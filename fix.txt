#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®ï¼ˆæ ¸å¼¹çº§ä¿®å¤ - å®Œå…¨é‡å»ºæ¨¡å¼ï¼‰==="
    
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åº”ç”¨é…ç½®"
        return 1
    fi
    
    log "ğŸ“‹ åŸå§‹é…ç½®æ–‡ä»¶è¡Œæ•°: $(wc -l < .config)"
    
    local backup_file=".config.bak.$(date +%Y%m%d%H%M%S)"
    cp .config "$backup_file"
    log "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½: $backup_file"
    
    log "ğŸ”§ æ­¥éª¤1: å®Œå…¨åºŸå¼ƒæ—§é…ç½®ï¼Œä»é›¶å¼€å§‹é‡å»º"
    
    rm -f .config .config.old
    
    log "ğŸ”„ æ­¥éª¤2: ç”Ÿæˆæœ€å°å¯è¡Œé…ç½®"
    
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
EOF
    
    log "ğŸ“ æœ€å°é…ç½®å·²åˆ›å»ºï¼Œå…± $(wc -l < .config) è¡Œ"
    log "ğŸ“‹ æœ€å°é…ç½®å†…å®¹:"
    cat .config | sed 's/^/  /'
    
    log "ğŸ”„ æ­¥éª¤3: è¿è¡Œ make defconfig ç”Ÿæˆæ ‡å‡†æ¡†æ¶"
    
    if make defconfig; then
        log "âœ… make defconfig æˆåŠŸï¼Œç”Ÿæˆæ ‡å‡†é…ç½®æ¡†æ¶"
    else
        log "âŒ è‡´å‘½é”™è¯¯: å³ä½¿æœ€å°é…ç½®ä¹Ÿæ— æ³•é€šè¿‡ defconfig"
        log "ğŸ“‹ æ£€æŸ¥ OpenWrt æºç å®Œæ•´æ€§..."
        
        if [ ! -f "include/toplevel.mk" ]; then
            log "âŒ æºç æŸå: ç¼ºå°‘ include/toplevel.mk"
            handle_error "OpenWrt æºç ä¸å®Œæ•´"
        fi
        
        log "ğŸ’¡ å°è¯•ä½¿ç”¨é…ç½®æ—§ç‰ˆæœ¬å…¼å®¹æ¨¡å¼..."
        echo "CONFIG_TEST_OPTIONS=y" > .config
        if make defconfig; then
            log "âœ… å…¼å®¹æ¨¡å¼æˆåŠŸ"
        else
            handle_error "OpenWrt æºç å¯èƒ½å·²æŸåï¼Œå»ºè®®é‡æ–°å…‹éš†"
        fi
    fi
    
    log "ğŸ”§ æ­¥éª¤4: ä»å¤‡ä»½ä¸­æå–æœ‰æ•ˆé…ç½®é¡¹"
    
    local valid_config_count=0
    local invalid_config_count=0
    local temp_config=$(mktemp)
    
    while IFS= read -r line; do
        stripped_line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        
        if [ -z "$stripped_line" ] || echo "$stripped_line" | grep -q "^#"; then
            continue
        fi
        
        if echo "$stripped_line" | grep -q "^CONFIG_.*=y$"; then
            config_name=$(echo "$stripped_line" | cut -d'=' -f1)
            
            if grep -q "^$config_name=" .config; then
                invalid_config_count=$((invalid_config_count + 1))
                continue
            fi
            
            if grep -q "^# $config_name is not set" .config; then
                sed -i "/^# $config_name is not set/d" .config
            fi
            
            echo "$stripped_line" >> .config
            valid_config_count=$((valid_config_count + 1))
            log "âœ… æ·»åŠ æœ‰æ•ˆé…ç½®: $config_name"
        fi
    done < "$backup_file"
    
    log "ğŸ“Š é…ç½®æå–ç»Ÿè®¡:"
    log "  âœ… æˆåŠŸæ·»åŠ : $valid_config_count ä¸ªé…ç½®é¡¹"
    log "  âš ï¸ è·³è¿‡å†²çª: $invalid_config_count ä¸ªé…ç½®é¡¹"
    
    log "ğŸ”„ æ­¥éª¤5: æœ€ç»ˆé…ç½®åŒæ­¥"
    
    make defconfig || log "âš ï¸ æœ€ç»ˆ defconfig è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ"
    
    log "ğŸ”§ æ­¥éª¤6: å¼ºåˆ¶å¯ç”¨å…³é”®é©±åŠ¨"
    
    if [ -f "scripts/config" ]; then
        log "  ğŸ”§ ä½¿ç”¨ scripts/config å·¥å…·..."
        
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-core
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb2
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb3
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-xhci-hcd
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-storage
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-storage-uas
        ./scripts/config --enable CONFIG_PACKAGE_kmod-scsi-core
        ./scripts/config --enable CONFIG_PACKAGE_kmod-fs-ext4
        ./scripts/config --enable CONFIG_PACKAGE_kmod-fs-vfat
        ./scripts/config --enable CONFIG_PACKAGE_kmod-fs-exfat
        ./scripts/config --enable CONFIG_PACKAGE_kmod-fs-ntfs3
        ./scripts/config --enable CONFIG_PACKAGE_kmod-nls-utf8
        ./scripts/config --enable CONFIG_PACKAGE_kmod-nls-cp936
        
        log "  âœ… USB å­˜å‚¨ç›¸å…³é©±åŠ¨å·²å¼ºåˆ¶å¯ç”¨"
    else
        log "  âš ï¸ scripts/config ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç›´æ¥å†™å…¥æ–¹å¼"
        
        cat >> .config << 'EOF'
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_kmod-usb-xhci-hcd=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-usb-storage-uas=y
CONFIG_PACKAGE_kmod-scsi-core=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_kmod-fs-exfat=y
CONFIG_PACKAGE_kmod-fs-ntfs3=y
CONFIG_PACKAGE_kmod-nls-utf8=y
CONFIG_PACKAGE_kmod-nls-cp936=y
EOF
        log "  âœ… USB å­˜å‚¨ç›¸å…³é©±åŠ¨å·²ç›´æ¥å†™å…¥"
    fi
    
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        log "  ğŸ”§ IPQ40xx å¹³å°ä¸“ç”¨é©±åŠ¨..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3-qcom
            ./scripts/config --enable CONFIG_PACKAGE_kmod-phy-qcom-dwc3
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-phy-msm
        else
            echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-phy-msm=y" >> .config
        fi
        log "  âœ… IPQ40xx USB é©±åŠ¨å·²å¯ç”¨"
    fi
    
    if [ "$TARGET" = "ramips" ]; then
        log "  ğŸ”§ Ramips å¹³å°ä¸“ç”¨é©±åŠ¨..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-xhci-mtk
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb2-mtk
        else
            echo "CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb2-mtk=y" >> .config
        fi
        log "  âœ… Ramips USB é©±åŠ¨å·²å¯ç”¨"
    fi
    
    if [ "$TARGET" = "ath79" ]; then
        log "  ğŸ”§ Ath79 å¹³å°ä¸“ç”¨é©±åŠ¨..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb2-ath79
        else
            echo "CONFIG_PACKAGE_kmod-usb2-ath79=y" >> .config
        fi
        log "  âœ… Ath79 USB é©±åŠ¨å·²å¯ç”¨"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  ğŸ”§ TurboACC é©±åŠ¨..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_luci-app-turboacc
            ./scripts/config --enable CONFIG_PACKAGE_kmod-shortcut-fe
            ./scripts/config --enable CONFIG_PACKAGE_kmod-fast-classifier
        else
            echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        fi
        log "  âœ… TurboACC é©±åŠ¨å·²å¯ç”¨"
    fi
    
    log "  ğŸ”§ TCP BBR æ‹¥å¡æ§åˆ¶..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-tcp-bbr
        ./scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
    else
        echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        sed -i '/^CONFIG_DEFAULT_TCP_CONG=/d' .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    fi
    log "  âœ… TCP BBR å·²å¯ç”¨"
    
    log "  ğŸ”§ ath10k-ct å†²çªä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-pci
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-smallbuffers
        ./scripts/config --enable CONFIG_PACKAGE_kmod-ath10k-ct
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers
        log "  âœ… ath10k-ct é…ç½®å·²ä¼˜åŒ–"
    fi
    
    log "ğŸ”„ æ­¥éª¤7: æœ€ç»ˆé…ç½®åŒæ­¥"
    
    make defconfig || {
        log "âš ï¸ æœ€ç»ˆ defconfig äº§ç”Ÿè­¦å‘Šï¼Œä½†è¿™æ˜¯é¢„æœŸçš„"
    }
    
    log "ğŸ”§ æ­¥éª¤8: éªŒè¯å…³é”®é…ç½®"
    
    local missing=()
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        missing+=("kmod-usb-xhci-hcd")
        echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
    fi
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        missing+=("kmod-usb3")
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
    fi
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" .config; then
        missing+=("kmod-usb-storage")
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
    fi
    
    if [ ${#missing[@]} -gt 0 ]; then
        log "âš ï¸ å¼ºåˆ¶æ·»åŠ ç¼ºå¤±é©±åŠ¨: ${missing[*]}"
        make defconfig > /dev/null 2>&1 || true
        log "âœ… å…³é”®é©±åŠ¨å·²ç¡®ä¿å¯ç”¨"
    fi
    
    log "ğŸ“Š æœ€ç»ˆé…ç½®ç»Ÿè®¡:"
    log "  ğŸ“ æ€»è¡Œæ•°: $(wc -l < .config)"
    log "  âœ… CONFIG_*=y: $(grep -c "^CONFIG_.*=y$" .config 2>/dev/null || echo 0)"
    log "  âœ… CONFIG_*=m: $(grep -c "^CONFIG_.*=m$" .config 2>/dev/null || echo 0)"
    log "  âšª æ³¨é‡Šè¡Œ: $(grep -c "^#" .config 2>/dev/null || echo 0)"
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        log "  âœ… USB 3.0: å·²å¯ç”¨"
    fi
    
    if grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config 2>/dev/null; then
        log "  âœ… TurboACC: å·²å¯ç”¨"
    fi
    
    if grep -q '^CONFIG_DEFAULT_TCP_CONG="bbr"' .config; then
        log "  âœ… TCP BBR: å·²å¯ç”¨"
    fi
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
}
#ã€build_firmware_main.sh-16-endã€‘

#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆæ ¸å¼¹çº§ - é…ç½®æ–‡ä»¶æ ¸éªŒï¼‰==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: SELECTED_BRANCH=$SELECTED_BRANCH, TARGET=$TARGET"
    else
        echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨"
        exit 1
    fi
    
    cd $BUILD_DIR
    
    echo "=== ğŸš¨ é…ç½®æ–‡ä»¶æ ¸éªŒ ==="
    echo ""
    echo "1. âœ… é…ç½®æ–‡ä»¶å­˜åœ¨æ€§:"
    
    if [ ! -f ".config" ]; then
        echo "  âŒ .config ä¸å­˜åœ¨"
        echo "  ğŸ”§ æ­£åœ¨ç”Ÿæˆæœ€å°é…ç½®..."
        
        cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
EOF
        echo "  âœ… æœ€å°é…ç½®å·²åˆ›å»º"
    else
        echo "  âœ… .config å­˜åœ¨"
    fi
    
    echo ""
    echo "2. ğŸ”¬ é…ç½®æ–‡ä»¶è¯­æ³•ä¸¥æ ¼æ£€æŸ¥:"
    
    local bad_lines=0
    local line_num=0
    
    while IFS= read -r line; do
        line_num=$((line_num + 1))
        stripped=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        
        if [ -z "$stripped" ]; then
            continue
        fi
        
        if echo "$stripped" | grep -q "^CONFIG_"; then
            if ! echo "$stripped" | grep -q "=y$" && ! echo "$stripped" | grep -q "=m$" && ! echo "$stripped" | grep -q "=n$"; then
                echo "  âŒ ç¬¬ $line_num è¡Œ: è¯­æ³•é”™è¯¯ - $stripped"
                bad_lines=$((bad_lines + 1))
            fi
        fi
    done < .config
    
    if [ $bad_lines -gt 0 ]; then
        echo "  âŒ å‘ç° $bad_lines ä¸ªè¯­æ³•é”™è¯¯ï¼Œç«‹å³é‡ç½®é…ç½®æ–‡ä»¶"
        
        rm -f .config
        
        cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
EOF
        echo "  âœ… é…ç½®æ–‡ä»¶å·²é‡ç½®"
    else
        echo "  âœ… é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡"
    fi
    
    echo ""
    echo "3. ğŸ§ª make defconfig å‹åŠ›æµ‹è¯•:"
    
    for i in 1 2 3; do
        echo "  ğŸ”„ ç¬¬ $i æ¬¡æµ‹è¯•..."
        if make defconfig > /dev/null 2>&1; then
            echo "  âœ… ç¬¬ $i æ¬¡æµ‹è¯•é€šè¿‡"
        else
            echo "  âŒ ç¬¬ $i æ¬¡æµ‹è¯•å¤±è´¥"
            if [ $i -eq 3 ]; then
                echo "  ğŸ”§ ä¸‰æ¬¡æµ‹è¯•å‡å¤±è´¥ï¼Œæ‰§è¡Œæ·±åº¦ä¿®å¤..."
                
                rm -f .config .config.old
                
                cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
                
                if make defconfig; then
                    echo "  âœ… æ·±åº¦ä¿®å¤æˆåŠŸ"
                else
                    echo "  âŒ æ·±åº¦ä¿®å¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ OpenWrt æºç "
                    exit 1
                fi
            fi
        fi
    done
    
    echo ""
    echo "4. ğŸ’¾ SDK ç›®å½•æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "  âœ… SDK ç›®å½•: $COMPILER_DIR"
    else
        echo "  âŒ SDK ç›®å½•ä¸å­˜åœ¨"
        exit 1
    fi
    
    echo ""
    echo "5. ğŸ“ Feeds æ£€æŸ¥:"
    if [ -d "feeds" ]; then
        echo "  âœ… feeds ç›®å½•å­˜åœ¨"
    else
        echo "  âŒ feeds ç›®å½•ä¸å­˜åœ¨"
        exit 1
    fi
    
    echo ""
    echo "6. ğŸ’¿ ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    AVAILABLE_SPACE=$(df /mnt --output=avail 2>/dev/null | tail -1 || df / --output=avail | tail -1)
    AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
    echo "  ğŸ“Š å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
    
    if [ $AVAILABLE_GB -lt 10 ]; then
        echo "  âŒ ç£ç›˜ç©ºé—´ä¸è¶³"
        exit 1
    else
        echo "  âœ… ç£ç›˜ç©ºé—´å……è¶³"
    fi
    
    echo ""
    echo "========================================"
    echo "âœ…âœ…âœ… æ‰€æœ‰æ ¸éªŒé€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}
#ã€build_firmware_main.sh-37-endã€‘
