#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä½¿ç”¨å…¬å…±å‡½æ•°ï¼‰ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡:"
        echo "   SELECTED_BRANCH=$SELECTED_BRANCH"
        echo "   TARGET=$TARGET"
        echo "   SUBTARGET=$SUBTARGET"
        echo "   DEVICE=$DEVICE"
        echo "   CONFIG_MODE=$CONFIG_MODE"
        echo "   COMPILER_DIR=$COMPILER_DIR"
    else
        echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ ($BUILD_DIR/build_env.sh)"
        exit 1
    fi
    
    cd $BUILD_DIR
    echo ""
    echo "=== ğŸš¨ å‰ç½®é”™è¯¯åŠ¨æ€æ£€æµ‹ ==="
    echo ""
    
    local error_count=0
    local warning_count=0
    
    echo "1. âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    if [ -f ".config" ]; then
        local config_size=$(ls -lh .config | awk '{print $5}')
        local config_lines=$(wc -l < .config)
        echo "   âœ… .config æ–‡ä»¶å­˜åœ¨"
        echo "   ğŸ“Š å¤§å°: $config_size, è¡Œæ•°: $config_lines"
        
        # æ„å»ºè®¾å¤‡é…ç½®è¡Œ
        local device_for_config=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
        local expected_config="CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_for_config}=y"
        
        if grep -q "^${expected_config}$" .config; then
            echo "   âœ… è®¾å¤‡é…ç½®æ­£ç¡®: $expected_config"
        else
            # å°è¯•æŸ¥æ‰¾ä»»ä½•åŒ…å«è¯¥è®¾å¤‡çš„é…ç½®è¡Œï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
            if grep -q "CONFIG_TARGET_.*DEVICE.*${device_for_config}=y" .config; then
                echo "   âœ… è®¾å¤‡é…ç½®æ­£ç¡® (æ¨¡ç³ŠåŒ¹é…)"
            else
                echo "   âŒ è®¾å¤‡é…ç½®å¯èƒ½ä¸æ­£ç¡®ï¼Œæœªæ‰¾åˆ°: $expected_config"
                error_count=$((error_count + 1))
            fi
        fi
    else
        echo "   âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    echo "2. âœ… SDK/ç¼–è¯‘å™¨æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "   âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
        local sdk_size=$(du -sh "$COMPILER_DIR" 2>/dev/null | awk '{print $1}')
        echo "   ğŸ“Š å¤§å°: $sdk_size"
        
        local gcc_file=$(find "$COMPILER_DIR" -type f -executable -name "*gcc" ! -name "*gcc-ar" ! -name "*gcc-ranlib" ! -name "*gcc-nm" ! -path "*dummy-tools*" 2>/dev/null | head -1)
        if [ -n "$gcc_file" ]; then
            echo "   âœ… æ‰¾åˆ°GCC: $(basename "$gcc_file")"
            local gcc_version=$("$gcc_file" --version 2>&1 | head -1)
            echo "   ğŸ”§ ç‰ˆæœ¬: $gcc_version"
        else
            echo "   âŒ æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨"
            error_count=$((error_count + 1))
        fi
    else
        echo "   âŒ SDKç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    echo "3. âœ… Feedsæ£€æŸ¥:"
    if [ -d "feeds" ]; then
        local feeds_count=$(find feeds -maxdepth 1 -type d 2>/dev/null | wc -l)
        feeds_count=$((feeds_count - 1))
        echo "   âœ… feedsç›®å½•å­˜åœ¨, åŒ…å« $feeds_count ä¸ªfeed"
        
        for feed in packages luci; do
            if [ -d "feeds/$feed" ]; then
                echo "   âœ… $feed feed: å­˜åœ¨"
            else
                echo "   âŒ $feed feed: ä¸å­˜åœ¨"
                warning_count=$((warning_count + 1))
            fi
        done
    else
        echo "   âŒ feedsç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    echo "4. âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    local available_space=$(df /mnt --output=avail 2>/dev/null | tail -1 || df / --output=avail | tail -1)
    local available_gb=$((available_space / 1024 / 1024))
    echo "   ğŸ“Š å¯ç”¨ç©ºé—´: ${available_gb}G"
    
    if [ $available_gb -lt 5 ]; then
        echo "   âŒ ç©ºé—´ä¸¥é‡ä¸è¶³ (<5G)"
        error_count=$((error_count + 1))
    elif [ $available_gb -lt 10 ]; then
        echo "   âš ï¸ ç©ºé—´è¾ƒä½ (<10G)"
        warning_count=$((warning_count + 1))
    elif [ $available_gb -lt 20 ]; then
        echo "   âš ï¸ ç©ºé—´ä¸€èˆ¬ (<20G)"
        warning_count=$((warning_count + 1))
    else
        echo "   âœ… ç©ºé—´å……è¶³"
    fi
    echo ""
    
    echo "5. âœ… USBé©±åŠ¨æ£€æŸ¥:"
    local critical_drivers=(
        "kmod-usb-core"
    )
    
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            critical_drivers+=("kmod-usb-dwc3" "kmod-usb-dwc3-qcom")
            ;;
        mediatek|ramips)
            critical_drivers+=("kmod-usb-xhci-mtk")
            ;;
    esac
    
    local missing_usb=0
    for driver in "${critical_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "   âœ… $driver: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${driver}=m" .config; then
            echo "   ğŸ“¦ $driver: æ¨¡å—åŒ–"
        else
            echo "   âŒ $driver: æœªå¯ç”¨"
            missing_usb=$((missing_usb + 1))
        fi
    done
    
    if [ $missing_usb -gt 0 ]; then
        echo "   âš ï¸ æœ‰ $missing_usb ä¸ªå…³é”®USBé©±åŠ¨ç¼ºå¤±"
        warning_count=$((warning_count + 1))
    fi
    echo ""
    
    echo "6. âœ… å†…å­˜æ£€æŸ¥:"
    local mem_total=$(free -m | awk '/^Mem:/{print $2}')
    local mem_available=$(free -m | awk '/^Mem:/{print $7}')
    echo "   ğŸ“Š æ€»å†…å­˜: ${mem_total}MB, å¯ç”¨: ${mem_available}MB"
    
    if [ $mem_available -lt 512 ]; then
        echo "   âš ï¸ å¯ç”¨å†…å­˜ä¸è¶³ (<512MB)"
        warning_count=$((warning_count + 1))
    else
        echo "   âœ… å†…å­˜å……è¶³"
    fi
    echo ""
    
    echo "7. âœ… CPUæ£€æŸ¥:"
    local cpu_cores=$(nproc)
    local cpu_model=$(grep "model name" /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs)
    echo "   ğŸ“Š æ ¸å¿ƒæ•°: $cpu_cores"
    echo "   ğŸ“Š å‹å·: $cpu_model"
    echo ""
    
    echo "========================================"
    if [ $error_count -gt 0 ]; then
        echo "âŒâŒâŒ æ£€æµ‹åˆ° $error_count ä¸ªé”™è¯¯ï¼Œè¯·ä¿®å¤åé‡è¯• âŒâŒâŒ"
        exit 1
    elif [ $warning_count -gt 0 ]; then
        echo "âš ï¸âš ï¸âš ï¸ æ£€æµ‹åˆ° $warning_count ä¸ªè­¦å‘Šï¼Œä½†å¯ä»¥ç»§ç»­ âš ï¸âš ï¸âš ï¸"
    else
        echo "âœ…âœ…âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    fi
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}
#ã€build_firmware_main.sh-37-endã€‘

