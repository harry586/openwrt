#ã€build_firmware_main.sh-32ã€‘
workflow_step16_verify_usb() {
    log "=== æ­¥éª¤16: éªŒè¯USBé…ç½®ï¼ˆæ™ºèƒ½æ£€æµ‹ç‰ˆï¼‰ ==="
    
    trap 'echo "âš ï¸ æ­¥éª¤16 éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
    
    cd $BUILD_DIR
    
    echo "=== ğŸš¨ USBé…ç½®æ™ºèƒ½æ£€æµ‹ ==="
    echo ""
    
    # 1. æ£€æµ‹USBæ ¸å¿ƒæ¨¡å—
    echo "1. ğŸŸ¢ USBæ ¸å¿ƒæ¨¡å—:"
    if grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" .config; then
        echo "   âœ… kmod-usb-core: å·²å¯ç”¨"
    else
        echo "   âŒ kmod-usb-core: æœªå¯ç”¨"
    fi
    echo ""
    
    # 2. æ£€æµ‹USB 2.0æ”¯æŒ
    echo "2. ğŸŸ¢ USB 2.0æ”¯æŒ:"
    local usb2_enabled=0
    if grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config; then
        echo "   âœ… kmod-usb2: å·²å¯ç”¨"
        usb2_enabled=1
    elif grep -q "^CONFIG_USB_EHCI_HCD=y" .config || grep -q "^CONFIG_USB_OHCI_HCD=y" .config; then
        echo "   âœ… USB 2.0åŠŸèƒ½å·²å¯ç”¨ï¼ˆé€šè¿‡å†…æ ¸é…ç½®ï¼‰"
        usb2_enabled=1
    else
        echo "   âŒ USB 2.0åŠŸèƒ½æœªå¯ç”¨"
    fi
    echo ""
    
    # 3. æ™ºèƒ½æ£€æµ‹USB 3.0/xhciåŠŸèƒ½
    echo "3. ğŸŸ¢ USB 3.0/xhciåŠŸèƒ½æ£€æµ‹:"
    
    local xhci_enabled=0
    local xhci_methods=""
    
    # æ–¹æ³•1: æ£€æŸ¥é€šç”¨xhci-hcdåŒ…
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        xhci_enabled=1
        xhci_methods="$xhci_methods\n   - é€šç”¨xhci-hcdåŒ…"
    fi
    
    # æ–¹æ³•2: æ£€æŸ¥å¹³å°ä¸“ç”¨xhciåŒ…
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config; then
        xhci_enabled=1
        xhci_methods="$xhci_methods\n   - è”å‘ç§‘xhci-mtkåŒ…"
    fi
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-qcom=y" .config; then
        xhci_enabled=1
        xhci_methods="$xhci_methods\n   - é«˜é€šxhci-qcomåŒ…"
    fi
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" .config; then
        xhci_enabled=1
        xhci_methods="$xhci_methods\n   - å¹³å°xhci-plat-hcdåŒ…"
    fi
    
    # æ–¹æ³•3: æ£€æŸ¥DWC3é©±åŠ¨ï¼ˆå†…éƒ¨é›†æˆxhciï¼‰
    if grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config || grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config; then
        xhci_enabled=1
        xhci_methods="$xhci_methods\n   - DWC3æ§åˆ¶å™¨ï¼ˆå†…éƒ¨é›†æˆxhciï¼‰"
    fi
    
    # æ–¹æ³•4: æ£€æŸ¥å†…æ ¸xhcié…ç½®
    if grep -q "^CONFIG_USB_XHCI_HCD=y" .config; then
        xhci_enabled=1
        xhci_methods="$xhci_methods\n   - å†…æ ¸xhciæ”¯æŒ"
    fi
    
    if grep -q "^CONFIG_USB_XHCI_PLATFORM=y" .config; then
        xhci_enabled=1
        xhci_methods="$xhci_methods\n   - å†…æ ¸å¹³å°xhciæ”¯æŒ"
    fi
    
    # æ–¹æ³•5: æ£€æŸ¥é«˜é€šå¹³å°ä¸“ç”¨PHY
    if grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config; then
        # é«˜é€šIPQ40xxå¹³å°æœ‰ä¸“ç”¨PHYï¼Œé€šå¸¸ä¸DWC3é…åˆ
        if [ $xhci_enabled -eq 0 ]; then
            # è™½ç„¶æ²¡æœ‰ç›´æ¥xhciåŒ…ï¼Œä½†å¹³å°æ”¯æŒUSB 3.0
            xhci_enabled=1
            xhci_methods="$xhci_methods\n   - é«˜é€šIPQ40xxå¹³å°ï¼ˆé€šè¿‡PHYå’ŒDWC3ï¼‰"
        fi
    fi
    
    # è¾“å‡ºæ£€æµ‹ç»“æœ
    if [ $xhci_enabled -eq 1 ]; then
        echo "   âœ… USB 3.0/xhciåŠŸèƒ½å·²å¯ç”¨"
        echo "   æ£€æµ‹æ–¹å¼:"
        echo -e "$xhci_methods" | while read line; do
            [ -n "$line" ] && echo "     $line"
        done
        
        # æ˜¾ç¤ºå®é™…å¯ç”¨çš„ç›¸å…³é…ç½®
        echo "   å®é™…é…ç½®:"
        grep -E "CONFIG_(PACKAGE_kmod-usb-xhci|PACKAGE_kmod-usb-dwc3|USB_XHCI|PHY_QCOM)" .config | grep -E "=y|=m" | head -5 | while read line; do
            echo "     $line"
        done
    else
        echo "   âŒ USB 3.0/xhciåŠŸèƒ½æœªå¯ç”¨"
    fi
    echo ""
    
    # 4. æ£€æµ‹USBå­˜å‚¨é©±åŠ¨
    echo "4. ğŸŸ¢ USBå­˜å‚¨æ”¯æŒ:"
    local storage_enabled=0
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" .config; then
        echo "   âœ… kmod-usb-storage: å·²å¯ç”¨"
        storage_enabled=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-storage-uas=y" .config; then
        echo "   âœ… kmod-usb-storage-uas: å·²å¯ç”¨"
        storage_enabled=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_kmod-scsi-core=y" .config; then
        echo "   âœ… kmod-scsi-core: å·²å¯ç”¨"
    else
        echo "   âŒ kmod-scsi-core: æœªå¯ç”¨"
    fi
    
    if [ $storage_enabled -eq 0 ]; then
        echo "   âŒ USBå­˜å‚¨é©±åŠ¨æœªå¯ç”¨"
    fi
    echo ""
    
    # 5. æ£€æµ‹å¹³å°ä¸“ç”¨é©±åŠ¨
    echo "5. ğŸŸ¢ å¹³å°ä¸“ç”¨é©±åŠ¨æ£€æµ‹:"
    
    # æ£€æµ‹ç›®æ ‡å¹³å°
    local target=$(grep "^CONFIG_TARGET_" .config | grep "=y" | head -1 | cut -d'_' -f2 | tr '[:upper:]' '[:lower:]')
    
    case "$target" in
        ipq40xx|ipq806x|qcom)
            echo "   ğŸ”§ æ£€æµ‹åˆ°é«˜é€šå¹³å°"
            local qcom_drivers=$(grep "^CONFIG_PACKAGE_kmod" .config | grep -E "qcom|ipq40|dwc3" | grep -E "=y|=m" | sort)
            if [ -n "$qcom_drivers" ]; then
                echo "$qcom_drivers" | while read line; do
                    local pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1)
                    local val=$(echo "$line" | cut -d'=' -f2)
                    if [ "$val" = "y" ]; then
                        echo "   âœ… $pkg: å·²å¯ç”¨"
                    elif [ "$val" = "m" ]; then
                        echo "   ğŸ“¦ $pkg: æ¨¡å—åŒ–"
                    fi
                done
            else
                echo "   æœªæ‰¾åˆ°é«˜é€šä¸“ç”¨é©±åŠ¨"
            fi
            
            # æ£€æŸ¥é«˜é€šPHY
            if grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config; then
                echo "   âœ… é«˜é€šIPQ4019 USB PHY: å·²å¯ç”¨"
            fi
            ;;
        mediatek|ramips)
            echo "   ğŸ”§ æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°"
            local mtk_drivers=$(grep "^CONFIG_PACKAGE_kmod" .config | grep -E "mtk|mediatek|xhci-mtk" | grep -E "=y|=m" | sort)
            if [ -n "$mtk_drivers" ]; then
                echo "$mtk_drivers" | while read line; do
                    local pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1)
                    local val=$(echo "$line" | cut -d'=' -f2)
                    if [ "$val" = "y" ]; then
                        echo "   âœ… $pkg: å·²å¯ç”¨"
                    elif [ "$val" = "m" ]; then
                        echo "   ğŸ“¦ $pkg: æ¨¡å—åŒ–"
                    fi
                done
            else
                echo "   æœªæ‰¾åˆ°è”å‘ç§‘ä¸“ç”¨é©±åŠ¨"
            fi
            ;;
        ath79)
            echo "   ğŸ”§ æ£€æµ‹åˆ°ATH79å¹³å°"
            local ath79_drivers=$(grep "^CONFIG_PACKAGE_kmod" .config | grep -E "ath79" | grep -E "=y|=m" | sort)
            if [ -n "$ath79_drivers" ]; then
                echo "$ath79_drivers" | while read line; do
                    local pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1)
                    local val=$(echo "$line" | cut -d'=' -f2)
                    if [ "$val" = "y" ]; then
                        echo "   âœ… $pkg: å·²å¯ç”¨"
                    elif [ "$val" = "m" ]; then
                        echo "   ğŸ“¦ $pkg: æ¨¡å—åŒ–"
                    fi
                done
            else
                echo "   æœªæ‰¾åˆ°ATH79ä¸“ç”¨é©±åŠ¨"
            fi
            ;;
        *)
            echo "   â„¹ï¸ é€šç”¨å¹³å°"
            ;;
    esac
    echo ""
    
    # 6. æ£€æŸ¥é‡å¤é…ç½®
    echo "6. ğŸŸ¢ æ£€æŸ¥é‡å¤é…ç½®:"
    local duplicates=$(grep "^CONFIG_PACKAGE_kmod-usb" .config | cut -d'=' -f1 | sort | uniq -d)
    if [ -n "$duplicates" ]; then
        echo "$duplicates" | while read dup; do
            local count=$(grep -c "^$dup=" .config)
            echo "   âš ï¸ $dup: å‡ºç° $count æ¬¡"
        done
    else
        echo "   âœ… æ— é‡å¤é…ç½®"
    fi
    echo ""
    
    # 7. ç»Ÿè®¡ä¿¡æ¯
    echo "7. ğŸ“Š USBé©±åŠ¨ç»Ÿè®¡:"
    local total_usb=$(grep -c "^CONFIG_PACKAGE_kmod-usb" .config)
    local enabled_usb=$(grep -c "^CONFIG_PACKAGE_kmod-usb.*=y" .config)
    local module_usb=$(grep -c "^CONFIG_PACKAGE_kmod-usb.*=m" .config)
    echo "   æ€»USBåŒ…: $total_usb"
    echo "   å·²å¯ç”¨: $enabled_usb"
    echo "   æ¨¡å—åŒ–: $module_usb"
    echo ""
    
    # 8. USBåŠŸèƒ½æ€»ç»“
    echo "8. ğŸ“‹ USBåŠŸèƒ½æ€»ç»“:"
    
    # USB 2.0
    if [ $usb2_enabled -eq 1 ]; then
        echo "   âœ… USB 2.0: æ”¯æŒ"
    else
        echo "   âŒ USB 2.0: ä¸æ”¯æŒ"
    fi
    
    # USB 3.0
    if [ $xhci_enabled -eq 1 ]; then
        echo "   âœ… USB 3.0: æ”¯æŒ"
    else
        echo "   âŒ USB 3.0: ä¸æ”¯æŒ"
    fi
    
    # USBå­˜å‚¨
    if [ $storage_enabled -eq 1 ]; then
        echo "   âœ… USBå­˜å‚¨: æ”¯æŒ"
    else
        echo "   âŒ USBå­˜å‚¨: ä¸æ”¯æŒ"
    fi
    
    echo ""
    echo "âœ… USBé…ç½®æ£€æŸ¥å®Œæˆ"
    log "âœ… æ­¥éª¤16 å®Œæˆ"
}
#ã€build_firmware_main.sh-32-endã€‘
