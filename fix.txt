#ã€build_firmware_main.sh-01ã€‘æ–‡ä»¶å¤´ï¼šå˜é‡å®šä¹‰å’Œæ—¥å¿—å‡½æ•°
#!/bin/bash
set -e

BUILD_DIR="/mnt/openwrt-build"
ENV_FILE="$BUILD_DIR/build_env.sh"

# ä¿®å¤ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„è·å–ä»“åº“æ ¹ç›®å½•
if [ -n "$GITHUB_WORKSPACE" ]; then
    REPO_ROOT="$GITHUB_WORKSPACE"
else
    REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
fi

# ä¿®å¤ï¼šSUPPORT_DIR åº”è¯¥æŒ‡å‘ firmware-config ç›®å½•
SUPPORT_DIR="$REPO_ROOT/firmware-config"

# ç¡®ä¿æœ‰æ—¥å¿—ç›®å½•
mkdir -p /tmp/build-logs

log() {
    echo "ã€$(date '+%Y-%m-%d %H:%M:%S')ã€‘$1"
}

# è°ƒè¯•å‡½æ•°ï¼šæ˜¾ç¤ºç›®å½•ç»“æ„
debug_dirs() {
    log "ğŸ” è°ƒè¯•ç›®å½•ç»“æ„:"
    log "  ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
    log "  æ”¯æŒç›®å½•: $SUPPORT_DIR"
    if [ -d "$REPO_ROOT" ]; then
        log "  ğŸ“ REPO_ROOT å­˜åœ¨"
        log "  ç›®å½•å†…å®¹ (å‰10ä¸ª):"
        ls -la "$REPO_ROOT" | head -20
    else
        log "  âŒ REPO_ROOT ä¸å­˜åœ¨"
    fi
    
    if [ -d "$SUPPORT_DIR" ]; then
        log "  ğŸ“ SUPPORT_DIR å­˜åœ¨"
        log "  ç›®å½•å†…å®¹ (å‰10ä¸ª):"
        ls -la "$SUPPORT_DIR" | head -10
    else
        log "  âŒ SUPPORT_DIR ä¸å­˜åœ¨"
    fi
}

#ã€build_firmware_main.sh-04ã€‘è®¾å¤‡æ”¯æŒå‡½æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰
load_device_support() {
    log "ğŸ”§ åŠ è½½è®¾å¤‡æ”¯æŒè„šæœ¬..."
    
    # æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    debug_dirs
    
    local support_file="$SUPPORT_DIR/support.sh"
    log "ğŸ“ æ£€æŸ¥æ”¯æŒæ–‡ä»¶: $support_file"
    
    if [ -f "$support_file" ]; then
        log "âœ… æ‰¾åˆ°è®¾å¤‡æ”¯æŒè„šæœ¬"
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        log "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
        ls -lh "$support_file"
        
        # æµ‹è¯•èƒ½å¦è¯»å–å‡½æ•°
        log "ğŸ§ª æµ‹è¯•è„šæœ¬åŠŸèƒ½..."
        if source "$support_file" 2>/dev/null; then
            log "âœ… æˆåŠŸåŠ è½½è®¾å¤‡æ”¯æŒè„šæœ¬"
            
            # æµ‹è¯•å…³é”®å‡½æ•°æ˜¯å¦å­˜åœ¨
            if command -v get_device_config >/dev/null 2>&1; then
                log "âœ… æ‰¾åˆ° get_device_config å‡½æ•°"
            else
                log "âš ï¸ æœªæ‰¾åˆ° get_device_config å‡½æ•°"
            fi
            
            if command -v get_device_description >/dev/null 2>&1; then
                log "âœ… æ‰¾åˆ° get_device_description å‡½æ•°"
            else
                log "âš ï¸ æœªæ‰¾åˆ° get_device_description å‡½æ•°"
            fi
            
            if command -v get_all_devices >/dev/null 2>&1; then
                log "âœ… æ‰¾åˆ° get_all_devices å‡½æ•°"
                local all_devices=$(get_all_devices 2>/dev/null || echo "æ— æ³•è·å–è®¾å¤‡åˆ—è¡¨")
                log "ğŸ“± æ”¯æŒçš„è®¾å¤‡: $all_devices"
            else
                log "âš ï¸ æœªæ‰¾åˆ° get_all_devices å‡½æ•°"
            fi
            
            return 0
        else
            log "âŒ æ— æ³•åŠ è½½è®¾å¤‡æ”¯æŒè„šæœ¬"
            return 1
        fi
    else
        log "âŒ è®¾å¤‡æ”¯æŒè„šæœ¬ä¸å­˜åœ¨"
        log "ğŸ’¡ å°è¯•åœ¨ä»¥ä¸‹ä½ç½®æŸ¥æ‰¾:"
        find "$REPO_ROOT" -name "support.sh" -type f 2>/dev/null | head -5
        return 1
    fi
}

#ã€build_firmware_main.sh-35ã€‘ä¸»å‡½æ•°ï¼ˆæ·»åŠ è°ƒè¯•å‚æ•°ï¼‰
main() {
    case $1 in
        # æ–°å¢è°ƒè¯•å‘½ä»¤
        "debug_dirs")
            debug_dirs
            ;;
        "debug_load_device")
            load_device_support
            ;;
            
        # å…¶ä»–åŸæœ‰å‘½ä»¤ä¿æŒä¸å˜
        "setup_environment")
            setup_environment
            ;;
        "create_build_dir")
            create_build_dir
            ;;
        "initialize_build_env")
            initialize_build_env "$2" "$3" "$4" "$5"
            ;;
        "initialize_compiler_env")
            initialize_compiler_env "$2"
            ;;
        "verify_compiler_files")
            verify_compiler_files
            ;;
        "check_compiler_invocation")
            check_compiler_invocation
            ;;
        "add_turboacc_support")
            add_turboacc_support
            ;;
        "configure_feeds")
            configure_feeds
            ;;
        "install_turboacc_packages")
            install_turboacc_packages
            ;;
        "pre_build_space_check")
            pre_build_space_check
            ;;
        "post_build_space_check")
            post_build_space_check
            ;;
        "generate_config")
            generate_config "$2"
            ;;
        "verify_usb_config")
            verify_usb_config
            ;;
        "check_usb_drivers_integrity")
            check_usb_drivers_integrity
            ;;
        "validate_config_syntax")
            validate_config_syntax
            ;;
        "apply_config")
            apply_config
            ;;
        "fix_network")
            fix_network
            ;;
        "download_dependencies")
            download_dependencies
            ;;
        "integrate_custom_files")
            integrate_custom_files
            ;;
        "pre_build_error_check")
            pre_build_error_check
            ;;
        "build_firmware")
            build_firmware "$2"
            ;;
        "check_firmware_files")
            check_firmware_files
            ;;
        "cleanup")
            cleanup
            ;;
        "save_source_code_info")
            save_source_code_info
            ;;
        "search_compiler_files")
            search_compiler_files "$2" "$3"
            ;;
        "universal_compiler_search")
            universal_compiler_search "$2" "$3"
            ;;
        "search_compiler_files_simple")
            search_compiler_files_simple "$2" "$3"
            ;;
        "intelligent_platform_aware_compiler_search")
            intelligent_platform_aware_compiler_search "$2" "$3" "$4"
            ;;
        *)
            log "âŒ æœªçŸ¥å‘½ä»¤: $1"
            echo "å¯ç”¨å‘½ä»¤:"
            echo "  debug_dirs - è°ƒè¯•ç›®å½•ç»“æ„"
            echo "  debug_load_device - è°ƒè¯•è®¾å¤‡æ”¯æŒåŠ è½½"
            echo "  setup_environment, create_build_dir, initialize_build_env"
            echo "  initialize_compiler_env - åˆå§‹åŒ–ç¼–è¯‘å™¨ç¯å¢ƒï¼ˆä¸‹è½½OpenWrtå®˜æ–¹SDKï¼‰"
            echo "  add_turboacc_support, configure_feeds, install_turboacc_packages"
            echo "  pre_build_space_check, generate_config, verify_usb_config, check_usb_drivers_integrity, apply_config"
            echo "  fix_network, download_dependencies, integrate_custom_files"
            echo "  pre_build_error_check, validate_config_syntax, build_firmware, post_build_space_check"
            echo "  check_firmware_files, cleanup, save_source_code_info, verify_compiler_files"
            echo "  check_compiler_invocation, search_compiler_files, universal_compiler_search"
            echo "  search_compiler_files_simple, intelligent_platform_aware_compiler_search"
            exit 1
            ;;
    esac
}
