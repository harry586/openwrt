#ã€build_firmware_main.sh-23ã€‘
# æ­¤å‡½æ•°å·²åºŸå¼ƒï¼Œç°åœ¨ç”¨ä½œå…¬å…±å‡½æ•°åº“
# ============================================================================
# å…¬å…±å‡½æ•°åº“ - ä¾›æ‰€æœ‰æ­¥éª¤è°ƒç”¨
# ============================================================================

# æ ¹æ®å†…å®¹é€‰æ‹©æœ€ä½³çš„è®¾å¤‡å®šä¹‰æ–‡ä»¶ï¼ˆå¸¦è¯„åˆ†å’Œè¯¦ç»†ä¿¡æ¯ï¼‰
find_device_definition_file() {
    local device_name="$1"
    local platform="$2"
    local base_path="target/linux/$platform"
    local best_file=""
    local best_score=0
    local found_files=()
    
    if [ ! -d "$base_path" ]; then
        echo ""
        return
    fi
    
    echo "   ğŸ” å¼€å§‹æœç´¢è®¾å¤‡ $device_name çš„å®šä¹‰æ–‡ä»¶..."
    echo "   ğŸ“ æœç´¢è·¯å¾„: $base_path"
    
    local file_count=0
    while IFS= read -r mk_file; do
        file_count=$((file_count + 1))
        if [ -f "$mk_file" ]; then
            local score=0
            local matched=0
            local match_desc=""
            
            # è¯»å–æ–‡ä»¶å†…å®¹
            local file_content=$(cat "$mk_file" 2>/dev/null)
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«è®¾å¤‡å®šä¹‰ - å¤šç§åŒ¹é…æ¨¡å¼
            if echo "$file_content" | grep -q "define Device[/=_]$device_name" 2>/dev/null; then
                score=$((score + 100))
                matched=1
                match_desc="ç²¾ç¡®è®¾å¤‡å®šä¹‰"
                echo "        âœ… æ‰¾åˆ°ç²¾ç¡®è®¾å¤‡å®šä¹‰: define Device/$device_name"
            elif echo "$file_content" | grep -q "define Device.*$device_name" 2>/dev/null; then
                score=$((score + 90))
                matched=1
                match_desc="è®¾å¤‡å®šä¹‰åŒ…å«è®¾å¤‡å"
                echo "        âœ… æ‰¾åˆ°è®¾å¤‡å®šä¹‰åŒ…å«: $device_name"
            elif echo "$file_content" | grep -q "Device[/=_]$device_name" 2>/dev/null; then
                score=$((score + 80))
                matched=1
                match_desc="è®¾å¤‡å¼•ç”¨"
                echo "        âœ… æ‰¾åˆ°è®¾å¤‡å¼•ç”¨: Device/$device_name"
            elif echo "$file_content" | grep -q "DEVICE_MODEL.*$device_name" 2>/dev/null; then
                score=$((score + 70))
                matched=1
                match_desc="è®¾å¤‡å‹å·åŒ¹é…"
                echo "        âœ… æ‰¾åˆ°è®¾å¤‡å‹å·: $device_name"
            elif echo "$file_content" | grep -q "DEVICE_TITLE.*$device_name" 2>/dev/null; then
                score=$((score + 60))
                matched=1
                match_desc="è®¾å¤‡æ ‡é¢˜åŒ¹é…"
                echo "        âœ… æ‰¾åˆ°è®¾å¤‡æ ‡é¢˜åŒ…å«: $device_name"
            elif echo "$file_content" | grep -q "DEVICE_DTS.*$device_name" 2>/dev/null; then
                score=$((score + 50))
                matched=1
                match_desc="DTSåŒ¹é…"
                echo "        âœ… æ‰¾åˆ°DTSåŒ…å«: $device_name"
            elif echo "$file_content" | grep -qi "$device_name" 2>/dev/null; then
                local match_count=$(echo "$file_content" | grep -io "$device_name" 2>/dev/null | wc -l)
                score=$((score + match_count * 5))
                if [ $match_count -gt 0 ]; then
                    matched=1
                    match_desc="æ¨¡ç³ŠåŒ¹é… ($match_count æ¬¡)"
                    echo "        ğŸ” æ‰¾åˆ°æ¨¡ç³ŠåŒ¹é…: $device_name (å‡ºç° $match_count æ¬¡)"
                fi
            fi
            
            # æ ¹æ®æ–‡ä»¶è·¯å¾„åŠ åˆ†
            if [[ "$mk_file" == *"/image/"* ]]; then
                score=$((score + 30))
                echo "        ğŸ“ imageç›®å½• +30"
            fi
            
            if [[ "$mk_file" == *"/$platform/"*"target.mk" ]]; then
                score=$((score + 20))
                echo "        ğŸ“ target.mk +20"
            fi
            
            # æ ¹æ®æ–‡ä»¶å†…å®¹åŠ åˆ†
            if echo "$file_content" | grep -q "DEVICE_PACKAGES" 2>/dev/null; then
                score=$((score + 15))
            fi
            
            if echo "$file_content" | grep -q "DEVICE_DTS" 2>/dev/null; then
                score=$((score + 15))
            fi
            
            if echo "$file_content" | grep -q "KERNEL" 2>/dev/null; then
                score=$((score + 10))
            fi
            
            if [ $matched -eq 1 ]; then
                found_files+=("$mk_file|$score|$match_desc")
                echo "       æ€»åˆ†: $score"
                
                if [ $score -gt $best_score ]; then
                    best_score=$score
                    best_file="$mk_file"
                fi
            fi
        fi
    done < <(find "$base_path" -type f -name "*.mk" 2>/dev/null | sort)
    
    echo "   ğŸ“Š å…±æ£€æŸ¥ $file_count ä¸ª.mkæ–‡ä»¶"
    
    if [ -n "$best_file" ]; then
        echo "   ğŸ† æœ€ä½³åŒ¹é…æ–‡ä»¶ (å¾—åˆ†: $best_score): $best_file"
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¸­çš„è®¾å¤‡å®šä¹‰
        echo ""
        echo "   ğŸ“‹ æ–‡ä»¶ä¸­çš„è®¾å¤‡å®šä¹‰:"
        local in_device=0
        while IFS= read -r line; do
            if [[ "$line" =~ ^define[[:space:]]+Device/ ]]; then
                in_device=1
                echo "     $line"
            elif [[ "$line" =~ ^endef ]] && [ $in_device -eq 1 ]; then
                echo "     $line"
                in_device=0
            elif [ $in_device -eq 1 ]; then
                echo "     $line"
            fi
        done < "$best_file"
    else
        echo "   âŒ æœªæ‰¾åˆ°è®¾å¤‡ $device_name çš„å®šä¹‰æ–‡ä»¶"
        
        # æ˜¾ç¤ºæ‰¾åˆ°çš„æ‰€æœ‰è®¾å¤‡å
        echo ""
        echo "   ğŸ“‹ æ–‡ä»¶ä¸­åŒ…å«çš„è®¾å¤‡å:"
        find "$base_path" -type f -name "*.mk" 2>/dev/null | while read f; do
            grep -h "^define Device/" "$f" 2>/dev/null | sed 's/define Device\///' | while read dev; do
                echo "     - $dev (åœ¨ $(basename "$f") ä¸­)"
            done
        done | sort -u
    fi
    
    echo "$best_file"
}

# ä»è®¾å¤‡å®šä¹‰æ–‡ä»¶ä¸­æå–æŒ‡å®šè®¾å¤‡çš„é…ç½®å—
extract_device_config() {
    local device_file="$1"
    local device_name="$2"
    
    if [ ! -f "$device_file" ]; then
        return 1
    fi
    
    local in_device_block=0
    local device_block=""
    local current_device=""
    local found=0
    
    echo "   ğŸ“– æ­£åœ¨ä» $(basename "$device_file") ä¸­æå–è®¾å¤‡ $device_name çš„é…ç½®..."
    
    while IFS= read -r line; do
        # æ£€æŸ¥æ˜¯å¦æ˜¯è®¾å¤‡å®šä¹‰å¼€å§‹
        if [[ "$line" =~ ^define[[:space:]]+Device/(.+) ]]; then
            current_device="${BASH_REMATCH[1]}"
            # æ£€æŸ¥æ˜¯å¦åŒ¹é…è®¾å¤‡åï¼ˆå¤šç§åŒ¹é…æ–¹å¼ï¼‰
            if [[ "$current_device" == *"$device_name"* ]] || [[ "$device_name" == *"$current_device"* ]]; then
                in_device_block=1
                device_block="$line"$'\n'
                found=1
                echo "     æ‰¾åˆ°åŒ¹é…è®¾å¤‡: $current_device"
            else
                in_device_block=0
            fi
        elif [[ "$line" =~ ^endef ]] && [ $in_device_block -eq 1 ]; then
            device_block="${device_block}$line"
            break
        elif [ $in_device_block -eq 1 ]; then
            device_block="${device_block}$line"$'\n'
        fi
    done < "$device_file"
    
    if [ $found -eq 1 ]; then
        echo "   âœ… æˆåŠŸæå–è®¾å¤‡é…ç½®"
        echo "$device_block"
    else
        echo "   âš ï¸ åœ¨æ–‡ä»¶ä¸­æœªæ‰¾åˆ°è®¾å¤‡ $device_name çš„é…ç½®"
        echo ""
        echo "   æ–‡ä»¶ä¸­åŒ…å«çš„è®¾å¤‡:"
        grep "^define Device/" "$device_file" 2>/dev/null | sed 's/define Device\///' | while read dev; do
            echo "     - $dev"
        done
    fi
}

# ä»è®¾å¤‡å®šä¹‰å—ä¸­æå–å…·ä½“é…ç½®å€¼
extract_config_value() {
    local device_block="$1"
    local key="$2"
    
    echo "$device_block" | grep -E "^[[:space:]]*$key[[:space:]]*:?=" | head -1 | sed 's/.*=[[:space:]]*//' | tr -d '"'
}

# è·å–è®¾å¤‡æ”¯æŒä¿¡æ¯æ‘˜è¦
get_device_support_summary() {
    local device_name="$1"
    local platform="$2"
    local subtarget="$3"
    
    echo "   ğŸ“ å¹³å°: $platform"
    echo "   ğŸ“ å­å¹³å°: $subtarget"
    
    # ç›´æ¥è°ƒç”¨å‡½æ•°ï¼Œè®©å‡½æ•°å†…éƒ¨è¾“å‡ºè¯¦ç»†ä¿¡æ¯
    local device_file=$(find_device_definition_file "$device_name" "$platform")
    
    if [ -n "$device_file" ] && [ -f "$device_file" ]; then
        echo "   âœ… æ‰¾åˆ°è®¾å¤‡å®šä¹‰æ–‡ä»¶: $device_file"
        
        # æå–æŒ‡å®šè®¾å¤‡çš„é…ç½®å—
        local device_block=$(extract_device_config "$device_file" "$device_name")
        
        if [ -n "$device_block" ]; then
            echo ""
            echo "   ğŸ“‹ è®¾å¤‡ $device_name é…ç½®:"
            echo "   ----------------------------------------"
            echo "$device_block" | while read line; do
                echo "     $line"
            done
            echo "   ----------------------------------------"
            
            # ä»è®¾å¤‡å—ä¸­æå–å…·ä½“ä¿¡æ¯
            local soc=$(extract_config_value "$device_block" "SOC")
            local model=$(extract_config_value "$device_block" "DEVICE_MODEL")
            local title=$(extract_config_value "$device_block" "DEVICE_TITLE")
            local packages=$(extract_config_value "$device_block" "DEVICE_PACKAGES")
            local dts=$(extract_config_value "$device_block" "DEVICE_DTS")
            local kernel_ver=$(extract_config_value "$device_block" "KERNEL_PATCHVER")
            
            [ -n "$soc" ] && echo "   ğŸ”§ SOC: $soc"
            [ -n "$model" ] && echo "   ğŸ“± å‹å·: $model"
            [ -n "$title" ] && echo "   ğŸ“ æ ‡é¢˜: $title"
            [ -n "$packages" ] && echo "   ğŸ“¦ é»˜è®¤åŒ…: $packages"
            [ -n "$dts" ] && echo "   ğŸ”§ DTS: $dts"
            [ -n "$kernel_ver" ] && echo "   ğŸ§ å†…æ ¸ç‰ˆæœ¬: $kernel_ver"
        fi
        
        return 0
    else
        echo "   âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡ $device_name çš„å®šä¹‰æ–‡ä»¶"
        return 1
    fi
}

# ä»è®¾å¤‡å®šä¹‰æ–‡ä»¶ä¸­æå–å†…æ ¸ç‰ˆæœ¬
extract_kernel_version_from_device_file() {
    local device_file="$1"
    local device_name="$2"
    
    if [ ! -f "$device_file" ]; then
        echo ""
        return
    fi
    
    # å…ˆæå–æŒ‡å®šè®¾å¤‡çš„é…ç½®å—
    local device_block=$(extract_device_config "$device_file" "$device_name")
    
    if [ -n "$device_block" ]; then
        # ä»è®¾å¤‡å—ä¸­æå–å†…æ ¸ç‰ˆæœ¬
        local kernel_patchver=$(echo "$device_block" | grep -E "^[[:space:]]*KERNEL_PATCHVER[[:space:]]*:?=" | head -1 | sed 's/.*=[[:space:]]*//')
        local kernel_line=$(echo "$device_block" | grep -E "^[[:space:]]*KERNEL[[:space:]]*:?=" | head -1 | sed 's/.*=[[:space:]]*//')
        
        if [ -n "$kernel_patchver" ]; then
            echo "$kernel_patchver"
        elif [ -n "$kernel_line" ]; then
            echo "$kernel_line" | grep -oE '^[0-9]+\.[0-9]+'
        else
            echo ""
        fi
    else
        echo ""
    fi
}

# è·å–æ‰€æœ‰æ”¯æŒçš„åˆ†æ”¯åˆ—è¡¨
get_supported_branches() {
    local branches=()
    
    if [ -f "$REPO_ROOT/build-config.conf" ]; then
        while IFS= read -r line; do
            if [[ "$line" == *"BRANCH_"*":="* ]]; then
                local branch_name=$(echo "$line" | sed -n 's/.*BRANCH_[^=]*:="*\([^"]*\)"*.*/\1/p')
                if [ -n "$branch_name" ]; then
                    branches+=("$branch_name")
                fi
            elif [[ "$line" == *"export BRANCH_"*"="* ]]; then
                local branch_name=$(echo "$line" | sed -n 's/.*export BRANCH_[^=]*="*\([^"]*\)"*.*/\1/p')
                if [ -n "$branch_name" ]; then
                    branches+=("$branch_name")
                fi
            fi
        done < "$REPO_ROOT/build-config.conf"
    fi
    
    if [ ${#branches[@]} -eq 0 ]; then
        if command -v git >/dev/null 2>&1; then
            local remote_branches=$(git ls-remote --heads "${IMMORTALWRT_URL:-https://github.com/immortalwrt/immortalwrt.git}" 2>/dev/null | \
                awk -F'/' '{print $NF}' | grep -E '^(openwrt-|main|master)' | sort -r | head -5)
            
            if [ -n "$remote_branches" ]; then
                while IFS= read -r branch; do
                    branches+=("$branch")
                done <<< "$remote_branches"
            fi
        fi
    fi
    
    if [ ${#branches[@]} -gt 0 ]; then
        printf '%s\n' "${branches[@]}" | sort -u 2>/dev/null
    else
        echo "openwrt-23.05 openwrt-21.02"
    fi
}

# è·å–æŒ‡å®šå¹³å°ä¸‹çš„æ‰€æœ‰å­å¹³å°
get_subtargets_by_platform() {
    local branch="$1"
    local platform="$2"
    
    local subtargets=()
    local platform_path="target/linux/$platform"
    
    if [ -d "$platform_path" ]; then
        while IFS= read -r subtarget_dir; do
            if [ -n "$subtarget_dir" ]; then
                local subtarget=$(basename "$subtarget_dir")
                case "$subtarget" in
                    image|base-files|config|patches|files|Makefile)
                        continue
                        ;;
                    *)
                        if [ -f "$subtarget_dir/target.mk" ] || [ -f "$subtarget_dir/Makefile" ]; then
                            subtargets+=("$subtarget")
                        fi
                        ;;
                esac
            fi
        done < <(find "$platform_path" -maxdepth 1 -type d ! -path "$platform_path" 2>/dev/null | sort)
        
        if [ ${#subtargets[@]} -eq 0 ] && [ -f "$platform_path/Makefile" ]; then
            local default_subtarget=$(grep -E '^[[:space:]]*SUBTARGETS?[[:space:]]*:?=' "$platform_path/Makefile" 2>/dev/null | \
                sed 's/.*=[[:space:]]*//' | tr -d ' ' | tr ',' ' ')
            
            if [ -n "$default_subtarget" ]; then
                for st in $default_subtarget; do
                    [ -n "$st" ] && subtargets+=("$st")
                done
            else
                subtargets+=("generic")
            fi
        fi
    fi
    
    if [ ${#subtargets[@]} -gt 0 ]; then
        printf '%s\n' "${subtargets[@]}" | sort -u 2>/dev/null | head -10
    else
        echo "generic"
    fi
}

# æ ¹æ®å†…æ ¸ç‰ˆæœ¬æŸ¥æ‰¾é…ç½®æ–‡ä»¶
find_kernel_config_by_version() {
    local platform="$1"
    local subtarget="$2"
    local kernel_version="$3"
    local config_file=""
    
    local search_paths=(
        "target/linux/$platform/$subtarget"
        "target/linux/$platform"
    )
    
    if [ -n "$kernel_version" ]; then
        for search_path in "${search_paths[@]}"; do
            if [ -d "$search_path" ]; then
                config_file=$(find "$search_path" -maxdepth 2 -type f -name "config-${kernel_version}*" 2>/dev/null | head -1)
                if [ -n "$config_file" ]; then
                    echo "$config_file"
                    return
                fi
            fi
        done
    fi
    
    for ver in ${KERNEL_VERSION_PRIORITY:-6.6 6.1 5.15 5.10 5.4}; do
        config_file="target/linux/$platform/config-$ver"
        if [ -f "$config_file" ]; then
            echo "$config_file"
            return
        fi
    done
    
    echo ""
}
#ã€build_firmware_main.sh-23-endã€‘
