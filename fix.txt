#ã€build_firmware_main.sh-06ã€‘
initialize_build_env() {
    local device_name=$1
    local version_selection=$2
    local config_mode=$3
    
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ç‰ˆæœ¬é€‰æ‹© ==="
    if [ "$version_selection" = "23.05" ]; then
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-23.05"
    else
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-21.02"
    fi
    log "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH"
    
    log "=== å…‹éš†æºç  ==="
    log "ä»“åº“: $SELECTED_REPO_URL"
    log "åˆ†æ”¯: $SELECTED_BRANCH"
    
    sudo rm -rf ./* ./.git* 2>/dev/null || true
    
    git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . || handle_error "å…‹éš†æºç å¤±è´¥"
    log "âœ… æºç å…‹éš†å®Œæˆ"
    
    local important_source_files=("Makefile" "feeds.conf.default" "rules.mk" "Config.in")
    for file in "${important_source_files[@]}"; do
        if [ -f "$file" ]; then
            log "âœ… æºç æ–‡ä»¶å­˜åœ¨: $file"
        else
            log "âŒ æºç æ–‡ä»¶ç¼ºå¤±: $file"
        fi
    done
    
    log "=== è®¾å¤‡é…ç½® ==="
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” è°ƒç”¨support.shè·å–è®¾å¤‡å¹³å°ä¿¡æ¯..."
        PLATFORM_INFO=$("$SUPPORT_SCRIPT" get-platform "$device_name")
        if [ -n "$PLATFORM_INFO" ]; then
            TARGET=$(echo "$PLATFORM_INFO" | awk '{print $1}')
            SUBTARGET=$(echo "$PLATFORM_INFO" | awk '{print $2}')
            DEVICE="$device_name"
            log "âœ… ä»support.shè·å–å¹³å°ä¿¡æ¯: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
        else
            log "âŒ æ— æ³•ä»support.shè·å–å¹³å°ä¿¡æ¯"
            handle_error "è·å–å¹³å°ä¿¡æ¯å¤±è´¥"
        fi
    else
        log "âŒ support.shä¸å­˜åœ¨"
        handle_error "support.shè„šæœ¬ç¼ºå¤±"
    fi
    
    log "ğŸ”§ è®¾å¤‡: $device_name"
    log "ğŸ”§ ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    
    CONFIG_MODE="$config_mode"
    
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    
    log "=== åˆ›å»ºé…ç½®å·¥å…·ï¼ˆç›´æ¥å†™å…¥.configçš„åŒ…è£…è„šæœ¬ï¼‰==="
    
    mkdir -p scripts/config
    cat > scripts/config/config << 'EOF'
#!/bin/sh
# ç›´æ¥å†™å…¥.configçš„ç®€æ˜“configå·¥å…· - æœ€ç»ˆç¨³å®šç‰ˆ
CONFIG_FILE=".config"

case "$1" in
    --enable)
        shift
        sed -i "/^# CONFIG_$1 is not set/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=/d" "$CONFIG_FILE"
        echo "CONFIG_$1=y" >> "$CONFIG_FILE"
        ;;
    --disable)
        shift
        sed -i "/^CONFIG_$1=y/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=m/d" "$CONFIG_FILE"
        echo "# CONFIG_$1 is not set" >> "$CONFIG_FILE"
        ;;
    --module)
        shift
        sed -i "/^# CONFIG_$1 is not set/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=y/d" "$CONFIG_FILE"
        echo "CONFIG_$1=m" >> "$CONFIG_FILE"
        ;;
    --set-str)
        shift
        local name="$1"
        local value="$2"
        sed -i "/^CONFIG_$name=/d" "$CONFIG_FILE"
        echo "CONFIG_$name=\"$value\"" >> "$CONFIG_FILE"
        shift 2
        ;;
esac
EOF
    chmod +x scripts/config/config
    
    cat > scripts/config-tool << 'EOF'
#!/bin/sh
# ç»Ÿä¸€ config å·¥å…·è°ƒç”¨æ¥å£
if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
    exec scripts/config/config "$@"
else
    echo "Error: config tool not found" >&2
    exit 1
fi
EOF
    chmod +x scripts/config-tool
    
    log "âœ… ç®€æ˜“configå·¥å…·åˆ›å»ºæˆåŠŸ: scripts/config/config"
    log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£åˆ›å»ºæˆåŠŸ: scripts/config-tool"
    
    if scripts/config-tool --help > /dev/null 2>&1; then
        log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£æµ‹è¯•é€šè¿‡"
    fi
    
    log "âœ… é…ç½®å·¥å…·æœ€ç»ˆéªŒè¯é€šè¿‡"
    
    save_env
    
    echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
    echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
    echo "TARGET=$TARGET" >> $GITHUB_ENV
    echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
    echo "DEVICE=$DEVICE" >> $GITHUB_ENV
    echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
    
    log "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}
#ã€build_firmware_main.sh-06-endã€‘
#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆæœ€ç»ˆç¨³å®šç‰ˆV3-å¼ºåˆ¶é©±åŠ¨é”æ­»+äºŒæ¬¡å†™å…¥ï¼‰==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    local CONFIG_CMD="./scripts/config/config"
    log "âœ… ä½¿ç”¨ç®€æ˜“configå·¥å…·"
    
    log "ğŸ”§ ä½¿ç”¨é…ç½®å·¥å…·åˆå¹¶é…ç½®..."
    
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "ğŸ“ åº”ç”¨USBé€šç”¨é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/usb-generic.config"
        log "âœ… USBé€šç”¨é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "ğŸ“ åº”ç”¨åŸºç¡€é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/base.config"
        log "âœ… åŸºç¡€é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "ğŸ“ åº”ç”¨è®¾å¤‡é…ç½®: $DEVICE.config..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$device_config_file"
        log "âœ… è®¾å¤‡é…ç½®åº”ç”¨å®Œæˆ"
    elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "ğŸ“ åº”ç”¨æ­£å¸¸æ¨¡å¼é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/normal.config"
        log "âœ… æ­£å¸¸æ¨¡å¼é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "ğŸ“ åº”ç”¨å¹³å°é…ç½®: $(basename "$platform_config")..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$platform_config"
        log "âœ… å¹³å°é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            if [ -n "$pkg" ]; then
                $CONFIG_CMD --enable "PACKAGE_$pkg"
                log "âœ… æ·»åŠ åŒ…: $pkg"
            fi
        done
    fi
    
    log "ğŸ”§ ç¬¬ä¸€æ¬¡å¼ºåˆ¶å¯ç”¨æ‰€æœ‰å…³é”®é…ç½®..."
    
    $CONFIG_CMD --enable PACKAGE_kmod-usb-core
    $CONFIG_CMD --enable PACKAGE_kmod-usb2
    $CONFIG_CMD --enable PACKAGE_kmod-usb3
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-hcd
    $CONFIG_CMD --enable PACKAGE_kmod-usb-storage
    $CONFIG_CMD --enable PACKAGE_kmod-scsi-core
    
    if [ "$TARGET" = "ipq40xx" ]; then
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3-qcom
        $CONFIG_CMD --enable PACKAGE_kmod-phy-qcom-dwc3
        log "âœ… IPQ40xxå¹³å°ä¸“ç”¨é©±åŠ¨å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    fi
    
    $CONFIG_CMD --enable PACKAGE_kmod-tcp-bbr
    $CONFIG_CMD --set-str DEFAULT_TCP_CONG "bbr"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        $CONFIG_CMD --enable PACKAGE_luci-app-turboacc
        $CONFIG_CMD --enable PACKAGE_kmod-shortcut-fe
        $CONFIG_CMD --enable PACKAGE_kmod-fast-classifier
        log "âœ… TurboACCé…ç½®å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    fi
    
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-pci
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-smallbuffers
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-ct-smallbuffers
    $CONFIG_CMD --enable PACKAGE_kmod-ath10k-ct
    log "âœ… ath10kå†²çªä¿®å¤å®Œæˆ"
    
    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfig..."
    make defconfig || handle_error "æœ€ç»ˆé…ç½®åº”ç”¨å¤±è´¥"
    
    log "ğŸ”§ ç¬¬äºŒæ¬¡å¼ºåˆ¶å†™å…¥è¢«defconfigé‡ç½®çš„å…³é”®é©±åŠ¨..."
    
    local force_drivers_phase1=(
        "PACKAGE_kmod-usb-xhci-hcd"
    )
    
    if [ "$TARGET" = "ipq40xx" ]; then
        force_drivers_phase1+=("PACKAGE_kmod-phy-qcom-dwc3")
    fi
    
    local fixed_count=0
    for driver in "${force_drivers_phase1[@]}"; do
        if ! grep -q "^CONFIG_${driver}=y" .config; then
            log "âš ï¸ æ£€æµ‹åˆ° $driver è¢«defconfigé‡ç½®ï¼ŒäºŒæ¬¡å¼ºåˆ¶å†™å…¥..."
            $CONFIG_CMD --enable "$driver"
            fixed_count=$((fixed_count + 1))
        fi
    done
    
    if [ $fixed_count -gt 0 ]; then
        log "âœ… å·²ä¿®å¤ $fixed_count ä¸ªè¢«é‡ç½®çš„é©±åŠ¨"
        log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfig..."
        make defconfig || handle_error "äºŒæ¬¡é…ç½®åŒæ­¥å¤±è´¥"
        
        log "ğŸ”§ ç¬¬ä¸‰æ¬¡å¼ºåˆ¶å†™å…¥ï¼ˆç»ˆæé”æ­»ï¼‰..."
        local force_drivers_phase2=(
            "PACKAGE_kmod-usb-xhci-hcd"
        )
        
        if [ "$TARGET" = "ipq40xx" ]; then
            force_drivers_phase2+=("PACKAGE_kmod-phy-qcom-dwc3")
        fi
        
        for driver in "${force_drivers_phase2[@]}"; do
            if ! grep -q "^CONFIG_${driver}=y" .config; then
                log "âš ï¸ $driver ä»ç„¶è¢«é‡ç½®ï¼Œç›´æ¥å†™å…¥.configæ–‡ä»¶..."
                echo "CONFIG_${driver}=y" >> .config
            fi
        done
        
        log "ğŸ”„ ç¬¬ä¸‰æ¬¡è¿è¡Œ make defconfig..."
        make defconfig || handle_error "ä¸‰æ¬¡é…ç½®åŒæ­¥å¤±è´¥"
    fi
    
    log "ğŸ“‹ å…³é”®é…ç½®çŠ¶æ€ï¼ˆæœ€ç»ˆéªŒè¯ï¼‰:"
    log "  - kmod-usb2: $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb3: $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    if [ "$TARGET" = "ipq40xx" ]; then
        log "  - kmod-usb-dwc3-qcom: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        log "  - kmod-phy-qcom-dwc3: $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  - luci-app-turboacc: $(grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    log "  - kmod-tcp-bbr: $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    log "ğŸ“Š é…ç½®ç”Ÿæˆç»Ÿè®¡:"
    log "  - æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "  - é…ç½®è¡Œæ•°: $(wc -l < .config)"
    log "  - é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘


#ã€firmware-build.yml-18ã€‘
      - name: "18. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€"
        run: |
          echo "=== æ­¥éª¤18: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€ ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤18 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          echo "ğŸ”§ æ­¥éª¤18.1: è¿è¡Œ make defconfig..."
          make defconfig || {
            echo "âŒ make defconfig å¤±è´¥"
            exit 1
          }
          
          echo ""
          echo "ğŸ”§ æ­¥éª¤18.2: äºŒæ¬¡å¼ºåˆ¶å†™å…¥è¢«defconfigé‡ç½®çš„å…³é”®é©±åŠ¨..."
          
          # æ£€æµ‹ç›®æ ‡å¹³å°
          TARGET=$(grep "^CONFIG_TARGET_" .config | head -1 | cut -d'=' -f1 | sed 's/^CONFIG_TARGET_//' | sed 's/=y$//' 2>/dev/null || echo "")
          echo "ğŸ“‹ æ£€æµ‹åˆ°ç›®æ ‡å¹³å°: ${TARGET:-æœªçŸ¥}"
          
          # å¼ºåˆ¶å†™å…¥USB 3.0é©±åŠ¨
          if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
            echo "âš ï¸ æ£€æµ‹åˆ° kmod-usb-xhci-hcd è¢«é‡ç½®ï¼Œå¼ºåˆ¶å†™å…¥..."
            if [ -f "scripts/config/config" ]; then
              ./scripts/config/config --enable PACKAGE_kmod-usb-xhci-hcd
            else
              echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
            fi
            echo "âœ… å·²å¼ºåˆ¶å¯ç”¨: kmod-usb-xhci-hcd"
          fi
          
          # IPQ40xxå¹³å°ä¸“ç”¨é©±åŠ¨
          if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
            if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
              echo "âš ï¸ æ£€æµ‹åˆ° kmod-phy-qcom-dwc3 è¢«é‡ç½®ï¼Œå¼ºåˆ¶å†™å…¥..."
              if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_kmod-phy-qcom-dwc3
              else
                echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
              fi
              echo "âœ… å·²å¼ºåˆ¶å¯ç”¨: kmod-phy-qcom-dwc3"
            fi
          fi
          
          echo ""
          echo "ğŸ”§ æ­¥éª¤18.3: å†æ¬¡è¿è¡Œ make defconfig åŒæ­¥..."
          make defconfig
          
          echo ""
          echo "=========================================="
          echo "ğŸ“‹ åº”ç”¨é…ç½®åæœ€ç»ˆçŠ¶æ€ï¼ˆè¯¦ç»†æ£€æŸ¥ï¼‰:"
          echo "=========================================="
          
          echo "1ï¸âƒ£ USBæ ¸å¿ƒé©±åŠ¨:"
          echo "  - kmod-usb-core:       $(grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-usb2:           $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-usb3:           $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo ""
          
          echo "2ï¸âƒ£ USB 3.0æ§åˆ¶å™¨:"
          echo "  - kmod-usb-xhci-hcd:   $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-usb-xhci-pci:   $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-pci=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo ""
          
          echo "3ï¸âƒ£ USBå­˜å‚¨é©±åŠ¨:"
          echo "  - kmod-usb-storage:    $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-scsi-core:      $(grep -q "^CONFIG_PACKAGE_kmod-scsi-core=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo ""
          
          echo "4ï¸âƒ£ IPQ40xxå¹³å°ä¸“ç”¨é©±åŠ¨:"
          if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
            echo "  - kmod-usb-dwc3:       $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-usb-dwc3-qcom:  $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-phy-qcom-dwc3:  $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          else
            echo "  - éIPQ40xxå¹³å°ï¼Œè·³è¿‡æ£€æŸ¥"
          fi
          echo ""
          
          echo "5ï¸âƒ£ TurboACCé…ç½®:"
          if grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config 2>/dev/null; then
            echo "  - luci-app-turboacc:   âœ… å·²å¯ç”¨"
          else
            echo "  - luci-app-turboacc:   âŒ æœªå¯ç”¨"
          fi
          echo ""
          
          echo "6ï¸âƒ£ TCP BBRæ‹¥å¡æ§åˆ¶:"
          echo "  - kmod-tcp-bbr:        $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - DEFAULT_TCP_CONG:    $(grep "^CONFIG_DEFAULT_TCP_CONG=" .config | cut -d'"' -f2 || echo 'æœªè®¾ç½®')"
          echo ""
          
          echo "7ï¸âƒ£ é…ç½®æ–‡ä»¶ç»Ÿè®¡:"
          echo "  - æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
          echo "  - é…ç½®è¡Œæ•°: $(wc -l < .config)"
          echo ""
          
          if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
            echo "âœ…âœ…âœ… å…³é”®é©±åŠ¨ kmod-usb-xhci-hcd å·²æˆåŠŸé”å®šï¼Œä¸ä¼šè¢«é‡ç½®"
          else
            echo "âŒâŒâŒ è­¦å‘Š: kmod-usb-xhci-hcd ä»æœªå¯ç”¨ï¼Œè¯·æ£€æŸ¥é…ç½®ä¾èµ–"
          fi
          
          if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
            if grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
              echo "âœ…âœ…âœ… IPQ40xxå¹³å°é©±åŠ¨ kmod-phy-qcom-dwc3 å·²æˆåŠŸé”å®š"
            else
              echo "âŒâŒâŒ è­¦å‘Š: kmod-phy-qcom-dwc3 ä»æœªå¯ç”¨"
            fi
          fi
          
          echo "=========================================="
          echo "âœ… æ­¥éª¤18 é…ç½®åº”ç”¨å®Œæˆ"
#ã€firmware-build.yml-18-endã€‘

#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…ï¼ˆç»¼åˆä¿®å¤ç‰ˆV3ï¼‰==="
    
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åº”ç”¨é…ç½®"
        return 1
    fi
    
    log "ğŸ“‹ é…ç½®è¯¦æƒ…:"
    log "é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "é…ç½®è¡Œæ•°: $(wc -l < .config)"
    
    local backup_file=".config.bak.$(date +%Y%m%d%H%M%S)"
    cp .config "$backup_file"
    log "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½: $backup_file"
    
    log "ğŸ”§ æ­¥éª¤1: æ ‡å‡†åŒ–é…ç½®æ–‡ä»¶æ ¼å¼..."
    
    if [ -f ".config" ]; then
        awk '
        {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if ($0 ~ /^#/) {
                if ($0 ~ /^#CONFIG_/) {
                    $0 = "# " substr($0, 2)
                }
                if ($0 !~ /is not set$/) {
                    $0 = $0 " is not set"
                }
            }
            if ($0 ~ /^CONFIG_/) {
                if ($0 ~ /y$|m$|=$/) {
                    gsub(/[[:space:]]*=[[:space:]]*y$/, "=y")
                    gsub(/[[:space:]]*=[[:space:]]*m$/, "=m")
                    gsub(/[[:space:]]*=[[:space:]]*$/, "=")
                }
            }
            if (length($0) > 0) {
                print $0
            }
        }' .config > .config.tmp
        
        mv .config.tmp .config
        log "âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ ‡å‡†åŒ–å®Œæˆ"
    else
        log "âŒ .config æ–‡ä»¶åœ¨æ“ä½œè¿‡ç¨‹ä¸­ä¸¢å¤±"
        return 1
    fi
    
    log "ğŸ”§ æ­¥éª¤2: æ¸…ç†é‡å¤é…ç½®è¡Œ..."
    
    local dup_before=$(wc -l < .config)
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    local dup_after=$(wc -l < .config)
    local dup_removed=$((dup_before - dup_after))
    
    if [ $dup_removed -gt 0 ]; then
        log "âœ… å·²åˆ é™¤ $dup_removed ä¸ªå®Œå…¨é‡å¤çš„é…ç½®è¡Œ"
    fi
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    local config_uniq_removed=$((dup_after - $(wc -l < .config)))
    if [ $config_uniq_removed -gt 0 ]; then
        log "âœ… å·²åˆå¹¶ $config_uniq_removed ä¸ªé‡å¤é…ç½®é¡¹"
    fi
    
    log "ğŸ”§ æ­¥éª¤3: æ£€æŸ¥libustreamå†²çª..."
    
    local openssl_enabled=0
    local wolfssl_enabled=0
    
    if grep -q "^CONFIG_PACKAGE_libustream-openssl=y" .config; then
        openssl_enabled=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_libustream-wolfssl=y" .config; then
        wolfssl_enabled=1
    fi
    
    if [ $openssl_enabled -eq 1 ] && [ $wolfssl_enabled -eq 1 ]; then
        log "âš ï¸ å‘ç°libustream-opensslå’Œlibustream-wolfsslå†²çª"
        log "ğŸ”§ ä¿®å¤å†²çª: ç¦ç”¨libustream-openssl"
        
        awk '
        /^CONFIG_PACKAGE_libustream-openssl=y/ {
            print "# CONFIG_PACKAGE_libustream-openssl is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config
        
        log "âœ… å†²çªå·²ä¿®å¤"
    fi
    
    log "ğŸ”§ æ­¥éª¤4: è¿è¡Œ make defconfig..."
    make defconfig || handle_error "åº”ç”¨é…ç½®å¤±è´¥"
    
    log "ğŸ”§ æ­¥éª¤5: äºŒæ¬¡å¼ºåˆ¶å†™å…¥è¢«defconfigé‡ç½®çš„å…³é”®é©±åŠ¨..."
    
    local force_drivers=(
        "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
    )
    
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        force_drivers+=("CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y")
    fi
    
    local fixed_count=0
    for driver in "${force_drivers[@]}"; do
        driver_name=$(echo "$driver" | cut -d'=' -f1)
        if ! grep -q "^${driver_name}=y" .config; then
            log "âš ï¸ æ£€æµ‹åˆ° ${driver_name} è¢«defconfigé‡ç½®ï¼ŒäºŒæ¬¡å¼ºåˆ¶å†™å…¥..."
            if [ -f "scripts/config/config" ]; then
                config_item=$(echo "$driver_name" | sed 's/^CONFIG_PACKAGE_//')
                scripts/config/config --enable "$config_item"
            else
                sed -i "/^# ${driver_name} is not set/d" .config
                sed -i "/^${driver_name}=/d" .config
                echo "$driver" >> .config
            fi
            fixed_count=$((fixed_count + 1))
        fi
    done
    
    if [ $fixed_count -gt 0 ]; then
        log "âœ… å·²ä¿®å¤ $fixed_count ä¸ªè¢«é‡ç½®çš„é©±åŠ¨"
        log "ğŸ”„ å†æ¬¡è¿è¡Œ make defconfig åŒæ­¥..."
        make defconfig
    fi
    
    log "ğŸ”§ æ­¥éª¤6: éªŒè¯å…³é”®é…ç½®..."
    
    local missing_key_configs=()
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        missing_key_configs+=("kmod-usb-xhci-hcd")
    fi
    
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
            missing_key_configs+=("kmod-phy-qcom-dwc3")
        fi
    fi
    
    if [ ${#missing_key_configs[@]} -gt 0 ]; then
        log "âš ï¸ è­¦å‘Š: ä»¥ä¸‹å…³é”®é…ç½®åœ¨äºŒæ¬¡ä¿®å¤åä»ç„¶ä¸¢å¤±: ${missing_key_configs[*]}"
    else
        log "âœ… æ‰€æœ‰å…³é”®é…ç½®éªŒè¯é€šè¿‡"
    fi
    
    log "ğŸ“‹ åº”ç”¨é…ç½®åæœ€ç»ˆçŠ¶æ€:"
    log "  - kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        log "  - kmod-phy-qcom-dwc3: $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
    log "æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "æœ€ç»ˆé…ç½®å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "æœ€ç»ˆé…ç½®è¡Œæ•°: $(wc -l < .config)"
}
#ã€build_firmware_main.sh-16-endã€‘

