#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆè®¾å¤‡æ˜¾å¼æŒ‡å®šç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # æ­¥éª¤1: åˆ›å»ºåŸºç¡€ç›®æ ‡é…ç½®ï¼ˆæ˜¾å¼æŒ‡å®šè®¾å¤‡ï¼‰
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    # æ­¥éª¤2: åˆå¹¶æ‰€æœ‰é…ç½®æ–‡ä»¶
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    # è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è¿½åŠ é…ç½®ï¼ˆè¿‡æ»¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
        fi
    }
    
    append_config "$CONFIG_DIR/base.config"
    append_config "$CONFIG_DIR/usb-generic.config"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    append_config "$CONFIG_DIR/devices/$DEVICE.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/normal.config"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # TCP BBR
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    # TurboACCï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰
    if [ "$CONFIG_MODE" = "normal" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # ath10k å†²çªè§£å†³
    sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
    echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
    echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
    
    # æ­¥éª¤3: å»é‡
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤4: è¿è¡Œ defconfig è§£å†³ä¾èµ–
    log "ğŸ”„ è¿è¡Œ make defconfig è§£å†³ä¾èµ–å…³ç³»..."
    make defconfig || handle_error "ä¾èµ–è§£å†³å¤±è´¥"
    
    # æ­¥éª¤5: åå¤„ç†å¼ºåˆ¶å¯ç”¨å…³é”®USBè½¯ä»¶åŒ…ï¼ˆå¢å¼ºç‰ˆï¼‰
    log "ğŸ”§ åå¤„ç†ï¼šå¼ºåˆ¶å¯ç”¨USBè½¯ä»¶åŒ…ï¼ˆå¢å¼ºç‰ˆï¼‰..."
    
    # å®šä¹‰æ‰€æœ‰å¹³å°å¿…éœ€çš„USBè½¯ä»¶åŒ…ï¼ˆæ‰©å±•åˆ—è¡¨ï¼‰
    local MUST_PACKAGES=(
        # æ ¸å¿ƒé©±åŠ¨
        "kmod-usb-core"
        "kmod-usb-common"
        # USB 2.0/3.0 æ§åˆ¶å™¨
        "kmod-usb2"
        "kmod-usb3"
        "kmod-usb-ehci"
        "kmod-usb-ohci"
        "kmod-usb-xhci-hcd"
        "kmod-usb-xhci-pci"
        "kmod-usb-xhci-plat-hcd"
        # USB å­˜å‚¨
        "kmod-usb-storage"
        "kmod-usb-storage-uas"
        "kmod-usb-storage-extras"
        # SCSI æ”¯æŒ
        "kmod-scsi-core"
        "kmod-scsi-generic"
        # é€šç”¨ USB é©±åŠ¨
        "kmod-usb-dwc3"
        "kmod-usb-dwc3-of-simple"
        # æ–‡ä»¶ç³»ç»Ÿ
        "kmod-fs-ext4"
        "kmod-fs-vfat"
        "kmod-fs-exfat"
        "kmod-fs-ntfs3"
        # ç¼–ç æ”¯æŒ
        "kmod-nls-utf8"
        "kmod-nls-cp936"
        # æŒ‚è½½å·¥å…·
        "block-mount"
        "automount"
        # å®ç”¨å·¥å…·
        "usbutils"
        "lsusb"
        # ä¸²å£æ”¯æŒï¼ˆå¯é€‰ä½†å¸¸ç”¨ï¼‰
        "kmod-usb-serial"
    )
    
    # å¹³å°ç‰¹å®šè½¯ä»¶åŒ…ï¼ˆæ‰©å±•ï¼‰
    case "$TARGET" in
        ipq40xx)
            MUST_PACKAGES+=(
                "kmod-usb-dwc3-qcom"
                "kmod-phy-qcom-dwc3"
            )
            ;;
        ramips)
            MUST_PACKAGES+=(
                "kmod-usb-xhci-mtk"
                "kmod-usb-ohci-pci"
                "kmod-usb2-pci"
            )
            ;;
        mediatek)
            MUST_PACKAGES+=(
                "kmod-usb-dwc3-mediatek"
                "kmod-phy-mediatek"
            )
            ;;
        ath79)
            MUST_PACKAGES+=(
                "kmod-usb2-ath79"
                "kmod-usb-ohci"
            )
            ;;
    esac
    
    # å¼ºåˆ¶å†™å…¥.configï¼ˆåˆ é™¤å¯èƒ½å­˜åœ¨çš„ç¦ç”¨/æ¨¡å—è¡Œï¼Œæ·»åŠ =yï¼‰
    for pkg in "${MUST_PACKAGES[@]}"; do
        sed -i "/^CONFIG_PACKAGE_${pkg}=/d" .config
        sed -i "/^# CONFIG_PACKAGE_${pkg} is not set/d" .config
        echo "CONFIG_PACKAGE_${pkg}=y" >> .config
    done
    
    # å†æ¬¡ç¡®ä¿è®¾å¤‡é€‰é¡¹å­˜åœ¨ï¼ˆé˜²æ­¢è¢«è¦†ç›–ï¼‰
    if ! grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" .config; then
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
    fi
    
    # å†æ¬¡å»é‡
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤6: å†æ¬¡è¿è¡Œ defconfig åº”ç”¨å¼ºåˆ¶é…ç½®
    log "ğŸ”„ å†æ¬¡è¿è¡Œ make defconfig åº”ç”¨å¼ºåˆ¶é…ç½®..."
    
    # ä¿å­˜å½“å‰é…ç½®å¤‡ä»½
    cp .config .config.force
    
    # ä½¿ç”¨ -j1 V=s è¿è¡Œä»¥è·å–è¯¦ç»†è¾“å‡º
    if ! make -j1 defconfig V=s > /tmp/build-logs/defconfig.log 2>&1; then
        log "âŒ make defconfig å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—..."
        echo "=== defconfig.log æœ€å50è¡Œ ==="
        tail -50 /tmp/build-logs/defconfig.log
        echo "================================"
        
        # å°è¯•æ¢å¤å¤‡ä»½å¹¶ç»§ç»­
        if [ -f ".config.force" ]; then
            log "ğŸ”„ å°è¯•æ¢å¤å¼ºåˆ¶é…ç½®å¹¶ç»§ç»­..."
            cp .config.force .config
        else
            handle_error "å¼ºåˆ¶é…ç½®åº”ç”¨å¤±è´¥"
        fi
    else
        log "âœ… make defconfig æˆåŠŸ"
    fi
    
    # æ­¥éª¤7: æœ€ç»ˆéªŒè¯
    log "ğŸ“‹ å¿…éœ€USBé©±åŠ¨çŠ¶æ€éªŒè¯:"
    local missing=()
    local missing_optional=()
    
    for pkg in "${MUST_PACKAGES[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${pkg}=y" .config; then
            log "  âœ… $pkg: å·²å¯ç”¨"
        else
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¹³å°ç‰¹å®šåŒ…
            local is_optional=0
            case "$pkg" in
                kmod-usb-dwc3-qcom|kmod-phy-qcom-dwc3|kmod-usb-xhci-mtk|kmod-usb-dwc3-mediatek|kmod-phy-mediatek|kmod-usb2-ath79|kmod-usb-ohci-pci|kmod-usb2-pci)
                    is_optional=1
                    ;;
            esac
            
            if [ $is_optional -eq 1 ]; then
                log "  âš ï¸ $pkg: æœªå¯ç”¨ï¼ˆå¹³å°å¯é€‰ï¼‰"
                missing_optional+=("$pkg")
            else
                log "  âŒ $pkg: æœªå¯ç”¨"
                missing+=("$pkg")
            fi
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        log "âš ï¸ è­¦å‘Š: ä»¥ä¸‹å¿…éœ€é©±åŠ¨æœªå¯ç”¨: ${missing[*]}"
        log "ğŸ’¡ å¯èƒ½åŸå› : å†…æ ¸ä¸æ”¯æŒæˆ–å¹³å°æœªåŒ…å«ç›¸åº”é©±åŠ¨"
    else
        log "ğŸ‰ æ‰€æœ‰å¿…éœ€USBé©±åŠ¨å·²æˆåŠŸå¯ç”¨ï¼"
    fi
    
    if [ ${#missing_optional[@]} -gt 0 ]; then
        log "â„¹ï¸ å¯é€‰é©±åŠ¨æœªå¯ç”¨: ${missing_optional[*]}"
        log "ğŸ’¡ å¦‚æœç¡¬ä»¶éœ€è¦è¿™äº›é©±åŠ¨ï¼Œè¯·æ£€æŸ¥å¹³å°æ”¯æŒ"
    fi
    
    # æœ€ç»ˆè®¾å¤‡éªŒè¯
    local selected_device=$(grep "^CONFIG_TARGET_DEVICE_.*${DEVICE}=y" .config | head -1)
    if [ -n "$selected_device" ]; then
        log "âœ… ç›®æ ‡è®¾å¤‡å·²æ­£ç¡®é€‰æ‹©: $selected_device"
    else
        log "âŒ é”™è¯¯: ç›®æ ‡è®¾å¤‡ $DEVICE æœªè¢«é€‰ä¸­ï¼"
        log "å½“å‰å¯ç”¨çš„è®¾å¤‡é€‰é¡¹:"
        grep "^CONFIG_TARGET_DEVICE_.*=y" .config | head -10
        handle_error "è®¾å¤‡é…ç½®é”™è¯¯"
    fi
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘

#ã€build_firmware_main.sh-14ã€‘
verify_usb_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ğŸš¨ è¯¦ç»†éªŒè¯USBå’Œå­˜å‚¨é…ç½®ï¼ˆå¢å¼ºç‰ˆï¼‰ ==="
    
    echo ""
    echo "1. ğŸŸ¢ USBæ ¸å¿ƒæ¨¡å—:"
    grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" .config && echo "   âœ… kmod-usb-core" || echo "   âŒ kmod-usb-core"
    grep -q "^CONFIG_PACKAGE_kmod-usb-common=y" .config && echo "   âœ… kmod-usb-common" || echo "   âŒ kmod-usb-common"
    
    echo ""
    echo "2. ğŸŸ¢ USBæ§åˆ¶å™¨é©±åŠ¨:"
    echo "   - kmod-usb2:       $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-usb3:       $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-usb-ehci:   $(grep -q "^CONFIG_PACKAGE_kmod-usb-ehci=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-usb-ohci:   $(grep -q "^CONFIG_PACKAGE_kmod-usb-ohci=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-usb-xhci-pci: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-pci=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-usb-xhci-plat-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" .config && echo 'âœ…' || echo 'âŒ')"
    
    echo ""
    echo "3. ğŸš¨ USB 3.0 DWC3 æ ¸å¿ƒé©±åŠ¨:"
    echo "   - kmod-usb-dwc3:   $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-usb-dwc3-of-simple: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y" .config && echo 'âœ…' || echo 'âŒ')"
    
    echo ""
    echo "4. ğŸš¨ å¹³å°ä¸“ç”¨USBæ§åˆ¶å™¨:"
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        echo "   ğŸ”§ æ£€æµ‹åˆ°é«˜é€šIPQ40xxå¹³å°:"
        echo "     - kmod-usb-dwc3-qcom:     $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ…' || echo 'âŒ')"
        echo "     - kmod-phy-qcom-dwc3:     $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ…' || echo 'âŒ')"
    elif [ "$TARGET" = "ramips" ] || grep -q "^CONFIG_TARGET_ramips=y" .config 2>/dev/null; then
        echo "   ğŸ”§ æ£€æµ‹åˆ°é›·å‡ŒMT76xxå¹³å°:"
        echo "     - kmod-usb-xhci-mtk:       $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config && echo 'âœ…' || echo 'âŒ')"
        echo "     - kmod-usb-ohci-pci:       $(grep -q "^CONFIG_PACKAGE_kmod-usb-ohci-pci=y" .config && echo 'âœ…' || echo 'âŒ')"
        echo "     - kmod-usb2-pci:           $(grep -q "^CONFIG_PACKAGE_kmod-usb2-pci=y" .config && echo 'âœ…' || echo 'âŒ')"
    elif [ "$TARGET" = "mediatek" ] || grep -q "^CONFIG_TARGET_mediatek=y" .config 2>/dev/null; then
        echo "   ğŸ”§ æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°:"
        echo "     - kmod-usb-dwc3-mediatek:  $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-mediatek=y" .config && echo 'âœ…' || echo 'âŒ')"
        echo "     - kmod-phy-mediatek:       $(grep -q "^CONFIG_PACKAGE_kmod-phy-mediatek=y" .config && echo 'âœ…' || echo 'âŒ')"
    elif [ "$TARGET" = "ath79" ] || grep -q "^CONFIG_TARGET_ath79=y" .config 2>/dev/null; then
        echo "   ğŸ”§ æ£€æµ‹åˆ°é«˜é€šATH79å¹³å°:"
        echo "     - kmod-usb2-ath79:         $(grep -q "^CONFIG_PACKAGE_kmod-usb2-ath79=y" .config && echo 'âœ…' || echo 'âŒ')"
        echo "     - kmod-usb-ohci:           $(grep -q "^CONFIG_PACKAGE_kmod-usb-ohci=y" .config && echo 'âœ…' || echo 'âŒ')"
    fi
    
    echo ""
    echo "5. ğŸŸ¢ USBå­˜å‚¨é©±åŠ¨:"
    echo "   - kmod-usb-storage:        $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-usb-storage-uas:    $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage-uas=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-usb-storage-extras: $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage-extras=y" .config && echo 'âœ…' || echo 'âŒ')"
    
    echo ""
    echo "6. ğŸŸ¢ SCSIæ”¯æŒ:"
    echo "   - kmod-scsi-core:    $(grep -q "^CONFIG_PACKAGE_kmod-scsi-core=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-scsi-generic: $(grep -q "^CONFIG_PACKAGE_kmod-scsi-generic=y" .config && echo 'âœ…' || echo 'âŒ')"
    
    echo ""
    echo "7. ğŸŸ¢ æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ:"
    echo "   - kmod-fs-ext4:  $(grep -q "^CONFIG_PACKAGE_kmod-fs-ext4=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-fs-vfat:  $(grep -q "^CONFIG_PACKAGE_kmod-fs-vfat=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-fs-exfat: $(grep -q "^CONFIG_PACKAGE_kmod-fs-exfat=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-fs-ntfs3: $(grep -q "^CONFIG_PACKAGE_kmod-fs-ntfs3=y" .config && echo 'âœ…' || echo 'âŒ')"
    
    echo ""
    echo "8. ğŸŸ¢ ç¼–ç æ”¯æŒ:"
    echo "   - kmod-nls-utf8:  $(grep -q "^CONFIG_PACKAGE_kmod-nls-utf8=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - kmod-nls-cp936: $(grep -q "^CONFIG_PACKAGE_kmod-nls-cp936=y" .config && echo 'âœ…' || echo 'âŒ')"
    
    echo ""
    echo "9. ğŸŸ¢ è‡ªåŠ¨æŒ‚è½½å·¥å…·:"
    echo "   - block-mount: $(grep -q "^CONFIG_PACKAGE_block-mount=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - automount:   $(grep -q "^CONFIG_PACKAGE_automount=y" .config && echo 'âœ…' || echo 'âŒ')"
    
    echo ""
    echo "10. ğŸŸ¢ USBå®ç”¨å·¥å…·:"
    echo "   - usbutils: $(grep -q "^CONFIG_PACKAGE_usbutils=y" .config && echo 'âœ…' || echo 'âŒ')"
    echo "   - lsusb:    $(grep -q "^CONFIG_PACKAGE_lsusb=y" .config && echo 'âœ…' || echo 'âŒ')"
    
    echo ""
    echo "=== ğŸš¨ USBé…ç½®éªŒè¯å®Œæˆ ==="
    
    log "ğŸ“Š USBé…ç½®çŠ¶æ€æ€»ç»“:"
    local usb_drivers=("kmod-usb-core" "kmod-usb2" "kmod-usb3" "kmod-usb-xhci-hcd" "kmod-usb-storage" "kmod-scsi-core" "kmod-fs-ext4")
    local missing_count=0
    local enabled_count=0
    
    for driver in "${usb_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "  âœ… $driver: å·²å¯ç”¨"
            enabled_count=$((enabled_count + 1))
        else
            log "  âŒ $driver: æœªå¯ç”¨"
            missing_count=$((missing_count + 1))
        fi
    done
    
    log "ğŸ“ˆ ç»Ÿè®¡: $enabled_count ä¸ªå·²å¯ç”¨ï¼Œ$missing_count ä¸ªæœªå¯ç”¨"
    
    if [ $missing_count -gt 0 ]; then
        log "âš ï¸ è­¦å‘Š: æœ‰ $missing_count ä¸ªå…³é”®USBé©±åŠ¨æœªå¯ç”¨ï¼Œå¯èƒ½ä¼šå½±å“USBåŠŸèƒ½"
    else
        log "ğŸ‰ æ­å–œ: æ‰€æœ‰å…³é”®USBé©±åŠ¨éƒ½å·²å¯ç”¨"
    fi
}
#ã€build_firmware_main.sh-14-endã€‘

#ã€build_firmware_main.sh-15ã€‘
check_usb_drivers_integrity() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ğŸš¨ USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ï¼ˆå¢å¼ºç‰ˆï¼‰ ==="
    
    local missing_drivers=()
    local required_drivers=(
        # æ ¸å¿ƒé©±åŠ¨
        "kmod-usb-core"
        "kmod-usb2"
        "kmod-usb3"
        "kmod-usb-xhci-hcd"
        "kmod-usb-storage"
        "kmod-scsi-core"
        "kmod-fs-ext4"
        "kmod-fs-vfat"
        # æ‰©å±•é©±åŠ¨ï¼ˆæ¨èå¯ç”¨ï¼‰
        "kmod-usb-xhci-pci"
        "kmod-usb-xhci-plat-hcd"
        "kmod-usb-storage-uas"
        "kmod-scsi-generic"
        "kmod-fs-exfat"
        "kmod-fs-ntfs3"
        "kmod-nls-utf8"
        "kmod-nls-cp936"
    )
    
    # æ ¹æ®å¹³å°æ·»åŠ ä¸“ç”¨é©±åŠ¨
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        required_drivers+=("kmod-usb-dwc3-qcom" "kmod-phy-qcom-dwc3" "kmod-usb-dwc3" "kmod-usb-dwc3-of-simple")
    elif [ "$TARGET" = "ramips" ] || grep -q "^CONFIG_TARGET_ramips=y" .config 2>/dev/null; then
        required_drivers+=("kmod-usb-xhci-mtk" "kmod-usb-ohci-pci" "kmod-usb2-pci")
    elif [ "$TARGET" = "mediatek" ] || grep -q "^CONFIG_TARGET_mediatek=y" .config 2>/dev/null; then
        required_drivers+=("kmod-usb-dwc3-mediatek" "kmod-phy-mediatek" "kmod-usb-dwc3")
    elif [ "$TARGET" = "ath79" ] || grep -q "^CONFIG_TARGET_ath79=y" .config 2>/dev/null; then
        required_drivers+=("kmod-usb2-ath79" "kmod-usb-ohci")
    fi
    
    # æ£€æŸ¥æ¯ä¸ªé©±åŠ¨
    for driver in "${required_drivers[@]}"; do
        if ! grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "âŒ ç¼ºå¤±é©±åŠ¨: $driver"
            missing_drivers+=("$driver")
        else
            log "âœ… é©±åŠ¨å­˜åœ¨: $driver"
        fi
    done
    
    # å¦‚æœæœ‰ç¼ºå¤±é©±åŠ¨ï¼Œå°è¯•ä¿®å¤
    if [ ${#missing_drivers[@]} -gt 0 ]; then
        log "ğŸš¨ å‘ç° ${#missing_drivers[@]} ä¸ªç¼ºå¤±çš„USBé©±åŠ¨"
        log "æ­£åœ¨å°è¯•ä¿®å¤..."
        
        for driver in "${missing_drivers[@]}"; do
            echo "CONFIG_PACKAGE_${driver}=y" >> .config
            log "âœ… å·²æ·»åŠ : $driver"
        done
        
        # é‡æ–°è¿è¡Œdefconfig
        make defconfig || log "âš ï¸ make defconfig ä¿®å¤åä»æœ‰é—®é¢˜"
        log "âœ… USBé©±åŠ¨ä¿®å¤å®Œæˆ"
    else
        log "ğŸ‰ æ‰€æœ‰å¿…éœ€USBé©±åŠ¨éƒ½å·²å¯ç”¨"
    fi
}
#ã€build_firmware_main.sh-15-endã€‘
