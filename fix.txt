#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…ï¼ˆç»¼åˆä¿®å¤ç‰ˆï¼‰==="
    
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åº”ç”¨é…ç½®"
        return 1
    fi
    
    log "ğŸ“‹ é…ç½®è¯¦æƒ…:"
    log "é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "é…ç½®è¡Œæ•°: $(wc -l < .config)"
    
    local backup_file=".config.bak.$(date +%Y%m%d%H%M%S)"
    cp .config "$backup_file"
    log "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½: $backup_file"
    
    log "ğŸ”§ æ­¥éª¤1: æ ‡å‡†åŒ–é…ç½®æ–‡ä»¶æ ¼å¼..."
    
    if [ -f ".config" ]; then
        awk '
        {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if ($0 ~ /^#/) {
                if ($0 ~ /^#CONFIG_/) {
                    $0 = "# " substr($0, 2)
                }
                if ($0 !~ /is not set$/) {
                    $0 = $0 " is not set"
                }
            }
            if ($0 ~ /^CONFIG_/) {
                if ($0 ~ /y$|m$|=$/) {
                    gsub(/[[:space:]]*=[[:space:]]*y$/, "=y")
                    gsub(/[[:space:]]*=[[:space:]]*m$/, "=m")
                    gsub(/[[:space:]]*=[[:space:]]*$/, "=")
                }
            }
            if (length($0) > 0) {
                print $0
            }
        }' .config > .config.tmp
        
        mv .config.tmp .config
        log "âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ ‡å‡†åŒ–å®Œæˆ"
    else
        log "âŒ .config æ–‡ä»¶åœ¨æ“ä½œè¿‡ç¨‹ä¸­ä¸¢å¤±"
        return 1
    fi
    
    log "ğŸ”§ æ­¥éª¤2: æ¸…ç†é‡å¤é…ç½®è¡Œ..."
    
    local dup_before=$(wc -l < .config)
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    local dup_after=$(wc -l < .config)
    local dup_removed=$((dup_before - dup_after))
    
    if [ $dup_removed -gt 0 ]; then
        log "âœ… å·²åˆ é™¤ $dup_removed ä¸ªå®Œå…¨é‡å¤çš„é…ç½®è¡Œ"
    fi
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    local config_uniq_removed=$((dup_after - $(wc -l < .config)))
    if [ $config_uniq_removed -gt 0 ]; then
        log "âœ… å·²åˆå¹¶ $config_uniq_removed ä¸ªé‡å¤é…ç½®é¡¹"
    fi
    
    log "ğŸ”§ æ­¥éª¤3: æ£€æŸ¥libustreamå†²çª..."
    
    local openssl_enabled=0
    local wolfssl_enabled=0
    
    if grep -q "^CONFIG_PACKAGE_libustream-openssl=y" .config; then
        openssl_enabled=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_libustream-wolfssl=y" .config; then
        wolfssl_enabled=1
    fi
    
    if [ $openssl_enabled -eq 1 ] && [ $wolfssl_enabled -eq 1 ]; then
        log "âš ï¸ å‘ç°libustream-opensslå’Œlibustream-wolfsslå†²çª"
        log "ğŸ”§ ä¿®å¤å†²çª: ç¦ç”¨libustream-openssl"
        
        awk '
        /^CONFIG_PACKAGE_libustream-openssl=y/ {
            print "# CONFIG_PACKAGE_libustream-openssl is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config
        
        log "âœ… å†²çªå·²ä¿®å¤"
    fi
    
    log "ğŸ”§ æ­¥éª¤4: ä½¿ç”¨OpenWrtå®˜æ–¹é…ç½®å·¥å…·å¼ºåˆ¶ä¿®å¤å…³é”®é…ç½®..."
    
    if [ ! -f "scripts/config" ]; then
        log "âš ï¸ scripts/configå·¥å…·ä¸å­˜åœ¨ï¼Œç¼–è¯‘ç”Ÿæˆä¸­..."
        make scripts/config || {
            log "âŒ æ— æ³•ç”Ÿæˆscripts/configå·¥å…·"
            log "âš ï¸ å°†ä½¿ç”¨awkæ–¹å¼è¿›è¡Œä¿®å¤"
        }
    fi
    
    log "  ğŸ”§ USB 3.0é©±åŠ¨ä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-xhci-hcd
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb3
    else
        awk '
        /^# CONFIG_PACKAGE_kmod-usb-xhci-hcd is not set/ {
            print "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
            next
        }
        /^CONFIG_PACKAGE_kmod-usb-xhci-hcd=.*/ {
            print "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config.tmp; then
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config.tmp
        fi
        
        awk '
        /^# CONFIG_PACKAGE_kmod-usb3 is not set/ {
            print "CONFIG_PACKAGE_kmod-usb3=y"
            next
        }
        /^CONFIG_PACKAGE_kmod-usb3=.*/ {
            print "CONFIG_PACKAGE_kmod-usb3=y"
            next
        }
        { print $0 }
        ' .config.tmp > .config
        rm -f .config.tmp
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
            echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        fi
    fi
    log "  âœ… USB 3.0é©±åŠ¨å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        log "  ğŸ”§ IPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨ä¿®å¤..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3-qcom
            ./scripts/config --enable CONFIG_PACKAGE_kmod-phy-qcom-dwc3
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3
        else
            if ! grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config; then
                echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
                echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
            fi
        fi
        log "  âœ… IPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨ä¿®å¤å®Œæˆ"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  ğŸ”§ TurboACCé…ç½®ä¿®å¤..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_luci-app-turboacc
            ./scripts/config --enable CONFIG_PACKAGE_kmod-shortcut-fe
            ./scripts/config --enable CONFIG_PACKAGE_kmod-fast-classifier
        else
            if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
                echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-shortcut-fe=y" .config; then
                echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-fast-classifier=y" .config; then
                echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
            fi
        fi
        log "  âœ… TurboACCé…ç½®ä¿®å¤å®Œæˆ"
    fi
    
    log "  ğŸ”§ TCP BBRæ‹¥å¡æ§åˆ¶ä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-tcp-bbr
        ./scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
    else
        if ! grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        
        awk '!/^CONFIG_DEFAULT_TCP_CONG=/' .config > .config.tmp
        mv .config.tmp .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    fi
    log "  âœ… TCP BBRæ‹¥å¡æ§åˆ¶ä¿®å¤å®Œæˆ"
    
    log "  ğŸ”§ kmod-ath10k-ctå†²çªä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-pci
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-smallbuffers
        ./scripts/config --enable CONFIG_PACKAGE_kmod-ath10k-ct
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers
    else
        awk '
        /^CONFIG_PACKAGE_kmod-ath10k=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-pci=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-pci is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-ath10k-ct=y" .config; then
            echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        fi
    fi
    log "  âœ… kmod-ath10k-ctå†²çªä¿®å¤å®Œæˆ"
    
    log "ğŸ”§ æ­¥éª¤5: æœ€ç»ˆå»é‡å’Œæ ¼å¼æ£€æŸ¥..."
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    awk 'NF > 0' .config > .config.tmp
    mv .config.tmp .config
    
    log "âœ… æœ€ç»ˆå»é‡å®Œæˆ"
    
    log "ğŸ”„ æ­¥éª¤6: è¿è¡Œ make defconfig..."
    make defconfig || handle_error "åº”ç”¨é…ç½®å¤±è´¥"
    
    log "ğŸ”§ æ­¥éª¤7: éªŒè¯å…³é”®é…ç½®..."
    
    echo ""
    echo "=== ğŸ” USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰ ==="
    
    echo ""
    echo "ğŸ” æ£€æŸ¥åŸºç¡€USBé©±åŠ¨..."
    local required_drivers=(
        "kmod-usb-core"
        "kmod-usb2"
        "kmod-usb-storage"
        "kmod-scsi-core"
    )
    
    for driver in "${required_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "âœ… $driver: å·²å¯ç”¨"
        else
            echo "âŒ $driver: æœªå¯ç”¨"
        fi
    done
    
    echo ""
    echo "ğŸ” æ£€æŸ¥USB 3.0é©±åŠ¨..."
    local usb3_drivers=(
        "kmod-usb3"
        "kmod-usb-xhci-hcd"
    )
    
    for driver in "${usb3_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "âœ… $driver: å·²å¯ç”¨"
        else
            echo "âš ï¸ $driver: æœªå¯ç”¨ï¼ˆå¦‚æœè®¾å¤‡æ”¯æŒUSB 3.0å¯èƒ½éœ€è¦ï¼‰"
        fi
    done
    
    echo ""
    echo "ğŸ” æ£€æŸ¥å¹³å°ä¸“ç”¨é©±åŠ¨..."
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        echo "ğŸ”§ æ£€æµ‹åˆ°é«˜é€šIPQ40xxå¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
        local ipq40xx_drivers=(
            "kmod-usb-dwc3-qcom"
            "kmod-phy-qcom-dwc3"
            "kmod-usb-dwc3"
        )
        for driver in "${ipq40xx_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                echo "âœ… $driver: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ $driver: æœªå¯ç”¨ï¼ˆå¯èƒ½ä¸æ˜¯å¿…éœ€ï¼‰"
            fi
        done
    elif [ "$TARGET" = "ramips" ] || grep -q "^CONFIG_TARGET_ramips=y" .config 2>/dev/null; then
        echo "ğŸ”§ æ£€æµ‹åˆ°é›·å‡ŒMT76xxå¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
        local ramips_drivers=(
            "kmod-usb-xhci-mtk"
            "kmod-usb-ohci-pci"
            "kmod-usb2-pci"
        )
        for driver in "${ramips_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                echo "âœ… $driver: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ $driver: æœªå¯ç”¨ï¼ˆå¯èƒ½ä¸æ˜¯å¿…éœ€ï¼‰"
            fi
        done
    elif [ "$TARGET" = "ath79" ] || grep -q "^CONFIG_TARGET_ath79=y" .config 2>/dev/null; then
        echo "ğŸ”§ æ£€æµ‹åˆ°é«˜é€šATH79å¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
        local ath79_drivers=(
            "kmod-usb2-ath79"
            "kmod-usb-ohci"
        )
        for driver in "${ath79_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                echo "âœ… $driver: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ $driver: æœªå¯ç”¨ï¼ˆå¯èƒ½ä¸æ˜¯å¿…éœ€ï¼‰"
            fi
        done
    elif [ "$TARGET" = "mediatek" ] || grep -q "^CONFIG_TARGET_mediatek=y" .config 2>/dev/null; then
        echo "ğŸ”§ æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
        local mediatek_drivers=(
            "kmod-usb-dwc3-mediatek"
            "kmod-phy-mediatek"
            "kmod-usb-dwc3"
        )
        for driver in "${mediatek_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                echo "âœ… $driver: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ $driver: æœªå¯ç”¨ï¼ˆå¯èƒ½ä¸æ˜¯å¿…éœ€ï¼‰"
            fi
        done
    fi
    
    echo ""
    echo "=== ğŸ“¦ æ’ä»¶é…ç½®çŠ¶æ€ ==="
    
    local functional_plugins=(
        "luci-app-turboacc:TurboACC ç½‘ç»œåŠ é€Ÿ"
        "luci-app-upnp:UPnP è‡ªåŠ¨ç«¯å£è½¬å‘"
        "samba4-server:Samba æ–‡ä»¶å…±äº«"
        "luci-app-diskman:ç£ç›˜ç®¡ç†"
        "vlmcsd:KMS æ¿€æ´»æœåŠ¡"
        "smartdns:SmartDNS æ™ºèƒ½DNS"
        "luci-app-accesscontrol:å®¶é•¿æ§åˆ¶"
        "luci-app-wechatpush:å¾®ä¿¡æ¨é€"
        "sqm-scripts:æµé‡æ§åˆ¶ (SQM)"
        "vsftpd:FTP æœåŠ¡å™¨"
        "luci-app-arpbind:ARP ç»‘å®š"
        "luci-app-cpulimit:CPU é™åˆ¶"
        "luci-app-hd-idle:ç¡¬ç›˜ä¼‘çœ "
    )
    
    for plugin_entry in "${functional_plugins[@]}"; do
        local plugin="${plugin_entry%%:*}"
        local desc="${plugin_entry#*:}"
        
        if grep -q "^CONFIG_PACKAGE_${plugin}=y" .config; then
            echo "âœ… $desc: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${plugin}=m" .config; then
            echo "ğŸ“¦ $desc: æ¨¡å—åŒ–"
        elif grep -q "^# CONFIG_PACKAGE_${plugin} is not set" .config; then
            echo "âŒ $desc: å·²ç¦ç”¨"
        else
            echo "âšª $desc: æœªé…ç½®"
        fi
    done
    
    echo ""
    echo "=== ğŸ“Š é…ç½®ç»Ÿè®¡ ==="
    local enabled_count=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config 2>/dev/null || echo "0")
    local module_count=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config 2>/dev/null || echo "0")
    local disabled_count=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config 2>/dev/null || echo "0")
    echo "âœ… å·²å¯ç”¨æ’ä»¶: $enabled_count ä¸ª"
    echo "ğŸ“¦ æ¨¡å—åŒ–æ’ä»¶: $module_count ä¸ª"
    echo "âŒ å·²ç¦ç”¨æ’ä»¶: $disabled_count ä¸ª"
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
    log "æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "æœ€ç»ˆé…ç½®å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "æœ€ç»ˆé…ç½®è¡Œæ•°: $(wc -l < .config)"
}
#ã€build_firmware_main.sh-16-endã€‘

