#„Äêbuild_firmware_main.sh-06„Äë
initialize_build_env() {
    local device_name=$1
    local version_selection=$2
    local config_mode=$3
    
    cd $BUILD_DIR || handle_error "ËøõÂÖ•ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
    
    log "=== ÁâàÊú¨ÈÄâÊã© ==="
    if [ "$version_selection" = "23.05" ]; then
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-23.05"
    else
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-21.02"
    fi
    log "‚úÖ ÁâàÊú¨ÈÄâÊã©ÂÆåÊàê: $SELECTED_BRANCH"
    
    log "=== ÂÖãÈöÜÊ∫êÁ†Å ==="
    log "‰ªìÂ∫ì: $SELECTED_REPO_URL"
    log "ÂàÜÊîØ: $SELECTED_BRANCH"
    
    sudo rm -rf ./* ./.git* 2>/dev/null || true
    
    git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . || handle_error "ÂÖãÈöÜÊ∫êÁ†ÅÂ§±Ë¥•"
    log "‚úÖ Ê∫êÁ†ÅÂÖãÈöÜÂÆåÊàê"
    
    local important_source_files=("Makefile" "feeds.conf.default" "rules.mk" "Config.in")
    for file in "${important_source_files[@]}"; do
        if [ -f "$file" ]; then
            log "‚úÖ Ê∫êÁ†ÅÊñá‰ª∂Â≠òÂú®: $file"
        else
            log "‚ùå Ê∫êÁ†ÅÊñá‰ª∂Áº∫Â§±: $file"
        fi
    done
    
    log "=== ËÆæÂ§áÈÖçÁΩÆ ==="
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "üîç Ë∞ÉÁî®support.shËé∑ÂèñËÆæÂ§áÂπ≥Âè∞‰ø°ÊÅØ..."
        PLATFORM_INFO=$("$SUPPORT_SCRIPT" get-platform "$device_name")
        if [ -n "$PLATFORM_INFO" ]; then
            TARGET=$(echo "$PLATFORM_INFO" | awk '{print $1}')
            SUBTARGET=$(echo "$PLATFORM_INFO" | awk '{print $2}')
            DEVICE="$device_name"
            log "‚úÖ ‰ªésupport.shËé∑ÂèñÂπ≥Âè∞‰ø°ÊÅØ: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
        else
            log "‚ùå Êó†Ê≥ï‰ªésupport.shËé∑ÂèñÂπ≥Âè∞‰ø°ÊÅØ"
            handle_error "Ëé∑ÂèñÂπ≥Âè∞‰ø°ÊÅØÂ§±Ë¥•"
        fi
    else
        log "‚ùå support.sh‰∏çÂ≠òÂú®"
        handle_error "support.shËÑöÊú¨Áº∫Â§±"
    fi
    
    log "üîß ËÆæÂ§á: $device_name"
    log "üîß ÁõÆÊ†áÂπ≥Âè∞: $TARGET/$SUBTARGET"
    
    CONFIG_MODE="$config_mode"
    
    log "ÁõÆÊ†á: $TARGET"
    log "Â≠êÁõÆÊ†á: $SUBTARGET"
    log "ËÆæÂ§á: $DEVICE"
    log "ÈÖçÁΩÆÊ®°Âºè: $CONFIG_MODE"
    
    # üî• ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁ´ãÂç≥ÁºñËØëscripts/configÂ∑•ÂÖ∑
    log "=== ÁºñËØëÈÖçÁΩÆÂ∑•ÂÖ∑ ==="
    log "üîß ÁºñËØëscripts/configÂ∑•ÂÖ∑..."
    make scripts/config || handle_error "ÁºñËØëscripts/configÂ∑•ÂÖ∑Â§±Ë¥•"
    log "‚úÖ scripts/configÂ∑•ÂÖ∑ÁºñËØëÊàêÂäü"
    log "üìÅ Â∑•ÂÖ∑‰ΩçÁΩÆ: $(pwd)/scripts/config"
    
    save_env
    
    echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
    echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
    echo "TARGET=$TARGET" >> $GITHUB_ENV
    echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
    echo "DEVICE=$DEVICE" >> $GITHUB_ENV
    echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
    
    log "‚úÖ ÊûÑÂª∫ÁéØÂ¢ÉÂàùÂßãÂåñÂÆåÊàê"
}
#„Äêbuild_firmware_main.sh-06-end„Äë

#„Äêbuild_firmware_main.sh-13„Äë
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "ËøõÂÖ•ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
    
    log "=== Êô∫ËÉΩÈÖçÁΩÆÁîüÊàêÁ≥ªÁªüÔºàÁ∫Øscripts/configÁâàÔºâ==="
    log "ÁâàÊú¨: $SELECTED_BRANCH"
    log "ÁõÆÊ†á: $TARGET"
    log "Â≠êÁõÆÊ†á: $SUBTARGET"
    log "ËÆæÂ§á: $DEVICE"
    log "ÈÖçÁΩÆÊ®°Âºè: $CONFIG_MODE"
    log "ÈÖçÁΩÆÊñá‰ª∂ÁõÆÂΩï: $CONFIG_DIR"
    
    # Âà†Èô§ÊóßÈÖçÁΩÆ
    rm -f .config .config.old .config.bak*
    log "‚úÖ Â∑≤Ê∏ÖÁêÜÊóßÈÖçÁΩÆÊñá‰ª∂"
    
    # ÁîüÊàêÂü∫Á°ÄÁõÆÊ†áÈÖçÁΩÆ
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "üîß ÁîüÊàêÂü∫Á°ÄÈÖçÁΩÆ..."
    make defconfig || handle_error "Âü∫Á°ÄÈÖçÁΩÆÁîüÊàêÂ§±Ë¥•"
    log "‚úÖ Âü∫Á°ÄÈÖçÁΩÆÁîüÊàêÊàêÂäü"
    
    # üî• È™åËØÅscripts/configÂ∑•ÂÖ∑Â≠òÂú®ÔºàÊ≠•È™§06Â∑≤ÁºñËØëÔºâ
    if [ ! -f "scripts/config" ]; then
        log "‚ùå scripts/configÂ∑•ÂÖ∑‰∏çÂ≠òÂú®ÔºåËØ∑Ê£ÄÊü•Ê≠•È™§06"
        handle_error "scripts/configÂ∑•ÂÖ∑Áº∫Â§±"
    fi
    log "‚úÖ scripts/configÂ∑•ÂÖ∑Â∑≤Â∞±Áª™"
    
    log "üîß ‰ΩøÁî®scripts/configÂ∑•ÂÖ∑ÂêàÂπ∂ÈÖçÁΩÆ..."
    
    # 1. Â∫îÁî®USBÈÄöÁî®ÈÖçÁΩÆ
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "üìÅ Â∫îÁî®USBÈÄöÁî®ÈÖçÁΩÆ..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$CONFIG_DIR/usb-generic.config"
        log "‚úÖ USBÈÄöÁî®ÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    # 2. Â∫îÁî®Âü∫Á°ÄÈÖçÁΩÆ
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "üìÅ Â∫îÁî®Âü∫Á°ÄÈÖçÁΩÆ..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$CONFIG_DIR/base.config"
        log "‚úÖ Âü∫Á°ÄÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    # 3. Â∫îÁî®ËÆæÂ§áÈÖçÁΩÆÊàñÊ®°ÂºèÈÖçÁΩÆ
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "üìÅ Â∫îÁî®ËÆæÂ§áÈÖçÁΩÆ: $DEVICE.config..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$device_config_file"
        log "‚úÖ ËÆæÂ§áÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "üìÅ Â∫îÁî®Ê≠£Â∏∏Ê®°ÂºèÈÖçÁΩÆ..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            # Ë∑≥ËøáTurboACCÈùôÊÄÅÈÖçÁΩÆ
            if echo "$line" | grep -q "luci-app-turboacc\|kmod-shortcut-fe\|kmod-fast-classifier"; then
                continue
            fi
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$CONFIG_DIR/normal.config"
        log "‚úÖ Ê≠£Â∏∏Ê®°ÂºèÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    # 4. Â∫îÁî®Âπ≥Âè∞‰∏ìÁî®ÈÖçÁΩÆ
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "üìÅ Â∫îÁî®Âπ≥Âè∞ÈÖçÁΩÆ: $(basename "$platform_config")..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$platform_config"
        log "‚úÖ Âπ≥Âè∞ÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    # 5. Ê∑ªÂä†È¢ùÂ§ñÂåÖ
    if [ -n "$extra_packages" ]; then
        log "üì¶ Ê∑ªÂä†È¢ùÂ§ñÂåÖ: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            if [ -n "$pkg" ]; then
                ./scripts/config --enable "PACKAGE_$pkg"
                log "‚úÖ Ê∑ªÂä†ÂåÖ: $pkg"
            fi
        done
    fi
    
    # 6. Âº∫Âà∂ÂêØÁî®ÂÖ≥ÈîÆÈÖçÁΩÆ
    log "üîß Âº∫Âà∂ÂêØÁî®ÂÖ≥ÈîÆÈÖçÁΩÆ..."
    ./scripts/config --enable PACKAGE_kmod-usb-xhci-hcd
    ./scripts/config --enable PACKAGE_kmod-usb3
    ./scripts/config --enable PACKAGE_kmod-tcp-bbr
    ./scripts/config --set-str DEFAULT_TCP_CONG "bbr"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        ./scripts/config --enable PACKAGE_luci-app-turboacc
        ./scripts/config --enable PACKAGE_kmod-shortcut-fe
        ./scripts/config --enable PACKAGE_kmod-fast-classifier
        log "‚úÖ TurboACCÈÖçÁΩÆÂº∫Âà∂ÂêØÁî®ÂÆåÊàê"
    fi
    
    # 7. Â§ÑÁêÜath10kÂÜ≤Á™Å
    ./scripts/config --disable PACKAGE_kmod-ath10k
    ./scripts/config --disable PACKAGE_kmod-ath10k-pci
    ./scripts/config --disable PACKAGE_kmod-ath10k-smallbuffers
    ./scripts/config --disable PACKAGE_kmod-ath10k-ct-smallbuffers
    ./scripts/config --enable PACKAGE_kmod-ath10k-ct
    log "‚úÖ ath10kÂÜ≤Á™Å‰øÆÂ§çÂÆåÊàê"
    
    # 8. ÊúÄÁªàdefconfig
    log "üîÑ ËøêË°åÊúÄÁªà make defconfig..."
    make defconfig || handle_error "ÊúÄÁªàÈÖçÁΩÆÂ∫îÁî®Â§±Ë¥•"
    
    log "üìä ÈÖçÁΩÆÁîüÊàêÁªüËÆ°:"
    log "  - ÊúÄÁªàÈÖçÁΩÆÊñá‰ª∂: .config"
    log "  - ÈÖçÁΩÆË°åÊï∞: $(wc -l < .config)"
    log "  - ÈÖçÁΩÆÊñá‰ª∂Â§ßÂ∞è: $(ls -lh .config | awk '{print $5}')"
    
    log "‚úÖ ÈÖçÁΩÆÁîüÊàêÂÆåÊàê"
}
#„Äêbuild_firmware_main.sh-13-end„Äë

#„Äêbuild_firmware_main.sh-31„Äë
workflow_step15_generate_config() {
    local extra_packages="$1"
    
    log "=== Ê≠•È™§15: Êô∫ËÉΩÈÖçÁΩÆÁîüÊàêÔºàÁ∫Øscripts/configÁâàÔºâ==="
    
    set -e
    trap 'echo "‚ùå Ê≠•È™§15 Â§±Ë¥•ÔºåÈÄÄÂá∫‰ª£Á†Å: $?"; exit 1' ERR
    
    # scripts/configÂ∑•ÂÖ∑Â∑≤Âú®Ê≠•È™§06ÁºñËØëÂÆåÊàêÔºåÁõ¥Êé•Ë∞ÉÁî®
    generate_config "$extra_packages"
    
    log "‚úÖ Ê≠•È™§15 ÂÆåÊàê"
}
#„Äêbuild_firmware_main.sh-31-end„Äë

