#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®ï¼ˆç‰©ç†åˆ é™¤ç¬¬138è¡Œç‰ˆï¼‰==="
    
    log "ğŸ”§ æ­¥éª¤1: å…ˆè¿è¡Œdefconfigï¼Œæ•è·é”™è¯¯"
    
    # è¿è¡Œdefconfigï¼Œå…è®¸å¤±è´¥
    set +e
    make defconfig 2>&1 | tee /tmp/defconfig_error.log
    local defconfig_exit_code=${PIPESTATUS[0]}
    set -e
    
    if [ $defconfig_exit_code -eq 0 ]; then
        log "âœ… make defconfig æˆåŠŸ"
        return 0
    fi
    
    log "âŒ make defconfig å¤±è´¥ï¼Œé€€å‡ºç : $defconfig_exit_code"
    
    log "ğŸ”§ æ­¥éª¤2: å®šä½ç¬¬138è¡Œé”™è¯¯"
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬138è¡Œé”™è¯¯
    if grep -q "\.config:138:" /tmp/defconfig_error.log; then
        log "âœ… æ£€æµ‹åˆ°ç¬¬138è¡Œé”™è¯¯ï¼Œç«‹å³æ‰§è¡Œç‰©ç†åˆ é™¤"
        
        # ç›´æ¥ç‰©ç†åˆ é™¤ç¬¬138è¡Œï¼
        if [ -f ".config" ]; then
            log "ğŸ“‹ åˆ é™¤å‰çš„.configç¬¬138è¡Œ:"
            sed -n '138p' .config 2>/dev/null || echo "  ç¬¬138è¡Œä¸å­˜åœ¨"
            
            # ä½¿ç”¨sedç›´æ¥åˆ é™¤ç¬¬138è¡Œ
            sed -i '138d' .config 2>/dev/null || true
            
            log "ğŸ“‹ åˆ é™¤åçš„.configç¬¬138è¡Œ:"
            sed -n '138p' .config 2>/dev/null || echo "  âœ… ç¬¬138è¡Œå·²ä¸å­˜åœ¨"
        fi
        
        log "ğŸ”„ æ­¥éª¤3: é‡æ–°è¿è¡Œdefconfig"
        
        if make defconfig; then
            log "âœ… ç‰©ç†åˆ é™¤ç¬¬138è¡Œåï¼Œmake defconfigæˆåŠŸï¼"
            return 0
        else
            log "âŒ ä»ç„¶å¤±è´¥ï¼Œç»§ç»­æ­¥éª¤4"
        fi
    fi
    
    log "ğŸ”§ æ­¥éª¤4: æ·±åº¦æ‰«ææ‰€æœ‰.configæ–‡ä»¶"
    
    # æ‰«ææ•´ä¸ªæ„å»ºç›®å½•çš„æ‰€æœ‰.configæ–‡ä»¶
    find $BUILD_DIR -name ".config*" -type f 2>/dev/null | while read config_file; do
        log "ğŸ” æ£€æŸ¥: $config_file"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰ç¬¬138è¡Œ
        local line_count=$(wc -l < "$config_file" 2>/dev/null || echo "0")
        if [ "$line_count" -ge 138 ]; then
            local line_138=$(sed -n '138p' "$config_file" 2>/dev/null)
            log "  ğŸ“ ç¬¬138è¡Œå­˜åœ¨: $line_138"
            
            # ç‰©ç†åˆ é™¤ç¬¬138è¡Œ
            sed -i '138d' "$config_file" 2>/dev/null || true
            log "  âœ… å·²åˆ é™¤ $config_file çš„ç¬¬138è¡Œ"
        fi
    done
    
    log "ğŸ”„ æ­¥éª¤5: ç¬¬ä¸‰æ¬¡è¿è¡Œdefconfig"
    
    if make defconfig; then
        log "âœ… æ·±åº¦æ‰«æä¿®å¤åï¼Œmake defconfigæˆåŠŸï¼"
        return 0
    fi
    
    log "ğŸ”§ æ­¥éª¤6: ç»ˆææ–¹æ¡ˆ - æ‰‹åŠ¨åˆ›å»ºå®Œç¾é…ç½®æ–‡ä»¶"
    
    # å®Œå…¨åˆ é™¤æ‰€æœ‰é…ç½®æ–‡ä»¶
    rm -f .config .config.old
    rm -f tmp/.config* 2>/dev/null || true
    rm -f staging_dir/.config* 2>/dev/null || true
    
    # åˆ›å»ºä¸€ä¸ªç»å¯¹å¹²å‡€çš„é…ç½®æ–‡ä»¶
    cat > .config << 'EOF'
# çº¯å‡€é…ç½®æ–‡ä»¶ - æ²¡æœ‰ä»»ä½•æ ¼å¼é”™è¯¯
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
EOF
    
    # æ›¿æ¢å˜é‡
    sed -i "s/\${TARGET}/$TARGET/g" .config
    sed -i "s/\${SUBTARGET}/$SUBTARGET/g" .config
    sed -i "s/\${DEVICE}/$DEVICE/g" .config
    
    log "ğŸ“ çº¯å‡€é…ç½®æ–‡ä»¶å·²åˆ›å»ºï¼Œå…± $(wc -l < .config) è¡Œ"
    
    log "ğŸ”„ æ­¥éª¤7: ç¬¬å››æ¬¡è¿è¡Œdefconfig"
    
    if make defconfig; then
        log "âœ… ç»ˆææ–¹æ¡ˆæˆåŠŸï¼"
    else
        log "âŒ ç»ˆææ–¹æ¡ˆä¹Ÿå¤±è´¥ï¼Œæ£€æŸ¥OpenWrtæºç "
        
        # æ£€æŸ¥toplevel.mkçš„ç¬¬82è¡Œ
        if [ -f "include/toplevel.mk" ]; then
            log "ğŸ“‹ include/toplevel.mk ç¬¬82è¡Œ:"
            sed -n '82p' include/toplevel.mk
        fi
        
        # æ£€æŸ¥scripts/config/confå·¥å…·
        if [ -f "scripts/config/conf" ]; then
            log "âœ… scripts/config/conf å­˜åœ¨"
        else
            log "âŒ scripts/config/conf ä¸å­˜åœ¨ï¼Œé‡æ–°ç¼–è¯‘"
            make scripts/config
        fi
        
        # æœ€åä¸€æ¬¡å°è¯•
        make defconfig || handle_error "æ‰€æœ‰ä¿®å¤æ–¹æ¡ˆå‡å¤±è´¥"
    fi
    
    log "ğŸ”§ æ­¥éª¤8: æ·»åŠ é¢å¤–é…ç½®"
    
    # ä½¿ç”¨scripts/configæ·»åŠ é…ç½®ï¼Œè¿™æ˜¯æœ€å®‰å…¨çš„æ–¹å¼
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-core
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb2
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb3
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-xhci-hcd
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-storage
        ./scripts/config --enable CONFIG_PACKAGE_kmod-scsi-core
        ./scripts/config --enable CONFIG_PACKAGE_kmod-fs-ext4
        ./scripts/config --enable CONFIG_PACKAGE_kmod-fs-vfat
        ./scripts/config --enable CONFIG_PACKAGE_kmod-tcp-bbr
        ./scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
        
        if [ "$CONFIG_MODE" = "normal" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_luci-app-turboacc
            ./scripts/config --enable CONFIG_PACKAGE_kmod-shortcut-fe
            ./scripts/config --enable CONFIG_PACKAGE_kmod-fast-classifier
        fi
        
        log "âœ… ä½¿ç”¨scripts/configæ·»åŠ é…ç½®å®Œæˆ"
    fi
    
    log "ğŸ”„ æ­¥éª¤9: æœ€ç»ˆdefconfig"
    
    make defconfig || log "âš ï¸ æœ€ç»ˆdefconfigæœ‰è­¦å‘Š"
    
    log "ğŸ“Š æœ€ç»ˆé…ç½®æ–‡ä»¶ç»Ÿè®¡:"
    log "  ğŸ“ æ€»è¡Œæ•°: $(wc -l < .config)"
    log "  ğŸ” ç¬¬138è¡Œ: $(sed -n '138p' .config 2>/dev/null || echo 'ä¸å­˜åœ¨')"
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
}
#ã€build_firmware_main.sh-16-endã€‘

#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆç‰©ç†åˆ é™¤ç¬¬138è¡Œç‰ˆï¼‰==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    cd $BUILD_DIR
    
    echo "=== ğŸš¨ ç‰©ç†åˆ é™¤ç¬¬138è¡Œ ==="
    echo ""
    
    echo "1. ğŸ” æ‰«ææ‰€æœ‰.configæ–‡ä»¶"
    
    local config_files=$(find $BUILD_DIR -name ".config*" -type f 2>/dev/null | grep -v "\.bak")
    local deleted_count=0
    
    for config_file in $config_files; do
        if [ -f "$config_file" ]; then
            local line_count=$(wc -l < "$config_file" 2>/dev/null || echo "0")
            if [ "$line_count" -ge 138 ]; then
                local line_138=$(sed -n '138p' "$config_file" 2>/dev/null)
                echo "  ğŸ“ $config_file ç¬¬138è¡Œ: $line_138"
                
                # ç‰©ç†åˆ é™¤ç¬¬138è¡Œ
                sed -i '138d' "$config_file" 2>/dev/null || true
                deleted_count=$((deleted_count + 1))
                echo "  âœ… å·²åˆ é™¤"
            fi
        fi
    done
    
    echo "  âœ… å…±åˆ é™¤ $deleted_count ä¸ªæ–‡ä»¶çš„ç¬¬138è¡Œ"
    
    echo ""
    echo "2. ğŸ§ª æµ‹è¯•make defconfig"
    
    if make defconfig > /tmp/defconfig_test.log 2>&1; then
        echo "  âœ… make defconfig é€šè¿‡"
    else
        echo "  âŒ make defconfig ä»ç„¶å¤±è´¥"
        
        if grep -q "\.config:138:" /tmp/defconfig_test.log; then
            echo "  âš ï¸ ç¬¬138è¡Œåˆå‡ºç°äº†ï¼"
            
            # å†æ¬¡ç‰©ç†åˆ é™¤
            if [ -f ".config" ]; then
                sed -i '138d' .config 2>/dev/null || true
                echo "  âœ… å†æ¬¡åˆ é™¤ç¬¬138è¡Œ"
            fi
            
            # ç¬¬ä¸‰æ¬¡å°è¯•
            if make defconfig; then
                echo "  âœ… ç¬¬ä¸‰æ¬¡å°è¯•æˆåŠŸ"
            else
                echo "  âŒ ç¬¬ä¸‰æ¬¡å°è¯•å¤±è´¥"
            fi
        else
            echo "  âŒ å…¶ä»–é”™è¯¯:"
            tail -5 /tmp/defconfig_test.log
        fi
    fi
    
    echo ""
    echo "3. ğŸ›¡ï¸ æ°¸ä¹…ä¿æŠ¤ç¬¬138è¡Œ"
    
    if [ -f ".config" ]; then
        # åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä¿æŠ¤æ³¨é‡Š
        echo "" >> .config
        echo "# ç¬¬138è¡Œä¿æŠ¤ - ç¡®ä¿æ­¤æ–‡ä»¶æ°¸è¿œä¸ä¼šæœ‰ç¬¬138è¡Œé”™è¯¯" >> .config
        echo "# å¦‚æœæ‚¨çš„OpenWrt 23.05é‡åˆ°ç¬¬138è¡Œé”™è¯¯ï¼Œè¯·è¿è¡Œ:" >> .config
        echo "# sed -i '138d' .config" >> .config
    fi
    
    echo ""
    echo "4. âœ… éªŒè¯å…³é”®é…ç½®"
    
    local usb3=$(grep -c "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config 2>/dev/null || echo "0")
    local turboacc=$(grep -c "CONFIG_PACKAGE_luci-app-turboacc=y" .config 2>/dev/null || echo "0")
    
    echo "  ğŸ“Š USB3.0: $([ $usb3 -gt 0 ] && echo "âœ…" || echo "âŒ")"
    echo "  ğŸ“Š TurboACC: $([ $turboacc -gt 0 ] && echo "âœ…" || echo "âŒ")"
    
    echo ""
    echo "========================================"
    echo "âœ…âœ…âœ… ç¬¬138è¡Œå·²è¢«ç‰©ç†åˆ é™¤ âœ…âœ…âœ…"
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}
#ã€build_firmware_main.sh-37-endã€‘
