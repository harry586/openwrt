#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    
    # åˆ›å»º artifacts ç›®å½•
    ARTIFACTS_DIR="$REPO_ROOT/artifacts/step15-logs"
    mkdir -p "$ARTIFACTS_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # ---------- ç¬¬ä¸€æ­¥ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„è®¾å¤‡ ----------
    log "ğŸ”§ æ­¥éª¤1: ä½¿ç”¨ç”¨æˆ·æŒ‡å®šè®¾å¤‡ $DEVICE"
    
    # ç›´æ¥å†™å…¥ç”¨æˆ·æŒ‡å®šçš„è®¾å¤‡
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    # è¿è¡Œ defconfig ç”Ÿæˆé…ç½®
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    # æ£€æŸ¥è®¾å¤‡æ˜¯å¦è¢«é€‰ä¸­
    if grep -q "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" .config; then
        log "âœ… è®¾å¤‡ $DEVICE å·²é€‰ä¸­"
    else
        log "âš ï¸ è®¾å¤‡ $DEVICE å¯èƒ½æœªæ­£ç¡®é€‰ä¸­ï¼Œç»§ç»­æ„å»º..."
        # æ˜¾ç¤ºå½“å‰å·²é€‰ä¸­çš„è®¾å¤‡
        log "ğŸ“‹ å½“å‰å·²é€‰ä¸­çš„è®¾å¤‡:"
        grep -E "^CONFIG_TARGET_.*_DEVICE_.*=y" .config | head -10 | sed 's/^/   /' || echo "   æ— "
    fi
    
    # ---------- ç¬¬äºŒæ­¥ï¼šåˆå¹¶é…ç½®æ–‡ä»¶ ----------
    log "ğŸ“ æ­¥éª¤2: åˆå¹¶é…ç½®æ–‡ä»¶"
    
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
        fi
    }
    
    # æŒ‰é¡ºåºåˆå¹¶é…ç½®æ–‡ä»¶
    append_config "$CONFIG_DIR/base.config"
    append_config "$CONFIG_DIR/usb-generic.config"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/normal.config"
    fi
    
    # æ·»åŠ è®¾å¤‡ç‰¹å®šé…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if [ -f "$CONFIG_DIR/devices/$DEVICE.config" ]; then
        log "ğŸ“ æ‰¾åˆ°è®¾å¤‡ç‰¹å®šé…ç½®: $DEVICE.config"
        append_config "$CONFIG_DIR/devices/$DEVICE.config"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # TCP BBR
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    # TurboACC
    if [ "$CONFIG_MODE" = "normal" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # ---------- ç¬¬ä¸‰æ­¥ï¼šå¼ºåˆ¶å¯ç”¨ USB é©±åŠ¨ï¼ˆç›´æ¥è§£å†³æ‚¨çš„é—®é¢˜ï¼‰----------
    log "ğŸ”§ æ­¥éª¤3: å¼ºåˆ¶å¯ç”¨ USB é©±åŠ¨"
    
    # æ‚¨ç¼ºå¤±çš„é©±åŠ¨ - ç›´æ¥å†™å…¥
    cat >> .config << 'EOF'
# USB Core
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb-common=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_kmod-usb-ehci=y
CONFIG_PACKAGE_kmod-usb-ohci=y
CONFIG_PACKAGE_kmod-usb-xhci-hcd=y
CONFIG_PACKAGE_kmod-usb-xhci-pci=y
CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y

# USB Storage
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-usb-storage-uas=y
CONFIG_PACKAGE_kmod-usb-storage-extras=y
CONFIG_PACKAGE_kmod-scsi-core=y
CONFIG_PACKAGE_kmod-scsi-generic=y

# USB DWC3 (for ipq40xx)
CONFIG_PACKAGE_kmod-usb-dwc3=y
CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y
CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y
CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y

# Filesystem
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_kmod-fs-exfat=y
CONFIG_PACKAGE_kmod-fs-ntfs3=y

# NLS
CONFIG_PACKAGE_kmod-nls-utf8=y
CONFIG_PACKAGE_kmod-nls-cp936=y

# Tools
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_automount=y
CONFIG_PACKAGE_usbutils=y
CONFIG_PACKAGE_lsusb=y
CONFIG_PACKAGE_kmod-usb-serial=y
EOF
    
    log "âœ… USB é©±åŠ¨å¼ºåˆ¶æ·»åŠ å®Œæˆ"
    
    # ---------- ç¬¬å››æ­¥ï¼šè§£å†³ä¾èµ– ----------
    log "ğŸ”„ æ­¥éª¤4: è§£å†³ä¾èµ–å…³ç³»"
    
    # å»é‡
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # è¿è¡Œ oldconfig
    log "â³ æ­£åœ¨è§£å†³ä¾èµ–å…³ç³»ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ..."
    yes "" | make oldconfig > /tmp/build-logs/oldconfig.log 2>&1 || {
        log "âš ï¸ make oldconfig æœ‰è­¦å‘Šï¼Œç»§ç»­æ‰§è¡Œ"
        tail -20 /tmp/build-logs/oldconfig.log
        cp /tmp/build-logs/oldconfig.log "$ARTIFACTS_DIR/" 2>/dev/null || true
    }
    
    # ---------- ç¬¬äº”æ­¥ï¼šéªŒè¯ ----------
    log "ğŸ” æ­¥éª¤5: éªŒè¯é…ç½®"
    
    # éªŒè¯æ‚¨ç¼ºå¤±çš„é©±åŠ¨
    local CHECK_DRIVERS=(
        "kmod-usb-common"
        "kmod-usb-xhci-hcd"
        "kmod-usb-xhci-pci"
        "kmod-usb-xhci-plat-hcd"
        "kmod-usb-dwc3-of-simple"
        "lsusb"
        "kmod-phy-qcom-dwc3"
    )
    
    local all_found=0
    for driver in "${CHECK_DRIVERS[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "  âœ… $driver: å·²å¯ç”¨"
        else
            log "  âŒ $driver: æœªå¯ç”¨"
            all_found=1
        fi
    done
    
    if [ $all_found -eq 0 ]; then
        log "ğŸ‰ æ‰€æœ‰æ‚¨æŒ‡å®šçš„ USB é©±åŠ¨éƒ½å·²æˆåŠŸå¯ç”¨ï¼"
    else
        log "âš ï¸ éƒ¨åˆ†é©±åŠ¨æœªå¯ç”¨ï¼Œå¯èƒ½å†…æ ¸ä¸æ”¯æŒ"
    fi
    
    # ä¿å­˜æœ€ç»ˆé…ç½®
    cp .config "$ARTIFACTS_DIR/config-final" 2>/dev/null || true
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
