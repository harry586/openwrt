#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®ï¼ˆç»ˆæä¿®å¤ç‰ˆ - åŒè·¯å¾„æ¸…ç†ï¼‰==="
    
    log "ğŸ” æ­¥éª¤0: å…¨é¢æ¸…ç†æ‰€æœ‰å¯èƒ½çš„é…ç½®æ–‡ä»¶"
    
    local config_paths=(
        "$BUILD_DIR/.config"
        "$BUILD_DIR/.config.old"
        "$BUILD_DIR/package/.config"
        "$BUILD_DIR/package/.config.old"
        "$BUILD_DIR/target/linux/.config"
        "$BUILD_DIR/tmp/.config"
        "$BUILD_DIR/staging_dir/.config"
        "/tmp/.config"
        "/tmp/.config.old"
    )
    
    for path in "${config_paths[@]}"; do
        if [ -f "$path" ]; then
            log "  ğŸ—‘ï¸ åˆ é™¤é…ç½®æ–‡ä»¶: $path"
            rm -f "$path"
        fi
    done
    
    log "ğŸ”§ æ­¥éª¤1: æ¸…ç†æ„å»ºç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶"
    
    rm -rf "$BUILD_DIR/tmp" 2>/dev/null || true
    rm -rf "$BUILD_DIR/staging_dir/tmp" 2>/dev/null || true
    rm -rf "$BUILD_DIR/scripts/config/.config" 2>/dev/null || true
    rm -f "$BUILD_DIR/include/config" 2>/dev/null || true
    rm -f "$BUILD_DIR/include/autoconf.h" 2>/dev/null || true
    rm -f "$BUILD_DIR/include/generated" 2>/dev/null || true
    
    log "âœ… æ­¥éª¤1å®Œæˆ: æ‰€æœ‰ç¼“å­˜å·²æ¸…ç†"
    
    log "ğŸ”§ æ­¥éª¤2: ç”Ÿæˆå…¨æ–°çš„æœ€å°é…ç½®"
    
    cat > "$BUILD_DIR/.config" << EOF
# æœ€å°é…ç½® - ç”± build_firmware_main.sh è‡ªåŠ¨ç”Ÿæˆ
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
EOF
    
    log "ğŸ“ æœ€å°é…ç½®å·²åˆ›å»º: $BUILD_DIR/.config"
    log "ğŸ“‹ æœ€å°é…ç½®å†…å®¹:"
    cat "$BUILD_DIR/.config" | sed 's/^/  /'
    
    log "ğŸ”„ æ­¥éª¤3: è¿è¡Œ make defconfig ç”Ÿæˆæ ‡å‡†æ¡†æ¶"
    
    cd "$BUILD_DIR"
    
    if make defconfig; then
        log "âœ… make defconfig æˆåŠŸï¼Œç”Ÿæˆæ ‡å‡†é…ç½®æ¡†æ¶"
    else
        log "âŒ é”™è¯¯: å³ä½¿æœ€å°é…ç½®ä¹Ÿæ— æ³•é€šè¿‡ defconfig"
        log "ğŸ“‹ æ£€æŸ¥ OpenWrt æºç æ ¹ç›®å½• .config æ–‡ä»¶..."
        
        if [ -f "$BUILD_DIR/.config" ]; then
            log "ğŸ“Š æºç æ ¹ç›®å½• .config æ–‡ä»¶ä¿¡æ¯:"
            log "  ğŸ“ è¡Œæ•°: $(wc -l < "$BUILD_DIR/.config")"
            log "  ğŸ” ç¬¬138è¡Œå†…å®¹:"
            sed -n '138p' "$BUILD_DIR/.config" 2>/dev/null || log "  ç¬¬138è¡Œä¸å­˜åœ¨"
            
            log "ğŸ”§ æ‰§è¡Œæ¿€è¿›ä¿®å¤: å®Œå…¨åˆ é™¤å¹¶é‡å»º"
            rm -f "$BUILD_DIR/.config"
            
            cat > "$BUILD_DIR/.config" << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
        fi
        
        if make defconfig; then
            log "âœ… æ¿€è¿›ä¿®å¤æˆåŠŸ"
        else
            log "âŒ æ¿€è¿›ä¿®å¤å¤±è´¥ï¼Œæ£€æŸ¥ toplevel.mk"
            if [ -f "$BUILD_DIR/include/toplevel.mk" ]; then
                log "  âœ… toplevel.mk å­˜åœ¨"
            else
                log "  âŒ toplevel.mk ä¸å­˜åœ¨ï¼Œæºç å¯èƒ½æŸå"
                handle_error "OpenWrt æºç ä¸å®Œæ•´"
            fi
            handle_error "æ— æ³•é€šè¿‡ defconfig"
        fi
    fi
    
    log "ğŸ”§ æ­¥éª¤4: ä»å¤‡ä»½ä¸­æå–æœ‰æ•ˆé…ç½®é¡¹"
    
    local backup_file="$BUILD_DIR/.config.bak.$(date +%Y%m%d%H%M%S)"
    if [ -f "$BUILD_DIR/.config" ]; then
        cp "$BUILD_DIR/.config" "$backup_file"
        log "âœ… å½“å‰é…ç½®å·²å¤‡ä»½: $backup_file"
    fi
    
    log "ğŸ”§ æ­¥éª¤5: å¼ºåˆ¶å¯ç”¨å…³é”®é©±åŠ¨"
    
    if [ -f "scripts/config" ]; then
        log "  ğŸ”§ ä½¿ç”¨ scripts/config å·¥å…·..."
        
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-core
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb2
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb3
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-xhci-hcd
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-storage
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-storage-uas
        ./scripts/config --enable CONFIG_PACKAGE_kmod-scsi-core
        ./scripts/config --enable CONFIG_PACKAGE_kmod-fs-ext4
        ./scripts/config --enable CONFIG_PACKAGE_kmod-fs-vfat
        ./scripts/config --enable CONFIG_PACKAGE_kmod-fs-exfat
        ./scripts/config --enable CONFIG_PACKAGE_kmod-fs-ntfs3
        ./scripts/config --enable CONFIG_PACKAGE_kmod-nls-utf8
        ./scripts/config --enable CONFIG_PACKAGE_kmod-nls-cp936
        
        log "  âœ… USB å­˜å‚¨ç›¸å…³é©±åŠ¨å·²å¼ºåˆ¶å¯ç”¨"
    else
        log "  âš ï¸ scripts/config ä¸å­˜åœ¨ï¼Œç¼–è¯‘ç”Ÿæˆ..."
        make scripts/config > /dev/null 2>&1 || true
        
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-xhci-hcd
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb3
            log "  âœ… scripts/config å·²ç”Ÿæˆå¹¶ä½¿ç”¨"
        else
            cat >> .config << 'EOF'
CONFIG_PACKAGE_kmod-usb-xhci-hcd=y
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-scsi-core=y
EOF
            log "  âœ… USB é©±åŠ¨å·²ç›´æ¥å†™å…¥"
        fi
    fi
    
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        log "  ğŸ”§ IPQ40xx å¹³å°ä¸“ç”¨é©±åŠ¨..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3-qcom
            ./scripts/config --enable CONFIG_PACKAGE_kmod-phy-qcom-dwc3
        else
            echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
        fi
        log "  âœ… IPQ40xx USB é©±åŠ¨å·²å¯ç”¨"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  ğŸ”§ TurboACC é©±åŠ¨..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_luci-app-turboacc
            ./scripts/config --enable CONFIG_PACKAGE_kmod-shortcut-fe
            ./scripts/config --enable CONFIG_PACKAGE_kmod-fast-classifier
        else
            echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        fi
        log "  âœ… TurboACC é©±åŠ¨å·²å¯ç”¨"
    fi
    
    log "  ğŸ”§ TCP BBR æ‹¥å¡æ§åˆ¶..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-tcp-bbr
        ./scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
    else
        echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        sed -i '/^CONFIG_DEFAULT_TCP_CONG=/d' .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    fi
    log "  âœ… TCP BBR å·²å¯ç”¨"
    
    log "ğŸ”„ æ­¥éª¤6: æœ€ç»ˆé…ç½®åŒæ­¥"
    
    make defconfig || {
        log "âš ï¸ æœ€ç»ˆ defconfig äº§ç”Ÿè­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ"
    }
    
    log "ğŸ”§ æ­¥éª¤7: éªŒè¯å…³é”®é…ç½®"
    
    local missing=()
    
    for driver in "kmod-usb-xhci-hcd" "kmod-usb3" "kmod-usb-storage" "kmod-scsi-core"; do
        if ! grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            missing+=("$driver")
            echo "CONFIG_PACKAGE_${driver}=y" >> .config
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        log "âš ï¸ å¼ºåˆ¶æ·»åŠ ç¼ºå¤±é©±åŠ¨: ${missing[*]}"
        make defconfig > /dev/null 2>&1 || true
        log "âœ… å…³é”®é©±åŠ¨å·²ç¡®ä¿å¯ç”¨"
    fi
    
    log "ğŸ“Š æœ€ç»ˆé…ç½®ç»Ÿè®¡:"
    log "  ğŸ“ æ€»è¡Œæ•°: $(wc -l < .config)"
    log "  âœ… CONFIG_*=y: $(grep -c "^CONFIG_.*=y$" .config 2>/dev/null || echo 0)"
    log "  âœ… CONFIG_*=m: $(grep -c "^CONFIG_.*=m$" .config 2>/dev/null || echo 0)"
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        log "  âœ… USB 3.0: å·²å¯ç”¨"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ] && grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config 2>/dev/null; then
        log "  âœ… TurboACC: å·²å¯ç”¨"
    fi
    
    if grep -q '^CONFIG_DEFAULT_TCP_CONG="bbr"' .config; then
        log "  âœ… TCP BBR: å·²å¯ç”¨"
    fi
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
    
    log "ğŸ”§ æ­¥éª¤8: æœ€ç»ˆå®‰å…¨æ£€æŸ¥ - ç¡®ä¿ç¬¬138è¡Œæ²¡æœ‰é—®é¢˜"
    
    if [ -f ".config" ]; then
        local line_138=$(sed -n '138p' .config 2>/dev/null)
        if [ -n "$line_138" ]; then
            log "ğŸ“‹ .config ç¬¬138è¡Œå†…å®¹: $line_138"
            if ! echo "$line_138" | grep -q "^CONFIG_.*=y$" && ! echo "$line_138" | grep -q "^#"; then
                log "âš ï¸ ç¬¬138è¡Œæ ¼å¼å¼‚å¸¸ï¼Œæ­£åœ¨ä¿®å¤..."
                sed -i '138s/.*/# é…ç½®é¡¹å·²è‡ªåŠ¨ä¿®å¤/' .config
            fi
        fi
    fi
}
#ã€build_firmware_main.sh-16-endã€‘

#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆç»ˆæä¿®å¤ç‰ˆ - æºç æ ¹ç›®å½•æ ¸éªŒï¼‰==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡"
    fi
    
    cd $BUILD_DIR
    
    echo "=== ğŸš¨ æºç æ ¹ç›®å½•é…ç½®æ–‡ä»¶æ ¸éªŒ ==="
    echo ""
    echo "1. âœ… æ£€æŸ¥ $BUILD_DIR/.config"
    
    if [ -f ".config" ]; then
        echo "  âœ… .config å­˜åœ¨"
        
        local bad_lines=0
        local line_num=0
        local error_line=""
        local error_content=""
        
        while IFS= read -r line; do
            line_num=$((line_num + 1))
            stripped=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            
            if [ -z "$stripped" ] || echo "$stripped" | grep -q "^#"; then
                continue
            fi
            
            if echo "$stripped" | grep -q "^CONFIG_"; then
                if ! echo "$stripped" | grep -q "=y$" && ! echo "$stripped" | grep -q "=m$" && ! echo "$stripped" | grep -q "=n$"; then
                    echo "  âŒ ç¬¬ $line_num è¡Œ: è¯­æ³•é”™è¯¯ - $stripped"
                    bad_lines=$((bad_lines + 1))
                    error_line=$line_num
                    error_content=$stripped
                fi
            fi
        done < .config
        
        if [ $bad_lines -gt 0 ]; then
            echo "  âŒ å‘ç° $bad_lines ä¸ªè¯­æ³•é”™è¯¯"
            echo "  ğŸ”§ ç«‹å³æ‰§è¡Œç´§æ€¥ä¿®å¤..."
            
            if [ -n "$error_line" ] && [ "$error_line" = "138" ]; then
                echo "  âš ï¸ æ£€æµ‹åˆ°ç¬¬138è¡Œé”™è¯¯: $error_content"
                echo "  ğŸ”§ æ‰§è¡Œå®šç‚¹ä¿®å¤..."
                
                sed -i '138d' .config
                echo "# CONFIG_$(echo "$error_content" | sed 's/^CONFIG_//') is not set" >> .config
                
                echo "  âœ… ç¬¬138è¡Œå·²ä¿®å¤"
            fi
            
            echo "  ğŸ”§ æ‰§è¡Œå…¨å±€æ¸…ç†..."
            
            local clean_config=$(mktemp)
            grep -E "^(CONFIG_.*=[ym]$|^# CONFIG_.* is not set$)" .config | sort -u > "$clean_config"
            
            local target_config=$(grep -E "^(CONFIG_TARGET_${TARGET}=y|CONFIG_TARGET_${TARGET}_${SUBTARGET}=y|CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y)" .config 2>/dev/null || true)
            
            mv "$clean_config" .config
            echo "$target_config" >> .config
            
            echo "  âœ… é…ç½®æ–‡ä»¶å·²æ¸…ç†"
        else
            echo "  âœ… é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡"
        fi
    else
        echo "  âŒ .config ä¸å­˜åœ¨"
        echo "  ğŸ”§ åˆ›å»ºæœ€å°é…ç½®..."
        
        cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
EOF
        echo "  âœ… æœ€å°é…ç½®å·²åˆ›å»º"
    fi
    
    echo ""
    echo "2. ğŸ§ª make defconfig æµ‹è¯•:"
    
    if make defconfig > /tmp/defconfig.log 2>&1; then
        echo "  âœ… make defconfig é€šè¿‡"
    else
        echo "  âŒ make defconfig å¤±è´¥"
        
        if grep -q "missing separator" /tmp/defconfig.log; then
            local error_line=$(grep -n "missing separator" /tmp/defconfig.log | head -1 | grep -o ":[0-9]\+:" | grep -o "[0-9]\+")
            
            if [ -n "$error_line" ]; then
                echo "  ğŸ“ é”™è¯¯å‘ç”Ÿåœ¨ç¬¬ $error_line è¡Œ"
                
                if [ -f ".config" ]; then
                    echo "  ğŸ“‹ ç¬¬ $error_line è¡Œå†…å®¹:"
                    sed -n "${error_line}p" .config 2>/dev/null || echo "  æ— æ³•è¯»å–"
                fi
            fi
            
            echo "  ğŸ”§ æ‰§è¡Œæ ¸å¼¹çº§ä¿®å¤: å®Œå…¨åˆ é™¤å¹¶é‡å»º"
            
            rm -f .config .config.old
            
            cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
            
            if make defconfig; then
                echo "  âœ… æ ¸å¼¹çº§ä¿®å¤æˆåŠŸ"
            else
                echo "  âŒ æ ¸å¼¹çº§ä¿®å¤å¤±è´¥"
                exit 1
            fi
        else
            echo "  âŒ å…¶ä»–é”™è¯¯:"
            tail -5 /tmp/defconfig.log
            exit 1
        fi
    fi
    
    rm -f /tmp/defconfig.log
    
    echo ""
    echo "3. ğŸ’¾ SDK ç›®å½•æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "  âœ… SDK ç›®å½•: $COMPILER_DIR"
    fi
    
    echo ""
    echo "4. ğŸ“ Feeds æ£€æŸ¥:"
    if [ -d "feeds" ]; then
        echo "  âœ… feeds ç›®å½•å­˜åœ¨"
    fi
    
    echo ""
    echo "5. ğŸ’¿ ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    AVAILABLE_SPACE=$(df /mnt --output=avail 2>/dev/null | tail -1 || df / --output=avail | tail -1)
    AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
    echo "  ğŸ“Š å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
    
    echo ""
    echo "========================================"
    echo "âœ…âœ…âœ… æ‰€æœ‰æ ¸éªŒé€šè¿‡ âœ…âœ…âœ…"
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}
#ã€build_firmware_main.sh-37-endã€‘
