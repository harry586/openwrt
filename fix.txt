#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    
    ARTIFACTS_DIR="$REPO_ROOT/artifacts/step15-logs"
    mkdir -p "$ARTIFACTS_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # ---------- ç¬¬ä¸€æ­¥ï¼šåŸºç¡€é…ç½® ----------
    log "ğŸ”§ æ­¥éª¤1: ç”ŸæˆåŸºç¡€é…ç½®"
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
EOF
    make defconfig || handle_error "åŸºç¡€é…ç½®å¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®æˆåŠŸ"
    
    # ---------- ç¬¬äºŒæ­¥ï¼šè®¾å¤‡é€‰æ‹© ----------
    log "ğŸ” æ­¥éª¤2: è®¾å¤‡é€‰æ‹©"
    
    # è·å–å¯ç”¨è®¾å¤‡
    local available_devices=$(grep -E '^CONFIG_TARGET_DEVICE_.*=' .config | sed -E 's/^CONFIG_TARGET_DEVICE_//' | sed 's/=.*$//' | sort -u)
    
    if [ -n "$available_devices" ]; then
        log "ğŸ“‹ å¯ç”¨è®¾å¤‡:"
        echo "$available_devices" | sed 's/^/   /'
        
        # å°è¯•åŒ¹é…ç”¨æˆ·è®¾å¤‡
        local matched=""
        local user_lower=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]')
        while read avail; do
            avail_lower=$(echo "$avail" | tr '[:upper:]' '[:lower:]')
            if [ "$avail_lower" = "$user_lower" ]; then
                matched="$avail"
                break
            fi
        done <<< "$available_devices"
        
        if [ -n "$matched" ]; then
            DEVICE="$matched"
            log "âœ… åŒ¹é…åˆ°è®¾å¤‡: $DEVICE"
        else
            DEVICE=$(echo "$available_devices" | head -1)
            log "âš ï¸ ä½¿ç”¨ç¬¬ä¸€ä¸ªè®¾å¤‡: $DEVICE"
        fi
    else
        log "âš ï¸ æ— å¯ç”¨è®¾å¤‡åˆ—è¡¨ï¼Œç»§ç»­ä½¿ç”¨: $DEVICE"
    fi
    
    # å†™å…¥è®¾å¤‡é…ç½®
    echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
    make defconfig || handle_error "è®¾å¤‡é…ç½®å¤±è´¥"
    log "âœ… è®¾å¤‡é…ç½®å®Œæˆ"
    
    # ---------- ç¬¬ä¸‰æ­¥ï¼šåˆå¹¶é…ç½® ----------
    log "ğŸ“ æ­¥éª¤3: åˆå¹¶é…ç½®æ–‡ä»¶"
    
    append_config() {
        local file=$1
        [ -f "$file" ] && grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
    }
    
    append_config "$CONFIG_DIR/base.config"
    append_config "$CONFIG_DIR/usb-generic.config"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/normal.config"
    fi
    
    # é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # BBR
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    # TurboACC
    if [ "$CONFIG_MODE" = "normal" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # ath10k
    if [ "$TARGET" = "ipq40xx" ]; then
        sed -i '/CONFIG_PACKAGE_kmod-ath10k/d' .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
    fi
    
    # ---------- ç¬¬å››æ­¥ï¼šå…ˆè¿è¡Œ oldconfig ----------
    log "ğŸ”„ æ­¥éª¤4: ç¬¬ä¸€æ¬¡ä¾èµ–è§£å†³"
    yes "" | make oldconfig > /tmp/build-logs/oldconfig1.log 2>&1 || true
    
    # ---------- ç¬¬äº”æ­¥ï¼šå¼ºåˆ¶å†™å…¥ USB é©±åŠ¨ï¼ˆå…³é”®ä¿®å¤ï¼‰----------
    log "ğŸ”§ æ­¥éª¤5: å¼ºåˆ¶å†™å…¥ USB é©±åŠ¨"
    
    # ç›´æ¥è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼Œç„¶åæ’åºå»é‡
    cat >> .config << 'EOF'
# USB Core
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb-common=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_kmod-usb-ehci=y
CONFIG_PACKAGE_kmod-usb-ohci=y
CONFIG_PACKAGE_kmod-usb-xhci-hcd=y
CONFIG_PACKAGE_kmod-usb-xhci-pci=y
CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y

# USB Storage
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-usb-storage-uas=y
CONFIG_PACKAGE_kmod-usb-storage-extras=y
CONFIG_PACKAGE_kmod-scsi-core=y
CONFIG_PACKAGE_kmod-scsi-generic=y

# USB DWC3
CONFIG_PACKAGE_kmod-usb-dwc3=y
CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y
CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y
CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y

# Filesystem
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_kmod-fs-exfat=y
CONFIG_PACKAGE_kmod-fs-ntfs3=y

# NLS
CONFIG_PACKAGE_kmod-nls-utf8=y
CONFIG_PACKAGE_kmod-nls-cp936=y

# Tools
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_automount=y
CONFIG_PACKAGE_usbutils=y
CONFIG_PACKAGE_lsusb=y
CONFIG_PACKAGE_kmod-usb-serial=y
EOF
    
    # å»é‡
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    log "âœ… USB é©±åŠ¨å·²å†™å…¥"
    
    # ---------- ç¬¬å…­æ­¥ï¼šç¬¬äºŒæ¬¡ oldconfigï¼ˆä¿ç•™é…ç½®ï¼‰----------
    log "ğŸ”„ æ­¥éª¤6: æœ€ç»ˆä¾èµ–è§£å†³"
    
    # ä½¿ç”¨ olddefconfig è€Œä¸æ˜¯ oldconfigï¼Œå®ƒä¼šä¿ç•™ç°æœ‰é…ç½®
    make olddefconfig > /tmp/build-logs/oldconfig2.log 2>&1 || {
        log "âš ï¸ olddefconfig æœ‰è­¦å‘Šï¼Œå°è¯• oldconfig"
        yes "" | make oldconfig > /tmp/build-logs/oldconfig2.log 2>&1 || true
    }
    
    # ---------- ç¬¬ä¸ƒæ­¥ï¼šéªŒè¯ ----------
    log "ğŸ” æ­¥éª¤7: éªŒè¯é…ç½®"
    
    local CHECK=(
        "kmod-usb-common"
        "kmod-usb-xhci-hcd"
        "kmod-usb-xhci-pci"
        "kmod-usb-xhci-plat-hcd"
        "kmod-usb-dwc3-of-simple"
        "lsusb"
        "kmod-phy-qcom-dwc3"
    )
    
    local missing=()
    for driver in "${CHECK[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "  âœ… $driver: å·²å¯ç”¨"
        else
            log "  âŒ $driver: æœªå¯ç”¨"
            missing+=("$driver")
        fi
    done
    
    if [ ${#missing[@]} -eq 0 ]; then
        log "ğŸ‰ æ‰€æœ‰ USB é©±åŠ¨å·²å¯ç”¨ï¼"
    else
        log "âš ï¸ ç¼ºå¤±é©±åŠ¨: ${missing[*]}"
        echo "${missing[@]}" > "$ARTIFACTS_DIR/missing-deps.txt"
    fi
    
    # ä¿å­˜æœ€ç»ˆé…ç½®
    cp .config "$ARTIFACTS_DIR/config-final" 2>/dev/null || true
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
