#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…ï¼ˆç»ˆæä¿®å¤ç‰ˆ - é¢„æ¸…ç†æ¨¡å¼ï¼‰==="
    
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åº”ç”¨é…ç½®"
        return 1
    fi
    
    log "ğŸ“‹ é…ç½®è¯¦æƒ…:"
    log "é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "é…ç½®è¡Œæ•°: $(wc -l < .config)"
    
    local backup_file=".config.bak.$(date +%Y%m%d%H%M%S)"
    cp .config "$backup_file"
    log "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½: $backup_file"
    
    log "ğŸ”§ æ­¥éª¤1: é¢„æ¸…ç†æ¨¡å¼ - å½»åº•ç§»é™¤æ‰€æœ‰éæ ‡å‡†é…ç½®è¡Œ"
    
    local clean_config=$(mktemp)
    local line_number=0
    local removed_count=0
    
    while IFS= read -r line; do
        line_number=$((line_number + 1))
        
        stripped_line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        
        if [ -z "$stripped_line" ]; then
            continue
        fi
        
        if echo "$stripped_line" | grep -q "^#"; then
            if echo "$stripped_line" | grep -q "^# CONFIG_.* is not set$"; then
                echo "$stripped_line" >> "$clean_config"
                continue
            elif echo "$stripped_line" | grep -q "^# .* is not set$"; then
                local config_name=$(echo "$stripped_line" | sed -n 's/^# \(CONFIG_[^ ]*\) is not set$/\1/p')
                if [ -n "$config_name" ]; then
                    echo "# $config_name is not set" >> "$clean_config"
                    log "â„¹ï¸ ç¬¬ $line_number è¡Œ: æ ‡å‡†åŒ–æ³¨é‡Šæ ¼å¼"
                else
                    echo "$stripped_line" >> "$clean_config"
                fi
                continue
            else
                echo "$stripped_line" >> "$clean_config"
                continue
            fi
        fi
        
        if echo "$stripped_line" | grep -q "^CONFIG_"; then
            if echo "$stripped_line" | grep -q "=y$" || echo "$stripped_line" | grep -q "=m$" || echo "$stripped_line" | grep -q "=n$"; then
                local fixed_line=$(echo "$stripped_line" | sed -E 's/[[:space:]]*=[[:space:]]*/=/g')
                if [ "$fixed_line" != "$stripped_line" ]; then
                    log "âš ï¸ ç¬¬ $line_number è¡Œ: ä¿®å¤ç©ºæ ¼æ ¼å¼ - $fixed_line"
                fi
                echo "$fixed_line" >> "$clean_config"
                continue
            elif echo "$stripped_line" | grep -q "=$"; then
                log "âš ï¸ ç¬¬ $line_number è¡Œ: ç§»é™¤ç©ºé…ç½®å€¼"
                removed_count=$((removed_count + 1))
                continue
            elif echo "$stripped_line" | grep -q "^CONFIG_[A-Za-z0-9_]*$"; then
                log "âš ï¸ ç¬¬ $line_number è¡Œ: ç¼ºå°‘åˆ†éš”ç¬¦ - $stripped_line"
                echo "# $stripped_line is not set" >> "$clean_config"
                removed_count=$((removed_count + 1))
                continue
            else
                log "âš ï¸ ç¬¬ $line_number è¡Œ: æ— æ•ˆé…ç½®æ ¼å¼ - $stripped_line"
                removed_count=$((removed_count + 1))
                continue
            fi
        else
            log "âš ï¸ ç¬¬ $line_number è¡Œ: éæ ‡å‡†é…ç½®è¡Œ - $stripped_line"
            removed_count=$((removed_count + 1))
            continue
        fi
    done < .config
    
    mv "$clean_config" .config
    log "âœ… é¢„æ¸…ç†å®Œæˆ: ç§»é™¤äº† $removed_count ä¸ªæ— æ•ˆ/éæ ‡å‡†é…ç½®è¡Œ"
    log "ğŸ“Š æ¸…ç†åé…ç½®è¡Œæ•°: $(wc -l < .config)"
    
    log "ğŸ”§ æ­¥éª¤2: ä½¿ç”¨ OpenWrt å®˜æ–¹é…ç½®å·¥å…·ç”Ÿæˆæœ€å°é…ç½®"
    
    rm -f .config.old
    
    cat > .config.minimal << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
EOF
    
    log "ğŸ“ å·²åˆ›å»ºæœ€å°é…ç½®æ¨¡æ¿"
    
    cp .config.minimal .config
    
    log "ğŸ”„ æ­¥éª¤3: è¿è¡Œ make defconfig ç”Ÿæˆæ ‡å‡†é…ç½®..."
    
    if make defconfig; then
        log "âœ… make defconfig æˆåŠŸ"
    else
        log "âŒ make defconfig å¤±è´¥ï¼Œå°è¯•æ›´æ¿€è¿›çš„æ–¹æ³•"
        
        cat > .config.forced << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_IMAGES_PAD=y
CONFIG_TARGET_IB=y
CONFIG_TARGET_SDK=y
EOF
        
        mv .config.forced .config
        
        if ! make defconfig; then
            log "âŒ å³ä½¿ä½¿ç”¨æœ€å°é…ç½®ä»ç„¶å¤±è´¥"
            handle_error "make defconfig å¤±è´¥ï¼ŒOpenWrt æºç å¯èƒ½æŸå"
        fi
    fi
    
    log "ğŸ”§ æ­¥éª¤4: åˆå¹¶è‡ªå®šä¹‰é…ç½®..."
    
    local custom_config_backup="$backup_file"
    local temp_config=$(mktemp)
    
    cp .config "$temp_config"
    
    local added_count=0
    local conflict_count=0
    
    while IFS= read -r line; do
        stripped_line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        
        if [ -z "$stripped_line" ] || echo "$stripped_line" | grep -q "^#"; then
            continue
        fi
        
        if echo "$stripped_line" | grep -q "^CONFIG_.*=y$"; then
            config_name=$(echo "$stripped_line" | cut -d'=' -f1)
            
            if grep -q "^$config_name=y" .config; then
                conflict_count=$((conflict_count + 1))
                continue
            fi
            
            if grep -q "^# $config_name is not set" .config; then
                sed -i "/^# $config_name is not set/d" .config
                echo "$stripped_line" >> .config
                added_count=$((added_count + 1))
                log "âœ… å¯ç”¨é…ç½®: $config_name"
            else
                echo "$stripped_line" >> .config
                added_count=$((added_count + 1))
                log "âœ… æ·»åŠ é…ç½®: $config_name"
            fi
        fi
    done < "$custom_config_backup"
    
    log "ğŸ“Š é…ç½®åˆå¹¶ç»Ÿè®¡:"
    log "  âœ… æ–°å¢é…ç½®: $added_count ä¸ª"
    log "  âš ï¸ å†²çªè·³è¿‡: $conflict_count ä¸ª"
    
    log "ğŸ”„ æ­¥éª¤5: è¿è¡Œ make defconfig æœ€ç»ˆåŒæ­¥..."
    
    if ! make defconfig; then
        log "âš ï¸ é…ç½®åˆå¹¶å defconfig å¤±è´¥ï¼Œå›é€€åˆ°æœ€å°é…ç½®"
        cp .config.minimal .config
        make defconfig || handle_error "æ— æ³•æ¢å¤é…ç½®"
    fi
    
    log "ğŸ”§ æ­¥éª¤6: USB 3.0 é©±åŠ¨å¼ºåˆ¶å¯ç”¨..."
    
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-xhci-hcd
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb3
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-storage
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-storage-uas
        ./scripts/config --enable CONFIG_PACKAGE_kmod-scsi-core
        log "âœ… ä½¿ç”¨ scripts/config å¯ç”¨ USB é©±åŠ¨"
    else
        echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage-uas=y" >> .config
        echo "CONFIG_PACKAGE_kmod-scsi-core=y" >> .config
        log "âœ… ç›´æ¥å†™å…¥ USB é©±åŠ¨é…ç½®"
    fi
    
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        log "ğŸ”§ IPQ40xx å¹³å°ä¸“ç”¨ USB é©±åŠ¨..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3-qcom
            ./scripts/config --enable CONFIG_PACKAGE_kmod-phy-qcom-dwc3
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3
        else
            echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config
        fi
        log "âœ… IPQ40xx USB é©±åŠ¨å·²æ·»åŠ "
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "ğŸ”§ TurboACC é…ç½®..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_luci-app-turboacc
            ./scripts/config --enable CONFIG_PACKAGE_kmod-shortcut-fe
            ./scripts/config --enable CONFIG_PACKAGE_kmod-fast-classifier
        else
            echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        fi
        log "âœ… TurboACC é…ç½®å·²æ·»åŠ "
    fi
    
    log "ğŸ”§ TCP BBR æ‹¥å¡æ§åˆ¶..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-tcp-bbr
        ./scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
    else
        echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        awk '!/^CONFIG_DEFAULT_TCP_CONG=/' .config > .config.tmp
        mv .config.tmp .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    fi
    log "âœ… TCP BBR é…ç½®å·²æ·»åŠ "
    
    log "ğŸ”§ ath10k-ct å†²çªä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-pci
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-smallbuffers
        ./scripts/config --enable CONFIG_PACKAGE_kmod-ath10k-ct
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers
        log "âœ… ath10k-ct å†²çªå·²ä¿®å¤"
    fi
    
    log "ğŸ”„ æ­¥éª¤7: æœ€ç»ˆé…ç½®åŒæ­¥..."
    make defconfig || log "âš ï¸ æœ€ç»ˆ defconfig å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
    
    log "ğŸ”§ æ­¥éª¤8: æœ€ç»ˆé…ç½®éªŒè¯..."
    
    local critical_configs=(
        "CONFIG_TARGET_${TARGET}=y"
        "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y"
        "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y"
    )
    
    local missing_critical=0
    for config in "${critical_configs[@]}"; do
        if ! grep -q "^$config" .config; then
            log "âŒ å…³é”®é…ç½®ç¼ºå¤±: $config"
            missing_critical=$((missing_critical + 1))
        fi
    done
    
    if [ $missing_critical -gt 0 ]; then
        log "âš ï¸ å…³é”®é…ç½®ç¼ºå¤±ï¼Œé‡æ–°åº”ç”¨æœ€å°é…ç½®"
        cp .config.minimal .config
        make defconfig
        log "âœ… å·²æ¢å¤æœ€å°é…ç½®"
    fi
    
    log "ğŸ“Š æœ€ç»ˆé…ç½®ç»Ÿè®¡:"
    log "  ğŸ“ æ€»è¡Œæ•°: $(wc -l < .config)"
    log "  âœ… CONFIG_*=y: $(grep -c "^CONFIG_.*=y$" .config || echo "0")"
    log "  âœ… CONFIG_*=m: $(grep -c "^CONFIG_.*=m$" .config || echo "0")"
    log "  âšª æ³¨é‡Šè¡Œ: $(grep -c "^#" .config || echo "0")"
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        log "  âœ… USB 3.0: å·²å¯ç”¨"
    else
        log "  âš ï¸ USB 3.0: æœªå¯ç”¨"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ] && grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
        log "  âœ… TurboACC: å·²å¯ç”¨"
    fi
    
    if grep -q '^CONFIG_DEFAULT_TCP_CONG="bbr"' .config; then
        log "  âœ… TCP BBR: å·²å¯ç”¨"
    fi
    
    log "âœ… é…ç½®åº”ç”¨æµç¨‹å®Œæˆ"
}
#ã€build_firmware_main.sh-16-endã€‘

#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆç»ˆæä¿®å¤ç‰ˆ - é…ç½®æ–‡ä»¶é¢„æ£€ï¼‰==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: SELECTED_BRANCH=$SELECTED_BRANCH, TARGET=$TARGET"
        echo "âœ… COMPILER_DIR=$COMPILER_DIR"
        echo "âœ… CONFIG_MODE=$CONFIG_MODE"
    else
        echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ ($BUILD_DIR/build_env.sh)"
        echo "ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤08å’Œæ­¥éª¤09æ˜¯å¦æˆåŠŸæ‰§è¡Œ"
        exit 1
    fi
    
    cd $BUILD_DIR
    echo "=== ğŸš¨ å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆé…ç½®æ–‡ä»¶é¢„æ£€æ¨¡å¼ï¼‰==="
    
    echo ""
    echo "1. âœ… é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥:"
    if [ -f ".config" ]; then
        echo "  âœ… .config æ–‡ä»¶å­˜åœ¨"
        
        local line_number=0
        local error_count=0
        
        while IFS= read -r line; do
            line_number=$((line_number + 1))
            stripped_line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            
            if [ -z "$stripped_line" ]; then
                continue
            fi
            
            if echo "$stripped_line" | grep -q "^CONFIG_" && \
               ! echo "$stripped_line" | grep -q "=y$" && \
               ! echo "$stripped_line" | grep -q "=m$" && \
               ! echo "$stripped_line" | grep -q "^#.* is not set$"; then
                echo "  âŒ ç¬¬ $line_number è¡Œ: è¯­æ³•é”™è¯¯ - $stripped_line"
                error_count=$((error_count + 1))
            fi
        done < .config
        
        if [ $error_count -eq 0 ]; then
            echo "  âœ… é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡"
        else
            echo "  âŒ é…ç½®æ–‡ä»¶å­˜åœ¨ $error_count ä¸ªè¯­æ³•é”™è¯¯"
            echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
            
            local clean_config=$(mktemp)
            grep -E "^(CONFIG_.*=[ym]$|^# CONFIG_.* is not set$)" .config | sort -u > "$clean_config"
            mv "$clean_config" .config
            echo "  âœ… é…ç½®æ–‡ä»¶å·²æ¸…ç†ï¼Œå‰©ä½™ $(wc -l < .config) è¡Œ"
        fi
    else
        echo "  âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨"
        exit 1
    fi
    
    echo ""
    echo "2. âœ… SDKç›®å½•æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "  âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
    else
        echo "  âŒ é”™è¯¯: SDKç›®å½•ä¸å­˜åœ¨"
        exit 1
    fi
    
    echo ""
    echo "3. âœ… Feedsæ£€æŸ¥:"
    if [ -d "feeds" ]; then
        echo "  âœ… feeds ç›®å½•å­˜åœ¨"
    else
        echo "  âŒ é”™è¯¯: feeds ç›®å½•ä¸å­˜åœ¨"
        exit 1
    fi
    
    echo ""
    echo "4. âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    AVAILABLE_SPACE=$(df /mnt --output=avail 2>/dev/null | tail -1 || df / --output=avail | tail -1)
    AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
    echo "  ğŸ“Š å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
    
    if [ $AVAILABLE_GB -lt 10 ]; then
        echo "  âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³"
        exit 1
    else
        echo "  âœ… ç£ç›˜ç©ºé—´å……è¶³"
    fi
    
    echo ""
    echo "5. âœ… make defconfig é¢„æµ‹è¯•:"
    if make defconfig 2>/dev/null; then
        echo "  âœ… make defconfig æµ‹è¯•é€šè¿‡"
    else
        echo "  âŒ make defconfig æµ‹è¯•å¤±è´¥"
        echo "  ğŸ”§ æ­£åœ¨é‡ç½®é…ç½®æ–‡ä»¶..."
        
        cat > .config.minimal << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
EOF
        
        cp .config.minimal .config
        
        if make defconfig; then
            echo "  âœ… é…ç½®æ–‡ä»¶é‡ç½®æˆåŠŸ"
        else
            echo "  âŒ é…ç½®æ–‡ä»¶é‡ç½®å¤±è´¥"
            exit 1
        fi
    fi
    
    echo ""
    echo "========================================"
    echo "âœ…âœ…âœ… æ‰€æœ‰å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}
#ã€build_firmware_main.sh-37-endã€‘
