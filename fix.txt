#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆå®Œæ•´ç‰ˆï¼‰ ==="
    
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åº”ç”¨é…ç½®"
        return 1
    fi
    
    log "ğŸ“‹ é…ç½®è¯¦æƒ…:"
    log "é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "é…ç½®è¡Œæ•°: $(wc -l < .config)"
    
    local backup_file=".config.bak.$(date +%Y%m%d%H%M%S)"
    cp .config "$backup_file"
    log "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½: $backup_file"
    
    log "ğŸ”§ æ­¥éª¤1: æ ‡å‡†åŒ–é…ç½®æ–‡ä»¶æ ¼å¼..."
    
    if [ -f ".config" ]; then
        awk '
        {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if ($0 ~ /^#/) {
                if ($0 ~ /^#CONFIG_/) {
                    $0 = "# " substr($0, 2)
                }
                if ($0 !~ /is not set$/) {
                    $0 = $0 " is not set"
                }
            }
            if ($0 ~ /^CONFIG_/) {
                if ($0 ~ /y$|m$|=$/) {
                    gsub(/[[:space:]]*=[[:space:]]*y$/, "=y")
                    gsub(/[[:space:]]*=[[:space:]]*m$/, "=m")
                    gsub(/[[:space:]]*=[[:space:]]*$/, "=")
                }
            }
            if (length($0) > 0) {
                print $0
            }
        }' .config > .config.tmp
        
        mv .config.tmp .config
        log "âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ ‡å‡†åŒ–å®Œæˆ"
    else
        log "âŒ .config æ–‡ä»¶åœ¨æ“ä½œè¿‡ç¨‹ä¸­ä¸¢å¤±"
        return 1
    fi
    
    log "ğŸ”§ æ­¥éª¤2: æ¸…ç†é‡å¤é…ç½®è¡Œ..."
    
    local dup_before=$(wc -l < .config)
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    local dup_after=$(wc -l < .config)
    local dup_removed=$((dup_before - dup_after))
    
    if [ $dup_removed -gt 0 ]; then
        log "âœ… å·²åˆ é™¤ $dup_removed ä¸ªå®Œå…¨é‡å¤çš„é…ç½®è¡Œ"
    fi
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    local config_uniq_removed=$((dup_after - $(wc -l < .config)))
    if [ $config_uniq_removed -gt 0 ]; then
        log "âœ… å·²åˆå¹¶ $config_uniq_removed ä¸ªé‡å¤é…ç½®é¡¹"
    fi
    
    log "ğŸ”§ æ­¥éª¤3: æ£€æŸ¥libustreamå†²çª..."
    
    local openssl_enabled=0
    local wolfssl_enabled=0
    
    if grep -q "^CONFIG_PACKAGE_libustream-openssl=y" .config; then
        openssl_enabled=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_libustream-wolfssl=y" .config; then
        wolfssl_enabled=1
    fi
    
    if [ $openssl_enabled -eq 1 ] && [ $wolfssl_enabled -eq 1 ]; then
        log "âš ï¸ å‘ç°libustream-opensslå’Œlibustream-wolfsslå†²çª"
        log "ğŸ”§ ä¿®å¤å†²çª: ç¦ç”¨libustream-openssl"
        
        awk '
        /^CONFIG_PACKAGE_libustream-openssl=y/ {
            print "# CONFIG_PACKAGE_libustream-openssl is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config
        
        log "âœ… å†²çªå·²ä¿®å¤"
    else
        log "âœ… libustreamæ— å†²çª"
    fi
    
    log "ğŸ”§ æ­¥éª¤4: æ£€æŸ¥å¹¶ä¿®å¤å…³é”®é…ç½®..."
    
    local config_tool=""
    if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
        config_tool="scripts/config/config"
        log "âœ… ä½¿ç”¨ scripts/config/config å·¥å…·"
    elif [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
        config_tool="scripts/config/conf"
        log "âœ… ä½¿ç”¨ scripts/config/conf å·¥å…·"
    elif [ -f "scripts/config" ] && [ -x "scripts/config" ]; then
        config_tool="scripts/config"
        log "âœ… ä½¿ç”¨ scripts/config å·¥å…·"
    else
        log "âš ï¸ é…ç½®å·¥å…·ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨awkæ–¹å¼è¿›è¡Œä¿®å¤"
        config_tool=""
    fi
    
    local target=$(grep "^CONFIG_TARGET_" .config | grep "=y" | head -1 | cut -d'_' -f2 | tr '[:upper:]' '[:lower:]')
    local fix_count=0
    
    log "  ğŸ”§ USB 3.0é©±åŠ¨æ£€æŸ¥..."
    local usb3_enabled=0
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        usb3_enabled=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" .config; then
        usb3_enabled=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-qcom=y" .config; then
        usb3_enabled=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config; then
        usb3_enabled=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        usb3_enabled=1
    elif grep -q "^CONFIG_USB_XHCI_HCD=y" .config; then
        usb3_enabled=1
    fi
    
    if [ $usb3_enabled -eq 0 ]; then
        log "  âš ï¸ USB 3.0åŠŸèƒ½æœªå¯ç”¨ï¼Œå°è¯•ä¿®å¤..."
        if [ -n "$config_tool" ]; then
            if [ "$config_tool" = "scripts/config/conf" ]; then
                $config_tool --defconfig CONFIG_PACKAGE_kmod-usb3=y .config 2>/dev/null || true
            else
                $config_tool --enable PACKAGE_kmod-usb3 2>/dev/null || true
            fi
        else
            echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        fi
        fix_count=$((fix_count + 1))
        log "  âœ… USB 3.0åŠŸèƒ½å·²æ·»åŠ "
    else
        log "  âœ… USB 3.0åŠŸèƒ½å·²å¯ç”¨"
    fi
    
    if [ "$target" = "ipq40xx" ] || [ "$target" = "qcom" ]; then
        log "  ğŸ”§ IPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨æ£€æŸ¥..."
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && ! grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=m" .config; then
            log "  âš ï¸ kmod-usb-dwc3-qcomæœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
            if [ -n "$config_tool" ]; then
                if [ "$config_tool" = "scripts/config/conf" ]; then
                    $config_tool --defconfig CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y .config 2>/dev/null || true
                else
                    $config_tool --enable PACKAGE_kmod-usb-dwc3-qcom 2>/dev/null || true
                fi
            else
                echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            fi
            fix_count=$((fix_count + 1))
            log "  âœ… kmod-usb-dwc3-qcomå·²æ·»åŠ "
        else
            log "  âœ… kmod-usb-dwc3-qcomå·²å¯ç”¨"
        fi
        
        if grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config; then
            log "  âœ… é«˜é€šIPQ4019 USB PHYå·²å¯ç”¨"
        elif ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-ipq4019-usb=y" .config && ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-ipq4019-usb=m" .config; then
            log "  âš ï¸ é«˜é€šUSB PHYæœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
            if [ -n "$config_tool" ]; then
                if [ "$config_tool" = "scripts/config/conf" ]; then
                    $config_tool --defconfig CONFIG_PACKAGE_kmod-phy-qcom-ipq4019-usb=y .config 2>/dev/null || true
                else
                    $config_tool --enable PACKAGE_kmod-phy-qcom-ipq4019-usb 2>/dev/null || true
                fi
            else
                echo "CONFIG_PACKAGE_kmod-phy-qcom-ipq4019-usb=y" >> .config
            fi
            fix_count=$((fix_count + 1))
            log "  âœ… é«˜é€šUSB PHYå·²æ·»åŠ "
        fi
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  ğŸ”§ TurboACCé…ç½®æ£€æŸ¥..."
        local turboacc_fixed=0
        
        if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            log "  âš ï¸ luci-app-turboaccæœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
            if [ -n "$config_tool" ]; then
                if [ "$config_tool" = "scripts/config/conf" ]; then
                    $config_tool --defconfig CONFIG_PACKAGE_luci-app-turboacc=y .config 2>/dev/null || true
                else
                    $config_tool --enable PACKAGE_luci-app-turboacc 2>/dev/null || true
                fi
            else
                echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            fi
            turboacc_fixed=1
        fi
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-shortcut-fe=y" .config; then
            log "  âš ï¸ kmod-shortcut-feæœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
            if [ -n "$config_tool" ]; then
                if [ "$config_tool" = "scripts/config/conf" ]; then
                    $config_tool --defconfig CONFIG_PACKAGE_kmod-shortcut-fe=y .config 2>/dev/null || true
                else
                    $config_tool --enable PACKAGE_kmod-shortcut-fe 2>/dev/null || true
                fi
            else
                echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            fi
            turboacc_fixed=1
        fi
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-fast-classifier=y" .config; then
            log "  âš ï¸ kmod-fast-classifieræœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
            if [ -n "$config_tool" ]; then
                if [ "$config_tool" = "scripts/config/conf" ]; then
                    $config_tool --defconfig CONFIG_PACKAGE_kmod-fast-classifier=y .config 2>/dev/null || true
                else
                    $config_tool --enable PACKAGE_kmod-fast-classifier 2>/dev/null || true
                fi
            else
                echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
            fi
            turboacc_fixed=1
        fi
        
        if [ $turboacc_fixed -eq 1 ]; then
            log "  âœ… TurboACCé…ç½®å·²ä¿®å¤"
            fix_count=$((fix_count + 1))
        else
            log "  âœ… TurboACCé…ç½®æ­£å¸¸"
        fi
    fi
    
    log "  ğŸ”§ TCP BBRæ‹¥å¡æ§åˆ¶æ£€æŸ¥..."
    local bbr_fixed=0
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
        log "  âš ï¸ kmod-tcp-bbræœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
        if [ -n "$config_tool" ]; then
            if [ "$config_tool" = "scripts/config/conf" ]; then
                $config_tool --defconfig CONFIG_PACKAGE_kmod-tcp-bbr=y .config 2>/dev/null || true
            else
                $config_tool --enable PACKAGE_kmod-tcp-bbr 2>/dev/null || true
            fi
        else
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        bbr_fixed=1
    fi
    
    if ! grep -q '^CONFIG_DEFAULT_TCP_CONG="bbr"' .config; then
        log "  âš ï¸ DEFAULT_TCP_CONGæœªè®¾ç½®ä¸ºbbrï¼Œå°è¯•ä¿®å¤..."
        if [ -n "$config_tool" ]; then
            if [ "$config_tool" = "scripts/config/conf" ]; then
                sed -i '/^CONFIG_DEFAULT_TCP_CONG=/d' .config
                echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
            else
                $config_tool --set-str DEFAULT_TCP_CONG "bbr" 2>/dev/null || true
            fi
        else
            sed -i '/^CONFIG_DEFAULT_TCP_CONG=/d' .config
            echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        fi
        bbr_fixed=1
    fi
    
    if [ $bbr_fixed -eq 1 ]; then
        log "  âœ… TCP BBRé…ç½®å·²ä¿®å¤"
        fix_count=$((fix_count + 1))
    else
        log "  âœ… TCP BBRé…ç½®æ­£å¸¸"
    fi
    
    log "  ğŸ”§ kmod-ath10k-ctå†²çªæ£€æŸ¥..."
    local ath10k_fixed=0
    
    if grep -q "^CONFIG_PACKAGE_kmod-ath10k=y" .config; then
        log "  âš ï¸ æ£€æµ‹åˆ°æ ‡å‡†ath10ké©±åŠ¨ï¼Œä¸ath10k-ctå†²çªï¼Œæ­£åœ¨ä¿®å¤..."
        sed -i '/^CONFIG_PACKAGE_kmod-ath10k=y/d' .config
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-ath10k-ct=y" .config; then
            echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        fi
        ath10k_fixed=1
        log "  âœ… kmod-ath10k-ctå†²çªå·²ä¿®å¤"
    else
        log "  âœ… kmod-ath10k-cté…ç½®æ­£å¸¸"
    fi
    
    if [ $fix_count -eq 0 ]; then
        log "âœ… æ‰€æœ‰å…³é”®é…ç½®æ£€æŸ¥é€šè¿‡ï¼Œæ— éœ€ä¿®å¤"
    else
        log "âœ… å·²ä¿®å¤ $fix_count ä¸ªå…³é”®é…ç½®é¡¹"
    fi
    
    log "ğŸ”§ æ­¥éª¤5: æœ€ç»ˆå»é‡å’Œæ ¼å¼æ£€æŸ¥..."
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    awk 'NF > 0' .config > .config.tmp
    mv .config.tmp .config
    
    log "âœ… æœ€ç»ˆå»é‡å®Œæˆ"
    
    log "ğŸ”„ æ­¥éª¤6: è¿è¡Œ make defconfig..."
    make defconfig || handle_error "åº”ç”¨é…ç½®å¤±è´¥"
    
    log "ğŸ”§ æ­¥éª¤7: éªŒè¯å…³é”®é…ç½®..."
    
    echo ""
    echo "=== ğŸ” USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
    echo ""
    echo "ğŸ” æ£€æŸ¥åŸºç¡€USBé©±åŠ¨..."
    
    local base_drivers=(
        "kmod-usb-core"
        "kmod-usb2"
        "kmod-usb-storage"
        "kmod-scsi-core"
    )
    
    for driver in "${base_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "âœ… $driver: å·²å¯ç”¨"
        else
            echo "âŒ $driver: æœªå¯ç”¨"
        fi
    done
    
    echo ""
    echo "ğŸ” æ£€æŸ¥USB 3.0é©±åŠ¨..."
    
    local usb3_found=0
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        echo "âœ… kmod-usb3: å·²å¯ç”¨"
        usb3_found=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        echo "âœ… kmod-usb-xhci-hcd: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" .config; then
        echo "âœ… kmod-usb-xhci-plat-hcd: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-qcom=y" .config; then
        echo "âœ… kmod-usb-xhci-qcom: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config; then
        echo "âœ… kmod-usb-xhci-mtk: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        echo "âœ… DWC3 + USB3: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_USB_XHCI_HCD=y" .config; then
        echo "âœ… å†…æ ¸xhciæ”¯æŒ: å·²å¯ç”¨"
        usb3_found=1
    fi
    
    if [ $usb3_found -eq 0 ]; then
        echo "âš ï¸ USB 3.0é©±åŠ¨: æœªæ‰¾åˆ°ä»»ä½•å®ç°"
    fi
    
    echo ""
    echo "ğŸ” æ£€æŸ¥å¹³å°ä¸“ç”¨é©±åŠ¨..."
    
    local target=$(grep "^CONFIG_TARGET_" .config | grep "=y" | head -1 | cut -d'_' -f2 | tr '[:upper:]' '[:lower:]')
    
    case "$target" in
        ipq40xx|qcom)
            echo "ğŸ”§ æ£€æµ‹åˆ°é«˜é€šIPQ40xxå¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
            
            if grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config; then
                echo "âœ… kmod-usb-dwc3-qcom: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ kmod-usb-dwc3-qcom: æœªå¯ç”¨"
            fi
            
            if grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-ipq4019-usb=y" .config; then
                echo "âœ… kmod-phy-qcom-ipq4019-usb: å·²å¯ç”¨"
            elif grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config; then
                echo "âœ… é«˜é€šIPQ4019 USB PHY: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ é«˜é€šUSB PHY: æœªå¯ç”¨"
            fi
            ;;
        mediatek|ramips)
            echo "ğŸ”§ æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
            
            if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config; then
                echo "âœ… kmod-usb-xhci-mtk: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ kmod-usb-xhci-mtk: æœªå¯ç”¨"
            fi
            ;;
        ath79)
            echo "ğŸ”§ æ£€æµ‹åˆ°ATH79å¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
            
            if grep -q "^CONFIG_PACKAGE_kmod-usb2-ath79=y" .config; then
                echo "âœ… kmod-usb2-ath79: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ kmod-usb2-ath79: æœªå¯ç”¨"
            fi
            ;;
    esac
    
    echo ""
    echo "=== ğŸ“¦ æ’ä»¶é…ç½®çŠ¶æ€ ==="
    
    local plugins=$(grep "^CONFIG_PACKAGE_luci-app" .config | grep -E "=y|=m" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    local plugin_count=0
    
    if [ -n "$plugins" ]; then
        while read plugin; do
            plugin_count=$((plugin_count + 1))
            if grep -q "^CONFIG_PACKAGE_${plugin}=y" .config; then
                printf "%-4s âœ… %s: å·²å¯ç”¨\n" "[$plugin_count]" "$plugin"
            elif grep -q "^CONFIG_PACKAGE_${plugin}=m" .config; then
                printf "%-4s ğŸ“¦ %s: æ¨¡å—åŒ–\n" "[$plugin_count]" "$plugin"
            fi
        done <<< "$plugins"
        echo ""
        echo "ğŸ“Š æ’ä»¶æ€»æ•°: $plugin_count ä¸ª"
    else
        echo "æœªæ‰¾åˆ°Luciæ’ä»¶"
    fi
    
    echo ""
    echo "=== ğŸ“¦ å†…æ ¸æ¨¡å—é…ç½®çŠ¶æ€ ==="
    
    local kernel_modules=$(grep "^CONFIG_PACKAGE_kmod-" .config | grep -E "=y|=m" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    local module_count=0
    
    if [ -n "$kernel_modules" ]; then
        while read module; do
            module_count=$((module_count + 1))
            if grep -q "^CONFIG_PACKAGE_${module}=y" .config; then
                printf "%-4s âœ… %s: å·²å¯ç”¨\n" "[$module_count]" "$module"
            elif grep -q "^CONFIG_PACKAGE_${module}=m" .config; then
                printf "%-4s ğŸ“¦ %s: æ¨¡å—åŒ–\n" "[$module_count]" "$module"
            fi
        done <<< "$kernel_modules"
        echo ""
        echo "ğŸ“Š å†…æ ¸æ¨¡å—æ€»æ•°: $module_count ä¸ª"
    else
        echo "æœªæ‰¾åˆ°å†…æ ¸æ¨¡å—"
    fi
    
    echo ""
    echo "=== ğŸ“¦ ç½‘ç»œå·¥å…·é…ç½®çŠ¶æ€ ==="
    
    local net_tools=$(grep "^CONFIG_PACKAGE_" .config | grep -E "=y|=m" | grep -E "iptables|nftables|firewall|qos|sfe|shortcut|acceler|tc|fullcone" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    local net_count=0
    
    if [ -n "$net_tools" ]; then
        while read tool; do
            net_count=$((net_count + 1))
            if grep -q "^CONFIG_PACKAGE_${tool}=y" .config; then
                printf "%-4s âœ… %s: å·²å¯ç”¨\n" "[$net_count]" "$tool"
            elif grep -q "^CONFIG_PACKAGE_${tool}=m" .config; then
                printf "%-4s ğŸ“¦ %s: æ¨¡å—åŒ–\n" "[$net_count]" "$tool"
            fi
        done <<< "$net_tools"
        echo ""
        echo "ğŸ“Š ç½‘ç»œå·¥å…·æ€»æ•°: $net_count ä¸ª"
    else
        echo "æœªæ‰¾åˆ°ç½‘ç»œå·¥å…·"
    fi
    
    echo ""
    echo "=== ğŸ“¦ æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ ==="
    
    local fs_support=$(grep "^CONFIG_PACKAGE_kmod-fs-" .config | grep -E "=y|=m" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    local fs_count=0
    
    if [ -n "$fs_support" ]; then
        while read fs; do
            fs_count=$((fs_count + 1))
            if grep -q "^CONFIG_PACKAGE_${fs}=y" .config; then
                printf "%-4s âœ… %s: å·²å¯ç”¨\n" "[$fs_count]" "$fs"
            elif grep -q "^CONFIG_PACKAGE_${fs}=m" .config; then
                printf "%-4s ğŸ“¦ %s: æ¨¡å—åŒ–\n" "[$fs_count]" "$fs"
            fi
        done <<< "$fs_support"
        echo ""
        echo "ğŸ“Š æ–‡ä»¶ç³»ç»Ÿæ€»æ•°: $fs_count ä¸ª"
    else
        echo "æœªæ‰¾åˆ°æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ"
    fi
    
    echo ""
    echo "=== ğŸ“Š é…ç½®ç»Ÿè®¡ ==="
    
    local enabled_packages=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config 2>/dev/null || echo "0")
    local module_packages=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config 2>/dev/null || echo "0")
    local disabled_packages=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config 2>/dev/null || echo "0")
    local kernel_configs=$(grep -c "^CONFIG_[A-Z].*=y$" .config | grep -v "PACKAGE" | wc -l)
    
    echo "âœ… å·²å¯ç”¨æ’ä»¶/æ¨¡å—: $enabled_packages ä¸ª"
    echo "ğŸ“¦ æ¨¡å—åŒ–æ’ä»¶/æ¨¡å—: $module_packages ä¸ª"
    echo "âŒ å·²ç¦ç”¨æ’ä»¶/æ¨¡å—: $disabled_packages ä¸ª"
    echo "âš™ï¸ å†…æ ¸é…ç½®: $kernel_configs ä¸ª"
    echo "ğŸ“Š æ€»é…ç½®è¡Œæ•°: $(wc -l < .config) è¡Œ"
    
    # ========== å·²åˆ é™¤è®¾å¤‡ä¿¡æ¯è¯¦ç»†æŸ¥è¯¢éƒ¨åˆ† ==========
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
    log "æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "æœ€ç»ˆé…ç½®å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "æœ€ç»ˆé…ç½®è¡Œæ•°: $(wc -l < .config)"
}
#ã€build_firmware_main.sh-16-endã€‘

#ã€build_firmware_main.sh-31ã€‘
workflow_step15_generate_config() {
    local extra_packages="$1"
    
    log "=== æ­¥éª¤15: æ™ºèƒ½é…ç½®ç”Ÿæˆã€ä¿®å¤ç‰ˆã€‘ ==="
    log "å½“å‰è®¾å¤‡: $DEVICE"
    log "å½“å‰ç›®æ ‡: $TARGET"
    log "å½“å‰å­ç›®æ ‡: $SUBTARGET"
    
    set -e
    trap 'echo "âŒ æ­¥éª¤15 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    # ç¡®ä¿ç¯å¢ƒå˜é‡å·²åŠ è½½
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        log "âœ… ä»ç¯å¢ƒæ–‡ä»¶é‡æ–°åŠ è½½: DEVICE=$DEVICE, TARGET=$TARGET"
    fi
    
    # å¦‚æœDEVICEä¸ºç©ºï¼Œå°è¯•ä»å‚æ•°è·å–
    if [ -z "$DEVICE" ] && [ -n "$2" ]; then
        DEVICE="$2"
        log "âš ï¸ DEVICEä¸ºç©ºï¼Œä½¿ç”¨å‚æ•°: $DEVICE"
    fi
    
    # è®¾å¤‡åè½¬æ¢ - é’ˆå¯¹ac42u/acrh17çš„ç‰¹æ®Šå¤„ç†
    local device_for_config="$DEVICE"
    case "$DEVICE" in
        ac42u|rt-ac42u)
            device_for_config="asus_rt-ac42u"
            log "ğŸ”§ è®¾å¤‡åè½¬æ¢: $DEVICE -> $device_for_config"
            ;;
        acrh17|rt-acrh17)
            device_for_config="asus_rt-acrh17"
            log "ğŸ”§ è®¾å¤‡åè½¬æ¢: $DEVICE -> $device_for_config"
            ;;
        *)
            # é»˜è®¤è½¬æ¢ï¼šè½¬å°å†™ï¼Œæ¨ªçº¿å˜ä¸‹åˆ’çº¿
            device_for_config=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
            ;;
    esac
    
    cd "$BUILD_DIR" || handle_error "æ— æ³•è¿›å…¥æ„å»ºç›®å½•"
    
    # =========================================================================
    # è®¾å¤‡å®šä¹‰æ–‡ä»¶æŸ¥æ‰¾ï¼ˆä»…ä¸€æ¬¡ï¼‰
    # =========================================================================
    log ""
    log "=== ğŸ” è®¾å¤‡å®šä¹‰æ–‡ä»¶éªŒè¯ï¼ˆå‰ç½®æ£€æŸ¥ï¼‰ ==="
    
    # ç¡®å®šæœç´¢å…³é”®è¯
    local search_device=""
    case "$DEVICE" in
        ac42u|rt-ac42u|asus_rt-ac42u)
            search_device="ac42u"
            ;;
        acrh17|rt-acrh17|asus_rt-acrh17)
            search_device="acrh17"
            ;;
        *)
            search_device="$DEVICE"
            ;;
    esac
    
    log "æœç´¢è®¾å¤‡å: $search_device"
    log "æœç´¢è·¯å¾„: target/linux/$TARGET"
    
    # åˆ—å‡ºæ‰€æœ‰ .mk æ–‡ä»¶
    echo ""
    echo "ğŸ“ æ‰€æœ‰å­å¹³å° .mk æ–‡ä»¶åˆ—è¡¨:"
    local mk_files=()
    while IFS= read -r file; do
        mk_files+=("$file")
    done < <(find "target/linux/$TARGET" -type f -name "*.mk" 2>/dev/null | sort)
    
    if [ ${#mk_files[@]} -gt 0 ]; then
        echo "----------------------------------------"
        for i in "${!mk_files[@]}"; do
            printf "[%2d] %s\n" $((i+1)) "${mk_files[$i]}"
        done
        echo "----------------------------------------"
        echo "ğŸ“Š å…±æ‰¾åˆ° ${#mk_files[@]} ä¸ª .mk æ–‡ä»¶"
    else
        echo "   æœªæ‰¾åˆ° .mk æ–‡ä»¶"
    fi
    echo ""
    
    # æŸ¥æ‰¾åŒ…å«è®¾å¤‡å®šä¹‰çš„ .mk æ–‡ä»¶
    local device_file=""
    for mkfile in "${mk_files[@]}"; do
        if grep -q "define Device.*$search_device" "$mkfile" 2>/dev/null; then
            device_file="$mkfile"
            break
        fi
    done
    
    if [ -z "$device_file" ] || [ ! -f "$device_file" ]; then
        log "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°è®¾å¤‡ $DEVICE (æœç´¢å: $search_device) çš„å®šä¹‰æ–‡ä»¶"
        log "è¯·æ£€æŸ¥è®¾å¤‡åç§°æ˜¯å¦æ­£ç¡®ï¼Œæˆ– target/linux/$TARGET ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ .mk æ–‡ä»¶"
        exit 1
    fi
    
    log "âœ… æ‰¾åˆ°è®¾å¤‡å®šä¹‰æ–‡ä»¶: $device_file"
    
    # æå–è®¾å¤‡å®šä¹‰å—å¹¶æ˜¾ç¤ºå…³é”®è¡Œ
    local device_block=""
    device_block=$(awk "/define Device.*$search_device/,/^[[:space:]]*$|^endef/" "$device_file" 2>/dev/null)
    
    if [ -n "$device_block" ]; then
        echo ""
        echo "ğŸ“‹ è®¾å¤‡å®šä¹‰ä¿¡æ¯ï¼ˆå…³é”®å­—æ®µï¼‰:"
        echo "----------------------------------------"
        # æ˜¾ç¤º define Device è¡Œ
        echo "$device_block" | grep -E "define Device" | head -1
        # æ˜¾ç¤ºå…³é”®å±æ€§
        echo "$device_block" | grep -E "^[[:space:]]*(DEVICE_VENDOR|DEVICE_MODEL|DEVICE_VARIANT|DEVICE_DTS)[[:space:]]*:="
        echo "----------------------------------------"
    else
        log "âš ï¸ è­¦å‘Šï¼šæ— æ³•æå–è®¾å¤‡ $search_device çš„é…ç½®å—"
    fi
    
    # æå–å…³é”®å€¼ç”¨äºåç»­å¯¹æ¯”
    local soc_define=""
    local model_define=""
    local title_define=""
    local kernel_define=""
    local packages_define=""
    
    if [ -n "$device_block" ]; then
        soc_define=$(echo "$device_block" | awk -F':=' '/^[[:space:]]*SOC[[:space:]]*:=/ {gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2}')
        model_define=$(echo "$device_block" | awk -F':=' '/^[[:space:]]*DEVICE_MODEL[[:space:]]*:=/ {gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2}')
        title_define=$(echo "$device_block" | awk -F':=' '/^[[:space:]]*DEVICE_TITLE[[:space:]]*:=/ {gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2}')
        kernel_define=$(echo "$device_block" | awk -F':=' '/^[[:space:]]*KERNEL_PATCHVER[[:space:]]*:=/ {gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2}')
        packages_define=$(echo "$device_block" | awk -F':=' '/^[[:space:]]*DEVICE_PACKAGES[[:space:]]*:=/ {gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2}')
    fi
    
    log "âœ… è®¾å¤‡å®šä¹‰æ–‡ä»¶éªŒè¯é€šè¿‡ï¼Œç»§ç»­ç”Ÿæˆé…ç½®"
    
    # =========================================================================
    # ä¸ support.sh ä¿¡æ¯å¯¹æ¯”ï¼ˆç§»è‡³è®¾å¤‡å®šä¹‰ä¿¡æ¯åé¢ï¼‰
    # =========================================================================
    log ""
    log "ğŸ“Š ä¸ support.sh ä¿¡æ¯å¯¹æ¯”:"
    
    local support_info
    support_info=$("$SUPPORT_SCRIPT" get-platform "$DEVICE" 2>/dev/null)
    if [ -n "$support_info" ]; then
        local support_target
        local support_subtarget
        support_target=$(echo "$support_info" | awk '{print $1}')
        support_subtarget=$(echo "$support_info" | awk '{print $2}')
        
        echo ""
        echo "  æ¥æº          | ç›®æ ‡å¹³å°       | å­ç›®æ ‡         | SOC/å‹å·       | å†…æ ¸ç‰ˆæœ¬"
        echo "  --------------|----------------|----------------|----------------|----------------"
        
        # support.sh è¡Œ
        printf "  support.sh    | %-14s | %-14s | %-14s | %s\n" \
               "$support_target" "$support_subtarget" \
               "${soc_define:-N/A}" "${kernel_define:-N/A}"
        
        # å®šä¹‰æ–‡ä»¶è¡Œ
        printf "  å®šä¹‰æ–‡ä»¶      | %-14s | %-14s | %-14s | %s\n" \
               "$TARGET" "$SUBTARGET" \
               "${soc_define:-N/A}" "${kernel_define:-N/A}"
        
        # æ£€æŸ¥ä¸€è‡´æ€§
        if [ "$support_target" = "$TARGET" ] && [ "$support_subtarget" = "$SUBTARGET" ]; then
            log "  âœ… ç›®æ ‡/å­ç›®æ ‡ä¸ support.sh ä¸€è‡´"
        else
            log "  âš ï¸ è­¦å‘Šï¼šç›®æ ‡/å­ç›®æ ‡ä¸ support.sh ä¸ä¸€è‡´"
            log "     support.sh: $support_target/$support_subtarget"
            log "     å½“å‰é…ç½®:   $TARGET/$SUBTARGET"
        fi
    else
        log "  âš ï¸ æ— æ³•ä» support.sh è·å–ä¿¡æ¯ï¼Œè·³è¿‡å¯¹æ¯”"
    fi
    
    # =========================================================================
    # è°ƒç”¨æ ¸å¿ƒé…ç½®ç”Ÿæˆå‡½æ•°
    # =========================================================================
    generate_config "$extra_packages" "$device_for_config"
    
    # =========================================================================
    # å¼ºåˆ¶ç¦ç”¨æŒ‡å®šæ’ä»¶ç³»åˆ—
    # =========================================================================
    log ""
    log "=== ğŸ”§ å¼ºåˆ¶ç¦ç”¨ä¸éœ€è¦çš„æ’ä»¶ç³»åˆ— ==="
    
    local forbidden_plugins=(
        "luci-app-vssr"
        "luci-app-ssr-plus"
        "luci-app-rclone"
        "luci-app-passwall"
    )
    
    # å¤‡ä»½å½“å‰é…ç½®
    cp .config .config.before_disable
    
    # åˆ é™¤æ‰€æœ‰ç›¸å…³é…ç½®è¡Œï¼ˆåŒ…æ‹¬ä¸»åŒ…å’Œå­é€‰é¡¹ï¼‰
    for plugin in "${forbidden_plugins[@]}"; do
        log "  å¤„ç†æ’ä»¶: $plugin"
        
        # åˆ é™¤ä¸»åŒ…å¯ç”¨è¡Œ
        sed -i "/^CONFIG_PACKAGE_${plugin}=y/d" .config
        sed -i "/^CONFIG_PACKAGE_${plugin}=m/d" .config
        
        # åˆ é™¤æ‰€æœ‰å­é€‰é¡¹ï¼ˆä»¥æ’ä»¶åå¼€å¤´çš„é…ç½®ï¼‰
        sed -i "/^CONFIG_PACKAGE_${plugin}_/d" .config
        
        # æ·»åŠ ç¦ç”¨æ ‡è®°
        echo "# CONFIG_PACKAGE_${plugin} is not set" >> .config
        
        log "    âœ… å·²ç¦ç”¨ $plugin åŠå…¶å­é€‰é¡¹"
    done
    
    # é¢å¤–æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ ¼å¼
    sed -i '/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_/d' .config
    sed -i '/CONFIG_PACKAGE_luci-app-vssr_INCLUDE_/d' .config
    sed -i '/CONFIG_PACKAGE_luci-app-rclone_INCLUDE_/d' .config
    sed -i '/CONFIG_PACKAGE_luci-app-passwall_INCLUDE_/d' .config
    
    # å»é‡
    sort -u .config > .config.tmp && mv .config.tmp .config
    
    log "ğŸ”„ é‡æ–°è¿è¡Œ make defconfig ä½¿ç¦ç”¨ç”Ÿæ•ˆ..."
    make defconfig > /tmp/build-logs/defconfig_disable.log 2>&1 || {
        log "âš ï¸ make defconfig è­¦å‘Šï¼Œä½†ç»§ç»­"
    }
    
    # éªŒè¯ç¦ç”¨ç»“æœ
    local still_enabled=0
    for plugin in "${forbidden_plugins[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${plugin}=y" .config; then
            log "  âŒ $plugin ä»ç„¶è¢«å¯ç”¨"
            still_enabled=$((still_enabled + 1))
        elif grep -q "^CONFIG_PACKAGE_${plugin}=m" .config; then
            log "  âŒ $plugin ä»ç„¶è¢«æ¨¡å—åŒ–"
            still_enabled=$((still_enabled + 1))
        else
            log "  âœ… $plugin å·²æ­£ç¡®ç¦ç”¨"
        fi
    done
    
    if [ $still_enabled -eq 0 ]; then
        log "ğŸ‰ æ‰€æœ‰æŒ‡å®šæ’ä»¶å·²æˆåŠŸç¦ç”¨"
    else
        log "âš ï¸ æœ‰ $still_enabled ä¸ªæ’ä»¶æœªèƒ½ç¦ç”¨ï¼Œè¯·æ£€æŸ¥ feeds æˆ–ä¾èµ–"
    fi
    
    # æœ€ç»ˆé…ç½®ç»Ÿè®¡
    log ""
    log "ğŸ“Š é…ç½®ç»Ÿè®¡ï¼ˆç¦ç”¨åï¼‰:"
    log "  æ€»é…ç½®è¡Œæ•°: $(wc -l < .config)"
    log "  å¯ç”¨è½¯ä»¶åŒ…: $(grep -c "^CONFIG_PACKAGE_.*=y$" .config)"
    log "  æ¨¡å—åŒ–è½¯ä»¶åŒ…: $(grep -c "^CONFIG_PACKAGE_.*=m$" .config)"
    
    log "âœ… æ­¥éª¤15 å®Œæˆ"
}
#ã€build_firmware_main.sh-31-endã€‘

#ã€build_firmware_main.sh-39ã€‘
workflow_step26_check_artifacts() {
    log "=== æ­¥éª¤26: æ£€æŸ¥æ„å»ºäº§ç‰©ï¼ˆå®Œæ•´æ˜¾ç¤ºï¼‰ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤26 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    cd $BUILD_DIR
    
    if [ -d "bin/targets" ]; then
        echo "âœ… æ‰¾åˆ°å›ºä»¶ç›®å½•"
        
        FIRMWARE_COUNT=0
        PACKAGE_COUNT=0
        
        FIRMWARE_COUNT=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
        PACKAGE_COUNT=$(find bin/targets -type f \( -name "*.gz" -o -name "*.ipk" \) 2>/dev/null | wc -l)
        
        echo "=========================================="
        echo "ğŸ“ˆ æ„å»ºäº§ç‰©ç»Ÿè®¡:"
        echo "  å›ºä»¶æ–‡ä»¶: $FIRMWARE_COUNT ä¸ª (.bin/.img)"
        echo "  åŒ…æ–‡ä»¶: $PACKAGE_COUNT ä¸ª (.gz/.ipk)"
        echo ""
        
        if [ $FIRMWARE_COUNT -gt 0 ]; then
            echo "ğŸ“ å›ºä»¶æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
            echo "------------------------------------------"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                FILE_NAME=$(basename "$file")
                echo "ğŸ¯ $FILE_NAME ($SIZE)"
            done
        else
            echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶ (.bin/.img)"
        fi
        
        echo "=========================================="
        echo "âœ… æ„å»ºäº§ç‰©æ£€æŸ¥å®Œæˆ"
    else
        echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°å›ºä»¶ç›®å½•"
        exit 1
    fi
    
    log "âœ… æ­¥éª¤26 å®Œæˆ"
}
#ã€build_firmware_main.sh-39-endã€‘
