#ã€build_firmware_main.sh-04ã€‘è®¾å¤‡æ”¯æŒå‡½æ•°ï¼ˆæ·»åŠ æ¨¡ç³Šæœç´¢ç‰ˆï¼‰
load_device_support() {
    log "ğŸ”§ åŠ è½½è®¾å¤‡æ”¯æŒè„šæœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰..."
    
    # æ–¹æ³•1ï¼šä½¿ç”¨é¢„è®¾è·¯å¾„
    local support_file="$SUPPORT_DIR/support.sh"
    log "ğŸ“ æ£€æŸ¥é¢„è®¾è·¯å¾„: $support_file"
    
    if [ -f "$support_file" ]; then
        log "âœ… åœ¨é¢„è®¾è·¯å¾„æ‰¾åˆ°è®¾å¤‡æ”¯æŒè„šæœ¬"
        return _load_support_file "$support_file"
    fi
    
    log "âš ï¸ é¢„è®¾è·¯å¾„æœªæ‰¾åˆ°ï¼Œå¼€å§‹æ¨¡ç³Šæœç´¢..."
    
    # æ–¹æ³•2ï¼šåœ¨ä»“åº“æ ¹ç›®å½•é€’å½’æœç´¢
    log "ğŸ” åœ¨ä»“åº“æ ¹ç›®å½•é€’å½’æœç´¢ support.sh..."
    local found_files=$(find "$REPO_ROOT" -type f -name "support.sh" 2>/dev/null | head -5)
    
    if [ -n "$found_files" ]; then
        log "âœ… æ‰¾åˆ°å¯èƒ½çš„ support.sh æ–‡ä»¶:"
        echo "$found_files" | while read file; do
            log "  ğŸ“ $file"
        done
        
        # ä¼˜å…ˆé€‰æ‹©åŒ…å« firmware-config è·¯å¾„çš„
        local firmware_config_file=$(echo "$found_files" | grep "firmware-config" | head -1)
        if [ -n "$firmware_config_file" ]; then
            log "ğŸ¯ é€‰æ‹© firmware-config ç›®å½•ä¸‹çš„æ–‡ä»¶: $firmware_config_file"
            return _load_support_file "$firmware_config_file"
        fi
        
        # é€‰æ‹©ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶
        local first_file=$(echo "$found_files" | head -1)
        log "ğŸ¯ é€‰æ‹©ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶: $first_file"
        return _load_support_file "$first_file"
    fi
    
    # æ–¹æ³•3ï¼šåœ¨å½“å‰ç›®å½•å’Œçˆ¶ç›®å½•æœç´¢
    log "ğŸ” åœ¨å½“å‰ç›®å½•å’Œçˆ¶ç›®å½•æœç´¢..."
    local current_dir=$(pwd)
    local max_depth=5
    local depth=0
    
    while [ "$current_dir" != "/" ] && [ $depth -lt $max_depth ]; do
        depth=$((depth + 1))
        local test_file="$current_dir/firmware-config/support.sh"
        
        if [ -f "$test_file" ]; then
            log "âœ… åœ¨çˆ¶ç›®å½• $current_dir æ‰¾åˆ°: $test_file"
            return _load_support_file "$test_file"
        fi
        
        # æ£€æŸ¥å½“å‰ç›®å½•
        local test_file2="$current_dir/support.sh"
        if [ -f "$test_file2" ]; then
            log "âœ… åœ¨å½“å‰ç›®å½• $current_dir æ‰¾åˆ°: $test_file2"
            return _load_support_file "$test_file2"
        fi
        
        current_dir=$(dirname "$current_dir")
    done
    
    # æ–¹æ³•4ï¼šåœ¨å¸¸è§ä½ç½®æœç´¢
    log "ğŸ” åœ¨å¸¸è§ä½ç½®æœç´¢..."
    local common_locations=(
        "/home/runner/work/openwrt/openwrt/firmware-config/support.sh"
        "/mnt/firmware-config/support.sh"
        "/tmp/firmware-config/support.sh"
        "./firmware-config/support.sh"
        "../firmware-config/support.sh"
        "../../firmware-config/support.sh"
    )
    
    for location in "${common_locations[@]}"; do
        if [ -f "$location" ]; then
            log "âœ… åœ¨å¸¸è§ä½ç½®æ‰¾åˆ°: $location"
            return _load_support_file "$location"
        fi
    done
    
    # æ–¹æ³•5ï¼šä½¿ç”¨ find å‘½ä»¤å…¨å±€æœç´¢
    log "ğŸ” å…¨å±€æœç´¢ support.shï¼ˆå¯èƒ½éœ€è¦æ—¶é—´ï¼‰..."
    local global_found=$(find / -type f -name "support.sh" 2>/dev/null | grep -v "/proc\|/sys" | head -3)
    
    if [ -n "$global_found" ]; then
        log "ğŸŒ å…¨å±€æœç´¢æ‰¾åˆ°çš„æ–‡ä»¶:"
        echo "$global_found" | while read file; do
            log "  ğŸ“ $file"
        done
        
        # ä¼˜å…ˆé€‰æ‹©åŒ…å« openwrt æˆ– firmware çš„è·¯å¾„
        local openwrt_file=$(echo "$global_found" | grep -i "openwrt" | head -1)
        if [ -n "$openwrt_file" ]; then
            log "ğŸ¯ é€‰æ‹© openwrt ç›¸å…³æ–‡ä»¶: $openwrt_file"
            return _load_support_file "$openwrt_file"
        fi
        
        local firmware_file=$(echo "$global_found" | grep -i "firmware" | head -1)
        if [ -n "$firmware_file" ]; then
            log "ğŸ¯ é€‰æ‹© firmware ç›¸å…³æ–‡ä»¶: $firmware_file"
            return _load_support_file "$firmware_file"
        fi
    fi
    
    # æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥
    log "âŒ æ‰€æœ‰æœç´¢æ–¹æ³•éƒ½å¤±è´¥ï¼Œæ— æ³•æ‰¾åˆ° support.sh"
    log "ğŸ“Š è°ƒè¯•ä¿¡æ¯:"
    log "  å½“å‰ç›®å½•: $(pwd)"
    log "  REPO_ROOT: $REPO_ROOT"
    log "  SUPPORT_DIR: $SUPPORT_DIR"
    log "  GITHUB_WORKSPACE: ${GITHUB_WORKSPACE:-æœªè®¾ç½®}"
    
    log "ğŸ“ å½“å‰ç›®å½•ç»“æ„:"
    find . -maxdepth 3 -type d 2>/dev/null | head -20
    
    return 1
}

#ã€build_firmware_main.sh-04aã€‘è¾…åŠ©å‡½æ•°ï¼šåŠ è½½æ”¯æŒæ–‡ä»¶
_load_support_file() {
    local support_file="$1"
    
    log "ğŸ“‚ åŠ è½½æ”¯æŒæ–‡ä»¶: $support_file"
    
    # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    log "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
    ls -lh "$support_file"
    
    # æµ‹è¯•æ–‡ä»¶å†…å®¹
    log "ğŸ“„ æ–‡ä»¶å‰5è¡Œ:"
    head -5 "$support_file"
    
    # åŠ è½½æ–‡ä»¶
    if source "$support_file" 2>/dev/null; then
        log "âœ… æˆåŠŸåŠ è½½è®¾å¤‡æ”¯æŒè„šæœ¬"
        
        # éªŒè¯å…³é”®å‡½æ•°
        local has_functions=true
        
        if ! command -v get_device_config >/dev/null 2>&1; then
            log "âš ï¸ æœªæ‰¾åˆ° get_device_config å‡½æ•°"
            has_functions=false
        fi
        
        if ! command -v get_device_description >/dev/null 2>&1; then
            log "âš ï¸ æœªæ‰¾åˆ° get_device_description å‡½æ•°"
            has_functions=false
        fi
        
        if ! command -v get_all_devices >/dev/null 2>&1; then
            log "âš ï¸ æœªæ‰¾åˆ° get_all_devices å‡½æ•°"
            has_functions=false
        fi
        
        if [ "$has_functions" = true ]; then
            log "ğŸ‰ æ‰€æœ‰å¿…éœ€å‡½æ•°éƒ½å­˜åœ¨"
            
            # æµ‹è¯•è·å–è®¾å¤‡åˆ—è¡¨
            if command -v get_all_devices >/dev/null 2>&1; then
                local all_devices
                if all_devices=$(get_all_devices 2>/dev/null); then
                    log "ğŸ“± æ”¯æŒçš„è®¾å¤‡: $all_devices"
                else
                    log "âš ï¸ æ— æ³•æ‰§è¡Œ get_all_devices å‡½æ•°"
                fi
            fi
            
            return 0
        else
            log "âŒ æ”¯æŒæ–‡ä»¶ç¼ºå°‘å¿…éœ€å‡½æ•°"
            return 1
        fi
    else
        log "âŒ æ— æ³•åŠ è½½æ”¯æŒæ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯è¯­æ³•é”™è¯¯æˆ–æƒé™é—®é¢˜ï¼‰"
        return 1
    fi
}

#ã€build_firmware_main.sh-04bã€‘è°ƒè¯•å‡½æ•°ï¼šæ˜¾ç¤ºæ‰€æœ‰å¯èƒ½çš„è·¯å¾„
debug_find_support() {
    log "ğŸ” è°ƒè¯•ï¼šæŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ support.sh æ–‡ä»¶"
    
    log "1. ä»å½“å‰ç›®å½•å¼€å§‹æœç´¢:"
    find . -name "support.sh" -type f 2>/dev/null | head -10
    
    log "2. ä»ä»“åº“æ ¹ç›®å½•æœç´¢:"
    if [ -d "$REPO_ROOT" ]; then
        find "$REPO_ROOT" -name "support.sh" -type f 2>/dev/null | head -10
    fi
    
    log "3. æœç´¢æ‰€æœ‰åŒ…å« firmware-config çš„ç›®å½•:"
    find / -type d -name "firmware-config" 2>/dev/null | grep -v "/proc\|/sys" | head -5 | while read dir; do
        log "  ğŸ“ $dir"
        if [ -f "$dir/support.sh" ]; then
            log "    âœ… åŒ…å« support.sh"
        else
            log "    âŒ ä¸åŒ…å« support.sh"
        fi
    done
    
    log "4. æ£€æŸ¥å¸¸è§è·¯å¾„:"
    local check_paths=(
        "$(pwd)/firmware-config/support.sh"
        "$(pwd)/../firmware-config/support.sh"
        "$(pwd)/../../firmware-config/support.sh"
        "/home/runner/work/openwrt/openwrt/firmware-config/support.sh"
        "/mnt/openwrt-build/../firmware-config/support.sh"
        "$GITHUB_WORKSPACE/firmware-config/support.sh"
        "$REPO_ROOT/firmware-config/support.sh"
    )
    
    for path in "${check_paths[@]}"; do
        if [ -f "$path" ]; then
            log "  âœ… $path"
        else
            log "  âŒ $path"
        fi
    done
    
    log "5. ç¯å¢ƒå˜é‡:"
    log "  GITHUB_WORKSPACE: ${GITHUB_WORKSPACE:-æœªè®¾ç½®}"
    log "  REPO_ROOT: $REPO_ROOT"
    log "  SUPPORT_DIR: $SUPPORT_DIR"
    log "  PWD: $(pwd)"
}

#ã€build_firmware_main.sh-35ã€‘ä¸»å‡½æ•°ï¼ˆæ·»åŠ è°ƒè¯•å‘½ä»¤ï¼‰
main() {
    case $1 in
        # æ–°å¢è°ƒè¯•å‘½ä»¤
        "debug_find_support")
            debug_find_support
            ;;
        "debug_load_device")
            load_device_support
            ;;
        "debug_env")
            log "ç¯å¢ƒå˜é‡:"
            env | grep -E "(GITHUB|REPO|SUPPORT|BUILD)" | sort
            ;;
            
        # å…¶ä»–åŸæœ‰å‘½ä»¤...
        *)
            # ... åŸæœ‰ä»£ç  ...
            ;;
    esac
}
