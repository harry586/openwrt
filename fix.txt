#„Äêbuild_firmware_main.sh-06„Äë
initialize_build_env() {
    local device_name=$1
    local version_selection=$2
    local config_mode=$3
    
    cd $BUILD_DIR || handle_error "ËøõÂÖ•ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
    
    log "=== ÁâàÊú¨ÈÄâÊã© ==="
    if [ "$version_selection" = "23.05" ]; then
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-23.05"
    else
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-21.02"
    fi
    log "‚úÖ ÁâàÊú¨ÈÄâÊã©ÂÆåÊàê: $SELECTED_BRANCH"
    
    log "=== ÂÖãÈöÜÊ∫êÁ†Å ==="
    log "‰ªìÂ∫ì: $SELECTED_REPO_URL"
    log "ÂàÜÊîØ: $SELECTED_BRANCH"
    
    sudo rm -rf ./* ./.git* 2>/dev/null || true
    
    git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . || handle_error "ÂÖãÈöÜÊ∫êÁ†ÅÂ§±Ë¥•"
    log "‚úÖ Ê∫êÁ†ÅÂÖãÈöÜÂÆåÊàê"
    
    local important_source_files=("Makefile" "feeds.conf.default" "rules.mk" "Config.in")
    for file in "${important_source_files[@]}"; do
        if [ -f "$file" ]; then
            log "‚úÖ Ê∫êÁ†ÅÊñá‰ª∂Â≠òÂú®: $file"
        else
            log "‚ùå Ê∫êÁ†ÅÊñá‰ª∂Áº∫Â§±: $file"
        fi
    done
    
    log "=== ËÆæÂ§áÈÖçÁΩÆ ==="
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "üîç Ë∞ÉÁî®support.shËé∑ÂèñËÆæÂ§áÂπ≥Âè∞‰ø°ÊÅØ..."
        PLATFORM_INFO=$("$SUPPORT_SCRIPT" get-platform "$device_name")
        if [ -n "$PLATFORM_INFO" ]; then
            TARGET=$(echo "$PLATFORM_INFO" | awk '{print $1}')
            SUBTARGET=$(echo "$PLATFORM_INFO" | awk '{print $2}')
            DEVICE="$device_name"
            log "‚úÖ ‰ªésupport.shËé∑ÂèñÂπ≥Âè∞‰ø°ÊÅØ: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
        else
            log "‚ùå Êó†Ê≥ï‰ªésupport.shËé∑ÂèñÂπ≥Âè∞‰ø°ÊÅØ"
            handle_error "Ëé∑ÂèñÂπ≥Âè∞‰ø°ÊÅØÂ§±Ë¥•"
        fi
    else
        log "‚ùå support.sh‰∏çÂ≠òÂú®"
        handle_error "support.shËÑöÊú¨Áº∫Â§±"
    fi
    
    log "üîß ËÆæÂ§á: $device_name"
    log "üîß ÁõÆÊ†áÂπ≥Âè∞: $TARGET/$SUBTARGET"
    
    CONFIG_MODE="$config_mode"
    
    log "ÁõÆÊ†á: $TARGET"
    log "Â≠êÁõÆÊ†á: $SUBTARGET"
    log "ËÆæÂ§á: $DEVICE"
    log "ÈÖçÁΩÆÊ®°Âºè: $CONFIG_MODE"
    
    # üî• ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁ°Æ‰øùconfigÂ∑•ÂÖ∑ÂèØÁî®
    log "=== ÁºñËØëÈÖçÁΩÆÂ∑•ÂÖ∑ ==="
    
    local config_tool_created=0
    local real_config_tool=""
    
    # ÊñπÊ≥ï1: Áõ¥Êé•ÁºñËØë - OpenWrtÁºñËØëÂêéÁîüÊàêÁöÑÊòØscripts/config/configÂèØÊâßË°åÊñá‰ª∂
    log "üîß Â∞ùËØïÊñπÊ≥ï1: make scripts/config"
    if make scripts/config; then
        # Ê£ÄÊü•ÁºñËØëÂêéÁöÑÂÆûÈôÖ‰ΩçÁΩÆ
        if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
            log "‚úÖ ÊñπÊ≥ï1ÊàêÂäü: scripts/config/config Â∑•ÂÖ∑ÁºñËØëÊàêÂäü"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        elif [ -f "scripts/config" ] && [ -x "scripts/config" ] && [ ! -d "scripts/config" ]; then
            log "‚úÖ ÊñπÊ≥ï1ÊàêÂäü: scripts/config Â∑•ÂÖ∑ÁºñËØëÊàêÂäü"
            real_config_tool="scripts/config"
            config_tool_created=1
        fi
    fi
    
    # ÊñπÊ≥ï2: Êü•ÊâæÂ∑≤ÁºñËØëÁöÑconfigÂ∑•ÂÖ∑
    if [ $config_tool_created -eq 0 ]; then
        log "üîß Â∞ùËØïÊñπÊ≥ï2: Êü•ÊâæÂ∑≤ÁºñËØëÁöÑconfigÂ∑•ÂÖ∑"
        if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
            log "‚úÖ ÊñπÊ≥ï2ÊàêÂäü: ÊâæÂà∞ scripts/config/config"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        elif [ -f "scripts/kconfig/conf" ] && [ -x "scripts/kconfig/conf" ]; then
            log "‚úÖ ÊñπÊ≥ï2ÊàêÂäü: ÊâæÂà∞ scripts/kconfig/conf"
            # ÂàõÂª∫configÁõÆÂΩïÂíåÂåÖË£ÖËÑöÊú¨
            mkdir -p scripts/config
            cat > scripts/config/config << EOF
#!/bin/sh
exec "\$(dirname "\$0")/../kconfig/conf" "\$@"
EOF
            chmod +x scripts/config/config
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # ÊñπÊ≥ï3: ‰ªéSDKÂ§çÂà∂
    if [ $config_tool_created -eq 0 ] && [ -n "$COMPILER_DIR" ]; then
        log "üîß Â∞ùËØïÊñπÊ≥ï3: ‰ªéSDKÁõÆÂΩïÂ§çÂà∂"
        if [ -f "$COMPILER_DIR/scripts/config/config" ] && [ -x "$COMPILER_DIR/scripts/config/config" ]; then
            mkdir -p scripts/config
            cp "$COMPILER_DIR/scripts/config/config" scripts/config/
            chmod +x scripts/config/config
            log "‚úÖ ÊñπÊ≥ï3ÊàêÂäü: ‰ªéSDKÂ§çÂà∂ config Â∑•ÂÖ∑"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        elif [ -f "$COMPILER_DIR/scripts/config" ] && [ -x "$COMPILER_DIR/scripts/config" ] && [ ! -d "$COMPILER_DIR/scripts/config" ]; then
            cp "$COMPILER_DIR/scripts/config" scripts/
            chmod +x scripts/config
            log "‚úÖ ÊñπÊ≥ï3ÊàêÂäü: ‰ªéSDKÂ§çÂà∂ config Â∑•ÂÖ∑"
            real_config_tool="scripts/config"
            config_tool_created=1
        fi
    fi
    
    # ÊñπÊ≥ï4: ‰ΩøÁî®defconfigÁîüÊàêÈÖçÁΩÆÂ∑•ÂÖ∑ÔºàÁªàÊûÅÊñπÊ°àÔºâ
    if [ $config_tool_created -eq 0 ]; then
        log "üîß Â∞ùËØïÊñπÊ≥ï4: ËøêË°ådefconfigÁîüÊàêÈÖçÁΩÆÂ∑•ÂÖ∑"
        # ÂÖàÂàõÂª∫‰∏Ä‰∏™ÊúÄÂ∞èÈÖçÁΩÆ
        echo "CONFIG_TARGET_${TARGET}=y" > .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        if make defconfig; then
            if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
                log "‚úÖ ÊñπÊ≥ï4ÊàêÂäü: defconfigÁîüÊàê‰∫ÜconfigÂ∑•ÂÖ∑"
                real_config_tool="scripts/config/config"
                config_tool_created=1
            fi
        fi
    fi
    
    # ÊñπÊ≥ï5: ÂàõÂª∫Áõ¥Êé•ÂÜôÂÖ•.configÁöÑÂåÖË£ÖËÑöÊú¨Ôºà‰øùÂ∫ïÊñπÊ°àÔºâ
    if [ $config_tool_created -eq 0 ]; then
        log "üîß Â∞ùËØïÊñπÊ≥ï5: ÂàõÂª∫Áõ¥Êé•ÂÜôÂÖ•.configÁöÑÂåÖË£ÖËÑöÊú¨"
        mkdir -p scripts/config
        cat > scripts/config/config << 'EOF'
#!/bin/sh
# Áõ¥Êé•ÂÜôÂÖ•.configÁöÑÁÆÄÊòìconfigÂ∑•ÂÖ∑
CONFIG_FILE=".config"

case "$1" in
    --enable)
        shift
        sed -i "/^# CONFIG_$1 is not set/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=/d" "$CONFIG_FILE"
        echo "CONFIG_$1=y" >> "$CONFIG_FILE"
        ;;
    --disable)
        shift
        sed -i "/^CONFIG_$1=y/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=m/d" "$CONFIG_FILE"
        echo "# CONFIG_$1 is not set" >> "$CONFIG_FILE"
        ;;
    --module)
        shift
        sed -i "/^# CONFIG_$1 is not set/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=y/d" "$CONFIG_FILE"
        echo "CONFIG_$1=m" >> "$CONFIG_FILE"
        ;;
    --set-str)
        shift
        local name="$1"
        local value="$2"
        sed -i "/^CONFIG_$name=/d" "$CONFIG_FILE"
        echo "CONFIG_$name=\"$value\"" >> "$CONFIG_FILE"
        shift 2
        ;;
esac
EOF
        chmod +x scripts/config/config
        log "‚úÖ ÊñπÊ≥ï5ÊàêÂäü: ÂàõÂª∫ÁÆÄÊòìconfigÂ∑•ÂÖ∑"
        real_config_tool="scripts/config/config"
        config_tool_created=1
    fi
    
    # ÂàõÂª∫Áªü‰∏ÄË∞ÉÁî®Êé•Âè£ÔºàÁªùÂØπÂèØÈù†ÁâàÔºâ
    if [ $config_tool_created -eq 1 ]; then
        log "üîß ÂàõÂª∫Áªü‰∏ÄË∞ÉÁî®Êé•Âè£..."
        
        # ËÆ∞ÂΩïÁúüÂÆûÂ∑•ÂÖ∑Ë∑ØÂæÑ
        echo "$real_config_tool" > scripts/.config_tool_path
        
        cat > scripts/config-tool << EOF
#!/bin/sh
# Áªü‰∏Ä config Â∑•ÂÖ∑Ë∞ÉÁî®Êé•Âè£ÔºàÁªùÂØπÂèØÈù†ÁâàÔºâ
CONFIG_TOOL="\$(cat "\$(dirname "\$0")/.config_tool_path" 2>/dev/null)"
if [ -n "$CONFIG_TOOL" ] && [ -f "\$CONFIG_TOOL" ] && [ -x "\$CONFIG_TOOL" ]; then
    exec "\$CONFIG_TOOL" "\$@"
fi

# Â§áÈÄâ1: Áõ¥Êé•Êü•Êâæ
if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
    echo "scripts/config/config" > "\$(dirname "\$0")/.config_tool_path"
    exec scripts/config/config "\$@"
fi

# Â§áÈÄâ2: ÊóßÂºèË∑ØÂæÑ
if [ -f "scripts/config" ] && [ -x "scripts/config" ] && [ ! -d "scripts/config" ]; then
    echo "scripts/config" > "\$(dirname "\$0")/.config_tool_path"
    exec scripts/config "\$@"
fi

# Â§áÈÄâ3: kconfig/conf
if [ -f "scripts/kconfig/conf" ] && [ -x "scripts/kconfig/conf" ]; then
    mkdir -p scripts/config
    cat > scripts/config/config << 'INNEREOF'
#!/bin/sh
exec "\$(dirname "\$0")/../kconfig/conf" "\$@"
INNEREOF
    chmod +x scripts/config/config
    echo "scripts/config/config" > "\$(dirname "\$0")/.config_tool_path"
    exec scripts/config/config "\$@"
fi

echo "Error: config tool not found" >&2
exit 1
EOF
        chmod +x scripts/config-tool
        log "‚úÖ Áªü‰∏ÄË∞ÉÁî®Êé•Âè£ÂàõÂª∫ÊàêÂäü: scripts/config-tool"
        
        # ÊµãËØï‰∏Ä‰∏ã
        if scripts/config-tool --help > /dev/null 2>&1; then
            log "‚úÖ Áªü‰∏ÄË∞ÉÁî®Êé•Âè£ÊµãËØïÈÄöËøá"
        else
            log "‚ö†Ô∏è Áªü‰∏ÄË∞ÉÁî®Êé•Âè£ÊµãËØïÂ§±Ë¥•Ôºå‰ΩÜÂ∑•ÂÖ∑ÂèØËÉΩ‰ªçÂèØÁî®"
        fi
    fi
    
    # ÊúÄÁªàÈ™åËØÅ
    if [ $config_tool_created -eq 1 ]; then
        log "‚úÖ ÈÖçÁΩÆÂ∑•ÂÖ∑ÊúÄÁªàÈ™åËØÅÈÄöËøá"
        log "üìÅ ÁúüÂÆûÂ∑•ÂÖ∑Ë∑ØÂæÑ: $real_config_tool"
        log "üìÅ Áªü‰∏ÄË∞ÉÁî®Êé•Âè£: scripts/config-tool"
        
        # ÊòæÁ§∫Â∑•ÂÖ∑ÁâàÊú¨‰ø°ÊÅØ
        if [ -f "$real_config_tool" ]; then
            log "üìã Â∑•ÂÖ∑‰ø°ÊÅØ: $(file "$real_config_tool" | cut -d: -f2- | xargs)"
        fi
    else
        log "‚ùå ÊâÄÊúâÊñπÊ≥ïÈÉΩÂ§±Ë¥•ÔºåÈÖçÁΩÆÂ∑•ÂÖ∑‰∏çÂ≠òÂú®"
        handle_error "Êó†Ê≥ïÂàõÂª∫ÈÖçÁΩÆÂ∑•ÂÖ∑"
    fi
    
    save_env
    
    echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
    echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
    echo "TARGET=$TARGET" >> $GITHUB_ENV
    echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
    echo "DEVICE=$DEVICE" >> $GITHUB_ENV
    echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
    
    log "‚úÖ ÊûÑÂª∫ÁéØÂ¢ÉÂàùÂßãÂåñÂÆåÊàê"
}
#„Äêbuild_firmware_main.sh-06-end„Äë

#„Äêbuild_firmware_main.sh-13„Äë
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "ËøõÂÖ•ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
    
    log "=== Êô∫ËÉΩÈÖçÁΩÆÁîüÊàêÁ≥ªÁªü ==="
    log "ÁâàÊú¨: $SELECTED_BRANCH"
    log "ÁõÆÊ†á: $TARGET"
    log "Â≠êÁõÆÊ†á: $SUBTARGET"
    log "ËÆæÂ§á: $DEVICE"
    log "ÈÖçÁΩÆÊ®°Âºè: $CONFIG_MODE"
    log "ÈÖçÁΩÆÊñá‰ª∂ÁõÆÂΩï: $CONFIG_DIR"
    
    # Âà†Èô§ÊóßÈÖçÁΩÆ
    rm -f .config .config.old .config.bak*
    log "‚úÖ Â∑≤Ê∏ÖÁêÜÊóßÈÖçÁΩÆÊñá‰ª∂"
    
    # ÁîüÊàêÂü∫Á°ÄÁõÆÊ†áÈÖçÁΩÆ
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "üîß ÁîüÊàêÂü∫Á°ÄÈÖçÁΩÆ..."
    make defconfig || handle_error "Âü∫Á°ÄÈÖçÁΩÆÁîüÊàêÂ§±Ë¥•"
    log "‚úÖ Âü∫Á°ÄÈÖçÁΩÆÁîüÊàêÊàêÂäü"
    
    # üî• ‰ΩøÁî®Áªü‰∏ÄË∞ÉÁî®Êé•Âè£ÔºàÊ≠•È™§06Â∑≤Á°Æ‰øùÂèØÁî®Ôºâ
    if [ ! -f "scripts/config-tool" ] || [ ! -x "scripts/config-tool" ]; then
        log "‚ùå Áªü‰∏ÄË∞ÉÁî®Êé•Âè£‰∏çÂ≠òÂú®ÔºåËØ∑Ê£ÄÊü•Ê≠•È™§06"
        handle_error "config-toolÁº∫Â§±"
    fi
    
    local CONFIG_CMD="./scripts/config-tool"
    log "‚úÖ ‰ΩøÁî®Áªü‰∏ÄË∞ÉÁî®Êé•Âè£: scripts/config-tool"
    
    # ÊµãËØïÂ∑•ÂÖ∑ÊòØÂê¶ÂèØÁî®
    if ! $CONFIG_CMD --help > /dev/null 2>&1; then
        log "‚ö†Ô∏è config-toolÊµãËØïÂ§±Ë¥•ÔºåÂ∞ùËØïÈáçÊñ∞ÂàùÂßãÂåñ..."
        # ÈáçÊñ∞ËøêË°åÊ≠•È™§06ÁöÑÈÖçÁΩÆÂ∑•ÂÖ∑ÂàõÂª∫ÈÄªËæë
        cd $BUILD_DIR
        make scripts/config > /dev/null 2>&1 || true
        if [ -f "scripts/config/config" ]; then
            cat > scripts/config-tool << 'EOF'
#!/bin/sh
exec scripts/config/config "$@"
EOF
            chmod +x scripts/config-tool
            log "‚úÖ config-toolÂ∑≤ÈáçÊñ∞ÂàõÂª∫"
        fi
    fi
    
    log "üîß ‰ΩøÁî®ÈÖçÁΩÆÂ∑•ÂÖ∑ÂêàÂπ∂ÈÖçÁΩÆ..."
    
    # 1. Â∫îÁî®USBÈÄöÁî®ÈÖçÁΩÆ
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "üìÅ Â∫îÁî®USBÈÄöÁî®ÈÖçÁΩÆ..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/usb-generic.config"
        log "‚úÖ USBÈÄöÁî®ÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    # 2. Â∫îÁî®Âü∫Á°ÄÈÖçÁΩÆ
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "üìÅ Â∫îÁî®Âü∫Á°ÄÈÖçÁΩÆ..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/base.config"
        log "‚úÖ Âü∫Á°ÄÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    # 3. Â∫îÁî®ËÆæÂ§áÈÖçÁΩÆÊàñÊ®°ÂºèÈÖçÁΩÆ
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "üìÅ Â∫îÁî®ËÆæÂ§áÈÖçÁΩÆ: $DEVICE.config..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$device_config_file"
        log "‚úÖ ËÆæÂ§áÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "üìÅ Â∫îÁî®Ê≠£Â∏∏Ê®°ÂºèÈÖçÁΩÆ..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            # Ë∑≥ËøáTurboACCÈùôÊÄÅÈÖçÁΩÆ
            if echo "$line" | grep -q "luci-app-turboacc\|kmod-shortcut-fe\|kmod-fast-classifier"; then
                continue
            fi
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/normal.config"
        log "‚úÖ Ê≠£Â∏∏Ê®°ÂºèÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    # 4. Â∫îÁî®Âπ≥Âè∞‰∏ìÁî®ÈÖçÁΩÆ
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "üìÅ Â∫îÁî®Âπ≥Âè∞ÈÖçÁΩÆ: $(basename "$platform_config")..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$platform_config"
        log "‚úÖ Âπ≥Âè∞ÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    # 5. Ê∑ªÂä†È¢ùÂ§ñÂåÖ
    if [ -n "$extra_packages" ]; then
        log "üì¶ Ê∑ªÂä†È¢ùÂ§ñÂåÖ: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            if [ -n "$pkg" ]; then
                $CONFIG_CMD --enable "PACKAGE_$pkg"
                log "‚úÖ Ê∑ªÂä†ÂåÖ: $pkg"
            fi
        done
    fi
    
    # 6. Âº∫Âà∂ÂêØÁî®ÂÖ≥ÈîÆÈÖçÁΩÆ
    log "üîß Âº∫Âà∂ÂêØÁî®ÂÖ≥ÈîÆÈÖçÁΩÆ..."
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-hcd
    $CONFIG_CMD --enable PACKAGE_kmod-usb3
    $CONFIG_CMD --enable PACKAGE_kmod-tcp-bbr
    $CONFIG_CMD --set-str DEFAULT_TCP_CONG "bbr"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        $CONFIG_CMD --enable PACKAGE_luci-app-turboacc
        $CONFIG_CMD --enable PACKAGE_kmod-shortcut-fe
        $CONFIG_CMD --enable PACKAGE_kmod-fast-classifier
        log "‚úÖ TurboACCÈÖçÁΩÆÂº∫Âà∂ÂêØÁî®ÂÆåÊàê"
    fi
    
    # 7. Â§ÑÁêÜath10kÂÜ≤Á™Å
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-pci
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-smallbuffers
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-ct-smallbuffers
    $CONFIG_CMD --enable PACKAGE_kmod-ath10k-ct
    log "‚úÖ ath10kÂÜ≤Á™Å‰øÆÂ§çÂÆåÊàê"
    
    # 8. ÊúÄÁªàdefconfig
    log "üîÑ ËøêË°åÊúÄÁªà make defconfig..."
    make defconfig || handle_error "ÊúÄÁªàÈÖçÁΩÆÂ∫îÁî®Â§±Ë¥•"
    
    log "üìä ÈÖçÁΩÆÁîüÊàêÁªüËÆ°:"
    log "  - ÊúÄÁªàÈÖçÁΩÆÊñá‰ª∂: .config"
    log "  - ÈÖçÁΩÆË°åÊï∞: $(wc -l < .config)"
    log "  - ÈÖçÁΩÆÊñá‰ª∂Â§ßÂ∞è: $(ls -lh .config | awk '{print $5}')"
    
    log "‚úÖ ÈÖçÁΩÆÁîüÊàêÂÆåÊàê"
}
#„Äêbuild_firmware_main.sh-13-end„Äë

#„Äêbuild_firmware_main.sh-31„Äë
workflow_step15_generate_config() {
    local extra_packages="$1"
    
    log "=== Ê≠•È™§15: Êô∫ËÉΩÈÖçÁΩÆÁîüÊàê ==="
    
    set -e
    trap 'echo "‚ùå Ê≠•È™§15 Â§±Ë¥•ÔºåÈÄÄÂá∫‰ª£Á†Å: $?"; exit 1' ERR
    
    generate_config "$extra_packages"
    
    log "‚úÖ Ê≠•È™§15 ÂÆåÊàê"
}
#„Äêbuild_firmware_main.sh-31-end„Äë

