#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    local device_override=$2  # æ–°å¢è®¾å¤‡è¦†ç›–å‚æ•°
    
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    # å¦‚æœæä¾›äº†è®¾å¤‡è¦†ç›–å‚æ•°ï¼Œä¼˜å…ˆä½¿ç”¨
    if [ -n "$device_override" ]; then
        DEVICE="$device_override"
        log "ğŸ”§ ä½¿ç”¨è®¾å¤‡è¦†ç›–å‚æ•°: $DEVICE"
    fi
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆè®¾å¤‡æ˜¾å¼æŒ‡å®šç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    # éªŒè¯è®¾å¤‡å˜é‡æ˜¯å¦ä¸ºç©º
    if [ -z "$DEVICE" ]; then
        log "âŒ é”™è¯¯: DEVICEå˜é‡ä¸ºç©ºï¼"
        log "å¯ç”¨ç¯å¢ƒå˜é‡:"
        env | grep -E "DEVICE|TARGET|SELECTED" || true
        handle_error "DEVICEå˜é‡æœªè®¾ç½®"
    fi
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # æ­¥éª¤1: æ ¹æ®è®¾å¤‡åæ˜ å°„åˆ°æ­£ç¡®çš„OpenWrtè®¾å¤‡é…ç½®å
    local openwrt_device=""
    
    # å¦‚æœå¯ç”¨äº†åŠ¨æ€è®¾å¤‡æ˜ å°„ï¼Œå°è¯•ä»support.shè·å–
    if [ "${ENABLE_DYNAMIC_DEVICE_MAPPING:-true}" = "true" ] && [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” å°è¯•ä»support.shè·å–è®¾å¤‡æ˜ å°„..."
        local platform_info=$("$SUPPORT_SCRIPT" get-platform "$DEVICE" 2>/dev/null)
        if [ -n "$platform_info" ]; then
            # ä½¿ç”¨è®¾å¤‡åæœ¬èº«ä½œä¸ºopenwrt_deviceï¼ˆsupport.shå·²ç»å¤„ç†äº†æ˜ å°„ï¼‰
            openwrt_device="$DEVICE"
            log "âœ… ä»support.shè·å–è®¾å¤‡ä¿¡æ¯æˆåŠŸ"
        fi
    fi
    
    # å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œä½¿ç”¨è½¬æ¢è§„åˆ™
    if [ -z "$openwrt_device" ]; then
        case "$DEVICE" in
            ac42u|rt-ac42u|asus_rt-ac42u)
                openwrt_device="asus_rt-ac42u"
                log "ğŸ”§ æ˜ å°„è®¾å¤‡ $DEVICE -> $openwrt_device"
                ;;
            acrh17|rt-acrh17|asus_rt-acrh17)
                openwrt_device="asus_rt-acrh17"
                log "ğŸ”§ æ˜ å°„è®¾å¤‡ $DEVICE -> $openwrt_device"
                ;;
            *)
                openwrt_device=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
                log "ğŸ”§ ä½¿ç”¨è½¬æ¢åçš„è®¾å¤‡å: $openwrt_device"
                ;;
        esac
    fi
    
    # ç›´æ¥ä½¿ç”¨å°å†™çš„è®¾å¤‡å
    local device_lower="$openwrt_device"
    local device_config="CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}"
    
    log "ğŸ”§ è®¾å¤‡é…ç½®å˜é‡: $device_config=y"
    
    # æ­¥éª¤2: åˆ›å»ºåŸºç¡€ç›®æ ‡é…ç½® - ä½¿ç”¨å°å†™è®¾å¤‡å
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
${device_config}=y
EOF
    
    log "ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶å†…å®¹:"
    cat .config
    
    # æ­¥éª¤3: åˆå¹¶æ‰€æœ‰é…ç½®æ–‡ä»¶
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    # è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è¿½åŠ é…ç½®ï¼ˆè¿‡æ»¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
        fi
    }
    
    # ä½¿ç”¨é…ç½®æ–‡ä»¶åæ˜ å°„
    : ${CONFIG_BASE:="base.config"}
    : ${CONFIG_USB_GENERIC:="usb-generic.config"}
    : ${CONFIG_NORMAL:="normal.config"}
    
    append_config "$CONFIG_DIR/$CONFIG_BASE"
    append_config "$CONFIG_DIR/$CONFIG_USB_GENERIC"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    append_config "$CONFIG_DIR/devices/$DEVICE.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/$CONFIG_NORMAL"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # ä»config.txtåŠ¨æ€æ·»åŠ é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if [ -f "$CONFIG_DIR/devices/$DEVICE.config" ]; then
        log "ğŸ“‹ ä»è®¾å¤‡é…ç½®æ–‡ä»¶åŠ¨æ€æ·»åŠ é…ç½®: $CONFIG_DIR/devices/$DEVICE.config"
        append_config "$CONFIG_DIR/devices/$DEVICE.config"
    fi
    
    # TCP BBRï¼ˆæ ¹æ®é…ç½®å¼€å…³ï¼‰
    if [ "${ENABLE_TCP_BBR:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        log "âœ… TCP BBRå·²å¯ç”¨"
    fi
    
    # TurboACCï¼ˆæ ¹æ®é…ç½®å¼€å…³ï¼‰
    if [ "$CONFIG_MODE" = "normal" ] && [ "${ENABLE_TURBOACC:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        log "âœ… TurboACCå·²å¯ç”¨"
    fi
    
    # ath10k å†²çªè§£å†³ï¼ˆæ ¹æ®é…ç½®å¼€å…³ï¼‰
    if [ "${FORCE_ATH10K_CT:-true}" = "true" ]; then
        sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        log "âœ… ath10k-cté©±åŠ¨å·²å¼ºåˆ¶å¯ç”¨"
    fi
    
    # æ­¥éª¤4: ç¬¬ä¸€æ¬¡å»é‡
    log "ğŸ”„ ç¬¬ä¸€æ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # =========================================================================
    # æ­¥éª¤5: åŠ¨æ€è·å–ç›®æ ‡å¹³å°æ”¯æŒçš„å†…æ ¸é…ç½® - å¢å¼ºç‰ˆ
    # æŸ¥æ‰¾é€»è¾‘:
    #   1. é€’å½’æœç´¢æ•´ä¸ªtarget/linux/$TARGETç›®å½•ä¸‹çš„æ‰€æœ‰config-*æ–‡ä»¶
    #   2. ä¼˜å…ˆæŸ¥æ‰¾å­å¹³å°ç›®å½•ä¸­çš„å†…æ ¸é…ç½®æ–‡ä»¶
    #   3. æ ¹æ®å†…æ ¸ç‰ˆæœ¬ä¼˜å…ˆçº§é€‰æ‹©æœ€åˆé€‚çš„é…ç½®
    # =========================================================================
    log "ğŸ” åŠ¨æ€è·å–ç›®æ ‡å¹³å°æ”¯æŒçš„å†…æ ¸é…ç½®ï¼ˆå¢å¼ºç‰ˆï¼‰..."
    
    local kernel_config_file=""
    local kernel_version=""
    local found_kernel=0
    
    # å¦‚æœå¯ç”¨äº†åŠ¨æ€å†…æ ¸æ£€æµ‹
    if [ "${ENABLE_DYNAMIC_KERNEL_DETECTION:-true}" = "true" ]; then
        log "ğŸ” å¼€å§‹é€’å½’æœç´¢å†…æ ¸é…ç½®æ–‡ä»¶..."
        
        # å®šä¹‰è¦æœç´¢çš„æ ¹ç›®å½•
        local search_base="target/linux"
        local target_search_path="$search_base/$TARGET"
        
        # å®šä¹‰å†…æ ¸é…ç½®æ–‡ä»¶æœç´¢æ¨¡å¼
        local config_pattern="${KERNEL_CONFIG_PATTERN:-config-*}"
        
        # æ­¥éª¤1: ä¼˜å…ˆåœ¨å­å¹³å°ç›®å½•ä¸­é€’å½’æœç´¢
        log "ğŸ“ æ­¥éª¤1: åœ¨å­å¹³å°ç›®å½•ä¸­é€’å½’æœç´¢å†…æ ¸é…ç½®..."
        
        # æ£€æŸ¥å­å¹³å°ç›®å½•æ˜¯å¦å­˜åœ¨
        if [ -d "$target_search_path/$SUBTARGET" ]; then
            log "âœ… å­å¹³å°ç›®å½•å­˜åœ¨: $target_search_path/$SUBTARGET"
            
            # é€’å½’æœç´¢å­å¹³å°ç›®å½•ä¸‹çš„æ‰€æœ‰configæ–‡ä»¶
            local subtarget_configs=$(find "$target_search_path/$SUBTARGET" -type f -name "$config_pattern" 2>/dev/null | sort)
            
            if [ -n "$subtarget_configs" ]; then
                log "âœ… åœ¨å­å¹³å°ç›®å½•ä¸­æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶:"
                echo "$subtarget_configs" | while read config; do
                    log "   ğŸ“„ $config"
                done
                
                # æŒ‰ä¼˜å…ˆçº§é€‰æ‹©å†…æ ¸ç‰ˆæœ¬
                for ver in ${KERNEL_VERSION_PRIORITY:-6.6 6.1 5.15 5.10 5.4}; do
                    local matched_config=$(echo "$subtarget_configs" | grep "config-$ver\$" | head -1)
                    if [ -n "$matched_config" ]; then
                        kernel_config_file="$matched_config"
                        kernel_version="$ver"
                        log "âœ… é€‰æ‹©å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
                        found_kernel=1
                        break
                    fi
                done
                
                # å¦‚æœæ²¡æœ‰åŒ¹é…ä¼˜å…ˆçº§ï¼Œé€‰æ‹©æœ€æ–°çš„
                if [ $found_kernel -eq 0 ]; then
                    kernel_config_file=$(echo "$subtarget_configs" | head -1)
                    kernel_version=$(basename "$kernel_config_file" | sed 's/config-//')
                    log "âœ… é€‰æ‹©å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
                    found_kernel=1
                fi
            fi
            
            # åœ¨å­å¹³å°ç›®å½•ä¸­æŸ¥æ‰¾target.mkè·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
            if [ $found_kernel -eq 0 ]; then
                log "ğŸ“„ åœ¨å­å¹³å°ç›®å½•ä¸­æŸ¥æ‰¾target.mkæ–‡ä»¶..."
                local target_mk_files=$(find "$target_search_path/$SUBTARGET" -type f -name "target.mk" 2>/dev/null)
                
                for target_mk in $target_mk_files; do
                    log "ğŸ“„ æ‰¾åˆ°target.mkæ–‡ä»¶: $target_mk"
                    
                    # ä»target.mkä¸­æå–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
                    local kernel_patchver=$(grep -E "^KERNEL_PATCHVER:=" "$target_mk" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
                    local kernel_version_line=$(grep -E "^KERNEL_VERSION:=" "$target_mk" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
                    
                    if [ -n "$kernel_patchver" ]; then
                        kernel_version="$kernel_patchver"
                        log "âœ… ä»target.mkè·å–åˆ°å†…æ ¸è¡¥ä¸ç‰ˆæœ¬: $kernel_version"
                    elif [ -n "$kernel_version_line" ]; then
                        kernel_version=$(echo "$kernel_version_line" | grep -oE '^[0-9]+\.[0-9]+')
                        log "âœ… ä»target.mkè·å–åˆ°å†…æ ¸ç‰ˆæœ¬: $kernel_version_line (ä¸»ç‰ˆæœ¬: $kernel_version)"
                    fi
                    
                    if [ -n "$kernel_version" ]; then
                        # æ ¹æ®è·å–åˆ°çš„å†…æ ¸ç‰ˆæœ¬ï¼Œåœ¨å­å¹³å°ç›®å½•ä¸­æœç´¢å¯¹åº”çš„configæ–‡ä»¶
                        local version_config=$(find "$target_search_path/$SUBTARGET" -type f -name "config-${kernel_version}*" 2>/dev/null | head -1)
                        if [ -n "$version_config" ]; then
                            kernel_config_file="$version_config"
                            log "âœ… æ ¹æ®target.mkä¿¡æ¯æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file"
                            found_kernel=1
                            break
                        fi
                    fi
                done
            fi
        else
            log "â„¹ï¸ å­å¹³å°ç›®å½•ä¸å­˜åœ¨: $target_search_path/$SUBTARGET"
        fi
        
        # æ­¥éª¤2: å¦‚æœå­å¹³å°æ²¡æœ‰æ‰¾åˆ°ï¼Œåœ¨ä¸»å¹³å°ç›®å½•ä¸­é€’å½’æœç´¢
        if [ $found_kernel -eq 0 ]; then
            log "ğŸ“ æ­¥éª¤2: åœ¨ä¸»å¹³å°ç›®å½•ä¸­é€’å½’æœç´¢å†…æ ¸é…ç½®..."
            
            if [ -d "$target_search_path" ]; then
                # é€’å½’æœç´¢ä¸»å¹³å°ç›®å½•ä¸‹çš„æ‰€æœ‰configæ–‡ä»¶
                local target_configs=$(find "$target_search_path" -type f -name "$config_pattern" 2>/dev/null | sort)
                
                if [ -n "$target_configs" ]; then
                    log "âœ… åœ¨ä¸»å¹³å°ç›®å½•ä¸­æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶:"
                    echo "$target_configs" | while read config; do
                        log "   ğŸ“„ $config"
                    done
                    
                    # æŒ‰ä¼˜å…ˆçº§é€‰æ‹©å†…æ ¸ç‰ˆæœ¬
                    for ver in ${KERNEL_VERSION_PRIORITY:-6.6 6.1 5.15 5.10 5.4}; do
                        local matched_config=$(echo "$target_configs" | grep "config-$ver\$" | head -1)
                        if [ -n "$matched_config" ]; then
                            kernel_config_file="$matched_config"
                            kernel_version="$ver"
                            log "âœ… é€‰æ‹©å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
                            found_kernel=1
                            break
                        fi
                    done
                    
                    # å¦‚æœæ²¡æœ‰åŒ¹é…ä¼˜å…ˆçº§ï¼Œé€‰æ‹©æœ€æ–°çš„
                    if [ $found_kernel -eq 0 ]; then
                        kernel_config_file=$(echo "$target_configs" | head -1)
                        kernel_version=$(basename "$kernel_config_file" | sed 's/config-//')
                        log "âœ… é€‰æ‹©å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
                        found_kernel=1
                    fi
                fi
                
                # åœ¨ä¸»å¹³å°ç›®å½•ä¸­æŸ¥æ‰¾Makefileè·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
                if [ $found_kernel -eq 0 ]; then
                    log "ğŸ“„ åœ¨ä¸»å¹³å°ç›®å½•ä¸­æŸ¥æ‰¾Makefileæ–‡ä»¶..."
                    local makefile_files=$(find "$target_search_path" -maxdepth 2 -type f -name "Makefile" 2>/dev/null)
                    
                    for makefile in $makefile_files; do
                        log "ğŸ“„ æ‰¾åˆ°Makefileæ–‡ä»¶: $makefile"
                        
                        # ä»Makefileä¸­æå–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
                        local kernel_patchver=$(grep -E "^KERNEL_PATCHVER:=" "$makefile" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
                        local kernel_version_line=$(grep -E "^KERNEL_VERSION:=" "$makefile" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
                        
                        if [ -n "$kernel_patchver" ]; then
                            kernel_version="$kernel_patchver"
                            log "âœ… ä»Makefileè·å–åˆ°å†…æ ¸è¡¥ä¸ç‰ˆæœ¬: $kernel_version"
                        elif [ -n "$kernel_version_line" ]; then
                            kernel_version=$(echo "$kernel_version_line" | grep -oE '^[0-9]+\.[0-9]+')
                            log "âœ… ä»Makefileè·å–åˆ°å†…æ ¸ç‰ˆæœ¬: $kernel_version_line (ä¸»ç‰ˆæœ¬: $kernel_version)"
                        fi
                        
                        if [ -n "$kernel_version" ]; then
                            # æ ¹æ®è·å–åˆ°çš„å†…æ ¸ç‰ˆæœ¬ï¼Œåœ¨ä¸»å¹³å°ç›®å½•ä¸­æœç´¢å¯¹åº”çš„configæ–‡ä»¶
                            local version_config=$(find "$target_search_path" -type f -name "config-${kernel_version}*" 2>/dev/null | head -1)
                            if [ -n "$version_config" ]; then
                                kernel_config_file="$version_config"
                                log "âœ… æ ¹æ®Makefileä¿¡æ¯æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file"
                                found_kernel=1
                                break
                            fi
                        fi
                    done
                fi
            fi
        fi
        
        # æ­¥éª¤3: æœ€ç»ˆæ£€æŸ¥
        if [ $found_kernel -eq 0 ]; then
            log "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°ç›®æ ‡å¹³å° $TARGET çš„å†…æ ¸é…ç½®æ–‡ä»¶"
            
            # æ£€æŸ¥æ˜¯å¦é…ç½®ä¸ºå¿…é¡»æ‰¾åˆ°å†…æ ¸é…ç½®
            if [ "${REQUIRE_KERNEL_CONFIG:-false}" = "true" ]; then
                log "âŒ é”™è¯¯: æœªæ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶ï¼Œä¸” REQUIRE_KERNEL_CONFIG è®¾ç½®ä¸º true"
                handle_error "æœªæ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶"
            else
                log "â„¹ï¸ å°†ç»§ç»­æ„å»ºï¼Œä½†å¯èƒ½ç¼ºå°‘USBç›¸å…³å†…æ ¸é…ç½®"
            fi
        fi
    else
        # åŠ¨æ€æ£€æµ‹å·²ç¦ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ£€æµ‹
        log "â„¹ï¸ åŠ¨æ€å†…æ ¸æ£€æµ‹å·²ç¦ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ£€æµ‹..."
        
        for ver in ${KERNEL_VERSION_PRIORITY:-6.6 6.1 5.15 5.10 5.4}; do
            if [ -f "target/linux/$TARGET/config-$ver" ]; then
                kernel_config_file="target/linux/$TARGET/config-$ver"
                kernel_version="$ver"
                log "âœ… é€šè¿‡ä¼ ç»Ÿæ£€æµ‹æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
                found_kernel=1
                break
            fi
        done
    fi
    
    # å¦‚æœæ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶ï¼Œæå–USBç›¸å…³é…ç½®
    if [ -n "$kernel_config_file" ] && [ -f "$kernel_config_file" ]; then
        log "âœ… ä½¿ç”¨å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
        
        # å®šä¹‰å†…æ ¸æå–æ¨¡å¼ï¼ˆå¯ä»é…ç½®æ–‡ä»¶è·å–ï¼‰
        local kernel_patterns=(
            "^CONFIG_USB"
            "^CONFIG_PHY"
            "^CONFIG_DWC"
            "^CONFIG_XHCI"
            "^CONFIG_EXTCON"
            "^CONFIG_COMMON_CLK"
            "^CONFIG_ARCH"
        )
        
        # å¦‚æœé…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†KERNEL_EXTRACT_PATTERNSï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶çš„
        if [ ${#KERNEL_EXTRACT_PATTERNS[@]} -gt 0 ]; then
            kernel_patterns=("${KERNEL_EXTRACT_PATTERNS[@]}")
        fi
        
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å­˜å‚¨æå–çš„é…ç½®
        local usb_configs_file="/tmp/usb_configs_$$.txt"
        
        for pattern in "${kernel_patterns[@]}"; do
            grep -E "^${pattern}|^# ${pattern}" "$kernel_config_file" >> "$usb_configs_file" 2>/dev/null || true
        done
        
        # å»é‡å¹¶æ’åº
        sort -u "$usb_configs_file" > "$usb_configs_file.sorted"
        
        # æ˜¾ç¤ºæ‰¾åˆ°çš„é…ç½®
        local config_count=$(wc -l < "$usb_configs_file.sorted")
        log "æ‰¾åˆ° $config_count ä¸ªUSBç›¸å…³å†…æ ¸é…ç½®"
        
        log "æ‰€æœ‰USBç›¸å…³å†…æ ¸é…ç½®:"
        local line_num=0
        while read line; do
            line_num=$((line_num + 1))
            if echo "$line" | grep -q "=y$"; then
                log "   âœ… [$line_num] $line"
            elif echo "$line" | grep -q "=m$"; then
                log "   ğŸ“¦ [$line_num] $line"
            elif echo "$line" | grep -q "is not set"; then
                log "   âšª [$line_num] $line"
            else
                log "   ğŸ“„ [$line_num] $line"
            fi
        done < "$usb_configs_file.sorted"
        
        # å°†è¿™äº›é…ç½®æ·»åŠ åˆ°.configä¸­ï¼ˆä½†ä¸è¦è¦†ç›–å·²å¯ç”¨çš„é…ç½®ï¼‰
        local added_count=0
        while read line; do
            # æå–é…ç½®åï¼ˆå»æ‰å‰é¢çš„#å’Œç©ºæ ¼ï¼‰
            local config_name=$(echo "$line" | sed 's/^# //g' | cut -d'=' -f1 | cut -d' ' -f1)
            
            # æ£€æŸ¥é…ç½®æ˜¯å¦å·²å­˜åœ¨
            if ! grep -q "^${config_name}=" .config && ! grep -q "^# ${config_name} is not set" .config; then
                # å¦‚æœé…ç½®æ˜¯å¯ç”¨çš„ï¼ˆ=yï¼‰ï¼Œç›´æ¥æ·»åŠ 
                if echo "$line" | grep -q "=y$"; then
                    echo "$line" >> .config
                    added_count=$((added_count + 1))
                # å¦‚æœé…ç½®æ˜¯ç¦ç”¨çš„ï¼ˆis not setï¼‰ï¼Œä½œä¸ºæ³¨é‡Šæ·»åŠ 
                elif echo "$line" | grep -q "is not set"; then
                    echo "$line" >> .config
                    added_count=$((added_count + 1))
                fi
            fi
        done < "$usb_configs_file.sorted"
        
        log "âœ… æ·»åŠ äº† $added_count ä¸ªæ–°çš„å†…æ ¸é…ç½®"
        
        rm -f "$usb_configs_file" "$usb_configs_file.sorted"
    else
        log "âš ï¸ æœªæ‰¾åˆ°ç›®æ ‡å¹³å° $TARGET çš„å†…æ ¸é…ç½®æ–‡ä»¶"
    fi
    
    # æ­¥éª¤6: ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfigï¼ˆè¿™ä¼šé‡ç½®å†…æ ¸é…ç½®ï¼‰
    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfigï¼ˆåŠ è½½å¹³å°é»˜è®¤é…ç½®ï¼‰..."
    make defconfig > /tmp/build-logs/defconfig1.log 2>&1 || {
        log "âŒ ç¬¬ä¸€æ¬¡ make defconfig å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
        tail -50 /tmp/build-logs/defconfig1.log
        handle_error "ç¬¬ä¸€æ¬¡ä¾èµ–è§£å†³å¤±è´¥"
    }
    log "âœ… ç¬¬ä¸€æ¬¡ make defconfig æˆåŠŸ"
    
    # æ­¥éª¤7: åŠ¨æ€æ£€æµ‹å®é™…ç”Ÿæ•ˆçš„USBå†…æ ¸é…ç½®
    log "ğŸ” åŠ¨æ€æ£€æµ‹å®é™…ç”Ÿæ•ˆçš„USBå†…æ ¸é…ç½®..."
    
    # å®šä¹‰è¦æ£€æŸ¥çš„å…³é”®USBç»„ä»¶
    local usb_components=(
        "USB_SUPPORT"
        "USB_COMMON"
        "USB"
        "USB_XHCI_HCD"
        "USB_DWC3"
        "PHY"
    )
    
    for component in "${usb_components[@]}"; do
        local matches=$(grep -E "^CONFIG_${component}" .config | grep -E "=y|=m" | wc -l)
        if [ $matches -gt 0 ]; then
            log "âœ… $component ç›¸å…³é…ç½®: æ‰¾åˆ° $matches ä¸ª"
            # æ˜¾ç¤ºæ‰€æœ‰å…·ä½“é…ç½®
            grep -E "^CONFIG_${component}" .config | grep -E "=y|=m" | while read line; do
                log "    $line"
            done
        else
            log "â„¹ï¸ $component ç›¸å…³é…ç½®: æœªæ‰¾åˆ°"
        fi
    done
    
    # æ˜¾ç¤ºæ‰€æœ‰USBç›¸å…³å†…æ ¸é…ç½®
    log "ğŸ“‹ æ‰€æœ‰USBç›¸å…³å†…æ ¸é…ç½®ï¼ˆå·²ç”Ÿæ•ˆï¼‰:"
    local all_usb_kernel=$(grep -E "^CONFIG_USB_|^CONFIG_PHY_|^CONFIG_DWC|^CONFIG_XHCI|^CONFIG_EXTCON|^CONFIG_COMMON_CLK|^CONFIG_ARCH" .config | grep -E "=y|=m" | sort)
    if [ -n "$all_usb_kernel" ]; then
        local kernel_count=$(echo "$all_usb_kernel" | wc -l)
        log "å…± $kernel_count ä¸ªUSBç›¸å…³å†…æ ¸é…ç½®:"
        echo "$all_usb_kernel" | while read line; do
            log "  âœ… $line"
        done
    else
        log "  æœªæ‰¾åˆ°USBç›¸å…³å†…æ ¸é…ç½®"
    fi
    
    # æ­¥éª¤8: åŠ¨æ€æ·»åŠ USBè½¯ä»¶åŒ…ï¼ˆåŸºäºç›®æ ‡å¹³å°ï¼‰
    log "ğŸ“‹ åŠ¨æ€æ·»åŠ USBè½¯ä»¶åŒ…..."
    
    # ä»é…ç½®æ–‡ä»¶è·å–USBåŒ…åˆ—è¡¨
    # åŸºç¡€USBè½¯ä»¶åŒ…ï¼ˆæ‰€æœ‰å¹³å°éƒ½éœ€è¦ï¼‰
    local base_usb_packages=(
        "kmod-usb-core"
        "kmod-usb-common"
        "kmod-usb2"
        "kmod-usb3"
        "kmod-usb-storage"
        "kmod-scsi-core"
        "block-mount"
        "automount"
        "usbutils"
    )
    
    # æ‰©å±•USBåŒ…
    local extended_usb_packages=(
        "kmod-usb-storage-uas"
        "kmod-usb-storage-extras"
        "kmod-scsi-generic"
    )
    
    # æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
    local fs_support_packages=(
        "kmod-fs-ext4"
        "kmod-fs-vfat"
        "kmod-fs-exfat"
        "kmod-fs-ntfs3"
        "kmod-nls-utf8"
        "kmod-nls-cp936"
    )
    
    # å¦‚æœé…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†BASE_USB_PACKAGESï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶çš„
    if [ ${#BASE_USB_PACKAGES[@]} -gt 0 ]; then
        base_usb_packages=("${BASE_USB_PACKAGES[@]}")
    fi
    
    if [ ${#EXTENDED_USB_PACKAGES[@]} -gt 0 ]; then
        extended_usb_packages=("${EXTENDED_USB_PACKAGES[@]}")
    fi
    
    if [ ${#FS_SUPPORT_PACKAGES[@]} -gt 0 ]; then
        fs_support_packages=("${FS_SUPPORT_PACKAGES[@]}")
    fi
    
    # æ ¹æ®ç›®æ ‡å¹³å°æ·»åŠ ç‰¹å®šè½¯ä»¶åŒ…
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            log "æ£€æµ‹åˆ°é«˜é€šå¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local qcom_packages=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-qcom"
                "kmod-usb-dwc3-of-simple"
                "kmod-phy-qcom-ipq4019-usb"
                "kmod-usb-xhci-hcd"
                "kmod-usb-xhci-plat-hcd"
            )
            base_usb_packages+=("${qcom_packages[@]}")
            ;;
        mediatek|ramips)
            log "æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local mtk_packages=(
                "kmod-usb-xhci-mtk"
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-mediatek"
            )
            base_usb_packages+=("${mtk_packages[@]}")
            ;;
        ath79)
            log "æ£€æµ‹åˆ°ATH79å¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local ath79_packages=(
                "kmod-usb2-ath79"
                "kmod-usb-ohci"
            )
            base_usb_packages+=("${ath79_packages[@]}")
            ;;
    esac
    
    # å»é‡å¹¶æ·»åŠ USBè½¯ä»¶åŒ…
    local added_packages=0
    local existing_packages=0
    while read pkg; do
        [ -z "$pkg" ] && continue
        if ! grep -q "^CONFIG_PACKAGE_${pkg}=y" .config && ! grep -q "^CONFIG_PACKAGE_${pkg}=m" .config; then
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            added_packages=$((added_packages + 1))
            log "  âœ… æ·»åŠ è½¯ä»¶åŒ…: $pkg"
        else
            existing_packages=$((existing_packages + 1))
        fi
    done < <(printf "%s\n" "${base_usb_packages[@]}" "${extended_usb_packages[@]}" "${fs_support_packages[@]}" | sort -u)
    
    log "ğŸ“Š USBè½¯ä»¶åŒ…ç»Ÿè®¡: æ–°å¢ $added_packages ä¸ª, å·²å­˜åœ¨ $existing_packages ä¸ª"
    
    # æ­¥éª¤9: ç¬¬äºŒæ¬¡å»é‡
    log "ğŸ”„ ç¬¬äºŒæ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤10: ç¬¬äºŒæ¬¡è¿è¡Œ make defconfigï¼ˆåº”ç”¨å¼ºåˆ¶é…ç½®ï¼‰
    log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfigï¼ˆåº”ç”¨å¼ºåˆ¶é…ç½®ï¼‰..."
    make defconfig > /tmp/build-logs/defconfig2.log 2>&1 || {
        log "âš ï¸ ç¬¬äºŒæ¬¡ make defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­..."
    }
    log "âœ… ç¬¬äºŒæ¬¡ make defconfig å®Œæˆ"
    
    # æ­¥éª¤11: éªŒè¯å…³é”®USBé©±åŠ¨æ˜¯å¦è¢«æ­£ç¡®å¯ç”¨
    log "ğŸ” éªŒè¯å…³é”®USBé©±åŠ¨çŠ¶æ€..."
    
    local critical_usb_drivers=(
        "kmod-usb-core"
        "kmod-usb2"
        "kmod-usb-storage"
        "kmod-scsi-core"
    )
    
    # å¦‚æœé…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†CRITICAL_USB_DRIVERSï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶çš„
    if [ ${#CRITICAL_USB_DRIVERS[@]} -gt 0 ]; then
        critical_usb_drivers=("${CRITICAL_USB_DRIVERS[@]}")
    fi
    
    # æ ¹æ®å¹³å°æ·»åŠ å…³é”®é©±åŠ¨
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            critical_usb_drivers+=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-qcom"
            )
            ;;
        mediatek|ramips)
            critical_usb_drivers+=(
                "kmod-usb-xhci-mtk"
            )
            ;;
    esac
    
    local missing_drivers=()
    for driver in "${critical_usb_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "  âœ… $driver: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${driver}=m" .config; then
            log "  ğŸ“¦ $driver: æ¨¡å—åŒ–"
        else
            log "  âŒ $driver: æœªå¯ç”¨"
            missing_drivers+=("$driver")
        fi
    done
    
    # æ£€æŸ¥USB 3.0/xhciåŠŸèƒ½ï¼ˆå¤šç§å®ç°æ–¹å¼ï¼‰
    log "  ğŸ” USB 3.0/xhciåŠŸèƒ½æ£€æµ‹:"
    local usb3_found=0
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        log "    âœ… kmod-usb3: å·²å¯ç”¨"
        usb3_found=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        log "    âœ… kmod-usb-xhci-hcd: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" .config; then
        log "    âœ… kmod-usb-xhci-plat-hcd: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-qcom=y" .config; then
        log "    âœ… kmod-usb-xhci-qcom: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config; then
        log "    âœ… kmod-usb-xhci-mtk: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        log "    âœ… DWC3 + USB3: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_USB_XHCI_HCD=y" .config; then
        log "    âœ… å†…æ ¸xhciæ”¯æŒ: å·²å¯ç”¨"
        usb3_found=1
    fi
    
    if [ $usb3_found -eq 0 ]; then
        log "    âŒ USB 3.0åŠŸèƒ½æœªå¯ç”¨"
        missing_drivers+=("USB 3.0åŠŸèƒ½")
    fi
    
    if [ ${#missing_drivers[@]} -gt 0 ]; then
        log "âš ï¸ ç¼ºå¤±é©±åŠ¨: ${missing_drivers[*]}"
        
        # å¦‚æœå¯ç”¨äº†è‡ªåŠ¨ä¿®å¤ï¼Œå°è¯•æ·»åŠ ç¼ºå¤±é©±åŠ¨
        if [ "${AUTO_FIX_USB_DRIVERS:-true}" = "true" ]; then
            log "ğŸ”§ è‡ªåŠ¨ä¿®å¤ç¼ºå¤±é©±åŠ¨..."
            for driver in "${missing_drivers[@]}"; do
                if [[ "$driver" != "USB 3.0åŠŸèƒ½" ]]; then
                    echo "CONFIG_PACKAGE_${driver}=y" >> .config
                    log "  âœ… å·²æ·»åŠ : $driver"
                fi
            done
            # é‡æ–°è¿è¡Œdefconfig
            make defconfig > /dev/null 2>&1
            log "âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆ"
        fi
    else
        log "âœ… æ‰€æœ‰å…³é”®USBé©±åŠ¨éƒ½å·²å¯ç”¨"
    fi
    
    # æ­¥éª¤12: æ˜¾ç¤ºæ‰€æœ‰å·²å¯ç”¨çš„USBé©±åŠ¨
    log "ğŸ“‹ æ‰€æœ‰å·²å¯ç”¨çš„USBé©±åŠ¨:"
    local all_usb=$(grep "^CONFIG_PACKAGE_kmod-usb.*=y" .config | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    if [ -n "$all_usb" ]; then
        local usb_count=$(echo "$all_usb" | wc -l)
        log "å…± $usb_count ä¸ªUSBé©±åŠ¨:"
        echo "$all_usb" | while read driver; do
            log "  âœ… $driver"
        done
    else
        log "  æœªæ‰¾åˆ°USBé©±åŠ¨"
    fi
    
    # æ­¥éª¤13: æ˜¾ç¤ºæ‰€æœ‰USBç›¸å…³è½¯ä»¶åŒ…ï¼ˆåŒ…æ‹¬æ¨¡å—åŒ–çš„ï¼‰
    log "ğŸ“‹ æ‰€æœ‰USBç›¸å…³è½¯ä»¶åŒ…ï¼ˆåŒ…æ‹¬æ¨¡å—åŒ–ï¼‰:"
    local all_usb_packages=$(grep "^CONFIG_PACKAGE_kmod-usb" .config | grep -E "=y|=m" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    if [ -n "$all_usb_packages" ]; then
        local pkg_count=$(echo "$all_usb_packages" | wc -l)
        log "å…± $pkg_count ä¸ªUSBè½¯ä»¶åŒ…:"
        echo "$all_usb_packages" | while read pkg; do
            if grep -q "^CONFIG_PACKAGE_${pkg}=y" .config; then
                log "  âœ… $pkg"
            else
                log "  ğŸ“¦ $pkg"
            fi
        done
    else
        log "  æœªæ‰¾åˆ°USBè½¯ä»¶åŒ…"
    fi
    
    # æ­¥éª¤14: æœ€ç»ˆè®¾å¤‡éªŒè¯
    log "ğŸ” æ­£åœ¨éªŒè¯è®¾å¤‡ $openwrt_device æ˜¯å¦è¢«é€‰ä¸­..."
    
    if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
        log "âœ… ç›®æ ‡è®¾å¤‡å·²æ­£ç¡®å¯ç”¨: CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y"
    elif grep -q "^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} is not set" .config; then
        log "âš ï¸ è­¦å‘Š: è®¾å¤‡è¢«ç¦ç”¨ï¼Œå°è¯•å¼ºåˆ¶å¯ç”¨..."
        sed -i "/^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} is not set/d" .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1
        
        if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
            log "âœ… è®¾å¤‡å·²å¼ºåˆ¶å¯ç”¨"
        else
            log "âŒ æ— æ³•å¯ç”¨è®¾å¤‡"
        fi
    else
        log "âš ï¸ è­¦å‘Š: è®¾å¤‡é…ç½®è¡Œæœªæ‰¾åˆ°ï¼Œæ‰‹åŠ¨æ·»åŠ ..."
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1
    fi
    
    # æ­¥éª¤15: ä¿å­˜é…ç½®ç»Ÿè®¡ä¿¡æ¯
    local total_configs=$(wc -l < .config)
    local enabled_packages=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config)
    local module_packages=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config)
    local disabled_packages=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config)
    local enabled_kernel=$(grep -c "^CONFIG_[A-Z].*=y$" .config | grep -v "PACKAGE" | wc -l)
    
    log "ğŸ“Š é…ç½®ç»Ÿè®¡:"
    log "  æ€»é…ç½®è¡Œæ•°: $total_configs"
    log "  å¯ç”¨è½¯ä»¶åŒ…: $enabled_packages"
    log "  æ¨¡å—åŒ–è½¯ä»¶åŒ…: $module_packages"
    log "  ç¦ç”¨è½¯ä»¶åŒ…: $disabled_packages"
    log "  å¯ç”¨å†…æ ¸é…ç½®: $enabled_kernel"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘

#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆè°ƒç”¨åŠ¨æ€æŸ¥è¯¢æ¨¡å—ï¼‰ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡:"
        echo "   SELECTED_BRANCH=$SELECTED_BRANCH"
        echo "   TARGET=$TARGET"
        echo "   SUBTARGET=$SUBTARGET"
        echo "   DEVICE=$DEVICE"
        echo "   CONFIG_MODE=$CONFIG_MODE"
        echo "   COMPILER_DIR=$COMPILER_DIR"
    else
        echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ ($BUILD_DIR/build_env.sh)"
        exit 1
    fi
    
    cd $BUILD_DIR
    echo ""
    echo "=== ğŸš¨ å‰ç½®é”™è¯¯åŠ¨æ€æ£€æµ‹ ==="
    echo ""
    
    local error_count=0
    local warning_count=0
    
    # =========================================================================
    # è°ƒç”¨åŠ¨æ€æŸ¥è¯¢æ¨¡å—è·å–è®¾å¤‡æ”¯æŒä¿¡æ¯
    # =========================================================================
    echo "0. ğŸ” åŠ¨æ€è·å–è®¾å¤‡æ”¯æŒä¿¡æ¯:"
    echo "----------------------------------------"
    
    # è°ƒç”¨æ­¥éª¤15ä¸­çš„åŠ¨æ€æŸ¥è¯¢å‡½æ•°
    local device_support_info=$(get_device_support_summary "$TARGET" "$SUBTARGET" "$DEVICE" 2>/dev/null || echo "")
    
    if [ -n "$device_support_info" ]; then
        echo "$device_support_info"
    else
        echo "   âš ï¸ æ— æ³•è·å–è®¾å¤‡æ”¯æŒä¿¡æ¯"
        warning_count=$((warning_count + 1))
    fi
    
    echo "----------------------------------------"
    echo ""
    
    # 1. æ£€æŸ¥é…ç½®æ–‡ä»¶
    echo "1. âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    if [ -f ".config" ]; then
        local config_size=$(ls -lh .config | awk '{print $5}')
        local config_lines=$(wc -l < .config)
        echo "   âœ… .config æ–‡ä»¶å­˜åœ¨"
        echo "   ğŸ“Š å¤§å°: $config_size, è¡Œæ•°: $config_lines"
        
        # æ£€æŸ¥è®¾å¤‡é…ç½®
        local device_upper=$(echo "$DEVICE" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
        if grep -q "CONFIG_TARGET_.*DEVICE.*${device_upper}=y" .config; then
            echo "   âœ… è®¾å¤‡é…ç½®æ­£ç¡®"
        else
            # å°è¯•å°å†™åŒ¹é…
            local device_lower=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
            if grep -q "CONFIG_TARGET_.*DEVICE.*${device_lower}=y" .config; then
                echo "   âœ… è®¾å¤‡é…ç½®æ­£ç¡® (å°å†™)"
            else
                echo "   âŒ è®¾å¤‡é…ç½®å¯èƒ½ä¸æ­£ç¡®"
                error_count=$((error_count + 1))
            fi
        fi
    else
        echo "   âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 2. æ£€æŸ¥SDK/ç¼–è¯‘å™¨
    echo "2. âœ… SDK/ç¼–è¯‘å™¨æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "   âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
        local sdk_size=$(du -sh "$COMPILER_DIR" 2>/dev/null | awk '{print $1}')
        echo "   ğŸ“Š å¤§å°: $sdk_size"
        
        # æŸ¥æ‰¾çœŸæ­£çš„GCC
        local gcc_file=$(find "$COMPILER_DIR" -type f -executable -name "*gcc" ! -name "*gcc-ar" ! -name "*gcc-ranlib" ! -name "*gcc-nm" ! -path "*dummy-tools*" 2>/dev/null | head -1)
        if [ -n "$gcc_file" ]; then
            echo "   âœ… æ‰¾åˆ°GCC: $(basename "$gcc_file")"
            local gcc_version=$("$gcc_file" --version 2>&1 | head -1)
            echo "   ğŸ”§ ç‰ˆæœ¬: $gcc_version"
        else
            echo "   âŒ æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨"
            error_count=$((error_count + 1))
        fi
    else
        echo "   âŒ SDKç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 3. æ£€æŸ¥Feeds
    echo "3. âœ… Feedsæ£€æŸ¥:"
    if [ -d "feeds" ]; then
        local feeds_count=$(find feeds -maxdepth 1 -type d 2>/dev/null | wc -l)
        feeds_count=$((feeds_count - 1))  # å‡å»feedsç›®å½•æœ¬èº«
        echo "   âœ… feedsç›®å½•å­˜åœ¨, åŒ…å« $feeds_count ä¸ªfeed"
        
        # æ£€æŸ¥å…³é”®feed
        for feed in packages luci; do
            if [ -d "feeds/$feed" ]; then
                echo "   âœ… $feed feed: å­˜åœ¨"
            else
                echo "   âŒ $feed feed: ä¸å­˜åœ¨"
                warning_count=$((warning_count + 1))
            fi
        done
    else
        echo "   âŒ feedsç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
    echo "4. âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    local available_space=$(df /mnt --output=avail 2>/dev/null | tail -1 || df / --output=avail | tail -1)
    local available_gb=$((available_space / 1024 / 1024))
    echo "   ğŸ“Š å¯ç”¨ç©ºé—´: ${available_gb}G"
    
    if [ $available_gb -lt 5 ]; then
        echo "   âŒ ç©ºé—´ä¸¥é‡ä¸è¶³ (<5G)"
        error_count=$((error_count + 1))
    elif [ $available_gb -lt 10 ]; then
        echo "   âš ï¸ ç©ºé—´è¾ƒä½ (<10G)"
        warning_count=$((warning_count + 1))
    elif [ $available_gb -lt 20 ]; then
        echo "   âš ï¸ ç©ºé—´ä¸€èˆ¬ (<20G)"
        warning_count=$((warning_count + 1))
    else
        echo "   âœ… ç©ºé—´å……è¶³"
    fi
    echo ""
    
    # 5. æ£€æŸ¥å…³é”®USBé©±åŠ¨
    echo "5. âœ… USBé©±åŠ¨æ£€æŸ¥:"
    local critical_drivers=(
        "kmod-usb-core"
    )
    
    # æ ¹æ®å¹³å°æ·»åŠ å…³é”®é©±åŠ¨
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            critical_drivers+=("kmod-usb-dwc3" "kmod-usb-dwc3-qcom")
            ;;
        mediatek|ramips)
            critical_drivers+=("kmod-usb-xhci-mtk")
            ;;
    esac
    
    local missing_usb=0
    for driver in "${critical_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "   âœ… $driver: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${driver}=m" .config; then
            echo "   ğŸ“¦ $driver: æ¨¡å—åŒ–"
        else
            echo "   âŒ $driver: æœªå¯ç”¨"
            missing_usb=$((missing_usb + 1))
        fi
    done
    
    if [ $missing_usb -gt 0 ]; then
        echo "   âš ï¸ æœ‰ $missing_usb ä¸ªå…³é”®USBé©±åŠ¨ç¼ºå¤±"
        warning_count=$((warning_count + 1))
    fi
    echo ""
    
    # 6. æ£€æŸ¥å†…å­˜
    echo "6. âœ… å†…å­˜æ£€æŸ¥:"
    local mem_total=$(free -m | awk '/^Mem:/{print $2}')
    local mem_available=$(free -m | awk '/^Mem:/{print $7}')
    echo "   ğŸ“Š æ€»å†…å­˜: ${mem_total}MB, å¯ç”¨: ${mem_available}MB"
    
    if [ $mem_available -lt 512 ]; then
        echo "   âš ï¸ å¯ç”¨å†…å­˜ä¸è¶³ (<512MB)"
        warning_count=$((warning_count + 1))
    else
        echo "   âœ… å†…å­˜å……è¶³"
    fi
    echo ""
    
    # 7. æ£€æŸ¥CPU
    echo "7. âœ… CPUæ£€æŸ¥:"
    local cpu_cores=$(nproc)
    local cpu_model=$(grep "model name" /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs)
    echo "   ğŸ“Š æ ¸å¿ƒæ•°: $cpu_cores"
    echo "   ğŸ“Š å‹å·: $cpu_model"
    echo ""
    
    # 8. æ£€æŸ¥åˆ†æ”¯å…¼å®¹æ€§
    echo "8. âœ… åˆ†æ”¯å…¼å®¹æ€§æ£€æŸ¥:"
    local supported_branches=$(get_supported_branches 2>/dev/null || echo "")
    if [ -n "$supported_branches" ]; then
        if echo "$supported_branches" | grep -q "^$SELECTED_BRANCH$"; then
            echo "   âœ… å½“å‰åˆ†æ”¯ $SELECTED_BRANCH åœ¨æ”¯æŒåˆ—è¡¨ä¸­"
        else
            echo "   âš ï¸ å½“å‰åˆ†æ”¯ $SELECTED_BRANCH ä¸åœ¨æ”¯æŒåˆ—è¡¨ä¸­"
            warning_count=$((warning_count + 1))
        fi
    fi
    echo ""
    
    # 9. æ£€æŸ¥å†…æ ¸é…ç½®æ–‡ä»¶
    echo "9. âœ… å†…æ ¸é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    local kernel_configs=$(find "target/linux/$TARGET" -type f -name "config-*" 2>/dev/null | wc -l)
    if [ $kernel_configs -gt 0 ]; then
        echo "   âœ… æ‰¾åˆ° $kernel_configs ä¸ªå†…æ ¸é…ç½®æ–‡ä»¶"
    else
        echo "   âš ï¸ æœªæ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶"
        warning_count=$((warning_count + 1))
    fi
    echo ""
    
    # æ±‡æ€»
    echo "========================================"
    if [ $error_count -gt 0 ]; then
        echo "âŒâŒâŒ æ£€æµ‹åˆ° $error_count ä¸ªé”™è¯¯ï¼Œè¯·ä¿®å¤åé‡è¯• âŒâŒâŒ"
        exit 1
    elif [ $warning_count -gt 0 ]; then
        echo "âš ï¸âš ï¸âš ï¸ æ£€æµ‹åˆ° $warning_count ä¸ªè­¦å‘Šï¼Œä½†å¯ä»¥ç»§ç»­ âš ï¸âš ï¸âš ï¸"
    else
        echo "âœ…âœ…âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    fi
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}

# ============================================================================
# è®¾å¤‡æ”¯æŒä¿¡æ¯æ‘˜è¦å‡½æ•°ï¼ˆåœ¨æ­¥éª¤15ä¸­ä½¿ç”¨ï¼‰
# ============================================================================
get_device_support_summary() {
    local platform="$1"
    local subtarget="$2"
    local device="$3"
    
    local summary=""
    
    # è·å–æ”¯æŒçš„åˆ†æ”¯
    local branches=$(get_supported_branches 2>/dev/null | head -3 | tr '\n' ' ' || echo "æœªçŸ¥")
    summary="$summary   ğŸ“¦ æ”¯æŒçš„åˆ†æ”¯: $branches\n"
    
    # è·å–å­å¹³å°ä¿¡æ¯
    local subtargets=$(get_subtargets_by_platform "$SELECTED_BRANCH" "$platform" 2>/dev/null | head -5 | tr '\n' ' ' || echo "æœªçŸ¥")
    summary="$summary   ğŸ“ å¹³å° $platform æ”¯æŒçš„å­å¹³å°: $subtargets\n"
    
    # è·å–è®¾å¤‡åŒ¹é…ä¿¡æ¯
    local match_level="none"
    local match_info=""
    
    # æ£€æŸ¥ç²¾ç¡®åŒ¹é…
    local exact_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "exact" 2>/dev/null)
    if echo "$exact_devices" | grep -q "^$device$"; then
        match_level="exact"
        match_info="âœ… ç²¾ç¡®åŒ¹é… (å­å¹³å° $subtarget ä¸“ç”¨)"
    fi
    
    # æ£€æŸ¥ç³»åˆ—åŒ¹é…
    if [ "$match_level" = "none" ]; then
        local series_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "series" 2>/dev/null)
        if echo "$series_devices" | grep -q "^$device$"; then
            match_level="series"
            match_info="ğŸ”„ ç³»åˆ—åŒ¹é… (é€‚ç”¨äº $subtarget ç³»åˆ—)"
        fi
    fi
    
    # æ£€æŸ¥é€šé…åŒ¹é…
    if [ "$match_level" = "none" ]; then
        local wildcard_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "wildcard" 2>/dev/null)
        if echo "$wildcard_devices" | grep -q "^$device$"; then
            match_level="wildcard"
            match_info="ğŸ”— é€šé…åŒ¹é… (é€šè¿‡é€šé…è§„åˆ™)"
        fi
    fi
    
    if [ "$match_level" != "none" ]; then
        summary="$summary   ğŸ“± è®¾å¤‡åŒ¹é…çŠ¶æ€: $match_info\n"
    else
        summary="$summary   âš ï¸ è®¾å¤‡ $device æœªåœ¨åŒ¹é…åˆ—è¡¨ä¸­æ‰¾åˆ°\n"
    fi
    
    # è·å–è®¾å¤‡æ•°é‡ç»Ÿè®¡
    local exact_count=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "exact" 2>/dev/null | wc -l)
    local series_count=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "series" 2>/dev/null | wc -l)
    local wildcard_count=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "wildcard" 2>/dev/null | wc -l)
    
    summary="$summary   ğŸ“Š åŒ¹é…ç»Ÿè®¡: ç²¾ç¡®=$exact_count, ç³»åˆ—=$series_count, é€šé…=$wildcard_count\n"
    
    echo -e "$summary"
}

# è·å–æ‰€æœ‰æ”¯æŒçš„åˆ†æ”¯åˆ—è¡¨
get_supported_branches() {
    local branches=()
    
    # ä»é…ç½®æ–‡ä»¶ä¸­è·å–åˆ†æ”¯ä¿¡æ¯ï¼ˆä¿®å¤è¯­æ³•é”™è¯¯ï¼‰
    if [ -f "$REPO_ROOT/build-config.conf" ]; then
        while IFS= read -r line; do
            # ä¿®å¤æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•
            if [[ "$line" =~ ^[[:space:]]*:?[[:space:]]*\$\{BRANCH_[^=]+:=([^}]+)\} ]]; then
                local branch_name="${BASH_REMATCH[1]}"
                branches+=("$branch_name")
            elif [[ "$line" =~ ^[[:space:]]*export[[:space:]]+BRANCH_[^=]+=[\"]?([^\"]+)[\"]? ]]; then
                local branch_name="${BASH_REMATCH[1]}"
                branches+=("$branch_name")
            fi
        done < "$REPO_ROOT/build-config.conf"
    fi
    
    # å¦‚æœé…ç½®æ–‡ä»¶æ²¡æœ‰ï¼Œä»gitè¿œç¨‹ä»“åº“è·å–
    if [ ${#branches[@]} -eq 0 ]; then
        if command -v git >/dev/null 2>&1; then
            local remote_branches=$(git ls-remote --heads "${IMMORTALWRT_URL:-https://github.com/immortalwrt/immortalwrt.git}" 2>/dev/null | \
                awk -F'/' '{print $NF}' | grep -E "^(openwrt-[0-9]+\.[0-9]+|main|master)$" | sort -r | head -5)
            
            if [ -n "$remote_branches" ]; then
                while IFS= read -r branch; do
                    branches+=("$branch")
                done <<< "$remote_branches"
            fi
        fi
    fi
    
    # å»é‡å¹¶è¿”å›
    printf '%s\n' "${branches[@]}" | sort -u 2>/dev/null || echo "openwrt-23.05 openwrt-21.02"
}

# è·å–æŒ‡å®šå¹³å°ä¸‹çš„æ‰€æœ‰å­å¹³å°
get_subtargets_by_platform() {
    local branch="$1"
    local platform="$2"
    
    local subtargets=()
    local platform_path="target/linux/$platform"
    
    if [ -d "$platform_path" ]; then
        # æŸ¥æ‰¾å­å¹³å°ç›®å½•
        while IFS= read -r subtarget_dir; do
            local subtarget=$(basename "$subtarget_dir")
            if [ -d "$subtarget_dir" ] && [[ ! "$subtarget" =~ ^(image|base-files|config|patches|files|Makefile)$ ]]; then
                if [ -f "$subtarget_dir/target.mk" ] || [ -f "$subtarget_dir/Makefile" ]; then
                    subtargets+=("$subtarget")
                fi
            fi
        done < <(find "$platform_path" -maxdepth 1 -type d ! -path "$platform_path" 2>/dev/null | sort)
        
        # å¦‚æœæ²¡æœ‰å­å¹³å°ç›®å½•ï¼Œæ£€æŸ¥Makefile
        if [ ${#subtargets[@]} -eq 0 ] && [ -f "$platform_path/Makefile" ]; then
            local default_subtarget=$(grep -E "^[[:space:]]*SUBTARGETS?[[:space:]]*:?=" "$platform_path/Makefile" 2>/dev/null | \
                sed 's/.*=[[:space:]]*//' | tr -d ' ' | tr ',' ' ')
            
            if [ -n "$default_subtarget" ]; then
                for st in $default_subtarget; do
                    subtargets+=("$st")
                done
            else
                subtargets+=("generic")
            fi
        fi
    fi
    
    printf '%s\n' "${subtargets[@]}" | sort -u 2>/dev/null | head -10 || echo "generic"
}

# æå–å­å¹³å°çš„æ•°å­—ç³»åˆ—
extract_series_number() {
    local subtarget="$1"
    local numbers=$(echo "$subtarget" | grep -oE '[0-9]+' | head -1)
    if [ -n "$numbers" ] && [ ${#numbers} -ge 3 ]; then
        echo "${numbers:0:3}"
    else
        echo ""
    fi
}

# æ£€æŸ¥å­å¹³å°æ˜¯å¦åŒ¹é…ç³»åˆ—æ¨¡å¼
match_series_pattern() {
    local target_subtarget="$1"
    local candidate_subtarget="$2"
    
    # ç²¾ç¡®åŒ¹é…
    if [ "$target_subtarget" = "$candidate_subtarget" ]; then
        return 0
    fi
    
    # æå–æ•°å­—ç³»åˆ—
    local target_series=$(extract_series_number "$target_subtarget")
    local candidate_series=$(extract_series_number "$candidate_subtarget")
    
    # å¦‚æœéƒ½æœ‰æ•°å­—ç³»åˆ—ä¸”ç›¸åŒ
    if [ -n "$target_series" ] && [ -n "$candidate_series" ] && [ "$target_series" = "$candidate_series" ]; then
        return 0
    fi
    
    # æ£€æŸ¥é€šé…ç¬¦æ¨¡å¼
    if [[ "$candidate_subtarget" == *"*"* ]]; then
        local pattern=$(echo "$candidate_subtarget" | sed 's/\*/.*/g')
        if [[ "$target_subtarget" =~ $pattern ]]; then
            return 0
        fi
    fi
    
    # æ£€æŸ¥é€šç”¨ç³»åˆ—
    case "$candidate_subtarget" in
        filogic)
            if [[ "$target_subtarget" =~ ^(filogic|mt7981|mt7986|mt7988|mt798x)$ ]]; then
                return 0
            fi
            ;;
        mt798x)
            if [[ "$target_subtarget" =~ ^(mt7981|mt7986|mt7988|mt798x)$ ]]; then
                return 0
            fi
            ;;
        ipq40xx)
            if [[ "$target_subtarget" =~ ^(ipq40xx|ipq4018|ipq4019|ipq4028|ipq4029)$ ]]; then
                return 0
            fi
            ;;
        ipq807x)
            if [[ "$target_subtarget" =~ ^(ipq807x|ipq8071|ipq8072|ipq8074)$ ]]; then
                return 0
            fi
            ;;
    esac
    
    return 1
}

# è·å–æŒ‡å®šå¹³å°/å­å¹³å°ä¸‹çš„æ‰€æœ‰è®¾å¤‡
get_devices_by_subtarget() {
    local branch="$1"
    local platform="$2"
    local subtarget="$3"
    local match_type="${4:-all}"
    
    local devices=()
    local exact_devices=()
    local series_devices=()
    local wildcard_devices=()
    
    # å®šä¹‰è¦æœç´¢çš„è·¯å¾„
    local search_paths=()
    
    # 1. ç²¾ç¡®åŒ¹é…è·¯å¾„
    if [ -d "target/linux/$platform/$subtarget" ]; then
        search_paths+=("target/linux/$platform/$subtarget:exact")
    fi
    
    # 2. ç³»åˆ—åŒ¹é…è·¯å¾„
    local target_series=$(extract_series_number "$subtarget")
    if [ -n "$target_series" ]; then
        while IFS= read -r candidate_dir; do
            local candidate=$(basename "$candidate_dir")
            local candidate_series=$(extract_series_number "$candidate")
            
            if [ -n "$candidate_series" ] && [ "$candidate_series" = "$target_series" ] && \
               [ "$candidate" != "$subtarget" ] && [ -d "$candidate_dir" ]; then
                search_paths+=("$candidate_dir:series")
            fi
        done < <(find "target/linux/$platform" -maxdepth 1 -type d ! -path "target/linux/$platform" 2>/dev/null)
    fi
    
    # 3. é€šé…åŒ¹é…è·¯å¾„
    while IFS= read -r candidate_dir; do
        local candidate=$(basename "$candidate_dir")
        if [[ "$candidate" == *"*"* ]] && [ -d "$candidate_dir" ]; then
            if match_series_pattern "$subtarget" "$candidate"; then
                search_paths+=("$candidate_dir:wildcard")
            fi
        fi
    done < <(find "target/linux/$platform" -maxdepth 1 -type d ! -path "target/linux/$platform" 2>/dev/null)
    
    # å»é‡æœç´¢è·¯å¾„
    local seen_paths=()
    for path_entry in "${search_paths[@]}"; do
        local path="${path_entry%%:*}"
        if [[ ! " ${seen_paths[@]} " =~ " ${path} " ]]; then
            seen_paths+=("$path")
            
            local path_type="${path_entry##*:}"
            
            # æ ¹æ®åŒ¹é…ç±»å‹è¿‡æ»¤
            if [ "$match_type" != "all" ]; then
                case "$match_type" in
                    exact)   [ "$path_type" != "exact" ] && continue ;;
                    series)  [ "$path_type" != "series" ] && continue ;;
                    wildcard)[ "$path_type" != "wildcard" ] && continue ;;
                esac
            fi
            
            # æŸ¥æ‰¾è®¾å¤‡å®šä¹‰
            while IFS= read -r mk_file; do
                if [ -f "$mk_file" ] && grep -q "^define Device/" "$mk_file" 2>/dev/null; then
                    local file_devices=$(grep "^define Device/" "$mk_file" 2>/dev/null | \
                        sed 's/^define Device\///' | cut -d' ' -f1 | sort -u)
                    
                    if [ -n "$file_devices" ]; then
                        while IFS= read -r device; do
                            case "$path_type" in
                                exact)    exact_devices+=("$device") ;;
                                series)   series_devices+=("$device") ;;
                                wildcard) wildcard_devices+=("$device") ;;
                            esac
                        done <<< "$file_devices"
                    fi
                fi
            done < <(find "$path" -maxdepth 2 -type f -name "*.mk" -o -name "Makefile" 2>/dev/null | sort -u)
        fi
    done
    
    # æ ¹æ®è¯·æ±‚çš„åŒ¹é…ç±»å‹è¿”å›ç»“æœ
    case "$match_type" in
        exact)
            printf '%s\n' "${exact_devices[@]}" | sort -u
            ;;
        series)
            printf '%s\n' "${series_devices[@]}" | sort -u
            ;;
        wildcard)
            printf '%s\n' "${wildcard_devices[@]}" | sort -u
            ;;
        all)
            {
                printf '%s\n' "${exact_devices[@]}"
                printf '%s\n' "${series_devices[@]}"
                printf '%s\n' "${wildcard_devices[@]}"
            } | sort -u
            ;;
    esac
}
#ã€build_firmware_main.sh-37-endã€‘
