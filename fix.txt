#ã€firmware-build.yml-18ã€‘
      - name: "18. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€"
        run: |
          echo "=== æ­¥éª¤18: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€ ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤18 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          echo "ğŸ”§ æ­¥éª¤18.1: è¿è¡Œ make defconfig..."
          make defconfig || {
            echo "âŒ make defconfig å¤±è´¥"
            exit 1
          }
          
          echo ""
          echo "ğŸ”§ æ­¥éª¤18.2: äºŒæ¬¡å¼ºåˆ¶å†™å…¥è¢«defconfigé‡ç½®çš„å…³é”®é©±åŠ¨..."
          
          # æ£€æµ‹ç›®æ ‡å¹³å°
          TARGET=$(grep "^CONFIG_TARGET_" .config | head -1 | cut -d'=' -f1 | sed 's/^CONFIG_TARGET_//' | sed 's/=y$//' 2>/dev/null || echo "")
          echo "ğŸ“‹ æ£€æµ‹åˆ°ç›®æ ‡å¹³å°: ${TARGET:-æœªçŸ¥}"
          
          # å¼ºåˆ¶å†™å…¥USB 3.0é©±åŠ¨
          if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
            echo "âš ï¸ æ£€æµ‹åˆ° kmod-usb-xhci-hcd è¢«é‡ç½®ï¼Œå¼ºåˆ¶å†™å…¥..."
            if [ -f "scripts/config/config" ]; then
              ./scripts/config/config --enable PACKAGE_kmod-usb-xhci-hcd
            else
              echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
            fi
            echo "âœ… å·²å¼ºåˆ¶å¯ç”¨: kmod-usb-xhci-hcd"
          fi
          
          # IPQ40xxå¹³å°ä¸“ç”¨é©±åŠ¨
          if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
            if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
              echo "âš ï¸ æ£€æµ‹åˆ° kmod-phy-qcom-dwc3 è¢«é‡ç½®ï¼Œå¼ºåˆ¶å†™å…¥..."
              if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_kmod-phy-qcom-dwc3
              else
                echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
              fi
              echo "âœ… å·²å¼ºåˆ¶å¯ç”¨: kmod-phy-qcom-dwc3"
            fi
          fi
          
          echo ""
          echo "ğŸ”§ æ­¥éª¤18.3: å†æ¬¡è¿è¡Œ make defconfig åŒæ­¥..."
          make defconfig
          
          echo ""
          echo "=========================================="
          echo "ğŸ“‹ åº”ç”¨é…ç½®åæœ€ç»ˆçŠ¶æ€ï¼ˆè¯¦ç»†æ£€æŸ¥ï¼‰:"
          echo "=========================================="
          
          echo "1ï¸âƒ£ USBæ ¸å¿ƒé©±åŠ¨:"
          echo "  - kmod-usb-core:       $(grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-usb2:           $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-usb3:           $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo ""
          
          echo "2ï¸âƒ£ USB 3.0æ§åˆ¶å™¨:"
          echo "  - kmod-usb-xhci-hcd:   $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-usb-xhci-pci:   $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-pci=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo ""
          
          echo "3ï¸âƒ£ USBå­˜å‚¨é©±åŠ¨:"
          echo "  - kmod-usb-storage:    $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-scsi-core:      $(grep -q "^CONFIG_PACKAGE_kmod-scsi-core=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo ""
          
          echo "4ï¸âƒ£ IPQ40xxå¹³å°ä¸“ç”¨é©±åŠ¨:"
          if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
            echo "  - kmod-usb-dwc3:       $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-usb-dwc3-qcom:  $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-phy-qcom-dwc3:  $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          else
            echo "  - éIPQ40xxå¹³å°ï¼Œè·³è¿‡æ£€æŸ¥"
          fi
          echo ""
          
          echo "5ï¸âƒ£ TurboACCé…ç½®:"
          if grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config 2>/dev/null; then
            echo "  - luci-app-turboacc:   âœ… å·²å¯ç”¨"
          else
            echo "  - luci-app-turboacc:   âŒ æœªå¯ç”¨"
          fi
          echo ""
          
          echo "6ï¸âƒ£ TCP BBRæ‹¥å¡æ§åˆ¶:"
          echo "  - kmod-tcp-bbr:        $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - DEFAULT_TCP_CONG:    $(grep "^CONFIG_DEFAULT_TCP_CONG=" .config | cut -d'"' -f2 || echo 'æœªè®¾ç½®')"
          echo ""
          
          echo "7ï¸âƒ£ é…ç½®æ–‡ä»¶ç»Ÿè®¡:"
          echo "  - æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
          echo "  - é…ç½®è¡Œæ•°: $(wc -l < .config)"
          echo ""
          
          # æœ€ç»ˆéªŒè¯ç»“æœ
          XHCI_STATUS=$(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
          PHY_STATUS=$(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
          
          echo "8ï¸âƒ£ æœ€ç»ˆéªŒè¯ç»“æœ:"
          echo "  - kmod-usb-xhci-hcd:   $XHCI_STATUS"
          echo "  - kmod-phy-qcom-dwc3:  $PHY_STATUS"
          echo ""
          
          if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
            echo "âœ…âœ…âœ… å…³é”®é©±åŠ¨ kmod-usb-xhci-hcd å·²æˆåŠŸé”å®š"
          else
            echo "âŒâŒâŒ è‡´å‘½é”™è¯¯: kmod-usb-xhci-hcd ä»æœªå¯ç”¨"
            exit 1
          fi
          
          if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
            if grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
              echo "âœ…âœ…âœ… IPQ40xxå¹³å°é©±åŠ¨ kmod-phy-qcom-dwc3 å·²æˆåŠŸé”å®š"
            else
              echo "âŒâŒâŒ è‡´å‘½é”™è¯¯: kmod-phy-qcom-dwc3 ä»æœªå¯ç”¨"
              exit 1
            fi
          fi
          
          echo "=========================================="
          echo "âœ… æ­¥éª¤18 é…ç½®åº”ç”¨å®Œæˆ"
#ã€firmware-build.yml-18-endã€‘

#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆç»ˆæé”æ­»ç‰ˆV5-ç›´æ¥ä¿®æ”¹Kconfigï¼‰==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    local CONFIG_CMD="./scripts/config/config"
    log "âœ… ä½¿ç”¨ç®€æ˜“configå·¥å…·"
    
    log "ğŸ”§ ä½¿ç”¨é…ç½®å·¥å…·åˆå¹¶é…ç½®..."
    
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "ğŸ“ åº”ç”¨USBé€šç”¨é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/usb-generic.config"
        log "âœ… USBé€šç”¨é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "ğŸ“ åº”ç”¨åŸºç¡€é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/base.config"
        log "âœ… åŸºç¡€é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "ğŸ“ åº”ç”¨è®¾å¤‡é…ç½®: $DEVICE.config..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$device_config_file"
        log "âœ… è®¾å¤‡é…ç½®åº”ç”¨å®Œæˆ"
    elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "ğŸ“ åº”ç”¨æ­£å¸¸æ¨¡å¼é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/normal.config"
        log "âœ… æ­£å¸¸æ¨¡å¼é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "ğŸ“ åº”ç”¨å¹³å°é…ç½®: $(basename "$platform_config")..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$platform_config"
        log "âœ… å¹³å°é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            if [ -n "$pkg" ]; then
                $CONFIG_CMD --enable "PACKAGE_$pkg"
                log "âœ… æ·»åŠ åŒ…: $pkg"
            fi
        done
    fi
    
    log "ğŸ”§ ç¬¬ä¸€æ¬¡å¼ºåˆ¶å¯ç”¨æ‰€æœ‰å…³é”®é…ç½®..."
    
    $CONFIG_CMD --enable PACKAGE_kmod-usb-core
    $CONFIG_CMD --enable PACKAGE_kmod-usb2
    $CONFIG_CMD --enable PACKAGE_kmod-usb3
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-hcd
    $CONFIG_CMD --enable PACKAGE_kmod-usb-storage
    $CONFIG_CMD --enable PACKAGE_kmod-scsi-core
    
    if [ "$TARGET" = "ipq40xx" ]; then
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3-qcom
        $CONFIG_CMD --enable PACKAGE_kmod-phy-qcom-dwc3
        log "âœ… IPQ40xxå¹³å°ä¸“ç”¨é©±åŠ¨å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    fi
    
    $CONFIG_CMD --enable PACKAGE_kmod-tcp-bbr
    $CONFIG_CMD --set-str DEFAULT_TCP_CONG "bbr"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        $CONFIG_CMD --enable PACKAGE_luci-app-turboacc
        $CONFIG_CMD --enable PACKAGE_kmod-shortcut-fe
        $CONFIG_CMD --enable PACKAGE_kmod-fast-classifier
        log "âœ… TurboACCé…ç½®å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    fi
    
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-pci
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-smallbuffers
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-ct-smallbuffers
    $CONFIG_CMD --enable PACKAGE_kmod-ath10k-ct
    log "âœ… ath10kå†²çªä¿®å¤å®Œæˆ"
    
    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfig..."
    make defconfig || handle_error "æœ€ç»ˆé…ç½®åº”ç”¨å¤±è´¥"
    
    log "ğŸ”§ ç¬¬äºŒæ¬¡å¼ºåˆ¶å†™å…¥è¢«defconfigé‡ç½®çš„å…³é”®é©±åŠ¨..."
    
    force_drivers_phase1=(
        "PACKAGE_kmod-usb-xhci-hcd"
    )
    
    if [ "$TARGET" = "ipq40xx" ]; then
        force_drivers_phase1+=("PACKAGE_kmod-phy-qcom-dwc3")
    fi
    
    fixed_count=0
    for driver in "${force_drivers_phase1[@]}"; do
        if ! grep -q "^CONFIG_${driver}=y" .config; then
            log "âš ï¸ æ£€æµ‹åˆ° $driver è¢«defconfigé‡ç½®ï¼ŒäºŒæ¬¡å¼ºåˆ¶å†™å…¥..."
            $CONFIG_CMD --enable "$driver"
            fixed_count=$((fixed_count + 1))
        fi
    done
    
    if [ $fixed_count -gt 0 ]; then
        log "âœ… å·²ä¿®å¤ $fixed_count ä¸ªè¢«é‡ç½®çš„é©±åŠ¨"
        log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfig..."
        make defconfig || handle_error "äºŒæ¬¡é…ç½®åŒæ­¥å¤±è´¥"
        
        log "ğŸ”§ ç¬¬ä¸‰æ¬¡å¼ºåˆ¶å†™å…¥ï¼ˆç»ˆæé”æ­»-ç›´æ¥ä¿®æ”¹Kconfigä¾èµ–ï¼‰..."
        
        # å…ˆæ£€æŸ¥å“ªäº›é©±åŠ¨ä»ç„¶ç¼ºå¤±
        missing_xhci=0
        missing_phy=0
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
            missing_xhci=1
            log "âš ï¸ PACKAGE_kmod-usb-xhci-hcd ä»ç„¶è¢«é‡ç½®ï¼Œç›´æ¥å†™å…¥.configæ–‡ä»¶å¹¶æ·»åŠ ä¾èµ–..."
            
            # åˆ é™¤å¯èƒ½å†²çªçš„è¡Œ
            sed -i '/CONFIG_PACKAGE_kmod-usb-xhci-hcd/d' .config
            sed -i '/# CONFIG_PACKAGE_kmod-usb-xhci-hcd/d' .config
            
            # å†™å…¥é…ç½®
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
            
            # åŒæ—¶å†™å…¥å¯èƒ½ä¾èµ–çš„é…ç½®
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
        fi
        
        if [ "$TARGET" = "ipq40xx" ] && ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
            missing_phy=1
            log "âš ï¸ PACKAGE_kmod-phy-qcom-dwc3 ä»ç„¶è¢«é‡ç½®ï¼Œç›´æ¥å†™å…¥.configæ–‡ä»¶å¹¶æ·»åŠ ä¾èµ–..."
            
            # åˆ é™¤å¯èƒ½å†²çªçš„è¡Œ
            sed -i '/CONFIG_PACKAGE_kmod-phy-qcom-dwc3/d' .config
            sed -i '/# CONFIG_PACKAGE_kmod-phy-qcom-dwc3/d' .config
            
            # å†™å…¥é…ç½®
            echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
        fi
        
        if [ $missing_xhci -eq 1 ] || [ $missing_phy -eq 1 ]; then
            log "ğŸ”„ ç¬¬ä¸‰æ¬¡è¿è¡Œ make defconfigï¼ˆä½†ä¿ç•™æ‰‹åŠ¨å†™å…¥çš„é…ç½®ï¼‰..."
            
            # å¤‡ä»½æ‰‹åŠ¨å†™å…¥çš„é…ç½®
            cp .config .config.custom
            
            # è¿è¡Œdefconfig
            make defconfig || handle_error "ä¸‰æ¬¡é…ç½®åŒæ­¥å¤±è´¥"
            
            # æ¢å¤æ‰‹åŠ¨å†™å…¥çš„é…ç½®ï¼ˆå¦‚æœè¢«è¦†ç›–ï¼‰
            for driver in "${force_drivers_phase1[@]}"; do
                if ! grep -q "^CONFIG_${driver}=y" .config; then
                    log "âš ï¸ $driver è¢«defconfigè¦†ç›–ï¼Œä»å¤‡ä»½æ¢å¤..."
                    grep "^CONFIG_${driver}=y" .config.custom >> .config 2>/dev/null || echo "CONFIG_${driver}=y" >> .config
                fi
            done
            
            log "ğŸ”„ ç¬¬å››æ¬¡è¿è¡Œ make defconfig æœ€ç»ˆåŒæ­¥..."
            make defconfig
        fi
    fi
    
    log "ğŸ“‹ å…³é”®é…ç½®çŠ¶æ€ï¼ˆæœ€ç»ˆéªŒè¯ï¼‰:"
    log "  - kmod-usb2: $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb3: $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    if [ "$TARGET" = "ipq40xx" ]; then
        log "  - kmod-usb-dwc3-qcom: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        log "  - kmod-phy-qcom-dwc3: $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  - luci-app-turboacc: $(grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    log "  - kmod-tcp-bbr: $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    # æœ€ç»ˆå¼ºåˆ¶é€€å‡ºæœºåˆ¶ - å¦‚æœå…³é”®é©±åŠ¨ä»æœªå¯ç”¨ï¼Œç›´æ¥æŠ¥é”™é€€å‡º
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        log "âŒ è‡´å‘½é”™è¯¯: ç»è¿‡å››æ¬¡å°è¯•åï¼Œkmod-usb-xhci-hcd ä»ç„¶æœªå¯ç”¨"
        log "ğŸ’¡ è¯·æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬å’Œå¹³å°æ”¯æŒæƒ…å†µ"
        handle_error "USB 3.0é©±åŠ¨å¼ºåˆ¶å¯ç”¨å¤±è´¥"
    fi
    
    if [ "$TARGET" = "ipq40xx" ] && ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
        log "âŒ è‡´å‘½é”™è¯¯: ç»è¿‡å››æ¬¡å°è¯•åï¼Œkmod-phy-qcom-dwc3 ä»ç„¶æœªå¯ç”¨"
        log "ğŸ’¡ è¯·æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬å’Œå¹³å°æ”¯æŒæƒ…å†µ"
        handle_error "IPQ40xxå¹³å°é©±åŠ¨å¼ºåˆ¶å¯ç”¨å¤±è´¥"
    fi
    
    log "ğŸ“Š é…ç½®ç”Ÿæˆç»Ÿè®¡:"
    log "  - æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "  - é…ç½®è¡Œæ•°: $(wc -l < .config)"
    log "  - é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
