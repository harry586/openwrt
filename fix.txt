#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    local device_override=$2  # æ–°å¢è®¾å¤‡è¦†ç›–å‚æ•°
    
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    # å¦‚æœæä¾›äº†è®¾å¤‡è¦†ç›–å‚æ•°ï¼Œä¼˜å…ˆä½¿ç”¨
    if [ -n "$device_override" ]; then
        DEVICE="$device_override"
        log "ğŸ”§ ä½¿ç”¨è®¾å¤‡è¦†ç›–å‚æ•°: $DEVICE"
    fi
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆè®¾å¤‡æ˜¾å¼æŒ‡å®šç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    # éªŒè¯è®¾å¤‡å˜é‡æ˜¯å¦ä¸ºç©º
    if [ -z "$DEVICE" ]; then
        log "âŒ é”™è¯¯: DEVICEå˜é‡ä¸ºç©ºï¼"
        log "å¯ç”¨ç¯å¢ƒå˜é‡:"
        env | grep -E "DEVICE|TARGET|SELECTED" || true
        handle_error "DEVICEå˜é‡æœªè®¾ç½®"
    fi
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # æ­¥éª¤1: æ ¹æ®è®¾å¤‡åæ˜ å°„åˆ°æ­£ç¡®çš„OpenWrtè®¾å¤‡é…ç½®åï¼ˆä¿æŒå°å†™ï¼‰
    local openwrt_device=""
    case "$DEVICE" in
        ac42u|rt-ac42u|asus_rt-ac42u)
            openwrt_device="asus_rt-ac42u"
            log "ğŸ”§ æ˜ å°„è®¾å¤‡ $DEVICE -> $openwrt_device"
            ;;
        acrh17|rt-acrh17|asus_rt-acrh17)
            openwrt_device="asus_rt-acrh17"
            log "ğŸ”§ æ˜ å°„è®¾å¤‡ $DEVICE -> $openwrt_device"
            ;;
        *)
            # é»˜è®¤ä½¿ç”¨åŸè®¾å¤‡åï¼Œä½†è½¬æ¢ä¸ºOpenWrtæ ¼å¼ï¼ˆå…¨éƒ¨å°å†™ï¼Œä¸‹åˆ’çº¿ï¼‰
            openwrt_device=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
            log "ğŸ”§ ä½¿ç”¨è½¬æ¢åçš„è®¾å¤‡å: $openwrt_device"
            ;;
    esac
    
    # ç›´æ¥ä½¿ç”¨å°å†™çš„è®¾å¤‡å
    local device_lower="$openwrt_device"
    local device_config="CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}"
    
    log "ğŸ”§ è®¾å¤‡é…ç½®å˜é‡: $device_config=y"
    
    # æ­¥éª¤2: åˆ›å»ºåŸºç¡€ç›®æ ‡é…ç½® - ä½¿ç”¨å°å†™è®¾å¤‡å
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
${device_config}=y
EOF
    
    log "ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶å†…å®¹:"
    cat .config
    
    # æ­¥éª¤3: åˆå¹¶æ‰€æœ‰é…ç½®æ–‡ä»¶
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    # è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è¿½åŠ é…ç½®ï¼ˆè¿‡æ»¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
        fi
    }
    
    append_config "$CONFIG_DIR/base.config"
    append_config "$CONFIG_DIR/usb-generic.config"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    append_config "$CONFIG_DIR/devices/$DEVICE.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/normal.config"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # ä»config.txtåŠ¨æ€æ·»åŠ é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if [ -f "$CONFIG_DIR/devices/$DEVICE.config" ]; then
        log "ğŸ“‹ ä»è®¾å¤‡é…ç½®æ–‡ä»¶åŠ¨æ€æ·»åŠ é…ç½®: $CONFIG_DIR/devices/$DEVICE.config"
        append_config "$CONFIG_DIR/devices/$DEVICE.config"
    fi
    
    # TCP BBRï¼ˆæ‰€æœ‰è®¾å¤‡éƒ½å¯ç”¨ï¼‰
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    # TurboACCï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰
    if [ "$CONFIG_MODE" = "normal" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # ath10k å†²çªè§£å†³ï¼ˆä½¿ç”¨cté©±åŠ¨ï¼‰
    sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
    echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
    echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
    
    # æ­¥éª¤4: ç¬¬ä¸€æ¬¡å»é‡
    log "ğŸ”„ ç¬¬ä¸€æ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤5: åŠ¨æ€è·å–ç›®æ ‡å¹³å°æ”¯æŒçš„å†…æ ¸é…ç½®
    log "ğŸ” åŠ¨æ€è·å–ç›®æ ‡å¹³å°æ”¯æŒçš„å†…æ ¸é…ç½®..."
    
    # è·å–ç›®æ ‡å¹³å°çš„å†…æ ¸é…ç½®æ–‡ä»¶
    local kernel_config_file=""
    local kernel_version=""
    
    # æ£€æµ‹å†…æ ¸ç‰ˆæœ¬
    if [ -f "target/linux/$TARGET/config-5.4" ]; then
        kernel_config_file="target/linux/$TARGET/config-5.4"
        kernel_version="5.4"
    elif [ -f "target/linux/$TARGET/config-5.10" ]; then
        kernel_config_file="target/linux/$TARGET/config-5.10"
        kernel_version="5.10"
    elif [ -f "target/linux/$TARGET/config-5.15" ]; then
        kernel_config_file="target/linux/$TARGET/config-5.15"
        kernel_version="5.15"
    elif [ -f "target/linux/$TARGET/config-6.1" ]; then
        kernel_config_file="target/linux/$TARGET/config-6.1"
        kernel_version="6.1"
    fi
    
    if [ -n "$kernel_config_file" ] && [ -f "$kernel_config_file" ]; then
        log "âœ… æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
        
        # åŠ¨æ€æå–USBç›¸å…³çš„å†…æ ¸é…ç½®
        log "ğŸ“‹ ä»å†…æ ¸é…ç½®æ–‡ä»¶åŠ¨æ€æå–USBç›¸å…³é…ç½®:"
        
        # å®šä¹‰è¦æŸ¥æ‰¾çš„USBç›¸å…³é…ç½®æ¨¡å¼
        local usb_patterns=(
            "CONFIG_USB"
            "CONFIG_PHY"
            "CONFIG_DWC"
            "CONFIG_XHCI"
            "CONFIG_EXTCON"
            "CONFIG_COMMON_CLK"
            "CONFIG_ARCH"
        )
        
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å­˜å‚¨æå–çš„é…ç½®
        local usb_configs_file="/tmp/usb_configs_$$.txt"
        
        for pattern in "${usb_patterns[@]}"; do
            grep -E "^${pattern}|^# ${pattern}" "$kernel_config_file" >> "$usb_configs_file" 2>/dev/null || true
        done
        
        # å»é‡å¹¶æ’åº
        sort -u "$usb_configs_file" > "$usb_configs_file.sorted"
        
        # æ˜¾ç¤ºæ‰¾åˆ°çš„é…ç½®
        local config_count=$(wc -l < "$usb_configs_file.sorted")
        log "æ‰¾åˆ° $config_count ä¸ªUSBç›¸å…³å†…æ ¸é…ç½®"
        
        # æ˜¾ç¤ºæ‰€æœ‰é…ç½®ï¼Œä¸åˆ†é¡µ
        log "æ‰€æœ‰USBç›¸å…³å†…æ ¸é…ç½®:"
        local line_num=0
        while read line; do
            line_num=$((line_num + 1))
            if echo "$line" | grep -q "=y$"; then
                log "   âœ… [$line_num] $line"
            elif echo "$line" | grep -q "=m$"; then
                log "   ğŸ“¦ [$line_num] $line"
            elif echo "$line" | grep -q "is not set"; then
                log "   âšª [$line_num] $line"
            else
                log "   ğŸ“„ [$line_num] $line"
            fi
        done < "$usb_configs_file.sorted"
        
        # å°†è¿™äº›é…ç½®æ·»åŠ åˆ°.configä¸­ï¼ˆä½†ä¸è¦è¦†ç›–å·²å¯ç”¨çš„é…ç½®ï¼‰
        local added_count=0
        while read line; do
            # æå–é…ç½®åï¼ˆå»æ‰å‰é¢çš„#å’Œç©ºæ ¼ï¼‰
            local config_name=$(echo "$line" | sed 's/^# //g' | cut -d'=' -f1 | cut -d' ' -f1)
            
            # æ£€æŸ¥é…ç½®æ˜¯å¦å·²å­˜åœ¨
            if ! grep -q "^${config_name}=" .config && ! grep -q "^# ${config_name} is not set" .config; then
                # å¦‚æœé…ç½®æ˜¯å¯ç”¨çš„ï¼ˆ=yï¼‰ï¼Œç›´æ¥æ·»åŠ 
                if echo "$line" | grep -q "=y$"; then
                    echo "$line" >> .config
                    added_count=$((added_count + 1))
                # å¦‚æœé…ç½®æ˜¯ç¦ç”¨çš„ï¼ˆis not setï¼‰ï¼Œä½œä¸ºæ³¨é‡Šæ·»åŠ 
                elif echo "$line" | grep -q "is not set"; then
                    echo "$line" >> .config
                    added_count=$((added_count + 1))
                fi
            fi
        done < "$usb_configs_file.sorted"
        
        log "âœ… æ·»åŠ äº† $added_count ä¸ªæ–°çš„å†…æ ¸é…ç½®"
        
        rm -f "$usb_configs_file" "$usb_configs_file.sorted"
    else
        log "âš ï¸ æœªæ‰¾åˆ°ç›®æ ‡å¹³å° $TARGET çš„å†…æ ¸é…ç½®æ–‡ä»¶"
    fi
    
    # æ­¥éª¤6: ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfigï¼ˆè¿™ä¼šé‡ç½®å†…æ ¸é…ç½®ï¼‰
    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfigï¼ˆåŠ è½½å¹³å°é»˜è®¤é…ç½®ï¼‰..."
    make defconfig > /tmp/build-logs/defconfig1.log 2>&1 || {
        log "âŒ ç¬¬ä¸€æ¬¡ make defconfig å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
        tail -50 /tmp/build-logs/defconfig1.log
        handle_error "ç¬¬ä¸€æ¬¡ä¾èµ–è§£å†³å¤±è´¥"
    }
    log "âœ… ç¬¬ä¸€æ¬¡ make defconfig æˆåŠŸ"
    
    # æ­¥éª¤7: åŠ¨æ€æ£€æµ‹å®é™…ç”Ÿæ•ˆçš„USBå†…æ ¸é…ç½®
    log "ğŸ” åŠ¨æ€æ£€æµ‹å®é™…ç”Ÿæ•ˆçš„USBå†…æ ¸é…ç½®..."
    
    # å®šä¹‰è¦æ£€æŸ¥çš„å…³é”®USBç»„ä»¶
    local usb_components=(
        "USB_SUPPORT"
        "USB_COMMON"
        "USB"
        "USB_XHCI_HCD"
        "USB_DWC3"
        "PHY"
    )
    
    for component in "${usb_components[@]}"; do
        local matches=$(grep -E "^CONFIG_${component}" .config | grep -E "=y|=m" | wc -l)
        if [ $matches -gt 0 ]; then
            log "âœ… $component ç›¸å…³é…ç½®: æ‰¾åˆ° $matches ä¸ª"
            # æ˜¾ç¤ºæ‰€æœ‰å…·ä½“é…ç½®
            grep -E "^CONFIG_${component}" .config | grep -E "=y|=m" | while read line; do
                log "    $line"
            done
        else
            log "â„¹ï¸ $component ç›¸å…³é…ç½®: æœªæ‰¾åˆ°"
        fi
    done
    
    # æ˜¾ç¤ºæ‰€æœ‰USBç›¸å…³å†…æ ¸é…ç½®
    log "ğŸ“‹ æ‰€æœ‰USBç›¸å…³å†…æ ¸é…ç½®ï¼ˆå·²ç”Ÿæ•ˆï¼‰:"
    local all_usb_kernel=$(grep -E "^CONFIG_USB_|^CONFIG_PHY_|^CONFIG_DWC|^CONFIG_XHCI|^CONFIG_EXTCON|^CONFIG_COMMON_CLK|^CONFIG_ARCH" .config | grep -E "=y|=m" | sort)
    if [ -n "$all_usb_kernel" ]; then
        local kernel_count=$(echo "$all_usb_kernel" | wc -l)
        log "å…± $kernel_count ä¸ªUSBç›¸å…³å†…æ ¸é…ç½®:"
        echo "$all_usb_kernel" | while read line; do
            log "  âœ… $line"
        done
    else
        log "  æœªæ‰¾åˆ°USBç›¸å…³å†…æ ¸é…ç½®"
    fi
    
    # æ­¥éª¤8: åŠ¨æ€æ·»åŠ USBè½¯ä»¶åŒ…ï¼ˆåŸºäºç›®æ ‡å¹³å°ï¼‰
    log "ğŸ“‹ åŠ¨æ€æ·»åŠ USBè½¯ä»¶åŒ…..."
    
    # åŸºç¡€USBè½¯ä»¶åŒ…ï¼ˆæ‰€æœ‰å¹³å°éƒ½éœ€è¦ï¼‰
    local base_usb_packages=(
        "kmod-usb-core"
        "kmod-usb-common"
        "kmod-usb2"
        "kmod-usb3"
        "kmod-usb-storage"
        "kmod-scsi-core"
        "block-mount"
        "automount"
        "usbutils"
    )
    
    # æ ¹æ®ç›®æ ‡å¹³å°æ·»åŠ ç‰¹å®šè½¯ä»¶åŒ…
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            log "æ£€æµ‹åˆ°é«˜é€šå¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local qcom_packages=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-qcom"
                "kmod-usb-dwc3-of-simple"
                "kmod-phy-qcom-ipq4019-usb"
                "kmod-usb-xhci-hcd"
                "kmod-usb-xhci-plat-hcd"
            )
            base_usb_packages+=("${qcom_packages[@]}")
            ;;
        mediatek|ramips)
            log "æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local mtk_packages=(
                "kmod-usb-xhci-mtk"
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-mediatek"
            )
            base_usb_packages+=("${mtk_packages[@]}")
            ;;
        ath79)
            log "æ£€æµ‹åˆ°ATH79å¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local ath79_packages=(
                "kmod-usb2-ath79"
                "kmod-usb-ohci"
            )
            base_usb_packages+=("${ath79_packages[@]}")
            ;;
    esac
    
    # å»é‡å¹¶æ·»åŠ USBè½¯ä»¶åŒ…
    local added_packages=0
    local existing_packages=0
    while read pkg; do
        [ -z "$pkg" ] && continue
        if ! grep -q "^CONFIG_PACKAGE_${pkg}=y" .config && ! grep -q "^CONFIG_PACKAGE_${pkg}=m" .config; then
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            added_packages=$((added_packages + 1))
            log "  âœ… æ·»åŠ è½¯ä»¶åŒ…: $pkg"
        else
            existing_packages=$((existing_packages + 1))
        fi
    done < <(printf "%s\n" "${base_usb_packages[@]}" | sort -u)
    
    log "ğŸ“Š USBè½¯ä»¶åŒ…ç»Ÿè®¡: æ–°å¢ $added_packages ä¸ª, å·²å­˜åœ¨ $existing_packages ä¸ª"
    
    # æ­¥éª¤9: ç¬¬äºŒæ¬¡å»é‡
    log "ğŸ”„ ç¬¬äºŒæ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤10: ç¬¬äºŒæ¬¡è¿è¡Œ make defconfigï¼ˆåº”ç”¨å¼ºåˆ¶é…ç½®ï¼‰
    log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfigï¼ˆåº”ç”¨å¼ºåˆ¶é…ç½®ï¼‰..."
    make defconfig > /tmp/build-logs/defconfig2.log 2>&1 || {
        log "âš ï¸ ç¬¬äºŒæ¬¡ make defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­..."
    }
    log "âœ… ç¬¬äºŒæ¬¡ make defconfig å®Œæˆ"
    
    # æ­¥éª¤11: éªŒè¯å…³é”®USBé©±åŠ¨æ˜¯å¦è¢«æ­£ç¡®å¯ç”¨
    log "ğŸ” éªŒè¯å…³é”®USBé©±åŠ¨çŠ¶æ€..."
    
    local critical_usb_drivers=(
        "kmod-usb-core"
        "kmod-usb2"
        "kmod-usb-storage"
        "kmod-scsi-core"
    )
    
    # æ ¹æ®å¹³å°æ·»åŠ å…³é”®é©±åŠ¨
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            critical_usb_drivers+=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-qcom"
            )
            ;;
        mediatek|ramips)
            critical_usb_drivers+=(
                "kmod-usb-xhci-mtk"
            )
            ;;
    esac
    
    local missing_drivers=()
    for driver in "${critical_usb_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "  âœ… $driver: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${driver}=m" .config; then
            log "  ğŸ“¦ $driver: æ¨¡å—åŒ–"
        else
            log "  âŒ $driver: æœªå¯ç”¨"
            missing_drivers+=("$driver")
        fi
    done
    
    # æ£€æŸ¥USB 3.0/xhciåŠŸèƒ½ï¼ˆå¤šç§å®ç°æ–¹å¼ï¼‰
    log "  ğŸ” USB 3.0/xhciåŠŸèƒ½æ£€æµ‹:"
    local usb3_found=0
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        log "    âœ… kmod-usb3: å·²å¯ç”¨"
        usb3_found=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        log "    âœ… kmod-usb-xhci-hcd: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" .config; then
        log "    âœ… kmod-usb-xhci-plat-hcd: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-qcom=y" .config; then
        log "    âœ… kmod-usb-xhci-qcom: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config; then
        log "    âœ… kmod-usb-xhci-mtk: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        log "    âœ… DWC3 + USB3: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_USB_XHCI_HCD=y" .config; then
        log "    âœ… å†…æ ¸xhciæ”¯æŒ: å·²å¯ç”¨"
        usb3_found=1
    fi
    
    if [ $usb3_found -eq 0 ]; then
        log "    âŒ USB 3.0åŠŸèƒ½æœªå¯ç”¨"
        missing_drivers+=("USB 3.0åŠŸèƒ½")
    fi
    
    if [ ${#missing_drivers[@]} -gt 0 ]; then
        log "âš ï¸ ç¼ºå¤±é©±åŠ¨: ${missing_drivers[*]}"
    else
        log "âœ… æ‰€æœ‰å…³é”®USBé©±åŠ¨éƒ½å·²å¯ç”¨"
    fi
    
    # æ­¥éª¤12: æ˜¾ç¤ºæ‰€æœ‰å·²å¯ç”¨çš„USBé©±åŠ¨
    log "ğŸ“‹ æ‰€æœ‰å·²å¯ç”¨çš„USBé©±åŠ¨:"
    local all_usb=$(grep "^CONFIG_PACKAGE_kmod-usb.*=y" .config | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    if [ -n "$all_usb" ]; then
        local usb_count=$(echo "$all_usb" | wc -l)
        log "å…± $usb_count ä¸ªUSBé©±åŠ¨:"
        echo "$all_usb" | while read driver; do
            log "  âœ… $driver"
        done
    else
        log "  æœªæ‰¾åˆ°USBé©±åŠ¨"
    fi
    
    # æ­¥éª¤13: æ˜¾ç¤ºæ‰€æœ‰USBç›¸å…³è½¯ä»¶åŒ…ï¼ˆåŒ…æ‹¬æ¨¡å—åŒ–çš„ï¼‰
    log "ğŸ“‹ æ‰€æœ‰USBç›¸å…³è½¯ä»¶åŒ…ï¼ˆåŒ…æ‹¬æ¨¡å—åŒ–ï¼‰:"
    local all_usb_packages=$(grep "^CONFIG_PACKAGE_kmod-usb" .config | grep -E "=y|=m" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    if [ -n "$all_usb_packages" ]; then
        local pkg_count=$(echo "$all_usb_packages" | wc -l)
        log "å…± $pkg_count ä¸ªUSBè½¯ä»¶åŒ…:"
        echo "$all_usb_packages" | while read pkg; do
            if grep -q "^CONFIG_PACKAGE_${pkg}=y" .config; then
                log "  âœ… $pkg"
            else
                log "  ğŸ“¦ $pkg"
            fi
        done
    else
        log "  æœªæ‰¾åˆ°USBè½¯ä»¶åŒ…"
    fi
    
    # æ­¥éª¤14: æœ€ç»ˆè®¾å¤‡éªŒè¯
    log "ğŸ” æ­£åœ¨éªŒè¯è®¾å¤‡ $openwrt_device æ˜¯å¦è¢«é€‰ä¸­..."
    
    if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
        log "âœ… ç›®æ ‡è®¾å¤‡å·²æ­£ç¡®å¯ç”¨: CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y"
    elif grep -q "^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} is not set" .config; then
        log "âš ï¸ è­¦å‘Š: è®¾å¤‡è¢«ç¦ç”¨ï¼Œå°è¯•å¼ºåˆ¶å¯ç”¨..."
        sed -i "/^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} is not set/d" .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1
        
        if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
            log "âœ… è®¾å¤‡å·²å¼ºåˆ¶å¯ç”¨"
        else
            log "âŒ æ— æ³•å¯ç”¨è®¾å¤‡"
        fi
    else
        log "âš ï¸ è­¦å‘Š: è®¾å¤‡é…ç½®è¡Œæœªæ‰¾åˆ°ï¼Œæ‰‹åŠ¨æ·»åŠ ..."
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1
    fi
    
    # æ­¥éª¤15: ä¿å­˜é…ç½®ç»Ÿè®¡ä¿¡æ¯
    local total_configs=$(wc -l < .config)
    local enabled_packages=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config)
    local module_packages=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config)
    local disabled_packages=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config)
    local enabled_kernel=$(grep -c "^CONFIG_[A-Z].*=y$" .config | grep -v "PACKAGE" | wc -l)
    
    log "ğŸ“Š é…ç½®ç»Ÿè®¡:"
    log "  æ€»é…ç½®è¡Œæ•°: $total_configs"
    log "  å¯ç”¨è½¯ä»¶åŒ…: $enabled_packages"
    log "  æ¨¡å—åŒ–è½¯ä»¶åŒ…: $module_packages"
    log "  ç¦ç”¨è½¯ä»¶åŒ…: $disabled_packages"
    log "  å¯ç”¨å†…æ ¸é…ç½®: $enabled_kernel"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
