#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆåŠ¨æ€æ£€æµ‹ç‰ˆï¼‰ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡:"
        echo "   SELECTED_BRANCH=$SELECTED_BRANCH"
        echo "   TARGET=$TARGET"
        echo "   SUBTARGET=$SUBTARGET"
        echo "   DEVICE=$DEVICE"
        echo "   CONFIG_MODE=$CONFIG_MODE"
        echo "   COMPILER_DIR=$COMPILER_DIR"
    else
        echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ ($BUILD_DIR/build_env.sh)"
        exit 1
    fi
    
    cd $BUILD_DIR
    echo ""
    echo "=== ğŸš¨ å‰ç½®é”™è¯¯åŠ¨æ€æ£€æµ‹ ==="
    echo ""
    
    local error_count=0
    local warning_count=0
    
    # =========================================================================
    # åŠ¨æ€è·å–è®¾å¤‡æ”¯æŒä¿¡æ¯
    # =========================================================================
    echo "0. ğŸ” åŠ¨æ€è·å–è®¾å¤‡æ”¯æŒä¿¡æ¯:"
    echo "----------------------------------------"
    
    # è·å–æ‰€æœ‰æ”¯æŒçš„åˆ†æ”¯
    local supported_branches=$(get_supported_branches 2>/dev/null || echo "")
    if [ -n "$supported_branches" ]; then
        local branch_count=$(echo "$supported_branches" | wc -l)
        echo "   ğŸ“¦ æ”¯æŒçš„åˆ†æ”¯ ($branch_count ä¸ª):"
        echo "$supported_branches" | head -5 | while read branch; do
            if [ "$branch" = "$SELECTED_BRANCH" ]; then
                echo "     âœ… $branch (å½“å‰é€‰æ‹©)"
            else
                echo "     ğŸ“Œ $branch"
            fi
        done
        if [ $branch_count -gt 5 ]; then
            echo "     ... è¿˜æœ‰ $((branch_count - 5)) ä¸ªåˆ†æ”¯æœªæ˜¾ç¤º"
        fi
    else
        echo "   âš ï¸ æ— æ³•è·å–æ”¯æŒçš„åˆ†æ”¯åˆ—è¡¨"
        warning_count=$((warning_count + 1))
    fi
    
    # è·å–å½“å‰å¹³å°ä¸‹çš„æ‰€æœ‰å­å¹³å°
    if [ -n "$TARGET" ]; then
        local supported_subtargets=$(get_subtargets_by_platform "$SELECTED_BRANCH" "$TARGET" 2>/dev/null || echo "")
        if [ -n "$supported_subtargets" ]; then
            local subtarget_count=$(echo "$supported_subtargets" | wc -l)
            echo ""
            echo "   ğŸ“ å¹³å° $TARGET æ”¯æŒçš„å­å¹³å° ($subtarget_count ä¸ª):"
            echo "$supported_subtargets" | while read subtarget; do
                if [ "$subtarget" = "$SUBTARGET" ]; then
                    echo "     âœ… $subtarget (å½“å‰é€‰æ‹©)"
                else
                    echo "     ğŸ“Œ $subtarget"
                fi
            done
        else
            echo "   âš ï¸ æ— æ³•è·å–å¹³å° $TARGET æ”¯æŒçš„å­å¹³å°åˆ—è¡¨"
        fi
    fi
    
    # è·å–å½“å‰å¹³å°/å­å¹³å°ä¸‹çš„æ‰€æœ‰è®¾å¤‡ï¼ˆåŒ…æ‹¬ç³»åˆ—åŒ¹é…ï¼‰
    if [ -n "$TARGET" ] && [ -n "$SUBTARGET" ]; then
        echo ""
        echo "   ğŸ“± å¹³å° $TARGET/$SUBTARGET è®¾å¤‡æ”¯æŒæ£€æµ‹:"
        
        # è·å–ç²¾ç¡®åŒ¹é…çš„è®¾å¤‡
        local exact_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$TARGET" "$SUBTARGET" "exact" 2>/dev/null)
        local exact_count=0
        if [ -n "$exact_devices" ]; then
            exact_count=$(echo "$exact_devices" | wc -l)
        fi
        
        # è·å–ç³»åˆ—åŒ¹é…çš„è®¾å¤‡ï¼ˆå¦‚7981åŒ¹é…798xï¼‰
        local series_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$TARGET" "$SUBTARGET" "series" 2>/dev/null)
        local series_count=0
        if [ -n "$series_devices" ]; then
            series_count=$(echo "$series_devices" | wc -l)
        fi
        
        # è·å–é€šé…åŒ¹é…çš„è®¾å¤‡
        local wildcard_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$TARGET" "$SUBTARGET" "wildcard" 2>/dev/null)
        local wildcard_count=0
        if [ -n "$wildcard_devices" ]; then
            wildcard_count=$(echo "$wildcard_devices" | wc -l)
        fi
        
        echo "     ğŸ“Š ç²¾ç¡®åŒ¹é…: $exact_count ä¸ªè®¾å¤‡"
        echo "     ğŸ“Š ç³»åˆ—åŒ¹é…: $series_count ä¸ªè®¾å¤‡ (å¦‚7981åŒ¹é…798x)"
        echo "     ğŸ“Š é€šé…åŒ¹é…: $wildcard_count ä¸ªè®¾å¤‡"
        
        # æ˜¾ç¤ºç²¾ç¡®åŒ¹é…çš„è®¾å¤‡ï¼ˆå½“å‰å­å¹³å°ä¸“ç”¨ï¼‰
        if [ $exact_count -gt 0 ]; then
            echo ""
            echo "     ğŸ“‹ ç²¾ç¡®åŒ¹é…è®¾å¤‡ (å­å¹³å° $SUBTARGET ä¸“ç”¨):"
            local found_current=0
            echo "$exact_devices" | head -10 | while read device; do
                if [ "$device" = "$DEVICE" ]; then
                    echo "       âœ… $device (å½“å‰é€‰æ‹©)"
                    found_current=1
                else
                    echo "       ğŸ“Œ $device"
                fi
            done
            if [ $exact_count -gt 10 ]; then
                echo "       ... è¿˜æœ‰ $((exact_count - 10)) ä¸ªè®¾å¤‡æœªæ˜¾ç¤º"
            fi
        fi
        
        # æ˜¾ç¤ºç³»åˆ—åŒ¹é…çš„è®¾å¤‡ï¼ˆå¦‚7981åœ¨filogicç›®å½•ä¸‹åŒ¹é…798xï¼‰
        if [ $series_count -gt 0 ]; then
            echo ""
            echo "     ğŸ”— ç³»åˆ—åŒ¹é…è®¾å¤‡ (é€‚ç”¨äº $SUBTARGET ç³»åˆ—):"
            echo "$series_devices" | head -10 | while read device; do
                if [ "$device" = "$DEVICE" ] && [ $found_current -eq 0 ]; then
                    echo "       ğŸ”„ $device (å½“å‰é€‰æ‹© - ç³»åˆ—åŒ¹é…)"
                    found_current=1
                else
                    echo "       ğŸ”— $device"
                fi
            done
            if [ $series_count -gt 10 ]; then
                echo "       ... è¿˜æœ‰ $((series_count - 10)) ä¸ªè®¾å¤‡æœªæ˜¾ç¤º"
            fi
        fi
        
        # å¦‚æœå½“å‰è®¾å¤‡åœ¨ä»»ä½•åŒ¹é…ä¸­éƒ½æ²¡æ‰¾åˆ°
        if [ $found_current -eq 0 ]; then
            echo ""
            echo "   âš ï¸ è­¦å‘Š: å½“å‰è®¾å¤‡ $DEVICE æœªåœ¨åŒ¹é…åˆ—è¡¨ä¸­æ‰¾åˆ°!"
            echo "     å¯èƒ½çš„åŸå› :"
            echo "     - è®¾å¤‡åä¸åŒ¹é…"
            echo "     - è®¾å¤‡åœ¨æ­¤å¹³å°/å­å¹³å°ä¸‹ä¸æ”¯æŒ"
            echo "     - éœ€è¦æ£€æŸ¥ç³»åˆ—åŒ¹é…è§„åˆ™"
            warning_count=$((warning_count + 1))
        fi
        
        # æ˜¾ç¤ºåŒ¹é…ç»Ÿè®¡
        echo ""
        echo "     ğŸ“ˆ åŒ¹é…ç»Ÿè®¡:"
        echo "       ç²¾ç¡®åŒ¹é…ç›®å½•: $exact_count ä¸ªè®¾å¤‡"
        echo "       ç³»åˆ—åŒ¹é…ç›®å½•: $series_count ä¸ªè®¾å¤‡"
        echo "       é€šé…åŒ¹é…ç›®å½•: $wildcard_count ä¸ªè®¾å¤‡"
        echo "       æ€»è®¡: $((exact_count + series_count + wildcard_count)) ä¸ªç›¸å…³è®¾å¤‡"
    fi
    
    echo "----------------------------------------"
    echo ""
    
    # 1. æ£€æŸ¥é…ç½®æ–‡ä»¶
    echo "1. âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    if [ -f ".config" ]; then
        local config_size=$(ls -lh .config | awk '{print $5}')
        local config_lines=$(wc -l < .config)
        echo "   âœ… .config æ–‡ä»¶å­˜åœ¨"
        echo "   ğŸ“Š å¤§å°: $config_size, è¡Œæ•°: $config_lines"
        
        # æ£€æŸ¥è®¾å¤‡é…ç½®
        local device_upper=$(echo "$DEVICE" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
        if grep -q "CONFIG_TARGET_.*DEVICE.*${device_upper}=y" .config; then
            echo "   âœ… è®¾å¤‡é…ç½®æ­£ç¡®"
        else
            # å°è¯•å°å†™åŒ¹é…
            local device_lower=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
            if grep -q "CONFIG_TARGET_.*DEVICE.*${device_lower}=y" .config; then
                echo "   âœ… è®¾å¤‡é…ç½®æ­£ç¡® (å°å†™)"
            else
                echo "   âŒ è®¾å¤‡é…ç½®å¯èƒ½ä¸æ­£ç¡®"
                error_count=$((error_count + 1))
            fi
        fi
    else
        echo "   âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 2. æ£€æŸ¥SDK/ç¼–è¯‘å™¨
    echo "2. âœ… SDK/ç¼–è¯‘å™¨æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "   âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
        local sdk_size=$(du -sh "$COMPILER_DIR" 2>/dev/null | awk '{print $1}')
        echo "   ğŸ“Š å¤§å°: $sdk_size"
        
        # æŸ¥æ‰¾çœŸæ­£çš„GCC
        local gcc_file=$(find "$COMPILER_DIR" -type f -executable -name "*gcc" ! -name "*gcc-ar" ! -name "*gcc-ranlib" ! -name "*gcc-nm" ! -path "*dummy-tools*" 2>/dev/null | head -1)
        if [ -n "$gcc_file" ]; then
            echo "   âœ… æ‰¾åˆ°GCC: $(basename "$gcc_file")"
            local gcc_version=$("$gcc_file" --version 2>&1 | head -1)
            echo "   ğŸ”§ ç‰ˆæœ¬: $gcc_version"
        else
            echo "   âŒ æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨"
            error_count=$((error_count + 1))
        fi
    else
        echo "   âŒ SDKç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 3. æ£€æŸ¥Feeds
    echo "3. âœ… Feedsæ£€æŸ¥:"
    if [ -d "feeds" ]; then
        local feeds_count=$(find feeds -maxdepth 1 -type d 2>/dev/null | wc -l)
        feeds_count=$((feeds_count - 1))  # å‡å»feedsç›®å½•æœ¬èº«
        echo "   âœ… feedsç›®å½•å­˜åœ¨, åŒ…å« $feeds_count ä¸ªfeed"
        
        # æ£€æŸ¥å…³é”®feed
        for feed in packages luci; do
            if [ -d "feeds/$feed" ]; then
                echo "   âœ… $feed feed: å­˜åœ¨"
            else
                echo "   âŒ $feed feed: ä¸å­˜åœ¨"
                warning_count=$((warning_count + 1))
            fi
        done
    else
        echo "   âŒ feedsç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
    echo "4. âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    local available_space=$(df /mnt --output=avail 2>/dev/null | tail -1 || df / --output=avail | tail -1)
    local available_gb=$((available_space / 1024 / 1024))
    echo "   ğŸ“Š å¯ç”¨ç©ºé—´: ${available_gb}G"
    
    if [ $available_gb -lt 5 ]; then
        echo "   âŒ ç©ºé—´ä¸¥é‡ä¸è¶³ (<5G)"
        error_count=$((error_count + 1))
    elif [ $available_gb -lt 10 ]; then
        echo "   âš ï¸ ç©ºé—´è¾ƒä½ (<10G)"
        warning_count=$((warning_count + 1))
    elif [ $available_gb -lt 20 ]; then
        echo "   âš ï¸ ç©ºé—´ä¸€èˆ¬ (<20G)"
        warning_count=$((warning_count + 1))
    else
        echo "   âœ… ç©ºé—´å……è¶³"
    fi
    echo ""
    
    # 5. æ£€æŸ¥å…³é”®USBé©±åŠ¨
    echo "5. âœ… USBé©±åŠ¨æ£€æŸ¥:"
    local critical_drivers=(
        "kmod-usb-core"
    )
    
    # æ ¹æ®å¹³å°æ·»åŠ å…³é”®é©±åŠ¨
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            critical_drivers+=("kmod-usb-dwc3" "kmod-usb-dwc3-qcom")
            ;;
        mediatek|ramips)
            critical_drivers+=("kmod-usb-xhci-mtk")
            ;;
    esac
    
    local missing_usb=0
    for driver in "${critical_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "   âœ… $driver: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${driver}=m" .config; then
            echo "   ğŸ“¦ $driver: æ¨¡å—åŒ–"
        else
            echo "   âŒ $driver: æœªå¯ç”¨"
            missing_usb=$((missing_usb + 1))
        fi
    done
    
    if [ $missing_usb -gt 0 ]; then
        echo "   âš ï¸ æœ‰ $missing_usb ä¸ªå…³é”®USBé©±åŠ¨ç¼ºå¤±"
        warning_count=$((warning_count + 1))
    fi
    echo ""
    
    # 6. æ£€æŸ¥å†…å­˜
    echo "6. âœ… å†…å­˜æ£€æŸ¥:"
    local mem_total=$(free -m | awk '/^Mem:/{print $2}')
    local mem_available=$(free -m | awk '/^Mem:/{print $7}')
    echo "   ğŸ“Š æ€»å†…å­˜: ${mem_total}MB, å¯ç”¨: ${mem_available}MB"
    
    if [ $mem_available -lt 512 ]; then
        echo "   âš ï¸ å¯ç”¨å†…å­˜ä¸è¶³ (<512MB)"
        warning_count=$((warning_count + 1))
    else
        echo "   âœ… å†…å­˜å……è¶³"
    fi
    echo ""
    
    # 7. æ£€æŸ¥CPU
    echo "7. âœ… CPUæ£€æŸ¥:"
    local cpu_cores=$(nproc)
    local cpu_model=$(grep "model name" /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs)
    echo "   ğŸ“Š æ ¸å¿ƒæ•°: $cpu_cores"
    echo "   ğŸ“Š å‹å·: $cpu_model"
    echo ""
    
    # 8. æ£€æŸ¥åˆ†æ”¯å…¼å®¹æ€§
    echo "8. âœ… åˆ†æ”¯å…¼å®¹æ€§æ£€æŸ¥:"
    if [ -n "$supported_branches" ]; then
        if echo "$supported_branches" | grep -q "^$SELECTED_BRANCH$"; then
            echo "   âœ… å½“å‰åˆ†æ”¯ $SELECTED_BRANCH åœ¨æ”¯æŒåˆ—è¡¨ä¸­"
        else
            echo "   âš ï¸ å½“å‰åˆ†æ”¯ $SELECTED_BRANCH ä¸åœ¨æ”¯æŒåˆ—è¡¨ä¸­"
            echo "   æ”¯æŒçš„ç‰ˆæœ¬:"
            echo "$supported_branches" | head -3 | while read branch; do
                echo "     - $branch"
            done
            warning_count=$((warning_count + 1))
        fi
    fi
    echo ""
    
    # 9. æ£€æŸ¥å†…æ ¸é…ç½®æ–‡ä»¶
    echo "9. âœ… å†…æ ¸é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    local kernel_configs=$(find "target/linux/$TARGET" -type f -name "config-*" 2>/dev/null | wc -l)
    if [ $kernel_configs -gt 0 ]; then
        echo "   âœ… æ‰¾åˆ° $kernel_configs ä¸ªå†…æ ¸é…ç½®æ–‡ä»¶"
        echo "   å†…æ ¸ç‰ˆæœ¬:"
        find "target/linux/$TARGET" -type f -name "config-*" 2>/dev/null | \
            sed 's/.*config-//' | sort -u | head -5 | while read ver; do
            echo "     - $ver"
        done
    else
        echo "   âš ï¸ æœªæ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶"
        warning_count=$((warning_count + 1))
    fi
    echo ""
    
    # æ±‡æ€»
    echo "========================================"
    if [ $error_count -gt 0 ]; then
        echo "âŒâŒâŒ æ£€æµ‹åˆ° $error_count ä¸ªé”™è¯¯ï¼Œè¯·ä¿®å¤åé‡è¯• âŒâŒâŒ"
        exit 1
    elif [ $warning_count -gt 0 ]; then
        echo "âš ï¸âš ï¸âš ï¸ æ£€æµ‹åˆ° $warning_count ä¸ªè­¦å‘Šï¼Œä½†å¯ä»¥ç»§ç»­ âš ï¸âš ï¸âš ï¸"
    else
        echo "âœ…âœ…âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    fi
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}

# ============================================================================
# è®¾å¤‡æ”¯æŒä¿¡æ¯æŸ¥è¯¢è¾…åŠ©å‡½æ•°
# ============================================================================

# è·å–æ‰€æœ‰æ”¯æŒçš„åˆ†æ”¯åˆ—è¡¨
get_supported_branches() {
    local branches=()
    
    # ä»é…ç½®æ–‡ä»¶ä¸­è·å–åˆ†æ”¯ä¿¡æ¯
    if [ -f "$REPO_ROOT/build-config.conf" ]; then
        while IFS= read -r line; do
            if [[ "$line" =~ ^[[:space:]]*:?\ \$\{BRANCH_([^=]+):=([^}]+)\} ]]; then
                local branch_name="${BASH_REMATCH[2]}"
                branches+=("$branch_name")
            elif [[ "$line" =~ ^[[:space:]]*export[[:space:]]+BRANCH_([^=]+)=[\"]?([^\"]+)[\"]? ]]; then
                local branch_name="${BASH_REMATCH[2]}"
                branches+=("$branch_name")
            fi
        done < "$REPO_ROOT/build-config.conf"
    fi
    
    # å¦‚æœé…ç½®æ–‡ä»¶æ²¡æœ‰ï¼Œä»gitè¿œç¨‹ä»“åº“è·å–
    if [ ${#branches[@]} -eq 0 ]; then
        local remote_branches=$(git ls-remote --heads "${IMMORTALWRT_URL:-https://github.com/immortalwrt/immortalwrt.git}" 2>/dev/null | \
            awk -F'/' '{print $NF}' | grep -E "^(openwrt-[0-9]+\.[0-9]+|main|master)$" | sort -r)
        
        if [ -n "$remote_branches" ]; then
            while IFS= read -r branch; do
                branches+=("$branch")
            done <<< "$remote_branches"
        fi
    fi
    
    # å»é‡å¹¶è¿”å›
    printf '%s\n' "${branches[@]}" | sort -u 2>/dev/null || echo ""
}

# è·å–æŒ‡å®šå¹³å°ä¸‹çš„æ‰€æœ‰å­å¹³å°
get_subtargets_by_platform() {
    local branch="$1"
    local platform="$2"
    
    local subtargets=()
    local platform_path="target/linux/$platform"
    
    if [ -d "$platform_path" ]; then
        # æŸ¥æ‰¾å­å¹³å°ç›®å½•
        while IFS= read -r subtarget_dir; do
            local subtarget=$(basename "$subtarget_dir")
            if [ -d "$subtarget_dir" ] && [[ ! "$subtarget" =~ ^(image|base-files|config|patches|files|Makefile)$ ]]; then
                if [ -f "$subtarget_dir/target.mk" ] || [ -f "$subtarget_dir/Makefile" ]; then
                    subtargets+=("$subtarget")
                fi
            fi
        done < <(find "$platform_path" -maxdepth 1 -type d ! -path "$platform_path" 2>/dev/null | sort)
        
        # å¦‚æœæ²¡æœ‰å­å¹³å°ç›®å½•ï¼Œæ£€æŸ¥Makefile
        if [ ${#subtargets[@]} -eq 0 ] && [ -f "$platform_path/Makefile" ]; then
            local default_subtarget=$(grep -E "^[[:space:]]*SUBTARGETS?[[:space:]]*:?=" "$platform_path/Makefile" 2>/dev/null | \
                sed 's/.*=[[:space:]]*//' | tr -d ' ' | tr ',' ' ')
            
            if [ -n "$default_subtarget" ]; then
                for st in $default_subtarget; do
                    subtargets+=("$st")
                done
            else
                subtargets+=("generic")
            fi
        fi
    fi
    
    printf '%s\n' "${subtargets[@]}" | sort -u 2>/dev/null || echo ""
}

# æå–å­å¹³å°çš„æ•°å­—ç³»åˆ—ï¼ˆå¦‚ä»7981æå–798ï¼‰
extract_series_number() {
    local subtarget="$1"
    # æå–æ•°å­—éƒ¨åˆ†
    local numbers=$(echo "$subtarget" | grep -oE '[0-9]+' | head -1)
    if [ -n "$numbers" ] && [ ${#numbers} -ge 3 ]; then
        # å–å‰ä¸‰ä½ä½œä¸ºç³»åˆ—å·ï¼ˆå¦‚7981 -> 798ï¼‰
        echo "${numbers:0:3}"
    else
        echo ""
    fi
}

# æ£€æŸ¥å­å¹³å°æ˜¯å¦åŒ¹é…ç³»åˆ—æ¨¡å¼
match_series_pattern() {
    local target_subtarget="$1"
    local candidate_subtarget="$2"
    
    # ç²¾ç¡®åŒ¹é…
    if [ "$target_subtarget" = "$candidate_subtarget" ]; then
        return 0
    fi
    
    # æå–æ•°å­—ç³»åˆ—
    local target_series=$(extract_series_number "$target_subtarget")
    local candidate_series=$(extract_series_number "$candidate_subtarget")
    
    # å¦‚æœéƒ½æœ‰æ•°å­—ç³»åˆ—ä¸”ç›¸åŒ
    if [ -n "$target_series" ] && [ -n "$candidate_series" ] && [ "$target_series" = "$candidate_series" ]; then
        return 0
    fi
    
    # æ£€æŸ¥æ˜¯å¦åŒ…å«é€šé…ç¬¦æ¨¡å¼ï¼ˆå¦‚ mt7981 åŒ¹é… mt798*ï¼‰
    if [[ "$candidate_subtarget" == *"*"* ]]; then
        local pattern=$(echo "$candidate_subtarget" | sed 's/\*/.*/g')
        if [[ "$target_subtarget" =~ $pattern ]]; then
            return 0
        fi
    fi
    
    # æ£€æŸ¥é€šç”¨ç³»åˆ—ï¼ˆå¦‚ filogic åŒ…å« 7981ã€7986 ç­‰ï¼‰
    case "$candidate_subtarget" in
        filogic)
            if [[ "$target_subtarget" =~ ^(filogic|mt7981|mt7986|mt7988|mt798x)$ ]]; then
                return 0
            fi
            ;;
        mt798x)
            if [[ "$target_subtarget" =~ ^(mt7981|mt7986|mt7988|mt798x)$ ]]; then
                return 0
            fi
            ;;
        ipq40xx)
            if [[ "$target_subtarget" =~ ^(ipq40xx|ipq4018|ipq4019|ipq4028|ipq4029)$ ]]; then
                return 0
            fi
            ;;
        ipq807x)
            if [[ "$target_subtarget" =~ ^(ipq807x|ipq8071|ipq8072|ipq8074)$ ]]; then
                return 0
            fi
            ;;
        bcm53xx)
            if [[ "$target_subtarget" =~ ^(bcm53xx|bcm4708|bcm4709|bcm47189)$ ]]; then
                return 0
            fi
            ;;
    esac
    
    return 1
}

# è·å–æŒ‡å®šå¹³å°/å­å¹³å°ä¸‹çš„æ‰€æœ‰è®¾å¤‡ï¼ˆæ”¯æŒç³»åˆ—åŒ¹é…ï¼‰
get_devices_by_subtarget() {
    local branch="$1"
    local platform="$2"
    local subtarget="$3"
    local match_type="${4:-all}"  # exact, series, wildcard, all
    
    local devices=()
    local exact_devices=()
    local series_devices=()
    local wildcard_devices=()
    
    # å®šä¹‰è¦æœç´¢çš„è·¯å¾„
    local search_paths=()
    
    # 1. ç²¾ç¡®åŒ¹é…è·¯å¾„ï¼ˆå½“å‰å­å¹³å°ï¼‰
    if [ -d "target/linux/$platform/$subtarget" ]; then
        search_paths+=("target/linux/$platform/$subtarget:exact")
    fi
    
    # 2. æŸ¥æ‰¾å¯èƒ½çš„ç³»åˆ—åŒ¹é…è·¯å¾„
    local target_series=$(extract_series_number "$subtarget")
    if [ -n "$target_series" ]; then
        while IFS= read -r candidate_dir; do
            local candidate=$(basename "$candidate_dir")
            local candidate_series=$(extract_series_number "$candidate")
            
            # å¦‚æœç³»åˆ—å·ç›¸åŒä½†ä¸æ˜¯ç²¾ç¡®åŒ¹é…
            if [ -n "$candidate_series" ] && [ "$candidate_series" = "$target_series" ] && \
               [ "$candidate" != "$subtarget" ] && [ -d "$candidate_dir" ]; then
                search_paths+=("$candidate_dir:series")
            fi
        done < <(find "target/linux/$platform" -maxdepth 1 -type d ! -path "target/linux/$platform" 2>/dev/null)
    fi
    
    # 3. æŸ¥æ‰¾é€šé…ç¬¦è·¯å¾„ï¼ˆå¦‚åŒ…å« * çš„ç›®å½•ï¼‰
    while IFS= read -r candidate_dir; do
        local candidate=$(basename "$candidate_dir")
        if [[ "$candidate" == *"*"* ]] && [ -d "$candidate_dir" ]; then
            if match_series_pattern "$subtarget" "$candidate"; then
                search_paths+=("$candidate_dir:wildcard")
            fi
        fi
    done < <(find "target/linux/$platform" -maxdepth 1 -type d ! -path "target/linux/$platform" 2>/dev/null)
    
    # 4. å§‹ç»ˆåŒ…å«å¹³å°æ ¹ç›®å½•
    search_paths+=("target/linux/$platform:generic")
    
    # å»é‡æœç´¢è·¯å¾„
    local unique_paths=()
    local seen_paths=()
    for path_entry in "${search_paths[@]}"; do
        local path="${path_entry%%:*}"
        if [[ ! " ${seen_paths[@]} " =~ " ${path} " ]]; then
            unique_paths+=("$path_entry")
            seen_paths+=("$path")
        fi
    done
    
    # éå†æ‰€æœ‰æœç´¢è·¯å¾„æŸ¥æ‰¾è®¾å¤‡
    for path_entry in "${unique_paths[@]}"; do
        local search_path="${path_entry%%:*}"
        local path_type="${path_entry##*:}"
        
        if [ ! -d "$search_path" ]; then
            continue
        fi
        
        # æ ¹æ®åŒ¹é…ç±»å‹è¿‡æ»¤
        if [ "$match_type" != "all" ]; then
            case "$match_type" in
                exact)   [ "$path_type" != "exact" ] && continue ;;
                series)  [ "$path_type" != "series" ] && continue ;;
                wildcard)[ "$path_type" != "wildcard" ] && continue ;;
            esac
        fi
        
        # æŸ¥æ‰¾æ‰€æœ‰åŒ…å«è®¾å¤‡å®šä¹‰çš„mkæ–‡ä»¶
        while IFS= read -r mk_file; do
            if [ -f "$mk_file" ]; then
                # æŸ¥æ‰¾ Device/ å®šä¹‰
                if grep -q "^define Device/" "$mk_file" 2>/dev/null; then
                    local file_devices=$(grep "^define Device/" "$mk_file" 2>/dev/null | \
                        sed 's/^define Device\///' | cut -d' ' -f1 | sort -u)
                    
                    if [ -n "$file_devices" ]; then
                        while IFS= read -r device; do
                            case "$path_type" in
                                exact)    exact_devices+=("$device") ;;
                                series)   series_devices+=("$device") ;;
                                wildcard) wildcard_devices+=("$device") ;;
                                generic)  [[ ! " ${exact_devices[@]} ${series_devices[@]} ${wildcard_devices[@]} " =~ " ${device} " ]] && \
                                          wildcard_devices+=("$device") ;;
                            esac
                        done <<< "$file_devices"
                    fi
                fi
            fi
        done < <(find "$search_path" -maxdepth 2 -type f -name "*.mk" -o -name "Makefile" 2>/dev/null | sort -u)
    done
    
    # æ ¹æ®è¯·æ±‚çš„åŒ¹é…ç±»å‹è¿”å›ç»“æœ
    case "$match_type" in
        exact)
            printf '%s\n' "${exact_devices[@]}" | sort -u
            ;;
        series)
            printf '%s\n' "${series_devices[@]}" | sort -u
            ;;
        wildcard)
            printf '%s\n' "${wildcard_devices[@]}" | sort -u
            ;;
        all)
            # è¿”å›æ‰€æœ‰è®¾å¤‡ï¼Œä½†æ ‡è®°æ¥æº
            {
                printf '%s\n' "${exact_devices[@]}"
                printf '%s\n' "${series_devices[@]}"
                printf '%s\n' "${wildcard_devices[@]}"
            } | sort -u
            ;;
    esac
}

# è·å–è®¾å¤‡çš„å®Œæ•´æ”¯æŒä¿¡æ¯ï¼ˆåŒ…æ‹¬ç³»åˆ—åŒ¹é…ï¼‰
get_device_full_support() {
    local device_name="$1"
    local platform="$2"
    local subtarget="$3"
    
    local support_info=""
    local match_level="none"  # none, exact, series, wildcard
    
    # æ£€æŸ¥ç²¾ç¡®åŒ¹é…
    local exact_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "exact" 2>/dev/null)
    if echo "$exact_devices" | grep -q "^$device_name$"; then
        match_level="exact"
        support_info="âœ… ç²¾ç¡®åŒ¹é… (å­å¹³å° $subtarget ä¸“ç”¨)"
    fi
    
    # æ£€æŸ¥ç³»åˆ—åŒ¹é…
    if [ "$match_level" = "none" ]; then
        local series_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "series" 2>/dev/null)
        if echo "$series_devices" | grep -q "^$device_name$"; then
            match_level="series"
            support_info="ğŸ”„ ç³»åˆ—åŒ¹é… (é€‚ç”¨äº $subtarget ç³»åˆ—)"
        fi
    fi
    
    # æ£€æŸ¥é€šé…åŒ¹é…
    if [ "$match_level" = "none" ]; then
        local wildcard_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "wildcard" 2>/dev/null)
        if echo "$wildcard_devices" | grep -q "^$device_name$"; then
            match_level="wildcard"
            support_info="ğŸ”— é€šé…åŒ¹é… (é€šè¿‡é€šé…è§„åˆ™)"
        fi
    fi
    
    echo "$match_level|$support_info"
}
#ã€build_firmware_main.sh-37-endã€‘
