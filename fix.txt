#ã€build_firmware_main.sh-99ã€‘
main() {
    local command="$1"
    local arg1="$2"
    local arg2="$3"
    local arg3="$4"
    local arg4="$5"
    local arg5="$6"
    
    # åªåœ¨é¦–æ¬¡è°ƒç”¨ä¸»å‡½æ•°æ—¶åŠ è½½é…ç½®
    if [ -z "$MAIN_CONFIG_LOADED" ]; then
        # æ£€æŸ¥æ˜¯å¦å·²ç»é€šè¿‡è„šæœ¬å¼€å¤´åŠ è½½è¿‡
        if [ -z "$CONFIG_LOADED" ] && [ -f "$REPO_ROOT/build-config.conf" ]; then
            source "$REPO_ROOT/build-config.conf"
            load_build_config
        fi
        export MAIN_CONFIG_LOADED=1
    fi
    
    case "$command" in
        "setup_environment")
            setup_environment
            ;;
        "create_build_dir")
            create_build_dir
            ;;
        "initialize_build_env")
            initialize_build_env "$arg1" "$arg2" "$arg3"
            ;;
        "initialize_compiler_env")
            initialize_compiler_env "$arg1"
            ;;
        "add_turboacc_support")
            add_turboacc_support
            ;;
        "configure_feeds")
            configure_feeds
            ;;
        "install_turboacc_packages")
            install_turboacc_packages
            ;;
        "pre_build_space_check")
            pre_build_space_check
            ;;
        "generate_config")
            generate_config "$arg1"
            ;;
        "verify_usb_config")
            verify_usb_config
            ;;
        "check_usb_drivers_integrity")
            check_usb_drivers_integrity
            ;;
        "apply_config")
            apply_config
            ;;
        "fix_network")
            fix_network
            ;;
        "download_dependencies")
            download_dependencies
            ;;
        "integrate_custom_files")
            integrate_custom_files
            ;;
        "cleanup")
            cleanup
            ;;
        "save_source_code_info")
            save_source_code_info
            ;;
        "verify_compiler_files")
            verify_compiler_files
            ;;
        "check_compiler_invocation")
            check_compiler_invocation
            ;;
        "verify_sdk_directory")
            verify_sdk_directory
            ;;
        "verify_config_files")
            verify_config_files
            ;;
        
        "step05_install_basic_tools")
            workflow_step05_install_basic_tools
            ;;
        "step06_initial_space_check")
            workflow_step06_initial_space_check
            ;;
        "step07_create_build_dir")
            workflow_step07_create_build_dir
            ;;
        "step08_initialize_build_env")
            workflow_step08_initialize_build_env "$arg1" "$arg2" "$arg3"
            ;;
        "step09_download_sdk")
            workflow_step09_download_sdk "$arg1"
            ;;
        "step10_verify_sdk")
            workflow_step10_verify_sdk
            ;;
        "step11_add_turboacc")
            workflow_step11_add_turboacc
            ;;
        "step12_configure_feeds")
            workflow_step12_configure_feeds
            ;;
        "step13_install_turboacc")
            workflow_step13_install_turboacc
            ;;
        "step14_pre_build_space_check")
            workflow_step14_pre_build_space_check
            ;;
        "step15_generate_config")
            workflow_step15_generate_config "$arg1"
            ;;
        "step16_verify_usb")
            workflow_step16_verify_usb
            ;;
        "step17_check_usb_drivers")
            workflow_step17_check_usb_drivers
            ;;
        "step20_fix_network")
            workflow_step20_fix_network
            ;;
        "step21_download_deps")
            workflow_step21_download_deps
            ;;
        "step22_integrate_custom_files")
            workflow_step22_integrate_custom_files
            ;;
        "step23_pre_build_check")
            workflow_step23_pre_build_check
            ;;
        "step25_build_firmware")
            workflow_step25_build_firmware "$arg1"
            ;;
        "step26_check_artifacts")
            workflow_step26_check_artifacts
            ;;
        "step29_post_build_space_check")
            workflow_step29_post_build_space_check
            ;;
        "step30_build_summary")
            workflow_step30_build_summary "$arg1" "$arg2" "$arg3" "$arg4" "$arg5"
            ;;
        
        "search_compiler_files")
            universal_compiler_search "$arg1" "$arg2"
            ;;
        "universal_compiler_search")
            universal_compiler_search "$arg1" "$arg2"
            ;;
        "search_compiler_files_simple")
            search_compiler_files_simple "$arg1" "$arg2"
            ;;
        "intelligent_platform_aware_compiler_search")
            intelligent_platform_aware_compiler_search "$arg1" "$arg2" "$arg3"
            ;;
        
        *)
            log "âŒ æœªçŸ¥å‘½ä»¤: $command"
            echo "å¯ç”¨å‘½ä»¤:"
            echo "  åŸºç¡€å‡½æ•°: setup_environment, create_build_dir, initialize_build_env, etc."
            echo ""
            echo "  å·¥ä½œæµæ­¥éª¤å‘½ä»¤:"
            echo "    step05_install_basic_tools, step06_initial_space_check, step07_create_build_dir"
            echo "    step08_initialize_build_env, step09_download_sdk, step10_verify_sdk"
            echo "    step11_add_turboacc, step12_configure_feeds, step13_install_turboacc"
            echo "    step14_pre_build_space_check, step15_generate_config, step16_verify_usb"
            echo "    step17_check_usb_drivers, step20_fix_network, step21_download_deps"
            echo "    step22_integrate_custom_files, step23_pre_build_check, step25_build_firmware"
            echo "    step26_check_artifacts, step29_post_build_space_check, step30_build_summary"
            exit 1
            ;;
    esac
}

if [ $# -eq 0 ]; then
    echo "é”™è¯¯: éœ€è¦æä¾›å‘½ä»¤å‚æ•°"
    echo "ç”¨æ³•: $0 <å‘½ä»¤> [å‚æ•°1] [å‚æ•°2] [å‚æ•°3] [å‚æ•°4] [å‚æ•°5]"
    echo "ä¾‹å¦‚: $0 step08_initialize_build_env xiaomi_mi-router-4a-100m 23.05 normal"
    exit 1
fi

main "$@"
#ã€build_firmware_main.sh-99-endã€‘

#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    local device_override=$2
    
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    if [ -n "$device_override" ]; then
        DEVICE="$device_override"
        log "ğŸ”§ ä½¿ç”¨è®¾å¤‡è¦†ç›–å‚æ•°: $DEVICE"
    fi
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆåŠ¨æ€æ˜ å°„ç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    if [ -z "$DEVICE" ]; then
        log "âŒ é”™è¯¯: DEVICEå˜é‡ä¸ºç©ºï¼"
        env | grep -E "DEVICE|TARGET|SELECTED" || true
        handle_error "DEVICEå˜é‡æœªè®¾ç½®"
    fi
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # åŠ¨æ€è·å–è®¾å¤‡å¹³å°ä¿¡æ¯
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” ä»support.shè·å–è®¾å¤‡å¹³å°ä¿¡æ¯..."
        local platform_info=$("$SUPPORT_SCRIPT" get-platform "$DEVICE" 2>/dev/null)
        if [ -n "$platform_info" ]; then
            TARGET=$(echo "$platform_info" | awk '{print $1}')
            SUBTARGET=$(echo "$platform_info" | awk '{print $2}')
            log "âœ… ä»support.shè·å–å¹³å°ä¿¡æ¯: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
            save_env
        else
            log "âŒ support.shæ— æ³•è·å–è®¾å¤‡ä¿¡æ¯"
            handle_error "è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥"
        fi
    else
        log "âŒ support.shä¸å­˜åœ¨"
        handle_error "support.shè„šæœ¬ç¼ºå¤±"
    fi
    
    local device_lower="$DEVICE"
    local device_config="CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}"
    
    log "ğŸ”§ è®¾å¤‡é…ç½®å˜é‡: $device_config=y"
    
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
${device_config}=y
EOF
    
    log "ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶å†…å®¹:"
    cat .config
    
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
            log "âœ… åŠ è½½é…ç½®: $(basename "$file")"
        fi
    }
    
    # é€’å½’æœç´¢é…ç½®æ–‡ä»¶
    find_config_file() {
        local pattern=$1
        local search_dir=$2
        find "$search_dir" -type f -name "$pattern" 2>/dev/null | head -1
    }
    
    # åŸºç¡€é…ç½®
    append_config "$CONFIG_DIR/base.config"
    append_config "$CONFIG_DIR/usb-generic.config"
    
    # ç›®æ ‡å¹³å°é…ç½® - é€’å½’æœç´¢æ‰€æœ‰å­ç›®å½•
    local target_config=$(find_config_file "*${TARGET}*.config" "$CONFIG_DIR")
    if [ -n "$target_config" ]; then
        log "ğŸ” æ‰¾åˆ°ç›®æ ‡å¹³å°é…ç½®: $(basename "$target_config")"
        append_config "$target_config"
    else
        log "âš ï¸ æœªæ‰¾åˆ°ç›®æ ‡å¹³å°é…ç½®æ–‡ä»¶: $TARGET.config"
    fi
    
    # ç‰ˆæœ¬é…ç½® - é€’å½’æœç´¢æ‰€æœ‰å­ç›®å½•
    local branch_short="${SELECTED_BRANCH#openwrt-}"
    local version_config=$(find_config_file "*${branch_short}*.config" "$CONFIG_DIR")
    if [ -n "$version_config" ]; then
        log "ğŸ” æ‰¾åˆ°ç‰ˆæœ¬é…ç½®: $(basename "$version_config")"
        append_config "$version_config"
    else
        log "âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬é…ç½®æ–‡ä»¶: $SELECTED_BRANCH.config"
    fi
    
    # è®¾å¤‡é…ç½® - é€’å½’æœç´¢æ‰€æœ‰å­ç›®å½•
    local device_config_file=$(find_config_file "*${DEVICE}*.config" "$CONFIG_DIR")
    if [ -n "$device_config_file" ]; then
        log "ğŸ” æ‰¾åˆ°è®¾å¤‡é…ç½®: $(basename "$device_config_file")"
        append_config "$device_config_file"
    else
        log "âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡é…ç½®æ–‡ä»¶: $DEVICE.config"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/normal.config"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # TCP BBR
    if [ "${ENABLE_TCP_BBR:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        log "âœ… TCP BBRå·²å¯ç”¨"
    fi
    
    # TurboACC
    if [ "$CONFIG_MODE" = "normal" ] && [ "${ENABLE_TURBOACC:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        log "âœ… TurboACCå·²å¯ç”¨"
    fi
    
    # ath10k-ct
    if [ "${FORCE_ATH10K_CT:-true}" = "true" ]; then
        sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        log "âœ… ath10k-cté©±åŠ¨å·²å¼ºåˆ¶å¯ç”¨"
    fi
    
    # ç¬¬ä¸€æ¬¡å»é‡
    log "ğŸ”„ ç¬¬ä¸€æ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # åŠ¨æ€å†…æ ¸é…ç½®æ£€æµ‹
    log "ğŸ” åŠ¨æ€è·å–ç›®æ ‡å¹³å°æ”¯æŒçš„å†…æ ¸é…ç½®..."
    
    local kernel_config_file=""
    local kernel_version=""
    
    for ver in 6.6 6.1 5.15 5.10 5.4; do
        if [ -f "target/linux/$TARGET/config-$ver" ]; then
            kernel_config_file="target/linux/$TARGET/config-$ver"
            kernel_version="$ver"
            break
        fi
    done
    
    if [ -n "$kernel_config_file" ] && [ -f "$kernel_config_file" ]; then
        log "âœ… æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
        
        local usb_configs_file="/tmp/usb_configs_$$.txt"
        grep -E "^(CONFIG_USB|CONFIG_PHY|CONFIG_DWC|CONFIG_XHCI)" "$kernel_config_file" > "$usb_configs_file" 2>/dev/null || true
        
        if [ -s "$usb_configs_file" ]; then
            sort -u "$usb_configs_file" > "$usb_configs_file.sorted"
            local config_count=$(wc -l < "$usb_configs_file.sorted")
            log "æ‰¾åˆ° $config_count ä¸ªUSBç›¸å…³å†…æ ¸é…ç½®"
            
            local added_count=0
            while read line; do
                local config_name=$(echo "$line" | sed 's/^# //g' | cut -d'=' -f1 | cut -d' ' -f1)
                if ! grep -q "^${config_name}=" .config && ! grep -q "^# ${config_name} is not set" .config; then
                    if echo "$line" | grep -q "=y$"; then
                        echo "$line" >> .config
                        added_count=$((added_count + 1))
                    elif echo "$line" | grep -q "is not set"; then
                        echo "$line" >> .config
                        added_count=$((added_count + 1))
                    fi
                fi
            done < "$usb_configs_file.sorted"
            
            log "âœ… æ·»åŠ äº† $added_count ä¸ªæ–°çš„å†…æ ¸é…ç½®"
            rm -f "$usb_configs_file" "$usb_configs_file.sorted"
        fi
    else
        log "âš ï¸ æœªæ‰¾åˆ°ç›®æ ‡å¹³å° $TARGET çš„å†…æ ¸é…ç½®æ–‡ä»¶"
    fi
    
    # ç¬¬ä¸€æ¬¡make defconfig
    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfig..."
    if make defconfig > /tmp/build-logs/defconfig1.log 2>&1; then
        log "âœ… ç¬¬ä¸€æ¬¡ make defconfig æˆåŠŸ"
    else
        log "âŒ ç¬¬ä¸€æ¬¡ make defconfig å¤±è´¥"
        tail -50 /tmp/build-logs/defconfig1.log
        handle_error "ç¬¬ä¸€æ¬¡ä¾èµ–è§£å†³å¤±è´¥"
    fi
    
    # ç¬¬äºŒæ¬¡å»é‡
    log "ğŸ”„ ç¬¬äºŒæ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # ç¬¬äºŒæ¬¡make defconfig
    log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfig..."
    make defconfig > /tmp/build-logs/defconfig2.log 2>&1 || true
    
    # æœ€ç»ˆè®¾å¤‡éªŒè¯ - æ·»åŠ è°ƒè¯•ä¿¡æ¯
    log "ğŸ” æ­£åœ¨éªŒè¯è®¾å¤‡ $device_lower æ˜¯å¦è¢«é€‰ä¸­..."
    
    log "ğŸ“‹ å½“å‰.configä¸­çš„è®¾å¤‡é…ç½®:"
    grep "CONFIG_TARGET_.*DEVICE" .config | head -10 || log "  æœªæ‰¾åˆ°ä»»ä½•è®¾å¤‡é…ç½®"
    
    if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
        log "âœ… ç›®æ ‡è®¾å¤‡å·²æ­£ç¡®å¯ç”¨"
    else
        log "âŒ è®¾å¤‡æœªå¯ç”¨"
        log "æœŸæœ›çš„è®¾å¤‡é…ç½®: CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y"
        log "è¯·æ£€æŸ¥:"
        log "  1. support.shæ˜¯å¦æ­£ç¡®è¿”å›å¹³å°ä¿¡æ¯"
        log "  2. è®¾å¤‡åæ˜¯å¦æ­£ç¡®: $DEVICE"
        log "  3. ç›®æ ‡å¹³å°æ˜¯å¦æ­£ç¡®: $TARGET/$SUBTARGET"
        handle_error "è®¾å¤‡å¯ç”¨å¤±è´¥"
    fi
    
    # é…ç½®ç»Ÿè®¡
    local total_configs=$(wc -l < .config)
    local enabled_packages=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config)
    local module_packages=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config)
    local disabled_packages=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config)
    
    log "ğŸ“Š é…ç½®ç»Ÿè®¡:"
    log "  æ€»é…ç½®è¡Œæ•°: $total_configs"
    log "  å¯ç”¨è½¯ä»¶åŒ…: $enabled_packages"
    log "  æ¨¡å—åŒ–è½¯ä»¶åŒ…: $module_packages"
    log "  ç¦ç”¨è½¯ä»¶åŒ…: $disabled_packages"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘

#ã€build_firmware_main.sh-00.5ã€‘
# åŠ è½½ç»Ÿä¸€é…ç½®æ–‡ä»¶
load_build_config() {
    local config_file="${1:-$REPO_ROOT/build-config.conf}"
    
    # åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œ
    if [ -z "$CONFIG_LOADED" ]; then
        if [ -f "$config_file" ]; then
            log "ğŸ“ åŠ è½½ç»Ÿä¸€é…ç½®æ–‡ä»¶: $config_file"
            source "$config_file"
        else
            log "âš ï¸ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $config_fileï¼Œä½¿ç”¨è„šæœ¬å†…é»˜è®¤å€¼"
        fi
        
        # å¯¼å‡ºæ‰€æœ‰é…ç½®ä¸ºç¯å¢ƒå˜é‡
        export BUILD_DIR LOG_DIR BACKUP_DIR CONFIG_DIR
        export IMMORTALWRT_URL PACKAGES_FEED_URL LUCI_FEED_URL TURBOACC_FEED_URL
        export ENABLE_TURBOACC ENABLE_TCP_BBR FORCE_ATH10K_CT AUTO_FIX_USB_DRIVERS
        export ENABLE_DYNAMIC_KERNEL_DETECTION ENABLE_DYNAMIC_PLATFORM_DRIVERS ENABLE_DYNAMIC_DEVICE_MAPPING
        
        export CONFIG_LOADED=1
        log "âœ… é…ç½®åŠ è½½å®Œæˆ"
    fi
}

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
CONFIG_FILE="$REPO_ROOT/build-config.conf"

# åªåœ¨é¦–æ¬¡åŠ è½½ä¸”æœªé€šè¿‡ä¸»å‡½æ•°åŠ è½½æ—¶æ‰§è¡Œ
if [ -z "$CONFIG_LOADED" ] && [ -z "$MAIN_CONFIG_LOADED" ] && [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
    load_build_config
fi
#ã€build_firmware_main.sh-00.5-endã€‘
