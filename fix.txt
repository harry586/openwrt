#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    
    # åˆ›å»º artifacts ç›®å½•
    ARTIFACTS_DIR="$REPO_ROOT/artifacts/step15-logs"
    mkdir -p "$ARTIFACTS_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # ---------- ç¬¬ä¸€éƒ¨åˆ†ï¼šç”ŸæˆåŸºç¡€é…ç½® ----------
    log "ğŸ”§ æ­¥éª¤1: ç”ŸæˆåŸºç¡€ç›®æ ‡é…ç½®"
    
    # å…ˆå†™å…¥åŸºç¡€ç›®æ ‡ï¼Œè®© make defconfig ç”Ÿæˆå®Œæ•´é…ç½®
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
EOF
    
    # è¿è¡Œ defconfig ç”Ÿæˆå®Œæ•´é…ç½®
    make defconfig > /dev/null 2>&1 || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    # ---------- ç¬¬äºŒéƒ¨åˆ†ï¼šè®¾å¤‡é€‰æ‹© ----------
    log "ğŸ” æ­¥éª¤2: è®¾å¤‡é€‰æ‹©"
    
    # ä»ç”Ÿæˆçš„ .config ä¸­æå–æ‰€æœ‰å¯ç”¨çš„è®¾å¤‡é€‰é¡¹
    local available_devices=$(grep -E '^CONFIG_TARGET_DEVICE_.*=' .config | sed -E 's/^CONFIG_TARGET_DEVICE_//' | sed 's/=.*$//' | sort -u)
    
    if [ -z "$available_devices" ]; then
        log "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•å¯ç”¨è®¾å¤‡"
        log "ğŸ“‹ å½“å‰ .config ä¸­çš„è®¾å¤‡é…ç½®:"
        grep -E "CONFIG_TARGET_DEVICE_" .config | head -20 | sed 's/^/   /'
        handle_error "æ— å¯ç”¨è®¾å¤‡"
    fi
    
    log "ğŸ“‹ å¯ç”¨è®¾å¤‡åˆ—è¡¨:"
    echo "$available_devices" | sed 's/^/   /'
    
    # å°è¯•åŒ¹é…ç”¨æˆ·æŒ‡å®šçš„è®¾å¤‡
    local matched_device=""
    local user_device_lower=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]')
    
    while IFS= read -r avail; do
        avail_lower=$(echo "$avail" | tr '[:upper:]' '[:lower:]')
        if [ "$avail_lower" = "$user_device_lower" ]; then
            matched_device="$avail"
            break
        fi
    done <<< "$available_devices"
    
    if [ -n "$matched_device" ]; then
        DEVICE="$matched_device"
        log "âœ… åŒ¹é…åˆ°è®¾å¤‡: $DEVICE"
    else
        # å¦‚æœåŒ¹é…ä¸åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªè®¾å¤‡
        DEVICE=$(echo "$available_devices" | head -1)
        log "âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡ $DEVICEï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨è®¾å¤‡: $DEVICE"
    fi
    
    # é‡æ–°ç”Ÿæˆå¸¦è®¾å¤‡é€‰é¡¹çš„é…ç½®
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    make defconfig || handle_error "è®¾å¤‡é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… è®¾å¤‡é…ç½®å®Œæˆ"
    
    # ---------- ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆå¹¶é…ç½®æ–‡ä»¶ ----------
    log "ğŸ“ æ­¥éª¤3: åˆå¹¶é…ç½®æ–‡ä»¶"
    
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
        fi
    }
    
    append_config "$CONFIG_DIR/base.config"
    append_config "$CONFIG_DIR/usb-generic.config"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/normal.config"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # TCP BBR
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    # TurboACC
    if [ "$CONFIG_MODE" = "normal" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # ath10k å†²çªè§£å†³ï¼ˆipq40xx å¹³å°éœ€è¦ï¼‰
    if [ "$TARGET" = "ipq40xx" ]; then
        sed -i '/CONFIG_PACKAGE_kmod-ath10k/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers/d' .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
    fi
    
    # ---------- ç¬¬å››éƒ¨åˆ†ï¼šå¼ºåˆ¶å¯ç”¨ USB é©±åŠ¨ ----------
    log "ğŸ”§ æ­¥éª¤4: å¼ºåˆ¶å¯ç”¨ USB é©±åŠ¨"
    
    # åŸºç¡€ USB é©±åŠ¨
    local USB_PACKAGES=(
        "kmod-usb-core"
        "kmod-usb-common"
        "kmod-usb2"
        "kmod-usb3"
        "kmod-usb-xhci-hcd"
        "kmod-usb-xhci-pci"
        "kmod-usb-xhci-plat-hcd"
        "kmod-usb-storage"
        "kmod-scsi-core"
        "block-mount"
        "automount"
        "usbutils"
        "lsusb"
    )
    
    # å¹³å°ç‰¹å®šé©±åŠ¨
    case "$TARGET" in
        ipq40xx)
            USB_PACKAGES+=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-of-simple"
                "kmod-usb-dwc3-qcom"
                "kmod-phy-qcom-dwc3"
            )
            ;;
        mediatek)
            USB_PACKAGES+=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-of-simple"
                "kmod-usb-dwc3-mediatek"
                "kmod-phy-mediatek"
            )
            ;;
    esac
    
    for pkg in "${USB_PACKAGES[@]}"; do
        sed -i "/^CONFIG_PACKAGE_${pkg}=/d" .config
        sed -i "/^# CONFIG_PACKAGE_${pkg} is not set/d" .config
        echo "CONFIG_PACKAGE_${pkg}=y" >> .config
    done
    
    log "âœ… å·²å¼ºåˆ¶æ·»åŠ  ${#USB_PACKAGES[@]} ä¸ª USB é©±åŠ¨"
    
    # ---------- ç¬¬äº”éƒ¨åˆ†ï¼šå»é‡å’Œä¾èµ–è§£å†³ ----------
    log "ğŸ”„ æ­¥éª¤5: è§£å†³ä¾èµ–å…³ç³»"
    
    # å»é‡
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # è¿è¡Œ oldconfig
    yes "" | make oldconfig > /tmp/build-logs/oldconfig.log 2>&1 || {
        log "âŒ make oldconfig å¤±è´¥"
        tail -20 /tmp/build-logs/oldconfig.log
        cp /tmp/build-logs/oldconfig.log "$ARTIFACTS_DIR/" 2>/dev/null || true
        handle_error "ä¾èµ–è§£å†³å¤±è´¥"
    }
    
    # ---------- ç¬¬å…­éƒ¨åˆ†ï¼šéªŒè¯ç»“æœ ----------
    log "ğŸ” æ­¥éª¤6: éªŒè¯é…ç½®ç»“æœ"
    
    # éªŒè¯è®¾å¤‡
    if grep -q "^CONFIG_TARGET_DEVICE_.*${DEVICE}=y" .config; then
        log "âœ… è®¾å¤‡å·²é€‰ä¸­: $DEVICE"
    else
        log "âš ï¸ è®¾å¤‡æœªé€‰ä¸­ï¼Œå½“å‰å·²é€‰ä¸­çš„è®¾å¤‡:"
        grep -E "^CONFIG_TARGET_DEVICE_.*=y" .config | head -5 | sed 's/^/   /'
    fi
    
    # éªŒè¯ USB é©±åŠ¨
    local missing_drivers=()
    for pkg in "${USB_PACKAGES[@]}"; do
        if ! grep -q "^CONFIG_PACKAGE_${pkg}=y" .config; then
            missing_drivers+=("$pkg")
        fi
    done
    
    if [ ${#missing_drivers[@]} -eq 0 ]; then
        log "âœ… æ‰€æœ‰ USB é©±åŠ¨å·²å¯ç”¨"
    else
        log "âš ï¸ ä»¥ä¸‹é©±åŠ¨æœªå¯ç”¨ï¼ˆå¯èƒ½å†…æ ¸ä¸æ”¯æŒï¼‰:"
        printf "   %s\n" "${missing_drivers[@]}" | head -10
        echo "${missing_drivers[@]}" >> "$ARTIFACTS_DIR/missing-deps.txt"
    fi
    
    # ä¿å­˜æœ€ç»ˆé…ç½®
    cp .config "$ARTIFACTS_DIR/config-final" 2>/dev/null || true
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆï¼Œæœ€ç»ˆè®¾å¤‡: $DEVICE"
}
#ã€build_firmware_main.sh-13-endã€‘
