#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆå®Œæ•´ä¿®å¤ç‰ˆï¼‰==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    cp .config .config.base
    
    if [ -f "scripts/config" ]; then
        log "ğŸ”§ ä½¿ç”¨scripts/configå·¥å…·åˆå¹¶é…ç½®..."
        
        if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
            log "ğŸ“ åº”ç”¨USBé€šç”¨é…ç½®..."
            while IFS= read -r line || [ -n "$line" ]; do
                line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
                [ -z "$line" ] && continue
                
                if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                    config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                    ./scripts/config --enable "$config_name"
                elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                    config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                    ./scripts/config --module "$config_name"
                elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                    config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                    ./scripts/config --disable "$config_name"
                fi
            done < "$CONFIG_DIR/usb-generic.config"
            log "âœ… USBé€šç”¨é…ç½®åº”ç”¨å®Œæˆ"
        fi
        
        if [ -f "$CONFIG_DIR/base.config" ]; then
            log "ğŸ“ åº”ç”¨åŸºç¡€é…ç½®..."
            while IFS= read -r line || [ -n "$line" ]; do
                line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
                [ -z "$line" ] && continue
                
                if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                    config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                    ./scripts/config --enable "$config_name"
                elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                    config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                    ./scripts/config --module "$config_name"
                elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                    config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                    ./scripts/config --disable "$config_name"
                fi
            done < "$CONFIG_DIR/base.config"
            log "âœ… åŸºç¡€é…ç½®åº”ç”¨å®Œæˆ"
        fi
        
        local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
        if [ -f "$device_config_file" ]; then
            log "ğŸ“ åº”ç”¨è®¾å¤‡é…ç½®: $DEVICE.config..."
            while IFS= read -r line || [ -n "$line" ]; do
                line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
                [ -z "$line" ] && continue
                
                if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                    config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                    ./scripts/config --enable "$config_name"
                elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                    config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                    ./scripts/config --module "$config_name"
                elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                    config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                    ./scripts/config --disable "$config_name"
                fi
            done < "$device_config_file"
            log "âœ… è®¾å¤‡é…ç½®åº”ç”¨å®Œæˆ"
        elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
            log "ğŸ“ åº”ç”¨æ­£å¸¸æ¨¡å¼é…ç½®..."
            while IFS= read -r line || [ -n "$line" ]; do
                line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
                [ -z "$line" ] && continue
                
                if echo "$line" | grep -q "luci-app-turboacc\|kmod-shortcut-fe\|kmod-fast-classifier"; then
                    continue
                fi
                
                if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                    config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                    ./scripts/config --enable "$config_name"
                elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                    config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                    ./scripts/config --module "$config_name"
                elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                    config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                    ./scripts/config --disable "$config_name"
                fi
            done < "$CONFIG_DIR/normal.config"
            log "âœ… æ­£å¸¸æ¨¡å¼é…ç½®åº”ç”¨å®Œæˆ"
        fi
        
        local platform_config=""
        if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
            platform_config="$CONFIG_DIR/devices/$TARGET.config"
        else
            platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
        fi
        
        if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
            log "ğŸ“ åº”ç”¨å¹³å°é…ç½®: $(basename "$platform_config")..."
            while IFS= read -r line || [ -n "$line" ]; do
                line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
                [ -z "$line" ] && continue
                
                if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                    config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                    ./scripts/config --enable "$config_name"
                elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                    config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                    ./scripts/config --module "$config_name"
                elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                    config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                    ./scripts/config --disable "$config_name"
                fi
            done < "$platform_config"
            log "âœ… å¹³å°é…ç½®åº”ç”¨å®Œæˆ"
        fi
        
        if [ -n "$extra_packages" ]; then
            log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
            echo "$extra_packages" | tr ',' '\n' | while read pkg; do
                if [ -n "$pkg" ]; then
                    ./scripts/config --enable "PACKAGE_$pkg"
                    log "âœ… æ·»åŠ åŒ…: $pkg"
                fi
            done
        fi
        
        log "ğŸ”§ å¼ºåˆ¶å¯ç”¨å…³é”®é…ç½®..."
        ./scripts/config --enable PACKAGE_kmod-usb-xhci-hcd
        ./scripts/config --enable PACKAGE_kmod-usb3
        ./scripts/config --enable PACKAGE_kmod-tcp-bbr
        ./scripts/config --set-str DEFAULT_TCP_CONG "bbr"
        
        if [ "$CONFIG_MODE" = "normal" ]; then
            ./scripts/config --enable PACKAGE_luci-app-turboacc
            ./scripts/config --enable PACKAGE_kmod-shortcut-fe
            ./scripts/config --enable PACKAGE_kmod-fast-classifier
            log "âœ… TurboACCé…ç½®å¼ºåˆ¶å¯ç”¨å®Œæˆ"
        fi
        
        ./scripts/config --disable PACKAGE_kmod-ath10k
        ./scripts/config --disable PACKAGE_kmod-ath10k-pci
        ./scripts/config --disable PACKAGE_kmod-ath10k-smallbuffers
        ./scripts/config --disable PACKAGE_kmod-ath10k-ct-smallbuffers
        ./scripts/config --enable PACKAGE_kmod-ath10k-ct
        log "âœ… ath10kå†²çªä¿®å¤å®Œæˆ"
        
    else
        log "âŒ scripts/configå·¥å…·ä¸å­˜åœ¨ï¼Œæ— æ³•å®‰å…¨åˆå¹¶é…ç½®"
        log "âš ï¸ å°è¯•ç¼–è¯‘scripts/configå·¥å…·..."
        make scripts/config || handle_error "æ— æ³•ç”Ÿæˆscripts/configå·¥å…·"
        generate_config "$extra_packages"
        return
    fi
    
    log "ğŸ”„ è¿è¡Œæœ€ç»ˆ make defconfig..."
    make defconfig || handle_error "æœ€ç»ˆé…ç½®åº”ç”¨å¤±è´¥"
    
    log "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•..."
    if grep -q "^[[:space:]]" .config; then
        log "âš ï¸ å‘ç°è¡Œé¦–ç©ºæ ¼ï¼Œæ­£åœ¨ä¿®å¤..."
        sed -i 's/^[[:space:]]*//' .config
    fi
    
    if ! make defconfig > /dev/null 2>&1; then
        handle_error "é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯"
    fi
    log "âœ… é…ç½®æ–‡ä»¶è¯­æ³•éªŒè¯é€šè¿‡"
    
    log "ğŸ“Š é…ç½®ç”Ÿæˆç»Ÿè®¡:"
    log "  - æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "  - é…ç½®è¡Œæ•°: $(wc -l < .config)"
    log "  - é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘

#ã€build_firmware_main.sh-31ã€‘
workflow_step15_generate_config() {
    local extra_packages="$1"
    
    log "=== æ­¥éª¤15: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆä¿®å¤ç‰ˆï¼‰==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤15 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    generate_config "$extra_packages"
    
    if [ $? -ne 0 ]; then
        echo "âŒ é”™è¯¯: æ™ºèƒ½é…ç½®ç”Ÿæˆå¤±è´¥"
        exit 1
    fi
    
    log "âœ… æ­¥éª¤15 å®Œæˆ"
}
#ã€build_firmware_main.sh-31-endã€‘

#ã€build_firmware_main.sh-99ã€‘
main() {
    local command="$1"
    local arg1="$2"
    local arg2="$3"
    local arg3="$4"
    local arg4="$5"
    local arg5="$6"
    
    case "$command" in
        "setup_environment")
            setup_environment
            ;;
        "create_build_dir")
            create_build_dir
            ;;
        "initialize_build_env")
            initialize_build_env "$arg1" "$arg2" "$arg3"
            ;;
        "initialize_compiler_env")
            initialize_compiler_env "$arg1"
            ;;
        "add_turboacc_support")
            add_turboacc_support
            ;;
        "configure_feeds")
            configure_feeds
            ;;
        "install_turboacc_packages")
            install_turboacc_packages
            ;;
        "pre_build_space_check")
            pre_build_space_check
            ;;
        "generate_config")
            generate_config "$arg1"
            ;;
        "verify_usb_config")
            verify_usb_config
            ;;
        "check_usb_drivers_integrity")
            check_usb_drivers_integrity
            ;;
        "apply_config")
            apply_config
            ;;
        "fix_network")
            fix_network
            ;;
        "download_dependencies")
            download_dependencies
            ;;
        "integrate_custom_files")
            integrate_custom_files
            ;;
        "cleanup")
            cleanup
            ;;
        "save_source_code_info")
            save_source_code_info
            ;;
        "verify_compiler_files")
            verify_compiler_files
            ;;
        "check_compiler_invocation")
            check_compiler_invocation
            ;;
        "verify_sdk_directory")
            verify_sdk_directory
            ;;
        "verify_config_files")
            verify_config_files
            ;;
        
        "step05_install_basic_tools")
            workflow_step05_install_basic_tools
            ;;
        "step06_initial_space_check")
            workflow_step06_initial_space_check
            ;;
        "step07_create_build_dir")
            workflow_step07_create_build_dir
            ;;
        "step08_initialize_build_env")
            workflow_step08_initialize_build_env "$arg1" "$arg2" "$arg3"
            ;;
        "step09_download_sdk")
            workflow_step09_download_sdk "$arg1"
            ;;
        "step10_verify_sdk")
            workflow_step10_verify_sdk
            ;;
        "step11_add_turboacc")
            workflow_step11_add_turboacc
            ;;
        "step12_configure_feeds")
            workflow_step12_configure_feeds
            ;;
        "step13_install_turboacc")
            workflow_step13_install_turboacc
            ;;
        "step14_pre_build_space_check")
            workflow_step14_pre_build_space_check
            ;;
        "step15_generate_config")
            workflow_step15_generate_config "$arg1"
            ;;
        "step16_verify_usb")
            workflow_step16_verify_usb
            ;;
        "step17_check_usb_drivers")
            workflow_step17_check_usb_drivers
            ;;
        "step20_fix_network")
            workflow_step20_fix_network
            ;;
        "step21_download_deps")
            workflow_step21_download_deps
            ;;
        "step22_integrate_custom_files")
            workflow_step22_integrate_custom_files
            ;;
        "step23_pre_build_check")
            workflow_step23_pre_build_check
            ;;
        "step25_build_firmware")
            workflow_step25_build_firmware "$arg1"
            ;;
        "step26_check_artifacts")
            workflow_step26_check_artifacts
            ;;
        "step29_post_build_space_check")
            workflow_step29_post_build_space_check
            ;;
        "step30_build_summary")
            workflow_step30_build_summary "$arg1" "$arg2" "$arg3" "$arg4" "$arg5"
            ;;
        
        "search_compiler_files")
            universal_compiler_search "$arg1" "$arg2"
            ;;
        "universal_compiler_search")
            universal_compiler_search "$arg1" "$arg2"
            ;;
        "search_compiler_files_simple")
            search_compiler_files_simple "$arg1" "$arg2"
            ;;
        "intelligent_platform_aware_compiler_search")
            intelligent_platform_aware_compiler_search "$arg1" "$arg2" "$arg3"
            ;;
        
        *)
            log "âŒ æœªçŸ¥å‘½ä»¤: $command"
            echo "å¯ç”¨å‘½ä»¤:"
            echo "  åŸºç¡€å‡½æ•°: setup_environment, create_build_dir, initialize_build_env, etc."
            echo ""
            echo "  å·¥ä½œæµæ­¥éª¤å‘½ä»¤:"
            echo "    step05_install_basic_tools, step06_initial_space_check, step07_create_build_dir"
            echo "    step08_initialize_build_env, step09_download_sdk, step10_verify_sdk"
            echo "    step11_add_turboacc, step12_configure_feeds, step13_install_turboacc"
            echo "    step14_pre_build_space_check, step15_generate_config, step16_verify_usb"
            echo "    step17_check_usb_drivers, step20_fix_network, step21_download_deps"
            echo "    step22_integrate_custom_files, step23_pre_build_check, step25_build_firmware"
            echo "    step26_check_artifacts, step29_post_build_space_check, step30_build_summary"
            exit 1
            ;;
    esac
}

if [ $# -eq 0 ]; then
    echo "é”™è¯¯: éœ€è¦æä¾›å‘½ä»¤å‚æ•°"
    echo "ç”¨æ³•: $0 <å‘½ä»¤> [å‚æ•°1] [å‚æ•°2] [å‚æ•°3] [å‚æ•°4] [å‚æ•°5]"
    echo "ä¾‹å¦‚: $0 step08_initialize_build_env xiaomi_mi-router-4a-100m 23.05 normal"
    exit 1
fi

main "$@"
#ã€build_firmware_main.sh-99-endã€‘
