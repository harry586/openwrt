#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆå¼ºåˆ¶å¯ç”¨USBä¾èµ–ï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # æ­¥éª¤1: åˆ›å»ºåŸºç¡€ç›®æ ‡é…ç½®
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    # æ­¥éª¤2: ç›´æ¥åˆå¹¶æ‰€æœ‰USBé…ç½®ï¼ˆç¡®ä¿æ‰€æœ‰ä¾èµ–é¡¹éƒ½æ˜ç¡®å¯ç”¨ï¼‰
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    # åŸºç¡€é…ç½®
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "ğŸ“ åˆå¹¶åŸºç¡€é…ç½®: base.config..."
        # ç§»é™¤æ³¨é‡Šè¡Œï¼Œåªä¿ç•™æœ‰æ•ˆçš„CONFIGè¡Œ
        grep -v "^#" "$CONFIG_DIR/base.config" | grep "CONFIG_" >> .config
    fi
    
    # USBé€šç”¨é…ç½®ï¼ˆåŒ…å«å®Œæ•´çš„USBé©±åŠ¨é“¾ï¼‰
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "ğŸ“ åˆå¹¶USBé€šç”¨é…ç½®: usb-generic.config..."
        grep -v "^#" "$CONFIG_DIR/usb-generic.config" | grep "CONFIG_" >> .config
    fi
    
    # å¹³å°ä¸“ç”¨é…ç½®ï¼ˆå¦‚ipq40xx.configã€ramips.configç­‰ï¼‰
    local platform_config="$CONFIG_DIR/$TARGET.config"
    if [ -f "$platform_config" ]; then
        log "ğŸ“ åˆå¹¶å¹³å°é…ç½®: $TARGET.config..."
        grep -v "^#" "$platform_config" | grep "CONFIG_" >> .config
    fi
    
    # ç‰ˆæœ¬ä¸“ç”¨é…ç½®
    local version_config="$CONFIG_DIR/$SELECTED_BRANCH.config"
    if [ -f "$version_config" ]; then
        log "ğŸ“ åˆå¹¶ç‰ˆæœ¬é…ç½®: $SELECTED_BRANCH.config..."
        grep -v "^#" "$version_config" | grep "CONFIG_" >> .config
    fi
    
    # è®¾å¤‡ä¸“ç”¨é…ç½®
    local device_config="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config" ]; then
        log "ğŸ“ åˆå¹¶è®¾å¤‡é…ç½®: $DEVICE.config..."
        grep -v "^#" "$device_config" | grep "CONFIG_" >> .config
    fi
    
    # æ­£å¸¸æ¨¡å¼é…ç½®
    if [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "ğŸ“ åˆå¹¶æ­£å¸¸æ¨¡å¼é…ç½®: normal.config..."
        grep -v "^#" "$CONFIG_DIR/normal.config" | grep "CONFIG_" >> .config
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            if [ -n "$pkg" ]; then
                echo "CONFIG_PACKAGE_$pkg=y" >> .config
            fi
        done
    fi
    
    # TCP BBR
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    # TurboACCï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰
    if [ "$CONFIG_MODE" = "normal" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # ath10k å†²çªè§£å†³
    sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
    echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
    echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
    
    # æ­¥éª¤3: å»é‡
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤4: å†æ¬¡è¿è¡Œ defconfig è§£å†³ä¾èµ–ï¼ˆæ­¤æ—¶æ‰€æœ‰USBé€‰é¡¹å·²å¼ºåˆ¶å†™å…¥ï¼‰
    log "ğŸ”„ è¿è¡Œ make defconfig è§£å†³ä¾èµ–å…³ç³»..."
    make defconfig || handle_error "ä¾èµ–è§£å†³å¤±è´¥"
    
    # æ­¥éª¤5: åå¤„ç†å¼ºåˆ¶å¯ç”¨å…³é”®USBé©±åŠ¨ï¼ˆé˜²æ­¢è¢«ä¾èµ–ç³»ç»Ÿå†æ¬¡ç¦ç”¨ï¼‰
    log "ğŸ”§ åå¤„ç†ï¼šå¼ºåˆ¶å¯ç”¨å…³é”®USBé©±åŠ¨..."
    
    # å®šä¹‰éœ€è¦å¼ºåˆ¶å¯ç”¨çš„é©±åŠ¨åˆ—è¡¨ï¼ˆæŒ‰å¹³å°ï¼‰
    local MUST_ENABLE=(
        "kmod-usb-core"
        "kmod-usb-common"
        "kmod-usb2"
        "kmod-usb-ehci"
        "kmod-usb-ohci"
        "kmod-usb-xhci-hcd"
        "kmod-usb3"
        "kmod-usb-storage"
        "kmod-scsi-core"
    )
    
    # å¹³å°ç‰¹å®šé©±åŠ¨
    case "$TARGET" in
        ipq40xx)
            MUST_ENABLE+=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-of-simple"
                "kmod-usb-dwc3-qcom"
                "kmod-phy-qcom-dwc3"
            )
            ;;
        ramips)
            MUST_ENABLE+=(
                "kmod-usb-xhci-mtk"
                "kmod-usb-ohci-pci"
                "kmod-usb2-pci"
            )
            ;;
        mediatek)
            MUST_ENABLE+=(
                "kmod-usb-dwc3-mediatek"
                "kmod-phy-mediatek"
            )
            ;;
        ath79)
            MUST_ENABLE+=(
                "kmod-usb2-ath79"
            )
            ;;
    esac
    
    # é€ä¸ªå¼ºåˆ¶å¯ç”¨
    for driver in "${MUST_ENABLE[@]}"; do
        # åˆ é™¤å¯èƒ½å­˜åœ¨çš„ç¦ç”¨è¡Œ
        sed -i "/^# CONFIG_PACKAGE_${driver} is not set/d" .config
        sed -i "/^CONFIG_PACKAGE_${driver}=m/d" .config
        # å¦‚æœä¸å­˜åœ¨å¯ç”¨è¡Œï¼Œåˆ™æ·»åŠ 
        if ! grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "CONFIG_PACKAGE_${driver}=y" >> .config
            log "  âœ… å¼ºåˆ¶å¯ç”¨: $driver"
        fi
    done
    
    # å†æ¬¡è¿è¡Œ defconfig ä½¿å¼ºåˆ¶å¯ç”¨çš„é©±åŠ¨ç”Ÿæ•ˆ
    log "ğŸ”„ å†æ¬¡è¿è¡Œ make defconfig åº”ç”¨å¼ºåˆ¶é…ç½®..."
    make defconfig || handle_error "å¼ºåˆ¶é…ç½®åº”ç”¨å¤±è´¥"
    
    # æœ€ç»ˆéªŒè¯
    log "ğŸ“‹ å…³é”®USBé©±åŠ¨çŠ¶æ€éªŒè¯:"
    local missing=()
    for driver in "${MUST_ENABLE[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "  âœ… $driver: å·²å¯ç”¨"
        else
            log "  âŒ $driver: æœªå¯ç”¨"
            missing+=("$driver")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        log "âš ï¸ è­¦å‘Š: ä»¥ä¸‹é©±åŠ¨ä»æœªå¯ç”¨: ${missing[*]}"
        log "ğŸ’¡ å¯èƒ½éœ€è¦æ£€æŸ¥å†…æ ¸ä¾èµ–æˆ–å¹³å°æ”¯æŒ"
    else
        log "ğŸ‰ æ‰€æœ‰å…³é”®USBé©±åŠ¨å·²æˆåŠŸå¯ç”¨ï¼"
    fi
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
