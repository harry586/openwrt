#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆç«‹å³é€€å‡ºç‰ˆï¼‰- å¢å¼ºç‰ˆï¼Œè‡ªåŠ¨ä¿®å¤é…ç½®é—®é¢˜ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: SELECTED_BRANCH=$SELECTED_BRANCH, TARGET=$TARGET"
        echo "âœ… COMPILER_DIR=$COMPILER_DIR"
        echo "âœ… CONFIG_MODE=$CONFIG_MODE"
    else
        echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ ($BUILD_DIR/build_env.sh)"
        echo "ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤08å’Œæ­¥éª¤09æ˜¯å¦æˆåŠŸæ‰§è¡Œ"
        exit 1
    fi
    
    cd $BUILD_DIR
    echo "=== ğŸš¨ å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆç«‹å³é€€å‡ºç‰ˆï¼‰- å¢å¼ºç‰ˆ ==="
    
    echo ""
    echo "1. âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    if [ -f ".config" ]; then
        echo "  âœ… .config æ–‡ä»¶å­˜åœ¨"
        echo "  ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
        echo "  ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < .config)"
    else
        echo "  âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨"
        echo "  ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤15æ™ºèƒ½é…ç½®ç”Ÿæˆæ˜¯å¦æˆåŠŸ"
        exit 1
    fi
    
    echo ""
    echo "2. âœ… SDKç›®å½•æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "  âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
        echo "  ğŸ“Š ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | awk '{print $1}' || echo 'æœªçŸ¥')"
        
        GCC_FILE=$(find "$COMPILER_DIR" -type f -executable \
          -name "*gcc" \
          ! -name "*gcc-ar" \
          ! -name "*gcc-ranlib" \
          ! -name "*gcc-nm" \
          ! -path "*dummy-tools*" \
          ! -path "*scripts*" \
          2>/dev/null | head -1)
        
        if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
            echo "  âœ… æ‰¾åˆ°å¯æ‰§è¡ŒGCCç¼–è¯‘å™¨: $(basename "$GCC_FILE")"
            echo "  ğŸ”§ GCCç‰ˆæœ¬: $("$GCC_FILE" --version 2>&1 | head -1)"
        else
            echo "  âŒ é”™è¯¯: SDKç›®å½•ä¸­æœªæ‰¾åˆ°çœŸæ­£çš„GCCç¼–è¯‘å™¨"
            exit 1
        fi
    else
        echo "  âŒ é”™è¯¯: SDKç›®å½•ä¸å­˜åœ¨: $COMPILER_DIR"
        echo "  ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤09 SDKä¸‹è½½æ˜¯å¦æˆåŠŸ"
        exit 1
    fi
    
    echo ""
    echo "3. âœ… Feedsæ£€æŸ¥:"
    if [ -d "feeds" ]; then
        echo "  âœ… feeds ç›®å½•å­˜åœ¨"
        echo "  ğŸ“Š feedsç›®å½•å¤§å°: $(du -sh feeds 2>/dev/null | awk '{print $1}' || echo 'æœªçŸ¥')"
    else
        echo "  âŒ é”™è¯¯: feeds ç›®å½•ä¸å­˜åœ¨"
        echo "  ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤12é…ç½®Feedsæ˜¯å¦æˆåŠŸ"
        exit 1
    fi
    
    echo ""
    echo "4. âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1 | awk '{print $1}')
    AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
    echo "  ğŸ“Š /mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
    
    if [ $AVAILABLE_GB -lt 10 ]; then
        echo "  âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
        exit 1
    elif [ $AVAILABLE_GB -lt 20 ]; then
        echo "  âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
    else
        echo "  âœ… ç£ç›˜ç©ºé—´å……è¶³"
    fi
    
    echo ""
    echo "5. âœ… USBé…ç½®æ£€æŸ¥ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰:"
    USB_FIXED=0
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        echo "  âŒ é”™è¯¯: USB 3.0é©±åŠ¨æœªå¯ç”¨ (kmod-usb-xhci-hcd)"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-usb-xhci-hcd
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb-xhci-hcd"
        else
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb-xhci-hcd"
        fi
        USB_FIXED=1
    else
        echo "  âœ… kmod-usb-xhci-hcd: å·²å¯ç”¨"
    fi
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        echo "  âŒ é”™è¯¯: USB 3.0é©±åŠ¨æœªå¯ç”¨ (kmod-usb3)"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-usb3
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb3"
        else
            echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb3"
        fi
        USB_FIXED=1
    else
        echo "  âœ… kmod-usb3: å·²å¯ç”¨"
    fi
    
    if [ "$TARGET" = "ipq40xx" ]; then
        if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
            echo "  âŒ é”™è¯¯: IPQ40xxå¹³å°é©±åŠ¨æœªå¯ç”¨ (kmod-phy-qcom-dwc3)"
            echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
            if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_kmod-phy-qcom-dwc3
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-phy-qcom-dwc3"
            else
                echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-phy-qcom-dwc3"
            fi
            USB_FIXED=1
        else
            echo "  âœ… kmod-phy-qcom-dwc3: å·²å¯ç”¨"
        fi
    fi
    
    echo ""
    echo "6. âœ… TurboACCé…ç½®æ£€æŸ¥ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰:"
    TURBOACC_FIXED=0
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            echo "  âŒ é”™è¯¯: TurboACCæœªå¯ç”¨ (æ­£å¸¸æ¨¡å¼å¿…éœ€)"
            echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
            if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_luci-app-turboacc
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : luci-app-turboacc"
            else
                echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            fi
            TURBOACC_FIXED=1
        else
            echo "  âœ… luci-app-turboacc: å·²å¯ç”¨"
        fi
    else
        echo "  â„¹ï¸ åŸºç¡€æ¨¡å¼ï¼Œä¸æ£€æŸ¥TurboACCé…ç½®"
    fi
    
    echo ""
    echo "7. âœ… TCP BBRæ‹¥å¡æ§åˆ¶æ£€æŸ¥ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰:"
    BBR_FIXED=0
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
        echo "  âŒ é”™è¯¯: TCP BBRæœªå¯ç”¨"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-tcp-bbr
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-tcp-bbr"
        else
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        BBR_FIXED=1
    else
        echo "  âœ… kmod-tcp-bbr: å·²å¯ç”¨"
    fi
    
    if [ $USB_FIXED -eq 1 ] || [ $TURBOACC_FIXED -eq 1 ] || [ $BBR_FIXED -eq 1 ]; then
        echo ""
        echo "ğŸ”„ é…ç½®å·²ä¿®å¤ï¼Œé‡æ–°è¿è¡Œ make defconfig..."
        make defconfig
        echo "âœ… æ‰€æœ‰é…ç½®ä¿®å¤å®Œæˆ"
    fi
    
    echo ""
    echo "========================================"
    echo "âœ…âœ…âœ… æ‰€æœ‰å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}
#ã€build_firmware_main.sh-37-endã€‘

#ã€build_firmware_main.sh-23ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆç«‹å³é€€å‡ºç‰ˆï¼‰- å¢å¼ºç‰ˆï¼Œè‡ªåŠ¨ä¿®å¤é…ç½®é—®é¢˜ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: SELECTED_BRANCH=$SELECTED_BRANCH, TARGET=$TARGET"
        echo "âœ… COMPILER_DIR=$COMPILER_DIR"
        echo "âœ… CONFIG_MODE=$CONFIG_MODE"
    else
        echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ ($BUILD_DIR/build_env.sh)"
        echo "ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤08å’Œæ­¥éª¤09æ˜¯å¦æˆåŠŸæ‰§è¡Œ"
        exit 1
    fi
    
    cd $BUILD_DIR
    echo "=== ğŸš¨ å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆç«‹å³é€€å‡ºç‰ˆï¼‰- å¢å¼ºç‰ˆ ==="
    
    echo ""
    echo "1. âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    if [ -f ".config" ]; then
        echo "  âœ… .config æ–‡ä»¶å­˜åœ¨"
        echo "  ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
        echo "  ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < .config)"
    else
        echo "  âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨"
        echo "  ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤15æ™ºèƒ½é…ç½®ç”Ÿæˆæ˜¯å¦æˆåŠŸ"
        exit 1
    fi
    
    echo ""
    echo "2. âœ… SDKç›®å½•æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "  âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
        echo "  ğŸ“Š ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | awk '{print $1}' || echo 'æœªçŸ¥')"
        
        GCC_FILE=$(find "$COMPILER_DIR" -type f -executable \
          -name "*gcc" \
          ! -name "*gcc-ar" \
          ! -name "*gcc-ranlib" \
          ! -name "*gcc-nm" \
          ! -path "*dummy-tools*" \
          ! -path "*scripts*" \
          2>/dev/null | head -1)
        
        if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
            echo "  âœ… æ‰¾åˆ°å¯æ‰§è¡ŒGCCç¼–è¯‘å™¨: $(basename "$GCC_FILE")"
            echo "  ğŸ”§ GCCç‰ˆæœ¬: $("$GCC_FILE" --version 2>&1 | head -1)"
        else
            echo "  âŒ é”™è¯¯: SDKç›®å½•ä¸­æœªæ‰¾åˆ°çœŸæ­£çš„GCCç¼–è¯‘å™¨"
            exit 1
        fi
    else
        echo "  âŒ é”™è¯¯: SDKç›®å½•ä¸å­˜åœ¨: $COMPILER_DIR"
        echo "  ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤09 SDKä¸‹è½½æ˜¯å¦æˆåŠŸ"
        exit 1
    fi
    
    echo ""
    echo "3. âœ… Feedsæ£€æŸ¥:"
    if [ -d "feeds" ]; then
        echo "  âœ… feeds ç›®å½•å­˜åœ¨"
        echo "  ğŸ“Š feedsç›®å½•å¤§å°: $(du -sh feeds 2>/dev/null | awk '{print $1}' || echo 'æœªçŸ¥')"
    else
        echo "  âŒ é”™è¯¯: feeds ç›®å½•ä¸å­˜åœ¨"
        echo "  ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤12é…ç½®Feedsæ˜¯å¦æˆåŠŸ"
        exit 1
    fi
    
    echo ""
    echo "4. âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1 | awk '{print $1}')
    AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
    echo "  ğŸ“Š /mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
    
    if [ $AVAILABLE_GB -lt 10 ]; then
        echo "  âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
        exit 1
    elif [ $AVAILABLE_GB -lt 20 ]; then
        echo "  âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
    else
        echo "  âœ… ç£ç›˜ç©ºé—´å……è¶³"
    fi
    
    echo ""
    echo "5. âœ… USBé…ç½®æ£€æŸ¥ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰:"
    USB_FIXED=0
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        echo "  âŒ é”™è¯¯: USB 3.0é©±åŠ¨æœªå¯ç”¨ (kmod-usb-xhci-hcd)"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-usb-xhci-hcd
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb-xhci-hcd"
        else
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb-xhci-hcd"
        fi
        USB_FIXED=1
    else
        echo "  âœ… kmod-usb-xhci-hcd: å·²å¯ç”¨"
    fi
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        echo "  âŒ é”™è¯¯: USB 3.0é©±åŠ¨æœªå¯ç”¨ (kmod-usb3)"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-usb3
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb3"
        else
            echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb3"
        fi
        USB_FIXED=1
    else
        echo "  âœ… kmod-usb3: å·²å¯ç”¨"
    fi
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config; then
        echo "  âŒ é”™è¯¯: USB 2.0é©±åŠ¨æœªå¯ç”¨ (kmod-usb2)"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-usb2
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb2"
        else
            echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb2"
        fi
        USB_FIXED=1
    else
        echo "  âœ… kmod-usb2: å·²å¯ç”¨"
    fi
    
    if [ "$TARGET" = "ipq40xx" ]; then
        if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
            echo "  âŒ é”™è¯¯: IPQ40xxå¹³å°é©±åŠ¨æœªå¯ç”¨ (kmod-phy-qcom-dwc3)"
            echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
            if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_kmod-phy-qcom-dwc3
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-phy-qcom-dwc3"
            else
                echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-phy-qcom-dwc3"
            fi
            USB_FIXED=1
        else
            echo "  âœ… kmod-phy-qcom-dwc3: å·²å¯ç”¨"
        fi
    fi
    
    echo ""
    echo "6. âœ… TurboACCé…ç½®æ£€æŸ¥ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰:"
    TURBOACC_FIXED=0
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            echo "  âŒ é”™è¯¯: TurboACCæœªå¯ç”¨ (æ­£å¸¸æ¨¡å¼å¿…éœ€)"
            echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
            if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_luci-app-turboacc
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : luci-app-turboacc"
            else
                echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            fi
            TURBOACC_FIXED=1
        else
            echo "  âœ… luci-app-turboacc: å·²å¯ç”¨"
        fi
    else
        echo "  â„¹ï¸ åŸºç¡€æ¨¡å¼ï¼Œä¸æ£€æŸ¥TurboACCé…ç½®"
    fi
    
    echo ""
    echo "7. âœ… TCP BBRæ‹¥å¡æ§åˆ¶æ£€æŸ¥ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰:"
    BBR_FIXED=0
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
        echo "  âŒ é”™è¯¯: TCP BBRæœªå¯ç”¨"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-tcp-bbr
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-tcp-bbr"
        else
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        BBR_FIXED=1
    else
        echo "  âœ… kmod-tcp-bbr: å·²å¯ç”¨"
    fi
    
    if ! grep -q '^CONFIG_DEFAULT_TCP_CONG="bbr"' .config; then
        echo "  âŒ é”™è¯¯: TCP BBRæœªè®¾ç½®ä¸ºé»˜è®¤æ‹¥å¡æ§åˆ¶ç®—æ³•"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --set-str DEFAULT_TCP_CONG "bbr"
            echo "  âœ… å·²è®¾ç½®: DEFAULT_TCP_CONG=\"bbr\""
        else
            sed -i '/^CONFIG_DEFAULT_TCP_CONG=/d' .config
            echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        fi
        BBR_FIXED=1
    else
        echo "  âœ… DEFAULT_TCP_CONG=\"bbr\": å·²è®¾ç½®"
    fi
    
    if [ $USB_FIXED -eq 1 ] || [ $TURBOACC_FIXED -eq 1 ] || [ $BBR_FIXED -eq 1 ]; then
        echo ""
        echo "ğŸ”„ é…ç½®å·²ä¿®å¤ï¼Œé‡æ–°è¿è¡Œ make defconfig..."
        make defconfig
        
        echo ""
        echo "ğŸ“‹ ä¿®å¤åé…ç½®çŠ¶æ€:"
        echo "  - kmod-usb2: $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        echo "  - kmod-usb3: $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        echo "  - kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        
        if [ "$TARGET" = "ipq40xx" ]; then
            echo "  - kmod-usb-dwc3-qcom: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-phy-qcom-dwc3: $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        fi
        
        if [ "$CONFIG_MODE" = "normal" ]; then
            echo "  - luci-app-turboacc: $(grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        fi
        
        echo "  - kmod-tcp-bbr: $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        echo "  - DEFAULT_TCP_CONG: $(grep "^CONFIG_DEFAULT_TCP_CONG=" .config | cut -d'"' -f2 || echo 'æœªè®¾ç½®')"
        
        echo "âœ… æ‰€æœ‰é…ç½®ä¿®å¤å®Œæˆ"
    else
        echo ""
        echo "âœ… æ‰€æœ‰é…ç½®æ£€æŸ¥é€šè¿‡ï¼Œæ— éœ€ä¿®å¤"
    fi
    
    echo ""
    echo "========================================"
    echo "âœ…âœ…âœ… æ‰€æœ‰å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}
#ã€build_firmware_main.sh-23-endã€‘

#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…ï¼ˆç»¼åˆä¿®å¤ç‰ˆï¼‰==="
    
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åº”ç”¨é…ç½®"
        return 1
    fi
    
    log "ğŸ“‹ é…ç½®è¯¦æƒ…:"
    log "é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "é…ç½®è¡Œæ•°: $(wc -l < .config)"
    
    local backup_file=".config.bak.$(date +%Y%m%d%H%M%S)"
    cp .config "$backup_file"
    log "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½: $backup_file"
    
    log "ğŸ”§ æ­¥éª¤1: æ ‡å‡†åŒ–é…ç½®æ–‡ä»¶æ ¼å¼..."
    
    if [ -f ".config" ]; then
        awk '
        {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if ($0 ~ /^#/) {
                if ($0 ~ /^#CONFIG_/) {
                    $0 = "# " substr($0, 2)
                }
                if ($0 !~ /is not set$/) {
                    $0 = $0 " is not set"
                }
            }
            if ($0 ~ /^CONFIG_/) {
                if ($0 ~ /y$|m$|=$/) {
                    gsub(/[[:space:]]*=[[:space:]]*y$/, "=y")
                    gsub(/[[:space:]]*=[[:space:]]*m$/, "=m")
                    gsub(/[[:space:]]*=[[:space:]]*$/, "=")
                }
            }
            if (length($0) > 0) {
                print $0
            }
        }' .config > .config.tmp
        
        mv .config.tmp .config
        log "âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ ‡å‡†åŒ–å®Œæˆ"
    else
        log "âŒ .config æ–‡ä»¶åœ¨æ“ä½œè¿‡ç¨‹ä¸­ä¸¢å¤±"
        return 1
    fi
    
    log "ğŸ”§ æ­¥éª¤2: æ¸…ç†é‡å¤é…ç½®è¡Œ..."
    
    local dup_before=$(wc -l < .config)
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    local dup_after=$(wc -l < .config)
    local dup_removed=$((dup_before - dup_after))
    
    if [ $dup_removed -gt 0 ]; then
        log "âœ… å·²åˆ é™¤ $dup_removed ä¸ªå®Œå…¨é‡å¤çš„é…ç½®è¡Œ"
    fi
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    local config_uniq_removed=$((dup_after - $(wc -l < .config)))
    if [ $config_uniq_removed -gt 0 ]; then
        log "âœ… å·²åˆå¹¶ $config_uniq_removed ä¸ªé‡å¤é…ç½®é¡¹"
    fi
    
    log "ğŸ”§ æ­¥éª¤3: æ£€æŸ¥libustreamå†²çª..."
    
    local openssl_enabled=0
    local wolfssl_enabled=0
    
    if grep -q "^CONFIG_PACKAGE_libustream-openssl=y" .config; then
        openssl_enabled=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_libustream-wolfssl=y" .config; then
        wolfssl_enabled=1
    fi
    
    if [ $openssl_enabled -eq 1 ] && [ $wolfssl_enabled -eq 1 ]; then
        log "âš ï¸ å‘ç°libustream-opensslå’Œlibustream-wolfsslå†²çª"
        log "ğŸ”§ ä¿®å¤å†²çª: ç¦ç”¨libustream-openssl"
        
        awk '
        /^CONFIG_PACKAGE_libustream-openssl=y/ {
            print "# CONFIG_PACKAGE_libustream-openssl is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config
        
        log "âœ… å†²çªå·²ä¿®å¤"
    fi
    
    log "ğŸ”§ æ­¥éª¤4: ä½¿ç”¨OpenWrtå®˜æ–¹é…ç½®å·¥å…·å¼ºåˆ¶ä¿®å¤å…³é”®é…ç½®..."
    
    if [ ! -f "scripts/config" ]; then
        log "âš ï¸ scripts/configå·¥å…·ä¸å­˜åœ¨ï¼Œç¼–è¯‘ç”Ÿæˆä¸­..."
        make scripts/config || {
            log "âŒ æ— æ³•ç”Ÿæˆscripts/configå·¥å…·"
            log "âš ï¸ å°†ä½¿ç”¨awkæ–¹å¼è¿›è¡Œä¿®å¤"
        }
    fi
    
    log "  ğŸ”§ USB 3.0é©±åŠ¨ä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-xhci-hcd
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb3
    else
        awk '
        /^# CONFIG_PACKAGE_kmod-usb-xhci-hcd is not set/ {
            print "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
            next
        }
        /^CONFIG_PACKAGE_kmod-usb-xhci-hcd=.*/ {
            print "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config.tmp; then
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config.tmp
        fi
        
        awk '
        /^# CONFIG_PACKAGE_kmod-usb3 is not set/ {
            print "CONFIG_PACKAGE_kmod-usb3=y"
            next
        }
        /^CONFIG_PACKAGE_kmod-usb3=.*/ {
            print "CONFIG_PACKAGE_kmod-usb3=y"
            next
        }
        { print $0 }
        ' .config.tmp > .config
        rm -f .config.tmp
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
            echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        fi
    fi
    log "  âœ… USB 3.0é©±åŠ¨å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        log "  ğŸ”§ IPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨ä¿®å¤..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3-qcom
            ./scripts/config --enable CONFIG_PACKAGE_kmod-phy-qcom-dwc3
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3
        else
            if ! grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config; then
                echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
                echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
            fi
        fi
        log "  âœ… IPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨ä¿®å¤å®Œæˆ"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  ğŸ”§ TurboACCé…ç½®ä¿®å¤..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_luci-app-turboacc
            ./scripts/config --enable CONFIG_PACKAGE_kmod-shortcut-fe
            ./scripts/config --enable CONFIG_PACKAGE_kmod-fast-classifier
        else
            if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
                echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-shortcut-fe=y" .config; then
                echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-fast-classifier=y" .config; then
                echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
            fi
        fi
        log "  âœ… TurboACCé…ç½®ä¿®å¤å®Œæˆ"
    fi
    
    log "  ğŸ”§ TCP BBRæ‹¥å¡æ§åˆ¶ä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-tcp-bbr
        ./scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
    else
        if ! grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        
        awk '!/^CONFIG_DEFAULT_TCP_CONG=/' .config > .config.tmp
        mv .config.tmp .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    fi
    log "  âœ… TCP BBRæ‹¥å¡æ§åˆ¶ä¿®å¤å®Œæˆ"
    
    log "  ğŸ”§ kmod-ath10k-ctå†²çªä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-pci
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-smallbuffers
        ./scripts/config --enable CONFIG_PACKAGE_kmod-ath10k-ct
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers
    else
        awk '
        /^CONFIG_PACKAGE_kmod-ath10k=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-pci=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-pci is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-ath10k-ct=y" .config; then
            echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        fi
    fi
    log "  âœ… kmod-ath10k-ctå†²çªä¿®å¤å®Œæˆ"
    
    log "ğŸ”§ æ­¥éª¤5: æœ€ç»ˆå»é‡å’Œæ ¼å¼æ£€æŸ¥..."
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    awk 'NF > 0' .config > .config.tmp
    mv .config.tmp .config
    
    log "âœ… æœ€ç»ˆå»é‡å®Œæˆ"
    
    log "ğŸ”„ æ­¥éª¤6: è¿è¡Œ make defconfig..."
    make defconfig || handle_error "åº”ç”¨é…ç½®å¤±è´¥"
    
    log "ğŸ”§ æ­¥éª¤7: éªŒè¯å…³é”®é…ç½®..."
    
    local missing_key_configs=()
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        missing_key_configs+=("kmod-usb-xhci-hcd")
    fi
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        missing_key_configs+=("kmod-usb3")
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            missing_key_configs+=("luci-app-turboacc")
        fi
    fi
    
    if [ ${#missing_key_configs[@]} -gt 0 ]; then
        log "âš ï¸ è­¦å‘Š: ä»¥ä¸‹å…³é”®é…ç½®åœ¨defconfigåä¸¢å¤±: ${missing_key_configs[*]}"
        log "ğŸ’¡ è¿™å¯èƒ½æ˜¯ç”±äºä¾èµ–å…³ç³»ä¸æ»¡è¶³ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶"
    else
        log "âœ… æ‰€æœ‰å…³é”®é…ç½®éªŒè¯é€šè¿‡"
    fi
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
    log "æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "æœ€ç»ˆé…ç½®å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "æœ€ç»ˆé…ç½®è¡Œæ•°: $(wc -l < .config)"
}
#ã€build_firmware_main.sh-16-endã€‘

#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆæœ€ç»ˆç¨³å®šç‰ˆï¼‰==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    mkdir -p scripts/config
    cat > scripts/config/config << 'EOF'
#!/bin/sh
# ç›´æ¥å†™å…¥.configçš„ç®€æ˜“configå·¥å…·
CONFIG_FILE=".config"

case "$1" in
    --enable)
        shift
        sed -i "/^# CONFIG_$1 is not set/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=/d" "$CONFIG_FILE"
        echo "CONFIG_$1=y" >> "$CONFIG_FILE"
        ;;
    --disable)
        shift
        sed -i "/^CONFIG_$1=y/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=m/d" "$CONFIG_FILE"
        echo "# CONFIG_$1 is not set" >> "$CONFIG_FILE"
        ;;
    --module)
        shift
        sed -i "/^# CONFIG_$1 is not set/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=y/d" "$CONFIG_FILE"
        echo "CONFIG_$1=m" >> "$CONFIG_FILE"
        ;;
    --set-str)
        shift
        name="$1"
        value="$2"
        sed -i "/^CONFIG_$name=/d" "$CONFIG_FILE"
        echo "CONFIG_$name=\"$value\"" >> "$CONFIG_FILE"
        shift 2
        ;;
esac
EOF
    chmod +x scripts/config/config
    ln -sf config scripts/config/config-link
    
    local CONFIG_CMD="./scripts/config/config"
    log "âœ… ä½¿ç”¨ç®€æ˜“configå·¥å…·"
    
    log "ğŸ”§ ä½¿ç”¨é…ç½®å·¥å…·åˆå¹¶é…ç½®..."
    
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "ğŸ“ åº”ç”¨USBé€šç”¨é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/usb-generic.config"
        log "âœ… USBé€šç”¨é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "ğŸ“ åº”ç”¨åŸºç¡€é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/base.config"
        log "âœ… åŸºç¡€é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "ğŸ“ åº”ç”¨è®¾å¤‡é…ç½®: $DEVICE.config..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$device_config_file"
        log "âœ… è®¾å¤‡é…ç½®åº”ç”¨å®Œæˆ"
    elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "ğŸ“ åº”ç”¨æ­£å¸¸æ¨¡å¼é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "luci-app-turboacc|kmod-shortcut-fe|kmod-fast-classifier"; then
                continue
            fi
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/normal.config"
        log "âœ… æ­£å¸¸æ¨¡å¼é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "ğŸ“ åº”ç”¨å¹³å°é…ç½®: $(basename "$platform_config")..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$platform_config"
        log "âœ… å¹³å°é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            if [ -n "$pkg" ]; then
                $CONFIG_CMD --enable "PACKAGE_$pkg"
                log "âœ… æ·»åŠ åŒ…: $pkg"
            fi
        done
    fi
    
    log "ğŸ”§ å¼ºåˆ¶å¯ç”¨æ‰€æœ‰å…³é”®é…ç½®..."
    
    $CONFIG_CMD --enable PACKAGE_kmod-usb-core
    $CONFIG_CMD --enable PACKAGE_kmod-usb2
    $CONFIG_CMD --enable PACKAGE_kmod-usb3
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-hcd
    $CONFIG_CMD --enable PACKAGE_kmod-usb-storage
    $CONFIG_CMD --enable PACKAGE_kmod-scsi-core
    
    if [ "$TARGET" = "ipq40xx" ]; then
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3-qcom
        $CONFIG_CMD --enable PACKAGE_kmod-phy-qcom-dwc3
        log "âœ… IPQ40xxå¹³å°ä¸“ç”¨é©±åŠ¨å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    fi
    
    $CONFIG_CMD --enable PACKAGE_kmod-tcp-bbr
    $CONFIG_CMD --set-str DEFAULT_TCP_CONG "bbr"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        $CONFIG_CMD --enable PACKAGE_luci-app-turboacc
        $CONFIG_CMD --enable PACKAGE_kmod-shortcut-fe
        $CONFIG_CMD --enable PACKAGE_kmod-fast-classifier
        log "âœ… TurboACCé…ç½®å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    fi
    
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-pci
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-smallbuffers
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-ct-smallbuffers
    $CONFIG_CMD --enable PACKAGE_kmod-ath10k-ct
    log "âœ… ath10kå†²çªä¿®å¤å®Œæˆ"
    
    log "ğŸ”„ è¿è¡Œæœ€ç»ˆ make defconfig..."
    make defconfig || handle_error "æœ€ç»ˆé…ç½®åº”ç”¨å¤±è´¥"
    
    log "ğŸ“‹ å…³é”®é…ç½®çŠ¶æ€:"
    log "  - kmod-usb2: $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb3: $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    if [ "$TARGET" = "ipq40xx" ]; then
        log "  - kmod-usb-dwc3-qcom: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        log "  - kmod-phy-qcom-dwc3: $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  - luci-app-turboacc: $(grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    log "  - kmod-tcp-bbr: $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    log "ğŸ“Š é…ç½®ç”Ÿæˆç»Ÿè®¡:"
    log "  - æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "  - é…ç½®è¡Œæ•°: $(wc -l < .config)"
    log "  - é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘

