#ã€build_firmware_main.sh-32ã€‘
workflow_step16_verify_usb() {
    log "=== æ­¥éª¤16: éªŒè¯USBé…ç½®ï¼ˆåŠ¨æ€æ£€æµ‹ç‰ˆï¼‰ ==="
    
    trap 'echo "âš ï¸ æ­¥éª¤16 éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
    
    cd $BUILD_DIR
    
    echo "=== ğŸš¨ USBé…ç½®åŠ¨æ€æ£€æµ‹ ==="
    echo ""
    
    # 1. æ£€æµ‹USBæ ¸å¿ƒæ¨¡å—
    echo "1. ğŸŸ¢ USBæ ¸å¿ƒæ¨¡å—:"
    local usb_core=$(grep "^CONFIG_PACKAGE_kmod-usb-core=" .config | head -1)
    if [ -n "$usb_core" ]; then
        echo "   âœ… kmod-usb-core: $(echo $usb_core | cut -d'=' -f2)"
    else
        echo "   âŒ kmod-usb-core: æœªå¯ç”¨"
    fi
    echo ""
    
    # 2. æ£€æµ‹æ‰€æœ‰USBæ§åˆ¶å™¨é©±åŠ¨
    echo "2. ğŸŸ¢ USBæ§åˆ¶å™¨é©±åŠ¨:"
    local usb_controllers=$(grep "^CONFIG_PACKAGE_kmod-usb" .config | grep -E "usb2|usb3|ehci|ohci|xhci|dwc" | grep -v "storage\|serial\|net" | sort)
    
    if [ -n "$usb_controllers" ]; then
        echo "$usb_controllers" | while read line; do
            local pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1)
            local val=$(echo "$line" | cut -d'=' -f2)
            if [ "$val" = "y" ]; then
                echo "   âœ… $pkg: å·²å¯ç”¨"
            elif [ "$val" = "m" ]; then
                echo "   ğŸ“¦ $pkg: æ¨¡å—åŒ–"
            fi
        done
    else
        echo "   æœªæ‰¾åˆ°USBæ§åˆ¶å™¨é©±åŠ¨"
    fi
    echo ""
    
    # 3. æ£€æµ‹USBå­˜å‚¨é©±åŠ¨
    echo "3. ğŸŸ¢ USBå­˜å‚¨é©±åŠ¨:"
    local usb_storage=$(grep "^CONFIG_PACKAGE_kmod-usb-storage" .config | grep -E "=y|=m" | sort)
    if [ -n "$usb_storage" ]; then
        echo "$usb_storage" | while read line; do
            local pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1)
            local val=$(echo "$line" | cut -d'=' -f2)
            if [ "$val" = "y" ]; then
                echo "   âœ… $pkg: å·²å¯ç”¨"
            elif [ "$val" = "m" ]; then
                echo "   ğŸ“¦ $pkg: æ¨¡å—åŒ–"
            fi
        done
    else
        echo "   âŒ kmod-usb-storage: æœªå¯ç”¨"
    fi
    
    # SCSIæ ¸å¿ƒ
    if grep -q "^CONFIG_PACKAGE_kmod-scsi-core=y" .config; then
        echo "   âœ… kmod-scsi-core: å·²å¯ç”¨"
    elif grep -q "^CONFIG_PACKAGE_kmod-scsi-core=m" .config; then
        echo "   ğŸ“¦ kmod-scsi-core: æ¨¡å—åŒ–"
    else
        echo "   âŒ kmod-scsi-core: æœªå¯ç”¨"
    fi
    echo ""
    
    # 4. æ£€æµ‹å¹³å°ä¸“ç”¨é©±åŠ¨
    echo "4. ğŸŸ¢ å¹³å°ä¸“ç”¨é©±åŠ¨:"
    
    # æ£€æµ‹ç›®æ ‡å¹³å°
    local target=$(grep "^CONFIG_TARGET_" .config | grep "=y" | head -1 | cut -d'_' -f2 | tr '[:upper:]' '[:lower:]')
    
    case "$target" in
        ipq40xx|ipq806x|qcom)
            echo "   ğŸ”§ æ£€æµ‹åˆ°é«˜é€šå¹³å°"
            local qcom_drivers=$(grep "^CONFIG_PACKAGE_kmod" .config | grep -E "qcom|ipq40" | grep -E "=y|=m" | sort)
            if [ -n "$qcom_drivers" ]; then
                echo "$qcom_drivers" | while read line; do
                    local pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1)
                    local val=$(echo "$line" | cut -d'=' -f2)
                    if [ "$val" = "y" ]; then
                        echo "   âœ… $pkg: å·²å¯ç”¨"
                    elif [ "$val" = "m" ]; then
                        echo "   ğŸ“¦ $pkg: æ¨¡å—åŒ–"
                    fi
                done
            else
                echo "   æœªæ‰¾åˆ°é«˜é€šä¸“ç”¨é©±åŠ¨"
            fi
            ;;
        mediatek|ramips)
            echo "   ğŸ”§ æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°"
            local mtk_drivers=$(grep "^CONFIG_PACKAGE_kmod" .config | grep -E "mtk|mediatek" | grep -E "=y|=m" | sort)
            if [ -n "$mtk_drivers" ]; then
                echo "$mtk_drivers" | while read line; do
                    local pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1)
                    local val=$(echo "$line" | cut -d'=' -f2)
                    if [ "$val" = "y" ]; then
                        echo "   âœ… $pkg: å·²å¯ç”¨"
                    elif [ "$val" = "m" ]; then
                        echo "   ğŸ“¦ $pkg: æ¨¡å—åŒ–"
                    fi
                done
            else
                echo "   æœªæ‰¾åˆ°è”å‘ç§‘ä¸“ç”¨é©±åŠ¨"
            fi
            ;;
        ath79)
            echo "   ğŸ”§ æ£€æµ‹åˆ°ATH79å¹³å°"
            local ath79_drivers=$(grep "^CONFIG_PACKAGE_kmod" .config | grep -E "ath79" | grep -E "=y|=m" | sort)
            if [ -n "$ath79_drivers" ]; then
                echo "$ath79_drivers" | while read line; do
                    local pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1)
                    local val=$(echo "$line" | cut -d'=' -f2)
                    if [ "$val" = "y" ]; then
                        echo "   âœ… $pkg: å·²å¯ç”¨"
                    elif [ "$val" = "m" ]; then
                        echo "   ğŸ“¦ $pkg: æ¨¡å—åŒ–"
                    fi
                done
            else
                echo "   æœªæ‰¾åˆ°ATH79ä¸“ç”¨é©±åŠ¨"
            fi
            ;;
        *)
            echo "   â„¹ï¸ é€šç”¨å¹³å°ï¼Œæ— ä¸“ç”¨é©±åŠ¨"
            ;;
    esac
    echo ""
    
    # 5. æ£€æŸ¥é‡å¤é…ç½®
    echo "5. ğŸŸ¢ æ£€æŸ¥é‡å¤é…ç½®:"
    local duplicates=$(grep "^CONFIG_PACKAGE_kmod-usb" .config | cut -d'=' -f1 | sort | uniq -d)
    if [ -n "$duplicates" ]; then
        echo "$duplicates" | while read dup; do
            local count=$(grep -c "^$dup=" .config)
            echo "   âš ï¸ $dup: å‡ºç° $count æ¬¡"
        done
    else
        echo "   âœ… æ— é‡å¤é…ç½®"
    fi
    echo ""
    
    # 6. ç»Ÿè®¡ä¿¡æ¯
    echo "6. ğŸ“Š USBé©±åŠ¨ç»Ÿè®¡:"
    local total_usb=$(grep -c "^CONFIG_PACKAGE_kmod-usb" .config)
    local enabled_usb=$(grep -c "^CONFIG_PACKAGE_kmod-usb.*=y" .config)
    local module_usb=$(grep -c "^CONFIG_PACKAGE_kmod-usb.*=m" .config)
    echo "   æ€»USBåŒ…: $total_usb"
    echo "   å·²å¯ç”¨: $enabled_usb"
    echo "   æ¨¡å—åŒ–: $module_usb"
    echo ""
    
    echo "âœ… USBé…ç½®æ£€æŸ¥å®Œæˆ"
    log "âœ… æ­¥éª¤16 å®Œæˆ"
}
#ã€build_firmware_main.sh-32-endã€‘

#ã€build_firmware_main.sh-33ã€‘
workflow_step17_check_usb_drivers() {
    log "=== æ­¥éª¤17: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ï¼ˆåŠ¨æ€æ£€æµ‹ç‰ˆï¼‰ ==="
    
    trap 'echo "âš ï¸ æ­¥éª¤17 æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
    
    cd $BUILD_DIR
    
    echo "=== USBé©±åŠ¨å®Œæ•´æ€§åŠ¨æ€æ£€æµ‹ ==="
    echo ""
    
    # è·å–ç›®æ ‡å¹³å°
    local target=$(grep "^CONFIG_TARGET_" .config | grep "=y" | head -1 | cut -d'_' -f2 | tr '[:upper:]' '[:lower:]')
    echo "ç›®æ ‡å¹³å°: $target"
    echo ""
    
    # å®šä¹‰åŸºç¡€å¿…éœ€é©±åŠ¨
    local base_required=(
        "kmod-usb-core"
    )
    
    # æ ¹æ®å¹³å°å®šä¹‰å¿…éœ€é©±åŠ¨
    local required_drivers=()
    case "$target" in
        ipq40xx|ipq806x|qcom)
            required_drivers=(
                "kmod-usb-core"
                "kmod-usb2"
                "kmod-usb3"
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-qcom"
                "kmod-usb-xhci-hcd"
                "kmod-usb-storage"
                "kmod-scsi-core"
            )
            ;;
        mediatek|ramips)
            required_drivers=(
                "kmod-usb-core"
                "kmod-usb2"
                "kmod-usb3"
                "kmod-usb-xhci-mtk"
                "kmod-usb-storage"
                "kmod-scsi-core"
            )
            ;;
        ath79)
            required_drivers=(
                "kmod-usb-core"
                "kmod-usb2"
                "kmod-usb-ohci"
                "kmod-usb-storage"
                "kmod-scsi-core"
            )
            ;;
        *)
            required_drivers=(
                "kmod-usb-core"
                "kmod-usb2"
                "kmod-usb-storage"
                "kmod-scsi-core"
            )
            ;;
    esac
    
    echo "ğŸ” æ£€æŸ¥å¿…éœ€USBé©±åŠ¨:"
    echo ""
    
    local missing_drivers=()
    local enabled_drivers=()
    
    for driver in "${required_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "   âœ… $driver: å·²å¯ç”¨"
            enabled_drivers+=("$driver")
        elif grep -q "^CONFIG_PACKAGE_${driver}=m" .config; then
            echo "   ğŸ“¦ $driver: æ¨¡å—åŒ–"
            enabled_drivers+=("$driver")
        else
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›¿ä»£é©±åŠ¨
            local alt_driver=$(grep "^CONFIG_PACKAGE_" .config | grep -i "${driver#kmod-}" | grep -E "=y|=m" | head -1)
            if [ -n "$alt_driver" ]; then
                local alt_name=$(echo "$alt_driver" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1)
                echo "   ğŸ”„ $driver: æœªæ‰¾åˆ°ï¼Œä½†å‘ç°æ›¿ä»£: $alt_name"
                enabled_drivers+=("$driver(æ›¿ä»£:$alt_name)")
            else
                echo "   âŒ $driver: æœªå¯ç”¨"
                missing_drivers+=("$driver")
            fi
        fi
    done
    
    echo ""
    echo "ğŸ“Š ç»Ÿè®¡:"
    echo "   å¿…éœ€é©±åŠ¨: ${#required_drivers[@]} ä¸ª"
    echo "   å·²å¯ç”¨/æ›¿ä»£: ${#enabled_drivers[@]} ä¸ª"
    echo "   ç¼ºå¤±é©±åŠ¨: ${#missing_drivers[@]} ä¸ª"
    
    if [ ${#missing_drivers[@]} -gt 0 ]; then
        echo ""
        echo "âš ï¸ å‘ç°ç¼ºå¤±é©±åŠ¨:"
        for driver in "${missing_drivers[@]}"; do
            echo "   - $driver"
        done
        
        # æ£€æŸ¥è¿™äº›é©±åŠ¨æ˜¯å¦è¢«å†…æ ¸é€‰é¡¹æ›¿ä»£
        echo ""
        echo "ğŸ” æ£€æŸ¥å†…æ ¸é…ç½®æ›¿ä»£:"
        for driver in "${missing_drivers[@]}"; do
            local kernel_config=$(grep -E "^CONFIG_.*${driver#kmod-}.*=y" .config | head -1)
            if [ -n "$kernel_config" ]; then
                echo "   âœ… $driver å¯èƒ½è¢«å†…æ ¸é…ç½® $(echo $kernel_config | cut -d'=' -f1) æ›¿ä»£"
            fi
        done
    else
        echo ""
        echo "âœ… æ‰€æœ‰å¿…éœ€USBé©±åŠ¨éƒ½å·²å¯ç”¨æˆ–æœ‰æ›¿ä»£"
    fi
    
    echo ""
    echo "ğŸ” æ£€æŸ¥å®é™…å¯ç”¨çš„USBé©±åŠ¨:"
    local enabled_all=$(grep "^CONFIG_PACKAGE_kmod-usb.*=y" .config | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    if [ -n "$enabled_all" ]; then
        echo "$enabled_all" | head -10 | while read driver; do
            echo "   âœ… $driver"
        done
        local total=$(echo "$enabled_all" | wc -l)
        if [ $total -gt 10 ]; then
            echo "   ... è¿˜æœ‰ $((total - 10)) ä¸ª"
        fi
    fi
    
    log "âœ… æ­¥éª¤17 å®Œæˆ"
}
#ã€build_firmware_main.sh-33-endã€‘

#ã€build_firmware_main.sh-34ã€‘
workflow_step20_fix_network() {
    log "=== æ­¥éª¤20: ä¿®å¤ç½‘ç»œç¯å¢ƒï¼ˆåŠ¨æ€æ£€æµ‹ç‰ˆï¼‰ ==="
    
    trap 'echo "âš ï¸ æ­¥éª¤20 ä¿®å¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
    
    cd $BUILD_DIR
    
    echo "ğŸ” æ£€æµ‹å½“å‰ç½‘ç»œç¯å¢ƒ..."
    
    # æ£€æµ‹ç½‘ç»œè¿é€šæ€§
    if ping -c 1 -W 2 github.com > /dev/null 2>&1; then
        echo "âœ… GitHub å¯è¾¾"
    else
        echo "âš ï¸ GitHub ä¸å¯è¾¾ï¼Œå°è¯•ä½¿ç”¨ä»£ç†..."
    fi
    
    if ping -c 1 -W 2 google.com > /dev/null 2>&1; then
        echo "âœ… å›½é™…ç½‘ç»œå¯è¾¾"
    else
        echo "âš ï¸ å›½é™…ç½‘ç»œå¯èƒ½å—é™"
    fi
    
    # æ£€æµ‹å½“å‰ä»£ç†è®¾ç½®
    if [ -n "$http_proxy" ] || [ -n "$https_proxy" ]; then
        echo "æ£€æµ‹åˆ°ä»£ç†è®¾ç½®:"
        [ -n "$http_proxy" ] && echo "   HTTP_PROXY: $http_proxy"
        [ -n "$https_proxy" ] && echo "   HTTPS_PROXY: $https_proxy"
    else
        echo "æœªæ£€æµ‹åˆ°ä»£ç†è®¾ç½®"
    fi
    
    echo ""
    echo "ğŸ”§ é…ç½®Gitä¼˜åŒ–..."
    
    # åŠ¨æ€è®¾ç½®Gité…ç½®
    git config --global http.postBuffer 524288000
    git config --global http.lowSpeedLimit 0
    git config --global http.lowSpeedTime 999999
    git config --global core.compression 0
    
    # æ£€æµ‹Gitç‰ˆæœ¬å¹¶è®¾ç½®ç›¸åº”é€‰é¡¹
    local git_version=$(git --version | cut -d' ' -f3)
    echo "Gitç‰ˆæœ¬: $git_version"
    
    # æ ¹æ®ç½‘ç»œæƒ…å†µè®¾ç½®SSLéªŒè¯
    if curl -s --connect-timeout 5 https://github.com > /dev/null 2>&1; then
        export GIT_SSL_NO_VERIFY=0
        echo "âœ… SSLéªŒè¯: å¯ç”¨"
    else
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        export CURL_SSL_NO_VERIFY=1
        echo "âš ï¸ SSLéªŒè¯: ç¦ç”¨ï¼ˆç”±äºç½‘ç»œé—®é¢˜ï¼‰"
    fi
    
    # æµ‹è¯•æœ€ç»ˆè¿æ¥
    echo ""
    echo "ğŸ” æµ‹è¯•æœ€ç»ˆè¿æ¥..."
    if curl -s --connect-timeout 10 https://github.com > /dev/null; then
        echo "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸"
    else
        echo "âš ï¸ ç½‘ç»œè¿æ¥å¯èƒ½æœ‰é—®é¢˜ï¼Œä½†å°†ç»§ç»­å°è¯•"
    fi
    
    log "âœ… æ­¥éª¤20 å®Œæˆ"
}
#ã€build_firmware_main.sh-34-endã€‘

#ã€build_firmware_main.sh-35ã€‘
workflow_step21_download_deps() {
    log "=== æ­¥éª¤21: ä¸‹è½½ä¾èµ–åŒ…ï¼ˆåŠ¨æ€ä¼˜åŒ–ç‰ˆï¼‰ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤21 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    cd $BUILD_DIR
    
    echo "ğŸ”§ æ£€æŸ¥ä¾èµ–åŒ…ç›®å½•..."
    if [ ! -d "dl" ]; then
        mkdir -p dl
        echo "âœ… åˆ›å»ºä¾èµ–åŒ…ç›®å½•: dl"
    fi
    
    # ç»Ÿè®¡ç°æœ‰ä¾èµ–åŒ…
    local dep_count=$(find dl -type f 2>/dev/null | wc -l)
    local dep_size=$(du -sh dl 2>/dev/null | cut -f1 || echo "0B")
    echo "ğŸ“Š å½“å‰ä¾èµ–åŒ…: $dep_count ä¸ª, æ€»å¤§å°: $dep_size"
    
    # æ£€æµ‹ç³»ç»Ÿèµ„æºåŠ¨æ€è°ƒæ•´å¹¶è¡Œæ•°
    local cpu_cores=$(nproc)
    local mem_total=$(free -m | awk '/^Mem:/{print $2}')
    local download_jobs=1
    
    if [ $cpu_cores -ge 4 ] && [ $mem_total -ge 4096 ]; then
        download_jobs=$((cpu_cores > 8 ? 8 : cpu_cores))
        echo "âœ… æ£€æµ‹åˆ°é«˜æ€§èƒ½ç³»ç»Ÿï¼Œä½¿ç”¨ $download_jobs å¹¶è¡Œä¸‹è½½"
    elif [ $cpu_cores -ge 2 ] && [ $mem_total -ge 2048 ]; then
        download_jobs=4
        echo "âœ… æ£€æµ‹åˆ°æ ‡å‡†ç³»ç»Ÿï¼Œä½¿ç”¨ 4 å¹¶è¡Œä¸‹è½½"
    else
        download_jobs=2
        echo "âš ï¸ æ£€æµ‹åˆ°èµ„æºæœ‰é™ï¼Œä½¿ç”¨ 2 å¹¶è¡Œä¸‹è½½"
    fi
    
    echo "ğŸš€ å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¹¶è¡Œæ•°: $download_jobsï¼‰..."
    
    # ä½¿ç”¨timeouté¿å…å¡æ­»
    local start_time=$(date +%s)
    
    # å…ˆå°è¯•å¿«é€Ÿä¸‹è½½
    if make -j$download_jobs download -k > download.log 2>&1; then
        echo "âœ… ä¸‹è½½å®Œæˆ"
    else
        echo "âš ï¸ éƒ¨åˆ†ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹é‡è¯•å¤±è´¥é¡¹..."
        # æå–å¤±è´¥çš„åŒ…å¹¶é‡è¯•
        grep -E "ERROR|Failed" download.log | grep -o "make[^)]*" | while read cmd; do
            echo "é‡è¯•: $cmd"
            eval $cmd || true
        done
    fi
    
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    # ç»Ÿè®¡ä¸‹è½½ç»“æœ
    local new_dep_count=$(find dl -type f 2>/dev/null | wc -l)
    local new_dep_size=$(du -sh dl 2>/dev/null | cut -f1)
    local added=$((new_dep_count - dep_count))
    
    echo ""
    echo "ğŸ“Š ä¸‹è½½ç»Ÿè®¡:"
    echo "   è€—æ—¶: $((duration / 60))åˆ†$((duration % 60))ç§’"
    echo "   åŸæœ‰åŒ…: $dep_count ä¸ª ($dep_size)"
    echo "   ç°æœ‰åŒ…: $new_dep_count ä¸ª ($new_dep_size)"
    echo "   æ–°å¢åŒ…: $added ä¸ª"
    
    # æ£€æŸ¥ä¸‹è½½é”™è¯¯
    local error_count=$(grep -c -E "ERROR|Failed|404" download.log 2>/dev/null || echo "0")
    if [ $error_count -gt 0 ]; then
        echo "âš ï¸ å‘ç° $error_count ä¸ªä¸‹è½½é”™è¯¯ï¼Œä½†ä¸å½±å“ç»§ç»­"
        echo "é”™è¯¯ç¤ºä¾‹:"
        grep -E "ERROR|Failed|404" download.log | head -5
    fi
    
    log "âœ… æ­¥éª¤21 å®Œæˆ"
}
#ã€build_firmware_main.sh-35-endã€‘

#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆåŠ¨æ€æ£€æµ‹ç‰ˆï¼‰ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡:"
        echo "   SELECTED_BRANCH=$SELECTED_BRANCH"
        echo "   TARGET=$TARGET"
        echo "   SUBTARGET=$SUBTARGET"
        echo "   DEVICE=$DEVICE"
        echo "   CONFIG_MODE=$CONFIG_MODE"
        echo "   COMPILER_DIR=$COMPILER_DIR"
    else
        echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ ($BUILD_DIR/build_env.sh)"
        exit 1
    fi
    
    cd $BUILD_DIR
    echo ""
    echo "=== ğŸš¨ å‰ç½®é”™è¯¯åŠ¨æ€æ£€æµ‹ ==="
    echo ""
    
    local error_count=0
    local warning_count=0
    
    # 1. æ£€æŸ¥é…ç½®æ–‡ä»¶
    echo "1. âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    if [ -f ".config" ]; then
        local config_size=$(ls -lh .config | awk '{print $5}')
        local config_lines=$(wc -l < .config)
        echo "   âœ… .config æ–‡ä»¶å­˜åœ¨"
        echo "   ğŸ“Š å¤§å°: $config_size, è¡Œæ•°: $config_lines"
        
        # æ£€æŸ¥è®¾å¤‡é…ç½®
        local device_upper=$(echo "$DEVICE" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
        if grep -q "CONFIG_TARGET_.*DEVICE.*${device_upper}=y" .config; then
            echo "   âœ… è®¾å¤‡é…ç½®æ­£ç¡®"
        else
            # å°è¯•å°å†™åŒ¹é…
            local device_lower=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
            if grep -q "CONFIG_TARGET_.*DEVICE.*${device_lower}=y" .config; then
                echo "   âœ… è®¾å¤‡é…ç½®æ­£ç¡® (å°å†™)"
            else
                echo "   âŒ è®¾å¤‡é…ç½®å¯èƒ½ä¸æ­£ç¡®"
                error_count=$((error_count + 1))
            fi
        fi
    else
        echo "   âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 2. æ£€æŸ¥SDK/ç¼–è¯‘å™¨
    echo "2. âœ… SDK/ç¼–è¯‘å™¨æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "   âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
        local sdk_size=$(du -sh "$COMPILER_DIR" 2>/dev/null | awk '{print $1}')
        echo "   ğŸ“Š å¤§å°: $sdk_size"
        
        # æŸ¥æ‰¾çœŸæ­£çš„GCC
        local gcc_file=$(find "$COMPILER_DIR" -type f -executable -name "*gcc" ! -name "*gcc-ar" ! -name "*gcc-ranlib" ! -name "*gcc-nm" ! -path "*dummy-tools*" 2>/dev/null | head -1)
        if [ -n "$gcc_file" ]; then
            echo "   âœ… æ‰¾åˆ°GCC: $(basename "$gcc_file")"
            local gcc_version=$("$gcc_file" --version 2>&1 | head -1)
            echo "   ğŸ”§ ç‰ˆæœ¬: $gcc_version"
        else
            echo "   âŒ æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨"
            error_count=$((error_count + 1))
        fi
    else
        echo "   âŒ SDKç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 3. æ£€æŸ¥Feeds
    echo "3. âœ… Feedsæ£€æŸ¥:"
    if [ -d "feeds" ]; then
        local feeds_count=$(find feeds -maxdepth 1 -type d 2>/dev/null | wc -l)
        feeds_count=$((feeds_count - 1))  # å‡å»feedsç›®å½•æœ¬èº«
        echo "   âœ… feedsç›®å½•å­˜åœ¨, åŒ…å« $feeds_count ä¸ªfeed"
        
        # æ£€æŸ¥å…³é”®feed
        for feed in packages luci; do
            if [ -d "feeds/$feed" ]; then
                echo "   âœ… $feed feed: å­˜åœ¨"
            else
                echo "   âŒ $feed feed: ä¸å­˜åœ¨"
                warning_count=$((warning_count + 1))
            fi
        done
    else
        echo "   âŒ feedsç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
    echo "4. âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    local available_space=$(df /mnt --output=avail 2>/dev/null | tail -1 || df / --output=avail | tail -1)
    local available_gb=$((available_space / 1024 / 1024))
    echo "   ğŸ“Š å¯ç”¨ç©ºé—´: ${available_gb}G"
    
    if [ $available_gb -lt 5 ]; then
        echo "   âŒ ç©ºé—´ä¸¥é‡ä¸è¶³ (<5G)"
        error_count=$((error_count + 1))
    elif [ $available_gb -lt 10 ]; then
        echo "   âš ï¸ ç©ºé—´è¾ƒä½ (<10G)"
        warning_count=$((warning_count + 1))
    elif [ $available_gb -lt 20 ]; then
        echo "   âš ï¸ ç©ºé—´ä¸€èˆ¬ (<20G)"
        warning_count=$((warning_count + 1))
    else
        echo "   âœ… ç©ºé—´å……è¶³"
    fi
    echo ""
    
    # 5. æ£€æŸ¥å…³é”®USBé©±åŠ¨
    echo "5. âœ… USBé©±åŠ¨æ£€æŸ¥:"
    local critical_drivers=(
        "kmod-usb-core"
    )
    
    # æ ¹æ®å¹³å°æ·»åŠ å…³é”®é©±åŠ¨
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            critical_drivers+=("kmod-usb-dwc3" "kmod-usb-dwc3-qcom")
            ;;
        mediatek|ramips)
            critical_drivers+=("kmod-usb-xhci-mtk")
            ;;
    esac
    
    local missing_usb=0
    for driver in "${critical_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "   âœ… $driver: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${driver}=m" .config; then
            echo "   ğŸ“¦ $driver: æ¨¡å—åŒ–"
        else
            echo "   âŒ $driver: æœªå¯ç”¨"
            missing_usb=$((missing_usb + 1))
        fi
    done
    
    if [ $missing_usb -gt 0 ]; then
        echo "   âš ï¸ æœ‰ $missing_usb ä¸ªå…³é”®USBé©±åŠ¨ç¼ºå¤±"
        warning_count=$((warning_count + 1))
    fi
    echo ""
    
    # 6. æ£€æŸ¥å†…å­˜
    echo "6. âœ… å†…å­˜æ£€æŸ¥:"
    local mem_total=$(free -m | awk '/^Mem:/{print $2}')
    local mem_available=$(free -m | awk '/^Mem:/{print $7}')
    echo "   ğŸ“Š æ€»å†…å­˜: ${mem_total}MB, å¯ç”¨: ${mem_available}MB"
    
    if [ $mem_available -lt 512 ]; then
        echo "   âš ï¸ å¯ç”¨å†…å­˜ä¸è¶³ (<512MB)"
        warning_count=$((warning_count + 1))
    else
        echo "   âœ… å†…å­˜å……è¶³"
    fi
    echo ""
    
    # 7. æ£€æŸ¥CPU
    echo "7. âœ… CPUæ£€æŸ¥:"
    local cpu_cores=$(nproc)
    local cpu_model=$(grep "model name" /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs)
    echo "   ğŸ“Š æ ¸å¿ƒæ•°: $cpu_cores"
    echo "   ğŸ“Š å‹å·: $cpu_model"
    echo ""
    
    # æ±‡æ€»
    echo "========================================"
    if [ $error_count -gt 0 ]; then
        echo "âŒâŒâŒ æ£€æµ‹åˆ° $error_count ä¸ªé”™è¯¯ï¼Œè¯·ä¿®å¤åé‡è¯• âŒâŒâŒ"
        exit 1
    elif [ $warning_count -gt 0 ]; then
        echo "âš ï¸âš ï¸âš ï¸ æ£€æµ‹åˆ° $warning_count ä¸ªè­¦å‘Šï¼Œä½†å¯ä»¥ç»§ç»­ âš ï¸âš ï¸âš ï¸"
    else
        echo "âœ…âœ…âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    fi
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}
#ã€build_firmware_main.sh-37-endã€‘

