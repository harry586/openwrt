#ã€firmware-build.yml-00ã€‘æ­¥éª¤0ä¿®å¤ç‰ˆ
- name: "0. ç”Ÿæˆæ—¶é—´æˆ³å’Œè®¾å¤‡åŒæ­¥æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼‰"
  run: |
    echo "=== æ­¥éª¤ 0: ç”Ÿæˆæ—¶é—´æˆ³å’Œè®¾å¤‡åŒæ­¥æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼‰==="
    echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    
    # å·¥ä½œåŒºæ£€æŸ¥
    WORKSPACE="${{ github.workspace }}"
    echo "ğŸ“ å·¥ä½œåŒºæ ¹ç›®å½•: $WORKSPACE"
    echo "ğŸ“ å·¥ä½œåŒºæ ¹ç›®å½•å†…å®¹:"
    ls -la "$WORKSPACE" || echo "æ— æ³•åˆ—å‡ºå·¥ä½œåŒºç›®å½•"
    
    # ç­‰å¾…æ–‡ä»¶å¤åˆ¶å®Œæˆ
    echo "â³ ç­‰å¾…æ–‡ä»¶å¤åˆ¶å®Œæˆ..."
    sleep 2
    
    # è®¾å¤‡åŒæ­¥æ£€æŸ¥ - ä½¿ç”¨æ™ºèƒ½æœç´¢
    echo "ğŸ” æ™ºèƒ½æœç´¢è®¾å¤‡æ”¯æŒæ–‡ä»¶..."
    
    # æ–¹æ³•1: ç›´æ¥ä½¿ç”¨å·¥ä½œåŒºè·¯å¾„ï¼ˆæ—§æ–¹æ³•ï¼‰
    SUPPORT_FILE_1="$WORKSPACE/firmware-config/support.sh"
    
    # æ–¹æ³•2: åœ¨å½“å‰æ„å»ºç›®å½•ä¸­æœç´¢
    SUPPORT_FILE_2=""
    if [ -d "firmware-config" ]; then
      SUPPORT_FILE_2="firmware-config/support.sh"
    elif [ -d "../firmware-config" ]; then
      SUPPORT_FILE_2="../firmware-config/support.sh"
    elif [ -d "../../firmware-config" ]; then
      SUPPORT_FILE_2="../../firmware-config/support.sh"
    fi
    
    # æ–¹æ³•3: ä½¿ç”¨findå‘½ä»¤æœç´¢
    SUPPORT_FILE_3=""
    if command -v find >/dev/null 2>&1; then
      SUPPORT_FILE_3=$(find "$WORKSPACE" -type f -name "support.sh" 2>/dev/null | grep -i "firmware-config" | head -1)
    fi
    
    # æ–¹æ³•4: æœç´¢æ‰€æœ‰å¯èƒ½çš„è·¯å¾„
    SUPPORT_FILE_4=""
    local search_paths=(
      "$WORKSPACE/firmware-config/support.sh"
      "$(pwd)/firmware-config/support.sh"
      "$(pwd)/../firmware-config/support.sh"
      "$(pwd)/../../firmware-config/support.sh"
      "/home/runner/work/openwrt/openwrt/firmware-config/support.sh"
      "/mnt/firmware-config/support.sh"
    )
    
    for path in "${search_paths[@]}"; do
      if [ -f "$path" ]; then
        SUPPORT_FILE_4="$path"
        break
      fi
    done
    
    echo "ğŸ“Š æœç´¢ç»“æœ:"
    echo "  æ–¹æ³•1 (å·¥ä½œåŒºè·¯å¾„): $([ -f "$SUPPORT_FILE_1" ] && echo "âœ… æ‰¾åˆ°" || echo "âŒ æœªæ‰¾åˆ°")"
    echo "  æ–¹æ³•2 (ç›¸å¯¹è·¯å¾„): $([ -n "$SUPPORT_FILE_2" ] && [ -f "$SUPPORT_FILE_2" ] && echo "âœ… æ‰¾åˆ°: $SUPPORT_FILE_2" || echo "âŒ æœªæ‰¾åˆ°")"
    echo "  æ–¹æ³•3 (findæœç´¢): $([ -n "$SUPPORT_FILE_3" ] && echo "âœ… æ‰¾åˆ°: $SUPPORT_FILE_3" || echo "âŒ æœªæ‰¾åˆ°")"
    echo "  æ–¹æ³•4 (è·¯å¾„åˆ—è¡¨): $([ -n "$SUPPORT_FILE_4" ] && echo "âœ… æ‰¾åˆ°: $SUPPORT_FILE_4" || echo "âŒ æœªæ‰¾åˆ°")"
    
    # é€‰æ‹©æ‰¾åˆ°çš„æ–‡ä»¶
    SUPPORT_FILE=""
    if [ -n "$SUPPORT_FILE_4" ]; then
      SUPPORT_FILE="$SUPPORT_FILE_4"
    elif [ -n "$SUPPORT_FILE_3" ]; then
      SUPPORT_FILE="$SUPPORT_FILE_3"
    elif [ -n "$SUPPORT_FILE_2" ] && [ -f "$SUPPORT_FILE_2" ]; then
      SUPPORT_FILE="$SUPPORT_FILE_2"
    elif [ -f "$SUPPORT_FILE_1" ]; then
      SUPPORT_FILE="$SUPPORT_FILE_1"
    fi
    
    if [ -f "$SUPPORT_FILE" ]; then
      echo "âœ… æœ€ç»ˆé€‰æ‹©çš„è®¾å¤‡æ”¯æŒæ–‡ä»¶: $SUPPORT_FILE"
      echo "ğŸ“„ æ–‡ä»¶ä¿¡æ¯:"
      ls -lh "$SUPPORT_FILE"
      
      # æµ‹è¯•æ–‡ä»¶å†…å®¹
      echo "ğŸ“„ æ–‡ä»¶å‰5è¡Œå†…å®¹:"
      head -5 "$SUPPORT_FILE"
      
      # åŠ è½½æ–‡ä»¶æµ‹è¯•
      echo "ğŸ§ª æµ‹è¯•åŠ è½½è®¾å¤‡æ”¯æŒè„šæœ¬..."
      if source "$SUPPORT_FILE" 2>/dev/null; then
        echo "âœ… æˆåŠŸåŠ è½½è®¾å¤‡æ”¯æŒè„šæœ¬"
        
        # æµ‹è¯•å‡½æ•°æ˜¯å¦å­˜åœ¨
        if command -v get_all_devices >/dev/null 2>&1; then
          SUPPORTED_DEVICES=$(get_all_devices 2>/dev/null || echo "æ— æ³•è·å–è®¾å¤‡åˆ—è¡¨")
          echo "ğŸ“± support.sh ä¸­æ”¯æŒçš„è®¾å¤‡: $SUPPORTED_DEVICES"
          
          SELECTED_DEVICE="${{ github.event.inputs.device_name }}"
          echo "ğŸ¯ å½“å‰é€‰æ‹©çš„è®¾å¤‡: $SELECTED_DEVICE"
          
          # æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨support.shä¸­
          DEVICE_IN_SUPPORT=false
          IFS=' ' read -ra DEVICE_ARRAY <<< "$SUPPORTED_DEVICES"
          for device in "${DEVICE_ARRAY[@]}"; do
            if [ "$device" = "$SELECTED_DEVICE" ]; then
              DEVICE_IN_SUPPORT=true
              break
            fi
          done
          
          if [ "$DEVICE_IN_SUPPORT" = true ]; then
            echo "âœ… è®¾å¤‡ '$SELECTED_DEVICE' åœ¨ support.sh ä¸­æ”¯æŒ"
            if command -v get_device_description >/dev/null 2>&1; then
              DEVICE_DESC=$(get_device_description "$SELECTED_DEVICE" 2>/dev/null || echo "æ— æè¿°")
              echo "ğŸ“ è®¾å¤‡æè¿°: $DEVICE_DESC"
            fi
          else
            echo "âŒ é”™è¯¯: é€‰æ‹©çš„è®¾å¤‡ '$SELECTED_DEVICE' ä¸åœ¨ support.sh çš„æ”¯æŒåˆ—è¡¨ä¸­"
            echo "ğŸ“‹ support.sh æ”¯æŒçš„è®¾å¤‡:"
            for device in "${DEVICE_ARRAY[@]}"; do
              if command -v get_device_description >/dev/null 2>&1; then
                DESC=$(get_device_description "$device" 2>/dev/null || echo "æ— æè¿°")
                echo "  - $device: $DESC"
              else
                echo "  - $device"
              fi
            done
            exit 1
          fi
        else
          echo "âš ï¸ è­¦å‘Š: æ— æ³•ä» support.sh è¯»å–è®¾å¤‡åˆ—è¡¨å‡½æ•°"
        fi
      else
        echo "âŒ é”™è¯¯: æ— æ³•åŠ è½½è®¾å¤‡æ”¯æŒè„šæœ¬ï¼ˆå¯èƒ½æ˜¯è¯­æ³•é”™è¯¯ï¼‰"
        exit 1
      fi
    else
      echo "âŒ é”™è¯¯: æ— æ³•æ‰¾åˆ°è®¾å¤‡æ”¯æŒæ–‡ä»¶ support.sh"
      echo "ğŸ’¡ è°ƒè¯•ä¿¡æ¯:"
      echo "  å½“å‰ç›®å½•: $(pwd)"
      echo "  å·¥ä½œåŒº: $WORKSPACE"
      echo "  ç›®å½•ç»“æ„ (å‰3çº§):"
      find . -maxdepth 3 -type d 2>/dev/null | head -20
      exit 1
    fi
    
    # ç”Ÿæˆæ—¶é—´æˆ³
    BASE_DATE=$(date -u +'%Y%m%d')
    TIMESTAMP="${{ github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}-${{ github.event.inputs.source_repo }}-$BASE_DATE"
    
    echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
    
    echo "âœ… ç”Ÿæˆæ—¶é—´æˆ³: $TIMESTAMP"
    echo "ğŸ“‹ æ„å»ºé…ç½®:"
    echo "  è®¾å¤‡: ${{ github.event.inputs.device_name }}"
    echo "  ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
    echo "  æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
    echo "  æºä»£ç ä»“åº“: ${{ github.event.inputs.source_repo }}"
    echo "  å¹¶è¡Œä¼˜åŒ–: ${{ github.event.inputs.enable_parallel }}"
    
    echo "ğŸŸ¢ æ­¥éª¤ 0 å®Œæˆ"
