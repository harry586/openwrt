#ã€build_firmware_main.sh-23ã€‘
# æ­¤å‡½æ•°å·²åºŸå¼ƒï¼Œç°åœ¨ç”¨ä½œå…¬å…±å‡½æ•°åº“
# ============================================================================
# å…¬å…±å‡½æ•°åº“ - çœŸæ­£çš„é€’å½’æ¨¡ç³Šæœç´¢å’Œè¯„åˆ†
# ============================================================================

# é€’å½’æœç´¢æ‰€æœ‰.mkæ–‡ä»¶å¹¶æŸ¥æ‰¾è®¾å¤‡å
search_all_mk_files() {
    local search_path="$1"
    local device_name="$2"
    local found_files=()
    
    echo "   ğŸ” é€’å½’æœç´¢æ‰€æœ‰.mkæ–‡ä»¶..."
    
    while IFS= read -r mk_file; do
        if [ -f "$mk_file" ]; then
            found_files+=("$mk_file")
        fi
    done < <(find "$search_path" -type f -name "*.mk" 2>/dev/null)
    
    echo "   ğŸ“Š æ‰¾åˆ° ${#found_files[@]} ä¸ª.mkæ–‡ä»¶"
    
    # è¿”å›æ–‡ä»¶åˆ—è¡¨
    printf '%s\n' "${found_files[@]}"
}

# åœ¨æ–‡ä»¶ä¸­æœç´¢è®¾å¤‡å
search_device_in_file() {
    local mk_file="$1"
    local device_name="$2"
    local matches=()
    
    # è¯»å–æ–‡ä»¶å†…å®¹
    local content=$(cat "$mk_file" 2>/dev/null)
    
    # å¤šç§åŒ¹é…æ¨¡å¼
    if echo "$content" | grep -q "define Device.*$device_name"; then
        matches+=("ç²¾ç¡®è®¾å¤‡å®šä¹‰")
    fi
    if echo "$content" | grep -q "Device.*$device_name"; then
        matches+=("è®¾å¤‡å¼•ç”¨")
    fi
    if echo "$content" | grep -q "DEVICE_MODEL.*$device_name"; then
        matches+=("è®¾å¤‡å‹å·")
    fi
    if echo "$content" | grep -q "DEVICE_TITLE.*$device_name"; then
        matches+=("è®¾å¤‡æ ‡é¢˜")
    fi
    if echo "$content" | grep -q "DEVICE_DTS.*$device_name"; then
        matches+=("DTSå¼•ç”¨")
    fi
    if echo "$content" | grep -qi "$device_name"; then
        local count=$(echo "$content" | grep -io "$device_name" | wc -l)
        matches+=("æ¨¡ç³ŠåŒ¹é…($countæ¬¡)")
    fi
    
    # è¿”å›åŒ¹é…ç»“æœ
    if [ ${#matches[@]} -gt 0 ]; then
        echo "${matches[@]}"
    fi
}

# æå–æ–‡ä»¶ä¸­çš„è®¾å¤‡å®šä¹‰å—
extract_device_blocks() {
    local mk_file="$1"
    local in_block=0
    local blocks=()
    local current_block=""
    
    while IFS= read -r line; do
        if [[ "$line" =~ ^define[[:space:]]+Device/ ]]; then
            if [ $in_block -eq 1 ]; then
                blocks+=("$current_block")
            fi
            in_block=1
            current_block="$line"$'\n'
        elif [[ "$line" =~ ^endef ]] && [ $in_block -eq 1 ]; then
            current_block="${current_block}$line"
            blocks+=("$current_block")
            in_block=0
        elif [ $in_block -eq 1 ]; then
            current_block="${current_block}$line"$'\n'
        fi
    done < "$mk_file"
    
    printf '%s\n' "${blocks[@]}"
}

# è¯„åˆ†è®¾å¤‡å®šä¹‰å—
score_device_block() {
    local block="$1"
    local device_name="$2"
    local score=0
    
    # æå–è®¾å¤‡å
    local dev_name=$(echo "$block" | grep "^define Device/" | head -1 | sed 's/define Device\///' | awk '{print $1}')
    
    # ç²¾ç¡®åŒ¹é…è®¾å¤‡å
    if [ "$dev_name" = "$device_name" ]; then
        score=$((score + 200))
    elif [[ "$dev_name" == *"$device_name"* ]] || [[ "$device_name" == *"$dev_name"* ]]; then
        score=$((score + 150))
    fi
    
    # æ£€æŸ¥å„ä¸ªå­—æ®µ
    if echo "$block" | grep -q "^[[:space:]]*SOC"; then
        score=$((score + 30))
    fi
    if echo "$block" | grep -q "^[[:space:]]*DEVICE_MODEL"; then
        score=$((score + 30))
    fi
    if echo "$block" | grep -q "^[[:space:]]*DEVICE_TITLE.*$device_name"; then
        score=$((score + 50))
    fi
    if echo "$block" | grep -q "^[[:space:]]*DEVICE_PACKAGES"; then
        score=$((score + 20))
    fi
    if echo "$block" | grep -q "^[[:space:]]*DEVICE_DTS.*$device_name"; then
        score=$((score + 40))
    fi
    if echo "$block" | grep -q "^[[:space:]]*KERNEL_PATCHVER"; then
        score=$((score + 15))
    fi
    
    echo "$score"
}

# æ ¹æ®å†…å®¹é€‰æ‹©æœ€ä½³çš„è®¾å¤‡å®šä¹‰æ–‡ä»¶
find_device_definition_file() {
    local device_name="$1"
    local platform="$2"
    local base_path="target/linux/$platform"
    local best_file=""
    local best_score=0
    local best_block=""
    local all_files=()
    
    if [ ! -d "$base_path" ]; then
        echo ""
        return
    fi
    
    echo "   ğŸ” å¼€å§‹é€’å½’æœç´¢è®¾å¤‡ $device_name çš„å®šä¹‰æ–‡ä»¶..."
    echo "   ğŸ“ æœç´¢è·¯å¾„: $base_path"
    
    # æ”¶é›†æ‰€æœ‰.mkæ–‡ä»¶
    while IFS= read -r mk_file; do
        all_files+=("$mk_file")
    done < <(find "$base_path" -type f -name "*.mk" 2>/dev/null | sort)
    
    echo "   ğŸ“Š æ‰¾åˆ° ${#all_files[@]} ä¸ª.mkæ–‡ä»¶"
    
    # éå†æ¯ä¸ªæ–‡ä»¶
    for mk_file in "${all_files[@]}"; do
        local file_score=0
        local file_matched=0
        local matched_types=""
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ…å«è®¾å¤‡å
        if grep -qi "$device_name" "$mk_file" 2>/dev/null; then
            local matches=$(grep -i "$device_name" "$mk_file" | wc -l)
            file_score=$((file_score + matches * 5))
            file_matched=1
            matched_types="åŒ…å«è®¾å¤‡å($matchesæ¬¡)"
        fi
        
        # æå–å¹¶è¯„åˆ†æ¯ä¸ªè®¾å¤‡å—
        local block_index=0
        while IFS= read -r block; do
            if [ -n "$block" ]; then
                local block_score=$(score_device_block "$block" "$device_name")
                if [ $block_score -gt 0 ]; then
                    file_score=$((file_score + block_score))
                    file_matched=1
                    matched_types="$matched_types + è®¾å¤‡å—å¾—åˆ†$block_score"
                    
                    # å¦‚æœæ˜¯å½“å‰æœ€é«˜åˆ†ï¼Œä¿å­˜è¿™ä¸ªå—
                    if [ $file_score -gt $best_score ]; then
                        best_score=$file_score
                        best_file="$mk_file"
                        best_block="$block"
                    fi
                fi
                block_index=$((block_index + 1))
            fi
        done < <(extract_device_blocks "$mk_file")
        
        # æ ¹æ®æ–‡ä»¶è·¯å¾„åŠ åˆ†
        if [[ "$mk_file" == *"/image/"* ]]; then
            file_score=$((file_score + 30))
            matched_types="$matched_types + imageç›®å½•"
        fi
        if [[ "$mk_file" == *"/$platform/"*"target.mk" ]]; then
            file_score=$((file_score + 20))
            matched_types="$matched_types + target.mk"
        fi
        
        if [ $file_matched -eq 1 ]; then
            echo "   ğŸ“ $mk_file"
            echo "     åŒ¹é…: $matched_types"
            echo "     æ€»åˆ†: $file_score"
        fi
    done
    
    if [ -n "$best_file" ]; then
        echo "   ğŸ† æœ€ä½³åŒ¹é…æ–‡ä»¶ (å¾—åˆ†: $best_score): $best_file"
        if [ -n "$best_block" ]; then
            echo ""
            echo "   ğŸ“‹ æœ€ä½³åŒ¹é…è®¾å¤‡å—:"
            echo "$best_block" | while read line; do
                echo "     $line"
            done
        fi
    else
        echo "   âŒ æœªæ‰¾åˆ°è®¾å¤‡ $device_name çš„å®šä¹‰æ–‡ä»¶"
    fi
    
    echo "$best_file"
}

# ä»è®¾å¤‡å®šä¹‰æ–‡ä»¶ä¸­æå–æŒ‡å®šè®¾å¤‡çš„é…ç½®å—
extract_device_config() {
    local device_file="$1"
    local device_name="$2"
    local best_block=""
    local best_score=0
    
    if [ ! -f "$device_file" ]; then
        return 1
    fi
    
    # æå–æ‰€æœ‰è®¾å¤‡å—å¹¶è¯„åˆ†
    while IFS= read -r block; do
        if [ -n "$block" ]; then
            local score=$(score_device_block "$block" "$device_name")
            if [ $score -gt $best_score ]; then
                best_score=$score
                best_block="$block"
            fi
        fi
    done < <(extract_device_blocks "$device_file")
    
    echo "$best_block"
}

# ä»è®¾å¤‡å®šä¹‰å—ä¸­æå–å…·ä½“é…ç½®å€¼
extract_config_value() {
    local device_block="$1"
    local key="$2"
    
    echo "$device_block" | grep -E "^[[:space:]]*$key[[:space:]]*:?=" | head -1 | sed 's/.*=[[:space:]]*//' | tr -d '"'
}

# è·å–è®¾å¤‡æ”¯æŒä¿¡æ¯æ‘˜è¦
get_device_support_summary() {
    local device_name="$1"
    local platform="$2"
    local subtarget="$3"
    
    echo "   ğŸ“ å¹³å°: $platform"
    echo "   ğŸ“ å­å¹³å°: $subtarget"
    
    local device_file=$(find_device_definition_file "$device_name" "$platform")
    
    if [ -n "$device_file" ] && [ -f "$device_file" ]; then
        echo "   âœ… æ‰¾åˆ°è®¾å¤‡å®šä¹‰æ–‡ä»¶: $device_file"
        
        local device_block=$(extract_device_config "$device_file" "$device_name")
        
        if [ -n "$device_block" ]; then
            echo ""
            echo "   ğŸ“‹ è®¾å¤‡ $device_name é…ç½®:"
            echo "   ----------------------------------------"
            echo "$device_block" | while read line; do
                echo "     $line"
            done
            echo "   ----------------------------------------"
            
            local soc=$(extract_config_value "$device_block" "SOC")
            local model=$(extract_config_value "$device_block" "DEVICE_MODEL")
            local title=$(extract_config_value "$device_block" "DEVICE_TITLE")
            local packages=$(extract_config_value "$device_block" "DEVICE_PACKAGES")
            local dts=$(extract_config_value "$device_block" "DEVICE_DTS")
            local kernel_ver=$(extract_config_value "$device_block" "KERNEL_PATCHVER")
            
            [ -n "$soc" ] && echo "   ğŸ”§ SOC: $soc"
            [ -n "$model" ] && echo "   ğŸ“± å‹å·: $model"
            [ -n "$title" ] && echo "   ğŸ“ æ ‡é¢˜: $title"
            [ -n "$packages" ] && echo "   ğŸ“¦ é»˜è®¤åŒ…: $packages"
            [ -n "$dts" ] && echo "   ğŸ”§ DTS: $dts"
            [ -n "$kernel_ver" ] && echo "   ğŸ§ å†…æ ¸ç‰ˆæœ¬: $kernel_ver"
        fi
        
        return 0
    else
        echo "   âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡ $device_name çš„å®šä¹‰æ–‡ä»¶"
        return 1
    fi
}

# ä»è®¾å¤‡å®šä¹‰æ–‡ä»¶ä¸­æå–å†…æ ¸ç‰ˆæœ¬
extract_kernel_version_from_device_file() {
    local device_file="$1"
    local device_name="$2"
    
    if [ ! -f "$device_file" ]; then
        echo ""
        return
    fi
    
    local device_block=$(extract_device_config "$device_file" "$device_name")
    
    if [ -n "$device_block" ]; then
        local kernel_patchver=$(echo "$device_block" | grep -E "^[[:space:]]*KERNEL_PATCHVER[[:space:]]*:?=" | head -1 | sed 's/.*=[[:space:]]*//')
        local kernel_line=$(echo "$device_block" | grep -E "^[[:space:]]*KERNEL[[:space:]]*:?=" | head -1 | sed 's/.*=[[:space:]]*//')
        
        if [ -n "$kernel_patchver" ]; then
            echo "$kernel_patchver"
        elif [ -n "$kernel_line" ]; then
            echo "$kernel_line" | grep -oE '^[0-9]+\.[0-9]+'
        else
            echo ""
        fi
    else
        echo ""
    fi
}

# è·å–æ‰€æœ‰æ”¯æŒçš„åˆ†æ”¯åˆ—è¡¨
get_supported_branches() {
    local branches=()
    
    if [ -f "$REPO_ROOT/build-config.conf" ]; then
        while IFS= read -r line; do
            if [[ "$line" == *"BRANCH_"*":="* ]]; then
                local branch_name=$(echo "$line" | sed -n 's/.*BRANCH_[^=]*:="*\([^"]*\)"*.*/\1/p')
                if [ -n "$branch_name" ]; then
                    branches+=("$branch_name")
                fi
            elif [[ "$line" == *"export BRANCH_"*"="* ]]; then
                local branch_name=$(echo "$line" | sed -n 's/.*export BRANCH_[^=]*="*\([^"]*\)"*.*/\1/p')
                if [ -n "$branch_name" ]; then
                    branches+=("$branch_name")
                fi
            fi
        done < "$REPO_ROOT/build-config.conf"
    fi
    
    if [ ${#branches[@]} -eq 0 ]; then
        if command -v git >/dev/null 2>&1; then
            local remote_branches=$(git ls-remote --heads "${IMMORTALWRT_URL:-https://github.com/immortalwrt/immortalwrt.git}" 2>/dev/null | \
                awk -F'/' '{print $NF}' | grep -E '^(openwrt-|main|master)' | sort -r | head -5)
            
            if [ -n "$remote_branches" ]; then
                while IFS= read -r branch; do
                    branches+=("$branch")
                done <<< "$remote_branches"
            fi
        fi
    fi
    
    if [ ${#branches[@]} -gt 0 ]; then
        printf '%s\n' "${branches[@]}" | sort -u 2>/dev/null
    else
        echo "openwrt-23.05 openwrt-21.02"
    fi
}

# è·å–æŒ‡å®šå¹³å°ä¸‹çš„æ‰€æœ‰å­å¹³å°
get_subtargets_by_platform() {
    local branch="$1"
    local platform="$2"
    
    local subtargets=()
    local platform_path="target/linux/$platform"
    
    if [ -d "$platform_path" ]; then
        while IFS= read -r subtarget_dir; do
            if [ -n "$subtarget_dir" ]; then
                local subtarget=$(basename "$subtarget_dir")
                case "$subtarget" in
                    image|base-files|config|patches|files|Makefile)
                        continue
                        ;;
                    *)
                        if [ -f "$subtarget_dir/target.mk" ] || [ -f "$subtarget_dir/Makefile" ]; then
                            subtargets+=("$subtarget")
                        fi
                        ;;
                esac
            fi
        done < <(find "$platform_path" -maxdepth 1 -type d ! -path "$platform_path" 2>/dev/null | sort)
        
        if [ ${#subtargets[@]} -eq 0 ] && [ -f "$platform_path/Makefile" ]; then
            local default_subtarget=$(grep -E '^[[:space:]]*SUBTARGETS?[[:space:]]*:?=' "$platform_path/Makefile" 2>/dev/null | \
                sed 's/.*=[[:space:]]*//' | tr -d ' ' | tr ',' ' ')
            
            if [ -n "$default_subtarget" ]; then
                for st in $default_subtarget; do
                    [ -n "$st" ] && subtargets+=("$st")
                done
            else
                subtargets+=("generic")
            fi
        fi
    fi
    
    if [ ${#subtargets[@]} -gt 0 ]; then
        printf '%s\n' "${subtargets[@]}" | sort -u 2>/dev/null | head -10
    else
        echo "generic"
    fi
}

# æ ¹æ®å†…æ ¸ç‰ˆæœ¬æŸ¥æ‰¾é…ç½®æ–‡ä»¶
find_kernel_config_by_version() {
    local platform="$1"
    local subtarget="$2"
    local kernel_version="$3"
    local config_file=""
    
    local search_paths=(
        "target/linux/$platform/$subtarget"
        "target/linux/$platform"
    )
    
    if [ -n "$kernel_version" ]; then
        for search_path in "${search_paths[@]}"; do
            if [ -d "$search_path" ]; then
                config_file=$(find "$search_path" -maxdepth 2 -type f -name "config-${kernel_version}*" 2>/dev/null | head -1)
                if [ -n "$config_file" ]; then
                    echo "$config_file"
                    return
                fi
            fi
        done
    fi
    
    for ver in ${KERNEL_VERSION_PRIORITY:-6.6 6.1 5.15 5.10 5.4}; do
        config_file="target/linux/$platform/config-$ver"
        if [ -f "$config_file" ]; then
            echo "$config_file"
            return
        fi
    done
    
    echo ""
}
#ã€build_firmware_main.sh-23-endã€‘
