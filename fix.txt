#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    local retry_count=${2:-0}
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆå®Œæ•´ä¿®å¤ç‰ˆï¼‰==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    cp .config .config.base
    
    # ğŸ”¥ ä¿®å¤1: æå‰ç¼–è¯‘scripts/configå·¥å…·ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼‰
    if [ ! -f "scripts/config" ] && [ $retry_count -eq 0 ]; then
        log "ğŸ”§ scripts/configå·¥å…·ä¸å­˜åœ¨ï¼Œæ­£åœ¨ç¼–è¯‘..."
        make scripts/config || handle_error "æ— æ³•ç”Ÿæˆscripts/configå·¥å…·"
        log "âœ… scripts/configå·¥å…·ç¼–è¯‘æˆåŠŸ"
        # é‡æ–°è°ƒç”¨è‡ªèº«ï¼Œä½†æ ‡è®°å·²é‡è¯•
        generate_config "$extra_packages" 1
        return
    fi
    
    # ğŸ”¥ ä¿®å¤2: å¦‚æœç¼–è¯‘åä»ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
    if [ ! -f "scripts/config" ]; then
        log "âš ï¸ scripts/configå·¥å…·ä»ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¤‡ç”¨åˆå¹¶æ–¹æ¡ˆ..."
        apply_config_fallback "$extra_packages"
        return
    fi
    
    log "ğŸ”§ ä½¿ç”¨scripts/configå·¥å…·åˆå¹¶é…ç½®..."
    
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "ğŸ“ åº”ç”¨USBé€šç”¨é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$CONFIG_DIR/usb-generic.config"
        log "âœ… USBé€šç”¨é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "ğŸ“ åº”ç”¨åŸºç¡€é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$CONFIG_DIR/base.config"
        log "âœ… åŸºç¡€é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "ğŸ“ åº”ç”¨è®¾å¤‡é…ç½®: $DEVICE.config..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$device_config_file"
        log "âœ… è®¾å¤‡é…ç½®åº”ç”¨å®Œæˆ"
    elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "ğŸ“ åº”ç”¨æ­£å¸¸æ¨¡å¼é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "luci-app-turboacc\|kmod-shortcut-fe\|kmod-fast-classifier"; then
                continue
            fi
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$CONFIG_DIR/normal.config"
        log "âœ… æ­£å¸¸æ¨¡å¼é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "ğŸ“ åº”ç”¨å¹³å°é…ç½®: $(basename "$platform_config")..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$platform_config"
        log "âœ… å¹³å°é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            if [ -n "$pkg" ]; then
                ./scripts/config --enable "PACKAGE_$pkg"
                log "âœ… æ·»åŠ åŒ…: $pkg"
            fi
        done
    fi
    
    log "ğŸ”§ å¼ºåˆ¶å¯ç”¨å…³é”®é…ç½®..."
    ./scripts/config --enable PACKAGE_kmod-usb-xhci-hcd
    ./scripts/config --enable PACKAGE_kmod-usb3
    ./scripts/config --enable PACKAGE_kmod-tcp-bbr
    ./scripts/config --set-str DEFAULT_TCP_CONG "bbr"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        ./scripts/config --enable PACKAGE_luci-app-turboacc
        ./scripts/config --enable PACKAGE_kmod-shortcut-fe
        ./scripts/config --enable PACKAGE_kmod-fast-classifier
        log "âœ… TurboACCé…ç½®å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    fi
    
    ./scripts/config --disable PACKAGE_kmod-ath10k
    ./scripts/config --disable PACKAGE_kmod-ath10k-pci
    ./scripts/config --disable PACKAGE_kmod-ath10k-smallbuffers
    ./scripts/config --disable PACKAGE_kmod-ath10k-ct-smallbuffers
    ./scripts/config --enable PACKAGE_kmod-ath10k-ct
    log "âœ… ath10kå†²çªä¿®å¤å®Œæˆ"
    
    log "ğŸ”„ è¿è¡Œæœ€ç»ˆ make defconfig..."
    make defconfig || handle_error "æœ€ç»ˆé…ç½®åº”ç”¨å¤±è´¥"
    
    log "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•..."
    if grep -q "^[[:space:]]" .config; then
        log "âš ï¸ å‘ç°è¡Œé¦–ç©ºæ ¼ï¼Œæ­£åœ¨ä¿®å¤..."
        sed -i 's/^[[:space:]]*//' .config
    fi
    
    if ! make defconfig > /dev/null 2>&1; then
        handle_error "é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯"
    fi
    log "âœ… é…ç½®æ–‡ä»¶è¯­æ³•éªŒè¯é€šè¿‡"
    
    log "ğŸ“Š é…ç½®ç”Ÿæˆç»Ÿè®¡:"
    log "  - æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "  - é…ç½®è¡Œæ•°: $(wc -l < .config)"
    log "  - é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}

# ğŸ”¥ ä¿®å¤3: æ·»åŠ å¤‡ç”¨é…ç½®åˆå¹¶æ–¹æ¡ˆ
apply_config_fallback() {
    local extra_packages=$1
    log "âš ï¸ ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆåˆå¹¶é…ç½®..."
    
    # ç›´æ¥è¿½åŠ é…ç½®è¡Œï¼Œä½†ç¡®ä¿æ ¼å¼æ­£ç¡®
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        grep "^CONFIG_" "$CONFIG_DIR/usb-generic.config" | sed 's/[[:space:]]*$//' >> .config
    fi
    
    if [ -f "$CONFIG_DIR/base.config" ]; then
        grep "^CONFIG_" "$CONFIG_DIR/base.config" | sed 's/[[:space:]]*$//' >> .config
    fi
    
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        grep "^CONFIG_" "$device_config_file" | sed 's/[[:space:]]*$//' >> .config
    elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        grep "^CONFIG_" "$CONFIG_DIR/normal.config" | grep -v "luci-app-turboacc\|kmod-shortcut-fe\|kmod-fast-classifier" | sed 's/[[:space:]]*$//' >> .config
    fi
    
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        grep "^CONFIG_" "$platform_config" | sed 's/[[:space:]]*$//' >> .config
    fi
    
    # å¼ºåˆ¶æ·»åŠ å…³é”®é…ç½®
    echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # å»é‡
    sort -u .config -o .config
    
    log "ğŸ”„ è¿è¡Œ make defconfig..."
    make defconfig || handle_error "é…ç½®åº”ç”¨å¤±è´¥"
    
    log "âœ… å¤‡ç”¨é…ç½®åˆå¹¶å®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘

#ã€build_firmware_main.sh-31ã€‘
workflow_step15_generate_config() {
    local extra_packages="$1"
    
    log "=== æ­¥éª¤15: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆä¿®å¤ç‰ˆï¼‰==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤15 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    cd $BUILD_DIR
    
    # ğŸ”¥ ä¿®å¤4: æå‰ç¼–è¯‘scripts/configå·¥å…·ï¼Œé¿å…åœ¨generate_configä¸­é‡å¤ç¼–è¯‘
    if [ ! -f "scripts/config" ]; then
        log "ğŸ”§ æå‰ç¼–è¯‘scripts/configå·¥å…·..."
        make scripts/config || {
            log "âš ï¸ ç¼–è¯‘scripts/configå¤±è´¥ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
        }
    fi
    
    generate_config "$extra_packages"
    
    if [ $? -ne 0 ]; then
        echo "âŒ é”™è¯¯: æ™ºèƒ½é…ç½®ç”Ÿæˆå¤±è´¥"
        exit 1
    fi
    
    log "âœ… æ­¥éª¤15 å®Œæˆ"
}
#ã€build_firmware_main.sh-31-endã€‘
