#ã€build_firmware_main.sh-06ã€‘
initialize_build_env() {
    local device_name=$1
    local version_selection=$2
    local config_mode=$3
    
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ç‰ˆæœ¬é€‰æ‹© ==="
    if [ "$version_selection" = "23.05" ]; then
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-23.05"
    else
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-21.02"
    fi
    log "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH"
    
    log "=== å…‹éš†æºç  ==="
    log "ä»“åº“: $SELECTED_REPO_URL"
    log "åˆ†æ”¯: $SELECTED_BRANCH"
    
    sudo rm -rf ./* ./.git* 2>/dev/null || true
    
    git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . || handle_error "å…‹éš†æºç å¤±è´¥"
    log "âœ… æºç å…‹éš†å®Œæˆ"
    
    local important_source_files=("Makefile" "feeds.conf.default" "rules.mk" "Config.in")
    for file in "${important_source_files[@]}"; do
        if [ -f "$file" ]; then
            log "âœ… æºç æ–‡ä»¶å­˜åœ¨: $file"
        else
            log "âŒ æºç æ–‡ä»¶ç¼ºå¤±: $file"
        fi
    done
    
    log "=== è®¾å¤‡é…ç½® ==="
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” è°ƒç”¨support.shè·å–è®¾å¤‡å¹³å°ä¿¡æ¯..."
        PLATFORM_INFO=$("$SUPPORT_SCRIPT" get-platform "$device_name")
        if [ -n "$PLATFORM_INFO" ]; then
            TARGET=$(echo "$PLATFORM_INFO" | awk '{print $1}')
            SUBTARGET=$(echo "$PLATFORM_INFO" | awk '{print $2}')
            DEVICE="$device_name"
            log "âœ… ä»support.shè·å–å¹³å°ä¿¡æ¯: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
        else
            log "âŒ æ— æ³•ä»support.shè·å–å¹³å°ä¿¡æ¯"
            handle_error "è·å–å¹³å°ä¿¡æ¯å¤±è´¥"
        fi
    else
        log "âŒ support.shä¸å­˜åœ¨"
        handle_error "support.shè„šæœ¬ç¼ºå¤±"
    fi
    
    log "ğŸ”§ è®¾å¤‡: $device_name"
    log "ğŸ”§ ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    
    CONFIG_MODE="$config_mode"
    
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ­£ç¡®è¯†åˆ«å’Œä½¿ç”¨ç¼–è¯‘å¥½çš„ config å·¥å…·
    log "=== ç¼–è¯‘é…ç½®å·¥å…· ==="
    
    local config_tool_created=0
    local real_config_tool=""
    
    # æ–¹æ³•1: ç¼–è¯‘ scripts/config
    log "ğŸ”§ å°è¯•æ–¹æ³•1: ç¼–è¯‘ scripts/config..."
    if [ -d "scripts/config" ]; then
        cd scripts/config
        make
        cd $BUILD_DIR
        
        # æ£€æŸ¥ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶
        if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            log "âœ… æ–¹æ³•1æˆåŠŸ: ç¼–è¯‘ç”Ÿæˆ conf å·¥å…·"
            
            # åˆ›å»º config åŒ…è£…è„šæœ¬ï¼Œä½¿ç”¨ conf
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# OpenWrt config å·¥å…·åŒ…è£…è„šæœ¬
# ä½¿ç”¨ç¼–è¯‘ç”Ÿæˆçš„ conf å·¥å…·

CONF_TOOL="$(dirname "$0")/conf"

if [ ! -x "$CONF_TOOL" ]; then
    echo "Error: conf tool not found" >&2
    exit 1
fi

# è½¬æ¢å‚æ•°æ ¼å¼
case "$1" in
    --enable)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=y .config
        ;;
    --disable)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=n .config
        ;;
    --module)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=m .config
        ;;
    --set-str)
        shift
        name="$1"
        value="$2"
        "$CONF_TOOL" --defconfig CONFIG_$name="$value" .config
        shift 2
        ;;
    *)
        "$CONF_TOOL" "$@"
        ;;
esac
EOF
            chmod +x scripts/config/config
            log "âœ… åˆ›å»º config åŒ…è£…è„šæœ¬æˆåŠŸ"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        elif [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
            log "âœ… æ–¹æ³•1æˆåŠŸ: ç¼–è¯‘ç”Ÿæˆ config å·¥å…·"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•2: ç›´æ¥ä½¿ç”¨ conf ä½œä¸ºé…ç½®å·¥å…·
    if [ $config_tool_created -eq 0 ]; then
        if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            log "âœ… æ–¹æ³•2æˆåŠŸ: ç›´æ¥ä½¿ç”¨ conf å·¥å…·"
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# ä½¿ç”¨ conf å·¥å…·çš„åŒ…è£…è„šæœ¬
exec "$(dirname "$0")/conf" "$@"
EOF
            chmod +x scripts/config/config
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•3: ä½¿ç”¨ mconf (å¦‚æœå¯ç”¨)
    if [ $config_tool_created -eq 0 ]; then
        if [ -f "scripts/config/mconf" ] && [ -x "scripts/config/mconf" ]; then
            log "âœ… æ–¹æ³•3æˆåŠŸ: ä½¿ç”¨ mconf å·¥å…·"
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# ä½¿ç”¨ mconf å·¥å…·çš„åŒ…è£…è„šæœ¬
exec "$(dirname "$0")/mconf" "$@"
EOF
            chmod +x scripts/config/config
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•4: ä» SDK å¤åˆ¶
    if [ $config_tool_created -eq 0 ] && [ -n "$COMPILER_DIR" ]; then
        log "ğŸ”§ å°è¯•æ–¹æ³•4: ä» SDK ç›®å½•å¤åˆ¶"
        if [ -f "$COMPILER_DIR/scripts/config/conf" ] && [ -x "$COMPILER_DIR/scripts/config/conf" ]; then
            mkdir -p scripts/config
            cp "$COMPILER_DIR/scripts/config/conf" scripts/config/
            cat > scripts/config/config << 'EOF'
#!/bin/sh
exec "$(dirname "$0")/conf" "$@"
EOF
            chmod +x scripts/config/config
            log "âœ… æ–¹æ³•4æˆåŠŸ: ä» SDK å¤åˆ¶ conf å·¥å…·"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•5: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“å·¥å…·
    if [ $config_tool_created -eq 0 ]; then
        log "ğŸ”§ æ–¹æ³•5: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“ config å·¥å…·"
        mkdir -p scripts/config
        cat > scripts/config/config << 'EOF'
#!/bin/bash
# åŠŸèƒ½å®Œæ•´çš„ config å·¥å…·
CONFIG_FILE=".config"

show_help() {
    echo "Usage: config [options]"
    echo "  --enable <symbol>    Enable a configuration option"
    echo "  --disable <symbol>   Disable a configuration option"
    echo "  --module <symbol>    Set a configuration option as module"
    echo "  --set-str <name> <value> Set a string configuration option"
}

# ç¡®ä¿ .config å­˜åœ¨
if [ ! -f "$CONFIG_FILE" ]; then
    touch "$CONFIG_FILE"
fi

case "$1" in
    --enable)
        shift
        symbol="$1"
        # ç§»é™¤ CONFIG_ å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        symbol="${symbol#CONFIG_}"
        # ç§»é™¤ PACKAGE_ å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        symbol="${symbol#PACKAGE_}"
        
        # åˆ é™¤æ‰€æœ‰ç›¸å…³çš„è¡Œ
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        # æ·»åŠ å¯ç”¨è¡Œ
        echo "CONFIG_PACKAGE_${symbol}=y" >> "$CONFIG_FILE"
        ;;
    --disable)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        echo "# CONFIG_PACKAGE_${symbol} is not set" >> "$CONFIG_FILE"
        ;;
    --module)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        echo "CONFIG_PACKAGE_${symbol}=m" >> "$CONFIG_FILE"
        ;;
    --set-str)
        shift
        name="$1"
        value="$2"
        name="${name#CONFIG_}"
        
        sed -i "/^CONFIG_${name}=/d" "$CONFIG_FILE"
        echo "CONFIG_${name}="$value"" >> "$CONFIG_FILE"
        shift 2
        ;;
    --help)
        show_help
        ;;
    *)
        echo "Unknown option: $1"
        show_help
        exit 1
        ;;
esac
EOF
        chmod +x scripts/config/config
        log "âœ… æ–¹æ³•5æˆåŠŸ: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“ config å·¥å…·"
        real_config_tool="scripts/config/config"
        config_tool_created=1
    fi
    
    # åˆ›å»ºç»Ÿä¸€è°ƒç”¨æ¥å£ - ä¿®å¤ç‰ˆï¼Œä¸ä½¿ç”¨ --help æµ‹è¯•
    if [ $config_tool_created -eq 1 ]; then
        log "ğŸ”§ åˆ›å»ºç»Ÿä¸€è°ƒç”¨æ¥å£..."
        
        # è®°å½•çœŸå®å·¥å…·è·¯å¾„
        echo "$real_config_tool" > scripts/.config_tool_path
        
        # åˆ›å»º scripts/config è½¯é“¾æ¥æˆ–å‰¯æœ¬ï¼Œä»¥ä¾¿ make defconfig èƒ½æ‰¾åˆ°
        if [ ! -f "scripts/config" ]; then
            if [ -f "scripts/config/config" ]; then
                ln -sf config scripts/config 2>/dev/null || cp scripts/config/config scripts/config 2>/dev/null || true
                log "âœ… åˆ›å»º scripts/config é“¾æ¥/å‰¯æœ¬"
            fi
        fi
        
        cat > scripts/config-tool << 'EOF'
#!/bin/sh
# ç»Ÿä¸€ config å·¥å…·è°ƒç”¨æ¥å£
CONFIG_TOOL_PATH="$(dirname "$0")/.config_tool_path"

if [ -f "$CONFIG_TOOL_PATH" ]; then
    CONFIG_TOOL="$(cat "$CONFIG_TOOL_PATH" 2>/dev/null)"
    if [ -n "$CONFIG_TOOL" ] && [ -f "$CONFIG_TOOL" ] && [ -x "$CONFIG_TOOL" ]; then
        exec "$CONFIG_TOOL" "$@"
    fi
fi

# å¤‡é€‰1: ç›´æ¥æŸ¥æ‰¾
if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
    echo "scripts/config/config" > "$CONFIG_TOOL_PATH"
    exec scripts/config/config "$@"
fi

# å¤‡é€‰2: ä½¿ç”¨ conf
if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
    echo "scripts/config/conf" > "$CONFIG_TOOL_PATH"
    exec scripts/config/conf "$@"
fi

# å¤‡é€‰3: ä½¿ç”¨ mconf
if [ -f "scripts/config/mconf" ] && [ -x "scripts/config/mconf" ]; then
    echo "scripts/config/mconf" > "$CONFIG_TOOL_PATH"
    exec scripts/config/mconf "$@"
fi

echo "Error: config tool not found" >&2
exit 1
EOF
        chmod +x scripts/config-tool
        log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£åˆ›å»ºæˆåŠŸ: scripts/config-tool"
        
        # ä¸å†æµ‹è¯• --helpï¼Œè€Œæ˜¯æµ‹è¯•åŸºæœ¬åŠŸèƒ½
        if scripts/config-tool --version > /dev/null 2>&1 || scripts/config-tool -h > /dev/null 2>&1; then
            log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£æµ‹è¯•é€šè¿‡"
        else
            # å°è¯•æµ‹è¯•æ˜¯å¦å­˜åœ¨
            if [ -f scripts/config/config ] || [ -f scripts/config/conf ]; then
                log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£å¯ç”¨ï¼ˆè·³è¿‡å‚æ•°æµ‹è¯•ï¼‰"
            else
                log "âš ï¸ ç»Ÿä¸€è°ƒç”¨æ¥å£å¯èƒ½æœ‰é—®é¢˜ï¼Œä½†å·¥å…·å¯èƒ½ä»å¯ç”¨"
            fi
        fi
    fi
    
    # æœ€ç»ˆéªŒè¯
    if [ $config_tool_created -eq 1 ]; then
        log "âœ… é…ç½®å·¥å…·æœ€ç»ˆéªŒè¯é€šè¿‡"
        log "ğŸ“ çœŸå®å·¥å…·è·¯å¾„: $real_config_tool"
        log "ğŸ“ ç»Ÿä¸€è°ƒç”¨æ¥å£: scripts/config-tool"
        
        # æ˜¾ç¤ºå·¥å…·ä¿¡æ¯
        if [ -f "$real_config_tool" ]; then
            if file "$real_config_tool" | grep -q "ELF"; then
                log "ğŸ“‹ å·¥å…·ç±»å‹: å·²ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶"
            else
                log "ğŸ“‹ å·¥å…·ç±»å‹: Shell è„šæœ¬"
            fi
        fi
    else
        log "âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œé…ç½®å·¥å…·ä¸å­˜åœ¨"
        handle_error "æ— æ³•åˆ›å»ºé…ç½®å·¥å…·"
    fi
    
    save_env
    
    echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
    echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
    echo "TARGET=$TARGET" >> $GITHUB_ENV
    echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
    echo "DEVICE=$DEVICE" >> $GITHUB_ENV
    echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
    
    log "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}
#ã€build_firmware_main.sh-06-endã€‘

#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆè®¾å¤‡æ˜¾å¼æŒ‡å®šç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # æ­¥éª¤1: åˆ›å»ºåŸºç¡€ç›®æ ‡é…ç½®ï¼ˆæ˜¾å¼æŒ‡å®šè®¾å¤‡ï¼‰
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    # æ­¥éª¤2: åˆå¹¶æ‰€æœ‰é…ç½®æ–‡ä»¶
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    # è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è¿½åŠ é…ç½®ï¼ˆè¿‡æ»¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
        fi
    }
    
    append_config "$CONFIG_DIR/base.config"
    append_config "$CONFIG_DIR/usb-generic.config"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    append_config "$CONFIG_DIR/devices/$DEVICE.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/normal.config"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # æ ¹æ®config.txtæ·»åŠ ASUS RT-AC42Uç‰¹å®šé…ç½®
    log "ğŸ“‹ åº”ç”¨ASUS RT-AC42Uç‰¹å®šé…ç½®..."
    
    # åŸºç¡€ä¾èµ–åº“
    echo "CONFIG_GNUTLS_ALPN=y" >> .config
    echo "CONFIG_GNUTLS_ANON=y" >> .config
    echo "CONFIG_GNUTLS_CRYPTODEV=y" >> .config
    echo "CONFIG_GNUTLS_DTLS_SRTP=y" >> .config
    echo "CONFIG_GNUTLS_HEARTBEAT=y" >> .config
    echo "CONFIG_GNUTLS_OCSP=y" >> .config
    echo "CONFIG_GNUTLS_PSK=y" >> .config
    
    # libcurlé…ç½®
    echo "CONFIG_LIBCURL_COOKIES=y" >> .config
    echo "CONFIG_LIBCURL_CRYPTO_AUTH=y" >> .config
    echo "CONFIG_LIBCURL_FILE=y" >> .config
    echo "CONFIG_LIBCURL_FTP=y" >> .config
    echo "CONFIG_LIBCURL_HTTP=y" >> .config
    echo "CONFIG_LIBCURL_NGHTTP2=y" >> .config
    echo "CONFIG_LIBCURL_OPENSSL=y" >> .config
    echo "CONFIG_LIBCURL_PROXY=y" >> .config
    echo "CONFIG_LIBCURL_TFTP=y" >> .config
    echo "CONFIG_LIBCURL_THREADED_RESOLVER=y" >> .config
    echo "CONFIG_LIBCURL_TLS_SRP=y" >> .config
    echo "CONFIG_LIBCURL_UNIX_SOCKETS=y" >> .config
    
    # ath10ké©±åŠ¨å’Œå›ºä»¶
    echo "CONFIG_PACKAGE_ath10k-board-qca988x=y" >> .config
    echo "CONFIG_PACKAGE_ath10k-firmware-qca988x=y" >> .config
    
    # åŸºç¡€å·¥å…·
    echo "CONFIG_PACKAGE_attr=y" >> .config
    echo "CONFIG_PACKAGE_avahi-dbus-daemon=y" >> .config
    echo "CONFIG_PACKAGE_bash=y" >> .config
    echo "CONFIG_PACKAGE_blkid=y" >> .config
    echo "CONFIG_PACKAGE_blockd=y" >> .config
    echo "CONFIG_PACKAGE_bridge=y" >> .config
    echo "CONFIG_PACKAGE_btrfs-progs=y" >> .config
    echo "CONFIG_PACKAGE_cpulimit=y" >> .config
    echo "CONFIG_PACKAGE_curl=y" >> .config
    echo "CONFIG_PACKAGE_dbus=y" >> .config
    echo "CONFIG_PACKAGE_hd-idle=y" >> .config
    echo "CONFIG_PACKAGE_ip-tiny=y" >> .config
    echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
    echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> .config
    echo "CONFIG_PACKAGE_iputils-arping=y" >> .config
    echo "CONFIG_PACKAGE_jq=y" >> .config
    
    # å†…æ ¸æ¨¡å—
    echo "CONFIG_PACKAGE_kmod-crypto-acompress=y" >> .config
    echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    echo "CONFIG_PACKAGE_kmod-fs-autofs4=y" >> .config
    echo "CONFIG_PACKAGE_kmod-fs-btrfs=y" >> .config
    echo "CONFIG_PACKAGE_kmod-ifb=y" >> .config
    echo "CONFIG_PACKAGE_kmod-ipt-conntrack-extra=y" >> .config
    echo "CONFIG_PACKAGE_kmod-ipt-ipopt=y" >> .config
    echo "CONFIG_PACKAGE_kmod-lib-crc32c=y" >> .config
    echo "CONFIG_PACKAGE_kmod-lib-lzo=y" >> .config
    echo "CONFIG_PACKAGE_kmod-lib-raid6=y" >> .config
    echo "CONFIG_PACKAGE_kmod-lib-xor=y" >> .config
    echo "CONFIG_PACKAGE_kmod-lib-zlib-deflate=y" >> .config
    echo "CONFIG_PACKAGE_kmod-lib-zlib-inflate=y" >> .config
    echo "CONFIG_PACKAGE_kmod-lib-zstd=y" >> .config
    echo "CONFIG_PACKAGE_kmod-nls-cp936=y" >> .config
    echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
    echo "CONFIG_PACKAGE_kmod-sched-cake=y" >> .config
    echo "CONFIG_PACKAGE_kmod-sched-core=y" >> .config
    echo "CONFIG_PACKAGE_kmod-scsi-generic=y" >> .config
    echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
    
    # USBé©±åŠ¨ï¼ˆå…¨é¢å¯ç”¨ï¼‰
    echo "CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-ehci=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-ohci-pci=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-serial=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-serial-ftdi=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-serial-pl2303=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-uhci=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-xhci-pci=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb2-pci=y" >> .config
    
    # åº“æ–‡ä»¶
    echo "CONFIG_PACKAGE_libatomic=y" >> .config
    echo "CONFIG_PACKAGE_libattr=y" >> .config
    echo "CONFIG_PACKAGE_libavahi-client=y" >> .config
    echo "CONFIG_PACKAGE_libavahi-dbus-support=y" >> .config
    echo "CONFIG_PACKAGE_libcap=y" >> .config
    echo "CONFIG_PACKAGE_libcurl=y" >> .config
    echo "CONFIG_PACKAGE_libdaemon=y" >> .config
    echo "CONFIG_PACKAGE_libdbus=y" >> .config
    echo "CONFIG_PACKAGE_libevdev=y" >> .config
    echo "CONFIG_PACKAGE_libexpat=y" >> .config
    echo "CONFIG_PACKAGE_libgnutls=y" >> .config
    echo "CONFIG_PACKAGE_liblzo=y" >> .config
    echo "CONFIG_PACKAGE_libmount=y" >> .config
    echo "CONFIG_PACKAGE_libncurses=y" >> .config
    echo "CONFIG_PACKAGE_libnghttp2=y" >> .config
    echo "CONFIG_PACKAGE_libpopt=y" >> .config
    echo "CONFIG_PACKAGE_libreadline=y" >> .config
    echo "CONFIG_PACKAGE_libsmartcols=y" >> .config
    echo "CONFIG_PACKAGE_libtasn1=y" >> .config
    echo "CONFIG_PACKAGE_libtirpc=y" >> .config
    echo "CONFIG_PACKAGE_libudev-zero=y" >> .config
    echo "CONFIG_PACKAGE_liburing=y" >> .config
    echo "CONFIG_PACKAGE_libusb-1.0=y" >> .config
    echo "CONFIG_PACKAGE_libwolfssl=y" >> .config
    echo "CONFIG_PACKAGE_lsblk=y" >> .config
    
    # Luciåº”ç”¨ï¼ˆå…¨é¢å¯ç”¨ï¼‰
    echo "CONFIG_PACKAGE_luci-app-accesscontrol=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-arpbind=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-cpulimit=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-diskman=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-hd-idle=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-sqm=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-vlmcsd=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
    echo "CONFIG_PACKAGE_luci-app-wechatpush=y" >> .config
    
    # Luciä¸­æ–‡è¯­è¨€åŒ…
    echo "CONFIG_PACKAGE_luci-i18n-accesscontrol-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-arpbind-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-cpulimit-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-diskman-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-hd-idle-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-samba4-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-sqm-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-vlmcsd-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-vsftpd-zh-cn=y" >> .config
    echo "CONFIG_PACKAGE_luci-i18n-wechatpush-zh-cn=y" >> .config
    
    # æœåŠ¡å’Œåº”ç”¨
    echo "CONFIG_PACKAGE_miniupnpd=y" >> .config
    echo "CONFIG_PACKAGE_parted=y" >> .config
    echo "CONFIG_PACKAGE_samba4-libs=y" >> .config
    echo "CONFIG_PACKAGE_samba4-server=y" >> .config
    echo "CONFIG_PACKAGE_smartdns=y" >> .config
    echo "CONFIG_PACKAGE_smartmontools=y" >> .config
    echo "CONFIG_PACKAGE_sqm-scripts=y" >> .config
    echo "CONFIG_PACKAGE_tc-mod-iptables=y" >> .config
    echo "CONFIG_PACKAGE_tc-tiny=y" >> .config
    echo "CONFIG_PACKAGE_terminfo=y" >> .config
    echo "CONFIG_PACKAGE_uclibcxx=y" >> .config
    echo "CONFIG_PACKAGE_usbids=y" >> .config
    echo "CONFIG_PACKAGE_usbutils=y" >> .config
    echo "CONFIG_PACKAGE_vlmcsd=y" >> .config
    echo "CONFIG_PACKAGE_vsftpd=y" >> .config
    echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
    echo "CONFIG_PACKAGE_wsdd2=y" >> .config
    
    # æœåŠ¡é…ç½®é€‰é¡¹
    echo "CONFIG_PARTED_READLINE=y" >> .config
    echo "CONFIG_SAMBA4_SERVER_AVAHI=y" >> .config
    echo "CONFIG_SAMBA4_SERVER_NETBIOS=y" >> .config
    echo "CONFIG_SAMBA4_SERVER_VFS=y" >> .config
    echo "CONFIG_SAMBA4_SERVER_WSDD2=y" >> .config
    echo "CONFIG_WOLFSSL_HAS_NO_HW=y" >> .config
    echo "CONFIG_WPA_WOLFSSL=y" >> .config
    
    # ç¡®ä¿wpad-opensslæ˜¯æ¨¡å—åŒ–è€Œä¸æ˜¯å†…ç½®
    echo "CONFIG_PACKAGE_wpad-openssl=m" >> .config
    
    # ç¦ç”¨ä¸å…¼å®¹çš„USBé©±åŠ¨
    echo "# CONFIG_PACKAGE_kmod-usb-xhci-mtk is not set" >> .config
    
    # TCP BBR
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    # TurboACCï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰
    if [ "$CONFIG_MODE" = "normal" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # ath10k å†²çªè§£å†³ï¼ˆä½¿ç”¨cté©±åŠ¨ï¼‰
    sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
    echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
    echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
    
    # æ­¥éª¤3: å»é‡
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤4: è¿è¡Œ make olddefconfig è§£å†³ä¾èµ–å…³ç³»ï¼ˆæ”¹ç”¨ yes "" | make oldconfigï¼‰
    log "ğŸ”„ è¿è¡Œ yes "" | make oldconfig è§£å†³ä¾èµ–å…³ç³»..."
    yes "" | make -j1 oldconfig V=s > /tmp/build-logs/oldconfig.log 2>&1 || {
        log "âŒ make oldconfig å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
        tail -50 /tmp/build-logs/oldconfig.log
        handle_error "ä¾èµ–è§£å†³å¤±è´¥"
    }
    log "âœ… ä¾èµ–å…³ç³»è§£å†³æˆåŠŸ"
    
    # æ­¥éª¤5: åå¤„ç†å¼ºåˆ¶å¯ç”¨å…³é”®USBè½¯ä»¶åŒ…ï¼ˆå¢å¼ºç‰ˆï¼‰
    log "ğŸ”§ åå¤„ç†ï¼šå¼ºåˆ¶å¯ç”¨USBè½¯ä»¶åŒ…ï¼ˆå¢å¼ºç‰ˆï¼‰..."
    
    # å®šä¹‰æ‰€æœ‰å¹³å°å¿…éœ€çš„USBè½¯ä»¶åŒ…ï¼ˆæ‰©å±•åˆ—è¡¨ï¼‰
    local MUST_PACKAGES=(
        # æ ¸å¿ƒé©±åŠ¨
        "kmod-usb-core"
        "kmod-usb-common"
        # USB 2.0/3.0 æ§åˆ¶å™¨
        "kmod-usb2"
        "kmod-usb3"
        "kmod-usb-ehci"
        "kmod-usb-ohci"
        "kmod-usb-xhci-hcd"
        "kmod-usb-xhci-pci"
        "kmod-usb-xhci-plat-hcd"
        # USB å­˜å‚¨
        "kmod-usb-storage"
        "kmod-usb-storage-uas"
        "kmod-usb-storage-extras"
        # SCSI æ”¯æŒ
        "kmod-scsi-core"
        "kmod-scsi-generic"
        # é€šç”¨ USB é©±åŠ¨
        "kmod-usb-dwc3"
        "kmod-usb-dwc3-of-simple"
        # æ–‡ä»¶ç³»ç»Ÿ
        "kmod-fs-ext4"
        "kmod-fs-vfat"
        "kmod-fs-exfat"
        "kmod-fs-ntfs3"
        # ç¼–ç æ”¯æŒ
        "kmod-nls-utf8"
        "kmod-nls-cp936"
        # æŒ‚è½½å·¥å…·
        "block-mount"
        "automount"
        # å®ç”¨å·¥å…·
        "usbutils"
        "lsusb"
        # ä¸²å£æ”¯æŒï¼ˆå¯é€‰ä½†å¸¸ç”¨ï¼‰
        "kmod-usb-serial"
    )
    
    # å¹³å°ç‰¹å®šè½¯ä»¶åŒ…ï¼ˆæ‰©å±•ï¼‰
    case "$TARGET" in
        ipq40xx)
            MUST_PACKAGES+=(
                "kmod-usb-dwc3-qcom"
                "kmod-phy-qcom-dwc3"
            )
            ;;
        ramips)
            MUST_PACKAGES+=(
                "kmod-usb-xhci-mtk"
                "kmod-usb-ohci-pci"
                "kmod-usb2-pci"
            )
            ;;
        mediatek)
            MUST_PACKAGES+=(
                "kmod-usb-dwc3-mediatek"
                "kmod-phy-mediatek"
            )
            ;;
        ath79)
            MUST_PACKAGES+=(
                "kmod-usb2-ath79"
                "kmod-usb-ohci"
            )
            ;;
    esac
    
    # å¼ºåˆ¶å†™å…¥.configï¼ˆåˆ é™¤å¯èƒ½å­˜åœ¨çš„ç¦ç”¨/æ¨¡å—è¡Œï¼Œæ·»åŠ =yï¼‰
    for pkg in "${MUST_PACKAGES[@]}"; do
        sed -i "/^CONFIG_PACKAGE_${pkg}=/d" .config
        sed -i "/^# CONFIG_PACKAGE_${pkg} is not set/d" .config
        echo "CONFIG_PACKAGE_${pkg}=y" >> .config
    done
    
    # å†æ¬¡ç¡®ä¿è®¾å¤‡é€‰é¡¹å­˜åœ¨ï¼ˆé˜²æ­¢è¢«è¦†ç›–ï¼‰
    if ! grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" .config; then
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
    fi
    
    # å†æ¬¡å»é‡
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤6: å†æ¬¡è¿è¡Œ yes "" | make oldconfig åº”ç”¨å¼ºåˆ¶é…ç½®ï¼ˆä¸é‡ç½®ï¼‰
    log "ğŸ”„ å†æ¬¡è¿è¡Œ yes "" | make oldconfig åº”ç”¨å¼ºåˆ¶é…ç½®..."
    
    # ä¿å­˜å½“å‰é…ç½®å¤‡ä»½
    cp .config .config.force
    
    # ä½¿ç”¨ yes "" | make oldconfig è¿è¡Œä»¥è·å–è¯¦ç»†è¾“å‡º
    if ! yes "" | make -j1 oldconfig V=s > /tmp/build-logs/oldconfig2.log 2>&1; then
        log "âŒ make oldconfig å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—..."
        echo "=== oldconfig2.log æœ€å50è¡Œ ==="
        tail -50 /tmp/build-logs/oldconfig2.log
        echo "================================"
        
        # å°è¯•æ¢å¤å¤‡ä»½å¹¶ç»§ç»­
        if [ -f ".config.force" ]; then
            log "ğŸ”„ å°è¯•æ¢å¤å¼ºåˆ¶é…ç½®å¹¶ç»§ç»­..."
            cp .config.force .config
        else
            handle_error "å¼ºåˆ¶é…ç½®åº”ç”¨å¤±è´¥"
        fi
    else
        log "âœ… make oldconfig æˆåŠŸ"
    fi
    
    # æ­¥éª¤7: æœ€ç»ˆéªŒè¯
    log "ğŸ“‹ å¿…éœ€USBé©±åŠ¨çŠ¶æ€éªŒè¯:"
    local missing=()
    local missing_optional=()
    
    for pkg in "${MUST_PACKAGES[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${pkg}=y" .config; then
            log "  âœ… $pkg: å·²å¯ç”¨"
        else
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¹³å°ç‰¹å®šåŒ…
            local is_optional=0
            case "$pkg" in
                kmod-usb-dwc3-qcom|kmod-phy-qcom-dwc3|kmod-usb-xhci-mtk|kmod-usb-dwc3-mediatek|kmod-phy-mediatek|kmod-usb2-ath79|kmod-usb-ohci-pci|kmod-usb2-pci)
                    is_optional=1
                    ;;
            esac
            
            if [ $is_optional -eq 1 ]; then
                log "  âš ï¸ $pkg: æœªå¯ç”¨ï¼ˆå¹³å°å¯é€‰ï¼‰"
                missing_optional+=("$pkg")
            else
                log "  âŒ $pkg: æœªå¯ç”¨"
                missing+=("$pkg")
            fi
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        log "âš ï¸ è­¦å‘Š: ä»¥ä¸‹å¿…éœ€é©±åŠ¨æœªå¯ç”¨: ${missing[*]}"
        log "ğŸ’¡ å¯èƒ½åŸå› : å†…æ ¸ä¸æ”¯æŒæˆ–å¹³å°æœªåŒ…å«ç›¸åº”é©±åŠ¨"
    else
        log "ğŸ‰ æ‰€æœ‰å¿…éœ€USBé©±åŠ¨å·²æˆåŠŸå¯ç”¨ï¼"
    fi
    
    if [ ${#missing_optional[@]} -gt 0 ]; then
        log "â„¹ï¸ å¯é€‰é©±åŠ¨æœªå¯ç”¨: ${missing_optional[*]}"
        log "ğŸ’¡ å¦‚æœç¡¬ä»¶éœ€è¦è¿™äº›é©±åŠ¨ï¼Œè¯·æ£€æŸ¥å¹³å°æ”¯æŒ"
    fi
    
    # æœ€ç»ˆè®¾å¤‡éªŒè¯ï¼ˆå¢å¼ºç‰ˆï¼šå°è¯•å¤šç§åŒ¹é…æ–¹å¼ï¼Œå¹¶ä½¿ç”¨ scripts/config å·¥å…·å’Œ make defconfigï¼‰
    log "ğŸ” æ­£åœ¨éªŒè¯è®¾å¤‡ $DEVICE æ˜¯å¦è¢«é€‰ä¸­..."
    
    local device_selected=""
    local device_patterns=(
        "^CONFIG_TARGET_DEVICE_.*${DEVICE}=y"
        "^CONFIG_TARGET_DEVICE_.*${DEVICE^^}=y"
        "^CONFIG_TARGET_DEVICE_.*${DEVICE,,}=y"
        "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y"
        "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE^^}=y"
        "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE,,}=y"
    )
    
    for pattern in "${device_patterns[@]}"; do
        device_selected=$(grep -E "$pattern" .config | head -1)
        if [ -n "$device_selected" ]; then
            log "âœ… ç›®æ ‡è®¾å¤‡å·²åŒ¹é…: $device_selected"
            break
        fi
    done
    
    if [ -z "$device_selected" ]; then
        log "âŒ é”™è¯¯: ç›®æ ‡è®¾å¤‡ $DEVICE æœªè¢«é€‰ä¸­ï¼"
        log "å½“å‰å¯ç”¨çš„è®¾å¤‡é€‰é¡¹:"
        grep -E "^CONFIG_TARGET_DEVICE_.*=y|^CONFIG_TARGET_.*_DEVICE_.*=y" .config | head -20 | sed 's/^/  /' || echo "  æ²¡æœ‰å¯ç”¨çš„è®¾å¤‡é€‰é¡¹"
        
        # å°è¯•è‡ªåŠ¨ä¿®å¤
        log "ğŸ”„ å°è¯•è‡ªåŠ¨ä¿®å¤ï¼šä½¿ç”¨ scripts/config å·¥å…·å¯ç”¨è®¾å¤‡é€‰é¡¹..."
        
        local config_tool=""
        if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
            config_tool="scripts/config/config"
        elif [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            config_tool="scripts/config/conf"
        fi
        
        # å‡†å¤‡è®¾å¤‡åå˜ä½“
        local device_upper="${DEVICE^^}"
        local device_lower="${DEVICE,,}"
        local device_capital="$(echo ${DEVICE:0:1} | tr '[:lower:]' '[:upper:]')${DEVICE:1}"
        
        if [ -n "$config_tool" ]; then
            # ä½¿ç”¨é…ç½®å·¥å…·å¯ç”¨è®¾å¤‡é€‰é¡¹ï¼ˆå°è¯•å¤šç§æ ¼å¼ï¼‰
            log "ğŸ”§ ä½¿ç”¨é…ç½®å·¥å…· $config_tool å¯ç”¨è®¾å¤‡..."
            
            # å…ˆç¦ç”¨å¯èƒ½çš„å†²çªé€‰é¡¹
            $config_tool --disable TARGET_DEVICE_${TARGET}_${SUBTARGET}_DEVICE_${device_upper} 2>/dev/null || true
            $config_tool --disable TARGET_DEVICE_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} 2>/dev/null || true
            $config_tool --disable TARGET_DEVICE_${TARGET}_${SUBTARGET}_DEVICE_${device_capital} 2>/dev/null || true
            $config_tool --disable TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_upper} 2>/dev/null || true
            $config_tool --disable TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} 2>/dev/null || true
            $config_tool --disable TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_capital} 2>/dev/null || true
            
            # å¯ç”¨è®¾å¤‡é€‰é¡¹
            $config_tool --enable TARGET_DEVICE_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} 2>/dev/null || true
            $config_tool --enable TARGET_DEVICE_${TARGET}_${SUBTARGET}_DEVICE_${device_upper} 2>/dev/null || true
            $config_tool --enable TARGET_DEVICE_${TARGET}_${SUBTARGET}_DEVICE_${device_capital} 2>/dev/null || true
            $config_tool --enable TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} 2>/dev/null || true
            $config_tool --enable TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_upper} 2>/dev/null || true
            $config_tool --enable TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_capital} 2>/dev/null || true
        else
            # ç›´æ¥å†™å…¥å¤šç§æ ¼å¼
            log "âš ï¸ é…ç½®å·¥å…·ä¸å¯ç”¨ï¼Œç›´æ¥å†™å…¥å¤šç§è®¾å¤‡æ ¼å¼..."
            echo "CONFIG_TARGET_DEVICE_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
            echo "CONFIG_TARGET_DEVICE_${TARGET}_${SUBTARGET}_DEVICE_${device_upper}=y" >> .config
            echo "CONFIG_TARGET_DEVICE_${TARGET}_${SUBTARGET}_DEVICE_${device_capital}=y" >> .config
            echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
            echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_upper}=y" >> .config
            echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_capital}=y" >> .config
        fi
        
        # å»é‡
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        
        log "ğŸ”„ é‡æ–°è¿è¡Œ make defconfig ä»¥åº”ç”¨è®¾å¤‡é€‰æ‹©..."
        if make defconfig > /tmp/build-logs/defconfig_fix.log 2>&1; then
            log "âœ… make defconfig ä¿®å¤æˆåŠŸ"
            
            # å†æ¬¡æ£€æŸ¥
            for pattern in "${device_patterns[@]}"; do
                device_selected=$(grep -E "$pattern" .config | head -1)
                if [ -n "$device_selected" ]; then
                    log "âœ… ä¿®å¤åè®¾å¤‡å·²é€‰ä¸­: $device_selected"
                    break
                fi
            done
        else
            log "âŒ make defconfig ä¿®å¤å¤±è´¥"
            cat /tmp/build-logs/defconfig_fix.log
        fi
    fi
    
    if [ -z "$device_selected" ]; then
        # æœ€ç»ˆå¤±è´¥
        log "âŒ é”™è¯¯: æ— æ³•è‡ªåŠ¨ä¿®å¤è®¾å¤‡é€‰æ‹©é—®é¢˜"
        log "è¯·æ£€æŸ¥è®¾å¤‡åç§°æ˜¯å¦æ­£ç¡®ï¼Œæˆ–æ‰‹åŠ¨é…ç½®è®¾å¤‡ã€‚"
        log "å½“å‰å¯ç”¨çš„è®¾å¤‡é€‰é¡¹ï¼ˆå‰20ä¸ªï¼‰:"
        grep -E "^CONFIG_TARGET_DEVICE_.*=y|^CONFIG_TARGET_.*_DEVICE_.*=y" .config | head -20 | sed 's/^/  /' || echo "  æ²¡æœ‰å¯ç”¨çš„è®¾å¤‡é€‰é¡¹"
        handle_error "è®¾å¤‡é…ç½®é”™è¯¯"
    fi
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘

#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆç«‹å³é€€å‡ºç‰ˆï¼‰- å¢å¼ºç‰ˆï¼Œè‡ªåŠ¨ä¿®å¤é…ç½®é—®é¢˜ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: SELECTED_BRANCH=$SELECTED_BRANCH, TARGET=$TARGET"
        echo "âœ… COMPILER_DIR=$COMPILER_DIR"
        echo "âœ… CONFIG_MODE=$CONFIG_MODE"
    else
        echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ ($BUILD_DIR/build_env.sh)"
        echo "ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤08å’Œæ­¥éª¤09æ˜¯å¦æˆåŠŸæ‰§è¡Œ"
        exit 1
    fi
    
    cd $BUILD_DIR
    echo "=== ğŸš¨ å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆç«‹å³é€€å‡ºç‰ˆï¼‰- å¢å¼ºç‰ˆ ==="
    
    echo ""
    echo "1. âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    if [ -f ".config" ]; then
        echo "  âœ… .config æ–‡ä»¶å­˜åœ¨"
        echo "  ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
        echo "  ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < .config)"
        
        # æ£€æŸ¥å…³é”®é…ç½®é¡¹æ˜¯å¦å­˜åœ¨
        echo "  ğŸ” æ£€æŸ¥ASUS RT-AC42Uå…³é”®é…ç½®é¡¹:"
        local key_configs=(
            "CONFIG_PACKAGE_kmod-phy-qcom-dwc3"
            "CONFIG_PACKAGE_kmod-usb-xhci-hcd"
            "CONFIG_PACKAGE_luci-app-samba4"
            "CONFIG_PACKAGE_luci-app-diskman"
            "CONFIG_PACKAGE_kmod-ath10k-ct"
        )
        
        for config in "${key_configs[@]}"; do
            if grep -q "^${config}=y" .config; then
                echo "    âœ… $config: å·²å¯ç”¨"
            else
                echo "    âŒ $config: æœªå¯ç”¨"
            fi
        done
    else
        echo "  âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨"
        echo "  ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤15æ™ºèƒ½é…ç½®ç”Ÿæˆæ˜¯å¦æˆåŠŸ"
        exit 1
    fi
    
    echo ""
    echo "2. âœ… SDKç›®å½•æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "  âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
        echo "  ğŸ“Š ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | awk '{print $1}' || echo 'æœªçŸ¥')"
        
        GCC_FILE=$(find "$COMPILER_DIR" -type f -executable           -name "*gcc"           ! -name "*gcc-ar"           ! -name "*gcc-ranlib"           ! -name "*gcc-nm"           ! -path "*dummy-tools*"           ! -path "*scripts*"           2>/dev/null | head -1)
        
        if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
            echo "  âœ… æ‰¾åˆ°å¯æ‰§è¡ŒGCCç¼–è¯‘å™¨: $(basename "$GCC_FILE")"
            echo "  ğŸ”§ GCCç‰ˆæœ¬: $("$GCC_FILE" --version 2>&1 | head -1)"
        else
            echo "  âŒ é”™è¯¯: SDKç›®å½•ä¸­æœªæ‰¾åˆ°çœŸæ­£çš„GCCç¼–è¯‘å™¨"
            exit 1
        fi
    else
        echo "  âŒ é”™è¯¯: SDKç›®å½•ä¸å­˜åœ¨: $COMPILER_DIR"
        echo "  ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤09 SDKä¸‹è½½æ˜¯å¦æˆåŠŸ"
        exit 1
    fi
    
    echo ""
    echo "3. âœ… Feedsæ£€æŸ¥:"
    if [ -d "feeds" ]; then
        echo "  âœ… feeds ç›®å½•å­˜åœ¨"
        echo "  ğŸ“Š feedsç›®å½•å¤§å°: $(du -sh feeds 2>/dev/null | awk '{print $1}' || echo 'æœªçŸ¥')"
        
        # æ£€æŸ¥å…³é”®feeds
        if [ -d "feeds/packages" ]; then
            echo "  âœ… packages feed: å­˜åœ¨"
        else
            echo "  âŒ packages feed: ä¸å­˜åœ¨"
        fi
        
        if [ -d "feeds/luci" ]; then
            echo "  âœ… luci feed: å­˜åœ¨"
        else
            echo "  âŒ luci feed: ä¸å­˜åœ¨"
        fi
    else
        echo "  âŒ é”™è¯¯: feeds ç›®å½•ä¸å­˜åœ¨"
        echo "  ğŸ’¡ è¯·æ£€æŸ¥æ­¥éª¤12é…ç½®Feedsæ˜¯å¦æˆåŠŸ"
        exit 1
    fi
    
    echo ""
    echo "4. âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1 | awk '{print $1}')
    AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
    echo "  ğŸ“Š /mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
    
    if [ $AVAILABLE_GB -lt 10 ]; then
        echo "  âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
        exit 1
    elif [ $AVAILABLE_GB -lt 20 ]; then
        echo "  âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
    else
        echo "  âœ… ç£ç›˜ç©ºé—´å……è¶³"
    fi
    
    echo ""
    echo "5. âœ… USBé…ç½®æ£€æŸ¥ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰:"
    USB_FIXED=0
    
    # USB 3.0é©±åŠ¨
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        echo "  âŒ é”™è¯¯: USB 3.0é©±åŠ¨æœªå¯ç”¨ (kmod-usb-xhci-hcd)"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-usb-xhci-hcd
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb-xhci-hcd"
        else
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb-xhci-hcd"
        fi
        USB_FIXED=1
    else
        echo "  âœ… kmod-usb-xhci-hcd: å·²å¯ç”¨"
    fi
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        echo "  âŒ é”™è¯¯: USB 3.0é©±åŠ¨æœªå¯ç”¨ (kmod-usb3)"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-usb3
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb3"
        else
            echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb3"
        fi
        USB_FIXED=1
    else
        echo "  âœ… kmod-usb3: å·²å¯ç”¨"
    fi
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config; then
        echo "  âŒ é”™è¯¯: USB 2.0é©±åŠ¨æœªå¯ç”¨ (kmod-usb2)"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-usb2
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb2"
        else
            echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb2"
        fi
        USB_FIXED=1
    else
        echo "  âœ… kmod-usb2: å·²å¯ç”¨"
    fi
    
    # å¹³å°ä¸“ç”¨é©±åŠ¨
    if [ "$TARGET" = "ipq40xx" ]; then
        if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
            echo "  âŒ é”™è¯¯: IPQ40xxå¹³å°é©±åŠ¨æœªå¯ç”¨ (kmod-phy-qcom-dwc3)"
            echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
            if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_kmod-phy-qcom-dwc3
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-phy-qcom-dwc3"
            else
                echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-phy-qcom-dwc3"
            fi
            USB_FIXED=1
        else
            echo "  âœ… kmod-phy-qcom-dwc3: å·²å¯ç”¨"
        fi
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y" .config; then
            echo "  âŒ é”™è¯¯: IPQ40xxå¹³å°USB DWC3é©±åŠ¨æœªå¯ç”¨ (kmod-usb-dwc3-of-simple)"
            echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
            if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_kmod-usb-dwc3-of-simple
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb-dwc3-of-simple"
            else
                echo "CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y" >> .config
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-usb-dwc3-of-simple"
            fi
            USB_FIXED=1
        else
            echo "  âœ… kmod-usb-dwc3-of-simple: å·²å¯ç”¨"
        fi
    fi
    
    echo ""
    echo "6. âœ… TurboACCé…ç½®æ£€æŸ¥ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰:"
    TURBOACC_FIXED=0
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            echo "  âŒ é”™è¯¯: TurboACCæœªå¯ç”¨ (æ­£å¸¸æ¨¡å¼å¿…éœ€)"
            echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
            if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_luci-app-turboacc
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : luci-app-turboacc"
            else
                echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            fi
            TURBOACC_FIXED=1
        else
            echo "  âœ… luci-app-turboacc: å·²å¯ç”¨"
        fi
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-shortcut-fe=y" .config; then
            echo "  âŒ é”™è¯¯: Shortcut-FEæœªå¯ç”¨"
            echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
            if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_kmod-shortcut-fe
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-shortcut-fe"
            else
                echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            fi
            TURBOACC_FIXED=1
        else
            echo "  âœ… kmod-shortcut-fe: å·²å¯ç”¨"
        fi
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-fast-classifier=y" .config; then
            echo "  âŒ é”™è¯¯: Fast Classifieræœªå¯ç”¨"
            echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
            if [ -f "scripts/config/config" ]; then
                ./scripts/config/config --enable PACKAGE_kmod-fast-classifier
                echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-fast-classifier"
            else
                echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
            fi
            TURBOACC_FIXED=1
        else
            echo "  âœ… kmod-fast-classifier: å·²å¯ç”¨"
        fi
    else
        echo "  â„¹ï¸ åŸºç¡€æ¨¡å¼ï¼Œä¸æ£€æŸ¥TurboACCé…ç½®"
    fi
    
    echo ""
    echo "7. âœ… TCP BBRæ‹¥å¡æ§åˆ¶æ£€æŸ¥ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰:"
    BBR_FIXED=0
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
        echo "  âŒ é”™è¯¯: TCP BBRæœªå¯ç”¨"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --enable PACKAGE_kmod-tcp-bbr
            echo "  âœ… å·²å¼ºåˆ¶æ·»åŠ : kmod-tcp-bbr"
        else
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        BBR_FIXED=1
    else
        echo "  âœ… kmod-tcp-bbr: å·²å¯ç”¨"
    fi
    
    if ! grep -q '^CONFIG_DEFAULT_TCP_CONG="bbr"' .config; then
        echo "  âŒ é”™è¯¯: TCP BBRæœªè®¾ç½®ä¸ºé»˜è®¤æ‹¥å¡æ§åˆ¶ç®—æ³•"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        if [ -f "scripts/config/config" ]; then
            ./scripts/config/config --set-str DEFAULT_TCP_CONG "bbr"
            echo "  âœ… å·²è®¾ç½®: DEFAULT_TCP_CONG="bbr""
        else
            sed -i '/^CONFIG_DEFAULT_TCP_CONG=/d' .config
            echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        fi
        BBR_FIXED=1
    else
        echo "  âœ… DEFAULT_TCP_CONG="bbr": å·²è®¾ç½®"
    fi
    
    echo ""
    echo "8. âœ… ath10ké©±åŠ¨å†²çªæ£€æŸ¥ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰:"
    ATH10K_FIXED=0
    
    if grep -q "^CONFIG_PACKAGE_kmod-ath10k=y" .config; then
        echo "  âŒ é”™è¯¯: æ£€æµ‹åˆ°æ ‡å‡†ath10ké©±åŠ¨ï¼Œä¸ath10k-ctå†²çª"
        echo "  ğŸ”§ æ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
        sed -i '/^CONFIG_PACKAGE_kmod-ath10k=y/d' .config
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-ath10k-ct=y" .config; then
            echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        fi
        ATH10K_FIXED=1
        echo "  âœ… å·²ä¿®å¤: ç¦ç”¨æ ‡å‡†ath10kï¼Œå¯ç”¨ath10k-ct"
    else
        echo "  âœ… ath10ké©±åŠ¨é…ç½®æ­£ç¡®"
    fi
    
    if [ $USB_FIXED -eq 1 ] || [ $TURBOACC_FIXED -eq 1 ] || [ $BBR_FIXED -eq 1 ] || [ $ATH10K_FIXED -eq 1 ]; then
        echo ""
        echo "ğŸ”„ é…ç½®å·²ä¿®å¤ï¼Œé‡æ–°è¿è¡Œ make defconfig..."
        make defconfig
        
        echo ""
        echo "ğŸ“‹ ä¿®å¤åé…ç½®çŠ¶æ€:"
        echo "  - kmod-usb2: $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        echo "  - kmod-usb3: $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        echo "  - kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        
        if [ "$TARGET" = "ipq40xx" ]; then
            echo "  - kmod-usb-dwc3-qcom: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-phy-qcom-dwc3: $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-usb-dwc3-of-simple: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        fi
        
        if [ "$CONFIG_MODE" = "normal" ]; then
            echo "  - luci-app-turboacc: $(grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-shortcut-fe: $(grep -q "^CONFIG_PACKAGE_kmod-shortcut-fe=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-fast-classifier: $(grep -q "^CONFIG_PACKAGE_kmod-fast-classifier=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        fi
        
        echo "  - kmod-tcp-bbr: $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        echo "  - DEFAULT_TCP_CONG: $(grep "^CONFIG_DEFAULT_TCP_CONG=" .config | cut -d'"' -f2 || echo 'æœªè®¾ç½®')"
        echo "  - ath10k-ct: $(grep -q "^CONFIG_PACKAGE_kmod-ath10k-ct=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        
        echo "âœ… æ‰€æœ‰é…ç½®ä¿®å¤å®Œæˆ"
    else
        echo ""
        echo "âœ… æ‰€æœ‰é…ç½®æ£€æŸ¥é€šè¿‡ï¼Œæ— éœ€ä¿®å¤"
    fi
    
    echo ""
    echo "========================================"
    echo "âœ…âœ…âœ… æ‰€æœ‰å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}
#ã€build_firmware_main.sh-37-endã€‘
