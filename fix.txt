#ã€build_firmware_main.sh-00.5ã€‘
# åŠ è½½ç»Ÿä¸€é…ç½®æ–‡ä»¶
load_build_config() {
    local config_file="${1:-$REPO_ROOT/build-config.conf}"
    
    if [ -f "$config_file" ]; then
        log "ğŸ“ åŠ è½½ç»Ÿä¸€é…ç½®æ–‡ä»¶: $config_file"
        source "$config_file"
        export CONFIG_LOADED=1
    else
        log "âš ï¸ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $config_fileï¼Œä½¿ç”¨è„šæœ¬å†…é»˜è®¤å€¼"
    fi
    
    # å¯¼å‡ºæ‰€æœ‰é…ç½®ä¸ºç¯å¢ƒå˜é‡
    export BUILD_DIR LOG_DIR BACKUP_DIR CONFIG_DIR
    export IMMORTALWRT_URL PACKAGES_FEED_URL LUCI_FEED_URL TURBOACC_FEED_URL
    export ENABLE_TURBOACC ENABLE_TCP_BBR FORCE_ATH10K_CT AUTO_FIX_USB_DRIVERS
    export ENABLE_DYNAMIC_KERNEL_DETECTION ENABLE_DYNAMIC_PLATFORM_DRIVERS ENABLE_DYNAMIC_DEVICE_MAPPING
    
    log "âœ… é…ç½®åŠ è½½å®Œæˆ"
}

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
CONFIG_FILE="$REPO_ROOT/build-config.conf"

# åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œ
if [ -z "$CONFIG_LOADED" ] && [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
    load_build_config
fi
#ã€build_firmware_main.sh-00.5-endã€‘

#ã€build_firmware_main.sh-31ã€‘
workflow_step15_generate_config() {
    local extra_packages="$1"
    
    log "=== æ­¥éª¤15: æ™ºèƒ½é…ç½®ç”Ÿæˆã€ä¿®å¤ç‰ˆã€‘ ==="
    log "å½“å‰è®¾å¤‡: $DEVICE"
    log "å½“å‰ç›®æ ‡: $TARGET"
    log "å½“å‰å­ç›®æ ‡: $SUBTARGET"
    
    set -e
    trap 'echo "âŒ æ­¥éª¤15 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    # ç¡®ä¿ç¯å¢ƒå˜é‡å·²åŠ è½½
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        log "âœ… ä»ç¯å¢ƒæ–‡ä»¶é‡æ–°åŠ è½½: DEVICE=$DEVICE, TARGET=$TARGET"
    fi
    
    # å¦‚æœDEVICEä¸ºç©ºï¼Œå°è¯•ä»å‚æ•°è·å–
    if [ -z "$DEVICE" ] && [ -n "$2" ]; then
        DEVICE="$2"
        log "âš ï¸ DEVICEä¸ºç©ºï¼Œä½¿ç”¨å‚æ•°: $DEVICE"
    fi
    
    # è®¾å¤‡åè½¬æ¢ - é’ˆå¯¹ac42uçš„ç‰¹æ®Šå¤„ç†
    local device_for_config="$DEVICE"
    case "$DEVICE" in
        ac42u|rt-ac42u)
            device_for_config="asus_rt-ac42u"
            log "ğŸ”§ è®¾å¤‡åè½¬æ¢: $DEVICE -> $device_for_config"
            ;;
        acrh17|rt-acrh17)
            device_for_config="asus_rt-acrh17"
            log "ğŸ”§ è®¾å¤‡åè½¬æ¢: $DEVICE -> $device_for_config"
            ;;
        *)
            # é»˜è®¤è½¬æ¢ï¼šè½¬å°å†™ï¼Œæ¨ªçº¿å˜ä¸‹åˆ’çº¿
            device_for_config=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
            ;;
    esac
    
    generate_config "$extra_packages" "$device_for_config"
    
    log "âœ… æ­¥éª¤15 å®Œæˆ"
}
#ã€build_firmware_main.sh-31-endã€‘
