#ã€build_firmware_main.sh-06ã€‘
initialize_build_env() {
    local device_name=$1
    local version_selection=$2
    local config_mode=$3
    
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ç‰ˆæœ¬é€‰æ‹© ==="
    if [ "$version_selection" = "23.05" ]; then
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-23.05"
    else
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-21.02"
    fi
    log "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH"
    
    log "=== å…‹éš†æºç  ==="
    log "ä»“åº“: $SELECTED_REPO_URL"
    log "åˆ†æ”¯: $SELECTED_BRANCH"
    
    sudo rm -rf ./* ./.git* 2>/dev/null || true
    
    git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . || handle_error "å…‹éš†æºç å¤±è´¥"
    log "âœ… æºç å…‹éš†å®Œæˆ"
    
    local important_source_files=("Makefile" "feeds.conf.default" "rules.mk" "Config.in")
    for file in "${important_source_files[@]}"; do
        if [ -f "$file" ]; then
            log "âœ… æºç æ–‡ä»¶å­˜åœ¨: $file"
        else
            log "âŒ æºç æ–‡ä»¶ç¼ºå¤±: $file"
        fi
    done
    
    log "=== è®¾å¤‡é…ç½® ==="
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” è°ƒç”¨support.shè·å–è®¾å¤‡å¹³å°ä¿¡æ¯..."
        PLATFORM_INFO=$("$SUPPORT_SCRIPT" get-platform "$device_name")
        if [ -n "$PLATFORM_INFO" ]; then
            TARGET=$(echo "$PLATFORM_INFO" | awk '{print $1}')
            SUBTARGET=$(echo "$PLATFORM_INFO" | awk '{print $2}')
            DEVICE="$device_name"
            log "âœ… ä»support.shè·å–å¹³å°ä¿¡æ¯: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
        else
            log "âŒ æ— æ³•ä»support.shè·å–å¹³å°ä¿¡æ¯"
            handle_error "è·å–å¹³å°ä¿¡æ¯å¤±è´¥"
        fi
    else
        log "âŒ support.shä¸å­˜åœ¨"
        handle_error "support.shè„šæœ¬ç¼ºå¤±"
    fi
    
    log "ğŸ”§ è®¾å¤‡: $device_name"
    log "ğŸ”§ ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    
    CONFIG_MODE="$config_mode"
    
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ­£ç¡®è¯†åˆ«å’Œä½¿ç”¨ç¼–è¯‘å¥½çš„ config å·¥å…·
    log "=== ç¼–è¯‘é…ç½®å·¥å…· ==="
    
    local config_tool_created=0
    local real_config_tool=""
    
    # æ–¹æ³•1: ç¼–è¯‘ scripts/config
    log "ğŸ”§ å°è¯•æ–¹æ³•1: ç¼–è¯‘ scripts/config..."
    if [ -d "scripts/config" ]; then
        cd scripts/config
        make
        cd $BUILD_DIR
        
        # æ£€æŸ¥ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶
        if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            log "âœ… æ–¹æ³•1æˆåŠŸ: ç¼–è¯‘ç”Ÿæˆ conf å·¥å…·"
            
            # åˆ›å»º config åŒ…è£…è„šæœ¬ï¼Œä½¿ç”¨ conf
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# OpenWrt config å·¥å…·åŒ…è£…è„šæœ¬
# ä½¿ç”¨ç¼–è¯‘ç”Ÿæˆçš„ conf å·¥å…·

CONF_TOOL="$(dirname "$0")/conf"

if [ ! -x "$CONF_TOOL" ]; then
    echo "Error: conf tool not found" >&2
    exit 1
fi

# è½¬æ¢å‚æ•°æ ¼å¼
case "$1" in
    --enable)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=y .config
        ;;
    --disable)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=n .config
        ;;
    --module)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=m .config
        ;;
    --set-str)
        shift
        name="$1"
        value="$2"
        "$CONF_TOOL" --defconfig CONFIG_$name="$value" .config
        shift 2
        ;;
    *)
        "$CONF_TOOL" "$@"
        ;;
esac
EOF
            chmod +x scripts/config/config
            log "âœ… åˆ›å»º config åŒ…è£…è„šæœ¬æˆåŠŸ"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        elif [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
            log "âœ… æ–¹æ³•1æˆåŠŸ: ç¼–è¯‘ç”Ÿæˆ config å·¥å…·"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•2: ç›´æ¥ä½¿ç”¨ conf ä½œä¸ºé…ç½®å·¥å…·
    if [ $config_tool_created -eq 0 ]; then
        if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            log "âœ… æ–¹æ³•2æˆåŠŸ: ç›´æ¥ä½¿ç”¨ conf å·¥å…·"
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# ä½¿ç”¨ conf å·¥å…·çš„åŒ…è£…è„šæœ¬
exec "$(dirname "$0")/conf" "$@"
EOF
            chmod +x scripts/config/config
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•3: ä½¿ç”¨ mconf (å¦‚æœå¯ç”¨)
    if [ $config_tool_created -eq 0 ]; then
        if [ -f "scripts/config/mconf" ] && [ -x "scripts/config/mconf" ]; then
            log "âœ… æ–¹æ³•3æˆåŠŸ: ä½¿ç”¨ mconf å·¥å…·"
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# ä½¿ç”¨ mconf å·¥å…·çš„åŒ…è£…è„šæœ¬
exec "$(dirname "$0")/mconf" "$@"
EOF
            chmod +x scripts/config/config
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•4: ä» SDK å¤åˆ¶
    if [ $config_tool_created -eq 0 ] && [ -n "$COMPILER_DIR" ]; then
        log "ğŸ”§ å°è¯•æ–¹æ³•4: ä» SDK ç›®å½•å¤åˆ¶"
        if [ -f "$COMPILER_DIR/scripts/config/conf" ] && [ -x "$COMPILER_DIR/scripts/config/conf" ]; then
            mkdir -p scripts/config
            cp "$COMPILER_DIR/scripts/config/conf" scripts/config/
            cat > scripts/config/config << 'EOF'
#!/bin/sh
exec "$(dirname "$0")/conf" "$@"
EOF
            chmod +x scripts/config/config
            log "âœ… æ–¹æ³•4æˆåŠŸ: ä» SDK å¤åˆ¶ conf å·¥å…·"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•5: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“å·¥å…·
    if [ $config_tool_created -eq 0 ]; then
        log "ğŸ”§ æ–¹æ³•5: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“ config å·¥å…·"
        mkdir -p scripts/config
        cat > scripts/config/config << 'EOF'
#!/bin/bash
# åŠŸèƒ½å®Œæ•´çš„ config å·¥å…·
CONFIG_FILE=".config"

show_help() {
    echo "Usage: config [options]"
    echo "  --enable <symbol>    Enable a configuration option"
    echo "  --disable <symbol>   Disable a configuration option"
    echo "  --module <symbol>    Set a configuration option as module"
    echo "  --set-str <name> <value> Set a string configuration option"
}

# ç¡®ä¿ .config å­˜åœ¨
if [ ! -f "$CONFIG_FILE" ]; then
    touch "$CONFIG_FILE"
fi

case "$1" in
    --enable)
        shift
        symbol="$1"
        # ç§»é™¤ CONFIG_ å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        symbol="${symbol#CONFIG_}"
        # ç§»é™¤ PACKAGE_ å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        symbol="${symbol#PACKAGE_}"
        
        # åˆ é™¤æ‰€æœ‰ç›¸å…³çš„è¡Œ
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        # æ·»åŠ å¯ç”¨è¡Œ
        echo "CONFIG_PACKAGE_${symbol}=y" >> "$CONFIG_FILE"
        ;;
    --disable)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        echo "# CONFIG_PACKAGE_${symbol} is not set" >> "$CONFIG_FILE"
        ;;
    --module)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        echo "CONFIG_PACKAGE_${symbol}=m" >> "$CONFIG_FILE"
        ;;
    --set-str)
        shift
        name="$1"
        value="$2"
        name="${name#CONFIG_}"
        
        sed -i "/^CONFIG_${name}=/d" "$CONFIG_FILE"
        echo "CONFIG_${name}=\"$value\"" >> "$CONFIG_FILE"
        shift 2
        ;;
    --help)
        show_help
        ;;
    *)
        echo "Unknown option: $1"
        show_help
        exit 1
        ;;
esac
EOF
        chmod +x scripts/config/config
        log "âœ… æ–¹æ³•5æˆåŠŸ: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“ config å·¥å…·"
        real_config_tool="scripts/config/config"
        config_tool_created=1
    fi
    
    # åˆ›å»ºç»Ÿä¸€è°ƒç”¨æ¥å£
    if [ $config_tool_created -eq 1 ]; then
        log "ğŸ”§ åˆ›å»ºç»Ÿä¸€è°ƒç”¨æ¥å£..."
        
        # è®°å½•çœŸå®å·¥å…·è·¯å¾„
        echo "$real_config_tool" > scripts/.config_tool_path
        
        cat > scripts/config-tool << EOF
#!/bin/sh
# ç»Ÿä¸€ config å·¥å…·è°ƒç”¨æ¥å£
CONFIG_TOOL="\$(cat "\$(dirname "\$0")/.config_tool_path" 2>/dev/null)"
if [ -n "\$CONFIG_TOOL" ] && [ -f "\$CONFIG_TOOL" ] && [ -x "\$CONFIG_TOOL" ]; then
    exec "\$CONFIG_TOOL" "\$@"
fi

# å¤‡é€‰1: ç›´æ¥æŸ¥æ‰¾
if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
    echo "scripts/config/config" > "\$(dirname "\$0")/.config_tool_path"
    exec scripts/config/config "\$@"
fi

# å¤‡é€‰2: ä½¿ç”¨ conf
if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
    exec scripts/config/conf "\$@"
fi

echo "Error: config tool not found" >&2
exit 1
EOF
        chmod +x scripts/config-tool
        log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£åˆ›å»ºæˆåŠŸ: scripts/config-tool"
        
        # æµ‹è¯•å·¥å…·
        if scripts/config-tool --help > /dev/null 2>&1; then
            log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£æµ‹è¯•é€šè¿‡"
        else
            log "âš ï¸ ç»Ÿä¸€è°ƒç”¨æ¥å£æµ‹è¯•å¤±è´¥ï¼Œä½†å·¥å…·å¯èƒ½ä»å¯ç”¨"
        fi
    fi
    
    # æœ€ç»ˆéªŒè¯
    if [ $config_tool_created -eq 1 ]; then
        log "âœ… é…ç½®å·¥å…·æœ€ç»ˆéªŒè¯é€šè¿‡"
        log "ğŸ“ çœŸå®å·¥å…·è·¯å¾„: $real_config_tool"
        log "ğŸ“ ç»Ÿä¸€è°ƒç”¨æ¥å£: scripts/config-tool"
        
        # æ˜¾ç¤ºå·¥å…·ä¿¡æ¯
        if [ -f "$real_config_tool" ]; then
            if file "$real_config_tool" | grep -q "ELF"; then
                log "ğŸ“‹ å·¥å…·ç±»å‹: å·²ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶"
            else
                log "ğŸ“‹ å·¥å…·ç±»å‹: Shell è„šæœ¬"
            fi
        fi
    else
        log "âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œé…ç½®å·¥å…·ä¸å­˜åœ¨"
        handle_error "æ— æ³•åˆ›å»ºé…ç½®å·¥å…·"
    fi
    
    save_env
    
    echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
    echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
    echo "TARGET=$TARGET" >> $GITHUB_ENV
    echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
    echo "DEVICE=$DEVICE" >> $GITHUB_ENV
    echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
    
    log "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}
#ã€build_firmware_main.sh-06-endã€‘

#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆä¾èµ–é“¾å®Œæ•´ç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # åˆ›å»ºåŸºç¡€é…ç½®
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    # æ£€æŸ¥é…ç½®å·¥å…·
    local CONFIG_CMD="./scripts/config/config"
    if [ ! -f "$CONFIG_CMD" ] || [ ! -x "$CONFIG_CMD" ]; then
        if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            log "âœ… ä½¿ç”¨ conf å·¥å…·"
            CONFIG_CMD="./scripts/config/conf"
        elif [ -f "scripts/config-tool" ] && [ -x "scripts/config-tool" ]; then
            log "âœ… ä½¿ç”¨ config-tool"
            CONFIG_CMD="./scripts/config-tool"
        else
            log "âš ï¸ ä½¿ç”¨å†…ç½®ç®€æ˜“å·¥å…·"
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/bash
CONFIG_FILE=".config"
case "$1" in
    --enable)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        echo "CONFIG_PACKAGE_${symbol}=y" >> "$CONFIG_FILE"
        ;;
    --disable)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        echo "# CONFIG_PACKAGE_${symbol} is not set" >> "$CONFIG_FILE"
        ;;
esac
EOF
            chmod +x scripts/config/config
            CONFIG_CMD="./scripts/config/config"
        fi
    fi
    
    log "ğŸ”§ ä½¿ç”¨é…ç½®å·¥å…·: $CONFIG_CMD"
    
    # åº”ç”¨é…ç½®æ–‡ä»¶
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "ğŸ“ åº”ç”¨USBé€šç”¨é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | sed 's/^CONFIG_//')
                $CONFIG_CMD --enable "$config_name"
            fi
        done < "$CONFIG_DIR/usb-generic.config"
        log "âœ… USBé€šç”¨é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "ğŸ“ åº”ç”¨åŸºç¡€é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | sed 's/^CONFIG_//')
                $CONFIG_CMD --enable "$config_name"
            fi
        done < "$CONFIG_DIR/base.config"
        log "âœ… åŸºç¡€é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "ğŸ“ åº”ç”¨è®¾å¤‡é…ç½®: $DEVICE.config..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | sed 's/^CONFIG_//')
                $CONFIG_CMD --enable "$config_name"
            fi
        done < "$device_config_file"
        log "âœ… è®¾å¤‡é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "ğŸ“ åº”ç”¨æ­£å¸¸æ¨¡å¼é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | sed 's/^CONFIG_//')
                $CONFIG_CMD --enable "$config_name"
            fi
        done < "$CONFIG_DIR/normal.config"
        log "âœ… æ­£å¸¸æ¨¡å¼é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    # å¹³å°ä¸“ç”¨é…ç½®
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "ğŸ“ åº”ç”¨å¹³å°é…ç½®: $(basename "$platform_config")..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | sed 's/^CONFIG_//')
                $CONFIG_CMD --enable "$config_name"
            fi
        done < "$platform_config"
        log "âœ… å¹³å°é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            if [ -n "$pkg" ]; then
                $CONFIG_CMD --enable "PACKAGE_$pkg"
                log "âœ… æ·»åŠ åŒ…: $pkg"
            fi
        done
    fi
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šå®Œæ•´çš„ä¾èµ–é“¾é…ç½®
    log "ğŸ”§ å¯ç”¨å®Œæ•´çš„ä¾èµ–é“¾..."
    
    # USB æ ¸å¿ƒä¾èµ–é“¾
    $CONFIG_CMD --enable PACKAGE_kmod-usb-core
    
    # USB 2.0 å®Œæ•´ä¾èµ–é“¾
    $CONFIG_CMD --enable PACKAGE_kmod-usb2
    $CONFIG_CMD --enable PACKAGE_kmod-usb-ehci
    $CONFIG_CMD --enable PACKAGE_kmod-usb-ohci
    $CONFIG_CMD --enable PACKAGE_kmod-usb-uhci
    
    # USB 3.0 å®Œæ•´ä¾èµ–é“¾ - å…³é”®ä¿®å¤
    log "ğŸ”§ å¯ç”¨ USB 3.0 å®Œæ•´ä¾èµ–é“¾..."
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-hcd
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-hcd-dbg
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-mtk
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-pci
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-plat-hcd
    $CONFIG_CMD --enable PACKAGE_kmod-usb3
    
    # USB å­˜å‚¨å®Œæ•´ä¾èµ–é“¾
    $CONFIG_CMD --enable PACKAGE_kmod-scsi-core
    $CONFIG_CMD --enable PACKAGE_kmod-usb-storage
    $CONFIG_CMD --enable PACKAGE_kmod-usb-storage-extras
    $CONFIG_CMD --enable PACKAGE_kmod-usb-storage-uas
    
    # æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
    $CONFIG_CMD --enable PACKAGE_kmod-fs-ext4
    $CONFIG_CMD --enable PACKAGE_kmod-fs-vfat
    $CONFIG_CMD --enable PACKAGE_kmod-fs-exfat
    $CONFIG_CMD --enable PACKAGE_kmod-fs-ntfs3
    $CONFIG_CMD --enable PACKAGE_kmod-nls-utf8
    $CONFIG_CMD --enable PACKAGE_kmod-nls-cp936
    $CONFIG_CMD --enable PACKAGE_kmod-nls-cp437
    $CONFIG_CMD --enable PACKAGE_kmod-nls-iso8859-1
    
    # IPQ40xx å¹³å°ä¸“ç”¨ USB å®Œæ•´ä¾èµ–é“¾
    if [ "$TARGET" = "ipq40xx" ]; then
        log "ğŸ”§ å¯ç”¨ IPQ40xx å¹³å° USB å®Œæ•´ä¾èµ–é“¾..."
        
        # DWC3 æ ¸å¿ƒ
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3-of-simple
        
        # QCOM ä¸“ç”¨é©±åŠ¨
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3-qcom
        $CONFIG_CMD --enable PACKAGE_kmod-phy-qcom-dwc3
        $CONFIG_CMD --enable PACKAGE_kmod-usb-phy-msm
        
        # USB è§’è‰²åˆ‡æ¢
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3-role-switch
        
        # ä¾èµ–çš„å†…æ ¸é…ç½®
        $CONFIG_CMD --enable PACKAGE_kernel
        $CONFIG_CMD --enable PACKAGE_kmod-usb-common
        
        log "âœ… IPQ40xx USB å®Œæ•´ä¾èµ–é“¾å¯ç”¨å®Œæˆ"
    fi
    
    # TCP BBR æ‹¥å¡æ§åˆ¶
    $CONFIG_CMD --enable PACKAGE_kmod-tcp-bbr
    $CONFIG_CMD --set-str DEFAULT_TCP_CONG "bbr"
    
    # ath10k å†²çªè§£å†³
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-pci
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-smallbuffers
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-ct-smallbuffers
    $CONFIG_CMD --enable PACKAGE_kmod-ath10k-ct
    
    # TurboACC é…ç½®
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "ğŸ”§ å¯ç”¨ TurboACC ç»„ä»¶..."
        $CONFIG_CMD --enable PACKAGE_luci-app-turboacc
        $CONFIG_CMD --enable PACKAGE_kmod-shortcut-fe
        $CONFIG_CMD --enable PACKAGE_kmod-shortcut-fe-cm
        $CONFIG_CMD --enable PACKAGE_kmod-fast-classifier
        log "âœ… TurboACC ç»„ä»¶å¯ç”¨å®Œæˆ"
    fi
    
    log "ğŸ”„ è¿è¡Œ make defconfig è§£å†³ä¾èµ–å…³ç³»..."
    make defconfig || handle_error "æœ€ç»ˆé…ç½®åº”ç”¨å¤±è´¥"
    
    # å†æ¬¡æ£€æŸ¥å…³é”®é©±åŠ¨å¹¶å¼ºåˆ¶å†™å…¥ï¼ˆå¦‚æœä»æœªå¯ç”¨ï¼‰
    log "ğŸ”§ äºŒæ¬¡æ£€æŸ¥å…³é”®é©±åŠ¨..."
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        log "âš ï¸ kmod-usb-xhci-hcd ä»æœªå¯ç”¨ï¼Œæ£€æŸ¥ä¾èµ–..."
        # æ£€æŸ¥æ˜¯å¦å› ä¸ºå†…æ ¸ç‰ˆæœ¬é—®é¢˜
        if grep -q "CONFIG_TARGET_ipq40xx=y" .config; then
            echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        fi
        make defconfig
    fi
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && [ "$TARGET" = "ipq40xx" ]; then
        log "âš ï¸ kmod-phy-qcom-dwc3 ä»æœªå¯ç”¨ï¼Œå¼ºåˆ¶å¯ç”¨..."
        echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config
        make defconfig
    fi
    
    log "ğŸ“‹ å…³é”®é…ç½®çŠ¶æ€ï¼ˆæœ€ç»ˆï¼‰:"
    log "  - kmod-usb-core: $(grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb3: $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb2: $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    if [ "$TARGET" = "ipq40xx" ]; then
        log "  - kmod-usb-dwc3-qcom: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        log "  - kmod-phy-qcom-dwc3: $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
