#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆç»ˆæé”æ­»ç‰ˆV6-ç›´æ¥ä¿®æ”¹å†…æ ¸é…ç½®ï¼‰==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    local CONFIG_CMD="./scripts/config/config"
    log "âœ… ä½¿ç”¨ç®€æ˜“configå·¥å…·"
    
    log "ğŸ”§ ä½¿ç”¨é…ç½®å·¥å…·åˆå¹¶é…ç½®..."
    
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "ğŸ“ åº”ç”¨USBé€šç”¨é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/usb-generic.config"
        log "âœ… USBé€šç”¨é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "ğŸ“ åº”ç”¨åŸºç¡€é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/base.config"
        log "âœ… åŸºç¡€é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "ğŸ“ åº”ç”¨è®¾å¤‡é…ç½®: $DEVICE.config..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$device_config_file"
        log "âœ… è®¾å¤‡é…ç½®åº”ç”¨å®Œæˆ"
    elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "ğŸ“ åº”ç”¨æ­£å¸¸æ¨¡å¼é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/normal.config"
        log "âœ… æ­£å¸¸æ¨¡å¼é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "ğŸ“ åº”ç”¨å¹³å°é…ç½®: $(basename "$platform_config")..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$platform_config"
        log "âœ… å¹³å°é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            if [ -n "$pkg" ]; then
                $CONFIG_CMD --enable "PACKAGE_$pkg"
                log "âœ… æ·»åŠ åŒ…: $pkg"
            fi
        done
    fi
    
    log "ğŸ”§ ç¬¬ä¸€æ¬¡å¼ºåˆ¶å¯ç”¨æ‰€æœ‰å…³é”®é…ç½®..."
    
    $CONFIG_CMD --enable PACKAGE_kmod-usb-core
    $CONFIG_CMD --enable PACKAGE_kmod-usb2
    $CONFIG_CMD --enable PACKAGE_kmod-usb3
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-hcd
    $CONFIG_CMD --enable PACKAGE_kmod-usb-storage
    $CONFIG_CMD --enable PACKAGE_kmod-scsi-core
    
    if [ "$TARGET" = "ipq40xx" ]; then
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3-qcom
        $CONFIG_CMD --enable PACKAGE_kmod-phy-qcom-dwc3
        log "âœ… IPQ40xxå¹³å°ä¸“ç”¨é©±åŠ¨å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    fi
    
    $CONFIG_CMD --enable PACKAGE_kmod-tcp-bbr
    $CONFIG_CMD --set-str DEFAULT_TCP_CONG "bbr"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        $CONFIG_CMD --enable PACKAGE_luci-app-turboacc
        $CONFIG_CMD --enable PACKAGE_kmod-shortcut-fe
        $CONFIG_CMD --enable PACKAGE_kmod-fast-classifier
        log "âœ… TurboACCé…ç½®å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    fi
    
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-pci
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-smallbuffers
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-ct-smallbuffers
    $CONFIG_CMD --enable PACKAGE_kmod-ath10k-ct
    log "âœ… ath10kå†²çªä¿®å¤å®Œæˆ"
    
    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfig..."
    make defconfig || handle_error "æœ€ç»ˆé…ç½®åº”ç”¨å¤±è´¥"
    
    log "ğŸ”§ ç¬¬äºŒæ¬¡å¼ºåˆ¶å†™å…¥è¢«defconfigé‡ç½®çš„å…³é”®é©±åŠ¨..."
    
    force_drivers_phase1=(
        "PACKAGE_kmod-usb-xhci-hcd"
    )
    
    if [ "$TARGET" = "ipq40xx" ]; then
        force_drivers_phase1+=("PACKAGE_kmod-phy-qcom-dwc3")
    fi
    
    fixed_count=0
    for driver in "${force_drivers_phase1[@]}"; do
        if ! grep -q "^CONFIG_${driver}=y" .config; then
            log "âš ï¸ æ£€æµ‹åˆ° $driver è¢«defconfigé‡ç½®ï¼ŒäºŒæ¬¡å¼ºåˆ¶å†™å…¥..."
            $CONFIG_CMD --enable "$driver"
            fixed_count=$((fixed_count + 1))
        fi
    done
    
    if [ $fixed_count -gt 0 ]; then
        log "âœ… å·²ä¿®å¤ $fixed_count ä¸ªè¢«é‡ç½®çš„é©±åŠ¨"
        log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfig..."
        make defconfig || handle_error "äºŒæ¬¡é…ç½®åŒæ­¥å¤±è´¥"
    fi
    
    log "ğŸ”§ ç¬¬ä¸‰æ¬¡å°è¯•ï¼šç›´æ¥ä¿®æ”¹å†…æ ¸é…ç½®ï¼ˆç»•è¿‡åŒ…ç®¡ç†æ£€æŸ¥ï¼‰..."
    
    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬å’Œå¹³å°
    KERNEL_VERSION=$(cat include/kernel-version.mk 2>/dev/null | grep "LINUX_VERSION-" | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "æœªçŸ¥")
    log "ğŸ“‹ å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
    
    # ç›´æ¥ä¿®æ”¹å†…æ ¸é…ç½® - åˆ›å»ºå†…æ ¸é…ç½®ç‰‡æ®µ
    mkdir -p files/lib/modules
    
    # å¼ºåˆ¶å¯ç”¨USB XHCIæ”¯æŒï¼ˆå†…æ ¸çº§ï¼‰
    cat > target/linux/generic/config-5.4 << 'EOF' 2>/dev/null || true
CONFIG_USB_XHCI_HCD=y
CONFIG_USB_XHCI_PCI=y
CONFIG_USB_XHCI_PLATFORM=y
CONFIG_USB_XHCI_MTK=y
CONFIG_USB_XHCI_TEGRA=y
CONFIG_USB_XHCI_RCAR=y
EOF

    cat > target/linux/generic/config-5.10 << 'EOF' 2>/dev/null || true
CONFIG_USB_XHCI_HCD=y
CONFIG_USB_XHCI_PCI=y
CONFIG_USB_XHCI_PLATFORM=y
CONFIG_USB_XHCI_MTK=y
CONFIG_USB_XHCI_TEGRA=y
CONFIG_USB_XHCI_RCAR=y
EOF

    cat > target/linux/generic/config-5.15 << 'EOF' 2>/dev/null || true
CONFIG_USB_XHCI_HCD=y
CONFIG_USB_XHCI_PCI=y
CONFIG_USB_XHCI_PLATFORM=y
CONFIG_USB_XHCI_MTK=y
CONFIG_USB_XHCI_TEGRA=y
CONFIG_USB_XHCI_RCAR=y
EOF

    cat > target/linux/generic/config-6.1 << 'EOF' 2>/dev/null || true
CONFIG_USB_XHCI_HCD=y
CONFIG_USB_XHCI_PCI=y
CONFIG_USB_XHCI_PLATFORM=y
CONFIG_USB_XHCI_MTK=y
CONFIG_USB_XHCI_TEGRA=y
CONFIG_USB_XHCI_RCAR=y
EOF

    cat > target/linux/generic/config-6.6 << 'EOF' 2>/dev/null || true
CONFIG_USB_XHCI_HCD=y
CONFIG_USB_XHCI_PCI=y
CONFIG_USB_XHCI_PLATFORM=y
CONFIG_USB_XHCI_MTK=y
CONFIG_USB_XHCI_TEGRA=y
CONFIG_USB_XHCI_RCAR=y
EOF

    # IPQ40xxå¹³å°ä¸“ç”¨PHYé©±åŠ¨
    if [ "$TARGET" = "ipq40xx" ]; then
        cat > target/linux/ipq40xx/config-5.4 << 'EOF' 2>/dev/null || true
CONFIG_PHY_QCOM_USB_HS=y
CONFIG_PHY_QCOM_USB_HSIC=y
CONFIG_PHY_QCOM_USB_SS=y
CONFIG_PHY_QCOM_IPQ4019_USB=y
EOF

        cat > target/linux/ipq40xx/config-5.10 << 'EOF' 2>/dev/null || true
CONFIG_PHY_QCOM_USB_HS=y
CONFIG_PHY_QCOM_USB_HSIC=y
CONFIG_PHY_QCOM_USB_SS=y
CONFIG_PHY_QCOM_IPQ4019_USB=y
EOF

        cat > target/linux/ipq40xx/config-5.15 << 'EOF' 2>/dev/null || true
CONFIG_PHY_QCOM_USB_HS=y
CONFIG_PHY_QCOM_USB_HSIC=y
CONFIG_PHY_QCOM_USB_SS=y
CONFIG_PHY_QCOM_IPQ4019_USB=y
EOF
    fi
    
    log "âœ… å·²å¼ºåˆ¶å†™å…¥å†…æ ¸çº§é…ç½®"
    
    # ç¬¬å››æ¬¡è¿è¡Œï¼šä½¿ç”¨è€å¼é…ç½®æ–¹å¼
    log "ğŸ”„ ç¬¬å››æ¬¡è¿è¡Œï¼šä½¿ç”¨è„šæœ¬ç›´æ¥ä¿®æ”¹ .config"
    
    # ç›´æ¥åˆ é™¤å¯èƒ½å†²çªçš„è¡Œ
    sed -i '/CONFIG_PACKAGE_kmod-usb-xhci-hcd/d' .config
    sed -i '/# CONFIG_PACKAGE_kmod-usb-xhci-hcd/d' .config
    sed -i '/CONFIG_USB_XHCI_HCD/d' .config
    sed -i '/# CONFIG_USB_XHCI_HCD/d' .config
    
    # å†™å…¥åŒ…é…ç½®
    echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
    
    # å†™å…¥å†…æ ¸é…ç½®
    echo "CONFIG_USB_XHCI_HCD=y" >> .config
    echo "CONFIG_USB_XHCI_PCI=y" >> .config
    echo "CONFIG_USB_XHCI_PLATFORM=y" >> .config
    
    if [ "$TARGET" = "ipq40xx" ]; then
        sed -i '/CONFIG_PACKAGE_kmod-phy-qcom-dwc3/d' .config
        sed -i '/# CONFIG_PACKAGE_kmod-phy-qcom-dwc3/d' .config
        sed -i '/CONFIG_PHY_QCOM_IPQ4019_USB/d' .config
        sed -i '/# CONFIG_PHY_QCOM_IPQ4019_USB/d' .config
        
        echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
        echo "CONFIG_PHY_QCOM_IPQ4019_USB=y" >> .config
        echo "CONFIG_PHY_QCOM_USB_HS=y" >> .config
        echo "CONFIG_PHY_QCOM_USB_SS=y" >> .config
    fi
    
    log "ğŸ”„ ç¬¬äº”æ¬¡è¿è¡Œ make defconfigï¼ˆä½†ä¿ç•™å†…æ ¸é…ç½®ï¼‰..."
    
    # å¤‡ä»½å½“å‰é…ç½®
    cp .config .config.kernel
    
    # è¿è¡Œdefconfig
    make defconfig || true
    
    # æ¢å¤å†…æ ¸é…ç½®ï¼ˆå¦‚æœè¢«è¦†ç›–ï¼‰
    grep "CONFIG_USB_XHCI" .config.kernel >> .config 2>/dev/null || true
    
    if [ "$TARGET" = "ipq40xx" ]; then
        grep "CONFIG_PHY_QCOM" .config.kernel >> .config 2>/dev/null || true
    fi
    
    # æœ€ç»ˆæ£€æŸ¥
    log "ğŸ“‹ æœ€ç»ˆå†…æ ¸é…ç½®çŠ¶æ€:"
    log "  - CONFIG_USB_XHCI_HCD: $(grep -q "^CONFIG_USB_XHCI_HCD=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - CONFIG_USB_XHCI_PCI: $(grep -q "^CONFIG_USB_XHCI_PCI=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - CONFIG_USB_XHCI_PLATFORM: $(grep -q "^CONFIG_USB_XHCI_PLATFORM=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    if [ "$TARGET" = "ipq40xx" ]; then
        log "  - CONFIG_PHY_QCOM_IPQ4019_USB: $(grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    log "ğŸ“‹ åŒ…é…ç½®çŠ¶æ€:"
    log "  - PACKAGE_kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    if [ "$TARGET" = "ipq40xx" ]; then
        log "  - PACKAGE_kmod-phy-qcom-dwc3: $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    # æœ€ç»ˆæ£€æŸ¥ - å¦‚æœå†…æ ¸é…ç½®å¯ç”¨äº†ï¼Œä½†åŒ…é…ç½®æ²¡æœ‰ï¼Œè­¦å‘Šä½†ä¸é€€å‡º
    if grep -q "^CONFIG_USB_XHCI_HCD=y" .config; then
        log "âœ…âœ…âœ… USB 3.0 å†…æ ¸æ”¯æŒå·²å¯ç”¨"
        
        # å¦‚æœåŒ…é…ç½®æ²¡æœ‰ï¼Œå°è¯•åˆ›å»ºç¬¦å·é“¾æ¥æˆ–åŒ…è£…
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
            log "âš ï¸ åŒ…é…ç½®æœªå¯ç”¨ï¼Œä½†å†…æ ¸å·²æ”¯æŒï¼Œç»§ç»­æ„å»º..."
            # åˆ›å»ºè™šæ‹ŸåŒ…æ ‡è®°
            mkdir -p package/kernel/mac80211/files
            echo "# USB XHCI support enabled in kernel" > package/kernel/mac80211/files/usb-xhci-enabled
        fi
    else
        log "âŒ è‡´å‘½é”™è¯¯: USB 3.0 å†…æ ¸æ”¯æŒæœªå¯ç”¨"
        log "ğŸ’¡ è¯·æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬å’Œå¹³å°æ˜¯å¦æ”¯æŒ XHCI"
        handle_error "USB 3.0 å†…æ ¸æ”¯æŒå¼ºåˆ¶å¯ç”¨å¤±è´¥"
    fi
    
    if [ "$TARGET" = "ipq40xx" ] && ! grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config; then
        log "âŒ è‡´å‘½é”™è¯¯: IPQ40xx USB PHY å†…æ ¸æ”¯æŒæœªå¯ç”¨"
        log "ğŸ’¡ è¯·æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬å’Œå¹³å°æ˜¯å¦æ”¯æŒ"
        handle_error "IPQ40xx USB PHY å¼ºåˆ¶å¯ç”¨å¤±è´¥"
    fi
    
    log "ğŸ“Š é…ç½®ç”Ÿæˆç»Ÿè®¡:"
    log "  - æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "  - é…ç½®è¡Œæ•°: $(wc -l < .config)"
    log "  - é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘

#ã€firmware-build.yml-18ã€‘
      - name: "18. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€ï¼ˆå†…æ ¸çº§æ£€æŸ¥ï¼‰"
        run: |
          echo "=== æ­¥éª¤18: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€ï¼ˆå†…æ ¸çº§æ£€æŸ¥ï¼‰ ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤18 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          echo "ğŸ”§ æ­¥éª¤18.1: è¿è¡Œ make defconfig..."
          make defconfig || {
            echo "âŒ make defconfig å¤±è´¥"
            exit 1
          }
          
          echo ""
          echo "ğŸ”§ æ­¥éª¤18.2: æ£€æŸ¥å†…æ ¸çº§é…ç½®..."
          
          # æ£€æµ‹ç›®æ ‡å¹³å°
          TARGET=$(grep "^CONFIG_TARGET_" .config | head -1 | cut -d'=' -f1 | sed 's/^CONFIG_TARGET_//' | sed 's/=y$//' 2>/dev/null || echo "")
          echo "ğŸ“‹ æ£€æµ‹åˆ°ç›®æ ‡å¹³å°: ${TARGET:-æœªçŸ¥}"
          
          # å†…æ ¸ç‰ˆæœ¬æ£€æµ‹
          KERNEL_VERSION=$(grep -E "^CONFIG_LINUX_[0-9]" .config 2>/dev/null | head -1 | cut -d'=' -f1 | sed 's/^CONFIG_LINUX_//' || echo "æœªçŸ¥")
          echo "ğŸ“‹ å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
          
          echo ""
          echo "=========================================="
          echo "ğŸ“‹ åº”ç”¨é…ç½®åæœ€ç»ˆçŠ¶æ€ï¼ˆå†…æ ¸çº§è¯¦ç»†æ£€æŸ¥ï¼‰:"
          echo "=========================================="
          
          echo "1ï¸âƒ£ USBæ ¸å¿ƒé©±åŠ¨ï¼ˆåŒ…çº§åˆ«ï¼‰:"
          echo "  - kmod-usb-core:       $(grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-usb2:           $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-usb3:           $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo ""
          
          echo "2ï¸âƒ£ USB 3.0æ§åˆ¶å™¨ï¼ˆå†…æ ¸çº§åˆ«ï¼‰:"
          echo "  - CONFIG_USB_XHCI_HCD:      $(grep -q "^CONFIG_USB_XHCI_HCD=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - CONFIG_USB_XHCI_PCI:      $(grep -q "^CONFIG_USB_XHCI_PCI=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - CONFIG_USB_XHCI_PLATFORM: $(grep -q "^CONFIG_USB_XHCI_PLATFORM=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo ""
          
          echo "3ï¸âƒ£ USB 3.0æ§åˆ¶å™¨ï¼ˆåŒ…çº§åˆ«ï¼‰:"
          echo "  - kmod-usb-xhci-hcd:   $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo ""
          
          echo "4ï¸âƒ£ USBå­˜å‚¨é©±åŠ¨:"
          echo "  - kmod-usb-storage:    $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - kmod-scsi-core:      $(grep -q "^CONFIG_PACKAGE_kmod-scsi-core=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo ""
          
          echo "5ï¸âƒ£ IPQ40xxå¹³å°ä¸“ç”¨é©±åŠ¨ï¼ˆå†…æ ¸çº§åˆ«ï¼‰:"
          if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
            echo "  - CONFIG_PHY_QCOM_IPQ4019_USB: $(grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - CONFIG_PHY_QCOM_USB_HS:      $(grep -q "^CONFIG_PHY_QCOM_USB_HS=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - CONFIG_PHY_QCOM_USB_SS:      $(grep -q "^CONFIG_PHY_QCOM_USB_SS=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          else
            echo "  - éIPQ40xxå¹³å°ï¼Œè·³è¿‡æ£€æŸ¥"
          fi
          echo ""
          
          echo "6ï¸âƒ£ IPQ40xxå¹³å°ä¸“ç”¨é©±åŠ¨ï¼ˆåŒ…çº§åˆ«ï¼‰:"
          if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
            echo "  - kmod-usb-dwc3:       $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-usb-dwc3-qcom:  $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
            echo "  - kmod-phy-qcom-dwc3:  $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          else
            echo "  - éIPQ40xxå¹³å°ï¼Œè·³è¿‡æ£€æŸ¥"
          fi
          echo ""
          
          echo "7ï¸âƒ£ TurboACCé…ç½®:"
          if grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config 2>/dev/null; then
            echo "  - luci-app-turboacc:   âœ… å·²å¯ç”¨"
          else
            echo "  - luci-app-turboacc:   âŒ æœªå¯ç”¨"
          fi
          echo ""
          
          echo "8ï¸âƒ£ TCP BBRæ‹¥å¡æ§åˆ¶:"
          echo "  - kmod-tcp-bbr:        $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
          echo "  - DEFAULT_TCP_CONG:    $(grep "^CONFIG_DEFAULT_TCP_CONG=" .config | cut -d'"' -f2 || echo 'æœªè®¾ç½®')"
          echo ""
          
          echo "9ï¸âƒ£ é…ç½®æ–‡ä»¶ç»Ÿè®¡:"
          echo "  - æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
          echo "  - é…ç½®è¡Œæ•°: $(wc -l < .config)"
          echo ""
          
          # æœ€ç»ˆéªŒè¯ç»“æœ
          XHCI_KERNEL=$(grep -q "^CONFIG_USB_XHCI_HCD=y" .config && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
          XHCI_PACKAGE=$(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
          
          echo "ğŸ”Ÿ æœ€ç»ˆéªŒè¯ç»“æœ:"
          echo "  - USB XHCIï¼ˆå†…æ ¸çº§ï¼‰:   $XHCI_KERNEL"
          echo "  - kmod-usb-xhci-hcdï¼ˆåŒ…çº§ï¼‰: $XHCI_PACKAGE"
          
          if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
            PHY_KERNEL=$(grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
            PHY_PACKAGE=$(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
            echo "  - IPQ40xx PHYï¼ˆå†…æ ¸çº§ï¼‰: $PHY_KERNEL"
            echo "  - kmod-phy-qcom-dwc3ï¼ˆåŒ…çº§ï¼‰: $PHY_PACKAGE"
          fi
          echo ""
          
          # å…³é”®æ£€æŸ¥ï¼šå†…æ ¸çº§å¿…é¡»å¯ç”¨
          if grep -q "^CONFIG_USB_XHCI_HCD=y" .config; then
            echo "âœ…âœ…âœ… USB 3.0 å†…æ ¸æ”¯æŒå·²å¯ç”¨ï¼Œå¯ä»¥ç»§ç»­æ„å»º"
          else
            echo "âŒâŒâŒ è‡´å‘½é”™è¯¯: USB 3.0 å†…æ ¸æ”¯æŒæœªå¯ç”¨"
            echo "ğŸ’¡ è¯·æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬å’Œå¹³å°æ˜¯å¦æ”¯æŒ XHCI"
            exit 1
          fi
          
          if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
            if grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config; then
              echo "âœ…âœ…âœ… IPQ40xx USB PHY å†…æ ¸æ”¯æŒå·²å¯ç”¨"
            else
              echo "âŒâŒâŒ è‡´å‘½é”™è¯¯: IPQ40xx USB PHY å†…æ ¸æ”¯æŒæœªå¯ç”¨"
              exit 1
            fi
          fi
          
          echo "=========================================="
          echo "âœ… æ­¥éª¤18 é…ç½®åº”ç”¨å®Œæˆ"
#ã€firmware-build.yml-18-endã€‘
