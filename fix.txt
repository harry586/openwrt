#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆå‚æ•°æ ¼å¼ä¿®å¤ç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # åˆ›å»ºåŸºç¡€é…ç½®
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    # æ£€æŸ¥é…ç½®å·¥å…·å¹¶ç¡®å®šæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•
    local CONFIG_CMD=""
    local CONFIG_TYPE=""
    
    if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
        # æµ‹è¯•å·¥å…·ç±»å‹
        if scripts/config/config --help 2>&1 | grep -q "Usage"; then
            CONFIG_CMD="scripts/config/config"
            CONFIG_TYPE="standard"
            log "âœ… ä½¿ç”¨æ ‡å‡† config å·¥å…·: $CONFIG_CMD"
        else
            CONFIG_CMD="scripts/config/config"
            CONFIG_TYPE="conf"
            log "âœ… ä½¿ç”¨ conf ç±»å‹å·¥å…·: $CONFIG_CMD"
        fi
    elif [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
        CONFIG_CMD="scripts/config/conf"
        CONFIG_TYPE="conf"
        log "âœ… ä½¿ç”¨ conf å·¥å…·: $CONFIG_CMD"
    else
        log "âš ï¸ ä½¿ç”¨å†…ç½®ç®€æ˜“å·¥å…·"
        mkdir -p scripts/config
        cat > scripts/config/config << 'EOF'
#!/bin/bash
# ç®€æ˜“ config å·¥å…·
CONFIG_FILE=".config"

case "$1" in
    --enable)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        echo "CONFIG_PACKAGE_${symbol}=y" >> "$CONFIG_FILE"
        ;;
    --disable)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        echo "# CONFIG_PACKAGE_${symbol} is not set" >> "$CONFIG_FILE"
        ;;
esac
EOF
        chmod +x scripts/config/config
        CONFIG_CMD="scripts/config/config"
        CONFIG_TYPE="simple"
    fi
    
    log "ğŸ”§ ä½¿ç”¨é…ç½®å·¥å…·: $CONFIG_CMD (ç±»å‹: $CONFIG_TYPE)"
    
    # å®šä¹‰é…ç½®å‡½æ•°ï¼Œæ ¹æ®å·¥å…·ç±»å‹è°ƒç”¨æ­£ç¡®çš„å‚æ•°æ ¼å¼
    enable_config() {
        local symbol="$1"
        # ç§»é™¤å¯èƒ½çš„ CONFIG_ æˆ– PACKAGE_ å‰ç¼€
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        
        case "$CONFIG_TYPE" in
            "standard")
                # æ ‡å‡† config å·¥å…·ä½¿ç”¨ --enable å‚æ•°
                $CONFIG_CMD --enable "PACKAGE_${symbol}"
                ;;
            "conf")
                # conf å·¥å…·éœ€è¦å†™æ–‡ä»¶
                sed -i "/^CONFIG_PACKAGE_${symbol}=/d" .config
                sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" .config
                echo "CONFIG_PACKAGE_${symbol}=y" >> .config
                ;;
            "simple")
                # ç®€æ˜“å·¥å…·
                $CONFIG_CMD --enable "PACKAGE_${symbol}"
                ;;
        esac
    }
    
    disable_config() {
        local symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        
        case "$CONFIG_TYPE" in
            "standard")
                $CONFIG_CMD --disable "PACKAGE_${symbol}"
                ;;
            "conf")
                sed -i "/^CONFIG_PACKAGE_${symbol}=/d" .config
                sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" .config
                echo "# CONFIG_PACKAGE_${symbol} is not set" >> .config
                ;;
            "simple")
                $CONFIG_CMD --disable "PACKAGE_${symbol}"
                ;;
        esac
    }
    
    set_config_string() {
        local name="$1"
        local value="$2"
        name="${name#CONFIG_}"
        
        case "$CONFIG_TYPE" in
            "standard")
                $CONFIG_CMD --set-str "$name" "$value"
                ;;
            "conf"|"simple")
                sed -i "/^CONFIG_${name}=/d" .config
                echo "CONFIG_${name}=\"$value\"" >> .config
                ;;
        esac
    }
    
    # åº”ç”¨é…ç½®æ–‡ä»¶ - ä½¿ç”¨ç›´æ¥å†™å…¥æ–¹å¼é¿å…å·¥å…·å‚æ•°é—®é¢˜
    log "ğŸ“ ç›´æ¥å†™å…¥é…ç½®æ–‡ä»¶..."
    
    # USB æ ¸å¿ƒé…ç½®
    echo "" >> .config
    
    # USB æ ¸å¿ƒä¾èµ–é“¾
    echo "# USB Core Support" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
    
    # USB 2.0 å®Œæ•´ä¾èµ–é“¾
    echo "# USB 2.0 Support" >> .config
    echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-ehci=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-uhci=y" >> .config
    
    # USB 3.0 å®Œæ•´ä¾èµ–é“¾
    echo "# USB 3.0 Support" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd-dbg=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-xhci-pci=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
    
    # USB å­˜å‚¨å®Œæ•´ä¾èµ–é“¾
    echo "# USB Storage Support" >> .config
    echo "CONFIG_PACKAGE_kmod-scsi-core=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-storage-extras=y" >> .config
    echo "CONFIG_PACKAGE_kmod-usb-storage-uas=y" >> .config
    
    # æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
    echo "# Filesystem Support" >> .config
    echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
    echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
    echo "CONFIG_PACKAGE_kmod-fs-exfat=y" >> .config
    echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config
    echo "CONFIG_PACKAGE_kmod-nls-utf8=y" >> .config
    echo "CONFIG_PACKAGE_kmod-nls-cp936=y" >> .config
    echo "CONFIG_PACKAGE_kmod-nls-cp437=y" >> .config
    echo "CONFIG_PACKAGE_kmod-nls-iso8859-1=y" >> .config
    
    # IPQ40xx å¹³å°ä¸“ç”¨ USB å®Œæ•´ä¾èµ–é“¾
    if [ "$TARGET" = "ipq40xx" ]; then
        log "ğŸ”§ å¯ç”¨ IPQ40xx å¹³å° USB å®Œæ•´ä¾èµ–é“¾..."
        echo "# IPQ40xx Platform USB Support" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
        echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-phy-msm=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-dwc3-role-switch=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-common=y" >> .config
    fi
    
    # TCP BBR æ‹¥å¡æ§åˆ¶
    echo "# TCP BBR" >> .config
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    # ath10k å†²çªè§£å†³
    echo "# ath10k Configuration" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers is not set" >> .config
    echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
    
    # TurboACC é…ç½®
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "ğŸ”§ å¯ç”¨ TurboACC ç»„ä»¶..."
        echo "# TurboACC Support" >> .config
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe-cm=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # åº”ç”¨å…¶ä»–é…ç½®æ–‡ä»¶
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "ğŸ“ åˆå¹¶USBé€šç”¨é…ç½®..."
        cat "$CONFIG_DIR/usb-generic.config" | grep -v "^#" | grep "CONFIG_" >> .config
    fi
    
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "ğŸ“ åˆå¹¶åŸºç¡€é…ç½®..."
        cat "$CONFIG_DIR/base.config" | grep -v "^#" | grep "CONFIG_" >> .config
    fi
    
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "ğŸ“ åˆå¹¶è®¾å¤‡é…ç½®: $DEVICE.config..."
        cat "$device_config_file" | grep -v "^#" | grep "CONFIG_" >> .config
    fi
    
    if [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "ğŸ“ åˆå¹¶æ­£å¸¸æ¨¡å¼é…ç½®..."
        cat "$CONFIG_DIR/normal.config" | grep -v "^#" | grep "CONFIG_" >> .config
    fi
    
    # å¹³å°ä¸“ç”¨é…ç½®
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "ğŸ“ åˆå¹¶å¹³å°é…ç½®: $(basename "$platform_config")..."
        cat "$platform_config" | grep -v "^#" | grep "CONFIG_" >> .config
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            if [ -n "$pkg" ]; then
                echo "CONFIG_PACKAGE_$pkg=y" >> .config
                log "âœ… æ·»åŠ åŒ…: $pkg"
            fi
        done
    fi
    
    # å»é‡
    log "ğŸ”§ å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    log "ğŸ”„ è¿è¡Œ make defconfig è§£å†³ä¾èµ–å…³ç³»..."
    make defconfig || handle_error "æœ€ç»ˆé…ç½®åº”ç”¨å¤±è´¥"
    
    log "ğŸ“‹ å…³é”®é…ç½®çŠ¶æ€ï¼ˆæœ€ç»ˆï¼‰:"
    log "  - kmod-usb-core: $(grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb3: $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    log "  - kmod-usb2: $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    
    if [ "$TARGET" = "ipq40xx" ]; then
        log "  - kmod-usb-dwc3-qcom: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
        log "  - kmod-phy-qcom-dwc3: $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo 'âœ… å·²å¯ç”¨' || echo 'âŒ æœªå¯ç”¨')"
    fi
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
