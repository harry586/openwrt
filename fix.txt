#ã€build_firmware_main.sh-00ã€‘
# OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºä¸»è„šæœ¬
# å¯¹åº”å·¥ä½œæµ: firmware-build.yml
# ç‰ˆæœ¬: 3.1.0
# æœ€åæ›´æ–°: 2026-02-15
#ã€build_firmware_main.sh-00-endã€‘

#ã€build_firmware_main.sh-00.5ã€‘
# åŠ è½½ç»Ÿä¸€é…ç½®æ–‡ä»¶
load_build_config() {
    local config_file="${1:-$REPO_ROOT/build-config.conf}"
    
    if [ -f "$config_file" ]; then
        log "ğŸ“ åŠ è½½ç»Ÿä¸€é…ç½®æ–‡ä»¶: $config_file"
        source "$config_file"
    else
        log "âš ï¸ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $config_fileï¼Œä½¿ç”¨è„šæœ¬å†…é»˜è®¤å€¼"
    fi
    
    # å¯¼å‡ºæ‰€æœ‰é…ç½®ä¸ºç¯å¢ƒå˜é‡
    export BUILD_DIR LOG_DIR BACKUP_DIR CONFIG_DIR
    export IMMORTALWRT_URL PACKAGES_FEED_URL LUCI_FEED_URL TURBOACC_FEED_URL
    export ENABLE_TURBOACC ENABLE_TCP_BBR FORCE_ATH10K_CT AUTO_FIX_USB_DRIVERS
    export ENABLE_DYNAMIC_KERNEL_DETECTION ENABLE_DYNAMIC_PLATFORM_DRIVERS ENABLE_DYNAMIC_DEVICE_MAPPING
    
    log "âœ… é…ç½®åŠ è½½å®Œæˆ"
}

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
CONFIG_FILE="$REPO_ROOT/build-config.conf"
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
    load_build_config
fi
#ã€build_firmware_main.sh-00.5-endã€‘


#ã€build_firmware_main.sh-01ã€‘
set -e

# ä½¿ç”¨é…ç½®æ–‡ä»¶çš„å˜é‡ï¼Œå¦‚æœæœªå®šä¹‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
: ${BUILD_DIR:="/mnt/openwrt-build"}
: ${LOG_DIR:="/tmp/build-logs"}
: ${BACKUP_DIR:="/tmp/openwrt_backup"}

ENV_FILE="$BUILD_DIR/build_env.sh"
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
SUPPORT_SCRIPT="$REPO_ROOT/support.sh"
CONFIG_DIR="$REPO_ROOT/firmware-config/config"

mkdir -p "$LOG_DIR"

log() {
    echo "ã€$(date '+%Y-%m-%d %H:%M:%S')ã€‘$1"
}

handle_error() {
    log "âŒ é”™è¯¯å‘ç”Ÿåœ¨: $1"
    log "è¯¦ç»†é”™è¯¯ä¿¡æ¯:"
    echo "æœ€å50è¡Œæ—¥å¿—:"
    tail -50 "$LOG_DIR"/*.log 2>/dev/null || echo "æ— æ—¥å¿—æ–‡ä»¶"
    exit 1
}
#ã€build_firmware_main.sh-01-endã€‘


#ã€build_firmware_main.sh-02ã€‘
save_env() {
    mkdir -p $BUILD_DIR
    echo "#!/bin/bash" > $ENV_FILE
    echo "export SELECTED_REPO_URL=\"${SELECTED_REPO_URL}\"" >> $ENV_FILE
    echo "export SELECTED_BRANCH=\"${SELECTED_BRANCH}\"" >> $ENV_FILE
    echo "export TARGET=\"${TARGET}\"" >> $ENV_FILE
    echo "export SUBTARGET=\"${SUBTARGET}\"" >> $ENV_FILE
    echo "export DEVICE=\"${DEVICE}\"" >> $ENV_FILE
    echo "export CONFIG_MODE=\"${CONFIG_MODE}\"" >> $ENV_FILE
    echo "export REPO_ROOT=\"${REPO_ROOT}\"" >> $ENV_FILE
    echo "export COMPILER_DIR=\"${COMPILER_DIR}\"" >> $ENV_FILE
    
    # ä¿å­˜é…ç½®å¼€å…³çŠ¶æ€
    echo "export ENABLE_TURBOACC=\"${ENABLE_TURBOACC}\"" >> $ENV_FILE
    echo "export ENABLE_TCP_BBR=\"${ENABLE_TCP_BBR}\"" >> $ENV_FILE
    echo "export FORCE_ATH10K_CT=\"${FORCE_ATH10K_CT}\"" >> $ENV_FILE
    echo "export AUTO_FIX_USB_DRIVERS=\"${AUTO_FIX_USB_DRIVERS}\"" >> $ENV_FILE
    
    if [ -n "$GITHUB_ENV" ]; then
        echo "SELECTED_REPO_URL=${SELECTED_REPO_URL}" >> $GITHUB_ENV
        echo "SELECTED_BRANCH=${SELECTED_BRANCH}" >> $GITHUB_ENV
        echo "TARGET=${TARGET}" >> $GITHUB_ENV
        echo "SUBTARGET=${SUBTARGET}" >> $GITHUB_ENV
        echo "DEVICE=${DEVICE}" >> $GITHUB_ENV
        echo "CONFIG_MODE=${CONFIG_MODE}" >> $GITHUB_ENV
        echo "COMPILER_DIR=${COMPILER_DIR}" >> $GITHUB_ENV
    fi
    
    chmod +x $ENV_FILE
    log "âœ… ç¯å¢ƒå˜é‡å·²ä¿å­˜åˆ°: $ENV_FILE"
}
#ã€build_firmware_main.sh-02-endã€‘


#ã€build_firmware_main.sh-06ã€‘
initialize_build_env() {
    local device_name=$1
    local version_selection=$2
    local config_mode=$3
    
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ç‰ˆæœ¬é€‰æ‹© ==="
    if [ "$version_selection" = "23.05" ]; then
        SELECTED_REPO_URL="${IMMORTALWRT_URL:-https://github.com/immortalwrt/immortalwrt.git}"
        SELECTED_BRANCH="${BRANCH_23_05:-openwrt-23.05}"
    else
        SELECTED_REPO_URL="${IMMORTALWRT_URL:-https://github.com/immortalwrt/immortalwrt.git}"
        SELECTED_BRANCH="${BRANCH_21_02:-openwrt-21.02}"
    fi
    log "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH"
    
    log "=== å…‹éš†æºç  ==="
    log "ä»“åº“: $SELECTED_REPO_URL"
    log "åˆ†æ”¯: $SELECTED_BRANCH"
    
    sudo rm -rf ./* ./.git* 2>/dev/null || true
    
    git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . || handle_error "å…‹éš†æºç å¤±è´¥"
    log "âœ… æºç å…‹éš†å®Œæˆ"
    
    local important_source_files=("Makefile" "feeds.conf.default" "rules.mk" "Config.in")
    for file in "${important_source_files[@]}"; do
        if [ -f "$file" ]; then
            log "âœ… æºç æ–‡ä»¶å­˜åœ¨: $file"
        else
            log "âŒ æºç æ–‡ä»¶ç¼ºå¤±: $file"
        fi
    done
    
    log "=== è®¾å¤‡é…ç½® ==="
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” è°ƒç”¨support.shè·å–è®¾å¤‡å¹³å°ä¿¡æ¯..."
        PLATFORM_INFO=$("$SUPPORT_SCRIPT" get-platform "$device_name")
        if [ -n "$PLATFORM_INFO" ]; then
            TARGET=$(echo "$PLATFORM_INFO" | awk '{print $1}')
            SUBTARGET=$(echo "$PLATFORM_INFO" | awk '{print $2}')
            DEVICE="$device_name"
            log "âœ… ä»support.shè·å–å¹³å°ä¿¡æ¯: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
        else
            log "âŒ æ— æ³•ä»support.shè·å–å¹³å°ä¿¡æ¯"
            handle_error "è·å–å¹³å°ä¿¡æ¯å¤±è´¥"
        fi
    else
        log "âŒ support.shä¸å­˜åœ¨"
        handle_error "support.shè„šæœ¬ç¼ºå¤±"
    fi
    
    log "ğŸ”§ è®¾å¤‡: $device_name"
    log "ğŸ”§ ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    
    CONFIG_MODE="$config_mode"
    
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ­£ç¡®è¯†åˆ«å’Œä½¿ç”¨ç¼–è¯‘å¥½çš„ config å·¥å…·
    log "=== ç¼–è¯‘é…ç½®å·¥å…· ==="
    
    local config_tool_created=0
    local real_config_tool=""
    
    # æ–¹æ³•1: ç¼–è¯‘ scripts/config
    log "ğŸ”§ å°è¯•æ–¹æ³•1: ç¼–è¯‘ scripts/config..."
    if [ -d "scripts/config" ]; then
        cd scripts/config
        make
        cd $BUILD_DIR
        
        # æ£€æŸ¥ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶
        if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            log "âœ… æ–¹æ³•1æˆåŠŸ: ç¼–è¯‘ç”Ÿæˆ conf å·¥å…·"
            
            # åˆ›å»º config åŒ…è£…è„šæœ¬ï¼Œä½¿ç”¨ conf
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# OpenWrt config å·¥å…·åŒ…è£…è„šæœ¬
# ä½¿ç”¨ç¼–è¯‘ç”Ÿæˆçš„ conf å·¥å…·

CONF_TOOL="$(dirname "$0")/conf"

if [ ! -x "$CONF_TOOL" ]; then
    echo "Error: conf tool not found" >&2
    exit 1
fi

# è½¬æ¢å‚æ•°æ ¼å¼
case "$1" in
    --enable)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=y .config
        ;;
    --disable)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=n .config
        ;;
    --module)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=m .config
        ;;
    --set-str)
        shift
        name="$1"
        value="$2"
        "$CONF_TOOL" --defconfig CONFIG_$name="$value" .config
        shift 2
        ;;
    *)
        "$CONF_TOOL" "$@"
        ;;
esac
EOF
            chmod +x scripts/config/config
            log "âœ… åˆ›å»º config åŒ…è£…è„šæœ¬æˆåŠŸ"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        elif [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
            log "âœ… æ–¹æ³•1æˆåŠŸ: ç¼–è¯‘ç”Ÿæˆ config å·¥å…·"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•2: ç›´æ¥ä½¿ç”¨ conf ä½œä¸ºé…ç½®å·¥å…·
    if [ $config_tool_created -eq 0 ]; then
        if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            log "âœ… æ–¹æ³•2æˆåŠŸ: ç›´æ¥ä½¿ç”¨ conf å·¥å…·"
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# ä½¿ç”¨ conf å·¥å…·çš„åŒ…è£…è„šæœ¬
exec "$(dirname "$0")/conf" "$@"
EOF
            chmod +x scripts/config/config
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•3: ä½¿ç”¨ mconf (å¦‚æœå¯ç”¨)
    if [ $config_tool_created -eq 0 ]; then
        if [ -f "scripts/config/mconf" ] && [ -x "scripts/config/mconf" ]; then
            log "âœ… æ–¹æ³•3æˆåŠŸ: ä½¿ç”¨ mconf å·¥å…·"
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# ä½¿ç”¨ mconf å·¥å…·çš„åŒ…è£…è„šæœ¬
exec "$(dirname "$0")/mconf" "$@"
EOF
            chmod +x scripts/config/config
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•4: ä» SDK å¤åˆ¶
    if [ $config_tool_created -eq 0 ] && [ -n "$COMPILER_DIR" ]; then
        log "ğŸ”§ å°è¯•æ–¹æ³•4: ä» SDK ç›®å½•å¤åˆ¶"
        if [ -f "$COMPILER_DIR/scripts/config/conf" ] && [ -x "$COMPILER_DIR/scripts/config/conf" ]; then
            mkdir -p scripts/config
            cp "$COMPILER_DIR/scripts/config/conf" scripts/config/
            cat > scripts/config/config << 'EOF'
#!/bin/sh
exec "$(dirname "$0")/conf" "$@"
EOF
            chmod +x scripts/config/config
            log "âœ… æ–¹æ³•4æˆåŠŸ: ä» SDK å¤åˆ¶ conf å·¥å…·"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•5: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“å·¥å…·
    if [ $config_tool_created -eq 0 ]; then
        log "ğŸ”§ æ–¹æ³•5: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“ config å·¥å…·"
        mkdir -p scripts/config
        cat > scripts/config/config << 'EOF'
#!/bin/bash
# åŠŸèƒ½å®Œæ•´çš„ config å·¥å…·
CONFIG_FILE=".config"

show_help() {
    echo "Usage: config [options]"
    echo "  --enable <symbol>    Enable a configuration option"
    echo "  --disable <symbol>   Disable a configuration option"
    echo "  --module <symbol>    Set a configuration option as module"
    echo "  --set-str <name> <value> Set a string configuration option"
}

# ç¡®ä¿ .config å­˜åœ¨
if [ ! -f "$CONFIG_FILE" ]; then
    touch "$CONFIG_FILE"
fi

case "$1" in
    --enable)
        shift
        symbol="$1"
        # ç§»é™¤ CONFIG_ å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        symbol="${symbol#CONFIG_}"
        # ç§»é™¤ PACKAGE_ å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        symbol="${symbol#PACKAGE_}"
        
        # åˆ é™¤æ‰€æœ‰ç›¸å…³çš„è¡Œ
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        # æ·»åŠ å¯ç”¨è¡Œ
        echo "CONFIG_PACKAGE_${symbol}=y" >> "$CONFIG_FILE"
        ;;
    --disable)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        echo "# CONFIG_PACKAGE_${symbol} is not set" >> "$CONFIG_FILE"
        ;;
    --module)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        echo "CONFIG_PACKAGE_${symbol}=m" >> "$CONFIG_FILE"
        ;;
    --set-str)
        shift
        name="$1"
        value="$2"
        name="${name#CONFIG_}"
        
        sed -i "/^CONFIG_${name}=/d" "$CONFIG_FILE"
        echo "CONFIG_${name}="$value"" >> "$CONFIG_FILE"
        shift 2
        ;;
    --help)
        show_help
        ;;
    *)
        echo "Unknown option: $1"
        show_help
        exit 1
        ;;
esac
EOF
        chmod +x scripts/config/config
        log "âœ… æ–¹æ³•5æˆåŠŸ: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“ config å·¥å…·"
        real_config_tool="scripts/config/config"
        config_tool_created=1
    fi
    
    # åˆ›å»ºç»Ÿä¸€è°ƒç”¨æ¥å£ - ä¿®å¤ç‰ˆï¼Œä¸ä½¿ç”¨ --help æµ‹è¯•
    if [ $config_tool_created -eq 1 ]; then
        log "ğŸ”§ åˆ›å»ºç»Ÿä¸€è°ƒç”¨æ¥å£..."
        
        # è®°å½•çœŸå®å·¥å…·è·¯å¾„
        echo "$real_config_tool" > scripts/.config_tool_path
        
        # åˆ›å»º scripts/config è½¯é“¾æ¥æˆ–å‰¯æœ¬ï¼Œä»¥ä¾¿ make defconfig èƒ½æ‰¾åˆ°
        if [ ! -f "scripts/config" ]; then
            if [ -f "scripts/config/config" ]; then
                ln -sf config scripts/config 2>/dev/null || cp scripts/config/config scripts/config 2>/dev/null || true
                log "âœ… åˆ›å»º scripts/config é“¾æ¥/å‰¯æœ¬"
            fi
        fi
        
        cat > scripts/config-tool << 'EOF'
#!/bin/sh
# ç»Ÿä¸€ config å·¥å…·è°ƒç”¨æ¥å£
CONFIG_TOOL_PATH="$(dirname "$0")/.config_tool_path"

if [ -f "$CONFIG_TOOL_PATH" ]; then
    CONFIG_TOOL="$(cat "$CONFIG_TOOL_PATH" 2>/dev/null)"
    if [ -n "$CONFIG_TOOL" ] && [ -f "$CONFIG_TOOL" ] && [ -x "$CONFIG_TOOL" ]; then
        exec "$CONFIG_TOOL" "$@"
    fi
fi

# å¤‡é€‰1: ç›´æ¥æŸ¥æ‰¾
if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
    echo "scripts/config/config" > "$CONFIG_TOOL_PATH"
    exec scripts/config/config "$@"
fi

# å¤‡é€‰2: ä½¿ç”¨ conf
if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
    echo "scripts/config/conf" > "$CONFIG_TOOL_PATH"
    exec scripts/config/conf "$@"
fi

# å¤‡é€‰3: ä½¿ç”¨ mconf
if [ -f "scripts/config/mconf" ] && [ -x "scripts/config/mconf" ]; then
    echo "scripts/config/mconf" > "$CONFIG_TOOL_PATH"
    exec scripts/config/mconf "$@"
fi

echo "Error: config tool not found" >&2
exit 1
EOF
        chmod +x scripts/config-tool
        log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£åˆ›å»ºæˆåŠŸ: scripts/config-tool"
        
        # ä¸å†æµ‹è¯• --helpï¼Œè€Œæ˜¯æµ‹è¯•åŸºæœ¬åŠŸèƒ½
        if scripts/config-tool --version > /dev/null 2>&1 || scripts/config-tool -h > /dev/null 2>&1; then
            log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£æµ‹è¯•é€šè¿‡"
        else
            # å°è¯•æµ‹è¯•æ˜¯å¦å­˜åœ¨
            if [ -f scripts/config/config ] || [ -f scripts/config/conf ]; then
                log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£å¯ç”¨ï¼ˆè·³è¿‡å‚æ•°æµ‹è¯•ï¼‰"
            else
                log "âš ï¸ ç»Ÿä¸€è°ƒç”¨æ¥å£å¯èƒ½æœ‰é—®é¢˜ï¼Œä½†å·¥å…·å¯èƒ½ä»å¯ç”¨"
            fi
        fi
    fi
    
    # æœ€ç»ˆéªŒè¯
    if [ $config_tool_created -eq 1 ]; then
        log "âœ… é…ç½®å·¥å…·æœ€ç»ˆéªŒè¯é€šè¿‡"
        log "ğŸ“ çœŸå®å·¥å…·è·¯å¾„: $real_config_tool"
        log "ğŸ“ ç»Ÿä¸€è°ƒç”¨æ¥å£: scripts/config-tool"
        
        # æ˜¾ç¤ºå·¥å…·ä¿¡æ¯
        if [ -f "$real_config_tool" ]; then
            if file "$real_config_tool" | grep -q "ELF"; then
                log "ğŸ“‹ å·¥å…·ç±»å‹: å·²ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶"
            else
                log "ğŸ“‹ å·¥å…·ç±»å‹: Shell è„šæœ¬"
            fi
        fi
    else
        log "âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œé…ç½®å·¥å…·ä¸å­˜åœ¨"
        handle_error "æ— æ³•åˆ›å»ºé…ç½®å·¥å…·"
    fi
    
    save_env
    
    echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
    echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
    echo "TARGET=$TARGET" >> $GITHUB_ENV
    echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
    echo "DEVICE=$DEVICE" >> $GITHUB_ENV
    echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
    
    log "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}
#ã€build_firmware_main.sh-06-endã€‘

#ã€build_firmware_main.sh-09ã€‘
add_turboacc_support() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ·»åŠ  TurboACC æ”¯æŒ ==="
    
    # ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å¼€å…³
    if [ "$CONFIG_MODE" = "normal" ] && [ "${ENABLE_TURBOACC:-true}" = "true" ]; then
        log "ğŸ”§ ä¸ºæ­£å¸¸æ¨¡å¼æ·»åŠ  TurboACC æ”¯æŒ"
        echo "src-git turboacc ${TURBOACC_FEED_URL:-https://github.com/chenmozhijin/turboacc}" >> feeds.conf.default
        log "âœ… TurboACC feed æ·»åŠ å®Œæˆ"
    else
        if [ "$CONFIG_MODE" = "normal" ]; then
            log "â„¹ï¸ TurboACC å·²è¢«é…ç½®ç¦ç”¨"
        else
            log "â„¹ï¸ åŸºç¡€æ¨¡å¼ä¸æ·»åŠ  TurboACC æ”¯æŒ"
        fi
    fi
}
#ã€build_firmware_main.sh-09-endã€‘


#ã€build_firmware_main.sh-10ã€‘
configure_feeds() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== é…ç½®Feeds ==="
    
    if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
        FEEDS_BRANCH="openwrt-23.05"
    else
        FEEDS_BRANCH="openwrt-21.02"
    fi
    
    # ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„Feed URL
    echo "src-git packages ${PACKAGES_FEED_URL:-https://github.com/immortalwrt/packages.git};$FEEDS_BRANCH" > feeds.conf.default
    echo "src-git luci ${LUCI_FEED_URL:-https://github.com/immortalwrt/luci.git};$FEEDS_BRANCH" >> feeds.conf.default
    
    if [ "$CONFIG_MODE" = "normal" ] && [ "${ENABLE_TURBOACC:-true}" = "true" ]; then
        echo "src-git turboacc ${TURBOACC_FEED_URL:-https://github.com/chenmozhijin/turboacc}" >> feeds.conf.default
        log "âœ… æ·»åŠ TurboACC feedï¼ˆæ‰€æœ‰ç‰ˆæœ¬ï¼‰"
    fi
    
    log "=== æ›´æ–°Feeds ==="
    ./scripts/feeds update -a || handle_error "æ›´æ–°feedså¤±è´¥"
    
    log "=== å®‰è£…Feeds ==="
    ./scripts/feeds install -a || handle_error "å®‰è£…feedså¤±è´¥"
    
    local critical_feeds_dirs=("feeds/packages" "feeds/luci" "package/feeds")
    for dir in "${critical_feeds_dirs[@]}"; do
        if [ -d "$dir" ]; then
            log "âœ… Feedç›®å½•å­˜åœ¨: $dir"
        else
            log "âŒ Feedç›®å½•ç¼ºå¤±: $dir"
        fi
    done
    
    log "âœ… Feedsé…ç½®å®Œæˆ"
}
#ã€build_firmware_main.sh-10-endã€‘


#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    local device_override=$2  # æ–°å¢è®¾å¤‡è¦†ç›–å‚æ•°
    
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    # å¦‚æœæä¾›äº†è®¾å¤‡è¦†ç›–å‚æ•°ï¼Œä¼˜å…ˆä½¿ç”¨
    if [ -n "$device_override" ]; then
        DEVICE="$device_override"
        log "ğŸ”§ ä½¿ç”¨è®¾å¤‡è¦†ç›–å‚æ•°: $DEVICE"
    fi
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆè®¾å¤‡æ˜¾å¼æŒ‡å®šç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    # éªŒè¯è®¾å¤‡å˜é‡æ˜¯å¦ä¸ºç©º
    if [ -z "$DEVICE" ]; then
        log "âŒ é”™è¯¯: DEVICEå˜é‡ä¸ºç©ºï¼"
        log "å¯ç”¨ç¯å¢ƒå˜é‡:"
        env | grep -E "DEVICE|TARGET|SELECTED" || true
        handle_error "DEVICEå˜é‡æœªè®¾ç½®"
    fi
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # æ­¥éª¤1: æ ¹æ®è®¾å¤‡åæ˜ å°„åˆ°æ­£ç¡®çš„OpenWrtè®¾å¤‡é…ç½®å
    local openwrt_device=""
    
    # å¦‚æœå¯ç”¨äº†åŠ¨æ€è®¾å¤‡æ˜ å°„ï¼Œå°è¯•ä»support.shè·å–
    if [ "${ENABLE_DYNAMIC_DEVICE_MAPPING:-true}" = "true" ] && [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” å°è¯•ä»support.shè·å–è®¾å¤‡æ˜ å°„..."
        local platform_info=$("$SUPPORT_SCRIPT" get-platform "$DEVICE" 2>/dev/null)
        if [ -n "$platform_info" ]; then
            # ä½¿ç”¨è®¾å¤‡åæœ¬èº«ä½œä¸ºopenwrt_deviceï¼ˆsupport.shå·²ç»å¤„ç†äº†æ˜ å°„ï¼‰
            openwrt_device="$DEVICE"
            log "âœ… ä»support.shè·å–è®¾å¤‡ä¿¡æ¯æˆåŠŸ"
        fi
    fi
    
    # å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œä½¿ç”¨è½¬æ¢è§„åˆ™
    if [ -z "$openwrt_device" ]; then
        case "$DEVICE" in
            ac42u|rt-ac42u|asus_rt-ac42u)
                openwrt_device="asus_rt-ac42u"
                log "ğŸ”§ æ˜ å°„è®¾å¤‡ $DEVICE -> $openwrt_device"
                ;;
            acrh17|rt-acrh17|asus_rt-acrh17)
                openwrt_device="asus_rt-acrh17"
                log "ğŸ”§ æ˜ å°„è®¾å¤‡ $DEVICE -> $openwrt_device"
                ;;
            *)
                openwrt_device=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
                log "ğŸ”§ ä½¿ç”¨è½¬æ¢åçš„è®¾å¤‡å: $openwrt_device"
                ;;
        esac
    fi
    
    # ç›´æ¥ä½¿ç”¨å°å†™çš„è®¾å¤‡å
    local device_lower="$openwrt_device"
    local device_config="CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}"
    
    log "ğŸ”§ è®¾å¤‡é…ç½®å˜é‡: $device_config=y"
    
    # æ­¥éª¤2: åˆ›å»ºåŸºç¡€ç›®æ ‡é…ç½® - ä½¿ç”¨å°å†™è®¾å¤‡å
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
${device_config}=y
EOF
    
    log "ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶å†…å®¹:"
    cat .config
    
    # æ­¥éª¤3: åˆå¹¶æ‰€æœ‰é…ç½®æ–‡ä»¶
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    # è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è¿½åŠ é…ç½®ï¼ˆè¿‡æ»¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
        fi
    }
    
    # ä½¿ç”¨é…ç½®æ–‡ä»¶åæ˜ å°„
    : ${CONFIG_BASE:="base.config"}
    : ${CONFIG_USB_GENERIC:="usb-generic.config"}
    : ${CONFIG_NORMAL:="normal.config"}
    
    append_config "$CONFIG_DIR/$CONFIG_BASE"
    append_config "$CONFIG_DIR/$CONFIG_USB_GENERIC"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    append_config "$CONFIG_DIR/devices/$DEVICE.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/$CONFIG_NORMAL"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # ä»config.txtåŠ¨æ€æ·»åŠ é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if [ -f "$CONFIG_DIR/devices/$DEVICE.config" ]; then
        log "ğŸ“‹ ä»è®¾å¤‡é…ç½®æ–‡ä»¶åŠ¨æ€æ·»åŠ é…ç½®: $CONFIG_DIR/devices/$DEVICE.config"
        append_config "$CONFIG_DIR/devices/$DEVICE.config"
    fi
    
    # TCP BBRï¼ˆæ ¹æ®é…ç½®å¼€å…³ï¼‰
    if [ "${ENABLE_TCP_BBR:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        log "âœ… TCP BBRå·²å¯ç”¨"
    fi
    
    # TurboACCï¼ˆæ ¹æ®é…ç½®å¼€å…³ï¼‰
    if [ "$CONFIG_MODE" = "normal" ] && [ "${ENABLE_TURBOACC:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        log "âœ… TurboACCå·²å¯ç”¨"
    fi
    
    # ath10k å†²çªè§£å†³ï¼ˆæ ¹æ®é…ç½®å¼€å…³ï¼‰
    if [ "${FORCE_ATH10K_CT:-true}" = "true" ]; then
        sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        log "âœ… ath10k-cté©±åŠ¨å·²å¼ºåˆ¶å¯ç”¨"
    fi
    
    # æ­¥éª¤4: ç¬¬ä¸€æ¬¡å»é‡
    log "ğŸ”„ ç¬¬ä¸€æ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤5: åŠ¨æ€è·å–ç›®æ ‡å¹³å°æ”¯æŒçš„å†…æ ¸é…ç½®
    log "ğŸ” åŠ¨æ€è·å–ç›®æ ‡å¹³å°æ”¯æŒçš„å†…æ ¸é…ç½®..."
    
    local kernel_config_file=""
    local kernel_version=""
    
    # å¦‚æœå¯ç”¨äº†åŠ¨æ€å†…æ ¸æ£€æµ‹
    if [ "${ENABLE_DYNAMIC_KERNEL_DETECTION:-true}" = "true" ] && [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” å°è¯•åŠ¨æ€æ£€æµ‹å†…æ ¸é…ç½®æ–‡ä»¶..."
        # è¿™é‡Œå¯ä»¥è°ƒç”¨detect_kernel_configå‡½æ•°
        if [ -f "target/linux/$TARGET/config-6.1" ]; then
            kernel_config_file="target/linux/$TARGET/config-6.1"
            kernel_version="6.1"
        elif [ -f "target/linux/$TARGET/config-5.15" ]; then
            kernel_config_file="target/linux/$TARGET/config-5.15"
            kernel_version="5.15"
        elif [ -f "target/linux/$TARGET/config-5.10" ]; then
            kernel_config_file="target/linux/$TARGET/config-5.10"
            kernel_version="5.10"
        elif [ -f "target/linux/$TARGET/config-5.4" ]; then
            kernel_config_file="target/linux/$TARGET/config-5.4"
            kernel_version="5.4"
        fi
    else
        # ä½¿ç”¨ä¼ ç»Ÿçš„ç¡¬ç¼–ç æ£€æµ‹
        if [ -f "target/linux/$TARGET/config-5.4" ]; then
            kernel_config_file="target/linux/$TARGET/config-5.4"
            kernel_version="5.4"
        elif [ -f "target/linux/$TARGET/config-5.10" ]; then
            kernel_config_file="target/linux/$TARGET/config-5.10"
            kernel_version="5.10"
        elif [ -f "target/linux/$TARGET/config-5.15" ]; then
            kernel_config_file="target/linux/$TARGET/config-5.15"
            kernel_version="5.15"
        elif [ -f "target/linux/$TARGET/config-6.1" ]; then
            kernel_config_file="target/linux/$TARGET/config-6.1"
            kernel_version="6.1"
        fi
    fi
    
    if [ -n "$kernel_config_file" ] && [ -f "$kernel_config_file" ]; then
        log "âœ… æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
        
        # å®šä¹‰å†…æ ¸æå–æ¨¡å¼ï¼ˆå¯ä»é…ç½®æ–‡ä»¶è·å–ï¼‰
        local kernel_patterns=(
            "^CONFIG_USB"
            "^CONFIG_PHY"
            "^CONFIG_DWC"
            "^CONFIG_XHCI"
            "^CONFIG_EXTCON"
            "^CONFIG_COMMON_CLK"
            "^CONFIG_ARCH"
        )
        
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å­˜å‚¨æå–çš„é…ç½®
        local usb_configs_file="/tmp/usb_configs_$$.txt"
        
        for pattern in "${kernel_patterns[@]}"; do
            grep -E "^${pattern}|^# ${pattern}" "$kernel_config_file" >> "$usb_configs_file" 2>/dev/null || true
        done
        
        # å»é‡å¹¶æ’åº
        sort -u "$usb_configs_file" > "$usb_configs_file.sorted"
        
        # æ˜¾ç¤ºæ‰¾åˆ°çš„é…ç½®
        local config_count=$(wc -l < "$usb_configs_file.sorted")
        log "æ‰¾åˆ° $config_count ä¸ªUSBç›¸å…³å†…æ ¸é…ç½®"
        
        log "æ‰€æœ‰USBç›¸å…³å†…æ ¸é…ç½®:"
        local line_num=0
        while read line; do
            line_num=$((line_num + 1))
            if echo "$line" | grep -q "=y$"; then
                log "   âœ… [$line_num] $line"
            elif echo "$line" | grep -q "=m$"; then
                log "   ğŸ“¦ [$line_num] $line"
            elif echo "$line" | grep -q "is not set"; then
                log "   âšª [$line_num] $line"
            else
                log "   ğŸ“„ [$line_num] $line"
            fi
        done < "$usb_configs_file.sorted"
        
        # å°†è¿™äº›é…ç½®æ·»åŠ åˆ°.configä¸­ï¼ˆä½†ä¸è¦è¦†ç›–å·²å¯ç”¨çš„é…ç½®ï¼‰
        local added_count=0
        while read line; do
            # æå–é…ç½®åï¼ˆå»æ‰å‰é¢çš„#å’Œç©ºæ ¼ï¼‰
            local config_name=$(echo "$line" | sed 's/^# //g' | cut -d'=' -f1 | cut -d' ' -f1)
            
            # æ£€æŸ¥é…ç½®æ˜¯å¦å·²å­˜åœ¨
            if ! grep -q "^${config_name}=" .config && ! grep -q "^# ${config_name} is not set" .config; then
                # å¦‚æœé…ç½®æ˜¯å¯ç”¨çš„ï¼ˆ=yï¼‰ï¼Œç›´æ¥æ·»åŠ 
                if echo "$line" | grep -q "=y$"; then
                    echo "$line" >> .config
                    added_count=$((added_count + 1))
                # å¦‚æœé…ç½®æ˜¯ç¦ç”¨çš„ï¼ˆis not setï¼‰ï¼Œä½œä¸ºæ³¨é‡Šæ·»åŠ 
                elif echo "$line" | grep -q "is not set"; then
                    echo "$line" >> .config
                    added_count=$((added_count + 1))
                fi
            fi
        done < "$usb_configs_file.sorted"
        
        log "âœ… æ·»åŠ äº† $added_count ä¸ªæ–°çš„å†…æ ¸é…ç½®"
        
        rm -f "$usb_configs_file" "$usb_configs_file.sorted"
    else
        log "âš ï¸ æœªæ‰¾åˆ°ç›®æ ‡å¹³å° $TARGET çš„å†…æ ¸é…ç½®æ–‡ä»¶"
    fi
    
    # æ­¥éª¤6: ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfigï¼ˆè¿™ä¼šé‡ç½®å†…æ ¸é…ç½®ï¼‰
    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfigï¼ˆåŠ è½½å¹³å°é»˜è®¤é…ç½®ï¼‰..."
    make defconfig > /tmp/build-logs/defconfig1.log 2>&1 || {
        log "âŒ ç¬¬ä¸€æ¬¡ make defconfig å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
        tail -50 /tmp/build-logs/defconfig1.log
        handle_error "ç¬¬ä¸€æ¬¡ä¾èµ–è§£å†³å¤±è´¥"
    }
    log "âœ… ç¬¬ä¸€æ¬¡ make defconfig æˆåŠŸ"
    
    # æ­¥éª¤7: åŠ¨æ€æ£€æµ‹å®é™…ç”Ÿæ•ˆçš„USBå†…æ ¸é…ç½®
    log "ğŸ” åŠ¨æ€æ£€æµ‹å®é™…ç”Ÿæ•ˆçš„USBå†…æ ¸é…ç½®..."
    
    # å®šä¹‰è¦æ£€æŸ¥çš„å…³é”®USBç»„ä»¶
    local usb_components=(
        "USB_SUPPORT"
        "USB_COMMON"
        "USB"
        "USB_XHCI_HCD"
        "USB_DWC3"
        "PHY"
    )
    
    for component in "${usb_components[@]}"; do
        local matches=$(grep -E "^CONFIG_${component}" .config | grep -E "=y|=m" | wc -l)
        if [ $matches -gt 0 ]; then
            log "âœ… $component ç›¸å…³é…ç½®: æ‰¾åˆ° $matches ä¸ª"
            # æ˜¾ç¤ºæ‰€æœ‰å…·ä½“é…ç½®
            grep -E "^CONFIG_${component}" .config | grep -E "=y|=m" | while read line; do
                log "    $line"
            done
        else
            log "â„¹ï¸ $component ç›¸å…³é…ç½®: æœªæ‰¾åˆ°"
        fi
    done
    
    # æ˜¾ç¤ºæ‰€æœ‰USBç›¸å…³å†…æ ¸é…ç½®
    log "ğŸ“‹ æ‰€æœ‰USBç›¸å…³å†…æ ¸é…ç½®ï¼ˆå·²ç”Ÿæ•ˆï¼‰:"
    local all_usb_kernel=$(grep -E "^CONFIG_USB_|^CONFIG_PHY_|^CONFIG_DWC|^CONFIG_XHCI|^CONFIG_EXTCON|^CONFIG_COMMON_CLK|^CONFIG_ARCH" .config | grep -E "=y|=m" | sort)
    if [ -n "$all_usb_kernel" ]; then
        local kernel_count=$(echo "$all_usb_kernel" | wc -l)
        log "å…± $kernel_count ä¸ªUSBç›¸å…³å†…æ ¸é…ç½®:"
        echo "$all_usb_kernel" | while read line; do
            log "  âœ… $line"
        done
    else
        log "  æœªæ‰¾åˆ°USBç›¸å…³å†…æ ¸é…ç½®"
    fi
    
    # æ­¥éª¤8: åŠ¨æ€æ·»åŠ USBè½¯ä»¶åŒ…ï¼ˆåŸºäºç›®æ ‡å¹³å°ï¼‰
    log "ğŸ“‹ åŠ¨æ€æ·»åŠ USBè½¯ä»¶åŒ…..."
    
    # ä»é…ç½®æ–‡ä»¶è·å–USBåŒ…åˆ—è¡¨
    # åŸºç¡€USBè½¯ä»¶åŒ…ï¼ˆæ‰€æœ‰å¹³å°éƒ½éœ€è¦ï¼‰
    local base_usb_packages=(
        "kmod-usb-core"
        "kmod-usb-common"
        "kmod-usb2"
        "kmod-usb3"
        "kmod-usb-storage"
        "kmod-scsi-core"
        "block-mount"
        "automount"
        "usbutils"
    )
    
    # æ‰©å±•USBåŒ…
    local extended_usb_packages=(
        "kmod-usb-storage-uas"
        "kmod-usb-storage-extras"
        "kmod-scsi-generic"
    )
    
    # æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
    local fs_support_packages=(
        "kmod-fs-ext4"
        "kmod-fs-vfat"
        "kmod-fs-exfat"
        "kmod-fs-ntfs3"
        "kmod-nls-utf8"
        "kmod-nls-cp936"
    )
    
    # æ ¹æ®ç›®æ ‡å¹³å°æ·»åŠ ç‰¹å®šè½¯ä»¶åŒ…
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            log "æ£€æµ‹åˆ°é«˜é€šå¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local qcom_packages=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-qcom"
                "kmod-usb-dwc3-of-simple"
                "kmod-phy-qcom-ipq4019-usb"
                "kmod-usb-xhci-hcd"
                "kmod-usb-xhci-plat-hcd"
            )
            base_usb_packages+=("${qcom_packages[@]}")
            ;;
        mediatek|ramips)
            log "æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local mtk_packages=(
                "kmod-usb-xhci-mtk"
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-mediatek"
            )
            base_usb_packages+=("${mtk_packages[@]}")
            ;;
        ath79)
            log "æ£€æµ‹åˆ°ATH79å¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local ath79_packages=(
                "kmod-usb2-ath79"
                "kmod-usb-ohci"
            )
            base_usb_packages+=("${ath79_packages[@]}")
            ;;
    esac
    
    # å»é‡å¹¶æ·»åŠ USBè½¯ä»¶åŒ…
    local added_packages=0
    local existing_packages=0
    while read pkg; do
        [ -z "$pkg" ] && continue
        if ! grep -q "^CONFIG_PACKAGE_${pkg}=y" .config && ! grep -q "^CONFIG_PACKAGE_${pkg}=m" .config; then
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            added_packages=$((added_packages + 1))
            log "  âœ… æ·»åŠ è½¯ä»¶åŒ…: $pkg"
        else
            existing_packages=$((existing_packages + 1))
        fi
    done < <(printf "%s\n" "${base_usb_packages[@]}" "${extended_usb_packages[@]}" "${fs_support_packages[@]}" | sort -u)
    
    log "ğŸ“Š USBè½¯ä»¶åŒ…ç»Ÿè®¡: æ–°å¢ $added_packages ä¸ª, å·²å­˜åœ¨ $existing_packages ä¸ª"
    
    # æ­¥éª¤9: ç¬¬äºŒæ¬¡å»é‡
    log "ğŸ”„ ç¬¬äºŒæ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤10: ç¬¬äºŒæ¬¡è¿è¡Œ make defconfigï¼ˆåº”ç”¨å¼ºåˆ¶é…ç½®ï¼‰
    log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfigï¼ˆåº”ç”¨å¼ºåˆ¶é…ç½®ï¼‰..."
    make defconfig > /tmp/build-logs/defconfig2.log 2>&1 || {
        log "âš ï¸ ç¬¬äºŒæ¬¡ make defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­..."
    }
    log "âœ… ç¬¬äºŒæ¬¡ make defconfig å®Œæˆ"
    
    # æ­¥éª¤11: éªŒè¯å…³é”®USBé©±åŠ¨æ˜¯å¦è¢«æ­£ç¡®å¯ç”¨
    log "ğŸ” éªŒè¯å…³é”®USBé©±åŠ¨çŠ¶æ€..."
    
    local critical_usb_drivers=(
        "kmod-usb-core"
        "kmod-usb2"
        "kmod-usb-storage"
        "kmod-scsi-core"
    )
    
    # æ ¹æ®å¹³å°æ·»åŠ å…³é”®é©±åŠ¨
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            critical_usb_drivers+=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-qcom"
            )
            ;;
        mediatek|ramips)
            critical_usb_drivers+=(
                "kmod-usb-xhci-mtk"
            )
            ;;
    esac
    
    local missing_drivers=()
    for driver in "${critical_usb_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "  âœ… $driver: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${driver}=m" .config; then
            log "  ğŸ“¦ $driver: æ¨¡å—åŒ–"
        else
            log "  âŒ $driver: æœªå¯ç”¨"
            missing_drivers+=("$driver")
        fi
    done
    
    # æ£€æŸ¥USB 3.0/xhciåŠŸèƒ½ï¼ˆå¤šç§å®ç°æ–¹å¼ï¼‰
    log "  ğŸ” USB 3.0/xhciåŠŸèƒ½æ£€æµ‹:"
    local usb3_found=0
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        log "    âœ… kmod-usb3: å·²å¯ç”¨"
        usb3_found=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        log "    âœ… kmod-usb-xhci-hcd: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" .config; then
        log "    âœ… kmod-usb-xhci-plat-hcd: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-qcom=y" .config; then
        log "    âœ… kmod-usb-xhci-qcom: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config; then
        log "    âœ… kmod-usb-xhci-mtk: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        log "    âœ… DWC3 + USB3: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_USB_XHCI_HCD=y" .config; then
        log "    âœ… å†…æ ¸xhciæ”¯æŒ: å·²å¯ç”¨"
        usb3_found=1
    fi
    
    if [ $usb3_found -eq 0 ]; then
        log "    âŒ USB 3.0åŠŸèƒ½æœªå¯ç”¨"
        missing_drivers+=("USB 3.0åŠŸèƒ½")
    fi
    
    if [ ${#missing_drivers[@]} -gt 0 ]; then
        log "âš ï¸ ç¼ºå¤±é©±åŠ¨: ${missing_drivers[*]}"
        
        # å¦‚æœå¯ç”¨äº†è‡ªåŠ¨ä¿®å¤ï¼Œå°è¯•æ·»åŠ ç¼ºå¤±é©±åŠ¨
        if [ "${AUTO_FIX_USB_DRIVERS:-true}" = "true" ]; then
            log "ğŸ”§ è‡ªåŠ¨ä¿®å¤ç¼ºå¤±é©±åŠ¨..."
            for driver in "${missing_drivers[@]}"; do
                if [[ "$driver" != "USB 3.0åŠŸèƒ½" ]]; then
                    echo "CONFIG_PACKAGE_${driver}=y" >> .config
                    log "  âœ… å·²æ·»åŠ : $driver"
                fi
            done
            # é‡æ–°è¿è¡Œdefconfig
            make defconfig > /dev/null 2>&1
            log "âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆ"
        fi
    else
        log "âœ… æ‰€æœ‰å…³é”®USBé©±åŠ¨éƒ½å·²å¯ç”¨"
    fi
    
    # æ­¥éª¤12: æ˜¾ç¤ºæ‰€æœ‰å·²å¯ç”¨çš„USBé©±åŠ¨
    log "ğŸ“‹ æ‰€æœ‰å·²å¯ç”¨çš„USBé©±åŠ¨:"
    local all_usb=$(grep "^CONFIG_PACKAGE_kmod-usb.*=y" .config | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    if [ -n "$all_usb" ]; then
        local usb_count=$(echo "$all_usb" | wc -l)
        log "å…± $usb_count ä¸ªUSBé©±åŠ¨:"
        echo "$all_usb" | while read driver; do
            log "  âœ… $driver"
        done
    else
        log "  æœªæ‰¾åˆ°USBé©±åŠ¨"
    fi
    
    # æ­¥éª¤13: æ˜¾ç¤ºæ‰€æœ‰USBç›¸å…³è½¯ä»¶åŒ…ï¼ˆåŒ…æ‹¬æ¨¡å—åŒ–çš„ï¼‰
    log "ğŸ“‹ æ‰€æœ‰USBç›¸å…³è½¯ä»¶åŒ…ï¼ˆåŒ…æ‹¬æ¨¡å—åŒ–ï¼‰:"
    local all_usb_packages=$(grep "^CONFIG_PACKAGE_kmod-usb" .config | grep -E "=y|=m" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    if [ -n "$all_usb_packages" ]; then
        local pkg_count=$(echo "$all_usb_packages" | wc -l)
        log "å…± $pkg_count ä¸ªUSBè½¯ä»¶åŒ…:"
        echo "$all_usb_packages" | while read pkg; do
            if grep -q "^CONFIG_PACKAGE_${pkg}=y" .config; then
                log "  âœ… $pkg"
            else
                log "  ğŸ“¦ $pkg"
            fi
        done
    else
        log "  æœªæ‰¾åˆ°USBè½¯ä»¶åŒ…"
    fi
    
    # æ­¥éª¤14: æœ€ç»ˆè®¾å¤‡éªŒè¯
    log "ğŸ” æ­£åœ¨éªŒè¯è®¾å¤‡ $openwrt_device æ˜¯å¦è¢«é€‰ä¸­..."
    
    if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
        log "âœ… ç›®æ ‡è®¾å¤‡å·²æ­£ç¡®å¯ç”¨: CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y"
    elif grep -q "^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} is not set" .config; then
        log "âš ï¸ è­¦å‘Š: è®¾å¤‡è¢«ç¦ç”¨ï¼Œå°è¯•å¼ºåˆ¶å¯ç”¨..."
        sed -i "/^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} is not set/d" .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1
        
        if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
            log "âœ… è®¾å¤‡å·²å¼ºåˆ¶å¯ç”¨"
        else
            log "âŒ æ— æ³•å¯ç”¨è®¾å¤‡"
        fi
    else
        log "âš ï¸ è­¦å‘Š: è®¾å¤‡é…ç½®è¡Œæœªæ‰¾åˆ°ï¼Œæ‰‹åŠ¨æ·»åŠ ..."
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1
    fi
    
    # æ­¥éª¤15: ä¿å­˜é…ç½®ç»Ÿè®¡ä¿¡æ¯
    local total_configs=$(wc -l < .config)
    local enabled_packages=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config)
    local module_packages=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config)
    local disabled_packages=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config)
    local enabled_kernel=$(grep -c "^CONFIG_[A-Z].*=y$" .config | grep -v "PACKAGE" | wc -l)
    
    log "ğŸ“Š é…ç½®ç»Ÿè®¡:"
    log "  æ€»é…ç½®è¡Œæ•°: $total_configs"
    log "  å¯ç”¨è½¯ä»¶åŒ…: $enabled_packages"
    log "  æ¨¡å—åŒ–è½¯ä»¶åŒ…: $module_packages"
    log "  ç¦ç”¨è½¯ä»¶åŒ…: $disabled_packages"
    log "  å¯ç”¨å†…æ ¸é…ç½®: $enabled_kernel"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘


#ã€build_firmware_main.sh-38ã€‘
workflow_step25_build_firmware() {
    local enable_parallel="$1"
    
    log "=== æ­¥éª¤25: ç¼–è¯‘å›ºä»¶ï¼ˆæ™ºèƒ½å¹¶è¡Œä¼˜åŒ–ç‰ˆï¼‰ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤25 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    cd $BUILD_DIR
    
    CPU_CORES=$(nproc)
    TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
    
    echo "ğŸ”§ ç³»ç»Ÿä¿¡æ¯:"
    echo "  CPUæ ¸å¿ƒæ•°: $CPU_CORES"
    echo "  å†…å­˜å¤§å°: ${TOTAL_MEM}MB"
    echo "  å¹¶è¡Œä¼˜åŒ–: $enable_parallel"
    
    if [ "$enable_parallel" = "true" ]; then
        echo "ğŸ§  æ™ºèƒ½åˆ¤æ–­æœ€ä½³å¹¶è¡Œä»»åŠ¡æ•°..."
        
        # ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é˜ˆå€¼
        : ${HIGH_PERF_CORES:=4}
        : ${HIGH_PERF_MEM:=4096}
        : ${STD_PERF_CORES:=2}
        : ${STD_PERF_MEM:=2048}
        : ${HIGH_PERF_JOBS:=4}
        : ${STD_PERF_JOBS:=3}
        : ${LOW_PERF_JOBS:=2}
        
        if [ $CPU_CORES -ge $HIGH_PERF_CORES ]; then
            if [ $TOTAL_MEM -ge $HIGH_PERF_MEM ]; then
                MAKE_JOBS=$HIGH_PERF_JOBS
                echo "âœ… æ£€æµ‹åˆ°é«˜æ€§èƒ½Runner (${HIGH_PERF_CORES}æ ¸+${HIGH_PERF_MEM}MB)"
            else
                MAKE_JOBS=$((HIGH_PERF_JOBS - 1))
                echo "âœ… æ£€æµ‹åˆ°æ ‡å‡†Runner (${HIGH_PERF_CORES}æ ¸)"
            fi
        elif [ $CPU_CORES -ge $STD_PERF_CORES ]; then
            if [ $TOTAL_MEM -ge $STD_PERF_MEM ]; then
                MAKE_JOBS=$STD_PERF_JOBS
                echo "âœ… æ£€æµ‹åˆ°GitHubæ ‡å‡†Runner (${STD_PERF_CORES}æ ¸${STD_PERF_MEM}MB)"
            else
                MAKE_JOBS=$((STD_PERF_JOBS - 1))
                echo "âœ… æ£€æµ‹åˆ°${STD_PERF_CORES}æ ¸Runner"
            fi
        else
            MAKE_JOBS=$LOW_PERF_JOBS
            echo "âš ï¸ æ£€æµ‹åˆ°ä½æ€§èƒ½ç³»ç»Ÿ"
        fi
        
        echo "ğŸ¯ å†³å®šä½¿ç”¨ $MAKE_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡"
    else
        MAKE_JOBS=1
        echo "ğŸ”„ ç¦ç”¨å¹¶è¡Œä¼˜åŒ–ï¼Œä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘"
    fi
    
    echo ""
    echo "ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶"
    echo "ğŸ’¡ ç¼–è¯‘é…ç½®:"
    echo "  - å¹¶è¡Œä»»åŠ¡: $MAKE_JOBS"
    echo "  - å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
    
    export FORCE_UNSAFE_CONFIGURE=1
    
    START_TIME=$(date +%s)
    if [ "${ENABLE_VERBOSE_LOG:-false}" = "true" ]; then
        stdbuf -oL -eL time make -j$MAKE_JOBS V=s 2>&1 | tee build.log
    else
        stdbuf -oL -eL time make -j$MAKE_JOBS 2>&1 | tee build.log
    fi
    BUILD_EXIT_CODE=${PIPESTATUS[0]}
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
    
    echo ""
    echo "ğŸ“Š ç¼–è¯‘ç»Ÿè®¡:"
    echo "  - æ€»è€—æ—¶: $((DURATION / 60))åˆ†é’Ÿ$((DURATION % 60))ç§’"
    echo "  - é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
    
    if [ $BUILD_EXIT_CODE -eq 0 ]; then
        echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
    else
        echo "âŒ é”™è¯¯: ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
        exit $BUILD_EXIT_CODE
    fi
    
    log "âœ… æ­¥éª¤25 å®Œæˆ"
}
#ã€build_firmware_main.sh-38-endã€‘


#ã€build_firmware_main.sh-41ã€‘
workflow_step30_build_summary() {
    local device_name="$1"
    local version_selection="$2"
    local config_mode="$3"
    local timestamp_sec="$4"
    local enable_parallel="$5"
    
    log "=== æ­¥éª¤30: ç¼–è¯‘åæ€»ç»“ï¼ˆå¢å¼ºç‰ˆï¼‰ ==="
    
    trap 'echo "âš ï¸ æ­¥éª¤30 æ€»ç»“è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
    
    echo "ğŸš€ æ„å»ºæ€»ç»“æŠ¥å‘Š"
    echo "========================================"
    echo "è®¾å¤‡: $device_name"
    echo "ç‰ˆæœ¬: $version_selection"
    echo "é…ç½®æ¨¡å¼: $config_mode"
    echo "æ—¶é—´æˆ³: $timestamp_sec"
    echo "å¹¶è¡Œä¼˜åŒ–: $enable_parallel"
    echo "é…ç½®æ¥æº: ${CONFIG_FILE:-ä½¿ç”¨è„šæœ¬å†…é»˜è®¤å€¼}"
    echo ""
    
    if [ -d "$BUILD_DIR/bin/targets" ]; then
        FIRMWARE_COUNT=$(find "$BUILD_DIR/bin/targets" -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
        
        echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
        echo "  å›ºä»¶æ•°é‡: $FIRMWARE_COUNT ä¸ª (.bin/.img)"
        
        if [ $FIRMWARE_COUNT -gt 0 ]; then
            echo "  äº§ç‰©ä½ç½®: $BUILD_DIR/bin/targets/"
            echo "  ä¸‹è½½åç§°: firmware-$timestamp_sec"
        fi
    fi
    
    echo ""
    echo "ğŸ”§ ç¼–è¯‘å™¨ä¿¡æ¯:"
    if [ -d "$BUILD_DIR" ]; then
        GCC_FILE=$(find "$BUILD_DIR" -type f -executable \
          -name "*gcc" \
          ! -name "*gcc-ar" \
          ! -name "*gcc-ranlib" \
          ! -name "*gcc-nm" \
          ! -path "*dummy-tools*" \
          ! -path "*scripts*" \
          2>/dev/null | head -1)
        
        if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
            SDK_VERSION=$("$GCC_FILE" --version 2>&1 | head -1)
            MAJOR_VERSION=$(echo "$SDK_VERSION" | grep -o "[0-9]\+" | head -1)
            
            if [ "$MAJOR_VERSION" = "12" ]; then
                echo "  ğŸ¯ SDK GCC: 12.3.0 (OpenWrt 23.05 SDK)"
            elif [ "$MAJOR_VERSION" = "8" ]; then
                echo "  ğŸ¯ SDK GCC: 8.4.0 (OpenWrt 21.02 SDK)"
            fi
        fi
    fi
    
    echo ""
    echo "ğŸ“¦ SDKä¸‹è½½çŠ¶æ€:"
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source $BUILD_DIR/build_env.sh
        if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
            echo "  âœ… SDKå·²ä¸‹è½½: $COMPILER_DIR"
        else
            echo "  âŒ SDKæœªä¸‹è½½æˆ–ç›®å½•ä¸å­˜åœ¨"
        fi
    fi
    
    echo ""
    echo "âš™ï¸ åŠŸèƒ½å¼€å…³çŠ¶æ€:"
    echo "  TurboACC: ${ENABLE_TURBOACC:-true}"
    echo "  TCP BBR: ${ENABLE_TCP_BBR:-true}"
    echo "  ath10k-ctå¼ºåˆ¶: ${FORCE_ATH10K_CT:-true}"
    echo "  USBè‡ªåŠ¨ä¿®å¤: ${AUTO_FIX_USB_DRIVERS:-true}"
    
    echo ""
    echo "âœ… æ„å»ºæµç¨‹å®Œæˆ"
    echo "========================================"
    
    log "âœ… æ­¥éª¤30 å®Œæˆ"
}
#ã€build_firmware_main.sh-41-endã€‘


#ã€build_firmware_main.sh-99ã€‘
main() {
    local command="$1"
    local arg1="$2"
    local arg2="$3"
    local arg3="$4"
    local arg4="$5"
    local arg5="$6"
    
    # ç¡®ä¿é…ç½®å·²åŠ è½½
    if [ -z "$CONFIG_LOADED" ]; then
        if [ -f "$REPO_ROOT/build-config.conf" ]; then
            source "$REPO_ROOT/build-config.conf"
            load_build_config
            export CONFIG_LOADED=1
        fi
    fi
    
    case "$command" in
        "setup_environment")
            setup_environment
            ;;
        "create_build_dir")
            create_build_dir
            ;;
        "initialize_build_env")
            initialize_build_env "$arg1" "$arg2" "$arg3"
            ;;
        "initialize_compiler_env")
            initialize_compiler_env "$arg1"
            ;;
        "add_turboacc_support")
            add_turboacc_support
            ;;
        "configure_feeds")
            configure_feeds
            ;;
        "install_turboacc_packages")
            install_turboacc_packages
            ;;
        "pre_build_space_check")
            pre_build_space_check
            ;;
        "generate_config")
            generate_config "$arg1"
            ;;
        "verify_usb_config")
            verify_usb_config
            ;;
        "check_usb_drivers_integrity")
            check_usb_drivers_integrity
            ;;
        "apply_config")
            apply_config
            ;;
        "fix_network")
            fix_network
            ;;
        "download_dependencies")
            download_dependencies
            ;;
        "integrate_custom_files")
            integrate_custom_files
            ;;
        "cleanup")
            cleanup
            ;;
        "save_source_code_info")
            save_source_code_info
            ;;
        "verify_compiler_files")
            verify_compiler_files
            ;;
        "check_compiler_invocation")
            check_compiler_invocation
            ;;
        "verify_sdk_directory")
            verify_sdk_directory
            ;;
        "verify_config_files")
            verify_config_files
            ;;
        
        "step05_install_basic_tools")
            workflow_step05_install_basic_tools
            ;;
        "step06_initial_space_check")
            workflow_step06_initial_space_check
            ;;
        "step07_create_build_dir")
            workflow_step07_create_build_dir
            ;;
        "step08_initialize_build_env")
            workflow_step08_initialize_build_env "$arg1" "$arg2" "$arg3"
            ;;
        "step09_download_sdk")
            workflow_step09_download_sdk "$arg1"
            ;;
        "step10_verify_sdk")
            workflow_step10_verify_sdk
            ;;
        "step11_add_turboacc")
            workflow_step11_add_turboacc
            ;;
        "step12_configure_feeds")
            workflow_step12_configure_feeds
            ;;
        "step13_install_turboacc")
            workflow_step13_install_turboacc
            ;;
        "step14_pre_build_space_check")
            workflow_step14_pre_build_space_check
            ;;
        "step15_generate_config")
            workflow_step15_generate_config "$arg1"
            ;;
        "step16_verify_usb")
            workflow_step16_verify_usb
            ;;
        "step17_check_usb_drivers")
            workflow_step17_check_usb_drivers
            ;;
        "step20_fix_network")
            workflow_step20_fix_network
            ;;
        "step21_download_deps")
            workflow_step21_download_deps
            ;;
        "step22_integrate_custom_files")
            workflow_step22_integrate_custom_files
            ;;
        "step23_pre_build_check")
            workflow_step23_pre_build_check
            ;;
        "step25_build_firmware")
            workflow_step25_build_firmware "$arg1"
            ;;
        "step26_check_artifacts")
            workflow_step26_check_artifacts
            ;;
        "step29_post_build_space_check")
            workflow_step29_post_build_space_check
            ;;
        "step30_build_summary")
            workflow_step30_build_summary "$arg1" "$arg2" "$arg3" "$arg4" "$arg5"
            ;;
        
        "search_compiler_files")
            universal_compiler_search "$arg1" "$arg2"
            ;;
        "universal_compiler_search")
            universal_compiler_search "$arg1" "$arg2"
            ;;
        "search_compiler_files_simple")
            search_compiler_files_simple "$arg1" "$arg2"
            ;;
        "intelligent_platform_aware_compiler_search")
            intelligent_platform_aware_compiler_search "$arg1" "$arg2" "$arg3"
            ;;
        
        *)
            log "âŒ æœªçŸ¥å‘½ä»¤: $command"
            echo "å¯ç”¨å‘½ä»¤:"
            echo "  åŸºç¡€å‡½æ•°: setup_environment, create_build_dir, initialize_build_env, etc."
            echo ""
            echo "  å·¥ä½œæµæ­¥éª¤å‘½ä»¤:"
            echo "    step05_install_basic_tools, step06_initial_space_check, step07_create_build_dir"
            echo "    step08_initialize_build_env, step09_download_sdk, step10_verify_sdk"
            echo "    step11_add_turboacc, step12_configure_feeds, step13_install_turboacc"
            echo "    step14_pre_build_space_check, step15_generate_config, step16_verify_usb"
            echo "    step17_check_usb_drivers, step20_fix_network, step21_download_deps"
            echo "    step22_integrate_custom_files, step23_pre_build_check, step25_build_firmware"
            echo "    step26_check_artifacts, step29_post_build_space_check, step30_build_summary"
            exit 1
            ;;
    esac
}

if [ $# -eq 0 ]; then
    echo "é”™è¯¯: éœ€è¦æä¾›å‘½ä»¤å‚æ•°"
    echo "ç”¨æ³•: $0 <å‘½ä»¤> [å‚æ•°1] [å‚æ•°2] [å‚æ•°3] [å‚æ•°4] [å‚æ•°5]"
    echo "ä¾‹å¦‚: $0 step08_initialize_build_env xiaomi_mi-router-4a-100m 23.05 normal"
    exit 1
fi

main "$@"
#ã€build_firmware_main.sh-99-endã€‘
