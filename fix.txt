#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…ï¼ˆç»¼åˆä¿®å¤ç‰ˆ + Makefileè¯­æ³•æ£€æŸ¥ï¼‰==="
    
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åº”ç”¨é…ç½®"
        return 1
    fi
    
    log "ğŸ“‹ é…ç½®è¯¦æƒ…:"
    log "é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "é…ç½®è¡Œæ•°: $(wc -l < .config)"
    
    local backup_file=".config.bak.$(date +%Y%m%d%H%M%S)"
    cp .config "$backup_file"
    log "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½: $backup_file"
    
    log "ğŸ”§ æ­¥éª¤1: æ ‡å‡†åŒ–é…ç½®æ–‡ä»¶æ ¼å¼..."
    
    if [ -f ".config" ]; then
        awk '
        {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if ($0 ~ /^#/) {
                if ($0 ~ /^#CONFIG_/) {
                    $0 = "# " substr($0, 2)
                }
                if ($0 !~ /is not set$/) {
                    $0 = $0 " is not set"
                }
            }
            if ($0 ~ /^CONFIG_/) {
                if ($0 ~ /y$|m$|=$/) {
                    gsub(/[[:space:]]*=[[:space:]]*y$/, "=y")
                    gsub(/[[:space:]]*=[[:space:]]*m$/, "=m")
                    gsub(/[[:space:]]*=[[:space:]]*$/, "=")
                }
            }
            if (length($0) > 0) {
                print $0
            }
        }' .config > .config.tmp
        
        mv .config.tmp .config
        log "âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ ‡å‡†åŒ–å®Œæˆ"
    else
        log "âŒ .config æ–‡ä»¶åœ¨æ“ä½œè¿‡ç¨‹ä¸­ä¸¢å¤±"
        return 1
    fi
    
    log "ğŸ”§ æ­¥éª¤2: æ¸…ç†é‡å¤é…ç½®è¡Œ..."
    
    local dup_before=$(wc -l < .config)
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    local dup_after=$(wc -l < .config)
    local dup_removed=$((dup_before - dup_after))
    
    if [ $dup_removed -gt 0 ]; then
        log "âœ… å·²åˆ é™¤ $dup_removed ä¸ªå®Œå…¨é‡å¤çš„é…ç½®è¡Œ"
    fi
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    local config_uniq_removed=$((dup_after - $(wc -l < .config)))
    if [ $config_uniq_removed -gt 0 ]; then
        log "âœ… å·²åˆå¹¶ $config_uniq_removed ä¸ªé‡å¤é…ç½®é¡¹"
    fi
    
    log "ğŸ”§ æ­¥éª¤3: æ£€æŸ¥libustreamå†²çª..."
    
    local openssl_enabled=0
    local wolfssl_enabled=0
    
    if grep -q "^CONFIG_PACKAGE_libustream-openssl=y" .config; then
        openssl_enabled=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_libustream-wolfssl=y" .config; then
        wolfssl_enabled=1
    fi
    
    if [ $openssl_enabled -eq 1 ] && [ $wolfssl_enabled -eq 1 ]; then
        log "âš ï¸ å‘ç°libustream-opensslå’Œlibustream-wolfsslå†²çª"
        log "ğŸ”§ ä¿®å¤å†²çª: ç¦ç”¨libustream-openssl"
        
        awk '
        /^CONFIG_PACKAGE_libustream-openssl=y/ {
            print "# CONFIG_PACKAGE_libustream-openssl is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config
        
        log "âœ… å†²çªå·²ä¿®å¤"
    fi
    
    log "ğŸ”§ æ­¥éª¤4: ä½¿ç”¨OpenWrtå®˜æ–¹é…ç½®å·¥å…·å¼ºåˆ¶ä¿®å¤å…³é”®é…ç½®..."
    
    if [ ! -f "scripts/config" ]; then
        log "âš ï¸ scripts/configå·¥å…·ä¸å­˜åœ¨ï¼Œç¼–è¯‘ç”Ÿæˆä¸­..."
        make scripts/config || {
            log "âŒ æ— æ³•ç”Ÿæˆscripts/configå·¥å…·"
            log "âš ï¸ å°†ä½¿ç”¨awkæ–¹å¼è¿›è¡Œä¿®å¤"
        }
    fi
    
    log "  ğŸ”§ USB 3.0é©±åŠ¨ä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-xhci-hcd
        ./scripts/config --enable CONFIG_PACKAGE_kmod-usb3
    else
        awk '
        /^# CONFIG_PACKAGE_kmod-usb-xhci-hcd is not set/ {
            print "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
            next
        }
        /^CONFIG_PACKAGE_kmod-usb-xhci-hcd=.*/ {
            print "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config.tmp; then
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config.tmp
        fi
        
        awk '
        /^# CONFIG_PACKAGE_kmod-usb3 is not set/ {
            print "CONFIG_PACKAGE_kmod-usb3=y"
            next
        }
        /^CONFIG_PACKAGE_kmod-usb3=.*/ {
            print "CONFIG_PACKAGE_kmod-usb3=y"
            next
        }
        { print $0 }
        ' .config.tmp > .config
        rm -f .config.tmp
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
            echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        fi
    fi
    log "  âœ… USB 3.0é©±åŠ¨å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        log "  ğŸ”§ IPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨ä¿®å¤..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3-qcom
            ./scripts/config --enable CONFIG_PACKAGE_kmod-phy-qcom-dwc3
            ./scripts/config --enable CONFIG_PACKAGE_kmod-usb-dwc3
        else
            if ! grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config; then
                echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
                echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
            fi
        fi
        log "  âœ… IPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨ä¿®å¤å®Œæˆ"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  ğŸ”§ TurboACCé…ç½®ä¿®å¤..."
        if [ -f "scripts/config" ]; then
            ./scripts/config --enable CONFIG_PACKAGE_luci-app-turboacc
            ./scripts/config --enable CONFIG_PACKAGE_kmod-shortcut-fe
            ./scripts/config --enable CONFIG_PACKAGE_kmod-fast-classifier
        else
            if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
                echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-shortcut-fe=y" .config; then
                echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-fast-classifier=y" .config; then
                echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
            fi
        fi
        log "  âœ… TurboACCé…ç½®ä¿®å¤å®Œæˆ"
    fi
    
    log "  ğŸ”§ TCP BBRæ‹¥å¡æ§åˆ¶ä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --enable CONFIG_PACKAGE_kmod-tcp-bbr
        ./scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
    else
        if ! grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        
        awk '!/^CONFIG_DEFAULT_TCP_CONG=/' .config > .config.tmp
        mv .config.tmp .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    fi
    log "  âœ… TCP BBRæ‹¥å¡æ§åˆ¶ä¿®å¤å®Œæˆ"
    
    log "  ğŸ”§ kmod-ath10k-ctå†²çªä¿®å¤..."
    if [ -f "scripts/config" ]; then
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-pci
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-smallbuffers
        ./scripts/config --enable CONFIG_PACKAGE_kmod-ath10k-ct
        ./scripts/config --disable CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers
    else
        awk '
        /^CONFIG_PACKAGE_kmod-ath10k=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-pci=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-pci is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-ath10k-ct=y" .config; then
            echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        fi
    fi
    log "  âœ… kmod-ath10k-ctå†²çªä¿®å¤å®Œæˆ"
    
    log "ğŸ”§ æ­¥éª¤5: æœ€ç»ˆå»é‡å’Œæ ¼å¼æ£€æŸ¥..."
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    awk 'NF > 0' .config > .config.tmp
    mv .config.tmp .config
    
    log "âœ… æœ€ç»ˆå»é‡å®Œæˆ"
    
    log "ğŸ”§ æ­¥éª¤6: Makefileè¯­æ³•æ£€æŸ¥ä¸ä¿®å¤..."
    
    local config_line_num=1
    local fixed_count=0
    local temp_config=$(mktemp)
    
    while IFS= read -r line; do
        if echo "$line" | grep -q "^CONFIG_" && ! echo "$line" | grep -q "=y$" && ! echo "$line" | grep -q "=m$" && ! echo "$line" | grep -q "=" && ! echo "$line" | grep -q "is not set$"; then
            log "âš ï¸ ç¬¬ $config_line_num è¡Œæ ¼å¼é”™è¯¯: $line"
            echo "# $line (å·²ä¿®å¤: ç¼ºå°‘åˆ†éš”ç¬¦)" >> "$temp_config"
            echo "# CONFIG_$(echo "$line" | sed 's/^CONFIG_//') is not set" >> "$temp_config"
            fixed_count=$((fixed_count + 1))
        elif echo "$line" | grep -q "^CONFIG_.*=y$" && echo "$line" | grep -q "[[:space:]]=y$"; then
            local fixed_line=$(echo "$line" | sed 's/[[:space:]]*=y$/=y/')
            log "âš ï¸ ç¬¬ $config_line_num è¡Œç©ºæ ¼ä¿®å¤: $line -> $fixed_line"
            echo "$fixed_line" >> "$temp_config"
            fixed_count=$((fixed_count + 1))
        elif echo "$line" | grep -q "^CONFIG_.*=m$" && echo "$line" | grep -q "[[:space:]]=m$"; then
            local fixed_line=$(echo "$line" | sed 's/[[:space:]]*=m$/=m/')
            log "âš ï¸ ç¬¬ $config_line_num è¡Œç©ºæ ¼ä¿®å¤: $line -> $fixed_line"
            echo "$fixed_line" >> "$temp_config"
            fixed_count=$((fixed_count + 1))
        elif echo "$line" | grep -q "^CONFIG_.*[[:space:]]+$"; then
            log "âš ï¸ ç¬¬ $config_line_num è¡Œå°¾éšç©ºæ ¼: $line"
            local fixed_line=$(echo "$line" | sed 's/[[:space:]]*$//')
            echo "$fixed_line" >> "$temp_config"
            fixed_count=$((fixed_count + 1))
        elif echo "$line" | grep -q "^[[:space:]]*CONFIG_" && ! echo "$line" | grep -q "^CONFIG_"; then
            log "âš ï¸ ç¬¬ $config_line_num è¡Œå‰å¯¼ç©ºæ ¼: $line"
            local fixed_line=$(echo "$line" | sed 's/^[[:space:]]*//')
            echo "$fixed_line" >> "$temp_config"
            fixed_count=$((fixed_count + 1))
        else
            echo "$line" >> "$temp_config"
        fi
        config_line_num=$((config_line_num + 1))
    done < .config
    
    mv "$temp_config" .config
    
    if [ $fixed_count -gt 0 ]; then
        log "âœ… Makefileè¯­æ³•ä¿®å¤å®Œæˆï¼Œå…±ä¿®å¤ $fixed_count ä¸ªæ ¼å¼é—®é¢˜"
    else
        log "âœ… Makefileè¯­æ³•æ£€æŸ¥é€šè¿‡ï¼Œæœªå‘ç°æ ¼å¼é—®é¢˜"
    fi
    
    log "ğŸ”§ æ­¥éª¤7: æ£€æŸ¥æ— æ•ˆé…ç½®é¡¹..."
    
    local invalid_patterns=(
        "CONFIG_PACKAGE_bmx7"
        "CONFIG_PACKAGE_bmx7-dnsupdate"
        "CONFIG_PACKAGE_kmod-bmx7"
    )
    
    local invalid_count=0
    for pattern in "${invalid_patterns[@]}"; do
        if grep -q "^${pattern}=y" .config; then
            log "âš ï¸ å‘ç°æ— æ•ˆé…ç½®é¡¹: ${pattern}=y"
            awk "!/^${pattern}=y/" .config > .config.tmp
            mv .config.tmp .config
            log "âœ… å·²ç§»é™¤æ— æ•ˆé…ç½®: ${pattern}"
            invalid_count=$((invalid_count + 1))
        fi
    done
    
    if [ $invalid_count -gt 0 ]; then
        log "âœ… å·²ç§»é™¤ $invalid_count ä¸ªæ— æ•ˆé…ç½®é¡¹"
    fi
    
    log "ğŸ”§ æ­¥éª¤8: è¿è¡Œ make defconfig å‰éªŒè¯..."
    
    if [ ! -f "scripts/config" ]; then
        log "âš ï¸ scripts/configå·¥å…·ä¸å­˜åœ¨ï¼Œè·³è¿‡é¢„éªŒè¯"
    else
        local test_config=$(mktemp)
        cp .config "$test_config"
        
        if ./scripts/config --file "$test_config" --enable TEST_CONFIG 2>/dev/null; then
            log "âœ… scripts/config å·¥å…·å¯ç”¨"
        else
            log "âš ï¸ scripts/config å·¥å…·å¯èƒ½æœ‰é—®é¢˜ï¼Œå°†ä½¿ç”¨ç›´æ¥å†™å…¥æ–¹å¼"
        fi
        rm -f "$test_config"
    fi
    
    log "ğŸ”„ æ­¥éª¤9: è¿è¡Œ make defconfig..."
    
    local defconfig_output=$(mktemp)
    
    if make defconfig 2>&1 | tee "$defconfig_output"; then
        log "âœ… make defconfig æ‰§è¡ŒæˆåŠŸ"
    else
        local exit_code=$?
        log "âŒ make defconfig å¤±è´¥ï¼Œé€€å‡ºä»£ç : $exit_code"
        
        if grep -q "missing separator" "$defconfig_output"; then
            log "ğŸ”§ æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯ï¼Œæ­£åœ¨æ‰§è¡Œæ·±åº¦ä¿®å¤..."
            
            local line_number=$(grep -n "missing separator" "$defconfig_output" | head -1 | grep -o "[0-9]\+")
            if [ -n "$line_number" ]; then
                log "ğŸ“Œ é”™è¯¯å‘ç”Ÿåœ¨ç¬¬ $line_number è¡Œé™„è¿‘"
                
                local start_line=$((line_number - 5))
                if [ $start_line -lt 1 ]; then start_line=1; fi
                
                log "ğŸ“‹ é”™è¯¯ä¸Šä¸‹æ–‡:"
                sed -n "${start_line},$((line_number + 5))p" .config 2>/dev/null | nl -v $start_line || true
            fi
            
            log "ğŸ”§ æ‰§è¡Œæ¿€è¿›ä¿®å¤æ¨¡å¼..."
            
            local clean_config=$(mktemp)
            
            grep "^CONFIG_.*=[ym]$" .config | sort -u > "$clean_config"
            grep "^# CONFIG_.* is not set$" .config | sort -u >> "$clean_config"
            
            mv "$clean_config" .config
            
            log "âœ… æ¿€è¿›ä¿®å¤å®Œæˆï¼Œé…ç½®è¡Œæ•°: $(wc -l < .config)"
            
            log "ğŸ”„ é‡æ–°è¿è¡Œ make defconfig..."
            if make defconfig; then
                log "âœ… make defconfig ä¿®å¤æˆåŠŸ"
            else
                log "âŒ make defconfig ä»ç„¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶"
                cat .config | head -50
                handle_error "åº”ç”¨é…ç½®å¤±è´¥"
            fi
        else
            handle_error "make defconfig å¤±è´¥"
        fi
    fi
    
    rm -f "$defconfig_output"
    
    log "ğŸ”§ æ­¥éª¤10: éªŒè¯å…³é”®é…ç½®..."
    
    local missing_key_configs=()
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        missing_key_configs+=("kmod-usb-xhci-hcd")
    fi
    
    if ! grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        missing_key_configs+=("kmod-usb3")
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            missing_key_configs+=("luci-app-turboacc")
        fi
    fi
    
    if [ ${#missing_key_configs[@]} -gt 0 ]; then
        log "âš ï¸ è­¦å‘Š: ä»¥ä¸‹å…³é”®é…ç½®åœ¨defconfigåä¸¢å¤±: ${missing_key_configs[*]}"
        log "ğŸ’¡ å°è¯•å¼ºåˆ¶æ·»åŠ ä¸¢å¤±çš„å…³é”®é…ç½®..."
        
        for config in "${missing_key_configs[@]}"; do
            if [ -f "scripts/config" ]; then
                ./scripts/config --enable "CONFIG_PACKAGE_${config}"
                log "âœ… å¼ºåˆ¶æ·»åŠ : $config"
            else
                echo "CONFIG_PACKAGE_${config}=y" >> .config
                log "âœ… å¼ºåˆ¶æ·»åŠ : $config"
            fi
        done
        
        make defconfig || log "âš ï¸ äºŒæ¬¡defconfigå¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
        log "âœ… å…³é”®é…ç½®å¼ºåˆ¶æ·»åŠ å®Œæˆ"
    else
        log "âœ… æ‰€æœ‰å…³é”®é…ç½®éªŒè¯é€šè¿‡"
    fi
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
    log "æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "æœ€ç»ˆé…ç½®å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "æœ€ç»ˆé…ç½®è¡Œæ•°: $(wc -l < .config)"
}
#ã€build_firmware_main.sh-16-endã€‘
