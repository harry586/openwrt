#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    local device_override=$2
    
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    if [ -n "$device_override" ]; then
        DEVICE="$device_override"
        log "ğŸ”§ ä½¿ç”¨è®¾å¤‡è¦†ç›–å‚æ•°: $DEVICE"
    fi
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆåŠ¨æ€æ˜ å°„ç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    if [ -z "$DEVICE" ]; then
        log "âŒ é”™è¯¯: DEVICEå˜é‡ä¸ºç©ºï¼"
        env | grep -E "DEVICE|TARGET|SELECTED" || true
        handle_error "DEVICEå˜é‡æœªè®¾ç½®"
    fi
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # åŠ¨æ€è·å–è®¾å¤‡å¹³å°ä¿¡æ¯ - æ¯æ¬¡éƒ½é‡æ–°è·å–ï¼Œç¡®ä¿æœ€æ–°
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” ä»support.shè·å–è®¾å¤‡å¹³å°ä¿¡æ¯..."
        local platform_info=$("$SUPPORT_SCRIPT" get-platform "$DEVICE" 2>/dev/null)
        if [ -n "$platform_info" ]; then
            # æ›´æ–°TARGETå’ŒSUBTARGET
            TARGET=$(echo "$platform_info" | awk '{print $1}')
            SUBTARGET=$(echo "$platform_info" | awk '{print $2}')
            log "âœ… ä»support.shè·å–å¹³å°ä¿¡æ¯: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
            
            # ä¿å­˜åˆ°ç¯å¢ƒæ–‡ä»¶
            save_env
        else
            log "âŒ support.shæ— æ³•è·å–è®¾å¤‡ä¿¡æ¯"
            handle_error "è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥"
        fi
    else
        log "âŒ support.shä¸å­˜åœ¨"
        handle_error "support.shè„šæœ¬ç¼ºå¤±"
    fi
    
    local device_lower="$DEVICE"
    local device_config="CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}"
    
    log "ğŸ”§ è®¾å¤‡é…ç½®å˜é‡: $device_config=y"
    
    # åˆ›å»ºåŸºç¡€ç›®æ ‡é…ç½®
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
${device_config}=y
EOF
    
    log "ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶å†…å®¹:"
    cat .config
    
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
            log "âœ… åŠ è½½é…ç½®: $(basename "$file")"
        else
            log "âš ï¸ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $(basename "$file")"
        fi
    }
    
    # åˆå¹¶é…ç½®æ–‡ä»¶
    : ${CONFIG_BASE:="base.config"}
    : ${CONFIG_USB_GENERIC:="usb-generic.config"}
    : ${CONFIG_NORMAL:="normal.config"}
    
    append_config "$CONFIG_DIR/$CONFIG_BASE"
    append_config "$CONFIG_DIR/$CONFIG_USB_GENERIC"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    append_config "$CONFIG_DIR/devices/$DEVICE.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/$CONFIG_NORMAL"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # TCP BBR
    if [ "${ENABLE_TCP_BBR:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        log "âœ… TCP BBRå·²å¯ç”¨"
    fi
    
    # TurboACC
    if [ "$CONFIG_MODE" = "normal" ] && [ "${ENABLE_TURBOACC:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        log "âœ… TurboACCå·²å¯ç”¨"
    fi
    
    # ath10k-ct
    if [ "${FORCE_ATH10K_CT:-true}" = "true" ]; then
        sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        log "âœ… ath10k-cté©±åŠ¨å·²å¼ºåˆ¶å¯ç”¨"
    fi
    
    # ç¬¬ä¸€æ¬¡å»é‡
    log "ğŸ”„ ç¬¬ä¸€æ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # åŠ¨æ€å†…æ ¸é…ç½®æ£€æµ‹
    log "ğŸ” åŠ¨æ€è·å–ç›®æ ‡å¹³å°æ”¯æŒçš„å†…æ ¸é…ç½®..."
    
    local kernel_config_file=""
    local kernel_version=""
    
    # æ£€æµ‹å†…æ ¸é…ç½®æ–‡ä»¶
    for ver in 6.6 6.1 5.15 5.10 5.4; do
        if [ -f "target/linux/$TARGET/config-$ver" ]; then
            kernel_config_file="target/linux/$TARGET/config-$ver"
            kernel_version="$ver"
            break
        fi
    done
    
    if [ -n "$kernel_config_file" ] && [ -f "$kernel_config_file" ]; then
        log "âœ… æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
        
        # æå–USBç›¸å…³é…ç½®
        local usb_configs_file="/tmp/usb_configs_$$.txt"
        grep -E "^(CONFIG_USB|CONFIG_PHY|CONFIG_DWC|CONFIG_XHCI)" "$kernel_config_file" > "$usb_configs_file" 2>/dev/null || true
        
        if [ -s "$usb_configs_file" ]; then
            sort -u "$usb_configs_file" > "$usb_configs_file.sorted"
            local config_count=$(wc -l < "$usb_configs_file.sorted")
            log "æ‰¾åˆ° $config_count ä¸ªUSBç›¸å…³å†…æ ¸é…ç½®"
            
            local added_count=0
            while read line; do
                local config_name=$(echo "$line" | sed 's/^# //g' | cut -d'=' -f1 | cut -d' ' -f1)
                if ! grep -q "^${config_name}=" .config && ! grep -q "^# ${config_name} is not set" .config; then
                    if echo "$line" | grep -q "=y$"; then
                        echo "$line" >> .config
                        added_count=$((added_count + 1))
                    elif echo "$line" | grep -q "is not set"; then
                        echo "$line" >> .config
                        added_count=$((added_count + 1))
                    fi
                fi
            done < "$usb_configs_file.sorted"
            
            log "âœ… æ·»åŠ äº† $added_count ä¸ªæ–°çš„å†…æ ¸é…ç½®"
            rm -f "$usb_configs_file" "$usb_configs_file.sorted"
        fi
    else
        log "âš ï¸ æœªæ‰¾åˆ°ç›®æ ‡å¹³å° $TARGET çš„å†…æ ¸é…ç½®æ–‡ä»¶"
    fi
    
    # ç¬¬ä¸€æ¬¡make defconfig
    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfig..."
    if make defconfig > /tmp/build-logs/defconfig1.log 2>&1; then
        log "âœ… ç¬¬ä¸€æ¬¡ make defconfig æˆåŠŸ"
    else
        log "âŒ ç¬¬ä¸€æ¬¡ make defconfig å¤±è´¥"
        tail -50 /tmp/build-logs/defconfig1.log
        handle_error "ç¬¬ä¸€æ¬¡ä¾èµ–è§£å†³å¤±è´¥"
    fi
    
    # ç¬¬äºŒæ¬¡å»é‡
    log "ğŸ”„ ç¬¬äºŒæ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # ç¬¬äºŒæ¬¡make defconfig
    log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfig..."
    if make defconfig > /tmp/build-logs/defconfig2.log 2>&1; then
        log "âœ… ç¬¬äºŒæ¬¡ make defconfig æˆåŠŸ"
    else
        log "âš ï¸ ç¬¬äºŒæ¬¡ make defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­..."
        tail -20 /tmp/build-logs/defconfig2.log
    fi
    
    # æœ€ç»ˆè®¾å¤‡éªŒè¯
    log "ğŸ” æ­£åœ¨éªŒè¯è®¾å¤‡ $device_lower æ˜¯å¦è¢«é€‰ä¸­..."
    
    if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
        log "âœ… ç›®æ ‡è®¾å¤‡å·²æ­£ç¡®å¯ç”¨"
    else
        log "âŒ è®¾å¤‡æœªå¯ç”¨"
        handle_error "è®¾å¤‡å¯ç”¨å¤±è´¥"
    fi
    
    # é…ç½®ç»Ÿè®¡
    local total_configs=$(wc -l < .config)
    local enabled_packages=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config)
    local module_packages=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config)
    local disabled_packages=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config)
    
    log "ğŸ“Š é…ç½®ç»Ÿè®¡:"
    log "  æ€»é…ç½®è¡Œæ•°: $total_configs"
    log "  å¯ç”¨è½¯ä»¶åŒ…: $enabled_packages"
    log "  æ¨¡å—åŒ–è½¯ä»¶åŒ…: $module_packages"
    log "  ç¦ç”¨è½¯ä»¶åŒ…: $disabled_packages"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
