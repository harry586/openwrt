#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆç»¼åˆä¿®å¤ç‰ˆï¼‰ ==="
    
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åº”ç”¨é…ç½®"
        return 1
    fi
    
    log "ğŸ“‹ é…ç½®è¯¦æƒ…:"
    log "é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "é…ç½®è¡Œæ•°: $(wc -l < .config)"
    
    local backup_file=".config.bak.$(date +%Y%m%d%H%M%S)"
    cp .config "$backup_file"
    log "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½: $backup_file"
    
    log "ğŸ”§ æ­¥éª¤1: æ ‡å‡†åŒ–é…ç½®æ–‡ä»¶æ ¼å¼..."
    
    if [ -f ".config" ]; then
        awk '
        {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if ($0 ~ /^#/) {
                if ($0 ~ /^#CONFIG_/) {
                    $0 = "# " substr($0, 2)
                }
                if ($0 !~ /is not set$/) {
                    $0 = $0 " is not set"
                }
            }
            if ($0 ~ /^CONFIG_/) {
                if ($0 ~ /y$|m$|=$/) {
                    gsub(/[[:space:]]*=[[:space:]]*y$/, "=y")
                    gsub(/[[:space:]]*=[[:space:]]*m$/, "=m")
                    gsub(/[[:space:]]*=[[:space:]]*$/, "=")
                }
            }
            if (length($0) > 0) {
                print $0
            }
        }' .config > .config.tmp
        
        mv .config.tmp .config
        log "âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ ‡å‡†åŒ–å®Œæˆ"
    else
        log "âŒ .config æ–‡ä»¶åœ¨æ“ä½œè¿‡ç¨‹ä¸­ä¸¢å¤±"
        return 1
    fi
    
    log "ğŸ”§ æ­¥éª¤2: æ¸…ç†é‡å¤é…ç½®è¡Œ..."
    
    local dup_before=$(wc -l < .config)
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    local dup_after=$(wc -l < .config)
    local dup_removed=$((dup_before - dup_after))
    
    if [ $dup_removed -gt 0 ]; then
        log "âœ… å·²åˆ é™¤ $dup_removed ä¸ªå®Œå…¨é‡å¤çš„é…ç½®è¡Œ"
    fi
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    local config_uniq_removed=$((dup_after - $(wc -l < .config)))
    if [ $config_uniq_removed -gt 0 ]; then
        log "âœ… å·²åˆå¹¶ $config_uniq_removed ä¸ªé‡å¤é…ç½®é¡¹"
    fi
    
    log "ğŸ”§ æ­¥éª¤3: æ£€æŸ¥libustreamå†²çª..."
    
    local openssl_enabled=0
    local wolfssl_enabled=0
    
    if grep -q "^CONFIG_PACKAGE_libustream-openssl=y" .config; then
        openssl_enabled=1
    fi
    
    if grep -q "^CONFIG_PACKAGE_libustream-wolfssl=y" .config; then
        wolfssl_enabled=1
    fi
    
    if [ $openssl_enabled -eq 1 ] && [ $wolfssl_enabled -eq 1 ]; then
        log "âš ï¸ å‘ç°libustream-opensslå’Œlibustream-wolfsslå†²çª"
        log "ğŸ”§ ä¿®å¤å†²çª: ç¦ç”¨libustream-openssl"
        
        awk '
        /^CONFIG_PACKAGE_libustream-openssl=y/ {
            print "# CONFIG_PACKAGE_libustream-openssl is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config
        
        log "âœ… å†²çªå·²ä¿®å¤"
    fi
    
    log "ğŸ”§ æ­¥éª¤4: ä½¿ç”¨OpenWrté…ç½®å·¥å…·å¼ºåˆ¶ä¿®å¤å…³é”®é…ç½®..."
    
    # æ£€æŸ¥é…ç½®å·¥å…·æ˜¯å¦å­˜åœ¨ - ä¿®å¤ç‰ˆ
    local config_tool=""
    if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
        config_tool="scripts/config/config"
        log "âœ… ä½¿ç”¨ scripts/config/config å·¥å…·"
    elif [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
        config_tool="scripts/config/conf"
        log "âœ… ä½¿ç”¨ scripts/config/conf å·¥å…·"
    elif [ -f "scripts/config" ] && [ -x "scripts/config" ]; then
        config_tool="scripts/config"
        log "âœ… ä½¿ç”¨ scripts/config å·¥å…·"
    else
        log "âš ï¸ é…ç½®å·¥å…·ä¸å­˜åœ¨ï¼Œç¼–è¯‘ç”Ÿæˆä¸­..."
        
        # å°è¯•ç¼–è¯‘é…ç½®å·¥å…·
        if [ -d "scripts/config" ]; then
            make -C scripts/config 2>/dev/null || make scripts/config 2>/dev/null || true
        else
            make scripts/config 2>/dev/null || true
        fi
        
        # å†æ¬¡æ£€æŸ¥
        if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
            config_tool="scripts/config/config"
            log "âœ… ç¼–è¯‘åæ‰¾åˆ° scripts/config/config å·¥å…·"
        elif [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            config_tool="scripts/config/conf"
            log "âœ… ç¼–è¯‘åæ‰¾åˆ° scripts/config/conf å·¥å…·"
        elif [ -f "scripts/config" ] && [ -x "scripts/config" ]; then
            config_tool="scripts/config"
            log "âœ… ç¼–è¯‘åæ‰¾åˆ° scripts/config å·¥å…·"
        else
            log "âš ï¸ æ— æ³•ç¼–è¯‘é…ç½®å·¥å…·ï¼Œå°†ä½¿ç”¨awkæ–¹å¼è¿›è¡Œä¿®å¤"
            config_tool=""
        fi
    fi
    
    log "  ğŸ”§ USB 3.0é©±åŠ¨ä¿®å¤..."
    if [ -n "$config_tool" ]; then
        if [ "$config_tool" = "scripts/config/conf" ]; then
            # conf å·¥å…·ç”¨æ³•ä¸åŒ
            $config_tool --defconfig CONFIG_PACKAGE_kmod-usb-xhci-hcd=y .config 2>/dev/null || true
            $config_tool --defconfig CONFIG_PACKAGE_kmod-usb3=y .config 2>/dev/null || true
        else
            $config_tool --enable PACKAGE_kmod-usb-xhci-hcd 2>/dev/null || true
            $config_tool --enable PACKAGE_kmod-usb3 2>/dev/null || true
        fi
    else
        awk '
        /^# CONFIG_PACKAGE_kmod-usb-xhci-hcd is not set/ {
            print "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
            next
        }
        /^CONFIG_PACKAGE_kmod-usb-xhci-hcd=.*/ {
            print "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config.tmp; then
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config.tmp
        fi
        
        awk '
        /^# CONFIG_PACKAGE_kmod-usb3 is not set/ {
            print "CONFIG_PACKAGE_kmod-usb3=y"
            next
        }
        /^CONFIG_PACKAGE_kmod-usb3=.*/ {
            print "CONFIG_PACKAGE_kmod-usb3=y"
            next
        }
        { print $0 }
        ' .config.tmp > .config
        rm -f .config.tmp
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
            echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        fi
    fi
    log "  âœ… USB 3.0é©±åŠ¨å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        log "  ğŸ”§ IPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨ä¿®å¤..."
        if [ -n "$config_tool" ]; then
            if [ "$config_tool" = "scripts/config/conf" ]; then
                $config_tool --defconfig CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y .config 2>/dev/null || true
                $config_tool --defconfig CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y .config 2>/dev/null || true
                $config_tool --defconfig CONFIG_PACKAGE_kmod-usb-dwc3=y .config 2>/dev/null || true
            else
                $config_tool --enable PACKAGE_kmod-usb-dwc3-qcom 2>/dev/null || true
                $config_tool --enable PACKAGE_kmod-phy-qcom-dwc3 2>/dev/null || true
                $config_tool --enable PACKAGE_kmod-usb-dwc3 2>/dev/null || true
            fi
        else
            if ! grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config; then
                echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config; then
                echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config; then
                echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config
            fi
        fi
        log "  âœ… IPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨ä¿®å¤å®Œæˆ"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  ğŸ”§ TurboACCé…ç½®ä¿®å¤..."
        if [ -n "$config_tool" ]; then
            if [ "$config_tool" = "scripts/config/conf" ]; then
                $config_tool --defconfig CONFIG_PACKAGE_luci-app-turboacc=y .config 2>/dev/null || true
                $config_tool --defconfig CONFIG_PACKAGE_kmod-shortcut-fe=y .config 2>/dev/null || true
                $config_tool --defconfig CONFIG_PACKAGE_kmod-fast-classifier=y .config 2>/dev/null || true
            else
                $config_tool --enable PACKAGE_luci-app-turboacc 2>/dev/null || true
                $config_tool --enable PACKAGE_kmod-shortcut-fe 2>/dev/null || true
                $config_tool --enable PACKAGE_kmod-fast-classifier 2>/dev/null || true
            fi
        else
            if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
                echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-shortcut-fe=y" .config; then
                echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            fi
            if ! grep -q "^CONFIG_PACKAGE_kmod-fast-classifier=y" .config; then
                echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
            fi
        fi
        log "  âœ… TurboACCé…ç½®ä¿®å¤å®Œæˆ"
    fi
    
    log "  ğŸ”§ TCP BBRæ‹¥å¡æ§åˆ¶ä¿®å¤..."
    if [ -n "$config_tool" ]; then
        if [ "$config_tool" = "scripts/config/conf" ]; then
            $config_tool --defconfig CONFIG_PACKAGE_kmod-tcp-bbr=y .config 2>/dev/null || true
            # conf å·¥å…·è®¾ç½®å­—ç¬¦ä¸²å‚æ•°çš„æ–¹å¼
            sed -i '/^CONFIG_DEFAULT_TCP_CONG=/d' .config
            echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        else
            $config_tool --enable PACKAGE_kmod-tcp-bbr 2>/dev/null || true
            $config_tool --set-str DEFAULT_TCP_CONG "bbr" 2>/dev/null || true
        fi
    else
        if ! grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        
        awk '!/^CONFIG_DEFAULT_TCP_CONG=/' .config > .config.tmp
        mv .config.tmp .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    fi
    log "  âœ… TCP BBRæ‹¥å¡æ§åˆ¶ä¿®å¤å®Œæˆ"
    
    log "  ğŸ”§ kmod-ath10k-ctå†²çªä¿®å¤..."
    if [ -n "$config_tool" ]; then
        if [ "$config_tool" = "scripts/config/conf" ]; then
            $config_tool --defconfig '# CONFIG_PACKAGE_kmod-ath10k is not set' .config 2>/dev/null || true
            $config_tool --defconfig '# CONFIG_PACKAGE_kmod-ath10k-pci is not set' .config 2>/dev/null || true
            $config_tool --defconfig '# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set' .config 2>/dev/null || true
            $config_tool --defconfig CONFIG_PACKAGE_kmod-ath10k-ct=y .config 2>/dev/null || true
            $config_tool --defconfig '# CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers is not set' .config 2>/dev/null || true
        else
            $config_tool --disable PACKAGE_kmod-ath10k 2>/dev/null || true
            $config_tool --disable PACKAGE_kmod-ath10k-pci 2>/dev/null || true
            $config_tool --disable PACKAGE_kmod-ath10k-smallbuffers 2>/dev/null || true
            $config_tool --enable PACKAGE_kmod-ath10k-ct 2>/dev/null || true
            $config_tool --disable PACKAGE_kmod-ath10k-ct-smallbuffers 2>/dev/null || true
        fi
    else
        awk '
        /^CONFIG_PACKAGE_kmod-ath10k=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-pci=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-pci is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set"
            next
        }
        /^CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers=y/ {
            print "# CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config
        
        if ! grep -q "^CONFIG_PACKAGE_kmod-ath10k-ct=y" .config; then
            echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        fi
    fi
    log "  âœ… kmod-ath10k-ctå†²çªä¿®å¤å®Œæˆ"
    
    log "ğŸ”§ æ­¥éª¤5: æœ€ç»ˆå»é‡å’Œæ ¼å¼æ£€æŸ¥..."
    
    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config
    
    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq
    
    mv .config.uniq .config
    
    awk 'NF > 0' .config > .config.tmp
    mv .config.tmp .config
    
    log "âœ… æœ€ç»ˆå»é‡å®Œæˆ"
    
    log "ğŸ”„ æ­¥éª¤6: è¿è¡Œ make defconfig..."
    make defconfig || handle_error "åº”ç”¨é…ç½®å¤±è´¥"
    
    log "ğŸ”§ æ­¥éª¤7: éªŒè¯å…³é”®é…ç½®..."
    
    echo ""
    echo "=== ğŸ” USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰ ==="
    
    echo ""
    echo "ğŸ” æ£€æŸ¥åŸºç¡€USBé©±åŠ¨..."
    local required_drivers=(
        "kmod-usb-core"
        "kmod-usb2"
        "kmod-usb-storage"
        "kmod-scsi-core"
    )
    
    for driver in "${required_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "âœ… $driver: å·²å¯ç”¨"
        else
            echo "âŒ $driver: æœªå¯ç”¨"
        fi
    done
    
    echo ""
    echo "ğŸ” æ£€æŸ¥USB 3.0é©±åŠ¨..."
    local usb3_drivers=(
        "kmod-usb3"
        "kmod-usb-xhci-hcd"
    )
    
    for driver in "${usb3_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "âœ… $driver: å·²å¯ç”¨"
        else
            echo "âš ï¸ $driver: æœªå¯ç”¨ï¼ˆå¦‚æœè®¾å¤‡æ”¯æŒUSB 3.0å¯èƒ½éœ€è¦ï¼‰"
        fi
    done
    
    echo ""
    echo "ğŸ” æ£€æŸ¥å¹³å°ä¸“ç”¨é©±åŠ¨..."
    if [ "$TARGET" = "ipq40xx" ] || grep -q "^CONFIG_TARGET_ipq40xx=y" .config 2>/dev/null; then
        echo "ğŸ”§ æ£€æµ‹åˆ°é«˜é€šIPQ40xxå¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
        local ipq40xx_drivers=(
            "kmod-usb-dwc3-qcom"
            "kmod-phy-qcom-dwc3"
            "kmod-usb-dwc3"
        )
        for driver in "${ipq40xx_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                echo "âœ… $driver: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ $driver: æœªå¯ç”¨ï¼ˆå¯èƒ½ä¸æ˜¯å¿…éœ€ï¼‰"
            fi
        done
    elif [ "$TARGET" = "ramips" ] || grep -q "^CONFIG_TARGET_ramips=y" .config 2>/dev/null; then
        echo "ğŸ”§ æ£€æµ‹åˆ°é›·å‡ŒMT76xxå¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
        local ramips_drivers=(
            "kmod-usb-xhci-mtk"
            "kmod-usb-ohci-pci"
            "kmod-usb2-pci"
        )
        for driver in "${ramips_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                echo "âœ… $driver: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ $driver: æœªå¯ç”¨ï¼ˆå¯èƒ½ä¸æ˜¯å¿…éœ€ï¼‰"
            fi
        done
    elif [ "$TARGET" = "ath79" ] || grep -q "^CONFIG_TARGET_ath79=y" .config 2>/dev/null; then
        echo "ğŸ”§ æ£€æµ‹åˆ°é«˜é€šATH79å¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
        local ath79_drivers=(
            "kmod-usb2-ath79"
            "kmod-usb-ohci"
        )
        for driver in "${ath79_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                echo "âœ… $driver: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ $driver: æœªå¯ç”¨ï¼ˆå¯èƒ½ä¸æ˜¯å¿…éœ€ï¼‰"
            fi
        done
    elif [ "$TARGET" = "mediatek" ] || grep -q "^CONFIG_TARGET_mediatek=y" .config 2>/dev/null; then
        echo "ğŸ”§ æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
        local mediatek_drivers=(
            "kmod-usb-dwc3-mediatek"
            "kmod-phy-mediatek"
            "kmod-usb-dwc3"
        )
        for driver in "${mediatek_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                echo "âœ… $driver: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ $driver: æœªå¯ç”¨ï¼ˆå¯èƒ½ä¸æ˜¯å¿…éœ€ï¼‰"
            fi
        done
    fi
    
    echo ""
    echo "=== ğŸ“¦ æ’ä»¶é…ç½®çŠ¶æ€ ==="
    
    local functional_plugins=(
        "luci-app-turboacc:TurboACC ç½‘ç»œåŠ é€Ÿ"
        "luci-app-upnp:UPnP è‡ªåŠ¨ç«¯å£è½¬å‘"
        "samba4-server:Samba æ–‡ä»¶å…±äº«"
        "luci-app-diskman:ç£ç›˜ç®¡ç†"
        "vlmcsd:KMS æ¿€æ´»æœåŠ¡"
        "smartdns:SmartDNS æ™ºèƒ½DNS"
        "luci-app-accesscontrol:å®¶é•¿æ§åˆ¶"
        "luci-app-wechatpush:å¾®ä¿¡æ¨é€"
        "sqm-scripts:æµé‡æ§åˆ¶ (SQM)"
        "vsftpd:FTP æœåŠ¡å™¨"
        "luci-app-arpbind:ARP ç»‘å®š"
        "luci-app-cpulimit:CPU é™åˆ¶"
        "luci-app-hd-idle:ç¡¬ç›˜ä¼‘çœ "
    )
    
    for plugin_entry in "${functional_plugins[@]}"; do
        local plugin="${plugin_entry%%:*}"
        local desc="${plugin_entry#*:}"
        
        if grep -q "^CONFIG_PACKAGE_${plugin}=y" .config; then
            echo "âœ… $desc: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${plugin}=m" .config; then
            echo "ğŸ“¦ $desc: æ¨¡å—åŒ–"
        elif grep -q "^# CONFIG_PACKAGE_${plugin} is not set" .config; then
            echo "âŒ $desc: å·²ç¦ç”¨"
        else
            echo "âšª $desc: æœªé…ç½®"
        fi
    done
    
    echo ""
    echo "=== ğŸ“Š é…ç½®ç»Ÿè®¡ ==="
    local enabled_count=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config 2>/dev/null || echo "0")
    local module_count=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config 2>/dev/null || echo "0")
    local disabled_count=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config 2>/dev/null || echo "0")
    echo "âœ… å·²å¯ç”¨æ’ä»¶: $enabled_count ä¸ª"
    echo "ğŸ“¦ æ¨¡å—åŒ–æ’ä»¶: $module_count ä¸ª"
    echo "âŒ å·²ç¦ç”¨æ’ä»¶: $disabled_count ä¸ª"
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
    log "æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "æœ€ç»ˆé…ç½®å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "æœ€ç»ˆé…ç½®è¡Œæ•°: $(wc -l < .config)"
}
#ã€build_firmware_main.sh-16-endã€‘

#ã€build_firmware_main.sh-06ã€‘
initialize_build_env() {
    local device_name=$1
    local version_selection=$2
    local config_mode=$3
    
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ç‰ˆæœ¬é€‰æ‹© ==="
    if [ "$version_selection" = "23.05" ]; then
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-23.05"
    else
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-21.02"
    fi
    log "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH"
    
    log "=== å…‹éš†æºç  ==="
    log "ä»“åº“: $SELECTED_REPO_URL"
    log "åˆ†æ”¯: $SELECTED_BRANCH"
    
    sudo rm -rf ./* ./.git* 2>/dev/null || true
    
    git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . || handle_error "å…‹éš†æºç å¤±è´¥"
    log "âœ… æºç å…‹éš†å®Œæˆ"
    
    local important_source_files=("Makefile" "feeds.conf.default" "rules.mk" "Config.in")
    for file in "${important_source_files[@]}"; do
        if [ -f "$file" ]; then
            log "âœ… æºç æ–‡ä»¶å­˜åœ¨: $file"
        else
            log "âŒ æºç æ–‡ä»¶ç¼ºå¤±: $file"
        fi
    done
    
    log "=== è®¾å¤‡é…ç½® ==="
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” è°ƒç”¨support.shè·å–è®¾å¤‡å¹³å°ä¿¡æ¯..."
        PLATFORM_INFO=$("$SUPPORT_SCRIPT" get-platform "$device_name")
        if [ -n "$PLATFORM_INFO" ]; then
            TARGET=$(echo "$PLATFORM_INFO" | awk '{print $1}')
            SUBTARGET=$(echo "$PLATFORM_INFO" | awk '{print $2}')
            DEVICE="$device_name"
            log "âœ… ä»support.shè·å–å¹³å°ä¿¡æ¯: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
        else
            log "âŒ æ— æ³•ä»support.shè·å–å¹³å°ä¿¡æ¯"
            handle_error "è·å–å¹³å°ä¿¡æ¯å¤±è´¥"
        fi
    else
        log "âŒ support.shä¸å­˜åœ¨"
        handle_error "support.shè„šæœ¬ç¼ºå¤±"
    fi
    
    log "ğŸ”§ è®¾å¤‡: $device_name"
    log "ğŸ”§ ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    
    CONFIG_MODE="$config_mode"
    
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ­£ç¡®è¯†åˆ«å’Œä½¿ç”¨ç¼–è¯‘å¥½çš„ config å·¥å…·
    log "=== ç¼–è¯‘é…ç½®å·¥å…· ==="
    
    local config_tool_created=0
    local real_config_tool=""
    
    # æ–¹æ³•1: ç¼–è¯‘ scripts/config
    log "ğŸ”§ å°è¯•æ–¹æ³•1: ç¼–è¯‘ scripts/config..."
    if [ -d "scripts/config" ]; then
        cd scripts/config
        make
        cd $BUILD_DIR
        
        # æ£€æŸ¥ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶
        if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            log "âœ… æ–¹æ³•1æˆåŠŸ: ç¼–è¯‘ç”Ÿæˆ conf å·¥å…·"
            
            # åˆ›å»º config åŒ…è£…è„šæœ¬ï¼Œä½¿ç”¨ conf
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# OpenWrt config å·¥å…·åŒ…è£…è„šæœ¬
# ä½¿ç”¨ç¼–è¯‘ç”Ÿæˆçš„ conf å·¥å…·

CONF_TOOL="$(dirname "$0")/conf"

if [ ! -x "$CONF_TOOL" ]; then
    echo "Error: conf tool not found" >&2
    exit 1
fi

# è½¬æ¢å‚æ•°æ ¼å¼
case "$1" in
    --enable)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=y .config
        ;;
    --disable)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=n .config
        ;;
    --module)
        shift
        "$CONF_TOOL" --defconfig CONFIG_$1=m .config
        ;;
    --set-str)
        shift
        name="$1"
        value="$2"
        "$CONF_TOOL" --defconfig CONFIG_$name="$value" .config
        shift 2
        ;;
    *)
        "$CONF_TOOL" "$@"
        ;;
esac
EOF
            chmod +x scripts/config/config
            log "âœ… åˆ›å»º config åŒ…è£…è„šæœ¬æˆåŠŸ"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        elif [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
            log "âœ… æ–¹æ³•1æˆåŠŸ: ç¼–è¯‘ç”Ÿæˆ config å·¥å…·"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•2: ç›´æ¥ä½¿ç”¨ conf ä½œä¸ºé…ç½®å·¥å…·
    if [ $config_tool_created -eq 0 ]; then
        if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
            log "âœ… æ–¹æ³•2æˆåŠŸ: ç›´æ¥ä½¿ç”¨ conf å·¥å…·"
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# ä½¿ç”¨ conf å·¥å…·çš„åŒ…è£…è„šæœ¬
exec "$(dirname "$0")/conf" "$@"
EOF
            chmod +x scripts/config/config
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•3: ä½¿ç”¨ mconf (å¦‚æœå¯ç”¨)
    if [ $config_tool_created -eq 0 ]; then
        if [ -f "scripts/config/mconf" ] && [ -x "scripts/config/mconf" ]; then
            log "âœ… æ–¹æ³•3æˆåŠŸ: ä½¿ç”¨ mconf å·¥å…·"
            mkdir -p scripts/config
            cat > scripts/config/config << 'EOF'
#!/bin/sh
# ä½¿ç”¨ mconf å·¥å…·çš„åŒ…è£…è„šæœ¬
exec "$(dirname "$0")/mconf" "$@"
EOF
            chmod +x scripts/config/config
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•4: ä» SDK å¤åˆ¶
    if [ $config_tool_created -eq 0 ] && [ -n "$COMPILER_DIR" ]; then
        log "ğŸ”§ å°è¯•æ–¹æ³•4: ä» SDK ç›®å½•å¤åˆ¶"
        if [ -f "$COMPILER_DIR/scripts/config/conf" ] && [ -x "$COMPILER_DIR/scripts/config/conf" ]; then
            mkdir -p scripts/config
            cp "$COMPILER_DIR/scripts/config/conf" scripts/config/
            cat > scripts/config/config << 'EOF'
#!/bin/sh
exec "$(dirname "$0")/conf" "$@"
EOF
            chmod +x scripts/config/config
            log "âœ… æ–¹æ³•4æˆåŠŸ: ä» SDK å¤åˆ¶ conf å·¥å…·"
            real_config_tool="scripts/config/config"
            config_tool_created=1
        fi
    fi
    
    # æ–¹æ³•5: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“å·¥å…·
    if [ $config_tool_created -eq 0 ]; then
        log "ğŸ”§ æ–¹æ³•5: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“ config å·¥å…·"
        mkdir -p scripts/config
        cat > scripts/config/config << 'EOF'
#!/bin/bash
# åŠŸèƒ½å®Œæ•´çš„ config å·¥å…·
CONFIG_FILE=".config"

show_help() {
    echo "Usage: config [options]"
    echo "  --enable <symbol>    Enable a configuration option"
    echo "  --disable <symbol>   Disable a configuration option"
    echo "  --module <symbol>    Set a configuration option as module"
    echo "  --set-str <name> <value> Set a string configuration option"
}

# ç¡®ä¿ .config å­˜åœ¨
if [ ! -f "$CONFIG_FILE" ]; then
    touch "$CONFIG_FILE"
fi

case "$1" in
    --enable)
        shift
        symbol="$1"
        # ç§»é™¤ CONFIG_ å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        symbol="${symbol#CONFIG_}"
        # ç§»é™¤ PACKAGE_ å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        symbol="${symbol#PACKAGE_}"
        
        # åˆ é™¤æ‰€æœ‰ç›¸å…³çš„è¡Œ
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        # æ·»åŠ å¯ç”¨è¡Œ
        echo "CONFIG_PACKAGE_${symbol}=y" >> "$CONFIG_FILE"
        ;;
    --disable)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        echo "# CONFIG_PACKAGE_${symbol} is not set" >> "$CONFIG_FILE"
        ;;
    --module)
        shift
        symbol="$1"
        symbol="${symbol#CONFIG_}"
        symbol="${symbol#PACKAGE_}"
        
        sed -i "/^CONFIG_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_PACKAGE_${symbol}=/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_${symbol} is not set/d" "$CONFIG_FILE"
        sed -i "/^# CONFIG_PACKAGE_${symbol} is not set/d" "$CONFIG_FILE"
        
        echo "CONFIG_PACKAGE_${symbol}=m" >> "$CONFIG_FILE"
        ;;
    --set-str)
        shift
        name="$1"
        value="$2"
        name="${name#CONFIG_}"
        
        sed -i "/^CONFIG_${name}=/d" "$CONFIG_FILE"
        echo "CONFIG_${name}="$value"" >> "$CONFIG_FILE"
        shift 2
        ;;
    --help)
        show_help
        ;;
    *)
        echo "Unknown option: $1"
        show_help
        exit 1
        ;;
esac
EOF
        chmod +x scripts/config/config
        log "âœ… æ–¹æ³•5æˆåŠŸ: åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„ç®€æ˜“ config å·¥å…·"
        real_config_tool="scripts/config/config"
        config_tool_created=1
    fi
    
    # åˆ›å»ºç»Ÿä¸€è°ƒç”¨æ¥å£ - ä¿®å¤ç‰ˆï¼Œä¸ä½¿ç”¨ --help æµ‹è¯•
    if [ $config_tool_created -eq 1 ]; then
        log "ğŸ”§ åˆ›å»ºç»Ÿä¸€è°ƒç”¨æ¥å£..."
        
        # è®°å½•çœŸå®å·¥å…·è·¯å¾„
        echo "$real_config_tool" > scripts/.config_tool_path
        
        # åˆ›å»º scripts/config è½¯é“¾æ¥æˆ–å‰¯æœ¬ï¼Œä»¥ä¾¿ make defconfig èƒ½æ‰¾åˆ°
        if [ ! -f "scripts/config" ]; then
            if [ -f "scripts/config/config" ]; then
                ln -sf config scripts/config 2>/dev/null || cp scripts/config/config scripts/config 2>/dev/null || true
                log "âœ… åˆ›å»º scripts/config é“¾æ¥/å‰¯æœ¬"
            fi
        fi
        
        cat > scripts/config-tool << 'EOF'
#!/bin/sh
# ç»Ÿä¸€ config å·¥å…·è°ƒç”¨æ¥å£
CONFIG_TOOL_PATH="$(dirname "$0")/.config_tool_path"

if [ -f "$CONFIG_TOOL_PATH" ]; then
    CONFIG_TOOL="$(cat "$CONFIG_TOOL_PATH" 2>/dev/null)"
    if [ -n "$CONFIG_TOOL" ] && [ -f "$CONFIG_TOOL" ] && [ -x "$CONFIG_TOOL" ]; then
        exec "$CONFIG_TOOL" "$@"
    fi
fi

# å¤‡é€‰1: ç›´æ¥æŸ¥æ‰¾
if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
    echo "scripts/config/config" > "$CONFIG_TOOL_PATH"
    exec scripts/config/config "$@"
fi

# å¤‡é€‰2: ä½¿ç”¨ conf
if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
    echo "scripts/config/conf" > "$CONFIG_TOOL_PATH"
    exec scripts/config/conf "$@"
fi

# å¤‡é€‰3: ä½¿ç”¨ mconf
if [ -f "scripts/config/mconf" ] && [ -x "scripts/config/mconf" ]; then
    echo "scripts/config/mconf" > "$CONFIG_TOOL_PATH"
    exec scripts/config/mconf "$@"
fi

echo "Error: config tool not found" >&2
exit 1
EOF
        chmod +x scripts/config-tool
        log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£åˆ›å»ºæˆåŠŸ: scripts/config-tool"
        
        # ä¸å†æµ‹è¯• --helpï¼Œè€Œæ˜¯æµ‹è¯•åŸºæœ¬åŠŸèƒ½
        if scripts/config-tool --version > /dev/null 2>&1 || scripts/config-tool -h > /dev/null 2>&1; then
            log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£æµ‹è¯•é€šè¿‡"
        else
            # å°è¯•æµ‹è¯•æ˜¯å¦å­˜åœ¨
            if [ -f scripts/config/config ] || [ -f scripts/config/conf ]; then
                log "âœ… ç»Ÿä¸€è°ƒç”¨æ¥å£å¯ç”¨ï¼ˆè·³è¿‡å‚æ•°æµ‹è¯•ï¼‰"
            else
                log "âš ï¸ ç»Ÿä¸€è°ƒç”¨æ¥å£å¯èƒ½æœ‰é—®é¢˜ï¼Œä½†å·¥å…·å¯èƒ½ä»å¯ç”¨"
            fi
        fi
    fi
    
    # æœ€ç»ˆéªŒè¯
    if [ $config_tool_created -eq 1 ]; then
        log "âœ… é…ç½®å·¥å…·æœ€ç»ˆéªŒè¯é€šè¿‡"
        log "ğŸ“ çœŸå®å·¥å…·è·¯å¾„: $real_config_tool"
        log "ğŸ“ ç»Ÿä¸€è°ƒç”¨æ¥å£: scripts/config-tool"
        
        # æ˜¾ç¤ºå·¥å…·ä¿¡æ¯
        if [ -f "$real_config_tool" ]; then
            if file "$real_config_tool" | grep -q "ELF"; then
                log "ğŸ“‹ å·¥å…·ç±»å‹: å·²ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶"
            else
                log "ğŸ“‹ å·¥å…·ç±»å‹: Shell è„šæœ¬"
            fi
        fi
    else
        log "âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œé…ç½®å·¥å…·ä¸å­˜åœ¨"
        handle_error "æ— æ³•åˆ›å»ºé…ç½®å·¥å…·"
    fi
    
    save_env
    
    echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
    echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
    echo "TARGET=$TARGET" >> $GITHUB_ENV
    echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
    echo "DEVICE=$DEVICE" >> $GITHUB_ENV
    echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
    
    log "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}
#ã€build_firmware_main.sh-06-endã€‘
