#ã€build_firmware_main.sh-31ã€‘
workflow_step15_generate_config() {
    local extra_packages="$1"
    
    log "=== æ­¥éª¤15: æ™ºèƒ½é…ç½®ç”Ÿæˆã€ä¿®å¤ç‰ˆã€‘==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤15 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    # è°ƒç”¨å®Œå…¨é‡å†™çš„generate_configä¿®å¤ç‰ˆ
    generate_config_fixed "$extra_packages"
    
    if [ $? -ne 0 ]; then
        echo "âŒ é”™è¯¯: æ™ºèƒ½é…ç½®ç”Ÿæˆå¤±è´¥"
        exit 1
    fi
    
    log "âœ… æ­¥éª¤15 å®Œæˆ"
}
#ã€build_firmware_main.sh-31-endã€‘

#ã€build_firmware_main.sh-13-fixedã€‘
generate_config_fixed() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿã€å®Œæ•´ä¿®å¤ç‰ˆã€‘==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    # ğŸ”¥ å…³é”®ä¿®å¤1: å½»åº•åˆ é™¤æ—§é…ç½®
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # ğŸ”¥ å…³é”®ä¿®å¤2: å…ˆç”Ÿæˆç›®æ ‡å¹³å°é…ç½® - åªå†™æœ€åŸºæœ¬çš„ä¸‰è¡Œ
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    # ğŸ”¥ å…³é”®ä¿®å¤3: ç«‹å³è¿è¡Œdefconfigç”Ÿæˆå®Œæ•´ã€è¯­æ³•æ­£ç¡®çš„é…ç½®
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    # ğŸ”¥ å…³é”®ä¿®å¤4: å¤‡ä»½åŸºç¡€é…ç½®
    cp .config .config.base
    
    # ğŸ”¥ å…³é”®ä¿®å¤5: ä½¿ç”¨scripts/configå·¥å…·åˆå¹¶é…ç½®ï¼ˆæœ€å®‰å…¨çš„æ–¹å¼ï¼‰
    if [ -f "scripts/config" ]; then
        log "ğŸ”§ ä½¿ç”¨scripts/configå·¥å…·åˆå¹¶é…ç½®..."
        
        # åº”ç”¨usb-generic.config
        if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
            log "ğŸ“ åº”ç”¨USBé€šç”¨é…ç½®..."
            while IFS= read -r line || [ -n "$line" ]; do
                # å»é™¤ç©ºæ ¼å’Œç©ºè¡Œ
                line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
                [ -z "$line" ] && continue
                
                if [[ "$line" =~ ^CONFIG_([^=]+)=y$ ]]; then
                    ./scripts/config --enable "${BASH_REMATCH[1]}"
                elif [[ "$line" =~ ^CONFIG_([^=]+)=m$ ]]; then
                    ./scripts/config --module "${BASH_REMATCH[1]}"
                elif [[ "$line" =~ ^#\ CONFIG_([^\ ]+)\ is\ not\ set$ ]]; then
                    ./scripts/config --disable "${BASH_REMATCH[1]}"
                fi
            done < "$CONFIG_DIR/usb-generic.config"
        fi
        
        # åº”ç”¨base.config
        if [ -f "$CONFIG_DIR/base.config" ]; then
            log "ğŸ“ åº”ç”¨åŸºç¡€é…ç½®..."
            while IFS= read -r line || [ -n "$line" ]; do
                line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
                [ -z "$line" ] && continue
                
                if [[ "$line" =~ ^CONFIG_([^=]+)=y$ ]]; then
                    ./scripts/config --enable "${BASH_REMATCH[1]}"
                elif [[ "$line" =~ ^CONFIG_([^=]+)=m$ ]]; then
                    ./scripts/config --module "${BASH_REMATCH[1]}"
                elif [[ "$line" =~ ^#\ CONFIG_([^\ ]+)\ is\ not\ set$ ]]; then
                    ./scripts/config --disable "${BASH_REMATCH[1]}"
                fi
            done < "$CONFIG_DIR/base.config"
        fi
        
        # æ ¹æ®é…ç½®æ¨¡å¼åº”ç”¨é…ç½®
        if [ ! -f "$CONFIG_DIR/devices/$DEVICE.config" ]; then
            if [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
                log "ğŸ“ åº”ç”¨æ­£å¸¸æ¨¡å¼é…ç½®..."
                while IFS= read -r line || [ -n "$line" ]; do
                    line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
                    [ -z "$line" ] && continue
                    
                    # è·³è¿‡TurboACCé™æ€é…ç½®
                    if [[ "$line" =~ luci-app-turboacc|kmod-shortcut-fe|kmod-fast-classifier ]]; then
                        continue
                    fi
                    
                    if [[ "$line" =~ ^CONFIG_([^=]+)=y$ ]]; then
                        ./scripts/config --enable "${BASH_REMATCH[1]}"
                    elif [[ "$line" =~ ^CONFIG_([^=]+)=m$ ]]; then
                        ./scripts/config --module "${BASH_REMATCH[1]}"
                    elif [[ "$line" =~ ^#\ CONFIG_([^\ ]+)\ is\ not\ set$ ]]; then
                        ./scripts/config --disable "${BASH_REMATCH[1]}"
                    fi
                done < "$CONFIG_DIR/normal.config"
            fi
        else
            log "ğŸ“ åº”ç”¨è®¾å¤‡é…ç½®: $DEVICE.config..."
            while IFS= read -r line || [ -n "$line" ]; do
                line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
                [ -z "$line" ] && continue
                
                if [[ "$line" =~ ^CONFIG_([^=]+)=y$ ]]; then
                    ./scripts/config --enable "${BASH_REMATCH[1]}"
                elif [[ "$line" =~ ^CONFIG_([^=]+)=m$ ]]; then
                    ./scripts/config --module "${BASH_REMATCH[1]}"
                elif [[ "$line" =~ ^#\ CONFIG_([^\ ]+)\ is\ not\ set$ ]]; then
                    ./scripts/config --disable "${BASH_REMATCH[1]}"
                fi
            done < "$CONFIG_DIR/devices/$DEVICE.config"
        fi
        
        # åº”ç”¨å¹³å°ä¸“ç”¨é…ç½®
        local platform_config=""
        if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
            platform_config="$CONFIG_DIR/devices/$TARGET.config"
        else
            platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | head -1)
        fi
        
        if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
            log "ğŸ“ åº”ç”¨å¹³å°é…ç½®: $(basename "$platform_config")..."
            while IFS= read -r line || [ -n "$line" ]; do
                line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
                [ -z "$line" ] && continue
                
                if [[ "$line" =~ ^CONFIG_([^=]+)=y$ ]]; then
                    ./scripts/config --enable "${BASH_REMATCH[1]}"
                elif [[ "$line" =~ ^CONFIG_([^=]+)=m$ ]]; then
                    ./scripts/config --module "${BASH_REMATCH[1]}"
                elif [[ "$line" =~ ^#\ CONFIG_([^\ ]+)\ is\ not\ set$ ]]; then
                    ./scripts/config --disable "${BASH_REMATCH[1]}"
                fi
            done < "$platform_config"
        fi
        
        # æ·»åŠ é¢å¤–åŒ…
        if [ -n "$extra_packages" ]; then
            log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
            echo "$extra_packages" | tr ',' '\n' | while read pkg; do
                if [ -n "$pkg" ]; then
                    ./scripts/config --enable "PACKAGE_$pkg"
                    log "âœ… æ·»åŠ åŒ…: $pkg"
                fi
            done
        fi
        
        # å¼ºåˆ¶å¯ç”¨å…³é”®é…ç½®
        log "ğŸ”§ å¼ºåˆ¶å¯ç”¨å…³é”®é…ç½®..."
        ./scripts/config --enable PACKAGE_kmod-usb-xhci-hcd
        ./scripts/config --enable PACKAGE_kmod-usb3
        ./scripts/config --enable PACKAGE_kmod-tcp-bbr
        ./scripts/config --set-str DEFAULT_TCP_CONG "bbr"
        
        if [ "$CONFIG_MODE" = "normal" ]; then
            ./scripts/config --enable PACKAGE_luci-app-turboacc
            ./scripts/config --enable PACKAGE_kmod-shortcut-fe
            ./scripts/config --enable PACKAGE_kmod-fast-classifier
        fi
        
        # å¤„ç†ath10kå†²çª
        ./scripts/config --disable PACKAGE_kmod-ath10k
        ./scripts/config --disable PACKAGE_kmod-ath10k-pci
        ./scripts/config --disable PACKAGE_kmod-ath10k-smallbuffers
        ./scripts/config --disable PACKAGE_kmod-ath10k-ct-smallbuffers
        ./scripts/config --enable PACKAGE_kmod-ath10k-ct
        
    else
        log "âš ï¸ scripts/configä¸å­˜åœ¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ..."
        # å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥cpåŸºç¡€é…ç½®ï¼Œç„¶åechoè¿½åŠ 
        # ä½†è¿™ä¸æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œå…ˆé€€å‡º
        handle_error "scripts/configå·¥å…·ä¸å­˜åœ¨ï¼Œæ— æ³•å®‰å…¨åˆå¹¶é…ç½®"
    fi
    
    # ğŸ”¥ å…³é”®ä¿®å¤6: æœ€ç»ˆdefconfigç”Ÿæˆå®Œæ•´é…ç½®
    log "ğŸ”„ è¿è¡Œæœ€ç»ˆ make defconfig..."
    make defconfig || handle_error "æœ€ç»ˆé…ç½®åº”ç”¨å¤±è´¥"
    
    # ğŸ”¥ å…³é”®ä¿®å¤7: éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
    log "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•..."
    if grep -q "^[[:space:]]" .config; then
        log "âš ï¸ å‘ç°è¡Œé¦–ç©ºæ ¼ï¼Œæ­£åœ¨ä¿®å¤..."
        sed -i 's/^[[:space:]]*//' .config
    fi
    
    if ! make defconfig > /dev/null 2>&1; then
        handle_error "é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯"
    fi
    log "âœ… é…ç½®æ–‡ä»¶è¯­æ³•éªŒè¯é€šè¿‡"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
    log "æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "æœ€ç»ˆé…ç½®è¡Œæ•°: $(wc -l < .config)"
}
#ã€build_firmware_main.sh-13-fixed-endã€‘
