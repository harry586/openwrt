#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆå¼ºåˆ¶å¯ç”¨USBå†…æ ¸ä¾èµ–ï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # æ­¥éª¤1: åˆ›å»ºåŸºç¡€ç›®æ ‡é…ç½®
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    # æ­¥éª¤2: åˆå¹¶æ‰€æœ‰é…ç½®æ–‡ä»¶
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    # è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è¿½åŠ é…ç½®ï¼ˆè¿‡æ»¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
        fi
    }
    
    append_config "$CONFIG_DIR/base.config"
    append_config "$CONFIG_DIR/usb-generic.config"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    append_config "$CONFIG_DIR/devices/$DEVICE.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/normal.config"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # TCP BBR
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    # TurboACCï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰
    if [ "$CONFIG_MODE" = "normal" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # ath10k å†²çªè§£å†³
    sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
    echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
    echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
    
    # æ­¥éª¤3: å»é‡
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤4: è¿è¡Œ defconfig è§£å†³åŸºç¡€ä¾èµ–
    log "ğŸ”„ è¿è¡Œ make defconfig è§£å†³ä¾èµ–å…³ç³»..."
    make defconfig || handle_error "ä¾èµ–è§£å†³å¤±è´¥"
    
    # æ­¥éª¤5: åå¤„ç†å¼ºåˆ¶å¯ç”¨å…³é”®USBé©±åŠ¨ï¼ˆåŒ…æ‹¬å†…æ ¸ç¬¦å·ï¼‰
    log "ğŸ”§ åå¤„ç†ï¼šå¼ºåˆ¶å¯ç”¨USBå†…æ ¸ç¬¦å·..."
    
    # å®šä¹‰å®Œæ•´çš„å†…æ ¸USBç¬¦å·åˆ—è¡¨ï¼ˆæ ¹æ®å¸¸è§ä¾èµ–ï¼‰
    local KERNEL_USB_SYMS=(
        # åŸºç¡€ USB æ”¯æŒ
        "CONFIG_USB_SUPPORT=y"
        "CONFIG_USB_COMMON=y"
        "CONFIG_USB=y"
        "CONFIG_USB_ARCH_HAS_HCD=y"
        "CONFIG_USB_PCI=y"
        
        # XHCI ä¸»æœºæ§åˆ¶å™¨
        "CONFIG_USB_XHCI_HCD=y"
        "CONFIG_USB_XHCI_PCI=y"
        "CONFIG_USB_XHCI_PLATFORM=y"
        
        # DWC3 æ ¸å¿ƒ
        "CONFIG_USB_DWC3=y"
        "CONFIG_USB_DWC3_EP0=y"
        "CONFIG_USB_DWC3_GADGET=y"
        "CONFIG_USB_DWC3_DUAL_ROLE=y"
        "CONFIG_USB_DWC3_PCI=y"
        "CONFIG_USB_DWC3_OF_SIMPLE=y"
        
        # å…¶ä»–ä¸»æœºæ§åˆ¶å™¨ï¼ˆå¯é€‰ï¼Œä½†ç¡®ä¿USB2æ”¯æŒï¼‰
        "CONFIG_USB_EHCI_HCD=y"
        "CONFIG_USB_EHCI_PCI=y"
        "CONFIG_USB_OHCI_HCD=y"
        "CONFIG_USB_OHCI_PCI=y"
        
        # å­˜å‚¨æ”¯æŒ
        "CONFIG_USB_STORAGE=y"
    )
    
    # å¹³å°ç‰¹å®šå†…æ ¸ç¬¦å·
    case "$TARGET" in
        ipq40xx)
            KERNEL_USB_SYMS+=(
                "CONFIG_USB_DWC3_QCOM=y"
                "CONFIG_PHY_QCOM_DWC3=y"
                "CONFIG_PHY_QCOM_USB_HS=y"
            )
            ;;
        ramips)
            KERNEL_USB_SYMS+=(
                "CONFIG_USB_XHCI_MTK=y"
            )
            ;;
        mediatek)
            KERNEL_USB_SYMS+=(
                "CONFIG_USB_DWC3_MTK=y"
                "CONFIG_PHY_MTK_TPHY=y"
            )
            ;;
        ath79)
            KERNEL_USB_SYMS+=(
                "CONFIG_USB_EHCI_HCD=y"
                "CONFIG_USB_OHCI_HCD=y"
            )
            ;;
    esac
    
    # ä½¿ç”¨ scripts/config å·¥å…·ï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–ç›´æ¥å†™å…¥
    local CONFIG_TOOL=""
    if [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
        CONFIG_TOOL="scripts/config/conf"
    elif [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
        CONFIG_TOOL="scripts/config/config"
    fi
    
    if [ -n "$CONFIG_TOOL" ]; then
        for sym in "${KERNEL_USB_SYMS[@]}"; do
            # æå–ç¬¦å·åå’Œå€¼
            local name="${sym%%=*}"
            local value="${sym#*=}"
            if [ "$CONFIG_TOOL" = "scripts/config/conf" ]; then
                # conf ä½¿ç”¨ --defconfig å‚æ•°è®¾ç½®
                $CONFIG_TOOL --defconfig "$sym" .config 2>/dev/null || true
            else
                # config ä½¿ç”¨ --enable ç­‰ï¼Œä½†è¿™é‡Œç¬¦å·å¯èƒ½ä¸æ˜¯ PACKAGE_ å¼€å¤´ï¼Œæ‰€ä»¥ç”¨ç›´æ¥å†™å…¥æ›´ç®€å•
                sed -i "/^${name}=/d" .config
                echo "$sym" >> .config
            fi
        done
    else
        # ç›´æ¥å†™å…¥
        for sym in "${KERNEL_USB_SYMS[@]}"; do
            local name="${sym%%=*}"
            sed -i "/^${name}=/d" .config
            echo "$sym" >> .config
        done
    fi
    
    # åŒæ—¶å¼ºåˆ¶å¯ç”¨å¯¹åº”çš„è½¯ä»¶åŒ…ç¬¦å·ï¼ˆç¡®ä¿åŒ…è¢«é€‰ä¸­ï¼‰
    local PACKAGE_SYMS=(
        "CONFIG_PACKAGE_kmod-usb-core=y"
        "CONFIG_PACKAGE_kmod-usb-common=y"
        "CONFIG_PACKAGE_kmod-usb2=y"
        "CONFIG_PACKAGE_kmod-usb3=y"
        "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
        "CONFIG_PACKAGE_kmod-usb-storage=y"
        "CONFIG_PACKAGE_kmod-scsi-core=y"
        "CONFIG_PACKAGE_kmod-usb-dwc3=y"
        "CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y"
        "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y"
    )
    for sym in "${PACKAGE_SYMS[@]}"; do
        local name="${sym%%=*}"
        sed -i "/^${name}=/d" .config
        echo "$sym" >> .config
    done
    
    # æ­¥éª¤6: ä½¿ç”¨ olddefconfig æ›´æ–°é…ç½®ï¼ˆä¿ç•™æˆ‘ä»¬çš„è®¾ç½®ï¼Œè‡ªåŠ¨è¡¥å…¨ä¾èµ–ï¼‰
    log "ğŸ”„ è¿è¡Œ make olddefconfig åº”ç”¨å¼ºåˆ¶é…ç½®..."
    make olddefconfig || handle_error "å¼ºåˆ¶é…ç½®åº”ç”¨å¤±è´¥"
    
    # æ­¥éª¤7: æœ€ç»ˆéªŒè¯ï¼ˆåŒºåˆ†å¿…éœ€å’Œå¯é€‰ï¼‰
    log "ğŸ“‹ å¿…éœ€USBé©±åŠ¨çŠ¶æ€éªŒè¯:"
    local MUST_DRIVERS=(
        "kmod-usb-core"
        "kmod-usb2"
        "kmod-usb3"
        "kmod-usb-storage"
        "kmod-scsi-core"
    )
    local missing=()
    for driver in "${MUST_DRIVERS[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "  âœ… $driver: å·²å¯ç”¨"
        else
            log "  âŒ $driver: æœªå¯ç”¨"
            missing+=("$driver")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        log "âš ï¸ è­¦å‘Š: ä»¥ä¸‹å¿…éœ€é©±åŠ¨æœªå¯ç”¨: ${missing[*]}"
        log "ğŸ’¡ è¯·æ£€æŸ¥å†…æ ¸ä¾èµ–æˆ–å¹³å°æ”¯æŒ"
    else
        log "ğŸ‰ æ‰€æœ‰å¿…éœ€USBé©±åŠ¨å·²æˆåŠŸå¯ç”¨ï¼"
    fi
    
    log "ğŸ“‹ å¹³å°ç‰¹å®šé©±åŠ¨çŠ¶æ€éªŒè¯ï¼ˆå¯é€‰ï¼‰:"
    case "$TARGET" in
        ipq40xx)
            for driver in "kmod-usb-dwc3-qcom" "kmod-phy-qcom-dwc3" "kmod-usb-dwc3-of-simple"; do
                if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                    log "  âœ… $driver: å·²å¯ç”¨"
                else
                    log "  âš ï¸ $driver: æœªå¯ç”¨ï¼ˆå¦‚æœç¡¬ä»¶éœ€è¦ï¼Œè¯·æ£€æŸ¥æ”¯æŒï¼‰"
                fi
            done
            ;;
        ramips)
            for driver in "kmod-usb-xhci-mtk"; do
                if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                    log "  âœ… $driver: å·²å¯ç”¨"
                else
                    log "  âš ï¸ $driver: æœªå¯ç”¨ï¼ˆå¦‚æœç¡¬ä»¶éœ€è¦ï¼Œè¯·æ£€æŸ¥æ”¯æŒï¼‰"
                fi
            done
            ;;
    esac
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
