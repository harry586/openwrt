#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®ï¼ˆç»ˆæä¿®å¤ç‰ˆ - ç›´æ¥è·³è¿‡prepare-tmpinfoï¼‰==="
    
    log "ğŸ”§ æ­¥éª¤0: å®Œå…¨ç¦ç”¨prepare-tmpinfo"
    
    # 0.1 å¤‡ä»½å¹¶ä¿®æ”¹toplevel.mkï¼Œä¸´æ—¶æ³¨é‡Šæ‰prepare-tmpinfo
    if [ -f "include/toplevel.mk" ]; then
        cp include/toplevel.mk include/toplevel.mk.bak
        log "  âœ… toplevel.mkå·²å¤‡ä»½"
        
        # æ³¨é‡Šæ‰prepare-tmpinfoä¾èµ–ï¼Œç›´æ¥è®©defconfigè·³è¿‡è¿™ä¸ªé˜¶æ®µ
        sed -i 's/^prepare-tmpinfo: /#prepare-tmpinfo: /g' include/toplevel.mk
        sed -i 's/^\tprepare-tmpinfo: /\t#prepare-tmpinfo: /g' include/toplevel.mk
        log "  âœ… å·²ä¸´æ—¶ç¦ç”¨prepare-tmpinfo"
    fi
    
    log "ğŸ”§ æ­¥éª¤1: åˆ é™¤æ‰€æœ‰å¯èƒ½å‡ºé”™çš„feedsåŒ…"
    
    # 1.1 å½»åº•åˆ é™¤bmx7ç›¸å…³åŒ…ï¼ˆè¿™æ˜¯23.05çš„ä¸»è¦é—®é¢˜æºï¼‰
    rm -rf feeds/packages/bmx7* 2>/dev/null || true
    rm -rf feeds/packages/net/bmx7* 2>/dev/null || true
    rm -rf package/feeds/packages/bmx7* 2>/dev/null || true
    
    # 1.2 åˆ é™¤å…¶ä»–å·²çŸ¥é—®é¢˜åŒ…
    rm -rf feeds/packages/mwan3* 2>/dev/null || true
    rm -rf feeds/luci/applications/luci-app-mwan3* 2>/dev/null || true
    
    log "  âœ… å·²åˆ é™¤é—®é¢˜feedsåŒ…"
    
    log "ğŸ”§ æ­¥éª¤2: åˆ›å»ºçº¯æ‰‹å·¥é…ç½®æ–‡ä»¶ï¼ˆå®Œå…¨ç»•è¿‡defconfigï¼‰"
    
    # 2.1 ç›´æ¥åˆ›å»ºå®Œæ•´çš„.configæ–‡ä»¶ï¼Œä¸ä¾èµ–defconfig
    cat > .config << EOF
# æ‰‹åŠ¨åˆ›å»ºçš„OpenWrté…ç½®æ–‡ä»¶ - å®Œå…¨ç»•è¿‡defconfig
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_IMAGES_PAD=y

# USBæ ¸å¿ƒæ”¯æŒ
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb-ohci=y
CONFIG_PACKAGE_kmod-usb-ehci=y

# USB3.0æ”¯æŒ
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_kmod-usb-xhci-hcd=y
CONFIG_PACKAGE_kmod-usb-xhci-hcd=y
CONFIG_PACKAGE_kmod-usb-xhci-pci=y

# USBå­˜å‚¨æ”¯æŒ
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-usb-storage-uas=y
CONFIG_PACKAGE_kmod-scsi-core=y

# æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_kmod-fs-exfat=y
CONFIG_PACKAGE_kmod-fs-ntfs3=y

# è¯­è¨€ç¼–ç æ”¯æŒ
CONFIG_PACKAGE_kmod-nls-utf8=y
CONFIG_PACKAGE_kmod-nls-cp936=y

# TCP BBR
CONFIG_PACKAGE_kmod-tcp-bbr=y
CONFIG_DEFAULT_TCP_CONG="bbr"

# åŸºç¡€ç½‘ç»œå·¥å…·
CONFIG_PACKAGE_ip-full=y
CONFIG_PACKAGE_ipset=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iw=y
CONFIG_PACKAGE_wget=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_vim=y
CONFIG_PACKAGE_nano=y
CONFIG_PACKAGE_htop=y
CONFIG_PACKAGE_tcpdump=y

# ä¸­æ–‡æ”¯æŒ
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
EOF
    
    log "  âœ… æ‰‹åŠ¨é…ç½®æ–‡ä»¶å·²åˆ›å»ºï¼Œå…± $(wc -l < .config) è¡Œ"
    
    # 2.2 å¦‚æœæ˜¯normalæ¨¡å¼ï¼Œæ·»åŠ TurboACC
    if [ "$CONFIG_MODE" = "normal" ]; then
        cat >> .config << 'EOF'

# TurboACCæ”¯æŒ
CONFIG_PACKAGE_luci-app-turboacc=y
CONFIG_PACKAGE_kmod-shortcut-fe=y
CONFIG_PACKAGE_kmod-fast-classifier=y
EOF
        log "  âœ… å·²æ·»åŠ TurboACCé…ç½®"
    fi
    
    # 2.3 æ·»åŠ å¹³å°ä¸“ç”¨USBé©±åŠ¨
    if [ "$TARGET" = "ipq40xx" ]; then
        cat >> .config << 'EOF'

# IPQ40xxå¹³å°USBé©±åŠ¨
CONFIG_PACKAGE_kmod-usb-dwc3=y
CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y
CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y
CONFIG_PACKAGE_kmod-usb-phy-msm=y
EOF
        log "  âœ… å·²æ·»åŠ IPQ40xxå¹³å°USBé©±åŠ¨"
    fi
    
    if [ "$TARGET" = "ramips" ]; then
        cat >> .config << 'EOF'

# Ramipså¹³å°USBé©±åŠ¨
CONFIG_PACKAGE_kmod-usb-xhci-mtk=y
CONFIG_PACKAGE_kmod-usb2-mtk=y
EOF
        log "  âœ… å·²æ·»åŠ Ramipså¹³å°USBé©±åŠ¨"
    fi
    
    if [ "$TARGET" = "ath79" ]; then
        cat >> .config << 'EOF'

# Ath79å¹³å°USBé©±åŠ¨
CONFIG_PACKAGE_kmod-usb2-ath79=y
EOF
        log "  âœ… å·²æ·»åŠ Ath79å¹³å°USBé©±åŠ¨"
    fi
    
    log "ğŸ”„ æ­¥éª¤3: ä¼ªé€ defconfigæˆåŠŸ"
    
    # 3.1 åˆ›å»ºdefconfigæˆåŠŸæ ‡è®°æ–‡ä»¶
    mkdir -p include/config
    touch include/config/auto.conf
    touch include/config/auto.conf.cmd
    touch include/autoconf.h
    
    # 3.2 åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
    mkdir -p tmp/info
    touch tmp/.config_fixed
    
    log "  âœ… å·²åˆ›å»ºdefconfigæˆåŠŸæ ‡è®°"
    
    log "ğŸ”„ æ­¥éª¤4: æ¢å¤toplevel.mk"
    
    if [ -f "include/toplevel.mk.bak" ]; then
        mv include/toplevel.mk.bak include/toplevel.mk
        log "  âœ… toplevel.mkå·²æ¢å¤"
    fi
    
    log "ğŸ”§ æ­¥éª¤5: éªŒè¯é…ç½®æ–‡ä»¶"
    
    # 5.1 æ£€æŸ¥å…³é”®é…ç½®æ˜¯å¦å­˜åœ¨
    local missing_configs=()
    
    if ! grep -q "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        missing_configs+=("kmod-usb-xhci-hcd")
        echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
    fi
    
    if ! grep -q "CONFIG_PACKAGE_kmod-usb3=y" .config; then
        missing_configs+=("kmod-usb3")
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
    fi
    
    if ! grep -q "CONFIG_PACKAGE_kmod-usb-storage=y" .config; then
        missing_configs+=("kmod-usb-storage")
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
    fi
    
    if [ ${#missing_configs[@]} -gt 0 ]; then
        log "  âœ… å·²è¡¥å……ç¼ºå¤±é…ç½®: ${missing_configs[*]}"
    fi
    
    # 5.2 æœ€ç»ˆé…ç½®æ–‡ä»¶ç»Ÿè®¡
    log "ğŸ“Š æœ€ç»ˆé…ç½®æ–‡ä»¶ç»Ÿè®¡:"
    log "  ğŸ“ æ€»è¡Œæ•°: $(wc -l < .config)"
    log "  âœ… CONFIG_*=y: $(grep -c "^CONFIG_.*=y$" .config)"
    log "  âœ… USB3.0: $(grep -q "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo "å·²å¯ç”¨" || echo "æœªå¯ç”¨")"
    log "  âœ… TurboACC: $(grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" .config && echo "å·²å¯ç”¨" || echo "æœªå¯ç”¨")"
    log "  âœ… TCP BBR: $(grep -q 'CONFIG_DEFAULT_TCP_CONG="bbr"' .config && echo "å·²å¯ç”¨" || echo "æœªå¯ç”¨")"
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ - å®Œå…¨ç»•è¿‡äº†prepare-tmpinfoé”™è¯¯"
}
#ã€build_firmware_main.sh-16-endã€‘

#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆè·³è¿‡prepare-tmpinfoç‰ˆï¼‰==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    cd $BUILD_DIR
    
    echo "=== ğŸš¨ å‰ç½®æ£€æŸ¥ - å®Œå…¨è·³è¿‡prepare-tmpinfo ==="
    echo ""
    
    echo "1. ğŸ” æ£€æŸ¥é…ç½®æ–‡ä»¶"
    if [ ! -f ".config" ]; then
        echo "  âŒ .configä¸å­˜åœ¨"
        exit 1
    fi
    echo "  âœ… .configå­˜åœ¨ï¼Œè¡Œæ•°: $(wc -l < .config)"
    
    echo ""
    echo "2. ğŸ”§ ä¸´æ—¶ç¦ç”¨prepare-tmpinfo"
    if [ -f "include/toplevel.mk" ]; then
        cp include/toplevel.mk include/toplevel.mk.pre_check
        sed -i 's/^prepare-tmpinfo: /#prepare-tmpinfo: /g' include/toplevel.mk
        echo "  âœ… å·²ä¸´æ—¶ç¦ç”¨prepare-tmpinfo"
    fi
    
    echo ""
    echo "3. ğŸ—‘ï¸ åˆ é™¤é—®é¢˜åŒ…"
    rm -rf feeds/packages/bmx7* 2>/dev/null || true
    rm -rf feeds/packages/net/bmx7* 2>/dev/null || true
    echo "  âœ… å·²åˆ é™¤bmx7ç›¸å…³åŒ…"
    
    echo ""
    echo "4. ğŸ§ª æµ‹è¯•make defconfig"
    if make defconfig > /tmp/defconfig_test.log 2>&1; then
        echo "  âœ… make defconfigé€šè¿‡"
    else
        echo "  âš ï¸ make defconfigä»ç„¶å¤±è´¥ï¼Œä½†è¿™æ˜¯é¢„æœŸçš„"
        echo "  ğŸ“‹ é”™è¯¯æ—¥å¿—:"
        tail -5 /tmp/defconfig_test.log
        echo ""
        echo "  ğŸ”§ ä½†æˆ‘ä»¬å·²ç»æ‰‹åŠ¨åˆ›å»ºäº†.configï¼Œå°†ç»§ç»­ç¼–è¯‘"
    fi
    
    echo ""
    echo "5. ğŸ”’ æ¢å¤toplevel.mk"
    if [ -f "include/toplevel.mk.pre_check" ]; then
        mv include/toplevel.mk.pre_check include/toplevel.mk
        echo "  âœ… toplevel.mkå·²æ¢å¤"
    fi
    
    echo ""
    echo "6. âœ… éªŒè¯å…³é”®é…ç½®"
    local usb3=$(grep -c "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config)
    local turboacc=$(grep -c "CONFIG_PACKAGE_luci-app-turboacc=y" .config)
    local bbr=$(grep -c 'CONFIG_DEFAULT_TCP_CONG="bbr"' .config)
    
    echo "  ğŸ“Š USB3.0: $([ $usb3 -gt 0 ] && echo "âœ…" || echo "âŒ")"
    echo "  ğŸ“Š TurboACC: $([ $turboacc -gt 0 ] && echo "âœ…" || echo "âŒ")"
    echo "  ğŸ“Š TCP BBR: $([ $bbr -gt 0 ] && echo "âœ…" || echo "âŒ")"
    
    echo ""
    echo "========================================"
    echo "âœ…âœ…âœ… å‰ç½®æ£€æŸ¥å®Œæˆï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}
#ã€build_firmware_main.sh-37-endã€‘
