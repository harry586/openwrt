#ã€build_firmware_main.sh-31ã€‘
workflow_step15_generate_config() {
    local extra_packages="$1"
    
    log "=== æ­¥éª¤15: æ™ºèƒ½é…ç½®ç”Ÿæˆã€ä¿®å¤ç‰ˆã€‘ ==="
    log "å½“å‰è®¾å¤‡: $DEVICE"
    log "å½“å‰ç›®æ ‡: $TARGET"
    log "å½“å‰å­ç›®æ ‡: $SUBTARGET"
    
    set -e
    trap 'echo "âŒ æ­¥éª¤15 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    # ç¡®ä¿ç¯å¢ƒå˜é‡å·²åŠ è½½
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        log "âœ… ä»ç¯å¢ƒæ–‡ä»¶é‡æ–°åŠ è½½: DEVICE=$DEVICE, TARGET=$TARGET"
    fi
    
    # å¦‚æœDEVICEä¸ºç©ºï¼Œå°è¯•ä»å‚æ•°è·å–
    if [ -z "$DEVICE" ] && [ -n "$2" ]; then
        DEVICE="$2"
        log "âš ï¸ DEVICEä¸ºç©ºï¼Œä½¿ç”¨å‚æ•°: $DEVICE"
    fi
    
    # è®¾å¤‡åè½¬æ¢ - é’ˆå¯¹ac42u/acrh17çš„ç‰¹æ®Šå¤„ç†
    local device_for_config="$DEVICE"
    case "$DEVICE" in
        ac42u|rt-ac42u)
            device_for_config="asus_rt-ac42u"
            log "ğŸ”§ è®¾å¤‡åè½¬æ¢: $DEVICE -> $device_for_config"
            ;;
        acrh17|rt-acrh17)
            device_for_config="asus_rt-acrh17"
            log "ğŸ”§ è®¾å¤‡åè½¬æ¢: $DEVICE -> $device_for_config"
            ;;
        *)
            # é»˜è®¤è½¬æ¢ï¼šè½¬å°å†™ï¼Œæ¨ªçº¿å˜ä¸‹åˆ’çº¿
            device_for_config=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
            ;;
    esac
    
    cd "$BUILD_DIR" || handle_error "æ— æ³•è¿›å…¥æ„å»ºç›®å½•"
    
    # =========================================================================
    # è®¾å¤‡å®šä¹‰æ–‡ä»¶æŸ¥æ‰¾ï¼ˆé‡å†™ï¼Œä¸ä¾èµ–æœ‰é—®é¢˜çš„å‡½æ•°ï¼‰
    # =========================================================================
    log ""
    log "=== ğŸ” è®¾å¤‡å®šä¹‰æ–‡ä»¶éªŒè¯ï¼ˆå‰ç½®æ£€æŸ¥ï¼‰ ==="
    
    # ç¡®å®šæœç´¢å…³é”®è¯
    local search_device=""
    case "$DEVICE" in
        ac42u|rt-ac42u|asus_rt-ac42u)
            search_device="ac42u"
            ;;
        acrh17|rt-acrh17|asus_rt-acrh17)
            search_device="acrh17"
            ;;
        *)
            search_device="$DEVICE"
            ;;
    esac
    
    log "æœç´¢è®¾å¤‡å: $search_device"
    log "æœç´¢è·¯å¾„: target/linux/$TARGET"
    
    # ç›´æ¥ä½¿ç”¨ find + grep æŸ¥æ‰¾åŒ…å«è®¾å¤‡å®šä¹‰çš„ .mk æ–‡ä»¶
    local device_file
    device_file=$(find "target/linux/$TARGET" -type f -name "*.mk" \
                  -exec grep -l "define Device.*$search_device" {} \; 2>/dev/null | head -1)
    
    if [ -z "$device_file" ] || [ ! -f "$device_file" ]; then
        log "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°è®¾å¤‡ $DEVICE (æœç´¢å: $search_device) çš„å®šä¹‰æ–‡ä»¶"
        log "è¯·æ£€æŸ¥è®¾å¤‡åç§°æ˜¯å¦æ­£ç¡®ï¼Œæˆ– target/linux/$TARGET ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ .mk æ–‡ä»¶"
        exit 1
    fi
    
    log "âœ… æ‰¾åˆ°è®¾å¤‡å®šä¹‰æ–‡ä»¶: $device_file"
    
    # æå–è®¾å¤‡å®šä¹‰å—ï¼ˆä½¿ç”¨åŸæœ‰çš„ extract_device_config å‡½æ•°ï¼Œä½†å¢åŠ  fallbackï¼‰
    local device_block
    device_block=$(extract_device_config "$device_file" "$search_device" 2>/dev/null)
    
    if [ -z "$device_block" ]; then
        log "âš ï¸ è­¦å‘Šï¼šextract_device_config æœªèƒ½æå–é…ç½®å—ï¼Œå°è¯•æ‰‹åŠ¨æå–"
        # æ‰‹åŠ¨æå–ï¼šä»æ–‡ä»¶ä¸­æ‰¾åˆ°ä» "define Device/..." åˆ°ä¸‹ä¸€ä¸ªç©ºè¡Œæˆ– "endef" çš„å†…å®¹
        device_block=$(awk "/define Device.*$search_device/,/endef/ { print }" "$device_file" 2>/dev/null)
    fi
    
    if [ -n "$device_block" ]; then
        log "ğŸ“‹ è®¾å¤‡å®šä¹‰ä¿¡æ¯:"
        echo "$device_block" | while IFS= read -r line; do
            log "   $line"
        done
    else
        log "âš ï¸ è­¦å‘Šï¼šæ— æ³•æå–è®¾å¤‡ $search_device çš„é…ç½®å—"
    fi
    
    # ä»è®¾å¤‡å®šä¹‰ä¸­æå–å…³é”®å­—æ®µï¼ˆä½¿ç”¨åŸæœ‰å‡½æ•°ï¼Œå¦‚æœå¤±è´¥åˆ™æ‰‹åŠ¨ï¼‰
    local soc_define
    local model_define
    local title_define
    local kernel_define
    local packages_define
    
    soc_define=$(extract_config_value "$device_block" "SOC" 2>/dev/null)
    model_define=$(extract_config_value "$device_block" "DEVICE_MODEL" 2>/dev/null)
    title_define=$(extract_config_value "$device_block" "DEVICE_TITLE" 2>/dev/null)
    kernel_define=$(extract_config_value "$device_block" "KERNEL_PATCHVER" 2>/dev/null)
    packages_define=$(extract_config_value "$device_block" "DEVICE_PACKAGES" 2>/dev/null)
    
    log "âœ… è®¾å¤‡å®šä¹‰æ–‡ä»¶éªŒè¯é€šè¿‡ï¼Œç»§ç»­ç”Ÿæˆé…ç½®"
    
    # =========================================================================
    # è°ƒç”¨æ ¸å¿ƒé…ç½®ç”Ÿæˆå‡½æ•°
    # =========================================================================
    generate_config "$extra_packages" "$device_for_config"
    
    # =========================================================================
    # ä¸ support.sh ä¿¡æ¯å¯¹æ¯”ï¼ˆä»…ç”¨äºå±•ç¤ºï¼Œä¸é€€å‡ºï¼‰
    # =========================================================================
    log ""
    log "ğŸ“Š ä¸ support.sh ä¿¡æ¯å¯¹æ¯”:"
    
    local support_info
    support_info=$("$SUPPORT_SCRIPT" get-platform "$DEVICE" 2>/dev/null)
    if [ -n "$support_info" ]; then
        local support_target
        local support_subtarget
        support_target=$(echo "$support_info" | awk '{print $1}')
        support_subtarget=$(echo "$support_info" | awk '{print $2}')
        
        log "  æ¥æº          | ç›®æ ‡å¹³å°       | å­ç›®æ ‡         | SOC/å‹å·       | å†…æ ¸ç‰ˆæœ¬"
        log "  --------------|----------------|----------------|----------------|----------------"
        
        # support.sh è¡Œ
        printf "  support.sh    | %-14s | %-14s | %-14s | %s\n" \
               "$support_target" "$support_subtarget" \
               "${soc_define:-N/A}" "${kernel_define:-N/A}"
        
        # å®šä¹‰æ–‡ä»¶è¡Œ
        printf "  å®šä¹‰æ–‡ä»¶      | %-14s | %-14s | %-14s | %s\n" \
               "$TARGET" "$SUBTARGET" \
               "${soc_define:-N/A}" "${kernel_define:-N/A}"
        
        # æ£€æŸ¥ä¸€è‡´æ€§
        if [ "$support_target" = "$TARGET" ] && [ "$support_subtarget" = "$SUBTARGET" ]; then
            log "  âœ… ç›®æ ‡/å­ç›®æ ‡ä¸ support.sh ä¸€è‡´"
        else
            log "  âš ï¸ è­¦å‘Šï¼šç›®æ ‡/å­ç›®æ ‡ä¸ support.sh ä¸ä¸€è‡´"
            log "     support.sh: $support_target/$support_subtarget"
            log "     å½“å‰é…ç½®:   $TARGET/$SUBTARGET"
        fi
    else
        log "  âš ï¸ æ— æ³•ä» support.sh è·å–ä¿¡æ¯ï¼Œè·³è¿‡å¯¹æ¯”"
    fi
    
    # æ˜¾ç¤ºè®¾å¤‡è¯¦ç»†ä¿¡æ¯
    log ""
    log "ğŸ“± è®¾å¤‡è¯¦ç»†ä¿¡æ¯:"
    [ -n "$soc_define" ] && log "  SOC: $soc_define"
    [ -n "$model_define" ] && log "  å‹å·: $model_define"
    [ -n "$title_define" ] && log "  æ ‡é¢˜: $title_define"
    [ -n "$kernel_define" ] && log "  å†…æ ¸ç‰ˆæœ¬: $kernel_define"
    [ -n "$packages_define" ] && log "  é»˜è®¤åŒ…: $packages_define"
    
    # =========================================================================
    # å¼ºåˆ¶ç¦ç”¨æŒ‡å®šæ’ä»¶ç³»åˆ—
    # =========================================================================
    log ""
    log "=== ğŸ”§ å¼ºåˆ¶ç¦ç”¨ä¸éœ€è¦çš„æ’ä»¶ç³»åˆ— ==="
    
    local forbidden_plugins=(
        "luci-app-vssr"
        "luci-app-ssr-plus"
        "luci-app-rclone"
        "luci-app-passwall"
    )
    
    # å¤‡ä»½å½“å‰é…ç½®
    cp .config .config.before_disable
    
    # åˆ é™¤æ‰€æœ‰ç›¸å…³é…ç½®è¡Œï¼ˆåŒ…æ‹¬ä¸»åŒ…å’Œå­é€‰é¡¹ï¼‰
    for plugin in "${forbidden_plugins[@]}"; do
        log "  å¤„ç†æ’ä»¶: $plugin"
        
        # åˆ é™¤ä¸»åŒ…å¯ç”¨è¡Œ
        sed -i "/^CONFIG_PACKAGE_${plugin}=y/d" .config
        sed -i "/^CONFIG_PACKAGE_${plugin}=m/d" .config
        
        # åˆ é™¤æ‰€æœ‰å­é€‰é¡¹ï¼ˆä»¥æ’ä»¶åå¼€å¤´çš„é…ç½®ï¼‰
        sed -i "/^CONFIG_PACKAGE_${plugin}_/d" .config
        
        # æ·»åŠ ç¦ç”¨æ ‡è®°
        echo "# CONFIG_PACKAGE_${plugin} is not set" >> .config
        
        log "    âœ… å·²ç¦ç”¨ $plugin åŠå…¶å­é€‰é¡¹"
    done
    
    # é¢å¤–æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ ¼å¼
    sed -i '/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_/d' .config
    sed -i '/CONFIG_PACKAGE_luci-app-vssr_INCLUDE_/d' .config
    sed -i '/CONFIG_PACKAGE_luci-app-rclone_INCLUDE_/d' .config
    sed -i '/CONFIG_PACKAGE_luci-app-passwall_INCLUDE_/d' .config
    
    # å»é‡
    sort -u .config > .config.tmp && mv .config.tmp .config
    
    log "ğŸ”„ é‡æ–°è¿è¡Œ make defconfig ä½¿ç¦ç”¨ç”Ÿæ•ˆ..."
    make defconfig > /tmp/build-logs/defconfig_disable.log 2>&1 || {
        log "âš ï¸ make defconfig è­¦å‘Šï¼Œä½†ç»§ç»­"
    }
    
    # éªŒè¯ç¦ç”¨ç»“æœ
    local still_enabled=0
    for plugin in "${forbidden_plugins[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${plugin}=y" .config; then
            log "  âŒ $plugin ä»ç„¶è¢«å¯ç”¨"
            still_enabled=$((still_enabled + 1))
        elif grep -q "^CONFIG_PACKAGE_${plugin}=m" .config; then
            log "  âŒ $plugin ä»ç„¶è¢«æ¨¡å—åŒ–"
            still_enabled=$((still_enabled + 1))
        else
            log "  âœ… $plugin å·²æ­£ç¡®ç¦ç”¨"
        fi
    done
    
    if [ $still_enabled -eq 0 ]; then
        log "ğŸ‰ æ‰€æœ‰æŒ‡å®šæ’ä»¶å·²æˆåŠŸç¦ç”¨"
    else
        log "âš ï¸ æœ‰ $still_enabled ä¸ªæ’ä»¶æœªèƒ½ç¦ç”¨ï¼Œè¯·æ£€æŸ¥ feeds æˆ–ä¾èµ–"
    fi
    
    # æœ€ç»ˆé…ç½®ç»Ÿè®¡
    log ""
    log "ğŸ“Š é…ç½®ç»Ÿè®¡ï¼ˆç¦ç”¨åï¼‰:"
    log "  æ€»é…ç½®è¡Œæ•°: $(wc -l < .config)"
    log "  å¯ç”¨è½¯ä»¶åŒ…: $(grep -c "^CONFIG_PACKAGE_.*=y$" .config)"
    log "  æ¨¡å—åŒ–è½¯ä»¶åŒ…: $(grep -c "^CONFIG_PACKAGE_.*=m$" .config)"
    
    log "âœ… æ­¥éª¤15 å®Œæˆ"
}
#ã€build_firmware_main.sh-31-endã€‘
