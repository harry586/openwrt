#!/bin/bash
set -e

# ==============================
# ã€ç³»ç»Ÿåˆå§‹åŒ–ã€‘æ–‡ä»¶å¤´å’Œå…¨å±€å®šä¹‰
# ==============================
# æ³¨æ„ï¼šä¿®å¤Windowsæ¢è¡Œç¬¦é—®é¢˜
# é”™è¯¯ï¼šline 24: syntax error near unexpected token $'{\r''
# åŸå› ï¼šæ–‡ä»¶åŒ…å«Windowsé£æ ¼çš„CRLFæ¢è¡Œç¬¦

# ä¸´æ—¶ä¿®å¤ï¼šåœ¨ç¬¬24è¡Œå‰æ·»åŠ ä¿®å¤ä»£ç 
# ä½¿ç”¨trå‘½ä»¤æ¸…é™¤æ‰€æœ‰\rå­—ç¬¦
cat > /tmp/clean_file.sh << 'EOF'
#!/bin/bash
# æ¸…é™¤Windowsæ¢è¡Œç¬¦
if [ -f "$1" ]; then
    echo "æ­£åœ¨æ¸…é™¤æ–‡ä»¶ $1 ä¸­çš„Windowsæ¢è¡Œç¬¦..."
    cp "$1" "$1.bak"
    tr -d '\r' < "$1.bak" > "$1"
    echo "âœ… æ¸…é™¤å®Œæˆ"
else
    echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $1"
fi
EOF

chmod +x /tmp/clean_file.sh
/tmp/clean_file.sh "$0"

# é‡æ–°è®¾ç½®é”™è¯¯å¤„ç†
set -e

#ã€build_firmware_main.sh-01ã€‘æ–‡ä»¶å¤´ï¼šå˜é‡å®šä¹‰å’Œæ—¥å¿—å‡½æ•°
BUILD_DIR="/mnt/openwrt-build"
ENV_FILE="$BUILD_DIR/build_env.sh"
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
# ä¿®å¤ï¼šSUPPORT_DIR åº”è¯¥æŒ‡å‘ firmware-config ç›®å½•æœ¬èº«
SUPPORT_DIR="$REPO_ROOT/firmware-config"

# ç¡®ä¿æœ‰æ—¥å¿—ç›®å½•
mkdir -p /tmp/build-logs

log() {
    echo "ã€$(date '+%Y-%m-%d %H:%M:%S')ã€‘$1"
}

#ã€build_firmware_main.sh-02ã€‘é”™è¯¯å¤„ç†å‡½æ•°
handle_error() {
    log "âŒ é”™è¯¯å‘ç”Ÿåœ¨: $1"
    log "è¯¦ç»†é”™è¯¯ä¿¡æ¯:"
    echo "æœ€å100è¡Œæ„å»ºæ—¥å¿—:"
    tail -100 /tmp/build-logs/*.log 2>/dev/null || echo "æ— æ—¥å¿—æ–‡ä»¶"
    
    # æ£€æŸ¥defconfigæ—¥å¿—
    if [ -f "/tmp/defconfig.log" ]; then
        echo "defconfig é”™è¯¯æ—¥å¿—:"
        cat "/tmp/defconfig.log"
    fi
    
    # æ£€æŸ¥.configæ–‡ä»¶
    if [ -f ".config" ]; then
        echo ".config æœ€å50è¡Œ:"
        tail -50 .config
    fi
    
    exit 1
}

#ã€build_firmware_main.sh-03ã€‘æ™ºèƒ½æ–‡ä»¶æœç´¢å‡½æ•°
# å‚è€ƒfirmware-build-fix.ymlçš„æœç´¢é€»è¾‘

smart_file_search() {
    local filename="$1"
    local found_file=""
    
    log "ğŸ” å¼€å§‹æ™ºèƒ½æœç´¢æ–‡ä»¶: $filename"
    
    # 1. é¦–å…ˆåœ¨å¸¸è§ä½ç½®æŸ¥æ‰¾
    local common_paths=(
        "firmware-config/scripts/$filename"
        "scripts/$filename"
        "$filename"
        "./$filename"
        "../$filename"
    )
    
    for path in "${common_paths[@]}"; do
        if [ -f "$path" ]; then
            found_file="$path"
            log "âœ… åœ¨å¸¸è§ä½ç½®æ‰¾åˆ°: $found_file"
            break
        fi
    done
    
    # 2. å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨findå‘½ä»¤å…¨ç›®å½•æœç´¢
    if [ -z "$found_file" ]; then
        log "ğŸ” å¼€å§‹å…¨ç›®å½•æœç´¢ $filename..."
        found_file=$(find . -name "$filename" -type f ! -path "./.git/*" | head -1)
        
        if [ -n "$found_file" ]; then
            log "âœ… åœ¨å…¨ç›®å½•æœç´¢ä¸­æ‰¾åˆ°: $found_file"
        else
            log "âŒ é”™è¯¯: æœªæ‰¾åˆ° $filename æ–‡ä»¶"
            log "è¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨äºä»¥ä¸‹ä½ç½®ä¹‹ä¸€:"
            log "- firmware-config/scripts/$filename"
            log "- scripts/$filename"
            log "- $filename"
            log "å½“å‰ç›®å½•: $(pwd)"
            log "ç›®å½•å†…å®¹:"
            ls -la
            return 1
        fi
    fi
    
    echo "$found_file"
    return 0
}

#ã€build_firmware_main.sh-04ã€‘ä¿®å¤è„šæœ¬æ¢è¡Œç¬¦é—®é¢˜
# è¿™ä¸ªå‡½æ•°åº”è¯¥åœ¨è„šæœ¬å¼€å¤´è°ƒç”¨

fix_line_endings() {
    local script_file="${BASH_SOURCE[0]}"
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰Windowsæ¢è¡Œç¬¦
    if file "$script_file" | grep -q "CRLF"; then
        log "âš ï¸ æ£€æµ‹åˆ°Windowsæ¢è¡Œç¬¦ï¼Œæ­£åœ¨ä¿®å¤..."
        
        # å¤‡ä»½åŸæ–‡ä»¶
        local backup_file="${script_file}.bak"
        cp "$script_file" "$backup_file"
        
        # ä½¿ç”¨sedæ¸…é™¤\rå­—ç¬¦
        sed -i 's/\r$//' "$script_file"
        
        # éªŒè¯ä¿®å¤
        if file "$script_file" | grep -q "CRLF"; then
            log "âŒ ä¿®å¤å¤±è´¥ï¼Œæ¢å¤å¤‡ä»½"
            cp "$backup_file" "$script_file"
        else
            log "âœ… æ¢è¡Œç¬¦ä¿®å¤å®Œæˆ"
            rm -f "$backup_file"
        fi
    fi
}

# åœ¨è„šæœ¬å¼€å¤´è°ƒç”¨ä¿®å¤å‡½æ•°
fix_line_endings

#!/bin/bash
# ==============================
# ã€ç´§æ€¥ä¿®å¤ã€‘Windowsæ¢è¡Œç¬¦é—®é¢˜
# ==============================
# ä¿®å¤é”™è¯¯ï¼šsyntax error near unexpected token $'{\r''

# æ–¹æ³•1ï¼šç«‹å³æ¸…é™¤\rå­—ç¬¦
if [ -n "$BASH_SOURCE" ]; then
    # è¯»å–è„šæœ¬å†…å®¹ï¼Œè¿‡æ»¤æ‰\r
    SCRIPT_CONTENT=$(cat "${BASH_SOURCE[0]}" | tr -d '\r')
    # é‡æ–°æ‰§è¡Œè„šæœ¬
    eval "$SCRIPT_CONTENT"
    exit $?
fi

# å¦‚æœä¸Šé¢çš„æ–¹æ³•å¤±è´¥ï¼Œç»§ç»­æ­£å¸¸æ‰§è¡Œ
set -e

# æ–¹æ³•2ï¼šæ£€æŸ¥å¹¶ä¿®å¤å‡½æ•°å®šä¹‰
check_syntax() {
    # æ£€æŸ¥ç¬¬24è¡Œé™„è¿‘çš„é—®é¢˜
    local line_num=24
    local problem_line=$(sed -n "${line_num}p" "${BASH_SOURCE[0]}" 2>/dev/null)
    
    if echo "$problem_line" | grep -q $'\r'; then
        log "ğŸ”§ ä¿®å¤ç¬¬${line_num}è¡Œçš„æ¢è¡Œç¬¦é—®é¢˜"
        # ä¿®å¤è¿™ä¸€è¡Œ
        sed -i "${line_num}s/\r$//" "${BASH_SOURCE[0]}"
    fi
}

# æ‰§è¡Œè¯­æ³•æ£€æŸ¥
check_syntax

