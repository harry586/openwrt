#„Äêbuild_firmware_main.sh-13„Äë
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "ËøõÂÖ•ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
    
    log "=== Êô∫ËÉΩÈÖçÁΩÆÁîüÊàêÁ≥ªÁªüÔºàÊúÄÁªàÁ®≥ÂÆöÁâàÔºâ==="
    log "ÁâàÊú¨: $SELECTED_BRANCH"
    log "ÁõÆÊ†á: $TARGET"
    log "Â≠êÁõÆÊ†á: $SUBTARGET"
    log "ËÆæÂ§á: $DEVICE"
    log "ÈÖçÁΩÆÊ®°Âºè: $CONFIG_MODE"
    log "ÈÖçÁΩÆÊñá‰ª∂ÁõÆÂΩï: $CONFIG_DIR"
    
    rm -f .config .config.old .config.bak*
    log "‚úÖ Â∑≤Ê∏ÖÁêÜÊóßÈÖçÁΩÆÊñá‰ª∂"
    
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "üîß ÁîüÊàêÂü∫Á°ÄÈÖçÁΩÆ..."
    make defconfig || handle_error "Âü∫Á°ÄÈÖçÁΩÆÁîüÊàêÂ§±Ë¥•"
    log "‚úÖ Âü∫Á°ÄÈÖçÁΩÆÁîüÊàêÊàêÂäü"
    
    mkdir -p scripts/config
    cat > scripts/config/config << 'EOF'
#!/bin/sh
# Áõ¥Êé•ÂÜôÂÖ•.configÁöÑÁÆÄÊòìconfigÂ∑•ÂÖ∑
CONFIG_FILE=".config"

case "$1" in
    --enable)
        shift
        sed -i "/^# CONFIG_$1 is not set/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=/d" "$CONFIG_FILE"
        echo "CONFIG_$1=y" >> "$CONFIG_FILE"
        ;;
    --disable)
        shift
        sed -i "/^CONFIG_$1=y/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=m/d" "$CONFIG_FILE"
        echo "# CONFIG_$1 is not set" >> "$CONFIG_FILE"
        ;;
    --module)
        shift
        sed -i "/^# CONFIG_$1 is not set/d" "$CONFIG_FILE"
        sed -i "/^CONFIG_$1=y/d" "$CONFIG_FILE"
        echo "CONFIG_$1=m" >> "$CONFIG_FILE"
        ;;
    --set-str)
        shift
        name="$1"
        value="$2"
        sed -i "/^CONFIG_$name=/d" "$CONFIG_FILE"
        echo "CONFIG_$name=\"$value\"" >> "$CONFIG_FILE"
        shift 2
        ;;
esac
EOF
    chmod +x scripts/config/config
    ln -sf config scripts/config/config-link
    
    local CONFIG_CMD="./scripts/config/config"
    log "‚úÖ ‰ΩøÁî®ÁÆÄÊòìconfigÂ∑•ÂÖ∑"
    
    log "üîß ‰ΩøÁî®ÈÖçÁΩÆÂ∑•ÂÖ∑ÂêàÂπ∂ÈÖçÁΩÆ..."
    
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "üìÅ Â∫îÁî®USBÈÄöÁî®ÈÖçÁΩÆ..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/usb-generic.config"
        log "‚úÖ USBÈÄöÁî®ÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "üìÅ Â∫îÁî®Âü∫Á°ÄÈÖçÁΩÆ..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/base.config"
        log "‚úÖ Âü∫Á°ÄÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "üìÅ Â∫îÁî®ËÆæÂ§áÈÖçÁΩÆ: $DEVICE.config..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$device_config_file"
        log "‚úÖ ËÆæÂ§áÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "üìÅ Â∫îÁî®Ê≠£Â∏∏Ê®°ÂºèÈÖçÁΩÆ..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "luci-app-turboacc\|kmod-shortcut-fe\|kmod-fast-classifier"; then
                continue
            fi
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$CONFIG_DIR/normal.config"
        log "‚úÖ Ê≠£Â∏∏Ê®°ÂºèÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "üìÅ Â∫îÁî®Âπ≥Âè∞ÈÖçÁΩÆ: $(basename "$platform_config")..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                $CONFIG_CMD --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                $CONFIG_CMD --disable "$config_name"
            fi
        done < "$platform_config"
        log "‚úÖ Âπ≥Âè∞ÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
    fi
    
    if [ -n "$extra_packages" ]; then
        log "üì¶ Ê∑ªÂä†È¢ùÂ§ñÂåÖ: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            if [ -n "$pkg" ]; then
                $CONFIG_CMD --enable "PACKAGE_$pkg"
                log "‚úÖ Ê∑ªÂä†ÂåÖ: $pkg"
            fi
        done
    fi
    
    log "üîß Âº∫Âà∂ÂêØÁî®ÊâÄÊúâÂÖ≥ÈîÆÈÖçÁΩÆ..."
    
    $CONFIG_CMD --enable PACKAGE_kmod-usb-core
    $CONFIG_CMD --enable PACKAGE_kmod-usb2
    $CONFIG_CMD --enable PACKAGE_kmod-usb3
    $CONFIG_CMD --enable PACKAGE_kmod-usb-xhci-hcd
    $CONFIG_CMD --enable PACKAGE_kmod-usb-storage
    $CONFIG_CMD --enable PACKAGE_kmod-scsi-core
    
    if [ "$TARGET" = "ipq40xx" ]; then
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3
        $CONFIG_CMD --enable PACKAGE_kmod-usb-dwc3-qcom
        $CONFIG_CMD --enable PACKAGE_kmod-phy-qcom-dwc3
        log "‚úÖ IPQ40xxÂπ≥Âè∞‰∏ìÁî®È©±Âä®Âº∫Âà∂ÂêØÁî®ÂÆåÊàê"
    fi
    
    $CONFIG_CMD --enable PACKAGE_kmod-tcp-bbr
    $CONFIG_CMD --set-str DEFAULT_TCP_CONG "bbr"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        $CONFIG_CMD --enable PACKAGE_luci-app-turboacc
        $CONFIG_CMD --enable PACKAGE_kmod-shortcut-fe
        $CONFIG_CMD --enable PACKAGE_kmod-fast-classifier
        log "‚úÖ TurboACCÈÖçÁΩÆÂº∫Âà∂ÂêØÁî®ÂÆåÊàê"
    fi
    
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-pci
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-smallbuffers
    $CONFIG_CMD --disable PACKAGE_kmod-ath10k-ct-smallbuffers
    $CONFIG_CMD --enable PACKAGE_kmod-ath10k-ct
    log "‚úÖ ath10kÂÜ≤Á™Å‰øÆÂ§çÂÆåÊàê"
    
    log "üîÑ ËøêË°åÊúÄÁªà make defconfig..."
    make defconfig || handle_error "ÊúÄÁªàÈÖçÁΩÆÂ∫îÁî®Â§±Ë¥•"
    
    log "üìã ÂÖ≥ÈîÆÈÖçÁΩÆÁä∂ÊÄÅ:"
    log "  - kmod-usb2: $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo '‚úÖ Â∑≤ÂêØÁî®' || echo '‚ùå Êú™ÂêØÁî®')"
    log "  - kmod-usb3: $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo '‚úÖ Â∑≤ÂêØÁî®' || echo '‚ùå Êú™ÂêØÁî®')"
    log "  - kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo '‚úÖ Â∑≤ÂêØÁî®' || echo '‚ùå Êú™ÂêØÁî®')"
    
    if [ "$TARGET" = "ipq40xx" ]; then
        log "  - kmod-usb-dwc3-qcom: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo '‚úÖ Â∑≤ÂêØÁî®' || echo '‚ùå Êú™ÂêØÁî®')"
        log "  - kmod-phy-qcom-dwc3: $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo '‚úÖ Â∑≤ÂêØÁî®' || echo '‚ùå Êú™ÂêØÁî®')"
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  - luci-app-turboacc: $(grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config && echo '‚úÖ Â∑≤ÂêØÁî®' || echo '‚ùå Êú™ÂêØÁî®')"
    fi
    
    log "  - kmod-tcp-bbr: $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config && echo '‚úÖ Â∑≤ÂêØÁî®' || echo '‚ùå Êú™ÂêØÁî®')"
    
    log "üìä ÈÖçÁΩÆÁîüÊàêÁªüËÆ°:"
    log "  - ÊúÄÁªàÈÖçÁΩÆÊñá‰ª∂: .config"
    log "  - ÈÖçÁΩÆË°åÊï∞: $(wc -l < .config)"
    log "  - ÈÖçÁΩÆÊñá‰ª∂Â§ßÂ∞è: $(ls -lh .config | awk '{print $5}')"
    
    log "‚úÖ ÈÖçÁΩÆÁîüÊàêÂÆåÊàê"
}
#„Äêbuild_firmware_main.sh-13-end„Äë
