#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    local device_override=$2
    
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    if [ -n "$device_override" ]; then
        DEVICE="$device_override"
        log "ğŸ”§ ä½¿ç”¨è®¾å¤‡è¦†ç›–å‚æ•°: $DEVICE"
    fi
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆåŠ¨æ€æ˜ å°„ç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    if [ -z "$DEVICE" ]; then
        log "âŒ é”™è¯¯: DEVICEå˜é‡ä¸ºç©ºï¼"
        env | grep -E "DEVICE|TARGET|SELECTED" || true
        handle_error "DEVICEå˜é‡æœªè®¾ç½®"
    fi
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # åŠ¨æ€è·å–è®¾å¤‡å¹³å°ä¿¡æ¯
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” ä»support.shè·å–è®¾å¤‡å¹³å°ä¿¡æ¯..."
        local platform_info=$("$SUPPORT_SCRIPT" get-platform "$DEVICE" 2>/dev/null)
        if [ -n "$platform_info" ]; then
            TARGET=$(echo "$platform_info" | awk '{print $1}')
            SUBTARGET=$(echo "$platform_info" | awk '{print $2}')
            log "âœ… ä»support.shè·å–å¹³å°ä¿¡æ¯: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
            save_env
        else
            log "âŒ support.shæ— æ³•è·å–è®¾å¤‡ä¿¡æ¯"
            handle_error "è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥"
        fi
    else
        log "âŒ support.shä¸å­˜åœ¨"
        handle_error "support.shè„šæœ¬ç¼ºå¤±"
    fi
    
    local device_lower="$DEVICE"
    local device_config="CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}"
    
    log "ğŸ”§ è®¾å¤‡é…ç½®å˜é‡: $device_config=y"
    
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_MULTI_PROFILE=y
${device_config}=y
EOF
    
    log "ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶å†…å®¹:"
    cat .config
    
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
            log "âœ… åŠ è½½é…ç½®: $(basename "$file")"
        fi
    }
    
    # é€’å½’æœç´¢é…ç½®æ–‡ä»¶
    find_config_file() {
        local pattern=$1
        local search_dir=$2
        find "$search_dir" -type f -name "$pattern" 2>/dev/null | head -1
    }
    
    # é€’å½’æœç´¢åŒ…å«å…³é”®å­—çš„é…ç½®æ–‡ä»¶
    find_config_file_by_content() {
        local keyword=$1
        local search_dir=$2
        find "$search_dir" -type f -name "*.config" -exec grep -l "$keyword" {} \; 2>/dev/null | head -1
    }
    
    # åŸºç¡€é…ç½®
    append_config "$CONFIG_DIR/base.config"
    append_config "$CONFIG_DIR/usb-generic.config"
    
    # ç›®æ ‡å¹³å°é…ç½® - é€’å½’æœç´¢æ‰€æœ‰å­ç›®å½•
    local target_config=$(find_config_file "*${TARGET}*.config" "$CONFIG_DIR")
    if [ -n "$target_config" ]; then
        log "ğŸ” æ‰¾åˆ°ç›®æ ‡å¹³å°é…ç½®: $(basename "$target_config")"
        append_config "$target_config"
    else
        # å°è¯•æŒ‰å†…å®¹æœç´¢
        target_config=$(find_config_file_by_content "TARGET_${TARGET}" "$CONFIG_DIR")
        if [ -n "$target_config" ]; then
            log "ğŸ” é€šè¿‡å†…å®¹æ‰¾åˆ°ç›®æ ‡å¹³å°é…ç½®: $(basename "$target_config")"
            append_config "$target_config"
        else
            log "âš ï¸ æœªæ‰¾åˆ°ç›®æ ‡å¹³å°é…ç½®æ–‡ä»¶: $TARGET.config"
        fi
    fi
    
    # å­ç›®æ ‡å¹³å°é…ç½® - é€’å½’æœç´¢æ‰€æœ‰å­ç›®å½•
    if [ -n "$SUBTARGET" ]; then
        local subtarget_config=$(find_config_file "*${SUBTARGET}*.config" "$CONFIG_DIR")
        if [ -n "$subtarget_config" ]; then
            log "ğŸ” æ‰¾åˆ°å­ç›®æ ‡å¹³å°é…ç½®: $(basename "$subtarget_config")"
            append_config "$subtarget_config"
        else
            # å°è¯•æŒ‰å†…å®¹æœç´¢
            subtarget_config=$(find_config_file_by_content "TARGET_${TARGET}_${SUBTARGET}" "$CONFIG_DIR")
            if [ -n "$subtarget_config" ]; then
                log "ğŸ” é€šè¿‡å†…å®¹æ‰¾åˆ°å­ç›®æ ‡å¹³å°é…ç½®: $(basename "$subtarget_config")"
                append_config "$subtarget_config"
            fi
        fi
    fi
    
    # ç‰ˆæœ¬é…ç½® - é€’å½’æœç´¢æ‰€æœ‰å­ç›®å½•
    local branch_short="${SELECTED_BRANCH#openwrt-}"
    local version_config=$(find_config_file "*${branch_short}*.config" "$CONFIG_DIR")
    if [ -n "$version_config" ]; then
        log "ğŸ” æ‰¾åˆ°ç‰ˆæœ¬é…ç½®: $(basename "$version_config")"
        append_config "$version_config"
    else
        log "âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬é…ç½®æ–‡ä»¶: $SELECTED_BRANCH.config"
    fi
    
    # è®¾å¤‡é…ç½® - é€’å½’æœç´¢æ‰€æœ‰å­ç›®å½•
    local device_config_file=$(find_config_file "*${DEVICE}*.config" "$CONFIG_DIR")
    if [ -n "$device_config_file" ]; then
        log "ğŸ” æ‰¾åˆ°è®¾å¤‡é…ç½®: $(basename "$device_config_file")"
        append_config "$device_config_file"
    else
        # å°è¯•åœ¨deviceså­ç›®å½•ä¸­æœç´¢
        device_config_file=$(find_config_file "*${DEVICE}*.config" "$CONFIG_DIR/devices")
        if [ -n "$device_config_file" ]; then
            log "ğŸ” åœ¨devicesç›®å½•æ‰¾åˆ°è®¾å¤‡é…ç½®: $(basename "$device_config_file")"
            append_config "$device_config_file"
        else
            log "âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡é…ç½®æ–‡ä»¶: $DEVICE.config"
        fi
    fi
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/normal.config"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # TCP BBR
    if [ "${ENABLE_TCP_BBR:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        log "âœ… TCP BBRå·²å¯ç”¨"
    fi
    
    # TurboACC
    if [ "$CONFIG_MODE" = "normal" ] && [ "${ENABLE_TURBOACC:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        log "âœ… TurboACCå·²å¯ç”¨"
    fi
    
    # ath10k-ct
    if [ "${FORCE_ATH10K_CT:-true}" = "true" ]; then
        sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        log "âœ… ath10k-cté©±åŠ¨å·²å¼ºåˆ¶å¯ç”¨"
    fi
    
    # ç¬¬ä¸€æ¬¡å»é‡
    log "ğŸ”„ ç¬¬ä¸€æ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # åŠ¨æ€å†…æ ¸é…ç½®æ£€æµ‹ - ä¼˜å…ˆæŒ‰å­ç›®æ ‡ç›®å½•æœç´¢
    log "ğŸ” åŠ¨æ€è·å–ç›®æ ‡å¹³å°æ”¯æŒçš„å†…æ ¸é…ç½®..."
    
    local kernel_config_file=""
    local kernel_version=""
    
    # ä¼˜å…ˆæœç´¢å­ç›®æ ‡å¯¹åº”çš„å†…æ ¸é…ç½®
    if [ -d "target/linux/$TARGET" ]; then
        if [ -n "$SUBTARGET" ]; then
            # å…ˆæœç´¢å­ç›®æ ‡ç›®å½•
            kernel_config_file=$(find "target/linux/$TARGET/$SUBTARGET" -maxdepth 1 -type f -name "config-*" 2>/dev/null | head -1)
        fi
        
        # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæœç´¢ä¸»ç›®å½•
        if [ -z "$kernel_config_file" ]; then
            kernel_config_file=$(find "target/linux/$TARGET" -maxdepth 2 -type f -name "config-*" 2>/dev/null | head -1)
        fi
        
        if [ -n "$kernel_config_file" ]; then
            kernel_version=$(basename "$kernel_config_file" | sed 's/config-//')
            log "âœ… æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"
        fi
    fi
    
    if [ -n "$kernel_config_file" ] && [ -f "$kernel_config_file" ]; then
        # æå–USBç›¸å…³é…ç½®
        local usb_configs_file="/tmp/usb_configs_$$.txt"
        grep -E "^(CONFIG_USB|CONFIG_PHY|CONFIG_DWC|CONFIG_XHCI|CONFIG_MMC|CONFIG_SCSI)" "$kernel_config_file" > "$usb_configs_file" 2>/dev/null || true
        
        if [ -s "$usb_configs_file" ]; then
            sort -u "$usb_configs_file" > "$usb_configs_file.sorted"
            local config_count=$(wc -l < "$usb_configs_file.sorted")
            log "æ‰¾åˆ° $config_count ä¸ªUSB/å­˜å‚¨ç›¸å…³å†…æ ¸é…ç½®"
            
            local added_count=0
            while read line; do
                local config_name=$(echo "$line" | sed 's/^# //g' | cut -d'=' -f1 | cut -d' ' -f1)
                if ! grep -q "^${config_name}=" .config && ! grep -q "^# ${config_name} is not set" .config; then
                    if echo "$line" | grep -q "=y$"; then
                        echo "$line" >> .config
                        added_count=$((added_count + 1))
                    elif echo "$line" | grep -q "is not set"; then
                        echo "$line" >> .config
                        added_count=$((added_count + 1))
                    fi
                fi
            done < "$usb_configs_file.sorted"
            
            log "âœ… æ·»åŠ äº† $added_count ä¸ªæ–°çš„å†…æ ¸é…ç½®"
            rm -f "$usb_configs_file" "$usb_configs_file.sorted"
        fi
    else
        log "âš ï¸ æœªæ‰¾åˆ°ç›®æ ‡å¹³å° $TARGET çš„å†…æ ¸é…ç½®æ–‡ä»¶"
    fi
    
    # ç¬¬ä¸€æ¬¡make defconfig
    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfig..."
    if make defconfig > /tmp/build-logs/defconfig1.log 2>&1; then
        log "âœ… ç¬¬ä¸€æ¬¡ make defconfig æˆåŠŸ"
    else
        log "âŒ ç¬¬ä¸€æ¬¡ make defconfig å¤±è´¥"
        tail -50 /tmp/build-logs/defconfig1.log
        handle_error "ç¬¬ä¸€æ¬¡ä¾èµ–è§£å†³å¤±è´¥"
    fi
    
    # æ£€æŸ¥å­ç›®æ ‡æ˜¯å¦æ­£ç¡®
    if ! grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" .config; then
        log "âš ï¸ å­ç›®æ ‡ $SUBTARGET æœªå¯ç”¨ï¼Œå¼ºåˆ¶å¯ç”¨..."
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1
    fi
    
    # ç¬¬äºŒæ¬¡å»é‡
    log "ğŸ”„ ç¬¬äºŒæ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # ç¬¬äºŒæ¬¡make defconfig - è¿™æ¬¡å¼ºåˆ¶ä¿ç•™è®¾å¤‡é…ç½®
    log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfigï¼ˆå¼ºåˆ¶ä¿ç•™è®¾å¤‡é…ç½®ï¼‰..."
    
    # å…ˆåˆ é™¤å¯èƒ½å†²çªçš„é…ç½®
    sed -i "/^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_/d" .config
    sed -i "/^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_/d" .config
    
    # é‡æ–°æ·»åŠ ç›®æ ‡è®¾å¤‡
    echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # è¿è¡Œdefconfig
    make defconfig > /tmp/build-logs/defconfig2.log 2>&1 || true
    
    # æœ€ç»ˆè®¾å¤‡éªŒè¯
    log "ğŸ” æ­£åœ¨éªŒè¯è®¾å¤‡ $device_lower æ˜¯å¦è¢«é€‰ä¸­..."
    
    log "ğŸ“‹ å½“å‰.configä¸­çš„è®¾å¤‡é…ç½®:"
    grep "CONFIG_TARGET_.*DEVICE" .config | head -20 || log "  æœªæ‰¾åˆ°ä»»ä½•è®¾å¤‡é…ç½®"
    
    if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
        log "âœ… ç›®æ ‡è®¾å¤‡å·²æ­£ç¡®å¯ç”¨"
    else
        # æœ€åä¸€æ¬¡å°è¯•å¼ºåˆ¶å¯ç”¨
        log "âš ï¸ è®¾å¤‡æœªå¯ç”¨ï¼Œæœ€åä¸€æ¬¡å°è¯•å¼ºåˆ¶å¯ç”¨..."
        
        # å¤‡ä»½å½“å‰é…ç½®
        cp .config .config.bak
        
        # æ¸…ç†æ‰€æœ‰è®¾å¤‡é…ç½®
        sed -i "/^CONFIG_TARGET_.*DEVICE/d" .config
        sed -i "/^# CONFIG_TARGET_.*DEVICE/d" .config
        
        # åªæ·»åŠ ç›®æ ‡è®¾å¤‡
        echo "CONFIG_TARGET_${TARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        echo "CONFIG_TARGET_MULTI_PROFILE=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        
        # è¿è¡Œdefconfig
        make defconfig > /tmp/build-logs/defconfig3.log 2>&1 || true
        
        if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
            log "âœ… è®¾å¤‡å·²å¼ºåˆ¶å¯ç”¨"
        else
            log "âŒ è®¾å¤‡å¯ç”¨å¤±è´¥"
            log "æœŸæœ›çš„è®¾å¤‡é…ç½®: CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y"
            log "è¯·æ£€æŸ¥:"
            log "  1. support.shæ˜¯å¦æ­£ç¡®è¿”å›å¹³å°ä¿¡æ¯: $TARGET/$SUBTARGET"
            log "  2. è®¾å¤‡åæ˜¯å¦æ­£ç¡®: $DEVICE"
            log "  3. å†…æ ¸æ˜¯å¦æ”¯æŒè¯¥å­ç›®æ ‡: $SUBTARGET"
            
            # æ‰‹åŠ¨æŸ¥è¯¢å¯ç”¨è®¾å¤‡å’Œå†…æ ¸
            log "ğŸ“‹ å¯ç”¨å­ç›®æ ‡åˆ—è¡¨:"
            if [ -d "target/linux/$TARGET" ]; then
                ls -la "target/linux/$TARGET/" | grep -E "config-|image|filogic" | head -10
            fi
            
            log "ğŸ“‹ å¯ç”¨è®¾å¤‡åˆ—è¡¨:"
            grep -r "define Device" "target/linux/$TARGET/image" 2>/dev/null | head -10 || true
            grep -r "DEVICE_${device_lower}" "target/linux/$TARGET" 2>/dev/null | head -5 || true
            
            handle_error "è®¾å¤‡å¯ç”¨å¤±è´¥"
        fi
    fi
    
    # é…ç½®ç»Ÿè®¡
    local total_configs=$(wc -l < .config)
    local enabled_packages=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config)
    local module_packages=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config)
    local disabled_packages=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config)
    
    log "ğŸ“Š é…ç½®ç»Ÿè®¡:"
    log "  æ€»é…ç½®è¡Œæ•°: $total_configs"
    log "  å¯ç”¨è½¯ä»¶åŒ…: $enabled_packages"
    log "  æ¨¡å—åŒ–è½¯ä»¶åŒ…: $module_packages"
    log "  ç¦ç”¨è½¯ä»¶åŒ…: $disabled_packages"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
