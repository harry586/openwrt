#ã€build_firmware_main.sh-13ã€‘æ„å»ºç¯å¢ƒåˆå§‹åŒ–å‡½æ•° - ä¿®å¤LEDEåˆ†æ”¯é—®é¢˜
initialize_build_env() {
    local device_name=$1
    local version_selection=$2
    local config_mode=$3
    local source_repo=${4:-"immortalwrt"}  # æ·»åŠ ç¬¬å››ä¸ªå‚æ•°ï¼Œé»˜è®¤immortalwrt
    
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ç‰ˆæœ¬é€‰æ‹© ==="
    log "æºä»£ç ä»“åº“: $source_repo"
    
    # æ ¹æ®ä»“åº“é€‰æ‹©ä¸åŒçš„URL - åªä¿ç•™immortalwrtå’Œlede
    case "$source_repo" in
        "immortalwrt")
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            ;;
        "lede")
            SELECTED_REPO_URL="https://github.com/coolsnowwolf/lede.git"
            SELECTED_BRANCH="master"  # LEDEä½¿ç”¨masteråˆ†æ”¯
            ;;
        *)
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            source_repo="immortalwrt"
            ;;
    esac
    
    # æ ¹æ®ç‰ˆæœ¬é€‰æ‹©åˆ†æ”¯ï¼ˆLEDEé™¤å¤–ï¼‰- ä¿®å¤åˆ†æ”¯é€‰æ‹©é€»è¾‘
    if [ "$source_repo" = "lede" ]; then
        # LEDEä»“åº“åªä½¿ç”¨masteråˆ†æ”¯
        SELECTED_BRANCH="master"
        log "ğŸ”§ LEDEä»“åº“ä½¿ç”¨masteråˆ†æ”¯"
    else
        # ImmortalWrtä»“åº“æ ¹æ®ç‰ˆæœ¬é€‰æ‹©åˆ†æ”¯
        if [ "$version_selection" = "23.05" ]; then
            SELECTED_BRANCH="openwrt-23.05"
        else
            SELECTED_BRANCH="openwrt-21.02"
        fi
    fi
    
    # è®¾ç½®SOURCE_REPOç¯å¢ƒå˜é‡
    SOURCE_REPO="$source_repo"
    
    log "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH (ä»“åº“: $source_repo)"
    
    log "=== å…‹éš†æºç  ==="
    log "ä»“åº“: $SELECTED_REPO_URL"
    log "åˆ†æ”¯: $SELECTED_BRANCH"
    
    sudo rm -rf ./* ./.git* 2>/dev/null || true
    
    git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . || handle_error "å…‹éš†æºç å¤±è´¥"
    log "âœ… æºç å…‹éš†å®Œæˆ"
    
    # æ£€æŸ¥å…‹éš†çš„æ–‡ä»¶
    local important_source_files=("Makefile" "feeds.conf.default" "rules.mk" "Config.in")
    for file in "${important_source_files[@]}"; do
        if [ -f "$file" ]; then
            log "âœ… æºç æ–‡ä»¶å­˜åœ¨: $file"
        else
            log "âŒ æºç æ–‡ä»¶ç¼ºå¤±: $file"
        fi
    done
    
    log "=== è®¾å¤‡é…ç½® ==="
    DEVICE_NAME="$device_name"
    
    # åŠ è½½è®¾å¤‡æ”¯æŒè„šæœ¬
    if load_device_support; then
        local device_config=$(get_device_config "$device_name")
        TARGET=$(echo $device_config | awk '{print $1}')
        SUBTARGET=$(echo $device_config | awk '{print $2}')
        DEVICE=$(echo $device_config | awk '{print $3}')
        PLATFORM=$(echo $device_config | awk '{print $4}')
        
        local device_desc=$(get_device_description "$device_name")
        log "ğŸ”§ è®¾å¤‡: $device_desc"
        log "ç›®æ ‡: $TARGET"
        log "å­ç›®æ ‡: $SUBTARGET"
        log "è®¾å¤‡: $DEVICE"
        log "å¹³å°: $PLATFORM"
        
        # ç‰¹æ®Šå¤„ç†ï¼šå¯¹äºLEDEä»“åº“ï¼Œéœ€è¦ç¡®ä¿è®¾å¤‡åç§°æ­£ç¡®
        if [ "$SOURCE_REPO" = "lede" ]; then
            log "ğŸ”§ LEDEä»“åº“è®¾å¤‡åç§°è°ƒæ•´"
            # æ£€æŸ¥è®¾å¤‡æ˜¯å¦ä»¥"generic_"å¼€å¤´ï¼Œå¦‚æœæ˜¯åˆ™å»æ‰å‰ç¼€
            if [[ "$DEVICE" == generic_* ]]; then
                DEVICE="${DEVICE#generic_}"
                log "ğŸ“ è°ƒæ•´è®¾å¤‡åç§°: $DEVICE"
            fi
        fi
    else
        # é»˜è®¤é…ç½®ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰- ä¿®å¤è®¾å¤‡åç§°æ˜ å°„
        case "$device_name" in
            "ac42u"|"acrh17")
                TARGET="ipq40xx"
                SUBTARGET="generic"
                if [ "$SOURCE_REPO" = "lede" ]; then
                    DEVICE="asus_rt-acrh17"  # LEDEä¸­ä½¿ç”¨acrh17
                else
                    DEVICE="asus_rt-ac42u"   # ImmortalWrtä¸­ä½¿ç”¨ac42u
                fi
                PLATFORM="ipq40xx"
                ;;
            "mi_router_4a_gigabit"|"r4ag")
                TARGET="ramips"
                SUBTARGET="mt76x8"
                DEVICE="xiaomi_mi-router-4a-gigabit"
                PLATFORM="ramips"
                ;;
            "mi_router_3g"|"r3g")
                TARGET="ramips"
                SUBTARGET="mt7621"
                DEVICE="xiaomi_mi-router-3g"
                PLATFORM="ramips"
                ;;
            "netgear_3800")
                TARGET="ath79"
                SUBTARGET="generic"
                if [ "$SOURCE_REPO" = "lede" ]; then
                    DEVICE="netgear_wndr3800"  # LEDEä¸­çš„è®¾å¤‡åç§°
                else
                    DEVICE="netgear_wndr3800"  # ImmortalWrtä¸­çš„è®¾å¤‡åç§°
                fi
                PLATFORM="ath79"
                ;;
            *)
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="$device_name"
                PLATFORM="generic"
                ;;
        esac
        log "ğŸ”§ æ£€æµ‹åˆ°è®¾å¤‡: $device_name"
        log "ç›®æ ‡: $TARGET"
        log "å­ç›®æ ‡: $SUBTARGET"
        log "è®¾å¤‡: $DEVICE"
        log "å¹³å°: $PLATFORM"
    fi
    
    CONFIG_MODE="$config_mode"
    
    save_env
    
    echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
    echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
    echo "TARGET=$TARGET" >> $GITHUB_ENV
    echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
    echo "DEVICE=$DEVICE" >> $GITHUB_ENV
    echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
    echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
    echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
    echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
    
    log "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}

#ã€build_firmware_main.sh-14ã€‘ç¼–è¯‘å™¨ç¯å¢ƒåˆå§‹åŒ–å‡½æ•° - ä¿®å¤LEDE SDKä¸‹è½½é—®é¢˜
initialize_compiler_env() {
    local device_name="$1"
    log "=== åˆå§‹åŒ–ç¼–è¯‘å™¨ç¯å¢ƒï¼ˆä¸‹è½½OpenWrtå®˜æ–¹SDKï¼‰- ä¿®å¤ç‰ˆ ==="
    
    # é¦–å…ˆåŠ è½½ç¯å¢ƒå˜é‡ - ä¿®å¤æ£€æŸ¥é€»è¾‘
    log "ğŸ” æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        log "âœ… ä» $BUILD_DIR/build_env.sh åŠ è½½ç¯å¢ƒå˜é‡"
        
        # æ˜¾ç¤ºå…³é”®ç¯å¢ƒå˜é‡
        log "ğŸ“‹ å½“å‰ç¯å¢ƒå˜é‡:"
        log "  SELECTED_BRANCH: $SELECTED_BRANCH"
        log "  TARGET: $TARGET"
        log "  SUBTARGET: $SUBTARGET"
        log "  DEVICE: $DEVICE"
        log "  CONFIG_MODE: $CONFIG_MODE"
        log "  REPO_ROOT: $REPO_ROOT"
        log "  COMPILER_DIR: $COMPILER_DIR"
        log "  DEVICE_NAME: $DEVICE_NAME"
        log "  PLATFORM: $PLATFORM"
        log "  SOURCE_REPO: $SOURCE_REPO"
    else
        log "âš ï¸ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨: $BUILD_DIR/build_env.sh"
        log "ğŸ’¡ ç¯å¢ƒæ–‡ä»¶åº”è¯¥åœ¨æ­¥éª¤6.3ä¸­åˆ›å»ºï¼Œä½†æœªæ‰¾åˆ°"
        
        # è®¾ç½®é»˜è®¤å€¼
        if [ -z "$SELECTED_BRANCH" ]; then
            SELECTED_BRANCH="openwrt-21.02"
            log "âš ï¸ SELECTED_BRANCHæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $SELECTED_BRANCH"
        fi
        
        if [ -z "$SOURCE_REPO" ]; then
            SOURCE_REPO="immortalwrt"
            log "âš ï¸ SOURCE_REPOæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $SOURCE_REPO"
        fi
        
        if [ -z "$TARGET" ]; then
            # ä½¿ç”¨è®¾å¤‡æ”¯æŒè„šæœ¬è·å–é…ç½®
            if load_device_support; then
                local device_config=$(get_device_config "$device_name")
                TARGET=$(echo $device_config | awk '{print $1}')
                SUBTARGET=$(echo $device_config | awk '{print $2}')
                DEVICE=$(echo $device_config | awk '{print $3}')
                PLATFORM=$(echo $device_config | awk '{print $4}')
                log "âš ï¸ å¹³å°å˜é‡æœªè®¾ç½®ï¼Œä»è®¾å¤‡æ”¯æŒè„šæœ¬è·å–: TARGET=$TARGET, SUBTARGET=$SUBTARGET, DEVICE=$DEVICE, PLATFORM=$PLATFORM"
            else
                # é»˜è®¤é…ç½®
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="$device_name"
                PLATFORM="generic"
                log "âš ï¸ å¹³å°å˜é‡æœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: TARGET=$TARGET, SUBTARGET=$SUBTARGET, DEVICE=$DEVICE"
            fi
        fi
        
        if [ -z "$CONFIG_MODE" ]; then
            CONFIG_MODE="normal"
            log "âš ï¸ CONFIG_MODEæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $CONFIG_MODE"
        fi
        
        if [ -z "$DEVICE_NAME" ]; then
            DEVICE_NAME="$device_name"
            log "âš ï¸ DEVICE_NAMEæœªè®¾ç½®ï¼Œä½¿ç”¨: $DEVICE_NAME"
        fi
        
        if [ -z "$PLATFORM" ]; then
            PLATFORM="generic"
            log "âš ï¸ PLATFORMæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $PLATFORM"
        fi
        
        # ä¿å­˜åˆ°ç¯å¢ƒæ–‡ä»¶
        save_env
        log "âœ… å·²åˆ›å»ºç¯å¢ƒæ–‡ä»¶: $BUILD_DIR/build_env.sh"
    fi
    
    # æ£€æŸ¥ç¯å¢ƒå˜é‡ä¸­çš„COMPILER_DIR
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        log "âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
        
        # éªŒè¯ç¼–è¯‘å™¨ç›®å½•æ˜¯å¦çœŸçš„åŒ…å«GCC
        log "ğŸ” éªŒè¯ç¼–è¯‘å™¨ç›®å½•æœ‰æ•ˆæ€§..."
        local gcc_files=$(find "$COMPILER_DIR" -type f -executable \
          -name "*gcc" \
          ! -name "*gcc-ar" \
          ! -name "*gcc-ranlib" \
          ! -name "*gcc-nm" \
          ! -path "*dummy-tools*" \
          ! -path "*scripts*" \
          2>/dev/null | head -3)
        
        if [ -n "$gcc_files" ]; then
            log "âœ… ç¡®è®¤ç¼–è¯‘å™¨ç›®å½•åŒ…å«çœŸæ­£çš„GCC"
            local first_gcc=$(echo "$gcc_files" | head -1)
            log "  ğŸ¯ GCCæ–‡ä»¶: $(basename "$first_gcc")"
            log "  ğŸ”§ GCCç‰ˆæœ¬: $("$first_gcc" --version 2>&1 | head -1)"
            
            # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
            save_env
            
            # éªŒè¯ç¼–è¯‘å™¨
            verify_compiler_files
            return 0
        else
            log "âš ï¸ ç¼–è¯‘å™¨ç›®å½•å­˜åœ¨ä½†ä¸åŒ…å«çœŸæ­£çš„GCCï¼Œå°†é‡æ–°ä¸‹è½½SDK"
        fi
    else
        log "ğŸ” COMPILER_DIRæœªè®¾ç½®æˆ–ç›®å½•ä¸å­˜åœ¨ï¼Œå°†ä¸‹è½½OpenWrtå®˜æ–¹SDK"
    fi
    
    # æ ¹æ®è®¾å¤‡ç¡®å®šå¹³å°ï¼ˆä½¿ç”¨å·²è®¾ç½®çš„å˜é‡ï¼‰
    log "ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    log "ç›®æ ‡è®¾å¤‡: $DEVICE"
    log "OpenWrtç‰ˆæœ¬: $SELECTED_BRANCH"
    log "å¹³å°ç±»å‹: $PLATFORM"
    log "æºä»£ç ä»“åº“: $SOURCE_REPO"
    
    # ä¿®å¤ï¼šå¯¹äºLEDEä»“åº“çš„masteråˆ†æ”¯ï¼Œä¸éœ€è¦ä¸‹è½½SDK
    if [ "$SOURCE_REPO" = "lede" ] && [ "$SELECTED_BRANCH" = "master" ]; then
        log "ğŸ”§ LEDE masteråˆ†æ”¯ä½¿ç”¨å†…ç½®å·¥å…·é“¾ï¼Œæ— éœ€ä¸‹è½½OpenWrt SDK"
        log "ğŸ’¡ LEDEä¼šä½¿ç”¨è‡ªå·±çš„å·¥å…·é“¾è¿›è¡Œç¼–è¯‘"
        export COMPILER_DIR=""
        save_env
        return 0
    fi
    
    # ç®€åŒ–ç‰ˆæœ¬å­—ç¬¦ä¸²ï¼ˆä»openwrt-23.05è½¬ä¸º23.05ï¼‰
    local version_for_sdk=""
    if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
        version_for_sdk="23.05"
    elif [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
        version_for_sdk="21.02"
    elif [ "$SELECTED_BRANCH" = "master" ]; then
        # LEDEçš„masteråˆ†æ”¯ä½¿ç”¨21.02 SDK
        version_for_sdk="21.02"
    else
        # å°è¯•æå–ç‰ˆæœ¬å·
        version_for_sdk=$(echo "$SELECTED_BRANCH" | grep -o "[0-9][0-9]\.[0-9][0-9]" || echo "21.02")
        log "âš ï¸ æ— æ³•è¯†åˆ«çš„ç‰ˆæœ¬åˆ†æ”¯ï¼Œå°è¯•ä½¿ç”¨: $version_for_sdk"
    fi
    
    log "ğŸ“Œ SDKç‰ˆæœ¬: $version_for_sdk"
    log "ğŸ“Œ ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    
    # è¯¦ç»†æ˜¾ç¤ºSDKä¸‹è½½ä¿¡æ¯
    log "ğŸ” SDKä¸‹è½½è¯¦ç»†ä¿¡æ¯:"
    log "  è®¾å¤‡: $device_name"
    log "  OpenWrtç‰ˆæœ¬: $SELECTED_BRANCH"
    log "  SDKç‰ˆæœ¬: $version_for_sdk"
    log "  ç›®æ ‡: $TARGET"
    log "  å­ç›®æ ‡: $SUBTARGET"
    log "  å¹³å°: $PLATFORM"
    log "  æºä»£ç ä»“åº“: $SOURCE_REPO"
    
    # ä¸‹è½½OpenWrtå®˜æ–¹SDK
    log "ğŸš€ å¼€å§‹ä¸‹è½½OpenWrtå®˜æ–¹SDK..."
    if download_openwrt_sdk "$TARGET" "$SUBTARGET" "$version_for_sdk"; then
        log "ğŸ‰ OpenWrt SDKä¸‹è½½å¹¶è®¾ç½®æˆåŠŸ"
        log "ğŸ“Œ ç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
        
        # æ˜¾ç¤ºSDKç›®å½•ä¿¡æ¯
        if [ -d "$COMPILER_DIR" ]; then
            log "ğŸ“Š SDKç›®å½•ä¿¡æ¯:"
            log "  ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            log "  æ–‡ä»¶æ•°é‡: $(find "$COMPILER_DIR" -type f 2>/dev/null | wc -l)"
            
            # æŸ¥æ‰¾GCCç¼–è¯‘å™¨ï¼Œæ’é™¤è™šå‡ç¼–è¯‘å™¨
            local gcc_file=$(find "$COMPILER_DIR" -type f -executable \
              -name "*gcc" \
              ! -name "*gcc-ar" \
              ! -name "*gcc-ranlib" \
              ! -name "*gcc-nm" \
              ! -path "*dummy-tools*" \
              ! -path "*scripts*" \
              2>/dev/null | head -1)
            
            if [ -n "$gcc_file" ]; then
                log "âœ… æ‰¾åˆ°SDKä¸­çš„GCCç¼–è¯‘å™¨: $(basename "$gcc_file")"
                log "  ğŸ”§ å®Œæ•´è·¯å¾„: $gcc_file"
                log "  ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: $("$gcc_file" --version 2>&1 | head -1)"
            fi
        fi
        
        # ä¿å­˜åˆ°ç¯å¢ƒæ–‡ä»¶
        save_env
        
        return 0
    else
        log "âŒ OpenWrt SDKä¸‹è½½å¤±è´¥"
        log "ğŸ’¡ å°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨ä½œä¸ºåå¤‡"
        
        # è®¾ç½®ç©ºçš„ç¼–è¯‘å™¨ç›®å½•
        export COMPILER_DIR=""
        save_env
        
        # ä¸è¿”å›é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
        return 0
    fi
}

#ã€build_firmware_main.sh-21ã€‘é…ç½®åº”ç”¨å‡½æ•° - ä¿®å¤å†…æ ¸ç‰ˆæœ¬é—®é¢˜å¹¶å¢å¼ºæ˜¾ç¤º
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…ï¼ˆå¢å¼ºç‰ˆï¼‰==="
    
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åº”ç”¨é…ç½®"
        return 1
    fi
    
    log "ğŸ“‹ é…ç½®è¯¦æƒ…:"
    log "é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "é…ç½®è¡Œæ•°: $(wc -l < .config)"
    
    # å…ˆå¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶
    if [ -f ".config" ]; then
        local backup_file=".config.backup.$(date +%Y%m%d_%H%M%S)"
        cp ".config" "$backup_file"
        log "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶: $backup_file"
    fi
    
    # æ­¥éª¤1: éªŒè¯é…ç½®è¯­æ³•
    log "ğŸ” æ­¥éª¤1: éªŒè¯é…ç½®è¯­æ³•..."
    if validate_config_syntax; then
        log "âœ… é…ç½®è¯­æ³•éªŒè¯é€šè¿‡"
    else
        log "âš ï¸ é…ç½®è¯­æ³•æœ‰é—®é¢˜ï¼Œå°è¯•è‡ªåŠ¨ä¿®å¤..."
        # å°è¯•ä¿®å¤å¸¸è§é—®é¢˜
        make defconfig 2>&1 | tee /tmp/defconfig_fix.log
        if [ $? -eq 0 ]; then
            log "âœ… defconfig ä¿®å¤æˆåŠŸ"
        else
            log "âŒ defconfig ä¿®å¤å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
            log "defconfig é”™è¯¯æ—¥å¿—ï¼ˆå‰20è¡Œï¼‰:"
            cat /tmp/defconfig_fix.log | tail -20
        fi
    fi
    
    # æ­¥éª¤2: æ¸…ç†é‡å¤é…ç½®å’Œå†²çªé…ç½®
    log "ğŸ”§ æ­¥éª¤2: æ¸…ç†é‡å¤å’Œå†²çªé…ç½®..."
    
    # æ¸…ç†é‡å¤çš„USBé…ç½®
    local usb_configs=(
        "kmod-usb-core" "kmod-usb2" "kmod-usb3" "kmod-usb-xhci-hcd"
        "kmod-usb-xhci-pci" "kmod-usb-xhci-plat-hcd" "kmod-usb-ohci-pci"
        "kmod-usb-dwc3" "kmod-usb-dwc3-qcom" "kmod-phy-qcom-dwc3"
        "kmod-usb-dwc3-of-simple" "kmod-usb-xhci-mtk" "kmod-usb2-ath79"
    )
    
    for config in "${usb_configs[@]}"; do
        # åˆ é™¤é‡å¤çš„å¯ç”¨é…ç½®
        local enabled_count=$(grep -c "^CONFIG_PACKAGE_${config}=y" .config)
        if [ $enabled_count -gt 1 ]; then
            log "ğŸ”„ æ¸…ç†é‡å¤çš„å¯ç”¨é…ç½®: $config ($enabled_count æ¬¡)"
            awk -v cfg="CONFIG_PACKAGE_${config}=y" '$0 == cfg && !seen[cfg]++' .config > .config.tmp && mv .config.tmp .config
        fi
        
        # åˆ é™¤é‡å¤çš„ç¦ç”¨é…ç½®
        local disabled_count=$(grep -c "^# CONFIG_PACKAGE_${config} is not set" .config)
        if [ $disabled_count -gt 1 ]; then
            log "ğŸ”„ æ¸…ç†é‡å¤çš„ç¦ç”¨é…ç½®: $config ($disabled_count æ¬¡)"
            awk -v cfg="# CONFIG_PACKAGE_${config} is not set" '$0 == cfg && !seen[cfg]++' .config > .config.tmp && mv .config.tmp .config
        fi
        
        # è§£å†³å†²çªï¼šå¦‚æœæ—¢æœ‰å¯ç”¨åˆæœ‰ç¦ç”¨ï¼Œä¿ç•™å¯ç”¨
        if [ $enabled_count -gt 0 ] && [ $disabled_count -gt 0 ]; then
            log "ğŸ”„ è§£å†³é…ç½®å†²çª: $config (ä¿ç•™å¯ç”¨ï¼Œåˆ é™¤ç¦ç”¨)"
            sed -i "/^# CONFIG_PACKAGE_${config} is not set/d" .config
        fi
    done
    
    # æ­¥éª¤3: è¿è¡Œ make defconfig (ä½¿ç”¨æ”¹è¿›çš„é”™è¯¯å¤„ç†)
    log "ğŸ”„ æ­¥éª¤3: è¿è¡Œ make defconfig..."
    
    # æ¸…é™¤æ—§çš„defconfigæ—¥å¿—
    rm -f /tmp/defconfig.log
    
    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬é…ç½® - ä¿®å¤å†…æ ¸ç‰ˆæœ¬ç¼ºå¤±é—®é¢˜
    log "ğŸ” æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬é…ç½®..."
    if ! grep -q "^CONFIG_KERNEL_" .config; then
        log "âš ï¸ æœªæ‰¾åˆ°å†…æ ¸ç‰ˆæœ¬é…ç½®ï¼Œæ·»åŠ é»˜è®¤é…ç½®"
        
        # æ ¹æ®SELECTED_BRANCHè®¾ç½®å†…æ ¸ç‰ˆæœ¬
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ] || [ "$SELECTED_BRANCH" = "master" ]; then
            echo "# Kernel configuration" >> .config
            echo "CONFIG_KERNEL_NET=y" >> .config
            echo "CONFIG_KERNEL_IPV6=y" >> .config
            echo "CONFIG_KERNEL_BRIDGE=y" >> .config
            echo "CONFIG_KERNEL_FS_POSIX_ACL=y" >> .config
            echo "CONFIG_KERNEL_CGROUPS=y" >> .config
            log "âœ… æ·»åŠ 23.05/masterå†…æ ¸é»˜è®¤é…ç½®"
        else
            echo "# Kernel configuration" >> .config
            echo "CONFIG_KERNEL_IPV6=y" >> .config
            echo "CONFIG_KERNEL_BRIDGE=y" >> .config
            echo "CONFIG_KERNEL_FS_POSIX_ACL=y" >> .config
            log "âœ… æ·»åŠ 21.02å†…æ ¸é»˜è®¤é…ç½®"
        fi
    fi
    
    # è¿è¡Œdefconfigå¹¶æ•è·è¯¦ç»†æ—¥å¿—
    if ! make defconfig 2>&1 | tee /tmp/defconfig.log; then
        log "âŒ make defconfig å¤±è´¥"
        log "è¯¦ç»†é”™è¯¯ä¿¡æ¯:"
        cat /tmp/defconfig.log | tail -30
        
        # å°è¯•åˆ†æé”™è¯¯åŸå› 
        if grep -q "unknown statement" /tmp/defconfig.log; then
            log "ğŸ’¡ é”™è¯¯åˆ†æ: å‘ç°æœªçŸ¥è¯­å¥é”™è¯¯"
            log "ğŸ”§ å°è¯•ä¿®å¤: åˆ é™¤åŒ…å«'unknown statement'çš„è¡Œåé‡è¯•..."
            
            # æå–é”™è¯¯è¡Œå·
            grep "unknown statement" /tmp/defconfig.log | while read line; do
                error_line=$(echo "$line" | grep -o "line [0-9]*" | grep -o "[0-9]*")
                if [ -n "$error_line" ]; then
                    log "  åˆ é™¤ç¬¬ $error_line è¡Œ"
                    sed -i "${error_line}d" .config
                fi
            done
            
            # å†æ¬¡å°è¯•defconfig
            log "ğŸ”„ é‡æ–°è¿è¡Œ make defconfig..."
            if make defconfig 2>&1 | tee /tmp/defconfig_retry.log; then
                log "âœ… defconfig ä¿®å¤æˆåŠŸ"
            else
                log "âŒ defconfig ä»ç„¶å¤±è´¥"
                log "ç¬¬äºŒæ¬¡å°è¯•çš„é”™è¯¯æ—¥å¿—:"
                cat /tmp/defconfig_retry.log | tail -20
                log "âš ï¸ ä½†ç»§ç»­æ‰§è¡Œï¼Œè®©æ„å»ºè¿‡ç¨‹è‡ªç„¶å¤±è´¥"
            fi
        elif grep -q "Missing kernel version" /tmp/defconfig.log; then
            log "ğŸ’¡ é”™è¯¯åˆ†æ: å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶ç¼ºå¤±"
            log "ğŸ”§ å°è¯•ä¿®å¤: æ£€æŸ¥å†…æ ¸é…ç½®..."
            
            # æ£€æŸ¥å†…æ ¸é…ç½®
            if [ -f "target/linux/$TARGET/Makefile" ]; then
                log "âœ… ç›®æ ‡å¹³å°Makefileå­˜åœ¨: target/linux/$TARGET/Makefile"
                
                # æå–å†…æ ¸ç‰ˆæœ¬
                local kernel_version=$(grep "KERNEL_PATCHVER" "target/linux/$TARGET/Makefile" | cut -d':' -f2 | xargs)
                if [ -n "$kernel_version" ]; then
                    log "ğŸ“Œ å†…æ ¸ç‰ˆæœ¬: $kernel_version"
                    
                    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
                    if [ -f "include/kernel-version.mk" ]; then
                        log "âœ… å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨: include/kernel-version.mk"
                        
                        # ä¿®å¤å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
                        sed -i "s/KERNEL_PATCHVER:=.*/KERNEL_PATCHVER:=$kernel_version/" "include/kernel-version.mk" 2>/dev/null || true
                        log "ğŸ”§ æ›´æ–°å†…æ ¸ç‰ˆæœ¬ä¸º: $kernel_version"
                    fi
                fi
            fi
            
            # å†æ¬¡å°è¯•defconfig
            log "ğŸ”„ é‡æ–°è¿è¡Œ make defconfig..."
            if make defconfig 2>&1 | tee /tmp/defconfig_retry.log; then
                log "âœ… defconfig ä¿®å¤æˆåŠŸ"
            else
                log "âŒ defconfig ä»ç„¶å¤±è´¥"
                log "âš ï¸ ä½†ç»§ç»­æ‰§è¡Œï¼Œè®©æ„å»ºè¿‡ç¨‹è‡ªç„¶å¤±è´¥"
            fi
        else
            log "âš ï¸ æ— æ³•è‡ªåŠ¨ä¿®å¤defconfigé”™è¯¯ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
        fi
    else
        log "âœ… make defconfig æˆåŠŸ"
    fi
    
    # æ­¥éª¤4: å¼ºåˆ¶å¯ç”¨å…³é”®USBé©±åŠ¨ï¼ˆé˜²æ­¢defconfigåˆ é™¤ï¼‰
    log "ğŸ”§ æ­¥éª¤4: ç¡®ä¿å…³é”®USBé©±åŠ¨è¢«å¯ç”¨..."
    
    # å®šä¹‰å…³é”®USBé©±åŠ¨
    local critical_usb_drivers=(
        "CONFIG_PACKAGE_kmod-usb-core=y"
        "CONFIG_PACKAGE_kmod-usb2=y"
        "CONFIG_PACKAGE_kmod-usb3=y"
        "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
        "CONFIG_PACKAGE_kmod-usb-xhci-pci=y"
        "CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y"
        "CONFIG_PACKAGE_kmod-usb-ohci-pci=y"
        "CONFIG_PACKAGE_kmod-usb-dwc3=y"
        "CONFIG_PACKAGE_kmod-usb-storage=y"
        "CONFIG_PACKAGE_kmod-scsi-core=y"
    )
    
    # å¹³å°ä¸“ç”¨é©±åŠ¨
    if [ "$PLATFORM" = "ipq40xx" ]; then
        critical_usb_drivers+=(
            "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y"
            "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y"
            "CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y"
        )
    elif [ "$PLATFORM" = "ramips" ]; then
        critical_usb_drivers+=(
            "CONFIG_PACKAGE_kmod-usb-xhci-mtk=y"
        )
    elif [ "$PLATFORM" = "ath79" ]; then
        critical_usb_drivers+=(
            "CONFIG_PACKAGE_kmod-usb2-ath79=y"
        )
    fi
    
    # æ·»åŠ æˆ–ç¡®ä¿å…³é”®é©±åŠ¨
    local added_drivers=0
    for driver in "${critical_usb_drivers[@]}"; do
        local config_name=$(echo "$driver" | cut -d'=' -f1)
        if ! grep -q "^${config_name}=y" .config; then
            # åˆ é™¤å¯èƒ½çš„ç¦ç”¨é…ç½®
            sed -i "/^# ${config_name} is not set/d" .config
            # æ·»åŠ å¯ç”¨é…ç½®
            echo "$driver" >> .config
            added_drivers=$((added_drivers + 1))
            log "âœ… å·²æ·»åŠ : $config_name"
        else
            log "â„¹ï¸ å·²å­˜åœ¨: $config_name"
        fi
    done
    
    if [ $added_drivers -gt 0 ]; then
        log "ğŸ“ˆ å…±æ·»åŠ äº† $added_drivers ä¸ªå…³é”®é©±åŠ¨"
    fi
    
    # æ­¥éª¤5: æ˜¾ç¤ºå¯ç”¨çš„åŠŸèƒ½æ’ä»¶
    log "ğŸ¯ æ­¥éª¤5: æ˜¾ç¤ºå¯ç”¨çš„åŠŸèƒ½æ’ä»¶..."
    echo "=== å¯ç”¨çš„åŠŸèƒ½æ’ä»¶åˆ—è¡¨ ==="
    
    # å®šä¹‰è¦æ£€æŸ¥çš„åŠŸèƒ½æ’ä»¶
    local feature_plugins=(
        # ç½‘ç»œåŠ é€Ÿ
        "luci-app-turboacc" "kmod-shortcut-fe" "kmod-fast-classifier"
        # æ–‡ä»¶å…±äº«
        "luci-app-samba4" "samba4-server"
        # ç½‘ç»œæœåŠ¡
        "luci-app-upnp" "luci-app-vsftpd" "luci-app-arpbind"
        # ç³»ç»Ÿå·¥å…·
        "luci-app-diskman" "luci-app-cpulimit" "luci-app-hd-idle"
        # DNSç›¸å…³
        "luci-app-smartdns" "smartdns"
        # å…¶ä»–åŠŸèƒ½
        "luci-app-accesscontrol" "luci-app-vlmcsd" "luci-app-wechatpush"
        "luci-app-sqm" "ddns-scripts"
    )
    
    local enabled_count=0
    local disabled_count=0
    
    echo "åŠŸèƒ½æ’ä»¶çŠ¶æ€:"
    for plugin in "${feature_plugins[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${plugin}=y" .config; then
            echo "  âœ… $plugin"
            enabled_count=$((enabled_count + 1))
        elif grep -q "^# CONFIG_PACKAGE_${plugin} is not set" .config; then
            echo "  âŒ $plugin (å·²ç¦ç”¨)"
            disabled_count=$((disabled_count + 1))
        else
            echo "  ğŸ”„ $plugin (æœªé…ç½®)"
        fi
    done
    
    echo "ç»Ÿè®¡: $enabled_count ä¸ªå¯ç”¨ï¼Œ$disabled_count ä¸ªç¦ç”¨"
    echo ""
    
    # æ­¥éª¤6: å†æ¬¡éªŒè¯é…ç½®
    log "ğŸ” æ­¥éª¤6: æœ€ç»ˆé…ç½®éªŒè¯..."
    if validate_config_syntax; then
        log "âœ… æœ€ç»ˆé…ç½®è¯­æ³•éªŒè¯é€šè¿‡"
    else
        log "âš ï¸ æœ€ç»ˆé…ç½®ä»æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ"
    fi
    
    # æ­¥éª¤7: è¿è¡Œdefconfigç¡®ä¿é…ç½®ä¸€è‡´
    log "ğŸ”„ æ­¥éª¤7: æœ€ç»ˆè¿è¡Œ make defconfig..."
    if make defconfig 2>&1 | tee /tmp/final_defconfig.log; then
        log "âœ… æœ€ç»ˆ defconfig æˆåŠŸ"
    else
        log "âš ï¸ æœ€ç»ˆ defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ"
        cat /tmp/final_defconfig.log | tail -10
    fi
    
    # æ­¥éª¤8: æ˜¾ç¤ºæœ€ç»ˆé…ç½®çŠ¶æ€
    log "ğŸ“Š æ­¥éª¤8: æ˜¾ç¤ºæœ€ç»ˆé…ç½®çŠ¶æ€..."
    local final_enabled=$(grep "^CONFIG_PACKAGE_.*=y$" .config | wc -l)
    local final_disabled=$(grep "^# CONFIG_PACKAGE_.* is not set$" .config | wc -l)
    log "âœ… æœ€ç»ˆçŠ¶æ€: å·²å¯ç”¨ $final_enabled ä¸ª, å·²ç¦ç”¨ $final_disabled ä¸ª"
    
    # æ˜¾ç¤ºå…³é”®é…ç½®çŠ¶æ€
    log "ğŸ”§ å…³é”®é…ç½®çŠ¶æ€:"
    echo "1. USBæ ¸å¿ƒ: $(grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" .config && echo "âœ…" || echo "âŒ")"
    echo "2. USB 3.0: $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo "âœ…" || echo "âŒ")"
    echo "3. USB xHCI: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo "âœ…" || echo "âŒ")"
    echo "4. USBå­˜å‚¨: $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" .config && echo "âœ…" || echo "âŒ")"
    
    # æ ¹æ®å¹³å°æ˜¾ç¤ºä¸“ç”¨é©±åŠ¨
    if [ "$PLATFORM" = "ipq40xx" ]; then
        echo "5. é«˜é€šUSB: $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo "âœ…" || echo "âŒ")"
    elif [ "$PLATFORM" = "ramips" ]; then
        echo "5. é›·å‡ŒUSB: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config && echo "âœ…" || echo "âŒ")"
    elif [ "$PLATFORM" = "ath79" ]; then
        echo "5. ath79 USB: $(grep -q "^CONFIG_PACKAGE_kmod-usb2-ath79=y" .config && echo "âœ…" || echo "âŒ")"
    fi
    
    # æ˜¾ç¤ºé…ç½®ç»„åˆä¿¡æ¯
    log "ğŸ“‹ é…ç½®ç»„åˆä¿¡æ¯:"
    if [ -f "$SUPPORT_DIR/config/${DEVICE_NAME}.config" ]; then
        log "  ğŸ¯ ä½¿ç”¨è®¾å¤‡ç‰¹å®šé…ç½®: ${DEVICE_NAME}.config"
        log "  ğŸ“ é…ç½®ç»„åˆ: è®¾å¤‡é…ç½® + base.config + usb-generic.config"
    else
        if [ "$CONFIG_MODE" = "normal" ]; then
            log "  ğŸ“ é…ç½®ç»„åˆ: base.config + normal.config + usb-generic.config"
        else
            log "  ğŸ“ é…ç½®ç»„åˆ: base.config + åŸºç¡€æ¨¡å¼é…ç½® + usb-generic.config"
        fi
    fi
    
    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
    log "æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "æœ€ç»ˆé…ç½®å¤§å°: $(ls -lh .config | awk '{print $5}')"
}

#ã€build_firmware_main.sh-11ã€‘å‰ç½®é”™è¯¯æ£€æŸ¥å‡½æ•° - ä¿®å¤LEDEåˆ†æ”¯æ£€æŸ¥
pre_build_error_check() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ğŸš¨ å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤LEDEåˆ†æ”¯æ£€æŸ¥ï¼‰==="
    
    local error_count=0
    local warning_count=0
    
    # æ˜¾ç¤ºå½“å‰ç¯å¢ƒå˜é‡
    log "å½“å‰ç¯å¢ƒå˜é‡:"
    log "  SELECTED_BRANCH: $SELECTED_BRANCH"
    log "  TARGET: $TARGET"
    log "  SUBTARGET: $SUBTARGET"
    log "  DEVICE: $DEVICE"
    log "  CONFIG_MODE: $CONFIG_MODE"
    log "  COMPILER_DIR: $COMPILER_DIR"
    log "  DEVICE_NAME: $DEVICE_NAME"
    log "  PLATFORM: $PLATFORM"
    log "  SOURCE_REPO: $SOURCE_REPO"
    
    # 1. æ£€æŸ¥é…ç½®æ–‡ä»¶
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    else
        log "âœ… .config æ–‡ä»¶å­˜åœ¨"
    fi
    
    # 2. æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶ - ä¿®å¤LEDEå†…æ ¸é—®é¢˜
    log "ğŸ” æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶..."
    if [ -f "include/kernel-version.mk" ]; then
        log "âœ… å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨: include/kernel-version.mk"
        
        # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ˜¯å¦è®¾ç½®
        local kernel_patchver=$(grep "KERNEL_PATCHVER" "include/kernel-version.mk" | cut -d':' -f2 | xargs)
        if [ -n "$kernel_patchver" ] && [ "$kernel_patchver" != "" ]; then
            log "ğŸ“Œ å†…æ ¸ç‰ˆæœ¬: $kernel_patchver"
        else
            log "âš ï¸ è­¦å‘Š: å†…æ ¸ç‰ˆæœ¬æœªè®¾ç½®"
            warning_count=$((warning_count + 1))
            
            # å¯¹äºLEDE masteråˆ†æ”¯ï¼Œè®¾ç½®é»˜è®¤å†…æ ¸ç‰ˆæœ¬
            if [ "$SOURCE_REPO" = "lede" ] && [ "$SELECTED_BRANCH" = "master" ]; then
                log "ğŸ”§ ä¸ºLEDE masteråˆ†æ”¯è®¾ç½®é»˜è®¤å†…æ ¸ç‰ˆæœ¬"
                if [ -f "target/linux/$TARGET/Makefile" ]; then
                    local default_kernel=$(grep "KERNEL_PATCHVER" "target/linux/$TARGET/Makefile" | cut -d':' -f2 | xargs)
                    if [ -n "$default_kernel" ]; then
                        sed -i "s/KERNEL_PATCHVER:=.*/KERNEL_PATCHVER:=$default_kernel/" "include/kernel-version.mk"
                        log "âœ… è®¾ç½®å†…æ ¸ç‰ˆæœ¬ä¸º: $default_kernel"
                    fi
                fi
            fi
        fi
    else
        log "âš ï¸ è­¦å‘Š: å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨"
        warning_count=$((warning_count + 1))
    fi
    
    # 3. æ£€æŸ¥feeds
    if [ ! -d "feeds" ]; then
        log "âŒ é”™è¯¯: feeds ç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    else
        log "âœ… feeds ç›®å½•å­˜åœ¨"
    fi
    
    # 4. æ£€æŸ¥ä¾èµ–åŒ…
    if [ ! -d "dl" ]; then
        log "âš ï¸ è­¦å‘Š: dl ç›®å½•ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦ä¸‹è½½ä¾èµ–"
        warning_count=$((warning_count + 1))
    else
        local dl_count=$(find dl -type f \( -name "*.tar.*" -o -name "*.zip" -o -name "*.gz" \) 2>/dev/null | wc -l)
        log "âœ… ä¾èµ–åŒ…æ•°é‡: $dl_count ä¸ª"
    fi
    
    # 5. æ£€æŸ¥ç¼–è¯‘å™¨çŠ¶æ€
    if [ -d "staging_dir" ]; then
        local compiler_count=$(find staging_dir -maxdepth 1 -type d -name "compiler-*" 2>/dev/null | wc -l)
        if [ $compiler_count -eq 0 ]; then
            log "â„¹ï¸ æœªæ‰¾åˆ°å·²æ„å»ºçš„ç¼–è¯‘å™¨"
            log "ğŸ“Œ å°†ä½¿ç”¨ä¸‹è½½çš„SDKç¼–è¯‘å™¨æˆ–å†…ç½®å·¥å…·é“¾"
        else
            log "âœ… å·²æ£€æµ‹åˆ°ç¼–è¯‘å™¨: $compiler_count ä¸ª"
        fi
    else
        log "â„¹ï¸ staging_dirç›®å½•ä¸å­˜åœ¨"
        log "ğŸ“Œ å°†ä½¿ç”¨ä¸‹è½½çš„SDKç¼–è¯‘å™¨æˆ–å†…ç½®å·¥å…·é“¾è¿›è¡Œæ„å»º"
    fi
    
    # 6. æ£€æŸ¥å…³é”®æ–‡ä»¶
    local critical_files=("Makefile" "rules.mk" "Config.in" "feeds.conf.default")
    for file in "${critical_files[@]}"; do
        if [ -f "$file" ]; then
            log "âœ… å…³é”®æ–‡ä»¶å­˜åœ¨: $file"
        else
            log "âŒ é”™è¯¯: å…³é”®æ–‡ä»¶ä¸å­˜åœ¨: $file"
            error_count=$((error_count + 1))
        fi
    done
    
    # 7. æ£€æŸ¥å†…æ ¸Makefile
    log "ğŸ” æ£€æŸ¥å†…æ ¸Makefile..."
    if [ -f "target/linux/$TARGET/Makefile" ]; then
        log "âœ… ç›®æ ‡å¹³å°Makefileå­˜åœ¨: target/linux/$TARGET/Makefile"
        
        # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬é…ç½®
        local kernel_config=$(grep "KERNEL_PATCHVER" "target/linux/$TARGET/Makefile")
        if [ -n "$kernel_config" ]; then
            log "ğŸ“Œ å†…æ ¸ç‰ˆæœ¬é…ç½®: $kernel_config"
        else
            log "âš ï¸ è­¦å‘Š: å†…æ ¸ç‰ˆæœ¬é…ç½®æœªæ‰¾åˆ°"
            warning_count=$((warning_count + 1))
        fi
    else
        log "âŒ é”™è¯¯: ç›®æ ‡å¹³å°Makefileä¸å­˜åœ¨: target/linux/$TARGET/Makefile"
        error_count=$((error_count + 1))
    fi
    
    # 8. æ£€æŸ¥ç£ç›˜ç©ºé—´
    local available_space=$(df /mnt --output=avail | tail -1)
    local available_gb=$((available_space / 1024 / 1024))
    log "ç£ç›˜å¯ç”¨ç©ºé—´: ${available_gb}G"
    
    if [ $available_gb -lt 10 ]; then
        log "âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${available_gb}G)"
        error_count=$((error_count + 1))
    elif [ $available_gb -lt 20 ]; then
        log "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${available_gb}G)"
        warning_count=$((warning_count + 1))
    else
        log "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
    fi
    
    # 9. æ£€æŸ¥é¢„æ„å»ºç¼–è¯‘å™¨æ–‡ä»¶ - å¯¹äºLEDEåˆ†æ”¯ç‰¹æ®Šå¤„ç†
    log "ğŸ”§ æ£€æŸ¥é¢„æ„å»ºç¼–è¯‘å™¨æ–‡ä»¶..."
    
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        log "âœ… é¢„æ„å»ºç¼–è¯‘å™¨ç›®å½•å­˜åœ¨: $COMPILER_DIR"
        
        # å¯¹äºLEDE masteråˆ†æ”¯ï¼Œä¸éœ€è¦æ£€æŸ¥SDKç¼–è¯‘å™¨
        if [ "$SOURCE_REPO" = "lede" ] && [ "$SELECTED_BRANCH" = "master" ]; then
            log "â„¹ï¸ LEDE masteråˆ†æ”¯ä½¿ç”¨å†…ç½®å·¥å…·é“¾ï¼Œè·³è¿‡SDKç¼–è¯‘å™¨æ£€æŸ¥"
        else
            # æ”¾å®½æ£€æŸ¥ï¼šåªéœ€è¦æœ‰ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œä¸è¦æ±‚ç‰¹å®šç›®å½•ç»“æ„ï¼Œæ’é™¤è™šå‡ç¼–è¯‘å™¨
            local gcc_files=$(find "$COMPILER_DIR" -type f -executable \
              -name "*gcc" \
              ! -name "*gcc-ar" \
              ! -name "*gcc-ranlib" \
              ! -name "*gcc-nm" \
              ! -path "*dummy-tools*" \
              ! -path "*scripts*" \
              2>/dev/null | wc -l)
            
            if [ $gcc_files -gt 0 ]; then
                log "âœ… æ‰¾åˆ° $gcc_files ä¸ªGCCç¼–è¯‘å™¨æ–‡ä»¶"
            else
                log "âš ï¸ è­¦å‘Š: é¢„æ„å»ºç¼–è¯‘å™¨ç›®å½•ä¸­æœªæ‰¾åˆ°çœŸæ­£çš„GCCç¼–è¯‘å™¨"
                warning_count=$((warning_count + 1))
            fi
        fi
    else
        log "â„¹ï¸ æœªè®¾ç½®é¢„æ„å»ºç¼–è¯‘å™¨ç›®å½•æˆ–ç›®å½•ä¸å­˜åœ¨"
        if [ "$SOURCE_REPO" = "lede" ] && [ "$SELECTED_BRANCH" = "master" ]; then
            log "ğŸ’¡ LEDE masteråˆ†æ”¯å°†ä½¿ç”¨å†…ç½®å·¥å…·é“¾"
        else
            log "ğŸ’¡ å°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
        fi
    fi
    
    # 10. æ£€æŸ¥ç¼–è¯‘å™¨è°ƒç”¨çŠ¶æ€ï¼ˆä½¿ç”¨å¢å¼ºç‰ˆï¼‰
    check_compiler_invocation
    
    # æ€»ç»“
    if [ $error_count -eq 0 ]; then
        if [ $warning_count -eq 0 ]; then
            log "âœ… å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘"
        else
            log "âš ï¸ å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œä½†æœ‰ $warning_count ä¸ªè­¦å‘Šï¼Œå»ºè®®ä¿®å¤"
        fi
        return 0
    else
        log "âŒ å‰ç½®æ£€æŸ¥å‘ç° $error_count ä¸ªé”™è¯¯ï¼Œ$warning_count ä¸ªè­¦å‘Šï¼Œè¯·ä¿®å¤åå†ç¼–è¯‘"
        return 1
    fi
}

#ã€build_firmware_main.sh-27ã€‘å›ºä»¶æ„å»ºå‡½æ•° - ä¿®å¤è®¾å¤‡åç§°æ˜¾ç¤º
build_firmware() {
    local enable_cache=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ç¼–è¯‘å›ºä»¶ï¼ˆä½¿ç”¨OpenWrtå®˜æ–¹SDKå·¥å…·é“¾ï¼‰==="
    
    # æ˜¾ç¤ºè¯¦ç»†çš„ç¼–è¯‘ä¿¡æ¯
    log "ğŸ“‹ ç¼–è¯‘ä¿¡æ¯:"
    log "  æ„å»ºç›®å½•: $BUILD_DIR"
    log "  è®¾å¤‡: $DEVICE"
    log "  åŸå§‹è®¾å¤‡åç§°: $DEVICE_NAME"
    log "  ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "  é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "  ç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
    log "  å¹³å°: $PLATFORM"
    log "  æºä»£ç ä»“åº“: $SOURCE_REPO"
    log "  å¯ç”¨ç¼“å­˜: $enable_cache"
    
    # æ˜¾ç¤ºè®¾å¤‡æ˜ å°„ä¿¡æ¯
    log "ğŸ” è®¾å¤‡æ˜ å°„ä¿¡æ¯:"
    log "  è¾“å…¥è®¾å¤‡åç§°: $DEVICE_NAME"
    log "  å®é™…è®¾å¤‡æ ‡è¯†: $DEVICE"
    log "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    
    # ç¼–è¯‘å‰æœ€ç»ˆæ£€æŸ¥
    log "ç¼–è¯‘å‰æœ€ç»ˆæ£€æŸ¥..."
    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨"
        exit 1
    fi
    
    if [ ! -d "staging_dir" ]; then
        log "âš ï¸ è­¦å‘Š: staging_dir ç›®å½•ä¸å­˜åœ¨"
    fi
    
    if [ ! -d "dl" ]; then
        log "âš ï¸ è­¦å‘Š: dl ç›®å½•ä¸å­˜åœ¨"
    fi
    
    # æ£€æŸ¥é¢„æ„å»ºç¼–è¯‘å™¨æ–‡ä»¶
    log "ğŸ”§ æ£€æŸ¥é¢„æ„å»ºç¼–è¯‘å™¨è°ƒç”¨çŠ¶æ€..."
    verify_compiler_files
    
    # æ£€æŸ¥ç¼–è¯‘å™¨è°ƒç”¨çŠ¶æ€ï¼ˆä½¿ç”¨å¢å¼ºç‰ˆï¼‰
    check_compiler_invocation
    
    # è·å–CPUæ ¸å¿ƒæ•°
    local cpu_cores=$(nproc)
    local make_jobs=$cpu_cores
    
    # å¦‚æœå†…å­˜å°äº4GBï¼Œå‡å°‘å¹¶è¡Œä»»åŠ¡
    local total_mem=$(free -m | awk '/^Mem:/{print $2}')
    if [ $total_mem -lt 4096 ]; then
        make_jobs=$((cpu_cores / 2))
        if [ $make_jobs -lt 1 ]; then
            make_jobs=1
        fi
        log "âš ï¸ å†…å­˜è¾ƒä½(${total_mem}MB)ï¼Œå‡å°‘å¹¶è¡Œä»»åŠ¡åˆ° $make_jobs"
    fi
    
    # å¯¹äºLEDEä»“åº“ç‰¹æ®Šå¤„ç†
    if [ "$SOURCE_REPO" = "lede" ] && [ "$SELECTED_BRANCH" = "master" ]; then
        log "ğŸ”§ LEDE masteråˆ†æ”¯ä½¿ç”¨å†…ç½®å·¥å…·é“¾ï¼Œæ— éœ€é¢„æ„å»ºç¼–è¯‘å™¨"
    fi
    
    # å¼€å§‹ç¼–è¯‘ï¼ˆé»˜è®¤å¯ç”¨ç¼“å­˜ï¼‰
    log "ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶ï¼Œä½¿ç”¨ $make_jobs ä¸ªå¹¶è¡Œä»»åŠ¡"
    log "ğŸ’¡ ç¼–è¯‘å™¨è°ƒç”¨çŠ¶æ€å·²è®°å½•ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­å°†æ˜¾ç¤ºå…·ä½“è°ƒç”¨çš„ç¼–è¯‘å™¨"
    
    make -j$make_jobs V=s 2>&1 | tee build.log
    BUILD_EXIT_CODE=${PIPESTATUS[0]}
    
    log "ç¼–è¯‘é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
    
    # ç¼–è¯‘ç»“æœåˆ†æ
    if [ $BUILD_EXIT_CODE -eq 0 ]; then
        log "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
        
        # åˆ†æç¼–è¯‘å™¨è°ƒç”¨æƒ…å†µ
        log "ğŸ” ç¼–è¯‘å™¨è°ƒç”¨åˆ†æ:"
        if [ -f "build.log" ]; then
            local prebuilt_calls=$(grep -c "$COMPILER_DIR" build.log 2>/dev/null || echo "0")
            local total_calls=$(grep -c "gcc\|g++" build.log 2>/dev/null || echo "0")
            
            if [ $prebuilt_calls -gt 0 ]; then
                log "  ğŸ¯ é¢„æ„å»ºç¼–è¯‘å™¨è°ƒç”¨æ¬¡æ•°: $prebuilt_calls/$total_calls"
                log "  ğŸ“Œ æˆåŠŸè°ƒç”¨äº†é¢„æ„å»ºçš„ç¼–è¯‘å™¨æ–‡ä»¶"
            else
                log "  ğŸ”„ æœªæ£€æµ‹åˆ°é¢„æ„å»ºç¼–è¯‘å™¨è°ƒç”¨"
                if [ "$SOURCE_REPO" = "lede" ] && [ "$SELECTED_BRANCH" = "master" ]; then
                    log "  ğŸ“Œ LEDE masteråˆ†æ”¯ä½¿ç”¨å†…ç½®å·¥å…·é“¾"
                else
                    log "  ğŸ“Œ ä½¿ç”¨çš„æ˜¯OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
                fi
            fi
        fi
        
        # æ£€æŸ¥ç”Ÿæˆçš„å›ºä»¶
        if [ -d "bin/targets" ]; then
            local firmware_count=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
            log "âœ… ç”Ÿæˆå›ºä»¶æ–‡ä»¶: $firmware_count ä¸ª"
            
            # æ˜¾ç¤ºå›ºä»¶æ–‡ä»¶
            log "ğŸ“¦ ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | head -5 | while read file; do
                local file_size=$(du -h "$file" | cut -f1)
                local file_name=$(basename "$file")
                log "  ğŸ¯ $file_name ($file_size)"
            done
        else
            log "âŒ å›ºä»¶ç›®å½•ä¸å­˜åœ¨"
        fi
    else
        log "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
        
        # åˆ†æå¤±è´¥åŸå› 
        if [ -f "build.log" ]; then
            log "=== ç¼–è¯‘é”™è¯¯æ‘˜è¦ ==="
            
            # æŸ¥æ‰¾å¸¸è§é”™è¯¯
            local error_count=$(grep -c "Error [0-9]|error:" build.log)
            local warning_count=$(grep -c "Warning\|warning:" build.log)
            
            log "å‘ç° $error_count ä¸ªé”™è¯¯ï¼Œ$warning_count ä¸ªè­¦å‘Š"
            
            # æ˜¾ç¤ºå‰10ä¸ªé”™è¯¯
            if [ $error_count -gt 0 ]; then
                log "å‰10ä¸ªé”™è¯¯:"
                grep -i "Error\|error:" build.log | head -10
            fi
            
            # æ£€æŸ¥å†…æ ¸ç›¸å…³é”™è¯¯
            log "ğŸ”§ å†…æ ¸ç›¸å…³é”™è¯¯:"
            if grep -q "Missing kernel" build.log; then
                log "ğŸš¨ å‘ç°å†…æ ¸ç‰ˆæœ¬ç¼ºå¤±é”™è¯¯"
                log "æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬é…ç½®..."
                if [ -f "include/kernel-version.mk" ]; then
                    log "å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶å†…å®¹:"
                    cat "include/kernel-version.mk"
                fi
            fi
            
            # æ£€æŸ¥ç¼–è¯‘å™¨ç›¸å…³é”™è¯¯
            if grep -q "compiler.*not found" build.log; then
                log "ğŸš¨ å‘ç°ç¼–è¯‘å™¨æœªæ‰¾åˆ°é”™è¯¯"
                log "æ£€æŸ¥ç¼–è¯‘å™¨è·¯å¾„..."
            fi
        fi
        
        exit $BUILD_EXIT_CODE
    fi
    
    log "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"
    
    # ç¼–è¯‘å®Œæˆåä¿å­˜ç¯å¢ƒå˜é‡
    save_env
}
