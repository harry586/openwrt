#ã€build_firmware_main.sh-16ã€‘
apply_config() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"

    log "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆå®Œæ•´ç‰ˆï¼‰ ==="

    if [ ! -f ".config" ]; then
        log "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åº”ç”¨é…ç½®"
        return 1
    fi

    log "ğŸ“‹ é…ç½®è¯¦æƒ…:"
    log "é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "é…ç½®è¡Œæ•°: $(wc -l < .config)"

    local backup_file=".config.bak.$(date +%Y%m%d%H%M%S)"
    cp .config "$backup_file"
    log "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½: $backup_file"

    log "ğŸ”§ æ­¥éª¤1: æ ‡å‡†åŒ–é…ç½®æ–‡ä»¶æ ¼å¼..."

    if [ -f ".config" ]; then
        awk '
        {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "")
            if ($0 ~ /^#/) {
                if ($0 ~ /^#CONFIG_/) {
                    $0 = "# " substr($0, 2)
                }
                if ($0 !~ /is not set$/) {
                    $0 = $0 " is not set"
                }
            }
            if ($0 ~ /^CONFIG_/) {
                if ($0 ~ /y$|m$|=$/) {
                    gsub(/[[:space:]]*=[[:space:]]*y$/, "=y")
                    gsub(/[[:space:]]*=[[:space:]]*m$/, "=m")
                    gsub(/[[:space:]]*=[[:space:]]*$/, "=")
                }
            }
            if (length($0) > 0) {
                print $0
            }
        }' .config > .config.tmp

        mv .config.tmp .config
        log "âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ ‡å‡†åŒ–å®Œæˆ"
    else
        log "âŒ .config æ–‡ä»¶åœ¨æ“ä½œè¿‡ç¨‹ä¸­ä¸¢å¤±"
        return 1
    fi

    log "ğŸ”§ æ­¥éª¤2: æ¸…ç†é‡å¤é…ç½®è¡Œ..."

    local dup_before=$(wc -l < .config)

    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config

    local dup_after=$(wc -l < .config)
    local dup_removed=$((dup_before - dup_after))

    if [ $dup_removed -gt 0 ]; then
        log "âœ… å·²åˆ é™¤ $dup_removed ä¸ªå®Œå…¨é‡å¤çš„é…ç½®è¡Œ"
    fi

    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq

    mv .config.uniq .config

    local config_uniq_removed=$((dup_after - $(wc -l < .config)))
    if [ $config_uniq_removed -gt 0 ]; then
        log "âœ… å·²åˆå¹¶ $config_uniq_removed ä¸ªé‡å¤é…ç½®é¡¹"
    fi

    log "ğŸ”§ æ­¥éª¤3: æ£€æŸ¥libustreamå†²çª..."

    local openssl_enabled=0
    local wolfssl_enabled=0

    if grep -q "^CONFIG_PACKAGE_libustream-openssl=y" .config; then
        openssl_enabled=1
    fi

    if grep -q "^CONFIG_PACKAGE_libustream-wolfssl=y" .config; then
        wolfssl_enabled=1
    fi

    if [ $openssl_enabled -eq 1 ] && [ $wolfssl_enabled -eq 1 ]; then
        log "âš ï¸ å‘ç°libustream-opensslå’Œlibustream-wolfsslå†²çª"
        log "ğŸ”§ ä¿®å¤å†²çª: ç¦ç”¨libustream-openssl"

        awk '
        /^CONFIG_PACKAGE_libustream-openssl=y/ {
            print "# CONFIG_PACKAGE_libustream-openssl is not set"
            next
        }
        { print $0 }
        ' .config > .config.tmp
        mv .config.tmp .config

        log "âœ… å†²çªå·²ä¿®å¤"
    else
        log "âœ… libustreamæ— å†²çª"
    fi

    log "ğŸ”§ æ­¥éª¤4: æ£€æŸ¥å¹¶ä¿®å¤å…³é”®é…ç½®..."

    local config_tool=""
    if [ -f "scripts/config/config" ] && [ -x "scripts/config/config" ]; then
        config_tool="scripts/config/config"
        log "âœ… ä½¿ç”¨ scripts/config/config å·¥å…·"
    elif [ -f "scripts/config/conf" ] && [ -x "scripts/config/conf" ]; then
        config_tool="scripts/config/conf"
        log "âœ… ä½¿ç”¨ scripts/config/conf å·¥å…·"
    elif [ -f "scripts/config" ] && [ -x "scripts/config" ]; then
        config_tool="scripts/config"
        log "âœ… ä½¿ç”¨ scripts/config å·¥å…·"
    else
        log "âš ï¸ é…ç½®å·¥å…·ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨awkæ–¹å¼è¿›è¡Œä¿®å¤"
        config_tool=""
    fi

    local target=$(grep "^CONFIG_TARGET_" .config | grep "=y" | head -1 | cut -d'_' -f2 | tr '[:upper:]' '[:lower:]')
    local fix_count=0

    log "  ğŸ”§ USB 3.0é©±åŠ¨æ£€æŸ¥..."
    local usb3_enabled=0

    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        usb3_enabled=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" .config; then
        usb3_enabled=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-qcom=y" .config; then
        usb3_enabled=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config; then
        usb3_enabled=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        usb3_enabled=1
    elif grep -q "^CONFIG_USB_XHCI_HCD=y" .config; then
        usb3_enabled=1
    fi

    if [ $usb3_enabled -eq 0 ]; then
        log "  âš ï¸ USB 3.0åŠŸèƒ½æœªå¯ç”¨ï¼Œå°è¯•ä¿®å¤..."
        if [ -n "$config_tool" ]; then
            if [ "$config_tool" = "scripts/config/conf" ]; then
                $config_tool --defconfig CONFIG_PACKAGE_kmod-usb3=y .config 2>/dev/null || true
            else
                $config_tool --enable PACKAGE_kmod-usb3 2>/dev/null || true
            fi
        else
            echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        fi
        fix_count=$((fix_count + 1))
        log "  âœ… USB 3.0åŠŸèƒ½å·²æ·»åŠ "
    else
        log "  âœ… USB 3.0åŠŸèƒ½å·²å¯ç”¨"
    fi

    if [ "$target" = "ipq40xx" ] || [ "$target" = "qcom" ]; then
        log "  ğŸ”§ IPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨æ£€æŸ¥..."

        if ! grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && ! grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=m" .config; then
            log "  âš ï¸ kmod-usb-dwc3-qcomæœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
            if [ -n "$config_tool" ]; then
                if [ "$config_tool" = "scripts/config/conf" ]; then
                    $config_tool --defconfig CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y .config 2>/dev/null || true
                else
                    $config_tool --enable PACKAGE_kmod-usb-dwc3-qcom 2>/dev/null || true
                fi
            else
                echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            fi
            fix_count=$((fix_count + 1))
            log "  âœ… kmod-usb-dwc3-qcomå·²æ·»åŠ "
        else
            log "  âœ… kmod-usb-dwc3-qcomå·²å¯ç”¨"
        fi

        if grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config; then
            log "  âœ… é«˜é€šIPQ4019 USB PHYå·²å¯ç”¨"
        elif ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-ipq4019-usb=y" .config && ! grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-ipq4019-usb=m" .config; then
            log "  âš ï¸ é«˜é€šUSB PHYæœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
            if [ -n "$config_tool" ]; then
                if [ "$config_tool" = "scripts/config/conf" ]; then
                    $config_tool --defconfig CONFIG_PACKAGE_kmod-phy-qcom-ipq4019-usb=y .config 2>/dev/null || true
                else
                    $config_tool --enable PACKAGE_kmod-phy-qcom-ipq4019-usb 2>/dev/null || true
                fi
            else
                echo "CONFIG_PACKAGE_kmod-phy-qcom-ipq4019-usb=y" >> .config
            fi
            fix_count=$((fix_count + 1))
            log "  âœ… é«˜é€šUSB PHYå·²æ·»åŠ "
        fi
    fi

    if [ "$CONFIG_MODE" = "normal" ]; then
        log "  ğŸ”§ TurboACCé…ç½®æ£€æŸ¥..."
        local turboacc_fixed=0

        if ! grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            log "  âš ï¸ luci-app-turboaccæœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
            if [ -n "$config_tool" ]; then
                if [ "$config_tool" = "scripts/config/conf" ]; then
                    $config_tool --defconfig CONFIG_PACKAGE_luci-app-turboacc=y .config 2>/dev/null || true
                else
                    $config_tool --enable PACKAGE_luci-app-turboacc 2>/dev/null || true
                fi
            else
                echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            fi
            turboacc_fixed=1
        fi

        if ! grep -q "^CONFIG_PACKAGE_kmod-shortcut-fe=y" .config; then
            log "  âš ï¸ kmod-shortcut-feæœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
            if [ -n "$config_tool" ]; then
                if [ "$config_tool" = "scripts/config/conf" ]; then
                    $config_tool --defconfig CONFIG_PACKAGE_kmod-shortcut-fe=y .config 2>/dev/null || true
                else
                    $config_tool --enable PACKAGE_kmod-shortcut-fe 2>/dev/null || true
                fi
            else
                echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            fi
            turboacc_fixed=1
        fi

        if ! grep -q "^CONFIG_PACKAGE_kmod-fast-classifier=y" .config; then
            log "  âš ï¸ kmod-fast-classifieræœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
            if [ -n "$config_tool" ]; then
                if [ "$config_tool" = "scripts/config/conf" ]; then
                    $config_tool --defconfig CONFIG_PACKAGE_kmod-fast-classifier=y .config 2>/dev/null || true
                else
                    $config_tool --enable PACKAGE_kmod-fast-classifier 2>/dev/null || true
                fi
            else
                echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
            fi
            turboacc_fixed=1
        fi

        if [ $turboacc_fixed -eq 1 ]; then
            log "  âœ… TurboACCé…ç½®å·²ä¿®å¤"
            fix_count=$((fix_count + 1))
        else
            log "  âœ… TurboACCé…ç½®æ­£å¸¸"
        fi
    fi

    log "  ğŸ”§ TCP BBRæ‹¥å¡æ§åˆ¶æ£€æŸ¥..."
    local bbr_fixed=0

    if ! grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
        log "  âš ï¸ kmod-tcp-bbræœªå¯ç”¨ï¼Œå°è¯•æ·»åŠ ..."
        if [ -n "$config_tool" ]; then
            if [ "$config_tool" = "scripts/config/conf" ]; then
                $config_tool --defconfig CONFIG_PACKAGE_kmod-tcp-bbr=y .config 2>/dev/null || true
            else
                $config_tool --enable PACKAGE_kmod-tcp-bbr 2>/dev/null || true
            fi
        else
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        bbr_fixed=1
    fi

    if ! grep -q '^CONFIG_DEFAULT_TCP_CONG="bbr"' .config; then
        log "  âš ï¸ DEFAULT_TCP_CONGæœªè®¾ç½®ä¸ºbbrï¼Œå°è¯•ä¿®å¤..."
        if [ -n "$config_tool" ]; then
            if [ "$config_tool" = "scripts/config/conf" ]; then
                sed -i '/^CONFIG_DEFAULT_TCP_CONG=/d' .config
                echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
            else
                $config_tool --set-str DEFAULT_TCP_CONG "bbr" 2>/dev/null || true
            fi
        else
            sed -i '/^CONFIG_DEFAULT_TCP_CONG=/d' .config
            echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        fi
        bbr_fixed=1
    fi

    if [ $bbr_fixed -eq 1 ]; then
        log "  âœ… TCP BBRé…ç½®å·²ä¿®å¤"
        fix_count=$((fix_count + 1))
    else
        log "  âœ… TCP BBRé…ç½®æ­£å¸¸"
    fi

    log "  ğŸ”§ kmod-ath10k-ctå†²çªæ£€æŸ¥..."
    local ath10k_fixed=0

    if grep -q "^CONFIG_PACKAGE_kmod-ath10k=y" .config; then
        log "  âš ï¸ æ£€æµ‹åˆ°æ ‡å‡†ath10ké©±åŠ¨ï¼Œä¸ath10k-ctå†²çªï¼Œæ­£åœ¨ä¿®å¤..."
        sed -i '/^CONFIG_PACKAGE_kmod-ath10k=y/d' .config
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config

        if ! grep -q "^CONFIG_PACKAGE_kmod-ath10k-ct=y" .config; then
            echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        fi
        ath10k_fixed=1
        log "  âœ… kmod-ath10k-ctå†²çªå·²ä¿®å¤"
    else
        log "  âœ… kmod-ath10k-cté…ç½®æ­£å¸¸"
    fi

    if [ $fix_count -eq 0 ]; then
        log "âœ… æ‰€æœ‰å…³é”®é…ç½®æ£€æŸ¥é€šè¿‡ï¼Œæ— éœ€ä¿®å¤"
    else
        log "âœ… å·²ä¿®å¤ $fix_count ä¸ªå…³é”®é…ç½®é¡¹"
    fi

    log "ğŸ”§ æ­¥éª¤5: æœ€ç»ˆå»é‡å’Œæ ¼å¼æ£€æŸ¥..."

    awk '!seen[$0]++' .config > .config.tmp
    mv .config.tmp .config

    awk '
    BEGIN { FS="=" }
    /^CONFIG_/ {
        config_lines[$1] = $0
        next
    }
    { other_lines[NR] = $0 }
    END {
        for (i in config_lines) print config_lines[i]
        for (i in other_lines) print other_lines[i]
    }' .config > .config.uniq

    mv .config.uniq .config

    awk 'NF > 0' .config > .config.tmp
    mv .config.tmp .config

    log "âœ… æœ€ç»ˆå»é‡å®Œæˆ"

    log "ğŸ”„ æ­¥éª¤6: è¿è¡Œ make defconfig..."
    make defconfig || handle_error "åº”ç”¨é…ç½®å¤±è´¥"

    log "ğŸ”§ æ­¥éª¤7: éªŒè¯å…³é”®é…ç½®..."

    echo ""
    echo "=== ğŸ” USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
    echo ""
    echo "ğŸ” æ£€æŸ¥åŸºç¡€USBé©±åŠ¨..."

    local base_drivers=(
        "kmod-usb-core"
        "kmod-usb2"
        "kmod-usb-storage"
        "kmod-scsi-core"
    )

    for driver in "${base_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "âœ… $driver: å·²å¯ç”¨"
        else
            echo "âŒ $driver: æœªå¯ç”¨"
        fi
    done

    echo ""
    echo "ğŸ” æ£€æŸ¥USB 3.0é©±åŠ¨..."

    local usb3_found=0

    if grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        echo "âœ… kmod-usb3: å·²å¯ç”¨"
        usb3_found=1
    fi

    if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config; then
        echo "âœ… kmod-usb-xhci-hcd: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" .config; then
        echo "âœ… kmod-usb-xhci-plat-hcd: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-qcom=y" .config; then
        echo "âœ… kmod-usb-xhci-qcom: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config; then
        echo "âœ… kmod-usb-xhci-mtk: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3=y" .config && grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config; then
        echo "âœ… DWC3 + USB3: å·²å¯ç”¨"
        usb3_found=1
    elif grep -q "^CONFIG_USB_XHCI_HCD=y" .config; then
        echo "âœ… å†…æ ¸xhciæ”¯æŒ: å·²å¯ç”¨"
        usb3_found=1
    fi

    if [ $usb3_found -eq 0 ]; then
        echo "âš ï¸ USB 3.0é©±åŠ¨: æœªæ‰¾åˆ°ä»»ä½•å®ç°"
    fi

    echo ""
    echo "ğŸ” æ£€æŸ¥å¹³å°ä¸“ç”¨é©±åŠ¨..."

    local target=$(grep "^CONFIG_TARGET_" .config | grep "=y" | head -1 | cut -d'_' -f2 | tr '[:upper:]' '[:lower:]')

    case "$target" in
        ipq40xx|qcom)
            echo "ğŸ”§ æ£€æµ‹åˆ°é«˜é€šIPQ40xxå¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"

            if grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config; then
                echo "âœ… kmod-usb-dwc3-qcom: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ kmod-usb-dwc3-qcom: æœªå¯ç”¨"
            fi

            if grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-ipq4019-usb=y" .config; then
                echo "âœ… kmod-phy-qcom-ipq4019-usb: å·²å¯ç”¨"
            elif grep -q "^CONFIG_PHY_QCOM_IPQ4019_USB=y" .config; then
                echo "âœ… é«˜é€šIPQ4019 USB PHY: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ é«˜é€šUSB PHY: æœªå¯ç”¨"
            fi
            ;;
        mediatek|ramips)
            echo "ğŸ”§ æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"

            if grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" .config; then
                echo "âœ… kmod-usb-xhci-mtk: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ kmod-usb-xhci-mtk: æœªå¯ç”¨"
            fi
            ;;
        ath79)
            echo "ğŸ”§ æ£€æµ‹åˆ°ATH79å¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"

            if grep -q "^CONFIG_PACKAGE_kmod-usb2-ath79=y" .config; then
                echo "âœ… kmod-usb2-ath79: å·²å¯ç”¨"
            else
                echo "â„¹ï¸ kmod-usb2-ath79: æœªå¯ç”¨"
            fi
            ;;
    esac

    echo ""
    echo "=== ğŸ“¦ æ’ä»¶é…ç½®çŠ¶æ€ ==="

    local plugins=$(grep "^CONFIG_PACKAGE_luci-app" .config | grep -E "=y|=m" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    local plugin_count=0

    if [ -n "$plugins" ]; then
        while read plugin; do
            plugin_count=$((plugin_count + 1))
            if grep -q "^CONFIG_PACKAGE_${plugin}=y" .config; then
                printf "%-4s âœ… %s: å·²å¯ç”¨\n" "[$plugin_count]" "$plugin"
            elif grep -q "^CONFIG_PACKAGE_${plugin}=m" .config; then
                printf "%-4s ğŸ“¦ %s: æ¨¡å—åŒ–\n" "[$plugin_count]" "$plugin"
            fi
        done <<< "$plugins"
        echo ""
        echo "ğŸ“Š æ’ä»¶æ€»æ•°: $plugin_count ä¸ª"
    else
        echo "æœªæ‰¾åˆ°Luciæ’ä»¶"
    fi

    echo ""
    echo "=== ğŸ“¦ å†…æ ¸æ¨¡å—é…ç½®çŠ¶æ€ ==="

    local kernel_modules=$(grep "^CONFIG_PACKAGE_kmod-" .config | grep -E "=y|=m" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    local module_count=0

    if [ -n "$kernel_modules" ]; then
        while read module; do
            module_count=$((module_count + 1))
            if grep -q "^CONFIG_PACKAGE_${module}=y" .config; then
                printf "%-4s âœ… %s: å·²å¯ç”¨\n" "[$module_count]" "$module"
            elif grep -q "^CONFIG_PACKAGE_${module}=m" .config; then
                printf "%-4s ğŸ“¦ %s: æ¨¡å—åŒ–\n" "[$module_count]" "$module"
            fi
        done <<< "$kernel_modules"
        echo ""
        echo "ğŸ“Š å†…æ ¸æ¨¡å—æ€»æ•°: $module_count ä¸ª"
    else
        echo "æœªæ‰¾åˆ°å†…æ ¸æ¨¡å—"
    fi

    echo ""
    echo "=== ğŸ“¦ ç½‘ç»œå·¥å…·é…ç½®çŠ¶æ€ ==="

    local net_tools=$(grep "^CONFIG_PACKAGE_" .config | grep -E "=y|=m" | grep -E "iptables|nftables|firewall|qos|sfe|shortcut|acceler|tc|fullcone" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    local net_count=0

    if [ -n "$net_tools" ]; then
        while read tool; do
            net_count=$((net_count + 1))
            if grep -q "^CONFIG_PACKAGE_${tool}=y" .config; then
                printf "%-4s âœ… %s: å·²å¯ç”¨\n" "[$net_count]" "$tool"
            elif grep -q "^CONFIG_PACKAGE_${tool}=m" .config; then
                printf "%-4s ğŸ“¦ %s: æ¨¡å—åŒ–\n" "[$net_count]" "$tool"
            fi
        done <<< "$net_tools"
        echo ""
        echo "ğŸ“Š ç½‘ç»œå·¥å…·æ€»æ•°: $net_count ä¸ª"
    else
        echo "æœªæ‰¾åˆ°ç½‘ç»œå·¥å…·"
    fi

    echo ""
    echo "=== ğŸ“¦ æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ ==="

    local fs_support=$(grep "^CONFIG_PACKAGE_kmod-fs-" .config | grep -E "=y|=m" | sed 's/CONFIG_PACKAGE_//g' | cut -d'=' -f1 | sort)
    local fs_count=0

    if [ -n "$fs_support" ]; then
        while read fs; do
            fs_count=$((fs_count + 1))
            if grep -q "^CONFIG_PACKAGE_${fs}=y" .config; then
                printf "%-4s âœ… %s: å·²å¯ç”¨\n" "[$fs_count]" "$fs"
            elif grep -q "^CONFIG_PACKAGE_${fs}=m" .config; then
                printf "%-4s ğŸ“¦ %s: æ¨¡å—åŒ–\n" "[$fs_count]" "$fs"
            fi
        done <<< "$fs_support"
        echo ""
        echo "ğŸ“Š æ–‡ä»¶ç³»ç»Ÿæ€»æ•°: $fs_count ä¸ª"
    else
        echo "æœªæ‰¾åˆ°æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ"
    fi

    echo ""
    echo "=== ğŸ“Š é…ç½®ç»Ÿè®¡ ==="

    local enabled_packages=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config 2>/dev/null || echo "0")
    local module_packages=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config 2>/dev/null || echo "0")
    local disabled_packages=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config 2>/dev/null || echo "0")
    local kernel_configs=$(grep -c "^CONFIG_[A-Z].*=y$" .config | grep -v "PACKAGE" | wc -l)

    echo "âœ… å·²å¯ç”¨æ’ä»¶/æ¨¡å—: $enabled_packages ä¸ª"
    echo "ğŸ“¦ æ¨¡å—åŒ–æ’ä»¶/æ¨¡å—: $module_packages ä¸ª"
    echo "âŒ å·²ç¦ç”¨æ’ä»¶/æ¨¡å—: $disabled_packages ä¸ª"
    echo "âš™ï¸ å†…æ ¸é…ç½®: $kernel_configs ä¸ª"
    echo "ğŸ“Š æ€»é…ç½®è¡Œæ•°: $(wc -l < .config) è¡Œ"

    # =========================================================================
    # ç»ˆæç¦ç”¨ï¼šç¡®ä¿æŒ‡å®šæ’ä»¶è¢«å½»åº•æ¸…é™¤ï¼ˆåŠ å¼ºç‰ˆ v5 - æ¯æ¬¡ defconfig åéƒ½æ£€æŸ¥ï¼‰
    # =========================================================================
    log ""
    log "=== ğŸ”§ ç»ˆæç¦ç”¨ä¸éœ€è¦çš„æ’ä»¶ç³»åˆ—ï¼ˆåŠ å¼ºç‰ˆ v5ï¼‰ ==="

    local forbidden_plugins=(
        "luci-app-vssr"
        "luci-app-ssr-plus"
        "luci-app-rclone"
        "luci-app-passwall"
    )

    # å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼šå¼ºåˆ¶ç¦ç”¨æŒ‡å®šæ’ä»¶
    force_disable_plugins() {
        local config_file="$1"
        for plugin in "${forbidden_plugins[@]}"; do
            # åˆ é™¤æ‰€æœ‰ç›¸å…³è¡Œï¼ˆä¸»åŒ…å’Œå­é€‰é¡¹ï¼‰
            sed -i "/^CONFIG_PACKAGE_${plugin}[=_ ]/d" "$config_file"
            sed -i "/^CONFIG_PACKAGE_${plugin}_/d" "$config_file"
            sed -i "/^# CONFIG_PACKAGE_${plugin}[=_ ]/d" "$config_file"
            # æ·»åŠ ç¦ç”¨æ ‡è®°ï¼ˆä»…ä¸»åŒ…ï¼‰
            echo "# CONFIG_PACKAGE_${plugin} is not set" >> "$config_file"
        done
        sort -u "$config_file" > "$config_file.tmp" && mv "$config_file.tmp" "$config_file"
    }

    # åˆæ¬¡å¼ºåˆ¶ç¦ç”¨
    force_disable_plugins ".config"

    # å¾ªç¯è¿è¡Œ defconfig ç›´åˆ°æ‰€æœ‰æ’ä»¶éƒ½è¢«ç¦ç”¨ï¼ˆæœ€å¤š 5 æ¬¡ï¼‰
    local max_attempts=5
    local attempt=1
    while [ $attempt -le $max_attempts ]; do
        log "å°è¯• $attempt/$max_attempts: è¿è¡Œ make defconfig..."
        make defconfig > /tmp/build-logs/defconfig_attempt${attempt}.log 2>&1 || {
            log "âš ï¸ make defconfig è­¦å‘Šï¼Œä½†ç»§ç»­"
        }

        # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ®‹ç•™
        local still_enabled=0
        for plugin in "${forbidden_plugins[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${plugin}=y" .config || grep -q "^CONFIG_PACKAGE_${plugin}=m" .config; then
                still_enabled=$((still_enabled + 1))
                log "  âŒ $plugin ä»ç„¶è¢«å¯ç”¨"
            elif grep -q "^CONFIG_PACKAGE_${plugin}_" .config; then
                still_enabled=$((still_enabled + 1))
                log "  âŒ $plugin å­é€‰é¡¹æ®‹ç•™"
            fi
        done

        if [ $still_enabled -eq 0 ]; then
            log "âœ… ç¬¬ $attempt æ¬¡å°è¯•åæ‰€æœ‰æ’ä»¶å·²æˆåŠŸç¦ç”¨"
            break
        else
            log "âš ï¸ ç¬¬ $attempt æ¬¡å°è¯•åä»æœ‰ $still_enabled ä¸ªæ’ä»¶æ®‹ç•™ï¼Œå†æ¬¡å¼ºåˆ¶ç¦ç”¨..."
            force_disable_plugins ".config"
        fi
        attempt=$((attempt + 1))
    done

    # æœ€ç»ˆéªŒè¯
    log ""
    log "ğŸ“Š æœ€ç»ˆæ’ä»¶çŠ¶æ€éªŒè¯:"
    local still_remaining=0
    for plugin in "${forbidden_plugins[@]}"; do
        if grep -q -E "^CONFIG_PACKAGE_${plugin}[=_ ]|^# CONFIG_PACKAGE_${plugin}[=_ ]" .config; then
            log "  âŒ $plugin ä»æœ‰é…ç½®è¡Œæ®‹ç•™"
            still_remaining=$((still_remaining + 1))
        else
            log "  âœ… $plugin å·²æ­£ç¡®ç¦ç”¨"
        fi
    done

    if [ $still_remaining -eq 0 ]; then
        log "ğŸ‰ æ‰€æœ‰æŒ‡å®šæ’ä»¶å·²æˆåŠŸç¦ç”¨"
    else
        log "âš ï¸ æœ‰ $still_remaining ä¸ªæ’ä»¶æœªèƒ½å½»åº•ç¦ç”¨ï¼Œè¯·æ£€æŸ¥ feeds æˆ–ä¾èµ–"
        log "æç¤º: è¿™äº›æ’ä»¶å¯èƒ½è¢«å…¶ä»–åŒ…ä¾èµ–ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œ make menuconfig æ£€æŸ¥ä¾èµ–å…³ç³»"
    fi

    log "âœ… é…ç½®åº”ç”¨å®Œæˆ"
    log "æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "æœ€ç»ˆé…ç½®å¤§å°: $(ls -lh .config | awk '{print $5}')"
    log "æœ€ç»ˆé…ç½®è¡Œæ•°: $(wc -l < .config)"
}
#ã€build_firmware_main.sh-16-endã€‘

#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    local device_override=$2

    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"

    if [ -n "$device_override" ]; then
        DEVICE="$device_override"
        log "ğŸ”§ ä½¿ç”¨è®¾å¤‡è¦†ç›–å‚æ•°: $DEVICE"
    fi

    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆè®¾å¤‡æ˜¾å¼æŒ‡å®šç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"

    if [ -z "$DEVICE" ]; then
        log "âŒ é”™è¯¯: DEVICEå˜é‡ä¸ºç©ºï¼"
        env | grep -E "DEVICE|TARGET|SELECTED" || true
        handle_error "DEVICEå˜é‡æœªè®¾ç½®"
    fi

    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"

    local openwrt_device=""
    local search_device=""

    case "$DEVICE" in
        ac42u|rt-ac42u|asus_rt-ac42u)
            openwrt_device="asus_rt-ac42u"
            search_device="ac42u"
            log "ğŸ”§ è®¾å¤‡æ˜ å°„: è¾“å…¥=$DEVICE, é…ç½®ç”¨=$openwrt_device, æœç´¢ç”¨=$search_device"
            ;;
        acrh17|rt-acrh17|asus_rt-acrh17)
            openwrt_device="asus_rt-acrh17"
            search_device="acrh17"
            log "ğŸ”§ è®¾å¤‡æ˜ å°„: è¾“å…¥=$DEVICE, é…ç½®ç”¨=$openwrt_device, æœç´¢ç”¨=$search_device"
            ;;
        *)
            openwrt_device=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
            search_device="$DEVICE"
            log "ğŸ”§ ä½¿ç”¨åŸå§‹è®¾å¤‡å: $openwrt_device"
            ;;
    esac

    local device_lower="$openwrt_device"
    local device_config="CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}"

    log "ğŸ”§ è®¾å¤‡é…ç½®å˜é‡: $device_config=y"

    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
${device_config}=y
EOF

    log "ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶å†…å®¹:"
    cat .config

    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."

    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
        fi
    }

    : ${CONFIG_BASE:="base.config"}
    : ${CONFIG_USB_GENERIC:="usb-generic.config"}
    : ${CONFIG_NORMAL:="normal.config"}

    append_config "$CONFIG_DIR/$CONFIG_BASE"
    append_config "$CONFIG_DIR/$CONFIG_USB_GENERIC"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    append_config "$CONFIG_DIR/devices/$DEVICE.config"

    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/$CONFIG_NORMAL"
    fi

    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi

    if [ -f "$CONFIG_DIR/devices/$DEVICE.config" ]; then
        log "ğŸ“‹ ä»è®¾å¤‡é…ç½®æ–‡ä»¶åŠ¨æ€æ·»åŠ é…ç½®: $CONFIG_DIR/devices/$DEVICE.config"
        append_config "$CONFIG_DIR/devices/$DEVICE.config"
    fi

    if [ "${ENABLE_TCP_BBR:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
        log "âœ… TCP BBRå·²å¯ç”¨"
    fi

    if [ "$CONFIG_MODE" = "normal" ] && [ "${ENABLE_TURBOACC:-true}" = "true" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        log "âœ… TurboACCå·²å¯ç”¨"
    fi

    if [ "${FORCE_ATH10K_CT:-true}" = "true" ]; then
        sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
        sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
        echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        log "âœ… ath10k-cté©±åŠ¨å·²å¼ºåˆ¶å¯ç”¨"
    fi

    log "ğŸ”„ ç¬¬ä¸€æ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config

    # =========================================================================
    # é™é»˜è·å–å†…æ ¸é…ç½®æ–‡ä»¶ï¼ˆä¸å†è¾“å‡ºå†—é•¿æ—¥å¿—ï¼‰
    # =========================================================================
    local kernel_config_file=""
    local kernel_version=""
    local found_kernel=0

    if [ "${ENABLE_DYNAMIC_KERNEL_DETECTION:-true}" = "true" ]; then
        # å°è¯•ä»è®¾å¤‡å®šä¹‰æ–‡ä»¶è·å–å†…æ ¸ç‰ˆæœ¬ï¼ˆé™é»˜ï¼‰
        if [ -n "$TARGET" ] && [ -d "target/linux/$TARGET" ]; then
            # æŸ¥æ‰¾è®¾å¤‡å®šä¹‰æ–‡ä»¶ï¼ˆå¤ç”¨ä¹‹å‰çš„ search_deviceï¼‰
            local device_def_file=""
            while IFS= read -r mkfile; do
                if grep -q "define Device.*$search_device" "$mkfile" 2>/dev/null; then
                    device_def_file="$mkfile"
                    break
                fi
            done < <(find "target/linux/$TARGET" -type f -name "*.mk" 2>/dev/null)

            if [ -n "$device_def_file" ] && [ -f "$device_def_file" ]; then
                kernel_version=$(awk -F':=' '/^[[:space:]]*KERNEL_PATCHVER[[:space:]]*:=/ {gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2}' "$device_def_file")
                if [ -n "$kernel_version" ]; then
                    kernel_config_file="target/linux/$TARGET/config-$kernel_version"
                fi
            fi
        fi

        # å¦‚æœæœªæ‰¾åˆ°ï¼ŒæŒ‰ä¼˜å…ˆçº§æœç´¢
        if [ -z "$kernel_config_file" ] || [ ! -f "$kernel_config_file" ]; then
            for ver in ${KERNEL_VERSION_PRIORITY:-6.6 6.1 5.15 5.10 5.4}; do
                kernel_config_file="target/linux/$TARGET/config-$ver"
                if [ -f "$kernel_config_file" ]; then
                    kernel_version="$ver"
                    found_kernel=1
                    break
                fi
            done
        else
            found_kernel=1
        fi
    fi

    if [ $found_kernel -eq 1 ] && [ -f "$kernel_config_file" ]; then
        log "âœ… ä½¿ç”¨å†…æ ¸é…ç½®æ–‡ä»¶: $kernel_config_file (å†…æ ¸ç‰ˆæœ¬ $kernel_version)"

        local kernel_patterns=(
            "^CONFIG_USB"
            "^CONFIG_PHY"
            "^CONFIG_DWC"
            "^CONFIG_XHCI"
            "^CONFIG_EXTCON"
            "^CONFIG_COMMON_CLK"
            "^CONFIG_ARCH"
        )

        if [ ${#KERNEL_EXTRACT_PATTERNS[@]} -gt 0 ]; then
            kernel_patterns=("${KERNEL_EXTRACT_PATTERNS[@]}")
        fi

        local usb_configs_file="/tmp/usb_configs_$$.txt"

        for pattern in "${kernel_patterns[@]}"; do
            grep -E "^${pattern}|^# ${pattern}" "$kernel_config_file" >> "$usb_configs_file" 2>/dev/null || true
        done

        sort -u "$usb_configs_file" > "$usb_configs_file.sorted"

        local config_count=$(wc -l < "$usb_configs_file.sorted")
        log "æ‰¾åˆ° $config_count ä¸ªUSBç›¸å…³å†…æ ¸é…ç½®"

        local added_count=0
        while read line; do
            local config_name=$(echo "$line" | sed 's/^# //g' | cut -d'=' -f1 | cut -d' ' -f1)

            if ! grep -q "^${config_name}=" .config && ! grep -q "^# ${config_name} is not set" .config; then
                if echo "$line" | grep -q "=y$"; then
                    echo "$line" >> .config
                    added_count=$((added_count + 1))
                elif echo "$line" | grep -q "is not set"; then
                    echo "$line" >> .config
                    added_count=$((added_count + 1))
                fi
            fi
        done < "$usb_configs_file.sorted"

        log "âœ… æ·»åŠ äº† $added_count ä¸ªæ–°çš„å†…æ ¸é…ç½®"

        rm -f "$usb_configs_file" "$usb_configs_file.sorted"
    else
        # æœªæ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶æ—¶ä¸å†è¾“å‡ºè­¦å‘Šï¼Œä»…ä¿ç•™ä¸€ä¸ªè°ƒè¯•æ—¥å¿—ï¼ˆå¯å¿½ç•¥ï¼‰
        if [ "${DEBUG:-false}" = "true" ]; then
            log "â„¹ï¸ æœªæ‰¾åˆ°ç›®æ ‡å¹³å° $TARGET çš„å†…æ ¸é…ç½®æ–‡ä»¶ï¼Œè·³è¿‡å†…æ ¸é…ç½®æ·»åŠ "
        fi
    fi

    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfig..."
    make defconfig > /tmp/build-logs/defconfig1.log 2>&1 || {
        log "âŒ ç¬¬ä¸€æ¬¡ make defconfig å¤±è´¥"
        tail -50 /tmp/build-logs/defconfig1.log
        handle_error "ç¬¬ä¸€æ¬¡ä¾èµ–è§£å†³å¤±è´¥"
    }
    log "âœ… ç¬¬ä¸€æ¬¡ make defconfig æˆåŠŸ"

    log "ğŸ” åŠ¨æ€æ£€æµ‹å®é™…ç”Ÿæ•ˆçš„USBå†…æ ¸é…ç½®..."

    local usb_components=(
        "USB_SUPPORT"
        "USB_COMMON"
        "USB"
        "USB_XHCI_HCD"
        "USB_DWC3"
        "PHY"
    )

    for component in "${usb_components[@]}"; do
        local matches=$(grep -E "^CONFIG_${component}" .config | grep -E "=y|=m" | wc -l)
        if [ $matches -gt 0 ]; then
            log "âœ… $component ç›¸å…³é…ç½®: æ‰¾åˆ° $matches ä¸ª"
        fi
    done

    log "ğŸ“‹ åŠ¨æ€æ·»åŠ USBè½¯ä»¶åŒ…..."

    local base_usb_packages=(
        "kmod-usb-core"
        "kmod-usb-common"
        "kmod-usb2"
        "kmod-usb3"
        "kmod-usb-storage"
        "kmod-scsi-core"
        "block-mount"
        "automount"
        "usbutils"
    )

    local extended_usb_packages=(
        "kmod-usb-storage-uas"
        "kmod-usb-storage-extras"
        "kmod-scsi-generic"
    )

    local fs_support_packages=(
        "kmod-fs-ext4"
        "kmod-fs-vfat"
        "kmod-fs-exfat"
        "kmod-fs-ntfs3"
        "kmod-nls-utf8"
        "kmod-nls-cp936"
    )

    if [ ${#BASE_USB_PACKAGES[@]} -gt 0 ]; then
        base_usb_packages=("${BASE_USB_PACKAGES[@]}")
    fi

    if [ ${#EXTENDED_USB_PACKAGES[@]} -gt 0 ]; then
        extended_usb_packages=("${EXTENDED_USB_PACKAGES[@]}")
    fi

    if [ ${#FS_SUPPORT_PACKAGES[@]} -gt 0 ]; then
        fs_support_packages=("${FS_SUPPORT_PACKAGES[@]}")
    fi

    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            log "æ£€æµ‹åˆ°é«˜é€šå¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local qcom_packages=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-qcom"
                "kmod-usb-dwc3-of-simple"
                "kmod-phy-qcom-ipq4019-usb"
                "kmod-usb-xhci-hcd"
                "kmod-usb-xhci-plat-hcd"
            )
            base_usb_packages+=("${qcom_packages[@]}")
            ;;
        mediatek|ramips)
            log "æ£€æµ‹åˆ°è”å‘ç§‘å¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local mtk_packages=(
                "kmod-usb-xhci-mtk"
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-mediatek"
            )
            base_usb_packages+=("${mtk_packages[@]}")
            ;;
        ath79)
            log "æ£€æµ‹åˆ°ATH79å¹³å°ï¼Œæ·»åŠ ä¸“ç”¨USBé©±åŠ¨..."
            local ath79_packages=(
                "kmod-usb2-ath79"
                "kmod-usb-ohci"
            )
            base_usb_packages+=("${ath79_packages[@]}")
            ;;
    esac

    local added_packages=0
    local existing_packages=0
    while read pkg; do
        [ -z "$pkg" ] && continue
        if ! grep -q "^CONFIG_PACKAGE_${pkg}=y" .config && ! grep -q "^CONFIG_PACKAGE_${pkg}=m" .config; then
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            added_packages=$((added_packages + 1))
            log "  âœ… æ·»åŠ è½¯ä»¶åŒ…: $pkg"
        else
            existing_packages=$((existing_packages + 1))
        fi
    done < <(printf "%s\n" "${base_usb_packages[@]}" "${extended_usb_packages[@]}" "${fs_support_packages[@]}" | sort -u)

    log "ğŸ“Š USBè½¯ä»¶åŒ…ç»Ÿè®¡: æ–°å¢ $added_packages ä¸ª, å·²å­˜åœ¨ $existing_packages ä¸ª"

    log "ğŸ”„ ç¬¬äºŒæ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config

    log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfig..."
    make defconfig > /tmp/build-logs/defconfig2.log 2>&1 || {
        log "âš ï¸ ç¬¬äºŒæ¬¡ make defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­..."
    }
    log "âœ… ç¬¬äºŒæ¬¡ make defconfig å®Œæˆ"

    log "ğŸ” éªŒè¯å…³é”®USBé©±åŠ¨çŠ¶æ€..."

    local critical_usb_drivers=(
        "kmod-usb-core"
        "kmod-usb2"
        "kmod-usb-storage"
        "kmod-scsi-core"
    )

    if [ ${#CRITICAL_USB_DRIVERS[@]} -gt 0 ]; then
        critical_usb_drivers=("${CRITICAL_USB_DRIVERS[@]}")
    fi

    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            critical_usb_drivers+=(
                "kmod-usb-dwc3"
                "kmod-usb-dwc3-qcom"
            )
            ;;
        mediatek|ramips)
            critical_usb_drivers+=(
                "kmod-usb-xhci-mtk"
            )
            ;;
    esac

    local missing_drivers=()
    for driver in "${critical_usb_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "  âœ… $driver: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${driver}=m" .config; then
            log "  ğŸ“¦ $driver: æ¨¡å—åŒ–"
        else
            log "  âŒ $driver: æœªå¯ç”¨"
            missing_drivers+=("$driver")
        fi
    done

    if [ ${#missing_drivers[@]} -gt 0 ] && [ "${AUTO_FIX_USB_DRIVERS:-true}" = "true" ]; then
        log "ğŸ”§ è‡ªåŠ¨ä¿®å¤ç¼ºå¤±é©±åŠ¨..."
        for driver in "${missing_drivers[@]}"; do
            echo "CONFIG_PACKAGE_${driver}=y" >> .config
            log "  âœ… å·²æ·»åŠ : $driver"
        done
        make defconfig > /dev/null 2>&1
    fi

    log "ğŸ” æ­£åœ¨éªŒè¯è®¾å¤‡ $openwrt_device æ˜¯å¦è¢«é€‰ä¸­..."

    if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
        log "âœ… ç›®æ ‡è®¾å¤‡å·²æ­£ç¡®å¯ç”¨: CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y"
    elif grep -q "^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} is not set" .config; then
        log "âš ï¸ è­¦å‘Š: è®¾å¤‡è¢«ç¦ç”¨ï¼Œå°è¯•å¼ºåˆ¶å¯ç”¨..."
        sed -i "/^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} is not set/d" .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1

        if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
            log "âœ… è®¾å¤‡å·²å¼ºåˆ¶å¯ç”¨"
        else
            log "âŒ æ— æ³•å¯ç”¨è®¾å¤‡"
        fi
    else
        log "âš ï¸ è­¦å‘Š: è®¾å¤‡é…ç½®è¡Œæœªæ‰¾åˆ°ï¼Œæ‰‹åŠ¨æ·»åŠ ..."
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1
    fi

    local total_configs=$(wc -l < .config)
    local enabled_packages=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config)
    local module_packages=$(grep -c "^CONFIG_PACKAGE_.*=m$" .config)
    local disabled_packages=$(grep -c "^# CONFIG_PACKAGE_.* is not set$" .config)

    log "ğŸ“Š é…ç½®ç»Ÿè®¡:"
    log "  æ€»é…ç½®è¡Œæ•°: $total_configs"
    log "  å¯ç”¨è½¯ä»¶åŒ…: $enabled_packages"
    log "  æ¨¡å—åŒ–è½¯ä»¶åŒ…: $module_packages"
    log "  ç¦ç”¨è½¯ä»¶åŒ…: $disabled_packages"

    # =========================================================================
    # æ‰‹åŠ¨ç¦ç”¨ç‰¹å®šæ’ä»¶ï¼ˆvssr, ssr-plus, rclone, passwallï¼‰- å¢å¼ºç‰ˆ
    # =========================================================================
    log "ğŸ”§ æ‰‹åŠ¨ç¦ç”¨ luci-app-vssr, luci-app-ssr-plus, luci-app-rclone, luci-app-passwall åŠå…¶å­é€‰é¡¹"

    local forbidden_plugins=(
        "luci-app-vssr"
        "luci-app-ssr-plus"
        "luci-app-rclone"
        "luci-app-passwall"
    )

    # åˆ é™¤æ‰€æœ‰ç›¸å…³è¡Œï¼ˆåŒ…æ‹¬ä¸»åŒ…å’Œå­é€‰é¡¹ï¼‰
    for plugin in "${forbidden_plugins[@]}"; do
        sed -i "/^CONFIG_PACKAGE_${plugin}[=_ ]/d" .config
        sed -i "/^CONFIG_PACKAGE_${plugin}_/d" .config
        sed -i "/^# CONFIG_PACKAGE_${plugin}[=_ ]/d" .config
        # æ·»åŠ ç¦ç”¨æ ‡è®°ï¼ˆä»…ä¸»åŒ…ï¼Œå­é€‰é¡¹ä¼šè‡ªåŠ¨ç»§æ‰¿ï¼‰
        echo "# CONFIG_PACKAGE_${plugin} is not set" >> .config
    done

    # é¢å¤–æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ—§æ ¼å¼
    sed -i '/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_/d' .config
    sed -i '/CONFIG_PACKAGE_luci-app-vssr_INCLUDE_/d' .config
    sed -i '/CONFIG_PACKAGE_luci-app-rclone_INCLUDE_/d' .config
    sed -i '/CONFIG_PACKAGE_luci-app-passwall_INCLUDE_/d' .config

    # å»é‡
    sort .config | uniq > .config.tmp && mv .config.tmp .config

    log "ğŸ”„ è¿è¡Œ make defconfig ä»¥åº”ç”¨ç¦ç”¨..."
    make defconfig > /tmp/build-logs/defconfig_disable.log 2>&1 || {
        log "âš ï¸ make defconfig è­¦å‘Šï¼Œä½†ç»§ç»­"
    }

    # å†æ¬¡æ£€æŸ¥å¹¶å¼ºåˆ¶ç¦ç”¨ï¼ˆé˜²æ­¢ä¾èµ–é‡æ–°å¼•å…¥ï¼‰
    for plugin in "${forbidden_plugins[@]}"; do
        # å¦‚æœä»ç„¶å­˜åœ¨å¯ç”¨è¡Œï¼Œåˆ™å†æ¬¡åˆ é™¤å¹¶æ·»åŠ ç¦ç”¨æ ‡è®°
        if grep -q "^CONFIG_PACKAGE_${plugin}=y" .config || grep -q "^CONFIG_PACKAGE_${plugin}=m" .config; then
            sed -i "/^CONFIG_PACKAGE_${plugin}[=_ ]/d" .config
            echo "# CONFIG_PACKAGE_${plugin} is not set" >> .config
        fi
        # åˆ é™¤æ‰€æœ‰å­é€‰é¡¹ï¼ˆæ— è®ºçŠ¶æ€ï¼‰
        sed -i "/^CONFIG_PACKAGE_${plugin}_/d" .config
    done

    sort .config | uniq > .config.tmp && mv .config.tmp .config

    log "âœ… æ’ä»¶ç¦ç”¨å®Œæˆ"

    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘

