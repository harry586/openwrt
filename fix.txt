#ã€build_firmware_main.sh-06ã€‘
initialize_build_env() {
    local device_name=$1
    local version_selection=$2
    local config_mode=$3
    
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ç‰ˆæœ¬é€‰æ‹© ==="
    if [ "$version_selection" = "23.05" ]; then
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-23.05"
    else
        SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        SELECTED_BRANCH="openwrt-21.02"
    fi
    log "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH"
    
    log "=== å…‹éš†æºç  ==="
    log "ä»“åº“: $SELECTED_REPO_URL"
    log "åˆ†æ”¯: $SELECTED_BRANCH"
    
    sudo rm -rf ./* ./.git* 2>/dev/null || true
    
    git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . || handle_error "å…‹éš†æºç å¤±è´¥"
    log "âœ… æºç å…‹éš†å®Œæˆ"
    
    local important_source_files=("Makefile" "feeds.conf.default" "rules.mk" "Config.in")
    for file in "${important_source_files[@]}"; do
        if [ -f "$file" ]; then
            log "âœ… æºç æ–‡ä»¶å­˜åœ¨: $file"
        else
            log "âŒ æºç æ–‡ä»¶ç¼ºå¤±: $file"
        fi
    done
    
    log "=== è®¾å¤‡é…ç½® ==="
    if [ -f "$SUPPORT_SCRIPT" ]; then
        log "ğŸ” è°ƒç”¨support.shè·å–è®¾å¤‡å¹³å°ä¿¡æ¯..."
        PLATFORM_INFO=$("$SUPPORT_SCRIPT" get-platform "$device_name")
        if [ -n "$PLATFORM_INFO" ]; then
            TARGET=$(echo "$PLATFORM_INFO" | awk '{print $1}')
            SUBTARGET=$(echo "$PLATFORM_INFO" | awk '{print $2}')
            DEVICE="$device_name"
            log "âœ… ä»support.shè·å–å¹³å°ä¿¡æ¯: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
        else
            log "âŒ æ— æ³•ä»support.shè·å–å¹³å°ä¿¡æ¯"
            handle_error "è·å–å¹³å°ä¿¡æ¯å¤±è´¥"
        fi
    else
        log "âŒ support.shä¸å­˜åœ¨"
        handle_error "support.shè„šæœ¬ç¼ºå¤±"
    fi
    
    log "ğŸ”§ è®¾å¤‡: $device_name"
    log "ğŸ”§ ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    
    CONFIG_MODE="$config_mode"
    
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶ç¼–è¯‘scripts/configå·¥å…·ï¼Œå¤šé‡ä¿éšœ
    log "=== å¼ºåˆ¶ç¼–è¯‘é…ç½®å·¥å…· ==="
    
    # æ–¹æ³•1: ç›´æ¥ç¼–è¯‘
    log "ğŸ”§ å°è¯•æ–¹æ³•1: make scripts/config"
    if make scripts/config; then
        log "âœ… æ–¹æ³•1æˆåŠŸ: scripts/configå·¥å…·ç¼–è¯‘æˆåŠŸ"
    else
        log "âš ï¸ æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2..."
        
        # æ–¹æ³•2: åˆ›å»ºscriptsç›®å½•å¹¶æ‰‹åŠ¨å¤åˆ¶
        mkdir -p scripts
        if [ -f "scripts/config.guess" ] && [ -f "scripts/config.sub" ]; then
            log "ğŸ”§ å°è¯•æ–¹æ³•2: æ‰‹åŠ¨åˆ›å»ºconfigè„šæœ¬"
            cat > scripts/config << 'EOF'
#!/bin/sh
# Minimal config script for OpenWrt
SCRIPT_DIR=$(dirname "$0")
case "$1" in
    --enable)
        shift
        echo "CONFIG_$1=y" >> .config
        ;;
    --disable)
        shift
        echo "# CONFIG_$1 is not set" >> .config
        ;;
    --module)
        shift
        echo "CONFIG_$1=m" >> .config
        ;;
    --set-str)
        shift
        echo "CONFIG_$1=\"$2\"" >> .config
        shift
        ;;
esac
EOF
            chmod +x scripts/config
            log "âœ… æ–¹æ³•2æˆåŠŸ: æ‰‹åŠ¨åˆ›å»ºscripts/configå·¥å…·"
        else
            log "âš ï¸ æ–¹æ³•2å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3..."
            
            # æ–¹æ³•3: ä»å·²ç¼–è¯‘çš„SDKä¸­å¤åˆ¶
            if [ -n "$COMPILER_DIR" ] && [ -f "$COMPILER_DIR/scripts/config" ]; then
                log "ğŸ”§ å°è¯•æ–¹æ³•3: ä»SDKç›®å½•å¤åˆ¶"
                cp "$COMPILER_DIR/scripts/config" scripts/
                chmod +x scripts/config
                log "âœ… æ–¹æ³•3æˆåŠŸ: ä»SDKå¤åˆ¶scripts/configå·¥å…·"
            else
                log "âš ï¸ æ–¹æ³•3å¤±è´¥ï¼Œå°è¯•æ–¹æ³•4..."
                
                # æ–¹æ³•4: æœ€ç®€å•çš„fallback - åˆ›å»ºç©ºæ–‡ä»¶ï¼Œæ­¥éª¤13ä¼šå¤„ç†
                log "ğŸ”§ å°è¯•æ–¹æ³•4: åˆ›å»ºå ä½æ–‡ä»¶"
                touch scripts/config
                chmod +x scripts/config
                log "âš ï¸ æ–¹æ³•4: åˆ›å»ºå ä½æ–‡ä»¶ï¼Œæ­¥éª¤13å°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
            fi
        fi
    fi
    
    # æœ€ç»ˆéªŒè¯
    if [ -f "scripts/config" ] && [ -x "scripts/config" ]; then
        log "âœ… scripts/configå·¥å…·æœ€ç»ˆéªŒè¯é€šè¿‡"
        ls -la scripts/config
    else
        log "âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œscripts/configå·¥å…·ä¸å­˜åœ¨"
        handle_error "æ— æ³•åˆ›å»ºscripts/configå·¥å…·"
    fi
    
    save_env
    
    echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
    echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
    echo "TARGET=$TARGET" >> $GITHUB_ENV
    echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
    echo "DEVICE=$DEVICE" >> $GITHUB_ENV
    echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
    
    log "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}
#ã€build_firmware_main.sh-06-endã€‘

#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆå…¼å®¹ç‰ˆï¼‰==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    # åˆ é™¤æ—§é…ç½®
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # ç”ŸæˆåŸºç¡€ç›®æ ‡é…ç½®
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y
EOF
    
    log "ğŸ”§ ç”ŸæˆåŸºç¡€é…ç½®..."
    make defconfig || handle_error "åŸºç¡€é…ç½®ç”Ÿæˆå¤±è´¥"
    log "âœ… åŸºç¡€é…ç½®ç”ŸæˆæˆåŠŸ"
    
    # ğŸ”¥ éªŒè¯scripts/configå·¥å…·ï¼Œå¦‚æœä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œï¼Œé‡æ–°åˆ›å»º
    if [ ! -f "scripts/config" ] || [ ! -x "scripts/config" ]; then
        log "âš ï¸ scripts/configå·¥å…·ä¸å¯ç”¨ï¼Œé‡æ–°åˆ›å»º..."
        mkdir -p scripts
        cat > scripts/config << 'EOF'
#!/bin/sh
# Minimal config script for OpenWrt
SCRIPT_DIR=$(dirname "$0")
case "$1" in
    --enable)
        shift
        echo "CONFIG_$1=y" >> .config
        ;;
    --disable)
        shift
        echo "# CONFIG_$1 is not set" >> .config
        ;;
    --module)
        shift
        echo "CONFIG_$1=m" >> .config
        ;;
    --set-str)
        shift
        echo "CONFIG_$1=\"$2\"" >> .config
        shift
        ;;
esac
EOF
        chmod +x scripts/config
        log "âœ… scripts/configå·¥å…·é‡æ–°åˆ›å»ºæˆåŠŸ"
    fi
    
    log "ğŸ”§ ä½¿ç”¨scripts/configå·¥å…·åˆå¹¶é…ç½®..."
    
    # 1. åº”ç”¨USBé€šç”¨é…ç½®
    if [ -f "$CONFIG_DIR/usb-generic.config" ]; then
        log "ğŸ“ åº”ç”¨USBé€šç”¨é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$CONFIG_DIR/usb-generic.config"
        log "âœ… USBé€šç”¨é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    # 2. åº”ç”¨åŸºç¡€é…ç½®
    if [ -f "$CONFIG_DIR/base.config" ]; then
        log "ğŸ“ åº”ç”¨åŸºç¡€é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$CONFIG_DIR/base.config"
        log "âœ… åŸºç¡€é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    # 3. åº”ç”¨è®¾å¤‡é…ç½®æˆ–æ¨¡å¼é…ç½®
    local device_config_file="$CONFIG_DIR/devices/$DEVICE.config"
    if [ -f "$device_config_file" ]; then
        log "ğŸ“ åº”ç”¨è®¾å¤‡é…ç½®: $DEVICE.config..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$device_config_file"
        log "âœ… è®¾å¤‡é…ç½®åº”ç”¨å®Œæˆ"
    elif [ "$CONFIG_MODE" = "normal" ] && [ -f "$CONFIG_DIR/normal.config" ]; then
        log "ğŸ“ åº”ç”¨æ­£å¸¸æ¨¡å¼é…ç½®..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            # è·³è¿‡TurboACCé™æ€é…ç½®
            if echo "$line" | grep -q "luci-app-turboacc\|kmod-shortcut-fe\|kmod-fast-classifier"; then
                continue
            fi
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$CONFIG_DIR/normal.config"
        log "âœ… æ­£å¸¸æ¨¡å¼é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    # 4. åº”ç”¨å¹³å°ä¸“ç”¨é…ç½®
    local platform_config=""
    if [ -f "$CONFIG_DIR/devices/$TARGET.config" ]; then
        platform_config="$CONFIG_DIR/devices/$TARGET.config"
    else
        platform_config=$(find "$CONFIG_DIR" -type f -name "*${TARGET}*.config" 2>/dev/null | grep -v "usb-generic" | grep -v "base" | grep -v "normal" | head -1)
    fi
    
    if [ -n "$platform_config" ] && [ -f "$platform_config" ]; then
        log "ğŸ“ åº”ç”¨å¹³å°é…ç½®: $(basename "$platform_config")..."
        while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            [ -z "$line" ] && continue
            
            if echo "$line" | grep -q "^CONFIG_.*=y$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --enable "$config_name"
            elif echo "$line" | grep -q "^CONFIG_.*=m$"; then
                config_name=$(echo "$line" | cut -d'=' -f1 | cut -d'_' -f2-)
                ./scripts/config --module "$config_name"
            elif echo "$line" | grep -q "^# CONFIG_.* is not set$"; then
                config_name=$(echo "$line" | sed 's/^# CONFIG_//' | sed 's/ is not set//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ./scripts/config --disable "$config_name"
            fi
        done < "$platform_config"
        log "âœ… å¹³å°é…ç½®åº”ç”¨å®Œæˆ"
    fi
    
    # 5. æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '\n' | while read pkg; do
            if [ -n "$pkg" ]; then
                ./scripts/config --enable "PACKAGE_$pkg"
                log "âœ… æ·»åŠ åŒ…: $pkg"
            fi
        done
    fi
    
    # 6. å¼ºåˆ¶å¯ç”¨å…³é”®é…ç½®
    log "ğŸ”§ å¼ºåˆ¶å¯ç”¨å…³é”®é…ç½®..."
    ./scripts/config --enable PACKAGE_kmod-usb-xhci-hcd
    ./scripts/config --enable PACKAGE_kmod-usb3
    ./scripts/config --enable PACKAGE_kmod-tcp-bbr
    ./scripts/config --set-str DEFAULT_TCP_CONG "bbr"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        ./scripts/config --enable PACKAGE_luci-app-turboacc
        ./scripts/config --enable PACKAGE_kmod-shortcut-fe
        ./scripts/config --enable PACKAGE_kmod-fast-classifier
        log "âœ… TurboACCé…ç½®å¼ºåˆ¶å¯ç”¨å®Œæˆ"
    fi
    
    # 7. å¤„ç†ath10kå†²çª
    ./scripts/config --disable PACKAGE_kmod-ath10k
    ./scripts/config --disable PACKAGE_kmod-ath10k-pci
    ./scripts/config --disable PACKAGE_kmod-ath10k-smallbuffers
    ./scripts/config --disable PACKAGE_kmod-ath10k-ct-smallbuffers
    ./scripts/config --enable PACKAGE_kmod-ath10k-ct
    log "âœ… ath10kå†²çªä¿®å¤å®Œæˆ"
    
    # 8. æœ€ç»ˆdefconfig
    log "ğŸ”„ è¿è¡Œæœ€ç»ˆ make defconfig..."
    make defconfig || handle_error "æœ€ç»ˆé…ç½®åº”ç”¨å¤±è´¥"
    
    log "ğŸ“Š é…ç½®ç”Ÿæˆç»Ÿè®¡:"
    log "  - æœ€ç»ˆé…ç½®æ–‡ä»¶: .config"
    log "  - é…ç½®è¡Œæ•°: $(wc -l < .config)"
    log "  - é…ç½®æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘

#ã€build_firmware_main.sh-31ã€‘
workflow_step15_generate_config() {
    local extra_packages="$1"
    
    log "=== æ­¥éª¤15: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆå…¼å®¹ç‰ˆï¼‰==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤15 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    generate_config "$extra_packages"
    
    log "âœ… æ­¥éª¤15 å®Œæˆ"
}
#ã€build_firmware_main.sh-31-endã€‘
