#ã€build_firmware_main.sh-13ã€‘
generate_config() {
    local extra_packages=$1
    local device_override=$2  # æ–°å¢è®¾å¤‡è¦†ç›–å‚æ•°
    
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    # å¦‚æœæä¾›äº†è®¾å¤‡è¦†ç›–å‚æ•°ï¼Œä¼˜å…ˆä½¿ç”¨
    if [ -n "$device_override" ]; then
        DEVICE="$device_override"
        log "ğŸ”§ ä½¿ç”¨è®¾å¤‡è¦†ç›–å‚æ•°: $DEVICE"
    fi
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆè®¾å¤‡æ˜¾å¼æŒ‡å®šç‰ˆï¼‰ ==="
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "é…ç½®æ–‡ä»¶ç›®å½•: $CONFIG_DIR"
    
    # éªŒè¯è®¾å¤‡å˜é‡æ˜¯å¦ä¸ºç©º
    if [ -z "$DEVICE" ]; then
        log "âŒ é”™è¯¯: DEVICEå˜é‡ä¸ºç©ºï¼"
        log "å¯ç”¨ç¯å¢ƒå˜é‡:"
        env | grep -E "DEVICE|TARGET|SELECTED" || true
        handle_error "DEVICEå˜é‡æœªè®¾ç½®"
    fi
    
    rm -f .config .config.old .config.bak*
    log "âœ… å·²æ¸…ç†æ—§é…ç½®æ–‡ä»¶"
    
    # æ­¥éª¤1: æ ¹æ®è®¾å¤‡åæ˜ å°„åˆ°æ­£ç¡®çš„OpenWrtè®¾å¤‡é…ç½®åï¼ˆä¿æŒå°å†™ï¼‰
    local openwrt_device=""
    case "$DEVICE" in
        ac42u|rt-ac42u|asus_rt-ac42u)
            openwrt_device="asus_rt-ac42u"
            log "ğŸ”§ æ˜ å°„è®¾å¤‡ $DEVICE -> $openwrt_device"
            ;;
        acrh17|rt-acrh17|asus_rt-acrh17)
            openwrt_device="asus_rt-acrh17"
            log "ğŸ”§ æ˜ å°„è®¾å¤‡ $DEVICE -> $openwrt_device"
            ;;
        *)
            # é»˜è®¤ä½¿ç”¨åŸè®¾å¤‡åï¼Œä½†è½¬æ¢ä¸ºOpenWrtæ ¼å¼ï¼ˆå…¨éƒ¨å°å†™ï¼Œä¸‹åˆ’çº¿ï¼‰
            openwrt_device=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
            log "ğŸ”§ ä½¿ç”¨è½¬æ¢åçš„è®¾å¤‡å: $openwrt_device"
            ;;
    esac
    
    # ç›´æ¥ä½¿ç”¨å°å†™çš„è®¾å¤‡å
    local device_lower="$openwrt_device"
    local device_config="CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}"
    
    log "ğŸ”§ è®¾å¤‡é…ç½®å˜é‡: $device_config=y"
    
    # æ­¥éª¤2: åˆ›å»ºåŸºç¡€ç›®æ ‡é…ç½® - ä½¿ç”¨å°å†™è®¾å¤‡å
    cat > .config << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
${device_config}=y
EOF
    
    log "ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶å†…å®¹:"
    cat .config
    
    # æ­¥éª¤3: åˆå¹¶æ‰€æœ‰é…ç½®æ–‡ä»¶
    log "ğŸ“ å¼€å§‹åˆå¹¶é…ç½®æ–‡ä»¶..."
    
    # è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è¿½åŠ é…ç½®ï¼ˆè¿‡æ»¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
    append_config() {
        local file=$1
        if [ -f "$file" ]; then
            grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' | grep 'CONFIG_' >> .config
        fi
    }
    
    append_config "$CONFIG_DIR/base.config"
    append_config "$CONFIG_DIR/usb-generic.config"
    append_config "$CONFIG_DIR/$TARGET.config"
    append_config "$CONFIG_DIR/$SELECTED_BRANCH.config"
    append_config "$CONFIG_DIR/devices/$DEVICE.config"
    
    if [ "$CONFIG_MODE" = "normal" ]; then
        append_config "$CONFIG_DIR/normal.config"
    fi
    
    # æ·»åŠ é¢å¤–åŒ…
    if [ -n "$extra_packages" ]; then
        log "ğŸ“¦ æ·»åŠ é¢å¤–åŒ…: $extra_packages"
        echo "$extra_packages" | tr ',' '
' | while read pkg; do
            [ -n "$pkg" ] && echo "CONFIG_PACKAGE_$pkg=y" >> .config
        done
    fi
    
    # æ ¹æ®config.txtæ·»åŠ ASUS RT-AC42Uç‰¹å®šé…ç½®
    if [ "$openwrt_device" = "asus_rt-ac42u" ] || [ "$openwrt_device" = "asus_rt-acrh17" ]; then
        log "ğŸ“‹ åº”ç”¨ASUS RT-AC42U/ACRH17ç‰¹å®šé…ç½®..."
        
        # åŸºç¡€ä¾èµ–åº“
        echo "CONFIG_GNUTLS_ALPN=y" >> .config
        echo "CONFIG_GNUTLS_ANON=y" >> .config
        echo "CONFIG_GNUTLS_CRYPTODEV=y" >> .config
        echo "CONFIG_GNUTLS_DTLS_SRTP=y" >> .config
        echo "CONFIG_GNUTLS_HEARTBEAT=y" >> .config
        echo "CONFIG_GNUTLS_OCSP=y" >> .config
        echo "CONFIG_GNUTLS_PSK=y" >> .config
        
        # libcurlé…ç½®
        echo "CONFIG_LIBCURL_COOKIES=y" >> .config
        echo "CONFIG_LIBCURL_CRYPTO_AUTH=y" >> .config
        echo "CONFIG_LIBCURL_FILE=y" >> .config
        echo "CONFIG_LIBCURL_FTP=y" >> .config
        echo "CONFIG_LIBCURL_HTTP=y" >> .config
        echo "CONFIG_LIBCURL_NGHTTP2=y" >> .config
        echo "CONFIG_LIBCURL_OPENSSL=y" >> .config
        echo "CONFIG_LIBCURL_PROXY=y" >> .config
        echo "CONFIG_LIBCURL_TFTP=y" >> .config
        echo "CONFIG_LIBCURL_THREADED_RESOLVER=y" >> .config
        echo "CONFIG_LIBCURL_TLS_SRP=y" >> .config
        echo "CONFIG_LIBCURL_UNIX_SOCKETS=y" >> .config
        
        # ath10ké©±åŠ¨å’Œå›ºä»¶
        echo "CONFIG_PACKAGE_ath10k-board-qca988x=y" >> .config
        echo "CONFIG_PACKAGE_ath10k-firmware-qca988x=y" >> .config
        
        # åŸºç¡€å·¥å…·
        echo "CONFIG_PACKAGE_attr=y" >> .config
        echo "CONFIG_PACKAGE_avahi-dbus-daemon=y" >> .config
        echo "CONFIG_PACKAGE_bash=y" >> .config
        echo "CONFIG_PACKAGE_blkid=y" >> .config
        echo "CONFIG_PACKAGE_blockd=y" >> .config
        echo "CONFIG_PACKAGE_bridge=y" >> .config
        echo "CONFIG_PACKAGE_btrfs-progs=y" >> .config
        echo "CONFIG_PACKAGE_cpulimit=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_dbus=y" >> .config
        echo "CONFIG_PACKAGE_hd-idle=y" >> .config
        echo "CONFIG_PACKAGE_ip-tiny=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> .config
        echo "CONFIG_PACKAGE_iputils-arping=y" >> .config
        echo "CONFIG_PACKAGE_jq=y" >> .config
        
        # å†…æ ¸æ¨¡å—
        echo "CONFIG_PACKAGE_kmod-crypto-acompress=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-autofs4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-btrfs=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ifb=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-conntrack-extra=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-ipopt=y" >> .config
        echo "CONFIG_PACKAGE_kmod-lib-crc32c=y" >> .config
        echo "CONFIG_PACKAGE_kmod-lib-lzo=y" >> .config
        echo "CONFIG_PACKAGE_kmod-lib-raid6=y" >> .config
        echo "CONFIG_PACKAGE_kmod-lib-xor=y" >> .config
        echo "CONFIG_PACKAGE_kmod-lib-zlib-deflate=y" >> .config
        echo "CONFIG_PACKAGE_kmod-lib-zlib-inflate=y" >> .config
        echo "CONFIG_PACKAGE_kmod-lib-zstd=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-cp936=y" >> .config
        echo "CONFIG_PACKAGE_kmod-sched-cake=y" >> .config
        echo "CONFIG_PACKAGE_kmod-sched-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-scsi-generic=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        
        # è¿™é‡Œå…ˆä¸æ·»åŠ USBå†…æ ¸é…ç½®ï¼Œç­‰ç¬¬ä¸€æ¬¡defconfigä¹‹åå†æ·»åŠ 
    fi
    
    # TCP BBRï¼ˆæ‰€æœ‰è®¾å¤‡éƒ½å¯ç”¨ï¼‰
    echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
    echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> .config
    
    # TurboACCï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰
    if [ "$CONFIG_MODE" = "normal" ]; then
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
    fi
    
    # ath10k å†²çªè§£å†³ï¼ˆä½¿ç”¨cté©±åŠ¨ï¼‰
    sed -i '/CONFIG_PACKAGE_kmod-ath10k=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-pci=y/d' .config
    sed -i '/CONFIG_PACKAGE_kmod-ath10k-smallbuffers=y/d' .config
    echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-pci is not set" >> .config
    echo "# CONFIG_PACKAGE_kmod-ath10k-smallbuffers is not set" >> .config
    echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
    
    # æ­¥éª¤4: ç¬¬ä¸€æ¬¡å»é‡
    log "ğŸ”„ ç¬¬ä¸€æ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤5: ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfigï¼ˆè¿™ä¼šé‡ç½®å†…æ ¸é…ç½®ï¼‰
    log "ğŸ”„ ç¬¬ä¸€æ¬¡è¿è¡Œ make defconfigï¼ˆåŠ è½½å¹³å°é»˜è®¤é…ç½®ï¼‰..."
    make defconfig > /tmp/build-logs/defconfig1.log 2>&1 || {
        log "âŒ ç¬¬ä¸€æ¬¡ make defconfig å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
        tail -50 /tmp/build-logs/defconfig1.log
        handle_error "ç¬¬ä¸€æ¬¡ä¾èµ–è§£å†³å¤±è´¥"
    }
    log "âœ… ç¬¬ä¸€æ¬¡ make defconfig æˆåŠŸ"
    
    # æ­¥éª¤6: ç°åœ¨æ·»åŠ USBå†…æ ¸é…ç½®ï¼ˆåœ¨defconfigä¹‹åå¼ºåˆ¶å†™å…¥ï¼‰
    if [ "$openwrt_device" = "asus_rt-ac42u" ] || [ "$openwrt_device" = "asus_rt-acrh17" ]; then
        log "ğŸ“‹ åœ¨defconfigä¹‹åå¼ºåˆ¶å†™å…¥USBå†…æ ¸é…ç½®..."
        
        # ========== USB 3.0/DWC3 å†…æ ¸é…ç½®ï¼ˆæŒ‰ä¸¥æ ¼ä¾èµ–é¡ºåºï¼‰ ==========
        echo "# ========== USB 3.0/DWC3 å†…æ ¸é…ç½®ï¼ˆå¼ºåˆ¶å†™å…¥ï¼‰ ==========" >> .config
        
        # 1. åŸºç¡€æ¶æ„å’Œå†…æ ¸ç»„ä»¶
        echo "# 1. åŸºç¡€æ¶æ„å’Œå†…æ ¸ç»„ä»¶" >> .config
        
        # é«˜é€šå¹³å°æ”¯æŒ
        echo "CONFIG_ARCH_QCOM=y" >> .config
        echo "CONFIG_ARCH_IPQ40XX=y" >> .config
        
        # è®¾å¤‡æ ‘æ”¯æŒ
        echo "CONFIG_OF=y" >> .config
        echo "CONFIG_OF_NET=y" >> .config
        
        # æ—¶é’Ÿæ¡†æ¶
        echo "CONFIG_COMMON_CLK=y" >> .config
        echo "CONFIG_COMMON_CLK_QCOM=y" >> .config
        
        # External Connectoræ¡†æ¶
        echo "CONFIG_EXTCON=y" >> .config
        echo "CONFIG_EXTCON_QCOM=y" >> .config
        echo "CONFIG_EXTCON_GPIO=y" >> .config
        echo "CONFIG_EXTCON_USB_GPIO=y" >> .config
        echo "CONFIG_EXTCON_USBC_CHARGER=y" >> .config
        
        # PHYæ¡†æ¶
        echo "CONFIG_GENERIC_PHY=y" >> .config
        
        # 2. USBæ ¸å¿ƒå±‚
        echo "# 2. USBæ ¸å¿ƒå±‚" >> .config
        echo "CONFIG_USB_SUPPORT=y" >> .config
        echo "CONFIG_USB_COMMON=y" >> .config
        echo "CONFIG_USB_ARCH_HAS_HCD=y" >> .config
        echo "CONFIG_USB=y" >> .config
        
        # USBæ§åˆ¶å™¨é©±åŠ¨
        echo "CONFIG_USB_EHCI_HCD=y" >> .config
        echo "CONFIG_USB_EHCI_ROOT_HUB_TT=y" >> .config
        echo "CONFIG_USB_OHCI_HCD=y" >> .config
        
        # XHCI USB 3.0æ§åˆ¶å™¨
        echo "CONFIG_USB_XHCI_HCD=y" >> .config
        echo "CONFIG_USB_XHCI_PCI=y" >> .config
        echo "CONFIG_USB_XHCI_PLATFORM=y" >> .config
        echo "CONFIG_USB_XHCI_QCOM=y" >> .config
        
        # 3. DWC3æ ¸å¿ƒé©±åŠ¨
        echo "# 3. DWC3æ ¸å¿ƒé©±åŠ¨" >> .config
        echo "CONFIG_USB_DWC3=y" >> .config
        echo "CONFIG_USB_DWC3_DUAL_ROLE=y" >> .config
        echo "CONFIG_USB_DWC3_HOST=y" >> .config
        echo "CONFIG_USB_DWC3_GADGET=y" >> .config
        echo "CONFIG_USB_DWC3_ULPI=y" >> .config
        echo "CONFIG_USB_DWC3_DEBUG=y" >> .config
        echo "CONFIG_USB_DWC3_VERBOSE=y" >> .config
        
        # 4. DWC3å¹³å°èƒ¶æ°´å±‚
        echo "# 4. DWC3å¹³å°èƒ¶æ°´å±‚" >> .config
        echo "CONFIG_USB_DWC3_OF_SIMPLE=y" >> .config
        echo "CONFIG_USB_DWC3_QCOM=y" >> .config
        
        # 5. PHYé©±åŠ¨
        echo "# 5. PHYé©±åŠ¨" >> .config
        echo "CONFIG_PHY_QCOM_DWC3=y" >> .config
        echo "CONFIG_PHY_QCOM_USB_HS=y" >> .config
        echo "CONFIG_PHY_QCOM_USB_HSIC=y" >> .config
        echo "CONFIG_PHY_QCOM_USB_SS=y" >> .config
        
        # 6. USBè½¯ä»¶åŒ…ï¼ˆkmodï¼‰- ç¡®ä¿å­˜åœ¨
        echo "# 6. USBè½¯ä»¶åŒ…" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-common=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-ehci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-ohci-pci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-xhci-pci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage-uas=y" >> .config
        echo "CONFIG_PACKAGE_kmod-scsi-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-scsi-generic=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
        echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
        
        # USBä¸²å£é©±åŠ¨
        echo "CONFIG_PACKAGE_kmod-usb-serial=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-serial-ftdi=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-serial-pl2303=y" >> .config
        
        # æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-exfat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config
        
        # ç¼–ç æ”¯æŒ
        echo "CONFIG_PACKAGE_kmod-nls-utf8=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-cp936=y" >> .config
        
        # æŒ‚è½½å·¥å…·
        echo "CONFIG_PACKAGE_block-mount=y" >> .config
        echo "CONFIG_PACKAGE_automount=y" >> .config
        
        # USBå®ç”¨å·¥å…·
        echo "CONFIG_PACKAGE_usbutils=y" >> .config
        echo "CONFIG_PACKAGE_lsusb=y" >> .config
        
        # åº“æ–‡ä»¶
        echo "CONFIG_PACKAGE_libatomic=y" >> .config
        echo "CONFIG_PACKAGE_libattr=y" >> .config
        echo "CONFIG_PACKAGE_libavahi-client=y" >> .config
        echo "CONFIG_PACKAGE_libavahi-dbus-support=y" >> .config
        echo "CONFIG_PACKAGE_libcap=y" >> .config
        echo "CONFIG_PACKAGE_libcurl=y" >> .config
        echo "CONFIG_PACKAGE_libdaemon=y" >> .config
        echo "CONFIG_PACKAGE_libdbus=y" >> .config
        echo "CONFIG_PACKAGE_libevdev=y" >> .config
        echo "CONFIG_PACKAGE_libexpat=y" >> .config
        echo "CONFIG_PACKAGE_libgnutls=y" >> .config
        echo "CONFIG_PACKAGE_liblzo=y" >> .config
        echo "CONFIG_PACKAGE_libmount=y" >> .config
        echo "CONFIG_PACKAGE_libncurses=y" >> .config
        echo "CONFIG_PACKAGE_libnghttp2=y" >> .config
        echo "CONFIG_PACKAGE_libpopt=y" >> .config
        echo "CONFIG_PACKAGE_libreadline=y" >> .config
        echo "CONFIG_PACKAGE_libsmartcols=y" >> .config
        echo "CONFIG_PACKAGE_libtasn1=y" >> .config
        echo "CONFIG_PACKAGE_libtirpc=y" >> .config
        echo "CONFIG_PACKAGE_libudev-zero=y" >> .config
        echo "CONFIG_PACKAGE_liburing=y" >> .config
        echo "CONFIG_PACKAGE_libusb-1.0=y" >> .config
        echo "CONFIG_PACKAGE_libwolfssl=y" >> .config
        echo "CONFIG_PACKAGE_lsblk=y" >> .config
        
        # Luciåº”ç”¨ï¼ˆå…¨é¢å¯ç”¨ï¼‰
        echo "CONFIG_PACKAGE_luci-app-accesscontrol=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-arpbind=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-cpulimit=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-diskman=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-hd-idle=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-sqm=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vlmcsd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wechatpush=y" >> .config
        
        # Luciä¸­æ–‡è¯­è¨€åŒ…
        echo "CONFIG_PACKAGE_luci-i18n-accesscontrol-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-arpbind-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-cpulimit-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-diskman-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-hd-idle-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-samba4-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-sqm-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-vlmcsd-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-vsftpd-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-wechatpush-zh-cn=y" >> .config
        
        # æœåŠ¡å’Œåº”ç”¨
        echo "CONFIG_PACKAGE_miniupnpd=y" >> .config
        echo "CONFIG_PACKAGE_parted=y" >> .config
        echo "CONFIG_PACKAGE_samba4-libs=y" >> .config
        echo "CONFIG_PACKAGE_samba4-server=y" >> .config
        echo "CONFIG_PACKAGE_smartdns=y" >> .config
        echo "CONFIG_PACKAGE_smartmontools=y" >> .config
        echo "CONFIG_PACKAGE_sqm-scripts=y" >> .config
        echo "CONFIG_PACKAGE_tc-mod-iptables=y" >> .config
        echo "CONFIG_PACKAGE_tc-tiny=y" >> .config
        echo "CONFIG_PACKAGE_terminfo=y" >> .config
        echo "CONFIG_PACKAGE_uclibcxx=y" >> .config
        echo "CONFIG_PACKAGE_usbids=y" >> .config
        echo "CONFIG_PACKAGE_usbutils=y" >> .config
        echo "CONFIG_PACKAGE_vlmcsd=y" >> .config
        echo "CONFIG_PACKAGE_vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
        echo "CONFIG_PACKAGE_wsdd2=y" >> .config
        
        # æœåŠ¡é…ç½®é€‰é¡¹
        echo "CONFIG_PARTED_READLINE=y" >> .config
        echo "CONFIG_SAMBA4_SERVER_AVAHI=y" >> .config
        echo "CONFIG_SAMBA4_SERVER_NETBIOS=y" >> .config
        echo "CONFIG_SAMBA4_SERVER_VFS=y" >> .config
        echo "CONFIG_SAMBA4_SERVER_WSDD2=y" >> .config
        echo "CONFIG_WOLFSSL_HAS_NO_HW=y" >> .config
        echo "CONFIG_WPA_WOLFSSL=y" >> .config
        
        # ç¡®ä¿wpad-opensslæ˜¯æ¨¡å—åŒ–è€Œä¸æ˜¯å†…ç½®
        echo "CONFIG_PACKAGE_wpad-openssl=m" >> .config
        
        # ç¦ç”¨ä¸å…¼å®¹çš„USBé©±åŠ¨
        echo "# CONFIG_PACKAGE_kmod-usb-xhci-mtk is not set" >> .config
    fi
    
    # æ­¥éª¤7: ç¬¬äºŒæ¬¡å»é‡
    log "ğŸ”„ ç¬¬äºŒæ¬¡å»é‡é…ç½®..."
    sort .config | uniq > .config.tmp
    mv .config.tmp .config
    
    # æ­¥éª¤8: ç¬¬äºŒæ¬¡è¿è¡Œ make defconfigï¼ˆåº”ç”¨å¼ºåˆ¶é…ç½®ï¼‰
    log "ğŸ”„ ç¬¬äºŒæ¬¡è¿è¡Œ make defconfigï¼ˆåº”ç”¨å¼ºåˆ¶é…ç½®ï¼‰..."
    make defconfig > /tmp/build-logs/defconfig2.log 2>&1 || {
        log "âš ï¸ ç¬¬äºŒæ¬¡ make defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­..."
    }
    log "âœ… ç¬¬äºŒæ¬¡ make defconfig å®Œæˆ"
    
    # æ­¥éª¤9: éªŒè¯å…³é”®USBé©±åŠ¨æ˜¯å¦è¢«æ­£ç¡®å¯ç”¨
    log "ğŸ” éªŒè¯å…³é”®USBé©±åŠ¨çŠ¶æ€..."
    
    local critical_usb_drivers=(
        "kmod-usb-core"
        "kmod-usb-common"
        "kmod-usb2"
        "kmod-usb3"
        "kmod-usb-xhci-hcd"
        "kmod-usb-storage"
        "kmod-scsi-core"
        "kmod-usb-dwc3"
        "kmod-usb-dwc3-of-simple"
        "kmod-usb-dwc3-qcom"
        "kmod-phy-qcom-dwc3"
    )
    
    local missing_drivers=()
    for driver in "${critical_usb_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            log "  âœ… $driver: å·²å¯ç”¨"
        else
            log "  âŒ $driver: æœªå¯ç”¨"
            missing_drivers+=("$driver")
        fi
    done
    
    # å…ˆæŸ¥çœ‹.configä¸­å®é™…æœ‰å“ªäº›å†…æ ¸é…ç½®é€‰é¡¹ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    log "ğŸ” æŸ¥çœ‹.configä¸­çš„USBç›¸å…³å†…æ ¸é…ç½®é€‰é¡¹:"
    local usb_configs=$(grep -E "CONFIG_(USB|PHY|DWC|XHCI|QCOM|EXTCON|CLK|ARCH)" .config | grep -v "PACKAGE" | head -20)
    if [ -n "$usb_configs" ]; then
        echo "$usb_configs" | while read line; do
            log "    $line"
        done
    else
        log "    æœªæ‰¾åˆ°USBç›¸å…³å†…æ ¸é…ç½®"
    fi
    
    # æ£€æŸ¥å†…æ ¸é…ç½®çŠ¶æ€
    log "ğŸ” æ£€æŸ¥å†…æ ¸é…ç½®çŠ¶æ€:"
    
    # å®šä¹‰è¦æ£€æŸ¥çš„å†…æ ¸é…ç½®åŠå…¶å¯èƒ½çš„å˜ä½“
    local kernel_configs=(
        "ARCH_QCOM"
        "ARCH_IPQ40XX"
        "COMMON_CLK"
        "COMMON_CLK_QCOM"
        "EXTCON"
        "EXTCON_QCOM"
        "GENERIC_PHY"
        "USB_COMMON"
        "USB_XHCI_HCD"
        "USB_XHCI_QCOM"
        "USB_DWC3"
        "USB_DWC3_OF_SIMPLE"
        "USB_DWC3_QCOM"
        "PHY_QCOM_DWC3"
    )
    
    local missing_kernel=0
    for config in "${kernel_configs[@]}"; do
        if grep -q "^CONFIG_${config}=y" .config; then
            log "  âœ… ${config}: å·²å¯ç”¨"
        elif grep -q "^CONFIG_${config}=m" .config; then
            log "  ğŸ“¦ ${config}: æ¨¡å—åŒ–"
        elif grep -q "^# CONFIG_${config} is not set" .config; then
            log "  âŒ ${config}: å·²ç¦ç”¨"
            missing_kernel=$((missing_kernel + 1))
        else
            # å°è¯•æŸ¥æ‰¾ç±»ä¼¼çš„é…ç½®
            local similar=$(grep -E "^CONFIG_.*${config}.*=y" .config | head -1)
            if [ -n "$similar" ]; then
                log "  ğŸ” ${config} æœªæ‰¾åˆ°ï¼Œä½†æ‰¾åˆ°ç›¸ä¼¼é…ç½®: $similar"
            else
                log "  âšª ${config}: æœªæ‰¾åˆ°"
            fi
            missing_kernel=$((missing_kernel + 1))
        fi
    done
    
    if [ ${#missing_drivers[@]} -gt 0 ]; then
        log "âš ï¸ ä»æœ‰ ${#missing_drivers[@]} ä¸ªUSBé©±åŠ¨ç¼ºå¤±"
        if [ $missing_kernel -gt 0 ]; then
            log "â„¹ï¸ åŒæ—¶æœ‰ ${missing_kernel} ä¸ªå†…æ ¸é…ç½®ç¼ºå¤±æˆ–æœªæ‰¾åˆ°"
            log "â„¹ï¸ è¿™äº›é©±åŠ¨å¯èƒ½å› ä¸ºå†…æ ¸ç‰ˆæœ¬æˆ–å¹³å°é™åˆ¶æ— æ³•å¯ç”¨"
        else
            log "â„¹ï¸ ä½†å†…æ ¸é…ç½®éƒ½å·²å¯ç”¨ï¼Œé©±åŠ¨å¯èƒ½è¢«ä¸Šå±‚é…ç½®ç¦ç”¨"
        fi
        log "â„¹ï¸ åŸºæœ¬USBåŠŸèƒ½åº”è¯¥å·²ç»å¯ç”¨"
    else
        log "ğŸ‰ æ‰€æœ‰USBé©±åŠ¨éƒ½å·²æˆåŠŸå¯ç”¨ï¼"
    fi
    
    # æ­¥éª¤10: æœ€ç»ˆè®¾å¤‡éªŒè¯
    log "ğŸ” æ­£åœ¨éªŒè¯è®¾å¤‡ $openwrt_device æ˜¯å¦è¢«é€‰ä¸­..."
    
    if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
        log "âœ… ç›®æ ‡è®¾å¤‡å·²æ­£ç¡®å¯ç”¨: CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y"
    elif grep -q "^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} is not set" .config; then
        log "âš ï¸ è­¦å‘Š: è®¾å¤‡è¢«ç¦ç”¨ï¼Œå°è¯•å¼ºåˆ¶å¯ç”¨..."
        sed -i "/^# CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower} is not set/d" .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1
        
        if grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" .config; then
            log "âœ… è®¾å¤‡å·²å¼ºåˆ¶å¯ç”¨"
        else
            log "âŒ æ— æ³•å¯ç”¨è®¾å¤‡"
        fi
    else
        log "âš ï¸ è­¦å‘Š: è®¾å¤‡é…ç½®è¡Œæœªæ‰¾åˆ°ï¼Œæ‰‹åŠ¨æ·»åŠ ..."
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${device_lower}=y" >> .config
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        make defconfig > /dev/null 2>&1
    fi
    
    log "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}
#ã€build_firmware_main.sh-13-endã€‘
