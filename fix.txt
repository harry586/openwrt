#ã€build_firmware_main.sh-37ã€‘
workflow_step23_pre_build_check() {
    log "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆè°ƒç”¨åŠ¨æ€æŸ¥è¯¢æ¨¡å—ï¼‰ ==="
    
    set -e
    trap 'echo "âŒ æ­¥éª¤23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡:"
        echo "   SELECTED_BRANCH=$SELECTED_BRANCH"
        echo "   TARGET=$TARGET"
        echo "   SUBTARGET=$SUBTARGET"
        echo "   DEVICE=$DEVICE"
        echo "   CONFIG_MODE=$CONFIG_MODE"
        echo "   COMPILER_DIR=$COMPILER_DIR"
    else
        echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ ($BUILD_DIR/build_env.sh)"
        exit 1
    fi
    
    cd $BUILD_DIR
    echo ""
    echo "=== ğŸš¨ å‰ç½®é”™è¯¯åŠ¨æ€æ£€æµ‹ ==="
    echo ""
    
    local error_count=0
    local warning_count=0
    
    # =========================================================================
    # è°ƒç”¨åŠ¨æ€æŸ¥è¯¢æ¨¡å—è·å–è®¾å¤‡æ”¯æŒä¿¡æ¯
    # =========================================================================
    echo "0. ğŸ” åŠ¨æ€è·å–è®¾å¤‡æ”¯æŒä¿¡æ¯:"
    echo "----------------------------------------"
    
    # è°ƒç”¨æ­¥éª¤15ä¸­çš„åŠ¨æ€æŸ¥è¯¢å‡½æ•°
    local device_support_info=$(get_device_support_summary "$TARGET" "$SUBTARGET" "$DEVICE" 2>/dev/null || echo "")
    
    if [ -n "$device_support_info" ]; then
        echo "$device_support_info"
    else
        echo "   âš ï¸ æ— æ³•è·å–è®¾å¤‡æ”¯æŒä¿¡æ¯"
        warning_count=$((warning_count + 1))
    fi
    
    echo "----------------------------------------"
    echo ""
    
    # 1. æ£€æŸ¥é…ç½®æ–‡ä»¶
    echo "1. âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    if [ -f ".config" ]; then
        local config_size=$(ls -lh .config | awk '{print $5}')
        local config_lines=$(wc -l < .config)
        echo "   âœ… .config æ–‡ä»¶å­˜åœ¨"
        echo "   ğŸ“Š å¤§å°: $config_size, è¡Œæ•°: $config_lines"
        
        # æ£€æŸ¥è®¾å¤‡é…ç½®
        local device_upper=$(echo "$DEVICE" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
        if grep -q "CONFIG_TARGET_.*DEVICE.*${device_upper}=y" .config; then
            echo "   âœ… è®¾å¤‡é…ç½®æ­£ç¡®"
        else
            # å°è¯•å°å†™åŒ¹é…
            local device_lower=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
            if grep -q "CONFIG_TARGET_.*DEVICE.*${device_lower}=y" .config; then
                echo "   âœ… è®¾å¤‡é…ç½®æ­£ç¡® (å°å†™)"
            else
                echo "   âŒ è®¾å¤‡é…ç½®å¯èƒ½ä¸æ­£ç¡®"
                error_count=$((error_count + 1))
            fi
        fi
    else
        echo "   âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 2. æ£€æŸ¥SDK/ç¼–è¯‘å™¨
    echo "2. âœ… SDK/ç¼–è¯‘å™¨æ£€æŸ¥:"
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        echo "   âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
        local sdk_size=$(du -sh "$COMPILER_DIR" 2>/dev/null | awk '{print $1}')
        echo "   ğŸ“Š å¤§å°: $sdk_size"
        
        # æŸ¥æ‰¾çœŸæ­£çš„GCC
        local gcc_file=$(find "$COMPILER_DIR" -type f -executable -name "*gcc" ! -name "*gcc-ar" ! -name "*gcc-ranlib" ! -name "*gcc-nm" ! -path "*dummy-tools*" 2>/dev/null | head -1)
        if [ -n "$gcc_file" ]; then
            echo "   âœ… æ‰¾åˆ°GCC: $(basename "$gcc_file")"
            local gcc_version=$("$gcc_file" --version 2>&1 | head -1)
            echo "   ğŸ”§ ç‰ˆæœ¬: $gcc_version"
        else
            echo "   âŒ æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨"
            error_count=$((error_count + 1))
        fi
    else
        echo "   âŒ SDKç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 3. æ£€æŸ¥Feeds
    echo "3. âœ… Feedsæ£€æŸ¥:"
    if [ -d "feeds" ]; then
        local feeds_count=$(find feeds -maxdepth 1 -type d 2>/dev/null | wc -l)
        feeds_count=$((feeds_count - 1))  # å‡å»feedsç›®å½•æœ¬èº«
        echo "   âœ… feedsç›®å½•å­˜åœ¨, åŒ…å« $feeds_count ä¸ªfeed"
        
        # æ£€æŸ¥å…³é”®feed
        for feed in packages luci; do
            if [ -d "feeds/$feed" ]; then
                echo "   âœ… $feed feed: å­˜åœ¨"
            else
                echo "   âŒ $feed feed: ä¸å­˜åœ¨"
                warning_count=$((warning_count + 1))
            fi
        done
    else
        echo "   âŒ feedsç›®å½•ä¸å­˜åœ¨"
        error_count=$((error_count + 1))
    fi
    echo ""
    
    # 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
    echo "4. âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    local available_space=$(df /mnt --output=avail 2>/dev/null | tail -1 || df / --output=avail | tail -1)
    local available_gb=$((available_space / 1024 / 1024))
    echo "   ğŸ“Š å¯ç”¨ç©ºé—´: ${available_gb}G"
    
    if [ $available_gb -lt 5 ]; then
        echo "   âŒ ç©ºé—´ä¸¥é‡ä¸è¶³ (<5G)"
        error_count=$((error_count + 1))
    elif [ $available_gb -lt 10 ]; then
        echo "   âš ï¸ ç©ºé—´è¾ƒä½ (<10G)"
        warning_count=$((warning_count + 1))
    elif [ $available_gb -lt 20 ]; then
        echo "   âš ï¸ ç©ºé—´ä¸€èˆ¬ (<20G)"
        warning_count=$((warning_count + 1))
    else
        echo "   âœ… ç©ºé—´å……è¶³"
    fi
    echo ""
    
    # 5. æ£€æŸ¥å…³é”®USBé©±åŠ¨
    echo "5. âœ… USBé©±åŠ¨æ£€æŸ¥:"
    local critical_drivers=(
        "kmod-usb-core"
    )
    
    # æ ¹æ®å¹³å°æ·»åŠ å…³é”®é©±åŠ¨
    case "$TARGET" in
        ipq40xx|ipq806x|qcom)
            critical_drivers+=("kmod-usb-dwc3" "kmod-usb-dwc3-qcom")
            ;;
        mediatek|ramips)
            critical_drivers+=("kmod-usb-xhci-mtk")
            ;;
    esac
    
    local missing_usb=0
    for driver in "${critical_drivers[@]}"; do
        if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
            echo "   âœ… $driver: å·²å¯ç”¨"
        elif grep -q "^CONFIG_PACKAGE_${driver}=m" .config; then
            echo "   ğŸ“¦ $driver: æ¨¡å—åŒ–"
        else
            echo "   âŒ $driver: æœªå¯ç”¨"
            missing_usb=$((missing_usb + 1))
        fi
    done
    
    if [ $missing_usb -gt 0 ]; then
        echo "   âš ï¸ æœ‰ $missing_usb ä¸ªå…³é”®USBé©±åŠ¨ç¼ºå¤±"
        warning_count=$((warning_count + 1))
    fi
    echo ""
    
    # 6. æ£€æŸ¥å†…å­˜
    echo "6. âœ… å†…å­˜æ£€æŸ¥:"
    local mem_total=$(free -m | awk '/^Mem:/{print $2}')
    local mem_available=$(free -m | awk '/^Mem:/{print $7}')
    echo "   ğŸ“Š æ€»å†…å­˜: ${mem_total}MB, å¯ç”¨: ${mem_available}MB"
    
    if [ $mem_available -lt 512 ]; then
        echo "   âš ï¸ å¯ç”¨å†…å­˜ä¸è¶³ (<512MB)"
        warning_count=$((warning_count + 1))
    else
        echo "   âœ… å†…å­˜å……è¶³"
    fi
    echo ""
    
    # 7. æ£€æŸ¥CPU
    echo "7. âœ… CPUæ£€æŸ¥:"
    local cpu_cores=$(nproc)
    local cpu_model=$(grep "model name" /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs)
    echo "   ğŸ“Š æ ¸å¿ƒæ•°: $cpu_cores"
    echo "   ğŸ“Š å‹å·: $cpu_model"
    echo ""
    
    # 8. æ£€æŸ¥åˆ†æ”¯å…¼å®¹æ€§
    echo "8. âœ… åˆ†æ”¯å…¼å®¹æ€§æ£€æŸ¥:"
    local supported_branches=$(get_supported_branches 2>/dev/null || echo "")
    if [ -n "$supported_branches" ]; then
        if echo "$supported_branches" | grep -q "^$SELECTED_BRANCH$"; then
            echo "   âœ… å½“å‰åˆ†æ”¯ $SELECTED_BRANCH åœ¨æ”¯æŒåˆ—è¡¨ä¸­"
        else
            echo "   âš ï¸ å½“å‰åˆ†æ”¯ $SELECTED_BRANCH ä¸åœ¨æ”¯æŒåˆ—è¡¨ä¸­"
            warning_count=$((warning_count + 1))
        fi
    fi
    echo ""
    
    # 9. æ£€æŸ¥å†…æ ¸é…ç½®æ–‡ä»¶
    echo "9. âœ… å†…æ ¸é…ç½®æ–‡ä»¶æ£€æŸ¥:"
    local kernel_configs=$(find "target/linux/$TARGET" -type f -name "config-*" 2>/dev/null | wc -l)
    if [ $kernel_configs -gt 0 ]; then
        echo "   âœ… æ‰¾åˆ° $kernel_configs ä¸ªå†…æ ¸é…ç½®æ–‡ä»¶"
    else
        echo "   âš ï¸ æœªæ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶"
        warning_count=$((warning_count + 1))
    fi
    echo ""
    
    # æ±‡æ€»
    echo "========================================"
    if [ $error_count -gt 0 ]; then
        echo "âŒâŒâŒ æ£€æµ‹åˆ° $error_count ä¸ªé”™è¯¯ï¼Œè¯·ä¿®å¤åé‡è¯• âŒâŒâŒ"
        exit 1
    elif [ $warning_count -gt 0 ]; then
        echo "âš ï¸âš ï¸âš ï¸ æ£€æµ‹åˆ° $warning_count ä¸ªè­¦å‘Šï¼Œä½†å¯ä»¥ç»§ç»­ âš ï¸âš ï¸âš ï¸"
    else
        echo "âœ…âœ…âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘ âœ…âœ…âœ…"
    fi
    echo "========================================"
    
    log "âœ… æ­¥éª¤23 å®Œæˆ"
}

# ============================================================================
# è®¾å¤‡æ”¯æŒä¿¡æ¯æ‘˜è¦å‡½æ•°ï¼ˆåœ¨æ­¥éª¤15ä¸­ä½¿ç”¨ï¼‰
# ============================================================================
get_device_support_summary() {
    local platform="$1"
    local subtarget="$2"
    local device="$3"
    
    local summary=""
    
    # è·å–æ”¯æŒçš„åˆ†æ”¯
    local branches=$(get_supported_branches 2>/dev/null | head -3 | tr '\n' ' ' || echo "æœªçŸ¥")
    summary="${summary}   ğŸ“¦ æ”¯æŒçš„åˆ†æ”¯: $branches\n"
    
    # è·å–å­å¹³å°ä¿¡æ¯
    local subtargets=$(get_subtargets_by_platform "$SELECTED_BRANCH" "$platform" 2>/dev/null | head -5 | tr '\n' ' ' || echo "æœªçŸ¥")
    summary="${summary}   ğŸ“ å¹³å° $platform æ”¯æŒçš„å­å¹³å°: $subtargets\n"
    
    # è·å–è®¾å¤‡åŒ¹é…ä¿¡æ¯
    local match_level="none"
    local match_info=""
    
    # æ£€æŸ¥ç²¾ç¡®åŒ¹é…
    local exact_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "exact" 2>/dev/null)
    if echo "$exact_devices" | grep -q "^$device$"; then
        match_level="exact"
        match_info="âœ… ç²¾ç¡®åŒ¹é… (å­å¹³å° $subtarget ä¸“ç”¨)"
    fi
    
    # æ£€æŸ¥ç³»åˆ—åŒ¹é…
    if [ "$match_level" = "none" ]; then
        local series_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "series" 2>/dev/null)
        if echo "$series_devices" | grep -q "^$device$"; then
            match_level="series"
            match_info="ğŸ”„ ç³»åˆ—åŒ¹é… (é€‚ç”¨äº $subtarget ç³»åˆ—)"
        fi
    fi
    
    # æ£€æŸ¥é€šé…åŒ¹é…
    if [ "$match_level" = "none" ]; then
        local wildcard_devices=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "wildcard" 2>/dev/null)
        if echo "$wildcard_devices" | grep -q "^$device$"; then
            match_level="wildcard"
            match_info="ğŸ”— é€šé…åŒ¹é… (é€šè¿‡é€šé…è§„åˆ™)"
        fi
    fi
    
    if [ "$match_level" != "none" ]; then
        summary="${summary}   ğŸ“± è®¾å¤‡åŒ¹é…çŠ¶æ€: $match_info\n"
    else
        summary="${summary}   âš ï¸ è®¾å¤‡ $device æœªåœ¨åŒ¹é…åˆ—è¡¨ä¸­æ‰¾åˆ°\n"
    fi
    
    # è·å–è®¾å¤‡æ•°é‡ç»Ÿè®¡
    local exact_count=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "exact" 2>/dev/null | wc -l)
    local series_count=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "series" 2>/dev/null | wc -l)
    local wildcard_count=$(get_devices_by_subtarget "$SELECTED_BRANCH" "$platform" "$subtarget" "wildcard" 2>/dev/null | wc -l)
    
    summary="${summary}   ğŸ“Š åŒ¹é…ç»Ÿè®¡: ç²¾ç¡®=${exact_count}, ç³»åˆ—=${series_count}, é€šé…=${wildcard_count}\n"
    
    printf "%b" "$summary"
}

# è·å–æ‰€æœ‰æ”¯æŒçš„åˆ†æ”¯åˆ—è¡¨
get_supported_branches() {
    local branches=()
    
    # ä»é…ç½®æ–‡ä»¶ä¸­è·å–åˆ†æ”¯ä¿¡æ¯
    if [ -f "$REPO_ROOT/build-config.conf" ]; then
        while IFS= read -r line; do
            # æ–¹æ³•1: åŒ¹é… ${BRANCH_XX:=value} æ ¼å¼
            if [[ "$line" =~ :?\ \$\{BRANCH_[^=]+:=([^}]+)\} ]]; then
                local branch_name="${BASH_REMATCH[1]}"
                branches+=("$branch_name")
            # æ–¹æ³•2: åŒ¹é… export BRANCH_XX="value" æ ¼å¼
            elif [[ "$line" =~ export[[:space:]]+BRANCH_[^=]+=\"([^\"]+)\" ]]; then
                local branch_name="${BASH_REMATCH[1]}"
                branches+=("$branch_name")
            # æ–¹æ³•3: åŒ¹é… export BRANCH_XX=value æ ¼å¼
            elif [[ "$line" =~ export[[:space:]]+BRANCH_[^=]+=([^[:space:]]+) ]]; then
                local branch_name="${BASH_REMATCH[1]}"
                branches+=("$branch_name")
            fi
        done < "$REPO_ROOT/build-config.conf"
    fi
    
    # å¦‚æœé…ç½®æ–‡ä»¶æ²¡æœ‰ï¼Œä»gitè¿œç¨‹ä»“åº“è·å–
    if [ ${#branches[@]} -eq 0 ]; then
        if command -v git >/dev/null 2>&1; then
            # è·å–è¿œç¨‹åˆ†æ”¯
            local remote_branches=$(git ls-remote --heads "${IMMORTALWRT_URL:-https://github.com/immortalwrt/immortalwrt.git}" 2>/dev/null | \
                awk -F'/' '{print $NF}' | grep -E '^(openwrt-|main|master)' | sort -r | head -5)
            
            if [ -n "$remote_branches" ]; then
                while IFS= read -r branch; do
                    branches+=("$branch")
                done <<< "$remote_branches"
            fi
        fi
    fi
    
    # å»é‡å¹¶è¿”å›
    if [ ${#branches[@]} -gt 0 ]; then
        printf '%s\n' "${branches[@]}" | sort -u 2>/dev/null
    else
        echo "openwrt-23.05 openwrt-21.02"
    fi
}

# è·å–æŒ‡å®šå¹³å°ä¸‹çš„æ‰€æœ‰å­å¹³å°
get_subtargets_by_platform() {
    local branch="$1"
    local platform="$2"
    
    local subtargets=()
    local platform_path="target/linux/$platform"
    
    if [ -d "$platform_path" ]; then
        # æŸ¥æ‰¾å­å¹³å°ç›®å½•
        while IFS= read -r subtarget_dir; do
            if [ -n "$subtarget_dir" ]; then
                local subtarget=$(basename "$subtarget_dir")
                # è¿‡æ»¤æ‰éå­å¹³å°ç›®å½•
                case "$subtarget" in
                    image|base-files|config|patches|files|Makefile)
                        continue
                        ;;
                    *)
                        if [ -f "$subtarget_dir/target.mk" ] || [ -f "$subtarget_dir/Makefile" ]; then
                            subtargets+=("$subtarget")
                        fi
                        ;;
                esac
            fi
        done < <(find "$platform_path" -maxdepth 1 -type d ! -path "$platform_path" 2>/dev/null | sort)
        
        # å¦‚æœæ²¡æœ‰å­å¹³å°ç›®å½•ï¼Œæ£€æŸ¥Makefile
        if [ ${#subtargets[@]} -eq 0 ] && [ -f "$platform_path/Makefile" ]; then
            # ä»Makefileä¸­æå–SUBTARGETå®šä¹‰
            local default_subtarget=$(grep -E '^[[:space:]]*SUBTARGETS?[[:space:]]*:?=' "$platform_path/Makefile" 2>/dev/null | \
                sed 's/.*=[[:space:]]*//' | tr -d ' ' | tr ',' ' ')
            
            if [ -n "$default_subtarget" ]; then
                for st in $default_subtarget; do
                    [ -n "$st" ] && subtargets+=("$st")
                done
            else
                subtargets+=("generic")
            fi
        fi
    fi
    
    # è¿”å›ç»“æœ
    if [ ${#subtargets[@]} -gt 0 ]; then
        printf '%s\n' "${subtargets[@]}" | sort -u 2>/dev/null | head -10
    else
        echo "generic"
    fi
}

# æå–å­å¹³å°çš„æ•°å­—ç³»åˆ—
extract_series_number() {
    local subtarget="$1"
    # æå–æ•°å­—
    local numbers=$(echo "$subtarget" | grep -o '[0-9][0-9]*' | head -1)
    if [ -n "$numbers" ] && [ ${#numbers} -ge 3 ]; then
        # å–å‰ä¸‰ä½
        echo "$numbers" | cut -c1-3
    else
        echo ""
    fi
}

# æ£€æŸ¥å­å¹³å°æ˜¯å¦åŒ¹é…ç³»åˆ—æ¨¡å¼
match_series_pattern() {
    local target_subtarget="$1"
    local candidate_subtarget="$2"
    
    # ç²¾ç¡®åŒ¹é…
    if [ "$target_subtarget" = "$candidate_subtarget" ]; then
        return 0
    fi
    
    # æå–æ•°å­—ç³»åˆ—
    local target_series=$(extract_series_number "$target_subtarget")
    local candidate_series=$(extract_series_number "$candidate_subtarget")
    
    # å¦‚æœéƒ½æœ‰æ•°å­—ç³»åˆ—ä¸”ç›¸åŒ
    if [ -n "$target_series" ] && [ -n "$candidate_series" ] && [ "$target_series" = "$candidate_series" ]; then
        return 0
    fi
    
    # æ£€æŸ¥é€šé…ç¬¦æ¨¡å¼
    if [[ "$candidate_subtarget" == *"*"* ]]; then
        local base_name=$(echo "$candidate_subtarget" | sed 's/\*//g')
        if [[ "$target_subtarget" == *"$base_name"* ]]; then
            return 0
        fi
    fi
    
    # æ£€æŸ¥é€šç”¨ç³»åˆ—
    case "$candidate_subtarget" in
        filogic)
            case "$target_subtarget" in
                filogic|mt7981|mt7986|mt7988|mt798x) return 0 ;;
                *) ;;
            esac
            ;;
        mt798x)
            case "$target_subtarget" in
                mt7981|mt7986|mt7988|mt798x) return 0 ;;
                *) ;;
            esac
            ;;
        ipq40xx)
            case "$target_subtarget" in
                ipq40xx|ipq4018|ipq4019|ipq4028|ipq4029) return 0 ;;
                *) ;;
            esac
            ;;
        ipq807x)
            case "$target_subtarget" in
                ipq807x|ipq8071|ipq8072|ipq8074) return 0 ;;
                *) ;;
            esac
            ;;
    esac
    
    return 1
}

# è·å–æŒ‡å®šå¹³å°/å­å¹³å°ä¸‹çš„æ‰€æœ‰è®¾å¤‡
get_devices_by_subtarget() {
    local branch="$1"
    local platform="$2"
    local subtarget="$3"
    local match_type="${4:-all}"
    
    local exact_devices=()
    local series_devices=()
    local wildcard_devices=()
    
    # å®šä¹‰è¦æœç´¢çš„è·¯å¾„
    local search_paths=""
    
    # 1. ç²¾ç¡®åŒ¹é…è·¯å¾„
    if [ -d "target/linux/$platform/$subtarget" ]; then
        search_paths="$search_paths target/linux/$platform/$subtarget:exact"
    fi
    
    # 2. ç³»åˆ—åŒ¹é…è·¯å¾„
    local target_series=$(extract_series_number "$subtarget")
    if [ -n "$target_series" ]; then
        while IFS= read -r candidate_dir; do
            if [ -n "$candidate_dir" ]; then
                local candidate=$(basename "$candidate_dir")
                local candidate_series=$(extract_series_number "$candidate")
                
                if [ -n "$candidate_series" ] && [ "$candidate_series" = "$target_series" ] && \
                   [ "$candidate" != "$subtarget" ] && [ -d "$candidate_dir" ]; then
                    search_paths="$search_paths $candidate_dir:series"
                fi
            fi
        done < <(find "target/linux/$platform" -maxdepth 1 -type d ! -path "target/linux/$platform" 2>/dev/null)
    fi
    
    # 3. é€šé…åŒ¹é…è·¯å¾„
    while IFS= read -r candidate_dir; do
        if [ -n "$candidate_dir" ]; then
            local candidate=$(basename "$candidate_dir")
            if [[ "$candidate" == *"*"* ]] && [ -d "$candidate_dir" ]; then
                if match_series_pattern "$subtarget" "$candidate"; then
                    search_paths="$search_paths $candidate_dir:wildcard"
                fi
            fi
        fi
    done < <(find "target/linux/$platform" -maxdepth 1 -type d ! -path "target/linux/$platform" 2>/dev/null)
    
    # å»é‡å¹¶å¤„ç†æ¯ä¸ªè·¯å¾„
    local seen_paths=""
    for path_entry in $search_paths; do
        local path="${path_entry%%:*}"
        local path_type="${path_entry##*:}"
        
        # æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
        if [[ " $seen_paths " != *" $path "* ]]; then
            seen_paths="$seen_paths $path"
            
            # æ ¹æ®åŒ¹é…ç±»å‹è¿‡æ»¤
            if [ "$match_type" != "all" ]; then
                case "$match_type" in
                    exact)   [ "$path_type" != "exact" ] && continue ;;
                    series)  [ "$path_type" != "series" ] && continue ;;
                    wildcard)[ "$path_type" != "wildcard" ] && continue ;;
                esac
            fi
            
            # å¹³æ›¿æ–¹æ¡ˆ1: ä½¿ç”¨ä¸¤ä¸ªfindå‘½ä»¤åˆ†åˆ«æŸ¥æ‰¾.mkå’ŒMakefileæ–‡ä»¶
            local mk_files=""
            
            # æŸ¥æ‰¾.mkæ–‡ä»¶
            local mk_find=$(find "$path" -maxdepth 2 -type f -name "*.mk" 2>/dev/null)
            if [ -n "$mk_find" ]; then
                mk_files="$mk_files"$'\n'"$mk_find"
            fi
            
            # æŸ¥æ‰¾Makefileæ–‡ä»¶
            local makefile_find=$(find "$path" -maxdepth 2 -type f -name "Makefile" 2>/dev/null)
            if [ -n "$makefile_find" ]; then
                mk_files="$mk_files"$'\n'"$makefile_find"
            fi
            
            # å»é‡å¹¶å¤„ç†
            if [ -n "$mk_files" ]; then
                echo "$mk_files" | sort -u | while read mk_file; do
                    if [ -f "$mk_file" ]; then
                        # æå–è®¾å¤‡å®šä¹‰
                        while IFS= read -r line; do
                            if [[ "$line" == "define Device/"* ]]; then
                                local device=$(echo "$line" | sed 's/define Device\///' | awk '{print $1}')
                                if [ -n "$device" ]; then
                                    case "$path_type" in
                                        exact)    echo "$device" >> /tmp/exact_devices_$$.tmp ;;
                                        series)   echo "$device" >> /tmp/series_devices_$$.tmp ;;
                                        wildcard) echo "$device" >> /tmp/wildcard_devices_$$.tmp ;;
                                    esac
                                fi
                            fi
                        done < "$mk_file"
                    fi
                done
            fi
        fi
    done
    
    # ä»ä¸´æ—¶æ–‡ä»¶è¯»å–ç»“æœ
    if [ -f /tmp/exact_devices_$$.tmp ]; then
        exact_devices=($(cat /tmp/exact_devices_$$.tmp | sort -u))
        rm -f /tmp/exact_devices_$$.tmp
    fi
    
    if [ -f /tmp/series_devices_$$.tmp ]; then
        series_devices=($(cat /tmp/series_devices_$$.tmp | sort -u))
        rm -f /tmp/series_devices_$$.tmp
    fi
    
    if [ -f /tmp/wildcard_devices_$$.tmp ]; then
        wildcard_devices=($(cat /tmp/wildcard_devices_$$.tmp | sort -u))
        rm -f /tmp/wildcard_devices_$$.tmp
    fi
    
    # æ ¹æ®è¯·æ±‚çš„åŒ¹é…ç±»å‹è¿”å›ç»“æœ
    case "$match_type" in
        exact)
            printf '%s\n' "${exact_devices[@]}"
            ;;
        series)
            printf '%s\n' "${series_devices[@]}"
            ;;
        wildcard)
            printf '%s\n' "${wildcard_devices[@]}"
            ;;
        all)
            {
                printf '%s\n' "${exact_devices[@]}"
                printf '%s\n' "${series_devices[@]}"
                printf '%s\n' "${wildcard_devices[@]}"
            } | sort -u
            ;;
    esac
}
#ã€build_firmware_main.sh-37-endã€‘
