# ðŸ”§ å·¥ä½œæµä¿®å¤æ–‡ä»¶
# ç”Ÿæˆæ—¶é—´: Sat Jan 31 02:56:22 UTC 2026
# æ¥æº: firmware-config/fix.txt

#ã€firmware-build.yml-23ã€‘
# æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶ï¼ˆæ·»åŠ å˜é‡éªŒè¯ï¼‰
- name: "23. ç¼–è¯‘å›ºä»¶ï¼ˆæ·»åŠ å˜é‡éªŒè¯ï¼‰"
  run: |
    echo "=== æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶ï¼ˆæ·»åŠ å˜é‡éªŒè¯ï¼‰ ==="
    echo "ðŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    
    # è®¾ç½®é”™è¯¯å¤„ç†
    set -e
    trap 'echo "âŒ æ­¥éª¤ 23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    cd /mnt/openwrt-build
    
    # é¦–å…ˆæ£€æŸ¥çŽ¯å¢ƒå˜é‡
    echo "ðŸ” ç¼–è¯‘å‰çŽ¯å¢ƒå˜é‡éªŒè¯:"
    if [ -f "build_env.sh" ]; then
      source build_env.sh
      echo "âœ… åŠ è½½çŽ¯å¢ƒå˜é‡æˆåŠŸ"
    else
      echo "âŒ é”™è¯¯: build_env.sh æ–‡ä»¶ä¸å­˜åœ¨"
      exit 1
    fi
    
    # å…³é”®å˜é‡æ£€æŸ¥
    echo ""
    echo "ðŸ” å…³é”®å˜é‡æ£€æŸ¥:"
    echo "  TARGET: $TARGET"
    echo "  SUBTARGET: $SUBTARGET"
    echo "  DEVICE: $DEVICE"
    echo "  SELECTED_BRANCH: $SELECTED_BRANCH"
    echo "  PLATFORM: $PLATFORM"
    echo "  SOURCE_REPO: $SOURCE_REPO"
    
    if [ -z "$TARGET" ]; then
      echo "âŒ é”™è¯¯: TARGET å˜é‡ä¸ºç©ºï¼Œè¿™æ˜¯å¯¼è‡´ç¼–è¯‘å¤±è´¥çš„æ ¹æœ¬åŽŸå› "
      echo "ðŸ’¡ å°è¯•ä¿®å¤..."
      
      # å°è¯•ä»Žsupport.shèŽ·å–
      SUPPORT_DIR="${{ github.workspace }}/firmware-config"
      if [ -f "$SUPPORT_DIR/support.sh" ]; then
        source "$SUPPORT_DIR/support.sh"
        
        if command -v get_device_config >/dev/null 2>&1; then
          DEVICE_CONFIG=$(get_device_config "${{ github.event.inputs.device_name }}")
          if [ -n "$DEVICE_CONFIG" ]; then
            TARGET=$(echo $DEVICE_CONFIG | awk '{print $1}')
            SUBTARGET=$(echo $DEVICE_CONFIG | awk '{print $2}')
            DEVICE=$(echo $DEVICE_CONFIG | awk '{print $3}')
            PLATFORM=$(echo $DEVICE_CONFIG | awk '{print $4}')
            
            echo "âœ… ä»Žsupport.shèŽ·å–é…ç½®:"
            echo "  TARGET: $TARGET"
            echo "  SUBTARGET: $SUBTARGET"
            echo "  DEVICE: $DEVICE"
            echo "  PLATFORM: $PLATFORM"
            
            # æ›´æ–°çŽ¯å¢ƒå˜é‡
            export TARGET="$TARGET"
            export SUBTARGET="$SUBTARGET"
            export DEVICE="$DEVICE"
            export PLATFORM="$PLATFORM"
            
            # æ›´æ–°çŽ¯å¢ƒæ–‡ä»¶
            echo "ðŸ”„ æ›´æ–°çŽ¯å¢ƒæ–‡ä»¶..."
            sed -i "s/export TARGET=\".*\"/export TARGET=\"$TARGET\"/" build_env.sh
            sed -i "s/export SUBTARGET=\".*\"/export SUBTARGET=\"$SUBTARGET\"/" build_env.sh
            sed -i "s/export DEVICE=\".*\"/export DEVICE=\"$DEVICE\"/" build_env.sh
            sed -i "s/export PLATFORM=\".*\"/export PLATFORM=\"$PLATFORM\"/" build_env.sh
            
            # é‡æ–°åŠ è½½çŽ¯å¢ƒå˜é‡
            source build_env.sh
            echo "âœ… çŽ¯å¢ƒå˜é‡å·²ä¿®å¤"
          fi
        fi
      fi
    fi
    
    # å¦‚æžœTARGETä»ç„¶ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
    if [ -z "$TARGET" ]; then
      echo "âš ï¸ TARGET ä»ç„¶ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼ ipq40xx"
      export TARGET="ipq40xx"
      export SUBTARGET="generic"
      export DEVICE="${{ github.event.inputs.device_name }}"
      export PLATFORM="generic"
      
      # æ›´æ–°çŽ¯å¢ƒæ–‡ä»¶
      echo "ðŸ”„ è®¾ç½®é»˜è®¤å€¼åˆ°çŽ¯å¢ƒæ–‡ä»¶..."
      sed -i "s/export TARGET=\".*\"/export TARGET=\"ipq40xx\"/" build_env.sh
      sed -i "s/export SUBTARGET=\".*\"/export SUBTARGET=\"generic\"/" build_env.sh
      sed -i "s/export DEVICE=\".*\"/export DEVICE=\"${{ github.event.inputs.device_name }}\"/" build_env.sh
      sed -i "s/export PLATFORM=\".*\"/export PLATFORM=\"generic\"/" build_env.sh
      
      source build_env.sh
    fi
    
    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
    echo ""
    echo "ðŸ” æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶..."
    KERNEL_VERSION_FILE="include/kernel-${TARGET}.mk"
    if [ -f "$KERNEL_VERSION_FILE" ]; then
      echo "âœ… å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨: $KERNEL_VERSION_FILE"
--
#ã€firmware-build.yml-21ã€‘
# æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤TARGETå˜é‡é—®é¢˜ï¼‰
- name: "21. å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤TARGETå˜é‡é—®é¢˜ï¼‰"
  run: |
    echo "=== æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤TARGETå˜é‡é—®é¢˜ï¼‰ ==="
    echo "ðŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    
    # è®¾ç½®é”™è¯¯å¤„ç†
    set -e
    trap 'echo "âŒ æ­¥éª¤ 21 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ðŸ” æ£€æŸ¥å½“å‰çŽ¯å¢ƒ..."
    if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
      source /mnt/openwrt-build/build_env.sh
      echo "âœ… åŠ è½½çŽ¯å¢ƒå˜é‡: SELECTED_BRANCH=$SELECTED_BRANCH, TARGET=$TARGET, PLATFORM=$PLATFORM, SOURCE_REPO=$SOURCE_REPO"
    else
      echo "âŒ é”™è¯¯: çŽ¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨"
      exit 1
    fi
    
    # å…³é”®æ£€æŸ¥ï¼šç¡®ä¿TARGETå˜é‡ä¸ä¸ºç©º
    echo ""
    echo "ðŸ” å…³é”®å˜é‡æ£€æŸ¥ï¼ˆä¿®å¤TARGETé—®é¢˜ï¼‰:"
    echo "  TARGET: $TARGET"
    echo "  SUBTARGET: $SUBTARGET"
    echo "  DEVICE: $DEVICE"
    echo "  SELECTED_BRANCH: $SELECTED_BRANCH"
    
    if [ -z "$TARGET" ]; then
      echo "âŒ é”™è¯¯: TARGET å˜é‡ä¸ºç©ºï¼Œè¿™æ˜¯å¯¼è‡´ç¼–è¯‘å¤±è´¥çš„æ ¹æœ¬åŽŸå› "
      echo "ðŸ’¡ å¯èƒ½çš„åŽŸå› :"
      echo "  1. è®¾å¤‡æ”¯æŒè„šæœ¬æœªæ­£ç¡®é…ç½®"
      echo "  2. çŽ¯å¢ƒå˜é‡æœªæ­£ç¡®ä¼ é€’"
      echo "  3. support.sh æ–‡ä»¶æœ‰é—®é¢˜"
      
      # å°è¯•ä»Žsupport.shèŽ·å–
      SUPPORT_DIR="${{ github.workspace }}/firmware-config"
      if [ -f "$SUPPORT_DIR/support.sh" ]; then
        echo "ðŸ”§ å°è¯•ä»Žsupport.shèŽ·å–è®¾å¤‡é…ç½®..."
        source "$SUPPORT_DIR/support.sh"
        
        if command -v get_device_config >/dev/null 2>&1; then
          DEVICE_CONFIG=$(get_device_config "${{ github.event.inputs.device_name }}")
          if [ -n "$DEVICE_CONFIG" ]; then
            TARGET=$(echo $DEVICE_CONFIG | awk '{print $1}')
            SUBTARGET=$(echo $DEVICE_CONFIG | awk '{print $2}')
            DEVICE=$(echo $DEVICE_CONFIG | awk '{print $3}')
            PLATFORM=$(echo $DEVICE_CONFIG | awk '{print $4}')
