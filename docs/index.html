<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWrtå›ºä»¶æ„å»ºå™¨</title>
    <style>
        :root {
            --primary: #2ea44f;
            --primary-dark: #2c974b;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --text: #24292e;
            --text-light: #586069;
            --border: #e1e4e8;
            --shadow: 0 1px 3px rgba(27,31,35,0.12), 0 8px 24px rgba(66,74,83,0.12);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--text);
        }
        
        .subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 1rem;
        }
        
        select, input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 164, 79, 0.2);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-group input {
            width: auto;
            transform: scale(1.2);
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 164, 79, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .alert.success {
            background: #f0fff4;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .alert.error {
            background: #ffeef0;
            border: 2px solid #f97583;
            color: #d73a49;
        }
        
        .alert.warning {
            background: #fff8f0;
            border: 2px solid #e36209;
            color: #e36209;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .device-tag {
            padding: 10px;
            background: var(--bg);
            border-radius: 6px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .device-tag:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .device-tag.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }
        
        .info-box {
            background: var(--bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            color: var(--text);
        }
        
        .status-card {
            background: var(--bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .status-card.show {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .github-link {
            color: var(--primary);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .github-link:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .device-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ—ï¸ OpenWrtå›ºä»¶æ„å»ºå™¨</h1>
            <p class="subtitle">æ— éœ€ç™»å½•ï¼Œæ— éœ€Tokenï¼Œä¸€é”®æ„å»ºå®šåˆ¶å›ºä»¶</p>
            <a href="#" id="githubRepoLink" class="github-link" target="_blank">
                <span>ğŸ™</span> æŸ¥çœ‹GitHubä»“åº“
            </a>
        </header>
        
        <div class="card">
            <div id="alert" class="alert"></div>
            
            <form id="buildForm">
                <div class="form-group">
                    <label>ğŸ“± é€‰æ‹©è®¾å¤‡</label>
                    <select id="device" name="device" required>
                        <option value="">æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...</option>
                    </select>
                    <div class="device-grid" id="deviceGrid"></div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ”„ OpenWrtç‰ˆæœ¬</label>
                    <select id="version" name="version" required>
                        <option value="21.02">21.02 - ç¨³å®šç‰ˆ</option>
                        <option value="23.05" selected>23.05 - æ–°ç‰ˆ</option>
                        <option value="snapshot">Snapshot - å¼€å‘ç‰ˆ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>âš™ï¸ é…ç½®æ¨¡å¼</label>
                    <select id="mode" name="mode" required>
                        <option value="base">ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®</option>
                        <option value="normal" selected>ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½</option>
                        <option value="custom">ğŸ”µ è‡ªå®šä¹‰æ¨¡å¼ - é«˜çº§é…ç½®</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“¦ é¢å¤–æ’ä»¶ (å¯é€‰)</label>
                    <input type="text" id="packages" name="packages" 
                           placeholder="ä¾‹å¦‚: luci-app-ddns luci-app-upnp">
                    <small style="color: var(--text-light); display: block; margin-top: 5px;">
                        è¾“å…¥æ’ä»¶åç§°ï¼Œç”¨ç©ºæ ¼åˆ†éš”ã€‚å‰ç¼€+è¡¨ç¤ºæ·»åŠ ï¼Œ-è¡¨ç¤ºç§»é™¤
                    </small>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="parallel" name="parallel" checked>
                        <label for="parallel" style="margin-bottom: 0;">
                            âš¡ å¯ç”¨æ™ºèƒ½å¹¶è¡Œä¼˜åŒ–
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="btn" id="submitBtn" disabled>
                    <span>ğŸš€</span> å¼€å§‹æ„å»ºå›ºä»¶
                </button>
            </form>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æäº¤æ„å»ºè¯·æ±‚...</p>
            </div>
            
            <div class="status-card" id="statusCard">
                <h3>ğŸ“‹ æ„å»ºçŠ¶æ€</h3>
                <div class="status-item">
                    <span>âœ…</span>
                    <span>æ„å»ºè¯·æ±‚å·²æäº¤</span>
                </div>
                <div class="status-item">
                    <span>â³</span>
                    <span>æ­£åœ¨ç­‰å¾…GitHub Actionså¼€å§‹è¿è¡Œ...</span>
                </div>
                <p style="margin-top: 10px; color: var(--text-light); font-size: 0.9rem;">
                    è¯·å‰å¾€ <a href="#" id="actionsLink" target="_blank" style="color: var(--primary);">GitHub Actionsé¡µé¢</a> æŸ¥çœ‹è¯¦ç»†è¿›åº¦
                </p>
            </div>
        </div>
        
        <div class="info-box">
            <h3>ğŸ“ ä½¿ç”¨è¯´æ˜</h3>
            <p>1. é€‰æ‹©è®¾å¤‡å’Œé…ç½®æ¨¡å¼</p>
            <p>2. ç‚¹å‡»"å¼€å§‹æ„å»º"æŒ‰é’®</p>
            <p>3. ç­‰å¾…GitHub Actionså®Œæˆæ„å»º</p>
            <p>4. åœ¨Actionsé¡µé¢ä¸‹è½½ç”Ÿæˆçš„å›ºä»¶</p>
        </div>
        
        <div class="info-box">
            <h3>ğŸ¯ æ­£å¸¸æ¨¡å¼åŒ…å«çš„åŠŸèƒ½</h3>
            <p>TurboACCç½‘ç»œåŠ é€Ÿã€Sambaæ–‡ä»¶å…±äº«ã€ç£ç›˜ç®¡ç†ã€SmartDNSæ™ºèƒ½DNSã€å®¶é•¿æ§åˆ¶ã€å¾®ä¿¡æ¨é€ã€æµé‡æ§åˆ¶ã€FTPæœåŠ¡å™¨ç­‰å®Œæ•´åŠŸèƒ½ã€‚</p>
        </div>
        
        <footer>
            <p>Â© 2024 OpenWrtå›ºä»¶æ„å»ºå™¨ | åŸºäºGitHub Actionsè‡ªåŠ¨æ„å»º | 
                <a href="#" id="githubDocsLink" class="github-link">æŸ¥çœ‹æ–‡æ¡£</a>
            </p>
        </footer>
    </div>

    <script>
        // =============== é…ç½® ===============
        const CONFIG = {
            DEVICES_API: 'devices.json',  // è®¾å¤‡åˆ—è¡¨API
            WORKFLOW_FILE: 'firmware-build.yml'
        };
        
        // =============== çŠ¶æ€ç®¡ç† ===============
        let state = {
            devices: [],
            isLoading: false,
            lastBuildId: null,
            repoOwner: '',
            repoName: ''
        };
        
        // =============== DOMå…ƒç´  ===============
        const elements = {
            deviceSelect: document.getElementById('device'),
            deviceGrid: document.getElementById('deviceGrid'),
            buildForm: document.getElementById('buildForm'),
            submitBtn: document.getElementById('submitBtn'),
            loading: document.getElementById('loading'),
            alert: document.getElementById('alert'),
            statusCard: document.getElementById('statusCard'),
            actionsLink: document.getElementById('actionsLink'),
            githubRepoLink: document.getElementById('githubRepoLink'),
            githubDocsLink: document.getElementById('githubDocsLink')
        };
        
        // =============== åˆå§‹åŒ– ===============
        document.addEventListener('DOMContentLoaded', () => {
            init();
        });
        
        async function init() {
            // è‡ªåŠ¨æ£€æµ‹GitHubä»“åº“ä¿¡æ¯
            await detectGitHubRepo();
            
            // æ›´æ–°GitHubé“¾æ¥
            updateGitHubLinks();
            
            // åŠ è½½è®¾å¤‡åˆ—è¡¨
            await loadDevices();
            
            // è®¾ç½®è¡¨å•äº‹ä»¶
            setupFormEvents();
            
            // æ£€æŸ¥URLå‚æ•°
            checkUrlParams();
        }
        
        // =============== è‡ªåŠ¨æ£€æµ‹GitHubä»“åº“ ===============
        async function detectGitHubRepo() {
            try {
                // ä»GitHub Pagesè‡ªåŠ¨æ£€æµ‹ä»“åº“
                if (window.location.hostname.endsWith('.github.io')) {
                    const parts = window.location.hostname.split('.');
                    if (parts.length >= 2) {
                        state.repoOwner = parts[0]; // GitHubç”¨æˆ·å
                        
                        // è·å–ä»“åº“åï¼ˆä»è·¯å¾„è·å–ç¬¬ä¸€ä¸ªéç©ºéƒ¨åˆ†ï¼‰
                        const pathParts = window.location.pathname.split('/').filter(p => p);
                        state.repoName = pathParts[0] || 'openwrt';
                        
                        console.log('æ£€æµ‹åˆ°çš„GitHubä»“åº“:', state.repoOwner + '/' + state.repoName);
                        return;
                    }
                }
                
                // å¦‚æœæ— æ³•è‡ªåŠ¨æ£€æµ‹ï¼Œå°è¯•ä»é¡µé¢URLè·å–
                const urlParams = new URLSearchParams(window.location.search);
                const repoParam = urlParams.get('repo');
                if (repoParam && repoParam.includes('/')) {
                    const [owner, name] = repoParam.split('/');
                    state.repoOwner = owner;
                    state.repoName = name;
                    console.log('ä»URLå‚æ•°è·å–GitHubä»“åº“:', repoParam);
                    return;
                }
                
                // æœ€åå°è¯•ä»å½“å‰é¡µé¢è¯»å–ä»“åº“ä¿¡æ¯
                await fetchGitHubInfoFromPage();
                
            } catch (error) {
                console.warn('æ— æ³•è‡ªåŠ¨æ£€æµ‹GitHubä»“åº“:', error);
                // è®¾ç½®é»˜è®¤å€¼ï¼ˆå°†æç¤ºç”¨æˆ·æ‰‹åŠ¨è®¾ç½®ï¼‰
                state.repoOwner = '';
                state.repoName = '';
            }
        }
        
        async function fetchGitHubInfoFromPage() {
            try {
                // å°è¯•è·å–é¡µé¢ä¸Šçš„GitHubé“¾æ¥
                const links = document.querySelectorAll('a[href*="github.com"]');
                for (const link of links) {
                    const url = new URL(link.href, window.location.origin);
                    if (url.hostname === 'github.com') {
                        const pathParts = url.pathname.split('/').filter(p => p);
                        if (pathParts.length >= 2) {
                            state.repoOwner = pathParts[0];
                            state.repoName = pathParts[1];
                            console.log('ä»é¡µé¢é“¾æ¥è·å–GitHubä»“åº“:', state.repoOwner + '/' + state.repoName);
                            return;
                        }
                    }
                }
            } catch (error) {
                console.warn('ä»é¡µé¢è·å–GitHubä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        // =============== æ›´æ–°GitHubé“¾æ¥ ===============
        function updateGitHubLinks() {
            if (state.repoOwner && state.repoName) {
                const baseUrl = `https://github.com/${state.repoOwner}/${state.repoName}`;
                
                // æ›´æ–°ä»“åº“é“¾æ¥
                elements.githubRepoLink.href = baseUrl;
                
                // æ›´æ–°æ–‡æ¡£é“¾æ¥
                elements.githubDocsLink.href = `${baseUrl}/blob/main/README.md`;
                
                // æ›´æ–°çŠ¶æ€å¡ç‰‡çš„Actionsé“¾æ¥
                elements.actionsLink.href = `${baseUrl}/actions`;
                
                console.log('GitHubé“¾æ¥å·²æ›´æ–°:', {
                    repo: elements.githubRepoLink.href,
                    docs: elements.githubDocsLink.href,
                    actions: elements.actionsLink.href
                });
            } else {
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                showAlert('âš ï¸ æ— æ³•è‡ªåŠ¨æ£€æµ‹GitHubä»“åº“ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®ä»“åº“åœ°å€ã€‚åœ¨URLä¸­æ·»åŠ  ?repo=ç”¨æˆ·å/ä»“åº“å', 'warning');
                elements.githubRepoLink.href = '#';
                elements.githubDocsLink.href = '#';
                elements.actionsLink.href = '#';
            }
        }
        
        // =============== åŠ è½½è®¾å¤‡åˆ—è¡¨ ===============
        async function loadDevices() {
            try {
                showAlert('æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...', 'warning');
                
                // å°è¯•ä»å¤šä¸ªæ¥æºè·å–è®¾å¤‡åˆ—è¡¨
                let devices = [];
                
                // 1. å°è¯•ä»APIè·å–è®¾å¤‡åˆ—è¡¨
                try {
                    const apiResponse = await fetch(CONFIG.DEVICES_API);
                    if (apiResponse.ok) {
                        const data = await apiResponse.json();
                        if (Array.isArray(data.devices)) {
                            devices = data.devices;
                            console.log('ä»APIåŠ è½½è®¾å¤‡åˆ—è¡¨:', devices.length, 'ä¸ªè®¾å¤‡');
                        }
                    }
                } catch (apiError) {
                    console.log('APIåŠ è½½å¤±è´¥:', apiError);
                }
                
                // 2. å¦‚æœAPIå¤±è´¥ï¼Œå°è¯•ä»support.shè·å–
                if (devices.length === 0 && state.repoOwner && state.repoName) {
                    try {
                        const supportResponse = await fetch(
                            `https://raw.githubusercontent.com/${state.repoOwner}/${state.repoName}/main/support.sh`
                        );
                        if (supportResponse.ok) {
                            const content = await supportResponse.text();
                            devices = extractDevicesFromSupport(content);
                            console.log('ä»support.shåŠ è½½è®¾å¤‡åˆ—è¡¨:', devices.length, 'ä¸ªè®¾å¤‡');
                        }
                    } catch (supportError) {
                        console.log('support.shåŠ è½½å¤±è´¥:', supportError);
                    }
                }
                
                // 3. å¦‚æœéƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯
                if (devices.length === 0) {
                    throw new Error('æ— æ³•åŠ è½½è®¾å¤‡åˆ—è¡¨');
                }
                
                state.devices = devices;
                updateDeviceUI();
                hideAlert();
                
                // åˆ·æ–°é¡µé¢æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½
                setupAutoRefresh();
                
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
                state.devices = [];
                updateDeviceUI();
                showAlert(`âŒ è®¾å¤‡åˆ—è¡¨åŠ è½½å¤±è´¥: ${error.message}ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚`, 'error');
                elements.submitBtn.disabled = true;
            }
        }
        
        function extractDevicesFromSupport(content) {
            const devices = new Set();
            
            // ä»support.shä¸­æå–è®¾å¤‡å
            const patterns = [
                /DEVICES\["([^"]+)"\]/g,
                /get_device_config\s*\(\s*["']([^"']+)["']/g,
                /["']([a-zA-Z0-9_\-]+)["']/g
            ];
            
            // æŸ¥æ‰¾è®¾å¤‡å®šä¹‰è¡Œ
            const lines = content.split('\n');
            for (const line of lines) {
                if (line.includes('DEVICES[') || line.includes('device_name=')) {
                    patterns.forEach(pattern => {
                        let match;
                        while ((match = pattern.exec(line)) !== null) {
                            if (match[1] && match[1].length > 2 && !match[1].startsWith('CONFIG_')) {
                                devices.add(match[1].trim());
                            }
                        }
                    });
                }
            }
            
            return Array.from(devices).sort();
        }
        
        function updateDeviceUI() {
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            elements.deviceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è®¾å¤‡</option>';
            elements.deviceGrid.innerHTML = '';
            
            if (state.devices.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'æœªæ‰¾åˆ°æ”¯æŒçš„è®¾å¤‡';
                elements.deviceSelect.appendChild(option);
                return;
            }
            
            // æ›´æ–°ä¸‹æ‹‰é€‰æ‹©
            state.devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device;
                option.textContent = device;
                elements.deviceSelect.appendChild(option);
            });
            
            // æ›´æ–°è®¾å¤‡ç½‘æ ¼
            state.devices.forEach(device => {
                const tag = document.createElement('div');
                tag.className = 'device-tag';
                tag.textContent = device;
                tag.title = `ç‚¹å‡»é€‰æ‹© ${device}`;
                tag.addEventListener('click', () => {
                    elements.deviceSelect.value = device;
                    // æ›´æ–°é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.device-tag').forEach(t => 
                        t.classList.remove('selected'));
                    tag.classList.add('selected');
                });
                elements.deviceGrid.appendChild(tag);
            });
            
            // å¯ç”¨æäº¤æŒ‰é’®
            elements.submitBtn.disabled = false;
        }
        
        // =============== è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ ===============
        function setupAutoRefresh() {
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°è®¾å¤‡åˆ—è¡¨
                    refreshDevicesIfNeeded();
                }
            });
            
            // ç›‘å¬é¡µé¢è·å–ç„¦ç‚¹äº‹ä»¶
            window.addEventListener('focus', refreshDevicesIfNeeded);
            
            // æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡è®¾å¤‡åˆ—è¡¨
            setInterval(refreshDevicesIfNeeded, 5 * 60 * 1000);
        }
        
        async function refreshDevicesIfNeeded() {
            if (state.isLoading) return;
            
            try {
                console.log('æ£€æŸ¥è®¾å¤‡åˆ—è¡¨æ›´æ–°...');
                // è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ£€æŸ¥è®¾å¤‡åˆ—è¡¨æ˜¯å¦éœ€è¦æ›´æ–°
                // ä¾‹å¦‚ï¼šæ¯”è¾ƒæ—¶é—´æˆ³æˆ–ç‰ˆæœ¬å·
            } catch (error) {
                console.log('è®¾å¤‡åˆ—è¡¨æ›´æ–°æ£€æŸ¥å¤±è´¥:', error);
            }
        }
        
        // =============== è¡¨å•äº‹ä»¶å¤„ç† ===============
        function setupFormEvents() {
            // è¡¨å•æäº¤
            elements.buildForm.addEventListener('submit', handleSubmit);
            
            // è®¾å¤‡é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°æ ‡ç­¾é€‰ä¸­çŠ¶æ€
            elements.deviceSelect.addEventListener('change', function() {
                const selectedDevice = this.value;
                document.querySelectorAll('.device-tag').forEach(tag => {
                    tag.classList.toggle('selected', tag.textContent === selectedDevice);
                });
            });
            
            // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œå®æ—¶éªŒè¯
            elements.buildForm.addEventListener('input', validateFormInRealTime);
        }
        
        function validateFormInRealTime() {
            const device = elements.deviceSelect.value;
            const isValid = device && state.devices.includes(device);
            elements.submitBtn.disabled = !isValid;
        }
        
        // =============== å¤„ç†è¡¨å•æäº¤ ===============
        async function handleSubmit(event) {
            event.preventDefault();
            
            if (state.isLoading) return;
            
            // æ£€æŸ¥GitHubä»“åº“ä¿¡æ¯
            if (!state.repoOwner || !state.repoName) {
                showAlert('âŒ è¯·å…ˆè®¾ç½®GitHubä»“åº“ä¿¡æ¯ã€‚åœ¨URLä¸­æ·»åŠ  ?repo=ç”¨æˆ·å/ä»“åº“å', 'error');
                return;
            }
            
            const formData = {
                device: elements.deviceSelect.value,
                version: document.getElementById('version').value,
                mode: document.getElementById('mode').value,
                packages: document.getElementById('packages').value.trim(),
                parallel: document.getElementById('parallel').checked
            };
            
            // éªŒè¯è¡¨å•
            if (!validateForm(formData)) return;
            
            // å¼€å§‹æäº¤
            state.isLoading = true;
            updateUIState(true);
            
            try {
                const result = await triggerWorkflow(formData);
                
                if (result.success) {
                    showSuccess(result);
                    
                    // æ›´æ–°çŠ¶æ€å¡ç‰‡
                    elements.actionsLink.href = result.html_url;
                    elements.statusCard.classList.add('show');
                    
                    // 3ç§’åè‡ªåŠ¨è·³è½¬åˆ°Actionsé¡µé¢
                    setTimeout(() => {
                        if (result.html_url && result.html_url !== '#') {
                            window.open(result.html_url, '_blank');
                        }
                    }, 3000);
                    
                    // 3åˆ†é’Ÿåé‡ç½®è¡¨å•
                    setTimeout(() => {
                        resetForm();
                    }, 180000);
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                showAlert(`âŒ æäº¤å¤±è´¥: ${error.message}`, 'error');
                state.isLoading = false;
                updateUIState(false);
            }
        }
        
        function validateForm(data) {
            if (!data.device) {
                showAlert('è¯·é€‰æ‹©è®¾å¤‡', 'error');
                return false;
            }
            
            if (!state.devices.includes(data.device)) {
                showAlert(`è®¾å¤‡"${data.device}"ä¸åœ¨æ”¯æŒåˆ—è¡¨ä¸­`, 'error');
                return false;
            }
            
            return true;
        }
        
        // =============== è§¦å‘GitHubå·¥ä½œæµ ===============
        async function triggerWorkflow(data) {
            if (!state.repoOwner || !state.repoName) {
                throw new Error('æœªè®¾ç½®GitHubä»“åº“ä¿¡æ¯');
            }
            
            // ç”ŸæˆGitHub Actionsæ‰‹åŠ¨è§¦å‘é“¾æ¥
            const actionsUrl = generateManualTriggerUrl(data);
            
            return {
                success: true,
                html_url: actionsUrl,
                message: 'è¯·ç‚¹å‡»é“¾æ¥æ‰‹åŠ¨è§¦å‘æ„å»º'
            };
        }
        
        function generateManualTriggerUrl(data) {
            // æ„å»ºGitHub Actionsæ‰‹åŠ¨è§¦å‘é¡µé¢çš„URL
            const baseUrl = `https://github.com/${state.repoOwner}/${state.repoName}/actions/workflows/${CONFIG.WORKFLOW_FILE}`;
            const params = new URLSearchParams();
            
            // æ·»åŠ å·¥ä½œæµè¾“å…¥å‚æ•°
            params.append('manual', 'true');
            
            // æ·»åŠ è®¾å¤‡ä¿¡æ¯
            if (data.device) {
                params.append('inputs.device_name', data.device);
            }
            
            // æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
            if (data.version) {
                params.append('inputs.version_selection', data.version);
            }
            
            // æ·»åŠ é…ç½®æ¨¡å¼
            if (data.mode) {
                params.append('inputs.config_mode', data.mode);
            }
            
            // æ·»åŠ é¢å¤–åŒ…
            if (data.packages) {
                params.append('inputs.extra_packages', data.packages);
            }
            
            // æ·»åŠ å¹¶è¡Œä¼˜åŒ–é€‰é¡¹
            params.append('inputs.enable_parallel', data.parallel ? 'true' : 'false');
            
            return `${baseUrl}?${params.toString()}`;
        }
        
        // =============== UIè¾…åŠ©å‡½æ•° ===============
        function showAlert(message, type = 'info') {
            elements.alert.textContent = message;
            elements.alert.className = `alert ${type}`;
            elements.alert.style.display = 'block';
            
            // è‡ªåŠ¨éšè—éé”™è¯¯æç¤º
            if (type !== 'error') {
                setTimeout(() => {
                    hideAlert();
                }, 5000);
            }
        }
        
        function hideAlert() {
            elements.alert.style.display = 'none';
        }
        
        function showSuccess(result) {
            showAlert(`âœ… ${result.message}`, 'success');
        }
        
        function updateUIState(isLoading) {
            elements.submitBtn.disabled = isLoading;
            elements.loading.style.display = isLoading ? 'block' : 'none';
            elements.submitBtn.innerHTML = isLoading ? 
                '<span>â³</span> æäº¤ä¸­...' : 
                '<span>ğŸš€</span> å¼€å§‹æ„å»ºå›ºä»¶';
        }
        
        function resetForm() {
            elements.buildForm.reset();
            document.getElementById('parallel').checked = true;
            elements.statusCard.classList.remove('show');
            document.querySelectorAll('.device-tag').forEach(tag => 
                tag.classList.remove('selected'));
            state.isLoading = false;
            updateUIState(false);
        }
        
        // =============== URLå‚æ•°å¤„ç† ===============
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            
            // è®¾ç½®ä»“åº“å‚æ•°
            const repoParam = params.get('repo');
            if (repoParam && repoParam.includes('/')) {
                const [owner, name] = repoParam.split('/');
                state.repoOwner = owner;
                state.repoName = name;
                updateGitHubLinks();
            }
            
            // è®¾ç½®è®¾å¤‡å‚æ•°
            if (params.has('device')) {
                const device = params.get('device');
                // å»¶è¿Ÿè®¾ç½®ï¼Œç­‰å¾…è®¾å¤‡åˆ—è¡¨åŠ è½½å®Œæˆ
                setTimeout(() => {
                    if (state.devices.includes(device)) {
                        elements.deviceSelect.value = device;
                        elements.deviceSelect.dispatchEvent(new Event('change'));
                    }
                }, 500);
            }
            
            // è®¾ç½®ç‰ˆæœ¬å‚æ•°
            if (params.has('version')) {
                const version = params.get('version');
                const versionSelect = document.getElementById('version');
                if (Array.from(versionSelect.options).some(opt => opt.value === version)) {
                    versionSelect.value = version;
                }
            }
            
            // è®¾ç½®æ¨¡å¼å‚æ•°
            if (params.has('mode')) {
                const mode = params.get('mode');
                const modeSelect = document.getElementById('mode');
                if (Array.from(modeSelect.options).some(opt => opt.value === mode)) {
                    modeSelect.value = mode;
                }
            }
        }
    </script>
</body>
</html>
