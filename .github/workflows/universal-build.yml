name: "Universal Firmware Builder"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "master"
        type: string
      config_profile:
        description: "è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„"
        required: true
        type: string
        default: ".config_rt-ac42u_immortalwrt"
      build_optimization:
        description: "ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥"
        required: true
        type: choice
        options: ["balanced", "speed", "stability"]
        default: "balanced"
      enable_advanced:
        description: "å¯ç”¨é«˜çº§åŠŸèƒ½"
        required: false
        default: false
        type: boolean
      custom_patches:
        description: "è‡ªå®šä¹‰è¡¥ä¸URLæˆ–è·¯å¾„"
        required: false
        default: ""
        type: string
      extra_packages:
        description: "é¢å¤–è½¯ä»¶åŒ…åˆ—è¡¨(é€—å·åˆ†éš”)"
        required: false
        default: ""
        type: string
      debug_mode:
        description: "å¯ç”¨è°ƒè¯•æ¨¡å¼"
        required: false
        default: false
        type: boolean

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 360
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"
        with:
          path: "config-repo"
          fetch-depth: 0

      - name: "ğŸ”§ åˆå§‹åŒ–å·¥ä½œç¯å¢ƒ"
        run: |
          echo "=== ğŸ”§ åˆå§‹åŒ–å·¥ä½œç¯å¢ƒ ==="
          sudo mkdir -p /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chown -R $USER:$USER /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chmod -R 755 /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          mkdir -p /mnt/build-logs
          MAIN_LOG="/mnt/build-logs/build_timeline.log"
          echo "ğŸ æ„å»ºå¼€å§‹æ—¶é—´: $(date)" > $MAIN_LOG
          echo "ğŸ”§ å·¥ä½œæµç‰ˆæœ¬: Optimized Inputs" >> $MAIN_LOG
          echo "ğŸ“‹ è¾“å…¥å‚æ•°:" >> $MAIN_LOG
          echo "  - æºç é¢„è®¾: ${{ github.event.inputs.source_preset }}" >> $MAIN_LOG
          echo "  - æºç åˆ†æ”¯: ${{ github.event.inputs.source_branch }}" >> $MAIN_LOG
          echo "  - é…ç½®æ–¹æ¡ˆ: ${{ github.event.inputs.config_profile }}" >> $MAIN_LOG
          echo "  - é«˜çº§åŠŸèƒ½: ${{ github.event.inputs.enable_advanced }}" >> $MAIN_LOG
          echo "  - è‡ªå®šä¹‰è¡¥ä¸: ${{ github.event.inputs.custom_patches }}" >> $MAIN_LOG
          echo "  - é¢å¤–åŒ…: ${{ github.event.inputs.extra_packages }}" >> $MAIN_LOG
          echo "  - è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug_mode }}" >> $MAIN_LOG
          echo "==========================================" >> $MAIN_LOG
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV
          echo "CONFIG_REPO_DIR=${{ github.workspace }}/config-repo" >> $GITHUB_ENV
          echo "âœ… å·¥ä½œç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸ’¾ ç¯å¢ƒè®¾ç½®ä¸èµ„æºç®¡ç†"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ’¾ ç¯å¢ƒè®¾ç½®ä¸èµ„æºç®¡ç† ===" | tee -a "$MAIN_LOG"
          echo "ğŸ“Š ç³»ç»Ÿä¿¡æ¯:" | tee -a "$MAIN_LOG"
          echo "  - ç³»ç»Ÿ: $(lsb_release -d | cut -f2)" | tee -a "$MAIN_LOG"
          echo "  - å†…æ ¸: $(uname -r)" | tee -a "$MAIN_LOG"
          echo "  - CPU: $(nproc) æ ¸å¿ƒ" | tee -a "$MAIN_LOG"
          echo "  - å†…å­˜: $(free -h | awk 'NR==2{print $7}') å¯ç”¨" | tee -a "$MAIN_LOG"
          echo "ğŸ’¾ ç£ç›˜ç©ºé—´çŠ¶æ€:" | tee -a "$MAIN_LOG"
          df -h | tee -a "$MAIN_LOG"
          echo "ğŸ”„ åˆ›å»ºäº¤æ¢æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          SWAP_SIZE="32G"
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          echo "ğŸ“¦ åˆ›å»º ${SWAP_SIZE} äº¤æ¢æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          sudo fallocate -l $SWAP_SIZE /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          echo "ğŸ“Š å†…å­˜çŠ¶æ€:" | tee -a "$MAIN_LOG"
          free -h | tee -a "$MAIN_LOG"
          echo "âœ… ç¯å¢ƒè®¾ç½®å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ– ===" | tee -a "$MAIN_LOG"
          echo "ğŸ“¦ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..." | tee -a "$MAIN_LOG"
          sudo apt-get update -qq
          echo "ğŸ”§ å®‰è£…æ ¸å¿ƒç¼–è¯‘å·¥å…·..." | tee -a "$MAIN_LOG"
          sudo apt-get install -y -qq build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-dev rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build libelf-dev libxml2-dev liblzma-dev liblzo2-dev axel net-tools e2fsprogs genext2fs dosfstools mtools libffi-dev libsqlite3-dev libpam0g-dev libtirpc-dev libev-dev lm-sensors libnetsnmp-dev glib2-dev libgpiod-dev
          echo "ğŸ é…ç½®Pythonç¯å¢ƒ..." | tee -a "$MAIN_LOG"
          python3 -m pip install --upgrade pip
          python3 -m pip install setuptools wheel
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½® ===" | tee -a "$MAIN_LOG"
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          echo "ğŸ¯ ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥: $OPTIMIZATION_STRATEGY" | tee -a "$MAIN_LOG"
          case "$OPTIMIZATION_STRATEGY" in
            "speed")
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=2
              echo "ğŸš€ é€Ÿåº¦ä¼˜å…ˆæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            "stability")
              CCACHE_SIZE="2G"
              PARALLEL_JOBS=1
              echo "ğŸ›¡ï¸ ç¨³å®šæ€§ä¼˜å…ˆæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            *)
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=2
              echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
          esac
          mkdir -p /mnt/ccache
          ccache -M $CCACHE_SIZE
          ccache -o compression=true
          ccache -o compression_level=6
          echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          echo "ğŸ“Š åˆå§‹CCacheç»Ÿè®¡:" | tee -a "$MAIN_LOG"
          ccache -s | tee -a "$MAIN_LOG"
          echo "âœ… æ€§èƒ½ä¼˜åŒ–å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ æºç é…ç½®ä¸è·å–"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ æºç é…ç½®ä¸è·å– ===" | tee -a "$MAIN_LOG"
          REPO_JSON_FOUND=$(find ${{ env.CONFIG_REPO_DIR }} -name "*repositories*.json" -type f 2>/dev/null | head -1)
          if [ -z "$REPO_JSON_FOUND" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° repositories.json æ–‡ä»¶" | tee -a "$MAIN_LOG"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $REPO_JSON_FOUND" | tee -a "$MAIN_LOG"
          PRESET="${{ github.event.inputs.source_preset }}"
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND" 2>/dev/null || echo "")
          if [ -z "$SOURCE_URL" ]; then
            echo "âŒ é”™è¯¯: é¢„è®¾ '$PRESET' åœ¨é…ç½®æ–‡ä»¶ä¸­ä¸å­˜åœ¨" | tee -a "$MAIN_LOG"
            exit 1
          fi
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND" 2>/dev/null || echo "master")
          fi
          echo "ğŸ“¦ æºç ä¿¡æ¯:" | tee -a "$MAIN_LOG"
          echo "  - URL: $SOURCE_URL" | tee -a "$MAIN_LOG"
          echo "  - åˆ†æ”¯: $BRANCH" | tee -a "$MAIN_LOG"
          echo "  - é¢„è®¾: $PRESET" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "ğŸ”„ å…‹éš†æºç ..." | tee -a "$MAIN_LOG"
          rm -rf .[!.]* * 2>/dev/null || true
          echo "ğŸ“¥ å…‹éš†å°è¯•..." | tee -a "$MAIN_LOG"
          if git clone --depth 1 --branch "$BRANCH" "$SOURCE_URL" . 2>&1; then
            if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
              echo "âœ… æºç å…‹éš†æˆåŠŸ" | tee -a "$MAIN_LOG"
            else
              echo "âŒ æºç ç»“æ„ä¸å®Œæ•´" | tee -a "$MAIN_LOG"
              exit 1
            fi
          else
            echo "âŒ æºç å…‹éš†å¤±è´¥" | tee -a "$MAIN_LOG"
            exit 1
          fi
          ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          echo "âœ… æºç å…‹éš†æˆåŠŸ" | tee -a "$MAIN_LOG"
          echo "  - å®é™…åˆ†æ”¯: $ACTUAL_BRANCH" | tee -a "$MAIN_LOG"
          echo "  - æäº¤å“ˆå¸Œ: $COMMIT_HASH" | tee -a "$MAIN_LOG"
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV

      - name: "ğŸ”§ é…ç½®ä¸‹è½½é•œåƒæº"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ é…ç½®ä¸‹è½½é•œåƒæº ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "ğŸŒ é…ç½®å¤šé•œåƒæº..." | tee -a "$MAIN_LOG"
          echo "src-gz openwrt_base https://mirrors.ustc.edu.cn/lede/releases/22.03.5/packages/aarch64_cortex-a53/base" > download-mirrors.conf
          echo "src-gz openwrt_luci https://mirrors.ustc.edu.cn/lede/releases/22.03.5/packages/aarch64_cortex-a53/luci" >> download-mirrors.conf
          echo "src-gz openwrt_packages https://mirrors.ustc.edu.cn/lede/releases/22.03.5/packages/aarch64_cortex-a53/packages" >> download-mirrors.conf
          echo "src-gz openwrt_routing https://mirrors.ustc.edu.cn/lede/releases/22.03.5/packages/aarch64_cortex-a53/routing" >> download-mirrors.conf
          echo "src-gz openwrt_telephony https://mirrors.ustc.edu.cn/lede/releases/22.03.5/packages/aarch64_cortex-a53/telephony" >> download-mirrors.conf
          echo "ğŸ”§ ä¿®å¤ä¸‹è½½è„šæœ¬..." | tee -a "$MAIN_LOG"
          sed -i 's|https://downloads.openwrt.org|https://mirrors.ustc.edu.cn/lede|g' scripts/download.pl
          sed -i 's|https://cdn.kernel.org|https://mirrors.ustc.edu.cn/kernel|g' scripts/download.pl
          sed -i 's|https://www.netfilter.org|https://mirrors.ustc.edu.cn/netfilter|g' scripts/download.pl
          echo "ğŸ“¥ è®¾ç½®ä¸‹è½½é‡è¯•..." | tee -a "$MAIN_LOG"
          echo "DOWNLOAD_MAX_CONNECTION=5" >> include/prereq.mk
          echo "WGET_OPTIONS='--timeout=30 --tries=5 --retry-connrefused'" >> include/prereq.mk
          echo "âœ… é•œåƒæºé…ç½®å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”„ æºç åˆå§‹åŒ–ä¸Feedsé…ç½®"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”„ æºç åˆå§‹åŒ–ä¸Feedsé…ç½® ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "ğŸ“‹ é…ç½®Feeds..." | tee -a "$MAIN_LOG"
          case "${{ env.SOURCE_PRESET }}" in
            "immortalwrt")
              echo "src-git packages https://github.com/immortalwrt/packages.git;openwrt-22.03" > feeds.conf
              echo "src-git luci https://github.com/immortalwrt/luci.git;openwrt-22.03" >> feeds.conf
              ;;
            "openwrt")
              echo "src-git packages https://git.openwrt.org/feed/packages.git;openwrt-22.03" > feeds.conf
              echo "src-git luci https://git.openwrt.org/project/luci.git;openwrt-22.03" >> feeds.conf
              ;;
            "lede")
              echo "src-git packages https://github.com/coolsnowwolf/packages.git;master" > feeds.conf
              echo "src-git luci https://github.com/coolsnowwolf/luci.git;master" >> feeds.conf
              ;;
          esac
          echo "src-git routing https://github.com/openwrt/routing.git;openwrt-22.03" >> feeds.conf
          echo "src-git telephony https://github.com/openwrt/telephony.git;openwrt-22.03" >> feeds.conf
          echo "ğŸ”„ æ›´æ–°Feeds..." | tee -a "$MAIN_LOG"
          for attempt in 1 2 3; do
            echo "ğŸ”„ æ›´æ–°å°è¯• $attempt/3..." | tee -a "$MAIN_LOG"
            if ./scripts/feeds update -a 2>&1; then
              echo "âœ… Feedsæ›´æ–°æˆåŠŸ" | tee -a "$MAIN_LOG"
              break
            else
              echo "âš ï¸ Feedsæ›´æ–°å¤±è´¥ï¼Œé‡è¯• $attempt/3..." | tee -a "$MAIN_LOG"
              sleep 10
            fi
          done
          echo "ğŸ“¦ å®‰è£…Feeds..." | tee -a "$MAIN_LOG"
          if ./scripts/feeds install -a 2>&1; then
            echo "âœ… Feedså®‰è£…æˆåŠŸ" | tee -a "$MAIN_LOG"
          else
            echo "âš ï¸ Feedså®‰è£…æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ..." | tee -a "$MAIN_LOG"
          fi
          echo "âœ… æºç åˆå§‹åŒ–å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ¯ åº”ç”¨è®¾å¤‡é…ç½®"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ¯ åº”ç”¨è®¾å¤‡é…ç½® ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "ğŸ” æŸ¥æ‰¾é…ç½®æ–‡ä»¶: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
          CONFIG_FOUND=""
          SEARCH_PATHS=("${{ env.CONFIG_REPO_DIR }}/.configs" "${{ env.CONFIG_REPO_DIR }}/configs" "${{ env.CONFIG_REPO_DIR }}" "$GITHUB_WORKSPACE/configs")
          for path in "${SEARCH_PATHS[@]}"; do
            if [ -f "$path/$CONFIG_PROFILE" ]; then
              CONFIG_FOUND="$path/$CONFIG_PROFILE"
              break
            fi
          done
          if [ -z "$CONFIG_FOUND" ]; then
            CONFIG_FOUND=$(find "${{ env.CONFIG_REPO_DIR }}" -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
          fi
          if [ -n "$CONFIG_FOUND" ] && [ -f "$CONFIG_FOUND" ]; then
            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND" | tee -a "$MAIN_LOG"
            cp "$CONFIG_FOUND" .config
            echo "ğŸ”§ åº”ç”¨ä¼˜åŒ–é…ç½®..." | tee -a "$MAIN_LOG"
            echo "# CONFIG_TARGET_ROOTFS_EXT4FS is not set" >> .config
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
            echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> .config
            echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> .config
            echo "CONFIG_SDK=y" >> .config
            echo "CONFIG_BUILD_LOG=y" >> .config
            echo "ğŸ”„ è¿è¡Œdefconfig..." | tee -a "$MAIN_LOG"
            if make defconfig 2>&1; then
              echo "âœ… é…ç½®åº”ç”¨å®Œæˆ" | tee -a "$MAIN_LOG"
            else
              echo "âš ï¸ defconfigæœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ..." | tee -a "$MAIN_LOG"
            fi
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ '$CONFIG_PROFILE'" | tee -a "$MAIN_LOG"
            exit 1
          fi

      - name: "ğŸ”§ åº”ç”¨é«˜çº§åŠŸèƒ½"
        if: github.event.inputs.enable_advanced == 'true'
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ åº”ç”¨é«˜çº§åŠŸèƒ½ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          # åº”ç”¨è‡ªå®šä¹‰è¡¥ä¸
          if [ -n "${{ github.event.inputs.custom_patches }}" ]; then
            echo "ğŸ”§ åº”ç”¨è‡ªå®šä¹‰è¡¥ä¸..." | tee -a "$MAIN_LOG"
            PATCH_URL="${{ github.event.inputs.custom_patches }}"
            if [[ $PATCH_URL == http* ]]; then
              echo "ğŸ“¥ ä¸‹è½½è¡¥ä¸: $PATCH_URL" | tee -a "$MAIN_LOG"
              wget -O custom.patch "$PATCH_URL" && patch -p1 < custom.patch && echo "âœ… è¡¥ä¸åº”ç”¨æˆåŠŸ" | tee -a "$MAIN_LOG" || echo "âš ï¸ è¡¥ä¸åº”ç”¨å¤±è´¥" | tee -a "$MAIN_LOG"
            elif [ -f "${{ env.CONFIG_REPO_DIR }}/$PATCH_URL" ]; then
              echo "ğŸ“¥ åº”ç”¨æœ¬åœ°è¡¥ä¸: $PATCH_URL" | tee -a "$MAIN_LOG"
              patch -p1 < "${{ env.CONFIG_REPO_DIR }}/$PATCH_URL" && echo "âœ… è¡¥ä¸åº”ç”¨æˆåŠŸ" | tee -a "$MAIN_LOG" || echo "âš ï¸ è¡¥ä¸åº”ç”¨å¤±è´¥" | tee -a "$MAIN_LOG"
            fi
          fi
          
          # æ·»åŠ é¢å¤–è½¯ä»¶åŒ…
          if [ -n "${{ github.event.inputs.extra_packages }}" ]; then
            echo "ğŸ“¦ é…ç½®é¢å¤–è½¯ä»¶åŒ…..." | tee -a "$MAIN_LOG"
            IFS=',' read -ra PKGS <<< "${{ github.event.inputs.extra_packages }}"
            for pkg in "${PKGS[@]}"; do
              echo "CONFIG_PACKAGE_${pkg}=y" >> .config
              echo "âœ… æ·»åŠ åŒ…: $pkg" | tee -a "$MAIN_LOG"
            done
          fi
          
          # ä¿®å¤ä¾èµ–é—®é¢˜
          echo "ğŸ”§ ä¿®å¤ç¼ºå¤±çš„ä¾èµ–åŒ…..." | tee -a "$MAIN_LOG"
          mkdir -p staging_dir/host/include
          touch staging_dir/host/include/libev.h
          touch staging_dir/host/include/libpam.h
          touch staging_dir/host/include/libtirpc
          touch staging_dir/host/include/lm-sensors
          touch staging_dir/host/include/libnetsnmp
          touch staging_dir/host/include/glib2.h
          touch staging_dir/host/include/libgpiod.h
          
          # é‡æ–°è¿è¡Œdefconfigç¡®ä¿é…ç½®æ­£ç¡®
          echo "ğŸ”„ é‡æ–°è¿è¡Œdefconfig..." | tee -a "$MAIN_LOG"
          make defconfig 2>&1 | tee -a "$MAIN_LOG" || echo "âš ï¸ defconfigæœ‰è­¦å‘Š" | tee -a "$MAIN_LOG"
          
          echo "âœ… é«˜çº§åŠŸèƒ½åº”ç”¨å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¥ é¢„ä¸‹è½½ä¾èµ–"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¥ é¢„ä¸‹è½½ä¾èµ– ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "ğŸ”§ è®¾ç½®ä¸‹è½½ç›®å½•..." | tee -a "$MAIN_LOG"
          mkdir -p /mnt/downloads
          [ -d "dl" ] && rm -rf dl
          ln -sf /mnt/downloads dl
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½..." | tee -a "$MAIN_LOG"
          MAX_ATTEMPTS=5
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "ğŸ”„ ä¸‹è½½å°è¯• $attempt/$MAX_ATTEMPTS..." | tee -a "$MAIN_LOG"
            if make download -j3 V=sc 2>&1; then
              echo "âœ… ä¸‹è½½æˆåŠŸ" | tee -a "$MAIN_LOG"
              break
            else
              echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œé‡è¯• $attempt/$MAX_ATTEMPTS..." | tee -a "$MAIN_LOG"
              if [ $attempt -eq $MAX_ATTEMPTS ]; then
                echo "âŒ æ‰€æœ‰ä¸‹è½½å°è¯•éƒ½å¤±è´¥ï¼Œè·³è¿‡ä¸‹è½½ç»§ç»­ç¼–è¯‘..." | tee -a "$MAIN_LOG"
                break
              fi
              sleep 15
            fi
          done
          DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶æ•°é‡: $DOWNLOAD_COUNT" | tee -a "$MAIN_LOG"

      - name: "ğŸ› ï¸ ç¼–è¯‘å·¥å…·é“¾"
        timeout-minutes: 180
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ› ï¸ ç¼–è¯‘å·¥å…·é“¾ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          echo "ğŸ”§ ç¼–è¯‘åŸºç¡€å·¥å…·..." | tee -a "$MAIN_LOG"
          if make tools/install -j1 V=s 2>&1; then
            echo "âœ… åŸºç¡€å·¥å…·ç¼–è¯‘æˆåŠŸ" | tee -a "$MAIN_LOG"
          else
            echo "âš ï¸ åŸºç¡€å·¥å…·ç¼–è¯‘æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ..." | tee -a "$MAIN_LOG"
          fi
          echo "ğŸ”„ ç¼–è¯‘å·¥å…·é“¾..." | tee -a "$MAIN_LOG"
          MAX_RETRIES=3
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "ğŸ”„ å·¥å…·é“¾ç¼–è¯‘å°è¯• $attempt/$MAX_RETRIES" | tee -a "$MAIN_LOG"
            if [ $attempt -gt 1 ]; then
              echo "ğŸ§¹ æ¸…ç†å·¥å…·é“¾..." | tee -a "$MAIN_LOG"
              make toolchain/clean 2>/dev/null || true
              sleep 5
            fi
            if make toolchain/compile -j1 V=s 2>&1; then
              echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ" | tee -a "$MAIN_LOG"
              break
            else
              echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥" | tee -a "$MAIN_LOG"
              if [ $attempt -eq $MAX_RETRIES ]; then
                echo "âŒ æ‰€æœ‰å·¥å…·é“¾ç¼–è¯‘å°è¯•éƒ½å¤±è´¥" | tee -a "$MAIN_LOG"
                exit 1
              fi
              sleep 10
            fi
          done
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸš€ ç¼–è¯‘å›ºä»¶"
        timeout-minutes: 240
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸš€ ç¼–è¯‘å›ºä»¶ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          echo "ğŸ”§ å¼€å§‹ç¼–è¯‘..." | tee -a "$MAIN_LOG"
          MAX_ATTEMPTS=2
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "ğŸ”„ ç¼–è¯‘å°è¯• $attempt/$MAX_ATTEMPTS" | tee -a "$MAIN_LOG"
            if [ $attempt -eq 1 ]; then
              JOBS=2
            else
              JOBS=1
              echo "ğŸ§¹ æ¸…ç†éƒ¨åˆ†æ„å»º..." | tee -a "$MAIN_LOG"
              make target/linux-clean 2>/dev/null || true
              sleep 5
            fi
            if make -j$JOBS V=s 2>&1; then
              if [ -d "bin/targets" ] && find bin/targets -name "*.bin" -o -name "*.img" 2>/dev/null | grep -q .; then
                echo "âœ… ç¼–è¯‘æˆåŠŸ" | tee -a "$MAIN_LOG"
                echo "BUILD_STATUS=success" >> $GITHUB_ENV
                break
              else
                echo "âš ï¸ ç¼–è¯‘å®Œæˆä½†æœªç”Ÿæˆå›ºä»¶" | tee -a "$MAIN_LOG"
              fi
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥" | tee -a "$MAIN_LOG"
              if [ $attempt -eq $MAX_ATTEMPTS ]; then
                echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•éƒ½å¤±è´¥" | tee -a "$MAIN_LOG"
                echo "BUILD_STATUS=failed" >> $GITHUB_ENV
                exit 1
              fi
              sleep 10
            fi
          done
          echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ¯ éªŒè¯å·¥å‚é•œåƒ"
        if: env.BUILD_STATUS == 'success'
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ¯ éªŒè¯å·¥å‚é•œåƒ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          ASUS_FACTORY=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -i factory || true)
          if [ -n "$ASUS_FACTORY" ]; then
            echo "âœ… å·¥å‚é•œåƒå·²ç”Ÿæˆ:" | tee -a "$MAIN_LOG"
            for img in $ASUS_FACTORY; do
              size=$(du -h "$img" | cut -f1)
              echo "  - $(basename "$img") ($size)" | tee -a "$MAIN_LOG"
            done
            echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°å·¥å‚é•œåƒ" | tee -a "$MAIN_LOG"
            echo "FACTORY_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©"
        if: env.BUILD_STATUS == 'success'
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰© ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          mkdir -p /mnt/artifacts/firmware
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) > /mnt/artifacts/firmware-list.txt
          FIRMWARE_COUNT=$(wc -l < /mnt/artifacts/firmware-list.txt)
          echo "ğŸ“¦ å¤åˆ¶ $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          COPIED_COUNT=0
          while IFS= read -r firmware; do
            if [ -f "$firmware" ]; then
              cp "$firmware" /mnt/artifacts/firmware/ && COPIED_COUNT=$((COPIED_COUNT+1)) || echo "âš ï¸ å¤åˆ¶å¤±è´¥: $firmware" | tee -a "$MAIN_LOG"
            fi
          done < /mnt/artifacts/firmware-list.txt
          echo "FIRMWARE_COUNT=$COPIED_COUNT" >> $GITHUB_ENV
          echo "âœ… æˆåŠŸå¤åˆ¶ $COPIED_COUNT ä¸ªå›ºä»¶æ–‡ä»¶" | tee -a "$MAIN_LOG"

      - name: "ğŸ“‹ æ™ºèƒ½æ—¥å¿—åˆ†æä¸æŠ¥å‘Š"
        if: always()
        timeout-minutes: 5
        run: |
          set -e
          echo "=== ğŸ“‹ æ™ºèƒ½æ—¥å¿—åˆ†æä¸æŠ¥å‘Š ==="
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "==========================================" | tee -a "$MAIN_LOG"
          echo "ğŸ æ„å»ºç»“æŸæ—¶é—´: $(date)" | tee -a "$MAIN_LOG"
          echo "ğŸ“Š æœ€ç»ˆçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}" | tee -a "$MAIN_LOG"
          echo "ğŸ“¦ å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}" | tee -a "$MAIN_LOG"
          echo "ğŸ­ å·¥å‚é•œåƒ: ${{ env.FACTORY_EXISTS || 'unknown' }}" | tee -a "$MAIN_LOG"
          echo "==========================================" | tee -a "$MAIN_LOG"
          ERROR_REPORT_DIR="/mnt/artifacts/error-analysis"
          mkdir -p "$ERROR_REPORT_DIR"
          TIMELINE_ERRORS="$ERROR_REPORT_DIR/timeline_errors.txt"
          echo "=== ğŸ•’ æ—¶é—´çº¿é”™è¯¯æŠ¥å‘Š ===" > "$TIMELINE_ERRORS"
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> "$TIMELINE_ERRORS"
          echo "æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}" >> "$TIMELINE_ERRORS"
          echo "==========================================" >> "$TIMELINE_ERRORS"
          if [ -f "$MAIN_LOG" ]; then
            echo "ğŸ” å…³é”®é”™è¯¯:" >> "$TIMELINE_ERRORS"
            { grep -n -i -B2 -A2 "error\|failed\|fatal" "$MAIN_LOG" | head -50 || echo "æ— ä¸¥é‡é”™è¯¯"; } >> "$TIMELINE_ERRORS"
            echo "" >> "$TIMELINE_ERRORS"
            echo "ğŸ“¥ ä¸‹è½½é—®é¢˜:" >> "$TIMELINE_ERRORS"
            { grep -n -i "404\|curl.*failed\|download failed" "$MAIN_LOG" || echo "æ— ä¸‹è½½é—®é¢˜"; } >> "$TIMELINE_ERRORS"
            echo "" >> "$TIMELINE_ERRORS"
            echo "ğŸ”§ é«˜çº§åŠŸèƒ½é—®é¢˜:" >> "$TIMELINE_ERRORS"
            { grep -n -i "patch\|custom\|advanced" "$MAIN_LOG" || echo "æ— é«˜çº§åŠŸèƒ½é—®é¢˜"; } >> "$TIMELINE_ERRORS"
          fi
          echo "âœ… æ™ºèƒ½æ—¥å¿—åˆ†æå®Œæˆ"

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Build-Artifacts-${{ github.run_number }}"
          path: |
            /mnt/artifacts
            /mnt/build-logs
          retention-days: 30
          compression-level: 9

      - name: "ğŸ“Š æœ€ç»ˆæ„å»ºæŠ¥å‘Š"
        if: always()
        run: |
          echo "=== ğŸ“Š æœ€ç»ˆæ„å»ºæŠ¥å‘Š ==="
          echo ""
          echo "ğŸ¯ æ„å»ºæ‘˜è¦"
          echo "=========================================="
          echo "ğŸ“¦ æºç ä¿¡æ¯:"
          echo "  - é¢„è®¾: ${{ env.SOURCE_PRESET || 'unknown' }}"
          echo "  - åˆ†æ”¯: ${{ env.ACTUAL_BRANCH || 'unknown' }}"
          echo "  - æäº¤: ${{ env.COMMIT_HASH || 'unknown' }}"
          echo ""
          echo "ğŸ“ˆ æ„å»ºç»“æœ:"
          echo "  - çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - å·¥å‚é•œåƒ: ${{ env.FACTORY_EXISTS || 'unknown' }}"
          echo ""
          echo "ğŸ”§ é«˜çº§åŠŸèƒ½:"
          echo "  - å¯ç”¨çŠ¶æ€: ${{ github.event.inputs.enable_advanced || 'false' }}"
          echo "  - è‡ªå®šä¹‰è¡¥ä¸: ${{ github.event.inputs.custom_patches || 'æ— ' }}"
          echo "  - é¢å¤–è½¯ä»¶åŒ…: ${{ github.event.inputs.extra_packages || 'æ— ' }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            if [ "${{ env.FACTORY_EXISTS }}" = "true" ]; then
              echo "ğŸ‰ æ„å»ºæˆåŠŸï¼å·¥å‚é•œåƒå·²ç”Ÿæˆ"
            else
              echo "âš ï¸ æ„å»ºæˆåŠŸä½†æœªç”Ÿæˆå·¥å‚é•œåƒ"
            fi
          else
            echo "âŒ æ„å»ºå¤±è´¥"
            echo ""
            echo "ğŸ” å¯èƒ½çš„åŸå› :"
            echo "  - ç½‘ç»œä¸‹è½½é—®é¢˜"
            echo "  - ä¾èµ–åŒ…ç¼ºå¤±"
            echo "  - ç£ç›˜ç©ºé—´ä¸è¶³"
            echo "  - è‡ªå®šä¹‰è¡¥ä¸å†²çª"
            echo ""
            echo "ğŸ’¡ å»ºè®®:"
            echo "  - æ£€æŸ¥ç½‘ç»œè¿æ¥"
            echo "  - ä½¿ç”¨ç¨³å®šåˆ†æ”¯è€Œémaster"
            echo "  - ç¡®ä¿é…ç½®æ–‡ä»¶æ­£ç¡®"
            echo "  - æ£€æŸ¥è‡ªå®šä¹‰è¡¥ä¸å…¼å®¹æ€§"
          fi
          echo ""
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "=========================================="
