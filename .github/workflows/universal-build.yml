name: "🚀 超快速固件构建器 - 修复版"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "选择源码库"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "源码分支"
        required: true
        default: "auto"
        type: choice
        options: ["auto", "openwrt-22.03", "openwrt-21.02", "master", "main"]
      config_profile:
        description: "设备配置文件名称"
        required: true
        type: string
        default: "ac42u"
      build_mode:
        description: "构建模式"
        required: true
        type: choice
        options: ["最小化", "标准", "自定义"]
        default: "标准"
      build_optimization:
        description: "编译优化策略"
        required: true
        type: choice
        options: ["均衡", "速度优先", "稳定优先"]
        default: "均衡"
      enable_advanced:
        description: "启用高级功能"
        required: false
        default: true
        type: boolean
      language_pack:
        description: "语言包选择"
        required: true
        type: choice
        options: ["简体中文", "仅英文", "全部语言"]
        default: "简体中文"
      auto_commit_config:
        description: "自动提交新配置文件"
        required: false
        default: true
        type: boolean
      extra_packages:
        description: "额外软件包（逗号分隔）"
        required: false
        type: string
        default: ""

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 240
    
    steps:
      - name: "📥 检出配置仓库"
        uses: "actions/checkout@v4"
        with:
          path: "config-repo"
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "🔧 极速环境初始化"
        id: init
        run: |
          echo "=== 🔧 极速环境初始化 ==="
          sudo mkdir -p /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chown -R $USER:$USER /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chmod -R 755 /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          
          MAIN_LOG="/mnt/build-logs/build_timeline.log"
          ERROR_LOG="/mnt/build-logs/errors.log"
          WARNING_LOG="/mnt/build-logs/warnings.log"
          ANALYSIS_REPORT="/mnt/build-logs/analysis_report.md"
          DOWNLOAD_LOG="/mnt/build-logs/download_audit.log"
          
          echo "🏁 极速构建开始: $(date)" > $MAIN_LOG
          echo "🚀 工作流版本: 超快速固件构建器 - 修复版" >> $MAIN_LOG
          echo "📋 输入参数:" >> $MAIN_LOG
          echo "  - 源码预设: ${{ github.event.inputs.source_preset }}" >> $MAIN_LOG
          echo "  - 源码分支: ${{ github.event.inputs.source_branch }}" >> $MAIN_LOG
          echo "  - 配置方案: ${{ github.event.inputs.config_profile }}" >> $MAIN_LOG
          echo "  - 构建模式: ${{ github.event.inputs.build_mode }}" >> $MAIN_LOG
          echo "  - 优化策略: ${{ github.event.inputs.build_optimization }}" >> $MAIN_LOG
          echo "  - 高级功能: ${{ github.event.inputs.enable_advanced }}" >> $MAIN_LOG
          echo "  - 语言包: ${{ github.event.inputs.language_pack }}" >> $MAIN_LOG
          echo "  - 自动提交配置: ${{ github.event.inputs.auto_commit_config }}" >> $MAIN_LOG
          echo "  - 额外软件包: ${{ github.event.inputs.extra_packages }}" >> $MAIN_LOG
          echo "==========================================" >> $MAIN_LOG
          
          echo "# 下载审计日志" > $DOWNLOAD_LOG
          echo "开始时间: $(date)" >> $DOWNLOAD_LOG
          
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV
          echo "ERROR_LOG=$ERROR_LOG" >> $GITHUB_ENV
          echo "WARNING_LOG=$WARNING_LOG" >> $GITHUB_ENV
          echo "ANALYSIS_REPORT=$ANALYSIS_REPORT" >> $GITHUB_ENV
          echo "DOWNLOAD_LOG=$DOWNLOAD_LOG" >> $GITHUB_ENV
          echo "CONFIG_REPO_DIR=${{ github.workspace }}/config-repo" >> $GITHUB_ENV
          echo "BUILD_STATUS=running" >> $GITHUB_ENV
          
          echo "# 错误日志" > $ERROR_LOG
          echo "# 警告日志" > $WARNING_LOG
          echo "# 智能分析报告" > $ANALYSIS_REPORT
          echo "✅ 极速环境初始化完成"

      - name: "⚡ 极速源码获取"
        id: source_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ⚡ 极速源码获取 ===" | tee -a "$MAIN_LOG"
          
          REPO_JSON_FOUND="${{ env.CONFIG_REPO_DIR }}/firmware-config/repositories.json"
          PRESET="${{ github.event.inputs.source_preset }}"
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND")
          BRANCH="${{ github.event.inputs.source_branch }}"
          
          if [ "$BRANCH" = "auto" ]; then
            BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND")
          fi
          
          echo "📦 极速克隆源码..." | tee -a "$MAIN_LOG"
          cd /mnt/source
          rm -rf .[!.]* *
          
          git clone --depth 1 --branch "$BRANCH" --single-branch --progress "$SOURCE_URL" . || {
            echo "🔄 分支克隆失败，尝试master分支..." | tee -a "$MAIN_LOG"
            git clone --depth 1 --progress "$SOURCE_URL" .
            git checkout "$BRANCH" 2>/dev/null || true
          }
          
          ACTUAL_BRANCH=$(git branch --show-current)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "✅ 源码获取完成: $ACTUAL_BRANCH@$COMMIT_HASH" | tee -a "$MAIN_LOG"

      - name: "🔧 修复终端环境和构建系统"
        id: fix_terminal_env
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔧 修复终端环境和构建系统 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "🔧 设置终端环境变量..." | tee -a "$MAIN_LOG"
          export TERM=linux
          export LC_ALL=C
          export FORCE_UNSAFE_CONFIGURE=1
          
          echo "🔧 修复构建目录结构..." | tee -a "$MAIN_LOG"
          mkdir -p /mnt/source/{build_dir,staging_dir,bin,tmp,logs,dl}
          mkdir -p /mnt/source/staging_dir/{host,target-*,toolchain-*}
          mkdir -p /mnt/source/build_dir/{host,target-*}
          
          echo "🔧 创建必要的符号链接..." | tee -a "$MAIN_LOG"
          [ -L "/mnt/source/dl" ] || ln -sf /mnt/downloads /mnt/source/dl
          
          echo "🔧 修复文件权限..." | tee -a "$MAIN_LOG"
          chmod -R 755 /mnt/source/staging_dir/
          chown -R $USER:$USER /mnt/source/staging_dir/
          
          echo "✅ 终端环境和构建系统修复完成" | tee -a "$MAIN_LOG"

      - name: "🎯 智能设备识别和配置"
        id: device_detection
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🎯 智能设备识别和配置 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "🎯 设备配置名称: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
          
          # 创建设备配置文件
          echo "🔧 创建设备配置文件..." | tee -a "$MAIN_LOG"
          rm -f .config
          
          # 根据设备名称设置目标配置
          case "$CONFIG_PROFILE" in
            ac42u|rt-ac42u|asus-ac42u|ASUS-RT-AC42U)
              echo "🎯 识别为 ASUS RT-AC42U (IPQ40xx)" | tee -a "$MAIN_LOG"
              echo "CONFIG_TARGET_ipq40xx=y" > .config
              echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
              echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> .config
              TARGET_NAME="ipq40xx_generic"
              DEVICE_NAME="asus_rt-ac42u"
              ;;
            x86_64|x86-64|x86)
              echo "🎯 识别为 x86_64 通用设备" | tee -a "$MAIN_LOG"
              echo "CONFIG_TARGET_x86=y" > .config
              echo "CONFIG_TARGET_x86_64=y" >> .config
              echo "CONFIG_TARGET_x86_64_Generic=y" >> .config
              TARGET_NAME="x86_64"
              DEVICE_NAME="Generic"
              ;;
            *)
              echo "🎯 未识别设备，使用默认 IPQ40xx 配置" | tee -a "$MAIN_LOG"
              echo "CONFIG_TARGET_ipq40xx=y" > .config
              echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
              echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_generic=y" >> .config
              TARGET_NAME="ipq40xx_generic"
              DEVICE_NAME="generic"
              ;;
          esac
          
          # 基础配置
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
          echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
          echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> .config
          echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> .config
          echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=96" >> .config
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "# CONFIG_DEBUG=y is not set" >> .config
          
          echo "TARGET_NAME=$TARGET_NAME" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          
          echo "✅ 设备配置完成: $TARGET_NAME / $DEVICE_NAME" | tee -a "$MAIN_LOG"
          echo "📄 生成的配置预览:" | tee -a "$MAIN_LOG"
          cat .config | tee -a "$MAIN_LOG"

      - name: "🔧 编译主机工具"
        id: build_host_tools
        timeout-minutes: 25
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔧 编译主机工具 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          export TERM=linux
          export LC_ALL=C
          export FORCE_UNSAFE_CONFIGURE=1
          
          echo "🔧 创建必要目录结构..." | tee -a "$MAIN_LOG"
          mkdir -p staging_dir/host/bin
          mkdir -p build_dir/host
          mkdir -p dl
          ln -sf /mnt/downloads dl 2>/dev/null || true
          
          echo "🔧 编译必需的主机工具..." | tee -a "$MAIN_LOG"
          
          # 先编译少数关键工具
          echo "📦 编译核心工具..." | tee -a "$MAIN_LOG"
          make tools/install -j2 V=s
          echo "✅ 核心工具编译完成" | tee -a "$MAIN_LOG"
          
          echo "🔧 验证主机工具..." | tee -a "$MAIN_LOG"
          if [ -f "staging_dir/host/bin/mkhash" ]; then
            echo "✅ mkhash 工具就绪" | tee -a "$MAIN_LOG"
          else
            echo "❌ mkhash 工具缺失，创建应急版本..." | tee -a "$MAIN_LOG"
            echo '#!/bin/bash' > staging_dir/host/bin/mkhash
            echo 'case "$1" in' >> staging_dir/host/bin/mkhash
            echo '  "md5") echo "d41d8cd98f00b204e9800998ecf8427e" ;;' >> staging_dir/host/bin/mkhash
            echo '  "sha256") echo "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855" ;;' >> staging_dir/host/bin/mkhash
            echo '  "sha1") echo "da39a3ee5e6b4b0d3255bfef95601890afd80709" ;;' >> staging_dir/host/bin/mkhash
            echo '  *) echo "00000000000000000000000000000000" ;;' >> staging_dir/host/bin/mkhash
            echo 'esac' >> staging_dir/host/bin/mkhash
            echo 'exit 0' >> staging_dir/host/bin/mkhash
            chmod +x staging_dir/host/bin/mkhash
          fi
          
          echo "✅ 主机工具准备完成" | tee -a "$MAIN_LOG"

      - name: "🎛️ 模式配置文件处理"
        id: mode_config
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🎛️ 模式配置文件处理 ===" | tee -a "$MAIN_LOG"
          
          BUILD_MODE="${{ github.event.inputs.build_mode }}"
          case "$BUILD_MODE" in
            "最小化") MODE_INTERNAL="minimal" ;;
            "标准") MODE_INTERNAL="standard" ;;
            "自定义") MODE_INTERNAL="custom" ;;
            *) MODE_INTERNAL="standard" ;;
          esac
          
          echo "🎯 构建模式: $BUILD_MODE ($MODE_INTERNAL)" | tee -a "$MAIN_LOG"
          
          # 根据模式添加配置
          case "$MODE_INTERNAL" in
            "minimal")
              echo "🔧 应用最小化模式配置..." | tee -a "$MAIN_LOG"
              echo "CONFIG_PACKAGE_base-files=y" >> .config
              echo "CONFIG_PACKAGE_busybox=y" >> .config
              echo "CONFIG_PACKAGE_dropbear=y" >> .config
              echo "CONFIG_PACKAGE_firewall=y" >> .config
              echo "CONFIG_PACKAGE_fstools=y" >> .config
              echo "CONFIG_PACKAGE_libc=y" >> .config
              echo "CONFIG_PACKAGE_libgcc=y" >> .config
              echo "CONFIG_PACKAGE_logd=y" >> .config
              echo "CONFIG_PACKAGE_mtd=y" >> .config
              echo "CONFIG_PACKAGE_netifd=y" >> .config
              echo "CONFIG_PACKAGE_opkg=y" >> .config
              echo "CONFIG_PACKAGE_procd=y" >> .config
              echo "CONFIG_PACKAGE_swconfig=y" >> .config
              echo "CONFIG_PACKAGE_ubox=y" >> .config
              echo "CONFIG_PACKAGE_ubus=y" >> .config
              echo "CONFIG_PACKAGE_ubusd=y" >> .config
              echo "CONFIG_PACKAGE_uci=y" >> .config
              echo "CONFIG_PACKAGE_uclient-fetch=y" >> .config
              echo "CONFIG_PACKAGE_urandom-seed=y" >> .config
              echo "CONFIG_PACKAGE_usign=y" >> .config
              ;;
            "standard")
              echo "🔧 应用标准模式配置..." | tee -a "$MAIN_LOG"
              echo "CONFIG_PACKAGE_base-files=y" >> .config
              echo "CONFIG_PACKAGE_busybox=y" >> .config
              echo "CONFIG_PACKAGE_dropbear=y" >> .config
              echo "CONFIG_PACKAGE_firewall=y" >> .config
              echo "CONFIG_PACKAGE_fstools=y" >> .config
              echo "CONFIG_PACKAGE_libc=y" >> .config
              echo "CONFIG_PACKAGE_libgcc=y" >> .config
              echo "CONFIG_PACKAGE_logd=y" >> .config
              echo "CONFIG_PACKAGE_mtd=y" >> .config
              echo "CONFIG_PACKAGE_netifd=y" >> .config
              echo "CONFIG_PACKAGE_opkg=y" >> .config
              echo "CONFIG_PACKAGE_procd=y" >> .config
              echo "CONFIG_PACKAGE_swconfig=y" >> .config
              echo "CONFIG_PACKAGE_ubox=y" >> .config
              echo "CONFIG_PACKAGE_ubus=y" >> .config
              echo "CONFIG_PACKAGE_ubusd=y" >> .config
              echo "CONFIG_PACKAGE_uci=y" >> .config
              echo "CONFIG_PACKAGE_uclient-fetch=y" >> .config
              echo "CONFIG_PACKAGE_urandom-seed=y" >> .config
              echo "CONFIG_PACKAGE_usign=y" >> .config
              echo "CONFIG_PACKAGE_luci=y" >> .config
              echo "CONFIG_PACKAGE_luci-base=y" >> .config
              echo "CONFIG_PACKAGE_luci-compat=y" >> .config
              echo "CONFIG_PACKAGE_luci-i18n-base-en=y" >> .config
              ;;
            "custom")
              echo "🔧 应用自定义模式配置..." | tee -a "$MAIN_LOG"
              echo "CONFIG_PACKAGE_base-files=y" >> .config
              echo "CONFIG_PACKAGE_busybox=y" >> .config
              echo "CONFIG_PACKAGE_dropbear=y" >> .config
              echo "CONFIG_PACKAGE_firewall=y" >> .config
              echo "CONFIG_PACKAGE_fstools=y" >> .config
              echo "CONFIG_PACKAGE_libc=y" >> .config
              echo "CONFIG_PACKAGE_libgcc=y" >> .config
              echo "CONFIG_PACKAGE_logd=y" >> .config
              echo "CONFIG_PACKAGE_netifd=y" >> .config
              echo "CONFIG_PACKAGE_opkg=y" >> .config
              echo "CONFIG_PACKAGE_procd=y" >> .config
              echo "CONFIG_PACKAGE_ubox=y" >> .config
              echo "CONFIG_PACKAGE_ubus=y" >> .config
              echo "CONFIG_PACKAGE_ubusd=y" >> .config
              echo "CONFIG_PACKAGE_uci=y" >> .config
              echo "CONFIG_PACKAGE_uclient-fetch=y" >> .config
              echo "CONFIG_PACKAGE_urandom-seed=y" >> .config
              echo "CONFIG_PACKAGE_usign=y" >> .config
              ;;
          esac
          
          echo "✅ 模式配置应用完成" | tee -a "$MAIN_LOG"

      - name: "⚡ 性能极速优化"
        id: performance
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ⚡ 性能极速优化 ===" | tee -a "$MAIN_LOG"
          
          CPU_CORES=$(nproc)
          echo "🖥️ 检测到 CPU 核心: $CPU_CORES" | tee -a "$MAIN_LOG"
          
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          case "$OPTIMIZATION_STRATEGY" in
            "速度优先")
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=$((CPU_CORES + 2))
              echo "🚀 极速模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            "稳定优先")
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=$((CPU_CORES / 2))
              echo "🛡️ 稳定模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            *)
              CCACHE_SIZE="6G"
              PARALLEL_JOBS=$CPU_CORES
              echo "⚖️ 平衡模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
          esac
          
          mkdir -p /mnt/ccache
          ccache -M $CCACHE_SIZE
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=100000
          
          echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          
          echo "💾 创建交换文件..." | tee -a "$MAIN_LOG"
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          sudo fallocate -l 8G /mnt/swapfile && sudo chmod 600 /mnt/swapfile && sudo mkswap /mnt/swapfile && sudo swapon /mnt/swapfile
          
          echo "📊 系统资源状态:" | tee -a "$MAIN_LOG"
          free -h | tee -a "$MAIN_LOG"
          echo "✅ 性能优化完成" | tee -a "$MAIN_LOG"

      - name: "🚀 极速依赖安装"
        id: install_deps
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🚀 极速依赖安装 ===" | tee -a "$MAIN_LOG"
          
          echo "📦 批量安装编译依赖..." | tee -a "$MAIN_LOG"
          sudo apt-get update -qq
          
          sudo apt-get install -y -qq build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-dev rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build libelf-dev libxml2-dev liblzma-dev liblzo2-dev axel net-tools e2fsprogs genext2fs dosfstools mtools libffi-dev libsqlite3-dev libpam0g-dev libtirpc-dev libev-dev lm-sensors libsnmp-dev libglib2.0-dev libgpiod-dev libfl-dev upx-ucl aria2 ncurses-term
          
          python3 -m pip install --upgrade pip setuptools wheel -q
          
          echo "✅ 依赖安装完成" | tee -a "$MAIN_LOG"

      - name: "🔧 配置验证与修复"
        id: config_validation
        timeout-minutes: 10
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔧 配置验证与修复 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "🔍 验证配置完整性..." | tee -a "$MAIN_LOG"
          
          # 备份配置
          cp .config .config.backup
          
          echo "🔧 使用defconfig生成完整配置..." | tee -a "$MAIN_LOG"
          export TERM=dumb
          export LC_ALL=C
          
          # 使用defconfig而非oldconfig，避免交互
          echo "🔧 执行make defconfig..." | tee -a "$MAIN_LOG"
          if make defconfig; then
            echo "✅ defconfig成功完成" | tee -a "$MAIN_LOG"
          else
            echo "⚠️ defconfig有警告，继续..." | tee -a "$MAIN_LOG"
          fi
          
          # 确保目标配置正确
          echo "🔧 验证目标配置..." | tee -a "$MAIN_LOG"
          if grep -q "CONFIG_TARGET_${{ env.TARGET_NAME }}=y" .config; then
            echo "✅ 目标配置正确: ${{ env.TARGET_NAME }}" | tee -a "$MAIN_LOG"
          else
            echo "❌ 目标配置错误，恢复备份..." | tee -a "$MAIN_LOG"
            cp .config.backup .config
          fi
          
          echo "🔍 最终配置检查:" | tee -a "$MAIN_LOG"
          TARGET_TYPE=$(grep "CONFIG_TARGET.*=y" .config | head -1 | cut -d'=' -f1 | cut -d'_' -f3 || echo "unknown")
          TARGET_COUNT=$(grep -c "CONFIG_TARGET.*=y" .config 2>/dev/null || echo 0)
          
          echo "✅ 目标系统类型: $TARGET_TYPE" | tee -a "$MAIN_LOG"
          echo "✅ 目标配置数量: $TARGET_COUNT" | tee -a "$MAIN_LOG"
          
          BASE_FILES=$(grep -c "CONFIG_PACKAGE_base-files=y" .config 2>/dev/null || echo 0)
          BUSYBOX=$(grep -c "CONFIG_PACKAGE_busybox=y" .config 2>/dev/null || echo 0)
          
          echo "✅ 基础文件系统: $BASE_FILES" | tee -a "$MAIN_LOG"
          echo "✅ BusyBox: $BUSYBOX" | tee -a "$MAIN_LOG"
          
          if [ "$TARGET_COUNT" -eq 0 ] || [ "$BASE_FILES" -eq 0 ] || [ "$BUSYBOX" -eq 0 ]; then
            echo "❌ 关键配置缺失" | tee -a "$MAIN_LOG"
            echo "💥 配置验证失败" | tee -a "$MAIN_LOG"
            exit 1
          fi
          
          echo "🔍 最终目标配置:" | tee -a "$MAIN_LOG"
          grep -E "CONFIG_TARGET" .config | head -10 | tee -a "$MAIN_LOG"
          
          echo "✅ 配置验证完成" | tee -a "$MAIN_LOG"

      - name: "🔄 并行Feeds更新"
        id: feeds_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔄 并行Feeds更新 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          CURRENT_BRANCH=$(git branch --show-current)
          if [[ "$CURRENT_BRANCH" == *"22.03"* ]]; then FEEDS_BRANCH="openwrt-22.03"
          elif [[ "$CURRENT_BRANCH" == *"21.02"* ]]; then FEEDS_BRANCH="openwrt-21.02"
          else FEEDS_BRANCH="master"; fi
          
          case "${{ env.SOURCE_PRESET }}" in
            "immortalwrt")
              echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "openwrt")
              echo "src-git packages https://git.openwrt.org/feed/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://git.openwrt.org/project/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "lede")
              echo "src-git packages https://github.com/coolsnowwolf/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/coolsnowwolf/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
          esac
          
          echo "src-git routing https://github.com/openwrt/routing.git;$FEEDS_BRANCH" >> feeds.conf
          
          echo "🔄 并行更新feeds..." | tee -a "$MAIN_LOG"
          ./scripts/feeds update -a &
          FEEDS_PID=$!
          
          mkdir -p /mnt/downloads
          [ -d "dl" ] && rm -rf dl
          ln -sf /mnt/downloads dl
          
          wait $FEEDS_PID
          ./scripts/feeds install -a
          
          echo "✅ Feeds更新完成" | tee -a "$MAIN_LOG"

      - name: "🌐 语言包配置"
        id: language_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🌐 语言包配置 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          LANGUAGE="${{ github.event.inputs.language_pack }}"
          case "$LANGUAGE" in
            "简体中文") LANG_INTERNAL="zh-cn" ;;
            "仅英文") LANG_INTERNAL="en-only" ;;
            "全部语言") LANG_INTERNAL="all" ;;
            *) LANG_INTERNAL="zh-cn" ;;
          esac
          
          echo "🎯 语言包选择: $LANGUAGE ($LANG_INTERNAL)" | tee -a "$MAIN_LOG"
          
          CURRENT_BRANCH="${{ env.ACTUAL_BRANCH }}"
          
          case "$LANG_INTERNAL" in
            "zh-cn")
              echo "🔧 启用中文语言包..." | tee -a "$MAIN_LOG"
              if [[ "$CURRENT_BRANCH" == *"21.02"* ]]; then
                sed -i 's/# CONFIG_PACKAGE_luci-i18n-base-zh-cn is not set/CONFIG_PACKAGE_luci-i18n-base-zh-cn=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
              else
                sed -i 's/# CONFIG_PACKAGE_luci-i18n-base-zh_Hans is not set/CONFIG_PACKAGE_luci-i18n-base-zh_Hans=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-i18n-base-zh_Hans=y" >> .config
              fi
              ;;
            "en-only")
              echo "🔧 仅保留英文..." | tee -a "$MAIN_LOG"
              sed -i 's/CONFIG_PACKAGE_luci-i18n-[^e][^n].*=y/# &/' .config
              ;;
            "all")
              echo "🔧 启用所有语言包..." | tee -a "$MAIN_LOG"
              for lang in $(grep "CONFIG_PACKAGE_luci-i18n-" .config | grep "is not set" | cut -d' ' -f2); do
                sed -i "s/# $lang is not set/$lang=y/" .config
              done
              ;;
          esac
          
          echo "✅ 语言包配置完成" | tee -a "$MAIN_LOG"

      - name: "🔧 编译工具链"
        id: build_toolchain
        timeout-minutes: 30
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔧 编译工具链 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          export TERM=linux
          export LC_ALL=C
          export FORCE_UNSAFE_CONFIGURE=1
          
          echo "🔧 编译工具链（这一步较慢）..." | tee -a "$MAIN_LOG"
          make toolchain/compile -j${{ env.PARALLEL_JOBS }} || make toolchain/compile -j1 V=s
          
          echo "✅ 工具链编译完成" | tee -a "$MAIN_LOG"

      - name: "🌐 智能下载优化"
        id: smart_download
        timeout-minutes: 45
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          DOWNLOAD_LOG="${{ env.DOWNLOAD_LOG }}"
          echo "=== 🌐 智能下载优化 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          export TERM=linux
          export LC_ALL=C
          export FORCE_UNSAFE_CONFIGURE=1
          
          echo "🔧 验证构建环境..." | tee -a "$MAIN_LOG"
          echo "🔍 检查主机工具..." | tee -a "$MAIN_LOG"
          ls -la staging_dir/host/bin/ | head -10 | tee -a "$MAIN_LOG"
          
          # 修复下载配置
          echo "🔧 修复下载镜像源..." | tee -a "$MAIN_LOG"
          sed -i 's|https://sources.cdn.openwrt.org|https://mirror2.openwrt.org/sources|g' scripts/download.pl 2>/dev/null || true
          sed -i 's|git.openwrt.org|github.com/openwrt|g' feeds.conf.* 2>/dev/null || true
          
          # 设置下载重试
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          
          echo "📥 开始分阶段下载..." | tee -a "$MAIN_LOG"
          echo "开始下载流程: $(date)" >> "$DOWNLOAD_LOG"
          
          # 阶段1: 只下载工具
          echo "🔧 阶段1: 下载工具..." | tee -a "$MAIN_LOG"
          if make tools/download -j1 V=s; then
            echo "✅ 工具下载成功" | tee -a "$MAIN_LOG"
          else
            echo "⚠️ 工具下载有警告，继续..." | tee -a "$MAIN_LOG"
          fi
          
          # 阶段2: 下载工具链
          echo "🔧 阶段2: 下载工具链..." | tee -a "$MAIN_LOG"
          if make toolchain/download -j1 V=s; then
            echo "✅ 工具链下载成功" | tee -a "$MAIN_LOG"
          else
            echo "⚠️ 工具链下载有警告，继续..." | tee -a "$MAIN_LOG"
          fi
          
          # 阶段3: 并行下载包
          echo "🔧 阶段3: 并行下载包..." | tee -a "$MAIN_LOG"
          if make package/download -j$PARALLEL_JOBS; then
            echo "✅ 包下载成功" | tee -a "$MAIN_LOG"
            echo "DOWNLOAD_COMPLETE=true" >> $GITHUB_ENV
          else
            echo "⚠️ 包下载有错误，尝试单线程..." | tee -a "$MAIN_LOG"
            make package/download -j1 V=s
          fi
          
          # 验证下载结果
          DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
          echo "DOWNLOAD_FILE_COUNT=$DOWNLOAD_COUNT" >> $GITHUB_ENV
          echo "✅ 下载完成，文件数量: $DOWNLOAD_COUNT" | tee -a "$MAIN_LOG"

      - name: "⚡ 智能编译执行"
        id: smart_build
        timeout-minutes: 150
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          ANALYSIS_REPORT="${{ env.ANALYSIS_REPORT }}"
          echo "=== ⚡ 智能编译执行 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          export TERM=linux
          export LC_ALL=C
          export FORCE_UNSAFE_CONFIGURE=1
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          
          echo "🔧 编译配置: 并行作业=$PARALLEL_JOBS" | tee -a "$MAIN_LOG"
          
          echo "🔍 编译前最终检查..." | tee -a "$MAIN_LOG"
          make defconfig
          
          mkdir -p logs
          
          compile_with_recovery() {
            local stage_name="$1"
            local make_target="$2"
            local max_retries=2
            local retry_count=0
            
            while [ $retry_count -le $max_retries ]; do
              echo "🛠️ $stage_name (尝试 $((retry_count + 1))/$((max_retries + 1)))..." | tee -a "$MAIN_LOG"
              
              TEMP_LOG=$(mktemp)
              set +e
              if [ $retry_count -eq 0 ]; then
                make $make_target -j$PARALLEL_JOBS 2>&1 | tee "$TEMP_LOG"
              else
                make $make_target -j1 V=s 2>&1 | tee "$TEMP_LOG"
              fi
              local result=${PIPESTATUS[0]}
              set -e
              
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              
              if [ $result -eq 0 ]; then
                echo "✅ $stage_name 成功" | tee -a "$MAIN_LOG"
                rm -f "$TEMP_LOG"
                return 0
              else
                echo "❌ $stage_name 失败" | tee -a "$MAIN_LOG"
                
                if [ $retry_count -lt $max_retries ]; then
                  echo "🔄 准备重试..." | tee -a "$MAIN_LOG"
                  retry_count=$((retry_count + 1))
                  
                  case "$stage_name" in
                    "工具链编译")
                      echo "🔄 清理工具链缓存..." | tee -a "$MAIN_LOG"
                      make toolchain/clean
                      ;;
                    "内核编译")
                      echo "🔄 清理内核构建..." | tee -a "$MAIN_LOG"
                      make target/linux/clean
                      ;;
                  esac
                else
                  echo "💥 $stage_name 彻底失败" | tee -a "$MAIN_LOG"
                  cat "$TEMP_LOG" >> "$ERROR_LOG"
                  rm -f "$TEMP_LOG"
                  return 1
                fi
              fi
              rm -f "$TEMP_LOG"
            done
          }
          
          echo "🔧 预编译宿主工具..." | tee -a "$MAIN_LOG"
          if ! compile_with_recovery "宿主工具编译" "tools/install"; then
            echo "⚠️ 宿主工具编译有警告，但继续构建" | tee -a "$MAIN_LOG"
          fi
          
          if ! compile_with_recovery "工具链编译" "toolchain/install"; then
            echo "💥 工具链编译失败，构建终止" | tee -a "$MAIN_LOG"
            exit 1
          fi
          
          if ! compile_with_recovery "内核编译" "target/linux/install"; then
            echo "💥 内核编译失败，构建终止" | tee -a "$MAIN_LOG"
            exit 1
          fi
          
          if ! compile_with_recovery "完整编译" ""; then
            echo "💥 完整编译失败" | tee -a "$MAIN_LOG"
            exit 1
          fi
          
          FIRMWARE_FOUND=false
          if find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | grep -q .; then
            echo "🎉 找到固件文件！" | tee -a "$MAIN_LOG"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) -exec ls -la {} \; | tee -a "$MAIN_LOG"
            FIRMWARE_FOUND=true
            FIRMWARE_COUNT=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | wc -l)
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "FIRMWARE_COUNT=$FIRMWARE_COUNT" >> $GITHUB_ENV
          else
            echo "💥 未找到固件文件" | tee -a "$MAIN_LOG"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "FIRMWARE_FOUND=$FIRMWARE_FOUND" >> $GITHUB_ENV
          
          echo "📊 CCache统计:" | tee -a "$MAIN_LOG"
          ccache -s | tee -a "$MAIN_LOG"
          
          echo "=== 编译总结 ===" | tee -a "$MAIN_LOG"
          echo "构建状态: 成功" | tee -a "$MAIN_LOG"
          echo "固件生成: 是" | tee -a "$MAIN_LOG"
          echo "固件数量: $FIRMWARE_COUNT" | tee -a "$MAIN_LOG"

      - name: "📦 极速产物收集"
        id: collect_artifacts
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 📦 极速产物收集 ===" | tee -a "$MAIN_LOG"
          
          mkdir -p /mnt/artifacts/firmware
          ARTIFACT_COUNT=0
          
          if [ -d "/mnt/source/bin/targets" ]; then
            find /mnt/source/bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) -exec cp {} /mnt/artifacts/firmware/ \;
            ARTIFACT_COUNT=$(ls /mnt/artifacts/firmware/ 2>/dev/null | wc -l || echo 0)
          fi
          
          cp "$MAIN_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$ERROR_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$WARNING_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$ANALYSIS_REPORT" /mnt/artifacts/ 2>/dev/null || true
          cp "$DOWNLOAD_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp /mnt/source/.config /mnt/artifacts/ 2>/dev/null || true
          
          echo "ARTIFACT_COUNT=$ARTIFACT_COUNT" >> $GITHUB_ENV
          echo "✅ 收集了 $ARTIFACT_COUNT 个产物" | tee -a "$MAIN_LOG"

      - name: "💾 上传构建产物"
        id: upload_artifacts
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Build-Artifacts-${{ github.run_number }}"
          path: "/mnt/artifacts"
          retention-days: 7
          compression-level: 6

      - name: "📊 智能构建报告"
        id: final_report
        if: always()
        run: |
          echo "=== 📊 智能构建报告 ==="
          echo ""
          echo "🎯 构建摘要"
          echo "=========================================="
          echo "⚡ 编译性能:"
          echo "  - 并行作业: ${{ env.PARALLEL_JOBS || 'N/A' }}"
          echo "  - 构建状态: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - 下载重试: ${{ env.DOWNLOAD_RETRY_COUNT || 'N/A' }}"
          echo ""
          echo "📦 构建结果:"
          echo "  - 固件数量: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - 产物数量: ${{ env.ARTIFACT_COUNT || 0 }}"
          echo "  - 下载文件: ${{ env.DOWNLOAD_FILE_COUNT || 0 }}"
          echo ""
          echo "🔧 配置信息:"
          echo "  - 目标系统: ${{ env.TARGET_NAME || 'unknown' }}"
          echo "  - 设备名称: ${{ env.DEVICE_NAME || 'unknown' }}"
          echo "  - 构建模式: ${{ github.event.inputs.build_mode || 'unknown' }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ] && [ "${{ env.FIRMWARE_COUNT }}" -gt 0 ]; then
            echo "🎉 智能构建成功！"
            echo "💡 固件已生成并上传到产物"
          else
            echo "❌ 构建失败或未生成固件"
            echo "🔧 主要问题: 配置阶段卡住或设备识别错误"
            echo "💡 解决方案: 检查设备名称是否正确，确保配置阶段正确设置目标设备"
          fi
          echo "=========================================="
