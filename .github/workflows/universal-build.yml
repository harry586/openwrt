name: "Universal Firmware Builder - Reliable Version"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "auto"
        type: string
      config_profile:
        description: "è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„"
        required: true
        type: string
        default: ".config_rt-ac42u_immortalwrt"

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 240
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"

      - name: "ğŸ’¾ åŸºç¡€ç¯å¢ƒè®¾ç½®"
        timeout-minutes: 5
        run: |
          echo "=== ğŸ’¾ åŸºç¡€ç¯å¢ƒè®¾ç½® ==="
          sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }}
          sudo chown -R $USER:$USER /mnt/*
          
          # è®¾ç½®äº¤æ¢æ–‡ä»¶
          sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=16384 status=progress
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          
          echo "âœ… ç¯å¢ƒè®¾ç½®å®Œæˆ"

      - name: "ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–"
        timeout-minutes: 10
        run: |
          echo "=== ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ– ==="
          sudo apt-get update
          sudo apt-get install -y build-essential git flex bison g++ gawk gcc-multilib g++-multilib gettext libncurses5-dev libssl-dev python3 python3-pip rsync unzip zlib1g-dev file wget ccache libtool automake autoconf binutils
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: "ğŸ“¥ è·å–æºç "
        timeout-minutes: 15
        run: |
          echo "=== ğŸ“¥ è·å–æºç  ==="
          cd ${{ env.SOURCE_DIR }}
          rm -rf ./*
          echo "ğŸ”§ å…‹éš†æºç ..."
          git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git .
          echo "âœ… æºç è·å–å®Œæˆ"

      - name: "ğŸ”§ åº”ç”¨é…ç½®æ–‡ä»¶"
        timeout-minutes: 5
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ”§ åº”ç”¨é…ç½®æ–‡ä»¶ ==="
          
          # ä½¿ç”¨ç®€å•ç›´æ¥çš„æ–‡ä»¶æŸ¥æ‰¾æ–¹æ³•
          CONFIG_FILE=""
          
          # é¦–å…ˆå°è¯•ç”¨æˆ·æŒ‡å®šçš„è·¯å¾„
          if [ -f "$GITHUB_WORKSPACE/${{ github.event.inputs.config_profile }}" ]; then
            CONFIG_FILE="$GITHUB_WORKSPACE/${{ github.event.inputs.config_profile }}"
            echo "âœ… åœ¨æŒ‡å®šè·¯å¾„æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FILE"
          else
            # åœ¨å¸¸è§ä½ç½®æœç´¢
            echo "ğŸ” åœ¨å¸¸è§ä½ç½®æœç´¢é…ç½®æ–‡ä»¶..."
            POSSIBLE_PATHS=(
              "$GITHUB_WORKSPACE/${{ github.event.inputs.config_profile }}"
              "$GITHUB_WORKSPACE/configs/${{ github.event.inputs.config_profile }}"
              "$GITHUB_WORKSPACE/firmware-config/${{ github.event.inputs.config_profile }}"
              "$GITHUB_WORKSPACE/../${{ github.event.inputs.config_profile }}"
              "./${{ github.event.inputs.config_profile }}"
            )
            
            for path in "${POSSIBLE_PATHS[@]}"; do
              if [ -f "$path" ]; then
                CONFIG_FILE="$path"
                echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FILE"
                break
              fi
            done
          fi
          
          if [ -z "$CONFIG_FILE" ]; then
            echo "âŒ é”™è¯¯: æ— æ³•æ‰¾åˆ°é…ç½®æ–‡ä»¶ '${{ github.event.inputs.config_profile }}'"
            echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            echo "ğŸ“ GITHUB_WORKSPACE å†…å®¹:"
            ls -la "$GITHUB_WORKSPACE"
            exit 1
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "$CONFIG_FILE" .config
          echo "âœ… é…ç½®æ–‡ä»¶åº”ç”¨å®Œæˆ"

      - name: "ğŸ”§ åŸºç¡€é…ç½®ä¿®å¤"
        timeout-minutes: 5
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ”§ åŸºç¡€é…ç½®ä¿®å¤ ==="
          
          # ç¡®ä¿åŸºæœ¬é…ç½®
          echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> .config
          echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> .config
          
          # è¿è¡Œdefconfig
          make defconfig
          echo "âœ… åŸºç¡€é…ç½®ä¿®å¤å®Œæˆ"

      - name: "ğŸ”„ åˆå§‹åŒ–Feeds"
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ”„ åˆå§‹åŒ–Feeds ==="
          
          # ä½¿ç”¨æ ‡å‡†feedsé…ç½®
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "âœ… Feedsåˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸ“¥ ä¸‹è½½æºç åŒ…"
        timeout-minutes: 30
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ“¥ ä¸‹è½½æºç åŒ… ==="
          
          mkdir -p ${{ env.DOWNLOAD_DIR }}
          [ -d "dl" ] && rm -rf dl
          ln -sf ${{ env.DOWNLOAD_DIR }} dl
          
          make download -j1
          echo "âœ… ä¸‹è½½å®Œæˆ"

      - name: "ğŸ› ï¸ ç¼–è¯‘å·¥å…·é“¾"
        timeout-minutes: 90
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ› ï¸ ç¼–è¯‘å·¥å…·é“¾ ==="
          
          # è®¾ç½®ç¯å¢ƒ
          export FORCE_UNSAFE_CONFIGURE=1
          
          echo "ğŸ”§ ç¼–è¯‘å·¥å…·..."
          make tools/install -j2
          
          echo "ğŸ”§ ç¼–è¯‘å·¥å…·é“¾..."
          if make toolchain/compile -j2; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            echo "TOOLCHAIN_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
            if make toolchain/compile -j1; then
              echo "âœ… å•çº¿ç¨‹å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
              echo "TOOLCHAIN_SUCCESS=true" >> $GITHUB_ENV
            else
              echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
              exit 1
            fi
          fi

      - name: "ğŸš€ ç¼–è¯‘å›ºä»¶"
        if: env.TOOLCHAIN_SUCCESS == 'true'
        timeout-minutes: 120
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸš€ ç¼–è¯‘å›ºä»¶ ==="
          
          echo "ğŸ”§ å¼€å§‹ç¼–è¯‘..."
          if make -j2; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
            if make -j1; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
              echo "BUILD_STATUS=success" >> $GITHUB_ENV
            else
              echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•å¤±è´¥"
              exit 1
            fi
          fi

      - name: "ğŸ“¦ æ”¶é›†äº§ç‰©"
        if: env.BUILD_STATUS == 'success'
        timeout-minutes: 5
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ“¦ æ”¶é›†äº§ç‰© ==="
          mkdir -p ${{ env.ARTIFACTS_DIR }}/firmware
          
          if [ -d "bin/targets" ]; then
            # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) -exec cp {} ${{ env.ARTIFACTS_DIR }}/firmware/ \;
            FIRMWARE_COUNT=$(find ${{ env.ARTIFACTS_DIR }}/firmware -type f | wc -l)
            echo "FIRMWARE_COUNT=$FIRMWARE_COUNT" >> $GITHUB_ENV
            echo "âœ… æ”¶é›† $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
            
            # æ£€æŸ¥å·¥å‚é•œåƒ
            ASUS_FACTORY=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -i factory || true)
            if [ -n "$ASUS_FACTORY" ]; then
              echo "âœ… å·¥å‚é•œåƒå·²ç”Ÿæˆ"
              echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
            else
              echo "âš ï¸ æœªæ‰¾åˆ°å·¥å‚é•œåƒ"
              echo "FACTORY_EXISTS=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘è¾“å‡ºç›®å½•"
          fi

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
        if: env.BUILD_STATUS == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: "firmware-build"
          path: ${{ env.ARTIFACTS_DIR }}
          retention-days: 7

      - name: "ğŸ“‹ ç”ŸæˆæŠ¥å‘Š"
        if: always()
        timeout-minutes: 3
        run: |
          echo "=== ğŸ“‹ æ„å»ºæŠ¥å‘Š ==="
          echo "æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "å·¥å‚é•œåƒ: ${{ env.FACTORY_EXISTS || 'unknown' }}"
          
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            if [ "${{ env.FACTORY_EXISTS }}" = "true" ]; then
              echo "ğŸ‰ æ„å»ºæˆåŠŸï¼å·¥å‚é•œåƒå·²ç”Ÿæˆ"
            else
              echo "âš ï¸ æ„å»ºæˆåŠŸä½†æœªç”Ÿæˆå·¥å‚é•œåƒ"
            fi
          else
            echo "âŒ æ„å»ºå¤±è´¥"
          fi
