name: "Universal Firmware Builder"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "选择源码库"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "源码分支"
        required: true
        default: "master"
        type: string
      config_profile:
        description: "设备配置文件路径"
        required: true
        type: string
        default: ".config_rt-ac42u_immortalwrt"
      build_optimization:
        description: "编译优化策略"
        required: true
        type: choice
        options: ["balanced", "speed", "stability"]
        default: "balanced"
      enable_advanced:
        description: "启用高级功能"
        required: false
        default: true
        type: boolean
      custom_patches:
        description: "自定义补丁URL或路径"
        required: false
        default: ""
        type: string
      extra_packages:
        description: "额外软件包列表(逗号分隔)"
        required: false
        default: "luci,luci-theme-material,luci-app-upnp,luci-app-wireguard,luci-app-samba4,luci-app-turboacc"
        type: string
      debug_mode:
        description: "启用调试模式"
        required: false
        default: false
        type: boolean

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 360
    
    steps:
      - name: "📥 检出配置仓库"
        uses: "actions/checkout@v4"
        with:
          path: "config-repo"
          fetch-depth: 0

      - name: "🔧 初始化工作环境"
        run: |
          echo "=== 🔧 初始化工作环境 ==="
          sudo mkdir -p /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chown -R $USER:$USER /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chmod -R 755 /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          mkdir -p /mnt/build-logs
          MAIN_LOG="/mnt/build-logs/build_timeline.log"
          echo "🏁 构建开始时间: $(date)" > $MAIN_LOG
          echo "🔧 工作流版本: Enhanced Customization" >> $MAIN_LOG
          echo "📋 输入参数:" >> $MAIN_LOG
          echo "  - 源码预设: ${{ github.event.inputs.source_preset }}" >> $MAIN_LOG
          echo "  - 源码分支: ${{ github.event.inputs.source_branch }}" >> $MAIN_LOG
          echo "  - 配置方案: ${{ github.event.inputs.config_profile }}" >> $MAIN_LOG
          echo "  - 高级功能: ${{ github.event.inputs.enable_advanced }}" >> $MAIN_LOG
          echo "  - 自定义补丁: ${{ github.event.inputs.custom_patches }}" >> $MAIN_LOG
          echo "  - 额外包: ${{ github.event.inputs.extra_packages }}" >> $MAIN_LOG
          echo "  - 调试模式: ${{ github.event.inputs.debug_mode }}" >> $MAIN_LOG
          echo "==========================================" >> $MAIN_LOG
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV
          echo "CONFIG_REPO_DIR=${{ github.workspace }}/config-repo" >> $GITHUB_ENV
          echo "✅ 工作环境初始化完成"

      - name: "💾 环境设置与资源管理"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 💾 环境设置与资源管理 ===" | tee -a "$MAIN_LOG"
          echo "📊 系统信息:" | tee -a "$MAIN_LOG"
          echo "  - 系统: $(lsb_release -d | cut -f2)" | tee -a "$MAIN_LOG"
          echo "  - 内核: $(uname -r)" | tee -a "$MAIN_LOG"
          echo "  - CPU: $(nproc) 核心" | tee -a "$MAIN_LOG"
          echo "  - 内存: $(free -h | awk 'NR==2{print $7}') 可用" | tee -a "$MAIN_LOG"
          echo "💾 磁盘空间状态:" | tee -a "$MAIN_LOG"
          df -h | tee -a "$MAIN_LOG"
          echo "🔄 创建交换文件..." | tee -a "$MAIN_LOG"
          SWAP_SIZE="32G"
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          echo "📦 创建 ${SWAP_SIZE} 交换文件..." | tee -a "$MAIN_LOG"
          sudo fallocate -l $SWAP_SIZE /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          echo "📊 内存状态:" | tee -a "$MAIN_LOG"
          free -h | tee -a "$MAIN_LOG"
          echo "✅ 环境设置完成" | tee -a "$MAIN_LOG"

      - name: "🛠️ 安装编译依赖"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🛠️ 安装编译依赖 ===" | tee -a "$MAIN_LOG"
          echo "📦 更新软件包列表..." | tee -a "$MAIN_LOG"
          sudo apt-get update -qq
          echo "🔧 安装核心编译工具..." | tee -a "$MAIN_LOG"
          sudo apt-get install -y -qq build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-dev rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build libelf-dev libxml2-dev liblzma-dev liblzo2-dev axel net-tools e2fsprogs genext2fs dosfstools mtools libffi-dev libsqlite3-dev libpam0g-dev libtirpc-dev libev-dev lm-sensors libsnmp-dev libglib2.0-dev libgpiod-dev
          echo "🐍 配置Python环境..." | tee -a "$MAIN_LOG"
          python3 -m pip install --upgrade pip
          python3 -m pip install setuptools wheel
          echo "✅ 依赖安装完成" | tee -a "$MAIN_LOG"

      - name: "⚡ 性能优化配置"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ⚡ 性能优化配置 ===" | tee -a "$MAIN_LOG"
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          echo "🎯 编译优化策略: $OPTIMIZATION_STRATEGY" | tee -a "$MAIN_LOG"
          case "$OPTIMIZATION_STRATEGY" in
            "speed")
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=2
              echo "🚀 速度优先模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            "stability")
              CCACHE_SIZE="2G"
              PARALLEL_JOBS=1
              echo "🛡️ 稳定性优先模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            *)
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=2
              echo "⚖️ 平衡模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
          esac
          mkdir -p /mnt/ccache
          ccache -M $CCACHE_SIZE
          ccache -o compression=true
          ccache -o compression_level=6
          echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          echo "📊 初始CCache统计:" | tee -a "$MAIN_LOG"
          ccache -s | tee -a "$MAIN_LOG"
          echo "✅ 性能优化完成" | tee -a "$MAIN_LOG"

      - name: "🔧 源码配置与获取"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔧 源码配置与获取 ===" | tee -a "$MAIN_LOG"
          REPO_JSON_FOUND="${{ env.CONFIG_REPO_DIR }}/firmware-config/repositories.json"
          if [ ! -f "$REPO_JSON_FOUND" ]; then
            echo "❌ 错误: 未找到 repositories.json 文件" | tee -a "$MAIN_LOG"
            exit 1
          fi
          echo "✅ 找到配置文件: $REPO_JSON_FOUND" | tee -a "$MAIN_LOG"
          PRESET="${{ github.event.inputs.source_preset }}"
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND" 2>/dev/null || echo "")
          if [ -z "$SOURCE_URL" ]; then
            echo "❌ 错误: 预设 '$PRESET' 在配置文件中不存在" | tee -a "$MAIN_LOG"
            exit 1
          fi
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND" 2>/dev/null || echo "master")
          fi
          echo "📦 源码信息:" | tee -a "$MAIN_LOG"
          echo "  - URL: $SOURCE_URL" | tee -a "$MAIN_LOG"
          echo "  - 分支: $BRANCH" | tee -a "$MAIN_LOG"
          echo "  - 预设: $PRESET" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "🔄 克隆源码..." | tee -a "$MAIN_LOG"
          rm -rf .[!.]* * 2>/dev/null || true
          echo "📥 克隆尝试..." | tee -a "$MAIN_LOG"
          if git clone --depth 1 --branch "$BRANCH" "$SOURCE_URL" . 2>&1; then
            if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
              echo "✅ 源码克隆成功" | tee -a "$MAIN_LOG"
            else
              echo "❌ 源码结构不完整" | tee -a "$MAIN_LOG"
              exit 1
            fi
          else
            echo "❌ 源码克隆失败" | tee -a "$MAIN_LOG"
            exit 1
          fi
          ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          echo "✅ 源码克隆成功" | tee -a "$MAIN_LOG"
          echo "  - 实际分支: $ACTUAL_BRANCH" | tee -a "$MAIN_LOG"
          echo "  - 提交哈希: $COMMIT_HASH" | tee -a "$MAIN_LOG"
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV

      - name: "🔧 配置下载镜像源"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔧 配置下载镜像源 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "🌐 配置多镜像源..." | tee -a "$MAIN_LOG"
          echo "src-gz openwrt_base https://mirrors.ustc.edu.cn/lede/releases/22.03.5/packages/aarch64_cortex-a53/base" > download-mirrors.conf
          echo "src-gz openwrt_luci https://mirrors.ustc.edu.cn/lede/releases/22.03.5/packages/aarch64_cortex-a53/luci" >> download-mirrors.conf
          echo "src-gz openwrt_packages https://mirrors.ustc.edu.cn/lede/releases/22.03.5/packages/aarch64_cortex-a53/packages" >> download-mirrors.conf
          echo "src-gz openwrt_routing https://mirrors.ustc.edu.cn/lede/releases/22.03.5/packages/aarch64_cortex-a53/routing" >> download-mirrors.conf
          echo "src-gz openwrt_telephony https://mirrors.ustc.edu.cn/lede/releases/22.03.5/packages/aarch64_cortex-a53/telephony" >> download-mirrors.conf
          echo "🔧 修复下载脚本..." | tee -a "$MAIN_LOG"
          sed -i 's|https://downloads.openwrt.org|https://mirrors.ustc.edu.cn/lede|g' scripts/download.pl
          sed -i 's|https://cdn.kernel.org|https://mirrors.ustc.edu.cn/kernel|g' scripts/download.pl
          sed -i 's|https://www.netfilter.org|https://mirrors.ustc.edu.cn/netfilter|g' scripts/download.pl
          echo "📥 设置下载重试..." | tee -a "$MAIN_LOG"
          echo "DOWNLOAD_MAX_CONNECTION=5" >> include/prereq.mk
          echo "WGET_OPTIONS='--timeout=30 --tries=5 --retry-connrefused'" >> include/prereq.mk
          echo "✅ 镜像源配置完成" | tee -a "$MAIN_LOG"

      - name: "🔄 源码初始化与Feeds配置"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔄 源码初始化与Feeds配置 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "📋 配置Feeds..." | tee -a "$MAIN_LOG"
          case "${{ env.SOURCE_PRESET }}" in
            "immortalwrt")
              echo "src-git packages https://github.com/immortalwrt/packages.git;openwrt-22.03" > feeds.conf
              echo "src-git luci https://github.com/immortalwrt/luci.git;openwrt-22.03" >> feeds.conf
              ;;
            "openwrt")
              echo "src-git packages https://git.openwrt.org/feed/packages.git;openwrt-22.03" > feeds.conf
              echo "src-git luci https://git.openwrt.org/project/luci.git;openwrt-22.03" >> feeds.conf
              ;;
            "lede")
              echo "src-git packages https://github.com/coolsnowwolf/packages.git;master" > feeds.conf
              echo "src-git luci https://github.com/coolsnowwolf/luci.git;master" >> feeds.conf
              ;;
          esac
          echo "src-git routing https://github.com/openwrt/routing.git;openwrt-22.03" >> feeds.conf
          echo "src-git telephony https://github.com/openwrt/telephony.git;openwrt-22.03" >> feeds.conf
          
          echo "🔄 更新Feeds..." | tee -a "$MAIN_LOG"
          MAX_FEED_ATTEMPTS=5
          FEED_SUCCESS=false
          for attempt in $(seq 1 $MAX_FEED_ATTEMPTS); do
            echo "🔄 Feeds更新尝试 $attempt/$MAX_FEED_ATTEMPTS..." | tee -a "$MAIN_LOG"
            TEMP_LOG=$(mktemp)
            if { ./scripts/feeds update -a 2>&1 | tee "$TEMP_LOG"; } then
              if grep -i -E "error|failed|fatal" "$TEMP_LOG"; then
                echo "⚠️ Feeds更新有错误，重试 $attempt/$MAX_FEED_ATTEMPTS..." | tee -a "$MAIN_LOG"
                cat "$TEMP_LOG" >> "$MAIN_LOG"
                rm -f "$TEMP_LOG"
                sleep 10
              else
                echo "✅ Feeds更新成功" | tee -a "$MAIN_LOG"
                cat "$TEMP_LOG" >> "$MAIN_LOG"
                rm -f "$TEMP_LOG"
                FEED_SUCCESS=true
                break
              fi
            else
              echo "⚠️ Feeds更新失败，重试 $attempt/$MAX_FEED_ATTEMPTS..." | tee -a "$MAIN_LOG"
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              rm -f "$TEMP_LOG"
              sleep 10
            fi
          done
          
          if [ "$FEED_SUCCESS" = "false" ]; then
            echo "❌ Feeds更新失败，但继续执行编译..." | tee -a "$MAIN_LOG"
          fi
          
          echo "📦 安装Feeds..." | tee -a "$MAIN_LOG"
          if ./scripts/feeds install -a 2>&1; then
            echo "✅ Feeds安装成功" | tee -a "$MAIN_LOG"
          else
            echo "⚠️ Feeds安装有警告，但继续执行..." | tee -a "$MAIN_LOG"
          fi
          echo "✅ 源码初始化完成" | tee -a "$MAIN_LOG"

      - name: "🎯 应用设备配置"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🎯 应用设备配置 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "🔍 查找配置文件: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
          
          # 多种方式查找配置文件
          CONFIG_FOUND=""
          
          # 方法1: 精确匹配
          SEARCH_PATHS=(
            "${{ env.CONFIG_REPO_DIR }}/firmware-config/configs"
            "${{ env.CONFIG_REPO_DIR }}/firmware-config" 
            "${{ env.CONFIG_REPO_DIR }}"
            "${{ env.CONFIG_REPO_DIR }}/firmware-config/configs/device-profiles"
          )
          
          for path in "${SEARCH_PATHS[@]}"; do
            if [ -f "$path/$CONFIG_PROFILE" ]; then
              CONFIG_FOUND="$path/$CONFIG_PROFILE"
              echo "✅ 精确找到配置文件: $CONFIG_FOUND" | tee -a "$MAIN_LOG"
              break
            fi
          done
          
          # 方法2: 模糊搜索 - 查找包含配置名称的文件
          if [ -z "$CONFIG_FOUND" ]; then
            echo "🔍 精确匹配失败，开始模糊搜索..." | tee -a "$MAIN_LOG"
            for path in "${SEARCH_PATHS[@]}"; do
              if [ -d "$path" ]; then
                FOUND_FILE=$(find "$path" -type f -name "*$CONFIG_PROFILE*" 2>/dev/null | head -1)
                if [ -n "$FOUND_FILE" ] && [ -f "$FOUND_FILE" ]; then
                  CONFIG_FOUND="$FOUND_FILE"
                  echo "✅ 模糊搜索找到配置文件: $CONFIG_FOUND" | tee -a "$MAIN_LOG"
                  break
                fi
              fi
            done
          fi
          
          # 方法3: 搜索所有.config文件
          if [ -z "$CONFIG_FOUND" ]; then
            echo "🔍 模糊搜索失败，搜索所有.config文件..." | tee -a "$MAIN_LOG"
            for path in "${SEARCH_PATHS[@]}"; do
              if [ -d "$path" ]; then
                FOUND_FILE=$(find "$path" -type f -name "*.config*" 2>/dev/null | head -1)
                if [ -n "$FOUND_FILE" ] && [ -f "$FOUND_FILE" ]; then
                  CONFIG_FOUND="$FOUND_FILE"
                  echo "✅ 找到.config文件: $CONFIG_FOUND" | tee -a "$MAIN_LOG"
                  break
                fi
              fi
            done
          fi
          
          # 方法4: 搜索任何包含配置名称的文件
          if [ -z "$CONFIG_FOUND" ]; then
            echo "🔍 搜索任何包含配置名称的文件..." | tee -a "$MAIN_LOG"
            for path in "${SEARCH_PATHS[@]}"; do
              if [ -d "$path" ]; then
                FOUND_FILE=$(find "$path" -type f -name "*config*" 2>/dev/null | head -1)
                if [ -n "$FOUND_FILE" ] && [ -f "$FOUND_FILE" ]; then
                  CONFIG_FOUND="$FOUND_FILE"
                  echo "✅ 找到config文件: $CONFIG_FOUND" | tee -a "$MAIN_LOG"
                  break
                fi
              fi
            done
          fi
          
          if [ -n "$CONFIG_FOUND" ] && [ -f "$CONFIG_FOUND" ]; then
            echo "🎯 最终使用配置文件: $CONFIG_FOUND" | tee -a "$MAIN_LOG"
            
            # 显示配置文件内容前几行用于验证
            echo "📄 配置文件预览:" | tee -a "$MAIN_LOG"
            head -20 "$CONFIG_FOUND" | tee -a "$MAIN_LOG"
            echo "..." | tee -a "$MAIN_LOG"
            
            cp "$CONFIG_FOUND" .config
            echo "🔧 应用优化配置..." | tee -a "$MAIN_LOG"
            
            # 强制启用关键包
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
            echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
            echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> .config
            echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> .config
            echo "CONFIG_SDK=y" >> .config
            echo "CONFIG_BUILD_LOG=y" >> .config
            
            # 强制启用LUCI和基本包
            echo "CONFIG_PACKAGE_luci=y" >> .config
            echo "CONFIG_PACKAGE_luci-theme-material=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-wireguard=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            echo "CONFIG_PACKAGE_luci-base=y" >> .config
            echo "CONFIG_PACKAGE_luci-compat=y" >> .config
            echo "CONFIG_PACKAGE_luci-mod-admin-full=y" >> .config
            echo "CONFIG_PACKAGE_luci-proto-ipv6=y" >> .config
            echo "CONFIG_PACKAGE_luci-proto-ppp=y" >> .config
            echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
            
            # 确保基础包被包含
            echo "CONFIG_PACKAGE_dropbear=y" >> .config
            echo "CONFIG_PACKAGE_fstools=y" >> .config
            echo "CONFIG_PACKAGE_block-mount=y" >> .config
            echo "CONFIG_PACKAGE_uci=y" >> .config
            echo "CONFIG_PACKAGE_base-files=y" >> .config
            
            echo "🔄 运行defconfig..." | tee -a "$MAIN_LOG"
            TEMP_LOG=$(mktemp)
            if { make defconfig 2>&1 | tee "$TEMP_LOG"; } then
              echo "✅ 配置应用完成" | tee -a "$MAIN_LOG"
              # 检查defconfig警告
              if grep -i "WARNING" "$TEMP_LOG"; then
                echo "⚠️ defconfig有警告" | tee -a "$MAIN_LOG"
              fi
            else
              echo "❌ defconfig失败" | tee -a "$MAIN_LOG"
              grep -i -E "error|failed|fatal" "$TEMP_LOG" | head -20 | tee -a "$MAIN_LOG"
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              rm -f "$TEMP_LOG"
              exit 1
            fi
            cat "$TEMP_LOG" >> "$MAIN_LOG"
            rm -f "$TEMP_LOG"
          else
            echo "❌ 错误: 未找到配置文件 '$CONFIG_PROFILE'" | tee -a "$MAIN_LOG"
            echo "🔍 搜索路径:" | tee -a "$MAIN_LOG"
            for path in "${SEARCH_PATHS[@]}"; do
              echo "  - $path" | tee -a "$MAIN_LOG"
              if [ -d "$path" ]; then
                find "$path" -type f -name "*config*" 2>/dev/null | head -10 | tee -a "$MAIN_LOG" || true
              fi
            done
            exit 1
          fi

      - name: "🔧 应用高级功能"
        if: github.event.inputs.enable_advanced == 'true'
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔧 应用高级功能 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "🔧 高级功能状态: 已启用" | tee -a "$MAIN_LOG"
          echo "📋 高级功能配置:" | tee -a "$MAIN_LOG"
          echo "  - 自定义补丁: ${{ github.event.inputs.custom_patches || '无' }}" | tee -a "$MAIN_LOG"
          echo "  - 额外软件包: ${{ github.event.inputs.extra_packages || '无' }}" | tee -a "$MAIN_LOG"
          
          # 应用自定义补丁
          if [ -n "${{ github.event.inputs.custom_patches }}" ]; then
            echo "🔧 应用自定义补丁..." | tee -a "$MAIN_LOG"
            PATCH_URL="${{ github.event.inputs.custom_patches }}"
            if [[ $PATCH_URL == http* ]]; then
              echo "📥 下载补丁: $PATCH_URL" | tee -a "$MAIN_LOG"
              if wget -O custom.patch "$PATCH_URL" 2>&1; then
                echo "✅ 补丁下载成功" | tee -a "$MAIN_LOG"
                if patch -p1 < custom.patch 2>&1; then
                  echo "✅ 补丁应用成功" | tee -a "$MAIN_LOG"
                  echo "CUSTOM_PATCH_STATUS=success" >> $GITHUB_ENV
                else
                  echo "❌ 补丁应用失败" | tee -a "$MAIN_LOG"
                  echo "CUSTOM_PATCH_STATUS=failed" >> $GITHUB_ENV
                fi
              else
                echo "❌ 补丁下载失败" | tee -a "$MAIN_LOG"
                echo "CUSTOM_PATCH_STATUS=download_failed" >> $GITHUB_ENV
              fi
            elif [ -f "${{ env.CONFIG_REPO_DIR }}/firmware-config/$PATCH_URL" ]; then
              echo "📥 应用本地补丁: $PATCH_URL" | tee -a "$MAIN_LOG"
              if patch -p1 < "${{ env.CONFIG_REPO_DIR }}/firmware-config/$PATCH_URL" 2>&1; then
                echo "✅ 补丁应用成功" | tee -a "$MAIN_LOG"
                echo "CUSTOM_PATCH_STATUS=success" >> $GITHUB_ENV
              else
                echo "❌ 补丁应用失败" | tee -a "$MAIN_LOG"
                echo "CUSTOM_PATCH_STATUS=failed" >> $GITHUB_ENV
              fi
            else
              echo "❌ 补丁文件不存在: $PATCH_URL" | tee -a "$MAIN_LOG"
              echo "CUSTOM_PATCH_STATUS=not_found" >> $GITHUB_ENV
            fi
          else
            echo "ℹ️ 未提供自定义补丁" | tee -a "$MAIN_LOG"
            echo "CUSTOM_PATCH_STATUS=not_provided" >> $GITHUB_ENV
          fi
          
          # 添加额外软件包
          if [ -n "${{ github.event.inputs.extra_packages }}" ]; then
            echo "📦 配置额外软件包..." | tee -a "$MAIN_LOG"
            IFS=',' read -ra PKGS <<< "${{ github.event.inputs.extra_packages }}"
            ADDED_COUNT=0
            for pkg in "${PKGS[@]}"; do
              CLEAN_PKG=$(echo "$pkg" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              if [ -n "$CLEAN_PKG" ]; then
                echo "CONFIG_PACKAGE_${CLEAN_PKG}=y" >> .config
                echo "✅ 添加包: $CLEAN_PKG" | tee -a "$MAIN_LOG"
                ADDED_COUNT=$((ADDED_COUNT + 1))
              fi
            done
            echo "EXTRA_PACKAGES_ADDED=$ADDED_COUNT" >> $GITHUB_ENV
            echo "✅ 成功添加 $ADDED_COUNT 个额外软件包" | tee -a "$MAIN_LOG"
          else
            echo "ℹ️ 未提供额外软件包" | tee -a "$MAIN_LOG"
            echo "EXTRA_PACKAGES_ADDED=0" >> $GITHUB_ENV
          fi
          
          # 安装自定义IPK包
          echo "📦 安装自定义IPK包..." | tee -a "$MAIN_LOG"
          IPK_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-features/prebuilt-ipks"
          if [ -d "$IPK_DIR" ]; then
            echo "🔍 查找自定义IPK包..." | tee -a "$MAIN_LOG"
            IPK_FILES=$(find "$IPK_DIR" -name "*.ipk" -type f 2>/dev/null || true)
            if [ -n "$IPK_FILES" ]; then
              echo "✅ 找到自定义IPK包:" | tee -a "$MAIN_LOG"
              mkdir -p package/custom
              IPK_COUNT=0
              for ipk in $IPK_FILES; do
                ipk_name=$(basename "$ipk")
                echo "  - 复制 $ipk_name" | tee -a "$MAIN_LOG"
                cp "$ipk" package/custom/
                pkg_base=$(echo "$ipk_name" | sed 's/\.ipk$//' | tr '-' '_')
                echo "CONFIG_PACKAGE_${pkg_base}=y" >> .config
                echo "✅ 添加自定义包: $pkg_base" | tee -a "$MAIN_LOG"
                IPK_COUNT=$((IPK_COUNT + 1))
              done
              echo "CUSTOM_IPK_COUNT=$IPK_COUNT" >> $GITHUB_ENV
              echo "✅ 成功添加 $IPK_COUNT 个自定义IPK包" | tee -a "$MAIN_LOG"
            else
              echo "ℹ️ 未找到自定义IPK包" | tee -a "$MAIN_LOG"
              echo "CUSTOM_IPK_COUNT=0" >> $GITHUB_ENV
            fi
          else
            echo "ℹ️ 自定义IPK目录不存在: $IPK_DIR" | tee -a "$MAIN_LOG"
            echo "CUSTOM_IPK_COUNT=0" >> $GITHUB_ENV
          fi
          
          # 执行自定义脚本 - 增强模糊搜索
          echo "🔧 执行自定义脚本..." | tee -a "$MAIN_LOG"
          
          # 定义多个可能的脚本搜索路径
          SCRIPT_PATHS=(
            "${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-features/scripts"
            "${{ env.CONFIG_REPO_DIR }}/firmware-config/scripts" 
            "${{ env.CONFIG_REPO_DIR }}/scripts"
            "${{ env.CONFIG_REPO_DIR }}/firmware-config"
            "${{ env.CONFIG_REPO_DIR }}"
          )
          
          SCRIPT_FOUND=false
          SCRIPT_COUNT=0
          
          for script_path in "${SCRIPT_PATHS[@]}"; do
            if [ -d "$script_path" ]; then
              echo "🔍 在 $script_path 中查找脚本..." | tee -a "$MAIN_LOG"
              # 查找所有.sh脚本，按修改时间排序
              SCRIPTS=$(find "$script_path" -name "*.sh" -type f 2>/dev/null | sort || true)
              if [ -n "$SCRIPTS" ]; then
                echo "✅ 在 $script_path 中找到脚本:" | tee -a "$MAIN_LOG"
                for script in $SCRIPTS; do
                  echo "  - $(basename "$script")" | tee -a "$MAIN_LOG"
                done
                
                for script in $SCRIPTS; do
                  echo "📜 执行脚本: $(basename "$script")..." | tee -a "$MAIN_LOG"
                  chmod +x "$script"
                  cd /mnt/source
                  TEMP_LOG=$(mktemp)
                  if { bash "$script" 2>&1 | tee "$TEMP_LOG"; } then
                    echo "✅ 自定义脚本执行成功: $(basename "$script")" | tee -a "$MAIN_LOG"
                    SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
                  else
                    SCRIPT_EXIT_CODE=$?
                    echo "❌ 自定义脚本执行失败: $(basename "$script")，退出码: $SCRIPT_EXIT_CODE" | tee -a "$MAIN_LOG"
                    grep -i -E "error|failed|fatal" "$TEMP_LOG" | head -10 | tee -a "$MAIN_LOG"
                  fi
                  cat "$TEMP_LOG" >> "$MAIN_LOG"
                  rm -f "$TEMP_LOG"
                done
                SCRIPT_FOUND=true
              fi
            fi
          done
          
          if [ "$SCRIPT_FOUND" = "true" ]; then
            echo "CUSTOM_SCRIPT_STATUS=executed_${SCRIPT_COUNT}_scripts" >> $GITHUB_ENV
            echo "✅ 总共执行了 $SCRIPT_COUNT 个自定义脚本" | tee -a "$MAIN_LOG"
          else
            echo "ℹ️ 未找到任何自定义脚本" | tee -a "$MAIN_LOG"
            echo "🔍 搜索的路径:" | tee -a "$MAIN_LOG"
            for path in "${SCRIPT_PATHS[@]}"; do
              echo "  - $path" | tee -a "$MAIN_LOG"
            done
            echo "CUSTOM_SCRIPT_STATUS=not_found" >> $GITHUB_ENV
          fi
          
          # 修复依赖问题
          echo "🔧 修复缺失的依赖包..." | tee -a "$MAIN_LOG"
          mkdir -p staging_dir/host/include
          for header in libev.h libpam.h libtirpc lm-sensors libnetsnmp glib2.h libgpiod.h; do
            touch "staging_dir/host/include/$header" 2>/dev/null || true
          done
          
          # 重新运行defconfig确保配置正确
          echo "🔄 重新运行defconfig..." | tee -a "$MAIN_LOG"
          TEMP_LOG=$(mktemp)
          if { make defconfig 2>&1 | tee "$TEMP_LOG"; } then
            # 只输出警告信息
            if grep -i "WARNING" "$TEMP_LOG"; then
              echo "⚠️ defconfig有警告" | tee -a "$MAIN_LOG"
            fi
          else
            echo "❌ defconfig失败" | tee -a "$MAIN_LOG"
            grep -i -E "error|failed|fatal" "$TEMP_LOG" | head -20 | tee -a "$MAIN_LOG"
          fi
          cat "$TEMP_LOG" >> "$MAIN_LOG"
          rm -f "$TEMP_LOG"
          
          echo "✅ 高级功能应用完成" | tee -a "$MAIN_LOG"

      - name: "🔍 验证配置"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔍 验证配置 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "📋 当前配置摘要:" | tee -a "$MAIN_LOG"
          echo "🔧 已启用的LUCI应用:" | tee -a "$MAIN_LOG"
          # 修复LUCI检测逻辑
          LUCI_COUNT=0
          LUCI_APPS=$(grep "CONFIG_PACKAGE_luci" .config | grep "=y" || true)
          if [ -n "$LUCI_APPS" ]; then
            echo "$LUCI_APPS" | while read app; do
              echo "✅ $app" | tee -a "$MAIN_LOG"
              LUCI_COUNT=$((LUCI_COUNT + 1))
            done
          fi
          
          if [ $LUCI_COUNT -eq 0 ]; then
            echo "❌ 未找到LUCI应用配置" | tee -a "$MAIN_LOG"
          else
            echo "✅ 总共找到 $LUCI_COUNT 个LUCI相关配置" | tee -a "$MAIN_LOG"
          fi
          
          echo "📦 自定义IPK包:" | tee -a "$MAIN_LOG"
          if [ -d "package/custom" ]; then
            ls -la package/custom/ | tee -a "$MAIN_LOG"
          else
            echo "ℹ️ 无自定义IPK包" | tee -a "$MAIN_LOG"
          fi
          
          echo "📦 固件大小预估:" | tee -a "$MAIN_LOG"
          if [ $LUCI_COUNT -gt 3 ]; then
            echo "✅ LUCI已启用 - 固件大小应该 >20MB" | tee -a "$MAIN_LOG"
          elif [ $LUCI_COUNT -gt 0 ]; then
            echo "⚠️ LUCI部分启用 - 固件大小可能 15-20MB" | tee -a "$MAIN_LOG"
          else
            echo "❌ LUCI未启用 - 固件大小可能 <15MB" | tee -a "$MAIN_LOG"
          fi
          
          # 显示关键配置状态
          echo "🎯 关键配置状态:" | tee -a "$MAIN_LOG"
          for config in "CONFIG_TARGET_ROOTFS_SQUASHFS" "CONFIG_PACKAGE_luci" "CONFIG_PACKAGE_luci-theme-material"; do
            if grep -q "$config=y" .config; then
              echo "✅ $config=y" | tee -a "$MAIN_LOG"
            else
              echo "❌ $config 未设置" | tee -a "$MAIN_LOG"
            fi
          done
          
          echo "✅ 配置验证完成" | tee -a "$MAIN_LOG"

      - name: "📥 预下载依赖"
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 📥 预下载依赖 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "🔧 设置下载目录..." | tee -a "$MAIN_LOG"
          mkdir -p /mnt/downloads
          [ -d "dl" ] && rm -rf dl
          ln -sf /mnt/downloads dl
          echo "📥 开始下载..." | tee -a "$MAIN_LOG"
          MAX_ATTEMPTS=5
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "🔄 下载尝试 $attempt/$MAX_ATTEMPTS..." | tee -a "$MAIN_LOG"
            TEMP_LOG=$(mktemp)
            if { make download -j3 V=sc 2>&1 | tee "$TEMP_LOG"; } then
              echo "✅ 下载成功" | tee -a "$MAIN_LOG"
              # 检查下载警告
              if grep -i -E "error|failed|404|curl.*failed|download failed" "$TEMP_LOG"; then
                echo "⚠️ 下载过程中发现一些问题" | tee -a "$MAIN_LOG"
              fi
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              rm -f "$TEMP_LOG"
              break
            else
              echo "⚠️ 下载失败，重试 $attempt/$MAX_ATTEMPTS..." | tee -a "$MAIN_LOG"
              # 输出下载错误
              grep -i -E "error|failed|404|curl.*failed|download failed" "$TEMP_LOG" | tee -a "$MAIN_LOG" || true
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              rm -f "$TEMP_LOG"
              
              if [ $attempt -eq $MAX_ATTEMPTS ]; then
                echo "❌ 所有下载尝试都失败，跳过下载继续编译..." | tee -a "$MAIN_LOG"
                break
              fi
              sleep 15
            fi
          done
          DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
          echo "✅ 下载完成，文件数量: $DOWNLOAD_COUNT" | tee -a "$MAIN_LOG"

      - name: "🛠️ 编译工具链"
        timeout-minutes: 180
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🛠️ 编译工具链 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          
          echo "🔧 编译基础工具..." | tee -a "$MAIN_LOG"
          TEMP_LOG=$(mktemp)
          if { make tools/install -j1 V=s 2>&1 | tee "$TEMP_LOG"; } then
            echo "✅ 基础工具编译成功" | tee -a "$MAIN_LOG"
            # 检查编译警告
            if grep -i -E "error|warning|failed|No such file or directory" "$TEMP_LOG" | head -10; then
              echo "⚠️ 基础工具编译发现警告" | tee -a "$MAIN_LOG"
            fi
          else
            echo "❌ 基础工具编译失败" | tee -a "$MAIN_LOG"
            grep -i -E "error|failed|fatal|No such file or directory" "$TEMP_LOG" | head -20 | tee -a "$MAIN_LOG"
            cat "$TEMP_LOG" >> "$MAIN_LOG"
            rm -f "$TEMP_LOG"
            exit 1
          fi
          cat "$TEMP_LOG" >> "$MAIN_LOG"
          rm -f "$TEMP_LOG"
          
          echo "🔄 编译工具链..." | tee -a "$MAIN_LOG"
          MAX_RETRIES=3
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "🔄 工具链编译尝试 $attempt/$MAX_RETRIES" | tee -a "$MAIN_LOG"
            TEMP_LOG=$(mktemp)
            
            if [ $attempt -gt 1 ]; then
              echo "🧹 清理工具链..." | tee -a "$MAIN_LOG"
              make toolchain/clean 2>/dev/null || true
              sleep 5
            fi
            
            if { make toolchain/compile -j1 V=s 2>&1 | tee "$TEMP_LOG"; } then
              echo "✅ 工具链编译成功" | tee -a "$MAIN_LOG"
              # 检查编译警告
              if grep -i -E "error|warning|failed|No such file or directory" "$TEMP_LOG" | head -10; then
                echo "⚠️ 工具链编译发现警告" | tee -a "$MAIN_LOG"
              fi
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              rm -f "$TEMP_LOG"
              break
            else
              echo "❌ 工具链编译失败" | tee -a "$MAIN_LOG"
              echo "🔍 关键错误信息:" | tee -a "$MAIN_LOG"
              grep -i -E "error|failed|fatal|No such file or directory|undefined reference|collect2: error" "$TEMP_LOG" | head -30 | tee -a "$MAIN_LOG"
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              rm -f "$TEMP_LOG"
              
              if [ $attempt -eq $MAX_RETRIES ]; then
                echo "❌ 所有工具链编译尝试都失败" | tee -a "$MAIN_LOG"
                exit 1
              fi
              sleep 10
            fi
          done
          echo "✅ 工具链编译完成" | tee -a "$MAIN_LOG"

      - name: "🚀 编译固件"
        timeout-minutes: 240
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🚀 编译固件 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          
          echo "🔧 开始编译..." | tee -a "$MAIN_LOG"
          MAX_ATTEMPTS=2
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "🔄 编译尝试 $attempt/$MAX_ATTEMPTS" | tee -a "$MAIN_LOG"
            TEMP_LOG=$(mktemp)
            
            if [ $attempt -eq 1 ]; then
              JOBS=2
            else
              JOBS=1
              echo "🧹 清理部分构建..." | tee -a "$MAIN_LOG"
              make target/linux-clean 2>/dev/null || true
              sleep 5
            fi
            
            if { make -j$JOBS V=s 2>&1 | tee "$TEMP_LOG"; } then
              # 检查是否生成了任何固件文件
              if find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.itb" -o -name "*.gz" \) 2>/dev/null | grep -q .; then
                echo "✅ 编译成功，找到固件文件" | tee -a "$MAIN_LOG"
                # 输出编译过程中的关键信息
                echo "🔍 编译摘要:" | tee -a "$MAIN_LOG"
                grep -i -E "error|warning|failed|No such file or directory|collect2|undefined reference" "$TEMP_LOG" | tail -20 | tee -a "$MAIN_LOG" || true
                cat "$TEMP_LOG" >> "$MAIN_LOG"
                rm -f "$TEMP_LOG"
                echo "BUILD_STATUS=success" >> $GITHUB_ENV
                break
              else
                echo "⚠️ 编译完成但未生成标准固件文件，检查其他格式..." | tee -a "$MAIN_LOG"
                # 输出关键错误信息
                grep -i -E "error|failed|fatal|No such file or directory" "$TEMP_LOG" | tail -15 | tee -a "$MAIN_LOG"
                cat "$TEMP_LOG" >> "$MAIN_LOG"
                rm -f "$TEMP_LOG"
                
                # 检查其他可能的文件格式
                if find bin/targets -type f 2>/dev/null | grep -q .; then
                  echo "✅ 找到其他格式的文件:" | tee -a "$MAIN_LOG"
                  find bin/targets -type f 2>/dev/null | head -10 | tee -a "$MAIN_LOG"
                  echo "BUILD_STATUS=success" >> $GITHUB_ENV
                  break
                else
                  echo "❌ 编译完成但未生成任何固件文件" | tee -a "$MAIN_LOG"
                fi
              fi
            else
              echo "❌ 编译失败" | tee -a "$MAIN_LOG"
              # 输出关键错误信息
              echo "🔍 关键错误信息:" | tee -a "$MAIN_LOG"
              grep -i -E "error|failed|fatal|No such file or directory|collect2: error|recipe for target.*failed" "$TEMP_LOG" | tail -30 | tee -a "$MAIN_LOG"
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              rm -f "$TEMP_LOG"
              
              if [ $attempt -eq $MAX_ATTEMPTS ]; then
                echo "❌ 所有编译尝试都失败" | tee -a "$MAIN_LOG"
                echo "BUILD_STATUS=failed" >> $GITHUB_ENV
                exit 1
              fi
              sleep 10
            fi
          done
          echo "✅ 固件编译完成" | tee -a "$MAIN_LOG"

      - name: "🔍 分析生成的固件"
        if: env.BUILD_STATUS == 'success'
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🔍 分析生成的固件 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "📁 所有生成的文件:" | tee -a "$MAIN_LOG"
          find bin/targets -type f 2>/dev/null | while read file; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "unknown")
              echo "  - $file ($size)" | tee -a "$MAIN_LOG"
            fi
          done
          
          echo "📊 固件详细信息:" | tee -a "$MAIN_LOG"
          if [ -d "bin/targets" ]; then
            echo "🎯 目标目录结构:" | tee -a "$MAIN_LOG"
            find bin/targets -type d 2>/dev/null | head -20 | tee -a "$MAIN_LOG"
            
            echo "🔍 查找所有固件文件:" | tee -a "$MAIN_LOG"
            FIRMWARE_FILES=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.itb" -o -name "*.gz" \) 2>/dev/null || true)
            if [ -n "$FIRMWARE_FILES" ]; then
              echo "📦 找到的固件文件:" | tee -a "$MAIN_LOG"
              TOTAL_SIZE=0
              FIRMWARE_COUNT=0
              for file in $FIRMWARE_FILES; do
                if [ -f "$file" ]; then
                  size=$(du -b "$file" 2>/dev/null | cut -f1 || echo "0")
                  human_size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "unknown")
                  TOTAL_SIZE=$((TOTAL_SIZE + size))
                  FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
                  echo "  - $file ($human_size)" | tee -a "$MAIN_LOG"
                fi
              done
              # 转换为MB
              TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024 / 1024))
              echo "📏 固件总大小: ${TOTAL_SIZE_MB}MB" | tee -a "$MAIN_LOG"
              echo "📦 固件数量: ${FIRMWARE_COUNT}" | tee -a "$MAIN_LOG"
              
              # 检查固件大小是否正常
              if [ $TOTAL_SIZE_MB -lt 5 ]; then
                echo "❌ 警告: 固件大小异常小 (<5MB)，可能是initramfs" | tee -a "$MAIN_LOG"
              elif [ $TOTAL_SIZE_MB -lt 15 ]; then
                echo "⚠️ 固件大小较小 (<15MB)，可能缺少LUCI" | tee -a "$MAIN_LOG"
              elif [ $TOTAL_SIZE_MB -gt 30 ]; then
                echo "✅ 固件大小正常 (>30MB)，包含完整插件" | tee -a "$MAIN_LOG"
              else
                echo "ℹ️ 固件大小中等 (15-30MB)" | tee -a "$MAIN_LOG"
              fi
              
              echo "FIRMWARE_SIZE_MB=$TOTAL_SIZE_MB" >> $GITHUB_ENV
              echo "FIRMWARE_COUNT=$FIRMWARE_COUNT" >> $GITHUB_ENV
            else
              echo "❌ 未找到任何固件文件" | tee -a "$MAIN_LOG"
              echo "FIRMWARE_COUNT=0" >> $GITHUB_ENV
            fi
          else
            echo "❌ bin/targets 目录不存在" | tee -a "$MAIN_LOG"
            echo "FIRMWARE_COUNT=0" >> $GITHUB_ENV
          fi

      - name: "🎯 验证工厂镜像"
        if: env.BUILD_STATUS == 'success'
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 🎯 验证工厂镜像 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          # 多种方式查找工厂镜像
          echo "🔍 查找工厂镜像..." | tee -a "$MAIN_LOG"
          
          # 方法1: 查找包含 factory 的文件
          FACTORY_FILES=$(find bin/targets -type f -iname "*factory*" 2>/dev/null || true)
          
          # 方法2: 查找包含 ac42u 的文件
          AC42U_FILES=$(find bin/targets -type f -iname "*ac42u*" 2>/dev/null || true)
          
          # 方法3: 查找包含 asus 的文件
          ASUS_FILES=$(find bin/targets -type f -iname "*asus*" 2>/dev/null || true)
          
          # 方法4: 查找所有固件文件
          ALL_FIRMWARE=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.itb" \) 2>/dev/null || true)
          
          echo "📋 查找结果:" | tee -a "$MAIN_LOG"
          echo "  - 包含 'factory' 的文件: $([ -n "$FACTORY_FILES" ] && echo "找到" || echo "无")" | tee -a "$MAIN_LOG"
          echo "  - 包含 'ac42u' 的文件: $([ -n "$AC42U_FILES" ] && echo "找到" || echo "无")" | tee -a "$MAIN_LOG"
          echo "  - 包含 'asus' 的文件: $([ -n "$ASUS_FILES" ] && echo "找到" || echo "无")" | tee -a "$MAIN_LOG"
          echo "  - 所有固件文件: $(echo "$ALL_FIRMWARE" | wc -l 2>/dev/null || echo "0")" | tee -a "$MAIN_LOG"
          
          # 合并所有可能的工厂镜像
          ALL_FACTORY_CANDIDATES=$(echo "$FACTORY_FILES" "$AC42U_FILES" "$ASUS_FILES" | tr ' ' '\n' | sort -u | grep -v '^$')
          
          if [ -n "$ALL_FACTORY_CANDIDATES" ]; then
            echo "✅ 找到可能的工厂镜像:" | tee -a "$MAIN_LOG"
            for img in $ALL_FACTORY_CANDIDATES; do
              if [ -f "$img" ]; then
                size=$(du -h "$img" | cut -f1)
                file_type=$(file "$img" 2>/dev/null | cut -d: -f2 || echo "unknown")
                echo "  - $(basename "$img") ($size) - $file_type" | tee -a "$MAIN_LOG"
              fi
            done
            echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
            # 将文件列表转换为单行，用空格分隔
            FACTORY_FILES_LINE=$(echo "$ALL_FACTORY_CANDIDATES" | tr '\n' ' ' | sed 's/ $//')
            echo "FACTORY_FILES=$FACTORY_FILES_LINE" >> $GITHUB_ENV
          else
            echo "❌ 未找到工厂镜像" | tee -a "$MAIN_LOG"
            echo "FACTORY_EXISTS=false" >> $GITHUB_ENV
            
            # 如果没有找到工厂镜像，显示所有固件文件供分析
            echo "📁 所有可用的固件文件:" | tee -a "$MAIN_LOG"
            for firmware in $ALL_FIRMWARE; do
              if [ -f "$firmware" ]; then
                size=$(du -h "$firmware" | cut -f1)
                echo "  - $(basename "$firmware") ($size)" | tee -a "$MAIN_LOG"
              fi
            done
          fi

      - name: "📦 收集构建产物"
        if: env.BUILD_STATUS == 'success'
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== 📦 收集构建产物 ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          mkdir -p /mnt/artifacts/firmware
          
          # 使用更可靠的方式收集固件文件
          echo "📦 查找固件文件..." | tee -a "$MAIN_LOG"
          FIRMWARE_COUNT=0
          if [ -d "bin/targets" ]; then
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.itb" -o -name "*.gz" \) > /tmp/firmware-list.txt 2>/dev/null || true
            
            if [ -f "/tmp/firmware-list.txt" ]; then
              FIRMWARE_COUNT=$(wc -l < /tmp/firmware-list.txt)
              echo "📦 找到 $FIRMWARE_COUNT 个固件文件..." | tee -a "$MAIN_LOG"
              
              COPIED_COUNT=0
              while IFS= read -r firmware; do
                if [ -f "$firmware" ]; then
                  filename=$(basename "$firmware")
                  # 清理文件名中的特殊字符
                  safe_filename=$(echo "$filename" | tr ' ' '_' | tr -cd '[:alnum:]._-')
                  cp "$firmware" "/mnt/artifacts/firmware/$safe_filename" && {
                    COPIED_COUNT=$((COPIED_COUNT+1))
                    echo "✅ 复制: $filename" | tee -a "$MAIN_LOG"
                  } || echo "⚠️ 复制失败: $filename" | tee -a "$MAIN_LOG"
                fi
              done < /tmp/firmware-list.txt
              
              echo "FIRMWARE_COUNT=$COPIED_COUNT" >> $GITHUB_ENV
              echo "✅ 成功复制 $COPIED_COUNT 个固件文件" | tee -a "$MAIN_LOG"
              
              # 列出复制的文件
              echo "📁 产物目录内容:" | tee -a "$MAIN_LOG"
              ls -la /mnt/artifacts/firmware/ | tee -a "$MAIN_LOG"
            else
              echo "❌ 未找到任何固件文件" | tee -a "$MAIN_LOG"
              echo "FIRMWARE_COUNT=0" >> $GITHUB_ENV
            fi
          else
            echo "❌ bin/targets 目录不存在" | tee -a "$MAIN_LOG"
            echo "FIRMWARE_COUNT=0" >> $GITHUB_ENV
          fi

      - name: "📋 智能日志分析与报告"
        if: always()
        timeout-minutes: 5
        run: |
          set -e
          echo "=== 📋 智能日志分析与报告 ==="
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "==========================================" | tee -a "$MAIN_LOG"
          echo "🏁 构建结束时间: $(date)" | tee -a "$MAIN_LOG"
          echo "📊 最终状态: ${{ env.BUILD_STATUS || 'unknown' }}" | tee -a "$MAIN_LOG"
          echo "📦 固件数量: ${{ env.FIRMWARE_COUNT || 0 }}" | tee -a "$MAIN_LOG"
          echo "📏 固件大小: ${{ env.FIRMWARE_SIZE_MB || 'unknown' }}MB" | tee -a "$MAIN_LOG"
          echo "🏭 工厂镜像: ${{ env.FACTORY_EXISTS || 'unknown' }}" | tee -a "$MAIN_LOG"
          echo "🔧 高级功能: ${{ github.event.inputs.enable_advanced || 'false' }}" | tee -a "$MAIN_LOG"
          
          # 显示自定义功能状态
          echo "🔧 自定义功能状态:" | tee -a "$MAIN_LOG"
          echo "  - 自定义补丁: ${{ env.CUSTOM_PATCH_STATUS || '未执行' }}" | tee -a "$MAIN_LOG"
          echo "  - 额外软件包: ${{ env.EXTRA_PACKAGES_ADDED || 0 }} 个" | tee -a "$MAIN_LOG"
          echo "  - 自定义IPK: ${{ env.CUSTOM_IPK_COUNT || 0 }} 个" | tee -a "$MAIN_LOG"
          echo "  - 自定义脚本: ${{ env.CUSTOM_SCRIPT_STATUS || '未执行' }}" | tee -a "$MAIN_LOG"
          
          echo "==========================================" | tee -a "$MAIN_LOG"
          
          ERROR_REPORT_DIR="/mnt/artifacts/error-analysis"
          mkdir -p "$ERROR_REPORT_DIR"
          TIMELINE_ERRORS="$ERROR_REPORT_DIR/timeline_errors.txt"
          
          echo "=== 🕒 时间线错误报告 ===" > "$TIMELINE_ERRORS"
          echo "生成时间: $(date)" >> "$TIMELINE_ERRORS"
          echo "构建状态: ${{ env.BUILD_STATUS || 'unknown' }}" >> "$TIMELINE_ERRORS"
          echo "固件数量: ${{ env.FIRMWARE_COUNT || 0 }}" >> "$TIMELINE_ERRORS"
          echo "固件大小: ${{ env.FIRMWARE_SIZE_MB || 'unknown' }}MB" >> "$TIMELINE_ERRORS"
          
          # 添加自定义功能状态到错误报告
          echo "自定义功能状态:" >> "$TIMELINE_ERRORS"
          echo "  - 补丁: ${{ env.CUSTOM_PATCH_STATUS || 'N/A' }}" >> "$TIMELINE_ERRORS"
          echo "  - 额外包: ${{ env.EXTRA_PACKAGES_ADDED || 0 }}" >> "$TIMELINE_ERRORS"
          echo "  - 自定义IPK: ${{ env.CUSTOM_IPK_COUNT || 0 }}" >> "$TIMELINE_ERRORS"
          echo "  - 脚本: ${{ env.CUSTOM_SCRIPT_STATUS || 'N/A' }}" >> "$TIMELINE_ERRORS"
          
          echo "==========================================" >> "$TIMELINE_ERRORS"
          
          if [ -f "$MAIN_LOG" ]; then
            echo "🔍 关键错误:" >> "$TIMELINE_ERRORS"
            { grep -n -i -B2 -A2 "error\|failed\|fatal" "$MAIN_LOG" | head -50 || echo "无严重错误"; } >> "$TIMELINE_ERRORS"
            echo "" >> "$TIMELINE_ERRORS"
            echo "📥 下载问题:" >> "$TIMELINE_ERRORS"
            { grep -n -i "404\|curl.*failed\|download failed" "$MAIN_LOG" || echo "无下载问题"; } >> "$TIMELINE_ERRORS"
            echo "" >> "$TIMELINE_ERRORS"
            echo "🔧 高级功能问题:" >> "$TIMELINE_ERRORS"
            { grep -n -i "patch\|custom\|advanced" "$MAIN_LOG" || echo "无高级功能问题"; } >> "$TIMELINE_ERRORS"
            echo "" >> "$TIMELINE_ERRORS"
            echo "⚠️ 文件查找警告:" >> "$TIMELINE_ERRORS"
            { grep -n -i "No such file or directory" "$MAIN_LOG" | head -20 || echo "无文件查找警告"; } >> "$TIMELINE_ERRORS"
          fi
          echo "✅ 智能日志分析完成"

      - name: "💾 上传构建产物"
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Build-Artifacts-${{ github.run_number }}"
          path: |
            /mnt/artifacts
            /mnt/build-logs
          retention-days: 30
          compression-level: 9

      - name: "📊 最终构建报告"
        if: always()
        run: |
          echo "=== 📊 最终构建报告 ==="
          echo ""
          echo "🎯 构建摘要"
          echo "=========================================="
          echo "📦 源码信息:"
          echo "  - 预设: ${{ env.SOURCE_PRESET || 'unknown' }}"
          echo "  - 分支: ${{ env.ACTUAL_BRANCH || 'unknown' }}"
          echo "  - 提交: ${{ env.COMMIT_HASH || 'unknown' }}"
          echo ""
          echo "📈 构建结果:"
          echo "  - 状态: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - 固件数量: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - 固件大小: ${{ env.FIRMWARE_SIZE_MB || 'unknown' }}MB"
          echo "  - 工厂镜像: ${{ env.FACTORY_EXISTS || 'unknown' }}"
          echo ""
          echo "🔧 高级功能:"
          echo "  - 启用状态: ${{ github.event.inputs.enable_advanced || 'false' }}"
          echo "  - 自定义补丁: ${{ github.event.inputs.custom_patches || '无' }} (状态: ${{ env.CUSTOM_PATCH_STATUS || '未知' }})"
          echo "  - 额外软件包: ${{ github.event.inputs.extra_packages || '无' }} (添加: ${{ env.EXTRA_PACKAGES_ADDED || 0 }}个)"
          echo "  - 自定义IPK: ${{ env.CUSTOM_IPK_COUNT || 0 }} 个"
          echo "  - 自定义脚本: ${{ env.CUSTOM_SCRIPT_STATUS || '未执行' }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            if [ "${{ env.FIRMWARE_SIZE_MB }}" -lt 15 ] 2>/dev/null; then
              echo "⚠️ 警告: 固件大小异常小 (${{ env.FIRMWARE_SIZE_MB }}MB)"
              echo ""
              echo "🔍 可能原因:"
              echo "  - LUCI界面未正确启用"
              echo "  - 插件依赖关系问题"
              echo "  - 配置文件中插件选项未设置"
              echo "  - 生成了initramfs镜像而非完整固件"
              echo ""
              echo "💡 解决方案:"
              echo "  - 检查配置文件中是否包含 CONFIG_PACKAGE_luci=y"
              echo "  - 确保高级功能已启用"
              echo "  - 验证额外软件包名称是否正确"
              echo "  - 检查是否选择了正确的文件系统类型"
            fi
            
            if [ "${{ env.FACTORY_EXISTS }}" = "true" ]; then
              echo "🎉 构建成功！工厂镜像已生成"
              if [ -n "${{ env.FACTORY_FILES }}" ]; then
                echo ""
                echo "🏭 工厂镜像文件:"
                for file in ${{ env.FACTORY_FILES }}; do
                  echo "  - $(basename "$file")"
                done
              fi
            else
              echo "⚠️ 构建成功但未生成工厂镜像"
              echo ""
              echo "💡 可能原因:"
              echo "  - 设备配置可能不支持工厂镜像"
              echo "  - 生成的可能是sysupgrade固件"
              echo "  - 文件名不包含'factory'关键词"
              echo "  - 生成了initramfs镜像"
            fi
          else
            echo "❌ 构建失败"
            echo ""
            echo "🔍 可能的原因:"
            echo "  - 网络下载问题"
            echo "  - 依赖包缺失"
            echo "  - 磁盘空间不足"
            echo "  - 自定义补丁冲突"
            echo "  - 配置文件错误"
            echo ""
            echo "💡 建议:"
            echo "  - 检查网络连接"
            echo "  - 使用稳定分支而非master"
            echo "  - 确保配置文件正确"
            echo "  - 检查自定义补丁兼容性"
            echo "  - 查看详细构建日志"
          fi
          echo ""
          echo "⏰ 完成时间: $(date)"
          echo "=========================================="
