name: "Universal Firmware Builder - Toolchain Fixed Version"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "auto"
        type: string
      config_profile:
        description: "è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„"
        required: true
        type: string
        default: ".config_rt-ac42u_immortalwrt"

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 240
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"

      - name: "ğŸ’¾ ç¯å¢ƒåˆå§‹åŒ–ä¸ä¿®å¤"
        timeout-minutes: 5
        run: |
          echo "=== ğŸ’¾ ç¯å¢ƒåˆå§‹åŒ–ä¸ä¿®å¤ ==="
          sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }}
          sudo chown -R $USER:$USER /mnt/*
          if [ -f /mnt/swapfile ]; then
            sudo swapoff /mnt/swapfile 2>/dev/null || true
            sudo rm -f /mnt/swapfile 2>/dev/null || true
          fi
          sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=16384 status=progress
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          echo "ğŸ“Š å†…å­˜çŠ¶æ€:"
          free -h
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸ› ï¸ å®‰è£…å®Œæ•´çš„ç¼–è¯‘å·¥å…·é“¾"
        timeout-minutes: 10
        run: |
          echo "=== ğŸ› ï¸ å®‰è£…å®Œæ•´çš„ç¼–è¯‘å·¥å…·é“¾ ==="
          sudo apt-get update
          sudo apt-get install -y build-essential
          sudo apt-get install -y gcc g++ gcc-multilib g++-multilib
          sudo apt-get install -y clang llvm
          sudo apt-get install -y flex bison
          sudo apt-get install -y gettext texinfo
          sudo apt-get install -y libncurses5-dev libssl-dev
          sudo apt-get install -y python3 python3-pip
          sudo apt-get install -y rsync unzip zlib1g-dev
          sudo apt-get install -y file wget curl jq
          sudo apt-get install -y ccache
          sudo apt-get install -y libtool-bin automake autoconf
          sudo apt-get install -y pkg-config
          sudo apt-get install -y subversion
          sudo apt-get install -y cmake ninja-build
          sudo apt-get install -y libelf-dev libssl-dev
          sudo apt-get install -y zlib1g-dev libxml2-dev
          sudo apt-get install -y liblzma-dev liblzo2-dev
          echo "ğŸ” éªŒè¯å·¥å…·é“¾:"
          gcc --version || echo "âŒ gcc æœªå®‰è£…"
          g++ --version || echo "âŒ g++ æœªå®‰è£…"
          make --version || echo "âŒ make æœªå®‰è£…"
          python3 --version || echo "âŒ python3 æœªå®‰è£…"
          cmake --version || echo "âŒ cmake æœªå®‰è£…"
          echo "âœ… ç¼–è¯‘å·¥å…·é“¾å®‰è£…å®Œæˆ"

      - name: "âš¡ é…ç½®CCache"
        timeout-minutes: 2
        run: |
          echo "=== âš¡ é…ç½®CCache ==="
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache -M 4G
          ccache -o compression=true
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "ğŸ“Š CCacheçŠ¶æ€:"
          ccache -s

      - name: "ğŸ“¥ è·å–æºç "
        timeout-minutes: 15
        run: |
          echo "=== ğŸ“¥ è·å–æºç  ==="
          cd ${{ env.SOURCE_DIR }}
          rm -rf ./*
          echo "ğŸ”§ å…‹éš† ImmortalWrt æºç ..."
          git clone --depth=1 --branch "openwrt-21.02" https://github.com/immortalwrt/immortalwrt.git .
          echo "âœ… æºç è·å–å®Œæˆ"

      - name: "ğŸ”§ åº”ç”¨é…ç½®ä¸ä¿®å¤å·¥å…·é“¾"
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ”§ åº”ç”¨é…ç½®ä¸ä¿®å¤å·¥å…·é“¾ ==="
          CONFIG_FILE="$GITHUB_WORKSPACE/${{ github.event.inputs.config_profile }}"
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" .config
            echo "âœ… é…ç½®æ–‡ä»¶åº”ç”¨: $CONFIG_FILE"
          else
            echo "âŒ é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°: $CONFIG_FILE"
            exit 1
          fi
          echo "ğŸ”§ ä¿®å¤å·¥å…·é“¾é…ç½®..."
          sed -i 's/CONFIG_GCC_USE_GRAPHITE=.*/# CONFIG_GCC_USE_GRAPHITE is not set/' .config 2>/dev/null || true
          sed -i 's/CONFIG_GCC_USE_VERSION_11=.*/CONFIG_GCC_USE_VERSION_11=y/' .config 2>/dev/null || echo "CONFIG_GCC_USE_VERSION_11=y" >> .config
          echo "# CONFIG_GCC_USE_GRAPHITE is not set" >> .config
          echo "# CONFIG_GCC_USE_LTO is not set" >> .config
          echo "CONFIG_GCC_USE_VERSION_11=y" >> .config
          echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> .config
          echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> .config
          make defconfig
          echo "âœ… é…ç½®ä¿®å¤å®Œæˆ"

      - name: "ğŸ”„ åˆå§‹åŒ–æœ€å°åŒ–Feeds"
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ”„ åˆå§‹åŒ–æœ€å°åŒ–Feeds ==="
          echo "src-git packages https://github.com/immortalwrt/packages.git;openwrt-21.02" > feeds.conf
          echo "src-git luci https://github.com/immortalwrt/luci.git;openwrt-21.02" >> feeds.conf
          echo "ğŸ“‹ Feedsé…ç½®å†…å®¹:"
          cat feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "âœ… Feedsåˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸ“¥ ä¸‹è½½æºç åŒ…"
        timeout-minutes: 30
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ“¥ ä¸‹è½½æºç åŒ… ==="
          mkdir -p ${{ env.DOWNLOAD_DIR }}
          [ -d "dl" ] && rm -rf dl
          ln -sf ${{ env.DOWNLOAD_DIR }} dl
          echo "ğŸ”§ å¼€å§‹ä¸‹è½½..."
          make download -j1 V=s
          echo "âœ… ä¸‹è½½å®Œæˆ"

      - name: "ğŸ”§ ä¿®å¤å·¥å…·é“¾ç¼–è¯‘ç¯å¢ƒ"
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ”§ ä¿®å¤å·¥å…·é“¾ç¼–è¯‘ç¯å¢ƒ ==="
          rm -rf build_dir/host/gcc-* 2>/dev/null || true
          rm -rf build_dir/toolchain-* 2>/dev/null || true
          rm -rf staging_dir/host 2>/dev/null || true
          rm -rf staging_dir/toolchain-* 2>/dev/null || true
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          export LANG=C
          export PATH="/usr/bin:/bin:/usr/sbin:/sbin:$PATH"
          mkdir -p staging_dir/host/bin
          ln -sf /usr/bin/gcc staging_dir/host/bin/gcc 2>/dev/null || true
          ln -sf /usr/bin/g++ staging_dir/host/bin/g++ 2>/dev/null || true
          ln -sf /usr/bin/as staging_dir/host/bin/as 2>/dev/null || true
          ln -sf /usr/bin/ld staging_dir/host/bin/ld 2>/dev/null || true
          echo "ğŸ”§ ç¯å¢ƒä¿®å¤å®Œæˆ"

      - name: "ğŸ› ï¸ åˆ†é˜¶æ®µç¼–è¯‘å·¥å…·é“¾"
        timeout-minutes: 120
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ› ï¸ åˆ†é˜¶æ®µç¼–è¯‘å·¥å…·é“¾ ==="
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          export LANG=C
          echo "ğŸ”§ é˜¶æ®µ1: ç¼–è¯‘ä¸»æœºå·¥å…·..."
          if make tools/install -j2 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/tools-compile.log; then
            echo "âœ… ä¸»æœºå·¥å…·ç¼–è¯‘æˆåŠŸ"
          else
            echo "âš ï¸ ä¸»æœºå·¥å…·ç¼–è¯‘æœ‰è­¦å‘Šï¼Œç»§ç»­æ‰§è¡Œ..."
          fi
          echo "ğŸ”§ é˜¶æ®µ2: ç¼–è¯‘å·¥å…·é“¾ - å°è¯•1 (æ ‡å‡†)..."
          if make toolchain/compile -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/toolchain-attempt1.log; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            echo "TOOLCHAIN_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å°è¯•1å¤±è´¥ï¼Œåˆ†æé”™è¯¯..."
            if grep -q "cannot compute suffix of object files" ${{ env.BUILD_LOG_DIR }}/toolchain-attempt1.log; then
              echo "ğŸ”§ æ£€æµ‹åˆ°å¯¹è±¡æ–‡ä»¶åç¼€é”™è¯¯ï¼Œå°è¯•ä¿®å¤..."
              rm -rf build_dir/host/gcc-* 2>/dev/null || true
              echo "ğŸ”§ é˜¶æ®µ3: æ¸…ç†åé‡æ–°ç¼–è¯‘å·¥å…·é“¾..."
              if make toolchain/compile -j1 V=sc 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/toolchain-attempt2.log; then
                echo "âœ… å·¥å…·é“¾ä¿®å¤ç¼–è¯‘æˆåŠŸ"
                echo "TOOLCHAIN_SUCCESS=true" >> $GITHUB_ENV
              else
                echo "âŒ å·¥å…·é“¾ä¿®å¤ç¼–è¯‘å¤±è´¥"
                echo "ğŸ” æœ€åé”™è¯¯:"
                tail -50 ${{ env.BUILD_LOG_DIR }}/toolchain-attempt2.log
                exit 1
              fi
            else
              echo "âŒ æœªçŸ¥çš„å·¥å…·é“¾é”™è¯¯"
              exit 1
            fi
          fi

      - name: "ğŸš€ ç¼–è¯‘å›ºä»¶"
        if: env.TOOLCHAIN_SUCCESS == 'true'
        timeout-minutes: 120
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸš€ ç¼–è¯‘å›ºä»¶ ==="
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          echo "ğŸ”§ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          if make -j2 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/compile.log; then
            echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹é‡è¯•..."
            if make -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/compile-retry.log; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
              echo "BUILD_STATUS=success" >> $GITHUB_ENV
            else
              echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•å¤±è´¥"
              echo "BUILD_STATUS=failed" >> $GITHUB_ENV
              exit 1
            fi
          fi

      - name: "ğŸ¯ éªŒè¯å·¥å‚é•œåƒ"
        if: env.BUILD_STATUS == 'success'
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ¯ éªŒè¯å·¥å‚é•œåƒ ==="
          echo "ğŸ” æ£€æŸ¥å·¥å‚é•œåƒ..."
          ASUS_FACTORY=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -i factory || true)
          if [ -n "$ASUS_FACTORY" ]; then
            echo "âœ… å·¥å‚é•œåƒå·²ç”Ÿæˆ:"
            for img in $ASUS_FACTORY; do
              size=$(du -h "$img" | cut -f1)
              echo "  - $img ($size)"
            done
            echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°å·¥å‚é•œåƒ"
            echo "FACTORY_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: "ğŸ“¦ æ”¶é›†äº§ç‰©"
        if: env.BUILD_STATUS == 'success'
        timeout-minutes: 5
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ“¦ æ”¶é›†äº§ç‰© ==="
          mkdir -p ${{ env.ARTIFACTS_DIR }}/firmware
          if [ -d "bin/targets" ]; then
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) -exec cp {} ${{ env.ARTIFACTS_DIR }}/firmware/ \;
            FIRMWARE_COUNT=$(find ${{ env.ARTIFACTS_DIR }}/firmware -type f | wc -l)
            echo "FIRMWARE_COUNT=$FIRMWARE_COUNT" >> $GITHUB_ENV
            echo "âœ… æ”¶é›† $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
          fi

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
        if: env.BUILD_STATUS == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: "firmware-${{ github.run_number }}"
          path: ${{ env.ARTIFACTS_DIR }}
          retention-days: 7

      - name: "ğŸ“‹ ç”ŸæˆæŠ¥å‘Š"
        if: always()
        timeout-minutes: 3
        run: |
          echo "=== ğŸ“‹ æ„å»ºæŠ¥å‘Š ==="
          echo "æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "å·¥å…·é“¾çŠ¶æ€: ${{ env.TOOLCHAIN_SUCCESS || 'unknown' }}"
          echo "å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "å·¥å‚é•œåƒ: ${{ env.FACTORY_EXISTS || 'unknown' }}"
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            if [ "${{ env.FACTORY_EXISTS }}" = "true" ]; then
              echo "ğŸ‰ æ„å»ºæˆåŠŸï¼å·¥å‚é•œåƒå·²ç”Ÿæˆ"
            else
              echo "âš ï¸ æ„å»ºæˆåŠŸä½†æœªç”Ÿæˆå·¥å‚é•œåƒ"
            fi
          else
            echo "âŒ æ„å»ºå¤±è´¥ - ä¸»è¦é—®é¢˜: å·¥å…·é“¾ç¼–è¯‘é”™è¯¯"
          fi
