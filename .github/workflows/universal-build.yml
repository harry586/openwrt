name: Universal Firmware Builder - Enhanced Pre-download & Verification

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: é€‰æ‹©æºç åº“
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: immortalwrt
      source_branch:
        description: æºç åˆ†æ”¯
        required: true
        default: auto
        type: string
      config_profile:
        description: è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„
        required: true
        type: string
        default: .config_rt-ac42u_immortalwrt
      build_optimization:
        description: ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: balanced
      toolchain_strategy:
        description: å·¥å…·é“¾ç­–ç•¥
        required: true
        type: choice
        options:
          - prebuilt
          - local
          - auto
        default: auto
      enable_custom_features:
        description: å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½
        required: false
        default: true
        type: boolean
      fix_common_issues:
        description: è‡ªåŠ¨ä¿®å¤å¸¸è§é—®é¢˜
        required: false
        default: true
        type: boolean
      enable_pre_download:
        description: å¯ç”¨é¢„ä¸‹è½½éªŒè¯
        required: false
        default: true
        type: boolean
      enable_post_verify:
        description: å¯ç”¨ç¼–è¯‘åŽéªŒè¯
        required: false
        default: true
        type: boolean

env:
  TZ: Asia/Shanghai
  SOURCE_DIR: /mnt/source
  ARTIFACTS_DIR: /mnt/artifacts
  CCACHE_DIR: /mnt/ccache
  BUILD_LOG_DIR: /mnt/build-logs
  DOWNLOAD_DIR: /mnt/downloads
  TOOLCHAIN_LOG_DIR: /mnt/toolchain-logs

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      - name: ðŸ“¥ æ£€å‡ºé…ç½®ä»“åº“
        uses: actions/checkout@v4
        with:
          path: .
          fetch-depth: 0

      - name: ðŸ’¾ æ™ºèƒ½ç³»ç»Ÿèµ„æºåˆ†æž
        timeout-minutes: 2
        run: |
          echo "=== æ™ºèƒ½ç³»ç»Ÿèµ„æºåˆ†æž ==="
          echo "ðŸ“Š ç£ç›˜ç©ºé—´:"
          df -h
          echo ""
          echo "ðŸ’» CPU ä¿¡æ¯:"
          echo "æ ¸å¿ƒæ•°: $(nproc)"
          echo "æž¶æž„: $(uname -m)"
          echo "CPU åž‹å·: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d: -f2 | sed 's/^ *//')"
          echo ""
          echo "ðŸ§  å†…å­˜ä¿¡æ¯:"
          free -h
          echo ""
          echo "ðŸ”„ äº¤æ¢ç©ºé—´: $(swapon --show | wc -l 2>/dev/null || echo 0) ä¸ªäº¤æ¢æ–‡ä»¶"
          echo ""
          ROOT_AVAILABLE=$(df / | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${ROOT_AVAILABLE}GB"
          if [ "$ROOT_AVAILABLE" -lt 5 ]; then
            echo "ðŸš¨ è­¦å‘Š: æ ¹åˆ†åŒºç©ºé—´ä¸è¶³5GBï¼Œå¯èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§"
          fi
          echo "âœ… èµ„æºåˆ†æžå®Œæˆ - ç³»ç»Ÿå°±ç»ª"

      - name: ðŸ’¾ å¢žå¼ºå†…å­˜ç®¡ç†ä¸ŽçŽ¯å¢ƒè®¾ç½®
        run: |
          echo "=== å¢žå¼ºå†…å­˜ç®¡ç†ä¸ŽçŽ¯å¢ƒè®¾ç½® ==="
          MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}' 2>/dev/null || echo 0)
          echo "/mnt åˆ†åŒºå¯ç”¨ç©ºé—´: ${MNT_AVAILABLE}GB"
          if [ "$MNT_AVAILABLE" -lt 15 ]; then
            echo "ðŸš¨ ä¸¥é‡é”™è¯¯: /mnt åˆ†åŒºç©ºé—´ä¸è¶³15GBï¼Œæ— æ³•ç¼–è¯‘"
            exit 1
          elif [ "$MNT_AVAILABLE" -lt 25 ]; then
            echo "âš ï¸ è­¦å‘Š: /mnt åˆ†åŒºç©ºé—´ç´§å¼  (${MNT_AVAILABLE}GB)"
          else
            echo "âœ… /mnt åˆ†åŒºç©ºé—´å……è¶³"
          fi
          echo "ðŸ”„ åˆ›å»º16GBäº¤æ¢æ–‡ä»¶..."
          if [ -f /mnt/swapfile ]; then
            sudo swapoff /mnt/swapfile 2>/dev/null || true
            sudo rm -f /mnt/swapfile 2>/dev/null || true
          fi
          sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=16384 status=progress || sudo fallocate -l 16G /mnt/swapfile || sudo truncate -s 16G /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          echo "ðŸ“Š å½“å‰å†…å­˜çŠ¶æ€:"
          free -h
          echo "äº¤æ¢ç©ºé—´:"
          swapon --show
          echo "âš¡ ä¼˜åŒ–å†…å­˜å‚æ•°..."
          sudo sysctl -w vm.swappiness=80 2>/dev/null || echo "âš ï¸ æ— æ³•è®¾ç½®swappiness"
          sudo sysctl -w vm.vfs_cache_pressure=50 2>/dev/null || echo "âš ï¸ æ— æ³•è®¾ç½®vfs_cache_pressure"
          echo "ðŸ”§ åˆ›å»ºå·¥ä½œç›®å½•..."
          sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chown -R $USER:$USER ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chmod -R 755 ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }}
          sudo chmod -R 777 ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          echo "ðŸ“Š è®¾ç½®åŽç£ç›˜ç©ºé—´çŠ¶æ€:"
          df -h

      - name: ðŸ› ï¸ å…¨é¢ç¼–è¯‘ä¾èµ–å®‰è£…ä¸ŽéªŒè¯
        run: |
          echo "å®‰è£…å…¨é¢ç¼–è¯‘ä¾èµ–åŒ…..."
          sudo apt-get update
          echo "ðŸ“¦ å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·..."
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib
          echo "ðŸ“¦ å®‰è£…å¼€å‘åº“..."
          sudo apt-get install -y gettext git libncurses5-dev libssl-dev python3 python3-pip python3-setuptools
          echo "ðŸ“¦ å®‰è£…å·¥å…·é“¾ä¾èµ–..."
          sudo apt-get install -y rsync unzip zlib1g-dev file wget jq ccache m4 help2man texinfo texi2html
          echo "ðŸ“¦ å®‰è£…æž„å»ºå·¥å…·..."
          sudo apt-get install -y libtool-bin automake autoconf pkg-config subversion mercurial curl cmake ninja-build
          echo "ðŸ“¦ å®‰è£…ç³»ç»Ÿåº“..."
          sudo apt-get install -y libelf-dev libssl-dev zlib1g-dev libc6-dev libxml2-dev liblzma-dev liblzo2-dev
          echo "ðŸ” ä¾èµ–å®‰è£…éªŒè¯..."
          echo "=== å…³é”®å·¥å…·éªŒè¯ ==="
          for tool in gcc g++ make flex bison git curl wget ninja; do
            if command -v $tool >/dev/null 2>&1; then
              version=$($tool --version 2>/dev/null | head -1 | cut -d' ' -f1-4 | tr -d '\n' || echo "å¯ç”¨")
              echo "âœ… $tool: $version"
            else
              echo "âŒ $tool: æœªå®‰è£…"
              exit 1
            fi
          done
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å’ŒéªŒè¯å®Œæˆ"

      - name: âš¡ é«˜çº§ç¼“å­˜ä¸Žæ€§èƒ½ä¼˜åŒ–
        run: |
          echo "è®¾ç½®é«˜çº§ç¼“å­˜ä¸Žæ€§èƒ½ä¼˜åŒ–..."
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache -M 16G
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=200000
          ccache -o sloppiness=file_macro,include_file_mtime,include_file_ctime,time_macros
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=16G" >> $GITHUB_ENV
          echo "CCACHE_SLOPPINESS=file_macro,include_file_mtime,include_file_ctime,time_macros" >> $GITHUB_ENV
          echo "ðŸ“Š åˆå§‹CCacheç»Ÿè®¡:"
          ccache -s
          echo "âœ… ç¼“å­˜ä¸Žæ€§èƒ½ä¼˜åŒ–å®Œæˆ"

      - name: ðŸ” æ™ºèƒ½æ–‡ä»¶å‘çŽ°ä¸Žé…ç½®åˆ†æž
        id: file-discovery
        run: |
          echo "=== æ™ºèƒ½æ–‡ä»¶å‘çŽ°ä¸Žé…ç½®åˆ†æž ==="
          set +o pipefail
          echo "ðŸ“‹ æŸ¥æ‰¾ repositories.json æ–‡ä»¶..."
          REPO_JSON_FOUND=$(find . -maxdepth 3 -name "repositories.json" -type f 2>/dev/null | head -1)
          if [ -n "$REPO_JSON_FOUND" ]; then
            echo "âœ… æ‰¾åˆ° repositories.json: $REPO_JSON_FOUND"
            echo "REPO_JSON_PATH=$REPO_JSON_FOUND" >> $GITHUB_ENV
            echo "ðŸ“Š repositories.json å†…å®¹åˆ†æž:"
            jq -r '.repositories | keys[] as $k | "  - \($k): \(.[$k].description // "æ— æè¿°")"' "$REPO_JSON_FOUND" 2>/dev/null || echo "æ— æ³•è§£æžJSONå†…å®¹"
          else
            echo "âŒ æœªæ‰¾åˆ° repositories.json æ–‡ä»¶"
            exit 1
          fi
          echo "ðŸ“‹ æ™ºèƒ½æŸ¥æ‰¾æ‰€æœ‰é…ç½®æ–‡ä»¶..."
          CONFIG_PATTERNS=(".config_*" "config_*" "*.config")
          ALL_CONFIG_FILES=""
          for pattern in "${CONFIG_PATTERNS[@]}"; do
            echo "æœç´¢æ¨¡å¼: $pattern"
            found_files=$(find . -maxdepth 3 -name "$pattern" -type f 2>/dev/null | head -10)
            if [ -n "$found_files" ]; then
              ALL_CONFIG_FILES="$ALL_CONFIG_FILES"$'\n'"$found_files"
              echo "æ‰¾åˆ°æ–‡ä»¶:"
              echo "$found_files"
            fi
          done
          if [ -n "$ALL_CONFIG_FILES" ]; then
            CONFIG_COUNT=$(echo "$ALL_CONFIG_FILES" | grep -v '^$' | wc -l)
            echo "âœ… æ€»å…±æ‰¾åˆ° $CONFIG_COUNT ä¸ªé…ç½®æ–‡ä»¶"
            echo "CONFIG_FILES_FOUND=true" >> $GITHUB_ENV
            echo "$ALL_CONFIG_FILES" > ${{ env.BUILD_LOG_DIR }}/all_config_files.txt
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
            echo "CONFIG_FILES_FOUND=false" >> $GITHUB_ENV
          fi
          set -o pipefail
          echo "âœ… æ™ºèƒ½æ–‡ä»¶å‘çŽ°å®Œæˆ"

      - name: ðŸ”§ æ™ºèƒ½æºç é…ç½®è§£æž
        id: source-config
        run: |
          echo "æ­£åœ¨æ™ºèƒ½è§£æžæºç é…ç½®..."
          PRESET="${{ github.event.inputs.source_preset }}"
          echo "ä½¿ç”¨çš„é¢„è®¾: $PRESET"
          REPO_JSON_PATH="${{ env.REPO_JSON_PATH }}"
          if ! jq -e ".repositories.$PRESET" "$REPO_JSON_PATH" >/dev/null 2>&1; then
            echo "âŒ é”™è¯¯: é¢„è®¾ '$PRESET' ä¸å­˜åœ¨"
            echo "å¯ç”¨çš„é¢„è®¾:"
            jq -r '.repositories | keys[]' "$REPO_JSON_PATH"
            exit 1
          fi
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_PATH")
          DESCRIPTION=$(jq -r ".repositories.$PRESET.description // \"æœªçŸ¥\"" "$REPO_JSON_PATH")
          RECOMMENDED_BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_PATH")
          echo "âœ… æˆåŠŸèŽ·å–é…ç½®ä¿¡æ¯"
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH="$RECOMMENDED_BRANCH"
            echo "ðŸ¤– è‡ªåŠ¨é€‰æ‹©æŽ¨èåˆ†æ”¯: $BRANCH"
          else
            echo "ðŸ“‹ ä½¿ç”¨æŒ‡å®šåˆ†æ”¯: $BRANCH"
          fi
          echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
          echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "RECOMMENDED_BRANCH=$RECOMMENDED_BRANCH" >> $GITHUB_ENV
          echo ""
          echo "âœ… æºç é…ç½®è§£æžå®Œæˆ"
          echo "ðŸ“Š é…ç½®è¯¦æƒ…:"
          echo "  - é¢„è®¾: $PRESET"
          echo "  - æè¿°: $DESCRIPTION"
          echo "  - ä»“åº“: $SOURCE_URL"
          echo "  - åˆ†æ”¯: $BRANCH"
          echo "  - æŽ¨èåˆ†æ”¯: $RECOMMENDED_BRANCH"

      - name: ðŸ“¥ æ™ºèƒ½æºç èŽ·å–ä¸Žåˆ†æ”¯å¤„ç†
        id: clone-source
        run: |
          echo "å¼€å§‹æ™ºèƒ½æºç èŽ·å–ä¸Žåˆ†æ”¯å¤„ç†..."
          cd ${{ env.SOURCE_DIR }}
          REQUESTED_BRANCH="${{ env.SOURCE_BRANCH }}"
          SOURCE_URL="${{ env.SOURCE_URL }}"
          echo "ðŸŽ¯ è¯·æ±‚åˆ†æ”¯: $REQUESTED_BRANCH"
          echo "ðŸŽ¯ æºç ä»“åº“: $SOURCE_URL"
          echo "ðŸ§¹ æ¸…ç†æºç ç›®å½•..."
          rm -rf .[!.]* * 2>/dev/null || true
          CLONE_STRATEGIES=("æŒ‡å®šåˆ†æ”¯æ·±åº¦å…‹éš†: git clone --depth 1 --branch $REQUESTED_BRANCH $SOURCE_URL ." "mainåˆ†æ”¯æ·±åº¦å…‹éš†: git clone --depth 1 --branch main $SOURCE_URL ." "masteråˆ†æ”¯æ·±åº¦å…‹éš†: git clone --depth 1 --branch master $SOURCE_URL ." "é»˜è®¤åˆ†æ”¯æ·±åº¦å…‹éš†: git clone --depth 1 $SOURCE_URL ." "å®Œæ•´å…‹éš†: git clone $SOURCE_URL .")
          if [ "$REQUESTED_BRANCH" = "auto" ]; then
            RECOMMENDED_BRANCH="${{ env.RECOMMENDED_BRANCH }}"
            if [ -n "$RECOMMENDED_BRANCH" ] && [ "$RECOMMENDED_BRANCH" != "null" ]; then
              CLONE_STRATEGIES=("æŽ¨èåˆ†æ”¯æ·±åº¦å…‹éš†: git clone --depth 1 --branch $RECOMMENDED_BRANCH $SOURCE_URL ." "${CLONE_STRATEGIES[@]}")
            fi
          fi
          CLONE_SUCCESS=false
          CLONE_ERROR=""
          ACTUAL_BRANCH=""
          for strategy in "${CLONE_STRATEGIES[@]}"; do
            strategy_name=$(echo "$strategy" | cut -d: -f1)
            clone_cmd=$(echo "$strategy" | cut -d: -f2-)
            echo ""
            echo "ðŸ”„ å°è¯•ç­–ç•¥: $strategy_name"
            echo "å‘½ä»¤: $clone_cmd"
            rm -rf .[!.]* * 2>/dev/null || true
            if eval $clone_cmd 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/clone.log; then
              if [ -d ".git" ]; then
                ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
                COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
                echo "âœ… å…‹éš†æˆåŠŸ: $strategy_name"
                echo "ðŸ“‹ å®žé™…åˆ†æ”¯: $ACTUAL_BRANCH"
                echo "ðŸ”— æäº¤å“ˆå¸Œ: $COMMIT_HASH"
                if [ -f "scripts/feeds" ]; then
                  echo "âœ… å…³é”®æ–‡ä»¶ 'scripts/feeds' å­˜åœ¨"
                  CLONE_SUCCESS=true
                  break
                else
                  echo "âŒ å…³é”®æ–‡ä»¶ 'scripts/feeds' ä¸å­˜åœ¨ï¼Œç»§ç»­å°è¯•å…¶ä»–ç­–ç•¥..."
                  CLONE_ERROR="å…³é”®æ–‡ä»¶ç¼ºå¤±"
                  echo "ðŸ“ å½“å‰ç›®å½•ç»“æž„:"
                  ls -la | head -10
                fi
              else
                CLONE_ERROR="Gitç›®å½•æœªåˆ›å»º"
                echo "âš ï¸ Gitç›®å½•æœªåˆ›å»ºï¼Œç»§ç»­å°è¯•å…¶ä»–ç­–ç•¥..."
              fi
            else
              CLONE_ERROR="å…‹éš†å‘½ä»¤æ‰§è¡Œå¤±è´¥"
              echo "âŒ ç­–ç•¥å¤±è´¥: $strategy_name"
              if [ -f "${{ env.BUILD_LOG_DIR }}/clone.log" ]; then
                echo "å…‹éš†é”™è¯¯è¯¦æƒ…:"
                tail -20 ${{ env.BUILD_LOG_DIR }}/clone.log
              fi
            fi
          done
          if [ "$CLONE_SUCCESS" = "false" ]; then
            echo "âŒ æ‰€æœ‰å…‹éš†ç­–ç•¥éƒ½å¤±è´¥"
            echo "ðŸ” æœ€åŽå°è¯•çš„å…‹éš†æ—¥å¿—:"
            cat ${{ env.BUILD_LOG_DIR }}/clone.log 2>/dev/null || echo "æ— å…‹éš†æ—¥å¿—"
            echo "é”™è¯¯: $CLONE_ERROR"
            exit 1
          fi
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo ""
          echo "ðŸ” æºç ä»“åº“æ·±åº¦éªŒè¯..."
          echo "ðŸ“ æºç ç›®å½•ç»“æž„:"
          ls -la | head -10
          echo ""
          echo "ðŸ”§ éªŒè¯å…³é”®æ–‡ä»¶:"
          for file in scripts/feeds include/toplevel.mk package/Makefile; do
            if [ -f "$file" ]; then
              echo "âœ… $file: å­˜åœ¨"
            else
              echo "âŒ $file: ç¼ºå¤±"
            fi
          done
          echo "âœ… æºç èŽ·å–ä¸ŽéªŒè¯å®Œæˆ"

      - name: ðŸ’¾ æºç èŽ·å–åŽç©ºé—´ç›‘æµ‹
        run: |
          echo "=== æºç èŽ·å–åŽç©ºé—´ç›‘æµ‹ ==="
          echo "ðŸ“Š å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h
          ROOT_AVAILABLE=$(df / | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${ROOT_AVAILABLE}GB"
          echo "/mnt åˆ†åŒºå¯ç”¨ç©ºé—´: ${MNT_AVAILABLE}GB"
          if [ "$ROOT_AVAILABLE" -lt 2 ]; then
            echo "ðŸš¨ ä¸¥é‡è­¦å‘Š: æ ¹åˆ†åŒºç©ºé—´ä¸è¶³2GBï¼Œå¯èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§"
          fi
          if [ "$MNT_AVAILABLE" -lt 10 ]; then
            echo "ðŸš¨ ä¸¥é‡é”™è¯¯: /mnt åˆ†åŒºç©ºé—´ä¸è¶³10GBï¼Œæ— æ³•ç¼–è¯‘"
            exit 1
          elif [ "$MNT_AVAILABLE" -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: /mnt åˆ†åŒºç©ºé—´ç´§å¼  (${MNT_AVAILABLE}GB)"
          else
            echo "âœ… /mnt åˆ†åŒºç©ºé—´å……è¶³"
          fi

      - name: ðŸ”„ æ™ºèƒ½æºç åˆå§‹åŒ–
        timeout-minutes: 30
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¼€å§‹æ™ºèƒ½æºç åˆå§‹åŒ–..."
          START_TIME=$(date +%s)
          echo "ðŸ” éªŒè¯æºç å®Œæ•´æ€§..."
          if [ ! -f "scripts/feeds" ]; then
            echo "âŒ é”™è¯¯: scripts/feeds æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæºç å¯èƒ½ä¸å®Œæ•´"
            echo "ðŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          echo "ðŸ”§ Feedsé…ç½®æ£€æµ‹..."
          FEEDS_CONF_FOUND=""
          for feeds_file in feeds.conf feeds.conf.default .feeds.conf .feeds.conf.default; do
            if [ -f "$feeds_file" ]; then
              FEEDS_CONF_FOUND="$feeds_file"
              echo "ðŸ“‹ ä½¿ç”¨çŽ°æœ‰ $feeds_file"
              if [ "$feeds_file" != "feeds.conf" ]; then
                cp "$feeds_file" feeds.conf
              fi
              break
            fi
          done
          if [ -z "$FEEDS_CONF_FOUND" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°feedsé…ç½®ï¼Œåˆ›å»ºé€šç”¨é…ç½®"
            echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
            echo "src-git luci https://git.openwrt.org/feed/luci.git" >> feeds.conf
            echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
            echo "src-git telephony https://git.openwrt.org/feed/telephony.git" >> feeds.conf
            echo "âœ… å·²åˆ›å»ºé€šç”¨ feeds.conf"
          fi
          echo "ðŸ”„ æ›´æ–°Feeds..."
          for i in 1 2 3; do
            echo "å°è¯• $i/3"
            if ./scripts/feeds update -a; then
              echo "âœ… Feedsæ›´æ–°æˆåŠŸ"
              break
            else
              echo "âŒ Feedsæ›´æ–°å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
              if [ $i -eq 3 ]; then
                echo "âŒ Feedsæ›´æ–°å½»åº•å¤±è´¥"
                exit 1
              fi
              sleep 5
            fi
          done
          echo "ðŸ“¦ å®‰è£…åŸºç¡€Feeds..."
          FEEDS_LIST="packages luci routing telephony"
          for feed in $FEEDS_LIST; do
            if ./scripts/feeds install -a -p $feed; then
              echo "âœ… $feed å®‰è£…æˆåŠŸ"
            else
              echo "âš ï¸ $feed å®‰è£…å¤±è´¥"
            fi
          done
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ Feedsåˆå§‹åŒ–è€—æ—¶: ${DURATION}ç§’"
          echo "âœ… æºç åˆå§‹åŒ–å®Œæˆ"

      - name: ðŸŽ¯ å¿«é€Ÿé…ç½®æ–‡ä»¶æŸ¥æ‰¾ä¸Žåº”ç”¨
        timeout-minutes: 1
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¿«é€Ÿé…ç½®æ–‡ä»¶æŸ¥æ‰¾ä¸Žåº”ç”¨..."
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "è¾“å…¥é…ç½®æ¨¡å¼: $CONFIG_PROFILE"
          echo "ðŸ” å¿«é€Ÿé…ç½®æ–‡ä»¶æœç´¢..."
          CONFIG_FOUND=""
          echo "ðŸŽ¯ ç›´æŽ¥è·¯å¾„æŸ¥æ‰¾..."
          if [ -f "$CONFIG_PROFILE" ]; then
            CONFIG_FOUND="$CONFIG_PROFILE"
            echo "âœ… åœ¨å½“å‰ç›®å½•æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
          elif [ -f "../$CONFIG_PROFILE" ]; then
            CONFIG_FOUND="../$CONFIG_PROFILE"
            echo "âœ… åœ¨ä¸Šçº§ç›®å½•æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
          elif [ -f "$GITHUB_WORKSPACE/$CONFIG_PROFILE" ]; then
            CONFIG_FOUND="$GITHUB_WORKSPACE/$CONFIG_PROFILE"
            echo "âœ… åœ¨å·¥ä½œåŒºæ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
          fi
          if [ -z "$CONFIG_FOUND" ]; then
            echo "ðŸ” å—é™æ·±åº¦æœç´¢..."
            CONFIG_FOUND=$(find . -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            if [ -z "$CONFIG_FOUND" ]; then
              CONFIG_FOUND=$(find $GITHUB_WORKSPACE -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            fi
            if [ -n "$CONFIG_FOUND" ]; then
              echo "âœ… é€šè¿‡å—é™æœç´¢æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
            fi
          fi
          if [ -z "$CONFIG_FOUND" ] && [ -f "${{ env.BUILD_LOG_DIR }}/all_config_files.txt" ]; then
            echo "ðŸ” ä½¿ç”¨æ–‡ä»¶å‘çŽ°ç¼“å­˜..."
            CACHED_PATH=$(grep "$CONFIG_PROFILE" "${{ env.BUILD_LOG_DIR }}/all_config_files.txt" | head -1)
            if [ -n "$CACHED_PATH" ]; then
              if [[ "$CACHED_PATH" == ./* ]]; then
                CONFIG_FOUND="$GITHUB_WORKSPACE/${CACHED_PATH#./}"
              else
                CONFIG_FOUND="$CACHED_PATH"
              fi
              if [ -f "$CONFIG_FOUND" ]; then
                echo "âœ… é€šè¿‡ç¼“å­˜æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
              else
                echo "âš ï¸ ç¼“å­˜ä¸­çš„æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FOUND"
                CONFIG_FOUND=""
              fi
            fi
          fi
          if [ -z "$CONFIG_FOUND" ] && [[ "$CONFIG_PROFILE" == *"*"* ]]; then
            echo "ðŸ” å¿«é€Ÿæ¨¡å¼åŒ¹é…..."
            CONFIG_FOUND=$(find . -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            if [ -z "$CONFIG_FOUND" ]; then
              CONFIG_FOUND=$(find $GITHUB_WORKSPACE -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            fi
            if [ -n "$CONFIG_FOUND" ]; then
              echo "âœ… é€šè¿‡æ¨¡å¼åŒ¹é…æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
            fi
          fi
          if [ -z "$CONFIG_FOUND" ]; then
            echo "ðŸ” æ˜¾ç¤ºå¯ç”¨é…ç½®æ–‡ä»¶..."
            AVAILABLE_CONFIGS=$(find . -maxdepth 3 -name "*.config" -o -name ".config_*" -o -name "config_*" 2>/dev/null | head -5)
            if [ -z "$AVAILABLE_CONFIGS" ]; then
              AVAILABLE_CONFIGS=$(find $GITHUB_WORKSPACE -maxdepth 3 -name "*.config" -o -name ".config_*" -o -name "config_*" 2>/dev/null | head -5)
            fi
            if [ -n "$AVAILABLE_CONFIGS" ]; then
              CONFIG_FOUND=$(echo "$AVAILABLE_CONFIGS" | head -1)
              echo "âš ï¸ ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
              echo "å¯ç”¨é…ç½®æ–‡ä»¶:"
              echo "$AVAILABLE_CONFIGS"
            fi
          fi
          if [ -n "$CONFIG_FOUND" ]; then
            echo "ðŸ“‹ å¤åˆ¶é…ç½®æ–‡ä»¶: $CONFIG_FOUND -> .config"
            if [ -f "$CONFIG_FOUND" ]; then
              cp "$CONFIG_FOUND" .config
              echo "ðŸ” é…ç½®æ–‡ä»¶åŸºæœ¬ä¿¡æ¯:"
              CONFIG_SIZE=$(stat -c%s .config 2>/dev/null || echo "æœªçŸ¥")
              echo "  - æ–‡ä»¶: $(basename $CONFIG_FOUND)"
              echo "  - å¤§å°: ${CONFIG_SIZE} å­—èŠ‚"
              echo "  - æ¥æº: $CONFIG_FOUND"
              TARGET_ARCH=$(grep "CONFIG_TARGET_ARCH_PACKAGES" .config 2>/dev/null | cut -d= -f2 | tr -d '"' | head -1 || echo "æœªçŸ¥")
              echo "  - æž¶æž„: $TARGET_ARCH"
              echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
            else
              echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FOUND"
              echo "ðŸ” éªŒè¯æ–‡ä»¶å­˜åœ¨æ€§..."
              ls -la "$(dirname "$CONFIG_FOUND")" 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âŒ é”™è¯¯: æ— æ³•æ‰¾åˆ°é…ç½®æ–‡ä»¶ '$CONFIG_PROFILE'"
            echo ""
            echo "ðŸ” è°ƒè¯•ä¿¡æ¯:"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
            echo "å¿«é€Ÿé…ç½®æ–‡ä»¶åˆ—è¡¨:"
            find . -maxdepth 2 -name "*.config" -o -name ".config_*" 2>/dev/null | head -10 || echo "å½“å‰ç›®å½•æ— é…ç½®æ–‡ä»¶"
            find $GITHUB_WORKSPACE -maxdepth 2 -name "*.config" -o -name ".config_*" 2>/dev/null | head -10 || echo "å·¥ä½œåŒºæ— é…ç½®æ–‡ä»¶"
            exit 1
          fi

      - name: ðŸ”§ è®¾å¤‡é•œåƒé…ç½®ä¿®å¤
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== è®¾å¤‡é•œåƒé…ç½®ä¿®å¤ ==="
          echo "ðŸ” æ£€æŸ¥å½“å‰ç›®æ ‡è®¾å¤‡é…ç½®..."
          if [ -f ".config" ]; then
            echo "ðŸ“‹ å½“å‰è®¾å¤‡ç›¸å…³é…ç½®:"
            grep -E "CONFIG_TARGET.*asus_rt-ac42u|CONFIG_TARGET_DEVICE|CONFIG_TARGET_.*_DEVICE.*asus" .config | head -20
          fi
          echo "ðŸ”§ ç¡®ä¿å·¥åŽ‚é•œåƒç”Ÿæˆå¯ç”¨..."
          sed -i 's/# CONFIG_TARGET_IMAGES_PACKAGES is not set/CONFIG_TARGET_IMAGES_PACKAGES=y/' .config 2>/dev/null || true
          if grep -q "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u" .config; then
            echo "ðŸŽ¯ å¯ç”¨ asus_rt-ac42u è®¾å¤‡é…ç½®..."
            sed -i 's/# CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u is not set/CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y/' .config
          else
            echo "ðŸ”§ æ·»åŠ  asus_rt-ac42u è®¾å¤‡é…ç½®..."
            echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> .config
          fi
          echo "ðŸ”§ å¯ç”¨å·¥åŽ‚é•œåƒæ ¼å¼..."
          sed -i 's/# CONFIG_IMAGEOPT is not set/CONFIG_IMAGEOPT=y/' .config 2>/dev/null || true
          sed -i 's/# CONFIG_COMBINED_IMAGES is not set/CONFIG_COMBINED_IMAGES=y/' .config 2>/dev/null || true
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> .config
          echo "CONFIG_TARGET_KERNEL_PARTSIZE=32" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=512" >> .config
          echo "ðŸ”„ é‡æ–°è¿è¡Œé…ç½®..."
          make defconfig >/dev/null 2>&1 || echo "é…ç½®æ›´æ–°å®Œæˆ"
          echo "âœ… è®¾å¤‡é•œåƒé…ç½®ä¿®å¤å®Œæˆ"

      - name: ðŸ”§ é«˜çº§æ€§èƒ½ä¼˜åŒ–é…ç½®
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "åº”ç”¨é«˜çº§æ€§èƒ½ä¼˜åŒ–é…ç½®..."
          echo "âš¡ åº”ç”¨åŸºç¡€ä¼˜åŒ–..."
          sed -i 's/CONFIG_DEBUG=y/# CONFIG_DEBUG is not set/' .config 2>/dev/null || true
          sed -i 's/CONFIG_DEVEL=y/# CONFIG_DEVEL is not set/' .config 2>/dev/null || true
          echo "CONFIG_CCACHE=y" >> .config
          case "${{ github.event.inputs.build_optimization }}" in
            "speed")
              echo "ðŸš€ åº”ç”¨æžé€Ÿä¼˜åŒ–é…ç½®..."
              echo "CONFIG_DEBUG_INFO=n" >> .config
              ;;
            "stability")
              echo "ðŸ›¡ï¸ åº”ç”¨ç¨³å®šä¼˜åŒ–é…ç½®..."
              echo "CONFIG_SMALL_FLASH=y" >> .config
              ;;
            *)
              echo "âš–ï¸ åº”ç”¨å¹³è¡¡ä¼˜åŒ–é…ç½®..."
              ;;
          esac
          echo "ðŸ”„ è¿è¡Œé…ç½®å¤„ç†..."
          echo "n" | make oldconfig >/dev/null 2>&1 || make defconfig >/dev/null 2>&1 || echo "é…ç½®å¤„ç†å®Œæˆ"
          echo "âœ… æ€§èƒ½ä¼˜åŒ–é…ç½®å®Œæˆ"

      - name: ðŸ“¥ å…¨é¢é¢„ä¸‹è½½ä¸Žä¾èµ–éªŒè¯
        if: github.event.inputs.enable_pre_download == 'true'
        timeout-minutes: 45
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== å…¨é¢é¢„ä¸‹è½½ä¸Žä¾èµ–éªŒè¯ ==="
          mkdir -p ${{ env.DOWNLOAD_DIR }}
          echo "ðŸ” ç©ºé—´æ£€æŸ¥ - é¢„ä¸‹è½½å‰..."
          DOWNLOAD_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ä¸‹è½½å‰å¯ç”¨ç©ºé—´: ${DOWNLOAD_AVAILABLE}GB"
          if [ "$DOWNLOAD_AVAILABLE" -lt 8 ]; then
            echo "ðŸš¨ ç©ºé—´ä¸è¶³: é¢„ä¸‹è½½éœ€è¦è‡³å°‘8GBç©ºé—´"
            exit 1
          fi
          echo "ðŸ” åˆ†æžéœ€è¦ä¸‹è½½çš„åŒ…..."
          echo "ðŸ“‹ ç”Ÿæˆä¸‹è½½æ¸…å•..."
          make target/linux/prepare 2>/dev/null || true
          echo "ðŸ“¥ å¼€å§‹å…¨é¢é¢„ä¸‹è½½..."
          DOWNLOAD_LOG="${{ env.BUILD_LOG_DIR }}/pre-download.log"
          {
            echo "é˜¶æ®µ1: ä¸‹è½½å†…æ ¸æºç ..."
            make target/linux/download 2>&1
            echo "é˜¶æ®µ2: ä¸‹è½½å·¥å…·é“¾..."
            make toolchain/download 2>&1
            echo "é˜¶æ®µ3: ä¸‹è½½æ‰€æœ‰åŒ…..."
            make package/download 2>&1
            echo "é˜¶æ®µ4: éªŒè¯ä¸‹è½½å®Œæ•´æ€§..."
            make target/linux/check 2>&1 || true
            make package/check 2>&1 || true
          } 2>&1 | tee "$DOWNLOAD_LOG"
          echo "ðŸ” ä¸‹è½½ç»“æžœéªŒè¯..."
          echo "ðŸ“Š ä¸‹è½½ç›®å½•å†…å®¹:"
          ls -la dl/ 2>/dev/null | head -20
          echo "ðŸ”Ž æ£€æŸ¥ä¸‹è½½é”™è¯¯..."
          if grep -i "error\|failed\|not found" "$DOWNLOAD_LOG"; then
            echo "âš ï¸ å‘çŽ°ä¸‹è½½é”™è¯¯ï¼Œä½†ç»§ç»­ç¼–è¯‘è¿‡ç¨‹..."
            echo "DOWNLOAD_STATUS=with_errors" >> $GITHUB_ENV
          else
            echo "âœ… æ‰€æœ‰ä¸‹è½½æˆåŠŸå®Œæˆ"
            echo "DOWNLOAD_STATUS=success" >> $GITHUB_ENV
          fi
          echo "ðŸ“¦ ä¸‹è½½æ–‡ä»¶ç»Ÿè®¡:"
          find dl/ -type f 2>/dev/null | wc -l
          du -sh dl/ 2>/dev/null || echo "ä¸‹è½½ç›®å½•ä¸ºç©º"
          echo "ðŸ” ç©ºé—´æ£€æŸ¥ - é¢„ä¸‹è½½åŽ..."
          POST_DOWNLOAD_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ä¸‹è½½åŽå¯ç”¨ç©ºé—´: ${POST_DOWNLOAD_AVAILABLE}GB"
          SPACE_USED=$((DOWNLOAD_AVAILABLE - POST_DOWNLOAD_AVAILABLE))
          echo "ä¸‹è½½å ç”¨ç©ºé—´: ${SPACE_USED}GB"

      - name: ðŸ” é¢„ç¼–è¯‘çŽ¯å¢ƒéªŒè¯
        if: github.event.inputs.enable_pre_download == 'true'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== é¢„ç¼–è¯‘çŽ¯å¢ƒéªŒè¯ ==="
          echo "ðŸ”§ éªŒè¯å·¥å…·é“¾..."
          echo "ðŸ“‹ æ£€æŸ¥å…³é”®å·¥å…·:"
          for tool in gcc g++ make flex bison ninja; do
            if command -v $tool >/dev/null 2>&1; then
              echo "âœ… $tool: å¯ç”¨"
            else
              echo "âŒ $tool: ç¼ºå¤±"
            fi
          done
          echo "ðŸ“¦ éªŒè¯æºç å®Œæ•´æ€§..."
          if [ -d "dl" ] && [ "$(ls -A dl/ 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "âœ… æºç åŒ…å·²ä¸‹è½½"
            echo "ðŸ“Š ä¸‹è½½åŒ…æ•°é‡: $(find dl/ -type f 2>/dev/null | wc -l)"
            echo "ðŸ“Š ä¸‹è½½ç›®å½•å¤§å°: $(du -sh dl/ 2>/dev/null || echo "æœªçŸ¥")"
          else
            echo "âš ï¸ æºç åŒ…ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          fi
          echo "ðŸ”— éªŒè¯ä¾èµ–å…³ç³»..."
          make defconfig >/dev/null 2>&1
          if make -p -q >/dev/null 2>&1; then
            echo "âœ… ä¾èµ–å…³ç³»éªŒè¯é€šè¿‡"
          else
            echo "âš ï¸ ä¾èµ–å…³ç³»å¯èƒ½æœ‰å†²çª"
          fi
          echo "ðŸ’¾ æœ€ç»ˆç©ºé—´æ£€æŸ¥..."
          FINAL_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ç¼–è¯‘å‰å¯ç”¨ç©ºé—´: ${FINAL_AVAILABLE}GB"
          if [ "$FINAL_AVAILABLE" -lt 5 ]; then
            echo "ðŸš¨ ä¸¥é‡è­¦å‘Š: ç¼–è¯‘å‰å¯ç”¨ç©ºé—´ä¸è¶³5GB"
            echo "ðŸ’¡ å»ºè®®æ¸…ç†æˆ–å¢žåŠ ç©ºé—´"
          elif [ "$FINAL_AVAILABLE" -lt 10 ]; then
            echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰å¯ç”¨ç©ºé—´ç´§å¼ "
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi

      - name: ðŸ› ï¸ Sambaä¸“ç”¨ä¿®å¤ä¸Žç¼–è¯‘
        if: github.event.inputs.enable_custom_features == 'true'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== Sambaä¸“ç”¨ä¿®å¤ä¸Žç¼–è¯‘ ==="
          echo "ðŸ”§ æ™ºèƒ½æ£€æµ‹Sambaä¾èµ–åº“è·¯å¾„..."
          echo "ðŸ” æœç´¢tallocç›¸å…³ç›®å½•..."
          find . -name "*talloc*" -type d 2>/dev/null | grep -E "(package|feeds)" | head -10
          echo "ðŸ” æœç´¢tdbç›¸å…³ç›®å½•..."
          find . -name "*tdb*" -type d 2>/dev/null | grep -E "(package|feeds)" | head -10
          echo "ðŸ” æœç´¢teventç›¸å…³ç›®å½•..."
          find . -name "*tevent*" -type d 2>/dev/null | grep -E "(package|feeds)" | head -10
          echo "ðŸ” æœç´¢ldbç›¸å…³ç›®å½•..."
          find . -name "*ldb*" -type d 2>/dev/null | grep -E "(package|feeds)" | head -10
          echo "ðŸ”„ æ›´æ–°å¹¶å®‰è£…Sambaç›¸å…³feeds..."
          ./scripts/feeds update packages 2>/dev/null || true
          ./scripts/feeds install libtalloc 2>/dev/null || echo "âš ï¸ libtallocå®‰è£…å¤±è´¥"
          ./scripts/feeds install libtdb 2>/dev/null || echo "âš ï¸ libtdbå®‰è£…å¤±è´¥" 
          ./scripts/feeds install libtevent 2>/dev/null || echo "âš ï¸ libteventå®‰è£…å¤±è´¥"
          ./scripts/feeds install libldb 2>/dev/null || echo "âš ï¸ libldbå®‰è£…å¤±è´¥"
          echo "ðŸ“¦ ä½¿ç”¨ç¨³å¥çš„Sambaä¾èµ–åº“ç¼–è¯‘æ–¹æ³•..."
          echo "ðŸ”§ å…ˆç¼–è¯‘ä¸€äº›åŸºç¡€åŒ…æµ‹è¯•çŽ¯å¢ƒ..."
          make package/libs/toolchain/compile -j1 V=s 2>/dev/null || echo "âš ï¸ å·¥å…·é“¾ç¼–è¯‘æµ‹è¯•å¤±è´¥"
          SAMBA_DEPS=("talloc" "tdb" "tevent" "ldb")
          SAMBA_SUCCESS=true
          for dep in "${SAMBA_DEPS[@]}"; do
            echo "ç¼–è¯‘ $dep..."
            if make package/$dep/compile -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/samba-$dep.log; then
              echo "âœ… $dep ç¼–è¯‘æˆåŠŸ (æ ‡å‡†è·¯å¾„)"
              continue
            fi
            if make package/feeds/packages/$dep/compile -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/samba-$dep-feeds.log; then
              echo "âœ… $dep ç¼–è¯‘æˆåŠŸ (feedsè·¯å¾„)"
              continue
            fi
            if make package/libs/$dep/compile -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/samba-$dep-libs.log; then
              echo "âœ… $dep ç¼–è¯‘æˆåŠŸ (libsè·¯å¾„)"
              continue
            fi
            echo "âŒ $dep æ‰€æœ‰ç¼–è¯‘å°è¯•éƒ½å¤±è´¥ï¼Œä½†ç»§ç»­æµç¨‹..."
            SAMBA_SUCCESS=false
          done
          if [ "$SAMBA_SUCCESS" = "false" ]; then
            echo "âš ï¸ éƒ¨åˆ†Sambaä¾èµ–åº“ç¼–è¯‘å¤±è´¥ï¼Œè€ƒè™‘ç¦ç”¨Samba"
          else
            echo "âœ… æ‰€æœ‰Sambaä¾èµ–åº“ç¼–è¯‘å®Œæˆ"
          fi
          echo "ðŸ”§ ä¼˜åŒ–ç¼–è¯‘çŽ¯å¢ƒ..."
          export CFLAGS="$CFLAGS -Os -pipe -fno-caller-saves"
          export CXXFLAGS="$CXXFLAGS -Os -pipe -fno-caller-saves"
          echo "âœ… Sambaä¿®å¤å®Œæˆ"

      - name: ðŸ”§ ç»¼åˆé—®é¢˜ä¿®å¤
        if: github.event.inputs.fix_common_issues == 'true'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== æ‰§è¡Œç»¼åˆé—®é¢˜ä¿®å¤ ==="
          echo "ðŸ”§ æ·±åº¦ç›®å½•ä¿®å¤ä¸Žæƒé™è®¾ç½®..."
          echo "åˆ›å»ºç›®æ ‡æ ¹æ–‡ä»¶ç³»ç»Ÿå¿…è¦ç›®å½•..."
          find build_dir -name "root.orig-*" -type d 2>/dev/null | while read root_dir; do
            echo "ä¿®å¤ç›®å½•: $root_dir"
            mkdir -p "$root_dir/tmp"
            mkdir -p "$root_dir/var/lock"
            mkdir -p "$root_dir/var/run"
            mkdir -p "$root_dir/usr/lib/opkg"
            mkdir -p "$root_dir/var/lib/opkg"
            chmod 755 "$root_dir/tmp"
            chmod 755 "$root_dir/var"
            echo "âœ… å·²ä¿®å¤: $root_dir"
          done
          echo "ðŸ”§ ä¿®å¤å·²çŸ¥ç›®æ ‡ç›®å½•ç»“æž„..."
          KNOWN_ROOTS=("build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/root.orig-ipq40xx" "staging_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/root.orig-ipq40xx" "build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/root-ipq40xx")
          for known_root in "${KNOWN_ROOTS[@]}"; do
            if [ -d "$known_root" ]; then
              echo "ðŸ”§ ä¿®å¤å·²çŸ¥ç›®å½•: $known_root"
              mkdir -p "$known_root/tmp"
              mkdir -p "$known_root/var/lock"
              mkdir -p "$known_root/var/run"
              mkdir -p "$known_root/usr/lib/opkg"
              mkdir -p "$known_root/var/lib/opkg"
              chmod 755 "$known_root/tmp"
              echo "âœ… å·²ä¿®å¤: $known_root"
            else
              echo "â„¹ï¸ ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»º: $known_root"
              mkdir -p "$known_root/tmp" 2>/dev/null || true
            fi
          done
          echo "ðŸ”§ åˆ›å»ºé€šç”¨ç›®æ ‡ç›®å½•ç»“æž„..."
          TARGET_PATTERN="target-*"
          for target_dir in $TARGET_PATTERN; do
            if [ -d "$target_dir" ]; then
              find "$target_dir" -name "root*" -type d 2>/dev/null | while read root_dir; do
                mkdir -p "$root_dir/tmp"
                mkdir -p "$root_dir/var/lock" 
                mkdir -p "$root_dir/var/run"
                chmod 755 "$root_dir/tmp"
              done
            fi
          done
          echo "ðŸ”§ ä¿®å¤å·¥åŽ‚é•œåƒé…ç½®..."
          if [ -f ".config" ]; then
            echo "ðŸŽ¯ å¯ç”¨å·¥åŽ‚é•œåƒç”Ÿæˆé…ç½®..."
            sed -i 's/# CONFIG_TARGET_IMAGES_PACKAGES is not set/CONFIG_TARGET_IMAGES_PACKAGES=y/' .config 2>/dev/null || true
            sed -i 's/# CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u is not set/CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y/' .config 2>/dev/null || true
            sed -i 's/# CONFIG_IMAGEOPT is not set/CONFIG_IMAGEOPT=y/' .config 2>/dev/null || true
            sed -i 's/# CONFIG_COMBINED_IMAGES is not set/CONFIG_COMBINED_IMAGES=y/' .config 2>/dev/null || true
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
            echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> .config
            echo "CONFIG_TARGET_ROOTFS_INCLUDE_USB=y" >> .config
            echo "âœ… å·¥åŽ‚é•œåƒé…ç½®å·²ä¿®å¤"
            make defconfig >/dev/null 2>&1 || echo "é…ç½®æ›´æ–°å®Œæˆ"
          fi
          echo "ðŸ”§ æ£€æŸ¥é—®é¢˜åŒ…å¤„ç†..."
          if grep -q "CONFIG_PACKAGE_samba4-server=y" .config 2>/dev/null; then
            echo "âš ï¸ sambaåŒ…å·²å¯ç”¨ï¼Œå¦‚æŒç»­å¤±è´¥å¯è€ƒè™‘ç¦ç”¨"
            echo "ðŸ’¡ å¦‚éœ€ç¦ç”¨sambaï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹è¡Œ:"
            echo "# sed -i 's/CONFIG_PACKAGE_samba4-server=y/# CONFIG_PACKAGE_samba4-server is not set/' .config"
            echo "# sed -i 's/CONFIG_PACKAGE_luci-app-samba4=y/# CONFIG_PACKAGE_luci-app-samba4 is not set/' .config"
            if [ "${{ github.event.inputs.fix_common_issues }}" = "true" ]; then
              echo "ðŸ”§ æ ¹æ®é…ç½®è‡ªåŠ¨ç¦ç”¨å¯èƒ½æœ‰é—®é¢˜çš„sambaåŒ…..."
              sed -i 's/CONFIG_PACKAGE_samba4-server=y/# CONFIG_PACKAGE_samba4-server is not set/' .config 2>/dev/null || true
              sed -i 's/CONFIG_PACKAGE_luci-app-samba4=y/# CONFIG_PACKAGE_luci-app-samba4 is not set/' .config 2>/dev/null || true
              echo "âœ… å·²è‡ªåŠ¨ç¦ç”¨sambaç›¸å…³åŒ…"
            fi
          fi
          echo "ðŸ”§ ä¿®å¤ç¬¦å·é“¾æŽ¥..."
          if [ -L "tmp" ] && [ ! -e "tmp" ]; then
            echo "ðŸ”§ ä¿®å¤æŸåçš„tmpç¬¦å·é“¾æŽ¥..."
            rm -f tmp
            mkdir -p tmp
            echo "âœ… tmpç¬¦å·é“¾æŽ¥å·²ä¿®å¤"
          fi
          echo "âœ… ç»¼åˆé—®é¢˜ä¿®å¤å®Œæˆ"

      - name: ðŸ› ï¸ å…¨é¢å·¥å…·é“¾ç¼–è¯‘ä¸ŽéªŒè¯
        timeout-minutes: 90
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¼€å§‹å…¨é¢å·¥å…·é“¾ç¼–è¯‘..."
          START_TIME=$(date +%s)
          mkdir -p ${{ env.TOOLCHAIN_LOG_DIR }}
          echo "ðŸ”§ ç¼–è¯‘Hostå·¥å…·..."
          if ! make tools/compile -j$(($(nproc) - 1)) V=sc 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/host-tools.log; then
            echo "âŒ Hostå·¥å…·ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
            if ! make tools/compile -j1 V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/host-tools-single.log; then
              echo "âŒ Hostå·¥å…·ç¼–è¯‘å½»åº•å¤±è´¥"
              exit 1
            fi
          fi
          echo "ðŸ”§ ç¼–è¯‘å·¥å…·é“¾..."
          if ! make toolchain/compile -j$(($(nproc) - 1)) V=sc 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/toolchain-compile.log; then
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
            if ! make toolchain/compile -j1 V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/toolchain-compile-single.log; then
              echo "âŒ å·¥å…·é“¾ç¼–è¯‘å½»åº•å¤±è´¥"
              exit 1
            fi
          fi
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ å·¥å…·é“¾ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’"
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"

      - name: ðŸ” æ·±åº¦å·¥å…·é“¾éªŒè¯
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== æ·±åº¦å·¥å…·é“¾éªŒè¯ ==="
          echo "ðŸ”§ å…³é”®å·¥å…·éªŒè¯:"
          for tool in m4 flex bison; do
            tool_path=$(find staging_dir/host/bin -name "$tool" -type f 2>/dev/null | head -1)
            if [ -n "$tool_path" ] && [ -x "$tool_path" ]; then
              echo "âœ… $tool: å¯ç”¨"
            else
              echo "âŒ $tool: ç¼ºå¤±"
              exit 1
            fi
          done
          echo "ðŸŽ¯ ç›®æ ‡å·¥å…·é“¾éªŒè¯:"
          TARGET_GCC=$(find staging_dir/toolchain-*/bin/ -name "*gcc" -type f 2>/dev/null | head -1)
          if [ -n "$TARGET_GCC" ] && [ -x "$TARGET_GCC" ]; then
            echo "âœ… ç›®æ ‡GCC: å¯ç”¨"
          else
            echo "âŒ ç›®æ ‡GCC: ç¼ºå¤±"
            exit 1
          fi
          echo "âœ… æ·±åº¦å·¥å…·é“¾éªŒè¯å®Œæˆ"

      - name: ðŸ—ï¸ æ™ºèƒ½ç¼–è¯‘å›ºä»¶ï¼ˆåˆ†é˜¶æ®µä¼˜åŒ–ï¼‰
        timeout-minutes: 240
        id: compile-firmware
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¼€å§‹æ™ºèƒ½ç¼–è¯‘å›ºä»¶ï¼ˆåˆ†é˜¶æ®µä¼˜åŒ–ï¼‰..."
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=linux
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          BUILD_JOBS=${BUILD_JOBS:-$(( $(nproc) - 1 ))}
          SAMBA_JOBS=${SAMBA_JOBS:-1}
          mkdir -p ${{ env.BUILD_LOG_DIR }}
          START_TIME=$(date +%s)
          echo "ðŸ” ç¼–è¯‘å‰æœ€ç»ˆç©ºé—´æ£€æŸ¥..."
          COMPILE_START_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ç¼–è¯‘å¼€å§‹å‰å¯ç”¨ç©ºé—´: ${COMPILE_START_SPACE}GB"
          if [ "$COMPILE_START_SPACE" -lt 3 ]; then
            echo "ðŸš¨ ä¸¥é‡é”™è¯¯: ç¼–è¯‘å¼€å§‹å‰ç©ºé—´ä¸è¶³3GB"
            exit 1
          fi
          echo "ðŸ“Š ç¼–è¯‘å‚æ•°æ±‡æ€»:"
          echo "  - æºç åº“: ${{ env.SOURCE_PRESET }}"
          echo "  - å®žé™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
          echo "  - å·¥å…·é“¾ç­–ç•¥: ${{ github.event.inputs.toolchain_strategy }}"
          echo "  - è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
          echo "  - é—®é¢˜ä¿®å¤: ${{ github.event.inputs.fix_common_issues }}"
          echo "  - é¢„ä¸‹è½½: ${{ github.event.inputs.enable_pre_download }}"
          echo "  - åŽéªŒè¯: ${{ github.event.inputs.enable_post_verify }}"
          echo "  - CPUæ ¸å¿ƒ: $(nproc)"
          echo "  - ç¼–è¯‘ä»»åŠ¡æ•°: $BUILD_JOBS"
          echo "  - Sambaä»»åŠ¡æ•°: $SAMBA_JOBS"
          echo "  - CCache: å·²å¯ç”¨"
          echo "  - èµ·å§‹ç©ºé—´: ${COMPILE_START_SPACE}GB"
          echo "ðŸ”§ å¼€å§‹ç¼–è¯‘..."
          LOG_FILE="${{ env.BUILD_LOG_DIR }}/firmware-compile.log"
          {
            echo "é˜¶æ®µ1: åŸºç¡€çŽ¯å¢ƒå‡†å¤‡..."
            make tools/install 2>/dev/null || echo "âš ï¸ å·¥å…·å®‰è£…è­¦å‘Š"
            make toolchain/install 2>/dev/null || echo "âš ï¸ å·¥å…·é“¾å®‰è£…è­¦å‘Š"
            echo "é˜¶æ®µ2: å†…æ ¸ç¼–è¯‘..."
            make target/linux/compile -j$BUILD_JOBS V=s || {
              echo "âš ï¸ å†…æ ¸ç¼–è¯‘é‡åˆ°é—®é¢˜ï¼Œç»§ç»­..."
            }
            echo "é˜¶æ®µ3: åŒ…ç¼–è¯‘ï¼ˆåˆ†æ‰¹æ¬¡ï¼‰..."
            echo "ðŸ”§ ç¼–è¯‘åŸºç¡€ç½‘ç»œåŒ…..."
            make package/network/utils/compile -j$BUILD_JOBS V=s || echo "âš ï¸ ç½‘ç»œå·¥å…·ç¼–è¯‘é—®é¢˜"
            echo "ðŸ”§ ç¼–è¯‘åŸºç¡€ç³»ç»ŸåŒ…..."
            make package/system/compile -j$BUILD_JOBS V=s || echo "âš ï¸ ç³»ç»ŸåŒ…ç¼–è¯‘é—®é¢˜"
            echo "ðŸ”§ ç¼–è¯‘LuCIç›¸å…³åŒ…..."
            make package/feeds/luci/compile -j$BUILD_JOBS V=s || echo "âš ï¸ LuCIç¼–è¯‘é—®é¢˜"
            if [ "${{ github.event.inputs.enable_custom_features }}" = "true" ]; then
              echo "é˜¶æ®µ4: Sambaç›¸å…³åŒ…ç¼–è¯‘..."
              for pkg in samba4-libs samba4-server luci-app-samba4; do
                echo "ç¼–è¯‘ $pkg..."
                if make package/$pkg/compile -j$SAMBA_JOBS V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/$pkg-compile.log; then
                  echo "âœ… $pkg ç¼–è¯‘æˆåŠŸ"
                else
                  echo "âš ï¸ $pkg ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
                  make package/$pkg/compile -j$SAMBA_JOBS V=sc 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/$pkg-fix.log || echo "âŒ $pkg å½»åº•å¤±è´¥"
                fi
              done
            fi
            echo "é˜¶æ®µ5: å‰©ä½™åŒ…ç¼–è¯‘..."
            make package/compile -j$BUILD_JOBS V=sc || {
              echo "âš ï¸ éƒ¨åˆ†åŒ…ç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­å®‰è£…é˜¶æ®µ..."
            }
            echo "é˜¶æ®µ6: åŒ…å®‰è£…..."
            make package/install -j1 V=s || {
              echo "âŒ åŒ…å®‰è£…å¤±è´¥ï¼Œå°è¯•ä¿®å¤æ–¹æ³•..."
              mkdir -p build_dir/target-*/root-*/tmp
              mkdir -p build_dir/target-*/root-*/var/lock
              mkdir -p build_dir/target-*/root-*/var/run
              make package/install -j1 V=sc || echo "âš ï¸ åŒ…å®‰è£…ä»ç„¶å¤±è´¥ï¼Œç»§ç»­ç›®æ ‡å®‰è£…"
            }
            echo "é˜¶æ®µ7: ç›®æ ‡å®‰è£…..."
            make target/install -j1 V=s || {
              echo "âŒ ç›®æ ‡å®‰è£…å¤±è´¥ï¼Œå°è¯•ç›´æŽ¥ç”Ÿæˆé•œåƒ..."
              make -j1 V=sc || make image -j1 V=sc
            }
            echo "é˜¶æ®µ8: ç”Ÿæˆé•œåƒ..."
            make target/linux/ipq40xx/image -j1 V=s || {
              echo "âš ï¸ ä¸“é—¨é•œåƒç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç›®æ ‡..."
              make -j1 V=sc
            }
          } 2>&1 | tee "$LOG_FILE"
          COMPILE_EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV
          echo "ðŸ” ç¼–è¯‘åŽç©ºé—´æ£€æŸ¥..."
          COMPILE_END_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ç¼–è¯‘ç»“æŸåŽå¯ç”¨ç©ºé—´: ${COMPILE_END_SPACE}GB"
          SPACE_USED=$((COMPILE_START_SPACE - COMPILE_END_SPACE))
          echo "ç¼–è¯‘è¿‡ç¨‹å ç”¨ç©ºé—´: ${SPACE_USED}GB"
          if find bin -name "*.bin" -o -name "*.img" 2>/dev/null | grep -q .; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "ðŸŽ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼ˆæœ‰å›ºä»¶ç”Ÿæˆï¼‰!"
          elif [ $COMPILE_EXIT_CODE -eq 0 ]; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "ðŸŽ‰ ç¼–è¯‘æˆåŠŸå®Œæˆ!"
          else
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç : $COMPILE_EXIT_CODE"
            exit 1
          fi
          echo "â±ï¸ æ€»ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’ ($(($DURATION/60))åˆ†é’Ÿ)"

      - name: ðŸ” ç¼–è¯‘åŽå…¨é¢éªŒè¯
        if: env.BUILD_STATUS == 'success' && github.event.inputs.enable_post_verify == 'true'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ç¼–è¯‘åŽå…¨é¢éªŒè¯ ==="
          echo "ðŸ” å›ºä»¶æ–‡ä»¶éªŒè¯..."
          if [ -d "bin/targets" ]; then
            echo "âœ… å›ºä»¶è¾“å‡ºç›®å½•å­˜åœ¨"
            echo "ðŸ“Š ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
            find bin/targets -name "*.bin" -o -name "*.img" 2>/dev/null | while read file; do
              if [ -f "$file" ]; then
                size=$(stat -c%s "$file" 2>/dev/null || echo 0)
                echo "  - $(basename "$file") ($(($size/1024/1024))MB)"
              fi
            done
            echo "ðŸ” æ£€æŸ¥ASUS RT-AC42Ué•œåƒ..."
            ASUS_IMAGES=$(find bin/targets -name "*asus_rt-ac42u*" -type f 2>/dev/null)
            if [ -n "$ASUS_IMAGES" ]; then
              echo "âœ… ASUS RT-AC42Ué•œåƒå·²ç”Ÿæˆ:"
              for img in $ASUS_IMAGES; do
                echo "  - $(basename "$img")"
              done
            else
              echo "âš ï¸ æœªæ‰¾åˆ°ASUS RT-AC42Uç‰¹å®šé•œåƒ"
            fi
            echo "ðŸ” æ£€æŸ¥é•œåƒç±»åž‹å®Œæ•´æ€§..."
            FACTORY_COUNT=$(find bin/targets -name "*factory*" -type f 2>/dev/null | wc -l)
            UPGRADE_COUNT=$(find bin/targets -name "*sysupgrade*" -type f 2>/dev/null | wc -l)
            echo "  - å·¥åŽ‚é•œåƒ: $FACTORY_COUNT ä¸ª"
            echo "  - å‡çº§é•œåƒ: $UPGRADE_COUNT ä¸ª"
          else
            echo "âŒ å›ºä»¶è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
          fi
          echo "ðŸ” SambaåŠŸèƒ½éªŒè¯..."
          if find bin -name "*samba4*" -type f | grep -q .; then
            echo "âœ… Sambaç›¸å…³åŒ…å·²ç”Ÿæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°Sambaç›¸å…³åŒ…"
          fi
          echo "ðŸ” å…³é”®åŒ…éªŒè¯..."
          for pkg in base-files luci firewall; do
            if find bin -name "*$pkg*" -type f | grep -q .; then
              echo "âœ… $pkg ç›¸å…³åŒ…å·²ç”Ÿæˆ"
            else
              echo "âš ï¸ æœªæ‰¾åˆ° $pkg ç›¸å…³åŒ…"
            fi
          done
          echo "ðŸ“Š æœ€ç»ˆç©ºé—´çŠ¶æ€..."
          FINAL_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "æœ€ç»ˆå¯ç”¨ç©ºé—´: ${FINAL_SPACE}GB"
          echo "âœ… ç¼–è¯‘åŽéªŒè¯å®Œæˆ"

      - name: ðŸ” è¯¦ç»†å›ºä»¶äº§ç‰©éªŒè¯ä¸Žæ”¶é›†
        if: env.BUILD_STATUS == 'success'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== è¯¦ç»†å›ºä»¶äº§ç‰©éªŒè¯ä¸Žæ”¶é›† ==="
          mkdir -p ${{ env.ARTIFACTS_DIR }}/firmware
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs
          mkdir -p ${{ env.ARTIFACTS_DIR }}/configs
          echo "ðŸ” æœç´¢å›ºä»¶æ–‡ä»¶..."
          TOTAL_FIRMWARE_COUNT=0
          if [ -d "bin/targets" ]; then
            echo "ðŸ“ å¤åˆ¶æ ‡å‡†è¾“å‡ºç›®å½•..."
            cp -r bin/targets ${{ env.ARTIFACTS_DIR }}/firmware/
            INITRAMFS_COUNT=$(find bin/targets -name "*initramfs*" -type f 2>/dev/null | wc -l)
            UPGRADE_COUNT=$(find bin/targets -name "*sysupgrade*" -type f 2>/dev/null | wc -l)
            FACTORY_COUNT=$(find bin/targets -name "*factory*" -type f 2>/dev/null | wc -l)
            OTHER_COUNT=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.itb" 2>/dev/null | grep -v -e "initramfs" -e "sysupgrade" -e "factory" | wc -l)
            TOTAL_FIRMWARE_COUNT=$((INITRAMFS_COUNT + UPGRADE_COUNT + FACTORY_COUNT + OTHER_COUNT))
            echo "ðŸ“Š å›ºä»¶ç±»åž‹ç»Ÿè®¡:"
            echo "  - Initramfs é•œåƒ: $INITRAMFS_COUNT ä¸ª"
            echo "  - ç³»ç»Ÿå‡çº§é•œåƒ: $UPGRADE_COUNT ä¸ª"
            echo "  - å·¥åŽ‚åˆ·æœºé•œåƒ: $FACTORY_COUNT ä¸ª"
            echo "  - å…¶ä»–é•œåƒ: $OTHER_COUNT ä¸ª"
            echo "  - æ€»è®¡: $TOTAL_FIRMWARE_COUNT ä¸ªæ–‡ä»¶"
            echo "ðŸ“‹ å›ºä»¶æ–‡ä»¶è¯¦ç»†åˆ—è¡¨:"
            find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.itb" 2>/dev/null | head -30 | while read file; do
              if [ -f "$file" ]; then
                file_size=$(stat -c%s "$file" 2>/dev/null || echo 0)
                file_type="å…¶ä»–"
                if [[ "$file" == *"initramfs"* ]]; then
                  file_type="Initramfs"
                elif [[ "$file" == *"sysupgrade"* ]]; then
                  file_type="ç³»ç»Ÿå‡çº§"
                elif [[ "$file" == *"factory"* ]]; then
                  file_type="å·¥åŽ‚åˆ·æœº"
                fi
                echo "  - $file_type: $(basename "$file") ($(($file_size/1024/1024))MB)"
              fi
            done
            echo ""
            echo "ðŸ” æ£€æŸ¥ ASUS RT-AC42U ç‰¹å®šé•œåƒ..."
            ASUS_IMAGES=$(find bin/targets -name "*asus_rt-ac42u*" -type f 2>/dev/null)
            if [ -n "$ASUS_IMAGES" ]; then
              echo "ðŸ“‹ ASUS RT-AC42U é•œåƒåˆ—è¡¨:"
              for img in $ASUS_IMAGES; do
                if [ -f "$img" ]; then
                  img_size=$(stat -c%s "$img" 2>/dev/null || echo 0)
                  img_type="æœªçŸ¥"
                  if [[ "$img" == *"initramfs"* ]]; then
                    img_type="RAMå¯åŠ¨é•œåƒ"
                  elif [[ "$img" == *"sysupgrade"* ]]; then
                    img_type="ç³»ç»Ÿå‡çº§é•œåƒ"
                  elif [[ "$img" == *"factory"* ]]; then
                    img_type="å·¥åŽ‚åˆ·æœºé•œåƒ"
                  fi
                  echo "  - $img_type: $(basename "$img") ($(($img_size/1024/1024))MB)"
                fi
              done
              ASUS_FACTORY=$(find bin/targets -name "*asus_rt-ac42u*factory*" -type f 2>/dev/null)
              if [ -z "$ASUS_FACTORY" ]; then
                echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ° ASUS RT-AC42U å·¥åŽ‚åˆ·æœºé•œåƒ"
                echo "FACTORY_MISSING=true" >> $GITHUB_ENV
              else
                echo "âœ… å·²æ‰¾åˆ° ASUS RT-AC42U å·¥åŽ‚åˆ·æœºé•œåƒ"
                echo "FACTORY_MISSING=false" >> $GITHUB_ENV
              fi
            else
              echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½• ASUS RT-AC42U é•œåƒ"
              echo "FACTORY_MISSING=true" >> $GITHUB_ENV
            fi
          else
            echo "âš ï¸ æ ‡å‡†è¾“å‡ºç›®å½• bin/targets ä¸å­˜åœ¨"
            echo "FACTORY_MISSING=true" >> $GITHUB_ENV
          fi
          echo "ðŸ” åœ¨å…¶ä»–ä½ç½®æœç´¢å›ºä»¶..."
          OTHER_FIRMWARE=$(find . -maxdepth 4 -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" 2>/dev/null | grep -v "bin/targets" | head -20)
          if [ -n "$OTHER_FIRMWARE" ]; then
            OTHER_COUNT=$(echo "$OTHER_FIRMWARE" | wc -l)
            echo "âœ… åœ¨å…¶ä»–ä½ç½®æ‰¾åˆ° $OTHER_COUNT ä¸ªå›ºä»¶ç›¸å…³æ–‡ä»¶"
            for file in $OTHER_FIRMWARE; do
              if [ -f "$file" ]; then
                file_size=$(stat -c%s "$file" 2>/dev/null || echo 0)
                if [ "$file_size" -gt 1000000 ]; then
                  rel_path=$(echo "$file" | sed 's|^\./||')
                  target_dir="${{ env.ARTIFACTS_DIR }}/firmware/other/$(dirname "$rel_path")"
                  mkdir -p "$target_dir"
                  cp "$file" "$target_dir/"
                  echo "ðŸ“¦ å·²æ”¶é›†: $rel_path ($(($file_size/1024/1024))MB)"
                  TOTAL_FIRMWARE_COUNT=$((TOTAL_FIRMWARE_COUNT + 1))
                fi
              fi
            done
          fi
          if [ $TOTAL_FIRMWARE_COUNT -eq 0 ]; then
            echo "ðŸ” æ·±åº¦æœç´¢å›ºä»¶æ–‡ä»¶..."
            BUILD_FIRMWARE=$(find build_dir -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | head -10)
            if [ -n "$BUILD_FIRMWARE" ]; then
              echo "âœ… åœ¨build_dirä¸­æ‰¾åˆ°å›ºä»¶ç›¸å…³æ–‡ä»¶:"
              echo "$BUILD_FIRMWARE"
            fi
          fi
          echo "ðŸ“‹ æ”¶é›†æž„å»ºä¿¡æ¯å’Œæ—¥å¿—..."
          cp .config ${{ env.ARTIFACTS_DIR }}/configs/ 2>/dev/null || echo "âš ï¸ æ— æ³•å¤åˆ¶.config"
          cp feeds.conf ${{ env.ARTIFACTS_DIR }}/configs/ 2>/dev/null || echo "âš ï¸ æ— æ³•å¤åˆ¶feeds.conf"
          echo "FIRMWARE_COUNT=$TOTAL_FIRMWARE_COUNT" >> $GITHUB_ENV
          if [ $TOTAL_FIRMWARE_COUNT -eq 0 ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶"
            echo "å½“å‰ç›®å½•ç»“æž„:"
            find . -maxdepth 3 -type d | head -20
            echo ""
            echo "æ‰€æœ‰å¯èƒ½çš„å›ºä»¶æ–‡ä»¶:"
            find . -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" 2>/dev/null | head -30 || echo "æ— å›ºä»¶æ–‡ä»¶"
            exit 1
          else
            echo "âœ… å›ºä»¶éªŒè¯ä¸Žæ”¶é›†å®Œæˆ: æ€»å…± $TOTAL_FIRMWARE_COUNT ä¸ªæ–‡ä»¶"
          fi

      - name: ðŸ’¾ ä¼˜åŒ–æ—¥å¿—æ”¶é›†ä¸Žç»“æž„
        if: always()
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ä¼˜åŒ–æ—¥å¿—æ”¶é›†ä¸Žç»“æž„ ==="
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs/å®Œæ•´æ—¥å¿—-è‹±æ–‡
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs/é—®é¢˜æ‘˜è¦
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs/ç¼–è¯‘è¯¦ç»†æ—¥å¿—
          echo "ðŸ“ æ•´ç†åŽŸå§‹è‹±æ–‡æ—¥å¿—..."
          if [ -d "${{ env.BUILD_LOG_DIR }}" ]; then
            cp -r ${{ env.BUILD_LOG_DIR }}/* ${{ env.ARTIFACTS_DIR }}/logs/å®Œæ•´æ—¥å¿—-è‹±æ–‡/ 2>/dev/null || true
          fi
          if [ -d "${{ env.TOOLCHAIN_LOG_DIR }}" ]; then
            cp -r ${{ env.TOOLCHAIN_LOG_DIR }}/* ${{ env.ARTIFACTS_DIR }}/logs/å®Œæ•´æ—¥å¿—-è‹±æ–‡/ 2>/dev/null || true
          fi
          echo "ðŸ“ æ”¶é›†å¹¶é‡å‘½åGitHubè¿‡ç¨‹æ—¥å¿—..."
          LOG_MAPPING=("clone.log:æ£€å‡ºé…ç½®ä»“åº“.txt" "firmware-compile.log:æ™ºèƒ½ç¼–è¯‘å›ºä»¶.txt" "target-install.log:ç›®æ ‡å®‰è£…é˜¶æ®µ.txt" "image-generation.log:é•œåƒç”Ÿæˆè¿‡ç¨‹.txt" "host-tools.log:ä¸»æœºå·¥å…·ç¼–è¯‘.txt" "toolchain-compile.log:å·¥å…·é“¾ç¼–è¯‘.txt" "samba-talloc.log:Samba-tallocåº“ç¼–è¯‘.txt" "samba-tdb.log:Samba-tdbåº“ç¼–è¯‘.txt" "samba-tevent.log:Samba-teventåº“ç¼–è¯‘.txt" "samba-ldb.log:Samba-ldbåº“ç¼–è¯‘.txt" "samba4-libs-compile.log:Samba4åº“ç¼–è¯‘.txt" "samba4-server-compile.log:Samba4æœåŠ¡å™¨ç¼–è¯‘.txt" "pre-download.log:é¢„ä¸‹è½½è¿‡ç¨‹.txt")
          for mapping in "${LOG_MAPPING[@]}"; do
            orig_file=$(echo "$mapping" | cut -d: -f1)
            chinese_name=$(echo "$mapping" | cut -d: -f2)
            if [ -f "${{ env.BUILD_LOG_DIR }}/$orig_file" ]; then
              cp "${{ env.BUILD_LOG_DIR }}/$orig_file" "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/$chinese_name"
              echo "âœ… å·²å¤åˆ¶: $orig_file â†’ $chinese_name"
            fi
          done
          echo "åˆ›å»ºæ­¥éª¤æ—¥å¿—æ˜ å°„..."
          echo "# GitHub Actions æ­¥éª¤æ—¥å¿—ä¸­æ–‡æ˜ å°„" > "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "æ£€å‡ºé…ç½®ä»“åº“.txt - ðŸ“¥ æ£€å‡ºé…ç½®ä»“åº“" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "æ™ºèƒ½ç³»ç»Ÿèµ„æºåˆ†æž.txt - ðŸ’¾ æ™ºèƒ½ç³»ç»Ÿèµ„æºåˆ†æž" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "å…¨é¢å·¥ä½œçŽ¯å¢ƒè®¾ç½®.txt - ðŸ”§ å…¨é¢å·¥ä½œçŽ¯å¢ƒè®¾ç½®" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "æ™ºèƒ½æ–‡ä»¶å‘çŽ°ä¸Žé…ç½®åˆ†æž.txt - ðŸ” æ™ºèƒ½æ–‡ä»¶å‘çŽ°ä¸Žé…ç½®åˆ†æž" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "æ™ºèƒ½æºç é…ç½®è§£æž.txt - ðŸ”§ æ™ºèƒ½æºç é…ç½®è§£æž" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "å…¨é¢ç¼–è¯‘ä¾èµ–å®‰è£…ä¸ŽéªŒè¯.txt - ðŸ› ï¸ å…¨é¢ç¼–è¯‘ä¾èµ–å®‰è£…ä¸ŽéªŒè¯" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "é«˜çº§ç¼“å­˜ä¸Žæ€§èƒ½ä¼˜åŒ–.txt - âš¡ é«˜çº§ç¼“å­˜ä¸Žæ€§èƒ½ä¼˜åŒ–" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "æ™ºèƒ½æºç èŽ·å–ä¸Žåˆ†æ”¯å¤„ç†.txt - ðŸ“¥ æ™ºèƒ½æºç èŽ·å–ä¸Žåˆ†æ”¯å¤„ç†" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "æºç èŽ·å–åŽç©ºé—´ç›‘æµ‹.txt - ðŸ’¾ æºç èŽ·å–åŽç©ºé—´ç›‘æµ‹" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "æ™ºèƒ½æºç åˆå§‹åŒ–.txt - ðŸ”„ æ™ºèƒ½æºç åˆå§‹åŒ–" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "å¿«é€Ÿé…ç½®æ–‡ä»¶æŸ¥æ‰¾ä¸Žåº”ç”¨.txt - ðŸŽ¯ å¿«é€Ÿé…ç½®æ–‡ä»¶æŸ¥æ‰¾ä¸Žåº”ç”¨" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "è®¾å¤‡é•œåƒé…ç½®ä¿®å¤.txt - ðŸ”§ è®¾å¤‡é•œåƒé…ç½®ä¿®å¤" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "é«˜çº§æ€§èƒ½ä¼˜åŒ–é…ç½®.txt - ðŸ”§ é«˜çº§æ€§èƒ½ä¼˜åŒ–é…ç½®" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "é¢„ä¸‹è½½è¿‡ç¨‹.txt - ðŸ“¥ å…¨é¢é¢„ä¸‹è½½ä¸Žä¾èµ–éªŒè¯" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "é¢„ç¼–è¯‘çŽ¯å¢ƒéªŒè¯.txt - ðŸ” é¢„ç¼–è¯‘çŽ¯å¢ƒéªŒè¯" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "Sambaä¸“ç”¨ä¿®å¤ä¸Žç¼–è¯‘.txt - ðŸ› ï¸ Sambaä¸“ç”¨ä¿®å¤ä¸Žç¼–è¯‘" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "ç»¼åˆé—®é¢˜ä¿®å¤.txt - ðŸ”§ ç»¼åˆé—®é¢˜ä¿®å¤" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "å…¨é¢å·¥å…·é“¾ç¼–è¯‘ä¸ŽéªŒè¯.txt - ðŸ› ï¸ å…¨é¢å·¥å…·é“¾ç¼–è¯‘ä¸ŽéªŒè¯" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "æ·±åº¦å·¥å…·é“¾éªŒè¯.txt - ðŸ” æ·±åº¦å·¥å…·é“¾éªŒè¯" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "æ™ºèƒ½ç¼–è¯‘å›ºä»¶.txt - ðŸ—ï¸ æ™ºèƒ½ç¼–è¯‘å›ºä»¶" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "ç¼–è¯‘åŽå…¨é¢éªŒè¯.txt - ðŸ” ç¼–è¯‘åŽå…¨é¢éªŒè¯" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "è¯¦ç»†å›ºä»¶äº§ç‰©éªŒè¯ä¸Žæ”¶é›†.txt - ðŸ” è¯¦ç»†å›ºä»¶äº§ç‰©éªŒè¯ä¸Žæ”¶é›†" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "ä¼˜åŒ–æ—¥å¿—æ”¶é›†ä¸Žç»“æž„.txt - ðŸ’¾ ä¼˜åŒ–æ—¥å¿—æ”¶é›†ä¸Žç»“æž„" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "å®Œå–„æ·±åº¦é”™è¯¯åˆ†æžä¸Žè§£å†³æ–¹æ¡ˆ.txt - ðŸ” å®Œå–„æ·±åº¦é”™è¯¯åˆ†æžä¸Žè§£å†³æ–¹æ¡ˆ" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "ç”Ÿæˆè¯¦ç»†æž„å»ºæŠ¥å‘Š.txt - ðŸ“Š ç”Ÿæˆè¯¦ç»†æž„å»ºæŠ¥å‘Š" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "ä¸Šä¼ æž„å»ºäº§ç‰©.txt - ðŸ’¾ ä¸Šä¼ æž„å»ºäº§ç‰©" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "ç¼–è¯‘åŽæ™ºèƒ½æ¸…ç†.txt - ðŸ§¹ ç¼–è¯‘åŽæ™ºèƒ½æ¸…ç†" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "æœ€ç»ˆç»¼åˆæŠ¥å‘Š.txt - ðŸ“Š æœ€ç»ˆç»¼åˆæŠ¥å‘Š" >> "${{ env.ARTIFACTS_DIR }}/logs/GitHubè¿‡ç¨‹æ—¥å¿—/æ­¥éª¤æ—¥å¿—æ˜ å°„è¯´æ˜Ž.txt"
          echo "ðŸ“ æ”¶é›†é—®é¢˜æ‘˜è¦..."
          if [ -f "${{ env.BUILD_LOG_DIR }}/firmware-errors.log" ]; then
            cp "${{ env.BUILD_LOG_DIR }}/firmware-errors.log" "${{ env.ARTIFACTS_DIR }}/logs/é—®é¢˜æ‘˜è¦/ç¼–è¯‘é”™è¯¯æ‘˜è¦.txt"
          fi
          echo "âœ… æ—¥å¿—ç»“æž„ä¼˜åŒ–å®Œæˆ"

      - name: ðŸ” å®Œå–„æ·±åº¦é”™è¯¯åˆ†æžä¸Žè§£å†³æ–¹æ¡ˆ
        if: always()
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== å®Œå–„æ·±åº¦é”™è¯¯åˆ†æžä¸Žè§£å†³æ–¹æ¡ˆ ==="
          ANALYSIS_FILE="${{ env.ARTIFACTS_DIR }}/æ·±åº¦é”™è¯¯åˆ†æžä¸Žè§£å†³æ–¹æ¡ˆæŠ¥å‘Š.txt"
          echo "=== æ·±åº¦é”™è¯¯åˆ†æžä¸Žè§£å†³æ–¹æ¡ˆæŠ¥å‘Š ===" > "$ANALYSIS_FILE"
          echo "åˆ†æžæ—¶é—´: $(date)" >> "$ANALYSIS_FILE"
          echo "æž„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}" >> "$ANALYSIS_FILE"
          echo "å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}" >> "$ANALYSIS_FILE"
          echo "å·¥åŽ‚é•œåƒçŠ¶æ€: ${{ env.FACTORY_MISSING == 'true' && 'ç¼ºå¤±' || 'å·²ç”Ÿæˆ' }}" >> "$ANALYSIS_FILE"
          echo "é¢„ä¸‹è½½çŠ¶æ€: ${{ env.DOWNLOAD_STATUS || 'æœªæ‰§è¡Œ' }}" >> "$ANALYSIS_FILE"
          echo "" >> "$ANALYSIS_FILE"
          echo "ðŸŽ¯ æ ¸å¿ƒé—®é¢˜æ€»ç»“" >> "$ANALYSIS_FILE"
          echo "==================" >> "$ANALYSIS_FILE"
          echo "âœ… å·²ä¿®å¤é—®é¢˜: æºç èŽ·å–å®Œæ•´æ€§éªŒè¯" >> "$ANALYSIS_FILE"
          echo "âœ… å·²ä¿®å¤é—®é¢˜: é¢„ä¸‹è½½ä¸Žä¾èµ–éªŒè¯" >> "$ANALYSIS_FILE"
          echo "âœ… å·²ä¿®å¤é—®é¢˜: Sambaä¾èµ–åº“è·¯å¾„æ£€æµ‹" >> "$ANALYSIS_FILE"
          echo "âš ï¸ éœ€è¦æ³¨æ„: ç¼–è¯‘è¿‡ç¨‹ä¸­ç©ºé—´ç®¡ç†" >> "$ANALYSIS_FILE"
          echo "âš ï¸ éœ€è¦æ³¨æ„: åŒ…ä¾èµ–å…³ç³»å†²çª" >> "$ANALYSIS_FILE"
          echo "" >> "$ANALYSIS_FILE"
          echo "ðŸ” è¯¦ç»†é—®é¢˜åˆ†æžä¸Žè§£å†³æ–¹æ¡ˆ" >> "$ANALYSIS_FILE"
          echo "==========================" >> "$ANALYSIS_FILE"
          echo "" >> "$ANALYSIS_FILE"
          echo "1. æºç èŽ·å–å®Œæ•´æ€§éªŒè¯" >> "$ANALYSIS_FILE"
          echo "---------------------" >> "$ANALYSIS_FILE"
          echo "âœ… å·²ä¿®å¤: å¢žåŠ å…³é”®æ–‡ä»¶éªŒè¯ (scripts/feeds)" >> "$ANALYSIS_FILE"
          echo "âœ… å·²ä¿®å¤: å¤šé‡å…‹éš†ç­–ç•¥ç¡®ä¿æºç å®Œæ•´" >> "$ANALYSIS_FILE"
          echo "âœ… å·²ä¿®å¤: è¯¦ç»†çš„ç›®å½•ç»“æž„éªŒè¯" >> "$ANALYSIS_FILE"
          echo "" >> "$ANALYSIS_FILE"
          echo "2. é¢„ä¸‹è½½ä¸Žä¾èµ–éªŒè¯" >> "$ANALYSIS_FILE"
          echo "------------------" >> "$ANALYSIS_FILE"
          echo "âœ… å·²å®žçŽ°: å…¨é¢é¢„ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…" >> "$ANALYSIS_FILE"
          echo "âœ… å·²å®žçŽ°: ä¸‹è½½å®Œæ•´æ€§æ£€æŸ¥" >> "$ANALYSIS_FILE"
          echo "âœ… å·²å®žçŽ°: ç©ºé—´ä½¿ç”¨ç›‘æŽ§" >> "$ANALYSIS_FILE"
          echo "" >> "$ANALYSIS_FILE"
          echo "3. Sambaä¾èµ–åº“è·¯å¾„æ£€æµ‹" >> "$ANALYSIS_FILE"
          echo "----------------------" >> "$ANALYSIS_FILE"
          echo "âœ… å·²ä¿®å¤: æ™ºèƒ½è·¯å¾„æ£€æµ‹æœºåˆ¶" >> "$ANALYSIS_FILE"
          echo "âœ… å·²ä¿®å¤: å¤šé‡ç¼–è¯‘å°è¯•ç­–ç•¥" >> "$ANALYSIS_FILE"
          echo "âœ… å·²ä¿®å¤: éžä¸­æ–­å¼é”™è¯¯å¤„ç†" >> "$ANALYSIS_FILE"
          echo "" >> "$ANALYSIS_FILE"
          echo "ðŸ“Š ç¼–è¯‘è´¨é‡è¯„ä¼°" >> "$ANALYSIS_FILE"
          echo "==============" >> "$ANALYSIS_FILE"
          echo "âœ… æˆåŠŸæ–¹é¢:" >> "$ANALYSIS_FILE"
          echo "   - æºç èŽ·å–å®Œæ•´æ€§éªŒè¯" >> "$ANALYSIS_FILE"
          echo "   - é¢„ä¸‹è½½ä¾èµ–ç®¡ç†" >> "$ANALYSIS_FILE"
          echo "   - å¤šé‡é”™è¯¯æ¢å¤æœºåˆ¶" >> "$ANALYSIS_FILE"
          echo "" >> "$ANALYSIS_FILE"
          echo "âš ï¸ éœ€è¦æ³¨æ„:" >> "$ANALYSIS_FILE"
          echo "   - ç¼–è¯‘è¿‡ç¨‹ä¸­å†…å­˜ä½¿ç”¨" >> "$ANALYSIS_FILE"
          echo "   - ç£ç›˜ç©ºé—´ç®¡ç†" >> "$ANALYSIS_FILE"
          echo "   - ç½‘ç»œç¨³å®šæ€§" >> "$ANALYSIS_FILE"
          echo "" >> "$ANALYSIS_FILE"
          echo "ðŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®" >> "$ANALYSIS_FILE"
          echo "================" >> "$ANALYSIS_FILE"
          echo "1. ðŸ“Š ç›‘æŽ§ç¼–è¯‘è¿‡ç¨‹èµ„æºä½¿ç”¨" >> "$ANALYSIS_FILE"
          echo "2. ðŸ”§ æŒç»­ä¼˜åŒ–é”™è¯¯æ¢å¤æœºåˆ¶" >> "$ANALYSIS_FILE"
          echo "3. ðŸ“ˆ æ”¶é›†æ›´å¤šç¼–è¯‘ç»Ÿè®¡ä¿¡æ¯" >> "$ANALYSIS_FILE"
          echo "4. ðŸ§ª æµ‹è¯•ä¸åŒæºç åˆ†æ”¯çš„å…¼å®¹æ€§" >> "$ANALYSIS_FILE"
          echo "âœ… å®Œå–„æ·±åº¦é”™è¯¯åˆ†æžå®Œæˆ"

      - name: ðŸ“Š ç”Ÿæˆè¯¦ç»†æž„å»ºæŠ¥å‘Š
        if: always()
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "ç”Ÿæˆè¯¦ç»†æž„å»ºæŠ¥å‘Š..."
          REPORT_FILE="${{ env.ARTIFACTS_DIR }}/è¯¦ç»†æž„å»ºæŠ¥å‘Š.txt"
          echo "=== è¯¦ç»†å›ºä»¶æž„å»ºæŠ¥å‘Š ===" > "$REPORT_FILE"
          echo "æž„å»ºæ—¶é—´: $(date)" >> "$REPORT_FILE"
          echo "æž„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}" >> "$REPORT_FILE"
          echo "ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION || 'N/A' }}ç§’" >> "$REPORT_FILE"
          echo "å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}" >> "$REPORT_FILE"
          echo "é¢„ä¸‹è½½çŠ¶æ€: ${{ env.DOWNLOAD_STATUS || 'æœªæ‰§è¡Œ' }}" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "=== å·¥åŽ‚é•œåƒçŠ¶æ€ ===" >> "$REPORT_FILE"
          if [ "${{ env.FACTORY_MISSING }}" = "true" ]; then
            echo "âŒ å·¥åŽ‚åˆ·æœºé•œåƒ: ç¼ºå¤±" >> "$REPORT_FILE"
          else
            echo "âœ… å·¥åŽ‚åˆ·æœºé•œåƒ: å·²ç”Ÿæˆ" >> "$REPORT_FILE"
          fi
          echo "" >> "$REPORT_FILE"
          echo "=== æºç ä¿¡æ¯ ===" >> "$REPORT_FILE"
          echo "æºç åº“: ${{ env.SOURCE_PRESET }}" >> "$REPORT_FILE"
          echo "è¯·æ±‚åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}" >> "$REPORT_FILE"
          echo "å®žé™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}" >> "$REPORT_FILE"
          echo "æŽ¨èåˆ†æ”¯: ${{ env.RECOMMENDED_BRANCH }}" >> "$REPORT_FILE"
          echo "æäº¤å“ˆå¸Œ: ${{ env.COMMIT_HASH || 'unknown' }}" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "=== ç¼–è¯‘é…ç½® ===" >> "$REPORT_FILE"
          echo "é…ç½®æ–‡ä»¶: ${{ github.event.inputs.config_profile }}" >> "$REPORT_FILE"
          echo "ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}" >> "$REPORT_FILE"
          echo "å·¥å…·é“¾ç­–ç•¥: ${{ github.event.inputs.toolchain_strategy }}" >> "$REPORT_FILE"
          echo "è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}" >> "$REPORT_FILE"
          echo "é—®é¢˜ä¿®å¤: ${{ github.event.inputs.fix_common_issues }}" >> "$REPORT_FILE"
          echo "é¢„ä¸‹è½½: ${{ github.event.inputs.enable_pre_download }}" >> "$REPORT_FILE"
          echo "åŽéªŒè¯: ${{ github.event.inputs.enable_post_verify }}" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "=== ç³»ç»Ÿä¿¡æ¯ ===" >> "$REPORT_FILE"
          echo "Runner: ${{ runner.os }}" >> "$REPORT_FILE"
          echo "CPUæ ¸å¿ƒ: $(nproc)" >> "$REPORT_FILE"
          echo "å†…å­˜: $(free -h | awk '/^Mem:/{print $2}')" >> "$REPORT_FILE"
          echo "ç£ç›˜ç©ºé—´: $(df -h /mnt | awk 'NR==2{print $4}') å¯ç”¨" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            echo "=== äº§ç‰©ä¿¡æ¯ ===" >> "$REPORT_FILE"
            echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨:" >> "$REPORT_FILE"
            find ${{ env.ARTIFACTS_DIR }}/firmware -type f 2>/dev/null | xargs -I {} basename {} 2>/dev/null | sort | head -20 >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "æ—¥å¿—æ–‡ä»¶åˆ—è¡¨:" >> "$REPORT_FILE"
            find ${{ env.ARTIFACTS_DIR }}/logs -type f 2>/dev/null | xargs -I {} basename {} 2>/dev/null | sort | head -10 >> "$REPORT_FILE"
          else
            echo "æž„å»ºå¤±è´¥ï¼Œæ— å›ºä»¶äº§ç‰©" >> "$REPORT_FILE"
          fi
          echo "âœ… è¯¦ç»†æž„å»ºæŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ðŸ’¾ ä¸Šä¼ æž„å»ºäº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Firmware-${{ github.run_number }}-${{ env.SOURCE_PRESET }}-${{ env.ACTUAL_BRANCH }}-${{ env.BUILD_STATUS || 'unknown' }}
          path: ${{ env.ARTIFACTS_DIR }}
          retention-days: 30

      - name: ðŸ§¹ ç¼–è¯‘åŽæ™ºèƒ½æ¸…ç†
        if: always()
        run: |
          echo "å¼€å§‹ç¼–è¯‘åŽæ™ºèƒ½æ¸…ç†..."
          echo "=== æ¸…ç†å‰çŠ¶æ€ ==="
          df -h
          free -h
          if [ -d "${{ env.SOURCE_DIR }}" ]; then
            cd ${{ env.SOURCE_DIR }}
            echo "ðŸ§¹ æ¸…ç†ç¼–è¯‘ä¸´æ—¶æ–‡ä»¶..."
            rm -rf build_dir/* staging_dir/* tmp/* 2>/dev/null || true
          fi
          echo "ðŸ§¹ æ¸…ç†äº¤æ¢æ–‡ä»¶..."
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          echo ""
          echo "=== æ¸…ç†åŽçŠ¶æ€ ==="
          df -h
          free -h
          echo "âœ… æ™ºèƒ½æ¸…ç†å®Œæˆ"

      - name: ðŸ“Š æœ€ç»ˆç»¼åˆæŠ¥å‘Š
        if: always()
        run: |
          echo "=== æœ€ç»ˆç»¼åˆæŠ¥å‘Š ==="
          echo "ðŸŽ¯ å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ðŸ†” è¿è¡ŒID: ${{ github.run_id }}"
          echo "ðŸ†” è¿è¡Œå·: ${{ github.run_number }}"
          echo ""
          echo "ðŸ“¦ æºç ä¿¡æ¯:"
          echo "  - é¢„è®¾: ${{ env.SOURCE_PRESET }}"
          echo "  - åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "  - æŽ¨è: ${{ env.RECOMMENDED_BRANCH }}"
          echo "  - æäº¤: ${{ env.COMMIT_HASH || 'unknown' }}"
          echo ""
          echo "âš™ï¸ ç¼–è¯‘é…ç½®:"
          echo "  - é…ç½®æ–‡ä»¶: ${{ github.event.inputs.config_profile }}"
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
          echo "  - å·¥å…·é“¾: ${{ github.event.inputs.toolchain_strategy }}"
          echo "  - è‡ªå®šä¹‰: ${{ github.event.inputs.enable_custom_features }}"
          echo "  - é—®é¢˜ä¿®å¤: ${{ github.event.inputs.fix_common_issues }}"
          echo "  - é¢„ä¸‹è½½: ${{ github.event.inputs.enable_pre_download }}"
          echo "  - åŽéªŒè¯: ${{ github.event.inputs.enable_post_verify }}"
          echo ""
          echo "ðŸ“ˆ æž„å»ºç»“æžœ:"
          echo "  - çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - æ—¶é•¿: ${{ env.BUILD_DURATION || 'N/A' }}ç§’"
          echo "  - å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - å·¥åŽ‚é•œåƒçŠ¶æ€: ${{ env.FACTORY_MISSING == 'true' && 'ç¼ºå¤±' || 'å·²ç”Ÿæˆ' }}"
          echo "  - é¢„ä¸‹è½½çŠ¶æ€: ${{ env.DOWNLOAD_STATUS || 'æœªæ‰§è¡Œ' }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            echo "ðŸŽ‰ æž„å»ºæˆåŠŸï¼å›ºä»¶å·²ä¸Šä¼ åˆ° Artifacts"
            echo "ðŸ“¦ ä¸‹è½½ Artifacts èŽ·å–ç¼–è¯‘äº§ç‰©"
            echo "ðŸ”§ å›ºä»¶æ–‡ä»¶åœ¨ firmware/ ç›®å½•ä¸­"
            echo "ðŸ“‹ è¯¦ç»†æŠ¥å‘Šåœ¨ è¯¦ç»†æž„å»ºæŠ¥å‘Š.txt"
            echo "ðŸ” æ·±åº¦åˆ†æžåœ¨ æ·±åº¦é”™è¯¯åˆ†æžä¸Žè§£å†³æ–¹æ¡ˆæŠ¥å‘Š.txt"
            echo "ðŸ“ æ—¥å¿—æ–‡ä»¶åœ¨ logs/ ç›®å½•ä¸­ï¼ˆåˆ†ç±»æ¸…æ™°ï¼‰"
            if [ "${{ env.FACTORY_MISSING }}" = "true" ]; then
              echo "âš ï¸ æ³¨æ„: å·¥åŽ‚åˆ·æœºé•œåƒç¼ºå¤±ï¼Œåªæœ‰ç³»ç»Ÿå‡çº§é•œåƒ"
            else
              echo "âœ… æ‰€æœ‰é•œåƒç±»åž‹å‡å·²ç”Ÿæˆ"
            fi
          else
            echo "âŒ æž„å»ºå¤±è´¥"
            echo "ðŸ” è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—åˆ†æžé”™è¯¯åŽŸå› "
            echo "ðŸ“‹ æ£€æŸ¥ Artifacts ä¸­çš„ç¼–è¯‘æ—¥å¿—"
            echo "ðŸ” æŸ¥çœ‹ logs/é—®é¢˜æ‘˜è¦/ å¿«é€Ÿäº†è§£é—®é¢˜"
            echo "ðŸ’¡ ä¸»è¦æ”¹è¿›:"
            echo "  - æºç èŽ·å–å®Œæ•´æ€§éªŒè¯"
            echo "  - é¢„ä¸‹è½½ä¾èµ–ç®¡ç†"
            echo "  - å¤šé‡é”™è¯¯æ¢å¤æœºåˆ¶"
            echo "  - è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯"
          fi
