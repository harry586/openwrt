name: "Universal Firmware Builder - Enhanced Disk Monitoring Version"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "auto"
        type: string
      config_profile:
        description: "è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„"
        required: true
        type: string
        default: ".config_rt-ac42u_immortalwrt"
      build_optimization:
        description: "ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥"
        required: true
        type: choice
        options: ["balanced", "speed", "stability", "minimal"]
        default: "minimal"

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"
  SPACE_THRESHOLD: "2"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 240
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"

      - name: "ğŸ” æ™ºèƒ½æ–‡ä»¶å‘ç°ä¸é…ç½®è§£æ"
        id: "config-parser"
        run: |
          echo "=== ğŸ” æ™ºèƒ½æ–‡ä»¶å‘ç°ä¸é…ç½®è§£æ ==="
          echo "ğŸ“‹ æŸ¥æ‰¾ repositories.json æ–‡ä»¶..."
          
          REPO_JSON_FOUND=""
          SEARCH_PATHS=(".", "..", "$GITHUB_WORKSPACE", "configs", "../configs", "./firmware-config")
          
          for path in "${SEARCH_PATHS[@]}"; do
            if [ -f "$path/repositories.json" ]; then
              REPO_JSON_FOUND="$path/repositories.json"
              FILE_SIZE=$(du -h "$REPO_JSON_FOUND" | cut -f1)
              echo "âœ… åœ¨è·¯å¾„ '$path' æ‰¾åˆ° repositories.json ($FILE_SIZE)"
              break
            fi
          done
          
          if [ -z "$REPO_JSON_FOUND" ]; then
            echo "ğŸ” ç²¾ç¡®æŸ¥æ‰¾å¤±è´¥ï¼Œå°è¯•æ¨¡ç³Šæœç´¢..."
            REPO_JSON_FOUND=$(find . -maxdepth 3 -name "*repositories*.json" -type f 2>/dev/null | head -1)
            if [ -n "$REPO_JSON_FOUND" ]; then
              FILE_SIZE=$(du -h "$REPO_JSON_FOUND" | cut -f1)
              echo "âœ… æ¨¡ç³Šæœç´¢æ‰¾åˆ°: $REPO_JSON_FOUND ($FILE_SIZE)"
            fi
          fi
          
          if [ -z "$REPO_JSON_FOUND" ]; then
            echo "âŒ é”™è¯¯: æ— æ³•æ‰¾åˆ° repositories.json æ–‡ä»¶"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          echo "REPO_JSON_PATH=$REPO_JSON_FOUND" >> $GITHUB_ENV
          echo "âœ… é…ç½®æ–‡ä»¶è§£æå®Œæˆ"

      - name: "ğŸ’¾ åˆå§‹ç£ç›˜ç©ºé—´åˆ†æ"
        timeout-minutes: 3
        run: |
          echo "=== ğŸ’¾ åˆå§‹ç£ç›˜ç©ºé—´åˆ†æ ==="
          echo "ğŸ“Š ç³»ç»Ÿç£ç›˜ç©ºé—´çŠ¶æ€:"
          df -h
          
          echo ""
          echo "ğŸ” é‡ç‚¹ç›‘æ§åˆ†åŒº:"
          df -h | grep -E '(/|/mnt|/dev/root)' | while read line; do
            echo "  $line"
          done
          
          ROOT_AVAILABLE=$(df / | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}' 2>/dev/null || echo "0")
          
          echo ""
          echo "ğŸ“ˆ å…³é”®åˆ†åŒºå¯ç”¨ç©ºé—´:"
          echo "  - æ ¹åˆ†åŒº(/): ${ROOT_AVAILABLE}GB"
          echo "  - æ•°æ®åˆ†åŒº(/mnt): ${MNT_AVAILABLE}GB"
          echo "  - ç©ºé—´é˜ˆå€¼: ${{ env.SPACE_THRESHOLD }}GB"
          
          if [ "$MNT_AVAILABLE" -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: /mnt åˆ†åŒºç©ºé—´ä¸è¶³20GBï¼Œå¯ç”¨æé™ä¼˜åŒ–æ¨¡å¼"
            echo "EXTREME_OPTIMIZATION=true" >> $GITHUB_ENV
          else
            echo "EXTREME_OPTIMIZATION=false" >> $GITHUB_ENV
          fi
          
          if [ "$MNT_AVAILABLE" -lt 5 ]; then
            echo "âŒ é”™è¯¯: /mnt åˆ†åŒºç©ºé—´ä¸è¶³5GBï¼Œæ— æ³•ç»§ç»­"
            exit 1
          fi
          
          echo "INITIAL_MNT_SPACE=$MNT_AVAILABLE" >> $GITHUB_ENV
          echo "INITIAL_ROOT_SPACE=$ROOT_AVAILABLE" >> $GITHUB_ENV

      - name: "ğŸ’¾ å¢å¼ºå†…å­˜ä¸äº¤æ¢ç®¡ç†"
        timeout-minutes: 5
        run: |
          echo "=== ğŸ’¾ å¢å¼ºå†…å­˜ä¸äº¤æ¢ç®¡ç† ==="
          echo "ğŸ“Š åˆå§‹å†…å­˜çŠ¶æ€:"
          free -h
          echo "ğŸ”„ åˆ›å»ºæ™ºèƒ½äº¤æ¢æ–‡ä»¶..."
          if [ -f /mnt/swapfile ]; then
            sudo swapoff /mnt/swapfile 2>/dev/null || true
            sudo rm -f /mnt/swapfile 2>/dev/null || true
          fi
          MNT_AVAILABLE=${{ env.INITIAL_MNT_SPACE }}
          if [ "$MNT_AVAILABLE" -gt 30 ]; then
            SWAP_SIZE="24G"
            echo "ğŸ’¡ ç©ºé—´å……è¶³ï¼Œä½¿ç”¨ ${SWAP_SIZE} äº¤æ¢æ–‡ä»¶"
          elif [ "$MNT_AVAILABLE" -gt 20 ]; then
            SWAP_SIZE="16G"
            echo "ğŸ’¡ ç©ºé—´é€‚ä¸­ï¼Œä½¿ç”¨ ${SWAP_SIZE} äº¤æ¢æ–‡ä»¶"
          else
            SWAP_SIZE="8G"
            echo "ğŸ’¡ ç©ºé—´ç´§å¼ ï¼Œä½¿ç”¨ ${SWAP_SIZE} äº¤æ¢æ–‡ä»¶"
          fi
          sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=$(( ${SWAP_SIZE%G} * 1024 )) status=progress
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          echo "ğŸ“Š äº¤æ¢æ–‡ä»¶æ¿€æ´»åå†…å­˜çŠ¶æ€:"
          free -h
          sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }}
          sudo chown -R $USER:$USER /mnt/*
          echo "âœ… å†…å­˜ç®¡ç†å®Œæˆ"

      - name: "ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–"
        timeout-minutes: 10
        run: |
          echo "=== ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ– ==="
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build libelf-dev libssl-dev zlib1g-dev libxml2-dev liblzma-dev liblzo2-dev
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: "âš¡ æ™ºèƒ½ç¼“å­˜ä¸ç©ºé—´ä¼˜åŒ–"
        timeout-minutes: 3
        run: |
          echo "=== âš¡ æ™ºèƒ½ç¼“å­˜ä¸ç©ºé—´ä¼˜åŒ– ==="
          echo "ğŸ“Š ç¼“å­˜è®¾ç½®å‰ç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          AVAILABLE_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "å½“å‰å¯ç”¨ç©ºé—´: ${AVAILABLE_SPACE}GB"
          mkdir -p ${{ env.CCACHE_DIR }}
          if [ "$AVAILABLE_SPACE" -lt 10 ]; then
            CCACHE_SIZE="1G"
            echo "âš ï¸ ç©ºé—´æåº¦ç´§å¼ ï¼Œä½¿ç”¨æœ€å°ç¼“å­˜: $CCACHE_SIZE"
          elif [ "$AVAILABLE_SPACE" -lt 15 ]; then
            CCACHE_SIZE="2G"
            echo "âš ï¸ ç©ºé—´ç´§å¼ ï¼Œä½¿ç”¨å°ç¼“å­˜: $CCACHE_SIZE"
          else
            CCACHE_SIZE="4G"
            echo "âœ… ç©ºé—´å……è¶³ï¼Œä½¿ç”¨æ ‡å‡†ç¼“å­˜: $CCACHE_SIZE"
          fi
          ccache -M $CCACHE_SIZE
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=50000
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "CCACHE_SIZE=$CCACHE_SIZE" >> $GITHUB_ENV
          echo "ğŸ“Š CCacheé…ç½®å®Œæˆ:"
          ccache -s

      - name: "ğŸ“¥ è·å–æºç "
        timeout-minutes: 15
        run: |
          echo "=== ğŸ“¥ è·å–æºç  ==="
          cd ${{ env.SOURCE_DIR }}
          rm -rf ./* 2>/dev/null || true
          echo "ğŸ“Š å…‹éš†å‰ç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          case "${{ github.event.inputs.source_preset }}" in
            "immortalwrt")
              echo "ğŸ”§ å…‹éš† ImmortalWrt æºç ..."
              git clone --depth=1 --branch "${{ github.event.inputs.source_branch }}" https://github.com/immortalwrt/immortalwrt.git .
              ;;
            "openwrt")
              echo "ğŸ”§ å…‹éš† OpenWrt æºç ..."
              git clone --depth=1 --branch "${{ github.event.inputs.source_branch }}" https://git.openwrt.org/openwrt/openwrt.git .
              ;;
            "lede")
              echo "ğŸ”§ å…‹éš† LEDE æºç ..."
              git clone --depth=1 --branch "${{ github.event.inputs.source_branch }}" https://github.com/coolsnowwolf/lede.git .
              ;;
          esac
          echo "ğŸ“Š å…‹éš†åç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          echo "âœ… æºç è·å–å®Œæˆ"

      - name: "ğŸ”§ åº”ç”¨ç©ºé—´ä¼˜åŒ–é…ç½®"
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ”§ åº”ç”¨ç©ºé—´ä¼˜åŒ–é…ç½® ==="
          echo "ğŸ“Š é…ç½®å‰ç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          CONFIG_FILE="$GITHUB_WORKSPACE/${{ github.event.inputs.config_profile }}"
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" .config
            echo "âœ… é…ç½®æ–‡ä»¶åº”ç”¨: $CONFIG_FILE"
          else
            echo "âŒ é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°: $CONFIG_FILE"
            echo "ğŸ” åœ¨å½“å‰ç›®å½•æœç´¢é…ç½®æ–‡ä»¶..."
            find . -name "*${{ github.event.inputs.config_profile }}*" -type f | head -5
            exit 1
          fi
          echo "ğŸ”§ åº”ç”¨ç©ºé—´ä¼˜åŒ–é…ç½®..."
          sed -i 's/CONFIG_TARGET_KERNEL_PARTSIZE=.*/CONFIG_TARGET_KERNEL_PARTSIZE=8/' .config 2>/dev/null || echo "CONFIG_TARGET_KERNEL_PARTSIZE=8" >> .config
          sed -i 's/CONFIG_TARGET_ROOTFS_PARTSIZE=.*/CONFIG_TARGET_ROOTFS_PARTSIZE=32/' .config 2>/dev/null || echo "CONFIG_TARGET_ROOTFS_PARTSIZE=32" >> .config
          echo "# CONFIG_DEBUG_INFO is not set" >> .config
          echo "# CONFIG_KERNEL_DEBUG_INFO is not set" >> .config
          echo "# CONFIG_DEBUG_KERNEL is not set" >> .config
          echo "# CONFIG_KERNEL_DEBUG_KERNEL is not set" >> .config
          echo "# CONFIG_KERNEL_DEBUG_DEVMEM is not set" >> .config
          echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> .config
          echo "CONFIG_SMALL_FLASH=y" >> .config
          echo "CONFIG_KERNEL_KALLSYMS=n" >> .config
          echo "CONFIG_KERNEL_DEBUG_FS=n" >> .config
          echo "CONFIG_SYMBOLIC_ERRNAME=n" >> .config
          echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> .config
          echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> .config
          echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
          make defconfig
          echo "ğŸ“Š é…ç½®åç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          echo "âœ… ç©ºé—´ä¼˜åŒ–é…ç½®å®Œæˆ"

      - name: "ğŸ”„ åˆå§‹åŒ–æœ€å°åŒ–Feeds"
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ”„ åˆå§‹åŒ–æœ€å°åŒ–Feeds ==="
          echo "ğŸ“Š Feedsåˆå§‹åŒ–å‰ç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          echo "src-git packages https://github.com/immortalwrt/packages.git;openwrt-21.02" > feeds.conf
          echo "src-git luci https://github.com/immortalwrt/luci.git;openwrt-21.02" >> feeds.conf
          echo "ğŸ“‹ Feedsé…ç½®å†…å®¹:"
          cat feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "ğŸ“Š Feedsåˆå§‹åŒ–åç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          echo "âœ… Feedsåˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸ“¥ æ™ºèƒ½ä¸‹è½½ä¸ç©ºé—´ç›‘æ§"
        timeout-minutes: 30
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ“¥ æ™ºèƒ½ä¸‹è½½ä¸ç©ºé—´ç›‘æ§ ==="
          mkdir -p ${{ env.DOWNLOAD_DIR }}
          [ -d "dl" ] && rm -rf dl
          ln -sf ${{ env.DOWNLOAD_DIR }} dl
          echo "ğŸ“Š ä¸‹è½½å‰ç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          INITIAL_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "åˆå§‹å¯ç”¨ç©ºé—´: ${INITIAL_SPACE}GB"
          echo "ğŸ”§ ä½¿ç”¨å•çº¿ç¨‹ä¸‹è½½é¿å…å†…å­˜å‹åŠ›..."
          if ! make download -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/download.log; then
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œæ£€æŸ¥ç©ºé—´çŠ¶æ€..."
            CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
            echo "å½“å‰å¯ç”¨ç©ºé—´: ${CURRENT_SPACE}GB"
            echo "ç©ºé—´æ¶ˆè€—: $((INITIAL_SPACE - CURRENT_SPACE))GB"
            exit 1
          fi
          echo "ğŸ“Š ä¸‹è½½åç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ä¸‹è½½åå¯ç”¨ç©ºé—´: ${CURRENT_SPACE}GB"
          echo "ä¸‹è½½æ¶ˆè€—ç©ºé—´: $((INITIAL_SPACE - CURRENT_SPACE))GB"
          echo "âœ… ä¸‹è½½å®Œæˆ"

      - name: "ğŸ› ï¸ åˆ†é˜¶æ®µå·¥å…·é“¾ç¼–è¯‘ä¸ç©ºé—´æ£€æŸ¥"
        timeout-minutes: 90
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ› ï¸ åˆ†é˜¶æ®µå·¥å…·é“¾ç¼–è¯‘ä¸ç©ºé—´æ£€æŸ¥ ==="
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          ulimit -S -n 8192
          echo "ğŸ”§ é˜¶æ®µ1: ç¼–è¯‘åŸºç¡€å·¥å…·..."
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ğŸ“Š [åŸºç¡€å·¥å…·ç¼–è¯‘å‰] å½“å‰å¯ç”¨ç©ºé—´: ${CURRENT_SPACE}GB (é˜ˆå€¼: ${{ env.SPACE_THRESHOLD }}GB)"
          if [ "$CURRENT_SPACE" -lt "${{ env.SPACE_THRESHOLD }}" ]; then
            echo "âŒ [åŸºç¡€å·¥å…·ç¼–è¯‘å‰] é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ ${{ env.SPACE_THRESHOLD }}GBï¼Œå½“å‰ä»…å‰© ${CURRENT_SPACE}GB"
            echo "ğŸ’¾ è¯¦ç»†ç©ºé—´ä½¿ç”¨:"
            df -h | grep -E '(/|/mnt)'
            echo "ğŸ§¹ å°è¯•æ¸…ç†..."
            make dirclean 2>/dev/null || true
            ccache -c 2>/dev/null || true
            exit 1
          elif [ "$CURRENT_SPACE" -lt 5 ]; then
            echo "âš ï¸ [åŸºç¡€å·¥å…·ç¼–è¯‘å‰] è­¦å‘Š: ç£ç›˜ç©ºé—´ä»…å‰© ${CURRENT_SPACE}GBï¼Œæ¥è¿‘å±é™©é˜ˆå€¼"
          fi
          if ! make tools/install -j2 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/tools-compile.log; then
            echo "âš ï¸ åŸºç¡€å·¥å…·ç¼–è¯‘æœ‰è­¦å‘Šï¼Œæ£€æŸ¥ç©ºé—´çŠ¶æ€..."
            CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
            echo "ğŸ“Š [åŸºç¡€å·¥å…·ç¼–è¯‘å] å½“å‰å¯ç”¨ç©ºé—´: ${CURRENT_SPACE}GB"
          fi
          echo "ğŸ”§ é˜¶æ®µ2: ç¼–è¯‘å·¥å…·é“¾..."
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ğŸ“Š [å·¥å…·é“¾ç¼–è¯‘å‰] å½“å‰å¯ç”¨ç©ºé—´: ${CURRENT_SPACE}GB (é˜ˆå€¼: ${{ env.SPACE_THRESHOLD }}GB)"
          if [ "$CURRENT_SPACE" -lt "${{ env.SPACE_THRESHOLD }}" ]; then
            echo "âŒ [å·¥å…·é“¾ç¼–è¯‘å‰] é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ ${{ env.SPACE_THRESHOLD }}GBï¼Œå½“å‰ä»…å‰© ${CURRENT_SPACE}GB"
            exit 1
          fi
          if ! make toolchain/compile -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/toolchain-compile.log; then
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œæ£€æŸ¥ç©ºé—´çŠ¶æ€..."
            CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
            echo "ğŸ“Š [å·¥å…·é“¾ç¼–è¯‘å¤±è´¥å] å½“å‰å¯ç”¨ç©ºé—´: ${CURRENT_SPACE}GB"
            exit 1
          fi
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ğŸ“Š [å·¥å…·é“¾ç¼–è¯‘å®Œæˆå] å½“å‰å¯ç”¨ç©ºé—´: ${CURRENT_SPACE}GB"
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"

      - name: "ğŸ” ç¼–è¯‘å‰æ·±åº¦ç©ºé—´æ£€æŸ¥"
        timeout-minutes: 3
        run: |
          echo "=== ğŸ” ç¼–è¯‘å‰æ·±åº¦ç©ºé—´æ£€æŸ¥ ==="
          cd ${{ env.SOURCE_DIR }}
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          THRESHOLD=${{ env.SPACE_THRESHOLD }}
          echo "ğŸ“Š ç¼–è¯‘å‰è¯¦ç»†ç©ºé—´åˆ†æ:"
          echo "  - å½“å‰å¯ç”¨ç©ºé—´: ${CURRENT_SPACE}GB"
          echo "  - ç©ºé—´é˜ˆå€¼: ${THRESHOLD}GB"
          echo "  - åˆå§‹ç©ºé—´: ${{ env.INITIAL_MNT_SPACE }}GB"
          echo "  - å·²æ¶ˆè€—ç©ºé—´: $((${{ env.INITIAL_MNT_SPACE }} - CURRENT_SPACE))GB"
          df -h | grep -E '(/|/mnt)' | while read line; do
            echo "  $line"
          done
          if [ "$CURRENT_SPACE" -lt "$THRESHOLD" ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ä¸è¶³ ${THRESHOLD}GB"
            echo "ğŸ’¾ ç©ºé—´ä½¿ç”¨è¯¦æƒ…:"
            echo "ğŸ§¹ æ‰§è¡Œç´§æ€¥æ¸…ç†..."
            make dirclean 2>/dev/null || true
            rm -rf build_dir/target-*/linux-*/linux-* 2>/dev/null || true
            ccache -c 2>/dev/null || true
            CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
            if [ "$CURRENT_SPACE" -lt "$THRESHOLD" ]; then
              echo "âŒ ç´§æ€¥æ¸…ç†åç©ºé—´ä»ç„¶ä¸è¶³: ${CURRENT_SPACE}GB"
              exit 1
            else
              echo "âœ… ç´§æ€¥æ¸…ç†æˆåŠŸï¼Œå½“å‰ç©ºé—´: ${CURRENT_SPACE}GB"
            fi
          elif [ "$CURRENT_SPACE" -lt 8 ]; then
            echo "âš ï¸ ç¼–è¯‘è­¦å‘Š: ç£ç›˜ç©ºé—´ç´§å¼  (${CURRENT_SPACE}GB)ï¼Œå¯ç”¨æé™ç¼–è¯‘æ¨¡å¼"
            echo "LIMIT_BUILD_MODE=true" >> $GITHUB_ENV
          else
            echo "âœ… ç©ºé—´å……è¶³ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘"
            echo "LIMIT_BUILD_MODE=false" >> $GITHUB_ENV
          fi

      - name: "ğŸš€ åˆ†é˜¶æ®µç¼–è¯‘ä¸å®æ—¶ç©ºé—´ç›‘æ§"
        timeout-minutes: 120
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸš€ åˆ†é˜¶æ®µç¼–è¯‘ä¸å®æ—¶ç©ºé—´ç›‘æ§ ==="
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          ulimit -S -n 8192
          if [ "${{ env.LIMIT_BUILD_MODE }}" = "true" ]; then
            PARALLEL_JOBS=1
            echo "ğŸ”§ æé™æ¨¡å¼: ä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘"
          else
            PARALLEL_JOBS=2
            echo "ğŸ”§ æ­£å¸¸æ¨¡å¼: ä½¿ç”¨2çº¿ç¨‹ç¼–è¯‘"
          fi
          echo "ğŸ”§ é˜¶æ®µ1: ç¼–è¯‘ç›®æ ‡å‡†å¤‡..."
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ğŸ“Š [é˜¶æ®µ1å¼€å§‹] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
          if [ "$CURRENT_SPACE" -lt "${{ env.SPACE_THRESHOLD }}" ]; then
            echo "âŒ [é˜¶æ®µ1å¼€å§‹] ç©ºé—´è€—å°½é”™è¯¯: ä»…å‰© ${CURRENT_SPACE}GB"
            echo "ğŸ’¾ ç©ºé—´ä½¿ç”¨æŠ¥å‘Š:"
            df -h | grep -E '(/|/mnt)'
            echo "ğŸ“ å¤§æ–‡ä»¶åˆ†æ:"
            find ${{ env.SOURCE_DIR }} -type f -size +100M 2>/dev/null | head -10 | while read file; do
              size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "unknown")
              echo "  - $file ($size)"
            done
            exit 1
          fi
          make target/linux/prepare -j$PARALLEL_JOBS V=s
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ğŸ“Š [é˜¶æ®µ1å®Œæˆ] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
          echo "ğŸ”§ é˜¶æ®µ2: ç¼–è¯‘å†…æ ¸..."
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ğŸ“Š [é˜¶æ®µ2å¼€å§‹] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
          if [ "$CURRENT_SPACE" -lt "${{ env.SPACE_THRESHOLD }}" ]; then
            echo "âŒ [é˜¶æ®µ2å¼€å§‹] ç©ºé—´è€—å°½é”™è¯¯: ä»…å‰© ${CURRENT_SPACE}GB"
            exit 1
          fi
          make target/linux/compile -j$PARALLEL_JOBS V=s
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ğŸ“Š [é˜¶æ®µ2å®Œæˆ] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
          echo "ğŸ”§ é˜¶æ®µ3: ç¼–è¯‘åŸºç¡€åŒ…..."
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ğŸ“Š [é˜¶æ®µ3å¼€å§‹] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
          if [ "$CURRENT_SPACE" -lt "${{ env.SPACE_THRESHOLD }}" ]; then
            echo "âŒ [é˜¶æ®µ3å¼€å§‹] ç©ºé—´è€—å°½é”™è¯¯: ä»…å‰© ${CURRENT_SPACE}GB"
            exit 1
          fi
          make package/base-files/compile -j$PARALLEL_JOBS V=s
          make package/busybox/compile -j$PARALLEL_JOBS V=s
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ğŸ“Š [é˜¶æ®µ3å®Œæˆ] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
          echo "ğŸ”§ é˜¶æ®µ4: å®Œæ•´ç¼–è¯‘..."
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ğŸ“Š [é˜¶æ®µ4å¼€å§‹] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
          if [ "$CURRENT_SPACE" -lt "${{ env.SPACE_THRESHOLD }}" ]; then
            echo "âŒ [é˜¶æ®µ4å¼€å§‹] ç©ºé—´è€—å°½é”™è¯¯: ä»…å‰© ${CURRENT_SPACE}GB"
            exit 1
          fi
          if make -j$PARALLEL_JOBS V=s; then
            CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
            echo "ğŸ“Š [é˜¶æ®µ4å®Œæˆ] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæ£€æŸ¥ç©ºé—´çŠ¶æ€..."
            CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
            echo "ğŸ“Š [ç¼–è¯‘å¤±è´¥å] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
            echo "ğŸ”„ å°è¯•å•çº¿ç¨‹é‡è¯•..."
            if make -j1 V=s; then
              CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
              echo "ğŸ“Š [å•çº¿ç¨‹é‡è¯•å®Œæˆ] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
              echo "BUILD_STATUS=success" >> $GITHUB_ENV
            else
              echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•å¤±è´¥"
              CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
              echo "ğŸ“Š [æœ€ç»ˆå¤±è´¥å] å®æ—¶ç©ºé—´: ${CURRENT_SPACE}GB"
              echo "BUILD_STATUS=failed" >> $GITHUB_ENV
              exit 1
            fi
          fi

      - name: "ğŸ¯ å·¥å‚é•œåƒä¿éšœä¸æœ€ç»ˆç©ºé—´æŠ¥å‘Š"
        if: env.BUILD_STATUS == 'success'
        timeout-minutes: 15
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ¯ å·¥å‚é•œåƒä¿éšœä¸æœ€ç»ˆç©ºé—´æŠ¥å‘Š ==="
          INITIAL_SPACE=${{ env.INITIAL_MNT_SPACE }}
          CURRENT_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          TOTAL_USED=$((INITIAL_SPACE - CURRENT_SPACE))
          echo "ğŸ“Š æ„å»ºè¿‡ç¨‹ç©ºé—´æ¶ˆè€—æ€»ç»“:"
          echo "  - åˆå§‹ç©ºé—´: ${INITIAL_SPACE}GB"
          echo "  - æœ€ç»ˆç©ºé—´: ${CURRENT_SPACE}GB"
          echo "  - æ€»æ¶ˆè€—: ${TOTAL_USED}GB"
          echo "  - å‰©ä½™ç©ºé—´æ¯”ä¾‹: $((CURRENT_SPACE * 100 / INITIAL_SPACE))%"
          df -h | grep -E '(/|/mnt)' | while read line; do
            echo "  $line"
          done
          echo "ğŸ” æ£€æŸ¥å·¥å‚é•œåƒ..."
          ASUS_FACTORY=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -i factory || true)
          if [ -n "$ASUS_FACTORY" ]; then
            echo "âœ… å·¥å‚é•œåƒå·²ç”Ÿæˆ:"
            for img in $ASUS_FACTORY; do
              size=$(du -h "$img" | cut -f1)
              echo "  - $img ($size)"
            done
            echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°å·¥å‚é•œåƒï¼Œæ‰§è¡Œä¸“é—¨ç¼–è¯‘..."
            make target/install -j1 V=s
            ASUS_FACTORY_RETRY=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -i factory || true)
            if [ -n "$ASUS_FACTORY_RETRY" ]; then
              echo "âœ… å·¥å‚é•œåƒä¿®å¤æˆåŠŸ"
              echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
            else
              echo "âŒ å·¥å‚é•œåƒç”Ÿæˆå¤±è´¥"
              echo "FACTORY_EXISTS=false" >> $GITHUB_ENV
            fi
          fi

      - name: "ğŸ“¦ äº§ç‰©æ”¶é›†ä¸ç©ºé—´æ¸…ç†"
        if: env.BUILD_STATUS == 'success'
        timeout-minutes: 8
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ“¦ äº§ç‰©æ”¶é›†ä¸ç©ºé—´æ¸…ç† ==="
          echo "ğŸ“Š æ”¶é›†å‰ç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          mkdir -p ${{ env.ARTIFACTS_DIR }}/firmware
          if [ -d "bin/targets" ]; then
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) -exec cp {} ${{ env.ARTIFACTS_DIR }}/firmware/ \;
            FIRMWARE_COUNT=$(find ${{ env.ARTIFACTS_DIR }}/firmware -type f | wc -l)
            echo "FIRMWARE_COUNT=$FIRMWARE_COUNT" >> $GITHUB_ENV
            echo "âœ… æ”¶é›† $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
          fi
          echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘ä¸­é—´æ–‡ä»¶..."
          make dirclean 2>/dev/null || true
          rm -rf build_dir/* 2>/dev/null || true
          ccache -c 2>/dev/null || true
          echo "ğŸ“Š æ¸…ç†åç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          FINAL_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "FINAL_SPACE=$FINAL_SPACE" >> $GITHUB_ENV

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
        if: env.BUILD_STATUS == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: "firmware-${{ github.run_number }}-${{ github.event.inputs.source_preset }}"
          path: ${{ env.ARTIFACTS_DIR }}
          retention-days: 7

      - name: "ğŸ“‹ æœ€ç»ˆç©ºé—´åˆ†ææŠ¥å‘Š"
        if: always()
        timeout-minutes: 3
        run: |
          echo "=== ğŸ“‹ æœ€ç»ˆç©ºé—´åˆ†ææŠ¥å‘Š ==="
          echo ""
          echo "ğŸ’¾ ç£ç›˜ç©ºé—´ä½¿ç”¨æ€»ç»“"
          echo "=========================================="
          echo "ğŸ“Š ç©ºé—´ç»Ÿè®¡:"
          echo "  - åˆå§‹ç©ºé—´: ${{ env.INITIAL_MNT_SPACE }}GB"
          echo "  - æœ€ç»ˆç©ºé—´: ${{ env.FINAL_SPACE || 'N/A' }}GB"
          if [ -n "${{ env.FINAL_SPACE }}" ]; then
            echo "  - æ€»æ¶ˆè€—: $((${{ env.INITIAL_MNT_SPACE }} - ${{ env.FINAL_SPACE }}))GB"
          fi
          echo "  - ç©ºé—´é˜ˆå€¼: ${{ env.SPACE_THRESHOLD }}GB"
          echo ""
          echo "ğŸ¯ æ„å»ºç»“æœ:"
          echo "  - æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - å·¥å‚é•œåƒ: ${{ env.FACTORY_EXISTS || 'unknown' }}"
          echo "  - ä¼˜åŒ–æ¨¡å¼: ${{ env.EXTREME_OPTIMIZATION || 'false' }}"
          echo "  - æé™ç¼–è¯‘: ${{ env.LIMIT_BUILD_MODE || 'false' }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            if [ "${{ env.FACTORY_EXISTS }}" = "true" ]; then
              echo "ğŸ‰ æ„å»ºæˆåŠŸï¼å·¥å‚é•œåƒå·²ç”Ÿæˆ"
            else
              echo "âš ï¸ æ„å»ºæˆåŠŸä½†æœªç”Ÿæˆå·¥å‚é•œåƒ"
            fi
          else
            echo "âŒ æ„å»ºå¤±è´¥"
            echo ""
            echo "ğŸ” å¯èƒ½çš„åŸå› :"
            echo "  - ç£ç›˜ç©ºé—´ä¸è¶³"
            echo "  - ç½‘ç»œä¸‹è½½å¤±è´¥"
            echo "  - é…ç½®é”™è¯¯"
            echo "  - ä¾èµ–ç¼ºå¤±"
          fi
          echo ""
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "=========================================="

      - name: "ğŸ§¹ æœ€ç»ˆæ¸…ç†"
        if: always()
        timeout-minutes: 2
        run: |
          echo "=== ğŸ§¹ æœ€ç»ˆæ¸…ç† ==="
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          echo "ğŸ“Š æœ€ç»ˆèµ„æºçŠ¶æ€:"
          free -h
          echo "âœ… æ¸…ç†å®Œæˆ"
