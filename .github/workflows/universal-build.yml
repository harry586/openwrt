name: "ğŸš€ è¶…å¿«é€Ÿå›ºä»¶æ„å»ºå™¨ - ä¼˜åŒ–ç‰ˆ"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "auto"
        type: choice
        options: ["auto", "openwrt-22.03", "openwrt-21.02", "master", "main"]
      config_profile:
        description: "è®¾å¤‡é…ç½®æ–‡ä»¶åç§°"
        required: true
        type: string
        default: "ac42u"
      build_mode:
        description: "æ„å»ºæ¨¡å¼"
        required: true
        type: choice
        options: ["minimal", "standard", "custom"]
        default: "standard"
      build_optimization:
        description: "ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥"
        required: true
        type: choice
        options: ["balanced", "speed", "stability"]
        default: "balanced"
      enable_advanced:
        description: "å¯ç”¨é«˜çº§åŠŸèƒ½"
        required: false
        default: true
        type: boolean
      language_pack:
        description: "è¯­è¨€åŒ…é€‰æ‹©"
        required: true
        type: choice
        options: ["zh-cn", "en-only", "all"]
        default: "zh-cn"
      auto_commit_config:
        description: "è‡ªåŠ¨æäº¤æ–°é…ç½®æ–‡ä»¶"
        required: false
        default: true
        type: boolean
      extra_packages:
        description: "é¢å¤–è½¯ä»¶åŒ…ï¼ˆé€—å·åˆ†éš”ï¼‰"
        required: false
        type: string
        default: ""

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 180
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"
        with:
          path: "config-repo"
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ”§ æé€Ÿç¯å¢ƒåˆå§‹åŒ–"
        id: init
        run: |
          echo "=== ğŸ”§ æé€Ÿç¯å¢ƒåˆå§‹åŒ– ==="
          sudo mkdir -p /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chown -R $USER:$USER /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chmod -R 755 /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          
          MAIN_LOG="/mnt/build-logs/build_timeline.log"
          ERROR_LOG="/mnt/build-logs/errors.log"
          WARNING_LOG="/mnt/build-logs/warnings.log"
          ANALYSIS_REPORT="/mnt/build-logs/analysis_report.md"
          DOWNLOAD_LOG="/mnt/build-logs/download_audit.log"
          
          echo "ğŸ æé€Ÿæ„å»ºå¼€å§‹: $(date)" > $MAIN_LOG
          echo "ğŸš€ å·¥ä½œæµç‰ˆæœ¬: è¶…å¿«é€Ÿå›ºä»¶æ„å»ºå™¨ - ä¼˜åŒ–ç‰ˆ" >> $MAIN_LOG
          echo "ğŸ“‹ è¾“å…¥å‚æ•°:" >> $MAIN_LOG
          echo "  - æºç é¢„è®¾: ${{ github.event.inputs.source_preset }}" >> $MAIN_LOG
          echo "  - æºç åˆ†æ”¯: ${{ github.event.inputs.source_branch }}" >> $MAIN_LOG
          echo "  - é…ç½®æ–¹æ¡ˆ: ${{ github.event.inputs.config_profile }}" >> $MAIN_LOG
          echo "  - æ„å»ºæ¨¡å¼: ${{ github.event.inputs.build_mode }}" >> $MAIN_LOG
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}" >> $MAIN_LOG
          echo "  - é«˜çº§åŠŸèƒ½: ${{ github.event.inputs.enable_advanced }}" >> $MAIN_LOG
          echo "  - è¯­è¨€åŒ…: ${{ github.event.inputs.language_pack }}" >> $MAIN_LOG
          echo "  - è‡ªåŠ¨æäº¤é…ç½®: ${{ github.event.inputs.auto_commit_config }}" >> $MAIN_LOG
          echo "  - é¢å¤–è½¯ä»¶åŒ…: ${{ github.event.inputs.extra_packages }}" >> $MAIN_LOG
          echo "==========================================" >> $MAIN_LOG
          
          echo "# ä¸‹è½½å®¡è®¡æ—¥å¿—" > $DOWNLOAD_LOG
          echo "å¼€å§‹æ—¶é—´: $(date)" >> $DOWNLOAD_LOG
          
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV
          echo "ERROR_LOG=$ERROR_LOG" >> $GITHUB_ENV
          echo "WARNING_LOG=$WARNING_LOG" >> $GITHUB_ENV
          echo "ANALYSIS_REPORT=$ANALYSIS_REPORT" >> $GITHUB_ENV
          echo "DOWNLOAD_LOG=$DOWNLOAD_LOG" >> $GITHUB_ENV
          echo "CONFIG_REPO_DIR=${{ github.workspace }}/config-repo" >> $GITHUB_ENV
          echo "BUILD_STATUS=running" >> $GITHUB_ENV
          
          echo "# é”™è¯¯æ—¥å¿—" > $ERROR_LOG
          echo "# è­¦å‘Šæ—¥å¿—" > $WARNING_LOG
          echo "# æ™ºèƒ½åˆ†ææŠ¥å‘Š" > $ANALYSIS_REPORT
          echo "âœ… æé€Ÿç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸš€ æé€Ÿä¾èµ–å®‰è£…"
        id: install_deps
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸš€ æé€Ÿä¾èµ–å®‰è£… ===" | tee -a "$MAIN_LOG"
          
          echo "ğŸ“¦ æ‰¹é‡å®‰è£…ç¼–è¯‘ä¾èµ–..." | tee -a "$MAIN_LOG"
          sudo apt-get update -qq
          
          sudo apt-get install -y -qq build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-dev rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build libelf-dev libxml2-dev liblzma-dev liblzo2-dev axel net-tools e2fsprogs genext2fs dosfstools mtools libffi-dev libsqlite3-dev libpam0g-dev libtirpc-dev libev-dev lm-sensors libsnmp-dev libglib2.0-dev libgpiod-dev libfl-dev upx-ucl aria2
          
          python3 -m pip install --upgrade pip setuptools wheel -q
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ æ€§èƒ½æé€Ÿä¼˜åŒ–"
        id: performance
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== âš¡ æ€§èƒ½æé€Ÿä¼˜åŒ– ===" | tee -a "$MAIN_LOG"
          
          CPU_CORES=$(nproc)
          echo "ğŸ–¥ï¸ æ£€æµ‹åˆ° CPU æ ¸å¿ƒ: $CPU_CORES" | tee -a "$MAIN_LOG"
          
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          case "$OPTIMIZATION_STRATEGY" in
            "speed")
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=$((CPU_CORES + 2))
              echo "ğŸš€ æé€Ÿæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            "stability")
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=$((CPU_CORES / 2))
              echo "ğŸ›¡ï¸ ç¨³å®šæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            *)
              CCACHE_SIZE="6G"
              PARALLEL_JOBS=$CPU_CORES
              echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
          esac
          
          mkdir -p /mnt/ccache
          ccache -M $CCACHE_SIZE
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=100000
          
          echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          
          echo "ğŸ’¾ åˆ›å»ºäº¤æ¢æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          sudo fallocate -l 8G /mnt/swapfile && sudo chmod 600 /mnt/swapfile && sudo mkswap /mnt/swapfile && sudo swapon /mnt/swapfile
          
          echo "ğŸ“Š ç³»ç»Ÿèµ„æºçŠ¶æ€:" | tee -a "$MAIN_LOG"
          free -h | tee -a "$MAIN_LOG"
          echo "âœ… æ€§èƒ½ä¼˜åŒ–å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ æé€Ÿæºç è·å–"
        id: source_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== âš¡ æé€Ÿæºç è·å– ===" | tee -a "$MAIN_LOG"
          
          REPO_JSON_FOUND="${{ env.CONFIG_REPO_DIR }}/firmware-config/repositories.json"
          PRESET="${{ github.event.inputs.source_preset }}"
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND")
          BRANCH="${{ github.event.inputs.source_branch }}"
          
          if [ "$BRANCH" = "auto" ]; then
            BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND")
          fi
          
          echo "ğŸ“¦ æé€Ÿå…‹éš†æºç ..." | tee -a "$MAIN_LOG"
          cd /mnt/source
          rm -rf .[!.]* *
          
          git clone --depth 1 --branch "$BRANCH" --single-branch --progress "$SOURCE_URL" . || {
            echo "ğŸ”„ åˆ†æ”¯å…‹éš†å¤±è´¥ï¼Œå°è¯•masteråˆ†æ”¯..." | tee -a "$MAIN_LOG"
            git clone --depth 1 --progress "$SOURCE_URL" .
            git checkout "$BRANCH" 2>/dev/null || true
          }
          
          ACTUAL_BRANCH=$(git branch --show-current)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "âœ… æºç è·å–å®Œæˆ: $ACTUAL_BRANCH@$COMMIT_HASH" | tee -a "$MAIN_LOG"

      - name: "ğŸ›ï¸ æ¨¡å¼é…ç½®æ–‡ä»¶å¤„ç†"
        id: mode_config
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ›ï¸ æ¨¡å¼é…ç½®æ–‡ä»¶å¤„ç† ===" | tee -a "$MAIN_LOG"
          
          BUILD_MODE="${{ github.event.inputs.build_mode }}"
          CONFIG_REPO="${{ env.CONFIG_REPO_DIR }}"
          MODE_CONFIG_DIR="$CONFIG_REPO/firmware-config/modes"
          
          echo "ğŸ¯ æ„å»ºæ¨¡å¼: $BUILD_MODE" | tee -a "$MAIN_LOG"
          
          mkdir -p "$MODE_CONFIG_DIR"
          
          case "$BUILD_MODE" in
            "minimal")
              echo "ğŸ”§ åˆ›å»ºæœ€å°åŒ–æ¨¡å¼é…ç½®..." | tee -a "$MAIN_LOG"
              echo "# ============================================" > "$MODE_CONFIG_DIR/minimal.conf"
              echo "# æœ€å°åŒ–æ„å»ºæ¨¡å¼é…ç½®" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "# ============================================" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "# åŸºç¡€ç³»ç»Ÿé…ç½®" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_base-files=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_busybox=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_dropbear=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_firewall=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_fstools=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_libc=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_libgcc=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_logd=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_mtd=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_netifd=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_opkg=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_procd=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_swconfig=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_ubox=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_ubus=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_ubusd=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_uci=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_uclient-fetch=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_urandom-seed=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_usign=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              ;;
            
            "standard")
              echo "ğŸ”§ åˆ›å»ºæ ‡å‡†æ¨¡å¼é…ç½®..." | tee -a "$MAIN_LOG"
              echo "# ============================================" > "$MODE_CONFIG_DIR/standard.conf"
              echo "# æ ‡å‡†æ„å»ºæ¨¡å¼é…ç½®" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "# ============================================" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "# åŸºç¡€ç³»ç»Ÿé…ç½®" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_base-files=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_busybox=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_dropbear=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_firewall=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_fstools=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_libc=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_libgcc=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_logd=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_mtd=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_netifd=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_opkg=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_procd=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_swconfig=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_ubox=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_ubus=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_ubusd=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_uci=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_uclient-fetch=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_urandom-seed=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_usign=y" >> "$MODE_CONFIG_DIR/standard.conf"
              ;;
            
            "custom")
              echo "ğŸ”§ åˆ›å»ºè‡ªå®šä¹‰æ¨¡å¼é…ç½®..." | tee -a "$MAIN_LOG"
              echo "# ============================================" > "$MODE_CONFIG_DIR/custom.conf"
              echo "# è‡ªå®šä¹‰æ„å»ºæ¨¡å¼é…ç½®" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "# ============================================" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "# åŸºç¡€ç³»ç»Ÿï¼ˆå¿…é€‰ï¼‰" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_base-files=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_busybox=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_dropbear=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_firewall=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_fstools=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_libc=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_libgcc=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_logd=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_netifd=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_opkg=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_procd=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_ubox=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_ubus=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_ubusd=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_uci=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_uclient-fetch=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_urandom-seed=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_usign=y" >> "$MODE_CONFIG_DIR/custom.conf"
              ;;
          esac
          
          echo "BUILD_MODE=$BUILD_MODE" >> $GITHUB_ENV
          echo "MODE_CONFIG_DIR=$MODE_CONFIG_DIR" >> $GITHUB_ENV
          echo "âœ… æ¨¡å¼é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ: $BUILD_MODE" | tee -a "$MAIN_LOG"

      - name: "ğŸ“ æ™ºèƒ½é…ç½®åˆ›å»ºä¸å¤„ç†"
        id: config_creation
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“ æ™ºèƒ½é…ç½®åˆ›å»ºä¸å¤„ç† ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          CONFIG_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/configs"
          CONFIG_FILE="$CONFIG_DIR/config_$CONFIG_PROFILE"
          MODE_CONFIG="${{ env.MODE_CONFIG_DIR }}/${{ github.event.inputs.build_mode }}.conf"
          
          echo "ğŸ” æŸ¥æ‰¾é…ç½®æ–‡ä»¶: $CONFIG_FILE" | tee -a "$MAIN_LOG"
          echo "ğŸ›ï¸ åº”ç”¨æ¨¡å¼é…ç½®: $MODE_CONFIG" | tee -a "$MAIN_LOG"
          
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" .config
            echo "âœ… åº”ç”¨ç°æœ‰é…ç½®æ–‡ä»¶: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
            echo "CONFIG_SOURCE=existing" >> $GITHUB_ENV
          else
            echo "ğŸ”§ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°é…ç½®..." | tee -a "$MAIN_LOG"
            mkdir -p "$CONFIG_DIR"
            
            echo "ğŸ¯ æ™ºèƒ½åˆ†æè®¾å¤‡åç§°: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
            
            echo "# =============================================" > "$CONFIG_FILE"
            echo "# é€šç”¨è®¾å¤‡é…ç½® - $CONFIG_PROFILE" >> "$CONFIG_FILE"
            echo "# è‡ªåŠ¨ç”Ÿæˆäº $(date)" >> "$CONFIG_FILE"
            echo "# =============================================" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# åŸºç¡€ç›®æ ‡é…ç½®" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"

            TARGET_CONFIG=""
            if [[ "$CONFIG_PROFILE" =~ ^rt-ac42u$|^ac42u$|^asus.*ac42u ]]; then
              echo "# ASUS RT-AC42U è®¾å¤‡ (IPQ40xx)" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx_generic=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ipq40xx_asus_rt-ac42u"
              echo "ğŸ¯ è®¾å¤‡ç±»å‹: IPQ40xx (ASUS RT-AC42U)" | tee -a "$MAIN_LOG"
            elif [[ "$CONFIG_PROFILE" =~ ^x86|^x64|^generic.*64 ]]; then
              echo "# x86/x64 é€šç”¨è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86_64=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="x86_64_generic"
              echo "ğŸ¯ è®¾å¤‡ç±»å‹: x86_64 é€šç”¨" | tee -a "$MAIN_LOG"
            elif [[ "$CONFIG_PROFILE" =~ ^mt7621|^newifi.*d2|^r6220 ]]; then
              echo "# MT7621 è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_ramips_mt7621_DEVICE_xxx=y è¯·æ ¹æ®å…·ä½“è®¾å¤‡è®¾ç½®" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621"
              echo "ğŸ¯ è®¾å¤‡ç±»å‹: MT7621" | tee -a "$MAIN_LOG"
            elif [[ "$CONFIG_PROFILE" =~ ^r3g|^mir3g|^xiaomi.*r3g ]]; then
              echo "# Xiaomi R3G è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-3g=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621_xiaomi_r3g"
              echo "ğŸ¯ è®¾å¤‡ç±»å‹: Xiaomi R3G" | tee -a "$MAIN_LOG"
            elif [[ "$CONFIG_PROFILE" =~ ^r3p|^mir3p|^xiaomi.*r3p ]]; then
              echo "# Xiaomi R3P è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$MAIN_LOG"
              echo "CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-3-pro=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621_xiaomi_r3p"
              echo "ğŸ¯ è®¾å¤‡ç±»å‹: Xiaomi R3P" | tee -a "$MAIN_LOG"
            elif [[ "$CONFIG_PROFILE" =~ ^k2p|^phicomm.*k2p ]]; then
              echo "# Phicomm K2P è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621_phicomm_k2p"
              echo "ğŸ¯ è®¾å¤‡ç±»å‹: Phicomm K2P" | tee -a "$MAIN_LOG"
            else
              echo "# é€šç”¨è®¾å¤‡é…ç½® - è¯·æ ¹æ®å®é™…è®¾å¤‡ä¿®æ”¹" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx_yyy=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx_yyy_DEVICE_zzz=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="generic"
              echo "ğŸ¯ è®¾å¤‡ç±»å‹: é€šç”¨" | tee -a "$MAIN_LOG"
            fi
            
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# é•œåƒé…ç½®" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_IMAGES_GZIP=y" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# åˆ†åŒºå¤§å°" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_ROOTFS_PARTSIZE=96" >> "$CONFIG_FILE"
            
            cp "$CONFIG_FILE" .config
            echo "CONFIG_SOURCE=new" >> $GITHUB_ENV
            echo "TARGET_CONFIG=$TARGET_CONFIG" >> $GITHUB_ENV
            echo "âœ… å·²åˆ›å»ºæ™ºèƒ½é…ç½®æ–‡ä»¶: $CONFIG_FILE" | tee -a "$MAIN_LOG"
            echo "ğŸ¯ ç›®æ ‡é…ç½®ç±»å‹: $TARGET_CONFIG" | tee -a "$MAIN_LOG"
          fi
          
          if [ -f "$MODE_CONFIG" ]; then
            echo "ğŸ”§ åº”ç”¨æ¨¡å¼é…ç½®æ–‡ä»¶..." | tee -a "$MAIN_LOG"
            cat "$MODE_CONFIG" >> .config
            echo "âœ… æ¨¡å¼é…ç½®åº”ç”¨å®Œæˆ: ${{ github.event.inputs.build_mode }}" | tee -a "$MAIN_LOG"
          else
            echo "âš ï¸ æ¨¡å¼é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $MODE_CONFIG" | tee -a "$MAIN_LOG"
          fi
          
          # é…ç½®é¢å¤–è½¯ä»¶åŒ…
          if [ -n "${{ github.event.inputs.extra_packages }}" ]; then
            echo "ğŸ“¦ é…ç½®é¢å¤–è½¯ä»¶åŒ…..." | tee -a "$MAIN_LOG"
            IFS=',' read -ra PKGS <<< "${{ github.event.inputs.extra_packages }}"
            ADDED_COUNT=0
            for pkg in "${PKGS[@]}"; do
              CLEAN_PKG=$(echo "$pkg" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              if [ -n "$CLEAN_PKG" ]; then
                if ! grep -q "CONFIG_PACKAGE_${CLEAN_PKG}=y" .config; then
                  echo "CONFIG_PACKAGE_${CLEAN_PKG}=y" >> .config
                  echo "âœ… æ·»åŠ åŒ…: $CLEAN_PKG" | tee -a "$MAIN_LOG"
                  ADDED_COUNT=$((ADDED_COUNT + 1))
                else
                  echo "â„¹ï¸ åŒ…å·²å­˜åœ¨: $CLEAN_PKG" | tee -a "$MAIN_LOG"
                fi
              fi
            done
            echo "EXTRA_PACKAGES_ADDED=$ADDED_COUNT" >> $GITHUB_ENV
            echo "âœ… æˆåŠŸæ·»åŠ  $ADDED_COUNT ä¸ªé¢å¤–è½¯ä»¶åŒ…" | tee -a "$MAIN_LOG"
          else
            echo "â„¹ï¸ æœªæä¾›é¢å¤–è½¯ä»¶åŒ…" | tee -a "$MAIN_LOG"
            echo "EXTRA_PACKAGES_ADDED=0" >> $GITHUB_ENV
          fi
          
          # åŠ è½½è‡ªå®šä¹‰æ’ä»¶æ–‡ä»¶
          CUSTOM_PLUGINS_FILE="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-plugins.txt"
          if [ -f "$CUSTOM_PLUGINS_FILE" ]; then
            echo "ğŸ”Œ åŠ è½½è‡ªå®šä¹‰æ’ä»¶æ–‡ä»¶..." | tee -a "$MAIN_LOG"
            PLUGIN_COUNT=0
            while IFS= read -r plugin; do
              plugin=$(echo "$plugin" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              if [ -n "$plugin" ] && [[ ! "$plugin" =~ ^# ]]; then
                if ! grep -q "CONFIG_PACKAGE_${plugin}=y" .config; then
                  echo "CONFIG_PACKAGE_${plugin}=y" >> .config
                  echo "âœ… æ·»åŠ æ’ä»¶: $plugin" | tee -a "$MAIN_LOG"
                  PLUGIN_COUNT=$((PLUGIN_COUNT + 1))
                else
                  echo "â„¹ï¸ æ’ä»¶å·²å­˜åœ¨: $plugin" | tee -a "$MAIN_LOG"
                fi
              fi
            done < "$CUSTOM_PLUGINS_FILE"
            echo "CUSTOM_PLUGINS_ADDED=$PLUGIN_COUNT" >> $GITHUB_ENV
            echo "âœ… æˆåŠŸæ·»åŠ  $PLUGIN_COUNT ä¸ªè‡ªå®šä¹‰æ’ä»¶" | tee -a "$MAIN_LOG"
          else
            echo "â„¹ï¸ è‡ªå®šä¹‰æ’ä»¶æ–‡ä»¶ä¸å­˜åœ¨: $CUSTOM_PLUGINS_FILE" | tee -a "$MAIN_LOG"
            echo "CUSTOM_PLUGINS_ADDED=0" >> $GITHUB_ENV
          fi
          
          echo "âš¡ é¢„é…ç½®ä¼˜åŒ–é€‰é¡¹..." | tee -a "$MAIN_LOG"
          echo "# ç¼–è¯‘ä¼˜åŒ–" >> .config
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "# CONFIG_DEBUG=y is not set" >> .config
          
          echo "âœ… é…ç½®åˆ›å»ºä¸å¤„ç†å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”„ å¹¶è¡ŒFeedsæ›´æ–°"
        id: feeds_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”„ å¹¶è¡ŒFeedsæ›´æ–° ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          CURRENT_BRANCH=$(git branch --show-current)
          if [[ "$CURRENT_BRANCH" == *"22.03"* ]]; then FEEDS_BRANCH="openwrt-22.03"
          elif [[ "$CURRENT_BRANCH" == *"21.02"* ]]; then FEEDS_BRANCH="openwrt-21.02"
          else FEEDS_BRANCH="master"; fi
          
          case "${{ env.SOURCE_PRESET }}" in
            "immortalwrt")
              echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "openwrt")
              echo "src-git packages https://git.openwrt.org/feed/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://git.openwrt.org/project/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "lede")
              echo "src-git packages https://github.com/coolsnowwolf/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/coolsnowwolf/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
          esac
          
          echo "src-git routing https://github.com/openwrt/routing.git;$FEEDS_BRANCH" >> feeds.conf
          
          echo "ğŸ”„ å¹¶è¡Œæ›´æ–°feeds..." | tee -a "$MAIN_LOG"
          ./scripts/feeds update -a &
          FEEDS_PID=$!
          
          mkdir -p /mnt/downloads
          [ -d "dl" ] && rm -rf dl
          ln -sf /mnt/downloads dl
          
          wait $FEEDS_PID
          ./scripts/feeds install -a
          
          echo "âœ… Feedsæ›´æ–°å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸŒ è¯­è¨€åŒ…é…ç½®"
        id: language_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸŒ è¯­è¨€åŒ…é…ç½® ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          LANGUAGE="${{ github.event.inputs.language_pack }}"
          echo "ğŸ¯ è¯­è¨€åŒ…é€‰æ‹©: $LANGUAGE" | tee -a "$MAIN_LOG"
          
          CURRENT_BRANCH="${{ env.ACTUAL_BRANCH }}"
          
          case "$LANGUAGE" in
            "zh-cn")
              echo "ğŸ”§ å¯ç”¨ä¸­æ–‡è¯­è¨€åŒ…..." | tee -a "$MAIN_LOG"
              if [[ "$CURRENT_BRANCH" == *"21.02"* ]]; then
                sed -i 's/# CONFIG_PACKAGE_luci-i18n-base-zh-cn is not set/CONFIG_PACKAGE_luci-i18n-base-zh-cn=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
              else
                sed -i 's/# CONFIG_PACKAGE_luci-i18n-base-zh_Hans is not set/CONFIG_PACKAGE_luci-i18n-base-zh_Hans=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-i18n-base-zh_Hans=y" >> .config
              fi
              ;;
            "en-only")
              echo "ğŸ”§ ä»…ä¿ç•™è‹±æ–‡..." | tee -a "$MAIN_LOG"
              sed -i 's/CONFIG_PACKAGE_luci-i18n-[^e][^n].*=y/# &/' .config
              ;;
            "all")
              echo "ğŸ”§ å¯ç”¨æ‰€æœ‰è¯­è¨€åŒ…..." | tee -a "$MAIN_LOG"
              for lang in $(grep "CONFIG_PACKAGE_luci-i18n-" .config | grep "is not set" | cut -d' ' -f2); do
                sed -i "s/# $lang is not set/$lang=y/" .config
              done
              ;;
          esac
          
          echo "âœ… è¯­è¨€åŒ…é…ç½®å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ ä¿®å¤ä¸»æœºå·¥å…·æ£€æŸ¥"
        id: fix_prereq_check
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ ä¿®å¤ä¸»æœºå·¥å…·æ£€æŸ¥ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ å¼ºåˆ¶åˆ›å»ºä¸»æœºå·¥å…·ç›®å½•..." | tee -a "$MAIN_LOG"
          mkdir -p staging_dir/host
          mkdir -p staging_dir/toolchain-*
          
          echo "ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡è·³è¿‡ä¸¥æ ¼æ£€æŸ¥..." | tee -a "$MAIN_LOG"
          export FORCE_UNSAFE_CONFIGURE=1
          
          echo "ğŸ”§ æ‰‹åŠ¨åˆ›å»ºprereq-buildæ–‡ä»¶..." | tee -a "$MAIN_LOG"
          touch staging_dir/host/.prereq-build
          
          # æ£€æŸ¥å¹¶ä¿®å¤å¸¸è§çš„ä¾èµ–é—®é¢˜
          echo "ğŸ”§ æ£€æŸ¥å¹¶ä¿®å¤ç³»ç»Ÿä¾èµ–..." | tee -a "$MAIN_LOG"
          
          # ç¡®ä¿æ‰€æœ‰å¿…è¦çš„å·¥å…·éƒ½å­˜åœ¨
          for tool in gcc g++ make bash patch perl python3 python; do
            if command -v $tool >/dev/null 2>&1; then
              echo "âœ… $tool å­˜åœ¨" | tee -a "$MAIN_LOG"
            else
              echo "âš ï¸ $tool ç¼ºå¤±ï¼Œå°è¯•å®‰è£…..." | tee -a "$MAIN_LOG"
              sudo apt-get install -y $tool 2>/dev/null || true
            fi
          done
          
          echo "ğŸ”§ ä¿®å¤æ–‡ä»¶æƒé™..." | tee -a "$MAIN_LOG"
          chmod -R 755 staging_dir/
          chown -R $USER:$USER staging_dir/
          
          echo "âœ… ä¸»æœºå·¥å…·æ£€æŸ¥ä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸŒ æ™ºèƒ½ç½‘ç»œå’Œä¸‹è½½ä¼˜åŒ–"
        id: smart_download
        timeout-minutes: 30
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          DOWNLOAD_LOG="${{ env.DOWNLOAD_LOG }}"
          echo "=== ğŸŒ æ™ºèƒ½ç½‘ç»œå’Œä¸‹è½½ä¼˜åŒ– ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export FORCE_UNSAFE_CONFIGURE=1
          
          echo "ğŸ“Š ç½‘ç»œçŠ¶æ€æ£€æŸ¥..." | tee -a "$MAIN_LOG"
          echo "ç½‘ç»œçŠ¶æ€æ£€æŸ¥: $(date)" >> "$DOWNLOAD_LOG"
          
          # æµ‹è¯•ç½‘ç»œè¿æ¥
          echo "ğŸ” æµ‹è¯•ç½‘ç»œè¿æ¥æ€§..." | tee -a "$MAIN_LOG"
          MIRRORS=(
            "github.com"
            "git.openwrt.org" 
            "downloads.openwrt.org"
            "mirror2.openwrt.org"
            "sources.cdn.openwrt.org"
          )
          
          for mirror in "${MIRRORS[@]}"; do
            if ping -c 1 -W 2 "$mirror" &>/dev/null; then
              echo "âœ… $mirror - å¯è¾¾" | tee -a "$MAIN_LOG"
              echo "å¯è¾¾é•œåƒ: $mirror" >> "$DOWNLOAD_LOG"
            else
              echo "âš ï¸ $mirror - ä¸å¯è¾¾" | tee -a "$MAIN_LOG"
              echo "ä¸å¯è¾¾é•œåƒ: $mirror" >> "$DOWNLOAD_LOG"
            fi
          done
          
          # ä¿®å¤é•œåƒæº
          echo "ğŸ”§ é…ç½®ä¸‹è½½é•œåƒæº..." | tee -a "$MAIN_LOG"
          sed -i 's|https://sources.cdn.openwrt.org|https://mirror2.openwrt.org/sources|g' scripts/download.pl
          sed -i 's|git.openwrt.org|github.com/openwrt|g' feeds.conf.* 2>/dev/null || true
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
          echo "ğŸ”§ åˆ›å»ºå¿…è¦çš„æ„å»ºç›®å½•..." | tee -a "$MAIN_LOG"
          mkdir -p /mnt/source/{build_dir,staging_dir,bin,tmp,logs,dl}
          mkdir -p /mnt/source/staging_dir/{host,target-*,toolchain-*}
          mkdir -p /mnt/source/build_dir/{host,target-*}
          
          # ä¿®å¤æƒé™
          chmod -R 755 /mnt/source/staging_dir/
          chown -R $USER:$USER /mnt/source/staging_dir/
          
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          
          echo "ğŸ“¥ å¼€å§‹æ™ºèƒ½ä¸‹è½½æµç¨‹..." | tee -a "$MAIN_LOG"
          echo "å¼€å§‹ä¸‹è½½æµç¨‹: $(date)" >> "$DOWNLOAD_LOG"
          
          # ä¸‹è½½çŠ¶æ€è·Ÿè¸ª
          DOWNLOAD_SUCCESS=false
          DOWNLOAD_RETRY_COUNT=0
          MAX_RETRIES=5
          
          while [ $DOWNLOAD_RETRY_COUNT -lt $MAX_RETRIES ] && [ "$DOWNLOAD_SUCCESS" = false ]; do
            DOWNLOAD_RETRY_COUNT=$((DOWNLOAD_RETRY_COUNT + 1))
            echo "ğŸ”„ ä¸‹è½½å°è¯• $DOWNLOAD_RETRY_COUNT/$MAX_RETRIES..." | tee -a "$MAIN_LOG"
            echo "ä¸‹è½½å°è¯• $DOWNLOAD_RETRY_COUNT: $(date)" >> "$DOWNLOAD_LOG"
            
            # é¦–å…ˆå°è¯•ç¼–è¯‘hostå·¥å…·
            echo "ğŸ”§ å°è¯•ç¼–è¯‘hostå·¥å…·..." | tee -a "$MAIN_LOG"
            if make tools/compile -j1 FORCE_UNSAFE_CONFIGURE=1; then
              echo "âœ… hostå·¥å…·ç¼–è¯‘æˆåŠŸ" | tee -a "$MAIN_LOG"
              echo "hostå·¥å…·ç¼–è¯‘æˆåŠŸ" >> "$DOWNLOAD_LOG"
            else
              echo "âš ï¸ hostå·¥å…·ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶è·³è¿‡..." | tee -a "$MAIN_LOG"
              echo "hostå·¥å…·ç¼–è¯‘å¤±è´¥ï¼Œå¼ºåˆ¶è·³è¿‡" >> "$DOWNLOAD_LOG"
              # å¼ºåˆ¶åˆ›å»ºprereq-buildæ–‡ä»¶
              mkdir -p staging_dir/host
              touch staging_dir/host/.prereq-build
            fi
            
            # ç„¶åå°è¯•ä¸‹è½½
            echo "ğŸŒ å¼€å§‹ä¸‹è½½ä¾èµ–..." | tee -a "$MAIN_LOG"
            
            # ä½¿ç”¨ä¸åŒçš„å¹¶è¡Œåº¦å°è¯•
            if [ $DOWNLOAD_RETRY_COUNT -le 2 ]; then
              JOBS=$PARALLEL_JOBS
            else
              JOBS=1  # æœ€åå°è¯•ä½¿ç”¨å•çº¿ç¨‹
            fi
            
            TEMP_DOWNLOAD_LOG=$(mktemp)
            set +e
            make download -j$JOBS FORCE_UNSAFE_CONFIGURE=1 V=s 2>&1 | tee "$TEMP_DOWNLOAD_LOG"
            DOWNLOAD_RESULT=${PIPESTATUS[0]}
            set -e
            
            # è®°å½•ä¸‹è½½æ—¥å¿—
            cat "$TEMP_DOWNLOAD_LOG" >> "$MAIN_LOG"
            echo "=== ä¸‹è½½å°è¯• $DOWNLOAD_RETRY_COUNT è¯¦ç»†æ—¥å¿— ===" >> "$DOWNLOAD_LOG"
            cat "$TEMP_DOWNLOAD_LOG" >> "$DOWNLOAD_LOG"
            
            if [ $DOWNLOAD_RESULT -eq 0 ]; then
              echo "âœ… ä¸‹è½½æˆåŠŸ" | tee -a "$MAIN_LOG"
              echo "ä¸‹è½½æˆåŠŸ" >> "$DOWNLOAD_LOG"
              DOWNLOAD_SUCCESS=true
            else
              echo "âŒ ä¸‹è½½å°è¯• $DOWNLOAD_RETRY_COUNT å¤±è´¥" | tee -a "$MAIN_LOG"
              echo "ä¸‹è½½å¤±è´¥ï¼Œé€€å‡ºç : $DOWNLOAD_RESULT" >> "$DOWNLOAD_LOG"
              
              # åˆ†æä¸‹è½½é”™è¯¯
              if grep -q "Connection timed out" "$TEMP_DOWNLOAD_LOG"; then
                echo "ğŸŒ ç½‘ç»œè¶…æ—¶é”™è¯¯" | tee -a "$MAIN_LOG"
                echo "é”™è¯¯ç±»å‹: ç½‘ç»œè¶…æ—¶" >> "$DOWNLOAD_LOG"
              elif grep -q "Name or service not known" "$TEMP_DOWNLOAD_LOG"; then
                echo "ğŸŒ DNSè§£æé”™è¯¯" | tee -a "$MAIN_LOG"
                echo "é”™è¯¯ç±»å‹: DNSè§£æå¤±è´¥" >> "$DOWNLOAD_LOG"
              elif grep -q "404 Not Found" "$TEMP_DOWNLOAD_LOG"; then
                echo "ğŸŒ èµ„æºä¸å­˜åœ¨é”™è¯¯" | tee -a "$MAIN_LOG"
                echo "é”™è¯¯ç±»å‹: 404èµ„æºä¸å­˜åœ¨" >> "$DOWNLOAD_LOG"
              elif grep -q "SSL certificate problem" "$TEMP_DOWNLOAD_LOG"; then
                echo "ğŸŒ SSLè¯ä¹¦é”™è¯¯" | tee -a "$MAIN_LOG"
                echo "é”™è¯¯ç±»å‹: SSLè¯ä¹¦é—®é¢˜" >> "$DOWNLOAD_LOG"
              fi
              
              if [ $DOWNLOAD_RETRY_COUNT -lt $MAX_RETRIES ]; then
                RETRY_DELAY=$((DOWNLOAD_RETRY_COUNT * 10))
                echo "â³ ç­‰å¾… ${RETRY_DELAY}ç§’åé‡è¯•..." | tee -a "$MAIN_LOG"
                echo "ç­‰å¾… ${RETRY_DELAY}ç§’åé‡è¯•" >> "$DOWNLOAD_LOG"
                sleep $RETRY_DELAY
                
                # æ¸…ç†éƒ¨åˆ†ä¸‹è½½æ–‡ä»¶
                echo "ğŸ§¹ æ¸…ç†éƒ¨åˆ†ä¸‹è½½çš„æ–‡ä»¶..." | tee -a "$MAIN_LOG"
                find dl/ -name "*.tmp" -delete 2>/dev/null || true
                find dl/ -name "*.part" -delete 2>/dev/null || true
              fi
            fi
            
            rm -f "$TEMP_DOWNLOAD_LOG"
          done
          
          if [ "$DOWNLOAD_SUCCESS" = false ]; then
            echo "ğŸ’¥ æ‰€æœ‰ä¸‹è½½å°è¯•éƒ½å¤±è´¥" | tee -a "$MAIN_LOG"
            echo "æœ€ç»ˆçŠ¶æ€: æ‰€æœ‰ä¸‹è½½å°è¯•å¤±è´¥" >> "$DOWNLOAD_LOG"
            exit 1
          fi
          
          # ä¸‹è½½å®Œæ•´æ€§éªŒè¯
          echo "ğŸ” éªŒè¯ä¸‹è½½å®Œæ•´æ€§..." | tee -a "$MAIN_LOG"
          echo "å¼€å§‹å®Œæ•´æ€§éªŒè¯: $(date)" >> "$DOWNLOAD_LOG"
          
          DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
          echo "ğŸ“¦ ä¸‹è½½æ–‡ä»¶æ•°é‡: $DOWNLOAD_COUNT" | tee -a "$MAIN_LOG"
          echo "æ€»ä¸‹è½½æ–‡ä»¶æ•°: $DOWNLOAD_COUNT" >> "$DOWNLOAD_LOG"
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          CRITICAL_FILES=0
          if [ -f "dl/"*"/linux-"*".tar.xz" ] || [ -f "dl/linux-"*".tar.xz" ]; then
            echo "âœ… æ‰¾åˆ°Linuxå†…æ ¸æºç " | tee -a "$MAIN_LOG"
            CRITICAL_FILES=$((CRITICAL_FILES + 1))
          else
            echo "âš ï¸ æœªæ‰¾åˆ°Linuxå†…æ ¸æºç " | tee -a "$MAIN_LOG"
          fi
          
          if find dl/ -name "*.tar.gz" | grep -q .; then
            echo "âœ… æ‰¾åˆ°å‹ç¼©åŒ…æ–‡ä»¶" | tee -a "$MAIN_LOG"
            CRITICAL_FILES=$((CRITICAL_FILES + 1))
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å‹ç¼©åŒ…æ–‡ä»¶" | tee -a "$MAIN_LOG"
          fi
          
          if [ "$DOWNLOAD_COUNT" -lt 10 ]; then
            echo "âš ï¸ ä¸‹è½½æ–‡ä»¶æ•°é‡è¿‡å°‘ï¼Œå¯èƒ½æœ‰é—®é¢˜" | tee -a "$MAIN_LOG"
            echo "è­¦å‘Š: ä¸‹è½½æ–‡ä»¶æ•°é‡è¿‡å°‘" >> "$DOWNLOAD_LOG"
          else
            echo "âœ… ä¸‹è½½æ–‡ä»¶æ•°é‡æ­£å¸¸" | tee -a "$MAIN_LOG"
          fi
          
          if [ $CRITICAL_FILES -lt 1 ]; then
            echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±ï¼Œä¸‹è½½å¯èƒ½ä¸å®Œæ•´" | tee -a "$MAIN_LOG"
            echo "é”™è¯¯: å…³é”®æ–‡ä»¶ç¼ºå¤±" >> "$DOWNLOAD_LOG"
            exit 1
          fi
          
          echo "ğŸ“Š ä¸‹è½½ç»Ÿè®¡:" | tee -a "$MAIN_LOG"
          echo "ä¸‹è½½æ–‡ä»¶æ€»æ•°: $DOWNLOAD_COUNT" | tee -a "$MAIN_LOG"
          echo "ä¸‹è½½é‡è¯•æ¬¡æ•°: $DOWNLOAD_RETRY_COUNT" | tee -a "$MAIN_LOG"
          echo "å…³é”®æ–‡ä»¶æ•°é‡: $CRITICAL_FILES" | tee -a "$MAIN_LOG"
          
          echo "æœ€ç»ˆä¸‹è½½ç»Ÿè®¡:" >> "$DOWNLOAD_LOG"
          echo "æ–‡ä»¶æ€»æ•°: $DOWNLOAD_COUNT" >> "$DOWNLOAD_LOG"
          echo "é‡è¯•æ¬¡æ•°: $DOWNLOAD_RETRY_COUNT" >> "$DOWNLOAD_LOG"
          echo "å…³é”®æ–‡ä»¶: $CRITICAL_FILES" >> "$DOWNLOAD_LOG"
          echo "ä¸‹è½½å®Œæˆæ—¶é—´: $(date)" >> "$DOWNLOAD_LOG"
          
          echo "DOWNLOAD_COMPLETE=true" >> $GITHUB_ENV
          echo "DOWNLOAD_FILE_COUNT=$DOWNLOAD_COUNT" >> $GITHUB_ENV
          echo "âœ… æ™ºèƒ½ä¸‹è½½å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ é«˜çº§åŠŸèƒ½å¢å¼º"
        id: advanced_features
        if: github.event.inputs.enable_advanced == 'true'
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ”§ é«˜çº§åŠŸèƒ½å¢å¼º ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ é«˜çº§åŠŸèƒ½çŠ¶æ€: å·²å¯ç”¨" | tee -a "$MAIN_LOG"
          
          echo "ğŸ“¦ å®‰è£…è‡ªå®šä¹‰IPKåŒ…..." | tee -a "$MAIN_LOG"
          IPK_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-features/prebuilt-ipks"
          IPK_COUNT=0
          
          if [ -d "$IPK_DIR" ]; then
            echo "ğŸ” æŸ¥æ‰¾è‡ªå®šä¹‰IPKåŒ…..." | tee -a "$MAIN_LOG"
            IPK_FILES=$(find "$IPK_DIR" -name "*.ipk" -type f 2>/dev/null || true)
            if [ -n "$IPK_FILES" ]; then
              echo "âœ… æ‰¾åˆ°è‡ªå®šä¹‰IPKåŒ…:" | tee -a "$MAIN_LOG"
              mkdir -p package/custom
              for ipk in $IPK_FILES; do
                ipk_name=$(basename "$ipk")
                echo "  - å¤åˆ¶ $ipk_name" | tee -a "$MAIN_LOG"
                cp "$ipk" package/custom/
                IPK_COUNT=$((IPK_COUNT + 1))
                ipk_basename=$(basename "$ipk" .ipk)
                echo "CONFIG_PACKAGE_${ipk_basename}=y" >> .config
              done
              echo "âœ… æˆåŠŸæ·»åŠ  $IPK_COUNT ä¸ªè‡ªå®šä¹‰IPKåŒ…" | tee -a "$MAIN_LOG"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰IPKåŒ…" | tee -a "$MAIN_LOG"
            fi
          else
            echo "â„¹ï¸ è‡ªå®šä¹‰IPKç›®å½•ä¸å­˜åœ¨: $IPK_DIR" | tee -a "$MAIN_LOG"
          fi
          
          echo "CUSTOM_IPK_COUNT=$IPK_COUNT" >> $GITHUB_ENV
          
          echo "ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..." | tee -a "$MAIN_LOG"
          SCRIPT_PATHS="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-features/scripts ${{ env.CONFIG_REPO_DIR }}/firmware-config/scripts ${{ env.CONFIG_REPO_DIR }}/scripts ${{ env.CONFIG_REPO_DIR }}/firmware-config"
          
          SCRIPT_COUNT=0
          for script_path in $SCRIPT_PATHS; do
            if [ -d "$script_path" ]; then
              echo "ğŸ” åœ¨ $script_path ä¸­æŸ¥æ‰¾è„šæœ¬..." | tee -a "$MAIN_LOG"
              SCRIPTS=$(find "$script_path" -maxdepth 2 -name "*.sh" -type f 2>/dev/null | sort || true)
              if [ -n "$SCRIPTS" ]; then
                for script in $SCRIPTS; do
                  script_name=$(basename "$script")
                  echo "ğŸ“œ æ‰§è¡Œè„šæœ¬: $script_name..." | tee -a "$MAIN_LOG"
                  chmod +x "$script"
                  
                  TEMP_LOG=$(mktemp)
                  if { bash "$script" 2>&1 | tee "$TEMP_LOG"; } then
                    echo "âœ… è‡ªå®šä¹‰è„šæœ¬æ‰§è¡ŒæˆåŠŸ: $script_name" | tee -a "$MAIN_LOG"
                    SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
                  else
                    echo "âš ï¸ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œæœ‰è­¦å‘Š: $script_name" | tee -a "$MAIN_LOG"
                    grep -i -E "error|failed|No such file" "$TEMP_LOG" >> "$WARNING_LOG" || true
                  fi
                  cat "$TEMP_LOG" >> "$MAIN_LOG"
                  rm -f "$TEMP_LOG"
                done
              else
                echo "â„¹ï¸ åœ¨ $script_path ä¸­æœªæ‰¾åˆ°è„šæœ¬" | tee -a "$MAIN_LOG"
              fi
            else
              echo "â„¹ï¸ è„šæœ¬ç›®å½•ä¸å­˜åœ¨: $script_path" | tee -a "$MAIN_LOG"
            fi
          done
          
          echo "CUSTOM_SCRIPT_COUNT=$SCRIPT_COUNT" >> $GITHUB_ENV
          echo "âœ… é«˜çº§åŠŸèƒ½åº”ç”¨å®Œæˆï¼Œæ‰§è¡Œäº† $SCRIPT_COUNT ä¸ªè„šæœ¬" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ æ™ºèƒ½æ„å»ºä¿®å¤ç³»ç»Ÿ"
        id: smart_build_fix
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ æ™ºèƒ½æ„å»ºä¿®å¤ç³»ç»Ÿ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ åº”ç”¨æ™ºèƒ½æ„å»ºä¿®å¤..." | tee -a "$MAIN_LOG"
          
          # 1. åŠ¨æ€è®¾å¤‡é€‚é…ä¿®å¤
          echo "ğŸ”§ åŠ¨æ€è®¾å¤‡é€‚é…ä¿®å¤..." | tee -a "$MAIN_LOG"
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          
          echo "# ======================" >> .config
          echo "# æ™ºèƒ½è®¾å¤‡ä¿®å¤" >> .config
          echo "# ======================" >> .config
          
          if [[ "$CONFIG_PROFILE" =~ ^rt-ac42u$|^ac42u$|^asus.*ac42u ]]; then
            echo "# IPQ40xxè®¾å¤‡ä¿®å¤" >> .config
            echo "CONFIG_TARGET_ipq40xx=y" >> .config
            echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
            echo "CONFIG_KERNEL_ARM=y" >> .config
          elif [[ "$CONFIG_PROFILE" =~ ^x86|^x64|^generic.*64 ]]; then
            echo "# x86è®¾å¤‡ä¿®å¤" >> .config
            echo "CONFIG_TARGET_x86=y" >> .config
            echo "CONFIG_TARGET_x86_64=y" >> .config
            echo "CONFIG_KERNEL_X86=y" >> .config
          elif [[ "$CONFIG_PROFILE" =~ ^mt7621|^newifi.*d2|^r6220 ]]; then
            echo "# MT7621è®¾å¤‡ä¿®å¤" >> .config
            echo "CONFIG_TARGET_ramips=y" >> .config
            echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
            echo "CONFIG_KERNEL_MIPS=y" >> .config
          fi
          
          # 2. é€šç”¨å†…æ ¸ä¿®å¤
          echo "# é€šç”¨å†…æ ¸ä¿®å¤" >> .config
          echo "CONFIG_KERNEL_DEVTMPFS=y" >> .config
          echo "CONFIG_KERNEL_DEVTMPFS_MOUNT=y" >> .config
          echo "CONFIG_KERNEL_LZO=y" >> .config
          echo "CONFIG_KERNEL_LZ4=y" >> .config
          echo "CONFIG_KERNEL_ZSTD=y" >> .config
          echo "CONFIG_KERNEL_EXT4_FS=y" >> .config
          echo "CONFIG_KERNEL_VFAT_FS=y" >> .config
          echo "CONFIG_KERNEL_TMPFS=y" >> .config
          echo "CONFIG_KERNEL_NET=y" >> .config
          echo "CONFIG_KERNEL_INET=y" >> .config
          echo "CONFIG_KERNEL_IPV6=y" >> .config
          
          # 3. é€šç”¨ç›®å½•ç»“æ„ä¿®å¤
          echo "ğŸ”§ ä¿®å¤é€šç”¨æ„å»ºç›®å½•ç»“æ„..." | tee -a "$MAIN_LOG"
          mkdir -p /mnt/source/{build_dir,staging_dir,bin,tmp,logs,dl}
          mkdir -p /mnt/source/build_dir/{host,target-*}
          mkdir -p /mnt/source/staging_dir/{host,target-*,toolchain-*}
          
          # åˆ›å»ºé€šç”¨ç›®æ ‡æ¶æ„ç›®å½•ç»“æ„
          for arch_dir in /mnt/source/build_dir/target-*; do
            if [ -d "$arch_dir" ]; then
              arch_name=$(basename "$arch_dir")
              mkdir -p "$arch_dir/root-"{ipq40xx,ramips,x86,armvirt,ath79,mediatek,qualcomm,realtek,bcm53xx,generic}
              
              for root_dir in "$arch_dir"/root-*; do
                if [ -d "$root_dir" ]; then
                  mkdir -p "$root_dir"/{bin,dev,etc,lib,proc,sbin,sys,tmp,usr,var,www,overlay}
                  mkdir -p "$root_dir"/usr/{bin,sbin,lib,share,include}
                  mkdir -p "$root_dir"/etc/{init.d,config,uci-defaults,hotplug.d,rc.button}
                  mkdir -p "$root_dir"/var/{lock,run,log,tmp}
                  mkdir -p "$root_dir"/lib/{modules,firmware,netifd,upgrade}
                fi
              done
              
              mkdir -p "$arch_dir/linux-"{ipq40xx,ramips,x86,ath79}"_generic/linux-*/"
            fi
          done
          
          # åˆ›å»ºä¸»æœºå·¥å…·é“¾ç›®å½•
          mkdir -p /mnt/source/staging_dir/host/{bin,lib,include,share,usr}
          mkdir -p /mnt/source/build_dir/host/{cmake,pkg-config,automake,libtool}
          
          # åˆ›å»ºé€šç”¨åŒ…æ„å»ºç›®å½•
          mkdir -p /mnt/source/build_dir/{host,target-*}/{alsa-lib,busybox,dropbear,firewall,json-c,libubox,libuci,luci,mtdev,openvpn,opkg,procd,ubus,uci,uhttpd,wpad}
          
          # è®¾ç½®æ­£ç¡®çš„ç›®å½•æƒé™
          find /mnt/source/build_dir -type d -exec chmod 755 {} \; 2>/dev/null || true
          find /mnt/source/staging_dir -type d -exec chmod 755 {} \; 2>/dev/null || true
          find /mnt/source/bin -type d -exec chmod 755 {} \; 2>/dev/null || true
          
          # åˆ›å»ºç¬¦å·é“¾æ¥
          [ -L "/mnt/source/dl" ] || ln -sf /mnt/downloads /mnt/source/dl 2>/dev/null || true
          [ -L "/mnt/source/logs" ] || ln -sf /mnt/build-logs /mnt/source/logs 2>/dev/null || true
          
          # ä¿®å¤ç›®å½•æ‰€æœ‰æƒ
          chown -R $USER:$USER /mnt/source/build_dir /mnt/source/staging_dir /mnt/source/bin 2>/dev/null || true
          
          echo "âœ… æ™ºèƒ½æ„å»ºä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ“ æ„å»ºç›®å½•é¢„æ£€æŸ¥"
        id: dir_precheck
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“ æ„å»ºç›®å½•é¢„æ£€æŸ¥ ===" | tee -a "$MAIN_LOG"
          
          cd /mnt/source
          
          echo "ğŸ”§ æ‰§è¡Œé¢„ç¼–è¯‘ç›®å½•æ£€æŸ¥..." | tee -a "$MAIN_LOG"
          
          # åˆ›å»ºé€šç”¨æ„å»ºç›®å½•å‡½æ•°
          create_universal_build_dirs() {
            echo "ğŸ—ï¸ åˆ›å»ºé€šç”¨æ„å»ºç›®å½•..." | tee -a "$MAIN_LOG"
            
            local target_arch=$(find /mnt/source/build_dir -maxdepth 1 -name "target-*" -type d | head -1 | xargs basename 2>/dev/null || echo "target-unknown")
            local linux_arch=$(find /mnt/source/build_dir -maxdepth 1 -name "linux-*" -type d | head -1 | xargs basename 2>/dev/null || echo "linux-unknown")
            
            echo "  ğŸ“Š æ£€æµ‹åˆ°æ¶æ„: $target_arch, $linux_arch" | tee -a "$MAIN_LOG"
            
            local root_patterns=("ipq40xx" "ramips" "x86" "armvirt" "ath79" "mediatek" "qualcomm" "realtek" "bcm53xx" "generic")
            
            for pattern in "${root_patterns[@]}"; do
              local root_dir="/mnt/source/build_dir/$target_arch/root-$pattern"
              if [ ! -d "$root_dir" ]; then
                echo "  ğŸ“‚ åˆ›å»ºæ ¹ç›®å½•: root-$pattern" | tee -a "$MAIN_LOG"
                mkdir -p "$root_dir"
              fi
              
              local std_dirs=("bin" "dev" "etc" "lib" "proc" "sbin" "sys" "tmp" "usr" "var" "www" "overlay")
              for dir in "${std_dirs[@]}"; do
                mkdir -p "$root_dir/$dir"
              done
              
              mkdir -p "$root_dir/usr/"{bin,sbin,lib,share,include}
              mkdir -p "$root_dir/etc/"{init.d,config,uci-defaults,hotplug.d,rc.button}
              mkdir -p "$root_dir/var/"{lock,run,log,tmp}
              mkdir -p "$root_dir/lib/"{modules,firmware,netifd,upgrade}
            done
            
            find "/mnt/source/build_dir/$target_arch" -type d -exec chmod 755 {} \; 2>/dev/null || true
            
            echo "âœ… é€šç”¨ç›®å½•åˆ›å»ºå®Œæˆ" | tee -a "$MAIN_LOG"
          }
          
          create_universal_build_dirs
          
          # éªŒè¯å…³é”®ç›®å½•ï¼ˆbin/targetsåœ¨ç¼–è¯‘å‰ä¸å­˜åœ¨æ˜¯æ­£å¸¸çš„ï¼‰
          echo "ğŸ” éªŒè¯å…³é”®ç›®å½•..." | tee -a "$MAIN_LOG"
          critical_dirs=("build_dir" "staging_dir" "dl" "tmp")
          
          all_ok=true
          for dir in "${critical_dirs[@]}"; do
            if [ -d "$dir" ] && [ -w "$dir" ]; then
              echo "  âœ… $dir - å¯å†™" | tee -a "$MAIN_LOG"
            else
              echo "  âŒ $dir - é—®é¢˜" | tee -a "$MAIN_LOG"
              all_ok=false
            fi
          done
          
          # bin/targetsç›®å½•åœ¨ç¼–è¯‘å‰ä¸å­˜åœ¨æ˜¯æ­£å¸¸çš„
          if [ -d "bin/targets" ] && [ -w "bin/targets" ]; then
            echo "  âœ… bin/targets - å¯å†™" | tee -a "$MAIN_LOG"
          else
            echo "  â„¹ï¸ bin/targets - ç¼–è¯‘å‰ä¸å­˜åœ¨ï¼ˆæ­£å¸¸ï¼‰" | tee -a "$MAIN_LOG"
          fi
          
          if [ "$all_ok" = true ]; then
            echo "âœ… ç›®å½•é¢„æ£€æŸ¥é€šè¿‡" | tee -a "$MAIN_LOG"
          else
            echo "âš ï¸ ç›®å½•é¢„æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œä½†å°†ç»§ç»­æ„å»º" | tee -a "$MAIN_LOG"
          fi

      - name: "ğŸ” é…ç½®å®Œæ•´æ€§éªŒè¯"
        id: config_validation
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ” é…ç½®å®Œæ•´æ€§éªŒè¯ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ” éªŒè¯é…ç½®å®Œæ•´æ€§..." | tee -a "$MAIN_LOG"
          
          # è¿è¡Œdefconfigè§£å†³ä¾èµ–
          make defconfig
          
          # æ£€æŸ¥å…³é”®é…ç½®
          echo "ğŸ” å…³é”®é…ç½®æ£€æŸ¥:" | tee -a "$MAIN_LOG"
          [ "$(grep -c "CONFIG_TARGET.*=y" .config)" -gt 0 ] && echo "âœ… ç›®æ ‡é…ç½®æ­£å¸¸" || echo "âŒ ç›®æ ‡é…ç½®å¼‚å¸¸"
          [ "$(grep -c "CONFIG_PACKAGE_base-files=y" .config)" -gt 0 ] && echo "âœ… åŸºç¡€æ–‡ä»¶ç³»ç»Ÿæ­£å¸¸" || echo "âŒ åŸºç¡€æ–‡ä»¶ç³»ç»Ÿå¼‚å¸¸"
          [ "$(grep -c "CONFIG_PACKAGE_busybox=y" .config)" -gt 0 ] && echo "âœ… BusyBoxæ­£å¸¸" || echo "âŒ BusyBoxå¼‚å¸¸"
          
          echo "âœ… é…ç½®éªŒè¯å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ æ™ºèƒ½ç¼–è¯‘æ‰§è¡Œ"
        id: smart_build
        timeout-minutes: 150
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          ANALYSIS_REPORT="${{ env.ANALYSIS_REPORT }}"
          echo "=== âš¡ æ™ºèƒ½ç¼–è¯‘æ‰§è¡Œ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          
          echo "ğŸ”§ ç¼–è¯‘é…ç½®: å¹¶è¡Œä½œä¸š=$PARALLEL_JOBS" | tee -a "$MAIN_LOG"
          
          # ç¼–è¯‘å‰æœ€ç»ˆæ£€æŸ¥
          echo "ğŸ” ç¼–è¯‘å‰æœ€ç»ˆæ£€æŸ¥..." | tee -a "$MAIN_LOG"
          make defconfig
          
          mkdir -p logs
          
          # é€šç”¨ç›®å½•åˆ›å»ºå‡½æ•°
          create_universal_build_dirs() {
            echo "ğŸ—ï¸ åˆ›å»ºé€šç”¨æ„å»ºç›®å½•..." | tee -a "$MAIN_LOG"
            
            local target_arch=$(find /mnt/source/build_dir -maxdepth 1 -name "target-*" -type d | head -1 | xargs basename 2>/dev/null || echo "target-unknown")
            local root_patterns=("ipq40xx" "ramips" "x86" "armvirt" "ath79" "mediatek" "qualcomm" "realtek" "bcm53xx" "generic")
            
            for pattern in "${root_patterns[@]}"; do
              local root_dir="/mnt/source/build_dir/$target_arch/root-$pattern"
              mkdir -p "$root_dir"
              
              local std_dirs=("bin" "dev" "etc" "lib" "proc" "sbin" "sys" "tmp" "usr" "var" "www" "overlay")
              for dir in "${std_dirs[@]}"; do
                mkdir -p "$root_dir/$dir"
              done
              
              mkdir -p "$root_dir/usr/"{bin,sbin,lib,share,include}
              mkdir -p "$root_dir/etc/"{init.d,config,uci-defaults,hotplug.d,rc.button}
              mkdir -p "$root_dir/var/"{lock,run,log,tmp}
              mkdir -p "$root_dir/lib/"{modules,firmware,netifd,upgrade}
            done
            
            find "/mnt/source/build_dir/$target_arch" -type d -exec chmod 755 {} \; 2>/dev/null || true
            echo "âœ… é€šç”¨ç›®å½•åˆ›å»ºå®Œæˆ" | tee -a "$MAIN_LOG"
          }
          
          # ç¼–è¯‘å‡½æ•° - å¸¦é”™è¯¯åˆ†æå’Œæ¢å¤
          compile_with_recovery() {
            local stage_name="$1"
            local make_target="$2"
            local max_retries=2
            local retry_count=0
            
            while [ $retry_count -le $max_retries ]; do
              echo "ğŸ› ï¸ $stage_name (å°è¯• $((retry_count + 1))/$((max_retries + 1)))..." | tee -a "$MAIN_LOG"
              
              TEMP_LOG=$(mktemp)
              set +e
              if [ $retry_count -eq 0 ]; then
                make $make_target -j$PARALLEL_JOBS 2>&1 | tee "$TEMP_LOG"
              else
                make $make_target -j1 V=s 2>&1 | tee "$TEMP_LOG"
              fi
              local result=${PIPESTATUS[0]}
              set -e
              
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              
              if [ $result -eq 0 ]; then
                echo "âœ… $stage_name æˆåŠŸ" | tee -a "$MAIN_LOG"
                rm -f "$TEMP_LOG"
                return 0
              else
                echo "âŒ $stage_name å¤±è´¥" | tee -a "$MAIN_LOG"
                
                # é”™è¯¯åˆ†æ
                analyze_build_error "$stage_name" "$TEMP_LOG"
                
                if [ $retry_count -lt $max_retries ]; then
                  echo "ğŸ”„ å‡†å¤‡é‡è¯•..." | tee -a "$MAIN_LOG"
                  retry_count=$((retry_count + 1))
                  
                  # æ ¹æ®é”™è¯¯ç±»å‹åº”ç”¨ä¿®å¤
                  apply_error_fix "$stage_name" "$TEMP_LOG"
                else
                  echo "ğŸ’¥ $stage_name å½»åº•å¤±è´¥" | tee -a "$MAIN_LOG"
                  cat "$TEMP_LOG" >> "$ERROR_LOG"
                  rm -f "$TEMP_LOG"
                  return 1
                fi
              fi
              rm -f "$TEMP_LOG"
            done
          }
          
          # é”™è¯¯åˆ†æå‡½æ•°
          analyze_build_error() {
            local stage="$1"
            local log_file="$2"
            
            echo "ğŸ” åˆ†æ $stage é”™è¯¯..." | tee -a "$MAIN_LOG"
            echo "=== $stage é”™è¯¯åˆ†æ ===" >> "$ANALYSIS_REPORT"
            
            # å¸¸è§é”™è¯¯æ¨¡å¼è¯†åˆ«
            if grep -q "No rule to make target" "$log_file"; then
              echo "âŒ ç¼ºå¤±æ„å»ºç›®æ ‡" | tee -a "$MAIN_LOG"
              echo "é—®é¢˜: ç¼ºå¤±æ„å»ºç›®æ ‡" >> "$ANALYSIS_REPORT"
              echo "è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥ä¾èµ–å…³ç³»å’Œé…ç½®" >> "$ANALYSIS_REPORT"
            fi
            
            if grep -q "undefined reference" "$log_file"; then
              echo "âŒ é“¾æ¥é”™è¯¯" | tee -a "$MAIN_LOG"
              echo "é—®é¢˜: é“¾æ¥é”™è¯¯ - æœªå®šä¹‰å¼•ç”¨" >> "$ANALYSIS_REPORT"
              echo "è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥åº“ä¾èµ–å’Œé“¾æ¥é¡ºåº" >> "$ANALYSIS_REPORT"
            fi
            
            if grep -q "error:.*conflicting types" "$log_file"; then
              echo "âŒ ç±»å‹å†²çª" | tee -a "$MAIN_LOG"
              echo "é—®é¢˜: ç±»å‹å†²çªé”™è¯¯" >> "$ANALYSIS_REPORT"
              echo "è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥å¤´æ–‡ä»¶åŒ…å«å’Œç±»å‹å®šä¹‰" >> "$ANALYSIS_REPORT"
            fi
            
            if grep -q "No such file or directory" "$log_file"; then
              echo "âŒ æ–‡ä»¶ç¼ºå¤±" | tee -a "$MAIN_LOG"
              echo "é—®é¢˜: æ–‡ä»¶æˆ–ç›®å½•ä¸å­˜åœ¨" >> "$ANALYSIS_REPORT"
              echo "è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œä¾èµ–" >> "$ANALYSIS_REPORT"
            fi
            
            # æå–å…·ä½“é”™è¯¯ä¿¡æ¯
            local errors=$(grep -E "(error:|Error:|ERROR:)" "$log_file" | head -5)
            if [ -n "$errors" ]; then
              echo "ğŸ“‹ å…·ä½“é”™è¯¯:" | tee -a "$MAIN_LOG"
              echo "$errors" | tee -a "$MAIN_LOG"
              echo "å…·ä½“é”™è¯¯:" >> "$ANALYSIS_REPORT"
              echo "$errors" >> "$ANALYSIS_REPORT"
            fi
          }
          
          # é”™è¯¯ä¿®å¤å‡½æ•°
          apply_error_fix() {
            local stage="$1"
            local log_file="$2"
            
            echo "ğŸ”§ åº”ç”¨é”™è¯¯ä¿®å¤..." | tee -a "$MAIN_LOG"
            
            case "$stage" in
              "å·¥å…·é“¾ç¼–è¯‘")
                echo "ğŸ”„ æ¸…ç†å·¥å…·é“¾ç¼“å­˜..." | tee -a "$MAIN_LOG"
                make toolchain/clean
                ;;
              "å†…æ ¸ç¼–è¯‘")
                echo "ğŸ”„ æ¸…ç†å†…æ ¸æ„å»º..." | tee -a "$MAIN_LOG"
                make target/linux/clean
                
                # ä¸“é—¨ä¿®å¤æ„å»ºç›®å½•é—®é¢˜
                echo "ğŸ”§ ä¿®å¤å†…æ ¸æ„å»ºç›®å½•..." | tee -a "$MAIN_LOG"
                create_universal_build_dirs
                
                # ä¿®å¤opkgç¼ºå¤±é—®é¢˜ - æ›´å½»åº•çš„è§£å†³æ–¹æ¡ˆ
                echo "ğŸ”§ ä¿®å¤opkgå·¥å…·ç¼ºå¤±..." | tee -a "$MAIN_LOG"
                if [ ! -f "/mnt/source/staging_dir/host/bin/opkg" ]; then
                  echo "ğŸ”„ é‡æ–°ç¼–è¯‘å·¥å…·é“¾å’Œå®¿ä¸»å·¥å…·..." | tee -a "$MAIN_LOG"
                  make tools/install -j1 V=s
                  make toolchain/install -j1 V=s
                  if [ -f "/mnt/source/staging_dir/host/bin/opkg" ]; then
                    echo "âœ… opkgå·¥å…·ä¿®å¤æˆåŠŸ" | tee -a "$MAIN_LOG"
                  else
                    echo "âŒ opkgå·¥å…·ä¿®å¤å¤±è´¥" | tee -a "$MAIN_LOG"
                  fi
                fi
                ;;
              "å®Œæ•´ç¼–è¯‘")
                if grep -q "No such file or directory" "$log_file"; then
                  echo "ğŸ”§ ä¿®å¤ç¼ºå¤±ç›®å½•é”™è¯¯..." | tee -a "$MAIN_LOG"
                  create_universal_build_dirs
                fi
                ;;
            esac
          }
          
          # é˜¶æ®µ0: é¢„ç¼–è¯‘å®¿ä¸»å·¥å…·ï¼ˆè§£å†³opkgç¼ºå¤±é—®é¢˜ï¼‰
          echo "ğŸ”§ é¢„ç¼–è¯‘å®¿ä¸»å·¥å…·..." | tee -a "$MAIN_LOG"
          if ! compile_with_recovery "å®¿ä¸»å·¥å…·ç¼–è¯‘" "tools/install"; then
            echo "âš ï¸ å®¿ä¸»å·¥å…·ç¼–è¯‘æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ„å»º" | tee -a "$MAIN_LOG"
          fi
          
          # é˜¶æ®µ1: å·¥å…·é“¾ç¼–è¯‘
          if ! compile_with_recovery "å·¥å…·é“¾ç¼–è¯‘" "toolchain/install"; then
            echo "ğŸ’¥ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œæ„å»ºç»ˆæ­¢" | tee -a "$MAIN_LOG"
            exit 1
          fi
          
          # é˜¶æ®µ2: å†…æ ¸ç¼–è¯‘
          if ! compile_with_recovery "å†…æ ¸ç¼–è¯‘" "target/linux/install"; then
            echo "ğŸ’¥ å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œæ„å»ºç»ˆæ­¢" | tee -a "$MAIN_LOG"
            exit 1
          fi
          
          # é˜¶æ®µ3: å®Œæ•´ç¼–è¯‘
          if ! compile_with_recovery "å®Œæ•´ç¼–è¯‘" ""; then
            echo "ğŸ’¥ å®Œæ•´ç¼–è¯‘å¤±è´¥" | tee -a "$MAIN_LOG"
            exit 1
          fi
          
          # æ£€æŸ¥å›ºä»¶ç”Ÿæˆ
          FIRMWARE_FOUND=false
          if find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | grep -q .; then
            echo "ğŸ‰ æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼" | tee -a "$MAIN_LOG"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) -exec ls -la {} \; | tee -a "$MAIN_LOG"
            FIRMWARE_FOUND=true
            FIRMWARE_COUNT=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | wc -l)
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "FIRMWARE_COUNT=$FIRMWARE_COUNT" >> $GITHUB_ENV
          else
            echo "ğŸ’¥ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶" | tee -a "$MAIN_LOG"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "FIRMWARE_FOUND=$FIRMWARE_FOUND" >> $GITHUB_ENV
          
          echo "ğŸ“Š CCacheç»Ÿè®¡:" | tee -a "$MAIN_LOG"
          ccache -s | tee -a "$MAIN_LOG"
          
          echo "=== ç¼–è¯‘æ€»ç»“ ===" | tee -a "$MAIN_LOG"
          echo "æ„å»ºçŠ¶æ€: æˆåŠŸ" | tee -a "$MAIN_LOG"
          echo "å›ºä»¶ç”Ÿæˆ: æ˜¯" | tee -a "$MAIN_LOG"
          echo "å›ºä»¶æ•°é‡: $FIRMWARE_COUNT" | tee -a "$MAIN_LOG"

      - name: "ğŸ” è‡ªåŠ¨é”™è¯¯åˆ†æä¸æŠ¥å‘Š"
        id: error_analysis
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          ANALYSIS_REPORT="${{ env.ANALYSIS_REPORT }}"
          DOWNLOAD_LOG="${{ env.DOWNLOAD_LOG }}"
          echo "=== ğŸ” è‡ªåŠ¨é”™è¯¯åˆ†æä¸æŠ¥å‘Š ===" | tee -a "$MAIN_LOG"
          
          # ç”Ÿæˆé”™è¯¯åˆ†ææŠ¥å‘Š
          echo "# æ™ºèƒ½é”™è¯¯åˆ†ææŠ¥å‘Š" > "$ANALYSIS_REPORT"
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> "$ANALYSIS_REPORT"
          echo "" >> "$ANALYSIS_REPORT"
          
          # åˆ†ææ„å»ºçŠ¶æ€
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            echo "## ğŸ‰ æ„å»ºæˆåŠŸ" >> "$ANALYSIS_REPORT"
            echo "- çŠ¶æ€: æˆåŠŸå®Œæˆ" >> "$ANALYSIS_REPORT"
            echo "- å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}" >> "$ANALYSIS_REPORT"
          else
            echo "## âŒ æ„å»ºå¤±è´¥" >> "$ANALYSIS_REPORT"
            echo "- çŠ¶æ€: æ„å»ºå¤±è´¥" >> "$ANALYSIS_REPORT"
            
            # åˆ†æé”™è¯¯æ—¥å¿—
            if [ -f "$ERROR_LOG" ]; then
              echo "## ğŸ” é”™è¯¯åˆ†æ" >> "$ANALYSIS_REPORT"
              
              # å¸¸è§é”™è¯¯æ¨¡å¼è¯†åˆ«
              if grep -q "No rule to make target" "$ERROR_LOG"; then
                echo "### âŒ ç¼ºå¤±æ„å»ºç›®æ ‡" >> "$ANALYSIS_REPORT"
                echo "**é—®é¢˜**: ç¼–è¯‘ç³»ç»Ÿæ‰¾ä¸åˆ°æŒ‡å®šçš„æ„å»ºç›®æ ‡" >> "$ANALYSIS_REPORT"
                echo "**å¯èƒ½åŸå› **: åŒ…åé”™è¯¯ã€ä¾èµ–ç¼ºå¤±æˆ–é…ç½®é—®é¢˜" >> "$ANALYSIS_REPORT"
                echo "**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥.configæ–‡ä»¶ä¸­çš„åŒ…é…ç½®ï¼Œç¡®ä¿æ‰€æœ‰ä¾èµ–åŒ…å·²æ­£ç¡®å¯ç”¨" >> "$ANALYSIS_REPORT"
              fi
              
              if grep -q "undefined reference" "$ERROR_LOG"; then
                echo "### âŒ é“¾æ¥é”™è¯¯" >> "$ANALYSIS_REPORT"
                echo "**é—®é¢˜**: é“¾æ¥å™¨æ‰¾ä¸åˆ°ç¬¦å·å®šä¹‰" >> "$ANALYSIS_REPORT"
                echo "**å¯èƒ½åŸå› **: åº“æ–‡ä»¶ç¼ºå¤±ã€é“¾æ¥é¡ºåºé”™è¯¯æˆ–ABIä¸å…¼å®¹" >> "$ANALYSIS_REPORT"
                echo "**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥åº“ä¾èµ–å…³ç³»ï¼Œç¡®ä¿æ‰€æœ‰å¿…éœ€çš„åº“éƒ½å·²ç¼–è¯‘å¹¶æ­£ç¡®é“¾æ¥" >> "$ANALYSIS_REPORT"
              fi
              
              if grep -q "error:.*conflicting types" "$ERROR_LOG"; then
                echo "### âŒ ç±»å‹å†²çª" >> "$ANALYSIS_REPORT"
                echo "**é—®é¢˜**: æ•°æ®ç±»å‹å®šä¹‰å†²çª" >> "$ANALYSIS_REPORT"
                echo "**å¯èƒ½åŸå› **: å¤´æ–‡ä»¶é‡å¤åŒ…å«ã€å†…æ ¸ç‰ˆæœ¬ä¸åŒ¹é…" >> "$ANALYSIS_REPORT"
                echo "**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥å¤´æ–‡ä»¶åŒ…å«é¡ºåºï¼Œæ¸…ç†æ„å»ºç¼“å­˜" >> "$ANALYSIS_REPORT"
              fi
              
              # æå–å‰10ä¸ªé”™è¯¯
              echo "### ğŸ“‹ ä¸»è¦é”™è¯¯åˆ—è¡¨" >> "$ANALYSIS_REPORT"
              grep -E "(error:|Error:|ERROR:)" "$ERROR_LOG" | head -10 | while read -r error; do
                echo "- $error" >> "$ANALYSIS_REPORT"
              done
            fi
            
            echo "## ğŸ› ï¸ ä¿®å¤å»ºè®®" >> "$ANALYSIS_REPORT"
            echo "1. æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®" >> "$ANALYSIS_REPORT"
            echo "2. ç¡®ä¿æ‰€æœ‰ä¾èµ–åŒ…å·²æ­£ç¡®ä¸‹è½½" >> "$ANALYSIS_REPORT"
            echo "3. å°è¯•æ¸…ç†æ„å»ºç¼“å­˜: make clean" >> "$ANALYSIS_REPORT"
            echo "4. æ£€æŸ¥ç£ç›˜ç©ºé—´å’Œå†…å­˜æ˜¯å¦å……è¶³" >> "$ANALYSIS_REPORT"
          fi
          
          # ä¸‹è½½é—®é¢˜åˆ†æ
          if [ -f "$DOWNLOAD_LOG" ]; then
            echo "## ğŸŒ ä¸‹è½½é—®é¢˜åˆ†æ" >> "$ANALYSIS_REPORT"
            if grep -q "ç½‘ç»œè¶…æ—¶" "$DOWNLOAD_LOG"; then
              echo "### âŒ ç½‘ç»œè¿æ¥é—®é¢˜" >> "$ANALYSIS_REPORT"
              echo "**é—®é¢˜**: ä¸‹è½½è¿‡ç¨‹ä¸­å‡ºç°ç½‘ç»œè¶…æ—¶" >> "$ANALYSIS_REPORT"
              echo "**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå°è¯•ä½¿ç”¨ä»£ç†æˆ–æ›´æ¢é•œåƒæº" >> "$ANALYSIS_REPORT"
            fi
            
            if grep -q "DNSè§£æå¤±è´¥" "$DOWNLOAD_LOG"; then
              echo "### âŒ DNSè§£æé—®é¢˜" >> "$ANALYSIS_REPORT"
              echo "**é—®é¢˜**: æ— æ³•è§£æåŸŸå" >> "$ANALYSIS_REPORT"
              echo "**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥DNSè®¾ç½®ï¼Œå°è¯•ä½¿ç”¨å…¶ä»–DNSæœåŠ¡å™¨" >> "$ANALYSIS_REPORT"
            fi
            
            if grep -q "SSLè¯ä¹¦é—®é¢˜" "$DOWNLOAD_LOG"; then
              echo "### âŒ SSLè¯ä¹¦é—®é¢˜" >> "$ANALYSIS_REPORT"
              echo "**é—®é¢˜**: SSLè¯ä¹¦éªŒè¯å¤±è´¥" >> "$ANALYSIS_REPORT"
              echo "**è§£å†³æ–¹æ¡ˆ**: æ›´æ–°CAè¯ä¹¦æˆ–ä¸´æ—¶ç¦ç”¨SSLéªŒè¯" >> "$ANALYSIS_REPORT"
            fi
            
            DOWNLOAD_RETRIES=$(grep -c "ä¸‹è½½å°è¯•" "$DOWNLOAD_LOG" 2>/dev/null || echo 0)
            echo "### ğŸ“Š ä¸‹è½½ç»Ÿè®¡" >> "$ANALYSIS_REPORT"
            echo "- ä¸‹è½½é‡è¯•æ¬¡æ•°: $DOWNLOAD_RETRIES" >> "$ANALYSIS_REPORT"
            echo "- æœ€ç»ˆä¸‹è½½æ–‡ä»¶æ•°: ${{ env.DOWNLOAD_FILE_COUNT || 0 }}" >> "$ANALYSIS_REPORT"
          fi
          
          # ç³»ç»Ÿèµ„æºæŠ¥å‘Š
          echo "## ğŸ“Š ç³»ç»Ÿèµ„æºæŠ¥å‘Š" >> "$ANALYSIS_REPORT"
          echo "\`\`\`" >> "$ANALYSIS_REPORT"
          echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:" >> "$ANALYSIS_REPORT"
          df -h >> "$ANALYSIS_REPORT" 2>/dev/null || echo "ç£ç›˜ä½¿ç”¨æƒ…å†µè·å–å¤±è´¥" >> "$ANALYSIS_REPORT"
          echo "" >> "$ANALYSIS_REPORT"
          echo "å†…å­˜ä½¿ç”¨æƒ…å†µ:" >> "$ANALYSIS_REPORT"
          free -h >> "$ANALYSIS_REPORT" 2>/dev/null || echo "å†…å­˜ä½¿ç”¨æƒ…å†µè·å–å¤±è´¥" >> "$ANALYSIS_REPORT"
          echo "\`\`\`" >> "$ANALYSIS_REPORT"
          
          echo "âœ… é”™è¯¯åˆ†ææŠ¥å‘Šç”Ÿæˆå®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¦ æé€Ÿäº§ç‰©æ”¶é›†"
        id: collect_artifacts
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¦ æé€Ÿäº§ç‰©æ”¶é›† ===" | tee -a "$MAIN_LOG"
          
          mkdir -p /mnt/artifacts/firmware
          ARTIFACT_COUNT=0
          
          if [ -d "/mnt/source/bin/targets" ]; then
            find /mnt/source/bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) -exec cp {} /mnt/artifacts/firmware/ \;
            ARTIFACT_COUNT=$(ls /mnt/artifacts/firmware/ 2>/dev/null | wc -l || echo 0)
          fi
          
          cp "$MAIN_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$ERROR_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$WARNING_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$ANALYSIS_REPORT" /mnt/artifacts/ 2>/dev/null || true
          cp "$DOWNLOAD_LOG" /mnt/artifacts/ 2>/dev/null || true
          
          # æ”¶é›†é…ç½®æ–‡ä»¶å’Œæ„å»ºä¿¡æ¯
          cp /mnt/source/.config /mnt/artifacts/ 2>/dev/null || true
          
          echo "ARTIFACT_COUNT=$ARTIFACT_COUNT" >> $GITHUB_ENV
          echo "âœ… æ”¶é›†äº† $ARTIFACT_COUNT ä¸ªäº§ç‰©" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¤ æäº¤æ–°é…ç½®æ–‡ä»¶åˆ°ä»“åº“"
        id: commit_config
        if: env.CONFIG_SOURCE == 'new' && github.event.inputs.auto_commit_config == 'true'
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¤ æäº¤æ–°é…ç½®æ–‡ä»¶åˆ°ä»“åº“ ===" | tee -a "$MAIN_LOG"
          
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          CONFIG_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/configs"
          CONFIG_FILE="$CONFIG_DIR/config_$CONFIG_PROFILE"
          
          if [ -f "$CONFIG_FILE" ]; then
            echo "ğŸ“ æ‰¾åˆ°æ–°åˆ›å»ºçš„é…ç½®æ–‡ä»¶: $CONFIG_FILE" | tee -a "$MAIN_LOG"
            
            # åˆ‡æ¢åˆ°é…ç½®ä»“åº“ç›®å½•
            cd "${{ env.CONFIG_REPO_DIR }}"
            
            # é…ç½®Gitç”¨æˆ·
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            
            # æ·»åŠ é…ç½®æ–‡ä»¶
            git add "firmware-config/configs/config_$CONFIG_PROFILE"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
            if git diff --staged --quiet; then
              echo "â„¹ï¸ æ²¡æœ‰æ–°çš„é…ç½®æ–‡ä»¶éœ€è¦æäº¤" | tee -a "$MAIN_LOG"
            else
              # æäº¤æ›´æ”¹
              COMMIT_MSG="æ·»åŠ æ–°çš„è®¾å¤‡é…ç½®æ–‡ä»¶: $CONFIG_PROFILE"
              if [ -n "${{ env.TARGET_CONFIG }}" ]; then
                COMMIT_MSG="$COMMIT_MSG (ç›®æ ‡: ${{ env.TARGET_CONFIG }})"
              fi
              git commit -m "$COMMIT_MSG"
              echo "âœ… é…ç½®æ–‡ä»¶å·²æäº¤åˆ°æœ¬åœ°ä»“åº“: $COMMIT_MSG" | tee -a "$MAIN_LOG"
              
              # æ¨é€åˆ°è¿œç¨‹ä»“åº“
              echo "ğŸ”„ æ¨é€åˆ°è¿œç¨‹ä»“åº“..." | tee -a "$MAIN_LOG"
              git push
              echo "âœ… é…ç½®æ–‡ä»¶å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“" | tee -a "$MAIN_LOG"
            fi
          else
            echo "â„¹ï¸ æ²¡æœ‰åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶" | tee -a "$MAIN_LOG"
          fi

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
        id: upload_artifacts
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Build-Artifacts-${{ github.run_number }}"
          path: |
            /mnt/artifacts
          retention-days: 7
          compression-level: 6

      - name: "ğŸ“Š æ™ºèƒ½æ„å»ºæŠ¥å‘Š"
        id: final_report
        if: always()
        run: |
          echo "=== ğŸ“Š æ™ºèƒ½æ„å»ºæŠ¥å‘Š ==="
          echo ""
          echo "ğŸ¯ æ„å»ºæ‘˜è¦"
          echo "=========================================="
          echo "âš¡ ç¼–è¯‘æ€§èƒ½:"
          echo "  - å¹¶è¡Œä½œä¸š: ${{ env.PARALLEL_JOBS || 'N/A' }}"
          echo "  - æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - ä¸‹è½½é‡è¯•: ${{ env.DOWNLOAD_RETRY_COUNT || 'N/A' }}"
          echo ""
          echo "ğŸ“¦ æ„å»ºç»“æœ:"
          echo "  - å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - äº§ç‰©æ•°é‡: ${{ env.ARTIFACT_COUNT || 0 }}"
          echo "  - ä¸‹è½½æ–‡ä»¶: ${{ env.DOWNLOAD_FILE_COUNT || 0 }}"
          echo ""
          echo "ğŸ”§ é…ç½®ä¿¡æ¯:"
          echo "  - é…ç½®æ¥æº: ${{ env.CONFIG_SOURCE || 'unknown' }}"
          echo "  - ç›®æ ‡é…ç½®: ${{ env.TARGET_CONFIG || 'unknown' }}"
          echo "  - æ„å»ºæ¨¡å¼: ${{ github.event.inputs.build_mode || 'unknown' }}"
          echo ""
          echo "ğŸ”§ é«˜çº§åŠŸèƒ½:"
          echo "  - è‡ªå®šä¹‰IPK: ${{ env.CUSTOM_IPK_COUNT || 0 }} ä¸ª"
          echo "  - è‡ªå®šä¹‰è„šæœ¬: ${{ env.CUSTOM_SCRIPT_COUNT || 0 }} ä¸ª"
          echo "  - é¢å¤–è½¯ä»¶åŒ…: ${{ env.EXTRA_PACKAGES_ADDED || 0 }} ä¸ª"
          echo "  - è‡ªå®šä¹‰æ’ä»¶: ${{ env.CUSTOM_PLUGINS_ADDED || 0 }} ä¸ª"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ] && [ "${{ env.FIRMWARE_COUNT }}" -gt 0 ]; then
            echo "ğŸ‰ æ™ºèƒ½æ„å»ºæˆåŠŸï¼"
            echo "ğŸ’¡ å›ºä»¶å·²ç”Ÿæˆå¹¶ä¸Šä¼ åˆ°äº§ç‰©"
            if [ "${{ env.CONFIG_SOURCE }}" = "new" ] && [ "${{ github.event.inputs.auto_commit_config }}" = "true" ]; then
              echo "ğŸ“ æ–°é…ç½®æ–‡ä»¶å·²è‡ªåŠ¨æäº¤åˆ°ä»“åº“"
            fi
          else
            echo "âŒ æ„å»ºå¤±è´¥æˆ–æœªç”Ÿæˆå›ºä»¶"
            echo "ğŸ”§ è¯·æŸ¥çœ‹é”™è¯¯åˆ†ææŠ¥å‘Šäº†è§£è¯¦ç»†é—®é¢˜"
            if [ "${{ env.DOWNLOAD_RETRY_COUNT }}" -gt 3 ]; then
              echo "ğŸŒ ç½‘ç»œé—®é¢˜: ä¸‹è½½è¿‡ç¨‹å¤šæ¬¡é‡è¯•ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥"
            fi
          fi
          echo "=========================================="
