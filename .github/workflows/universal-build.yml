name: "Universal Firmware Builder - Enhanced Validation Version"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "auto"
        type: string
      config_profile:
        description: "è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„"
        required: true
        type: string
        default: ".config_rt-ac42u_immortalwrt"
      build_optimization:
        description: "ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥"
        required: true
        type: choice
        options: ["balanced", "speed", "stability"]
        default: "balanced"
      toolchain_strategy:
        description: "å·¥å…·é“¾ç­–ç•¥"
        required: true
        type: choice
        options: ["prebuilt", "local", "auto"]
        default: "auto"
      enable_custom_features:
        description: "å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½"
        required: false
        default: true
        type: boolean
      fix_common_issues:
        description: "è‡ªåŠ¨ä¿®å¤å¸¸è§é—®é¢˜"
        required: false
        default: true
        type: boolean
      enable_pre_download:
        description: "å¯ç”¨é¢„ä¸‹è½½éªŒè¯"
        required: false
        default: true
        type: boolean
      enable_post_verify:
        description: "å¯ç”¨ç¼–è¯‘åéªŒè¯"
        required: false
        default: true
        type: boolean
      debug_mode:
        description: "å¯ç”¨è°ƒè¯•æ¨¡å¼"
        required: false
        default: false
        type: boolean

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"
  TOOLCHAIN_LOG_DIR: "/mnt/toolchain-logs"
  DEBUG_MODE: "${{ github.event.inputs.debug_mode }}"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 360
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"
        with:
          path: "."
          fetch-depth: 0

      - name: "ğŸ” æ™ºèƒ½æ–‡ä»¶å‘ç°ä¸é…ç½®è§£æ"
        id: "config-parser"
        run: |
          echo "=== ğŸ” æ™ºèƒ½æ–‡ä»¶å‘ç°ä¸é…ç½®è§£æ ==="
          echo "ğŸ“‹ æŸ¥æ‰¾ repositories.json æ–‡ä»¶..."
          REPO_JSON_FOUND=""
          SEARCH_PATHS=(".", "..", "$GITHUB_WORKSPACE", "configs", "../configs")
          
          for path in "${SEARCH_PATHS[@]}"; do
            if [ -f "$path/repositories.json" ]; then
              REPO_JSON_FOUND="$path/repositories.json"
              FILE_SIZE=$(du -h "$REPO_JSON_FOUND" | cut -f1)
              echo "âœ… åœ¨è·¯å¾„ '$path' æ‰¾åˆ° repositories.json ($FILE_SIZE)"
              break
            fi
          done
          
          if [ -z "$REPO_JSON_FOUND" ]; then
            echo "ğŸ” ç²¾ç¡®æŸ¥æ‰¾å¤±è´¥ï¼Œå°è¯•æ¨¡ç³Šæœç´¢..."
            REPO_JSON_FOUND=$(find . -maxdepth 3 -name "*repositories*.json" -type f 2>/dev/null | head -1)
            if [ -n "$REPO_JSON_FOUND" ]; then
              FILE_SIZE=$(du -h "$REPO_JSON_FOUND" | cut -f1)
              echo "âœ… æ¨¡ç³Šæœç´¢æ‰¾åˆ°: $REPO_JSON_FOUND ($FILE_SIZE)"
            fi
          fi
          
          if [ -z "$REPO_JSON_FOUND" ]; then
            echo "ğŸ” å°è¯•å…¨ç›®å½•æ·±åº¦æœç´¢..."
            REPO_JSON_FOUND=$(find . -name "*repositories*.json" -type f 2>/dev/null | head -1)
            if [ -n "$REPO_JSON_FOUND" ]; then
              FILE_SIZE=$(du -h "$REPO_JSON_FOUND" | cut -f1)
              echo "âœ… æ·±åº¦æœç´¢æ‰¾åˆ°: $REPO_JSON_FOUND ($FILE_SIZE)"
            else
              echo "âŒ æ‰€æœ‰æœç´¢å°è¯•éƒ½å¤±è´¥ï¼Œè¯·ç¡®ä¿ repositories.json æ–‡ä»¶å­˜åœ¨"
              find . -maxdepth 2 -type d -exec ls -la {} \; 2>/dev/null | head -20
              exit 1
            fi
          fi
          
          echo "REPO_JSON_PATH=$REPO_JSON_FOUND" >> $GITHUB_ENV
          DEFAULT_REPO=$(jq -r '.defaults.repository' "$REPO_JSON_FOUND" 2>/dev/null || echo "immortalwrt")
          CUSTOM_FEATURES_DIR=$(jq -r '.custom_features_support.features_directory' "$REPO_JSON_FOUND" 2>/dev/null || echo "firmware-config/custom-features")
          echo "DEFAULT_REPO=$DEFAULT_REPO" >> $GITHUB_ENV
          echo "CUSTOM_FEATURES_DIR=$CUSTOM_FEATURES_DIR" >> $GITHUB_ENV
          echo "âœ… é…ç½®æ–‡ä»¶è§£æå®Œæˆ"

      - name: "ğŸ’¾ æ™ºèƒ½ç³»ç»Ÿèµ„æºåˆ†æ"
        timeout-minutes: 2
        run: |
          echo "=== ğŸ’¾ æ™ºèƒ½ç³»ç»Ÿèµ„æºåˆ†æ ==="
          echo "ğŸ“Š ç³»ç»Ÿä¿¡æ¯:"
          echo "ğŸ·ï¸ ç³»ç»Ÿç‰ˆæœ¬: $(lsb_release -d | cut -f2)"
          echo "ğŸ§ å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
          echo "ğŸ’» CPU æ¶æ„: $(uname -m)"
          echo "ğŸ“Š ç£ç›˜ç©ºé—´åˆ†æ:"
          df -h | grep -E '(/|/mnt)' | while read line; do echo "  $line"; done
          echo "ğŸ’» CPU èµ„æº:"
          echo "  - æ ¸å¿ƒæ•°: $(nproc)"
          echo "  - CPUå‹å·: $(grep -m1 'model name' /proc/cpuinfo | cut -d: -f2 | xargs)"
          echo "ğŸ§  å†…å­˜ä¿¡æ¯:"
          free -h
          ROOT_AVAILABLE=$(df / | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          MEM_AVAILABLE=$(free -g | awk 'NR==2 {print int($7)}')
          echo "ğŸ“ˆ èµ„æºçŠ¶æ€:"
          echo "  - æ ¹åˆ†åŒºå¯ç”¨: ${ROOT_AVAILABLE}GB"
          echo "  - å¯ç”¨å†…å­˜: ${MEM_AVAILABLE}GB"
          if [ "$ROOT_AVAILABLE" -lt 5 ]; then
            echo "ğŸš¨ è­¦å‘Š: æ ¹åˆ†åŒºç©ºé—´ä¸è¶³5GBï¼Œå¯èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§"
          fi
          if [ "$MEM_AVAILABLE" -lt 2 ]; then
            echo "ğŸš¨ è­¦å‘Š: å¯ç”¨å†…å­˜ä¸è¶³2GBï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥"
          fi
          echo "âœ… èµ„æºåˆ†æå®Œæˆ"

      - name: "ğŸ’¾ å¢å¼ºå†…å­˜ç®¡ç†ä¸ç¯å¢ƒè®¾ç½®"
        timeout-minutes: 5
        run: |
          echo "=== ğŸ’¾ å¢å¼ºå†…å­˜ç®¡ç†ä¸ç¯å¢ƒè®¾ç½® ==="
          MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}' 2>/dev/null || echo 0)
          echo "/mnt åˆ†åŒºå¯ç”¨ç©ºé—´: ${MNT_AVAILABLE}GB"
          if [ "$MNT_AVAILABLE" -lt 20 ]; then
            echo "ğŸš¨ ä¸¥é‡é”™è¯¯: /mnt åˆ†åŒºç©ºé—´ä¸è¶³20GBï¼Œæ— æ³•ç¼–è¯‘"
            exit 1
          fi
          echo "ğŸ”„ åˆ›å»ºæ™ºèƒ½äº¤æ¢æ–‡ä»¶..."
          SWAP_SIZE="16G"
          if [ "$MNT_AVAILABLE" -gt 50 ]; then
            SWAP_SIZE="20G"
            echo "ğŸ’¡ æ£€æµ‹åˆ°å……è¶³ç©ºé—´ï¼Œä½¿ç”¨ ${SWAP_SIZE} äº¤æ¢æ–‡ä»¶"
          fi
          if [ -f /mnt/swapfile ]; then
            echo "ğŸ”„ æ¸…ç†ç°æœ‰äº¤æ¢æ–‡ä»¶..."
            sudo swapoff /mnt/swapfile 2>/dev/null || true
            sudo rm -f /mnt/swapfile 2>/dev/null || true
          fi
          echo "ğŸ“¦ åˆ›å»º ${SWAP_SIZE} äº¤æ¢æ–‡ä»¶..."
          sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=$(( ${SWAP_SIZE%G} * 1024 )) status=progress || sudo fallocate -l $SWAP_SIZE /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          echo "ğŸ“Š å½“å‰å†…å­˜çŠ¶æ€:"
          free -h
          echo "ğŸ”§ åˆ›å»ºå·¥ä½œç›®å½•ç»“æ„..."
          sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chown -R $USER:$USER ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chmod -R 755 ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }}
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          echo "âœ… ç¯å¢ƒè®¾ç½®å®Œæˆ"

      - name: "ğŸ› ï¸ æ™ºèƒ½ç¼–è¯‘ä¾èµ–å®‰è£…"
        timeout-minutes: 10
        run: |
          echo "=== ğŸ› ï¸ æ™ºèƒ½ç¼–è¯‘ä¾èµ–å®‰è£… ==="
          echo "ğŸ“¦ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          sudo apt-get update
          echo "ğŸ”§ å®‰è£…æ ¸å¿ƒç¼–è¯‘å·¥å…·..."
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib
          echo "ğŸ“š å®‰è£…å¼€å‘åº“..."
          sudo apt-get install -y gettext git libncurses5-dev libssl-dev python3 python3-pip
          sudo apt-get install -y rsync unzip zlib1g-dev file wget jq ccache
          sudo apt-get install -y libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build
          sudo apt-get install -y libelf-dev libssl-dev zlib1g-dev libxml2-dev liblzma-dev liblzo2-dev
          echo "ğŸŒ å®‰è£…ç½‘ç»œå·¥å…·..."
          sudo apt-get install -y axel curl wget net-tools
          CURRENT_GIT_VERSION=$(git --version | cut -d' ' -f3)
          echo "ğŸ” å½“å‰ Git ç‰ˆæœ¬: $CURRENT_GIT_VERSION"
          echo "ğŸ” éªŒè¯å…³é”®å·¥å…·å®‰è£…..."
          REQUIRED_TOOLS=("gcc" "g++" "make" "git" "curl" "wget" "python3" "cmake" "ninja")
          for tool in "${REQUIRED_TOOLS[@]}"; do
            if command -v $tool >/dev/null 2>&1; then
              version=$($tool --version 2>/dev/null | head -1 || echo "unknown")
              echo "âœ… $tool: $version"
            else
              echo "âŒ $tool: æœªå®‰è£…"
              exit 1
            fi
          done
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: "âš¡ é«˜çº§ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–"
        timeout-minutes: 3
        run: |
          echo "=== âš¡ é«˜çº§ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ– ==="
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          echo "ğŸ¯ ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥: $OPTIMIZATION_STRATEGY"
          case "$OPTIMIZATION_STRATEGY" in
            "speed")
              CCACHE_SIZE="12G"
              PARALLEL_JOBS=$(nproc)
              echo "ğŸš€ é€Ÿåº¦ä¼˜å…ˆæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}"
              ;;
            "stability")
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=$(( $(nproc) - 2 ))
              echo "ğŸ›¡ï¸ ç¨³å®šæ€§ä¼˜å…ˆæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}"
              ;;
            *)
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=$(( $(nproc) - 1 ))
              echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}"
              ;;
          esac
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache -M $CCACHE_SIZE
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=100000
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=$CCACHE_SIZE" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          echo "ğŸ“Š åˆå§‹CCacheç»Ÿè®¡:"
          ccache -s
          echo "ğŸ”§ ç³»ç»Ÿæ€§èƒ½è°ƒä¼˜..."
          echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
          echo "vm.vfs_cache_pressure=50" | sudo tee -a /etc/sysctl.conf
          echo "âœ… æ€§èƒ½ä¼˜åŒ–å®Œæˆ"

      - name: "ğŸ”§ æ™ºèƒ½æºç é…ç½®è§£æ"
        id: "source-config"
        run: |
          echo "=== ğŸ”§ æ™ºèƒ½æºç é…ç½®è§£æ ==="
          PRESET="${{ github.event.inputs.source_preset }}"
          REPO_JSON_PATH="${{ env.REPO_JSON_PATH }}"
          echo "ğŸ¯ æ­£åœ¨è§£æé¢„è®¾: $PRESET"
          if ! jq -e ".repositories.$PRESET" "$REPO_JSON_PATH" >/dev/null 2>&1; then
            echo "âŒ é”™è¯¯: é¢„è®¾ '$PRESET' åœ¨ repositories.json ä¸­ä¸å­˜åœ¨"
            jq -r '.repositories | keys_unsorted[]' "$REPO_JSON_PATH"
            exit 1
          fi
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_PATH")
          DESCRIPTION=$(jq -r ".repositories.$PRESET.description // \"æœªçŸ¥\"" "$REPO_JSON_PATH")
          RECOMMENDED_BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_PATH")
          STABLE_BRANCHES=$(jq -r ".repositories.$PRESET.stable_branches[]" "$REPO_JSON_PATH" 2>/dev/null | tr '\n' ' ' || echo "")
          FEATURES=$(jq -r ".repositories.$PRESET.features | to_entries | map(\"\(.key)=\(.value)\") | join(\", \")" "$REPO_JSON_PATH" 2>/dev/null || echo "æœªçŸ¥")
          NOTES=$(jq -r ".repositories.$PRESET.notes // \"æ— \"" "$REPO_JSON_PATH")
          BUILD_TIPS=$(jq -r ".repositories.$PRESET.build_tips // \"æ— \"" "$REPO_JSON_PATH")
          FEEDS_CONFIG=$(jq -r ".repositories.$PRESET.feeds_config | to_entries | map(\"\(.key)=\(.value)\") | join(\";\")" "$REPO_JSON_PATH" 2>/dev/null || echo "")
          BRANCH_FEEDS_MAPPING=$(jq -r ".repositories.$PRESET.branch_feeds_mapping | to_entries | map(\"\(.key)=\(.value)\") | join(\";\")" "$REPO_JSON_PATH" 2>/dev/null || echo "")
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH="$RECOMMENDED_BRANCH"
            echo "ğŸ¤– è‡ªåŠ¨é€‰æ‹©æ¨èåˆ†æ”¯: $BRANCH"
          else
            if [ -n "$STABLE_BRANCHES" ] && ! echo "$STABLE_BRANCHES" | grep -q "$BRANCH"; then
              echo "âš ï¸ è­¦å‘Š: æŒ‡å®šåˆ†æ”¯ '$BRANCH' ä¸åœ¨å·²çŸ¥ç¨³å®šåˆ†æ”¯åˆ—è¡¨ä¸­"
              echo "ğŸ“‹ æ¨èçš„ç¨³å®šåˆ†æ”¯: $STABLE_BRANCHES"
            fi
          fi
          echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
          echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "SOURCE_DESCRIPTION=$DESCRIPTION" >> $GITHUB_ENV
          echo "SOURCE_FEATURES=$FEATURES" >> $GITHUB_ENV
          echo "SOURCE_NOTES=$NOTES" >> $GITHUB_ENV
          echo "SOURCE_BUILD_TIPS=$BUILD_TIPS" >> $GITHUB_ENV
          echo "SOURCE_FEEDS_CONFIG=$FEEDS_CONFIG" >> $GITHUB_ENV
          echo "SOURCE_BRANCH_FEEDS_MAPPING=$BRANCH_FEEDS_MAPPING" >> $GITHUB_ENV
          echo "âœ… æºç é…ç½®è§£æå®Œæˆ"
          echo "ğŸ“¦ ä»“åº“è¯¦ç»†ä¿¡æ¯:"
          echo "  - URL: $SOURCE_URL"
          echo "  - æè¿°: $DESCRIPTION"
          echo "  - ä½¿ç”¨åˆ†æ”¯: $BRANCH"
          echo "  - æ¨èåˆ†æ”¯: $RECOMMENDED_BRANCH"
          echo "  - ç¨³å®šåˆ†æ”¯: $STABLE_BRANCHES"
          echo "  - ç‰¹æ€§: $FEATURES"
          echo "  - å¤‡æ³¨: $NOTES"
          echo "  - ç¼–è¯‘æç¤º: $BUILD_TIPS"

      - name: "ğŸ“¥ ä¸¥æ ¼æºç è·å–ä¸éªŒè¯"
        id: "clone-source"
        timeout-minutes: 20
        run: |
          echo "=== ğŸ“¥ ä¸¥æ ¼æºç è·å–ä¸éªŒè¯ ==="
          cd ${{ env.SOURCE_DIR }}
          REQUESTED_BRANCH="${{ env.SOURCE_BRANCH }}"
          SOURCE_URL="${{ env.SOURCE_URL }}"
          PRESET="${{ env.SOURCE_PRESET }}"
          echo "ğŸ¯ ç›®æ ‡ä»“åº“: $SOURCE_URL"
          echo "ğŸ¯ è¯·æ±‚åˆ†æ”¯: $REQUESTED_BRANCH"
          echo "ğŸ¯ é¢„è®¾ç±»å‹: $PRESET"
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œç›®å½•..."
          rm -rf .[!.]* * 2>/dev/null || true
          
          case "$PRESET" in
            "immortalwrt") BRANCH_STRATEGIES=("$REQUESTED_BRANCH" "openwrt-21.02" "openwrt-23.05" "master" "main") ;;
            "openwrt") BRANCH_STRATEGIES=("$REQUESTED_BRANCH" "main" "master" "v23.05.x" "v22.03.x") ;;
            "lede") BRANCH_STRATEGIES=("$REQUESTED_BRANCH" "master" "main") ;;
            *) BRANCH_STRATEGIES=("$REQUESTED_BRANCH" "master" "main") ;;
          esac
          
          BRANCH_STRATEGIES=($(printf "%s\n" "${BRANCH_STRATEGIES[@]}" | sort -u))
          echo "ğŸ”„ å°†å°è¯•çš„åˆ†æ”¯ç­–ç•¥: ${BRANCH_STRATEGIES[*]}"
          
          CLONE_SUCCESS=false
          for branch in "${BRANCH_STRATEGIES[@]}"; do
            echo "ğŸ”„ å°è¯•åˆ†æ”¯: $branch"
            rm -rf .[!.]* * 2>/dev/null || true
            
            MAX_CLONE_RETRIES=2
            for ((retry=1; retry<=MAX_CLONE_RETRIES; retry++)); do
              echo "ğŸ“¥ å…‹éš†å°è¯• $retry/$MAX_CLONE_RETRIES..."
              if git clone --depth 1 --branch "$branch" "$SOURCE_URL" . 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/clone-$branch-attempt$retry.log; then
                break
              else
                echo "âŒ å…‹éš†å°è¯• $retry å¤±è´¥"
                if [ $retry -eq $MAX_CLONE_RETRIES ]; then
                  continue 2
                fi
                sleep 3
              fi
            done
            
            if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
              ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
              COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
              COMMIT_DATE=$(git log -1 --format=%ci 2>/dev/null || echo "unknown")
              COMMIT_MESSAGE=$(git log -1 --format=%s 2>/dev/null || echo "unknown")
              echo "âœ… å…‹éš†æˆåŠŸ!"
              echo "ğŸ“Š å…‹éš†è¯¦æƒ…:"
              echo "  - å®é™…åˆ†æ”¯: $ACTUAL_BRANCH"
              echo "  - æäº¤å“ˆå¸Œ: $COMMIT_HASH"
              echo "  - æäº¤æ—¶é—´: $COMMIT_DATE"
              echo "  - æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"
              
              REQUIRED_FILES=("scripts/feeds" "rules.mk" "Config.in" "Makefile" "include/image.mk" "target/linux/Makefile")
              MISSING_FILES=0
              for file in "${REQUIRED_FILES[@]}"; do
                if [ ! -f "$file" ]; then
                  echo "âŒ å¿…éœ€æ–‡ä»¶ '$file' ä¸å­˜åœ¨"
                  MISSING_FILES=$((MISSING_FILES+1))
                else
                  echo "âœ… æ–‡ä»¶ '$file' å­˜åœ¨"
                fi
              done
              
              if [ $MISSING_FILES -eq 0 ]; then
                CLONE_SUCCESS=true
                break
              else
                echo "âŒ ç¼ºå¤± $MISSING_FILES ä¸ªå¿…éœ€æ–‡ä»¶ï¼Œå°è¯•ä¸‹ä¸€ä¸ªåˆ†æ”¯"
                continue
              fi
            else
              echo "âŒ ä»“åº“ç»“æ„ä¸å®Œæ•´ï¼Œå°è¯•ä¸‹ä¸€ä¸ªåˆ†æ”¯"
              continue
            fi
          done
          
          if [ "$CLONE_SUCCESS" = "false" ]; then
            echo "âŒ æ‰€æœ‰åˆ†æ”¯ç­–ç•¥éƒ½å¤±è´¥ï¼Œå°è¯•é»˜è®¤åˆ†æ”¯..."
            rm -rf .[!.]* * 2>/dev/null || true
            if git clone --depth 1 "$SOURCE_URL" . 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/clone-default.log; then
              if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
                ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
                COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
                COMMIT_DATE=$(git log -1 --format=%ci 2>/dev/null || echo "unknown")
                COMMIT_MESSAGE=$(git log -1 --format=%s 2>/dev/null || echo "unknown")
                echo "âœ… é»˜è®¤åˆ†æ”¯å…‹éš†æˆåŠŸ"
                CLONE_SUCCESS=true
              fi
            fi
          fi
          
          if [ "$CLONE_SUCCESS" = "false" ]; then
            echo "âŒ æ‰€æœ‰å…‹éš†ç­–ç•¥éƒ½å¤±è´¥"
            echo "ğŸ” æœ€åé”™è¯¯æ—¥å¿—:"
            tail -50 ${{ env.BUILD_LOG_DIR }}/clone-*.log 2>/dev/null || echo "æ— æ—¥å¿—æ–‡ä»¶"
            exit 1
          fi
          
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
          echo "âœ… æºç è·å–ä¸éªŒè¯å®Œæˆ"

      - name: "ğŸ”„ ä¸¥æ ¼æºç åˆå§‹åŒ–ä¸Feedsä¿®å¤"
        timeout-minutes: 30
        run: |
          echo "=== ğŸ”„ ä¸¥æ ¼æºç åˆå§‹åŒ–ä¸Feedsä¿®å¤ ==="
          cd ${{ env.SOURCE_DIR }}
          if [ ! -f "scripts/feeds" ]; then
            echo "âŒ é”™è¯¯: scripts/feeds æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          SOURCE_PRESET="${{ env.SOURCE_PRESET }}"
          ACTUAL_BRANCH="${{ env.ACTUAL_BRANCH }}"
          FEEDS_CONFIG="${{ env.SOURCE_FEEDS_CONFIG }}"
          BRANCH_FEEDS_MAPPING="${{ env.SOURCE_BRANCH_FEEDS_MAPPING }}"
          echo "ğŸ“¦ æºç ç±»å‹: $SOURCE_PRESET, å®é™…åˆ†æ”¯: $ACTUAL_BRANCH"
          
          echo "ğŸ¯ ç”Ÿæˆæ™ºèƒ½Feedsé…ç½®..."
          FEEDS_BRANCH=""
          if [ -n "$BRANCH_FEEDS_MAPPING" ]; then
            IFS=';' read -ra MAPPINGS <<< "$BRANCH_FEEDS_MAPPING"
            for mapping in "${MAPPINGS[@]}"; do
              IFS='=' read -r branch_name feeds_branch <<< "$mapping"
              if [ "$branch_name" = "$ACTUAL_BRANCH" ]; then
                FEEDS_BRANCH="$feeds_branch"
                echo "ğŸ”§ æ£€æµ‹åˆ°åˆ†æ”¯æ˜ å°„: $ACTUAL_BRANCH -> $FEEDS_BRANCH"
                break
              fi
            done
          fi
          
          if [ -n "$FEEDS_CONFIG" ]; then
            echo "ğŸ“‹ ä½¿ç”¨é¢„è®¾Feedsé…ç½®..."
            rm -f feeds.conf
            IFS=';' read -ra FEED_ITEMS <<< "$FEEDS_CONFIG"
            for item in "${FEED_ITEMS[@]}"; do
              IFS='=' read -r feed_name feed_url <<< "$item"
              if [ -n "$FEEDS_BRANCH" ] && [[ "$feed_url" == *"github.com"* ]] && [[ "$feed_url" != *";"* ]]; then
                echo "src-git $feed_name $feed_url;$FEEDS_BRANCH" >> feeds.conf
              else
                echo "src-git $feed_name $feed_url" >> feeds.conf
              fi
            done
          else
            echo "ğŸ“‹ ä½¿ç”¨é»˜è®¤Feedsé…ç½®..."
            case "$SOURCE_PRESET" in
              "immortalwrt")
                BRANCH_SUFFIX=""
                if [ -n "$FEEDS_BRANCH" ]; then
                  BRANCH_SUFFIX=";$FEEDS_BRANCH"
                elif [[ "$ACTUAL_BRANCH" == *"21.02"* ]]; then
                  BRANCH_SUFFIX=";openwrt-21.02"
                elif [[ "$ACTUAL_BRANCH" == *"23.05"* ]]; then
                  BRANCH_SUFFIX=";openwrt-23.05"
                fi
                echo "src-git packages https://github.com/immortalwrt/packages.git$BRANCH_SUFFIX" > feeds.conf
                echo "src-git luci https://github.com/immortalwrt/luci.git$BRANCH_SUFFIX" >> feeds.conf
                echo "src-git routing https://github.com/immortalwrt/routing.git$BRANCH_SUFFIX" >> feeds.conf
                echo "src-git telephony https://github.com/immortalwrt/telephony.git$BRANCH_SUFFIX" >> feeds.conf
                ;;
              "openwrt")
                echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
                echo "src-git luci https://git.openwrt.org/project/luci.git" >> feeds.conf
                echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
                echo "src-git telephony https://git.openwrt.org/feed/telephony.git" >> feeds.conf
                ;;
              "lede")
                echo "src-git packages https://github.com/coolsnowwolf/packages.git" > feeds.conf
                echo "src-git luci https://github.com/coolsnowwolf/luci.git" >> feeds.conf
                echo "src-git routing https://github.com/coolsnowwolf/routing.git" >> feeds.conf
                echo "src-git telephony https://github.com/coolsnowwolf/telephony.git" >> feeds.conf
                ;;
            esac
          fi
          
          echo "ğŸ“‹ Feedsé…ç½®å†…å®¹:"
          cat feeds.conf
          
          echo "ğŸ”„ å¼€å§‹ä¸¥æ ¼Feedsæ›´æ–°..."
          MAX_RETRIES=3
          RETRY_COUNT=0
          FEEDS_SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ å°è¯•æ›´æ–°Feeds (ç¬¬ $((RETRY_COUNT+1)) æ¬¡)..."
            FEEDS_UPDATE_LOG="${{ env.BUILD_LOG_DIR }}/feeds-update-$RETRY_COUNT.log"
            
            if ./scripts/feeds update -a 2>&1 | tee "$FEEDS_UPDATE_LOG"; then
              if grep -q "Updated" "$FEEDS_UPDATE_LOG" || grep -q "Create index" "$FEEDS_UPDATE_LOG"; then
                echo "âœ… Feedsæ›´æ–°æˆåŠŸ!"
                FEEDS_SUCCESS=true
                break
              else
                echo "âš ï¸ Feedsæ›´æ–°æ— è¾“å‡ºï¼Œå¯èƒ½å¤±è´¥"
              fi
            else
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "âš ï¸ Feedsæ›´æ–°å¤±è´¥ï¼Œå‡†å¤‡é‡è¯• ($RETRY_COUNT/$MAX_RETRIES)..."
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep 5
                if [ $RETRY_COUNT -eq 1 ]; then
                  echo "ğŸ”„ å°è¯•ä½¿ç”¨GitHubé•œåƒæº..."
                  sed -i 's|git.openwrt.org|github.com/openwrt|g' feeds.conf
                  sed -i 's|https://git.openwrt.org/|https://github.com/openwrt/|g' feeds.conf
                  echo "ğŸ“‹ æ›´æ–°åçš„Feedsé…ç½®:"
                  cat feeds.conf
                fi
              fi
            fi
          done
          
          if [ "$FEEDS_SUCCESS" = "false" ]; then
            echo "âŒ Feedsæ›´æ–°å¤±è´¥ï¼Œå°è¯•æœ€å°åŒ–feedsé…ç½®..."
            echo "src-git packages https://github.com/openwrt/packages.git" > feeds.conf
            echo "src-git luci https://github.com/openwrt/luci.git" >> feeds.conf
            if ! ./scripts/feeds update -a 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/feeds-update-minimal.log; then
              echo "âŒ æœ€å°åŒ–feedsé…ç½®ä¹Ÿå¤±è´¥"
              if [ -f "${{ env.BUILD_LOG_DIR }}/feeds-update-0.log" ]; then
                echo "ğŸ” è¯¦ç»†é”™è¯¯:"
                grep -n -i -A3 -B3 "error\|failed\|not found" ${{ env.BUILD_LOG_DIR }}/feeds-update-0.log | head -20
              fi
              exit 1
            fi
          fi
          
          echo "ğŸ“¦ å®‰è£…Feeds..."
          if ! ./scripts/feeds install -a 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/feeds-install.log; then
            echo "âš ï¸ Feedså®‰è£…æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
          fi
          
          echo "ğŸ” éªŒè¯Feedså®‰è£…..."
          if [ -d "feeds/packages" ] && [ -d "feeds/luci" ]; then
            echo "âœ… Feedså®‰è£…éªŒè¯é€šè¿‡"
            PACKAGE_COUNT=$(find feeds/packages -name "Makefile" 2>/dev/null | wc -l)
            LUCI_COUNT=$(find feeds/luci -name "Makefile" 2>/dev/null | wc -l)
            echo "ğŸ“Š Feedsç»Ÿè®¡:"
            echo "  - åŒ…æ•°é‡: $PACKAGE_COUNT"
            echo "  - LuCIåº”ç”¨æ•°é‡: $LUCI_COUNT"
          else
            echo "âŒ Feedså®‰è£…éªŒè¯å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… æºç åˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸ¯ ä¸¥æ ¼é…ç½®æ–‡ä»¶æœç´¢ä¸åº”ç”¨"
        timeout-minutes: 5
        run: |
          echo "=== ğŸ¯ ä¸¥æ ¼é…ç½®æ–‡ä»¶æœç´¢ä¸åº”ç”¨ ==="
          cd ${{ env.SOURCE_DIR }}
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "ğŸ” ä¸¥æ ¼æŸ¥æ‰¾é…ç½®æ–‡ä»¶: $CONFIG_PROFILE"
          
          CONFIG_FOUND=""
          SEARCH_PATHS=(".configs" "configs" "$GITHUB_WORKSPACE" "$GITHUB_WORKSPACE/configs" "../configs" "../.configs")
          
          for path in "${SEARCH_PATHS[@]}"; do
            if [ -f "$path/$CONFIG_PROFILE" ]; then
              CONFIG_FOUND="$path/$CONFIG_PROFILE"
              FILE_SIZE=$(du -h "$CONFIG_FOUND" | cut -f1)
              echo "âœ… åœ¨è·¯å¾„ '$path' æ‰¾åˆ°é…ç½®æ–‡ä»¶ ($FILE_SIZE)"
              break
            fi
          done
          
          if [ -z "$CONFIG_FOUND" ]; then
            echo "ğŸ” åœ¨é…ç½®ä»“åº“ä¸­æ·±åº¦æœç´¢..."
            CONFIG_FOUND=$(find "$GITHUB_WORKSPACE" -maxdepth 4 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            if [ -n "$CONFIG_FOUND" ]; then
              FILE_SIZE=$(du -h "$CONFIG_FOUND" | cut -f1)
              echo "âœ… åœ¨é…ç½®ä»“åº“ä¸­æ‰¾åˆ°: $CONFIG_FOUND ($FILE_SIZE)"
            fi
          fi
          
          if [ -z "$CONFIG_FOUND" ]; then
            echo "ğŸ” æœç´¢é…ç½®æ–‡ä»¶å˜ä½“..."
            CONFIG_VARIANTS=("$CONFIG_PROFILE" ".config_$CONFIG_PROFILE" "${CONFIG_PROFILE}.config" "config_$CONFIG_PROFILE")
            for variant in "${CONFIG_VARIANTS[@]}"; do
              FOUND=$(find "$GITHUB_WORKSPACE" -maxdepth 3 -name "$variant" -type f 2>/dev/null | head -1)
              if [ -n "$FOUND" ]; then
                CONFIG_FOUND="$FOUND"
                FILE_SIZE=$(du -h "$CONFIG_FOUND" | cut -f1)
                echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶å˜ä½“: $CONFIG_FOUND ($FILE_SIZE)"
                break
              fi
            done
          fi
          
          if [ -z "$CONFIG_FOUND" ]; then
            echo "ğŸ” æœç´¢ä»»ä½•.configæ–‡ä»¶..."
            CONFIG_FOUND=$(find "$GITHUB_WORKSPACE" -maxdepth 3 -name "*.config*" -type f 2>/dev/null | grep -v "node_modules\|feeds" | head -1)
            if [ -n "$CONFIG_FOUND" ]; then
              FILE_SIZE=$(du -h "$CONFIG_FOUND" | cut -f1)
              echo "âš ï¸ ä½¿ç”¨æ‰¾åˆ°çš„é»˜è®¤é…ç½®æ–‡ä»¶: $CONFIG_FOUND ($FILE_SIZE)"
            fi
          fi
          
          if [ -n "$CONFIG_FOUND" ] && [ -f "$CONFIG_FOUND" ]; then
            if grep -q "CONFIG_" "$CONFIG_FOUND" && (grep -q "CONFIG_TARGET" "$CONFIG_FOUND" || grep -q "CONFIG_PACKAGE" "$CONFIG_FOUND"); then
              echo "ğŸ“‹ å¤åˆ¶é…ç½®æ–‡ä»¶: $CONFIG_FOUND -> .config"
              cp "$CONFIG_FOUND" .config
              CONFIG_LINES=$(wc -l < .config)
              TARGET_CONFIGS=$(grep -c "CONFIG_TARGET" .config || true)
              PACKAGE_CONFIGS=$(grep -c "CONFIG_PACKAGE" .config || true)
              echo "âœ… é…ç½®æ–‡ä»¶åº”ç”¨å®Œæˆ"
              echo "ğŸ“Š é…ç½®æ–‡ä»¶ä¿¡æ¯:"
              echo "  - æ€»è¡Œæ•°: $CONFIG_LINES"
              echo "  - ç›®æ ‡é…ç½®: $TARGET_CONFIGS"
              echo "  - åŒ…é…ç½®: $PACKAGE_CONFIGS"
            else
              echo "âŒ é”™è¯¯: æ‰¾åˆ°çš„æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„é…ç½®æ–‡ä»¶"
              head -10 "$CONFIG_FOUND"
              exit 1
            fi
          else
            echo "âŒ é”™è¯¯: æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„é…ç½®æ–‡ä»¶ '$CONFIG_PROFILE'"
            exit 1
          fi

      - name: "ğŸ”§ ä¸¥æ ¼ç£ç›˜ç©ºé—´ä¼˜åŒ–"
        timeout-minutes: 5
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ”§ ä¸¥æ ¼ç£ç›˜ç©ºé—´ä¼˜åŒ– ==="
          
          # æ£€æŸ¥å½“å‰ç£ç›˜ç©ºé—´
          echo "ğŸ“Š å½“å‰ç£ç›˜ç©ºé—´çŠ¶æ€:"
          df -h | grep -E '(/|/mnt)'
          AVAILABLE_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "å¯ç”¨ç©ºé—´: ${AVAILABLE_SPACE}GB"
          
          # è®¾ç½®æ›´ä¿å®ˆçš„åˆ†åŒºå¤§å°
          echo "ğŸ”§ è®¾ç½®ä¿å®ˆåˆ†åŒºå¤§å°..."
          cp .config .config.backup
          
          # ä¿®å¤åˆ†åŒºå¤§å°é…ç½®
          sed -i 's/CONFIG_TARGET_KERNEL_PARTSIZE=.*/CONFIG_TARGET_KERNEL_PARTSIZE=16/' .config 2>/dev/null || echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> .config
          sed -i 's/CONFIG_TARGET_ROOTFS_PARTSIZE=.*/CONFIG_TARGET_ROOTFS_PARTSIZE=64/' .config 2>/dev/null || echo "CONFIG_TARGET_ROOTFS_PARTSIZE=64" >> .config
          
          # ç¦ç”¨è°ƒè¯•ä¿¡æ¯ä»¥èŠ‚çœç©ºé—´
          echo "# CONFIG_DEBUG_INFO is not set" >> .config
          echo "# CONFIG_KERNEL_DEBUG_INFO is not set" >> .config
          echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> .config
          
          # ä¼˜åŒ–ç¼–è¯‘é€‰é¡¹
          echo "CONFIG_SMALL_FLASH=y" >> .config
          echo "CONFIG_KERNEL_KALLSYMS=n" >> .config
          
          echo "âœ… ç£ç›˜ç©ºé—´ä¼˜åŒ–å®Œæˆ"

      - name: "ğŸ”§ ä¸¥æ ¼è®¾å¤‡é•œåƒé…ç½®ä¿®å¤"
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ”§ ä¸¥æ ¼è®¾å¤‡é•œåƒé…ç½®ä¿®å¤ ==="
          echo "ğŸ” éªŒè¯å½“å‰è®¾å¤‡é…ç½®..."
          if grep -q "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u" .config; then
            echo "âœ… æ‰¾åˆ° ASUS RT-AC42U è®¾å¤‡é…ç½®"
            sed -i 's/# CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u is not set/CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y/' .config
          else
            echo "ğŸ”§ æ·»åŠ  ASUS RT-AC42U è®¾å¤‡é…ç½®"
            echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> .config
          fi
          
          REQUIRED_CONFIGS=("CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" "CONFIG_TARGET_IMAGES_GZIP=y" "CONFIG_TARGET_ipq40xx=y" "CONFIG_TARGET_ipq40xx_generic=y")
          
          for config in "${REQUIRED_CONFIGS[@]}"; do
            config_name=$(echo "$config" | cut -d'=' -f1)
            if ! grep -q "$config_name" .config; then
              echo "ğŸ”§ æ·»åŠ ç¼ºå¤±é…ç½®: $config"
              echo "$config" >> .config
            fi
          done
          
          echo "ğŸ”„ è¿è¡Œä¸¥æ ¼defconfig..."
          if ! make defconfig 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/defconfig.log; then
            echo "âš ï¸ defconfig æœ‰è­¦å‘Šï¼Œæ£€æŸ¥é…ç½®..."
          fi
          
          if grep -q "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" .config; then
            echo "âœ… ASUS RT-AC42U è®¾å¤‡é…ç½®éªŒè¯é€šè¿‡"
          else
            echo "âŒ ASUS RT-AC42U è®¾å¤‡é…ç½®éªŒè¯å¤±è´¥"
            exit 1
          fi
          echo "âœ… è®¾å¤‡é•œåƒé…ç½®ä¸¥æ ¼ä¿®å¤å®Œæˆ"

      - name: "ğŸ“¦ å¢å¼ºè‡ªå®šä¹‰åŠŸèƒ½å¤„ç†"
        if: github.event.inputs.enable_custom_features == 'true'
        timeout-minutes: 15
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ“¦ å¢å¼ºè‡ªå®šä¹‰åŠŸèƒ½å¤„ç† ==="
          CONFIG_REPO_DIR="$GITHUB_WORKSPACE"
          CUSTOM_FEATURES_DIR="$CONFIG_REPO_DIR/${{ env.CUSTOM_FEATURES_DIR }}"
          
          echo "ğŸ” æœç´¢è‡ªå®šä¹‰åŠŸèƒ½ç›®å½•..."
          if [ -d "$CUSTOM_FEATURES_DIR" ]; then
            CUSTOM_DIR_SIZE=$(du -sh "$CUSTOM_FEATURES_DIR" | cut -f1)
            echo "âœ… æ‰¾åˆ°è‡ªå®šä¹‰åŠŸèƒ½ç›®å½• ($CUSTOM_DIR_SIZE)"
            
            if [ -d "$CUSTOM_FEATURES_DIR/prebuilt-ipks" ]; then
              echo "ğŸ“¦ å¤„ç†é¢„æ„å»ºIPKåŒ…..."
              IPK_FILES=$(find "$CUSTOM_FEATURES_DIR/prebuilt-ipks" -name "*.ipk" 2>/dev/null)
              IPK_COUNT=$(echo "$IPK_FILES" | wc -l)
              echo "ğŸ“Š æ‰¾åˆ° $IPK_COUNT ä¸ªIPKæ–‡ä»¶"
              
              if [ "$IPK_COUNT" -gt 0 ]; then
                mkdir -p package/base-files/files/usr/lib/opkg/custom
                echo "$IPK_FILES" | while read ipk; do
                  ipk_size=$(du -h "$ipk" | cut -f1)
                  echo "å¤åˆ¶: $(basename "$ipk") ($ipk_size)"
                  cp "$ipk" package/base-files/files/usr/lib/opkg/custom/
                done
                
                COPIED_COUNT=$(find package/base-files/files/usr/lib/opkg/custom -name "*.ipk" 2>/dev/null | wc -l)
                echo "âœ… æˆåŠŸå¤åˆ¶ $COPIED_COUNT ä¸ªIPKåŒ…"
                
                mkdir -p package/base-files/files/etc/uci-defaults
                echo '#!/bin/sh' > package/base-files/files/etc/uci-defaults/99-custom-ipks
                echo '[ -d "/usr/lib/opkg/custom" ] && {' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
                echo '    for ipk in /usr/lib/opkg/custom/*.ipk; do' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
                echo '        [ -f "$ipk" ] && opkg install "$ipk"' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
                echo '    done' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
                echo '}' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
                echo 'exit 0' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
                chmod +x package/base-files/files/etc/uci-defaults/99-custom-ipks
                echo "âœ… åˆ›å»ºIPKè‡ªåŠ¨å®‰è£…è„šæœ¬"
              else
                echo "â„¹ï¸ prebuilt-ipks ç›®å½•ä¸ºç©º"
              fi
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ° prebuilt-ipks ç›®å½•"
            fi
            
            if [ -d "$CUSTOM_FEATURES_DIR/scripts" ]; then
              echo "ğŸ”§ å¤„ç†è‡ªå®šä¹‰è„šæœ¬..."
              SCRIPT_FILES=$(find "$CUSTOM_FEATURES_DIR/scripts" -name "*.sh" 2>/dev/null)
              SCRIPT_COUNT=$(echo "$SCRIPT_FILES" | wc -l)
              echo "ğŸ“Š æ‰¾åˆ° $SCRIPT_COUNT ä¸ªè„šæœ¬æ–‡ä»¶"
              
              if [ "$SCRIPT_COUNT" -gt 0 ]; then
                echo "ğŸ”„ è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™å¹¶æ‰§è¡Œ..."
                echo "$SCRIPT_FILES" | while read script; do
                  chmod +x "$script"
                  script_size=$(du -h "$script" | cut -f1)
                  echo "è®¾ç½®æƒé™: $(basename "$script") ($script_size)"
                done
                
                echo "$SCRIPT_FILES" | sort | while read script; do
                  echo "æ‰§è¡Œè„šæœ¬: $(basename "$script")"
                  if bash "$script" 2>&1; then
                    echo "âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ: $(basename "$script")"
                  else
                    echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥: $(basename "$script")"
                  fi
                done
              else
                echo "â„¹ï¸ scripts ç›®å½•ä¸ºç©º"
              fi
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ° scripts ç›®å½•"
            fi
            
            if [ -d "$CUSTOM_FEATURES_DIR/patches" ]; then
              echo "ğŸ©¹ å¤„ç†è‡ªå®šä¹‰è¡¥ä¸..."
              PATCH_FILES=$(find "$CUSTOM_FEATURES_DIR/patches" -name "*.patch" 2>/dev/null)
              PATCH_COUNT=$(echo "$PATCH_FILES" | wc -l)
              echo "ğŸ“Š æ‰¾åˆ° $PATCH_COUNT ä¸ªè¡¥ä¸æ–‡ä»¶"
              
              if [ "$PATCH_COUNT" -gt 0 ]; then
                echo "$PATCH_FILES" | sort | while read patch; do
                  patch_size=$(du -h "$patch" | cut -f1)
                  echo "åº”ç”¨è¡¥ä¸: $(basename "$patch") ($patch_size)"
                  if patch -p1 --forward -r - < "$patch" 2>&1; then
                    echo "âœ… è¡¥ä¸åº”ç”¨æˆåŠŸ: $(basename "$patch")"
                  else
                    echo "âš ï¸ è¡¥ä¸åº”ç”¨å¯èƒ½æœ‰é—®é¢˜: $(basename "$patch")"
                  fi
                done
              else
                echo "â„¹ï¸ patches ç›®å½•ä¸ºç©º"
              fi
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ° patches ç›®å½•"
            fi
            
            if [ -d "$CUSTOM_FEATURES_DIR/configs" ]; then
              echo "âš™ï¸ å¤„ç†è‡ªå®šä¹‰é…ç½®..."
              CONFIG_FILES=$(find "$CUSTOM_FEATURES_DIR/configs" -type f 2>/dev/null)
              CONFIG_COUNT=$(echo "$CONFIG_FILES" | wc -l)
              echo "ğŸ“Š æ‰¾åˆ° $CONFIG_COUNT ä¸ªé…ç½®æ–‡ä»¶"
              
              if [ "$CONFIG_COUNT" -gt 0 ]; then
                echo "$CONFIG_FILES" | while read config; do
                  rel_path=$(realpath --relative-to="$CUSTOM_FEATURES_DIR/configs" "$config")
                  target_dir="package/base-files/files/$(dirname "$rel_path")"
                  mkdir -p "$target_dir"
                  config_size=$(du -h "$config" | cut -f1)
                  cp "$config" "$target_dir/"
                  echo "âœ… å¤åˆ¶é…ç½®: $rel_path ($config_size)"
                done
              else
                echo "â„¹ï¸ configs ç›®å½•ä¸ºç©º"
              fi
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ° configs ç›®å½•"
            fi
            
            echo "ğŸ‰ è‡ªå®šä¹‰åŠŸèƒ½å¤„ç†å®Œæˆ"
          else
            echo "â„¹ï¸ æ— è‡ªå®šä¹‰åŠŸèƒ½ç›®å½•ï¼Œè·³è¿‡è¯¦ç»†å¤„ç†"
          fi
          echo "âœ… è‡ªå®šä¹‰åŠŸèƒ½å¤„ç†å®Œæˆ"

      - name: "ğŸ“¥ ä¸¥æ ¼é¢„ä¸‹è½½éªŒè¯"
        if: github.event.inputs.enable_pre_download == 'true'
        timeout-minutes: 45
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ“¥ ä¸¥æ ¼é¢„ä¸‹è½½éªŒè¯ ==="
          echo "ğŸ”§ è®¾ç½®ä¸‹è½½ç›®å½•..."
          mkdir -p ${{ env.DOWNLOAD_DIR }}
          [ -d "dl" ] && rm -rf dl
          ln -sf ${{ env.DOWNLOAD_DIR }} dl
          
          DOWNLOAD_LOG="${{ env.BUILD_LOG_DIR }}/download.log"
          MAX_DOWNLOAD_RETRIES=2
          DOWNLOAD_SUCCESS=false
          
          echo "ğŸ“¥ å¼€å§‹ä¸¥æ ¼é¢„ä¸‹è½½éªŒè¯..."
          echo "ğŸ”§ ä½¿ç”¨å¹¶è¡Œä¸‹è½½: ${{ env.PARALLEL_JOBS }} ä¸ªä»»åŠ¡"
          
          for ((retry=1; retry<=MAX_DOWNLOAD_RETRIES; retry++)); do
            echo "ğŸ”„ ä¸‹è½½å°è¯• $retry/$MAX_DOWNLOAD_RETRIES..."
            
            if make download -j${{ env.PARALLEL_JOBS }} V=sc 2>&1 | tee "$DOWNLOAD_LOG"; then
              if grep -q "Downloaded\|File already downloaded" "$DOWNLOAD_LOG"; then
                echo "âœ… ä¸‹è½½æˆåŠŸå®Œæˆ"
                DOWNLOAD_SUCCESS=true
                break
              else
                echo "âš ï¸ ä¸‹è½½æ— è¾“å‡ºï¼Œå¯èƒ½å¤±è´¥"
              fi
            else
              echo "âŒ ä¸‹è½½å°è¯• $retry å¤±è´¥"
              if [ $retry -lt $MAX_DOWNLOAD_RETRIES ]; then
                sleep 10
              fi
            fi
          done
          
          if [ "$DOWNLOAD_SUCCESS" = "false" ]; then
            echo "âš ï¸ å¹¶è¡Œä¸‹è½½å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ä¸‹è½½..."
            if make download -j1 V=s 2>&1 | tee -a "$DOWNLOAD_LOG"; then
              echo "âœ… å•çº¿ç¨‹ä¸‹è½½æˆåŠŸ"
              DOWNLOAD_SUCCESS=true
            else
              echo "âŒ æ‰€æœ‰ä¸‹è½½å°è¯•éƒ½å¤±è´¥"
              grep -i "error\|failed\|not found\|hash mismatch" "$DOWNLOAD_LOG" | head -20
              exit 1
            fi
          fi
          
          echo "ğŸ” ä¸¥æ ¼éªŒè¯ä¸‹è½½æ–‡ä»¶..."
          DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
          DOWNLOAD_SIZE=$(du -sh dl/ 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
          echo "ğŸ“Š ä¸‹è½½ç»“æœç»Ÿè®¡:"
          echo "  - æ–‡ä»¶æ•°é‡: $DOWNLOAD_COUNT"
          echo "  - æ€»å¤§å°: $DOWNLOAD_SIZE"
          
          if [ "$DOWNLOAD_COUNT" -lt 10 ]; then
            echo "âš ï¸ è­¦å‘Š: ä¸‹è½½çš„æ–‡ä»¶æ•°é‡è¾ƒå°‘ï¼Œå¯èƒ½æœ‰é—®é¢˜"
          else
            echo "âœ… ä¸‹è½½æ–‡ä»¶æ•°é‡æ­£å¸¸"
          fi
          
          KEY_FILES=("linux-*.tar.xz" "toolchain-*.tar.xz" "*.tar.gz" "*.tar.bz2")
          for pattern in "${KEY_FILES[@]}"; do
            files=$(find dl/ -name "$pattern" 2>/dev/null | head -5)
            if [ -n "$files" ]; then
              echo "âœ… æ‰¾åˆ°æ–‡ä»¶æ¨¡å¼: $pattern"
            else
              echo "âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶æ¨¡å¼: $pattern"
            fi
          done
          
          echo "âœ… ä¸¥æ ¼é¢„ä¸‹è½½éªŒè¯å®Œæˆ"

      - name: "ğŸ› ï¸ ç¨³å®šå·¥å…·é“¾ç¼–è¯‘"
        timeout-minutes: 120
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ› ï¸ ç¨³å®šå·¥å…·é“¾ç¼–è¯‘ ==="
          
          echo "ğŸ”§ è®¾ç½®ç¼–è¯‘ç¯å¢ƒ..."
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          ulimit -S -n 8192
          
          echo "ğŸ“¦ ç¬¬ä¸€æ­¥: ç¼–è¯‘åŸºç¡€å·¥å…·..."
          if ! make tools/install -j2 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/tools-compile.log; then
            echo "âš ï¸ åŸºç¡€å·¥å…·ç¼–è¯‘æœ‰è­¦å‘Šï¼Œç»§ç»­æ‰§è¡Œ..."
          fi
          
          echo "ğŸ”§ ç¬¬äºŒæ­¥: ç¨³å®šå·¥å…·é“¾ç¼–è¯‘..."
          MAX_RETRIES=3
          RETRY_COUNT=0
          TOOLCHAIN_SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$TOOLCHAIN_SUCCESS" = "false" ]; do
            echo "ğŸ”„ å·¥å…·é“¾ç¼–è¯‘å°è¯• $((RETRY_COUNT+1))/$MAX_RETRIES"
            
            # æ¸…ç†ä¹‹å‰çš„ç¼–è¯‘
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "ğŸ§¹ æ¸…ç†å·¥å…·é“¾..."
              make toolchain/clean 2>/dev/null || true
              sleep 5
            fi
            
            # æ ¹æ®é‡è¯•æ¬¡æ•°è°ƒæ•´å¹¶è¡Œä»»åŠ¡æ•°
            if [ $RETRY_COUNT -eq 0 ]; then
              JOBS=$(( ${{ env.PARALLEL_JOBS }} / 2 ))
            else
              JOBS=1
            fi
            
            TOOLCHAIN_LOG="${{ env.BUILD_LOG_DIR }}/toolchain-attempt-$RETRY_COUNT.log"
            echo "ğŸ”§ ä½¿ç”¨ $JOBS ä¸ªå¹¶è¡Œä»»åŠ¡ç¼–è¯‘å·¥å…·é“¾..."
            
            if make toolchain/compile -j$JOBS V=s 2>&1 | tee "$TOOLCHAIN_LOG"; then
              # éªŒè¯å·¥å…·é“¾æ˜¯å¦çœŸæ­£æˆåŠŸ
              if [ -f "staging_dir/toolchain-*/bin/*-gcc" ] || [ -d "staging_dir/toolchain-*/bin" ]; then
                echo "âœ… å·¥å…·é“¾ç¼–è¯‘éªŒè¯æˆåŠŸ!"
                TOOLCHAIN_SUCCESS=true
                break
              else
                echo "âš ï¸ ç¼–è¯‘å®Œæˆä½†å·¥å…·é“¾æ–‡ä»¶ä¸å®Œæ•´"
              fi
            else
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
              
              # åˆ†æå¤±è´¥åŸå› 
              if grep -q "No space left" "$TOOLCHAIN_LOG"; then
                echo "ğŸ’¾ å¤±è´¥åŸå› : ç£ç›˜ç©ºé—´ä¸è¶³"
                # æ¸…ç†ç¼“å­˜é‡Šæ”¾ç©ºé—´
                make dirclean 2>/dev/null || true
                rm -rf build_dir/toolchain-* 2>/dev/null || true
              fi
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "ğŸ”„ ç­‰å¾…10ç§’åé‡è¯•..."
                sleep 10
              fi
            fi
          done
          
          if [ "$TOOLCHAIN_SUCCESS" = "false" ]; then
            echo "âŒ æ‰€æœ‰å·¥å…·é“¾ç¼–è¯‘å°è¯•éƒ½å¤±è´¥"
            echo "ğŸ” æœ€åé”™è¯¯æ—¥å¿—:"
            tail -50 ${{ env.BUILD_LOG_DIR }}/toolchain-attempt-*.log 2>/dev/null || echo "æ— æ—¥å¿—æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"

      - name: "ğŸ” æ™ºèƒ½ç¼–è¯‘å‰æœ€ç»ˆéªŒè¯"
        timeout-minutes: 5
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ” æ™ºèƒ½ç¼–è¯‘å‰æœ€ç»ˆéªŒè¯ ==="
          
          echo "ğŸ” åˆ†çº§éªŒè¯æ‰€æœ‰å¿…è¦ç»„ä»¶..."
          
          # çº§åˆ«1: å…³é”®ç»„ä»¶éªŒè¯ï¼ˆå¤±è´¥åˆ™é€€å‡ºï¼‰
          CRITICAL_FAILED=0
          if [ ! -d "dl" ] || [ "$(find dl/ -type f 2>/dev/null | wc -l)" -lt 5 ]; then
            echo "âŒ å…³é”®é”™è¯¯: ä¸‹è½½æ–‡ä»¶ä¸è¶³"
            CRITICAL_FAILED=1
          else
            echo "âœ… ä¸‹è½½æ–‡ä»¶éªŒè¯é€šè¿‡"
          fi
          
          if [ ! -f ".config" ] || ! grep -q "CONFIG_TARGET" .config; then
            echo "âŒ å…³é”®é”™è¯¯: é…ç½®æ–‡ä»¶æ— æ•ˆ"
            CRITICAL_FAILED=1
          else
            echo "âœ… é…ç½®éªŒè¯é€šè¿‡"
          fi
          
          if [ $CRITICAL_FAILED -eq 1 ]; then
            echo "ğŸš¨ å…³é”®éªŒè¯å¤±è´¥ï¼Œæ— æ³•ç»§ç»­ç¼–è¯‘"
            exit 1
          fi
          
          # çº§åˆ«2: é‡è¦ç»„ä»¶éªŒè¯ï¼ˆå¤±è´¥åˆ™ä¿®å¤ï¼‰
          IMPORTANT_FAILED=0
          if [ ! -d "staging_dir/toolchain-" ] || [ -z "$(find staging_dir/toolchain-*/bin -name '*-gcc' 2>/dev/null | head -1)" ]; then
            echo "âš ï¸ é‡è¦è­¦å‘Š: å·¥å…·é“¾ä¸å®Œæ•´ï¼Œä½†å¯ä»¥å°è¯•ä¿®å¤"
            IMPORTANT_FAILED=1
            echo "TOOLCHAIN_REPAIR_NEEDED=true" >> $GITHUB_ENV
          else
            echo "âœ… å·¥å…·é“¾éªŒè¯é€šè¿‡"
          fi
          
          if [ ! -d "feeds/packages" ] || [ ! -d "feeds/luci" ]; then
            echo "âš ï¸ é‡è¦è­¦å‘Š: Feedsä¸å®Œæ•´"
            IMPORTANT_FAILED=1
          else
            echo "âœ… FeedséªŒè¯é€šè¿‡"
          fi
          
          # çº§åˆ«3: èµ„æºéªŒè¯ï¼ˆè­¦å‘Šä½†ä¸åœæ­¢ï¼‰
          AVAILABLE_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          if [ "$AVAILABLE_SPACE" -lt 10 ]; then
            echo "âš ï¸ èµ„æºè­¦å‘Š: ç£ç›˜ç©ºé—´ç´§å¼  (${AVAILABLE_SPACE}GB)"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³: ${AVAILABLE_SPACE}GB"
          fi
          
          SWAP_SIZE=$(free -g | awk 'NR==3 {print $2}')
          if [ "$SWAP_SIZE" -lt 4 ]; then
            echo "âš ï¸ èµ„æºè­¦å‘Š: äº¤æ¢ç©ºé—´è¾ƒå° (${SWAP_SIZE}GB)"
          else
            echo "âœ… äº¤æ¢ç©ºé—´å……è¶³: ${SWAP_SIZE}GB"
          fi
          
          if [ $IMPORTANT_FAILED -eq 0 ]; then
            echo "ğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼Œå¼€å§‹ç¼–è¯‘..."
            echo "READY_FOR_COMPILE=true" >> $GITHUB_ENV
          else
            echo "ğŸ”„ éœ€è¦ä¿®å¤åç»§ç»­ç¼–è¯‘..."
            echo "READY_FOR_COMPILE=with_warnings" >> $GITHUB_ENV
          fi

      - name: "ğŸš€ æ™ºèƒ½ç¼–è¯‘ä¸é‡è¯•æœºåˆ¶"
        if: env.READY_FOR_COMPILE
        timeout-minutes: 180
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸš€ æ™ºèƒ½ç¼–è¯‘ä¸é‡è¯•æœºåˆ¶ ==="
          
          # è®¾ç½®ç¯å¢ƒä¼˜åŒ–
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          ulimit -S -n 8192
          
          MAX_COMPILE_ATTEMPTS=2
          ATTEMPT=1
          COMPILE_SUCCESS=false
          
          while [ $ATTEMPT -le $MAX_COMPILE_ATTEMPTS ] && [ "$COMPILE_SUCCESS" = "false" ]; do
            echo "ğŸ”„ ç¼–è¯‘å°è¯• $ATTEMPT/$MAX_COMPILE_ATTEMPTS"
            
            # è°ƒæ•´å¹¶è¡Œä»»åŠ¡æ•°ï¼šç¬¬ä¸€æ¬¡ç”¨æ­£å¸¸ï¼Œç¬¬äºŒæ¬¡å‡å°‘
            if [ $ATTEMPT -eq 1 ]; then
              JOBS=${{ env.PARALLEL_JOBS }}
            else
              JOBS=$(( ${{ env.PARALLEL_JOBS }} / 2 ))
              echo "ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»º..."
              make target/linux-clean 2>/dev/null || true
              make package-cleanup 2>/dev/null || true
            fi
            
            COMPILE_LOG="${{ env.BUILD_LOG_DIR }}/compile-attempt-$ATTEMPT.log"
            echo "ğŸ”§ ä½¿ç”¨ $JOBS ä¸ªå¹¶è¡Œä»»åŠ¡ç¼–è¯‘..."
            
            if make -j$JOBS V=s 2>&1 | tee "$COMPILE_LOG"; then
              # éªŒè¯ç¼–è¯‘æ˜¯å¦çœŸæ­£æˆåŠŸ
              if [ -d "bin/targets" ] && find bin/targets -name "*.bin" 2>/dev/null | grep -q .; then
                echo "âœ… ç¼–è¯‘éªŒè¯æˆåŠŸ!"
                COMPILE_SUCCESS=true
                echo "BUILD_STATUS=success" >> $GITHUB_ENV
                break
              else
                echo "âš ï¸ ç¼–è¯‘å®Œæˆä½†æœªç”Ÿæˆå›ºä»¶æ–‡ä»¶"
              fi
            else
              echo "âŒ ç¼–è¯‘å°è¯• $ATTEMPT å¤±è´¥"
              ATTEMPT=$((ATTEMPT+1))
              
              if [ $ATTEMPT -le $MAX_COMPILE_ATTEMPTS ]; then
                echo "ğŸ”„ å‡†å¤‡é‡è¯•ç¼–è¯‘..."
                sleep 10
                
                # æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œä¸è¶³åˆ™æ¸…ç†
                AVAILABLE_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
                if [ "$AVAILABLE_SPACE" -lt 5 ]; then
                  echo "ğŸ§¹ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ‰§è¡Œæ·±åº¦æ¸…ç†..."
                  make dirclean 2>/dev/null || true
                fi
              fi
            fi
          done
          
          if [ "$COMPILE_SUCCESS" = "false" ]; then
            echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•éƒ½å¤±è´¥"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: "ğŸ¯ ä¸¥æ ¼å·¥å‚é•œåƒä¿éšœ"
        if: env.BUILD_STATUS == 'success'
        timeout-minutes: 25
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ¯ ä¸¥æ ¼å·¥å‚é•œåƒä¿éšœ ==="
          
          echo "ğŸ”§ ç¡®ä¿å·¥å‚é•œåƒé…ç½®..."
          # å¼ºåˆ¶å¯ç”¨å·¥å‚é•œåƒç”Ÿæˆ
          echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> .config
          echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> .config
          echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
          
          echo "ğŸ”„ é‡æ–°è¿è¡Œdefconfigç¡®ä¿é…ç½®ç”Ÿæ•ˆ..."
          make defconfig 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/factory-defconfig.log
          
          echo "ğŸ” æ£€æŸ¥å·¥å‚é•œåƒç”ŸæˆçŠ¶æ€..."
          ASUS_FACTORY=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -i factory || true)
          
          if [ -n "$ASUS_FACTORY" ]; then
            echo "âœ… å·¥å‚é•œåƒå·²ç”Ÿæˆ:"
            for img in $ASUS_FACTORY; do
              size=$(du -h "$img" | cut -f1)
              echo "  - $img ($size)"
            done
            echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°å·¥å‚é•œåƒï¼Œæ‰§è¡Œä¸“é—¨ç¼–è¯‘..."
            echo "ğŸ”„ ä¸“é—¨ç¼–è¯‘ç›®æ ‡è®¾å¤‡é•œåƒ..."
            
            # ä¸“é—¨ç¼–è¯‘å·¥å‚é•œåƒ
            make target/linux/install -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/factory-special.log || true
            
            # æœ€åå°è¯•å®Œæ•´ç›®æ ‡ç¼–è¯‘
            make target/install -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/factory-final.log || true
            
            ASUS_FACTORY_RETRY=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -i factory || true)
            if [ -n "$ASUS_FACTORY_RETRY" ]; then
              echo "âœ… å·¥å‚é•œåƒä¿®å¤æˆåŠŸ!"
              for img in $ASUS_FACTORY_RETRY; do
                size=$(du -h "$img" | cut -f1)
                echo "  - $img ($size)"
              done
              echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
            else
              echo "âŒ å·¥å‚é•œåƒç”Ÿæˆå¤±è´¥"
              echo "FACTORY_EXISTS=false" >> $GITHUB_ENV
            fi
          fi

      - name: "ğŸ” ç¼–è¯‘å®Œæ•´æ€§éªŒè¯"
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ” ç¼–è¯‘å®Œæ•´æ€§éªŒè¯ ==="
          
          echo "ğŸ” éªŒè¯ç¼–è¯‘å®Œæ•´æ€§..."
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          CRITICAL_FILES=(
            "staging_dir/toolchain-*/bin/*-gcc"
            "build_dir/target-*/linux-*/vmlinux"
            "build_dir/target-*/busybox-*/busybox"
            "build_dir/target-*/base-files-*/.built"
          )
          
          for file_pattern in "${CRITICAL_FILES[@]}"; do
            if ls $file_pattern >/dev/null 2>&1; then
              echo "âœ… $(basename $(ls $file_pattern 2>/dev/null | head -1)): å­˜åœ¨"
            else
              echo "âŒ $file_pattern: ç¼ºå¤±"
              echo "COMPILE_INTEGRITY_FAILED=true" >> $GITHUB_ENV
            fi
          done
          
          # æ£€æŸ¥æ ¹æ–‡ä»¶ç³»ç»Ÿç»„ä»¶
          if [ -d "build_dir/target-*/root-*" ]; then
            echo "âœ… æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•å­˜åœ¨"
          else
            echo "âŒ æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•ç¼ºå¤±"
            echo "COMPILE_INTEGRITY_FAILED=true" >> $GITHUB_ENV
          fi
          
          if [ "$COMPILE_INTEGRITY_FAILED" = "true" ]; then
            echo "ğŸš¨ ç¼–è¯‘å®Œæ•´æ€§éªŒè¯å¤±è´¥"
            exit 1
          else
            echo "ğŸ‰ ç¼–è¯‘å®Œæ•´æ€§éªŒè¯é€šè¿‡"
          fi

      - name: "ğŸ” ä¸¥æ ¼ç¼–è¯‘äº§ç‰©éªŒè¯"
        if: env.BUILD_STATUS == 'success'
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ğŸ” ä¸¥æ ¼ç¼–è¯‘äº§ç‰©éªŒè¯ ==="
          mkdir -p ${{ env.ARTIFACTS_DIR }}/firmware
          
          echo "ğŸ” ä¸¥æ ¼æœç´¢å›ºä»¶æ–‡ä»¶..."
          if [ -d "bin/targets" ]; then
            echo "âœ… æ‰¾åˆ°å›ºä»¶è¾“å‡ºç›®å½•"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) > ${{ env.ARTIFACTS_DIR }}/firmware-list.txt
            FIRMWARE_COUNT=$(wc -l < ${{ env.ARTIFACTS_DIR }}/firmware-list.txt)
            
            echo "ğŸ“¦ å¤åˆ¶ $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶..."
            COPIED_COUNT=0
            while IFS= read -r firmware; do
              if [ -f "$firmware" ]; then
                cp "$firmware" ${{ env.ARTIFACTS_DIR }}/firmware/ 2>/dev/null && COPIED_COUNT=$((COPIED_COUNT+1)) || true
              fi
            done < ${{ env.ARTIFACTS_DIR }}/firmware-list.txt
            
            echo "âœ… æˆåŠŸå¤åˆ¶ $COPIED_COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
            
            ASUS_FACTORY=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -i factory || true)
            ASUS_SYSUPGRADE=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -v factory || true)
            
            if [ -n "$ASUS_FACTORY" ]; then
              echo "âœ… å·¥å‚é•œåƒ:"
              for img in $ASUS_FACTORY; do
                size=$(du -h "$img" | cut -f1)
                echo "  - $(basename "$img") ($size)"
                cp "$img" ${{ env.ARTIFACTS_DIR }}/firmware/ 2>/dev/null || true
              done
            else
              echo "âŒ æœªæ‰¾åˆ°å·¥å‚é•œåƒ!"
            fi
            
            if [ -n "$ASUS_SYSUPGRADE" ]; then
              echo "âœ… å‡çº§é•œåƒ:"
              for img in $ASUS_SYSUPGRADE; do
                size=$(du -h "$img" | cut -f1)
                echo "  - $(basename "$img") ($size)"
              done
            else
              echo "âŒ æœªæ‰¾åˆ°å‡çº§é•œåƒ!"
            fi
            
            ARTIFACT_SIZE=$(du -sh ${{ env.ARTIFACTS_DIR }}/firmware/ 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            echo "ğŸ“¦ äº§ç‰©æ€»å¤§å°: $ARTIFACT_SIZE"
          else
            echo "âŒ æœªæ‰¾åˆ°å›ºä»¶è¾“å‡ºç›®å½•"
          fi
          
          FINAL_COUNT=$(find ${{ env.ARTIFACTS_DIR }}/firmware -type f 2>/dev/null | wc -l || echo 0)
          echo "FIRMWARE_COUNT=$FINAL_COUNT" >> $GITHUB_ENV
          echo "ğŸ“Š æœ€ç»ˆå›ºä»¶æ•°é‡: $FINAL_COUNT"
          
          if [ "$FINAL_COUNT" -eq 0 ]; then
            echo "âŒ é”™è¯¯: æ²¡æœ‰ç”Ÿæˆä»»ä½•å›ºä»¶æ–‡ä»¶"
            exit 1
          else
            echo "âœ… å›ºä»¶ç”ŸæˆéªŒè¯é€šè¿‡"
          fi

      - name: "ğŸ“‹ ä¸¥æ ¼æ—¥å¿—æ”¶é›†ä¸åˆ†æ"
        if: always()
        timeout-minutes: 8
        run: |
          echo "=== ğŸ“‹ ä¸¥æ ¼æ—¥å¿—æ”¶é›†ä¸åˆ†æ ==="
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs
          
          KEY_LOGS=("${{ env.BUILD_LOG_DIR }}/critical-errors.log" "${{ env.BUILD_LOG_DIR }}/compile.log" "${{ env.BUILD_LOG_DIR }}/download.log" "${{ env.BUILD_LOG_DIR }}/toolchain.log" "${{ env.BUILD_LOG_DIR }}/feeds-update-0.log" "${{ env.BUILD_LOG_DIR }}/feeds-install.log" "${{ env.BUILD_LOG_DIR }}/kernel-compile.log" "${{ env.BUILD_LOG_DIR }}/factory-repair.log")
          
          for log in "${KEY_LOGS[@]}"; do
            if [ -f "$log" ]; then
              base_name=$(basename "$log")
              cp "$log" "${{ env.ARTIFACTS_DIR }}/logs/${base_name}" 2>/dev/null || true
            fi
          done
          
          if [ -d "${{ env.SOURCE_DIR }}" ]; then
            cd ${{ env.SOURCE_DIR }}
            cp .config ${{ env.ARTIFACTS_DIR }}/logs/final-config.txt 2>/dev/null || true
            ccache -s > ${{ env.ARTIFACTS_DIR }}/logs/ccache-stats.txt 2>/dev/null || true
          fi
          
          if [ -f "${{ env.ARTIFACTS_DIR }}/firmware-list.txt" ]; then
            cp ${{ env.ARTIFACTS_DIR }}/firmware-list.txt ${{ env.ARTIFACTS_DIR }}/logs/ 2>/dev/null || true
          fi
          
          echo "âœ… ä¸¥æ ¼æ—¥å¿—æ”¶é›†å®Œæˆ"

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Firmware-${{ github.run_number }}-${{ env.SOURCE_PRESET }}-${{ env.ACTUAL_BRANCH }}-${{ env.BUILD_STATUS || 'unknown' }}"
          path: "${{ env.ARTIFACTS_DIR }}"
          retention-days: 30
          compression-level: 9

      - name: "ğŸ§¹ æ™ºèƒ½æ¸…ç†"
        if: always()
        timeout-minutes: 5
        run: |
          echo "=== ğŸ§¹ æ™ºèƒ½æ¸…ç† ==="
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          ccache -s
          echo "âœ… æ™ºèƒ½æ¸…ç†å®Œæˆ"

      - name: "ğŸ“Š æœ€ç»ˆè¯¦ç»†æŠ¥å‘Š"
        if: always()
        timeout-minutes: 5
        run: |
          echo "=== ğŸ“Š æœ€ç»ˆè¯¦ç»†æŠ¥å‘Š ==="
          echo ""
          echo "ğŸ¯ æ„å»ºè¯¦ç»†æ‘˜è¦"
          echo "=========================================="
          echo "ğŸ“¦ æºç ä¿¡æ¯:"
          echo "  - é¢„è®¾: ${{ env.SOURCE_PRESET }}"
          echo "  - åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "  - æäº¤: ${{ env.COMMIT_HASH || 'unknown' }}"
          echo ""
          echo "ğŸ“ˆ æ„å»ºç»“æœ:"
          echo "  - çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - æ—¶é•¿: ${{ env.BUILD_DURATION || 'N/A' }}ç§’ ($((${{ env.BUILD_DURATION || 0 }}/60))åˆ†é’Ÿ)"
          echo "  - å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - å·¥å‚é•œåƒ: ${{ env.FACTORY_EXISTS || 'unknown' }}"
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
          echo ""
          echo "ğŸ”§ åŠŸèƒ½çŠ¶æ€:"
          echo "  - è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
          echo "  - é¢„ä¸‹è½½: ${{ github.event.inputs.enable_pre_download }}"
          echo "  - é—®é¢˜ä¿®å¤: ${{ github.event.inputs.fix_common_issues }}"
          echo "  - è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug_mode }}"
          echo ""
          
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            if [ "${{ env.FACTORY_EXISTS }}" = "true" ]; then
              echo "ğŸ‰ æ„å»ºæˆåŠŸï¼å·¥å‚é•œåƒå·²ç”Ÿæˆ"
              echo ""
              echo "ğŸš¨ æ•‘ç –é‡è¦æç¤º:"
              echo "   1. ä¸‹è½½ Artifacts ä¸­çš„å›ºä»¶æ–‡ä»¶"
              echo "   2. æŸ¥æ‰¾åç§°åŒ…å« 'factory' çš„é•œåƒæ–‡ä»¶"
              echo "   3. ä½¿ç”¨ ASUS å®˜æ–¹æ¢å¤å·¥å…·åˆ·å…¥å·¥å‚é•œåƒ"
              echo "   4. ç­‰å¾…è·¯ç”±å™¨è‡ªåŠ¨é‡å¯å®Œæˆ"
              echo "   5. ä¸è¦ä½¿ç”¨ sysupgrade é•œåƒæ•‘ç –ï¼"
            else
              echo "âš ï¸ æ„å»ºæˆåŠŸä½†æœªç”Ÿæˆå·¥å‚é•œåƒ"
            fi
          else
            echo "âŒ æ„å»ºå¤±è´¥"
            echo ""
            echo "ğŸ” æ•…éšœæ’é™¤å»ºè®®:"
            echo "   - æŸ¥çœ‹ critical-errors.log"
            echo "   - éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®"
            echo "   - æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œä»“åº“çŠ¶æ€"
          fi
          echo ""
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "=========================================="
