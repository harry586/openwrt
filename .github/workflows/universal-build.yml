name: "Universal Firmware Builder - Enhanced Logging Version"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "选择源码库"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "源码分支"
        required: true
        default: "master"
        type: string
      config_profile:
        description: "设备配置文件路径"
        required: true
        type: string
        default: ".config_rt-ac42u_immortalwrt"
      build_optimization:
        description: "编译优化策略"
        required: true
        type: choice
        options: ["balanced", "speed", "stability"]
        default: "balanced"
      toolchain_strategy:
        description: "工具链策略"
        required: true
        type: choice
        options: ["prebuilt", "local", "auto"]
        default: "auto"
      enable_custom_features:
        description: "启用自定义功能"
        required: false
        default: true
        type: boolean
      fix_common_issues:
        description: "自动修复常见问题"
        required: false
        default: true
        type: boolean
      enable_pre_download:
        description: "启用预下载验证"
        required: false
        default: true
        type: boolean
      enable_post_verify:
        description: "启用编译后验证"
        required: false
        default: true
        type: boolean
      debug_mode:
        description: "启用调试模式"
        required: false
        default: false
        type: boolean

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"
  TOOLCHAIN_LOG_DIR: "/mnt/toolchain-logs"
  DEBUG_MODE: "${{ github.event.inputs.debug_mode }}"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 360
    
    steps:
      - name: "📥 检出配置仓库"
        uses: "actions/checkout@v4"
        with:
          path: "."
          fetch-depth: 0

      - name: "🔧 初始化日志系统"
        run: |
          echo "=== 🔧 初始化日志系统 ==="
          mkdir -p ${{ env.BUILD_LOG_DIR }}
          # 创建主日志文件
          MAIN_LOG="${{ env.BUILD_LOG_DIR }}/build_timeline.log"
          echo "🏁 构建开始时间: $(date)" > $MAIN_LOG
          echo "🔧 工作流版本: Enhanced Logging Version" >> $MAIN_LOG
          echo "📋 输入参数:" >> $MAIN_LOG
          echo "  - 源码预设: ${{ github.event.inputs.source_preset }}" >> $MAIN_LOG
          echo "  - 源码分支: ${{ github.event.inputs.source_branch }}" >> $MAIN_LOG
          echo "  - 配置方案: ${{ github.event.inputs.config_profile }}" >> $MAIN_LOG
          echo "  - 优化策略: ${{ github.event.inputs.build_optimization }}" >> $MAIN_LOG
          echo "==========================================" >> $MAIN_LOG
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV

      - name: "💾 环境设置与资源管理"
        run: |
          {
            echo "=== 💾 环境设置与资源管理 ==="
            echo "📊 系统信息: $(lsb_release -d | cut -f2), 内核: $(uname -r)"
            echo "💻 CPU: $(nproc) 核心, $(grep -m1 'model name' /proc/cpuinfo | cut -d: -f2 | xargs)"
            echo "🧠 内存: $(free -h | awk 'NR==2{print $7}') 可用"
            
            # 磁盘空间检查
            MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
            echo "💾 /mnt 可用空间: ${MNT_AVAILABLE}GB"
            if [ "$MNT_AVAILABLE" -lt 20 ]; then
              echo "❌ 错误: /mnt 分区空间不足20GB"
              exit 1
            fi
            
            # 创建交换文件
            echo "🔄 创建交换文件..."
            SWAP_SIZE="16G"
            sudo swapoff /mnt/swapfile 2>/dev/null || true
            sudo rm -f /mnt/swapfile 2>/dev/null || true
            sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=$(( ${SWAP_SIZE%G} * 1024 )) status=progress || sudo fallocate -l $SWAP_SIZE /mnt/swapfile
            sudo chmod 600 /mnt/swapfile
            sudo mkswap /mnt/swapfile
            sudo swapon /mnt/swapfile
            echo "✅ 交换文件创建完成: ${SWAP_SIZE}"
            
            # 创建工作目录
            sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }}
            sudo chown -R $USER:$USER ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }}
            
            echo "✅ 环境设置完成"
          } >> ${{ env.MAIN_LOG }}

      - name: "🛠️ 安装编译依赖"
        run: |
          {
            echo "=== 🛠️ 安装编译依赖 ==="
            echo "📦 更新软件包列表..."
            sudo apt-get update
            
            echo "🔧 安装核心编译工具..."
            sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build libelf-dev libxml2-dev liblzma-dev liblzo2-dev axel net-tools
            
            # 验证关键工具
            echo "🔍 验证工具安装..."
            for tool in gcc g++ make git curl wget python3 cmake ninja; do
              if command -v $tool >/dev/null 2>&1; then
                version=$($tool --version 2>/dev/null | head -1 || echo "unknown")
                echo "✅ $tool: $version"
              else
                echo "❌ $tool: 未安装"
                exit 1
              fi
            done
            
            echo "✅ 依赖安装完成"
          } >> ${{ env.MAIN_LOG }}

      - name: "⚡ 性能优化配置"
        run: |
          {
            echo "=== ⚡ 性能优化配置 ==="
            OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
            echo "🎯 编译优化策略: $OPTIMIZATION_STRATEGY"
            
            case "$OPTIMIZATION_STRATEGY" in
              "speed")
                CCACHE_SIZE="12G"
                PARALLEL_JOBS=$(nproc)
                echo "🚀 速度优先模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}"
                ;;
              "stability")
                CCACHE_SIZE="4G"
                PARALLEL_JOBS=$(( $(nproc) - 2 ))
                echo "🛡️ 稳定性优先模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}"
                ;;
              *)
                CCACHE_SIZE="8G"
                PARALLEL_JOBS=$(( $(nproc) - 1 ))
                echo "⚖️ 平衡模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}"
                ;;
            esac
            
            mkdir -p ${{ env.CCACHE_DIR }}
            ccache -M $CCACHE_SIZE
            ccache -o compression=true
            ccache -o compression_level=6
            echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
            echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
            echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
            
            echo "📊 初始CCache统计:"
            ccache -s
            echo "✅ 性能优化完成"
          } >> ${{ env.MAIN_LOG }}

      - name: "🔧 源码配置与获取"
        run: |
          {
            echo "=== 🔧 源码配置与获取 ==="
            
            # 查找配置文件
            REPO_JSON_FOUND=$(find . -name "*repositories*.json" -type f 2>/dev/null | head -1)
            if [ -z "$REPO_JSON_FOUND" ]; then
              echo "❌ 错误: 未找到 repositories.json 文件"
              exit 1
            fi
            echo "✅ 找到配置文件: $REPO_JSON_FOUND"
            
            PRESET="${{ github.event.inputs.source_preset }}"
            SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND" 2>/dev/null || echo "")
            if [ -z "$SOURCE_URL" ]; then
              echo "❌ 错误: 预设 '$PRESET' 在配置文件中不存在"
              exit 1
            fi
            
            BRANCH="${{ github.event.inputs.source_branch }}"
            if [ "$BRANCH" = "auto" ]; then
              BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND" 2>/dev/null || echo "master")
            fi
            
            echo "📦 源码信息:"
            echo "  - URL: $SOURCE_URL"
            echo "  - 分支: $BRANCH"
            echo "  - 预设: $PRESET"
            
            # 克隆源码
            cd ${{ env.SOURCE_DIR }}
            echo "🔄 克隆源码..."
            rm -rf .[!.]* * 2>/dev/null || true
            
            CLONE_SUCCESS=false
            for attempt in 1 2; do
              echo "📥 克隆尝试 $attempt/2..."
              if git clone --depth 1 --branch "$BRANCH" "$SOURCE_URL" . 2>&1; then
                if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
                  CLONE_SUCCESS=true
                  break
                fi
              fi
              sleep 3
            done
            
            if [ "$CLONE_SUCCESS" = "false" ]; then
              echo "🔄 尝试默认分支..."
              rm -rf .[!.]* * 2>/dev/null || true
              if git clone --depth 1 "$SOURCE_URL" . 2>&1; then
                if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
                  CLONE_SUCCESS=true
                fi
              fi
            fi
            
            if [ "$CLONE_SUCCESS" = "false" ]; then
              echo "❌ 源码克隆失败"
              exit 1
            fi
            
            ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
            COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            echo "✅ 源码克隆成功"
            echo "  - 实际分支: $ACTUAL_BRANCH"
            echo "  - 提交哈希: $COMMIT_HASH"
            
            echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
            echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
            echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          } >> ${{ env.MAIN_LOG }}

      - name: "🔄 源码初始化与Feeds配置"
        run: |
          {
            echo "=== 🔄 源码初始化与Feeds配置 ==="
            cd ${{ env.SOURCE_DIR }}
            
            # 配置feeds
            echo "📋 配置Feeds..."
            case "${{ env.SOURCE_PRESET }}" in
              "immortalwrt")
                echo "src-git packages https://github.com/immortalwrt/packages.git" > feeds.conf
                echo "src-git luci https://github.com/immortalwrt/luci.git" >> feeds.conf
                echo "src-git routing https://github.com/immortalwrt/routing.git" >> feeds.conf
                echo "src-git telephony https://github.com/immortalwrt/telephony.git" >> feeds.conf
                ;;
              "openwrt")
                echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
                echo "src-git luci https://git.openwrt.org/project/luci.git" >> feeds.conf
                echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
                echo "src-git telephony https://git.openwrt.org/feed/telephony.git" >> feeds.conf
                ;;
              "lede")
                echo "src-git packages https://github.com/coolsnowwolf/packages.git" > feeds.conf
                echo "src-git luci https://github.com/coolsnowwolf/luci.git" >> feeds.conf
                echo "src-git routing https://github.com/coolsnowwolf/routing.git" >> feeds.conf
                echo "src-git telephony https://github.com/coolsnowwolf/telephony.git" >> feeds.conf
                ;;
            esac
            
            echo "🔄 更新Feeds..."
            for attempt in 1 2 3; do
              if ./scripts/feeds update -a 2>&1; then
                break
              fi
              echo "⚠️ Feeds更新失败，重试 $attempt/3..."
              sleep 5
            done
            
            echo "📦 安装Feeds..."
            ./scripts/feeds install -a 2>&1
            
            echo "✅ 源码初始化完成"
          } >> ${{ env.MAIN_LOG }}

      - name: "🎯 应用设备配置"
        run: |
          {
            echo "=== 🎯 应用设备配置 ==="
            cd ${{ env.SOURCE_DIR }}
            
            CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
            echo "🔍 查找配置文件: $CONFIG_PROFILE"
            
            # 搜索配置文件
            CONFIG_FOUND=""
            SEARCH_PATHS=(".configs" "configs" "$GITHUB_WORKSPACE" "$GITHUB_WORKSPACE/configs")
            
            for path in "${SEARCH_PATHS[@]}"; do
              if [ -f "$path/$CONFIG_PROFILE" ]; then
                CONFIG_FOUND="$path/$CONFIG_PROFILE"
                break
              fi
            done
            
            if [ -z "$CONFIG_FOUND" ]; then
              CONFIG_FOUND=$(find "$GITHUB_WORKSPACE" -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            fi
            
            if [ -n "$CONFIG_FOUND" ] && [ -f "$CONFIG_FOUND" ]; then
              echo "✅ 找到配置文件: $CONFIG_FOUND"
              cp "$CONFIG_FOUND" .config
              
              # 确保必要的配置
              echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> .config
              echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> .config
              
              echo "🔄 运行defconfig..."
              make defconfig 2>&1
              echo "✅ 配置应用完成"
            else
              echo "❌ 错误: 未找到配置文件 '$CONFIG_PROFILE'"
              exit 1
            fi
          } >> ${{ env.MAIN_LOG }}

      - name: "📥 预下载依赖"
        if: github.event.inputs.enable_pre_download == 'true'
        run: |
          {
            echo "=== 📥 预下载依赖 ==="
            cd ${{ env.SOURCE_DIR }}
            
            echo "🔧 设置下载目录..."
            mkdir -p ${{ env.DOWNLOAD_DIR }}
            [ -d "dl" ] && rm -rf dl
            ln -sf ${{ env.DOWNLOAD_DIR }} dl
            
            echo "📥 开始下载..."
            for attempt in 1 2; do
              if make download -j${{ env.PARALLEL_JOBS }} V=sc 2>&1; then
                break
              fi
              echo "⚠️ 下载失败，重试 $attempt/2..."
              sleep 10
            done
            
            DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
            echo "✅ 下载完成，文件数量: $DOWNLOAD_COUNT"
          } >> ${{ env.MAIN_LOG }}

      - name: "🛠️ 编译工具链"
        timeout-minutes: 150
        run: |
          {
            echo "=== 🛠️ 编译工具链 ==="
            cd ${{ env.SOURCE_DIR }}
            
            export FORCE_UNSAFE_CONFIGURE=1
            export LC_ALL=C
            
            echo "🔧 编译基础工具..."
            make tools/install -j2 V=s 2>&1
            
            echo "🔄 编译工具链..."
            MAX_RETRIES=3
            for attempt in $(seq 1 $MAX_RETRIES); do
              echo "🔄 工具链编译尝试 $attempt/$MAX_RETRIES"
              
              case $attempt in
                1) JOBS=$(( ${{ env.PARALLEL_JOBS }} / 2 )) ;;
                2) JOBS=1; make toolchain/clean 2>/dev/null || true ;;
                3) JOBS=1; make dirclean 2>/dev/null || true ;;
              esac
              
              if make toolchain/compile -j$JOBS V=s 2>&1; then
                if find staging_dir/toolchain-*/bin -name "*-gcc" 2>/dev/null | grep -q .; then
                  echo "✅ 工具链编译成功"
                  break
                else
                  echo "⚠️ 编译完成但工具链不完整"
                fi
              else
                echo "❌ 工具链编译失败"
                if [ $attempt -eq $MAX_RETRIES ]; then
                  echo "❌ 所有工具链编译尝试都失败"
                  exit 1
                fi
                sleep 10
              fi
            done
            
            echo "✅ 工具链编译完成"
          } >> ${{ env.MAIN_LOG }}

      - name: "🚀 编译固件"
        timeout-minutes: 180
        run: |
          {
            echo "=== 🚀 编译固件 ==="
            cd ${{ env.SOURCE_DIR }}
            
            export FORCE_UNSAFE_CONFIGURE=1
            export LC_ALL=C
            
            MAX_ATTEMPTS=2
            for attempt in $(seq 1 $MAX_ATTEMPTS); do
              echo "🔄 编译尝试 $attempt/$MAX_ATTEMPTS"
              
              if [ $attempt -eq 1 ]; then
                JOBS=${{ env.PARALLEL_JOBS }}
              else
                JOBS=$(( ${{ env.PARALLEL_JOBS }} / 2 ))
                echo "🧹 清理之前的构建..."
                make target/linux-clean 2>/dev/null || true
              fi
              
              if make -j$JOBS V=s 2>&1; then
                if [ -d "bin/targets" ] && find bin/targets -name "*.bin" 2>/dev/null | grep -q .; then
                  echo "✅ 编译成功"
                  echo "BUILD_STATUS=success" >> $GITHUB_ENV
                  break
                else
                  echo "⚠️ 编译完成但未生成固件"
                fi
              else
                echo "❌ 编译失败"
                if [ $attempt -eq $MAX_ATTEMPTS ]; then
                  echo "❌ 所有编译尝试都失败"
                  echo "BUILD_STATUS=failed" >> $GITHUB_ENV
                  exit 1
                fi
                sleep 10
              fi
            done
          } >> ${{ env.MAIN_LOG }}

      - name: "🎯 验证工厂镜像"
        if: env.BUILD_STATUS == 'success'
        run: |
          {
            echo "=== 🎯 验证工厂镜像 ==="
            cd ${{ env.SOURCE_DIR }}
            
            ASUS_FACTORY=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -i factory || true)
            
            if [ -n "$ASUS_FACTORY" ]; then
              echo "✅ 工厂镜像已生成:"
              for img in $ASUS_FACTORY; do
                size=$(du -h "$img" | cut -f1)
                echo "  - $(basename "$img") ($size)"
              done
              echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
            else
              echo "❌ 未找到工厂镜像"
              echo "FACTORY_EXISTS=false" >> $GITHUB_ENV
              
              # 尝试专门编译工厂镜像
              echo "🔄 尝试专门编译工厂镜像..."
              make target/install -j1 V=s 2>&1 || true
            fi
          } >> ${{ env.MAIN_LOG }}

      - name: "📦 收集构建产物"
        if: env.BUILD_STATUS == 'success'
        run: |
          {
            echo "=== 📦 收集构建产物 ==="
            cd ${{ env.SOURCE_DIR }}
            
            mkdir -p ${{ env.ARTIFACTS_DIR }}/firmware
            
            # 查找所有固件文件
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) > ${{ env.ARTIFACTS_DIR }}/firmware-list.txt
            FIRMWARE_COUNT=$(wc -l < ${{ env.ARTIFACTS_DIR }}/firmware-list.txt)
            
            echo "📦 复制 $FIRMWARE_COUNT 个固件文件..."
            while IFS= read -r firmware; do
              if [ -f "$firmware" ]; then
                cp "$firmware" ${{ env.ARTIFACTS_DIR }}/firmware/ 2>/dev/null || true
              fi
            done < ${{ env.ARTIFACTS_DIR }}/firmware-list.txt
            
            COPIED_COUNT=$(find ${{ env.ARTIFACTS_DIR }}/firmware -type f 2>/dev/null | wc -l)
            echo "✅ 成功复制 $COPIED_COUNT 个固件文件"
            echo "FIRMWARE_COUNT=$COPIED_COUNT" >> $GITHUB_ENV
          } >> ${{ env.MAIN_LOG }}

      - name: "📋 智能日志分析与报告"
        if: always()
        timeout-minutes: 10
        run: |
          echo "=== 📋 智能日志分析与报告 ==="
          
          # 完成主日志
          {
            echo "=========================================="
            echo "🏁 构建结束时间: $(date)"
            echo "📊 最终状态: ${{ env.BUILD_STATUS || 'unknown' }}"
            echo "📦 固件数量: ${{ env.FIRMWARE_COUNT || 0 }}"
            echo "🏭 工厂镜像: ${{ env.FACTORY_EXISTS || 'unknown' }}"
          } >> ${{ env.MAIN_LOG }}
          
          # 创建智能错误报告
          ERROR_REPORT_DIR="${{ env.ARTIFACTS_DIR }}/error-analysis"
          mkdir -p "$ERROR_REPORT_DIR"
          
          # 生成时间线错误报告
          TIMELINE_ERRORS="$ERROR_REPORT_DIR/timeline_errors.txt"
          echo "=== 🕒 时间线错误报告 ===" > "$TIMELINE_ERRORS"
          echo "生成时间: $(date)" >> "$TIMELINE_ERRORS"
          echo "构建状态: ${{ env.BUILD_STATUS || 'unknown' }}" >> "$TIMELINE_ERRORS"
          echo "==========================================" >> "$TIMELINE_ERRORS"
          
          # 从主日志提取关键错误（按时间顺序）
          echo "🔍 分析主日志时间线..." >> "$TIMELINE_ERRORS"
          grep -n -i -A3 -B1 "error\|failed\|fatal\|warning\|missing\|not found\|cannot" ${{ env.MAIN_LOG }} >> "$TIMELINE_ERRORS" 2>/dev/null || echo "无关键错误信息" >> "$TIMELINE_ERRORS"
          
          # 生成分类错误报告
          CATEGORIZED_ERRORS="$ERROR_REPORT_DIR/categorized_errors.txt"
          echo "=== 🗂️ 分类错误报告 ===" > "$CATEGORIZED_ERRORS"
          
          # 严重错误
          echo "🔴 严重错误 (ERROR/FATAL):" >> "$CATEGORIZED_ERRORS"
          grep -n -i "error\|fatal" ${{ env.MAIN_LOG }} | head -20 >> "$CATEGORIZED_ERRORS" 2>/dev/null || echo "无严重错误" >> "$CATEGORIZED_ERRORS"
          
          echo "" >> "$CATEGORIZED_ERRORS"
          echo "🟡 失败信息 (FAILED):" >> "$CATEGORIZED_ERRORS"
          grep -n -i "failed" ${{ env.MAIN_LOG }} | head -15 >> "$CATEGORIZED_ERRORS" 2>/dev/null || echo "无失败信息" >> "$CATEGORIZED_ERRORS"
          
          echo "" >> "$CATEGORIZED_ERRORS"
          echo "🔵 警告信息 (WARNING):" >> "$CATEGORIZED_ERRORS"
          grep -n -i "warning" ${{ env.MAIN_LOG }} | head -10 >> "$CATEGORIZED_ERRORS" 2>/dev/null || echo "无警告信息" >> "$CATEGORIZED_ERRORS"
          
          echo "" >> "$CATEGORIZED_ERRORS"
          echo "🟣 缺失/未找到 (MISSING/NOT FOUND):" >> "$CATEGORIFIED_ERRORS"
          grep -n -i "missing\|not found" ${{ env.MAIN_LOG }} | head -10 >> "$CATEGORIFIED_ERRORS" 2>/dev/null || echo "无缺失信息" >> "$CATEGORIFIED_ERRORS"
          
          # 生成统计报告
          STATS_REPORT="$ERROR_REPORT_DIR/error_statistics.txt"
          echo "=== 📊 错误统计报告 ===" > "$STATS_REPORT"
          echo "总日志行数: $(wc -l < ${{ env.MAIN_LOG }} 2>/dev/null || echo 0)" >> "$STATS_REPORT"
          echo "错误数量: $(grep -c -i "error" ${{ env.MAIN_LOG }} 2>/dev/null || echo 0)" >> "$STATS_REPORT"
          echo "失败数量: $(grep -c -i "failed" ${{ env.MAIN_LOG }} 2>/dev/null || echo 0)" >> "$STATS_REPORT"
          echo "警告数量: $(grep -c -i "warning" ${{ env.MAIN_LOG }} 2>/dev/null || echo 0)" >> "$STATS_REPORT"
          echo "致命错误: $(grep -c -i "fatal" ${{ env.MAIN_LOG }} 2>/dev/null || echo 0)" >> "$STATS_REPORT"
          
          # 生成修复建议
          FIX_SUGGESTIONS="$ERROR_REPORT_DIR/fix_suggestions.txt"
          echo "=== 💡 修复建议 ===" > "$FIX_SUGGESTIONS"
          
          if grep -q -i "branch.*not found" ${{ env.MAIN_LOG }}; then
            echo "🔧 分支问题修复建议:" >> "$FIX_SUGGESTIONS"
            echo "  - 检查源码仓库是否存在指定分支" >> "$FIX_SUGGESTIONS"
            echo "  - 尝试使用 'master' 或 'main' 分支" >> "$FIX_SUGGESTIONS"
            echo "  - 查看 repositories.json 中的推荐分支" >> "$FIX_SUGGESTIONS"
          fi
          
          if grep -q -i "toolchain.*failed" ${{ env.MAIN_LOG }}; then
            echo "🔧 工具链编译问题修复建议:" >> "$FIX_SUGGESTIONS"
            echo "  - 增加交换文件大小" >> "$FIX_SUGGESTIONS"
            echo "  - 使用稳定性优先的编译策略" >> "$FIX_SUGGESTIONS"
            echo "  - 检查磁盘空间是否充足" >> "$FIX_SUGGESTIONS"
          fi
          
          if grep -q -i "config.*not found" ${{ env.MAIN_LOG }}; then
            echo "🔧 配置文件问题修复建议:" >> "$FIX_SUGGESTIONS"
            echo "  - 确认配置文件路径是否正确" >> "$FIX_SUGGESTIONS"
            echo "  - 检查配置文件是否在 configs 目录中" >> "$FIX_SUGGESTIONS"
            echo "  - 验证配置文件格式是否正确" >> "$FIX_SUGGESTIONS"
          fi
          
          if [ ! -f "$FIX_SUGGESTIONS" ] || [ ! -s "$FIX_SUGGESTIONS" ]; then
            echo "✅ 未检测到需要修复的问题" >> "$FIX_SUGGESTIONS"
          fi
          
          echo "✅ 智能日志分析完成"
          echo "📁 报告文件位置: $ERROR_REPORT_DIR"

      - name: "💾 上传构建产物和日志"
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Build-Artifacts-${{ github.run_number }}"
          path: |
            ${{ env.ARTIFACTS_DIR }}
            ${{ env.BUILD_LOG_DIR }}
          retention-days: 30
          compression-level: 9

      - name: "🧹 清理环境"
        if: always()
        run: |
          echo "=== 🧹 清理环境 ==="
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          ccache -s
          echo "✅ 环境清理完成"

      - name: "📊 最终构建报告"
        if: always()
        run: |
          echo "=== 📊 最终构建报告 ==="
          echo ""
          echo "🎯 构建摘要"
          echo "=========================================="
          echo "📦 源码信息:"
          echo "  - 预设: ${{ env.SOURCE_PRESET || 'unknown' }}"
          echo "  - 分支: ${{ env.ACTUAL_BRANCH || 'unknown' }}"
          echo "  - 提交: ${{ env.COMMIT_HASH || 'unknown' }}"
          echo ""
          echo "📈 构建结果:"
          echo "  - 状态: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - 固件数量: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - 工厂镜像: ${{ env.FACTORY_EXISTS || 'unknown' }}"
          echo ""
          
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            if [ "${{ env.FACTORY_EXISTS }}" = "true" ]; then
              echo "🎉 构建成功！工厂镜像已生成"
              echo ""
              echo "🚨 救砖重要提示:"
              echo "   1. 下载 Artifacts 中的固件文件"
              echo "   2. 查找名称包含 'factory' 的镜像文件"
              echo "   3. 使用 ASUS 官方恢复工具刷入工厂镜像"
            else
              echo "⚠️ 构建成功但未生成工厂镜像"
            fi
          else
            echo "❌ 构建失败"
            echo ""
            echo "🔍 请查看 error-analysis 目录中的错误报告:"
            echo "   - timeline_errors.txt - 时间线错误"
            echo "   - categorized_errors.txt - 分类错误"
            echo "   - fix_suggestions.txt - 修复建议"
          fi
          echo ""
          echo "⏰ 完成时间: $(date)"
          echo "=========================================="
