name: "Universal Firmware Builder - Fixed Permissions Version"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "选择源码库"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "源码分支"
        required: true
        default: "master"
        type: string
      config_profile:
        description: "设备配置文件路径"
        required: true
        type: string
        default: ".config_rt-ac42u_immortalwrt"
      build_optimization:
        description: "编译优化策略"
        required: true
        type: choice
        options: ["balanced", "speed", "stability"]
        default: "balanced"
      toolchain_strategy:
        description: "工具链策略"
        required: true
        type: choice
        options: ["prebuilt", "local", "auto"]
        default: "auto"
      enable_custom_features:
        description: "启用自定义功能"
        required: false
        default: true
        type: boolean
      fix_common_issues:
        description: "自动修复常见问题"
        required: false
        default: true
        type: boolean
      enable_pre_download:
        description: "启用预下载验证"
        required: false
        default: true
        type: boolean
      enable_post_verify:
        description: "启用编译后验证"
        required: false
        default: true
        type: boolean
      debug_mode:
        description: "启用调试模式"
        required: false
        default: false
        type: boolean

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"
  DEBUG_MODE: "${{ github.event.inputs.debug_mode }}"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 360
    
    steps:
      - name: "📥 检出配置仓库"
        uses: "actions/checkout@v4"
        with:
          path: "config-repo"
          fetch-depth: 0

      - name: "🔧 初始化工作环境与权限修复"
        run: |
          echo "=== 🔧 初始化工作环境与权限修复 ==="
          
          # 检查/mnt目录权限
          echo "🔍 检查/mnt目录状态..."
          ls -la /mnt/ | head -10
          
          # 使用sudo创建目录并设置正确权限
          echo "📁 创建工作目录结构..."
          sudo mkdir -p $SOURCE_DIR $ARTIFACTS_DIR $CCACHE_DIR $BUILD_LOG_DIR $DOWNLOAD_DIR
          sudo chown -R $USER:$USER $SOURCE_DIR $ARTIFACTS_DIR $CCACHE_DIR $BUILD_LOG_DIR $DOWNLOAD_DIR
          sudo chmod -R 755 $SOURCE_DIR $ARTIFACTS_DIR $CCACHE_DIR $BUILD_LOG_DIR $DOWNLOAD_DIR
          
          # 验证目录创建
          echo "✅ 目录创建验证:"
          ls -la /mnt/
          
          # 创建主日志文件
          MAIN_LOG="$BUILD_LOG_DIR/build_timeline.log"
          echo "🏁 构建开始时间: $(date)" > $MAIN_LOG
          echo "🔧 工作流版本: Fixed Permissions Version" >> $MAIN_LOG
          echo "📋 输入参数:" >> $MAIN_LOG
          echo "  - 源码预设: ${{ github.event.inputs.source_preset }}" >> $MAIN_LOG
          echo "  - 源码分支: ${{ github.event.inputs.source_branch }}" >> $MAIN_LOG
          echo "  - 配置方案: ${{ github.event.inputs.config_profile }}" >> $MAIN_LOG
          echo "==========================================" >> $MAIN_LOG
          
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV
          echo "CONFIG_REPO_DIR=${{ github.workspace }}/config-repo" >> $GITHUB_ENV
          
          echo "✅ 工作环境初始化完成"

      - name: "💾 环境设置与资源管理"
        run: |
          {
            echo "=== 💾 环境设置与资源管理 ==="
            
            # 系统信息
            echo "📊 系统信息:"
            echo "  - 系统: $(lsb_release -d | cut -f2)"
            echo "  - 内核: $(uname -r)" 
            echo "  - CPU: $(nproc) 核心"
            echo "  - 内存: $(free -h | awk 'NR==2{print $7}') 可用"
            
            # 磁盘空间检查
            echo "💾 磁盘空间状态:"
            df -h | grep -E '(/|/mnt)'
            MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
            echo "  - /mnt 可用空间: ${MNT_AVAILABLE}GB"
            
            if [ "$MNT_AVAILABLE" -lt 20 ]; then
              echo "❌ 错误: /mnt 分区空间不足20GB"
              exit 1
            fi
            
            # 创建交换文件
            echo "🔄 创建交换文件..."
            SWAP_SIZE="16G"
            if [ "$MNT_AVAILABLE" -gt 50 ]; then
              SWAP_SIZE="20G"
            fi
            
            # 清理现有交换文件
            sudo swapoff /mnt/swapfile 2>/dev/null || true
            sudo rm -f /mnt/swapfile 2>/dev/null || true
            
            # 创建新交换文件
            echo "📦 创建 ${SWAP_SIZE} 交换文件..."
            sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=$(( ${SWAP_SIZE%G} * 1024 )) status=progress 2>/dev/null || sudo fallocate -l $SWAP_SIZE /mnt/swapfile
            sudo chmod 600 /mnt/swapfile
            sudo mkswap /mnt/swapfile
            sudo swapon /mnt/swapfile
            
            echo "📊 内存状态:"
            free -h
            
            echo "✅ 环境设置完成"
          } >> $MAIN_LOG

      - name: "🛠️ 安装编译依赖"
        run: |
          {
            echo "=== 🛠️ 安装编译依赖 ==="
            echo "📦 更新软件包列表..."
            sudo apt-get update -qq
            
            echo "🔧 安装核心编译工具..."
            sudo apt-get install -y -qq \
              build-essential clang flex bison g++ gawk \
              gcc-multilib g++-multilib gettext git libncurses5-dev \
              libssl-dev python3 python3-pip rsync unzip zlib1g-dev \
              file wget jq ccache libtool-bin automake autoconf \
              pkg-config subversion curl cmake ninja-build libelf-dev \
              libxml2-dev liblzma-dev liblzo2-dev axel net-tools
            
            # 验证关键工具
            echo "🔍 验证工具安装..."
            for tool in gcc g++ make git curl wget python3 cmake ninja ccache; do
              if command -v $tool >/dev/null 2>&1; then
                version=$($tool --version 2>/dev/null | head -1 | cut -d' ' -f1-3 || echo "installed")
                echo "✅ $tool: $version"
              else
                echo "❌ $tool: 未安装"
                exit 1
              fi
            done
            
            echo "✅ 依赖安装完成"
          } >> $MAIN_LOG

      - name: "⚡ 性能优化配置"
        run: |
          {
            echo "=== ⚡ 性能优化配置 ==="
            OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
            echo "🎯 编译优化策略: $OPTIMIZATION_STRATEGY"
            
            case "$OPTIMIZATION_STRATEGY" in
              "speed")
                CCACHE_SIZE="12G"
                PARALLEL_JOBS=$(nproc)
                echo "🚀 速度优先模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}"
                ;;
              "stability")
                CCACHE_SIZE="4G"
                PARALLEL_JOBS=$(( $(nproc) - 2 ))
                [ $PARALLEL_JOBS -lt 1 ] && PARALLEL_JOBS=1
                echo "🛡️ 稳定性优先模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}"
                ;;
              *)
                CCACHE_SIZE="8G"
                PARALLEL_JOBS=$(( $(nproc) - 1 ))
                [ $PARALLEL_JOBS -lt 1 ] && PARALLEL_JOBS=1
                echo "⚖️ 平衡模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}"
                ;;
            esac
            
            mkdir -p $CCACHE_DIR
            ccache -M $CCACHE_SIZE
            ccache -o compression=true
            ccache -o compression_level=6
            
            echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
            echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
            echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
            
            echo "📊 初始CCache统计:"
            ccache -s
            echo "✅ 性能优化完成"
          } >> $MAIN_LOG

      - name: "🔧 源码配置与获取"
        run: |
          {
            echo "=== 🔧 源码配置与获取 ==="
            
            # 查找配置文件
            REPO_JSON_FOUND=$(find $CONFIG_REPO_DIR -name "*repositories*.json" -type f 2>/dev/null | head -1)
            if [ -z "$REPO_JSON_FOUND" ]; then
              echo "❌ 错误: 未找到 repositories.json 文件"
              exit 1
            fi
            echo "✅ 找到配置文件: $REPO_JSON_FOUND"
            
            PRESET="${{ github.event.inputs.source_preset }}"
            SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND" 2>/dev/null || echo "")
            if [ -z "$SOURCE_URL" ]; then
              echo "❌ 错误: 预设 '$PRESET' 在配置文件中不存在"
              exit 1
            fi
            
            BRANCH="${{ github.event.inputs.source_branch }}"
            if [ "$BRANCH" = "auto" ]; then
              BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND" 2>/dev/null || echo "master")
            fi
            
            echo "📦 源码信息:"
            echo "  - URL: $SOURCE_URL"
            echo "  - 分支: $BRANCH"
            echo "  - 预设: $PRESET"
            
            # 克隆源码
            cd $SOURCE_DIR
            echo "🔄 克隆源码..."
            rm -rf .[!.]* * 2>/dev/null || true
            
            CLONE_SUCCESS=false
            for attempt in 1 2; do
              echo "📥 克隆尝试 $attempt/2..."
              if git clone --depth 1 --branch "$BRANCH" "$SOURCE_URL" . 2>&1; then
                if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
                  CLONE_SUCCESS=true
                  break
                fi
              fi
              sleep 3
            done
            
            if [ "$CLONE_SUCCESS" = "false" ]; then
              echo "🔄 尝试默认分支..."
              rm -rf .[!.]* * 2>/dev/null || true
              if git clone --depth 1 "$SOURCE_URL" . 2>&1; then
                if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
                  CLONE_SUCCESS=true
                fi
              fi
            fi
            
            if [ "$CLONE_SUCCESS" = "false" ]; then
              echo "❌ 源码克隆失败"
              exit 1
            fi
            
            ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
            COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            echo "✅ 源码克隆成功"
            echo "  - 实际分支: $ACTUAL_BRANCH"
            echo "  - 提交哈希: $COMMIT_HASH"
            
            echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
            echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
            echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          } >> $MAIN_LOG

      - name: "🔄 源码初始化与Feeds配置"
        run: |
          {
            echo "=== 🔄 源码初始化与Feeds配置 ==="
            cd $SOURCE_DIR
            
            # 配置feeds
            echo "📋 配置Feeds..."
            case "$SOURCE_PRESET" in
              "immortalwrt")
                echo "src-git packages https://github.com/immortalwrt/packages.git" > feeds.conf
                echo "src-git luci https://github.com/immortalwrt/luci.git" >> feeds.conf
                echo "src-git routing https://github.com/immortalwrt/routing.git" >> feeds.conf
                echo "src-git telephony https://github.com/immortalwrt/telephony.git" >> feeds.conf
                ;;
              "openwrt")
                echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
                echo "src-git luci https://git.openwrt.org/project/luci.git" >> feeds.conf
                echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
                echo "src-git telephony https://git.openwrt.org/feed/telephony.git" >> feeds.conf
                ;;
              "lede")
                echo "src-git packages https://github.com/coolsnowwolf/packages.git" > feeds.conf
                echo "src-git luci https://github.com/coolsnowwolf/luci.git" >> feeds.conf
                echo "src-git routing https://github.com/coolsnowwolf/routing.git" >> feeds.conf
                echo "src-git telephony https://github.com/coolsnowwolf/telephony.git" >> feeds.conf
                ;;
            esac
            
            echo "🔄 更新Feeds..."
            for attempt in 1 2 3; do
              if ./scripts/feeds update -a 2>&1; then
                echo "✅ Feeds更新成功"
                break
              else
                echo "⚠️ Feeds更新失败，重试 $attempt/3..."
                sleep 5
              fi
            done
            
            echo "📦 安装Feeds..."
            if ./scripts/feeds install -a 2>&1; then
              echo "✅ Feeds安装成功"
            else
              echo "⚠️ Feeds安装有警告，但继续执行..."
            fi
            
            echo "✅ 源码初始化完成"
          } >> $MAIN_LOG

      - name: "🎯 应用设备配置"
        run: |
          {
            echo "=== 🎯 应用设备配置 ==="
            cd $SOURCE_DIR
            
            CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
            echo "🔍 查找配置文件: $CONFIG_PROFILE"
            
            # 搜索配置文件
            CONFIG_FOUND=""
            SEARCH_PATHS=("$CONFIG_REPO_DIR/.configs" "$CONFIG_REPO_DIR/configs" "$CONFIG_REPO_DIR" "$GITHUB_WORKSPACE/configs")
            
            for path in "${SEARCH_PATHS[@]}"; do
              if [ -f "$path/$CONFIG_PROFILE" ]; then
                CONFIG_FOUND="$path/$CONFIG_PROFILE"
                break
              fi
            done
            
            if [ -z "$CONFIG_FOUND" ]; then
              CONFIG_FOUND=$(find "$CONFIG_REPO_DIR" -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            fi
            
            if [ -n "$CONFIG_FOUND" ] && [ -f "$CONFIG_FOUND" ]; then
              echo "✅ 找到配置文件: $CONFIG_FOUND"
              cp "$CONFIG_FOUND" .config
              
              # 确保必要的配置
              echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> .config
              echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> .config
              
              echo "🔄 运行defconfig..."
              if make defconfig 2>&1; then
                echo "✅ 配置应用完成"
              else
                echo "⚠️ defconfig有警告，但继续执行..."
              fi
            else
              echo "❌ 错误: 未找到配置文件 '$CONFIG_PROFILE'"
              echo "🔍 搜索路径: ${SEARCH_PATHS[*]}"
              exit 1
            fi
          } >> $MAIN_LOG

      - name: "📥 预下载依赖"
        if: github.event.inputs.enable_pre_download == 'true'
        run: |
          {
            echo "=== 📥 预下载依赖 ==="
            cd $SOURCE_DIR
            
            echo "🔧 设置下载目录..."
            mkdir -p $DOWNLOAD_DIR
            [ -d "dl" ] && rm -rf dl
            ln -sf $DOWNLOAD_DIR dl
            
            echo "📥 开始下载..."
            for attempt in 1 2; do
              if make download -j$PARALLEL_JOBS V=sc 2>&1; then
                echo "✅ 下载成功"
                break
              else
                echo "⚠️ 下载失败，重试 $attempt/2..."
                sleep 10
              fi
            done
            
            DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
            echo "✅ 下载完成，文件数量: $DOWNLOAD_COUNT"
          } >> $MAIN_LOG

      - name: "🛠️ 编译工具链"
        timeout-minutes: 150
        run: |
          {
            echo "=== 🛠️ 编译工具链 ==="
            cd $SOURCE_DIR
            
            export FORCE_UNSAFE_CONFIGURE=1
            export LC_ALL=C
            
            echo "🔧 编译基础工具..."
            if make tools/install -j2 V=s 2>&1; then
              echo "✅ 基础工具编译成功"
            else
              echo "⚠️ 基础工具编译有警告，但继续执行..."
            fi
            
            echo "🔄 编译工具链..."
            MAX_RETRIES=3
            TOOLCHAIN_SUCCESS=false
            
            for attempt in $(seq 1 $MAX_RETRIES); do
              echo "🔄 工具链编译尝试 $attempt/$MAX_RETRIES"
              
              case $attempt in
                1) 
                  JOBS=$(( PARALLEL_JOBS / 2 ))
                  [ $JOBS -lt 1 ] && JOBS=1
                  ;;
                2) 
                  JOBS=1
                  echo "🧹 清理工具链..."
                  make toolchain/clean 2>/dev/null || true
                  sleep 5
                  ;;
                3) 
                  JOBS=1
                  echo "🧹 深度清理..."
                  make dirclean 2>/dev/null || true
                  sleep 10
                  ;;
              esac
              
              if make toolchain/compile -j$JOBS V=s 2>&1; then
                if find staging_dir/toolchain-*/bin -name "*-gcc" 2>/dev/null | grep -q .; then
                  echo "✅ 工具链编译成功"
                  TOOLCHAIN_SUCCESS=true
                  break
                else
                  echo "⚠️ 编译完成但工具链不完整"
                fi
              else
                echo "❌ 工具链编译失败"
                if [ $attempt -eq $MAX_RETRIES ]; then
                  echo "❌ 所有工具链编译尝试都失败"
                  exit 1
                fi
                sleep 10
              fi
            done
            
            echo "✅ 工具链编译完成"
          } >> $MAIN_LOG

      - name: "🚀 编译固件"
        timeout-minutes: 180
        run: |
          {
            echo "=== 🚀 编译固件 ==="
            cd $SOURCE_DIR
            
            export FORCE_UNSAFE_CONFIGURE=1
            export LC_ALL=C
            
            MAX_ATTEMPTS=2
            COMPILE_SUCCESS=false
            
            for attempt in $(seq 1 $MAX_ATTEMPTS); do
              echo "🔄 编译尝试 $attempt/$MAX_ATTEMPTS"
              
              if [ $attempt -eq 1 ]; then
                JOBS=$PARALLEL_JOBS
              else
                JOBS=$(( PARALLEL_JOBS / 2 ))
                [ $JOBS -lt 1 ] && JOBS=1
                echo "🧹 清理之前的构建..."
                make target/linux-clean 2>/dev/null || true
                sleep 5
              fi
              
              if make -j$JOBS V=s 2>&1; then
                if [ -d "bin/targets" ] && find bin/targets -name "*.bin" 2>/dev/null | grep -q .; then
                  echo "✅ 编译成功"
                  COMPILE_SUCCESS=true
                  echo "BUILD_STATUS=success" >> $GITHUB_ENV
                  break
                else
                  echo "⚠️ 编译完成但未生成固件"
                fi
              else
                echo "❌ 编译失败"
                if [ $attempt -eq $MAX_ATTEMPTS ]; then
                  echo "❌ 所有编译尝试都失败"
                  echo "BUILD_STATUS=failed" >> $GITHUB_ENV
                  exit 1
                fi
                sleep 10
              fi
            done
            
            echo "✅ 固件编译完成"
          } >> $MAIN_LOG

      - name: "🎯 验证工厂镜像"
        if: env.BUILD_STATUS == 'success'
        run: |
          {
            echo "=== 🎯 验证工厂镜像 ==="
            cd $SOURCE_DIR
            
            ASUS_FACTORY=$(find bin/targets -name "*asus*rt-ac42u*" -o -name "*rt-ac42u*" | grep -i factory || true)
            
            if [ -n "$ASUS_FACTORY" ]; then
              echo "✅ 工厂镜像已生成:"
              for img in $ASUS_FACTORY; do
                size=$(du -h "$img" | cut -f1)
                echo "  - $(basename "$img") ($size)"
              done
              echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
            else
              echo "❌ 未找到工厂镜像"
              echo "FACTORY_EXISTS=false" >> $GITHUB_ENV
              
              # 尝试专门编译工厂镜像
              echo "🔄 尝试专门编译工厂镜像..."
              make target/install -j1 V=s 2>&1 || true
            fi
          } >> $MAIN_LOG

      - name: "📦 收集构建产物"
        if: env.BUILD_STATUS == 'success'
        run: |
          {
            echo "=== 📦 收集构建产物 ==="
            cd $SOURCE_DIR
            
            mkdir -p $ARTIFACTS_DIR/firmware
            
            # 查找所有固件文件
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) > $ARTIFACTS_DIR/firmware-list.txt
            FIRMWARE_COUNT=$(wc -l < $ARTIFACTS_DIR/firmware-list.txt)
            
            echo "📦 复制 $FIRMWARE_COUNT 个固件文件..."
            COPIED_COUNT=0
            while IFS= read -r firmware; do
              if [ -f "$firmware" ]; then
                cp "$firmware" $ARTIFACTS_DIR/firmware/ 2>/dev/null && COPIED_COUNT=$((COPIED_COUNT+1)) || true
              fi
            done < $ARTIFACTS_DIR/firmware-list.txt
            
            echo "✅ 成功复制 $COPIED_COUNT 个固件文件"
            echo "FIRMWARE_COUNT=$COPIED_COUNT" >> $GITHUB_ENV
          } >> $MAIN_LOG

      - name: "📋 智能日志分析与报告"
        if: always()
        timeout-minutes: 5
        run: |
          echo "=== 📋 智能日志分析与报告 ==="
          
          # 完成主日志
          {
            echo "=========================================="
            echo "🏁 构建结束时间: $(date)"
            echo "📊 最终状态: ${{ env.BUILD_STATUS || 'unknown' }}"
            echo "📦 固件数量: ${{ env.FIRMWARE_COUNT || 0 }}"
            echo "🏭 工厂镜像: ${{ env.FACTORY_EXISTS || 'unknown' }}"
            echo "=========================================="
          } >> $MAIN_LOG
          
          # 创建错误分析目录
          ERROR_REPORT_DIR="$ARTIFACTS_DIR/error-analysis"
          mkdir -p "$ERROR_REPORT_DIR"
          
          # 生成时间线错误报告
          TIMELINE_ERRORS="$ERROR_REPORT_DIR/timeline_errors.txt"
          echo "=== 🕒 时间线错误报告 ===" > "$TIMELINE_ERRORS"
          echo "生成时间: $(date)" >> "$TIMELINE_ERRORS"
          echo "构建状态: ${{ env.BUILD_STATUS || 'unknown' }}" >> "$TIMELINE_ERRORS"
          echo "==========================================" >> "$TIMELINE_ERRORS"
          
          # 从主日志提取关键错误
          if [ -f "$MAIN_LOG" ]; then
            echo "🔍 关键错误时间线:" >> "$TIMELINE_ERRORS"
            grep -n -i -A2 -B1 "error\|failed\|fatal" "$MAIN_LOG" >> "$TIMELINE_ERRORS" 2>/dev/null || echo "无严重错误" >> "$TIMELINE_ERRORS"
            
            echo "" >> "$TIMELINE_ERRORS"
            echo "⚠️ 警告信息:" >> "$TIMELINE_ERRORS"
            grep -n -i "warning" "$MAIN_LOG" | head -10 >> "$TIMELINE_ERRORS" 2>/dev/null || echo "无警告信息" >> "$TIMELINE_ERRORS"
          else
            echo "主日志文件不存在" >> "$TIMELINE_ERRORS"
          fi
          
          # 生成错误统计
          STATS_REPORT="$ERROR_REPORT_DIR/error_statistics.txt"
          echo "=== 📊 错误统计 ===" > "$STATS_REPORT"
          if [ -f "$MAIN_LOG" ]; then
            echo "总日志行数: $(wc -l < "$MAIN_LOG" 2>/dev/null || echo 0)" >> "$STATS_REPORT"
            echo "错误数量: $(grep -c -i "error" "$MAIN_LOG" 2>/dev/null || echo 0)" >> "$STATS_REPORT"
            echo "失败数量: $(grep -c -i "failed" "$MAIN_LOG" 2>/dev/null || echo 0)" >> "$STATS_REPORT"
            echo "警告数量: $(grep -c -i "warning" "$MAIN_LOG" 2>/dev/null || echo 0)" >> "$STATS_REPORT"
          else
            echo "主日志文件不存在" >> "$STATS_REPORT"
          fi
          
          echo "✅ 智能日志分析完成"

      - name: "💾 上传构建产物"
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Build-Artifacts-${{ github.run_number }}"
          path: |
            $ARTIFACTS_DIR
            $BUILD_LOG_DIR
          retention-days: 30
          compression-level: 9

      - name: "🧹 清理环境"
        if: always()
        run: |
          echo "=== 🧹 清理环境 ==="
          # 禁用交换文件
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          # 显示ccache统计
          ccache -s 2>/dev/null || echo "ccache不可用"
          echo "✅ 环境清理完成"

      - name: "📊 最终构建报告"
        if: always()
        run: |
          echo "=== 📊 最终构建报告 ==="
          echo ""
          echo "🎯 构建摘要"
          echo "=========================================="
          echo "📦 源码信息:"
          echo "  - 预设: ${{ env.SOURCE_PRESET || 'unknown' }}"
          echo "  - 分支: ${{ env.ACTUAL_BRANCH || 'unknown' }}"
          echo "  - 提交: ${{ env.COMMIT_HASH || 'unknown' }}"
          echo ""
          echo "📈 构建结果:"
          echo "  - 状态: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - 固件数量: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - 工厂镜像: ${{ env.FACTORY_EXISTS || 'unknown' }}"
          echo ""
          
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            if [ "${{ env.FACTORY_EXISTS }}" = "true" ]; then
              echo "🎉 构建成功！工厂镜像已生成"
            else
              echo "⚠️ 构建成功但未生成工厂镜像"
            fi
          else
            echo "❌ 构建失败"
            echo ""
            echo "🔍 请查看 error-analysis 目录中的错误报告"
          fi
          echo ""
          echo "⏰ 完成时间: $(date)"
          echo "=========================================="
