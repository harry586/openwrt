name: Universal Firmware Builder - Complete Version

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: ÈÄâÊã©Ê∫êÁ†ÅÂ∫ì
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: immortalwrt
      source_branch:
        description: Ê∫êÁ†ÅÂàÜÊîØ
        required: true
        default: auto
        type: string
      config_profile:
        description: ËÆæÂ§áÈÖçÁΩÆÊñá‰ª∂Ë∑ØÂæÑ
        required: true
        type: string
        default: .config_rt-ac42u_immortalwrt
      build_optimization:
        description: ÁºñËØë‰ºòÂåñÁ≠ñÁï•
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: balanced
      toolchain_strategy:
        description: Â∑•ÂÖ∑ÈìæÁ≠ñÁï•
        required: true
        type: choice
        options:
          - prebuilt
          - local
          - auto
        default: auto
      enable_custom_features:
        description: ÂêØÁî®Ëá™ÂÆö‰πâÂäüËÉΩ
        required: false
        default: true
        type: boolean
      fix_common_issues:
        description: Ëá™Âä®‰øÆÂ§çÂ∏∏ËßÅÈóÆÈ¢ò
        required: false
        default: true
        type: boolean
      enable_pre_download:
        description: ÂêØÁî®È¢Ñ‰∏ãËΩΩÈ™åËØÅ
        required: false
        default: true
        type: boolean
      enable_post_verify:
        description: ÂêØÁî®ÁºñËØëÂêéÈ™åËØÅ
        required: false
        default: true
        type: boolean

env:
  TZ: Asia/Shanghai
  SOURCE_DIR: /mnt/source
  ARTIFACTS_DIR: /mnt/artifacts
  CCACHE_DIR: /mnt/ccache
  BUILD_LOG_DIR: /mnt/build-logs
  DOWNLOAD_DIR: /mnt/downloads
  TOOLCHAIN_LOG_DIR: /mnt/toolchain-logs

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      - name: üì• Ê£ÄÂá∫ÈÖçÁΩÆ‰ªìÂ∫ì
        uses: actions/checkout@v4
        with:
          path: .
          fetch-depth: 0

      - name: üíæ Êô∫ËÉΩÁ≥ªÁªüËµÑÊ∫êÂàÜÊûê
        timeout-minutes: 2
        run: |
          echo "=== Êô∫ËÉΩÁ≥ªÁªüËµÑÊ∫êÂàÜÊûê ==="
          echo "üìä Á£ÅÁõòÁ©∫Èó¥:"
          df -h
          echo ""
          echo "üíª CPU ‰ø°ÊÅØ:"
          echo "Ê†∏ÂøÉÊï∞: $(nproc)"
          echo "Êû∂ÊûÑ: $(uname -m)"
          echo "CPU ÂûãÂè∑: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d: -f2 | sed 's/^ *//')"
          echo ""
          echo "üß† ÂÜÖÂ≠ò‰ø°ÊÅØ:"
          free -h
          echo ""
          echo "üîÑ ‰∫§Êç¢Á©∫Èó¥: $(swapon --show | wc -l 2>/dev/null || echo 0) ‰∏™‰∫§Êç¢Êñá‰ª∂"
          echo ""
          ROOT_AVAILABLE=$(df / | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "Ê†πÂàÜÂå∫ÂèØÁî®Á©∫Èó¥: ${ROOT_AVAILABLE}GB"
          if [ "$ROOT_AVAILABLE" -lt 5 ]; then
            echo "üö® Ë≠¶Âëä: Ê†πÂàÜÂå∫Á©∫Èó¥‰∏çË∂≥5GBÔºåÂèØËÉΩÂΩ±ÂìçÁ≥ªÁªüÁ®≥ÂÆöÊÄß"
          fi
          echo "‚úÖ ËµÑÊ∫êÂàÜÊûêÂÆåÊàê - Á≥ªÁªüÂ∞±Áª™"

      - name: üíæ Â¢ûÂº∫ÂÜÖÂ≠òÁÆ°ÁêÜ‰∏éÁéØÂ¢ÉËÆæÁΩÆ
        run: |
          echo "=== Â¢ûÂº∫ÂÜÖÂ≠òÁÆ°ÁêÜ‰∏éÁéØÂ¢ÉËÆæÁΩÆ ==="
          MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}' 2>/dev/null || echo 0)
          echo "/mnt ÂàÜÂå∫ÂèØÁî®Á©∫Èó¥: ${MNT_AVAILABLE}GB"
          if [ "$MNT_AVAILABLE" -lt 15 ]; then
            echo "üö® ‰∏•ÈáçÈîôËØØ: /mnt ÂàÜÂå∫Á©∫Èó¥‰∏çË∂≥15GBÔºåÊó†Ê≥ïÁºñËØë"
            exit 1
          elif [ "$MNT_AVAILABLE" -lt 25 ]; then
            echo "‚ö†Ô∏è Ë≠¶Âëä: /mnt ÂàÜÂå∫Á©∫Èó¥Á¥ßÂº† (${MNT_AVAILABLE}GB)"
          else
            echo "‚úÖ /mnt ÂàÜÂå∫Á©∫Èó¥ÂÖÖË∂≥"
          fi
          echo "üîÑ ÂàõÂª∫16GB‰∫§Êç¢Êñá‰ª∂..."
          if [ -f /mnt/swapfile ]; then
            sudo swapoff /mnt/swapfile 2>/dev/null || true
            sudo rm -f /mnt/swapfile 2>/dev/null || true
          fi
          sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=16384 status=progress || sudo fallocate -l 16G /mnt/swapfile || sudo truncate -s 16G /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          echo "üìä ÂΩìÂâçÂÜÖÂ≠òÁä∂ÊÄÅ:"
          free -h
          echo "‰∫§Êç¢Á©∫Èó¥:"
          swapon --show
          echo "‚ö° ‰ºòÂåñÂÜÖÂ≠òÂèÇÊï∞..."
          sudo sysctl -w vm.swappiness=80 2>/dev/null || echo "‚ö†Ô∏è Êó†Ê≥ïËÆæÁΩÆswappiness"
          sudo sysctl -w vm.vfs_cache_pressure=50 2>/dev/null || echo "‚ö†Ô∏è Êó†Ê≥ïËÆæÁΩÆvfs_cache_pressure"
          echo "üîß ÂàõÂª∫Â∑•‰ΩúÁõÆÂΩï..."
          sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chown -R $USER:$USER ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chmod -R 755 ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }}
          sudo chmod -R 777 ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          echo "üìä ËÆæÁΩÆÂêéÁ£ÅÁõòÁ©∫Èó¥Áä∂ÊÄÅ:"
          df -h

      - name: üõ†Ô∏è ÂÖ®Èù¢ÁºñËØë‰æùËµñÂÆâË£Ö‰∏éÈ™åËØÅ
        run: |
          echo "ÂÆâË£ÖÂÖ®Èù¢ÁºñËØë‰æùËµñÂåÖ..."
          sudo apt-get update
          echo "üì¶ ÂÆâË£ÖÂü∫Á°ÄÁºñËØëÂ∑•ÂÖ∑..."
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib
          echo "üì¶ ÂÆâË£ÖÂºÄÂèëÂ∫ì..."
          sudo apt-get install -y gettext git libncurses5-dev libssl-dev python3 python3-pip python3-setuptools
          echo "üì¶ ÂÆâË£ÖÂ∑•ÂÖ∑Èìæ‰æùËµñ..."
          sudo apt-get install -y rsync unzip zlib1g-dev file wget jq ccache m4 help2man texinfo texi2html
          echo "üì¶ ÂÆâË£ÖÊûÑÂª∫Â∑•ÂÖ∑..."
          sudo apt-get install -y libtool-bin automake autoconf pkg-config subversion mercurial curl cmake ninja-build
          echo "üì¶ ÂÆâË£ÖÁ≥ªÁªüÂ∫ì..."
          sudo apt-get install -y libelf-dev libssl-dev zlib1g-dev libc6-dev libxml2-dev liblzma-dev liblzo2-dev
          echo "üîç ‰æùËµñÂÆâË£ÖÈ™åËØÅ..."
          echo "=== ÂÖ≥ÈîÆÂ∑•ÂÖ∑È™åËØÅ ==="
          for tool in gcc g++ make flex bison git curl wget ninja; do
            if command -v $tool >/dev/null 2>&1; then
              version=$($tool --version 2>/dev/null | head -1 | cut -d' ' -f1-4 | tr -d '\n' || echo "ÂèØÁî®")
              echo "‚úÖ $tool: $version"
            else
              echo "‚ùå $tool: Êú™ÂÆâË£Ö"
              exit 1
            fi
          done
          echo "‚úÖ ÊâÄÊúâ‰æùËµñÂÆâË£ÖÂíåÈ™åËØÅÂÆåÊàê"

      - name: ‚ö° È´òÁ∫ßÁºìÂ≠ò‰∏éÊÄßËÉΩ‰ºòÂåñ
        run: |
          echo "ËÆæÁΩÆÈ´òÁ∫ßÁºìÂ≠ò‰∏éÊÄßËÉΩ‰ºòÂåñ..."
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache -M 16G
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=200000
          ccache -o sloppiness=file_macro,include_file_mtime,include_file_ctime,time_macros
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=16G" >> $GITHUB_ENV
          echo "CCACHE_SLOPPINESS=file_macro,include_file_mtime,include_file_ctime,time_macros" >> $GITHUB_ENV
          echo "üìä ÂàùÂßãCCacheÁªüËÆ°:"
          ccache -s
          echo "‚úÖ ÁºìÂ≠ò‰∏éÊÄßËÉΩ‰ºòÂåñÂÆåÊàê"

      - name: üîç Êô∫ËÉΩÊñá‰ª∂ÂèëÁé∞‰∏éÈÖçÁΩÆÂàÜÊûê
        id: file-discovery
        run: |
          echo "=== Êô∫ËÉΩÊñá‰ª∂ÂèëÁé∞‰∏éÈÖçÁΩÆÂàÜÊûê ==="
          set +o pipefail
          echo "üìã Êü•Êâæ repositories.json Êñá‰ª∂..."
          REPO_JSON_FOUND=$(find . -maxdepth 3 -name "repositories.json" -type f 2>/dev/null | head -1)
          if [ -n "$REPO_JSON_FOUND" ]; then
            echo "‚úÖ ÊâæÂà∞ repositories.json: $REPO_JSON_FOUND"
            echo "REPO_JSON_PATH=$REPO_JSON_FOUND" >> $GITHUB_ENV
            echo "üìä repositories.json ÂÜÖÂÆπÂàÜÊûê:"
            jq -r '.repositories | keys[] as $k | "  - \($k): \(.[$k].description // "Êó†ÊèèËø∞")"' "$REPO_JSON_FOUND" 2>/dev/null || echo "Êó†Ê≥ïËß£ÊûêJSONÂÜÖÂÆπ"
          else
            echo "‚ùå Êú™ÊâæÂà∞ repositories.json Êñá‰ª∂"
            exit 1
          fi
          echo "üìã Êô∫ËÉΩÊü•ÊâæÊâÄÊúâÈÖçÁΩÆÊñá‰ª∂..."
          CONFIG_PATTERNS=(".config_*" "config_*" "*.config")
          ALL_CONFIG_FILES=""
          for pattern in "${CONFIG_PATTERNS[@]}"; do
            echo "ÊêúÁ¥¢Ê®°Âºè: $pattern"
            found_files=$(find . -maxdepth 3 -name "$pattern" -type f 2>/dev/null | head -10)
            if [ -n "$found_files" ]; then
              ALL_CONFIG_FILES="$ALL_CONFIG_FILES"$'\n'"$found_files"
              echo "ÊâæÂà∞Êñá‰ª∂:"
              echo "$found_files"
            fi
          done
          if [ -n "$ALL_CONFIG_FILES" ]; then
            CONFIG_COUNT=$(echo "$ALL_CONFIG_FILES" | grep -v '^$' | wc -l)
            echo "‚úÖ ÊÄªÂÖ±ÊâæÂà∞ $CONFIG_COUNT ‰∏™ÈÖçÁΩÆÊñá‰ª∂"
            echo "CONFIG_FILES_FOUND=true" >> $GITHUB_ENV
            echo "$ALL_CONFIG_FILES" > ${{ env.BUILD_LOG_DIR }}/all_config_files.txt
          else
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞‰ªª‰ΩïÈÖçÁΩÆÊñá‰ª∂"
            echo "CONFIG_FILES_FOUND=false" >> $GITHUB_ENV
          fi
          
          echo "üìã Êô∫ËÉΩÊü•ÊâæËá™ÂÆö‰πâÂäüËÉΩÁõÆÂΩï..."
          CUSTOM_DIR_PATTERNS=("custom-features" "custom" "features" "firmware-config" "diyscript")
          CUSTOM_FEATURES_DIR=""
          for pattern in "${CUSTOM_DIR_PATTERNS[@]}"; do
            echo "ÊêúÁ¥¢ÁõÆÂΩï: $pattern"
            found_dir=$(find . -maxdepth 2 -type d -name "$pattern" 2>/dev/null | head -1)
            if [ -n "$found_dir" ]; then
              # Â∞ÜÁõ∏ÂØπË∑ØÂæÑËΩ¨Êç¢‰∏∫ÁªùÂØπË∑ØÂæÑ
              if [[ "$found_dir" == ./* ]]; then
                CUSTOM_FEATURES_DIR="$GITHUB_WORKSPACE/${found_dir#./}"
              else
                CUSTOM_FEATURES_DIR="$GITHUB_WORKSPACE/$found_dir"
              fi
              echo "‚úÖ ÊâæÂà∞Ëá™ÂÆö‰πâÂäüËÉΩÁõÆÂΩï: $found_dir (ÁªùÂØπË∑ØÂæÑ: $CUSTOM_FEATURES_DIR)"
              break
            fi
          done
          
          if [ -n "$CUSTOM_FEATURES_DIR" ]; then
            echo "CUSTOM_FEATURES_DIR=$CUSTOM_FEATURES_DIR" >> $GITHUB_ENV
            echo "üîç Ëá™ÂÆö‰πâÁõÆÂΩïËØ¶ÁªÜÂàÜÊûê:"
            echo "üìÅ ÁõÆÂΩïÁªìÊûÑ:"
            find "$CUSTOM_FEATURES_DIR" -type f 2>/dev/null | head -20
          else
            echo "‚ÑπÔ∏è Êú™ÊâæÂà∞Ëá™ÂÆö‰πâÂäüËÉΩÁõÆÂΩï"
            echo "CUSTOM_FEATURES_DIR=" >> $GITHUB_ENV
          fi
          
          set -o pipefail
          echo "‚úÖ Êô∫ËÉΩÊñá‰ª∂ÂèëÁé∞ÂÆåÊàê"

      - name: üîß Êô∫ËÉΩÊ∫êÁ†ÅÈÖçÁΩÆËß£Êûê
        id: source-config
        run: |
          echo "Ê≠£Âú®Êô∫ËÉΩËß£ÊûêÊ∫êÁ†ÅÈÖçÁΩÆ..."
          PRESET="${{ github.event.inputs.source_preset }}"
          echo "‰ΩøÁî®ÁöÑÈ¢ÑËÆæ: $PRESET"
          REPO_JSON_PATH="${{ env.REPO_JSON_PATH }}"
          
          if ! jq -e ".repositories.$PRESET" "$REPO_JSON_PATH" >/dev/null 2>&1; then
            echo "‚ùå ÈîôËØØ: È¢ÑËÆæ '$PRESET' ‰∏çÂ≠òÂú®"
            echo "ÂèØÁî®ÁöÑÈ¢ÑËÆæ:"
            jq -r '.repositories | keys[]' "$REPO_JSON_PATH"
            exit 1
          fi
          
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_PATH")
          DESCRIPTION=$(jq -r ".repositories.$PRESET.description // \"Êú™Áü•\"" "$REPO_JSON_PATH")
          RECOMMENDED_BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_PATH")
          echo "‚úÖ ÊàêÂäüËé∑ÂèñÈÖçÁΩÆ‰ø°ÊÅØ"
          
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH="$RECOMMENDED_BRANCH"
            echo "ü§ñ Ëá™Âä®ÈÄâÊã©Êé®ËçêÂàÜÊîØ: $BRANCH"
          else
            echo "üìã ‰ΩøÁî®ÊåáÂÆöÂàÜÊîØ: $BRANCH"
          fi
          
          echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
          echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "RECOMMENDED_BRANCH=$RECOMMENDED_BRANCH" >> $GITHUB_ENV
          
          echo ""
          echo "‚úÖ Ê∫êÁ†ÅÈÖçÁΩÆËß£ÊûêÂÆåÊàê"
          echo "üìä ÈÖçÁΩÆËØ¶ÊÉÖ:"
          echo "  - È¢ÑËÆæ: $PRESET"
          echo "  - ÊèèËø∞: $DESCRIPTION"
          echo "  - ‰ªìÂ∫ì: $SOURCE_URL"
          echo "  - ÂàÜÊîØ: $BRANCH"
          echo "  - Êé®ËçêÂàÜÊîØ: $RECOMMENDED_BRANCH"

      - name: üì• Êô∫ËÉΩÊ∫êÁ†ÅËé∑Âèñ‰∏éÂàÜÊîØÂ§ÑÁêÜ
        id: clone-source
        run: |
          echo "ÂºÄÂßãÊô∫ËÉΩÊ∫êÁ†ÅËé∑Âèñ‰∏éÂàÜÊîØÂ§ÑÁêÜ..."
          cd ${{ env.SOURCE_DIR }}
          REQUESTED_BRANCH="${{ env.SOURCE_BRANCH }}"
          SOURCE_URL="${{ env.SOURCE_URL }}"
          echo "üéØ ËØ∑Ê±ÇÂàÜÊîØ: $REQUESTED_BRANCH"
          echo "üéØ Ê∫êÁ†Å‰ªìÂ∫ì: $SOURCE_URL"
          echo "üßπ Ê∏ÖÁêÜÊ∫êÁ†ÅÁõÆÂΩï..."
          rm -rf .[!.]* * 2>/dev/null || true
          CLONE_STRATEGIES=("ÊåáÂÆöÂàÜÊîØÊ∑±Â∫¶ÂÖãÈöÜ: git clone --depth 1 --branch $REQUESTED_BRANCH $SOURCE_URL ." "mainÂàÜÊîØÊ∑±Â∫¶ÂÖãÈöÜ: git clone --depth 1 --branch main $SOURCE_URL ." "masterÂàÜÊîØÊ∑±Â∫¶ÂÖãÈöÜ: git clone --depth 1 --branch master $SOURCE_URL ." "ÈªòËÆ§ÂàÜÊîØÊ∑±Â∫¶ÂÖãÈöÜ: git clone --depth 1 $SOURCE_URL ." "ÂÆåÊï¥ÂÖãÈöÜ: git clone $SOURCE_URL .")
          if [ "$REQUESTED_BRANCH" = "auto" ]; then
            RECOMMENDED_BRANCH="${{ env.RECOMMENDED_BRANCH }}"
            if [ -n "$RECOMMENDED_BRANCH" ] && [ "$RECOMMENDED_BRANCH" != "null" ]; then
              CLONE_STRATEGIES=("Êé®ËçêÂàÜÊîØÊ∑±Â∫¶ÂÖãÈöÜ: git clone --depth 1 --branch $RECOMMENDED_BRANCH $SOURCE_URL ." "${CLONE_STRATEGIES[@]}")
            fi
          fi
          CLONE_SUCCESS=false
          CLONE_ERROR=""
          ACTUAL_BRANCH=""
          for strategy in "${CLONE_STRATEGIES[@]}"; do
            strategy_name=$(echo "$strategy" | cut -d: -f1)
            clone_cmd=$(echo "$strategy" | cut -d: -f2-)
            echo ""
            echo "üîÑ Â∞ùËØïÁ≠ñÁï•: $strategy_name"
            echo "ÂëΩ‰ª§: $clone_cmd"
            rm -rf .[!.]* * 2>/dev/null || true
            if eval $clone_cmd 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/clone.log; then
              if [ -d ".git" ]; then
                ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
                COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
                echo "‚úÖ ÂÖãÈöÜÊàêÂäü: $strategy_name"
                echo "üìã ÂÆûÈôÖÂàÜÊîØ: $ACTUAL_BRANCH"
                echo "üîó Êèê‰∫§ÂìàÂ∏å: $COMMIT_HASH"
                if [ -f "scripts/feeds" ]; then
                  echo "‚úÖ ÂÖ≥ÈîÆÊñá‰ª∂ 'scripts/feeds' Â≠òÂú®"
                  CLONE_SUCCESS=true
                  break
                else
                  echo "‚ùå ÂÖ≥ÈîÆÊñá‰ª∂ 'scripts/feeds' ‰∏çÂ≠òÂú®ÔºåÁªßÁª≠Â∞ùËØïÂÖ∂‰ªñÁ≠ñÁï•..."
                  CLONE_ERROR="ÂÖ≥ÈîÆÊñá‰ª∂Áº∫Â§±"
                  echo "üìÅ ÂΩìÂâçÁõÆÂΩïÁªìÊûÑ:"
                  ls -la | head -10
                fi
              else
                CLONE_ERROR="GitÁõÆÂΩïÊú™ÂàõÂª∫"
                echo "‚ö†Ô∏è GitÁõÆÂΩïÊú™ÂàõÂª∫ÔºåÁªßÁª≠Â∞ùËØïÂÖ∂‰ªñÁ≠ñÁï•..."
              fi
            else
              CLONE_ERROR="ÂÖãÈöÜÂëΩ‰ª§ÊâßË°åÂ§±Ë¥•"
              echo "‚ùå Á≠ñÁï•Â§±Ë¥•: $strategy_name"
              if [ -f "${{ env.BUILD_LOG_DIR }}/clone.log" ]; then
                echo "ÂÖãÈöÜÈîôËØØËØ¶ÊÉÖ:"
                tail -20 ${{ env.BUILD_LOG_DIR }}/clone.log
              fi
            fi
          done
          if [ "$CLONE_SUCCESS" = "false" ]; then
            echo "‚ùå ÊâÄÊúâÂÖãÈöÜÁ≠ñÁï•ÈÉΩÂ§±Ë¥•"
            echo "üîç ÊúÄÂêéÂ∞ùËØïÁöÑÂÖãÈöÜÊó•Âøó:"
            cat ${{ env.BUILD_LOG_DIR }}/clone.log 2>/dev/null || echo "Êó†ÂÖãÈöÜÊó•Âøó"
            echo "ÈîôËØØ: $CLONE_ERROR"
            exit 1
          fi
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo ""
          echo "üîç Ê∫êÁ†Å‰ªìÂ∫ìÊ∑±Â∫¶È™åËØÅ..."
          echo "üìÅ Ê∫êÁ†ÅÁõÆÂΩïÁªìÊûÑ:"
          ls -la | head -10
          echo ""
          echo "üîß È™åËØÅÂÖ≥ÈîÆÊñá‰ª∂:"
          for file in scripts/feeds include/toplevel.mk package/Makefile; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file: Â≠òÂú®"
            else
              echo "‚ùå $file: Áº∫Â§±"
            fi
          done
          echo "‚úÖ Ê∫êÁ†ÅËé∑Âèñ‰∏éÈ™åËØÅÂÆåÊàê"

      - name: üíæ Ê∫êÁ†ÅËé∑ÂèñÂêéÁ©∫Èó¥ÁõëÊµã
        run: |
          echo "=== Ê∫êÁ†ÅËé∑ÂèñÂêéÁ©∫Èó¥ÁõëÊµã ==="
          echo "üìä ÂΩìÂâçÁ£ÅÁõò‰ΩøÁî®ÊÉÖÂÜµ:"
          df -h
          ROOT_AVAILABLE=$(df / | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "Ê†πÂàÜÂå∫ÂèØÁî®Á©∫Èó¥: ${ROOT_AVAILABLE}GB"
          echo "/mnt ÂàÜÂå∫ÂèØÁî®Á©∫Èó¥: ${MNT_AVAILABLE}GB"
          if [ "$ROOT_AVAILABLE" -lt 2 ]; then
            echo "üö® ‰∏•ÈáçË≠¶Âëä: Ê†πÂàÜÂå∫Á©∫Èó¥‰∏çË∂≥2GBÔºåÂèØËÉΩÂΩ±ÂìçÁ≥ªÁªüÁ®≥ÂÆöÊÄß"
          fi
          if [ "$MNT_AVAILABLE" -lt 10 ]; then
            echo "üö® ‰∏•ÈáçÈîôËØØ: /mnt ÂàÜÂå∫Á©∫Èó¥‰∏çË∂≥10GBÔºåÊó†Ê≥ïÁºñËØë"
            exit 1
          elif [ "$MNT_AVAILABLE" -lt 20 ]; then
            echo "‚ö†Ô∏è Ë≠¶Âëä: /mnt ÂàÜÂå∫Á©∫Èó¥Á¥ßÂº† (${MNT_AVAILABLE}GB)"
          else
            echo "‚úÖ /mnt ÂàÜÂå∫Á©∫Èó¥ÂÖÖË∂≥"
          fi

      - name: üîÑ Êô∫ËÉΩÊ∫êÁ†ÅÂàùÂßãÂåñ
        timeout-minutes: 30
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "ÂºÄÂßãÊô∫ËÉΩÊ∫êÁ†ÅÂàùÂßãÂåñ..."
          START_TIME=$(date +%s)
          echo "üîç È™åËØÅÊ∫êÁ†ÅÂÆåÊï¥ÊÄß..."
          if [ ! -f "scripts/feeds" ]; then
            echo "‚ùå ÈîôËØØ: scripts/feeds Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåÊ∫êÁ†ÅÂèØËÉΩ‰∏çÂÆåÊï¥"
            echo "üìÅ ÂΩìÂâçÁõÆÂΩïÂÜÖÂÆπ:"
            ls -la
            exit 1
          fi
          echo "üîß FeedsÈÖçÁΩÆÊ£ÄÊµã..."
          FEEDS_CONF_FOUND=""
          for feeds_file in feeds.conf feeds.conf.default .feeds.conf .feeds.conf.default; do
            if [ -f "$feeds_file" ]; then
              FEEDS_CONF_FOUND="$feeds_file"
              echo "üìã ‰ΩøÁî®Áé∞Êúâ $feeds_file"
              if [ "$feeds_file" != "feeds.conf" ]; then
                cp "$feeds_file" feeds.conf
              fi
              break
            fi
          done
          if [ -z "$FEEDS_CONF_FOUND" ]; then
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞feedsÈÖçÁΩÆÔºåÂàõÂª∫ÈÄöÁî®ÈÖçÁΩÆ"
            echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
            echo "src-git luci https://git.openwrt.org/feed/luci.git" >> feeds.conf
            echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
            echo "src-git telephony https://git.openwrt.org/feed/telephony.git" >> feeds.conf
            echo "‚úÖ Â∑≤ÂàõÂª∫ÈÄöÁî® feeds.conf"
          fi
          echo "üîÑ Êõ¥Êñ∞Feeds..."
          for i in 1 2 3; do
            echo "Â∞ùËØï $i/3"
            if ./scripts/feeds update -a; then
              echo "‚úÖ FeedsÊõ¥Êñ∞ÊàêÂäü"
              break
            else
              echo "‚ùå FeedsÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØï‰øÆÂ§ç..."
              if [ $i -eq 3 ]; then
                echo "‚ùå FeedsÊõ¥Êñ∞ÂΩªÂ∫ïÂ§±Ë¥•"
                exit 1
              fi
              sleep 5
            fi
          done
          echo "üì¶ ÂÆâË£ÖÂü∫Á°ÄFeeds..."
          FEEDS_LIST="packages luci routing telephony"
          for feed in $FEEDS_LIST; do
            if ./scripts/feeds install -a -p $feed; then
              echo "‚úÖ $feed ÂÆâË£ÖÊàêÂäü"
            else
              echo "‚ö†Ô∏è $feed ÂÆâË£ÖÂ§±Ë¥•"
            fi
          done
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "‚è±Ô∏è FeedsÂàùÂßãÂåñËÄóÊó∂: ${DURATION}Áßí"
          echo "‚úÖ Ê∫êÁ†ÅÂàùÂßãÂåñÂÆåÊàê"

      - name: üéØ Âø´ÈÄüÈÖçÁΩÆÊñá‰ª∂Êü•Êâæ‰∏éÂ∫îÁî®
        timeout-minutes: 1
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "Âø´ÈÄüÈÖçÁΩÆÊñá‰ª∂Êü•Êâæ‰∏éÂ∫îÁî®..."
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "ËæìÂÖ•ÈÖçÁΩÆÊ®°Âºè: $CONFIG_PROFILE"
          echo "üîç Âø´ÈÄüÈÖçÁΩÆÊñá‰ª∂ÊêúÁ¥¢..."
          CONFIG_FOUND=""
          echo "üéØ Áõ¥Êé•Ë∑ØÂæÑÊü•Êâæ..."
          if [ -f "$CONFIG_PROFILE" ]; then
            CONFIG_FOUND="$CONFIG_PROFILE"
            echo "‚úÖ Âú®ÂΩìÂâçÁõÆÂΩïÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂: $CONFIG_FOUND"
          elif [ -f "../$CONFIG_PROFILE" ]; then
            CONFIG_FOUND="../$CONFIG_PROFILE"
            echo "‚úÖ Âú®‰∏äÁ∫ßÁõÆÂΩïÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂: $CONFIG_FOUND"
          elif [ -f "$GITHUB_WORKSPACE/$CONFIG_PROFILE" ]; then
            CONFIG_FOUND="$GITHUB_WORKSPACE/$CONFIG_PROFILE"
            echo "‚úÖ Âú®Â∑•‰ΩúÂå∫ÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂: $CONFIG_FOUND"
          fi
          if [ -z "$CONFIG_FOUND" ]; then
            echo "üîç ÂèóÈôêÊ∑±Â∫¶ÊêúÁ¥¢..."
            CONFIG_FOUND=$(find . -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            if [ -z "$CONFIG_FOUND" ]; then
              CONFIG_FOUND=$(find $GITHUB_WORKSPACE -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            fi
            if [ -n "$CONFIG_FOUND" ]; then
              echo "‚úÖ ÈÄöËøáÂèóÈôêÊêúÁ¥¢ÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂: $CONFIG_FOUND"
            fi
          fi
          if [ -z "$CONFIG_FOUND" ] && [ -f "${{ env.BUILD_LOG_DIR }}/all_config_files.txt" ]; then
            echo "üîç ‰ΩøÁî®Êñá‰ª∂ÂèëÁé∞ÁºìÂ≠ò..."
            CACHED_PATH=$(grep "$CONFIG_PROFILE" "${{ env.BUILD_LOG_DIR }}/all_config_files.txt" | head -1)
            if [ -n "$CACHED_PATH" ]; then
              if [[ "$CACHED_PATH" == ./* ]]; then
                CONFIG_FOUND="$GITHUB_WORKSPACE/${CACHED_PATH#./}"
              else
                CONFIG_FOUND="$CACHED_PATH"
              fi
              if [ -f "$CONFIG_FOUND" ]; then
                echo "‚úÖ ÈÄöËøáÁºìÂ≠òÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂: $CONFIG_FOUND"
              else
                echo "‚ö†Ô∏è ÁºìÂ≠ò‰∏≠ÁöÑÊñá‰ª∂‰∏çÂ≠òÂú®: $CONFIG_FOUND"
                CONFIG_FOUND=""
              fi
            fi
          fi
          if [ -z "$CONFIG_FOUND" ] && [[ "$CONFIG_PROFILE" == *"*"* ]]; then
            echo "üîç Âø´ÈÄüÊ®°ÂºèÂåπÈÖç..."
            CONFIG_FOUND=$(find . -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            if [ -z "$CONFIG_FOUND" ]; then
              CONFIG_FOUND=$(find $GITHUB_WORKSPACE -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            fi
            if [ -n "$CONFIG_FOUND" ]; then
              echo "‚úÖ ÈÄöËøáÊ®°ÂºèÂåπÈÖçÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂: $CONFIG_FOUND"
            fi
          fi
          if [ -z "$CONFIG_FOUND" ]; then
            echo "üîç ÊòæÁ§∫ÂèØÁî®ÈÖçÁΩÆÊñá‰ª∂..."
            AVAILABLE_CONFIGS=$(find . -maxdepth 3 -name "*.config" -o -name ".config_*" -o -name "config_*" 2>/dev/null | head -5)
            if [ -z "$AVAILABLE_CONFIGS" ]; then
              AVAILABLE_CONFIGS=$(find $GITHUB_WORKSPACE -maxdepth 3 -name "*.config" -o -name ".config_*" -o -name "config_*" 2>/dev/null | head -5)
            fi
            if [ -n "$AVAILABLE_CONFIGS" ]; then
              CONFIG_FOUND=$(echo "$AVAILABLE_CONFIGS" | head -1)
              echo "‚ö†Ô∏è ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊâæÂà∞ÁöÑÈÖçÁΩÆÊñá‰ª∂: $CONFIG_FOUND"
              echo "ÂèØÁî®ÈÖçÁΩÆÊñá‰ª∂:"
              echo "$AVAILABLE_CONFIGS"
            fi
          fi
          if [ -n "$CONFIG_FOUND" ]; then
            echo "üìã Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂: $CONFIG_FOUND -> .config"
            if [ -f "$CONFIG_FOUND" ]; then
              cp "$CONFIG_FOUND" .config
              echo "üîç ÈÖçÁΩÆÊñá‰ª∂Âü∫Êú¨‰ø°ÊÅØ:"
              CONFIG_SIZE=$(stat -c%s .config 2>/dev/null || echo "Êú™Áü•")
              echo "  - Êñá‰ª∂: $(basename $CONFIG_FOUND)"
              echo "  - Â§ßÂ∞è: ${CONFIG_SIZE} Â≠óËäÇ"
              echo "  - Êù•Ê∫ê: $CONFIG_FOUND"
              TARGET_ARCH=$(grep "CONFIG_TARGET_ARCH_PACKAGES" .config 2>/dev/null | cut -d= -f2 | tr -d '"' | head -1 || echo "Êú™Áü•")
              echo "  - Êû∂ÊûÑ: $TARGET_ARCH"
              echo "‚úÖ ÈÖçÁΩÆÂ∫îÁî®ÂÆåÊàê"
            else
              echo "‚ùå ÈîôËØØ: ÈÖçÁΩÆÊñá‰ª∂‰∏çÂ≠òÂú®: $CONFIG_FOUND"
              echo "üîç È™åËØÅÊñá‰ª∂Â≠òÂú®ÊÄß..."
              ls -la "$(dirname "$CONFIG_FOUND")" 2>/dev/null || echo "ÁõÆÂΩï‰∏çÂ≠òÂú®"
              exit 1
            fi
          else
            echo "‚ùå ÈîôËØØ: Êó†Ê≥ïÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂ '$CONFIG_PROFILE'"
            echo ""
            echo "üîç Ë∞ÉËØï‰ø°ÊÅØ:"
            echo "ÂΩìÂâçÁõÆÂΩï: $(pwd)"
            echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
            echo "Âø´ÈÄüÈÖçÁΩÆÊñá‰ª∂ÂàóË°®:"
            find . -maxdepth 2 -name "*.config" -o -name ".config_*" 2>/dev/null | head -10 || echo "ÂΩìÂâçÁõÆÂΩïÊó†ÈÖçÁΩÆÊñá‰ª∂"
            find $GITHUB_WORKSPACE -maxdepth 2 -name "*.config" -o -name ".config_*" 2>/dev/null | head -10 || echo "Â∑•‰ΩúÂå∫Êó†ÈÖçÁΩÆÊñá‰ª∂"
            exit 1
          fi

      - name: üîß ËÆæÂ§áÈïúÂÉèÈÖçÁΩÆ‰øÆÂ§ç
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ËÆæÂ§áÈïúÂÉèÈÖçÁΩÆ‰øÆÂ§ç ==="
          echo "üîç Ê£ÄÊü•ÂΩìÂâçÁõÆÊ†áËÆæÂ§áÈÖçÁΩÆ..."
          if [ -f ".config" ]; then
            echo "üìã ÂΩìÂâçËÆæÂ§áÁõ∏ÂÖ≥ÈÖçÁΩÆ:"
            grep -E "CONFIG_TARGET.*asus_rt-ac42u|CONFIG_TARGET_DEVICE|CONFIG_TARGET_.*_DEVICE.*asus" .config | head -20
          fi
          echo "üîß Á°Æ‰øùÂ∑•ÂéÇÈïúÂÉèÁîüÊàêÂêØÁî®..."
          sed -i 's/# CONFIG_TARGET_IMAGES_PACKAGES is not set/CONFIG_TARGET_IMAGES_PACKAGES=y/' .config 2>/dev/null || true
          if grep -q "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u" .config; then
            echo "üéØ ÂêØÁî® asus_rt-ac42u ËÆæÂ§áÈÖçÁΩÆ..."
            sed -i 's/# CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u is not set/CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y/' .config
          else
            echo "üîß Ê∑ªÂä† asus_rt-ac42u ËÆæÂ§áÈÖçÁΩÆ..."
            echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> .config
          fi
          echo "üîß ÂêØÁî®Â∑•ÂéÇÈïúÂÉèÊ†ºÂºè..."
          sed -i 's/# CONFIG_IMAGEOPT is not set/CONFIG_IMAGEOPT=y/' .config 2>/dev/null || true
          sed -i 's/# CONFIG_COMBINED_IMAGES is not set/CONFIG_COMBINED_IMAGES=y/' .config 2>/dev/null || true
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> .config
          echo "CONFIG_TARGET_KERNEL_PARTSIZE=32" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=512" >> .config
          echo "üîÑ ÈáçÊñ∞ËøêË°åÈÖçÁΩÆ..."
          make defconfig >/dev/null 2>&1 || echo "ÈÖçÁΩÆÊõ¥Êñ∞ÂÆåÊàê"
          echo "‚úÖ ËÆæÂ§áÈïúÂÉèÈÖçÁΩÆ‰øÆÂ§çÂÆåÊàê"

      - name: üîß È´òÁ∫ßÊÄßËÉΩ‰ºòÂåñÈÖçÁΩÆ
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "Â∫îÁî®È´òÁ∫ßÊÄßËÉΩ‰ºòÂåñÈÖçÁΩÆ..."
          echo "‚ö° Â∫îÁî®Âü∫Á°Ä‰ºòÂåñ..."
          sed -i 's/CONFIG_DEBUG=y/# CONFIG_DEBUG is not set/' .config 2>/dev/null || true
          sed -i 's/CONFIG_DEVEL=y/# CONFIG_DEVEL is not set/' .config 2>/dev/null || true
          echo "CONFIG_CCACHE=y" >> .config
          case "${{ github.event.inputs.build_optimization }}" in
            "speed")
              echo "üöÄ Â∫îÁî®ÊûÅÈÄü‰ºòÂåñÈÖçÁΩÆ..."
              echo "CONFIG_DEBUG_INFO=n" >> .config
              ;;
            "stability")
              echo "üõ°Ô∏è Â∫îÁî®Á®≥ÂÆö‰ºòÂåñÈÖçÁΩÆ..."
              echo "CONFIG_SMALL_FLASH=y" >> .config
              ;;
            *)
              echo "‚öñÔ∏è Â∫îÁî®Âπ≥Ë°°‰ºòÂåñÈÖçÁΩÆ..."
              ;;
          esac
          echo "üîÑ ËøêË°åÈÖçÁΩÆÂ§ÑÁêÜ..."
          echo "n" | make oldconfig >/dev/null 2>&1 || make defconfig >/dev/null 2>&1 || echo "ÈÖçÁΩÆÂ§ÑÁêÜÂÆåÊàê"
          echo "‚úÖ ÊÄßËÉΩ‰ºòÂåñÈÖçÁΩÆÂÆåÊàê"

      - name: üì¶ ËØ¶ÁªÜËá™ÂÆö‰πâÂäüËÉΩÂ§ÑÁêÜ
        if: github.event.inputs.enable_custom_features == 'true'
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ËØ¶ÁªÜËá™ÂÆö‰πâÂäüËÉΩÂ§ÑÁêÜ ==="
          
          # ‰ΩøÁî®ÈÖçÁΩÆ‰ªìÂ∫ìÁöÑÁªùÂØπË∑ØÂæÑ
          CONFIG_REPO_DIR="$GITHUB_WORKSPACE"
          CUSTOM_FEATURES_DIR="${{ env.CUSTOM_FEATURES_DIR }}"
          
          # Â¶ÇÊûúÁéØÂ¢ÉÂèòÈáè‰∏≠ÊúâËÆæÁΩÆÔºå‰ΩøÁî®ÁéØÂ¢ÉÂèòÈáèÔºåÂê¶ÂàôÂ∞ùËØïÈªòËÆ§Ë∑ØÂæÑ
          if [ -z "$CUSTOM_FEATURES_DIR" ]; then
            CUSTOM_FEATURES_DIR="$CONFIG_REPO_DIR/firmware-config/custom-features"
            echo "‚ÑπÔ∏è ‰ΩøÁî®ÈªòËÆ§Ëá™ÂÆö‰πâÂäüËÉΩÁõÆÂΩï: $CUSTOM_FEATURES_DIR"
          fi
          
          if [ -n "$CUSTOM_FEATURES_DIR" ] && [ -d "$CUSTOM_FEATURES_DIR" ]; then
            echo "üîç ‰ΩøÁî®Ëá™ÂÆö‰πâÂäüËÉΩÁõÆÂΩï: $CUSTOM_FEATURES_DIR"
            
            # È™åËØÅÁõÆÂΩïÂÜÖÂÆπ
            echo "üìÅ ÁõÆÂΩïÂÜÖÂÆπÈ™åËØÅ:"
            ls -la "$CUSTOM_FEATURES_DIR" 2>/dev/null || echo "Êó†Ê≥ïËÆøÈóÆÁõÆÂΩï"
            
            # ËØ¶ÁªÜÂ§ÑÁêÜÈ¢ÑÁºñËØëIPKÂåÖ
            echo "üì¶ ËØ¶ÁªÜÂ§ÑÁêÜÈ¢ÑÁºñËØëIPKÂåÖ..."
            IPK_DIRS=("$CUSTOM_FEATURES_DIR/prebuilt-ipks" "$CUSTOM_FEATURES_DIR/ipks" "$CUSTOM_FEATURES_DIR/packages")
            IPK_PROCESSED=false
            
            for ipk_dir in "${IPK_DIRS[@]}"; do
              if [ -d "$ipk_dir" ]; then
                echo "üîç Ê£ÄÊü•IPKÁõÆÂΩï: $ipk_dir"
                IPK_FILES=$(find "$ipk_dir" -name "*.ipk" -type f 2>/dev/null)
                IPK_COUNT=$(echo "$IPK_FILES" | grep -v '^$' | wc -l 2>/dev/null || echo 0)
                
                if [ "$IPK_COUNT" -gt 0 ]; then
                  echo "‚úÖ Âú® $ipk_dir ÊâæÂà∞ $IPK_COUNT ‰∏™IPKÊñá‰ª∂"
                  mkdir -p package/base-files/files/usr/lib/opkg/custom
                  
                  echo "üìã IPKÊñá‰ª∂ÂàóË°®:"
                  for ipk in $IPK_FILES; do
                    if [ -f "$ipk" ]; then
                      filename=$(basename "$ipk")
                      filesize=$(stat -c%s "$ipk" 2>/dev/null || echo "Êú™Áü•")
                      echo "  - $filename ($(($filesize/1024))KB)"
                      cp "$ipk" package/base-files/files/usr/lib/opkg/custom/
                      echo "    ‚úÖ Â∑≤Â§çÂà∂Âà∞Âõ∫‰ª∂"
                    fi
                  done
                  IPK_PROCESSED=true
                  break
                else
                  echo "‚ÑπÔ∏è ÁõÆÂΩï $ipk_dir ‰∏≠Ê≤°ÊúâÊâæÂà∞IPKÊñá‰ª∂"
                fi
              fi
            done
            
            if [ "$IPK_PROCESSED" = "false" ]; then
              echo "‚ÑπÔ∏è Êú™ÊâæÂà∞‰ªª‰ΩïIPKÊñá‰ª∂"
            fi
            
            # ËØ¶ÁªÜÂ§ÑÁêÜËá™ÂÆö‰πâËÑöÊú¨
            echo ""
            echo "üìú ËØ¶ÁªÜÂ§ÑÁêÜËá™ÂÆö‰πâËÑöÊú¨..."
            SCRIPT_DIRS=("$CUSTOM_FEATURES_DIR/scripts" "$CUSTOM_FEATURES_DIR/script")
            SCRIPT_PROCESSED=false
            
            for script_dir in "${SCRIPT_DIRS[@]}"; do
              if [ -d "$script_dir" ]; then
                echo "üîç Ê£ÄÊü•ËÑöÊú¨ÁõÆÂΩï: $script_dir"
                SCRIPT_FILES=$(find "$script_dir" -name "*.sh" -type f 2>/dev/null)
                SCRIPT_COUNT=$(echo "$SCRIPT_FILES" | grep -v '^$' | wc -l 2>/dev/null || echo 0)
                
                if [ "$SCRIPT_COUNT" -gt 0 ]; then
                  echo "‚úÖ Âú® $script_dir ÊâæÂà∞ $SCRIPT_COUNT ‰∏™ËÑöÊú¨Êñá‰ª∂"
                  
                  echo "üìã ËÑöÊú¨Êñá‰ª∂ÂàóË°®:"
                  for script in $SCRIPT_FILES; do
                    if [ -f "$script" ]; then
                      filename=$(basename "$script")
                      echo "  - $filename"
                      echo "    ‚ñ∂Ô∏è ÊâßË°åËÑöÊú¨..."
                      chmod +x "$script"
                      export SOURCE_DIR="${{ env.SOURCE_DIR }}"
                      export BUILD_DIR="${{ env.SOURCE_DIR }}/build_dir"
                      export STAGING_DIR="${{ env.SOURCE_DIR }}/staging_dir"
                      
                      if timeout 300 bash "$script"; then
                        echo "    ‚úÖ ËÑöÊú¨ÊâßË°åÊàêÂäü"
                      else
                        EXIT_CODE=$?
                        if [ $EXIT_CODE -eq 124 ]; then
                          echo "    ‚è∞ ËÑöÊú¨ÊâßË°åË∂ÖÊó∂"
                        else
                          echo "    ‚ö†Ô∏è ËÑöÊú¨ÊâßË°åÂ§±Ë¥• (ÈÄÄÂá∫Á†Å: $EXIT_CODE)"
                        fi
                      fi
                    fi
                  done
                  SCRIPT_PROCESSED=true
                  break
                else
                  echo "‚ÑπÔ∏è ÁõÆÂΩï $script_dir ‰∏≠Ê≤°ÊúâÊâæÂà∞ËÑöÊú¨Êñá‰ª∂"
                fi
              fi
            done
            
            if [ "$SCRIPT_PROCESSED" = "false" ]; then
              echo "‚ÑπÔ∏è Êú™ÊâæÂà∞‰ªª‰ΩïËÑöÊú¨Êñá‰ª∂"
            fi
            
            # Â§ÑÁêÜËá™ÂÆö‰πâË°•‰∏Å
            echo ""
            echo "üîß Â§ÑÁêÜËá™ÂÆö‰πâË°•‰∏Å..."
            PATCH_FILES=$(find "$CUSTOM_FEATURES_DIR" -name "*.patch" -type f 2>/dev/null)
            PATCH_COUNT=$(echo "$PATCH_FILES" | grep -v '^$' | wc -l 2>/dev/null || echo 0)
            
            if [ "$PATCH_COUNT" -gt 0 ]; then
              echo "‚úÖ ÊâæÂà∞ $PATCH_COUNT ‰∏™Ë°•‰∏ÅÊñá‰ª∂"
              for patch in $PATCH_FILES; do
                if [ -f "$patch" ]; then
                  echo "üîß Â∫îÁî®Ë°•‰∏Å: $(basename $patch)"
                  if patch -p1 -N < "$patch"; then
                    echo "‚úÖ Ë°•‰∏ÅÂ∫îÁî®ÊàêÂäü: $(basename $patch)"
                  else
                    echo "‚ö†Ô∏è Ë°•‰∏ÅÂ∫îÁî®Â§±Ë¥•ÊàñÂ∑≤Â∫îÁî®: $(basename $patch)"
                  fi
                fi
              done
            else
              echo "‚ÑπÔ∏è Êú™ÊâæÂà∞Ë°•‰∏ÅÊñá‰ª∂"
            fi
            
          else
            echo "‚ÑπÔ∏è Êó†Ëá™ÂÆö‰πâÂäüËÉΩÁõÆÂΩïÊàñÁõÆÂΩï‰∏çÂ≠òÂú®ÔºåË∑≥ËøáËá™ÂÆö‰πâÂäüËÉΩÂ§ÑÁêÜ"
            echo "ÊêúÁ¥¢ÁöÑÁõÆÂΩï: $CUSTOM_FEATURES_DIR"
          fi
          echo "‚úÖ Ëá™ÂÆö‰πâÂäüËÉΩÂ§ÑÁêÜÂÆåÊàê"

      - name: üì• ÂÖ®Èù¢È¢Ñ‰∏ãËΩΩ‰∏é‰æùËµñÈ™åËØÅ
        if: github.event.inputs.enable_pre_download == 'true'
        timeout-minutes: 45
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ÂÖ®Èù¢È¢Ñ‰∏ãËΩΩ‰∏é‰æùËµñÈ™åËØÅ ==="
          mkdir -p ${{ env.DOWNLOAD_DIR }}
          echo "üîç Á©∫Èó¥Ê£ÄÊü• - È¢Ñ‰∏ãËΩΩÂâç..."
          DOWNLOAD_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "‰∏ãËΩΩÂâçÂèØÁî®Á©∫Èó¥: ${DOWNLOAD_AVAILABLE}GB"
          if [ "$DOWNLOAD_AVAILABLE" -lt 8 ]; then
            echo "üö® Á©∫Èó¥‰∏çË∂≥: È¢Ñ‰∏ãËΩΩÈúÄË¶ÅËá≥Â∞ë8GBÁ©∫Èó¥"
            exit 1
          fi
          echo "üîç ÂàÜÊûêÈúÄË¶Å‰∏ãËΩΩÁöÑÂåÖ..."
          echo "üìã ÁîüÊàê‰∏ãËΩΩÊ∏ÖÂçï..."
          make target/linux/prepare 2>/dev/null || true
          echo "üì• ÂºÄÂßãÂÖ®Èù¢È¢Ñ‰∏ãËΩΩ..."
          DOWNLOAD_LOG="${{ env.BUILD_LOG_DIR }}/pre-download.log"
          {
            echo "Èò∂ÊÆµ1: ‰∏ãËΩΩÂÜÖÊ†∏Ê∫êÁ†Å..."
            make target/linux/download 2>&1
            echo "Èò∂ÊÆµ2: ‰∏ãËΩΩÂ∑•ÂÖ∑Èìæ..."
            make toolchain/download 2>&1
            echo "Èò∂ÊÆµ3: ‰∏ãËΩΩÊâÄÊúâÂåÖ..."
            make package/download 2>&1
            echo "Èò∂ÊÆµ4: È™åËØÅ‰∏ãËΩΩÂÆåÊï¥ÊÄß..."
            make target/linux/check 2>&1 || true
            make package/check 2>&1 || true
          } 2>&1 | tee "$DOWNLOAD_LOG"
          echo "üîç ‰∏ãËΩΩÁªìÊûúÈ™åËØÅ..."
          echo "üìä ‰∏ãËΩΩÁõÆÂΩïÂÜÖÂÆπ:"
          ls -la dl/ 2>/dev/null | head -20
          echo "üîé Ê£ÄÊü•‰∏ãËΩΩÈîôËØØ..."
          if grep -i "error\|failed\|not found" "$DOWNLOAD_LOG"; then
            echo "‚ö†Ô∏è ÂèëÁé∞‰∏ãËΩΩÈîôËØØÔºå‰ΩÜÁªßÁª≠ÁºñËØëËøáÁ®ã..."
            echo "DOWNLOAD_STATUS=with_errors" >> $GITHUB_ENV
          else
            echo "‚úÖ ÊâÄÊúâ‰∏ãËΩΩÊàêÂäüÂÆåÊàê"
            echo "DOWNLOAD_STATUS=success" >> $GITHUB_ENV
          fi
          echo "üì¶ ‰∏ãËΩΩÊñá‰ª∂ÁªüËÆ°:"
          find dl/ -type f 2>/dev/null | wc -l
          du -sh dl/ 2>/dev/null || echo "‰∏ãËΩΩÁõÆÂΩï‰∏∫Á©∫"
          echo "üîç Á©∫Èó¥Ê£ÄÊü• - È¢Ñ‰∏ãËΩΩÂêé..."
          POST_DOWNLOAD_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "‰∏ãËΩΩÂêéÂèØÁî®Á©∫Èó¥: ${POST_DOWNLOAD_AVAILABLE}GB"
          SPACE_USED=$((DOWNLOAD_AVAILABLE - POST_DOWNLOAD_AVAILABLE))
          echo "‰∏ãËΩΩÂç†Áî®Á©∫Èó¥: ${SPACE_USED}GB"

      - name: üõ†Ô∏è Samba‰∏ìÁî®‰øÆÂ§ç‰∏éÁºñËØë
        if: github.event.inputs.enable_custom_features == 'true'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== Samba‰∏ìÁî®‰øÆÂ§ç‰∏éÁºñËØë ==="
          
          echo "üîß Êô∫ËÉΩÊ£ÄÊµãSamba‰æùËµñÂ∫ìË∑ØÂæÑ..."
          echo "üîç ÊêúÁ¥¢tallocÁõ∏ÂÖ≥ÁõÆÂΩï..."
          find . -name "*talloc*" -type d 2>/dev/null | grep -E "(package|feeds)" | head -10
          echo "üîç ÊêúÁ¥¢tdbÁõ∏ÂÖ≥ÁõÆÂΩï..."
          find . -name "*tdb*" -type d 2>/dev/null | grep -E "(package|feeds)" | head -10
          echo "üîç ÊêúÁ¥¢teventÁõ∏ÂÖ≥ÁõÆÂΩï..."
          find . -name "*tevent*" -type d 2>/dev/null | grep -E "(package|feeds)" | head -10
          echo "üîç ÊêúÁ¥¢ldbÁõ∏ÂÖ≥ÁõÆÂΩï..."
          find . -name "*ldb*" -type d 2>/dev/null | grep -E "(package|feeds)" | head -10
          echo "üîÑ Êõ¥Êñ∞Âπ∂ÂÆâË£ÖSambaÁõ∏ÂÖ≥feeds..."
          ./scripts/feeds update packages 2>/dev/null || true
          ./scripts/feeds install libtalloc 2>/dev/null || echo "‚ö†Ô∏è libtallocÂÆâË£ÖÂ§±Ë¥•"
          ./scripts/feeds install libtdb 2>/dev/null || echo "‚ö†Ô∏è libtdbÂÆâË£ÖÂ§±Ë¥•" 
          ./scripts/feeds install libtevent 2>/dev/null || echo "‚ö†Ô∏è libteventÂÆâË£ÖÂ§±Ë¥•"
          ./scripts/feeds install libldb 2>/dev/null || echo "‚ö†Ô∏è libldbÂÆâË£ÖÂ§±Ë¥•"
          echo "üì¶ ‰ΩøÁî®Á®≥ÂÅ•ÁöÑSamba‰æùËµñÂ∫ìÁºñËØëÊñπÊ≥ï..."
          echo "üîß ÂÖàÁºñËØë‰∏Ä‰∫õÂü∫Á°ÄÂåÖÊµãËØïÁéØÂ¢É..."
          make package/libs/toolchain/compile -j1 V=s 2>/dev/null || echo "‚ö†Ô∏è Â∑•ÂÖ∑ÈìæÁºñËØëÊµãËØïÂ§±Ë¥•"
          SAMBA_DEPS=("talloc" "tdb" "tevent" "ldb")
          SAMBA_SUCCESS=true
          for dep in "${SAMBA_DEPS[@]}"; do
            echo "ÁºñËØë $dep..."
            if make package/$dep/compile -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/samba-$dep.log; then
              echo "‚úÖ $dep ÁºñËØëÊàêÂäü (Ê†áÂáÜË∑ØÂæÑ)"
              continue
            fi
            if make package/feeds/packages/$dep/compile -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/samba-$dep-feeds.log; then
              echo "‚úÖ $dep ÁºñËØëÊàêÂäü (feedsË∑ØÂæÑ)"
              continue
            fi
            if make package/libs/$dep/compile -j1 V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/samba-$dep-libs.log; then
              echo "‚úÖ $dep ÁºñËØëÊàêÂäü (libsË∑ØÂæÑ)"
              continue
            fi
            echo "‚ùå $dep ÊâÄÊúâÁºñËØëÂ∞ùËØïÈÉΩÂ§±Ë¥•Ôºå‰ΩÜÁªßÁª≠ÊµÅÁ®ã..."
            SAMBA_SUCCESS=false
          done
          if [ "$SAMBA_SUCCESS" = "false" ]; then
            echo "‚ö†Ô∏è ÈÉ®ÂàÜSamba‰æùËµñÂ∫ìÁºñËØëÂ§±Ë¥•ÔºåËÄÉËôëÁ¶ÅÁî®Samba"
          else
            echo "‚úÖ ÊâÄÊúâSamba‰æùËµñÂ∫ìÁºñËØëÂÆåÊàê"
          fi
          echo "üîß ‰ºòÂåñÁºñËØëÁéØÂ¢É..."
          export CFLAGS="$CFLAGS -Os -pipe -fno-caller-saves"
          export CXXFLAGS="$CXXFLAGS -Os -pipe -fno-caller-saves"
          echo "‚úÖ Samba‰øÆÂ§çÂÆåÊàê"

      - name: üîß ÁªºÂêàÈóÆÈ¢ò‰øÆÂ§ç
        if: github.event.inputs.fix_common_issues == 'true'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ÊâßË°åÁªºÂêàÈóÆÈ¢ò‰øÆÂ§ç ==="
          echo "üîß Ê∑±Â∫¶ÁõÆÂΩï‰øÆÂ§ç‰∏éÊùÉÈôêËÆæÁΩÆ..."
          echo "ÂàõÂª∫ÁõÆÊ†áÊ†πÊñá‰ª∂Á≥ªÁªüÂøÖË¶ÅÁõÆÂΩï..."
          find build_dir -name "root.orig-*" -type d 2>/dev/null | while read root_dir; do
            echo "‰øÆÂ§çÁõÆÂΩï: $root_dir"
            mkdir -p "$root_dir/tmp"
            mkdir -p "$root_dir/var/lock"
            mkdir -p "$root_dir/var/run"
            mkdir -p "$root_dir/usr/lib/opkg"
            mkdir -p "$root_dir/var/lib/opkg"
            chmod 755 "$root_dir/tmp"
            chmod 755 "$root_dir/var"
            echo "‚úÖ Â∑≤‰øÆÂ§ç: $root_dir"
          done
          echo "üîß ‰øÆÂ§çÂ∑≤Áü•ÁõÆÊ†áÁõÆÂΩïÁªìÊûÑ..."
          KNOWN_ROOTS=("build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/root.orig-ipq40xx" "staging_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/root.orig-ipq40xx" "build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/root-ipq40xx")
          for known_root in "${KNOWN_ROOTS[@]}"; do
            if [ -d "$known_root" ]; then
              echo "üîß ‰øÆÂ§çÂ∑≤Áü•ÁõÆÂΩï: $known_root"
              mkdir -p "$known_root/tmp"
              mkdir -p "$known_root/var/lock"
              mkdir -p "$known_root/var/run"
              mkdir -p "$known_root/usr/lib/opkg"
              mkdir -p "$known_root/var/lib/opkg"
              chmod 755 "$known_root/tmp"
              echo "‚úÖ Â∑≤‰øÆÂ§ç: $known_root"
            else
              echo "‚ÑπÔ∏è ÁõÆÂΩï‰∏çÂ≠òÂú®ÔºåÂàõÂª∫: $known_root"
              mkdir -p "$known_root/tmp" 2>/dev/null || true
            fi
          done
          echo "üîß ÂàõÂª∫ÈÄöÁî®ÁõÆÊ†áÁõÆÂΩïÁªìÊûÑ..."
          TARGET_PATTERN="target-*"
          for target_dir in $TARGET_PATTERN; do
            if [ -d "$target_dir" ]; then
              find "$target_dir" -name "root*" -type d 2>/dev/null | while read root_dir; do
                mkdir -p "$root_dir/tmp"
                mkdir -p "$root_dir/var/lock" 
                mkdir -p "$root_dir/var/run"
                chmod 755 "$root_dir/tmp"
              done
            fi
          done
          echo "üîß ‰øÆÂ§çÂ∑•ÂéÇÈïúÂÉèÈÖçÁΩÆ..."
          if [ -f ".config" ]; then
            echo "üéØ ÂêØÁî®Â∑•ÂéÇÈïúÂÉèÁîüÊàêÈÖçÁΩÆ..."
            sed -i 's/# CONFIG_TARGET_IMAGES_PACKAGES is not set/CONFIG_TARGET_IMAGES_PACKAGES=y/' .config 2>/dev/null || true
            sed -i 's/# CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u is not set/CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y/' .config 2>/dev/null || true
            sed -i 's/# CONFIG_IMAGEOPT is not set/CONFIG_IMAGEOPT=y/' .config 2>/dev/null || true
            sed -i 's/# CONFIG_COMBINED_IMAGES is not set/CONFIG_COMBINED_IMAGES=y/' .config 2>/dev/null || true
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
            echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> .config
            echo "CONFIG_TARGET_ROOTFS_INCLUDE_USB=y" >> .config
            echo "‚úÖ Â∑•ÂéÇÈïúÂÉèÈÖçÁΩÆÂ∑≤‰øÆÂ§ç"
            make defconfig >/dev/null 2>&1 || echo "ÈÖçÁΩÆÊõ¥Êñ∞ÂÆåÊàê"
          fi
          echo "üîß Ê£ÄÊü•ÈóÆÈ¢òÂåÖÂ§ÑÁêÜ..."
          if grep -q "CONFIG_PACKAGE_samba4-server=y" .config 2>/dev/null; then
            echo "‚ö†Ô∏è sambaÂåÖÂ∑≤ÂêØÁî®ÔºåÂ¶ÇÊåÅÁª≠Â§±Ë¥•ÂèØËÄÉËôëÁ¶ÅÁî®"
          fi
          echo "üîß ‰øÆÂ§çÁ¨¶Âè∑ÈìæÊé•..."
          if [ -L "tmp" ] && [ ! -e "tmp" ]; then
            echo "üîß ‰øÆÂ§çÊçüÂùèÁöÑtmpÁ¨¶Âè∑ÈìæÊé•..."
            rm -f tmp
            mkdir -p tmp
            echo "‚úÖ tmpÁ¨¶Âè∑ÈìæÊé•Â∑≤‰øÆÂ§ç"
          fi
          echo "‚úÖ ÁªºÂêàÈóÆÈ¢ò‰øÆÂ§çÂÆåÊàê"

      - name: üõ†Ô∏è ÂÖ®Èù¢Â∑•ÂÖ∑ÈìæÁºñËØë‰∏éÈ™åËØÅ
        timeout-minutes: 90
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "ÂºÄÂßãÂÖ®Èù¢Â∑•ÂÖ∑ÈìæÁºñËØë..."
          START_TIME=$(date +%s)
          mkdir -p ${{ env.TOOLCHAIN_LOG_DIR }}
          echo "üîß ÁºñËØëHostÂ∑•ÂÖ∑..."
          if ! make tools/compile -j$(($(nproc) - 1)) V=sc 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/host-tools.log; then
            echo "‚ùå HostÂ∑•ÂÖ∑ÁºñËØëÂ§±Ë¥•ÔºåÂ∞ùËØïÂçïÁ∫øÁ®ã..."
            if ! make tools/compile -j1 V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/host-tools-single.log; then
              echo "‚ùå HostÂ∑•ÂÖ∑ÁºñËØëÂΩªÂ∫ïÂ§±Ë¥•"
              exit 1
            fi
          fi
          echo "üîß ÁºñËØëÂ∑•ÂÖ∑Èìæ..."
          if ! make toolchain/compile -j$(($(nproc) - 1)) V=sc 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/toolchain-compile.log; then
            echo "‚ùå Â∑•ÂÖ∑ÈìæÁºñËØëÂ§±Ë¥•ÔºåÂ∞ùËØïÂçïÁ∫øÁ®ã..."
            if ! make toolchain/compile -j1 V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/toolchain-compile-single.log; then
              echo "‚ùå Â∑•ÂÖ∑ÈìæÁºñËØëÂΩªÂ∫ïÂ§±Ë¥•"
              exit 1
            fi
          fi
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "‚è±Ô∏è Â∑•ÂÖ∑ÈìæÁºñËØëËÄóÊó∂: ${DURATION}Áßí"
          echo "‚úÖ Â∑•ÂÖ∑ÈìæÁºñËØëÂÆåÊàê"

      - name: üîç Ê∑±Â∫¶Â∑•ÂÖ∑ÈìæÈ™åËØÅ
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== Ê∑±Â∫¶Â∑•ÂÖ∑ÈìæÈ™åËØÅ ==="
          echo "üîß ÂÖ≥ÈîÆÂ∑•ÂÖ∑È™åËØÅ:"
          for tool in m4 flex bison; do
            tool_path=$(find staging_dir/host/bin -name "$tool" -type f 2>/dev/null | head -1)
            if [ -n "$tool_path" ] && [ -x "$tool_path" ]; then
              echo "‚úÖ $tool: ÂèØÁî®"
            else
              echo "‚ùå $tool: Áº∫Â§±"
              exit 1
            fi
          done
          echo "üéØ ÁõÆÊ†áÂ∑•ÂÖ∑ÈìæÈ™åËØÅ:"
          TARGET_GCC=$(find staging_dir/toolchain-*/bin/ -name "*gcc" -type f 2>/dev/null | head -1)
          if [ -n "$TARGET_GCC" ] && [ -x "$TARGET_GCC" ]; then
            echo "‚úÖ ÁõÆÊ†áGCC: ÂèØÁî®"
          else
            echo "‚ùå ÁõÆÊ†áGCC: Áº∫Â§±"
            exit 1
          fi
          echo "‚úÖ Ê∑±Â∫¶Â∑•ÂÖ∑ÈìæÈ™åËØÅÂÆåÊàê"

      - name: üèóÔ∏è Êô∫ËÉΩÁºñËØëÂõ∫‰ª∂ÔºàÂàÜÈò∂ÊÆµ‰ºòÂåñÔºâ
        timeout-minutes: 240
        id: compile-firmware
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "ÂºÄÂßãÊô∫ËÉΩÁºñËØëÂõ∫‰ª∂ÔºàÂàÜÈò∂ÊÆµ‰ºòÂåñÔºâ..."
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=linux
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          BUILD_JOBS=${BUILD_JOBS:-$(( $(nproc) - 1 ))}
          SAMBA_JOBS=${SAMBA_JOBS:-1}
          mkdir -p ${{ env.BUILD_LOG_DIR }}
          START_TIME=$(date +%s)
          echo "üîç ÁºñËØëÂâçÊúÄÁªàÁ©∫Èó¥Ê£ÄÊü•..."
          COMPILE_START_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ÁºñËØëÂºÄÂßãÂâçÂèØÁî®Á©∫Èó¥: ${COMPILE_START_SPACE}GB"
          if [ "$COMPILE_START_SPACE" -lt 3 ]; then
            echo "üö® ‰∏•ÈáçÈîôËØØ: ÁºñËØëÂºÄÂßãÂâçÁ©∫Èó¥‰∏çË∂≥3GB"
            exit 1
          fi
          echo "üìä ÁºñËØëÂèÇÊï∞Ê±áÊÄª:"
          echo "  - Ê∫êÁ†ÅÂ∫ì: ${{ env.SOURCE_PRESET }}"
          echo "  - ÂÆûÈôÖÂàÜÊîØ: ${{ env.ACTUAL_BRANCH }}"
          echo "  - ‰ºòÂåñÁ≠ñÁï•: ${{ github.event.inputs.build_optimization }}"
          echo "  - Â∑•ÂÖ∑ÈìæÁ≠ñÁï•: ${{ github.event.inputs.toolchain_strategy }}"
          echo "  - Ëá™ÂÆö‰πâÂäüËÉΩ: ${{ github.event.inputs.enable_custom_features }}"
          echo "  - ÈóÆÈ¢ò‰øÆÂ§ç: ${{ github.event.inputs.fix_common_issues }}"
          echo "  - È¢Ñ‰∏ãËΩΩ: ${{ github.event.inputs.enable_pre_download }}"
          echo "  - ÂêéÈ™åËØÅ: ${{ github.event.inputs.enable_post_verify }}"
          echo "  - CPUÊ†∏ÂøÉ: $(nproc)"
          echo "  - ÁºñËØë‰ªªÂä°Êï∞: $BUILD_JOBS"
          echo "  - Samba‰ªªÂä°Êï∞: $SAMBA_JOBS"
          echo "  - CCache: Â∑≤ÂêØÁî®"
          echo "  - Ëµ∑ÂßãÁ©∫Èó¥: ${COMPILE_START_SPACE}GB"
          echo "üîß ÂºÄÂßãÁºñËØë..."
          LOG_FILE="${{ env.BUILD_LOG_DIR }}/firmware-compile.log"
          {
            echo "Èò∂ÊÆµ1: Âü∫Á°ÄÁéØÂ¢ÉÂáÜÂ§á..."
            make tools/install 2>/dev/null || echo "‚ö†Ô∏è Â∑•ÂÖ∑ÂÆâË£ÖË≠¶Âëä"
            make toolchain/install 2>/dev/null || echo "‚ö†Ô∏è Â∑•ÂÖ∑ÈìæÂÆâË£ÖË≠¶Âëä"
            echo "Èò∂ÊÆµ2: ÂÜÖÊ†∏ÁºñËØë..."
            make target/linux/compile -j$BUILD_JOBS V=s || {
              echo "‚ö†Ô∏è ÂÜÖÊ†∏ÁºñËØëÈÅáÂà∞ÈóÆÈ¢òÔºåÁªßÁª≠..."
            }
            echo "Èò∂ÊÆµ3: ÂåÖÁºñËØëÔºàÂàÜÊâπÊ¨°Ôºâ..."
            echo "üîß ÁºñËØëÂü∫Á°ÄÁΩëÁªúÂåÖ..."
            make package/network/utils/compile -j$BUILD_JOBS V=s || echo "‚ö†Ô∏è ÁΩëÁªúÂ∑•ÂÖ∑ÁºñËØëÈóÆÈ¢ò"
            echo "üîß ÁºñËØëÂü∫Á°ÄÁ≥ªÁªüÂåÖ..."
            make package/system/compile -j$BUILD_JOBS V=s || echo "‚ö†Ô∏è Á≥ªÁªüÂåÖÁºñËØëÈóÆÈ¢ò"
            echo "üîß ÁºñËØëLuCIÁõ∏ÂÖ≥ÂåÖ..."
            make package/feeds/luci/compile -j$BUILD_JOBS V=s || echo "‚ö†Ô∏è LuCIÁºñËØëÈóÆÈ¢ò"
            if [ "${{ github.event.inputs.enable_custom_features }}" = "true" ]; then
              echo "Èò∂ÊÆµ4: SambaÁõ∏ÂÖ≥ÂåÖÁºñËØë..."
              for pkg in samba4-libs samba4-server luci-app-samba4; do
                echo "ÁºñËØë $pkg..."
                if make package/$pkg/compile -j$SAMBA_JOBS V=s 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/$pkg-compile.log; then
                  echo "‚úÖ $pkg ÁºñËØëÊàêÂäü"
                else
                  echo "‚ö†Ô∏è $pkg ÁºñËØëÂ§±Ë¥•ÔºåÂ∞ùËØïÁªßÁª≠..."
                  make package/$pkg/compile -j$SAMBA_JOBS V=sc 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/$pkg-fix.log || echo "‚ùå $pkg ÂΩªÂ∫ïÂ§±Ë¥•"
                fi
              done
            fi
            echo "Èò∂ÊÆµ5: Ââ©‰ΩôÂåÖÁºñËØë..."
            make package/compile -j$BUILD_JOBS V=sc || {
              echo "‚ö†Ô∏è ÈÉ®ÂàÜÂåÖÁºñËØëÂ§±Ë¥•ÔºåÁªßÁª≠ÂÆâË£ÖÈò∂ÊÆµ..."
            }
            echo "Èò∂ÊÆµ6: ÂåÖÂÆâË£Ö..."
            make package/install -j1 V=s || {
              echo "‚ùå ÂåÖÂÆâË£ÖÂ§±Ë¥•ÔºåÂ∞ùËØï‰øÆÂ§çÊñπÊ≥ï..."
              mkdir -p build_dir/target-*/root-*/tmp
              mkdir -p build_dir/target-*/root-*/var/lock
              mkdir -p build_dir/target-*/root-*/var/run
              make package/install -j1 V=sc || echo "‚ö†Ô∏è ÂåÖÂÆâË£Ö‰ªçÁÑ∂Â§±Ë¥•ÔºåÁªßÁª≠ÁõÆÊ†áÂÆâË£Ö"
            }
            echo "Èò∂ÊÆµ7: ÁõÆÊ†áÂÆâË£Ö..."
            make target/install -j1 V=s || {
              echo "‚ùå ÁõÆÊ†áÂÆâË£ÖÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•ÁîüÊàêÈïúÂÉè..."
              make -j1 V=sc || make image -j1 V=sc
            }
            echo "Èò∂ÊÆµ8: ÁîüÊàêÈïúÂÉè..."
            make target/linux/ipq40xx/image -j1 V=s || {
              echo "‚ö†Ô∏è ‰∏ìÈó®ÈïúÂÉèÁîüÊàêÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÁõÆÊ†á..."
              make -j1 V=sc
            }
          } 2>&1 | tee "$LOG_FILE"
          COMPILE_EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV
          echo "üîç ÁºñËØëÂêéÁ©∫Èó¥Ê£ÄÊü•..."
          COMPILE_END_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ÁºñËØëÁªìÊùüÂêéÂèØÁî®Á©∫Èó¥: ${COMPILE_END_SPACE}GB"
          SPACE_USED=$((COMPILE_START_SPACE - COMPILE_END_SPACE))
          echo "ÁºñËØëËøáÁ®ãÂç†Áî®Á©∫Èó¥: ${SPACE_USED}GB"
          if find bin -name "*.bin" -o -name "*.img" 2>/dev/null | grep -q .; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "üéâ ÁºñËØëÊàêÂäüÂÆåÊàêÔºàÊúâÂõ∫‰ª∂ÁîüÊàêÔºâ!"
          elif [ $COMPILE_EXIT_CODE -eq 0 ]; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "üéâ ÁºñËØëÊàêÂäüÂÆåÊàê!"
          else
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            echo "‚ùå ÁºñËØëÂ§±Ë¥•ÔºåÈÄÄÂá∫Á†Å: $COMPILE_EXIT_CODE"
            exit 1
          fi
          echo "‚è±Ô∏è ÊÄªÁºñËØëËÄóÊó∂: ${DURATION}Áßí ($(($DURATION/60))ÂàÜÈíü)"

      - name: üîç ÁºñËØëÂêéÂÖ®Èù¢È™åËØÅ
        if: env.BUILD_STATUS == 'success' && github.event.inputs.enable_post_verify == 'true'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ÁºñËØëÂêéÂÖ®Èù¢È™åËØÅ ==="
          echo "üîç Âõ∫‰ª∂Êñá‰ª∂È™åËØÅ..."
          if [ -d "bin/targets" ]; then
            echo "‚úÖ Âõ∫‰ª∂ËæìÂá∫ÁõÆÂΩïÂ≠òÂú®"
            echo "üìä ÁîüÊàêÁöÑÂõ∫‰ª∂Êñá‰ª∂:"
            find bin/targets -name "*.bin" -o -name "*.img" 2>/dev/null | while read file; do
              if [ -f "$file" ]; then
                size=$(stat -c%s "$file" 2>/dev/null || echo 0)
                echo "  - $(basename "$file") ($(($size/1024/1024))MB)"
              fi
            done
            echo "üîç Ê£ÄÊü•ASUS RT-AC42UÈïúÂÉè..."
            ASUS_IMAGES=$(find bin/targets -name "*asus_rt-ac42u*" -type f 2>/dev/null)
            if [ -n "$ASUS_IMAGES" ]; then
              echo "‚úÖ ASUS RT-AC42UÈïúÂÉèÂ∑≤ÁîüÊàê:"
              for img in $ASUS_IMAGES; do
                echo "  - $(basename "$img")"
              done
            else
              echo "‚ö†Ô∏è Êú™ÊâæÂà∞ASUS RT-AC42UÁâπÂÆöÈïúÂÉè"
            fi
            echo "üîç Ê£ÄÊü•ÈïúÂÉèÁ±ªÂûãÂÆåÊï¥ÊÄß..."
            FACTORY_COUNT=$(find bin/targets -name "*factory*" -type f 2>/dev/null | wc -l)
            UPGRADE_COUNT=$(find bin/targets -name "*sysupgrade*" -type f 2>/dev/null | wc -l)
            echo "  - Â∑•ÂéÇÈïúÂÉè: $FACTORY_COUNT ‰∏™"
            echo "  - ÂçáÁ∫ßÈïúÂÉè: $UPGRADE_COUNT ‰∏™"
          else
            echo "‚ùå Âõ∫‰ª∂ËæìÂá∫ÁõÆÂΩï‰∏çÂ≠òÂú®"
          fi
          echo "üîç SambaÂäüËÉΩÈ™åËØÅ..."
          if find bin -name "*samba4*" -type f | grep -q .; then
            echo "‚úÖ SambaÁõ∏ÂÖ≥ÂåÖÂ∑≤ÁîüÊàê"
          else
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞SambaÁõ∏ÂÖ≥ÂåÖ"
          fi
          echo "üîç ÂÖ≥ÈîÆÂåÖÈ™åËØÅ..."
          for pkg in base-files luci firewall; do
            if find bin -name "*$pkg*" -type f | grep -q .; then
              echo "‚úÖ $pkg Áõ∏ÂÖ≥ÂåÖÂ∑≤ÁîüÊàê"
            else
              echo "‚ö†Ô∏è Êú™ÊâæÂà∞ $pkg Áõ∏ÂÖ≥ÂåÖ"
            fi
          done
          echo "üìä ÊúÄÁªàÁ©∫Èó¥Áä∂ÊÄÅ..."
          FINAL_SPACE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "ÊúÄÁªàÂèØÁî®Á©∫Èó¥: ${FINAL_SPACE}GB"
          echo "‚úÖ ÁºñËØëÂêéÈ™åËØÅÂÆåÊàê"

      - name: üîç ËØ¶ÁªÜÂõ∫‰ª∂‰∫ßÁâ©È™åËØÅ‰∏éÊî∂ÈõÜ
        if: env.BUILD_STATUS == 'success'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== ËØ¶ÁªÜÂõ∫‰ª∂‰∫ßÁâ©È™åËØÅ‰∏éÊî∂ÈõÜ ==="
          mkdir -p ${{ env.ARTIFACTS_DIR }}/firmware
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs
          mkdir -p ${{ env.ARTIFACTS_DIR }}/configs
          echo "üîç ÊêúÁ¥¢Âõ∫‰ª∂Êñá‰ª∂..."
          TOTAL_FIRMWARE_COUNT=0
          if [ -d "bin/targets" ]; then
            echo "üìÅ Â§çÂà∂Ê†áÂáÜËæìÂá∫ÁõÆÂΩï..."
            cp -r bin/targets ${{ env.ARTIFACTS_DIR }}/firmware/
            INITRAMFS_COUNT=$(find bin/targets -name "*initramfs*" -type f 2>/dev/null | wc -l)
            UPGRADE_COUNT=$(find bin/targets -name "*sysupgrade*" -type f 2>/dev/null | wc -l)
            FACTORY_COUNT=$(find bin/targets -name "*factory*" -type f 2>/dev/null | wc -l)
            OTHER_COUNT=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.itb" 2>/dev/null | grep -v -e "initramfs" -e "sysupgrade" -e "factory" | wc -l)
            TOTAL_FIRMWARE_COUNT=$((INITRAMFS_COUNT + UPGRADE_COUNT + FACTORY_COUNT + OTHER_COUNT))
            echo "üìä Âõ∫‰ª∂Á±ªÂûãÁªüËÆ°:"
            echo "  - Initramfs ÈïúÂÉè: $INITRAMFS_COUNT ‰∏™"
            echo "  - Á≥ªÁªüÂçáÁ∫ßÈïúÂÉè: $UPGRADE_COUNT ‰∏™"
            echo "  - Â∑•ÂéÇÂà∑Êú∫ÈïúÂÉè: $FACTORY_COUNT ‰∏™"
            echo "  - ÂÖ∂‰ªñÈïúÂÉè: $OTHER_COUNT ‰∏™"
            echo "  - ÊÄªËÆ°: $TOTAL_FIRMWARE_COUNT ‰∏™Êñá‰ª∂"
            echo "üìã Âõ∫‰ª∂Êñá‰ª∂ËØ¶ÁªÜÂàóË°®:"
            find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.itb" 2>/dev/null | head -30 | while read file; do
              if [ -f "$file" ]; then
                file_size=$(stat -c%s "$file" 2>/dev/null || echo 0)
                file_type="ÂÖ∂‰ªñ"
                if [[ "$file" == *"initramfs"* ]]; then
                  file_type="Initramfs"
                elif [[ "$file" == *"sysupgrade"* ]]; then
                  file_type="Á≥ªÁªüÂçáÁ∫ß"
                elif [[ "$file" == *"factory"* ]]; then
                  file_type="Â∑•ÂéÇÂà∑Êú∫"
                fi
                echo "  - $file_type: $(basename "$file") ($(($file_size/1024/1024))MB)"
              fi
            done
            echo ""
            echo "üîç Ê£ÄÊü• ASUS RT-AC42U ÁâπÂÆöÈïúÂÉè..."
            ASUS_IMAGES=$(find bin/targets -name "*asus_rt-ac42u*" -type f 2>/dev/null)
            if [ -n "$ASUS_IMAGES" ]; then
              echo "üìã ASUS RT-AC42U ÈïúÂÉèÂàóË°®:"
              for img in $ASUS_IMAGES; do
                if [ -f "$img" ]; then
                  img_size=$(stat -c%s "$img" 2>/dev/null || echo 0)
                  img_type="Êú™Áü•"
                  if [[ "$img" == *"initramfs"* ]]; then
                    img_type="RAMÂêØÂä®ÈïúÂÉè"
                  elif [[ "$img" == *"sysupgrade"* ]]; then
                    img_type="Á≥ªÁªüÂçáÁ∫ßÈïúÂÉè"
                  elif [[ "$img" == *"factory"* ]]; then
                    img_type="Â∑•ÂéÇÂà∑Êú∫ÈïúÂÉè"
                  fi
                  echo "  - $img_type: $(basename "$img") ($(($img_size/1024/1024))MB)"
                fi
              done
              ASUS_FACTORY=$(find bin/targets -name "*asus_rt-ac42u*factory*" -type f 2>/dev/null)
              if [ -z "$ASUS_FACTORY" ]; then
                echo "‚ö†Ô∏è Ë≠¶Âëä: Êú™ÊâæÂà∞ ASUS RT-AC42U Â∑•ÂéÇÂà∑Êú∫ÈïúÂÉè"
                echo "FACTORY_MISSING=true" >> $GITHUB_ENV
              else
                echo "‚úÖ Â∑≤ÊâæÂà∞ ASUS RT-AC42U Â∑•ÂéÇÂà∑Êú∫ÈïúÂÉè"
                echo "FACTORY_MISSING=false" >> $GITHUB_ENV
              fi
            else
              echo "‚ùå ÈîôËØØ: Êú™ÊâæÂà∞‰ªª‰Ωï ASUS RT-AC42U ÈïúÂÉè"
              echo "FACTORY_MISSING=true" >> $GITHUB_ENV
            fi
          else
            echo "‚ö†Ô∏è Ê†áÂáÜËæìÂá∫ÁõÆÂΩï bin/targets ‰∏çÂ≠òÂú®"
            echo "FACTORY_MISSING=true" >> $GITHUB_ENV
          fi
          echo "üîç Âú®ÂÖ∂‰ªñ‰ΩçÁΩÆÊêúÁ¥¢Âõ∫‰ª∂..."
          OTHER_FIRMWARE=$(find . -maxdepth 4 -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" 2>/dev/null | grep -v "bin/targets" | head -20)
          if [ -n "$OTHER_FIRMWARE" ]; then
            OTHER_COUNT=$(echo "$OTHER_FIRMWARE" | wc -l)
            echo "‚úÖ Âú®ÂÖ∂‰ªñ‰ΩçÁΩÆÊâæÂà∞ $OTHER_COUNT ‰∏™Âõ∫‰ª∂Áõ∏ÂÖ≥Êñá‰ª∂"
            for file in $OTHER_FIRMWARE; do
              if [ -f "$file" ]; then
                file_size=$(stat -c%s "$file" 2>/dev/null || echo 0)
                if [ "$file_size" -gt 1000000 ]; then
                  rel_path=$(echo "$file" | sed 's|^\./||')
                  target_dir="${{ env.ARTIFACTS_DIR }}/firmware/other/$(dirname "$rel_path")"
                  mkdir -p "$target_dir"
                  cp "$file" "$target_dir/"
                  echo "üì¶ Â∑≤Êî∂ÈõÜ: $rel_path ($(($file_size/1024/1024))MB)"
                  TOTAL_FIRMWARE_COUNT=$((TOTAL_FIRMWARE_COUNT + 1))
                fi
              fi
            done
          fi
          if [ $TOTAL_FIRMWARE_COUNT -eq 0 ]; then
            echo "üîç Ê∑±Â∫¶ÊêúÁ¥¢Âõ∫‰ª∂Êñá‰ª∂..."
            BUILD_FIRMWARE=$(find build_dir -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | head -10)
            if [ -n "$BUILD_FIRMWARE" ]; then
              echo "‚úÖ Âú®build_dir‰∏≠ÊâæÂà∞Âõ∫‰ª∂Áõ∏ÂÖ≥Êñá‰ª∂:"
              echo "$BUILD_FIRMWARE"
            fi
          fi
          echo "üìã Êî∂ÈõÜÊûÑÂª∫‰ø°ÊÅØÂíåÊó•Âøó..."
          cp .config ${{ env.ARTIFACTS_DIR }}/configs/ 2>/dev/null || echo "‚ö†Ô∏è Êó†Ê≥ïÂ§çÂà∂.config"
          cp feeds.conf ${{ env.ARTIFACTS_DIR }}/configs/ 2>/dev/null || echo "‚ö†Ô∏è Êó†Ê≥ïÂ§çÂà∂feeds.conf"
          echo "FIRMWARE_COUNT=$TOTAL_FIRMWARE_COUNT" >> $GITHUB_ENV
          if [ $TOTAL_FIRMWARE_COUNT -eq 0 ]; then
            echo "‚ùå ÈîôËØØ: Êú™ÊâæÂà∞‰ªª‰ΩïÂõ∫‰ª∂Êñá‰ª∂"
            echo "ÂΩìÂâçÁõÆÂΩïÁªìÊûÑ:"
            find . -maxdepth 3 -type d | head -20
            echo ""
            echo "ÊâÄÊúâÂèØËÉΩÁöÑÂõ∫‰ª∂Êñá‰ª∂:"
            find . -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" 2>/dev/null | head -30 || echo "Êó†Âõ∫‰ª∂Êñá‰ª∂"
            exit 1
          else
            echo "‚úÖ Âõ∫‰ª∂È™åËØÅ‰∏éÊî∂ÈõÜÂÆåÊàê: ÊÄªÂÖ± $TOTAL_FIRMWARE_COUNT ‰∏™Êñá‰ª∂"
          fi

      - name: üíæ ‰∏ä‰º†ÊûÑÂª∫‰∫ßÁâ©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Firmware-${{ github.run_number }}-${{ env.SOURCE_PRESET }}-${{ env.ACTUAL_BRANCH }}-${{ env.BUILD_STATUS || 'unknown' }}
          path: ${{ env.ARTIFACTS_DIR }}
          retention-days: 30

      - name: üßπ ÁºñËØëÂêéÊô∫ËÉΩÊ∏ÖÁêÜ
        if: always()
        run: |
          echo "ÂºÄÂßãÁºñËØëÂêéÊô∫ËÉΩÊ∏ÖÁêÜ..."
          echo "=== Ê∏ÖÁêÜÂâçÁä∂ÊÄÅ ==="
          df -h
          free -h
          if [ -d "${{ env.SOURCE_DIR }}" ]; then
            cd ${{ env.SOURCE_DIR }}
            echo "üßπ Ê∏ÖÁêÜÁºñËØë‰∏¥Êó∂Êñá‰ª∂..."
            rm -rf build_dir/* staging_dir/* tmp/* 2>/dev/null || true
          fi
          echo "üßπ Ê∏ÖÁêÜ‰∫§Êç¢Êñá‰ª∂..."
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          echo ""
          echo "=== Ê∏ÖÁêÜÂêéÁä∂ÊÄÅ ==="
          df -h
          free -h
          echo "‚úÖ Êô∫ËÉΩÊ∏ÖÁêÜÂÆåÊàê"

      - name: üìä ÊúÄÁªàÁªºÂêàÊä•Âëä
        if: always()
        run: |
          echo "=== ÊúÄÁªàÁªºÂêàÊä•Âëä ==="
          echo "üéØ Â∑•‰ΩúÊµÅ: ${{ github.workflow }}"
          echo "üÜî ËøêË°åID: ${{ github.run_id }}"
          echo "üÜî ËøêË°åÂè∑: ${{ github.run_number }}"
          echo ""
          echo "üì¶ Ê∫êÁ†Å‰ø°ÊÅØ:"
          echo "  - È¢ÑËÆæ: ${{ env.SOURCE_PRESET }}"
          echo "  - ÂàÜÊîØ: ${{ env.ACTUAL_BRANCH }}"
          echo "  - Êé®Ëçê: ${{ env.RECOMMENDED_BRANCH }}"
          echo "  - Êèê‰∫§: ${{ env.COMMIT_HASH || 'unknown' }}"
          echo ""
          echo "‚öôÔ∏è ÁºñËØëÈÖçÁΩÆ:"
          echo "  - ÈÖçÁΩÆÊñá‰ª∂: ${{ github.event.inputs.config_profile }}"
          echo "  - ‰ºòÂåñÁ≠ñÁï•: ${{ github.event.inputs.build_optimization }}"
          echo "  - Â∑•ÂÖ∑Èìæ: ${{ github.event.inputs.toolchain_strategy }}"
          echo "  - Ëá™ÂÆö‰πâ: ${{ github.event.inputs.enable_custom_features }}"
          echo "  - ÈóÆÈ¢ò‰øÆÂ§ç: ${{ github.event.inputs.fix_common_issues }}"
          echo "  - È¢Ñ‰∏ãËΩΩ: ${{ github.event.inputs.enable_pre_download }}"
          echo "  - ÂêéÈ™åËØÅ: ${{ github.event.inputs.enable_post_verify }}"
          echo ""
          echo "üìà ÊûÑÂª∫ÁªìÊûú:"
          echo "  - Áä∂ÊÄÅ: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - Êó∂Èïø: ${{ env.BUILD_DURATION || 'N/A' }}Áßí"
          echo "  - Âõ∫‰ª∂Êï∞Èáè: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - Â∑•ÂéÇÈïúÂÉèÁä∂ÊÄÅ: ${{ env.FACTORY_MISSING == 'true' && 'Áº∫Â§±' || 'Â∑≤ÁîüÊàê' }}"
          echo "  - È¢Ñ‰∏ãËΩΩÁä∂ÊÄÅ: ${{ env.DOWNLOAD_STATUS || 'Êú™ÊâßË°å' }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            echo "üéâ ÊûÑÂª∫ÊàêÂäüÔºÅÂõ∫‰ª∂Â∑≤‰∏ä‰º†Âà∞ Artifacts"
            echo "üì¶ ‰∏ãËΩΩ Artifacts Ëé∑ÂèñÁºñËØë‰∫ßÁâ©"
            echo "üîß Âõ∫‰ª∂Êñá‰ª∂Âú® firmware/ ÁõÆÂΩï‰∏≠"
            if [ "${{ env.FACTORY_MISSING }}" = "true" ]; then
              echo "‚ö†Ô∏è Ê≥®ÊÑè: Â∑•ÂéÇÂà∑Êú∫ÈïúÂÉèÁº∫Â§±ÔºåÂè™ÊúâÁ≥ªÁªüÂçáÁ∫ßÈïúÂÉè"
            else
              echo "‚úÖ ÊâÄÊúâÈïúÂÉèÁ±ªÂûãÂùáÂ∑≤ÁîüÊàê"
            fi
          else
            echo "‚ùå ÊûÑÂª∫Â§±Ë¥•"
            echo "üîç ËØ∑Êü•ÁúãËØ¶ÁªÜÊó•ÂøóÂàÜÊûêÈîôËØØÂéüÂõ†"
            echo "üìã Ê£ÄÊü• Artifacts ‰∏≠ÁöÑÁºñËØëÊó•Âøó"
          fi
