name: "é€šç”¨å›ºä»¶æ„å»ºå™¨ - æ™ºèƒ½åˆ†æç‰ˆ"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "auto"
        type: choice
        options: ["auto", "openwrt-22.03", "openwrt-21.02", "master", "main"]
      config_profile:
        description: "è®¾å¤‡é…ç½®æ–‡ä»¶åç§°"
        required: true
        type: string
        default: "rt-ac42u"
      build_optimization:
        description: "ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥"
        required: true
        type: choice
        options: ["balanced", "speed", "stability"]
        default: "balanced"
      enable_advanced:
        description: "å¯ç”¨é«˜çº§åŠŸèƒ½"
        required: false
        default: true
        type: boolean
      language_pack:
        description: "è¯­è¨€åŒ…é€‰æ‹©"
        required: true
        type: choice
        options: ["zh-cn", "en-only", "all"]
        default: "zh-cn"
      plugin_preset:
        description: "æ’ä»¶é¢„è®¾"
        required: true
        type: choice
        options: ["minimal", "standard", "full", "custom"]
        default: "standard"

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 360
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"
        with:
          path: "config-repo"
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ”§ åˆå§‹åŒ–å·¥ä½œç¯å¢ƒ"
        id: init
        run: |
          echo "=== ğŸ”§ åˆå§‹åŒ–å·¥ä½œç¯å¢ƒ ==="
          sudo mkdir -p /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chown -R $USER:$USER /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chmod -R 755 /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          mkdir -p /mnt/build-logs
          MAIN_LOG="/mnt/build-logs/build_timeline.log"
          ERROR_LOG="/mnt/build-logs/errors.log"
          WARNING_LOG="/mnt/build-logs/warnings.log"
          ANALYSIS_REPORT="/mnt/build-logs/analysis_report.md"
          
          echo "ğŸ æ„å»ºå¼€å§‹æ—¶é—´: $(date)" > $MAIN_LOG
          echo "ğŸ”§ å·¥ä½œæµç‰ˆæœ¬: é€šç”¨å›ºä»¶æ„å»ºå™¨ - æ™ºèƒ½åˆ†æç‰ˆ" >> $MAIN_LOG
          echo "ğŸ“‹ è¾“å…¥å‚æ•°:" >> $MAIN_LOG
          echo "  - æºç é¢„è®¾: ${{ github.event.inputs.source_preset }}" >> $MAIN_LOG
          echo "  - æºç åˆ†æ”¯: ${{ github.event.inputs.source_branch }}" >> $MAIN_LOG
          echo "  - é…ç½®æ–¹æ¡ˆ: ${{ github.event.inputs.config_profile }}" >> $MAIN_LOG
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}" >> $MAIN_LOG
          echo "  - é«˜çº§åŠŸèƒ½: ${{ github.event.inputs.enable_advanced }}" >> $MAIN_LOG
          echo "  - è¯­è¨€åŒ…: ${{ github.event.inputs.language_pack }}" >> $MAIN_LOG
          echo "  - æ’ä»¶é¢„è®¾: ${{ github.event.inputs.plugin_preset }}" >> $MAIN_LOG
          echo "==========================================" >> $MAIN_LOG
          
          # åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶
          echo "# é”™è¯¯æ—¥å¿— - å¼€å§‹äº $(date)" > $ERROR_LOG
          echo "# è­¦å‘Šæ—¥å¿— - å¼€å§‹äº $(date)" > $WARNING_LOG
          echo "# æ™ºèƒ½åˆ†ææŠ¥å‘Š" > $ANALYSIS_REPORT
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> $ANALYSIS_REPORT
          echo "## æ„å»ºæ¦‚å†µ" >> $ANALYSIS_REPORT
          echo "- æºç : ${{ github.event.inputs.source_preset }}" >> $ANALYSIS_REPORT
          echo "- è®¾å¤‡: ${{ github.event.inputs.config_profile }}" >> $ANALYSIS_REPORT
          echo "- åˆ†æ”¯: ${{ github.event.inputs.source_branch }}" >> $ANALYSIS_REPORT
          echo "" >> $ANALYSIS_REPORT
          
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV
          echo "ERROR_LOG=$ERROR_LOG" >> $GITHUB_ENV
          echo "WARNING_LOG=$WARNING_LOG" >> $GITHUB_ENV
          echo "ANALYSIS_REPORT=$ANALYSIS_REPORT" >> $GITHUB_ENV
          echo "CONFIG_REPO_DIR=${{ github.workspace }}/config-repo" >> $GITHUB_ENV
          echo "BUILD_STATUS=running" >> $GITHUB_ENV
          echo "âœ… å·¥ä½œç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸ’¾ ç¯å¢ƒè®¾ç½®ä¸èµ„æºç®¡ç†"
        id: env_setup
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ’¾ ç¯å¢ƒè®¾ç½®ä¸èµ„æºç®¡ç† ===" | tee -a "$MAIN_LOG"
          echo "ğŸ“Š ç³»ç»Ÿä¿¡æ¯:" | tee -a "$MAIN_LOG"
          echo "  - ç³»ç»Ÿ: $(lsb_release -d | cut -f2)" | tee -a "$MAIN_LOG"
          echo "  - å†…æ ¸: $(uname -r)" | tee -a "$MAIN_LOG"
          echo "  - CPU: $(nproc) æ ¸å¿ƒ" | tee -a "$MAIN_LOG"
          echo "  - å†…å­˜: $(free -h | awk 'NR==2{print $7}') å¯ç”¨" | tee -a "$MAIN_LOG"
          echo "ğŸ’¾ ç£ç›˜ç©ºé—´çŠ¶æ€:" | tee -a "$MAIN_LOG"
          df -h | tee -a "$MAIN_LOG"
          echo "ğŸ”„ åˆ›å»ºäº¤æ¢æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          SWAP_SIZE="16G"
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          echo "ğŸ“¦ åˆ›å»º ${SWAP_SIZE} äº¤æ¢æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          if ! sudo fallocate -l $SWAP_SIZE /mnt/swapfile 2>> "$ERROR_LOG"; then
            echo "âŒ äº¤æ¢æ–‡ä»¶åˆ›å»ºå¤±è´¥" | tee -a "$MAIN_LOG"
            echo "äº¤æ¢æ–‡ä»¶åˆ›å»ºå¤±è´¥" >> "$ERROR_LOG"
          else
            sudo chmod 600 /mnt/swapfile
            sudo mkswap /mnt/swapfile
            sudo swapon /mnt/swapfile
            echo "ğŸ“Š å†…å­˜çŠ¶æ€:" | tee -a "$MAIN_LOG"
            free -h | tee -a "$MAIN_LOG"
          fi
          echo "âœ… ç¯å¢ƒè®¾ç½®å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–"
        id: install_deps
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ– ===" | tee -a "$MAIN_LOG"
          echo "ğŸ“¦ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..." | tee -a "$MAIN_LOG"
          if ! sudo apt-get update -qq 2>> "$ERROR_LOG"; then
            echo "âŒ è½¯ä»¶åŒ…åˆ—è¡¨æ›´æ–°å¤±è´¥" | tee -a "$MAIN_LOG"
          fi
          echo "ğŸ”§ å®‰è£…æ ¸å¿ƒç¼–è¯‘å·¥å…·..." | tee -a "$MAIN_LOG"
          if ! sudo apt-get install -y -qq build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-dev rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build libelf-dev libxml2-dev liblzma-dev liblzo2-dev axel net-tools e2fsprogs genext2fs dosfstools mtools libffi-dev libsqlite3-dev libpam0g-dev libtirpc-dev libev-dev lm-sensors libsnmp-dev libglib2.0-dev libgpiod-dev libfl-dev 2>> "$ERROR_LOG"; then
            echo "âŒ ä¾èµ–å®‰è£…æœ‰é”™è¯¯" | tee -a "$MAIN_LOG"
            echo "ç¼–è¯‘ä¾èµ–å®‰è£…å¤±è´¥" >> "$ERROR_LOG"
          fi
          echo "ğŸ é…ç½®Pythonç¯å¢ƒ..." | tee -a "$MAIN_LOG"
          python3 -m pip install --upgrade pip 2>> "$WARNING_LOG" || echo "Pythonå‡çº§è­¦å‘Š" >> "$WARNING_LOG"
          python3 -m pip install setuptools wheel 2>> "$WARNING_LOG" || echo "PythonåŒ…å®‰è£…è­¦å‘Š" >> "$WARNING_LOG"
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®"
        id: performance
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          echo "=== âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½® ===" | tee -a "$MAIN_LOG"
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          echo "ğŸ¯ ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥: $OPTIMIZATION_STRATEGY" | tee -a "$MAIN_LOG"
          case "$OPTIMIZATION_STRATEGY" in
            "speed")
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=2
              echo "ğŸš€ é€Ÿåº¦ä¼˜å…ˆæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            "stability")
              CCACHE_SIZE="2G"
              PARALLEL_JOBS=1
              echo "ğŸ›¡ï¸ ç¨³å®šæ€§ä¼˜å…ˆæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            *)
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=2
              echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
          esac
          mkdir -p /mnt/ccache
          ccache -M $CCACHE_SIZE 2>> "$ERROR_LOG" || echo "CCacheé…ç½®å¤±è´¥" >> "$ERROR_LOG"
          ccache -o compression=true
          ccache -o compression_level=6
          echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          echo "ğŸ“Š åˆå§‹CCacheç»Ÿè®¡:" | tee -a "$MAIN_LOG"
          ccache -s | tee -a "$MAIN_LOG" 2>> "$WARNING_LOG" || echo "CCacheç»Ÿè®¡å¤±è´¥" >> "$WARNING_LOG"
          echo "âœ… æ€§èƒ½ä¼˜åŒ–å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ æºç é…ç½®ä¸è·å–"
        id: source_setup
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          echo "=== ğŸ”§ æºç é…ç½®ä¸è·å– ===" | tee -a "$MAIN_LOG"
          REPO_JSON_FOUND="${{ env.CONFIG_REPO_DIR }}/firmware-config/repositories.json"
          if [ ! -f "$REPO_JSON_FOUND" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° repositories.json æ–‡ä»¶" | tee -a "$MAIN_LOG"
            echo "æœªæ‰¾åˆ° repositories.json æ–‡ä»¶" >> "$ERROR_LOG"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $REPO_JSON_FOUND" | tee -a "$MAIN_LOG"
          PRESET="${{ github.event.inputs.source_preset }}"
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND" 2>/dev/null || echo "")
          if [ -z "$SOURCE_URL" ]; then
            echo "âŒ é”™è¯¯: é¢„è®¾ '$PRESET' åœ¨é…ç½®æ–‡ä»¶ä¸­ä¸å­˜åœ¨" | tee -a "$MAIN_LOG"
            echo "é¢„è®¾ '$PRESET' åœ¨é…ç½®æ–‡ä»¶ä¸­ä¸å­˜åœ¨" >> "$ERROR_LOG"
            exit 1
          fi
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND" 2>/dev/null || echo "openwrt-22.03")
          fi
          echo "ğŸ“¦ æºç ä¿¡æ¯:" | tee -a "$MAIN_LOG"
          echo "  - URL: $SOURCE_URL" | tee -a "$MAIN_LOG"
          echo "  - åˆ†æ”¯: $BRANCH" | tee -a "$MAIN_LOG"
          echo "  - é¢„è®¾: $PRESET" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "ğŸ”„ å…‹éš†æºç ..." | tee -a "$MAIN_LOG"
          rm -rf .[!.]* * 2>/dev/null || true
          echo "ğŸ“¥ å…‹éš†å°è¯•..." | tee -a "$MAIN_LOG"
          if git clone --depth 1 --branch "$BRANCH" "$SOURCE_URL" . 2>&1; then
            if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
              echo "âœ… æºç å…‹éš†æˆåŠŸ" | tee -a "$MAIN_LOG"
            else
              echo "âŒ æºç ç»“æ„ä¸å®Œæ•´" | tee -a "$MAIN_LOG"
              echo "æºç ç»“æ„ä¸å®Œæ•´" >> "$ERROR_LOG"
              exit 1
            fi
          else
            echo "âŒ æºç å…‹éš†å¤±è´¥ï¼Œå°è¯•masteråˆ†æ”¯..." | tee -a "$MAIN_LOG"
            echo "æºç å…‹éš†å¤±è´¥ï¼Œå°è¯•masteråˆ†æ”¯" >> "$WARNING_LOG"
            if git clone --depth 1 "$SOURCE_URL" . 2>&1; then
              echo "âœ… ä½¿ç”¨masteråˆ†æ”¯å…‹éš†æˆåŠŸ" | tee -a "$MAIN_LOG"
              git checkout "$BRANCH" 2>/dev/null || echo "âš ï¸ æ— æ³•åˆ‡æ¢åˆ°åˆ†æ”¯ $BRANCHï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯" | tee -a "$MAIN_LOG"
            else
              echo "âŒ æºç å…‹éš†å¤±è´¥" | tee -a "$MAIN_LOG"
              echo "æºç å…‹éš†å¤±è´¥" >> "$ERROR_LOG"
              exit 1
            fi
          fi
          ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          echo "âœ… æºç å…‹éš†æˆåŠŸ" | tee -a "$MAIN_LOG"
          echo "  - å®é™…åˆ†æ”¯: $ACTUAL_BRANCH" | tee -a "$MAIN_LOG"
          echo "  - æäº¤å“ˆå¸Œ: $COMMIT_HASH" | tee -a "$MAIN_LOG"
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV

      - name: "ğŸ”„ æºç åˆå§‹åŒ–ä¸Feedsé…ç½®"
        id: feeds_setup
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ”„ æºç åˆå§‹åŒ–ä¸Feedsé…ç½® ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "ğŸ“‹ é…ç½®Feeds..." | tee -a "$MAIN_LOG"
          
          CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "master")
          echo "ğŸ”§ å½“å‰æºç åˆ†æ”¯: $CURRENT_BRANCH" | tee -a "$MAIN_LOG"
          if [[ "$CURRENT_BRANCH" == *"22.03"* ]]; then
            FEEDS_BRANCH="openwrt-22.03"
          elif [[ "$CURRENT_BRANCH" == *"21.02"* ]]; then
            FEEDS_BRANCH="openwrt-21.02"
          elif [[ "$CURRENT_BRANCH" == *"master"* ]]; then
            FEEDS_BRANCH="master"
          else
            FEEDS_BRANCH="main"
          fi
          echo "ğŸ¯ ä½¿ç”¨Feedsåˆ†æ”¯: $FEEDS_BRANCH" | tee -a "$MAIN_LOG"
          
          case "${{ env.SOURCE_PRESET }}" in
            "immortalwrt")
              echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "openwrt")
              echo "src-git packages https://git.openwrt.org/feed/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://git.openwrt.org/project/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "lede")
              echo "src-git packages https://github.com/coolsnowwolf/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/coolsnowwolf/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
          esac
          echo "src-git routing https://github.com/openwrt/routing.git;$FEEDS_BRANCH" >> feeds.conf
          echo "src-git telephony https://github.com/openwrt/telephony.git;$FEEDS_BRANCH" >> feeds.conf
          echo "ğŸ”§ Feedsé…ç½®å†…å®¹:" | tee -a "$MAIN_LOG"
          cat feeds.conf | tee -a "$MAIN_LOG"
          echo "ğŸ”„ æ›´æ–°Feeds..." | tee -a "$MAIN_LOG"
          MAX_FEED_ATTEMPTS=3
          FEED_SUCCESS=false
          for attempt in $(seq 1 $MAX_FEED_ATTEMPTS); do
            echo "ğŸ”„ Feedsæ›´æ–°å°è¯• $attempt/$MAX_FEED_ATTEMPTS..." | tee -a "$MAIN_LOG"
            TEMP_LOG=$(mktemp)
            if { ./scripts/feeds update -a 2>&1 | tee "$TEMP_LOG"; } then
              if grep -i -E "error|failed|fatal" "$TEMP_LOG"; then
                echo "âš ï¸ Feedsæ›´æ–°æœ‰é”™è¯¯ï¼Œé‡è¯• $attempt/$MAX_FEED_ATTEMPTS..." | tee -a "$MAIN_LOG"
                cat "$TEMP_LOG" >> "$MAIN_LOG"
                grep -i -E "error|failed|fatal" "$TEMP_LOG" >> "$WARNING_LOG" || true
                rm -f "$TEMP_LOG"
                sleep 10
              else
                echo "âœ… Feedsæ›´æ–°æˆåŠŸ" | tee -a "$MAIN_LOG"
                cat "$TEMP_LOG" >> "$MAIN_LOG"
                rm -f "$TEMP_LOG"
                FEED_SUCCESS=true
                break
              fi
            else
              echo "âš ï¸ Feedsæ›´æ–°å¤±è´¥ï¼Œé‡è¯• $attempt/$MAX_FEED_ATTEMPTS..." | tee -a "$MAIN_LOG"
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              grep -i -E "error|failed|fatal" "$TEMP_LOG" >> "$WARNING_LOG" || true
              rm -f "$TEMP_LOG"
              sleep 10
            fi
          done
          if [ "$FEED_SUCCESS" = "false" ]; then
            echo "âŒ Feedsæ›´æ–°å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œç¼–è¯‘..." | tee -a "$MAIN_LOG"
            echo "Feedsæ›´æ–°å¤±è´¥" >> "$WARNING_LOG"
          fi
          echo "ğŸ“¦ å®‰è£…Feeds..." | tee -a "$MAIN_LOG"
          if ./scripts/feeds install -a 2>&1; then
            echo "âœ… Feedså®‰è£…æˆåŠŸ" | tee -a "$MAIN_LOG"
          else
            echo "âš ï¸ Feedså®‰è£…æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ..." | tee -a "$MAIN_LOG"
            echo "Feedså®‰è£…æœ‰è­¦å‘Š" >> "$WARNING_LOG"
          fi
          echo "âœ… æºç åˆå§‹åŒ–å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ“ è‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶"
        id: config_creation
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          echo "=== ğŸ“ è‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶ ===" | tee -a "$MAIN_LOG"
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          CONFIG_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/configs"
          CONFIG_FILE="$CONFIG_DIR/config_$CONFIG_PROFILE"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "ğŸ”§ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°é…ç½®: $CONFIG_FILE" | tee -a "$MAIN_LOG"
            mkdir -p "$CONFIG_DIR"
            
            echo "ğŸ” åˆ†æè®¾å¤‡åç§°: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
            
            # åˆ›å»ºé€šç”¨é…ç½®æ–‡ä»¶æ¨¡æ¿
            {
              echo "# ============================================="
              echo "# é€šç”¨è®¾å¤‡é…ç½® - $CONFIG_PROFILE"
              echo "# è‡ªåŠ¨ç”Ÿæˆäº $(date)"
              echo "# ============================================="
              echo ""
              echo "# ======================"
              echo "# åŸºç¡€ç›®æ ‡é…ç½®"
              echo "# ======================"
            } > "$CONFIG_FILE"
            
            # æ ¹æ®è®¾å¤‡åç§°çŒœæµ‹ç›®æ ‡é…ç½®
            if [[ "$CONFIG_PROFILE" == *"ac42u"* ]] || [[ "$CONFIG_PROFILE" == *"asus"* ]]; then
              echo "# ASUS RT-AC42U è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx_generic=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> "$CONFIG_FILE"
            elif [[ "$CONFIG_PROFILE" == *"x86"* ]] || [[ "$CONFIG_PROFILE" == *"64"* ]]; then
              echo "# x86/x64 è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86_64=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> "$CONFIG_FILE"
            elif [[ "$CONFIG_PROFILE" == *"mt7621"* ]] || [[ "$CONFIG_PROFILE" == *"newifi"* ]] || [[ "$CONFIG_PROFILE" == *"d2"* ]] || [[ "$CONFIG_PROFILE" == *"r6220"* ]]; then
              echo "# MT7621 è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_ramips_mt7621_DEVICE_xxx=y è¯·æ ¹æ®å…·ä½“è®¾å¤‡è®¾ç½®" >> "$CONFIG_FILE"
            else
              echo "# è¯·æ ¹æ®å®é™…è®¾å¤‡ä¿®æ”¹ä»¥ä¸‹ç›®æ ‡é…ç½®" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx_yyy=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx_yyy_DEVICE_zzz=y" >> "$CONFIG_FILE"
            fi
            
            # æ·»åŠ é€šç”¨é…ç½®
            {
              echo ""
              echo "# ======================"
              echo "# é•œåƒé…ç½®"
              echo "# ======================"
              echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y"
              echo "CONFIG_TARGET_IMAGES_GZIP=y"
              echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y"
              echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y"
              echo ""
              echo "# åˆ†åŒºå¤§å°"
              echo "CONFIG_TARGET_KERNEL_PARTSIZE=16"
              if [[ "$CONFIG_PROFILE" == *"nand"* ]]; then
                echo "CONFIG_TARGET_ROOTFS_PARTSIZE=256"
              else
                echo "CONFIG_TARGET_ROOTFS_PARTSIZE=96"
              fi
              echo ""
              echo "# ======================"
              echo "# LUCI æ ¸å¿ƒé…ç½®"
              echo "# ======================"
              echo "CONFIG_PACKAGE_luci=y"
              echo "CONFIG_PACKAGE_luci-base=y"
              echo "CONFIG_PACKAGE_luci-compat=y"
              echo "CONFIG_PACKAGE_luci-mod-admin-full=y"
              echo "CONFIG_PACKAGE_luci-theme-bootstrap=y"
            } >> "$CONFIG_FILE"
            
            echo "âœ… å·²åˆ›å»ºé€šç”¨é…ç½®æ–‡ä»¶æ¨¡æ¿: $CONFIG_FILE" | tee -a "$MAIN_LOG"
            echo "âš ï¸ è¯·æ£€æŸ¥ç›®æ ‡é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œå¦‚ä¸æ­£ç¡®è¯·æ‰‹åŠ¨ä¿®æ”¹" | tee -a "$MAIN_LOG"
            echo "æ–°é…ç½®æ–‡ä»¶åˆ›å»º: $CONFIG_FILE" >> "$WARNING_LOG"
          else
            echo "âœ… é…ç½®æ–‡ä»¶å·²å­˜åœ¨: $CONFIG_FILE" | tee -a "$MAIN_LOG"
          fi

      - name: "ğŸ¯ åº”ç”¨è®¾å¤‡é…ç½®"
        id: apply_config
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          echo "=== ğŸ¯ åº”ç”¨è®¾å¤‡é…ç½® ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "ğŸ” æŸ¥æ‰¾é…ç½®æ–‡ä»¶: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
          
          SEARCH_PATHS="${{ env.CONFIG_REPO_DIR }}/firmware-config/configs ${{ env.CONFIG_REPO_DIR }}/firmware-config ${{ env.CONFIG_REPO_DIR }}"
          
          CONFIG_FOUND=""
          for path in $SEARCH_PATHS; do
            echo "ğŸ” æœç´¢è·¯å¾„: $path" | tee -a "$MAIN_LOG"
            for name in "config_$CONFIG_PROFILE" ".config_$CONFIG_PROFILE" "$CONFIG_PROFILE" "$CONFIG_PROFILE.config"; do
              if [ -f "$path/$name" ]; then
                CONFIG_FOUND="$path/$name"
                echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND" | tee -a "$MAIN_LOG"
                break 2
              fi
            done
          done
          
          if [ -z "$CONFIG_FOUND" ]; then
            echo "ğŸ” ç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå¼€å§‹æ¨¡ç³Šæœç´¢..." | tee -a "$MAIN_LOG"
            for path in $SEARCH_PATHS; do
              if [ -d "$path" ]; then
                FOUND_FILE=$(find "$path" -type f -name "*$CONFIG_PROFILE*" 2>/dev/null | head -1)
                if [ -n "$FOUND_FILE" ] && [ -f "$FOUND_FILE" ]; then
                  CONFIG_FOUND="$FOUND_FILE"
                  echo "âœ… æ¨¡ç³Šæœç´¢æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND" | tee -a "$MAIN_LOG"
                  break
                fi
              fi
            done
          fi
          
          if [ -n "$CONFIG_FOUND" ] && [ -f "$CONFIG_FOUND" ]; then
            echo "ğŸ¯ æœ€ç»ˆä½¿ç”¨é…ç½®æ–‡ä»¶: $CONFIG_FOUND" | tee -a "$MAIN_LOG"
            echo "ğŸ“„ é…ç½®æ–‡ä»¶é¢„è§ˆ:" | tee -a "$MAIN_LOG"
            head -20 "$CONFIG_FOUND" | tee -a "$MAIN_LOG"
            echo "..." | tee -a "$MAIN_LOG"
            cp "$CONFIG_FOUND" .config
            echo "âœ… é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ" | tee -a "$MAIN_LOG"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ '$CONFIG_PROFILE'" | tee -a "$MAIN_LOG"
            echo "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ '$CONFIG_PROFILE'" >> "$ERROR_LOG"
            exit 1
          fi

      - name: "ğŸŒ é…ç½®è¯­è¨€åŒ…"
        id: language_setup
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸŒ é…ç½®è¯­è¨€åŒ… ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          LANGUAGE="${{ github.event.inputs.language_pack }}"
          echo "ğŸ¯ è¯­è¨€åŒ…é€‰æ‹©: $LANGUAGE" | tee -a "$MAIN_LOG"
          
          case "$LANGUAGE" in
            "zh-cn")
              echo "ğŸ”§ å¯ç”¨ä¸­æ–‡è¯­è¨€åŒ…..." | tee -a "$MAIN_LOG"
              sed -i 's/# CONFIG_PACKAGE_luci-i18n-base-zh-cn is not set/CONFIG_PACKAGE_luci-i18n-base-zh-cn=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
              sed -i 's/# CONFIG_PACKAGE_luci-i18n-base-zh_Hans is not set/CONFIG_PACKAGE_luci-i18n-base-zh_Hans=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-i18n-base-zh_Hans=y" >> .config
              ;;
            "en-only")
              echo "ğŸ”§ ä»…ä¿ç•™è‹±æ–‡..." | tee -a "$MAIN_LOG"
              sed -i 's/CONFIG_PACKAGE_luci-i18n-[^e][^n].*=y/# &/' .config
              ;;
            "all")
              echo "ğŸ”§ å¯ç”¨æ‰€æœ‰è¯­è¨€åŒ…..." | tee -a "$MAIN_LOG"
              for lang in $(grep "CONFIG_PACKAGE_luci-i18n-" .config | grep "is not set" | cut -d' ' -f2); do
                sed -i "s/# $lang is not set/$lang=y/" .config
              done
              ;;
          esac
          echo "âœ… è¯­è¨€åŒ…é…ç½®å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”Œ é…ç½®æ’ä»¶é¢„è®¾"
        id: plugin_setup
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ”Œ é…ç½®æ’ä»¶é¢„è®¾ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          PRESET="${{ github.event.inputs.plugin_preset }}"
          echo "ğŸ¯ æ’ä»¶é¢„è®¾: $PRESET" | tee -a "$MAIN_LOG"
          
          enable_plugin() {
            local plugin=$1
            if grep -q "CONFIG_PACKAGE_${plugin}" .config; then
              sed -i "s/# CONFIG_PACKAGE_${plugin} is not set/CONFIG_PACKAGE_${plugin}=y/" .config
            else
              echo "CONFIG_PACKAGE_${plugin}=y" >> .config
            fi
            echo "âœ… å¯ç”¨: $plugin" | tee -a "$MAIN_LOG"
          }
          
          case "$PRESET" in
            "minimal")
              echo "ğŸ”§ æœ€å°åŒ–é…ç½®..." | tee -a "$MAIN_LOG"
              ;;
            "standard")
              echo "ğŸ”§ æ ‡å‡†é…ç½®..." | tee -a "$MAIN_LOG"
              enable_plugin "luci-app-upnp"
              enable_plugin "luci-app-wireguard"
              enable_plugin "luci-app-samba4"
              enable_plugin "luci-app-turboacc"
              enable_plugin "luci-app-arpbind"
              enable_plugin "luci-app-cpulimit"
              enable_plugin "luci-app-diskman"
              enable_plugin "luci-app-eqosplus"
              enable_plugin "luci-app-hd-idle"
              enable_plugin "luci-app-parentcontrol"
              enable_plugin "luci-app-wechatpush"
              enable_plugin "luci-app-smartdns"
              enable_plugin "luci-app-vlmcsd"
              enable_plugin "luci-app-vsftpd"
              enable_plugin "luci-app-ttyd"
              enable_plugin "luci-app-sqm-autorate"
              enable_plugin "automount"
              ;;
            "full")
              echo "ğŸ”§ å®Œæ•´é…ç½®..." | tee -a "$MAIN_LOG"
              for plugin in luci-app-upnp luci-app-wireguard luci-app-samba4 luci-app-turboacc luci-app-arpbind luci-app-cpulimit luci-app-diskman luci-app-eqosplus luci-app-hd-idle luci-app-parentcontrol luci-app-wechatpush luci-app-smartdns luci-app-vlmcsd luci-app-vsftpd luci-app-ttyd luci-app-sqm-autorate luci-app-adblock luci-app-wol luci-app-ddns luci-app-qos luci-app-statistics luci-app-vpn-policy-routing luci-app-nft-qos luci-app-uhttpd luci-app-firewall luci-app-olsr luci-app-olsr-services luci-app-olsr-viz luci-app-bcp38 luci-app-commands luci-app-diag-core luci-app-nlbwmon luci-app-splash luci-app-radicale2; do
                enable_plugin "$plugin"
              done
              ;;
            "custom")
              echo "ğŸ”§ è‡ªå®šä¹‰é…ç½®..." | tee -a "$MAIN_LOG"
              CUSTOM_PLUGINS_FILE="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-plugins.txt"
              if [ -f "$CUSTOM_PLUGINS_FILE" ]; then
                echo "ğŸ“‹ è¯»å–è‡ªå®šä¹‰æ’ä»¶åˆ—è¡¨..." | tee -a "$MAIN_LOG"
                while IFS= read -r plugin; do
                  if [ -n "$plugin" ] && [[ ! "$plugin" =~ ^# ]]; then
                    enable_plugin "$plugin"
                  fi
                done < "$CUSTOM_PLUGINS_FILE"
              else
                echo "â„¹ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰æ’ä»¶åˆ—è¡¨ï¼Œä½¿ç”¨æ ‡å‡†é…ç½®" | tee -a "$MAIN_LOG"
                echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰æ’ä»¶åˆ—è¡¨" >> "$WARNING_LOG"
              fi
              ;;
          esac
          
          echo "âœ… æ’ä»¶é…ç½®å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ åº”ç”¨é«˜çº§åŠŸèƒ½"
        id: advanced_features
        if: github.event.inputs.enable_advanced == 'true'
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ”§ åº”ç”¨é«˜çº§åŠŸèƒ½ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "ğŸ”§ é«˜çº§åŠŸèƒ½çŠ¶æ€: å·²å¯ç”¨" | tee -a "$MAIN_LOG"
          
          echo "ğŸ“¦ å®‰è£…è‡ªå®šä¹‰IPKåŒ…..." | tee -a "$MAIN_LOG"
          IPK_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-features/prebuilt-ipks"
          if [ -d "$IPK_DIR" ]; then
            echo "ğŸ” æŸ¥æ‰¾è‡ªå®šä¹‰IPKåŒ…..." | tee -a "$MAIN_LOG"
            IPK_FILES=$(find "$IPK_DIR" -name "*.ipk" -type f 2>/dev/null || true)
            if [ -n "$IPK_FILES" ]; then
              echo "âœ… æ‰¾åˆ°è‡ªå®šä¹‰IPKåŒ…:" | tee -a "$MAIN_LOG"
              mkdir -p package/custom
              IPK_COUNT=0
              for ipk in $IPK_FILES; do
                ipk_name=$(basename "$ipk")
                echo "  - å¤åˆ¶ $ipk_name" | tee -a "$MAIN_LOG"
                cp "$ipk" package/custom/
                IPK_COUNT=$((IPK_COUNT + 1))
              done
              echo "CUSTOM_IPK_COUNT=$IPK_COUNT" >> $GITHUB_ENV
              echo "âœ… æˆåŠŸæ·»åŠ  $IPK_COUNT ä¸ªè‡ªå®šä¹‰IPKåŒ…" | tee -a "$MAIN_LOG"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰IPKåŒ…" | tee -a "$MAIN_LOG"
              echo "CUSTOM_IPK_COUNT=0" >> $GITHUB_ENV
            fi
          else
            echo "â„¹ï¸ è‡ªå®šä¹‰IPKç›®å½•ä¸å­˜åœ¨: $IPK_DIR" | tee -a "$MAIN_LOG"
            echo "CUSTOM_IPK_COUNT=0" >> $GITHUB_ENV
          fi
          
          echo "ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..." | tee -a "$MAIN_LOG"
          SCRIPT_PATHS="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-features/scripts ${{ env.CONFIG_REPO_DIR }}/firmware-config/scripts ${{ env.CONFIG_REPO_DIR }}/scripts"
          
          SCRIPT_COUNT=0
          for script_path in $SCRIPT_PATHS; do
            if [ -d "$script_path" ]; then
              echo "ğŸ” åœ¨ $script_path ä¸­æŸ¥æ‰¾è„šæœ¬..." | tee -a "$MAIN_LOG"
              SCRIPTS=$(find "$script_path" -maxdepth 1 -name "*.sh" -type f 2>/dev/null | sort || true)
              if [ -n "$SCRIPTS" ]; then
                for script in $SCRIPTS; do
                  script_name=$(basename "$script")
                  echo "ğŸ“œ æ‰§è¡Œè„šæœ¬: $script_name..." | tee -a "$MAIN_LOG"
                  chmod +x "$script"
                  
                  if grep -q "files/etc/init.d/service-optimizer" "$script"; then
                    echo "âš ï¸ æ£€æµ‹åˆ°å¯èƒ½ä¸å­˜åœ¨çš„æ–‡ä»¶è·¯å¾„ï¼Œåˆ›å»ºç›®å½•..." | tee -a "$MAIN_LOG"
                    mkdir -p files/etc/init.d/ || true
                  fi
                  
                  TEMP_LOG=$(mktemp)
                  if { bash "$script" 2>&1 | tee "$TEMP_LOG"; } then
                    echo "âœ… è‡ªå®šä¹‰è„šæœ¬æ‰§è¡ŒæˆåŠŸ: $script_name" | tee -a "$MAIN_LOG"
                    SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
                  else
                    echo "âŒ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå¤±è´¥: $script_name" | tee -a "$MAIN_LOG"
                    echo "è‡ªå®šä¹‰è„šæœ¬ $script_name æ‰§è¡Œå¤±è´¥" >> "$WARNING_LOG"
                    grep -i -E "error|failed|No such file" "$TEMP_LOG" >> "$WARNING_LOG" || true
                  fi
                  cat "$TEMP_LOG" >> "$MAIN_LOG"
                  rm -f "$TEMP_LOG"
                done
              fi
            fi
          done
          
          echo "CUSTOM_SCRIPT_COUNT=$SCRIPT_COUNT" >> $GITHUB_ENV
          echo "âœ… é«˜çº§åŠŸèƒ½åº”ç”¨å®Œæˆï¼Œæ‰§è¡Œäº† $SCRIPT_COUNT ä¸ªè„šæœ¬" | tee -a "$MAIN_LOG"

      - name: "ğŸ”„ æœ€ç»ˆé…ç½®å¤„ç†"
        id: final_config
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ”„ æœ€ç»ˆé…ç½®å¤„ç† ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ è¿è¡Œdefconfig..." | tee -a "$MAIN_LOG"
          TEMP_LOG=$(mktemp)
          if { make defconfig 2>&1 | tee "$TEMP_LOG"; } then
            echo "âœ… defconfigæˆåŠŸ" | tee -a "$MAIN_LOG"
            if grep -i "WARNING" "$TEMP_LOG"; then
              echo "âš ï¸ defconfigæœ‰è­¦å‘Š" | tee -a "$MAIN_LOG"
              grep -i "WARNING" "$TEMP_LOG" >> "$WARNING_LOG" || true
            fi
          else
            echo "âŒ defconfigå¤±è´¥" | tee -a "$MAIN_LOG"
            grep -i -E "error|failed|fatal" "$TEMP_LOG" | head -20 | tee -a "$MAIN_LOG"
            grep -i -E "error|failed|fatal" "$TEMP_LOG" >> "$ERROR_LOG" || true
          fi
          cat "$TEMP_LOG" >> "$MAIN_LOG"
          rm -f "$TEMP_LOG"
          
          echo "âœ… æœ€ç»ˆé…ç½®å¤„ç†å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¥ é¢„ä¸‹è½½ä¾èµ–"
        id: download_deps
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ“¥ é¢„ä¸‹è½½ä¾èµ– ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          echo "ğŸ”§ è®¾ç½®ä¸‹è½½ç›®å½•..." | tee -a "$MAIN_LOG"
          mkdir -p /mnt/downloads
          [ -d "dl" ] && rm -rf dl
          ln -sf /mnt/downloads dl
          
          echo "ğŸŒ é…ç½®å¤‡ç”¨ä¸‹è½½é•œåƒ..." | tee -a "$MAIN_LOG"
          MIRRORS_FILE="scripts/download.pl"
          if [ -f "$MIRRORS_FILE" ]; then
            sed -i 's|https://sources.cdn.openwrt.org|https://mirror2.openwrt.org/sources|g' "$MIRRORS_FILE" || true
            sed -i 's|https://mirror2.openwrt.org/sources|https://mirror2.openwrt.org/sources https://downloads.openwrt.org/sources|g' "$MIRRORS_FILE" || true
          fi
          
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½..." | tee -a "$MAIN_LOG"
          MAX_ATTEMPTS=3
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "ğŸ”„ ä¸‹è½½å°è¯• $attempt/$MAX_ATTEMPTS..." | tee -a "$MAIN_LOG"
            TEMP_LOG=$(mktemp)
            if { make download -j2 V=s 2>&1 | tee "$TEMP_LOG"; } then
              echo "âœ… ä¸‹è½½æˆåŠŸ" | tee -a "$MAIN_LOG"
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              rm -f "$TEMP_LOG"
              break
            else
              echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œé‡è¯• $attempt/$MAX_ATTEMPTS..." | tee -a "$MAIN_LOG"
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              grep -i -E "404|error|failed" "$TEMP_LOG" >> "$WARNING_LOG" || true
              rm -f "$TEMP_LOG"
              if [ $attempt -eq $MAX_ATTEMPTS ]; then
                echo "âŒ æ‰€æœ‰ä¸‹è½½å°è¯•éƒ½å¤±è´¥ï¼Œè·³è¿‡ä¸‹è½½ç»§ç»­ç¼–è¯‘..." | tee -a "$MAIN_LOG"
                echo "ä¾èµ–ä¸‹è½½å¤±è´¥" >> "$WARNING_LOG"
              fi
              sleep 15
            fi
          done
          DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶æ•°é‡: $DOWNLOAD_COUNT" | tee -a "$MAIN_LOG"

      - name: "ğŸ› ï¸ ç¼–è¯‘å·¥å…·é“¾"
        id: toolchain_build
        continue-on-error: true
        timeout-minutes: 180
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ› ï¸ ç¼–è¯‘å·¥å…·é“¾ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          echo "ğŸ”§ ç¼–è¯‘å·¥å…·é“¾..." | tee -a "$MAIN_LOG"
          MAX_RETRIES=3
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "ğŸ”„ å·¥å…·é“¾ç¼–è¯‘å°è¯• $attempt/$MAX_RETRIES" | tee -a "$MAIN_LOG"
            TEMP_LOG=$(mktemp)
            if [ $attempt -gt 1 ]; then
              echo "ğŸ§¹ æ¸…ç†å·¥å…·é“¾..." | tee -a "$MAIN_LOG"
              make toolchain/clean 2>/dev/null || true
              sleep 5
            fi
            if { make toolchain/compile -j1 V=s 2>&1 | tee "$TEMP_LOG"; } then
              echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ" | tee -a "$MAIN_LOG"
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              rm -f "$TEMP_LOG"
              break
            else
              echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥" | tee -a "$MAIN_LOG"
              if grep -q "No such file or directory" "$TEMP_LOG"; then
                echo "ğŸ”§ æ£€æµ‹åˆ°æ–‡ä»¶ç¼ºå¤±é”™è¯¯ï¼Œå°è¯•ä¿®å¤..." | tee -a "$MAIN_LOG"
                mkdir -p staging_dir/hostpkg/bin staging_dir/host/bin || true
              fi
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              grep -i -E "error|failed|No such file" "$TEMP_LOG" >> "$WARNING_LOG" || true
              rm -f "$TEMP_LOG"
              if [ $attempt -eq $MAX_RETRIES ]; then
                echo "âŒ æ‰€æœ‰å·¥å…·é“¾ç¼–è¯‘å°è¯•éƒ½å¤±è´¥" | tee -a "$MAIN_LOG"
                echo "å·¥å…·é“¾ç¼–è¯‘å¤±è´¥" >> "$ERROR_LOG"
              fi
              sleep 10
            fi
          done
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸš€ ç¼–è¯‘å›ºä»¶"
        id: firmware_build
        continue-on-error: true
        timeout-minutes: 240
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸš€ ç¼–è¯‘å›ºä»¶ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          echo "ğŸ”§ å¼€å§‹ç¼–è¯‘..." | tee -a "$MAIN_LOG"
          MAX_ATTEMPTS=3
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "ğŸ”„ ç¼–è¯‘å°è¯• $attempt/$MAX_ATTEMPTS" | tee -a "$MAIN_LOG"
            TEMP_LOG=$(mktemp)
            if [ $attempt -eq 1 ]; then
              JOBS=2
            elif [ $attempt -eq 2 ]; then
              JOBS=1
              echo "ğŸ§¹ æ¸…ç†éƒ¨åˆ†æ„å»º..." | tee -a "$MAIN_LOG"
              make target/linux-clean 2>/dev/null || true
              sleep 5
            else
              JOBS=1
              echo "ğŸ§¹ å®Œå…¨æ¸…ç†æ„å»º..." | tee -a "$MAIN_LOG"
              make clean 2>/dev/null || true
              sleep 10
              make defconfig 2>/dev/null || true
            fi
            
            if { make -j$JOBS V=s 2>&1 | tee "$TEMP_LOG"; } then
              if find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.itb" -o -name "*.gz" \) 2>/dev/null | grep -q .; then
                echo "âœ… ç¼–è¯‘æˆåŠŸï¼Œæ‰¾åˆ°å›ºä»¶æ–‡ä»¶" | tee -a "$MAIN_LOG"
                cat "$TEMP_LOG" >> "$MAIN_LOG"
                rm -f "$TEMP_LOG"
                echo "BUILD_STATUS=success" >> $GITHUB_ENV
                break
              else
                echo "âŒ ç¼–è¯‘å®Œæˆä½†æœªç”Ÿæˆæ ‡å‡†å›ºä»¶æ–‡ä»¶" | tee -a "$MAIN_LOG"
                if find bin -type f 2>/dev/null | grep -q .; then
                  echo "ğŸ“ æ‰¾åˆ°å…¶ä»–æ„å»ºäº§ç‰©:" | tee -a "$MAIN_LOG"
                  find bin -type f | head -10 | tee -a "$MAIN_LOG"
                fi
              fi
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥" | tee -a "$MAIN_LOG"
              if grep -q "No such file or directory" "$TEMP_LOG"; then
                echo "ğŸ”§ æ£€æµ‹åˆ°æ–‡ä»¶ç¼ºå¤±é”™è¯¯" | tee -a "$MAIN_LOG"
              fi
              if grep -q "recipe for target" "$TEMP_LOG" && grep -q "failed" "$TEMP_LOG"; then
                echo "ğŸ”§ æ£€æµ‹åˆ°ç¼–è¯‘ç›®æ ‡å¤±è´¥" | tee -a "$MAIN_LOG"
              fi
              cat "$TEMP_LOG" >> "$MAIN_LOG"
              grep -i -E "error|failed|No such file" "$TEMP_LOG" >> "$WARNING_LOG" || true
              rm -f "$TEMP_LOG"
              if [ $attempt -eq $MAX_ATTEMPTS ]; then
                echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•éƒ½å¤±è´¥" | tee -a "$MAIN_LOG"
                echo "BUILD_STATUS=failed" >> $GITHUB_ENV
                echo "å›ºä»¶ç¼–è¯‘å¤±è´¥" >> "$ERROR_LOG"
              fi
              sleep 10
            fi
          done
          echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ” æ™ºèƒ½å›ºä»¶åˆ†æ"
        id: firmware_analysis
        if: always()
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          ANALYSIS_REPORT="${{ env.ANALYSIS_REPORT }}"
          echo "=== ğŸ” æ™ºèƒ½å›ºä»¶åˆ†æ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "## å›ºä»¶åˆ†æç»“æœ" >> "$ANALYSIS_REPORT"
          
          if [ ! -d "bin/targets" ]; then
            echo "âŒ bin/targets ç›®å½•ä¸å­˜åœ¨" | tee -a "$MAIN_LOG"
            echo "- âŒ æœªç”Ÿæˆä»»ä½•å›ºä»¶æ–‡ä»¶" >> "$ANALYSIS_REPORT"
            echo "FIRMWARE_COUNT=0" >> $GITHUB_ENV
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            return 0
          fi
          
          # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„å›ºä»¶æ–‡ä»¶
          find bin/targets -type f \( \
            -name "*.bin" -o \
            -name "*.img" -o \
            -name "*.trx" -o \
            -name "*.itb" -o \
            -name "*.chk" -o \
            -name "*.dlf" -o \
            -name "*.tftp" -o \
            -name "*.tar" -o \
            -name "*.gz" -o \
            -name "*.ubi" -o \
            -name "*.elf" \
          \) > /tmp/all_files.txt 2>/dev/null || true
          
          echo "ğŸ“‹ å›ºä»¶æ–‡ä»¶åˆ†æ:" | tee -a "$MAIN_LOG"
          TOTAL_SIZE=0
          REAL_FIRMWARE_COUNT=0
          ALL_FILES_COUNT=0
          INITRAMFS_FOUND=""
          SYSUPGRADE_FOUND=""
          FACTORY_FOUND=""
          
          # åˆ†ææ¯ä¸ªæ–‡ä»¶
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              ALL_FILES_COUNT=$((ALL_FILES_COUNT + 1))
              size=$(du -b "$file" 2>/dev/null | cut -f1 || echo "0")
              human_size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "unknown")
              
              file_basename=$(basename "$file")
              file_lower=$(echo "$file_basename" | tr '[:upper:]' '[:lower:]')
              
              if [[ "$file_lower" =~ "initramfs" ]] || [[ "$file" =~ "initramfs" ]]; then
                echo "  ğŸš€ INITRAMFS: $file_basename ($human_size)" | tee -a "$MAIN_LOG"
                INITRAMFS_FOUND="$file"
                TOTAL_SIZE=$((TOTAL_SIZE + size))
                REAL_FIRMWARE_COUNT=$((REAL_FIRMWARE_COUNT + 1))
                echo "INITRAMFS_EXISTS=true" >> $GITHUB_ENV
                echo "- âœ… Initramfs å›ºä»¶: $file_basename ($human_size)" >> "$ANALYSIS_REPORT"
                
              elif [[ "$file_lower" =~ "sysupgrade" ]] || [[ "$file" =~ "sysupgrade" ]]; then
                echo "  ğŸ”„ SYSUPGRADE: $file_basename ($human_size)" | tee -a "$MAIN_LOG"
                SYSUPGRADE_FOUND="$file"
                TOTAL_SIZE=$((TOTAL_SIZE + size))
                REAL_FIRMWARE_COUNT=$((REAL_FIRMWARE_COUNT + 1))
                echo "SYSUPGRADE_EXISTS=true" >> $GITHUB_ENV
                echo "- âœ… Sysupgrade å›ºä»¶: $file_basename ($human_size)" >> "$ANALYSIS_REPORT"
                
              elif [[ "$file_lower" =~ "factory" ]] || [[ "$file" =~ "factory" ]]; then
                echo "  ğŸ­ FACTORY: $file_basename ($human_size)" | tee -a "$MAIN_LOG"
                FACTORY_FOUND="$file"
                TOTAL_SIZE=$((TOTAL_SIZE + size))
                REAL_FIRMWARE_COUNT=$((REAL_FIRMWARE_COUNT + 1))
                echo "FACTORY_EXISTS=true" >> $GITHUB_ENV
                echo "- âœ… Factory å›ºä»¶: $file_basename ($human_size)" >> "$ANALYSIS_REPORT"
                
              elif [ $size -gt 5000000 ]; then
                if [[ ! "$file" =~ "/packages/" ]] && [[ ! "$file_basename" =~ ^Packages ]]; then
                  echo "  ğŸ“¦ LARGE_FILE: $file_basename ($human_size)" | tee -a "$MAIN_LOG"
                  TOTAL_SIZE=$((TOTAL_SIZE + size))
                  REAL_FIRMWARE_COUNT=$((REAL_FIRMWARE_COUNT + 1))
                  echo "- ğŸ“¦ å¤§å‹æ–‡ä»¶: $file_basename ($human_size)" >> "$ANALYSIS_REPORT"
                else
                  echo "  ğŸ“ PACKAGE: $file_basename ($human_size)" | tee -a "$MAIN_LOG"
                fi
              else
                echo "  ğŸ“„ OTHER: $file_basename ($human_size)" | tee -a "$MAIN_LOG"
              fi
            fi
          done < /tmp/all_files.txt
          
          # è®¾ç½®é»˜è®¤å€¼
          echo "FACTORY_EXISTS=${FACTORY_EXISTS:-false}" >> $GITHUB_ENV
          echo "SYSUPGRADE_EXISTS=${SYSUPGRADE_EXISTS:-false}" >> $GITHUB_ENV
          echo "INITRAMFS_EXISTS=${INITRAMFS_EXISTS:-false}" >> $GITHUB_ENV
          
          TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024 / 1024))
          echo "ğŸ“Š å›ºä»¶åˆ†æç»“æœ:" | tee -a "$MAIN_LOG"
          echo "  - çœŸå®å›ºä»¶æ•°é‡: $REAL_FIRMWARE_COUNT" | tee -a "$MAIN_LOG"
          echo "  - æ€»æ–‡ä»¶æ•°é‡: $ALL_FILES_COUNT" | tee -a "$MAIN_LOG"
          echo "  - å›ºä»¶æ€»å¤§å°: ${TOTAL_SIZE_MB}MB" | tee -a "$MAIN_LOG"
          echo "  - Factory å›ºä»¶: ${{ env.FACTORY_EXISTS || 'false' }}" | tee -a "$MAIN_LOG"
          echo "  - Sysupgrade å›ºä»¶: ${{ env.SYSUPGRADE_EXISTS || 'false' }}" | tee -a "$MAIN_LOG"
          echo "  - Initramfs å›ºä»¶: ${{ env.INITRAMFS_EXISTS || 'false' }}" | tee -a "$MAIN_LOG"
          
          echo "FIRMWARE_SIZE_MB=$TOTAL_SIZE_MB" >> $GITHUB_ENV
          echo "FIRMWARE_COUNT=$REAL_FIRMWARE_COUNT" >> $GITHUB_ENV
          
          # æ›´æ–°åˆ†ææŠ¥å‘Š
          echo "" >> "$ANALYSIS_REPORT"
          echo "### ç»Ÿè®¡ä¿¡æ¯" >> "$ANALYSIS_REPORT"
          echo "- å›ºä»¶æ–‡ä»¶æ•°é‡: $REAL_FIRMWARE_COUNT" >> "$ANALYSIS_REPORT"
          echo "- æ€»æ–‡ä»¶æ•°é‡: $ALL_FILES_COUNT" >> "$ANALYSIS_REPORT"
          echo "- å›ºä»¶æ€»å¤§å°: ${TOTAL_SIZE_MB}MB" >> "$ANALYSIS_REPORT"
          
          rm -f /tmp/all_files.txt
          echo "âœ… æ™ºèƒ½å›ºä»¶åˆ†æå®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©"
        id: collect_artifacts
        if: always()
        continue-on-error: true
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰© ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          mkdir -p /mnt/artifacts/firmware
          echo "ğŸ“¦ æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          FIRMWARE_COUNT=0
          if [ -d "bin/targets" ]; then
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.itb" -o -name "*.gz" \) > /tmp/firmware-list.txt 2>/dev/null || true
            if [ -f "/tmp/firmware-list.txt" ]; then
              FIRMWARE_COUNT=$(wc -l < /tmp/firmware-list.txt)
              echo "ğŸ“¦ æ‰¾åˆ° $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶..." | tee -a "$MAIN_LOG"
              COPIED_COUNT=0
              while IFS= read -r firmware; do
                if [ -f "$firmware" ]; then
                  filename=$(basename "$firmware")
                  safe_filename=$(echo "$filename" | tr ' ' '_' | tr -cd '[:alnum:]._-')
                  cp "$firmware" "/mnt/artifacts/firmware/$safe_filename" && {
                    COPIED_COUNT=$((COPIED_COUNT+1))
                    echo "âœ… å¤åˆ¶: $filename" | tee -a "$MAIN_LOG"
                  } || echo "âš ï¸ å¤åˆ¶å¤±è´¥: $filename" | tee -a "$MAIN_LOG"
                fi
              done < /tmp/firmware-list.txt
              echo "ARTIFACT_COUNT=$COPIED_COUNT" >> $GITHUB_ENV
              echo "âœ… æˆåŠŸå¤åˆ¶ $COPIED_COUNT ä¸ªå›ºä»¶æ–‡ä»¶" | tee -a "$MAIN_LOG"
            else
              echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶" | tee -a "$MAIN_LOG"
              echo "ARTIFACT_COUNT=0" >> $GITHUB_ENV
            fi
          else
            echo "âŒ bin/targets ç›®å½•ä¸å­˜åœ¨" | tee -a "$MAIN_LOG"
            echo "ARTIFACT_COUNT=0" >> $GITHUB_ENV
          fi

      - name: "ğŸ“‹ æ™ºèƒ½é”™è¯¯åˆ†ææŠ¥å‘Š"
        id: error_analysis
        if: always()
        continue-on-error: true
        timeout-minutes: 5
        run: |
          set +e
          echo "=== ğŸ“‹ æ™ºèƒ½é”™è¯¯åˆ†ææŠ¥å‘Š ==="
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          ANALYSIS_REPORT="${{ env.ANALYSIS_REPORT }}"
          
          echo "## é”™è¯¯åˆ†ææŠ¥å‘Š" >> "$ANALYSIS_REPORT"
          echo "" >> "$ANALYSIS_REPORT"
          
          # åˆ†æé”™è¯¯æ—¥å¿—
          echo "ğŸ” åˆ†æé”™è¯¯æ—¥å¿—..." | tee -a "$MAIN_LOG"
          if [ -f "$ERROR_LOG" ]; then
            ERROR_COUNT=$(grep -c . "$ERROR_LOG" 2>/dev/null || echo "0")
            if [ "$ERROR_COUNT" -gt 1 ]; then
              echo "âŒ å‘ç° $((ERROR_COUNT-1)) ä¸ªé”™è¯¯:" | tee -a "$MAIN_LOG"
              echo "### å…³é”®é”™è¯¯ ($((ERROR_COUNT-1)) ä¸ª)" >> "$ANALYSIS_REPORT"
              tail -n +2 "$ERROR_LOG" | while IFS= read -r error; do
                echo "- âŒ $error" >> "$ANALYSIS_REPORT"
              done
              echo "" >> "$ANALYSIS_REPORT"
            else
              echo "âœ… æ²¡æœ‰å…³é”®é”™è¯¯" | tee -a "$MAIN_LOG"
              echo "### å…³é”®é”™è¯¯: æ— " >> "$ANALYSIS_REPORT"
              echo "" >> "$ANALYSIS_REPORT"
            fi
          fi
          
          # åˆ†æè­¦å‘Šæ—¥å¿—
          echo "ğŸ” åˆ†æè­¦å‘Šæ—¥å¿—..." | tee -a "$MAIN_LOG"
          if [ -f "$WARNING_LOG" ]; then
            WARNING_COUNT=$(grep -c . "$WARNING_LOG" 2>/dev/null || echo "0")
            if [ "$WARNING_COUNT" -gt 1 ]; then
              echo "âš ï¸ å‘ç° $((WARNING_COUNT-1)) ä¸ªè­¦å‘Š:" | tee -a "$MAIN_LOG"
              echo "### è­¦å‘Šä¿¡æ¯ ($((WARNING_COUNT-1)) ä¸ª)" >> "$ANALYSIS_REPORT"
              tail -n +2 "$WARNING_LOG" | while IFS= read -r warning; do
                echo "- âš ï¸ $warning" >> "$ANALYSIS_REPORT"
              done
              echo "" >> "$ANALYSIS_REPORT"
            else
              echo "âœ… æ²¡æœ‰è­¦å‘Š" | tee -a "$MAIN_LOG"
              echo "### è­¦å‘Šä¿¡æ¯: æ— " >> "$ANALYSIS_REPORT"
              echo "" >> "$ANALYSIS_REPORT"
            fi
          fi
          
          # ä»ä¸»æ—¥å¿—ä¸­æå–å…³é”®é”™è¯¯æ¨¡å¼
          echo "ğŸ” åˆ†ææ„å»ºæ—¥å¿—ä¸­çš„é”™è¯¯æ¨¡å¼..." | tee -a "$MAIN_LOG"
          echo "### æ„å»ºæ—¥å¿—åˆ†æ" >> "$ANALYSIS_REPORT"
          
          # 404 ä¸‹è½½é”™è¯¯
          DOWNLOAD_404_COUNT=$(grep -c "404" "$MAIN_LOG" 2>/dev/null || echo "0")
          if [ "$DOWNLOAD_404_COUNT" -gt 0 ]; then
            echo "ğŸ“¥ å‘ç° $DOWNLOAD_404_COUNT ä¸ªä¸‹è½½é”™è¯¯ (404)" | tee -a "$MAIN_LOG"
            echo "- ğŸ“¥ ä¸‹è½½é”™è¯¯ (404): $DOWNLOAD_404_COUNT ä¸ª" >> "$ANALYSIS_REPORT"
          fi
          
          # æ–‡ä»¶ç¼ºå¤±é”™è¯¯
          FILE_MISSING_COUNT=$(grep -c "No such file or directory" "$MAIN_LOG" 2>/dev/null || echo "0")
          if [ "$FILE_MISSING_COUNT" -gt 0 ]; then
            echo "ğŸ“„ å‘ç° $FILE_MISSING_COUNT ä¸ªæ–‡ä»¶ç¼ºå¤±é”™è¯¯" | tee -a "$MAIN_LOG"
            echo "- ğŸ“„ æ–‡ä»¶ç¼ºå¤±é”™è¯¯: $FILE_MISSING_COUNT ä¸ª" >> "$ANALYSIS_REPORT"
          fi
          
          # ç¼–è¯‘é”™è¯¯
          COMPILE_ERROR_COUNT=$(grep -c "error:" "$MAIN_LOG" 2>/dev/null || echo "0")
          if [ "$COMPILE_ERROR_COUNT" -gt 0 ]; then
            echo "ğŸ”§ å‘ç° $COMPILE_ERROR_COUNT ä¸ªç¼–è¯‘é”™è¯¯" | tee -a "$MAIN_LOG"
            echo "- ğŸ”§ ç¼–è¯‘é”™è¯¯: $COMPILE_ERROR_COUNT ä¸ª" >> "$ANALYSIS_REPORT"
          fi
          
          # å¤±è´¥ç»Ÿè®¡
          FAILED_COUNT=$(grep -c "failed" "$MAIN_LOG" 2>/dev/null || echo "0")
          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "âŒ å‘ç° $FAILED_COUNT ä¸ªå¤±è´¥æ“ä½œ" | tee -a "$MAIN_LOG"
            echo "- âŒ å¤±è´¥æ“ä½œ: $FAILED_COUNT ä¸ª" >> "$ANALYSIS_REPORT"
          fi
          
          echo "" >> "$ANALYSIS_REPORT"
          echo "## æ„å»ºæ€»ç»“" >> "$ANALYSIS_REPORT"
          echo "- æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}" >> "$ANALYSIS_REPORT"
          echo "- å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}" >> "$ANALYSIS_REPORT"
          echo "- å›ºä»¶å¤§å°: ${{ env.FIRMWARE_SIZE_MB || 'unknown' }}MB" >> "$ANALYSIS_REPORT"
          echo "- è‡ªå®šä¹‰IPK: ${{ env.CUSTOM_IPK_COUNT || 0 }} ä¸ª" >> "$ANALYSIS_REPORT"
          echo "- è‡ªå®šä¹‰è„šæœ¬: ${{ env.CUSTOM_SCRIPT_COUNT || 0 }} ä¸ª" >> "$ANALYSIS_REPORT"
          
          echo "âœ… æ™ºèƒ½é”™è¯¯åˆ†æå®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
        id: upload_artifacts
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Build-Artifacts-${{ github.run_number }}"
          path: |
            /mnt/artifacts
            /mnt/build-logs
          retention-days: 30
          compression-level: 9

      - name: "ğŸ“Š æœ€ç»ˆæ„å»ºæŠ¥å‘Š"
        id: final_report
        if: always()
        run: |
          echo "=== ğŸ“Š æœ€ç»ˆæ„å»ºæŠ¥å‘Š ==="
          echo ""
          echo "ğŸ¯ æ„å»ºæ‘˜è¦"
          echo "=========================================="
          echo "ğŸ“¦ æºç ä¿¡æ¯:"
          echo "  - é¢„è®¾: ${{ env.SOURCE_PRESET || 'unknown' }}"
          echo "  - åˆ†æ”¯: ${{ env.ACTUAL_BRANCH || 'unknown' }}"
          echo "  - æäº¤: ${{ env.COMMIT_HASH || 'unknown' }}"
          echo ""
          echo "ğŸ“ˆ æ„å»ºç»“æœ:"
          echo "  - çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - å›ºä»¶å¤§å°: ${{ env.FIRMWARE_SIZE_MB || 'unknown' }}MB"
          echo "  - äº§ç‰©æ•°é‡: ${{ env.ARTIFACT_COUNT || 0 }}"
          echo "  - å›ºä»¶ç±»å‹:"
          echo "    * Factory: ${{ env.FACTORY_EXISTS || 'false' }}"
          echo "    * Sysupgrade: ${{ env.SYSUPGRADE_EXISTS || 'false' }}"
          echo "    * Initramfs: ${{ env.INITRAMFS_EXISTS || 'false' }}"
          echo ""
          echo "ğŸ”§ é«˜çº§åŠŸèƒ½:"
          echo "  - å¯ç”¨çŠ¶æ€: ${{ github.event.inputs.enable_advanced || 'false' }}"
          echo "  - è‡ªå®šä¹‰IPK: ${{ env.CUSTOM_IPK_COUNT || 0 }} ä¸ª"
          echo "  - è‡ªå®šä¹‰è„šæœ¬: ${{ env.CUSTOM_SCRIPT_COUNT || 0 }} ä¸ª"
          echo ""
          echo "ğŸ“‹ é”™è¯¯ç»Ÿè®¡:"
          echo "  - æŸ¥çœ‹è¯¦ç»†åˆ†ææŠ¥å‘Šäº†è§£é”™è¯¯è¯¦æƒ…"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            if [ "${{ env.FIRMWARE_COUNT }}" -gt 0 ]; then
              echo "ğŸ‰ æ„å»ºæˆåŠŸï¼å›ºä»¶å·²ç”Ÿæˆ"
              if [ "${{ env.FACTORY_EXISTS }}" = "true" ]; then
                echo "ğŸ’¡ åŒ…å« Factory å›ºä»¶ï¼Œå¯ç”¨äºé¦–æ¬¡åˆ·æœº"
              fi
              if [ "${{ env.SYSUPGRADE_EXISTS }}" = "true" ]; then
                echo "ğŸ’¡ åŒ…å« Sysupgrade å›ºä»¶ï¼Œå¯ç”¨äºç³»ç»Ÿå‡çº§"
              fi
              if [ "${{ env.INITRAMFS_EXISTS }}" = "true" ]; then
                echo "ğŸ’¡ åŒ…å« Initramfs å›ºä»¶ï¼Œå¯ç”¨äºä¸´æ—¶å¯åŠ¨"
              fi
            else
              echo "âš ï¸ æ„å»ºæˆåŠŸä½†æœªç”Ÿæˆå›ºä»¶"
            fi
          else
            echo "âŒ æ„å»ºå¤±è´¥æˆ–éƒ¨åˆ†å¤±è´¥"
            echo "ğŸ’¡ è¯·æŸ¥çœ‹è¯¦ç»†åˆ†ææŠ¥å‘Šäº†è§£é—®é¢˜è¯¦æƒ…"
            echo "ğŸ”§ å¸¸è§é—®é¢˜:"
            echo "  - ä¾èµ–åŒ…ä¸‹è½½å¤±è´¥ (404)"
            echo "  - å·¥å…·é“¾ç¼–è¯‘é”™è¯¯"
            echo "  - æ–‡ä»¶è·¯å¾„é—®é¢˜"
            echo "  - å†…å­˜ä¸è¶³"
          fi
          echo ""
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "=========================================="
