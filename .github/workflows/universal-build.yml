name: "ğŸš€ è¶…å¿«é€Ÿå›ºä»¶æ„å»ºå™¨ - æ™ºèƒ½ä¼˜åŒ–ç‰ˆ"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "auto"
        type: choice
        options: ["auto", "openwrt-22.03", "openwrt-21.02", "master", "main"]
      config_profile:
        description: "è®¾å¤‡é…ç½®æ–‡ä»¶åç§°"
        required: true
        type: string
        default: "rt-ac42u"
      build_optimization:
        description: "ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥"
        required: true
        type: choice
        options: ["balanced", "speed", "stability"]
        default: "balanced"
      enable_advanced:
        description: "å¯ç”¨é«˜çº§åŠŸèƒ½"
        required: false
        default: true
        type: boolean
      language_pack:
        description: "è¯­è¨€åŒ…é€‰æ‹©"
        required: true
        type: choice
        options: ["zh-cn", "en-only", "all"]
        default: "zh-cn"
      plugin_preset:
        description: "æ’ä»¶é¢„è®¾"
        required: true
        type: choice
        options: ["minimal", "standard", "full", "custom"]
        default: "standard"
      skip_tests:
        description: "è·³è¿‡æµ‹è¯•é˜¶æ®µ"
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 240  # å‡å°‘è¶…æ—¶æ—¶é—´ï¼Œä¼˜åŒ–ååº”è¯¥æ›´å¿«
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"
        with:
          path: "config-repo"
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ”§ æé€Ÿç¯å¢ƒåˆå§‹åŒ–"
        id: init
        run: |
          echo "=== ğŸ”§ æé€Ÿç¯å¢ƒåˆå§‹åŒ– ==="
          sudo mkdir -p /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chown -R $USER:$USER /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chmod -R 755 /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          
          MAIN_LOG="/mnt/build-logs/build_timeline.log"
          ERROR_LOG="/mnt/build-logs/errors.log"
          WARNING_LOG="/mnt/build-logs/warnings.log"
          ANALYSIS_REPORT="/mnt/build-logs/analysis_report.md"
          
          echo "ğŸ æé€Ÿæ„å»ºå¼€å§‹: $(date)" > $MAIN_LOG
          echo "ğŸš€ å·¥ä½œæµç‰ˆæœ¬: è¶…å¿«é€Ÿå›ºä»¶æ„å»ºå™¨" >> $MAIN_LOG
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV
          echo "ERROR_LOG=$ERROR_LOG" >> $GITHUB_ENV
          echo "WARNING_LOG=$WARNING_LOG" >> $GITHUB_ENV
          echo "ANALYSIS_REPORT=$ANALYSIS_REPORT" >> $GITHUB_ENV
          echo "CONFIG_REPO_DIR=${{ github.workspace }}/config-repo" >> $GITHUB_ENV
          echo "BUILD_STATUS=running" >> $GITHUB_ENV
          
          # æé€Ÿæ—¥å¿—åˆå§‹åŒ–
          echo "# é”™è¯¯æ—¥å¿—" > $ERROR_LOG
          echo "# è­¦å‘Šæ—¥å¿—" > $WARNING_LOG
          echo "# æ™ºèƒ½åˆ†ææŠ¥å‘Š" > $ANALYSIS_REPORT
          echo "âœ… æé€Ÿç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: "âš¡ æ€§èƒ½æé€Ÿä¼˜åŒ–"
        id: performance
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== âš¡ æ€§èƒ½æé€Ÿä¼˜åŒ– ===" | tee -a "$MAIN_LOG"
          
          # æ ¹æ®CPUæ ¸å¿ƒæ•°åŠ¨æ€ä¼˜åŒ–
          CPU_CORES=$(nproc)
          echo "ğŸ–¥ï¸ æ£€æµ‹åˆ° CPU æ ¸å¿ƒ: $CPU_CORES" | tee -a "$MAIN_LOG"
          
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          case "$OPTIMIZATION_STRATEGY" in
            "speed")
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=$((CPU_CORES + 2))
              echo "ğŸš€ æé€Ÿæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            "stability")
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=$((CPU_CORES / 2))
              echo "ğŸ›¡ï¸ ç¨³å®šæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            *)
              CCACHE_SIZE="6G"
              PARALLEL_JOBS=$CPU_CORES
              echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
          esac
          
          # é…ç½®ccache
          mkdir -p /mnt/ccache
          ccache -M $CCACHE_SIZE
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=100000
          
          echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          
          # åˆ›å»ºå¤§å®¹é‡äº¤æ¢æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
          echo "ğŸ’¾ åˆ›å»ºäº¤æ¢æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          sudo fallocate -l 8G /mnt/swapfile && sudo chmod 600 /mnt/swapfile && sudo mkswap /mnt/swapfile && sudo swapon /mnt/swapfile
          
          echo "ğŸ“Š ç³»ç»Ÿèµ„æºçŠ¶æ€:" | tee -a "$MAIN_LOG"
          free -h | tee -a "$MAIN_LOG"
          echo "âœ… æ€§èƒ½ä¼˜åŒ–å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸš€ æé€Ÿä¾èµ–å®‰è£…"
        id: install_deps
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸš€ æé€Ÿä¾èµ–å®‰è£… ===" | tee -a "$MAIN_LOG"
          
          echo "ğŸ“¦ æ‰¹é‡å®‰è£…ç¼–è¯‘ä¾èµ–..." | tee -a "$MAIN_LOG"
          sudo apt-get update -qq
          
          # æ‰¹é‡å®‰è£…æ‰€æœ‰ä¾èµ–ï¼Œå‡å°‘aptè°ƒç”¨æ¬¡æ•°
          sudo apt-get install -y -qq \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-pip python3-dev \
            rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake \
            autoconf pkg-config subversion curl cmake ninja-build libelf-dev \
            libxml2-dev liblzma-dev liblzo2-dev axel net-tools e2fsprogs \
            genext2fs dosfstools mtools libffi-dev libsqlite3-dev libpam0g-dev \
            libtirpc-dev libev-dev lm-sensors libsnmp-dev libglib2.0-dev \
            libgpiod-dev libfl-dev upx-ucl
          
          # é…ç½®Pythonç¯å¢ƒ
          python3 -m pip install --upgrade pip setuptools wheel -q
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ æé€Ÿæºç è·å–"
        id: source_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== âš¡ æé€Ÿæºç è·å– ===" | tee -a "$MAIN_LOG"
          
          REPO_JSON_FOUND="${{ env.CONFIG_REPO_DIR }}/firmware-config/repositories.json"
          PRESET="${{ github.event.inputs.source_preset }}"
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND")
          BRANCH="${{ github.event.inputs.source_branch }}"
          
          if [ "$BRANCH" = "auto" ]; then
            BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND")
          fi
          
          echo "ğŸ“¦ æé€Ÿå…‹éš†æºç ..." | tee -a "$MAIN_LOG"
          cd /mnt/source
          rm -rf .[!.]* *
          
          # ä½¿ç”¨æ·±åº¦å…‹éš†å’Œå¹¶è¡Œä¸‹è½½
          git clone --depth 1 --branch "$BRANCH" --single-branch --progress "$SOURCE_URL" . || {
            echo "ğŸ”„ åˆ†æ”¯å…‹éš†å¤±è´¥ï¼Œå°è¯•masteråˆ†æ”¯..." | tee -a "$MAIN_LOG"
            git clone --depth 1 --progress "$SOURCE_URL" .
            git checkout "$BRANCH" 2>/dev/null || true
          }
          
          ACTUAL_BRANCH=$(git branch --show-current)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "âœ… æºç è·å–å®Œæˆ: $ACTUAL_BRANCH@$COMMIT_HASH" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ æ™ºèƒ½é…ç½®é¢„å¤„ç†"
        id: pre_config
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ æ™ºèƒ½é…ç½®é¢„å¤„ç† ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          # åº”ç”¨è®¾å¤‡é…ç½®
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          CONFIG_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/configs"
          CONFIG_FILE="$CONFIG_DIR/config_$CONFIG_PROFILE"
          
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" .config
            echo "âœ… åº”ç”¨é…ç½®æ–‡ä»¶: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
          else
            # è‡ªåŠ¨ç”ŸæˆåŸºç¡€é…ç½®
            echo "ğŸ”§ è‡ªåŠ¨ç”ŸæˆåŸºç¡€é…ç½®..." | tee -a "$MAIN_LOG"
            {
              echo "# è‡ªåŠ¨ç”Ÿæˆé…ç½® - $CONFIG_PROFILE"
              echo "CONFIG_TARGET_x86=y"
              echo "CONFIG_TARGET_x86_64=y"
              echo "CONFIG_TARGET_x86_64_DEVICE_generic=y"
              echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y"
              echo "CONFIG_PACKAGE_luci=y"
              echo "CONFIG_PACKAGE_luci-base=y"
            } > .config
          fi
          
          # é¢„é…ç½®ä¼˜åŒ–é€‰é¡¹
          echo "âš¡ é¢„é…ç½®ä¼˜åŒ–é€‰é¡¹..." | tee -a "$MAIN_LOG"
          {
            echo "# ç¼–è¯‘ä¼˜åŒ–"
            echo "CONFIG_CCACHE=y"
            echo "CONFIG_BUILD_LOG=y"
            echo "CONFIG_SDK=y"
            echo "# CONFIG_DEBUG=y is not set"
          } >> .config
          
          # ç¦ç”¨å·²çŸ¥é—®é¢˜åŒ…
          echo "ğŸš« ç¦ç”¨å·²çŸ¥é—®é¢˜åŒ…..." | tee -a "$MAIN_LOG"
          for pkg in 6in4 6rd 6to4 luci-app-6in4 luci-app-6rd; do
            sed -i "s/CONFIG_PACKAGE_${pkg}=y/# CONFIG_PACKAGE_${pkg} is not set/" .config
          done
          
          echo "âœ… é…ç½®é¢„å¤„ç†å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”„ å¹¶è¡ŒFeedsæ›´æ–°"
        id: feeds_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”„ å¹¶è¡ŒFeedsæ›´æ–° ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          # é…ç½®feeds
          CURRENT_BRANCH=$(git branch --show-current)
          if [[ "$CURRENT_BRANCH" == *"22.03"* ]]; then FEEDS_BRANCH="openwrt-22.03"
          elif [[ "$CURRENT_BRANCH" == *"21.02"* ]]; then FEEDS_BRANCH="openwrt-21.02"
          else FEEDS_BRANCH="master"; fi
          
          case "${{ env.SOURCE_PRESET }}" in
            "immortalwrt")
              echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "openwrt")
              echo "src-git packages https://git.openwrt.org/feed/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://git.openwrt.org/project/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "lede")
              echo "src-git packages https://github.com/coolsnowwolf/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/coolsnowwolf/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
          esac
          
          echo "src-git routing https://github.com/openwrt/routing.git;$FEEDS_BRANCH" >> feeds.conf
          
          # å¹¶è¡Œæ›´æ–°feeds
          echo "ğŸ”„ å¹¶è¡Œæ›´æ–°feeds..." | tee -a "$MAIN_LOG"
          ./scripts/feeds update -a &
          FEEDS_PID=$!
          
          # åŒæ—¶å¼€å§‹ä¸‹è½½ç›®å½•è®¾ç½®
          mkdir -p /mnt/downloads
          [ -d "dl" ] && rm -rf dl
          ln -sf /mnt/downloads dl
          
          wait $FEEDS_PID
          ./scripts/feeds install -a
          
          echo "âœ… Feedsæ›´æ–°å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ¯ æ™ºèƒ½é…ç½®åº”ç”¨"
        id: apply_config
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ¯ æ™ºèƒ½é…ç½®åº”ç”¨ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          # åº”ç”¨è¯­è¨€é…ç½®
          LANGUAGE="${{ github.event.inputs.language_pack }}"
          if [ "$LANGUAGE" = "zh-cn" ]; then
            echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
          elif [ "$LANGUAGE" = "en-only" ]; then
            sed -i 's/CONFIG_PACKAGE_luci-i18n-[^e][^n].*=y/# &/' .config
          fi
          
          # åº”ç”¨æ’ä»¶é¢„è®¾
          PRESET="${{ github.event.inputs.plugin_preset }}"
          case "$PRESET" in
            "standard")
              for plugin in luci-app-upnp luci-app-wireguard luci-app-samba4 luci-app-turboacc; do
                echo "CONFIG_PACKAGE_${plugin}=y" >> .config
              done
              ;;
            "full")
              for plugin in luci-app-upnp luci-app-wireguard luci-app-samba4 luci-app-turboacc luci-app-adblock luci-app-wol luci-app-ddns; do
                echo "CONFIG_PACKAGE_${plugin}=y" >> .config
              done
              ;;
          esac
          
          # æœ€ç»ˆé…ç½®
          make defconfig
          echo "âœ… æ™ºèƒ½é…ç½®å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸš€ å¹¶è¡Œä¸‹è½½ä¼˜åŒ–"
        id: download_deps
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸš€ å¹¶è¡Œä¸‹è½½ä¼˜åŒ– ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          # é…ç½®ä¸‹è½½é•œåƒ
          sed -i 's|https://sources.cdn.openwrt.org|https://mirror2.openwrt.org/sources|g' scripts/download.pl
          
          echo "ğŸ“¥ å¼€å§‹å¹¶è¡Œä¸‹è½½..." | tee -a "$MAIN_LOG"
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          
          # ä½¿ç”¨å¹¶è¡Œä¸‹è½½
          if make download -j$PARALLEL_JOBS; then
            echo "âœ… ä¸‹è½½æˆåŠŸ" | tee -a "$MAIN_LOG"
          else
            echo "ğŸ”„ ä¸‹è½½æœ‰é”™è¯¯ï¼Œé‡è¯•..." | tee -a "$MAIN_LOG"
            make download -j2
          fi
          
          DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
          echo "ğŸ“¦ ä¸‹è½½æ–‡ä»¶æ•°é‡: $DOWNLOAD_COUNT" | tee -a "$MAIN_LOG"

      - name: "âš¡ æ™ºèƒ½å¢é‡ç¼–è¯‘"
        id: smart_build
        timeout-minutes: 180
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== âš¡ æ™ºèƒ½å¢é‡ç¼–è¯‘ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          SKIP_TESTS="${{ github.event.inputs.skip_tests }}"
          
          echo "ğŸ”§ ç¼–è¯‘é…ç½®: å¹¶è¡Œä½œä¸š=$PARALLEL_JOBS, è·³è¿‡æµ‹è¯•=$SKIP_TESTS" | tee -a "$MAIN_LOG"
          
          # ç¼–è¯‘ç­–ç•¥
          if [ "$SKIP_TESTS" = "true" ]; then
            EXTRA_FLAGS="IGNORE_ERRORS=m"
          else
            EXTRA_FLAGS=""
          fi
          
          # æ™ºèƒ½ç¼–è¯‘ï¼šä¼˜å…ˆç¼–è¯‘å·¥å…·é“¾å’Œå†…æ ¸
          echo "ğŸ› ï¸ é˜¶æ®µ1: ç¼–è¯‘å·¥å…·é“¾..." | tee -a "$MAIN_LOG"
          make toolchain/compile -j$PARALLEL_JOBS $EXTRA_FLAGS
          
          echo "ğŸ› ï¸ é˜¶æ®µ2: ç¼–è¯‘å†…æ ¸..." | tee -a "$MAIN_LOG"
          make target/linux/compile -j$PARALLEL_JOBS $EXTRA_FLAGS
          
          echo "ğŸš€ é˜¶æ®µ3: å®Œæ•´ç¼–è¯‘..." | tee -a "$MAIN_LOG"
          if make -j$PARALLEL_JOBS $EXTRA_FLAGS; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ" | tee -a "$MAIN_LOG"
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âš ï¸ ç¼–è¯‘æœ‰é”™è¯¯ï¼Œä½†ç»§ç»­æ£€æŸ¥äº§ç‰©..." | tee -a "$MAIN_LOG"
            # å³ä½¿ç¼–è¯‘æŠ¥é”™ä¹Ÿæ£€æŸ¥æ˜¯å¦æœ‰å›ºä»¶ç”Ÿæˆ
          fi
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©
          if find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) | grep -q .; then
            echo "ğŸ‰ æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼" | tee -a "$MAIN_LOG"
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶" | tee -a "$MAIN_LOG"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“Š CCacheç»Ÿè®¡:" | tee -a "$MAIN_LOG"
          ccache -s | tee -a "$MAIN_LOG"

      - name: "ğŸ” å¿«é€Ÿå›ºä»¶åˆ†æ"
        id: firmware_analysis
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ” å¿«é€Ÿå›ºä»¶åˆ†æ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          # å¿«é€Ÿåˆ†æå›ºä»¶
          FIRMWARE_COUNT=0
          TOTAL_SIZE=0
          
          if [ -d "bin/targets" ]; then
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
                size=$(du -b "$file" 2>/dev/null | cut -f1)
                TOTAL_SIZE=$((TOTAL_SIZE + size))
                echo "ğŸ“¦ å›ºä»¶: $(basename "$file") ($(du -h "$file" | cut -f1))" | tee -a "$MAIN_LOG"
              fi
            done < <(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null)
          fi
          
          TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024 / 1024))
          echo "FIRMWARE_COUNT=$FIRMWARE_COUNT" >> $GITHUB_ENV
          echo "FIRMWARE_SIZE_MB=$TOTAL_SIZE_MB" >> $GITHUB_ENV
          
          echo "ğŸ“Š åˆ†æç»“æœ: $FIRMWARE_COUNT ä¸ªå›ºä»¶, ${TOTAL_SIZE_MB}MB" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¦ æé€Ÿäº§ç‰©æ”¶é›†"
        id: collect_artifacts
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¦ æé€Ÿäº§ç‰©æ”¶é›† ===" | tee -a "$MAIN_LOG"
          
          mkdir -p /mnt/artifacts/firmware
          ARTIFACT_COUNT=0
          
          if [ -d "/mnt/source/bin/targets" ]; then
            # å¹¶è¡Œå¤åˆ¶å›ºä»¶æ–‡ä»¶
            find /mnt/source/bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) -exec cp {} /mnt/artifacts/firmware/ \;
            ARTIFACT_COUNT=$(ls /mnt/artifacts/firmware/ | wc -l)
          fi
          
          # å¤åˆ¶æ—¥å¿—æ–‡ä»¶
          cp "$MAIN_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$ERROR_LOG" /mnt/artifacts/ 2>/dev/null || true
          
          echo "ARTIFACT_COUNT=$ARTIFACT_COUNT" >> $GITHUB_ENV
          echo "âœ… æ”¶é›†äº† $ARTIFACT_COUNT ä¸ªäº§ç‰©" | tee -a "$MAIN_LOG"

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
        id: upload_artifacts
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Build-Artifacts-${{ github.run_number }}"
          path: |
            /mnt/artifacts
          retention-days: 7  # å‡å°‘ä¿ç•™å¤©æ•°ä»¥èŠ‚çœå­˜å‚¨
          compression-level: 6

      - name: "ğŸ“Š æé€Ÿæ„å»ºæŠ¥å‘Š"
        id: final_report
        if: always()
        run: |
          echo "=== ğŸ“Š æé€Ÿæ„å»ºæŠ¥å‘Š ==="
          echo ""
          echo "ğŸ¯ æ„å»ºæ‘˜è¦"
          echo "=========================================="
          echo "âš¡ ç¼–è¯‘æ€§èƒ½:"
          echo "  - å¹¶è¡Œä½œä¸š: ${{ env.PARALLEL_JOBS || 'N/A' }}"
          echo "  - CCacheå‘½ä¸­ç‡: æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
          echo ""
          echo "ğŸ“¦ æ„å»ºç»“æœ:"
          echo "  - çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - å›ºä»¶å¤§å°: ${{ env.FIRMWARE_SIZE_MB || 'unknown' }}MB"
          echo "  - äº§ç‰©æ•°é‡: ${{ env.ARTIFACT_COUNT || 0 }}"
          echo ""
          echo "â±ï¸ æ„å»ºæ—¶é—´:"
          echo "  - å¼€å§‹: è§æ„å»ºæ—¥å¿—"
          echo "  - ç»“æŸ: $(date)"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ] && [ "${{ env.FIRMWARE_COUNT }}" -gt 0 ]; then
            echo "ğŸ‰ æé€Ÿæ„å»ºæˆåŠŸï¼"
            echo "ğŸ’¡ å›ºä»¶å·²ç”Ÿæˆå¹¶ä¸Šä¼ åˆ°äº§ç‰©"
          else
            echo "âŒ æ„å»ºå¤±è´¥æˆ–æœªç”Ÿæˆå›ºä»¶"
            echo "ğŸ”§ è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£é—®é¢˜"
          fi
          echo "=========================================="
