name: Universal Firmware Builder - Enhanced Version

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 选择源码库
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: immortalwrt
      source_branch:
        description: 源码分支
        required: true
        default: auto
        type: string
      config_profile:
        description: 设备配置文件路径
        required: true
        type: string
        default: .config_rt-ac42u_immortalwrt
      build_optimization:
        description: 编译优化策略
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: balanced
      toolchain_strategy:
        description: 工具链策略
        required: true
        type: choice
        options:
          - prebuilt
          - local
          - auto
        default: auto
      enable_custom_features:
        description: 启用自定义功能
        required: false
        default: true
        type: boolean
      fix_common_issues:
        description: 自动修复常见问题
        required: false
        default: true
        type: boolean
      enable_pre_download:
        description: 启用预下载验证
        required: false
        default: true
        type: boolean
      enable_post_verify:
        description: 启用编译后验证
        required: false
        default: true
        type: boolean
      debug_mode:
        description: 启用调试模式
        required: false
        default: false
        type: boolean

env:
  TZ: Asia/Shanghai
  SOURCE_DIR: /mnt/source
  ARTIFACTS_DIR: /mnt/artifacts
  CCACHE_DIR: /mnt/ccache
  BUILD_LOG_DIR: /mnt/build-logs
  DOWNLOAD_DIR: /mnt/downloads
  TOOLCHAIN_LOG_DIR: /mnt/toolchain-logs
  DEBUG_MODE: ${{ github.event.inputs.debug_mode }}

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
      - name: 📥 检出配置仓库
        uses: actions/checkout@v4
        with:
          path: .
          fetch-depth: 0

      - name: 🔍 解析配置文件
        id: config-parser
        run: |
          echo "=== 🔍 解析配置文件 ==="
          if [ ! -f "repositories.json" ]; then
            echo "❌ 错误: repositories.json 文件不存在"
            exit 1
          fi
          echo "✅ 找到 repositories.json 文件"
          echo "REPO_JSON_PATH=repositories.json" >> $GITHUB_ENV
          DEFAULT_REPO=$(jq -r '.defaults.repository' repositories.json)
          DEFAULT_TIMEOUT=$(jq -r '.defaults.timeout_minutes' repositories.json)
          CUSTOM_FEATURES_DIR=$(jq -r '.custom_features_support.features_directory' repositories.json)
          echo "DEFAULT_REPO=$DEFAULT_REPO" >> $GITHUB_ENV
          echo "CUSTOM_FEATURES_DIR=$CUSTOM_FEATURES_DIR" >> $GITHUB_ENV
          echo "✅ 配置文件解析完成"

      - name: 💾 智能系统资源分析
        timeout-minutes: 2
        run: |
          echo "=== 💾 智能系统资源分析 ==="
          echo "📊 系统信息:"
          echo "🏷️ 系统版本: $(lsb_release -d | cut -f2)"
          echo "🐧 内核版本: $(uname -r)"
          echo "💻 CPU 架构: $(uname -m)"
          echo "📊 磁盘空间分析:"
          df -h | grep -E '(/|/mnt)' | while read line; do echo "  $line"; done
          echo "💻 CPU 资源:"
          echo "  - 核心数: $(nproc)"
          echo "  - CPU型号: $(grep -m1 "model name" /proc/cpuinfo | cut -d: -f2 | xargs)"
          echo "🧠 内存信息:"
          free -h
          ROOT_AVAILABLE=$(df / | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          MEM_AVAILABLE=$(free -g | awk 'NR==2 {print int($7)}')
          echo "📈 资源状态:"
          echo "  - 根分区可用: ${ROOT_AVAILABLE}GB"
          echo "  - 可用内存: ${MEM_AVAILABLE}GB"
          if [ "$ROOT_AVAILABLE" -lt 5 ]; then
            echo "🚨 警告: 根分区空间不足5GB，可能影响系统稳定性"
          fi
          if [ "$MEM_AVAILABLE" -lt 2 ]; then
            echo "🚨 警告: 可用内存不足2GB，编译可能失败"
          fi
          echo "✅ 资源分析完成"

      - name: 💾 增强内存管理与环境设置
        timeout-minutes: 5
        run: |
          echo "=== 💾 增强内存管理与环境设置 ==="
          MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}' 2>/dev/null || echo 0)
          echo "/mnt 分区可用空间: ${MNT_AVAILABLE}GB"
          if [ "$MNT_AVAILABLE" -lt 20 ]; then
            echo "🚨 严重错误: /mnt 分区空间不足20GB，无法编译"
            exit 1
          fi
          echo "🔄 创建智能交换文件..."
          SWAP_SIZE="8G"
          if [ "$MNT_AVAILABLE" -gt 50 ]; then
            SWAP_SIZE="12G"
            echo "💡 检测到充足空间，使用 ${SWAP_SIZE} 交换文件"
          fi
          if [ -f /mnt/swapfile ]; then
            echo "🔄 清理现有交换文件..."
            sudo swapoff /mnt/swapfile 2>/dev/null || true
            sudo rm -f /mnt/swapfile 2>/dev/null || true
          fi
          echo "📦 创建 ${SWAP_SIZE} 交换文件..."
          sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=$(( ${SWAP_SIZE%G} * 1024 )) status=progress || sudo fallocate -l $SWAP_SIZE /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          echo "📊 当前内存状态:"
          free -h
          echo "🔧 创建工作目录结构..."
          sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chown -R $USER:$USER ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.DOWNLOAD_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chmod -R 755 ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }}
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          echo "✅ 环境设置完成"

      - name: 🛠️ 智能编译依赖安装
        timeout-minutes: 10
        run: |
          echo "=== 🛠️ 智能编译依赖安装 ==="
          echo "📦 更新软件包列表..."
          sudo apt-get update
          echo "🔧 安装核心编译工具..."
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib
          echo "📚 安装开发库..."
          sudo apt-get install -y gettext git libncurses5-dev libssl-dev python3 python3-pip
          sudo apt-get install -y rsync unzip zlib1g-dev file wget jq ccache
          sudo apt-get install -y libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build
          sudo apt-get install -y libelf-dev libssl-dev zlib1g-dev libxml2-dev liblzma-dev liblzo2-dev
          echo "🌐 安装网络工具..."
          sudo apt-get install -y axel curl wget net-tools
          CURRENT_GIT_VERSION=$(git --version | cut -d' ' -f3)
          echo "🔍 当前 Git 版本: $CURRENT_GIT_VERSION"
          echo "✅ 依赖安装完成"

      - name: ⚡ 高级缓存与性能优化
        timeout-minutes: 3
        run: |
          echo "=== ⚡ 高级缓存与性能优化 ==="
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          echo "🎯 编译优化策略: $OPTIMIZATION_STRATEGY"
          case "$OPTIMIZATION_STRATEGY" in
            "speed")
              CCACHE_SIZE="12G"
              PARALLEL_JOBS=$(nproc)
              echo "🚀 速度优先模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}"
              ;;
            "stability")
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=$(( $(nproc) - 2 ))
              echo "🛡️ 稳定性优先模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}"
              ;;
            *)
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=$(( $(nproc) - 1 ))
              echo "⚖️ 平衡模式: CCache=${CCACHE_SIZE}, 并行作业=${PARALLEL_JOBS}"
              ;;
          esac
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache -M $CCACHE_SIZE
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=100000
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=$CCACHE_SIZE" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          echo "📊 初始CCache统计:"
          ccache -s
          echo "🔧 系统性能调优..."
          echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
          echo "vm.vfs_cache_pressure=50" | sudo tee -a /etc/sysctl.conf
          echo "✅ 性能优化完成"

      - name: 🔧 智能源码配置解析
        id: source-config
        run: |
          echo "=== 🔧 智能源码配置解析 ==="
          PRESET="${{ github.event.inputs.source_preset }}"
          REPO_JSON_PATH="${{ env.REPO_JSON_PATH }}"
          echo "🎯 正在解析预设: $PRESET"
          if ! jq -e ".repositories.$PRESET" "$REPO_JSON_PATH" >/dev/null 2>&1; then
            echo "❌ 错误: 预设 '$PRESET' 在 repositories.json 中不存在"
            jq -r '.repositories | keys_unsorted[]' "$REPO_JSON_PATH"
            exit 1
          fi
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_PATH")
          DESCRIPTION=$(jq -r ".repositories.$PRESET.description // \"未知\"" "$REPO_JSON_PATH")
          RECOMMENDED_BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_PATH")
          STABLE_BRANCHES=$(jq -r ".repositories.$PRESET.stable_branches[]" "$REPO_JSON_PATH" 2>/dev/null | tr '\n' ' ' || echo "")
          FEATURES=$(jq -r ".repositories.$PRESET.features | to_entries | map(\"\(.key)=\(.value)\") | join(\", \")" "$REPO_JSON_PATH" 2>/dev/null || echo "未知")
          NOTES=$(jq -r ".repositories.$PRESET.notes // \"无\"" "$REPO_JSON_PATH")
          BUILD_TIPS=$(jq -r ".repositories.$PRESET.build_tips // \"无\"" "$REPO_JSON_PATH")
          FEEDS_CONFIG=$(jq -r ".repositories.$PRESET.feeds_config | to_entries | map(\"\(.key)=\(.value)\") | join(\";\")" "$REPO_JSON_PATH" 2>/dev/null || echo "")
          BRANCH_FEEDS_MAPPING=$(jq -r ".repositories.$PRESET.branch_feeds_mapping | to_entries | map(\"\(.key)=\(.value)\") | join(\";\")" "$REPO_JSON_PATH" 2>/dev/null || echo "")
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH="$RECOMMENDED_BRANCH"
            echo "🤖 自动选择推荐分支: $BRANCH"
          else
            if [ -n "$STABLE_BRANCHES" ] && ! echo "$STABLE_BRANCHES" | grep -q "$BRANCH"; then
              echo "⚠️ 警告: 指定分支 '$BRANCH' 不在已知稳定分支列表中"
              echo "📋 推荐的稳定分支: $STABLE_BRANCHES"
            fi
          fi
          echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
          echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "SOURCE_DESCRIPTION=$DESCRIPTION" >> $GITHUB_ENV
          echo "SOURCE_FEATURES=$FEATURES" >> $GITHUB_ENV
          echo "SOURCE_NOTES=$NOTES" >> $GITHUB_ENV
          echo "SOURCE_BUILD_TIPS=$BUILD_TIPS" >> $GITHUB_ENV
          echo "SOURCE_FEEDS_CONFIG=$FEEDS_CONFIG" >> $GITHUB_ENV
          echo "SOURCE_BRANCH_FEEDS_MAPPING=$BRANCH_FEEDS_MAPPING" >> $GITHUB_ENV
          echo "✅ 源码配置解析完成"
          echo "📦 仓库详细信息:"
          echo "  - URL: $SOURCE_URL"
          echo "  - 描述: $DESCRIPTION"
          echo "  - 使用分支: $BRANCH"
          echo "  - 推荐分支: $RECOMMENDED_BRANCH"
          echo "  - 稳定分支: $STABLE_BRANCHES"
          echo "  - 特性: $FEATURES"
          echo "  - 备注: $NOTES"
          echo "  - 编译提示: $BUILD_TIPS"
          echo "  - Feeds配置: $FEEDS_CONFIG"
          echo "  - 分支-Feeds映射: $BRANCH_FEEDS_MAPPING"

      - name: 📥 智能源码获取与验证
        id: clone-source
        timeout-minutes: 15
        run: |
          echo "=== 📥 智能源码获取与验证 ==="
          cd ${{ env.SOURCE_DIR }}
          REQUESTED_BRANCH="${{ env.SOURCE_BRANCH }}"
          SOURCE_URL="${{ env.SOURCE_URL }}"
          PRESET="${{ env.SOURCE_PRESET }}"
          echo "🎯 目标仓库: $SOURCE_URL"
          echo "🎯 请求分支: $REQUESTED_BRANCH"
          echo "🎯 预设类型: $PRESET"
          echo "🧹 清理工作目录..."
          rm -rf .[!.]* * 2>/dev/null || true
          CLONE_SUCCESS=false
          BRANCH_STRATEGIES=("$REQUESTED_BRANCH")
          case "$PRESET" in
            "immortalwrt")
              BRANCH_STRATEGIES+=("openwrt-21.02" "openwrt-23.05" "master" "main")
              ;;
            "openwrt")
              BRANCH_STRATEGIES+=("main" "master" "v23.05.x" "v22.03.x")
              ;;
            "lede")
              BRANCH_STRATEGIES+=("master" "main")
              ;;
          esac
          BRANCH_STRATEGIES=($(printf "%s\n" "${BRANCH_STRATEGIES[@]}" | sort -u))
          echo "🔄 将尝试的分支策略: ${BRANCH_STRATEGIES[*]}"
          for branch in "${BRANCH_STRATEGIES[@]}"; do
            echo "🔄 尝试分支: $branch"
            rm -rf .[!.]* * 2>/dev/null || true
            if git clone --depth 1 --branch "$branch" "$SOURCE_URL" . 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/clone-$branch.log; then
              if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
                ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
                COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
                COMMIT_DATE=$(git log -1 --format=%ci 2>/dev/null || echo "unknown")
                COMMIT_MESSAGE=$(git log -1 --format=%s 2>/dev/null || echo "unknown")
                echo "✅ 克隆成功!"
                echo "📊 克隆详情:"
                echo "  - 实际分支: $ACTUAL_BRANCH"
                echo "  - 提交哈希: $COMMIT_HASH"
                echo "  - 提交时间: $COMMIT_DATE"
                echo "  - 提交信息: $COMMIT_MESSAGE"
                CLONE_SUCCESS=true
                break
              else
                echo "❌ 仓库结构不完整，尝试下一个分支"
                continue
              fi
            else
              echo "❌ 分支 '$branch' 克隆失败，尝试下一个"
              continue
            fi
          done
          if [ "$CLONE_SUCCESS" = "false" ]; then
            echo "❌ 所有分支策略都失败，尝试默认分支..."
            rm -rf .[!.]* * 2>/dev/null || true
            if git clone --depth 1 "$SOURCE_URL" . 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/clone-default.log; then
              if [ -d ".git" ] && [ -f "scripts/feeds" ]; then
                ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
                COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
                COMMIT_DATE=$(git log -1 --format=%ci 2>/dev/null || echo "unknown")
                COMMIT_MESSAGE=$(git log -1 --format=%s 2>/dev/null || echo "unknown")
                echo "✅ 默认分支克隆成功"
                CLONE_SUCCESS=true
              fi
            fi
          fi
          if [ "$CLONE_SUCCESS" = "false" ]; then
            echo "❌ 所有克隆策略都失败"
            tail -20 ${{ env.BUILD_LOG_DIR }}/clone-*.log 2>/dev/null || echo "无日志文件"
            exit 1
          fi
          echo "🔍 验证源码完整性..."
          REQUIRED_FILES=("scripts/feeds" "rules.mk" "Config.in" "Makefile")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ 错误: 必需文件 '$file' 不存在"
              exit 1
            fi
          done
          echo "✅ 源码完整性验证通过"
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
          echo "✅ 源码获取完成"

      - name: 🔄 智能源码初始化与Feeds修复
        timeout-minutes: 25
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 🔄 智能源码初始化与Feeds修复 ==="
          if [ ! -f "scripts/feeds" ]; then
            echo "❌ 错误: scripts/feeds 文件不存在"
            exit 1
          fi
          echo "🔧 检测源码类型并配置Feeds..."
          SOURCE_PRESET="${{ env.SOURCE_PRESET }}"
          ACTUAL_BRANCH="${{ env.ACTUAL_BRANCH }}"
          FEEDS_CONFIG="${{ env.SOURCE_FEEDS_CONFIG }}"
          BRANCH_FEEDS_MAPPING="${{ env.SOURCE_BRANCH_FEEDS_MAPPING }}"
          echo "📦 源码类型: $SOURCE_PRESET, 实际分支: $ACTUAL_BRANCH"
          echo "🎯 生成智能Feeds配置..."
          FEEDS_BRANCH=""
          if [ -n "$BRANCH_FEEDS_MAPPING" ]; then
            IFS=';' read -ra MAPPINGS <<< "$BRANCH_FEEDS_MAPPING"
            for mapping in "${MAPPINGS[@]}"; do
              IFS='=' read -r branch_name feeds_branch <<< "$mapping"
              if [ "$branch_name" = "$ACTUAL_BRANCH" ]; then
                FEEDS_BRANCH="$feeds_branch"
                echo "🔧 检测到分支映射: $ACTUAL_BRANCH -> $FEEDS_BRANCH"
                break
              fi
            done
          fi
          if [ -n "$FEEDS_CONFIG" ]; then
            echo "📋 使用预设Feeds配置..."
            rm -f feeds.conf
            IFS=';' read -ra FEED_ITEMS <<< "$FEEDS_CONFIG"
            for item in "${FEED_ITEMS[@]}"; do
              IFS='=' read -r feed_name feed_url <<< "$item"
              if [ -n "$FEEDS_BRANCH" ] && [[ "$feed_url" == *"github.com"* ]] && [[ "$feed_url" != *";"* ]]; then
                echo "src-git $feed_name $feed_url;$FEEDS_BRANCH" >> feeds.conf
              else
                echo "src-git $feed_name $feed_url" >> feeds.conf
              fi
            done
          else
            echo "📋 使用默认Feeds配置..."
            case "$SOURCE_PRESET" in
              "immortalwrt")
                BRANCH_SUFFIX=""
                if [ -n "$FEEDS_BRANCH" ]; then
                  BRANCH_SUFFIX=";$FEEDS_BRANCH"
                elif [[ "$ACTUAL_BRANCH" == *"21.02"* ]]; then
                  BRANCH_SUFFIX=";openwrt-21.02"
                elif [[ "$ACTUAL_BRANCH" == *"23.05"* ]]; then
                  BRANCH_SUFFIX=";openwrt-23.05"
                fi
                echo "src-git packages https://github.com/immortalwrt/packages.git$BRANCH_SUFFIX" > feeds.conf
                echo "src-git luci https://github.com/immortalwrt/luci.git$BRANCH_SUFFIX" >> feeds.conf
                echo "src-git routing https://github.com/immortalwrt/routing.git$BRANCH_SUFFIX" >> feeds.conf
                echo "src-git telephony https://github.com/immortalwrt/telephony.git$BRANCH_SUFFIX" >> feeds.conf
                ;;
              "openwrt")
                echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
                echo "src-git luci https://git.openwrt.org/project/luci.git" >> feeds.conf
                echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
                echo "src-git telephony https://git.openwrt.org/feed/telephony.git" >> feeds.conf
                ;;
              "lede")
                echo "src-git packages https://github.com/coolsnowwolf/packages.git" > feeds.conf
                echo "src-git luci https://github.com/coolsnowwolf/luci.git" >> feeds.conf
                echo "src-git routing https://github.com/coolsnowwolf/routing.git" >> feeds.conf
                echo "src-git telephony https://github.com/coolsnowwolf/telephony.git" >> feeds.conf
                ;;
            esac
          fi
          echo "📋 Feeds配置内容:"
          cat feeds.conf
          echo "🔄 开始更新Feeds..."
          MAX_RETRIES=3
          RETRY_COUNT=0
          FEEDS_SUCCESS=false
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "🔄 尝试更新Feeds (第 $((RETRY_COUNT+1)) 次)..."
            if ./scripts/feeds update -a 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/feeds-update-$RETRY_COUNT.log; then
              echo "✅ Feeds更新成功!"
              FEEDS_SUCCESS=true
              break
            else
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "⚠️ Feeds更新失败，准备重试 ($RETRY_COUNT/$MAX_RETRIES)..."
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⏳ 等待5秒后重试..."
                sleep 5
                if [ $RETRY_COUNT -eq 1 ]; then
                  echo "🔄 尝试使用GitHub镜像源..."
                  sed -i 's|git.openwrt.org|github.com/openwrt|g' feeds.conf
                  sed -i 's|https://git.openwrt.org/|https://github.com/openwrt/|g' feeds.conf
                  echo "📋 更新后的Feeds配置:"
                  cat feeds.conf
                fi
              fi
            fi
          done
          if [ "$FEEDS_SUCCESS" = "false" ]; then
            echo "❌ Feeds更新失败，尝试最小化feeds配置..."
            echo "src-git packages https://github.com/openwrt/packages.git" > feeds.conf
            echo "src-git luci https://github.com/openwrt/luci.git" >> feeds.conf
            ./scripts/feeds update -a || {
              echo "❌ 最小化feeds配置也失败"
              if [ -f "${{ env.BUILD_LOG_DIR }}/feeds-update-0.log" ]; then
                grep -n -i -A3 -B3 "error\|failed\|not found" ${{ env.BUILD_LOG_DIR }}/feeds-update-0.log | head -20
              fi
              exit 1
            }
          fi
          echo "📦 安装Feeds..."
          if ! ./scripts/feeds install -a 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/feeds-install.log; then
            echo "⚠️ Feeds安装有警告，但继续执行..."
          fi
          echo "🔧 修复可能的包配置问题..."
          COMMON_PACKAGES=("zstd" "zsh" "openssl" "libubox")
          for pkg in "${COMMON_PACKAGES[@]}"; do
            if [ -f "feeds/packages/utils/$pkg/Makefile" ]; then
              echo "🛠️ 检查 $pkg 配置..."
              sed -i 's/PKG_HASH:=.*/PKG_HASH:=skip/' feeds/packages/utils/$pkg/Makefile 2>/dev/null || true
              sed -i 's/PKG_VERSION:=.*/PKG_VERSION:=latest/' feeds/packages/utils/$pkg/Makefile 2>/dev/null || true
            fi
          done
          echo "✅ 源码初始化完成"

      - name: 🎯 快速配置文件查找与应用
        timeout-minutes: 2
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 🎯 快速配置文件查找与应用 ==="
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "🔍 查找配置文件: $CONFIG_PROFILE"
          CONFIG_FOUND=""
          SEARCH_PATHS=(".", "..", "$GITHUB_WORKSPACE", "configs", "../configs")
          for path in "${SEARCH_PATHS[@]}"; do
            if [ -f "$path/$CONFIG_PROFILE" ]; then
              CONFIG_FOUND="$path/$CONFIG_PROFILE"
              echo "✅ 在路径 '$path' 找到配置文件"
              break
            fi
          done
          if [ -z "$CONFIG_FOUND" ]; then
            echo "🔍 精确查找失败，尝试模糊搜索..."
            CONFIG_FOUND=$(find . -maxdepth 3 -name "*$CONFIG_PROFILE*" -type f 2>/dev/null | head -1)
            if [ -n "$CONFIG_FOUND" ]; then
              echo "✅ 模糊搜索找到: $CONFIG_FOUND"
            fi
          fi
          if [ -n "$CONFIG_FOUND" ] && [ -f "$CONFIG_FOUND" ]; then
            echo "📋 复制配置文件: $CONFIG_FOUND -> .config"
            cp "$CONFIG_FOUND" .config
            echo "✅ 配置应用完成"
            if grep -q "CONFIG_TARGET" .config && grep -q "CONFIG_PACKAGE" .config; then
              echo "✅ 配置文件基本结构验证通过"
            else
              echo "⚠️ 警告: 配置文件可能不完整"
            fi
          else
            echo "❌ 错误: 无法找到配置文件 '$CONFIG_PROFILE'"
            echo "🔍 搜索路径: ${SEARCH_PATHS[*]}"
            ls -la
            exit 1
          fi

      - name: 🔧 EXT4文件系统空间紧急修复
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 🔧 EXT4文件系统空间紧急修复 ==="
          echo "🔧 设置分区大小: 内核=20MB, 根文件系统=96MB"
          sed -i 's/CONFIG_TARGET_KERNEL_PARTSIZE=.*/CONFIG_TARGET_KERNEL_PARTSIZE=20/' .config 2>/dev/null || true
          sed -i 's/CONFIG_TARGET_ROOTFS_PARTSIZE=.*/CONFIG_TARGET_ROOTFS_PARTSIZE=96/' .config 2>/dev/null || true
          echo "CONFIG_TARGET_KERNEL_PARTSIZE=20" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=96" >> .config
          echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
          echo "# CONFIG_DEBUG_INFO is not set" >> .config
          echo "# CONFIG_DEBUG_KERNEL is not set" >> .config
          echo "✅ 分区大小修复完成"

      - name: 🔧 设备镜像配置修复
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 🔧 设备镜像配置修复 ==="
          if grep -q "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u" .config; then
            echo "✅ 找到 ASUS RT-AC42U 设备配置"
            sed -i 's/# CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u is not set/CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y/' .config
          else
            echo "🔧 添加 ASUS RT-AC42U 设备配置"
            echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> .config
          fi
          echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> .config
          echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> .config
          echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
          if ! grep -q "CONFIG_TARGET_ipq40xx" .config; then
            echo "🔧 设置目标架构为 ipq40xx"
            echo "CONFIG_TARGET_ipq40xx=y" >> .config
            echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
          fi
          echo "🔄 运行 defconfig..."
          make defconfig >/dev/null 2>&1 || {
            echo "⚠️ defconfig 有警告，但继续执行..."
          }
          echo "✅ 设备镜像配置修复完成"

      - name: 🔧 快速Samba验证
        if: github.event.inputs.enable_custom_features == 'true'
        timeout-minutes: 2
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 🔧 快速Samba验证 ==="
          echo "🔍 检查Samba配置状态..."
          if grep -q "CONFIG_PACKAGE_samba4-server=y" .config; then
            echo "✅ Samba4已在配置中启用"
          else
            echo "🔧 启用Samba4配置..."
            echo "CONFIG_PACKAGE_samba4-server=y" >> .config
            echo "CONFIG_PACKAGE_samba4-libs=y" >> .config
            echo "CONFIG_PACKAGE_samba4-client=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
            echo "✅ Samba4配置已添加"
          fi
          echo "✅ Samba验证完成"

      - name: 📦 详细自定义功能处理
        if: github.event.inputs.enable_custom_features == 'true'
        timeout-minutes: 15
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 📦 详细自定义功能处理 ==="
          CONFIG_REPO_DIR="$GITHUB_WORKSPACE"
          CUSTOM_FEATURES_DIR="$CONFIG_REPO_DIR/${{ env.CUSTOM_FEATURES_DIR }}"
          echo "🔍 开始验证自定义功能目录结构..."
          echo "配置仓库目录: $CONFIG_REPO_DIR"
          echo "自定义功能目录: $CUSTOM_FEATURES_DIR"
          if [ -d "$CUSTOM_FEATURES_DIR" ]; then
            echo "✅ 找到自定义功能目录"
            echo "📁 目录结构:"
            find "$CUSTOM_FEATURES_DIR" -type f -name "*" 2>/dev/null | while read file; do
              size=$(du -h "$file" | cut -f1)
              echo "   - $file ($size)"
            done || echo "   ℹ️ 无文件或无法访问"
            if [ -d "$CUSTOM_FEATURES_DIR/prebuilt-ipks" ]; then
              echo "📦 处理预构建IPK包..."
              IPK_COUNT=$(find "$CUSTOM_FEATURES_DIR/prebuilt-ipks" -name "*.ipk" 2>/dev/null | wc -l)
              echo "📊 找到 $IPK_COUNT 个IPK文件"
              mkdir -p package/base-files/files/usr/lib/opkg/custom
              echo "🔄 复制IPK文件到自定义OPKG目录..."
              find "$CUSTOM_FEATURES_DIR/prebuilt-ipks" -name "*.ipk" -exec cp -v {} package/base-files/files/usr/lib/opkg/custom/ \; 2>/dev/null
              COPIED_COUNT=$(find package/base-files/files/usr/lib/opkg/custom -name "*.ipk" 2>/dev/null | wc -l)
              echo "✅ 成功复制 $COPIED_COUNT 个IPK包"
              echo '#!/bin/sh' > package/base-files/files/etc/uci-defaults/99-custom-ipks
              echo '[ -d "/usr/lib/opkg/custom" ] && {' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
              echo '    for ipk in /usr/lib/opkg/custom/*.ipk; do' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
              echo '        [ -f "$ipk" ] && opkg install "$ipk"' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
              echo '    done' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
              echo '}' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
              echo 'exit 0' >> package/base-files/files/etc/uci-defaults/99-custom-ipks
              chmod +x package/base-files/files/etc/uci-defaults/99-custom-ipks
              echo "✅ 创建IPK自动安装脚本"
            else
              echo "ℹ️ 未找到 prebuilt-ipks 目录"
            fi
            if [ -d "$CUSTOM_FEATURES_DIR/scripts" ]; then
              echo "🔧 处理自定义脚本..."
              SCRIPT_COUNT=$(find "$CUSTOM_FEATURES_DIR/scripts" -name "*.sh" 2>/dev/null | wc -l)
              echo "📊 找到 $SCRIPT_COUNT 个脚本文件"
              echo "🔄 设置脚本执行权限并执行..."
              find "$CUSTOM_FEATURES_DIR/scripts" -name "*.sh" -exec chmod -v +x {} \; 2>/dev/null
              find "$CUSTOM_FEATURES_DIR/scripts" -name "*.sh" | sort | while read script; do
                echo "🚀 执行脚本: $(basename "$script")"
                echo "--- 脚本输出开始 ---"
                if bash "$script" 2>&1; then
                  echo "--- 脚本输出结束 ---"
                  echo "✅ 脚本执行成功: $(basename "$script")"
                else
                  echo "--- 脚本输出结束 ---"
                  echo "❌ 脚本执行失败: $(basename "$script")"
                fi
                echo ""
              done
            else
              echo "ℹ️ 未找到 scripts 目录"
            fi
            if [ -d "$CUSTOM_FEATURES_DIR/patches" ]; then
              echo "🩹 处理自定义补丁..."
              PATCH_COUNT=$(find "$CUSTOM_FEATURES_DIR/patches" -name "*.patch" 2>/dev/null | wc -l)
              echo "📊 找到 $PATCH_COUNT 个补丁文件"
              find "$CUSTOM_FEATURES_DIR/patches" -name "*.patch" | sort | while read patch; do
                echo "🔧 应用补丁: $(basename "$patch")"
                if patch -p1 --forward -r - < "$patch" 2>&1; then
                  echo "✅ 补丁应用成功: $(basename "$patch")"
                else
                  echo "⚠️ 补丁应用可能有问题: $(basename "$patch")"
                fi
                echo ""
              done
            else
              echo "ℹ️ 未找到 patches 目录"
            fi
            if [ -d "$CUSTOM_FEATURES_DIR/configs" ]; then
              echo "⚙️ 处理自定义配置..."
              find "$CUSTOM_FEATURES_DIR/configs" -name "*" -type f | while read config; do
                rel_path=$(realpath --relative-to="$CUSTOM_FEATURES_DIR/configs" "$config")
                target_dir="package/base-files/files/$(dirname "$rel_path")"
                mkdir -p "$target_dir"
                cp "$config" "$target_dir/"
                echo "✅ 复制配置: $rel_path"
              done
            fi
            echo "🎉 自定义功能处理完成"
          else
            echo "ℹ️ 无自定义功能目录，跳过详细处理"
          fi
          echo "✅ 详细自定义功能处理完成"

      - name: 📥 快速预下载
        if: github.event.inputs.enable_pre_download == 'true'
        timeout-minutes: 30
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 📥 快速预下载 ==="
          echo "📥 开始快速预下载..."
          echo "🔧 使用并行下载: ${{ env.PARALLEL_JOBS }} 个任务"
          mkdir -p ${{ env.DOWNLOAD_DIR }}
          [ -d "dl" ] && rm -rf dl
          ln -sf ${{ env.DOWNLOAD_DIR }} dl
          DOWNLOAD_LOG="${{ env.BUILD_LOG_DIR }}/download.log"
          if make download -j${{ env.PARALLEL_JOBS }} V=sc 2>&1 | tee "$DOWNLOAD_LOG"; then
            echo "✅ 预下载成功完成"
          else
            echo "⚠️ 下载有警告但继续..."
            if grep -q "Error [0-9]" "$DOWNLOAD_LOG"; then
              echo "🚨 发现下载错误，尝试单线程下载..."
              if make download -j1 V=s 2>&1 | tee "$DOWNLOAD_LOG"; then
                echo "✅ 单线程下载成功"
              else
                echo "❌ 下载失败"
                exit 1
              fi
            fi
          fi
          echo "📊 下载结果统计:"
          find dl/ -type f 2>/dev/null | wc -l
          echo "📦 下载文件总大小:"
          du -sh dl/ 2>/dev/null || echo "无法统计"
          echo "✅ 预下载完成"

      - name: 🛠️ 快速工具链编译
        timeout-minutes: 60
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 🛠️ 快速工具链编译 ==="
          echo "🔧 开始工具链编译..."
          echo "⚡ 使用并行编译: ${{ env.PARALLEL_JOBS }} 个任务"
          TOOLCHAIN_LOG="${{ env.TOOLCHAIN_LOG_DIR }}/toolchain.log"
          START_TIME=$(date +%s)
          if make toolchain/compile -j${{ env.PARALLEL_JOBS }} V=sc 2>&1 | tee "$TOOLCHAIN_LOG"; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "✅ 工具链编译成功!"
            echo "⏱️ 工具链编译耗时: ${DURATION}秒 ($(($DURATION/60))分钟)"
          else
            echo "⚠️ 工具链编译有警告，但继续执行..."
            if [ -d "staging_dir/toolchain" ]; then
              echo "✅ 工具链目录存在，继续执行"
            else
              echo "❌ 工具链编译失败"
              exit 1
            fi
          fi
          echo "📊 工具链状态:"
          find staging_dir/toolchain-* -name "*-gcc" 2>/dev/null | head -1 | xargs ls -la 2>/dev/null || echo "⚠️ 无法找到工具链"
          echo "✅ 工具链编译完成"

      - name: 🏗️ 高效编译固件
        timeout-minutes: 120
        id: compile-firmware
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 🏗️ 高效编译固件 ==="
          export FORCE_UNSAFE_CONFIGURE=1
          START_TIME=$(date +%s)
          LOG_FILE="${{ env.BUILD_LOG_DIR }}/compile.log"
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          echo "🔧 开始并行编译..."
          echo "⚡ 并行任务数: $PARALLEL_JOBS"
          echo "🎯 优化策略: ${{ github.event.inputs.build_optimization }}"
          BUILD_STATUS="unknown"
          echo "🚀 第一阶段: 并行编译..."
          if make -j$PARALLEL_JOBS V=sc 2>&1 | tee "$LOG_FILE"; then
            BUILD_STATUS="success"
            echo "🎉 并行编译成功!"
          else
            echo "⚠️ 并行编译失败，尝试单线程编译..."
            echo "🚀 第二阶段: 单线程编译..."
            if make -j1 V=s 2>&1 | tee "$LOG_FILE"; then
              BUILD_STATUS="success"
              echo "🎉 单线程编译成功!"
            else
              BUILD_STATUS="failed"
              echo "❌ 编译失败"
              echo "🔍 编译失败分析:"
              grep -i -A5 -B5 "error:\|Error [0-9]\|failed\|No such file\|undefined reference\|cannot find\|not found" "$LOG_FILE" | head -50
              exit 1
            fi
          fi
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV
          echo "BUILD_STATUS=$BUILD_STATUS" >> $GITHUB_ENV
          echo "⏱️ 编译总耗时: ${DURATION}秒 ($(($DURATION/60))分钟)"
          echo "📊 CCache 统计:"
          ccache -s

      - name: 🔍 错误日志分析
        if: always()
        timeout-minutes: 10
        run: |
          echo "=== 🔍 错误日志分析 ==="
          ERROR_LOG_FILE="${{ env.ARTIFACTS_DIR }}/error-analysis.log"
          echo "🔍 开始分析编译日志中的错误..."
          KEYWORDS=("error:" "Error 1" "Error 2" "failed" "No such file" "undefined reference" "cannot find" "not found" "fatal:")
          for log_file in ${{ env.BUILD_LOG_DIR }}/*.log ${{ env.TOOLCHAIN_LOG_DIR }}/*.log; do
            if [ -f "$log_file" ]; then
              echo "📄 分析日志文件: $(basename "$log_file")" | tee -a "$ERROR_LOG_FILE"
              echo "==========================================" | tee -a "$ERROR_LOG_FILE"
              for keyword in "${KEYWORDS[@]}"; do
                if grep -n -i "$keyword" "$log_file" > /dev/null; then
                  echo "🚨 发现关键词: **$keyword**" | tee -a "$ERROR_LOG_FILE"
                  echo "------------------------------------------" | tee -a "$ERROR_LOG_FILE"
                  grep -n -i -A5 -B5 "$keyword" "$log_file" | while IFS= read -r line; do
                    if echo "$line" | grep -i "$keyword" > /dev/null; then
                      echo "**$line**" | tee -a "$ERROR_LOG_FILE"
                    else
                      echo "$line" | tee -a "$ERROR_LOG_FILE"
                    fi
                  done
                  echo "" | tee -a "$ERROR_LOG_FILE"
                fi
              done
              echo "" | tee -a "$ERROR_LOG_FILE"
            fi
          done
          if [ -f "$ERROR_LOG_FILE" ] && [ -s "$ERROR_LOG_FILE" ]; then
            ERROR_COUNT=$(grep -c "🚨 发现关键词" "$ERROR_LOG_FILE" || echo "0")
            echo "📋 错误分析完成，发现 $ERROR_COUNT 类错误"
            echo "⚠️ 发现编译过程中的错误和警告，请检查错误分析报告"
          else
            echo "✅ 未发现明显的错误信息"
          fi

      - name: 🔍 编译产物验证
        if: env.BUILD_STATUS == 'success'
        timeout-minutes: 5
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 🔍 编译产物验证 ==="
          mkdir -p ${{ env.ARTIFACTS_DIR }}/firmware
          echo "🔍 搜索固件文件..."
          if [ -d "bin/targets" ]; then
            echo "✅ 找到固件输出目录"
            cp -r bin/targets/* ${{ env.ARTIFACTS_DIR }}/firmware/ 2>/dev/null || true
            FIRMWARE_COUNT=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" 2>/dev/null | wc -l)
            echo "📊 找到 $FIRMWARE_COUNT 个固件文件"
            ASUS_IMAGES=$(find bin/targets -name "*asus_rt-ac42u*" -type f 2>/dev/null)
            if [ -n "$ASUS_IMAGES" ]; then
              echo "✅ ASUS RT-AC42U 镜像已生成:"
              for img in $ASUS_IMAGES; do
                size=$(du -h "$img" | cut -f1)
                echo "  - $(basename "$img") ($size)"
              done
            else
              echo "⚠️ 未找到ASUS RT-AC42U特定镜像"
              echo "🔍 可用的镜像文件:"
              find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | head -10 | while read img; do
                size=$(du -h "$img" | cut -f1)
                echo "  - $(basename "$img") ($size)"
              done
            fi
            find bin/targets -type f > ${{ env.ARTIFACTS_DIR }}/firmware/filelist.txt 2>/dev/null || true
          else
            echo "❌ 未找到固件输出目录"
            ls -la
            exit 1
          fi
          echo "FIRMWARE_COUNT=$FIRMWARE_COUNT" >> $GITHUB_ENV
          echo "✅ 产物验证完成"

      - name: 📋 快速日志收集
        if: always()
        timeout-minutes: 5
        run: |
          echo "=== 📋 快速日志收集 ==="
          echo "开始快速日志收集..."
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs
          if [ -d "${{ env.BUILD_LOG_DIR }}" ]; then
            cp ${{ env.BUILD_LOG_DIR }}/*.log ${{ env.ARTIFACTS_DIR }}/logs/ 2>/dev/null || true
            echo "✅ 构建日志收集完成"
          fi
          if [ -d "${{ env.TOOLCHAIN_LOG_DIR }}" ]; then
            cp ${{ env.TOOLCHAIN_LOG_DIR }}/*.log ${{ env.ARTIFACTS_DIR }}/logs/ 2>/dev/null || true
            echo "✅ 工具链日志收集完成"
          fi
          if [ -d "${{ env.SOURCE_DIR }}" ]; then
            cd ${{ env.SOURCE_DIR }}
            cp .config ${{ env.ARTIFACTS_DIR }}/logs/final-config.txt 2>/dev/null || true
            echo "✅ 最终配置收集完成"
          fi
          ccache -s > ${{ env.ARTIFACTS_DIR }}/logs/ccache-stats.txt 2>/dev/null || true
          echo "📊 收集的日志文件:"
          find ${{ env.ARTIFACTS_DIR }}/logs -type f -name "*.log" -o -name "*.txt" | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "  - $(basename "$file") ($size)"
          done
          echo "✅ 日志收集完成"

      - name: 💾 上传构建产物
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Firmware-${{ github.run_number }}-${{ env.SOURCE_PRESET }}-${{ env.ACTUAL_BRANCH }}-${{ env.BUILD_STATUS || 'unknown' }}
          path: ${{ env.ARTIFACTS_DIR }}
          retention-days: 30
          compression-level: 9

      - name: 🧹 智能清理
        if: always()
        timeout-minutes: 3
        run: |
          echo "=== 🧹 智能清理 ==="
          echo "开始智能清理..."
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          echo "📊 最终CCache统计:"
          ccache -s
          if [ -d "${{ env.SOURCE_DIR }}" ]; then
            cd ${{ env.SOURCE_DIR }}
            echo "🧹 清理源码目录临时文件..."
            rm -rf tmp/ 2>/dev/null || true
            rm -f .config.old 2>/dev/null || true
          fi
          echo "✅ 清理完成"

      - name: 📊 最终报告
        if: always()
        timeout-minutes: 3
        run: |
          echo "=== 📊 最终报告 ==="
          echo ""
          echo "🎯 构建摘要"
          echo "=========================================="
          echo "📦 源码信息:"
          echo "  - 预设: ${{ env.SOURCE_PRESET }}"
          echo "  - 分支: ${{ env.ACTUAL_BRANCH }}"
          echo "  - 提交: ${{ env.COMMIT_HASH || 'unknown' }}"
          echo "  - 描述: ${{ env.SOURCE_DESCRIPTION }}"
          echo ""
          echo "📈 构建结果:"
          echo "  - 状态: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - 时长: ${{ env.BUILD_DURATION || 'N/A' }}秒 ($((${{ env.BUILD_DURATION || 0 }}/60))分钟)"
          echo "  - 固件数量: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - 优化策略: ${{ github.event.inputs.build_optimization }}"
          echo ""
          echo "🔧 功能状态:"
          echo "  - 自定义功能: ${{ github.event.inputs.enable_custom_features }}"
          echo "  - 预下载: ${{ github.event.inputs.enable_pre_download }}"
          echo "  - 问题修复: ${{ github.event.inputs.fix_common_issues }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            echo "🎉 构建成功！"
            echo "📦 固件已上传到 Artifacts，名称为:"
            echo "   Firmware-${{ github.run_number }}-${{ env.SOURCE_PRESET }}-${{ env.ACTUAL_BRANCH }}-success"
            echo ""
            echo "💡 使用提示:"
            echo "   - 下载 Artifacts 获取编译产物"
            echo "   - 选择适合您设备的固件文件刷入"
            echo "   - 首次使用建议选择 factory 固件"
          else
            echo "❌ 构建失败"
            echo ""
            echo "🔍 故障排除建议:"
            echo "   - 检查错误日志分析报告"
            echo "   - 验证配置文件是否正确"
            echo "   - 确认依赖包是否完整"
            echo "   - 查看详细构建日志"
            echo ""
            echo "📋 下次构建建议:"
            echo "   - 启用调试模式获取更多信息"
            echo "   - 尝试使用稳定性优化策略"
            echo "   - 检查网络连接和仓库状态"
          fi
          echo ""
          echo "⏰ 完成时间: $(date)"
          echo "=========================================="
