name: Build Firmware

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (例如: ac42u)'
        required: true
        default: 'ac42u'
        type: string

env:
  BUILD_DIR: /mnt/openwrt-build
  CONFIG_DIR: firmware-config

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check disk space
      run: |
        echo "=== 磁盘空间检查 ==="
        df -h
        echo "构建目录: ${{ env.BUILD_DIR }}"
        if [ -d "${{ env.BUILD_DIR }}" ]; then
          echo "构建目录已存在，检查其大小:"
          du -sh ${{ env.BUILD_DIR }} || true
        fi

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        echo "开始安装编译环境..."
        apt-get update
        apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib linux-libc-dev:i386 curl

    - name: Create build directory
      run: |
        echo "创建构建目录..."
        mkdir -p $BUILD_DIR
        echo "构建目录创建完成: $BUILD_DIR"
        df -h $BUILD_DIR

    - name: Clone ImmortalWrt source
      run: |
        cd $BUILD_DIR
        echo "开始克隆 ImmortalWrt 源码..."
        git clone https://github.com/immortalwrt/immortalwrt.git .
        git checkout openwrt-21.02
        echo "源码克隆完成，当前目录大小:"
        du -sh .

    - name: Update and install feeds
      run: |
        cd $BUILD_DIR
        echo "开始更新和安装 feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "feeds 安装完成，当前目录大小:"
        du -sh .

    - name: Generate device configuration
      run: |
        cd $BUILD_DIR
        
        # 根据设备名确定芯片平台
        case "${{ github.event.inputs.device_name }}" in
          "ac42u")
            PLATFORM="ipq40xx"
            DEVICE_FULL_NAME="asus_rt-ac42u"
            ;;
          *)
            echo "未知设备: ${{ github.event.inputs.device_name }}"
            exit 1
            ;;
        esac
        
        echo "为设备 ${{ github.event.inputs.device_name }} 生成配置，平台: $PLATFORM"
        
        # 生成基础配置
        echo "CONFIG_TARGET_${PLATFORM}=y" > .config
        echo "CONFIG_TARGET_${PLATFORM}_generic=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_FULL_NAME}=y" >> .config
        
        # 基础包配置
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        
        # 禁用不需要的功能
        echo "# CONFIG_PACKAGE_luci-app-accesscontrol is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-ddns is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-bandwidthd is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-wol is not set" >> .config
        
        # 复制配置到配置目录
        mkdir -p ../$CONFIG_DIR/configs/
        cp .config ../$CONFIG_DIR/configs/${{ github.event.inputs.device_name }}_config
        echo "配置生成完成"

    - name: Download packages
      run: |
        cd $BUILD_DIR
        echo "开始下载软件包..."
        make -j8 download V=s
        echo "下载完成，当前目录大小:"
        du -sh .

    - name: Check space before build
      run: |
        echo "=== 构建前空间检查 ==="
        df -h
        cd $BUILD_DIR
        du -sh .

    - name: Build firmware
      run: |
        cd $BUILD_DIR
        echo "开始编译固件..."
        make -j$(nproc) V=s 2>&1 | tee build.log
        echo "编译完成，最终目录大小:"
        du -sh .

    - name: Collect and filter logs
      run: |
        cd $BUILD_DIR
        
        echo "开始收集和过滤日志..."
        # 创建日志汇总文件
        touch error_summary.log
        
        # 过滤各种错误和警告信息
        grep -E -i "failed|error" build.log >> error_summary.log || true
        grep -E "No such file or directory" build.log >> error_summary.log || true
        grep -E "Broken pipe" build.log >> error_summary.log || true
        grep -E -i "missing" build.log >> error_summary.log || true
        grep -E "recipe for target.*failed" build.log >> error_summary.log || true
        
        # 显示错误摘要
        echo "=== 错误摘要 ==="
        cat error_summary.log

    - name: Final space check
      run: |
        echo "=== 最终空间使用情况 ==="
        df -h
        cd $BUILD_DIR
        echo "构建目录总大小:"
        du -sh .
        echo "bin/targets/ 目录大小:"
        du -sh bin/targets/ || echo "bin/targets/ 目录不存在"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/bin/targets/
          ${{ env.BUILD_DIR }}/error_summary.log
          ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: Upload configuration
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}
        path: ${{ env.CONFIG_DIR }}/configs/${{ github.event.inputs.device_name }}_config
        retention-days: 30
