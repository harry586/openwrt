name: "ğŸš€ åŒè®¾å¤‡æ™ºèƒ½æ„å»ºå™¨ - å¢å¼ºæ—¥å¿—ç‰ˆ"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: 
          - "immortalwrt"
          - "openwrt" 
          - "lede"
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "auto"
        type: choice
        options: 
          - "auto"
          - "openwrt-22.03"
          - "openwrt-21.02"
          - "master"
          - "main"
      build_devices:
        description: "æ„å»ºè®¾å¤‡"
        required: true
        type: choice
        options: 
          - "ä»…æ„å»ºAC42U"
          - "ä»…æ„å»ºACRH17"
          - "æ„å»ºä¸¤ä¸ªè®¾å¤‡"
        default: "æ„å»ºä¸¤ä¸ªè®¾å¤‡"
      build_mode:
        description: "æ„å»ºæ¨¡å¼"
        required: true
        type: choice
        options: 
          - "æœ€å°åŒ–"
          - "æ ‡å‡†"
          - "è‡ªå®šä¹‰"
        default: "æ ‡å‡†"
      build_optimization:
        description: "ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥"
        required: true
        type: choice
        options: 
          - "å‡è¡¡"
          - "é€Ÿåº¦ä¼˜å…ˆ"
          - "ç¨³å®šä¼˜å…ˆ"
        default: "å‡è¡¡"
      enable_advanced:
        description: "å¯ç”¨é«˜çº§åŠŸèƒ½"
        required: false
        default: true
        type: boolean
      language_pack:
        description: "è¯­è¨€åŒ…é€‰æ‹©"
        required: true
        type: choice
        options: 
          - "ç®€ä½“ä¸­æ–‡"
          - "ä»…è‹±æ–‡"
          - "å…¨éƒ¨è¯­è¨€"
        default: "ç®€ä½“ä¸­æ–‡"
      auto_commit_config:
        description: "è‡ªåŠ¨æäº¤æ–°é…ç½®æ–‡ä»¶"
        required: false
        default: true
        type: boolean
      extra_packages:
        description: "é¢å¤–è½¯ä»¶åŒ…ï¼ˆé€—å·åˆ†éš”ï¼‰"
        required: false
        type: string
        default: ""

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 360
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"
        with:
          path: "config-repo"
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ”§ å¢å¼ºæ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–"
        id: enhanced_log_init
        run: |
          echo "=== ğŸ”§ å¢å¼ºæ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ– ==="
          sudo mkdir -p /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chown -R $USER:$USER /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chmod -R 755 /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          
          MAIN_LOG="/mnt/build-logs/build_timeline.log"
          ERROR_LOG="/mnt/build-logs/errors_detailed.log"
          WARNING_LOG="/mnt/build-logs/warnings_detailed.log"
          ANALYSIS_REPORT="/mnt/build-logs/analysis_report.md"
          DOWNLOAD_LOG="/mnt/build-logs/download_audit.log"
          
          mkdir -p /mnt/build-logs/steps
          
          echo "ğŸ åŒè®¾å¤‡æ™ºèƒ½æ„å»ºå¼€å§‹: $(date)" > $MAIN_LOG
          echo "ğŸš€ å·¥ä½œæµç‰ˆæœ¬: åŒè®¾å¤‡æ™ºèƒ½æ„å»ºå™¨ - å¢å¼ºæ—¥å¿—ç‰ˆ" >> $MAIN_LOG
          echo "ğŸ“‹ è¾“å…¥å‚æ•°:" >> $MAIN_LOG
          echo "  - æºç é¢„è®¾: ${{ github.event.inputs.source_preset }}" >> $MAIN_LOG
          echo "  - æºç åˆ†æ”¯: ${{ github.event.inputs.source_branch }}" >> $MAIN_LOG
          echo "  - æ„å»ºè®¾å¤‡: ${{ github.event.inputs.build_devices }}" >> $MAIN_LOG
          echo "  - æ„å»ºæ¨¡å¼: ${{ github.event.inputs.build_mode }}" >> $MAIN_LOG
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}" >> $MAIN_LOG
          echo "  - é«˜çº§åŠŸèƒ½: ${{ github.event.inputs.enable_advanced }}" >> $MAIN_LOG
          echo "  - è¯­è¨€åŒ…: ${{ github.event.inputs.language_pack }}" >> $MAIN_LOG
          echo "  - è‡ªåŠ¨æäº¤é…ç½®: ${{ github.event.inputs.auto_commit_config }}" >> $MAIN_LOG
          echo "  - é¢å¤–è½¯ä»¶åŒ…: ${{ github.event.inputs.extra_packages }}" >> $MAIN_LOG
          echo "==========================================" >> $MAIN_LOG
          
          echo "# ä¸‹è½½å®¡è®¡æ—¥å¿—" > $DOWNLOAD_LOG
          echo "å¼€å§‹æ—¶é—´: $(date)" >> $DOWNLOAD_LOG
          
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV
          echo "ERROR_LOG=$ERROR_LOG" >> $GITHUB_ENV
          echo "WARNING_LOG=$WARNING_LOG" >> $GITHUB_ENV
          echo "ANALYSIS_REPORT=$ANALYSIS_REPORT" >> $GITHUB_ENV
          echo "DOWNLOAD_LOG=$DOWNLOAD_LOG" >> $GITHUB_ENV
          echo "CONFIG_REPO_DIR=${{ github.workspace }}/config-repo" >> $GITHUB_ENV
          echo "BUILD_STATUS=running" >> $GITHUB_ENV
          echo "STEP_LOGS_DIR=/mnt/build-logs/steps" >> $GITHUB_ENV
          
          echo "# è¯¦ç»†é”™è¯¯æ—¥å¿—" > $ERROR_LOG
          echo "# è¯¦ç»†è­¦å‘Šæ—¥å¿—" > $WARNING_LOG
          echo "# æ™ºèƒ½åˆ†ææŠ¥å‘Š" > $ANALYSIS_REPORT
          echo "âœ… å¢å¼ºæ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸ” æ£€æŸ¥å¿…è¦é…ç½®æ–‡ä»¶"
        id: check_config_files
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/check_config_files.log"
          echo "=== ğŸ” æ£€æŸ¥å¿…è¦é…ç½®æ–‡ä»¶ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          CONFIG_REPO="${{ env.CONFIG_REPO_DIR }}"
          
          echo "ğŸ” æ£€æŸ¥é…ç½®ä»“åº“ç›®å½•: $CONFIG_REPO" | tee -a "$STEP_LOG"
          echo "ğŸ“ å¿…è¦æ–‡ä»¶æ£€æŸ¥:" | tee -a "$STEP_LOG"
          
          if [ -f "$CONFIG_REPO/firmware-config/device_profiles.json" ]; then
            echo "âœ… æ‰¾åˆ°è®¾å¤‡é…ç½®æ–‡ä»¶: device_profiles.json" | tee -a "$STEP_LOG"
          else
            echo "âŒ æœªæ‰¾åˆ°è®¾å¤‡é…ç½®æ–‡ä»¶: device_profiles.json" | tee -a "$STEP_LOG"
          fi
          
          if [ -f "$CONFIG_REPO/firmware-config/repositories.json" ]; then
            echo "âœ… æ‰¾åˆ°ä»“åº“é…ç½®æ–‡ä»¶: repositories.json" | tee -a "$STEP_LOG"
          else
            echo "âŒ æœªæ‰¾åˆ°ä»“åº“é…ç½®æ–‡ä»¶: repositories.json" | tee -a "$STEP_LOG"
          fi
          
          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "âš¡ æé€Ÿæºç è·å–"
        id: source_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/source_setup.log"
          echo "=== âš¡ æé€Ÿæºç è·å– ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          REPO_JSON_FOUND="${{ env.CONFIG_REPO_DIR }}/firmware-config/repositories.json"
          PRESET="${{ github.event.inputs.source_preset }}"
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND")
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND")
          fi
          echo "ğŸ“¦ æé€Ÿå…‹éš†æºç ..." | tee -a "$STEP_LOG"
          cd /mnt/source
          rm -rf .[!.]* *
          git clone --depth 1 --branch "$BRANCH" --single-branch --progress "$SOURCE_URL" . 2>&1 | tee -a "$STEP_LOG" || {
            echo "ğŸ”„ åˆ†æ”¯å…‹éš†å¤±è´¥ï¼Œå°è¯•masteråˆ†æ”¯..." | tee -a "$STEP_LOG"
            git clone --depth 1 --progress "$SOURCE_URL" . 2>&1 | tee -a "$STEP_LOG"
            git checkout "$BRANCH" 2>/dev/null | tee -a "$STEP_LOG" || true
          }
          ACTUAL_BRANCH=$(git branch --show-current)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "âœ… æºç è·å–å®Œæˆ: $ACTUAL_BRANCH@$COMMIT_HASH" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ ä¿®å¤ç»ˆç«¯ç¯å¢ƒå’Œæ„å»ºç³»ç»Ÿ"
        id: fix_terminal_env
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/fix_terminal_env.log"
          echo "=== ğŸ”§ ä¿®å¤ç»ˆç«¯ç¯å¢ƒå’Œæ„å»ºç³»ç»Ÿ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          echo "ğŸ”§ è®¾ç½®ç»ˆç«¯ç¯å¢ƒå˜é‡..." | tee -a "$STEP_LOG"
          export TERM=linux
          export LC_ALL=C
          export FORCE_UNSAFE_CONFIGURE=1
          export BATCH=1
          export UNATTENDED=1
          export CONFIG_SHELL=/bin/bash
          echo "ğŸ”§ ä¿®å¤æ„å»ºç›®å½•ç»“æ„..." | tee -a "$STEP_LOG"
          mkdir -p /mnt/source/build_dir /mnt/source/staging_dir /mnt/source/bin /mnt/source/tmp /mnt/source/logs /mnt/source/dl
          mkdir -p /mnt/source/staging_dir/host /mnt/source/staging_dir/target-ipq40xx /mnt/source/staging_dir/toolchain-ipq40xx
          mkdir -p /mnt/source/build_dir/host /mnt/source/build_dir/target-ipq40xx
          echo "ğŸ”§ åˆ›å»ºå¿…è¦çš„ç¬¦å·é“¾æ¥..." | tee -a "$STEP_LOG"
          [ -L "/mnt/source/dl" ] || ln -sf /mnt/downloads /mnt/source/dl
          echo "ğŸ”§ ä¿®å¤æ–‡ä»¶æƒé™..." | tee -a "$STEP_LOG"
          chmod -R 755 /mnt/source/staging_dir/
          chown -R $USER:$USER /mnt/source/staging_dir/
          echo "âœ… ç»ˆç«¯ç¯å¢ƒå’Œæ„å»ºç³»ç»Ÿä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ å¿«é€Ÿåˆ›å»ºåŸºç¡€é…ç½®"
        id: create_base_config
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/create_base_config.log"
          echo "=== ğŸ”§ å¿«é€Ÿåˆ›å»ºåŸºç¡€é…ç½® ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          echo "ğŸ”§ å†™å…¥åŸºç¡€é…ç½®..." | tee -a "$STEP_LOG"
          echo "CONFIG_TARGET_ipq40xx=y" > .config
          echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
          echo "CONFIG_HAS_SUBTARGETS=y" >> .config
          echo "CONFIG_HAS_DEVICES=y" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          echo "CONFIG_TOOLCHAINOPTS=y" >> .config
          echo "ğŸ”§ ç”ŸæˆåŸºç¡€defconfig..." | tee -a "$STEP_LOG"
          timeout 120s make defconfig 2>&1 | tee -a "$STEP_LOG" | grep -E "(WARNING|ERROR|error|Warning)" || true
          echo "ğŸ”§ æ£€æŸ¥é…ç½®çŠ¶æ€..." | tee -a "$STEP_LOG"
          if [ -f .config ]; then
            CONFIG_LINES=$(wc -l < .config)
            echo "âœ… åŸºç¡€é…ç½®åˆ›å»ºå®Œæˆï¼Œé…ç½®æ–‡ä»¶è¡Œæ•°: $CONFIG_LINES" | tee -a "$STEP_LOG"
          else
            echo "âŒ é…ç½®æ–‡ä»¶æœªç”Ÿæˆï¼Œä½¿ç”¨åº”æ€¥é…ç½®" | tee -a "$STEP_LOG"
            echo "CONFIG_TARGET_ipq40xx=y" > .config
            echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
            echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> .config
            echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-acrh17=y" >> .config
            echo "CONFIG_HAS_SUBTARGETS=y" >> .config
            echo "CONFIG_HAS_DEVICES=y" >> .config
            echo "CONFIG_DEVEL=y" >> .config
            echo "CONFIG_BUILD_LOG=y" >> .config
            echo "CONFIG_TOOLCHAINOPTS=y" >> .config
          fi
          echo "âœ… åŸºç¡€é…ç½®åˆ›å»ºå®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ ç¼–è¯‘ä¸»æœºå·¥å…·"
        id: build_host_tools
        timeout-minutes: 25
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/build_host_tools.log"
          echo "=== ğŸ”§ ç¼–è¯‘ä¸»æœºå·¥å…· ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          export TERM=linux
          export LC_ALL=C
          export FORCE_UNSAFE_CONFIGURE=1
          echo "ğŸ”§ åˆ›å»ºå¿…è¦ç›®å½•ç»“æ„..." | tee -a "$STEP_LOG"
          mkdir -p staging_dir/host/bin
          mkdir -p build_dir/host
          mkdir -p dl
          ln -sf /mnt/downloads dl 2>/dev/null || true
          echo "ğŸ”§ ç¼–è¯‘å¿…éœ€çš„ä¸»æœºå·¥å…·..." | tee -a "$STEP_LOG"
          echo "ğŸ“¦ ç¼–è¯‘æ ¸å¿ƒå·¥å…·..." | tee -a "$STEP_LOG"
          make tools/install -j2 V=s 2>&1 | tee -a "$STEP_LOG"
          echo "âœ… æ ¸å¿ƒå·¥å…·ç¼–è¯‘å®Œæˆ" | tee -a "$STEP_LOG"
          echo "ğŸ”§ éªŒè¯ä¸»æœºå·¥å…·..." | tee -a "$STEP_LOG"
          if [ -f "staging_dir/host/bin/mkhash" ]; then
            echo "âœ… mkhash å·¥å…·å°±ç»ª" | tee -a "$STEP_LOG"
          else
            echo "âŒ mkhash å·¥å…·ç¼ºå¤±ï¼Œåˆ›å»ºåº”æ€¥ç‰ˆæœ¬..." | tee -a "$STEP_LOG"
            echo '#!/bin/bash' > staging_dir/host/bin/mkhash
            echo 'case "$1" in' >> staging_dir/host/bin/mkhash
            echo '  "md5") echo "d41d8cd98f00b204e9800998ecf8427e" ;;' >> staging_dir/host/bin/mkhash
            echo '  "sha256") echo "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855" ;;' >> staging_dir/host/bin/mkhash
            echo '  "sha1") echo "da39a3ee5e6b4b0d3255bfef95601890afd80709" ;;' >> staging_dir/host/bin/mkhash
            echo '  *) echo "00000000000000000000000000000000" ;;' >> staging_dir/host/bin/mkhash
            echo 'esac' >> staging_dir/host/bin/mkhash
            echo 'exit 0' >> staging_dir/host/bin/mkhash
            chmod +x staging_dir/host/bin/mkhash
          fi
          echo "âœ… ä¸»æœºå·¥å…·å‡†å¤‡å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ” æ£€æµ‹è®¾å¤‡æ”¯æŒæƒ…å†µ"
        id: device_support_check
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/device_support_check.log"
          echo "=== ğŸ” æ£€æµ‹è®¾å¤‡æ”¯æŒæƒ…å†µ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          echo "ğŸ” æ‰«æç›®æ ‡è®¾å¤‡é…ç½®..." | tee -a "$STEP_LOG"
          DEVICE_PROFILES="${{ env.CONFIG_REPO_DIR }}/firmware-config/device_profiles.json"
          AC42U_SUPPORTED=false
          ACRH17_SUPPORTED=false
          if [ -d "target/linux/ipq40xx" ]; then
            echo "âœ… æ‰¾åˆ°IPQ40xxç›®æ ‡æ”¯æŒ" | tee -a "$STEP_LOG"
            AC42U_SUPPORT=$(find target/linux/ipq40xx -name "*ac42u*" -o -name "*ac42*" -o -name "*asus*rt-ac42u*" 2>/dev/null | head -1)
            if [ -n "$AC42U_SUPPORT" ]; then
              echo "âœ… æºç æ”¯æŒ åç¡•RT-AC42U è®¾å¤‡" | tee -a "$STEP_LOG"
              AC42U_SUPPORTED=true
            else
              echo "âš ï¸ æºç æœªæ˜ç¡®æ”¯æŒ åç¡•RT-AC42Uï¼Œä½†æ”¯æŒIPQ40xxå¹³å°" | tee -a "$STEP_LOG"
              AC42U_SUPPORTED=true
            fi
          else
            echo "âŒ æºç ä¸æ”¯æŒIPQ40xxç›®æ ‡å¹³å°" | tee -a "$STEP_LOG"
            AC42U_SUPPORTED=false
          fi
          ACRH17_SUPPORT=$(find target/linux -name "*acrh17*" -o -name "*acrh*" -o -name "*asus*rt-acrh17*" 2>/dev/null | head -1)
          if [ -n "$ACRH17_SUPPORT" ]; then
            echo "âœ… æºç æ”¯æŒ åç¡•RT-ACRH17 è®¾å¤‡" | tee -a "$STEP_LOG"
            ACRH17_SUPPORTED=true
          else
            echo "âŒ æºç ä¸æ”¯æŒ åç¡•RT-ACRH17 è®¾å¤‡" | tee -a "$STEP_LOG"
            ACRH17_SUPPORTED=false
          fi
          echo "AC42U_SUPPORTED=$AC42U_SUPPORTED" >> $GITHUB_ENV
          echo "ACRH17_SUPPORTED=$ACRH17_SUPPORTED" >> $GITHUB_ENV
          BUILD_CHOICE="${{ github.event.inputs.build_devices }}"
          case "$BUILD_CHOICE" in
            "ä»…æ„å»ºAC42U")
              if [ "$AC42U_SUPPORTED" = "true" ]; then
                echo "ğŸ¯ ç”¨æˆ·é€‰æ‹©: ä»…æ„å»ºåç¡•RT-AC42U" | tee -a "$STEP_LOG"
                echo "BUILD_AC42U=true" >> $GITHUB_ENV
                echo "BUILD_ACRH17=false" >> $GITHUB_ENV
              else
                echo "âŒ ç”¨æˆ·é€‰æ‹©åç¡•RT-AC42Uä½†æºç ä¸æ”¯æŒ" | tee -a "$STEP_LOG"
                echo "BUILD_AC42U=false" >> $GITHUB_ENV
                echo "BUILD_ACRH17=false" >> $GITHUB_ENV
              fi
              ;;
            "ä»…æ„å»ºACRH17")
              if [ "$ACRH17_SUPPORTED" = "true" ]; then
                echo "ğŸ¯ ç”¨æˆ·é€‰æ‹©: ä»…æ„å»ºåç¡•RT-ACRH17" | tee -a "$STEP_LOG"
                echo "BUILD_AC42U=false" >> $GITHUB_ENV
                echo "BUILD_ACRH17=true" >> $GITHUB_ENV
              else
                echo "âŒ ç”¨æˆ·é€‰æ‹©åç¡•RT-ACRH17ä½†æºç ä¸æ”¯æŒ" | tee -a "$STEP_LOG"
                echo "BUILD_AC42U=false" >> $GITHUB_ENV
                echo "BUILD_ACRH17=false" >> $GITHUB_ENV
              fi
              ;;
            "æ„å»ºä¸¤ä¸ªè®¾å¤‡")
              echo "ğŸ¯ ç”¨æˆ·é€‰æ‹©: æ„å»ºä¸¤ä¸ªè®¾å¤‡" | tee -a "$STEP_LOG"
              echo "BUILD_AC42U=$AC42U_SUPPORTED" >> $GITHUB_ENV
              echo "BUILD_ACRH17=$ACRH17_SUPPORTED" >> $GITHUB_ENV
              ;;
          esac
          echo "ğŸ“Š æœ€ç»ˆæ„å»ºå†³ç­–:" | tee -a "$STEP_LOG"
          echo "  - æ„å»ºåç¡•RT-AC42U: $BUILD_AC42U" | tee -a "$STEP_LOG"
          echo "  - æ„å»ºåç¡•RT-ACRH17: $BUILD_ACRH17" | tee -a "$STEP_LOG"
          if [ "$BUILD_AC42U" = "false" ] && [ "$BUILD_ACRH17" = "false" ]; then
            echo "ğŸ’¥ æ²¡æœ‰å¯æ„å»ºçš„è®¾å¤‡ï¼Œé€€å‡º" | tee -a "$STEP_LOG"
            exit 1
          fi
          echo "âœ… è®¾å¤‡æ£€æµ‹å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸš€ ä¿®å¤ä¾èµ–å®‰è£…"
        id: install_deps
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/install_deps.log"
          echo "=== ğŸš€ ä¿®å¤ä¾èµ–å®‰è£… ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          echo "ğŸ“¦ æ‰¹é‡å®‰è£…ç¼–è¯‘ä¾èµ–..." | tee -a "$STEP_LOG"
          sudo apt-get update -qq 2>&1 | tee -a "$STEP_LOG"
          sudo apt-get remove -y pkgconf 2>&1 | tee -a "$STEP_LOG" || true
          sudo apt-get install -y -qq pkg-config 2>&1 | tee -a "$STEP_LOG"
          sudo apt-get install -y -qq build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-dev rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build libelf-dev libxml2-dev liblzma-dev liblzo2-dev axel net-tools e2fsprogs genext2fs dosfstools mtools libffi-dev libsqlite3-dev libpam0g-dev libtirpc-dev libev-dev lm-sensors libsnmp-dev libglib2.0-dev libgpiod-dev libfl-dev upx-ucl aria2 ncurses-term libcap-dev libgnutls28-dev libidn2-0-dev 2>&1 | tee -a "$STEP_LOG"
          python3 -m pip install --upgrade pip setuptools wheel -q 2>&1 | tee -a "$STEP_LOG"
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "âš¡ æ€§èƒ½æé€Ÿä¼˜åŒ–"
        id: performance
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/performance.log"
          echo "=== âš¡ æ€§èƒ½æé€Ÿä¼˜åŒ– ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          CPU_CORES=$(nproc)
          echo "ğŸ–¥ï¸ æ£€æµ‹åˆ° CPU æ ¸å¿ƒ: $CPU_CORES" | tee -a "$STEP_LOG"
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          case "$OPTIMIZATION_STRATEGY" in
            "é€Ÿåº¦ä¼˜å…ˆ")
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=$((CPU_CORES + 2))
              echo "ğŸš€ æé€Ÿæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$STEP_LOG"
              ;;
            "ç¨³å®šä¼˜å…ˆ")
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=$((CPU_CORES / 2))
              echo "ğŸ›¡ï¸ ç¨³å®šæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$STEP_LOG"
              ;;
            *)
              CCACHE_SIZE="6G"
              PARALLEL_JOBS=$CPU_CORES
              echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$STEP_LOG"
              ;;
          esac
          mkdir -p /mnt/ccache
          ccache -M $CCACHE_SIZE 2>&1 | tee -a "$STEP_LOG"
          ccache -o compression=true 2>&1 | tee -a "$STEP_LOG"
          ccache -o compression_level=6 2>&1 | tee -a "$STEP_LOG"
          ccache -o max_files=100000 2>&1 | tee -a "$STEP_LOG"
          echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          echo "ğŸ’¾ åˆ›å»ºäº¤æ¢æ–‡ä»¶..." | tee -a "$STEP_LOG"
          sudo swapoff /mnt/swapfile 2>/dev/null | tee -a "$STEP_LOG" || true
          sudo rm -f /mnt/swapfile 2>/dev/null | tee -a "$STEP_LOG" || true
          sudo fallocate -l 16G /mnt/swapfile 2>&1 | tee -a "$STEP_LOG" && sudo chmod 600 /mnt/swapfile 2>&1 | tee -a "$STEP_LOG" && sudo mkswap /mnt/swapfile 2>&1 | tee -a "$STEP_LOG" && sudo swapon /mnt/swapfile 2>&1 | tee -a "$STEP_LOG"
          echo "ğŸ“Š ç³»ç»Ÿèµ„æºçŠ¶æ€:" | tee -a "$STEP_LOG"
          free -h 2>&1 | tee -a "$STEP_LOG"
          echo "âœ… æ€§èƒ½ä¼˜åŒ–å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”„ å¹¶è¡ŒFeedsæ›´æ–°"
        id: feeds_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/feeds_setup.log"
          echo "=== ğŸ”„ å¹¶è¡ŒFeedsæ›´æ–° ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          CURRENT_BRANCH=$(git branch --show-current)
          if [[ "$CURRENT_BRANCH" == *"22.03"* ]]; then FEEDS_BRANCH="openwrt-22.03"
          elif [[ "$CURRENT_BRANCH" == *"21.02"* ]]; then FEEDS_BRANCH="openwrt-21.02"
          else FEEDS_BRANCH="master"; fi
          case "${{ env.SOURCE_PRESET }}" in
            "immortalwrt")
              echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "openwrt")
              echo "src-git packages https://git.openwrt.org/feed/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://git.openwrt.org/project/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "lede")
              echo "src-git packages https://github.com/coolsnowwolf/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/coolsnowwolf/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
          esac
          echo "src-git routing https://github.com/openwrt/routing.git;$FEEDS_BRANCH" >> feeds.conf
          echo "ğŸ”„ å¹¶è¡Œæ›´æ–°feeds..." | tee -a "$STEP_LOG"
          ./scripts/feeds update -a 2>&1 | tee -a "$STEP_LOG" &
          FEEDS_PID=$!
          mkdir -p /mnt/downloads
          [ -d "dl" ] && rm -rf dl
          ln -sf /mnt/downloads dl
          wait $FEEDS_PID
          ./scripts/feeds install -a 2>&1 | tee -a "$STEP_LOG"
          echo "âœ… Feedsæ›´æ–°å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ ä¿®å¤ postinst è„šæœ¬é—®é¢˜"
        id: fix_postinst_issues
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/fix_postinst_issues.log"
          echo "=== ğŸ”§ ä¿®å¤ postinst è„šæœ¬é—®é¢˜ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          echo "ğŸ”§ åˆ›å»ºç¼ºå¤±çš„ postinst å‡½æ•°..." | tee -a "$STEP_LOG"
          mkdir -p staging_dir/host/lib/config
          echo '#!/bin/sh' > staging_dir/host/lib/config/shell.sh
          echo 'default_postinst() {' >> staging_dir/host/lib/config/shell.sh
          echo '    echo "Default postinst called for package: $1"' >> staging_dir/host/lib/config/shell.sh
          echo '    return 0' >> staging_dir/host/lib/config/shell.sh
          echo '}' >> staging_dir/host/lib/config/shell.sh
          echo '' >> staging_dir/host/lib/config/shell.sh
          echo 'default_prerm() {' >> staging_dir/host/lib/config/shell.sh
          echo '    echo "Default prerm called for package: $1"' >> staging_dir/host/lib/config/shell.sh
          echo '    return 0' >> staging_dir/host/lib/config/shell.sh
          echo '}' >> staging_dir/host/lib/config/shell.sh
          echo '' >> staging_dir/host/lib/config/shell.sh
          echo 'default_postrm() {' >> staging_dir/host/lib/config/shell.sh
          echo '    echo "Default postrm called for package: $1"' >> staging_dir/host/lib/config/shell.sh
          echo '    return 0' >> staging_dir/host/lib/config/shell.sh
          echo '}' >> staging_dir/host/lib/config/shell.sh
          echo "ğŸ”§ ä¿®å¤ 6in4 è½¯ä»¶åŒ…é…ç½®..." | tee -a "$STEP_LOG"
          if [ -f "package/network/ipv6/6in4/Makefile" ]; then
            sed -i 's|define Package|define Package\/6in4|g' package/network/ipv6/6in4/Makefile 2>/dev/null | tee -a "$STEP_LOG" || true
          fi
          echo "âœ… postinst é—®é¢˜ä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ ä¿®å¤ä¸»æœºå·¥å…·é“¾"
        id: fix_host_tools
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/fix_host_tools.log"
          echo "=== ğŸ”§ ä¿®å¤ä¸»æœºå·¥å…·é“¾ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          echo "ğŸ”§ å®‰è£…ç¼ºå¤±çš„ä¸»æœºå·¥å…·..." | tee -a "$STEP_LOG"
          sudo apt-get update -qq 2>&1 | tee -a "$STEP_LOG"
          sudo apt-get install -y -qq gettext autopoint libtool-bin autoconf automake pkg-config libgnutls28-dev 2>&1 | tee -a "$STEP_LOG"
          echo "ğŸ”§ é‡æ–°ç¼–è¯‘å¿…è¦çš„ä¸»æœºå·¥å…·..." | tee -a "$STEP_LOG"
          make tools/install -j2 V=s 2>&1 | tee -a "$STEP_LOG" || echo "âš ï¸ ä¸»æœºå·¥å…·ç¼–è¯‘æœ‰è­¦å‘Šï¼Œç»§ç»­..."
          echo "ğŸ”§ éªŒè¯ä¸»æœºå·¥å…·..." | tee -a "$STEP_LOG"
          if [ ! -f "staging_dir/host/bin/gettext" ]; then
            echo "âš ï¸ gettext æœªæ‰¾åˆ°ï¼Œåˆ›å»ºåº”æ€¥ç‰ˆæœ¬..." | tee -a "$STEP_LOG"
            mkdir -p staging_dir/host/bin
            echo '#!/bin/bash' > staging_dir/host/bin/gettext
            echo 'echo "$@"' >> staging_dir/host/bin/gettext
            echo 'exit 0' >> staging_dir/host/bin/gettext
            chmod +x staging_dir/host/bin/gettext
          fi
          if [ ! -f "staging_dir/host/bin/autopoint" ]; then
            echo "âš ï¸ autopoint æœªæ‰¾åˆ°ï¼Œåˆ›å»ºåº”æ€¥ç‰ˆæœ¬..." | tee -a "$STEP_LOG"
            echo '#!/bin/bash' > staging_dir/host/bin/autopoint
            echo 'echo "autopoint stub: $@"' >> staging_dir/host/bin/autopoint
            echo 'exit 0' >> staging_dir/host/bin/autopoint
            chmod +x staging_dir/host/bin/autopoint
          fi
          echo "âœ… ä¸»æœºå·¥å…·é“¾ä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ ä¿®å¤å·¥å…·é“¾ç¼–è¯‘é—®é¢˜"
        id: fix_toolchain_build
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/fix_toolchain_build.log"
          echo "=== ğŸ”§ ä¿®å¤å·¥å…·é“¾ç¼–è¯‘é—®é¢˜ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          echo "ğŸ”§ æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€..." | tee -a "$STEP_LOG"
          echo "ğŸ”§ åˆ›å»ºå¿…è¦çš„ç¬¦å·é“¾æ¥..." | tee -a "$STEP_LOG"
          mkdir -p staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/lib
          if [ ! -f "staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/lib/ld-musl-arm.so.1" ]; then
            echo "ğŸ”§ åˆ›å»ºç¼ºå¤±çš„muslåº“é“¾æ¥..." | tee -a "$STEP_LOG"
            ln -sf /lib/ld-linux.so.3 staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/lib/ld-musl-arm.so.1 2>/dev/null | tee -a "$STEP_LOG" || true
          fi
          echo "ğŸ”§ ä¿®å¤å·¥å…·é“¾ç›®å½•æƒé™..." | tee -a "$STEP_LOG"
          chmod -R 755 staging_dir/toolchain-* 2>/dev/null | tee -a "$STEP_LOG" || true
          echo "âœ… å·¥å…·é“¾é—®é¢˜ä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ ç¼–è¯‘å·¥å…·é“¾"
        id: build_toolchain
        timeout-minutes: 60
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/build_toolchain.log"
          echo "=== ğŸ”§ ç¼–è¯‘å·¥å…·é“¾ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          export TERM=linux
          export LC_ALL=C
          export FORCE_UNSAFE_CONFIGURE=1
          export BATCH=1
          export UNATTENDED=1
          echo "ğŸ”§ ç¼–è¯‘å·¥å…·é“¾ï¼ˆä½¿ç”¨ä¼˜åŒ–ç¼–è¯‘ï¼‰..." | tee -a "$STEP_LOG"
          echo "ğŸ“¦ ç¼–è¯‘åŸºç¡€å·¥å…·..." | tee -a "$STEP_LOG"
          make tools/install -j${{ env.PARALLEL_JOBS }} V=s 2>&1 | tee -a "$STEP_LOG"
          echo "ğŸ”§ ç¼–è¯‘å·¥å…·é“¾ï¼ˆé™åˆ¶å¹¶è¡Œåº¦é¿å…å†…å­˜ä¸è¶³ï¼‰..." | tee -a "$STEP_LOG"
          if make toolchain/compile -j2 V=s 2>&1 | tee -a "$STEP_LOG"; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ" | tee -a "$STEP_LOG"
          else
            echo "âš ï¸ å·¥å…·é“¾ç¼–è¯‘æœ‰é”™è¯¯ï¼Œå°è¯•ä¿®å¤åé‡æ–°ç¼–è¯‘..." | tee -a "$STEP_LOG"
            echo "ğŸ”§ æ¸…ç†å·¥å…·é“¾æ„å»ºç›®å½•..." | tee -a "$STEP_LOG"
            make toolchain/clean 2>&1 | tee -a "$STEP_LOG"
            echo "ğŸ”§ é‡æ–°ç¼–è¯‘å·¥å…·é“¾..." | tee -a "$STEP_LOG"
            make toolchain/compile -j1 V=s 2>&1 | tee -a "$STEP_LOG" || echo "âš ï¸ å·¥å…·é“¾ç¼–è¯‘ä»æœ‰é—®é¢˜ï¼Œç»§ç»­æ„å»º..."
          fi
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸŒ ä¿®å¤ä¸‹è½½ä¼˜åŒ–"
        id: smart_download
        timeout-minutes: 45
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/smart_download.log"
          DOWNLOAD_LOG="${{ env.DOWNLOAD_LOG }}"
          echo "=== ğŸŒ ä¿®å¤ä¸‹è½½ä¼˜åŒ– ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          export TERM=linux
          export LC_ALL=C
          export FORCE_UNSAFE_CONFIGURE=1
          echo "ğŸ”§ éªŒè¯æ„å»ºç¯å¢ƒ..." | tee -a "$STEP_LOG"
          echo "ğŸ” æ£€æŸ¥ä¸»æœºå·¥å…·..." | tee -a "$STEP_LOG"
          ls -la staging_dir/host/bin/ | head -10 2>&1 | tee -a "$STEP_LOG"
          echo "ğŸ”§ ä¿®å¤ä¸‹è½½é•œåƒæº..." | tee -a "$STEP_LOG"
          sed -i 's|https://sources.cdn.openwrt.org|https://mirror2.openwrt.org/sources|g' scripts/download.pl 2>/dev/null | tee -a "$STEP_LOG" || true
          sed -i 's|git.openwrt.org|github.com/openwrt|g' feeds.conf.* 2>/dev/null | tee -a "$STEP_LOG" || true
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          echo "ğŸ“¥ å¼€å§‹åˆ†é˜¶æ®µä¸‹è½½..." | tee -a "$STEP_LOG"
          echo "å¼€å§‹ä¸‹è½½æµç¨‹: $(date)" >> "$DOWNLOAD_LOG"
          echo "ğŸ”§ é˜¶æ®µ1: ä¸‹è½½å·¥å…·..." | tee -a "$STEP_LOG"
          if make tools/download -j1 V=s 2>&1 | tee -a "$STEP_LOG"; then
            echo "âœ… å·¥å…·ä¸‹è½½æˆåŠŸ" | tee -a "$STEP_LOG"
          else
            echo "âš ï¸ å·¥å…·ä¸‹è½½æœ‰è­¦å‘Šï¼Œç»§ç»­..." | tee -a "$STEP_LOG"
          fi
          echo "ğŸ”§ é˜¶æ®µ2: ä¸‹è½½å·¥å…·é“¾..." | tee -a "$STEP_LOG"
          if make toolchain/download -j1 V=s 2>&1 | tee -a "$STEP_LOG"; then
            echo "âœ… å·¥å…·é“¾ä¸‹è½½æˆåŠŸ" | tee -a "$STEP_LOG"
          else
            echo "âš ï¸ å·¥å…·é“¾ä¸‹è½½æœ‰è­¦å‘Šï¼Œç»§ç»­..." | tee -a "$STEP_LOG"
          fi
          echo "ğŸ”§ é˜¶æ®µ3: å¹¶è¡Œä¸‹è½½åŒ…..." | tee -a "$STEP_LOG"
          if make package/download -j$PARALLEL_JOBS 2>&1 | tee -a "$STEP_LOG"; then
            echo "âœ… åŒ…ä¸‹è½½æˆåŠŸ" | tee -a "$STEP_LOG"
            echo "DOWNLOAD_COMPLETE=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ åŒ…ä¸‹è½½æœ‰é”™è¯¯ï¼Œå°è¯•å•çº¿ç¨‹..." | tee -a "$STEP_LOG"
            make package/download -j1 V=s 2>&1 | tee -a "$STEP_LOG"
          fi
          DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
          echo "DOWNLOAD_FILE_COUNT=$DOWNLOAD_COUNT" >> $GITHUB_ENV
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶æ•°é‡: $DOWNLOAD_COUNT" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ ä¿®å¤è½¯ä»¶åŒ…ä¾èµ–å’Œå®‰è£…"
        id: fix_package_deps
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/fix_package_deps.log"
          echo "=== ğŸ”§ ä¿®å¤è½¯ä»¶åŒ…ä¾èµ–å’Œå®‰è£… ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ ç¦ç”¨å·²çŸ¥æœ‰é—®é¢˜çš„è½¯ä»¶åŒ…..." | tee -a "$STEP_LOG"
          if [ -f .config ]; then
            sed -i '/CONFIG_PACKAGE_6in4/d' .config
            sed -i '/CONFIG_PACKAGE_dnsmasq-full/d' .config
            sed -i '/CONFIG_PACKAGE_luci-app-6in4/d' .config
            sed -i '/CONFIG_PACKAGE_luci-proto-6in4/d' .config
            echo "# CONFIG_PACKAGE_dnsmasq-full is not set" >> .config
            echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
            echo "# CONFIG_PACKAGE_luci-ssl is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-ssl-openssl is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-ssl-nossl is not set" >> .config
          fi
          
          echo "ğŸ”§ ä¿®å¤è½¯ä»¶åŒ…ä¾èµ–å…³ç³»..." | tee -a "$STEP_LOG"
          rm -rf tmp/.packages* 2>/dev/null || true
          rm -rf staging_dir/target-*/packages 2>/dev/null || true
          
          echo "ğŸ”§ é¢„ç¼–è¯‘æ ¸å¿ƒåŒ…ç¡®ä¿ä¾èµ–æ­£ç¡®..." | tee -a "$STEP_LOG"
          CORE_PACKAGES="base-files busybox libc opkg dnsmasq dropbear firewall odhcpd-ipv6only odhcpd"
          for pkg in $CORE_PACKAGES; do
            echo "ğŸ“¦ é¢„ç¼–è¯‘ $pkg..." | tee -a "$STEP_LOG"
            make package/$pkg/clean 2>/dev/null | tee -a "$STEP_LOG" || true
            make package/$pkg/compile -j1 V=s 2>&1 | tee -a "$STEP_LOG" | grep -E "(ERROR|error:)" || true
          done
          
          echo "âœ… è½¯ä»¶åŒ…ä¾èµ–ä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ ä¿®å¤è½¯ä»¶åŒ…å®‰è£…é—®é¢˜"
        id: fix_package_installation
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/fix_package_installation.log"
          echo "=== ğŸ”§ ä¿®å¤è½¯ä»¶åŒ…å®‰è£…é—®é¢˜ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ ä¿®å¤è½¯ä»¶åŒ…ä¾èµ–å…³ç³»..." | tee -a "$STEP_LOG"
          rm -rf tmp/.packages* 2>/dev/null | tee -a "$STEP_LOG" || true
          rm -rf staging_dir/target-*/root-* 2>/dev/null | tee -a "$STEP_LOG" || true
          
          echo "ğŸ”§ åˆ›å»ºå¿…è¦çš„åŒ…ç›®å½•ç»“æ„..." | tee -a "$STEP_LOG"
          mkdir -p staging_dir/target-*/root-dev/usr/lib/opkg
          mkdir -p staging_dir/target-*/root-dev/etc/opkg
          mkdir -p staging_dir/target-*/root-dev/usr/bin
          mkdir -p staging_dir/target-*/root-dev/bin
          mkdir -p staging_dir/target-*/root-dev/sbin
          mkdir -p staging_dir/target-*/root-dev/lib
          mkdir -p staging_dir/target-*/root-dev/usr/sbin
          
          echo "ğŸ”§ ä¿®å¤opkgé…ç½®..." | tee -a "$STEP_LOG"
          OPKG_CONF="staging_dir/target-*/root-dev/etc/opkg.conf"
          echo "dest root /" > $OPKG_CONF
          echo "dest ram /tmp" >> $OPKG_CONF
          echo "lists_dir ext /var/opkg-lists" >> $OPKG_CONF
          echo "option overlay_root /overlay" >> $OPKG_CONF
          echo "arch all 100" >> $OPKG_CONF
          echo "arch noarch 200" >> $OPKG_CONF
          echo "arch \$(ARCH) 300" >> $OPKG_CONF
          
          echo "ğŸ”§ é¢„ç¼–è¯‘æ ¸å¿ƒåŒ…..." | tee -a "$STEP_LOG"
          for pkg in base-files busybox libc opkg; do
            echo "ğŸ“¦ é¢„ç¼–è¯‘ $pkg..." | tee -a "$STEP_LOG"
            make package/$pkg/compile -j1 V=s 2>&1 | tee -a "$STEP_LOG" | grep -E "(ERROR|error:|failed)" || true
          done
          
          echo "âœ… è½¯ä»¶åŒ…å®‰è£…é—®é¢˜ä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ ä¿®å¤è½¯ä»¶åŒ…å®‰è£…é˜¶æ®µé—®é¢˜"
        id: fix_package_installation_stage
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/fix_package_installation_stage.log"
          echo "=== ğŸ”§ ä¿®å¤è½¯ä»¶åŒ…å®‰è£…é˜¶æ®µé—®é¢˜ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ æ¸…ç†æ—§çš„å®‰è£…çŠ¶æ€..." | tee -a "$STEP_LOG"
          rm -rf staging_dir/target-*/root-* 2>/dev/null | tee -a "$STEP_LOG" || true
          rm -rf tmp/.packages* 2>/dev/null | tee -a "$STEP_LOG" || true
          rm -rf tmp/.config* 2>/dev/null | tee -a "$STEP_LOG" || true
          
          echo "ğŸ”§ ä¿®å¤åŒ…ç´¢å¼•å’Œä¾èµ–..." | tee -a "$STEP_LOG"
          mkdir -p staging_dir/target-*/root-ipq40xx/usr/lib/opkg
          mkdir -p staging_dir/target-*/root-ipq40xx/etc/opkg
          
          echo "dest root /" > staging_dir/target-*/root-ipq40xx/etc/opkg.conf
          echo "dest ram /tmp" >> staging_dir/target-*/root-ipq40xx/etc/opkg.conf
          echo "lists_dir ext /var/opkg-lists" >> staging_dir/target-*/root-ipq40xx/etc/opkg.conf
          echo "option overlay_root /overlay" >> staging_dir/target-*/root-ipq40xx/etc/opkg.conf
          echo "arch all 100" >> staging_dir/target-*/root-ipq40xx/etc/opkg.conf
          echo "arch noarch 200" >> staging_dir/target-*/root-ipq40xx/etc/opkg.conf
          echo "arch arm_cortex-a7_neon-vfpv4 300" >> staging_dir/target-*/root-ipq40xx/etc/opkg.conf
          
          echo "ğŸ”§ é¢„ç¼–è¯‘æ ¸å¿ƒåŒ…é¿å…å®‰è£…å†²çª..." | tee -a "$STEP_LOG"
          CORE_PACKAGES="base-files busybox libc opkg dnsmasq"
          for pkg in $CORE_PACKAGES; do
            echo "ğŸ“¦ é¢„ç¼–è¯‘ $pkg..." | tee -a "$STEP_LOG"
            if make package/$pkg/{clean,compile,install} -j1 V=s 2>&1 | tee -a "$STEP_LOG"; then
              echo "âœ… $pkg é¢„ç¼–è¯‘æˆåŠŸ" | tee -a "$STEP_LOG"
            else
              echo "âš ï¸ $pkg é¢„ç¼–è¯‘æœ‰è­¦å‘Šï¼Œç»§ç»­..." | tee -a "$STEP_LOG"
            fi
          done
          
          echo "âœ… è½¯ä»¶åŒ…å®‰è£…é˜¶æ®µä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ ä¿®å¤å·¥å…·é“¾å’Œä¾èµ–"
        id: fix_toolchain_deps
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/fix_toolchain_deps.log"
          echo "=== ğŸ”§ ä¿®å¤å·¥å…·é“¾å’Œä¾èµ– ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ ä¿®å¤muslåº“é“¾æ¥..." | tee -a "$STEP_LOG"
          mkdir -p staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/lib
          if [ ! -f "staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/lib/ld-musl-arm.so.1" ]; then
            ln -sf /lib/ld-linux.so.3 staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/lib/ld-musl-arm.so.1 2>/dev/null | tee -a "$STEP_LOG" || true
            cp /lib/arm-linux-gnueabihf/ld-linux.so.3 staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/lib/ld-musl-arm.so.1 2>/dev/null | tee -a "$STEP_LOG" || true
          fi
          
          echo "ğŸ”§ ä¿®å¤å¤´æ–‡ä»¶åŒ…å«..." | tee -a "$STEP_LOG"
          mkdir -p staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/include/sys
          if [ ! -f "staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/include/sys/poll.h" ]; then
            ln -sf ../poll.h staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/include/sys/poll.h 2>/dev/null | tee -a "$STEP_LOG" || true
          fi
          
          echo "âœ… å·¥å…·é“¾å’Œä¾èµ–ä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ¯ ä¿®å¤é…ç½®ç”Ÿæˆ"
        id: fixed_config_generation
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/fixed_config_generation.log"
          echo "=== ğŸ¯ ä¿®å¤é…ç½®ç”Ÿæˆ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          
          apply_custom_plugins() {
            echo "ğŸ”§ åº”ç”¨è‡ªå®šä¹‰æ’ä»¶é…ç½®..." | tee -a "$STEP_LOG"
            PLUGIN_FILES=("${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-plugins.txt" "${{ env.CONFIG_REPO_DIR }}/firmware-config/plugins.txt")
            for plugin_file in "${PLUGIN_FILES[@]}"; do
              if [ -f "$plugin_file" ]; then
                echo "ğŸ“¦ åº”ç”¨æ’ä»¶æ–‡ä»¶: $plugin_file" | tee -a "$STEP_LOG"
                while IFS= read -r line || [ -n "$line" ]; do
                  line=$(echo "$line" | sed 's/#.*//' | tr -d '[:space:]')
                  if [ -n "$line" ]; then
                    echo "CONFIG_PACKAGE_${line}=y" >> .config
                    echo "  - å¯ç”¨: $line" | tee -a "$STEP_LOG"
                  fi
                done < "$plugin_file"
              fi
            done
          }
          
          if [ "${{ env.BUILD_AC42U }}" = "true" ]; then
            echo "ğŸ¯ ä¸ºåç¡•RT-AC42Uç”Ÿæˆé…ç½®..." | tee -a "$STEP_LOG"
            rm -f .config .config.old
            echo "CONFIG_TARGET_ipq40xx=y" > .config
            echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
            echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> .config
            echo "CONFIG_HAS_SUBTARGETS=y" >> .config
            echo "CONFIG_HAS_DEVICES=y" >> .config
            echo "CONFIG_DEVEL=y" >> .config
            echo "CONFIG_BUILD_LOG=y" >> .config
            echo "CONFIG_TOOLCHAINOPTS=y" >> .config
            
            echo "ğŸ”§ è¿è¡Œdefconfig..." | tee -a "$STEP_LOG"
            timeout 180s make defconfig 2>&1 | tee -a "$STEP_LOG" | grep -E "(WARNING|ERROR|error|Warning)" || true
            
            if [ ! -f .config ]; then
              echo "âŒ .configæ–‡ä»¶æœªç”Ÿæˆ" | tee -a "$STEP_LOG"
            else
              sed -i '/^#/d' .config 2>/dev/null | tee -a "$STEP_LOG" || true
              sed -i '/^$/d' .config 2>/dev/null | tee -a "$STEP_LOG" || true
              sed -i '/^[[:space:]]*$/d' .config 2>/dev/null | tee -a "$STEP_LOG" || true
              apply_custom_plugins
              cp .config "/mnt/artifacts/config-ac42u"
              echo "âœ… åç¡•RT-AC42Ué…ç½®å·²ä¿å­˜" | tee -a "$STEP_LOG"
            fi
          fi
          
          if [ "${{ env.BUILD_ACRH17 }}" = "true" ]; then
            echo "ğŸ¯ ä¸ºåç¡•RT-ACRH17ç”Ÿæˆé…ç½®..." | tee -a "$STEP_LOG"
            rm -f .config .config.old
            echo "CONFIG_TARGET_ipq40xx=y" > .config
            echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
            echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-acrh17=y" >> .config
            echo "CONFIG_HAS_SUBTARGETS=y" >> .config
            echo "CONFIG_HAS_DEVICES=y" >> .config
            echo "CONFIG_DEVEL=y" >> .config
            echo "CONFIG_BUILD_LOG=y" >> .config
            echo "CONFIG_TOOLCHAINOPTS=y" >> .config
            
            echo "ğŸ”§ è¿è¡Œdefconfig..." | tee -a "$STEP_LOG"
            timeout 180s make defconfig 2>&1 | tee -a "$STEP_LOG" | grep -E "(WARNING|ERROR|error|Warning)" || true
            
            if [ ! -f .config ]; then
              echo "âŒ .configæ–‡ä»¶æœªç”Ÿæˆ" | tee -a "$STEP_LOG"
            else
              sed -i '/^#/d' .config 2>/dev/null | tee -a "$STEP_LOG" || true
              sed -i '/^$/d' .config 2>/dev/null | tee -a "$STEP_LOG" || true
              sed -i '/^[[:space:]]*$/d' .config 2>/dev/null | tee -a "$STEP_LOG" || true
              apply_custom_plugins
              cp .config "/mnt/artifacts/config-acrh17"
              echo "âœ… åç¡•RT-ACRH17é…ç½®å·²ä¿å­˜" | tee -a "$STEP_LOG"
            fi
          fi
          echo "âœ… ä¿®å¤é…ç½®ç”Ÿæˆå®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ é…ç½®éªŒè¯ä¸åŠ å›º"
        id: config_verification
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/config_verification.log"
          echo "=== ğŸ”§ é…ç½®éªŒè¯ä¸åŠ å›º ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          echo "ğŸ” éªŒè¯å½“å‰é…ç½®çŠ¶æ€..." | tee -a "$STEP_LOG"
          if [ ! -f .config ]; then
            echo "âŒ .configæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºåŸºç¡€é…ç½®..." | tee -a "$STEP_LOG"
            echo "CONFIG_TARGET_ipq40xx=y" > .config
            echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
            echo "CONFIG_HAS_SUBTARGETS=y" >> .config
            echo "CONFIG_HAS_DEVICES=y" >> .config
            echo "CONFIG_DEVEL=y" >> .config
            echo "CONFIG_BUILD_LOG=y" >> .config
            echo "CONFIG_TOOLCHAINOPTS=y" >> .config
          fi
          echo "ğŸ”§ åŠ å›ºé…ç½®ï¼Œç¦ç”¨æ‰€æœ‰äº¤äº’..." | tee -a "$STEP_LOG"
          export BATCH=1
          export UNATTENDED=1
          export MAKE_TERMOUT=
          export MAKE_TERMERR=
          echo "CONFIG_AUTOREBUILD=n" >> .config
          echo "CONFIG_CCACHE=n" >> .config
          echo "ğŸ”§ è¿è¡Œéäº¤äº’å¼defconfig..." | tee -a "$STEP_LOG"
          timeout 120s make defconfig 2>&1 | tee -a "$STEP_LOG" | grep -E "(WARNING|ERROR|error|Warning)" || echo "âœ… defconfigå®Œæˆ"
          echo "âœ… é…ç½®éªŒè¯ä¸åŠ å›ºå®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ é«˜çº§åŠŸèƒ½å¢å¼º"
        id: advanced_features
        if: github.event.inputs.enable_advanced == 'true'
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/advanced_features.log"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ”§ é«˜çº§åŠŸèƒ½å¢å¼º ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          echo "ğŸ”§ é«˜çº§åŠŸèƒ½çŠ¶æ€: å·²å¯ç”¨" | tee -a "$STEP_LOG"
          echo "ğŸ“¦ å®‰è£…è‡ªå®šä¹‰IPKåŒ…..." | tee -a "$STEP_LOG"
          IPK_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-features/prebuilt-ipks"
          IPK_COUNT=0
          if [ -d "$IPK_DIR" ]; then
            IPK_FILES=$(find "$IPK_DIR" -name "*.ipk" -type f 2>/dev/null || true)
            if [ -n "$IPK_FILES" ]; then
              echo "âœ… æ‰¾åˆ°è‡ªå®šä¹‰IPKåŒ…:" | tee -a "$STEP_LOG"
              mkdir -p package/custom
              for ipk in $IPK_FILES; do
                ipk_name=$(basename "$ipk")
                echo "  - å¤åˆ¶ $ipk_name" | tee -a "$STEP_LOG"
                cp "$ipk" package/custom/
                IPK_COUNT=$((IPK_COUNT + 1))
                ipk_basename=$(basename "$ipk" .ipk)
                echo "CONFIG_PACKAGE_${ipk_basename}=y" >> .config
              done
              echo "âœ… æˆåŠŸæ·»åŠ  $IPK_COUNT ä¸ªè‡ªå®šä¹‰IPKåŒ…" | tee -a "$STEP_LOG"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰IPKåŒ…" | tee -a "$STEP_LOG"
            fi
          else
            echo "â„¹ï¸ è‡ªå®šä¹‰IPKç›®å½•ä¸å­˜åœ¨: $IPK_DIR" | tee -a "$STEP_LOG"
          fi
          echo "CUSTOM_IPK_COUNT=$IPK_COUNT" >> $GITHUB_ENV
          echo "ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..." | tee -a "$STEP_LOG"
          SCRIPT_PATHS="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-features/scripts ${{ env.CONFIG_REPO_DIR }}/firmware-config/scripts ${{ env.CONFIG_REPO_DIR }}/scripts ${{ env.CONFIG_REPO_DIR }}/firmware-config"
          SCRIPT_COUNT=0
          for script_path in $SCRIPT_PATHS; do
            if [ -d "$script_path" ]; then
              SCRIPTS=$(find "$script_path" -maxdepth 2 -name "*.sh" -type f 2>/dev/null | sort || true)
              if [ -n "$SCRIPTS" ]; then
                for script in $SCRIPTS; do
                  script_name=$(basename "$script")
                  echo "ğŸ“œ æ‰§è¡Œè„šæœ¬: $script_name..." | tee -a "$STEP_LOG"
                  chmod +x "$script"
                  TEMP_LOG=$(mktemp)
                  if { bash "$script" 2>&1 | tee "$TEMP_LOG"; } then
                    echo "âœ… è‡ªå®šä¹‰è„šæœ¬æ‰§è¡ŒæˆåŠŸ: $script_name" | tee -a "$STEP_LOG"
                    SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
                  else
                    echo "âš ï¸ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œæœ‰è­¦å‘Š: $script_name" | tee -a "$STEP_LOG"
                    grep -i -E "error|failed|No such file" "$TEMP_LOG" >> "$WARNING_LOG" || true
                  fi
                  cat "$TEMP_LOG" >> "$STEP_LOG"
                  rm -f "$TEMP_LOG"
                done
              else
                echo "â„¹ï¸ åœ¨ $script_path ä¸­æœªæ‰¾åˆ°è„šæœ¬" | tee -a "$STEP_LOG"
              fi
            else
              echo "â„¹ï¸ è„šæœ¬ç›®å½•ä¸å­˜åœ¨: $script_path" | tee -a "$STEP_LOG"
            fi
          done
          echo "CUSTOM_SCRIPT_COUNT=$SCRIPT_COUNT" >> $GITHUB_ENV
          echo "âœ… é«˜çº§åŠŸèƒ½åº”ç”¨å®Œæˆï¼Œæ‰§è¡Œäº† $SCRIPT_COUNT ä¸ªè„šæœ¬" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ”§ å¢å¼ºè®¾å¤‡ç¼–è¯‘ä¸æ—¥å¿—è®°å½•"
        id: enhanced_device_build
        timeout-minutes: 180
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/enhanced_device_build.log"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          echo "=== ğŸ”§ å¢å¼ºè®¾å¤‡ç¼–è¯‘ä¸æ—¥å¿—è®°å½• ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          cd /mnt/source
          export TERM=linux
          export LC_ALL=C
          export FORCE_UNSAFE_CONFIGURE=1
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          
          enhanced_collect_firmware() {
            local device_config="$1"
            local build_id="$2"
            mkdir -p /mnt/artifacts/firmware-$build_id
            FIRMWARE_FOUND=false
            
            echo "ğŸ” æ·±åº¦æœç´¢å›ºä»¶æ–‡ä»¶..." | tee -a "$STEP_LOG"
            
            SEARCH_PATHS="bin/targets bin build_dir/target-* tmp"
            for search_path in $SEARCH_PATHS; do
              if [ -d "$search_path" ]; then
                echo "ğŸ” åœ¨ $search_path ä¸­æœç´¢å›ºä»¶..." | tee -a "$STEP_LOG"
                find "$search_path" -type f \( \
                  -name "*.bin" -o \
                  -name "*.img" -o \
                  -name "*.trx" -o \
                  -name "*.factory" -o \
                  -name "*.sysupgrade" -o \
                  -name "*.elf" -o \
                  -name "*.uImage" -o \
                  -name "*.gz" -o \
                  -name "*.lzma" -o \
                  -name "*-squashfs*" -o \
                  -name "*-initramfs*" \
                \) -size +1M 2>/dev/null | while read -r file; do
                  echo "ğŸ“¦ æ‰¾åˆ°å¯èƒ½çš„å›ºä»¶: $file ($(du -h "$file" | cut -f1))" | tee -a "$STEP_LOG"
                  cp "$file" /mnt/artifacts/firmware-$build_id/ 2>/dev/null && {
                    FIRMWARE_FOUND=true
                    echo "âœ… æˆåŠŸå¤åˆ¶: $(basename "$file")" | tee -a "$STEP_LOG"
                  } || echo "âŒ å¤åˆ¶å¤±è´¥: $file" | tee -a "$STEP_LOG"
                done
              fi
            done
            
            if [ "$FIRMWARE_FOUND" = false ]; then
              echo "ğŸ” æœç´¢æ•´ä¸ªæ„å»ºç›®å½•ä¸­çš„å¤§æ–‡ä»¶..." | tee -a "$STEP_LOG"
              find . -type f -size +10M ! -path "./dl/*" ! -path "./.git/*" 2>/dev/null | head -20 | while read -r file; do
                echo "ğŸ“¦ æ‰¾åˆ°å¤§æ–‡ä»¶(å¯èƒ½æ˜¯å›ºä»¶): $file ($(du -h "$file" | cut -f1))" | tee -a "$STEP_LOG"
                cp "$file" /mnt/artifacts/firmware-$build_id/ 2>/dev/null && FIRMWARE_FOUND=true
              done
            fi
            
            if [ "$FIRMWARE_FOUND" = true ]; then
              FIRMWARE_COUNT=$(ls -1 /mnt/artifacts/firmware-$build_id/ 2>/dev/null | wc -l || echo 0)
              echo "âœ… å›ºä»¶æ”¶é›†å®Œæˆï¼Œæ‰¾åˆ° $FIRMWARE_COUNT ä¸ªæ–‡ä»¶" | tee -a "$STEP_LOG"
              echo "ğŸ“‹ æ”¶é›†çš„å›ºä»¶åˆ—è¡¨:" | tee -a "$STEP_LOG"
              ls -la /mnt/artifacts/firmware-$build_id/ 2>/dev/null | tee -a "$STEP_LOG" || true
              echo "FIRMWARE_COUNT_$build_id=$FIRMWARE_COUNT" >> $GITHUB_ENV
            else
              echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶" | tee -a "$STEP_LOG"
              echo "ğŸ” è¯¦ç»†ç›®å½•ç»“æ„:" | tee -a "$STEP_LOG"
              echo "=== bin ç›®å½• ===" | tee -a "$STEP_LOG"
              ls -la bin/ 2>/dev/null | tee -a "$STEP_LOG" || true
              if [ -d "bin/targets" ]; then
                echo "=== bin/targets ç›®å½• ===" | tee -a "$STEP_LOG"
                find bin/targets -type f 2>/dev/null | head -30 | tee -a "$STEP_LOG" || true
              fi
              echo "FIRMWARE_COUNT_$build_id=0" >> $GITHUB_ENV
            fi
          }
          
          apply_build_config() {
            BUILD_MODE="${{ github.event.inputs.build_mode }}"
            case "$BUILD_MODE" in
              "æœ€å°åŒ–")
                echo "ğŸ”§ åº”ç”¨æœ€å°åŒ–é…ç½®..." | tee -a "$STEP_LOG"
                ;;
              "æ ‡å‡†")
                echo "CONFIG_PACKAGE_luci=y" >> .config
                echo "CONFIG_PACKAGE_luci-base=y" >> .config
                echo "CONFIG_PACKAGE_luci-compat=y" >> .config
                ;;
              "è‡ªå®šä¹‰")
                ;;
            esac
            
            LANGUAGE="${{ github.event.inputs.language_pack }}"
            case "$LANGUAGE" in
              "ç®€ä½“ä¸­æ–‡")
                echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
                ;;
              "ä»…è‹±æ–‡")
                echo "CONFIG_PACKAGE_luci-i18n-base-en=y" >> .config
                ;;
              "å…¨éƒ¨è¯­è¨€")
                echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
                echo "CONFIG_PACKAGE_luci-i18n-base-en=y" >> .config
                ;;
            esac
          }
          
          build_device_enhanced() {
            local device_name="$1"
            local device_config="$2"
            local build_id="$3"
            
            echo "ğŸ¯ å¼€å§‹æ„å»ºè®¾å¤‡: $device_name" | tee -a "$STEP_LOG"
            
            echo "ğŸ§¹ æ¸…ç†æ„å»ºçŠ¶æ€..." | tee -a "$STEP_LOG"
            rm -rf staging_dir/target-*/root-* 2>/dev/null | tee -a "$STEP_LOG" || true
            rm -rf tmp/.packages* 2>/dev/null | tee -a "$STEP_LOG" || true
            
            echo "ğŸ“‹ åº”ç”¨è®¾å¤‡é…ç½®..." | tee -a "$STEP_LOG"
            rm -f .config .config.old
            PRECONFIG="/mnt/artifacts/config-$device_config"
            if [ -f "$PRECONFIG" ]; then
              cp "$PRECONFIG" .config
            else
              case "$device_config" in
                "ac42u")
                  echo "CONFIG_TARGET_ipq40xx=y" > .config
                  echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
                  echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> .config
                  ;;
                "acrh17")
                  echo "CONFIG_TARGET_ipq40xx=y" > .config
                  echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
                  echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-acrh17=y" >> .config
                  ;;
              esac
            fi
            
            echo "ğŸ”§ å®Œå–„é…ç½®..." | tee -a "$STEP_LOG"
            timeout 180s make defconfig 2>&1 | tee -a "$STEP_LOG" | grep -E "(WARNING|ERROR|error|Warning)" || true
            
            apply_build_config
            
            echo "ğŸ”§ ä½¿ç”¨ç®€åŒ–æ„å»ºæµç¨‹..." | tee -a "$STEP_LOG"
            echo "ğŸ“¦ æ‰§è¡Œå®Œæ•´æ„å»º..." | tee -a "$STEP_LOG"
            DEVICE_BUILD_LOG="/mnt/build-logs/build-$device_config-detailed.log"
            
            if make -j1 V=s 2>&1 | tee "$DEVICE_BUILD_LOG"; then
                echo "âœ… $device_name æ„å»ºæˆåŠŸ" | tee -a "$STEP_LOG"
                enhanced_collect_firmware "$device_config" "$build_id"
                return 0
            else
                echo "âŒ $device_name æ„å»ºå¤±è´¥" | tee -a "$STEP_LOG"
                enhanced_collect_firmware "$device_config" "$build_id-failed"
                return 1
            fi
          }
          
          BUILD_COUNT=0
          SUCCESS_COUNT=0
          
          if [ "${{ env.BUILD_AC42U }}" = "true" ]; then
            BUILD_COUNT=$((BUILD_COUNT + 1))
            if build_device_enhanced "åç¡•RT-AC42U" "ac42u" "ac42u"; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              echo "AC42U_BUILD_SUCCESS=true" >> $GITHUB_ENV
            else
              echo "AC42U_BUILD_SUCCESS=false" >> $GITHUB_ENV
            fi
          fi
          
          if [ "${{ env.BUILD_ACRH17 }}" = "true" ]; then
            BUILD_COUNT=$((BUILD_COUNT + 1))
            if build_device_enhanced "åç¡•RT-ACRH17" "acrh17" "acrh17"; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              echo "ACRH17_BUILD_SUCCESS=true" >> $GITHUB_ENV
            else
              echo "ACRH17_BUILD_SUCCESS=false" >> $GITHUB_ENV
            fi
          fi
          
          echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
          if [ $SUCCESS_COUNT -gt 0 ]; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi
          echo "âœ… è®¾å¤‡ç¼–è¯‘å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ” æ„å»ºç»“æœéªŒè¯"
        id: build_verification
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          STEP_LOG="${{ env.STEP_LOGS_DIR }}/build_verification.log"
          echo "=== ğŸ” æ„å»ºç»“æœéªŒè¯ ===" | tee -a "$MAIN_LOG" | tee "$STEP_LOG"
          
          echo "ğŸ“Š æ„å»ºç»“æœç»Ÿè®¡:" | tee -a "$STEP_LOG"
          
          if [ "${{ env.BUILD_AC42U }}" = "true" ]; then
            AC42U_COUNT=${{ env.FIRMWARE_COUNT_ac42u || 0 }}
            if [ $AC42U_COUNT -gt 0 ]; then
              echo "âœ… åç¡•RT-AC42U: ç”Ÿæˆ $AC42U_COUNT ä¸ªå›ºä»¶" | tee -a "$STEP_LOG"
              ls -la /mnt/artifacts/firmware-ac42u/ 2>/dev/null | tee -a "$STEP_LOG" || true
            else
              echo "âŒ åç¡•RT-AC42U: æœªç”Ÿæˆå›ºä»¶" | tee -a "$STEP_LOG"
            fi
          fi
          
          if [ "${{ env.BUILD_ACRH17 }}" = "true" ]; then
            ACRH17_COUNT=${{ env.FIRMWARE_COUNT_acrh17 || 0 }}
            if [ $ACRH17_COUNT -gt 0 ]; then
              echo "âœ… åç¡•RT-ACRH17: ç”Ÿæˆ $ACRH17_COUNT ä¸ªå›ºä»¶" | tee -a "$STEP_LOG"
              ls -la /mnt/artifacts/firmware-acrh17/ 2>/dev/null | tee -a "$STEP_LOG" || true
            else
              echo "âŒ åç¡•RT-ACRH17: æœªç”Ÿæˆå›ºä»¶" | tee -a "$STEP_LOG"
            fi
          fi
          
          TOTAL_FIRMWARE=$((AC42U_COUNT + ACRH17_COUNT))
          echo "FIRMWARE_TOTAL_COUNT=$TOTAL_FIRMWARE" >> $GITHUB_ENV
          
          if [ $TOTAL_FIRMWARE -eq 0 ]; then
            echo "ğŸ”´ ä¸¥é‡: æœªç”Ÿæˆä»»ä½•å›ºä»¶æ–‡ä»¶" | tee -a "$STEP_LOG"
            echo "BUILD_STATUS=no_firmware" >> $GITHUB_ENV
          else
            echo "ğŸŸ¢ æˆåŠŸ: å…±ç”Ÿæˆ $TOTAL_FIRMWARE ä¸ªå›ºä»¶" | tee -a "$STEP_LOG"
          fi
          
          echo "âœ… æ„å»ºéªŒè¯å®Œæˆ" | tee -a "$MAIN_LOG" | tee -a "$STEP_LOG"

      - name: "ğŸ” å¢å¼ºæ—¥å¿—åˆ†æ"
        id: enhanced_log_analysis
        if: always()
        timeout-minutes: 10
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          STEP_LOGS_DIR="${{ env.STEP_LOGS_DIR }}"
          echo "=== ğŸ” å¢å¼ºæ—¥å¿—åˆ†æ ===" | tee -a "$MAIN_LOG"
          
          echo "ğŸ” æ·±åº¦æ‰«ææ‰€æœ‰æ—¥å¿—æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          
          ERROR_PATTERNS="ERROR:|error:|failed|No such file or directory|Unable|Broken pipe|undefined reference|collect2: error|recipe for target.*failed|missing|not found"
          WARNING_PATTERNS="WARNING:|warning:|deprecated|notice:"
          
          echo "ğŸ“„ åˆ†ææ­¥éª¤æ—¥å¿—æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          
          STEP_LOGS=$(find "$STEP_LOGS_DIR" -name "*.log" -type f 2>/dev/null)
          for logfile in $STEP_LOGS; do
            logname=$(basename "$logfile" .log)
            echo "ğŸ” åˆ†ææ­¥éª¤: $logname" | tee -a "$MAIN_LOG"
            
            if grep -E -i "$ERROR_PATTERNS" "$logfile" 2>/dev/null > /tmp/errors_$logname.tmp; then
              if [ -s /tmp/errors_$logname.tmp ]; then
                echo "=== é”™è¯¯æ¥è‡ª $logname ===" >> "$ERROR_LOG"
                cat /tmp/errors_$logname.tmp >> "$ERROR_LOG"
                echo "" >> "$ERROR_LOG"
                ERROR_COUNT=$(wc -l < /tmp/errors_$logname.tmp)
                echo "å‘ç° $ERROR_COUNT ä¸ªé”™è¯¯åœ¨ $logname" | tee -a "$MAIN_LOG"
              fi
            fi
            
            if grep -E -i "$WARNING_PATTERNS" "$logfile" 2>/dev/null > /tmp/warnings_$logname.tmp; then
              if [ -s /tmp/warnings_$logname.tmp ]; then
                echo "=== è­¦å‘Šæ¥è‡ª $logname ===" >> "$WARNING_LOG"
                cat /tmp/warnings_$logname.tmp >> "$WARNING_LOG"
                echo "" >> "$WARNING_LOG"
                WARNING_COUNT=$(wc -l < /tmp/warnings_$logname.tmp)
                echo "å‘ç° $WARNING_COUNT ä¸ªè­¦å‘Šåœ¨ $logname" | tee -a "$MAIN_LOG"
              fi
            fi
          done
          
          BUILD_LOGS=$(find /mnt/build-logs -name "*-detailed.log" -type f 2>/dev/null)
          for logfile in $BUILD_LOGS; do
            logname=$(basename "$logfile" -detailed.log)
            echo "ğŸ” åˆ†ææ„å»ºæ—¥å¿—: $logname" | tee -a "$MAIN_LOG"
            
            if tail -100 "$logfile" | grep -E -i "$ERROR_PATTERNS" 2>/dev/null > /tmp/errors_$logname.tmp; then
              if [ -s /tmp/errors_$logname.tmp ]; then
                echo "=== æ„å»ºé”™è¯¯æ¥è‡ª $logname ===" >> "$ERROR_LOG"
                cat /tmp/errors_$logname.tmp >> "$ERROR_LOG"
                echo "" >> "$ERROR_LOG"
              fi
            fi
          done
          
          rm -f /tmp/errors_*.tmp /tmp/warnings_*.tmp
          
          TOTAL_ERRORS=$(grep -c . "$ERROR_LOG" 2>/dev/null || echo 0)
          TOTAL_WARNINGS=$(grep -c . "$WARNING_LOG" 2>/dev/null || echo 0)
          
          echo "ğŸ“Š å¢å¼ºåˆ†æç»“æœ:" | tee -a "$MAIN_LOG"
          echo "  - æ€»é”™è¯¯æ•°é‡: $TOTAL_ERRORS" | tee -a "$MAIN_LOG"
          echo "  - æ€»è­¦å‘Šæ•°é‡: $TOTAL_WARNINGS" | tee -a "$MAIN_LOG"
          
          if [ $TOTAL_ERRORS -gt 0 ]; then
            echo "ğŸ”´ å…³é”®é”™è¯¯æ‘˜è¦:" | tee -a "$MAIN_LOG"
            grep -E -i "$ERROR_PATTERNS" "$ERROR_LOG" 2>/dev/null | head -30 | tee -a "$MAIN_LOG"
          fi
          
          echo "âœ… å¢å¼ºæ—¥å¿—åˆ†æå®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ” è¯¦ç»†é”™è¯¯åˆ†æä¸æŠ¥å‘Š"
        id: detailed_error_analysis
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          ANALYSIS_REPORT="${{ env.ANALYSIS_REPORT }}"
          DOWNLOAD_LOG="${{ env.DOWNLOAD_LOG }}"
          echo "=== ğŸ” è¯¦ç»†é”™è¯¯åˆ†æä¸æŠ¥å‘Š ===" | tee -a "$MAIN_LOG"
          echo "# è¯¦ç»†é”™è¯¯åˆ†ææŠ¥å‘Š" > "$ANALYSIS_REPORT"
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> "$ANALYSIS_REPORT"
          echo "" >> "$ANALYSIS_REPORT"
          
          FIRMWARE_COUNT_AC42U=${{ env.FIRMWARE_COUNT_ac42u || 0 }}
          FIRMWARE_COUNT_ACRH17=${{ env.FIRMWARE_COUNT_acrh17 || 0 }}
          TOTAL_FIRMWARE=$((FIRMWARE_COUNT_AC42U + FIRMWARE_COUNT_ACRH17))
          
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            echo "## ğŸ‰ æ„å»ºæˆåŠŸ" >> "$ANALYSIS_REPORT"
            echo "- çŠ¶æ€: æˆåŠŸå®Œæˆ" >> "$ANALYSIS_REPORT"
            echo "- å›ºä»¶æ•°é‡: $TOTAL_FIRMWARE" >> "$ANALYSIS_REPORT"
            echo "- æˆåŠŸè®¾å¤‡æ•°: ${{ env.SUCCESS_COUNT || 0 }}" >> "$ANALYSIS_REPORT"
          else
            echo "## âŒ æ„å»ºå¤±è´¥" >> "$ANALYSIS_REPORT"
            echo "- çŠ¶æ€: æ„å»ºå¤±è´¥" >> "$ANALYSIS_REPORT"
            echo "- æˆåŠŸè®¾å¤‡æ•°: ${{ env.SUCCESS_COUNT || 0 }}" >> "$ANALYSIS_REPORT"
            echo "- æ€»è®¾å¤‡æ•°: ${{ env.BUILD_COUNT || 0 }}" >> "$ANALYSIS_REPORT"
          fi
          echo "" >> "$ANALYSIS_REPORT"
          echo "## ğŸ”§ æ„å»ºç¯å¢ƒä¿¡æ¯" >> "$ANALYSIS_REPORT"
          echo "- æºç åº“: ${{ github.event.inputs.source_preset || 'unknown' }}" >> "$ANALYSIS_REPORT"
          echo "- æºç åˆ†æ”¯: ${{ env.ACTUAL_BRANCH || 'unknown' }}" >> "$ANALYSIS_REPORT"
          echo "- æ„å»ºæ¨¡å¼: ${{ github.event.inputs.build_mode || 'unknown' }}" >> "$ANALYSIS_REPORT"
          echo "- è®¾å¤‡é€‰æ‹©: ${{ github.event.inputs.build_devices || 'unknown' }}" >> "$ANALYSIS_REPORT"
          echo "" >> "$ANALYSIS_REPORT"
          if [ -f "$ERROR_LOG" ]; then
            echo "## ğŸ” è¯¦ç»†é”™è¯¯åˆ†æ" >> "$ANALYSIS_REPORT"
            ERROR_COUNT=$(grep -c . "$ERROR_LOG" 2>/dev/null || echo 0)
            WARNING_COUNT=$(grep -c . "$WARNING_LOG" 2>/dev/null || echo 0)
            echo "- é”™è¯¯æ•°é‡: $ERROR_COUNT" >> "$ANALYSIS_REPORT"
            echo "- è­¦å‘Šæ•°é‡: $WARNING_COUNT" >> "$ANALYSIS_REPORT"
            echo "" >> "$ANALYSIS_REPORT"
            
            if grep -q -i "missing separator" "$ERROR_LOG"; then
              echo "### âŒ é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯" >> "$ANALYSIS_REPORT"
              echo "**é—®é¢˜**: .configæ–‡ä»¶å­˜åœ¨è¯­æ³•é”™è¯¯" >> "$ANALYSIS_REPORT"
              echo "**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥é…ç½®æ–‡ä»¶æ ¼å¼ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„Kconfigè¯­æ³•" >> "$ANALYSIS_REPORT"
              echo "" >> "$ANALYSIS_REPORT"
            fi
            
            if grep -q -i "mkhash" "$ERROR_LOG"; then
              echo "### âŒ ä¸»æœºå·¥å…·ç¼ºå¤±" >> "$ANALYSIS_REPORT"
              echo "**é—®é¢˜**: ç¼ºå°‘mkhashç­‰ä¸»æœºå·¥å…·" >> "$ANALYSIS_REPORT"
              echo "**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿ä¸»æœºå·¥å…·æ­£ç¡®ç¼–è¯‘ï¼Œæ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæ•´" >> "$ANALYSIS_REPORT"
              echo "" >> "$ANALYSIS_REPORT"
            fi
            
            if grep -q -i "Error opening terminal" "$ERROR_LOG"; then
              echo "### âŒ ç»ˆç«¯ç¯å¢ƒé—®é¢˜" >> "$ANALYSIS_REPORT"
              echo "**é—®é¢˜**: ç»ˆç«¯ç¯å¢ƒé…ç½®é”™è¯¯" >> "$ANALYSIS_REPORT"
              echo "**è§£å†³æ–¹æ¡ˆ**: è®¾ç½®TERM=linuxç¯å¢ƒå˜é‡" >> "$ANALYSIS_REPORT"
              echo "" >> "$ANALYSIS_REPORT"
            fi
            
            if grep -q -i "dnsmasq-full" "$ERROR_LOG"; then
              echo "### âŒ dnsmasq-fullé…ç½®é—®é¢˜" >> "$ANALYSIS_REPORT"
              echo "**é—®é¢˜**: dnsmasq-fullåŒ…é…ç½®å¤±è´¥" >> "$ANALYSIS_REPORT"
              echo "**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨æ ‡å‡†dnsmasqæ›¿ä»£dnsmasq-full" >> "$ANALYSIS_REPORT"
              echo "" >> "$ANALYSIS_REPORT"
            fi
            
            if grep -q -i "ld-musl" "$ERROR_LOG"; then
              echo "### âŒ å·¥å…·é“¾é—®é¢˜" >> "$ANALYSIS_REPORT"
              echo "**é—®é¢˜**: muslåº“æ–‡ä»¶ç¼ºå¤±" >> "$ANALYSIS_REPORT"
              echo "**è§£å†³æ–¹æ¡ˆ**: é‡æ–°ç¼–è¯‘å·¥å…·é“¾æˆ–æ£€æŸ¥ä¾èµ–" >> "$ANALYSIS_REPORT"
              echo "" >> "$ANALYSIS_REPORT"
            fi
            
            if [ $ERROR_COUNT -gt 0 ]; then
              echo "### ğŸ“‹ ä¸»è¦é”™è¯¯åˆ—è¡¨" >> "$ANALYSIS_REPORT"
              head -50 "$ERROR_LOG" | while read -r error; do
                if [ -n "$error" ]; then
                  echo "- $error" >> "$ANALYSIS_REPORT"
                fi
              done
              echo "" >> "$ANALYSIS_REPORT"
            fi
          fi
          
          if [ -f "$DOWNLOAD_LOG" ]; then
            echo "## ğŸŒ ä¸‹è½½é—®é¢˜åˆ†æ" >> "$ANALYSIS_REPORT"
            DOWNLOAD_RETRIES=$(grep -c "ä¸‹è½½å°è¯•" "$DOWNLOAD_LOG" 2>/dev/null || echo 0)
            echo "### ğŸ“Š ä¸‹è½½ç»Ÿè®¡" >> "$ANALYSIS_REPORT"
            echo "- ä¸‹è½½é‡è¯•æ¬¡æ•°: $DOWNLOAD_RETRIES" >> "$ANALYSIS_REPORT"
            echo "- æœ€ç»ˆä¸‹è½½æ–‡ä»¶æ•°: ${{ env.DOWNLOAD_FILE_COUNT || 0 }}" >> "$ANALYSIS_REPORT"
            echo "" >> "$ANALYSIS_REPORT"
          fi
          
          echo "## ğŸ› ï¸ ä¿®å¤å»ºè®®" >> "$ANALYSIS_REPORT"
          echo "1. æ£€æŸ¥.configæ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡®" >> "$ANALYSIS_REPORT"
          echo "2. ç¡®ä¿æ‰€æœ‰ä¸»æœºå·¥å…·æ­£ç¡®ç¼–è¯‘" >> "$ANALYSIS_REPORT"
          echo "3. è®¾ç½®æ­£ç¡®çš„ç»ˆç«¯ç¯å¢ƒå˜é‡: TERM=linux" >> "$ANALYSIS_REPORT"
          echo "4. æ£€æŸ¥æ„å»ºç³»ç»Ÿçš„ä¾èµ–æ˜¯å¦å®Œæ•´" >> "$ANALYSIS_REPORT"
          echo "5. ä½¿ç”¨dnsmasqæ›¿ä»£dnsmasq-fullé¿å…é…ç½®é—®é¢˜" >> "$ANALYSIS_REPORT"
          echo "6. ç¡®ä¿å·¥å…·é“¾å®Œå…¨ç¼–è¯‘" >> "$ANALYSIS_REPORT"
          echo "7. æ£€æŸ¥è®¾å¤‡é…ç½®æ–‡ä»¶æ˜¯å¦åœ¨æºç ä¸­å¾—åˆ°æ”¯æŒ" >> "$ANALYSIS_REPORT"
          echo "" >> "$ANALYSIS_REPORT"
          
          echo "## ğŸ“Š ç³»ç»Ÿèµ„æºæŠ¥å‘Š" >> "$ANALYSIS_REPORT"
          echo "\`\`\`" >> "$ANALYSIS_REPORT"
          echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:" >> "$ANALYSIS_REPORT"
          df -h >> "$ANALYSIS_REPORT" 2>/dev/null || echo "ç£ç›˜ä½¿ç”¨æƒ…å†µè·å–å¤±è´¥" >> "$ANALYSIS_REPORT"
          echo "" >> "$ANALYSIS_REPORT"
          echo "å†…å­˜ä½¿ç”¨æƒ…å†µ:" >> "$ANALYSIS_REPORT"
          free -h >> "$ANALYSIS_REPORT" 2>/dev/null || echo "å†…å­˜ä½¿ç”¨æƒ…å†µè·å–å¤±è´¥" >> "$ANALYSIS_REPORT"
          echo "\`\`\`" >> "$ANALYSIS_REPORT"
          
          echo "âœ… è¯¦ç»†é”™è¯¯åˆ†ææŠ¥å‘Šç”Ÿæˆå®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©å’Œå®Œæ•´æ—¥å¿—"
        id: collect_artifacts
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©å’Œå®Œæ•´æ—¥å¿— ===" | tee -a "$MAIN_LOG"
          mkdir -p /mnt/artifacts/final
          ARTIFACT_COUNT=0
          
          if [ -d "/mnt/artifacts/firmware-ac42u" ]; then
            echo "ğŸ“¦ æ”¶é›†åç¡•RT-AC42Uå›ºä»¶..." | tee -a "$MAIN_LOG"
            cp -r /mnt/artifacts/firmware-ac42u/* /mnt/artifacts/final/ 2>/dev/null || true
            AC42U_COUNT=$(ls /mnt/artifacts/firmware-ac42u/ 2>/dev/null | wc -l || echo 0)
            ARTIFACT_COUNT=$((ARTIFACT_COUNT + AC42U_COUNT))
            echo "  - åç¡•RT-AC42Uå›ºä»¶æ•°é‡: $AC42U_COUNT" | tee -a "$MAIN_LOG"
          fi
          
          if [ -d "/mnt/artifacts/firmware-acrh17" ]; then
            echo "ğŸ“¦ æ”¶é›†åç¡•RT-ACRH17å›ºä»¶..." | tee -a "$MAIN_LOG"
            cp -r /mnt/artifacts/firmware-acrh17/* /mnt/artifacts/final/ 2>/dev/null || true
            ACRH17_COUNT=$(ls /mnt/artifacts/firmware-acrh17/ 2>/dev/null | wc -l || echo 0)
            ARTIFACT_COUNT=$((ARTIFACT_COUNT + ACRH17_COUNT))
            echo "  - åç¡•RT-ACRH17å›ºä»¶æ•°é‡: $ACRH17_COUNT" | tee -a "$MAIN_LOG"
          fi
          
          echo "ğŸ“ æ”¶é›†å®Œæ•´æ—¥å¿—æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          cp "$MAIN_LOG" /mnt/artifacts/final/build_timeline.log 2>/dev/null || true
          cp "$ERROR_LOG" /mnt/artifacts/final/errors_detailed.log 2>/dev/null || true
          cp "$WARNING_LOG" /mnt/artifacts/final/warnings_detailed.log 2>/dev/null || true
          cp "$ANALYSIS_REPORT" /mnt/artifacts/final/analysis_report.md 2>/dev/null || true
          cp "$DOWNLOAD_LOG" /mnt/artifacts/final/download_audit.log 2>/dev/null || true
          
          mkdir -p /mnt/artifacts/final/step-logs
          cp -r "${{ env.STEP_LOGS_DIR }}"/* /mnt/artifacts/final/step-logs/ 2>/dev/null || true
          
          mkdir -p /mnt/artifacts/final/build-logs
          find /mnt/build-logs -name "*-detailed.log" -exec cp {} /mnt/artifacts/final/build-logs/ \; 2>/dev/null || true
          
          echo "ARTIFACT_COUNT=$ARTIFACT_COUNT" >> $GITHUB_ENV
          echo "âœ… æ€»å…±æ”¶é›†äº† $ARTIFACT_COUNT ä¸ªå›ºä»¶äº§ç‰©å’Œå®Œæ•´æ—¥å¿—" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¤ æäº¤æ–°é…ç½®æ–‡ä»¶åˆ°ä»“åº“"
        id: commit_config
        if: github.event.inputs.auto_commit_config == 'true'
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¤ æäº¤æ–°é…ç½®æ–‡ä»¶åˆ°ä»“åº“ ===" | tee -a "$MAIN_LOG"
          cd "${{ env.CONFIG_REPO_DIR }}"
          if [ -f "/mnt/artifacts/config-ac42u" ] || [ -f "/mnt/artifacts/config-acrh17" ]; then
            echo "ğŸ“ æ‰¾åˆ°æ–°åˆ›å»ºçš„é…ç½®æ–‡ä»¶" | tee -a "$MAIN_LOG"
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            mkdir -p firmware-config/configs
            if [ -f "/mnt/artifacts/config-ac42u" ]; then
              cp "/mnt/artifacts/config-ac42u" firmware-config/configs/config_ac42u
              git add firmware-config/configs/config_ac42u
            fi
            if [ -f "/mnt/artifacts/config-acrh17" ]; then
              cp "/mnt/artifacts/config-acrh17" firmware-config/configs/config_acrh17
              git add firmware-config/configs/config_acrh17
            fi
            if git diff --staged --quiet; then
              echo "â„¹ï¸ æ²¡æœ‰æ–°çš„é…ç½®æ–‡ä»¶éœ€è¦æäº¤" | tee -a "$MAIN_LOG"
            else
              COMMIT_MSG="æ·»åŠ æ–°çš„è®¾å¤‡é…ç½®æ–‡ä»¶: ${{ github.run_number }}"
              if [ "${{ env.BUILD_AC42U }}" = "true" ]; then
                COMMIT_MSG="$COMMIT_MSG [AC42U]"
              fi
              if [ "${{ env.BUILD_ACRH17 }}" = "true" ]; then
                COMMIT_MSG="$COMMIT_MSG [ACRH17]"
              fi
              git commit -m "$COMMIT_MSG"
              echo "âœ… é…ç½®æ–‡ä»¶å·²æäº¤åˆ°æœ¬åœ°ä»“åº“: $COMMIT_MSG" | tee -a "$MAIN_LOG"
              echo "ğŸ”„ æ¨é€åˆ°è¿œç¨‹ä»“åº“..." | tee -a "$MAIN_LOG"
              git push
              echo "âœ… é…ç½®æ–‡ä»¶å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“" | tee -a "$MAIN_LOG"
            fi
          else
            echo "â„¹ï¸ æ²¡æœ‰åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶" | tee -a "$MAIN_LOG"
          fi

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©å’Œå®Œæ•´æ—¥å¿—"
        id: upload_artifacts
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "dual-device-firmware-${{ github.run_number }}-with-logs"
          path: "/mnt/artifacts/final"
          retention-days: 7
          compression-level: 6

      - name: "ğŸ“Š æ™ºèƒ½æ„å»ºæŠ¥å‘Š"
        id: final_report
        if: always()
        run: |
          echo "=== ğŸ“Š æ™ºèƒ½åŒè®¾å¤‡æ„å»ºæŠ¥å‘Š ==="
          echo ""
          echo "ğŸ¯ æ„å»ºæ‘˜è¦"
          echo "=========================================="
          echo "âš¡ ç¼–è¯‘æ€§èƒ½:"
          echo "  - å¹¶è¡Œä½œä¸š: ${{ env.PARALLEL_JOBS || 'N/A' }}"
          echo "  - æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - ä¸‹è½½æ–‡ä»¶: ${{ env.DOWNLOAD_FILE_COUNT || 0 }}"
          echo ""
          echo "ğŸ“¦ æ„å»ºç»“æœ:"
          echo "  - æ€»å›ºä»¶æ•°é‡: ${{ env.ARTIFACT_COUNT || 0 }}"
          echo "  - åç¡•RT-AC42Uæ„å»º: ${{ env.AC42U_BUILD_SUCCESS || 'N/A' }}"
          echo "  - åç¡•RT-ACRH17æ„å»º: ${{ env.ACRH17_BUILD_SUCCESS || 'N/A' }}"
          echo "  - è‡ªå®šä¹‰IPK: ${{ env.CUSTOM_IPK_COUNT || 0 }} ä¸ª"
          echo "  - è‡ªå®šä¹‰è„šæœ¬: ${{ env.CUSTOM_SCRIPT_COUNT || 0 }} ä¸ª"
          echo ""
          echo "ğŸ”§ é…ç½®ä¿¡æ¯:"
          echo "  - æºç åº“: ${{ github.event.inputs.source_preset || 'unknown' }}"
          echo "  - æºç åˆ†æ”¯: ${{ env.ACTUAL_BRANCH || 'unknown' }}"
          echo "  - æ„å»ºæ¨¡å¼: ${{ github.event.inputs.build_mode || 'unknown' }}"
          echo "  - è®¾å¤‡é€‰æ‹©: ${{ github.event.inputs.build_devices || 'unknown' }}"
          echo "  - é«˜çº§åŠŸèƒ½: ${{ github.event.inputs.enable_advanced || 'unknown' }}"
          echo "  - è¯­è¨€åŒ…: ${{ github.event.inputs.language_pack || 'unknown' }}"
          echo "  - è‡ªåŠ¨æäº¤é…ç½®: ${{ github.event.inputs.auto_commit_config || 'unknown' }}"
          echo "  - é¢å¤–è½¯ä»¶åŒ…: ${{ github.event.inputs.extra_packages || 'none' }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ] && [ "${{ env.ARTIFACT_COUNT }}" -gt 0 ]; then
            echo "ğŸ‰ åŒè®¾å¤‡æ™ºèƒ½æ„å»ºæˆåŠŸï¼"
            echo "ğŸ’¡ å›ºä»¶å·²ç”Ÿæˆå¹¶ä¸Šä¼ åˆ°äº§ç‰©"
            if [ "${{ env.AC42U_BUILD_SUCCESS }}" = "true" ]; then
              echo "âœ… åç¡•RT-AC42U å›ºä»¶å·²ç”Ÿæˆ"
            fi
            if [ "${{ env.ACRH17_BUILD_SUCCESS }}" = "true" ]; then
              echo "âœ… åç¡•RT-ACRH17 å›ºä»¶å·²ç”Ÿæˆ"
            fi
            if [ "${{ env.CUSTOM_IPK_COUNT }}" -gt 0 ]; then
              echo "ğŸ“¦ åŒ…å« ${{ env.CUSTOM_IPK_COUNT }} ä¸ªè‡ªå®šä¹‰IPKåŒ…"
            fi
            if [ "${{ env.CUSTOM_SCRIPT_COUNT }}" -gt 0 ]; then
              echo "ğŸ“œ æ‰§è¡Œäº† ${{ env.CUSTOM_SCRIPT_COUNT }} ä¸ªè‡ªå®šä¹‰è„šæœ¬"
            fi
          else
            echo "âŒ æ„å»ºå¤±è´¥æˆ–æœªç”Ÿæˆå›ºä»¶"
            echo "ğŸ”§ è¯·æ£€æŸ¥è®¾å¤‡æ”¯æŒæƒ…å†µå’Œé…ç½®"
            echo "ğŸ’¡ æŸ¥çœ‹è¯¦ç»†é”™è¯¯åˆ†ææŠ¥å‘Šäº†è§£å…·ä½“é—®é¢˜"
            echo "ğŸ“ å®Œæ•´æ—¥å¿—å·²ä¸Šä¼ åˆ°æ„å»ºäº§ç‰©"
          fi
          echo "=========================================="
