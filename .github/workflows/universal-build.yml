name: "ğŸš€ è¶…å¿«é€Ÿå›ºä»¶æ„å»ºå™¨ - å®Œæ•´ä¿®å¤ç‰ˆ"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "auto"
        type: choice
        options: ["auto", "openwrt-22.03", "openwrt-21.02", "master", "main"]
      config_profile:
        description: "è®¾å¤‡é…ç½®æ–‡ä»¶åç§°"
        required: true
        type: string
        default: "ac42u"
      build_optimization:
        description: "ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥"
        required: true
        type: choice
        options: ["balanced", "speed", "stability"]
        default: "balanced"
      enable_advanced:
        description: "å¯ç”¨é«˜çº§åŠŸèƒ½"
        required: false
        default: true
        type: boolean
      language_pack:
        description: "è¯­è¨€åŒ…é€‰æ‹©"
        required: true
        type: choice
        options: ["zh-cn", "en-only", "all"]
        default: "zh-cn"
      plugin_preset:
        description: "æ’ä»¶é¢„è®¾"
        required: true
        type: choice
        options: ["minimal", "standard", "full", "custom"]
        default: "standard"
      skip_tests:
        description: "è·³è¿‡æµ‹è¯•é˜¶æ®µ"
        required: false
        default: true
        type: boolean
      auto_commit_config:
        description: "è‡ªåŠ¨æäº¤æ–°é…ç½®æ–‡ä»¶"
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 180
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"
        with:
          path: "config-repo"
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ”§ æé€Ÿç¯å¢ƒåˆå§‹åŒ–"
        id: init
        run: |
          echo "=== ğŸ”§ æé€Ÿç¯å¢ƒåˆå§‹åŒ– ==="
          sudo mkdir -p /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chown -R $USER:$USER /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chmod -R 755 /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          
          MAIN_LOG="/mnt/build-logs/build_timeline.log"
          ERROR_LOG="/mnt/build-logs/errors.log"
          WARNING_LOG="/mnt/build-logs/warnings.log"
          ANALYSIS_REPORT="/mnt/build-logs/analysis_report.md"
          
          echo "ğŸ æé€Ÿæ„å»ºå¼€å§‹: $(date)" > $MAIN_LOG
          echo "ğŸš€ å·¥ä½œæµç‰ˆæœ¬: è¶…å¿«é€Ÿå›ºä»¶æ„å»ºå™¨ - å®Œæ•´ä¿®å¤ç‰ˆ" >> $MAIN_LOG
          echo "ğŸ“‹ è¾“å…¥å‚æ•°:" >> $MAIN_LOG
          echo "  - æºç é¢„è®¾: ${{ github.event.inputs.source_preset }}" >> $MAIN_LOG
          echo "  - æºç åˆ†æ”¯: ${{ github.event.inputs.source_branch }}" >> $MAIN_LOG
          echo "  - é…ç½®æ–¹æ¡ˆ: ${{ github.event.inputs.config_profile }}" >> $MAIN_LOG
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}" >> $MAIN_LOG
          echo "  - é«˜çº§åŠŸèƒ½: ${{ github.event.inputs.enable_advanced }}" >> $MAIN_LOG
          echo "  - è¯­è¨€åŒ…: ${{ github.event.inputs.language_pack }}" >> $MAIN_LOG
          echo "  - æ’ä»¶é¢„è®¾: ${{ github.event.inputs.plugin_preset }}" >> $MAIN_LOG
          echo "  - è‡ªåŠ¨æäº¤é…ç½®: ${{ github.event.inputs.auto_commit_config }}" >> $MAIN_LOG
          echo "==========================================" >> $MAIN_LOG
          
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV
          echo "ERROR_LOG=$ERROR_LOG" >> $GITHUB_ENV
          echo "WARNING_LOG=$WARNING_LOG" >> $GITHUB_ENV
          echo "ANALYSIS_REPORT=$ANALYSIS_REPORT" >> $GITHUB_ENV
          echo "CONFIG_REPO_DIR=${{ github.workspace }}/config-repo" >> $GITHUB_ENV
          echo "BUILD_STATUS=running" >> $GITHUB_ENV
          
          echo "# é”™è¯¯æ—¥å¿—" > $ERROR_LOG
          echo "# è­¦å‘Šæ—¥å¿—" > $WARNING_LOG
          echo "# æ™ºèƒ½åˆ†ææŠ¥å‘Š" > $ANALYSIS_REPORT
          echo "âœ… æé€Ÿç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸš€ æé€Ÿä¾èµ–å®‰è£…"
        id: install_deps
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸš€ æé€Ÿä¾èµ–å®‰è£… ===" | tee -a "$MAIN_LOG"
          
          echo "ğŸ“¦ æ‰¹é‡å®‰è£…ç¼–è¯‘ä¾èµ–..." | tee -a "$MAIN_LOG"
          sudo apt-get update -qq
          
          sudo apt-get install -y -qq build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-dev rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build libelf-dev libxml2-dev liblzma-dev liblzo2-dev axel net-tools e2fsprogs genext2fs dosfstools mtools libffi-dev libsqlite3-dev libpam0g-dev libtirpc-dev libev-dev lm-sensors libsnmp-dev libglib2.0-dev libgpiod-dev libfl-dev upx-ucl
          
          python3 -m pip install --upgrade pip setuptools wheel -q
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ æ€§èƒ½æé€Ÿä¼˜åŒ–"
        id: performance
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== âš¡ æ€§èƒ½æé€Ÿä¼˜åŒ– ===" | tee -a "$MAIN_LOG"
          
          CPU_CORES=$(nproc)
          echo "ğŸ–¥ï¸ æ£€æµ‹åˆ° CPU æ ¸å¿ƒ: $CPU_CORES" | tee -a "$MAIN_LOG"
          
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          case "$OPTIMIZATION_STRATEGY" in
            "speed")
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=$((CPU_CORES + 2))
              echo "ğŸš€ æé€Ÿæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            "stability")
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=$((CPU_CORES / 2))
              echo "ğŸ›¡ï¸ ç¨³å®šæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            *)
              CCACHE_SIZE="6G"
              PARALLEL_JOBS=$CPU_CORES
              echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
          esac
          
          mkdir -p /mnt/ccache
          ccache -M $CCACHE_SIZE
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=100000
          
          echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          
          echo "ğŸ’¾ åˆ›å»ºäº¤æ¢æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          sudo fallocate -l 8G /mnt/swapfile && sudo chmod 600 /mnt/swapfile && sudo mkswap /mnt/swapfile && sudo swapon /mnt/swapfile
          
          echo "ğŸ“Š ç³»ç»Ÿèµ„æºçŠ¶æ€:" | tee -a "$MAIN_LOG"
          free -h | tee -a "$MAIN_LOG"
          echo "âœ… æ€§èƒ½ä¼˜åŒ–å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ æé€Ÿæºç è·å–"
        id: source_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== âš¡ æé€Ÿæºç è·å– ===" | tee -a "$MAIN_LOG"
          
          REPO_JSON_FOUND="${{ env.CONFIG_REPO_DIR }}/firmware-config/repositories.json"
          PRESET="${{ github.event.inputs.source_preset }}"
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND")
          BRANCH="${{ github.event.inputs.source_branch }}"
          
          if [ "$BRANCH" = "auto" ]; then
            BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND")
          fi
          
          echo "ğŸ“¦ æé€Ÿå…‹éš†æºç ..." | tee -a "$MAIN_LOG"
          cd /mnt/source
          rm -rf .[!.]* *
          
          git clone --depth 1 --branch "$BRANCH" --single-branch --progress "$SOURCE_URL" . || {
            echo "ğŸ”„ åˆ†æ”¯å…‹éš†å¤±è´¥ï¼Œå°è¯•masteråˆ†æ”¯..." | tee -a "$MAIN_LOG"
            git clone --depth 1 --progress "$SOURCE_URL" .
            git checkout "$BRANCH" 2>/dev/null || true
          }
          
          ACTUAL_BRANCH=$(git branch --show-current)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "âœ… æºç è·å–å®Œæˆ: $ACTUAL_BRANCH@$COMMIT_HASH" | tee -a "$MAIN_LOG"

      - name: "ğŸ“ æ™ºèƒ½é…ç½®åˆ›å»ºä¸å¤„ç†"
        id: config_creation
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“ æ™ºèƒ½é…ç½®åˆ›å»ºä¸å¤„ç† ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          CONFIG_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/configs"
          CONFIG_FILE="$CONFIG_DIR/config_$CONFIG_PROFILE"
          
          echo "ğŸ” æŸ¥æ‰¾é…ç½®æ–‡ä»¶: $CONFIG_FILE" | tee -a "$MAIN_LOG"
          
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" .config
            echo "âœ… åº”ç”¨ç°æœ‰é…ç½®æ–‡ä»¶: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
            echo "CONFIG_SOURCE=existing" >> $GITHUB_ENV
          else
            echo "ğŸ”§ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°é…ç½®..." | tee -a "$MAIN_LOG"
            mkdir -p "$CONFIG_DIR"
            
            # æ ¹æ®è®¾å¤‡åç§°çŒœæµ‹ç›®æ ‡é…ç½®
            echo "ğŸ¯ æ™ºèƒ½åˆ†æè®¾å¤‡åç§°: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
            
            # åˆ›å»ºé€šç”¨é…ç½®æ–‡ä»¶æ¨¡æ¿
            echo "# =============================================" > "$CONFIG_FILE"
            echo "# é€šç”¨è®¾å¤‡é…ç½® - $CONFIG_PROFILE" >> "$CONFIG_FILE"
            echo "# è‡ªåŠ¨ç”Ÿæˆäº $(date)" >> "$CONFIG_FILE"
            echo "# =============================================" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# åŸºç¡€ç›®æ ‡é…ç½®" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"

            # æ ¹æ®è®¾å¤‡åç§°çŒœæµ‹ç›®æ ‡é…ç½®
            TARGET_CONFIG=""
            if [[ "$CONFIG_PROFILE" =~ ^rt-ac42u$|^ac42u$|^asus.*ac42u ]]; then
              echo "# ASUS RT-AC42U è®¾å¤‡ (IPQ40xx)" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx_generic=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ipq40xx_asus_rt-ac42u"
            elif [[ "$CONFIG_PROFILE" =~ ^x86|^x64|^generic.*64 ]]; then
              echo "# x86/x64 é€šç”¨è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86_64=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="x86_64_generic"
            elif [[ "$CONFIG_PROFILE" =~ ^mt7621|^newifi.*d2|^r6220 ]]; then
              echo "# MT7621 è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_ramips_mt7621_DEVICE_xxx=y è¯·æ ¹æ®å…·ä½“è®¾å¤‡è®¾ç½®" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621"
            elif [[ "$CONFIG_PROFILE" =~ ^r3g|^mir3g|^xiaomi.*r3g ]]; then
              echo "# Xiaomi R3G è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-3g=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621_xiaomi_r3g"
            elif [[ "$CONFIG_PROFILE" =~ ^r3p|^mir3p|^xiaomi.*r3p ]]; then
              echo "# Xiaomi R3P è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$MAIN_LOG"
              echo "CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-3-pro=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621_xiaomi_r3p"
            elif [[ "$CONFIG_PROFILE" =~ ^k2p|^phicomm.*k2p ]]; then
              echo "# Phicomm K2P è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621_phicomm_k2p"
            else
              echo "# é€šç”¨è®¾å¤‡é…ç½® - è¯·æ ¹æ®å®é™…è®¾å¤‡ä¿®æ”¹" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx_yyy=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx_yyy_DEVICE_zzz=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="generic"
            fi
            
            # æ·»åŠ é€šç”¨é…ç½®
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# é•œåƒé…ç½®" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_IMAGES_GZIP=y" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# åˆ†åŒºå¤§å°" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_ROOTFS_PARTSIZE=96" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# LUCI æ ¸å¿ƒé…ç½®" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_luci=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_luci-base=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_luci-compat=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_luci-mod-admin-full=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# åŸºç¡€ç³»ç»ŸåŒ…" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_base-files=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_busybox=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_dnsmasq-full=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_dropbear=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_firewall=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_fstools=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_iptables=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_libc=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_libgcc=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_logd=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_mtd=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_netifd=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_opkg=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_ubus=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_ubusd=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_uci=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_uclient-fetch=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_urandom-seed=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_usign=y" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# IPv6 æ”¯æŒ" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_odhcp6c=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_ip6tables=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_kmod-ip6tables=y" >> "$CONFIG_FILE"
            echo "# CONFIG_PACKAGE_6in4 is not set" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# ç½‘ç»œæœåŠ¡" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_kmod-fs-ntfs=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_block-mount=y" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# ç³»ç»Ÿå·¥å…·" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_htop=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_nano=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_curl=y" >> "$CONFIG_FILE"
            echo "CONFIG_PACKAGE_wget=y" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# ç¼–è¯‘é€‰é¡¹" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "CONFIG_CCACHE=y" >> "$CONFIG_FILE"
            echo "CONFIG_BUILD_LOG=y" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# æ’é™¤çš„åº”ç”¨ç¨‹åº" >> "$CONFIG_FILE"
            echo "# CONFIG_PACKAGE_luci-app-wireguard is not set" >> "$CONFIG_FILE"
            echo "# CONFIG_PACKAGE_luci-app-ddns is not set" >> "$CONFIG_FILE"
            echo "# CONFIG_PACKAGE_luci-app-wol is not set" >> "$CONFIG_FILE"
            echo "# CONFIG_PACKAGE_luci-app-eqosplus is not set" >> "$CONFIG_FILE"
            echo "# CONFIG_PACKAGE_luci-app-parentcontrol is not set" >> "$CONFIG_FILE"
            echo "# CONFIG_PACKAGE_luci-app-nlbwmon is not set" >> "$CONFIG_FILE"
            echo "# CONFIG_PACKAGE_luci-theme-material is not set" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ç¦ç”¨è°ƒè¯•å‡å°ä½“ç§¯" >> "$CONFIG_FILE"
            echo "# CONFIG_DEBUG is not set" >> "$CONFIG_FILE"
            echo "# CONFIG_DEVEL is not set" >> "$CONFIG_FILE"

            cp "$CONFIG_FILE" .config
            echo "CONFIG_SOURCE=new" >> $GITHUB_ENV
            echo "TARGET_CONFIG=$TARGET_CONFIG" >> $GITHUB_ENV
            echo "âœ… å·²åˆ›å»ºæ™ºèƒ½é…ç½®æ–‡ä»¶: $CONFIG_FILE" | tee -a "$MAIN_LOG"
            echo "ğŸ¯ ç›®æ ‡é…ç½®ç±»å‹: $TARGET_CONFIG" | tee -a "$MAIN_LOG"
          fi
          
          echo "âš¡ é¢„é…ç½®ä¼˜åŒ–é€‰é¡¹..." | tee -a "$MAIN_LOG"
          echo "# ç¼–è¯‘ä¼˜åŒ–" >> .config
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "# CONFIG_DEBUG=y is not set" >> .config
          
          echo "âœ… é…ç½®åˆ›å»ºä¸å¤„ç†å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”„ å¹¶è¡ŒFeedsæ›´æ–°"
        id: feeds_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”„ å¹¶è¡ŒFeedsæ›´æ–° ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          CURRENT_BRANCH=$(git branch --show-current)
          if [[ "$CURRENT_BRANCH" == *"22.03"* ]]; then FEEDS_BRANCH="openwrt-22.03"
          elif [[ "$CURRENT_BRANCH" == *"21.02"* ]]; then FEEDS_BRANCH="openwrt-21.02"
          else FEEDS_BRANCH="master"; fi
          
          case "${{ env.SOURCE_PRESET }}" in
            "immortalwrt")
              echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "openwrt")
              echo "src-git packages https://git.openwrt.org/feed/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://git.openwrt.org/project/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
            "lede")
              echo "src-git packages https://github.com/coolsnowwolf/packages.git;$FEEDS_BRANCH" > feeds.conf
              echo "src-git luci https://github.com/coolsnowwolf/luci.git;$FEEDS_BRANCH" >> feeds.conf
              ;;
          esac
          
          echo "src-git routing https://github.com/openwrt/routing.git;$FEEDS_BRANCH" >> feeds.conf
          
          echo "ğŸ”„ å¹¶è¡Œæ›´æ–°feeds..." | tee -a "$MAIN_LOG"
          ./scripts/feeds update -a &
          FEEDS_PID=$!
          
          mkdir -p /mnt/downloads
          [ -d "dl" ] && rm -rf dl
          ln -sf /mnt/downloads dl
          
          wait $FEEDS_PID
          ./scripts/feeds install -a
          
          echo "âœ… Feedsæ›´æ–°å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ¯ å®Œæ•´æ’ä»¶é…ç½®"
        id: plugin_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ¯ å®Œæ•´æ’ä»¶é…ç½® ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          PRESET="${{ github.event.inputs.plugin_preset }}"
          echo "ğŸ¯ æ’ä»¶é¢„è®¾: $PRESET" | tee -a "$MAIN_LOG"
          
          mkdir -p package/custom feeds/luci/applications
          
          enable_plugin() {
            local plugin=$1
            local description=$2
            local config_name="CONFIG_PACKAGE_${plugin}"
            
            if grep -q "${config_name}=y" .config; then
              echo "âœ… å·²å¯ç”¨: $plugin ($description)" | tee -a "$MAIN_LOG"
              return 0
            fi
            
            if grep -q "${config_name} is not set" .config; then
              sed -i "s/# ${config_name} is not set/${config_name}=y/" .config
              echo "âœ… å¯ç”¨: $plugin ($description)" | tee -a "$MAIN_LOG"
            else
              echo "${config_name}=y" >> .config
              echo "âœ… æ–°å¢: $plugin ($description)" | tee -a "$MAIN_LOG"
            fi
          }
          
          disable_plugin() {
            local plugin=$1
            local config_name="CONFIG_PACKAGE_${plugin}"
            
            if grep -q "${config_name}=y" .config; then
              sed -i "s/${config_name}=y/# ${config_name} is not set/" .config
              echo "âŒ ç¦ç”¨: $plugin" | tee -a "$MAIN_LOG"
            fi
          }
          
          # ç¡®ä¿ç¦ç”¨ç”¨æˆ·æŒ‡å®šçš„æ’ä»¶
          echo "ğŸ”§ ç¦ç”¨æŒ‡å®šæ’ä»¶..." | tee -a "$MAIN_LOG"
          disable_plugin "luci-app-wireguard"
          disable_plugin "luci-app-ddns"
          disable_plugin "luci-app-wol"
          disable_plugin "luci-app-eqosplus"
          disable_plugin "luci-app-parentcontrol"
          disable_plugin "luci-app-nlbwmon"
          disable_plugin "6in4"
          
          case "$PRESET" in
            "minimal")
              echo "ğŸ”§ æœ€å°åŒ–é…ç½®..." | tee -a "$MAIN_LOG"
              enable_plugin "luci-app-upnp" "UPnPç«¯å£è½¬å‘"
              enable_plugin "luci-app-firewall" "é˜²ç«å¢™"
              ;;
            "standard")
              echo "ğŸ”§ æ ‡å‡†é…ç½®..." | tee -a "$MAIN_LOG"
              enable_plugin "luci-app-upnp" "UPnPç«¯å£è½¬å‘"
              enable_plugin "luci-app-samba4" "ç½‘ç»œå…±äº«(Samba)"
              enable_plugin "luci-app-turboacc" "ç½‘ç»œåŠ é€Ÿ"
              enable_plugin "luci-app-arpbind" "IP/MACç»‘å®š"
              enable_plugin "luci-app-cpulimit" "CPUé™åˆ¶"
              enable_plugin "luci-app-diskman" "ç£ç›˜ç®¡ç†"
              enable_plugin "luci-app-hd-idle" "ç¡¬ç›˜ä¼‘çœ "
              enable_plugin "luci-app-wechatpush" "å¾®ä¿¡æ¨é€"
              enable_plugin "luci-app-smartdns" "æ™ºèƒ½DNS"
              enable_plugin "luci-app-vlmcsd" "KMSæ¿€æ´»"
              enable_plugin "luci-app-vsftpd" "FTPæœåŠ¡å™¨"
              enable_plugin "luci-app-ttyd" "ç½‘é¡µç»ˆç«¯"
              enable_plugin "luci-app-sqm-autorate" "æ™ºèƒ½QoS"
              enable_plugin "automount" "è‡ªåŠ¨æŒ‚è½½"
              ;;
            "full")
              echo "ğŸ”§ å®Œæ•´é…ç½®..." | tee -a "$MAIN_LOG"
              # åŸºç¡€ç½‘ç»œ
              enable_plugin "luci-app-upnp" "UPnPç«¯å£è½¬å‘"
              enable_plugin "luci-app-samba4" "ç½‘ç»œå…±äº«(Samba)"
              enable_plugin "luci-app-turboacc" "ç½‘ç»œåŠ é€Ÿ"
              enable_plugin "luci-app-arpbind" "IP/MACç»‘å®š"
              enable_plugin "luci-app-cpulimit" "CPUé™åˆ¶"
              enable_plugin "luci-app-diskman" "ç£ç›˜ç®¡ç†"
              enable_plugin "luci-app-hd-idle" "ç¡¬ç›˜ä¼‘çœ "
              
              # é«˜çº§åŠŸèƒ½
              enable_plugin "luci-app-wechatpush" "å¾®ä¿¡æ¨é€"
              enable_plugin "luci-app-smartdns" "æ™ºèƒ½DNS"
              enable_plugin "luci-app-vlmcsd" "KMSæ¿€æ´»"
              enable_plugin "luci-app-vsftpd" "FTPæœåŠ¡å™¨"
              enable_plugin "luci-app-ttyd" "ç½‘é¡µç»ˆç«¯"
              enable_plugin "luci-app-sqm-autorate" "æ™ºèƒ½QoS"
              enable_plugin "automount" "è‡ªåŠ¨æŒ‚è½½"
              
              # æ‰©å±•åŠŸèƒ½
              enable_plugin "luci-app-adblock" "å¹¿å‘Šè¿‡æ»¤"
              enable_plugin "luci-app-qos" "æµé‡æ§åˆ¶"
              enable_plugin "luci-app-statistics" "æµé‡ç»Ÿè®¡"
              enable_plugin "luci-app-vpn-policy-routing" "VPNç­–ç•¥è·¯ç”±"
              enable_plugin "luci-app-nft-qos" "Nftables QoS"
              enable_plugin "luci-app-uhttpd" "WebæœåŠ¡å™¨"
              enable_plugin "luci-app-firewall" "é˜²ç«å¢™"
              enable_plugin "luci-app-olsr" "OLSRç½‘æ ¼ç½‘ç»œ"
              enable_plugin "luci-app-olsr-services" "OLSRæœåŠ¡"
              enable_plugin "luci-app-olsr-viz" "OLSRå¯è§†åŒ–"
              enable_plugin "luci-app-bcp38" "BCP38æ”¯æŒ"
              enable_plugin "luci-app-commands" "è‡ªå®šä¹‰å‘½ä»¤"
              enable_plugin "luci-app-diag-core" "è¯Šæ–­å·¥å…·"
              enable_plugin "luci-app-splash" "Captive Portal"
              enable_plugin "luci-app-radicale2" "CalDAV/CardDAV"
              ;;
            "custom")
              echo "ğŸ”§ è‡ªå®šä¹‰é…ç½®..." | tee -a "$MAIN_LOG"
              CUSTOM_PLUGINS_FILE="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-plugins.txt"
              if [ -f "$CUSTOM_PLUGINS_FILE" ]; then
                echo "ğŸ“‹ è¯»å–è‡ªå®šä¹‰æ’ä»¶åˆ—è¡¨..." | tee -a "$MAIN_LOG"
                while IFS= read -r plugin; do
                  if [ -n "$plugin" ] && [[ ! "$plugin" =~ ^# ]]; then
                    enable_plugin "$plugin" "è‡ªå®šä¹‰æ’ä»¶"
                  fi
                done < "$CUSTOM_PLUGINS_FILE"
              else
                echo "â„¹ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰æ’ä»¶åˆ—è¡¨ï¼Œä½¿ç”¨æ ‡å‡†é…ç½®" | tee -a "$MAIN_LOG"
                enable_plugin "luci-app-upnp" "UPnPç«¯å£è½¬å‘"
                enable_plugin "luci-app-samba4" "ç½‘ç»œå…±äº«(Samba)"
                enable_plugin "luci-app-turboacc" "ç½‘ç»œåŠ é€Ÿ"
              fi
              ;;
          esac
          
          echo "âœ… æ’ä»¶é…ç½®å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸŒ è¯­è¨€åŒ…é…ç½®"
        id: language_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸŒ è¯­è¨€åŒ…é…ç½® ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          LANGUAGE="${{ github.event.inputs.language_pack }}"
          echo "ğŸ¯ è¯­è¨€åŒ…é€‰æ‹©: $LANGUAGE" | tee -a "$MAIN_LOG"
          
          CURRENT_BRANCH="${{ env.ACTUAL_BRANCH }}"
          
          case "$LANGUAGE" in
            "zh-cn")
              echo "ğŸ”§ å¯ç”¨ä¸­æ–‡è¯­è¨€åŒ…..." | tee -a "$MAIN_LOG"
              if [[ "$CURRENT_BRANCH" == *"21.02"* ]]; then
                sed -i 's/# CONFIG_PACKAGE_luci-i18n-base-zh-cn is not set/CONFIG_PACKAGE_luci-i18n-base-zh-cn=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
              else
                sed -i 's/# CONFIG_PACKAGE_luci-i18n-base-zh_Hans is not set/CONFIG_PACKAGE_luci-i18n-base-zh_Hans=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-i18n-base-zh_Hans=y" >> .config
              fi
              ;;
            "en-only")
              echo "ğŸ”§ ä»…ä¿ç•™è‹±æ–‡..." | tee -a "$MAIN_LOG"
              sed -i 's/CONFIG_PACKAGE_luci-i18n-[^e][^n].*=y/# &/' .config
              ;;
            "all")
              echo "ğŸ”§ å¯ç”¨æ‰€æœ‰è¯­è¨€åŒ…..." | tee -a "$MAIN_LOG"
              for lang in $(grep "CONFIG_PACKAGE_luci-i18n-" .config | grep "is not set" | cut -d' ' -f2); do
                sed -i "s/# $lang is not set/$lang=y/" .config
              done
              ;;
          esac
          
          echo "âœ… è¯­è¨€åŒ…é…ç½®å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ é«˜çº§åŠŸèƒ½å¢å¼º"
        id: advanced_features
        if: github.event.inputs.enable_advanced == 'true'
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== ğŸ”§ é«˜çº§åŠŸèƒ½å¢å¼º ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ é«˜çº§åŠŸèƒ½çŠ¶æ€: å·²å¯ç”¨" | tee -a "$MAIN_LOG"
          
          echo "ğŸ“¦ å®‰è£…è‡ªå®šä¹‰IPKåŒ…..." | tee -a "$MAIN_LOG"
          IPK_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-features/prebuilt-ipks"
          IPK_COUNT=0
          
          if [ -d "$IPK_DIR" ]; then
            echo "ğŸ” æŸ¥æ‰¾è‡ªå®šä¹‰IPKåŒ…..." | tee -a "$MAIN_LOG"
            IPK_FILES=$(find "$IPK_DIR" -name "*.ipk" -type f 2>/dev/null || true)
            if [ -n "$IPK_FILES" ]; then
              echo "âœ… æ‰¾åˆ°è‡ªå®šä¹‰IPKåŒ…:" | tee -a "$MAIN_LOG"
              mkdir -p package/custom
              for ipk in $IPK_FILES; do
                ipk_name=$(basename "$ipk")
                echo "  - å¤åˆ¶ $ipk_name" | tee -a "$MAIN_LOG"
                cp "$ipk" package/custom/
                IPK_COUNT=$((IPK_COUNT + 1))
                ipk_basename=$(basename "$ipk" .ipk)
                echo "CONFIG_PACKAGE_${ipk_basename}=y" >> .config
              done
              echo "âœ… æˆåŠŸæ·»åŠ  $IPK_COUNT ä¸ªè‡ªå®šä¹‰IPKåŒ…" | tee -a "$MAIN_LOG"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰IPKåŒ…" | tee -a "$MAIN_LOG"
            fi
          else
            echo "â„¹ï¸ è‡ªå®šä¹‰IPKç›®å½•ä¸å­˜åœ¨: $IPK_DIR" | tee -a "$MAIN_LOG"
          fi
          
          echo "CUSTOM_IPK_COUNT=$IPK_COUNT" >> $GITHUB_ENV
          
          echo "ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..." | tee -a "$MAIN_LOG"
          SCRIPT_PATHS="${{ env.CONFIG_REPO_DIR }}/firmware-config/custom-features/scripts ${{ env.CONFIG_REPO_DIR }}/firmware-config/scripts ${{ env.CONFIG_REPO_DIR }}/scripts ${{ env.CONFIG_REPO_DIR }}/firmware-config"
          
          SCRIPT_COUNT=0
          for script_path in $SCRIPT_PATHS; do
            if [ -d "$script_path" ]; then
              echo "ğŸ” åœ¨ $script_path ä¸­æŸ¥æ‰¾è„šæœ¬..." | tee -a "$MAIN_LOG"
              SCRIPTS=$(find "$script_path" -maxdepth 2 -name "*.sh" -type f 2>/dev/null | sort || true)
              if [ -n "$SCRIPTS" ]; then
                for script in $SCRIPTS; do
                  script_name=$(basename "$script")
                  echo "ğŸ“œ æ‰§è¡Œè„šæœ¬: $script_name..." | tee -a "$MAIN_LOG"
                  chmod +x "$script"
                  
                  TEMP_LOG=$(mktemp)
                  if { bash "$script" 2>&1 | tee "$TEMP_LOG"; } then
                    echo "âœ… è‡ªå®šä¹‰è„šæœ¬æ‰§è¡ŒæˆåŠŸ: $script_name" | tee -a "$MAIN_LOG"
                    SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
                  else
                    echo "âš ï¸ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œæœ‰è­¦å‘Š: $script_name" | tee -a "$MAIN_LOG"
                    grep -i -E "error|failed|No such file" "$TEMP_LOG" >> "$WARNING_LOG" || true
                  fi
                  cat "$TEMP_LOG" >> "$MAIN_LOG"
                  rm -f "$TEMP_LOG"
                done
              else
                echo "â„¹ï¸ åœ¨ $script_path ä¸­æœªæ‰¾åˆ°è„šæœ¬" | tee -a "$MAIN_LOG"
              fi
            else
              echo "â„¹ï¸ è„šæœ¬ç›®å½•ä¸å­˜åœ¨: $script_path" | tee -a "$MAIN_LOG"
            fi
          done
          
          echo "CUSTOM_SCRIPT_COUNT=$SCRIPT_COUNT" >> $GITHUB_ENV
          echo "âœ… é«˜çº§åŠŸèƒ½åº”ç”¨å®Œæˆï¼Œæ‰§è¡Œäº† $SCRIPT_COUNT ä¸ªè„šæœ¬" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ æ„å»ºç³»ç»Ÿä¿®å¤"
        id: build_fix
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ æ„å»ºç³»ç»Ÿä¿®å¤ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ ä¿®å¤å·²çŸ¥æ„å»ºé—®é¢˜..." | tee -a "$MAIN_LOG"
          
          # å¼ºåŠ›ç¦ç”¨6in4åŠç›¸å…³é—®é¢˜åŒ…
          echo "ğŸ”§ å¼ºåŠ›ç¦ç”¨é—®é¢˜åŒ…..." | tee -a "$MAIN_LOG"
          for pkg in 6in4 6rd 6to4; do
            sed -i "s/CONFIG_PACKAGE_${pkg}=y/# CONFIG_PACKAGE_${pkg} is not set/" .config 2>/dev/null || true
            sed -i "s/CONFIG_PACKAGE_${pkg}-=y/# CONFIG_PACKAGE_${pkg} is not set/" .config 2>/dev/null || true
          done
          
          # åˆ é™¤å¯èƒ½å¼•èµ·é—®é¢˜çš„6in4ç›¸å…³æ–‡ä»¶
          echo "ğŸ”§ æ¸…ç†é—®é¢˜åŒ…æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          find . -name "*6in4*" -type f -path "*/package/*" -delete 2>/dev/null || true
          find . -name "*6rd*" -type f -path "*/package/*" -delete 2>/dev/null || true
          find . -name "*6to4*" -type f -path "*/package/*" -delete 2>/dev/null || true
          
          # ç¡®ä¿åŸºç¡€ç³»ç»ŸåŒ…å¯ç”¨
          echo "ğŸ”§ ç¡®ä¿åŸºç¡€ç³»ç»ŸåŒ…..." | tee -a "$MAIN_LOG"
          echo "# åŸºç¡€ç³»ç»Ÿä¿®å¤" >> .config
          echo "CONFIG_PACKAGE_base-files=y" >> .config
          echo "CONFIG_PACKAGE_busybox=y" >> .config
          echo "CONFIG_PACKAGE_opkg=y" >> .config
          echo "CONFIG_PACKAGE_procd=y" >> .config
          echo "CONFIG_PACKAGE_uci=y" >> .config
          echo "CONFIG_PACKAGE_ubus=y" >> .config
          echo "CONFIG_PACKAGE_netifd=y" >> .config
          echo "CONFIG_PACKAGE_firewall=y" >> .config
          echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
          echo "CONFIG_PACKAGE_dropbear=y" >> .config
          
          # IPv6æ”¯æŒï¼ˆä¸å«é—®é¢˜åŒ…ï¼‰
          echo "" >> .config
          echo "# IPv6æ”¯æŒï¼ˆä¸å«é—®é¢˜åŒ…ï¼‰" >> .config
          echo "CONFIG_PACKAGE_odhcp6c=y" >> .config
          echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> .config
          echo "CONFIG_PACKAGE_ip6tables=y" >> .config
          echo "CONFIG_PACKAGE_kmod-ipv6=y" >> .config
          echo "CONFIG_PACKAGE_kmod-ip6tables=y" >> .config
          
          # å¼ºåŠ›ç¦ç”¨æ‰€æœ‰é—®é¢˜åŒ…
          echo "" >> .config
          echo "# å¼ºåŠ›ç¦ç”¨é—®é¢˜åŒ…" >> .config
          for pkg in 6in4 6rd 6to4 luci-app-wireguard luci-app-ddns luci-app-wol luci-app-eqosplus luci-app-parentcontrol luci-app-nlbwmon; do
            echo "# CONFIG_PACKAGE_${pkg} is not set" >> .config
          done
          
          echo "âœ… æ„å»ºç³»ç»Ÿä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ æ·±åº¦æ„å»ºä¿®å¤"
        id: deep_build_fix
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ æ·±åº¦æ„å»ºä¿®å¤ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ ä¿®å¤å†…æ ¸é…ç½®..." | tee -a "$MAIN_LOG"
          
          # å¼ºåˆ¶è®¾ç½®æ­£ç¡®çš„å†…æ ¸é…ç½®
          echo "# å†…æ ¸é…ç½®ä¿®å¤" >> .config
          echo "CONFIG_KERNEL_BUILD_USER=\"OpenWrt\"" >> .config
          echo "CONFIG_KERNEL_BUILD_HOST=\"openwrt\"" >> .config
          echo "CONFIG_KERNEL_GIT_CLONE_URI=\"\"" >> .config
          echo "CONFIG_KERNEL_GIT_BRANCH=\"\"" >> .config
          echo "CONFIG_KERNEL_GIT_LOCAL_REPOSITORY=\"\"" >> .config
          
          # ä¿®å¤æ¨¡å—æ„å»º
          echo "" >> .config
          echo "# æ¨¡å—æ„å»ºä¿®å¤" >> .config
          echo "CONFIG_PACKAGE_kmod-ipt-core=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nf-conntrack=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nf-conntrack6=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nf-nat=y" >> .config
          echo "CONFIG_PACKAGE_kmod-ipt-ipset=y" >> .config
          
          # ä¿®å¤å·¥å…·é“¾
          echo "" >> .config
          echo "# å·¥å…·é“¾ä¿®å¤" >> .config
          echo "CONFIG_TOOLCHAIN_KERNEL_HAS_SPE=y" >> .config
          echo "CONFIG_TOOLCHAIN_KERNEL_HAS_NEON=y" >> .config
          echo "CONFIG_TOOLCHAIN_KERNEL_HAS_VFPV4=y" >> .config
          
          echo "âœ… æ·±åº¦æ„å»ºä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ å†…æ ¸é…ç½®ä¿®å¤"
        id: kernel_fix
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ å†…æ ¸é…ç½®ä¿®å¤ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          # ä¿®å¤IPQ40xxç‰¹å®šé…ç½®
          echo "ğŸ”§ ä¿®å¤IPQ40xxé…ç½®..." | tee -a "$MAIN_LOG"
          
          # ç¡®ä¿ç›®æ ‡è®¾å¤‡æ­£ç¡®é…ç½®
          sed -i 's/CONFIG_TARGET_ipq40xx=y/CONFIG_TARGET_ipq40xx=y\nCONFIG_TARGET_ipq40xx_generic=y\nCONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y/' .config
          
          # ä¿®å¤å†…æ ¸ç‰ˆæœ¬é…ç½®
          echo "# å†…æ ¸ç‰ˆæœ¬ä¿®å¤" >> .config
          echo "CONFIG_KERNEL_5_4=y" >> .config
          echo "CONFIG_KERNEL_5_4_255=y" >> .config
          echo "CONFIG_DEFAULT_5_4=y" >> .config
          
          # ä¿®å¤ç¼–è¯‘é€‰é¡¹
          echo "" >> .config
          echo "# ç¼–è¯‘é€‰é¡¹ä¿®å¤" >> .config
          echo "CONFIG_USE_MKLIBS=y" >> .config
          echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> .config
          echo "CONFIG_USE_UCLIBCXX=y" >> .config
          
          echo "âœ… å†…æ ¸é…ç½®ä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ” é…ç½®å®Œæ•´æ€§æ£€æŸ¥"
        id: config_check
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ” é…ç½®å®Œæ•´æ€§æ£€æŸ¥ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ” æ£€æŸ¥é—®é¢˜åŒ…é…ç½®..." | tee -a "$MAIN_LOG"
          
          # æ£€æŸ¥å¹¶ä¿®å¤6in4ç›¸å…³é…ç½®
          PROBLEM_PKGS=("6in4" "6rd" "6to4")
          for pkg in "${PROBLEM_PKGS[@]}"; do
            if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
              echo "âš ï¸  å‘ç°é—®é¢˜åŒ… $pkg è¢«å¯ç”¨ï¼Œæ­£åœ¨ç¦ç”¨..." | tee -a "$MAIN_LOG"
              sed -i "s/CONFIG_PACKAGE_${pkg}=y/# CONFIG_PACKAGE_${pkg} is not set/" .config
            fi
          done
          
          # éªŒè¯é…ç½®
          echo "ğŸ” éªŒè¯æœ€ç»ˆé…ç½®..." | tee -a "$MAIN_LOG"
          echo "é—®é¢˜åŒ…çŠ¶æ€:" | tee -a "$MAIN_LOG"
          for pkg in "${PROBLEM_PKGS[@]}"; do
            if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
              echo "âŒ $pkg: ä»ç„¶å¯ç”¨" | tee -a "$MAIN_LOG"
            else
              echo "âœ… $pkg: å·²ç¦ç”¨" | tee -a "$MAIN_LOG"
            fi
          done
          
          echo "âœ… é…ç½®æ£€æŸ¥å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”„ æœ€ç»ˆé…ç½®å¤„ç†"
        id: final_config
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”„ æœ€ç»ˆé…ç½®å¤„ç† ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ è¿è¡Œdefconfig..." | tee -a "$MAIN_LOG"
          make defconfig
          
          echo "ğŸ“‹ æœ€ç»ˆé…ç½®æ£€æŸ¥..." | tee -a "$MAIN_LOG"
          echo "ğŸ¯ ç›®æ ‡é…ç½®:" | tee -a "$MAIN_LOG"
          grep "^CONFIG_TARGET" .config | grep "=y" | head -10 | tee -a "$MAIN_LOG"
          echo "ğŸ”Œ å¯ç”¨çš„LUCIåº”ç”¨:" | tee -a "$MAIN_LOG"
          grep "^CONFIG_PACKAGE_luci-app" .config | grep "=y" | head -20 | tee -a "$MAIN_LOG"
          echo "ğŸŒ è¯­è¨€åŒ…:" | tee -a "$MAIN_LOG"
          grep "^CONFIG_PACKAGE_luci-i18n" .config | grep "=y" | head -10 | tee -a "$MAIN_LOG"
          echo "âŒ ç¦ç”¨çš„æŒ‡å®šæ’ä»¶:" | tee -a "$MAIN_LOG"
          grep "# CONFIG_PACKAGE_luci-app-wireguard is not set" .config && echo "  - WireGuard VPN"
          grep "# CONFIG_PACKAGE_luci-app-ddns is not set" .config && echo "  - åŠ¨æ€DNS"
          grep "# CONFIG_PACKAGE_luci-app-wol is not set" .config && echo "  - ç½‘ç»œå”¤é†’"
          grep "# CONFIG_PACKAGE_luci-app-eqosplus is not set" .config && echo "  - QoSæµæ§"
          grep "# CONFIG_PACKAGE_luci-app-parentcontrol is not set" .config && echo "  - ä¸Šç½‘æ—¶é—´æ§åˆ¶"
          grep "# CONFIG_PACKAGE_luci-app-nlbwmon is not set" .config && echo "  - å¸¦å®½ç›‘æ§"
          grep "# CONFIG_PACKAGE_6in4 is not set" .config && echo "  - 6in4éš§é“"
          
          echo "âœ… æœ€ç»ˆé…ç½®å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸš€ å¹¶è¡Œä¸‹è½½ä¼˜åŒ–"
        id: download_deps
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸš€ å¹¶è¡Œä¸‹è½½ä¼˜åŒ– ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          sed -i 's|https://sources.cdn.openwrt.org|https://mirror2.openwrt.org/sources|g' scripts/download.pl
          sed -i 's|git.openwrt.org|github.com/openwrt|g' feeds.conf.* 2>/dev/null || true
          
          echo "ğŸ“¥ å¼€å§‹å¹¶è¡Œä¸‹è½½..." | tee -a "$MAIN_LOG"
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          
          for i in 1 2 3; do
            echo "ğŸ”„ ä¸‹è½½å°è¯• $i/3..." | tee -a "$MAIN_LOG"
            if make download -j$PARALLEL_JOBS; then
              echo "âœ… ä¸‹è½½æˆåŠŸ" | tee -a "$MAIN_LOG"
              break
            else
              echo "âš ï¸ ä¸‹è½½å°è¯• $i å¤±è´¥" | tee -a "$MAIN_LOG"
              if [ $i -eq 3 ]; then
                echo "âŒ æ‰€æœ‰ä¸‹è½½å°è¯•éƒ½å¤±è´¥" | tee -a "$MAIN_LOG"
                exit 1
              fi
              sleep 10
            fi
          done
          
          DOWNLOAD_COUNT=$(find dl/ -type f 2>/dev/null | wc -l)
          echo "ğŸ“¦ ä¸‹è½½æ–‡ä»¶æ•°é‡: $DOWNLOAD_COUNT" | tee -a "$MAIN_LOG"
          
          if [ "$DOWNLOAD_COUNT" -lt 10 ]; then
            echo "âš ï¸ ä¸‹è½½æ–‡ä»¶æ•°é‡è¿‡å°‘ï¼Œå¯èƒ½æœ‰é—®é¢˜" | tee -a "$MAIN_LOG"
          fi

      - name: "âš¡ æ™ºèƒ½å¢é‡ç¼–è¯‘"
        id: smart_build
        timeout-minutes: 150
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          WARNING_LOG="${{ env.WARNING_LOG }}"
          echo "=== âš¡ æ™ºèƒ½å¢é‡ç¼–è¯‘ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          SKIP_TESTS="${{ github.event.inputs.skip_tests }}"
          
          echo "ğŸ”§ ç¼–è¯‘é…ç½®: å¹¶è¡Œä½œä¸š=$PARALLEL_JOBS, è·³è¿‡æµ‹è¯•=$SKIP_TESTS" | tee -a "$MAIN_LOG"
          
          # ç¼–è¯‘å‰æœ€ç»ˆæ£€æŸ¥
          echo "ğŸ” ç¼–è¯‘å‰æœ€ç»ˆæ£€æŸ¥..." | tee -a "$MAIN_LOG"
          make defconfig
          
          if [ "$SKIP_TESTS" = "true" ]; then
            EXTRA_FLAGS="IGNORE_ERRORS=m"
          else
            EXTRA_FLAGS=""
          fi
          
          # åˆ›å»ºæ„å»ºæ—¥å¿—ç›®å½•
          mkdir -p logs
          
          echo "ğŸ› ï¸ é˜¶æ®µ1: æ¸…ç†å’Œå‡†å¤‡..." | tee -a "$MAIN_LOG"
          make target/linux/clean
          make toolchain/clean
          
          echo "ğŸ› ï¸ é˜¶æ®µ2: ç¼–è¯‘å·¥å…·é“¾..." | tee -a "$MAIN_LOG"
          if make toolchain/install -j$PARALLEL_JOBS $EXTRA_FLAGS 2>&1 | tee -a "$MAIN_LOG"; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ" | tee -a "$MAIN_LOG"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..." | tee -a "$MAIN_LOG"
            make toolchain/install -j1 V=s 2>&1 | tee -a "$MAIN_LOG"
          fi
          
          echo "ğŸ› ï¸ é˜¶æ®µ3: ç¼–è¯‘å†…æ ¸..." | tee -a "$MAIN_LOG"
          if make target/linux/install -j$PARALLEL_JOBS $EXTRA_FLAGS 2>&1 | tee -a "$MAIN_LOG"; then
            echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ" | tee -a "$MAIN_LOG"
          else
            echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..." | tee -a "$MAIN_LOG"
            make target/linux/install -j1 V=s 2>&1 | tee -a "$MAIN_LOG"
          fi
          
          echo "ğŸš€ é˜¶æ®µ4: å®Œæ•´ç¼–è¯‘..." | tee -a "$MAIN_LOG"
          # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ•è·å®Œæ•´è¾“å‡º
          TEMP_LOG=$(mktemp)
          set +e
          make -j$PARALLEL_JOBS $EXTRA_FLAGS 2>&1 | tee "$TEMP_LOG"
          BUILD_RESULT=${PIPESTATUS[0]}
          set -e
          
          cat "$TEMP_LOG" >> "$MAIN_LOG"
          
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ" | tee -a "$MAIN_LOG"
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ (é€€å‡ºç : $BUILD_RESULT)" | tee -a "$MAIN_LOG"
            echo "ğŸ”„ å°è¯•å•çº¿ç¨‹ç¼–è¯‘å®šä½é—®é¢˜..." | tee -a "$MAIN_LOG"
            echo "=== è¯¦ç»†é”™è¯¯æ—¥å¿—å¼€å§‹ ===" >> "$ERROR_LOG"
            make -j1 V=s 2>&1 >> "$ERROR_LOG" || true
            echo "=== è¯¦ç»†é”™è¯¯æ—¥å¿—ç»“æŸ ===" >> "$ERROR_LOG"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
          fi
          rm -f "$TEMP_LOG"
          
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†å›ºä»¶æ–‡ä»¶
          FIRMWARE_FOUND=false
          if find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | grep -q .; then
            echo "ğŸ‰ æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼" | tee -a "$MAIN_LOG"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) -exec ls -la {} \; | tee -a "$MAIN_LOG"
            FIRMWARE_FOUND=true
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶" | tee -a "$MAIN_LOG"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            echo "ğŸ” æ£€æŸ¥æ„å»ºç›®å½•..." | tee -a "$MAIN_LOG"
            find bin -type f -name "*" 2>/dev/null | head -20 | tee -a "$MAIN_LOG"
          fi
          
          echo "FIRMWARE_FOUND=$FIRMWARE_FOUND" >> $GITHUB_ENV
          
          echo "ğŸ“Š CCacheç»Ÿè®¡:" | tee -a "$MAIN_LOG"
          ccache -s | tee -a "$MAIN_LOG"
          
          # æ„å»ºæ€»ç»“
          echo "=== ç¼–è¯‘æ€»ç»“ ===" | tee -a "$MAIN_LOG"
          echo "æ„å»ºçŠ¶æ€: $BUILD_STATUS" | tee -a "$MAIN_LOG"
          echo "å›ºä»¶ç”Ÿæˆ: $FIRMWARE_FOUND" | tee -a "$MAIN_LOG"

      - name: "ğŸ” æ„å»ºé”™è¯¯è¯Šæ–­"
        id: build_diagnosis
        if: env.BUILD_STATUS == 'failed'
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          echo "=== ğŸ” æ„å»ºé”™è¯¯è¯Šæ–­ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ è¯Šæ–­æ„å»ºé—®é¢˜..." | tee -a "$MAIN_LOG"
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          echo "ğŸ“‹ å…³é”®æ–‡ä»¶æ£€æŸ¥:" | tee -a "$MAIN_LOG"
          [ -f ".config" ] && echo "âœ… .config å­˜åœ¨" || echo "âŒ .config ç¼ºå¤±"
          [ -d "bin" ] && echo "âœ… bin ç›®å½•å­˜åœ¨" || echo "âŒ bin ç›®å½•ç¼ºå¤±"
          [ -d "build_dir" ] && echo "âœ… build_dir å­˜åœ¨" || echo "âŒ build_dir ç¼ºå¤±"
          
          # æ£€æŸ¥å†…æ ¸æ„å»ºçŠ¶æ€
          echo "ğŸ” å†…æ ¸æ„å»ºçŠ¶æ€:" | tee -a "$MAIN_LOG"
          if [ -d "build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic" ]; then
            # ä¿®å¤ç®¡é“é”™è¯¯ï¼Œä½¿ç”¨æ›´ç¨³å®šçš„æ–¹å¼
            find build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic \( -name "vmlinux" -o -name "*.ko" \) -print 2>/dev/null | head -5 | while read -r file; do
              echo "ğŸ” æ‰¾åˆ°: $file" | tee -a "$MAIN_LOG"
            done
          fi
          
          # æ£€æŸ¥å›ºä»¶ç”ŸæˆçŠ¶æ€
          echo "ğŸ” å›ºä»¶ç”ŸæˆçŠ¶æ€:" | tee -a "$MAIN_LOG"
          if [ -d "bin/targets" ]; then
            find bin/targets -type f -name "*" 2>/dev/null | head -10 | while read -r file; do
              echo "ğŸ“¦ äº§ç‰©: $file ($(du -h "$file" 2>/dev/null | cut -f1))" | tee -a "$MAIN_LOG"
            done
          else
            echo "âŒ bin/targets ç›®å½•ä¸å­˜åœ¨" | tee -a "$MAIN_LOG"
          fi
          
          # æ£€æŸ¥ç¼–è¯‘é”™è¯¯
          echo "ğŸ” ç¼–è¯‘é”™è¯¯åˆ†æ:" | tee -a "$MAIN_LOG"
          if [ -f "$ERROR_LOG" ]; then
            echo "ğŸ“‹ æœ€è¿‘é”™è¯¯:" | tee -a "$MAIN_LOG"
            tail -20 "$ERROR_LOG" | grep -E "(error|Error|ERROR|failed|Failed|FAILED)" | head -10 | tee -a "$MAIN_LOG"
          fi
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          echo "ğŸ” ç³»ç»Ÿèµ„æºçŠ¶æ€:" | tee -a "$MAIN_LOG"
          df -h /mnt | tee -a "$MAIN_LOG"
          echo "å†…å­˜ä½¿ç”¨:" | tee -a "$MAIN_LOG"
          free -h | tee -a "$MAIN_LOG"
          
          echo "âœ… é”™è¯¯è¯Šæ–­å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ æ„å»ºå¤±è´¥æ¢å¤"
        id: build_recovery
        if: env.BUILD_STATUS == 'failed'
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ æ„å»ºå¤±è´¥æ¢å¤ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”„ å°è¯•æ„å»ºæ¢å¤..." | tee -a "$MAIN_LOG"
          
          # æ¸…ç†å¯èƒ½çš„æ„å»ºé—®é¢˜
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¼“å­˜..." | tee -a "$MAIN_LOG"
          make clean
          rm -rf tmp staging_dir build_dir/target-*
          
          echo "ğŸ”§ é‡æ–°é…ç½®..." | tee -a "$MAIN_LOG"
          make defconfig
          
          echo "ğŸ”„ é‡æ–°å°è¯•ç¼–è¯‘æ ¸å¿ƒç»„ä»¶..." | tee -a "$MAIN_LOG"
          if make -j1 V=s 2>&1 | tail -100; then
            echo "âœ… æ¢å¤ç¼–è¯‘æˆåŠŸ" | tee -a "$MAIN_LOG"
            echo "BUILD_STATUS=recovered" >> $GITHUB_ENV
          else
            echo "âŒ æ¢å¤ç¼–è¯‘å¤±è´¥" | tee -a "$MAIN_LOG"
          fi

      - name: "ğŸ” å¿«é€Ÿå›ºä»¶åˆ†æ"
        id: firmware_analysis
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ” å¿«é€Ÿå›ºä»¶åˆ†æ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          FIRMWARE_COUNT=0
          TOTAL_SIZE=0
          
          if [ -d "bin/targets" ]; then
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
                size=$(du -b "$file" 2>/dev/null | cut -f1)
                TOTAL_SIZE=$((TOTAL_SIZE + size))
                echo "ğŸ“¦ å›ºä»¶: $(basename "$file") ($(du -h "$file" | cut -f1))" | tee -a "$MAIN_LOG"
              fi
            done < <(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) 2>/dev/null)
          fi
          
          TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024 / 1024))
          echo "FIRMWARE_COUNT=$FIRMWARE_COUNT" >> $GITHUB_ENV
          echo "FIRMWARE_SIZE_MB=$TOTAL_SIZE_MB" >> $GITHUB_ENV
          
          echo "ğŸ“Š åˆ†æç»“æœ: $FIRMWARE_COUNT ä¸ªå›ºä»¶, ${TOTAL_SIZE_MB}MB" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¦ æé€Ÿäº§ç‰©æ”¶é›†"
        id: collect_artifacts
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¦ æé€Ÿäº§ç‰©æ”¶é›† ===" | tee -a "$MAIN_LOG"
          
          mkdir -p /mnt/artifacts/firmware
          ARTIFACT_COUNT=0
          
          if [ -d "/mnt/source/bin/targets" ]; then
            find /mnt/source/bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) -exec cp {} /mnt/artifacts/firmware/ \;
            ARTIFACT_COUNT=$(ls /mnt/artifacts/firmware/ 2>/dev/null | wc -l || echo 0)
          fi
          
          cp "$MAIN_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$ERROR_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$WARNING_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$ANALYSIS_REPORT" /mnt/artifacts/ 2>/dev/null || true
          
          # æ”¶é›†é…ç½®æ–‡ä»¶å’Œæ„å»ºä¿¡æ¯
          cp /mnt/source/.config /mnt/artifacts/ 2>/dev/null || true
          
          echo "ARTIFACT_COUNT=$ARTIFACT_COUNT" >> $GITHUB_ENV
          echo "âœ… æ”¶é›†äº† $ARTIFACT_COUNT ä¸ªäº§ç‰©" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¤ æäº¤æ–°é…ç½®æ–‡ä»¶åˆ°ä»“åº“"
        id: commit_config
        if: env.CONFIG_SOURCE == 'new' && github.event.inputs.auto_commit_config == 'true'
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¤ æäº¤æ–°é…ç½®æ–‡ä»¶åˆ°ä»“åº“ ===" | tee -a "$MAIN_LOG"
          
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          CONFIG_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/configs"
          CONFIG_FILE="$CONFIG_DIR/config_$CONFIG_PROFILE"
          
          if [ -f "$CONFIG_FILE" ]; then
            echo "ğŸ“ æ‰¾åˆ°æ–°åˆ›å»ºçš„é…ç½®æ–‡ä»¶: $CONFIG_FILE" | tee -a "$MAIN_LOG"
            
            # åˆ‡æ¢åˆ°é…ç½®ä»“åº“ç›®å½•
            cd "${{ env.CONFIG_REPO_DIR }}"
            
            # é…ç½®Gitç”¨æˆ·
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            
            # æ·»åŠ é…ç½®æ–‡ä»¶
            git add "firmware-config/configs/config_$CONFIG_PROFILE"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
            if git diff --staged --quiet; then
              echo "â„¹ï¸ æ²¡æœ‰æ–°çš„é…ç½®æ–‡ä»¶éœ€è¦æäº¤" | tee -a "$MAIN_LOG"
            else
              # æäº¤æ›´æ”¹
              COMMIT_MSG="æ·»åŠ æ–°çš„è®¾å¤‡é…ç½®æ–‡ä»¶: $CONFIG_PROFILE"
              if [ -n "${{ env.TARGET_CONFIG }}" ]; then
                COMMIT_MSG="$COMMIT_MSG (ç›®æ ‡: ${{ env.TARGET_CONFIG }})"
              fi
              git commit -m "$COMMIT_MSG"
              echo "âœ… é…ç½®æ–‡ä»¶å·²æäº¤åˆ°æœ¬åœ°ä»“åº“: $COMMIT_MSG" | tee -a "$MAIN_LOG"
              
              # æ¨é€åˆ°è¿œç¨‹ä»“åº“
              echo "ğŸ”„ æ¨é€åˆ°è¿œç¨‹ä»“åº“..." | tee -a "$MAIN_LOG"
              git push
              echo "âœ… é…ç½®æ–‡ä»¶å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“" | tee -a "$MAIN_LOG"
            fi
          else
            echo "â„¹ï¸ æ²¡æœ‰åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶" | tee -a "$MAIN_LOG"
          fi

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
        id: upload_artifacts
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Build-Artifacts-${{ github.run_number }}"
          path: |
            /mnt/artifacts
          retention-days: 7
          compression-level: 6

      - name: "ğŸ“Š æé€Ÿæ„å»ºæŠ¥å‘Š"
        id: final_report
        if: always()
        run: |
          echo "=== ğŸ“Š æé€Ÿæ„å»ºæŠ¥å‘Š ==="
          echo ""
          echo "ğŸ¯ æ„å»ºæ‘˜è¦"
          echo "=========================================="
          echo "âš¡ ç¼–è¯‘æ€§èƒ½:"
          echo "  - å¹¶è¡Œä½œä¸š: ${{ env.PARALLEL_JOBS || 'N/A' }}"
          echo "  - CCacheå‘½ä¸­ç‡: æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
          echo ""
          echo "ğŸ“¦ æ„å»ºç»“æœ:"
          echo "  - çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - å›ºä»¶å¤§å°: ${{ env.FIRMWARE_SIZE_MB || 'unknown' }}MB"
          echo "  - äº§ç‰©æ•°é‡: ${{ env.ARTIFACT_COUNT || 0 }}"
          echo ""
          echo "ğŸ”§ é…ç½®ä¿¡æ¯:"
          echo "  - é…ç½®æ¥æº: ${{ env.CONFIG_SOURCE || 'unknown' }}"
          echo "  - ç›®æ ‡é…ç½®: ${{ env.TARGET_CONFIG || 'unknown' }}"
          echo "  - è‡ªåŠ¨æäº¤: ${{ github.event.inputs.auto_commit_config || 'false' }}"
          echo ""
          echo "ğŸ”§ é«˜çº§åŠŸèƒ½:"
          echo "  - è‡ªå®šä¹‰IPK: ${{ env.CUSTOM_IPK_COUNT || 0 }} ä¸ª"
          echo "  - è‡ªå®šä¹‰è„šæœ¬: ${{ env.CUSTOM_SCRIPT_COUNT || 0 }} ä¸ª"
          echo ""
          echo "â±ï¸ æ„å»ºæ—¶é—´:"
          echo "  - å¼€å§‹: è§æ„å»ºæ—¥å¿—"
          echo "  - ç»“æŸ: $(date)"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ] && [ "${{ env.FIRMWARE_COUNT }}" -gt 0 ]; then
            echo "ğŸ‰ æé€Ÿæ„å»ºæˆåŠŸï¼"
            echo "ğŸ’¡ å›ºä»¶å·²ç”Ÿæˆå¹¶ä¸Šä¼ åˆ°äº§ç‰©"
            if [ "${{ env.CONFIG_SOURCE }}" = "new" ] && [ "${{ github.event.inputs.auto_commit_config }}" = "true" ]; then
              echo "ğŸ“ æ–°é…ç½®æ–‡ä»¶å·²è‡ªåŠ¨æäº¤åˆ°ä»“åº“"
            fi
          elif [ "${{ env.BUILD_STATUS }}" = "recovered" ]; then
            echo "âš ï¸ æ„å»ºéƒ¨åˆ†æ¢å¤ï¼Œè¯·æ£€æŸ¥äº§ç‰©å®Œæ•´æ€§"
          else
            echo "âŒ æ„å»ºå¤±è´¥æˆ–æœªç”Ÿæˆå›ºä»¶"
            echo "ğŸ”§ è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£é—®é¢˜"
          fi
          echo "=========================================="
