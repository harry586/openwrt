name: "ğŸš€ è¶…å¿«é€Ÿå›ºä»¶æ„å»ºå™¨ - ä¼˜åŒ–ç‰ˆ"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: "é€‰æ‹©æºç åº“"
        required: true
        type: choice
        options: ["immortalwrt", "openwrt", "lede"]
        default: "immortalwrt"
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "auto"
        type: choice
        options: ["auto", "openwrt-22.03", "openwrt-21.02", "master", "main"]
      config_profile:
        description: "è®¾å¤‡é…ç½®æ–‡ä»¶åç§°"
        required: true
        type: string
        default: "ac42u"
      build_mode:
        description: "æ„å»ºæ¨¡å¼"
        required: true
        type: choice
        options: ["minimal", "standard", "full", "custom"]
        default: "standard"
      build_optimization:
        description: "ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥"
        required: true
        type: choice
        options: ["balanced", "speed", "stability"]
        default: "balanced"
      enable_advanced:
        description: "å¯ç”¨é«˜çº§åŠŸèƒ½"
        required: false
        default: true
        type: boolean
      language_pack:
        description: "è¯­è¨€åŒ…é€‰æ‹©"
        required: true
        type: choice
        options: ["zh-cn", "en-only", "all"]
        default: "zh-cn"
      auto_commit_config:
        description: "è‡ªåŠ¨æäº¤æ–°é…ç½®æ–‡ä»¶"
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/mnt/ccache"
  BUILD_LOG_DIR: "/mnt/build-logs"
  DOWNLOAD_DIR: "/mnt/downloads"

jobs:
  build:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 180
    
    steps:
      - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
        uses: "actions/checkout@v4"
        with:
          path: "config-repo"
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ”§ æé€Ÿç¯å¢ƒåˆå§‹åŒ–"
        id: init
        run: |
          echo "=== ğŸ”§ æé€Ÿç¯å¢ƒåˆå§‹åŒ– ==="
          sudo mkdir -p /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chown -R $USER:$USER /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          sudo chmod -R 755 /mnt/source /mnt/artifacts /mnt/ccache /mnt/build-logs /mnt/downloads
          
          MAIN_LOG="/mnt/build-logs/build_timeline.log"
          ERROR_LOG="/mnt/build-logs/errors.log"
          WARNING_LOG="/mnt/build-logs/warnings.log"
          ANALYSIS_REPORT="/mnt/build-logs/analysis_report.md"
          
          echo "ğŸ æé€Ÿæ„å»ºå¼€å§‹: $(date)" > $MAIN_LOG
          echo "ğŸš€ å·¥ä½œæµç‰ˆæœ¬: è¶…å¿«é€Ÿå›ºä»¶æ„å»ºå™¨ - ä¼˜åŒ–ç‰ˆ" >> $MAIN_LOG
          echo "ğŸ“‹ è¾“å…¥å‚æ•°:" >> $MAIN_LOG
          echo "  - æºç é¢„è®¾: ${{ github.event.inputs.source_preset }}" >> $MAIN_LOG
          echo "  - æºç åˆ†æ”¯: ${{ github.event.inputs.source_branch }}" >> $MAIN_LOG
          echo "  - é…ç½®æ–¹æ¡ˆ: ${{ github.event.inputs.config_profile }}" >> $MAIN_LOG
          echo "  - æ„å»ºæ¨¡å¼: ${{ github.event.inputs.build_mode }}" >> $MAIN_LOG
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}" >> $MAIN_LOG
          echo "  - é«˜çº§åŠŸèƒ½: ${{ github.event.inputs.enable_advanced }}" >> $MAIN_LOG
          echo "  - è¯­è¨€åŒ…: ${{ github.event.inputs.language_pack }}" >> $MAIN_LOG
          echo "  - è‡ªåŠ¨æäº¤é…ç½®: ${{ github.event.inputs.auto_commit_config }}" >> $MAIN_LOG
          echo "==========================================" >> $MAIN_LOG
          
          echo "MAIN_LOG=$MAIN_LOG" >> $GITHUB_ENV
          echo "ERROR_LOG=$ERROR_LOG" >> $GITHUB_ENV
          echo "WARNING_LOG=$WARNING_LOG" >> $GITHUB_ENV
          echo "ANALYSIS_REPORT=$ANALYSIS_REPORT" >> $GITHUB_ENV
          echo "CONFIG_REPO_DIR=${{ github.workspace }}/config-repo" >> $GITHUB_ENV
          echo "BUILD_STATUS=running" >> $GITHUB_ENV
          
          echo "# é”™è¯¯æ—¥å¿—" > $ERROR_LOG
          echo "# è­¦å‘Šæ—¥å¿—" > $WARNING_LOG
          echo "# æ™ºèƒ½åˆ†ææŠ¥å‘Š" > $ANALYSIS_REPORT
          echo "âœ… æé€Ÿç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: "ğŸš€ æé€Ÿä¾èµ–å®‰è£…"
        id: install_deps
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸš€ æé€Ÿä¾èµ–å®‰è£… ===" | tee -a "$MAIN_LOG"
          
          echo "ğŸ“¦ æ‰¹é‡å®‰è£…ç¼–è¯‘ä¾èµ–..." | tee -a "$MAIN_LOG"
          sudo apt-get update -qq
          
          sudo apt-get install -y -qq build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-dev rsync unzip zlib1g-dev file wget jq ccache libtool-bin automake autoconf pkg-config subversion curl cmake ninja-build libelf-dev libxml2-dev liblzma-dev liblzo2-dev axel net-tools e2fsprogs genext2fs dosfstools mtools libffi-dev libsqlite3-dev libpam0g-dev libtirpc-dev libev-dev lm-sensors libsnmp-dev libglib2.0-dev libgpiod-dev libfl-dev upx-ucl
          
          python3 -m pip install --upgrade pip setuptools wheel -q
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ æ€§èƒ½æé€Ÿä¼˜åŒ–"
        id: performance
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== âš¡ æ€§èƒ½æé€Ÿä¼˜åŒ– ===" | tee -a "$MAIN_LOG"
          
          CPU_CORES=$(nproc)
          echo "ğŸ–¥ï¸ æ£€æµ‹åˆ° CPU æ ¸å¿ƒ: $CPU_CORES" | tee -a "$MAIN_LOG"
          
          OPTIMIZATION_STRATEGY="${{ github.event.inputs.build_optimization }}"
          case "$OPTIMIZATION_STRATEGY" in
            "speed")
              CCACHE_SIZE="8G"
              PARALLEL_JOBS=$((CPU_CORES + 2))
              echo "ğŸš€ æé€Ÿæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            "stability")
              CCACHE_SIZE="4G"
              PARALLEL_JOBS=$((CPU_CORES / 2))
              echo "ğŸ›¡ï¸ ç¨³å®šæ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
            *)
              CCACHE_SIZE="6G"
              PARALLEL_JOBS=$CPU_CORES
              echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: CCache=${CCACHE_SIZE}, å¹¶è¡Œä½œä¸š=${PARALLEL_JOBS}" | tee -a "$MAIN_LOG"
              ;;
          esac
          
          mkdir -p /mnt/ccache
          ccache -M $CCACHE_SIZE
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=100000
          
          echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          
          echo "ğŸ’¾ åˆ›å»ºäº¤æ¢æ–‡ä»¶..." | tee -a "$MAIN_LOG"
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          sudo fallocate -l 8G /mnt/swapfile && sudo chmod 600 /mnt/swapfile && sudo mkswap /mnt/swapfile && sudo swapon /mnt/swapfile
          
          echo "ğŸ“Š ç³»ç»Ÿèµ„æºçŠ¶æ€:" | tee -a "$MAIN_LOG"
          free -h | tee -a "$MAIN_LOG"
          echo "âœ… æ€§èƒ½ä¼˜åŒ–å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ æé€Ÿæºç è·å–"
        id: source_setup
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== âš¡ æé€Ÿæºç è·å– ===" | tee -a "$MAIN_LOG"
          
          REPO_JSON_FOUND="${{ env.CONFIG_REPO_DIR }}/firmware-config/repositories.json"
          PRESET="${{ github.event.inputs.source_preset }}"
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_FOUND")
          BRANCH="${{ github.event.inputs.source_branch }}"
          
          if [ "$BRANCH" = "auto" ]; then
            BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_FOUND")
          fi
          
          echo "ğŸ“¦ æé€Ÿå…‹éš†æºç ..." | tee -a "$MAIN_LOG"
          cd /mnt/source
          rm -rf .[!.]* *
          
          git clone --depth 1 --branch "$BRANCH" --single-branch --progress "$SOURCE_URL" . || {
            echo "ğŸ”„ åˆ†æ”¯å…‹éš†å¤±è´¥ï¼Œå°è¯•masteråˆ†æ”¯..." | tee -a "$MAIN_LOG"
            git clone --depth 1 --progress "$SOURCE_URL" .
            git checkout "$BRANCH" 2>/dev/null || true
          }
          
          ACTUAL_BRANCH=$(git branch --show-current)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "âœ… æºç è·å–å®Œæˆ: $ACTUAL_BRANCH@$COMMIT_HASH" | tee -a "$MAIN_LOG"

      - name: "ğŸ›ï¸ æ¨¡å¼é…ç½®æ–‡ä»¶å¤„ç†"
        id: mode_config
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ›ï¸ æ¨¡å¼é…ç½®æ–‡ä»¶å¤„ç† ===" | tee -a "$MAIN_LOG"
          
          BUILD_MODE="${{ github.event.inputs.build_mode }}"
          CONFIG_REPO="${{ env.CONFIG_REPO_DIR }}"
          MODE_CONFIG_DIR="$CONFIG_REPO/firmware-config/modes"
          
          echo "ğŸ¯ æ„å»ºæ¨¡å¼: $BUILD_MODE" | tee -a "$MAIN_LOG"
          
          mkdir -p "$MODE_CONFIG_DIR"
          
          case "$BUILD_MODE" in
            "minimal")
              echo "ğŸ”§ åˆ›å»ºæœ€å°åŒ–æ¨¡å¼é…ç½®..." | tee -a "$MAIN_LOG"
              echo "# ============================================" > "$MODE_CONFIG_DIR/minimal.conf"
              echo "# æœ€å°åŒ–æ„å»ºæ¨¡å¼é…ç½®" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "# ============================================" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "# åŸºç¡€ç³»ç»Ÿé…ç½®" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_base-files=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_busybox=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_dropbear=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_firewall=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_fstools=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_libc=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_libgcc=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_logd=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_mtd=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_netifd=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_opkg=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_procd=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_swconfig=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_ubox=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_ubus=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_ubusd=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_uci=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_uclient-fetch=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_urandom-seed=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              echo "CONFIG_PACKAGE_usign=y" >> "$MODE_CONFIG_DIR/minimal.conf"
              ;;
            
            "standard")
              echo "ğŸ”§ åˆ›å»ºæ ‡å‡†æ¨¡å¼é…ç½®..." | tee -a "$MAIN_LOG"
              echo "# ============================================" > "$MODE_CONFIG_DIR/standard.conf"
              echo "# æ ‡å‡†æ„å»ºæ¨¡å¼é…ç½®" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "# ============================================" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "# åŸºç¡€ç³»ç»Ÿé…ç½®" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_base-files=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_busybox=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_dropbear=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_firewall=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_fstools=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_libc=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_libgcc=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_logd=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_mtd=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_netifd=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_opkg=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_procd=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_swconfig=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_ubox=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_ubus=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_ubusd=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_uci=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_uclient-fetch=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_urandom-seed=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_usign=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "# å®Œæ•´ç½‘ç»œæ”¯æŒ" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_dnsmasq-full=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_iptables=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_iptables-mod-nat-extra=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-ipt-core=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-ipt-ipset=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-ipt-nat=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-ipt-offload=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-nf-conntrack=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-nf-conntrack6=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-nf-flow=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-nf-ipt=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-nf-nat=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-nf-reject=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-nf-reject6=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_odhcp6c=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "# å®Œæ•´æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_block-mount=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-fs-autofs4=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-fs-btrfs=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-fs-exfat=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-fs-f2fs=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-fs-ntfs=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-fuse=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "# å®Œæ•´æ— çº¿æ”¯æŒ" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-ath=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-ath10k=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-ath9k=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-ath9k-common=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-cfg80211=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-mac80211=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_hostapd-common=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "# USBæ”¯æŒ" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-usb-core=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-usb-storage-extras=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-usb2=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_kmod-usb3=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "# LUCIåº”ç”¨" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_luci=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_luci-app-firewall=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_luci-app-opkg=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_luci-base=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_luci-compat=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_luci-mod-admin-full=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_luci-proto-ipv6=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_luci-proto-ppp=y" >> "$MODE_CONFIG_DIR/standard.conf"
              echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> "$MODE_CONFIG_DIR/standard.conf"
              ;;
            
            "full")
              echo "ğŸ”§ åˆ›å»ºå®Œæ•´æ¨¡å¼é…ç½®..." | tee -a "$MAIN_LOG"
              echo "# ============================================" > "$MODE_CONFIG_DIR/full.conf"
              echo "# å®Œæ•´æ„å»ºæ¨¡å¼é…ç½®" >> "$MODE_CONFIG_DIR/full.conf"
              echo "# ============================================" >> "$MODE_CONFIG_DIR/full.conf"
              echo "" >> "$MODE_CONFIG_DIR/full.conf"
              echo "# åŸºç¡€ç³»ç»Ÿé…ç½®" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_base-files=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_busybox=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_dropbear=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_firewall=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_fstools=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_libc=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_libgcc=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_logd=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_mtd=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_netifd=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_opkg=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_procd=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_swconfig=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_ubox=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_ubus=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_ubusd=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_uci=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_uclient-fetch=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_urandom-seed=y" >> "$MODE_CONFIG_DIR/full.conf"
              echo "CONFIG_PACKAGE_usign=y" >> "$MODE_CONFIG_DIR/full.conf"
              ;;
            
            "custom")
              echo "ğŸ”§ åˆ›å»ºè‡ªå®šä¹‰æ¨¡å¼é…ç½®..." | tee -a "$MAIN_LOG"
              echo "# ============================================" > "$MODE_CONFIG_DIR/custom.conf"
              echo "# è‡ªå®šä¹‰æ„å»ºæ¨¡å¼é…ç½®" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "# ============================================" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "# åŸºç¡€ç³»ç»Ÿï¼ˆå¿…é€‰ï¼‰" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_base-files=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_busybox=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_dropbear=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_firewall=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_fstools=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_libc=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_libgcc=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_logd=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_netifd=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_opkg=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_procd=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_ubox=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_ubus=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_ubusd=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_uci=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_uclient-fetch=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_urandom-seed=y" >> "$MODE_CONFIG_DIR/custom.conf"
              echo "CONFIG_PACKAGE_usign=y" >> "$MODE_CONFIG_DIR/custom.conf"
              ;;
          esac
          
          echo "BUILD_MODE=$BUILD_MODE" >> $GITHUB_ENV
          echo "MODE_CONFIG_DIR=$MODE_CONFIG_DIR" >> $GITHUB_ENV
          echo "âœ… æ¨¡å¼é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ: $BUILD_MODE" | tee -a "$MAIN_LOG"

      - name: "ğŸ“ æ™ºèƒ½é…ç½®åˆ›å»ºä¸å¤„ç†"
        id: config_creation
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“ æ™ºèƒ½é…ç½®åˆ›å»ºä¸å¤„ç† ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          CONFIG_DIR="${{ env.CONFIG_REPO_DIR }}/firmware-config/configs"
          CONFIG_FILE="$CONFIG_DIR/config_$CONFIG_PROFILE"
          MODE_CONFIG="${{ env.MODE_CONFIG_DIR }}/${{ github.event.inputs.build_mode }}.conf"
          
          echo "ğŸ” æŸ¥æ‰¾é…ç½®æ–‡ä»¶: $CONFIG_FILE" | tee -a "$MAIN_LOG"
          echo "ğŸ›ï¸ åº”ç”¨æ¨¡å¼é…ç½®: $MODE_CONFIG" | tee -a "$MAIN_LOG"
          
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" .config
            echo "âœ… åº”ç”¨ç°æœ‰é…ç½®æ–‡ä»¶: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
            echo "CONFIG_SOURCE=existing" >> $GITHUB_ENV
          else
            echo "ğŸ”§ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°é…ç½®..." | tee -a "$MAIN_LOG"
            mkdir -p "$CONFIG_DIR"
            
            echo "ğŸ¯ æ™ºèƒ½åˆ†æè®¾å¤‡åç§°: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
            
            echo "# =============================================" > "$CONFIG_FILE"
            echo "# é€šç”¨è®¾å¤‡é…ç½® - $CONFIG_PROFILE" >> "$CONFIG_FILE"
            echo "# è‡ªåŠ¨ç”Ÿæˆäº $(date)" >> "$CONFIG_FILE"
            echo "# =============================================" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# åŸºç¡€ç›®æ ‡é…ç½®" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"

            TARGET_CONFIG=""
            if [[ "$CONFIG_PROFILE" =~ ^rt-ac42u$|^ac42u$|^asus.*ac42u ]]; then
              echo "# ASUS RT-AC42U è®¾å¤‡ (IPQ40xx)" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx_generic=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ipq40xx_asus_rt-ac42u"
            elif [[ "$CONFIG_PROFILE" =~ ^x86|^x64|^generic.*64 ]]; then
              echo "# x86/x64 é€šç”¨è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86_64=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="x86_64_generic"
            elif [[ "$CONFIG_PROFILE" =~ ^mt7621|^newifi.*d2|^r6220 ]]; then
              echo "# MT7621 è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_ramips_mt7621_DEVICE_xxx=y è¯·æ ¹æ®å…·ä½“è®¾å¤‡è®¾ç½®" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621"
            elif [[ "$CONFIG_PROFILE" =~ ^r3g|^mir3g|^xiaomi.*r3g ]]; then
              echo "# Xiaomi R3G è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-3g=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621_xiaomi_r3g"
            elif [[ "$CONFIG_PROFILE" =~ ^r3p|^mir3p|^xiaomi.*r3p ]]; then
              echo "# Xiaomi R3P è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$MAIN_LOG"
              echo "CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-3-pro=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621_xiaomi_r3p"
            elif [[ "$CONFIG_PROFILE" =~ ^k2p|^phicomm.*k2p ]]; then
              echo "# Phicomm K2P è®¾å¤‡" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621=y" >> "$CONFIG_FILE"
              echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="ramips_mt7621_phicomm_k2p"
            else
              echo "# é€šç”¨è®¾å¤‡é…ç½® - è¯·æ ¹æ®å®é™…è®¾å¤‡ä¿®æ”¹" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx_yyy=y" >> "$CONFIG_FILE"
              echo "# CONFIG_TARGET_xxx_yyy_DEVICE_zzz=y" >> "$CONFIG_FILE"
              TARGET_CONFIG="generic"
            fi
            
            echo "" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "# é•œåƒé…ç½®" >> "$CONFIG_FILE"
            echo "# ======================" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_IMAGES_GZIP=y" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_IMAGES_INCLUDE_FACTORY=y" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_IMAGES_INCLUDE_SYSUPGRADE=y" >> "$CONFIG_FILE"
            echo "" >> "$CONFIG_FILE"
            echo "# åˆ†åŒºå¤§å°" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> "$CONFIG_FILE"
            echo "CONFIG_TARGET_ROOTFS_PARTSIZE=96" >> "$CONFIG_FILE"
            
            cp "$CONFIG_FILE" .config
            echo "CONFIG_SOURCE=new" >> $GITHUB_ENV
            echo "TARGET_CONFIG=$TARGET_CONFIG" >> $GITHUB_ENV
            echo "âœ… å·²åˆ›å»ºæ™ºèƒ½é…ç½®æ–‡ä»¶: $CONFIG_FILE" | tee -a "$MAIN_LOG"
            echo "ğŸ¯ ç›®æ ‡é…ç½®ç±»å‹: $TARGET_CONFIG" | tee -a "$MAIN_LOG"
          fi
          
          if [ -f "$MODE_CONFIG" ]; then
            echo "ğŸ”§ åº”ç”¨æ¨¡å¼é…ç½®æ–‡ä»¶..." | tee -a "$MAIN_LOG"
            cat "$MODE_CONFIG" >> .config
            echo "âœ… æ¨¡å¼é…ç½®åº”ç”¨å®Œæˆ: ${{ github.event.inputs.build_mode }}" | tee -a "$MAIN_LOG"
          else
            echo "âš ï¸ æ¨¡å¼é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $MODE_CONFIG" | tee -a "$MAIN_LOG"
          fi
          
          echo "âš¡ é¢„é…ç½®ä¼˜åŒ–é€‰é¡¹..." | tee -a "$MAIN_LOG"
          echo "# ç¼–è¯‘ä¼˜åŒ–" >> .config
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "# CONFIG_DEBUG=y is not set" >> .config
          
          echo "âœ… é…ç½®åˆ›å»ºä¸å¤„ç†å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ åŠ¨æ€è®¾å¤‡é…ç½®ä¿®å¤"
        id: dynamic_device_fix
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ åŠ¨æ€è®¾å¤‡é…ç½®ä¿®å¤ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "ğŸ¯ åŠ¨æ€ä¿®å¤è®¾å¤‡é…ç½®: $CONFIG_PROFILE" | tee -a "$MAIN_LOG"
          
          echo "# ======================" >> .config
          echo "# åŠ¨æ€è®¾å¤‡é…ç½®ä¿®å¤" >> .config
          echo "# ======================" >> .config
          
          if [[ "$CONFIG_PROFILE" =~ ^rt-ac42u$|^ac42u$|^asus.*ac42u ]]; then
            echo "# IPQ40xxé€šç”¨ä¿®å¤" >> .config
            echo "CONFIG_TARGET_ipq40xx=y" >> .config
            echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
            echo "CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y" >> .config
            echo "CONFIG_KERNEL_ARM=y" >> .config
            echo "CONFIG_KERNEL_ARM_CPU_NEON=y" >> .config
            echo "CONFIG_KERNEL_ARM_CPU_NEON_FP=y" >> .config
          elif [[ "$CONFIG_PROFILE" =~ ^x86|^x64|^generic.*64 ]]; then
            echo "# x86é€šç”¨ä¿®å¤" >> .config
            echo "CONFIG_TARGET_x86=y" >> .config
            echo "CONFIG_TARGET_x86_64=y" >> .config
            echo "CONFIG_KERNEL_X86=y" >> .config
            echo "CONFIG_KERNEL_X86_64=y" >> .config
          elif [[ "$CONFIG_PROFILE" =~ ^mt7621|^newifi.*d2|^r6220|^r3g|^r3p|^k2p ]]; then
            echo "# MT7621é€šç”¨ä¿®å¤" >> .config
            echo "CONFIG_TARGET_ramips=y" >> .config
            echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
            echo "CONFIG_KERNEL_MIPS=y" >> .config
            echo "CONFIG_KERNEL_MIPS_MT7621=y" >> .config
          else
            echo "# é€šç”¨å†…æ ¸ä¿®å¤" >> .config
            echo "CONFIG_KERNEL_DEVTMPFS=y" >> .config
            echo "CONFIG_KERNEL_DEVTMPFS_MOUNT=y" >> .config
          fi
          
          echo "# é€šç”¨å†…æ ¸ç‰¹æ€§" >> .config
          echo "CONFIG_KERNEL_LZO=y" >> .config
          echo "CONFIG_KERNEL_LZ4=y" >> .config
          echo "CONFIG_KERNEL_ZSTD=y" >> .config
          echo "CONFIG_KERNEL_EXT4_FS=y" >> .config
          echo "CONFIG_KERNEL_VFAT_FS=y" >> .config
          echo "CONFIG_KERNEL_TMPFS=y" >> .config
          echo "CONFIG_KERNEL_NET=y" >> .config
          echo "CONFIG_KERNEL_INET=y" >> .config
          echo "CONFIG_KERNEL_IPV6=y" >> .config
          
          echo "âœ… åŠ¨æ€è®¾å¤‡é…ç½®ä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ æ„å»ºé—®é¢˜ä¿®å¤"
        id: build_problem_fix
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ æ„å»ºé—®é¢˜ä¿®å¤ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ ä¿®å¤å·²çŸ¥æ„å»ºé—®é¢˜..." | tee -a "$MAIN_LOG"
          
          PROBLEM_PKGS=("6in4" "6rd" "6to4" "ds-lite" "map")
          for pkg in "${PROBLEM_PKGS[@]}"; do
            sed -i "s/CONFIG_PACKAGE_${pkg}=y/# CONFIG_PACKAGE_${pkg} is not set/" .config 2>/dev/null || true
          done
          
          echo "# æ„å»ºé—®é¢˜ä¿®å¤" >> .config
          echo "# CONFIG_PACKAGE_6in4 is not set" >> .config
          echo "# CONFIG_PACKAGE_6rd is not set" >> .config
          echo "# CONFIG_PACKAGE_6to4 is not set" >> .config
          echo "# CONFIG_PACKAGE_ds-lite is not set" >> .config
          echo "# CONFIG_PACKAGE_map is not set" >> .config
          
          echo "âœ… æ„å»ºé—®é¢˜ä¿®å¤å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "ğŸ”§ ç¼–è¯‘ç¯å¢ƒå‡†å¤‡"
        id: build_env_prepare
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ”§ ç¼–è¯‘ç¯å¢ƒå‡†å¤‡ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          echo "ğŸ”§ å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ..." | tee -a "$MAIN_LOG"
          
          mkdir -p build_dir/target-* staging_dir/target-* staging_dir/toolchain-*
          find build_dir -type d -exec chmod 755 {} \;
          find staging_dir -type d -exec chmod 755 {} \;
          
          chmod +x staging_dir/host/bin/* 2>/dev/null || true
          chmod +x staging_dir/toolchain-*/bin/* 2>/dev/null || true
          
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå‡†å¤‡å®Œæˆ" | tee -a "$MAIN_LOG"

      - name: "âš¡ ç¨³å¥ç¼–è¯‘æ‰§è¡Œ"
        id: robust_build
        timeout-minutes: 150
        run: |
          set -e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          ERROR_LOG="${{ env.ERROR_LOG }}"
          echo "=== âš¡ ç¨³å¥ç¼–è¯‘æ‰§è¡Œ ===" | tee -a "$MAIN_LOG"
          cd /mnt/source
          
          export FORCE_UNSAFE_CONFIGURE=1
          export LC_ALL=C
          PARALLEL_JOBS="${{ env.PARALLEL_JOBS }}"
          
          echo "ğŸ”§ ç¼–è¯‘é…ç½®: å¹¶è¡Œä½œä¸š=$PARALLEL_JOBS" | tee -a "$MAIN_LOG"
          
          echo "ğŸ” ç¼–è¯‘å‰æœ€ç»ˆæ£€æŸ¥..." | tee -a "$MAIN_LOG"
          make defconfig
          
          mkdir -p logs
          
          echo "ğŸ› ï¸ é˜¶æ®µ1: å·¥å…·é“¾ç¼–è¯‘..." | tee -a "$MAIN_LOG"
          if ! make toolchain/install -j$PARALLEL_JOBS 2>&1 | tee -a "$MAIN_LOG"; then
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..." | tee -a "$MAIN_LOG"
            make toolchain/install -j1 V=s 2>&1 | tee -a "$MAIN_LOG"
          fi
          
          echo "ğŸ› ï¸ é˜¶æ®µ2: å†…æ ¸ç¼–è¯‘..." | tee -a "$MAIN_LOG"
          if ! make target/linux/install -j$PARALLEL_JOBS 2>&1 | tee -a "$MAIN_LOG"; then
            echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..." | tee -a "$MAIN_LOG"
            make target/linux/install -j1 V=s 2>&1 | tee -a "$MAIN_LOG"
          fi
          
          echo "ğŸš€ é˜¶æ®µ3: å®Œæ•´ç¼–è¯‘..." | tee -a "$MAIN_LOG"
          TEMP_LOG=$(mktemp)
          set +e
          make -j$PARALLEL_JOBS 2>&1 | tee "$TEMP_LOG"
          BUILD_RESULT=${PIPESTATUS[0]}
          set -e
          
          cat "$TEMP_LOG" >> "$MAIN_LOG"
          
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ" | tee -a "$MAIN_LOG"
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ (é€€å‡ºç : $BUILD_RESULT)" | tee -a "$MAIN_LOG"
            echo "=== è¯¦ç»†é”™è¯¯æ—¥å¿—å¼€å§‹ ===" >> "$ERROR_LOG"
            make -j1 V=s 2>&1 >> "$ERROR_LOG" || true
            echo "=== è¯¦ç»†é”™è¯¯æ—¥å¿—ç»“æŸ ===" >> "$ERROR_LOG"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            exit $BUILD_RESULT
          fi
          rm -f "$TEMP_LOG"
          
          FIRMWARE_FOUND=false
          if find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | grep -q .; then
            echo "ğŸ‰ æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼" | tee -a "$MAIN_LOG"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) -exec ls -la {} \; | tee -a "$MAIN_LOG"
            FIRMWARE_FOUND=true
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶" | tee -a "$MAIN_LOG"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            find bin -type f -name "*" 2>/dev/null | head -20 | tee -a "$MAIN_LOG"
            exit 1
          fi
          
          echo "FIRMWARE_FOUND=$FIRMWARE_FOUND" >> $GITHUB_ENV
          
          echo "ğŸ“Š CCacheç»Ÿè®¡:" | tee -a "$MAIN_LOG"
          ccache -s | tee -a "$MAIN_LOG"
          
          echo "=== ç¼–è¯‘æ€»ç»“ ===" | tee -a "$MAIN_LOG"
          echo "æ„å»ºçŠ¶æ€: $BUILD_STATUS" | tee -a "$MAIN_LOG"
          echo "å›ºä»¶ç”Ÿæˆ: $FIRMWARE_FOUND" | tee -a "$MAIN_LOG"

      - name: "ğŸ“¦ äº§ç‰©æ”¶é›†"
        id: collect_artifacts
        if: always()
        run: |
          set +e
          MAIN_LOG="${{ env.MAIN_LOG }}"
          echo "=== ğŸ“¦ äº§ç‰©æ”¶é›† ===" | tee -a "$MAIN_LOG"
          
          mkdir -p /mnt/artifacts/firmware
          ARTIFACT_COUNT=0
          
          if [ -d "/mnt/source/bin/targets" ]; then
            find /mnt/source/bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) -exec cp {} /mnt/artifacts/firmware/ \;
            ARTIFACT_COUNT=$(ls /mnt/artifacts/firmware/ 2>/dev/null | wc -l || echo 0)
          fi
          
          cp "$MAIN_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp "$ERROR_LOG" /mnt/artifacts/ 2>/dev/null || true
          cp /mnt/source/.config /mnt/artifacts/ 2>/dev/null || true
          
          echo "ARTIFACT_COUNT=$ARTIFACT_COUNT" >> $GITHUB_ENV
          echo "âœ… æ”¶é›†äº† $ARTIFACT_COUNT ä¸ªäº§ç‰©" | tee -a "$MAIN_LOG"

      - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
        id: upload_artifacts
        if: always()
        uses: "actions/upload-artifact@v4"
        with:
          name: "Build-Artifacts-${{ github.run_number }}"
          path: |
            /mnt/artifacts
          retention-days: 7
          compression-level: 6

      - name: "ğŸ“Š æ„å»ºæŠ¥å‘Š"
        id: final_report
        if: always()
        run: |
          echo "=== ğŸ“Š æ„å»ºæŠ¥å‘Š ==="
          echo ""
          echo "ğŸ¯ æ„å»ºæ‘˜è¦"
          echo "=========================================="
          echo "ğŸ“¦ æ„å»ºç»“æœ:"
          echo "  - çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo "  - äº§ç‰©æ•°é‡: ${{ env.ARTIFACT_COUNT || 0 }}"
          echo ""
          echo "ğŸ”§ é…ç½®ä¿¡æ¯:"
          echo "  - é…ç½®æ¥æº: ${{ env.CONFIG_SOURCE || 'unknown' }}"
          echo "  - ç›®æ ‡é…ç½®: ${{ env.TARGET_CONFIG || 'unknown' }}"
          echo "  - æ„å»ºæ¨¡å¼: ${{ github.event.inputs.build_mode || 'unknown' }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ] && [ "${{ env.FIRMWARE_COUNT }}" -gt 0 ]; then
            echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
            echo "ğŸ’¡ å›ºä»¶å·²ç”Ÿæˆå¹¶ä¸Šä¼ åˆ°äº§ç‰©"
          else
            echo "âŒ æ„å»ºå¤±è´¥æˆ–æœªç”Ÿæˆå›ºä»¶"
            echo "ğŸ”§ è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£é—®é¢˜"
          fi
          echo "=========================================="
