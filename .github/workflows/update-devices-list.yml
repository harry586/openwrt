# 更新支持的设备列表工作流
# 功能：自动从多个OpenWrt源码仓库提取设备信息并生成支持列表
# 支持：immortalwrt、LEDE、OpenWrt官方源码（使用镜像源）

name: 更新支持的设备列表

on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 0 * * 1'  # 每周一凌晨运行

env:
  BUILD_DIR: /mnt/device-list  # 临时构建目录

jobs:
  update-device-list:
    runs-on: ubuntu-latest
    
    steps:
    # 代码检出步骤
    - name: 检出当前仓库
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史记录

    # 环境设置步骤
    - name: 设置编译环境
      run: |
        echo "=== 安装必要的依赖包 ==="
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev git curl jq python3

    # 目录准备步骤
    - name: 创建构建目录
      run: |
        echo "=== 创建临时构建目录 ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR

    # 源码克隆步骤 - immortalwrt (使用GitHub镜像，通常比较稳定)
    - name: 克隆immortalwrt源码
      run: |
        cd $BUILD_DIR
        echo "=== 克隆immortalwrt源码 ==="
        # 设置重试机制
        max_attempts=3
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          echo "尝试克隆immortalwrt (第 $attempt 次)..."
          if git clone --depth 1 https://github.com/immortalwrt/immortalwrt.git immortalwrt; then
            echo "✅ immortalwrt源码克隆成功"
            break
          else
            echo "❌ 第 $attempt 次克隆失败"
            if [ $attempt -eq $max_attempts ]; then
              echo "❌ 达到最大重试次数，immortalwrt克隆失败"
              exit 1
            fi
            attempt=$((attempt + 1))
            sleep 5  # 等待5秒后重试
          fi
        done

    # 源码克隆步骤 - LEDE (使用GitHub镜像)
    - name: 克隆LEDE源码
      run: |
        cd $BUILD_DIR
        echo "=== 克隆LEDE源码 ==="
        # 设置重试机制
        max_attempts=3
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          echo "尝试克隆LEDE (第 $attempt 次)..."
          if git clone --depth 1 https://github.com/coolsnowwolf/lede.git lede; then
            echo "✅ LEDE源码克隆成功"
            break
          else
            echo "❌ 第 $attempt 次克隆失败"
            if [ $attempt -eq $max_attempts ]; then
              echo "❌ 达到最大重试次数，LEDE克隆失败"
              exit 1
            fi
            attempt=$((attempt + 1))
            sleep 5  # 等待5秒后重试
          fi
        done

    # 源码克隆步骤 - OpenWrt (使用GitHub镜像替代不稳定的官方源)
    - name: 克隆OpenWrt源码
      run: |
        cd $BUILD_DIR
        echo "=== 克隆OpenWrt源码 ==="
        
        # 定义多个镜像源，按优先级尝试
        OPENWRT_MIRRORS=(
          "https://github.com/openwrt/openwrt.git"  # GitHub镜像 (推荐)
          "https://git.openwrt.org/openwrt/openwrt.git"  # 官方源 (备用)
        )
        
        max_attempts=3
        attempt=1
        mirror_index=0
        
        while [ $attempt -le $max_attempts ] && [ $mirror_index -lt ${#OPENWRT_MIRRORS[@]} ]; do
          current_mirror=${OPENWRT_MIRRORS[$mirror_index]}
          echo "尝试从镜像源克隆OpenWrt (第 $attempt 次，镜像 $((mirror_index + 1))/${#OPENWRT_MIRRORS[@]})..."
          echo "镜像地址: $current_mirror"
          
          if git clone --depth 1 "$current_mirror" openwrt; then
            echo "✅ OpenWrt源码克隆成功 (使用镜像: $current_mirror)"
            break
          else
            echo "❌ 第 $attempt 次克隆失败 (镜像: $current_mirror)"
            
            # 清理失败的克隆目录
            rm -rf openwrt
            
            if [ $attempt -eq $max_attempts ]; then
              # 当前镜像尝试次数用完，切换到下一个镜像
              mirror_index=$((mirror_index + 1))
              attempt=1
              if [ $mirror_index -ge ${#OPENWRT_MIRRORS[@]} ]; then
                echo "⚠️ 所有镜像源都尝试失败，跳过OpenWrt源码"
                echo "将继续处理其他仓库的设备列表..."
                break
              fi
            else
              attempt=$((attempt + 1))
            fi
            sleep 5  # 等待5秒后重试
          fi
        done

    # 源码验证步骤 - 确保所有必要的源码都已成功克隆
    - name: 验证源码克隆结果
      run: |
        cd $BUILD_DIR
        echo "=== 验证源码克隆结果 ==="
        
        REPOS=("immortalwrt" "lede" "openwrt")
        success_count=0
        
        for repo in "${REPOS[@]}"; do
          if [ -d "$repo" ] && [ -f "$repo/.git/config" ]; then
            echo "✅ $repo: 源码目录存在且包含git配置"
            success_count=$((success_count + 1))
            # 显示仓库信息
            cd "$repo"
            echo "   - 远程URL: $(git config --get remote.origin.url)"
            echo "   - 最新提交: $(git log -1 --oneline --no-color 2>/dev/null || echo '无法获取提交信息')"
            cd ..
          else
            echo "⚠️ $repo: 源码目录不存在或损坏，跳过该仓库"
          fi
          echo ""
        done
        
        if [ $success_count -eq 0 ]; then
          echo "❌ 所有源码仓库克隆失败，无法生成设备列表"
          exit 1
        else
          echo "✅ 成功克隆 $success_count/${#REPOS[@]} 个源码仓库"
        fi

    # 设备列表生成步骤
    - name: 生成设备列表
      run: |
        cd $BUILD_DIR
        echo "=== 生成设备列表 ==="
        
        # 创建Python脚本用于解析设备信息
        cat > generate_device_list.py << 'EOF'
        #!/usr/bin/env python3
        """
        设备列表生成脚本
        功能：从OpenWrt源码中提取设备定义信息并生成Markdown格式的支持列表
        支持：immortalwrt、LEDE、OpenWrt官方源码
        """
        
        import os
        import glob
        import re
        from pathlib import Path
        import datetime

        # 设备别名映射表
        # 将通用设备名称映射到具体的设备标识符
        device_aliases = {
            # ASUS 设备别名映射
            "asus_rt-ac42u": ["ac42u", "acrh17", "rt-acrh17"],
            "asus_rt-ac58u": ["ac58u", "acrh13", "rt-acrh13"],
            "asus_rt-acrh17": ["acrh17", "rt-acrh17"],
            "asus_rt-acrh13": ["acrh13", "rt-acrh13"],
            # 其他常见设备别名可以在这里添加
        }

        def reverse_alias_map(aliases):
            """生成反向别名映射"""
            reverse_map = {}
            for main_device, alias_list in aliases.items():
                for alias in alias_list:
                    reverse_map[alias] = main_device
            return reverse_map

        def parse_device_info(mk_file):
            """
            解析设备定义文件
            从Makefile中提取设备名称、厂商、型号等信息
            """
            devices = []
            try:
                with open(mk_file, 'r', encoding='utf-8', errors='ignore') as f:
                    content = f.read()
                
                # 查找所有设备定义块
                device_blocks = re.findall(r'define\s+Device/(.+?)\n(.*?)\nendef', content, re.DOTALL)
                
                for device_name, device_content in device_blocks:
                    device_info = {
                        'name': device_name.strip(),
                        'vendor': '',
                        'model': '',
                        'title': '',
                        'aliases': []
                    }
                    
                    # 提取设备信息
                    vendor_match = re.search(r'DEVICE_VENDOR\s*:?=\s*(.+)', device_content)
                    model_match = re.search(r'DEVICE_MODEL\s*:?=\s*(.+)', device_content)
                    title_match = re.search(r'DEVICE_TITLE\s*:?=\s*(.+)', device_content)
                    alt_match = re.search(r'DEVICE_ALT\w*_VENDOR\s*:?=\s*(.+)', device_content)
                    
                    if vendor_match:
                        device_info['vendor'] = vendor_match.group(1).strip()
                    if model_match:
                        device_info['model'] = model_match.group(1).strip()
                    if title_match:
                        device_info['title'] = title_match.group(1).strip()
                    
                    # 查找别名
                    if device_info['name'] in device_aliases:
                        device_info['aliases'] = device_aliases[device_info['name']]
                    
                    devices.append(device_info)
                    
            except Exception as e:
                print(f"解析文件 {mk_file} 时出错: {e}")
            
            return devices

        def generate_markdown_table(repo_name, devices):
            """生成Markdown格式的设备表格"""
            if not devices:
                return f"### {repo_name}\n\n暂无支持的设备数据\n\n"
            
            table = f"### {repo_name}\n\n"
            table += "| 序号 | 平台 | 设备名称 | 通用别名 | 备注 |\n"
            table += "|------|------|----------|----------|------|\n"
            
            for idx, device in enumerate(devices, 1):
                platform = device.get('platform', 'unknown')
                name = device['name']
                aliases = ', '.join(device['aliases']) if device['aliases'] else '-'
                title = device.get('title', '') or f"{device.get('vendor', '')} {device.get('model', '')}".strip()
                note = title if title else '-'
                
                table += f"| {idx} | {platform} | `{name}` | {aliases} | {note} |\n"
            
            return table + "\n"

        def main():
            """主函数"""
            # 定义要处理的源码仓库
            repos = {
                'immortalwrt': 'immortalwrt',
                'LEDE': 'lede', 
                'OpenWrt': 'openwrt'
            }
            
            all_devices = []
            repo_stats = {}
            
            # 处理每个仓库
            for repo_name, repo_dir in repos.items():
                repo_path = Path(repo_dir)
                if not repo_path.exists():
                    print(f"⚠️ 仓库 {repo_name} 不存在，跳过")
                    repo_stats[repo_name] = 0
                    continue
                
                print(f"🔍 处理 {repo_name}...")
                repo_devices = []
                
                # 查找所有平台目录
                target_linux = repo_path / "target" / "linux"
                if target_linux.exists():
                    for platform_dir in target_linux.iterdir():
                        if platform_dir.is_dir() and not platform_dir.name.startswith('.'):
                            platform = platform_dir.name
                            
                            # 查找所有的 .mk 文件
                            mk_files = list(platform_dir.glob("**/*.mk"))
                            
                            print(f"  平台 {platform}: 找到 {len(mk_files)} 个mk文件")
                            
                            for mk_file in mk_files:
                                devices = parse_device_info(mk_file)
                                for device in devices:
                                    device['platform'] = platform
                                    device['repo'] = repo_name
                                    repo_devices.append(device)
                else:
                    print(f"⚠️  {repo_name} 没有 target/linux 目录")
                
                repo_stats[repo_name] = len(repo_devices)
                all_devices.extend(repo_devices)
                
                # 为当前仓库生成表格
                table_content = generate_markdown_table(repo_name, repo_devices)
                
                # 保存到文件
                output_file = f"device_list_{repo_name.lower()}.md"
                with open(output_file, 'w', encoding='utf-8') as f:
                    f.write(table_content)
                
                print(f"✅ 生成 {output_file}，包含 {len(repo_devices)} 个设备")
            
            # 生成汇总文件
            with open("supports.md", 'w', encoding='utf-8') as f:
                # 文件头部信息
                f.write("# 源码支持设备列表\n\n")
                f.write("> 本文件自动生成，列出各源码仓库支持的设备信息\n\n")
                
                # 生成时间
                current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                f.write(f"**最后更新时间**: {current_time}\n\n")
                
                # 统计信息
                f.write("## 统计概览\n\n")
                total_devices = sum(repo_stats.values())
                f.write(f"**总设备数量**: {total_devices}\n\n")
                
                for repo_name, count in repo_stats.items():
                    f.write(f"- **{repo_name}**: {count} 个设备\n")
                f.write("\n")
                
                # 添加仓库信息
                f.write("## 仓库目录\n\n")
                for repo_name in repos.keys():
                    f.write(f"- [{repo_name}](#{repo_name.lower()})\n")
                f.write("\n")
                
                # 添加各仓库设备列表
                for repo_name in repos.keys():
                    try:
                        with open(f"device_list_{repo_name.lower()}.md", 'r', encoding='utf-8') as repo_file:
                            f.write(repo_file.read())
                    except FileNotFoundError:
                        f.write(f"### {repo_name}\n\n> 该仓库暂无设备数据或数据获取失败\n\n")
                
                # 使用说明
                f.write("## 使用说明\n\n")
                f.write("1. **设备名称**: 在编译配置中使用的设备标识符\n")
                f.write("2. **通用别名**: 常用的设备别名，可在工作流中输入使用\n")
                f.write("3. **平台**: 设备所属的硬件平台\n")
                f.write("4. **备注**: 设备的完整名称或描述信息\n\n")
                
                f.write("## 注意事项\n\n")
                f.write("- 设备列表每周自动更新\n")
                f.write("- 如果某个仓库显示无数据，可能是克隆失败或该仓库暂无设备定义\n")
                f.write("- 设备别名可用于简化输入，如输入 'ac42u' 会自动转换为 'asus_rt-ac42u'\n")
            
            print("🎉 设备列表生成完成")
            print("📊 生成统计:")
            for repo_name, count in repo_stats.items():
                print(f"   - {repo_name}: {count} 个设备")
            print(f"   - 总计: {total_devices} 个设备")

        if __name__ == "__main__":
            main()
        EOF

        # 运行设备列表生成脚本
        echo "开始运行设备列表生成脚本..."
        python3 generate_device_list.py
        echo "✅ 设备列表生成脚本执行完成"

        # 验证生成的文件
        echo "=== 验证生成的文件 ==="
        ls -la *.md
        echo "文件内容预览:"
        if [ -f "supports.md" ]; then
          echo "supports.md 前10行:"
          head -10 supports.md
        fi

    # 文件复制步骤 - 修复文件复制问题
    - name: 复制设备列表到工作目录
      run: |
        cd $BUILD_DIR
        echo "=== 复制设备列表到工作目录 ==="
        
        # 检查生成的文件
        echo "生成的文件列表:"
        ls -la *.md 2>/dev/null || echo "未找到Markdown文件"
        
        # 确保目标目录存在
        mkdir -p $GITHUB_WORKSPACE/firmware-config/custom-files/others
        
        # 复制汇总文件到根目录
        if [ -f "supports.md" ]; then
          echo "复制 supports.md 到仓库根目录..."
          cp -v supports.md $GITHUB_WORKSPACE/supports.md
          echo "✅ 已复制 supports.md 到仓库根目录"
          
          # 验证复制是否成功
          if [ -f "$GITHUB_WORKSPACE/supports.md" ]; then
            echo "✅ 验证: $GITHUB_WORKSPACE/supports.md 存在"
          else
            echo "❌ 错误: $GITHUB_WORKSPACE/supports.md 不存在，复制失败"
            exit 1
          fi
        else
          echo "❌ 错误: 未找到 supports.md 文件"
          exit 1
        fi
        
        # 复制详细文件到 firmware-config/custom-files/others/
        DEVICE_LIST_FILES=$(ls device_list_*.md 2>/dev/null || true)
        if [ -n "$DEVICE_LIST_FILES" ]; then
          echo "复制详细设备列表到 firmware-config/custom-files/others/..."
          for file in $DEVICE_LIST_FILES; do
            cp -v "$file" "$GITHUB_WORKSPACE/firmware-config/custom-files/others/"
          done
          echo "✅ 已复制详细设备列表到 firmware-config/custom-files/others/"
          echo "复制的文件: $DEVICE_LIST_FILES"
          
          # 验证复制是否成功
          for file in $DEVICE_LIST_FILES; do
            if [ -f "$GITHUB_WORKSPACE/firmware-config/custom-files/others/$file" ]; then
              echo "✅ 验证: $GITHUB_WORKSPACE/firmware-config/custom-files/others/$file 存在"
            else
              echo "❌ 错误: $GITHUB_WORKSPACE/firmware-config/custom-files/others/$file 不存在，复制失败"
            fi
          done
        else
          echo "⚠️ 警告: 未找到详细设备列表文件"
        fi
        
        echo "✅ 设备列表文件复制完成"
        
        # 在工作目录中显示最终文件结构
        echo "=== 工作目录最终文件结构 ==="
        cd $GITHUB_WORKSPACE
        ls -la supports.md 2>/dev/null || echo "supports.md 不存在"
        ls -la firmware-config/custom-files/others/device_list_*.md 2>/dev/null || echo "device_list_*.md 不存在"

    # 提交更新步骤 - 修复Git检测问题
    - name: 提交更新
      run: |
        cd $GITHUB_WORKSPACE
        echo "=== 提交设备列表更新 ==="
        
        # 设置Git用户信息
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 显示当前Git状态
        echo "=== 当前Git状态 ==="
        git status
        
        # 显示文件变化
        echo "=== 文件变化 ==="
        git diff --name-status
        
        # 添加所有相关文件
        echo "=== 添加文件到Git ==="
        git add supports.md
        git add firmware-config/custom-files/others/device_list_*.md 2>/dev/null || echo "没有device_list文件可添加"
        
        # 显示暂存区状态
        echo "=== 暂存区状态 ==="
        git status --porcelain
        
        # 检查是否有需要提交的更改
        if git diff --staged --quiet; then
          echo "ℹ️ 没有检测到设备列表变化，无需提交"
          echo "可能的原因:"
          echo "1. 文件内容与之前完全相同"
          echo "2. 文件没有被正确添加到Git"
          echo "3. 工作流运行在错误的分支上"
          
          # 显示更多调试信息
          echo "=== 调试信息 ==="
          echo "当前分支: $(git branch --show-current)"
          echo "HEAD commit: $(git log -1 --oneline)"
          if [ -f "supports.md" ]; then
            echo "supports.md 大小: $(wc -l < supports.md) 行"
            echo "supports.md 最后修改: $(stat -c %y supports.md 2>/dev/null || echo '未知')"
          fi
        else
          echo "检测到设备列表变化，准备提交..."
          git commit -m "自动更新设备列表 $(date +'%Y-%m-%d %H:%M:%S')"
          
          # 显示提交信息
          echo "=== 提交信息 ==="
          git log -1 --oneline
          
          # 推送到仓库
          echo "推送到仓库..."
          git push
          echo "✅ 设备列表更新已提交"
        fi

    # 清理步骤
    - name: 清理构建目录
      run: |
        echo "=== 清理临时构建目录 ==="
        sudo rm -rf $BUILD_DIR
        echo "✅ 构建目录已清理"
