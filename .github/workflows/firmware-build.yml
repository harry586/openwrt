name: OpenWrt Âõ∫‰ª∂ÊûÑÂª∫

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'üì± ËÆæÂ§áÂêçÁß∞ (Â¶Ç: ac42u)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'üîÑ ÁâàÊú¨ÈÄâÊã©'
        required: true
        type: choice
        default: '21.02'
        options:
          - '23.05'
          - '21.02'
      config_mode:
        description: '‚öôÔ∏è ÈÖçÁΩÆÊ®°Âºè'
        required: true
        type: choice
        default: 'normal'
        options:
          - 'base'
          - 'normal'
      extra_packages:
        description: 'È¢ùÂ§ñÊèí‰ª∂ (Áî®È°øÂè∑„ÄÅÂàÜÈöî)'
        required: false
        type: string
        default: ''
      enable_cache:
        description: '‚ö° ÂêØÁî®ÁºñËØëÁºìÂ≠ò'
        required: false
        default: true
        type: boolean
      rebuild_toolchain:
        description: 'üîÑ ÈáçÊñ∞ÊûÑÂª∫Â∑•ÂÖ∑Èìæ'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'üêõ ÂêØÁî®Ë∞ÉËØïÊ®°Âºè'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  TOOLCHAIN_DIR: /mnt/openwrt-toolchain
  WORKSPACE: ${{ github.workspace }}
  DEBUG_MODE: ${{ github.event.inputs.debug_mode }}

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Ê£ÄÂá∫‰ªìÂ∫ì
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: openwrt-config

    - name: ËÆæÁΩÆÊùÉÈôê
      run: chmod +x openwrt-config/firmware-config/scripts/*.sh

    - name: ÂàõÂª∫ÁõÆÂΩï
      run: |
        sudo mkdir -p $BUILD_DIR $TOOLCHAIN_DIR
        sudo chown -R $USER:$USER $BUILD_DIR $TOOLCHAIN_DIR

    - name: ÂàùÂßãÂåñÊûÑÂª∫ÁéØÂ¢É
      id: init_env
      run: |
        # Ê∏ÖÁêÜÂπ∂ÈáçÊñ∞ÂàõÂª∫ÊûÑÂª∫ÁõÆÂΩï
        sudo rm -rf $BUILD_DIR/*
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        
        cd $BUILD_DIR
        
        # Â§çÂà∂ËÑöÊú¨
        cp $WORKSPACE/openwrt-config/firmware-config/scripts/build_firmware_main.sh .
        chmod +x build_firmware_main.sh
        
        # ÊâßË°åÂàùÂßãÂåñ
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"
        
        if [ -f "build_env.sh" ]; then
          source build_env.sh
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_OUTPUT
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_OUTPUT
          echo "DEVICE=$DEVICE" >> $GITHUB_ENV
          echo "DEVICE=$DEVICE" >> $GITHUB_OUTPUT
        else
          exit 1
        fi

    - name: ÈÖçÁΩÆFeeds
      run: |
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh configure_feeds

    - name: ÂÆâË£ÖÊèí‰ª∂ÂåÖ
      run: |
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh install_filetransfer_packages

    - name: Êô∫ËÉΩÈÖçÁΩÆÁîüÊàê
      run: |
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"

    - name: Â∫îÁî®ÈÖçÁΩÆ
      run: |
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh apply_config

    - name: ‰∏ãËΩΩ‰æùËµñÂåÖ
      run: |
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh download_dependencies

    - name: ÁºñËØëÂõ∫‰ª∂
      id: build_firmware
      run: |
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"
        
        if [ $? -eq 0 ]; then
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
        fi

    - name: Ê£ÄÊü•Âõ∫‰ª∂Êñá‰ª∂
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      run: |
        cd $BUILD_DIR
        ./build_firmware_main.sh check_firmware_files

    - name: Â§á‰ªΩÈÖçÁΩÆ
      if: always()
      run: |
        cd $BUILD_DIR
        ./build_firmware_main.sh backup_config

    - name: ‰∏ä‰º†Âõ∫‰ª∂
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 30

    - name: ‰∏ä‰º†Êó•Âøó
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/*.log
          ${{ env.BUILD_DIR }}/config_backup/
        retention-days: 30
