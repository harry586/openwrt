name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆæç®€ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, acrh17, r3gç­‰)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©"
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ (ç”¨åˆ†å·åˆ†éš”)"
        required: false
        type: string
        default: ""
      enable_cache:
        description: "âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜"
        required: false
        default: true
        type: boolean
      save_toolchain:
        description: "ğŸ’¾ ä¿å­˜é€šç”¨å·¥å…·é“¾"
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  GIT_LFS_SKIP_SMUDGE: 1
  ENABLE_CACHE: "true"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: "ğŸ“¥ 1. æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤2ï¼šè¿è¡ŒåŸºç¡€ä¿®å¤
      - name: "ğŸ”§ 2. è¿è¡ŒåŸºç¡€ä¿®å¤"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step2_basic_fix
      
      # æ­¥éª¤3ï¼šè®¾ç½®æ„å»ºç¯å¢ƒ
      - name: "ğŸ› ï¸ 3. è®¾ç½®æ„å»ºç¯å¢ƒ"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step3_setup_environment
      
      # æ­¥éª¤4ï¼šå‡†å¤‡æ„å»ºç›®å½•
      - name: "ğŸ“ 4. å‡†å¤‡æ„å»ºç›®å½•"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step4_prepare_build_dir
      
      # æ­¥éª¤5ï¼šåˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      - name: "ğŸš€ 5. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step5_init_build_env \
            "${{ github.event.inputs.device_name }}" \
            "${{ github.event.inputs.version_selection }}" \
            "${{ github.event.inputs.config_mode }}" \
            "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤6ï¼šæ˜¾ç¤ºé…ç½®æ‘˜è¦
      - name: "âš¡ 6. æ˜¾ç¤ºé…ç½®æ‘˜è¦"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step6_show_config
      
      # æ­¥éª¤7ï¼šä¸‹è½½OpenWrtæºä»£ç 
      - name: "ğŸ“¥ 7. ä¸‹è½½OpenWrtæºä»£ç "
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step7_download_openwrt_source
      
      # æ­¥éª¤8ï¼šé…ç½®Feeds
      - name: "ğŸ“¦ 8. é…ç½®Feeds"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step8_configure_feeds
      
      # æ­¥éª¤9ï¼šç”Ÿæˆé…ç½®
      - name: "âš™ï¸ 9. ç”Ÿæˆé…ç½®"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step9_generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤10ï¼šåº”ç”¨é…ç½®å¹¶ä¿®å¤æ’ä»¶
      - name: "ğŸ”§ 10. åº”ç”¨é…ç½®å¹¶ä¿®å¤æ’ä»¶"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step10_apply_and_fix_config
      
      # æ­¥éª¤11ï¼šä¸‹è½½ä¾èµ–åŒ…
      - name: "ğŸ“¥ 11. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step11_download_dependencies
      
      # æ­¥éª¤12ï¼šç¼–è¯‘å›ºä»¶
      - name: "ğŸ”¨ 12. ç¼–è¯‘å›ºä»¶"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step12_build_firmware "${{ github.event.inputs.enable_cache }}"
      
      # æ­¥éª¤13ï¼šä¿å­˜å·¥å…·é“¾
      - name: "ğŸ’¾ 13. ä¿å­˜å·¥å…·é“¾"
        if: github.event.inputs.save_toolchain == 'true' && success()
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step13_save_toolchain
      
      # æ­¥éª¤14ï¼šä¸Šä¼ å›ºä»¶
      - name: "â¬†ï¸ 14. ä¸Šä¼ å›ºä»¶"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: "firmware-${{ github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}"
          path: /mnt/openwrt-build/bin/targets/
          retention-days: 30
      
      # æ­¥éª¤15ï¼šä¸Šä¼ æ—¥å¿—
      - name: "â¬†ï¸ 15. ä¸Šä¼ æ—¥å¿—"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "build-log-${{ github.event.inputs.device_name }}-${{ github.run_id }}"
          path: /mnt/openwrt-build/build.log
          retention-days: 30
      
      # æ­¥éª¤16ï¼šæ¸…ç†æ„å»ºç›®å½•
      - name: "ğŸ§¹ 16. æ¸…ç†æ„å»ºç›®å½•"
        if: always()
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step16_cleanup
      
      # æ­¥éª¤17ï¼šæ„å»ºæ€»ç»“
      - name: "ğŸ“ˆ 17. æ„å»ºæ€»ç»“"
        if: always()
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step17_build_summary "${{ job.status }}"
