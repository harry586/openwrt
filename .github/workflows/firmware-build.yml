name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆUSBå®Œå…¨ä¿®å¤é€šç”¨ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, r3g, r4ag ç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ï¼šâœ… æ–‡ä»¶ä¼ è¾“ã€‚
          
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ ã€‚
        required: true
        type: choice
        default: 'normal'
        options:
        - 'base'
        - 'normal'
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šğŸ”´ç”¨åˆ†å·;åˆ†éš”ã€‚ğŸ”´ å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ğŸ”´ ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚ğŸ”´ ç¤ºä¾‹ï¼š+luci-app-wol;+luci-app-ddns
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo cmake
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"

    - name: ç‰ˆæœ¬é€‰æ‹©
      id: version-selection
      run: |
        cd $BUILD_DIR
        echo "=== ç‰ˆæœ¬é€‰æ‹© ==="
        if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            SELECTED_BRANCH="openwrt-23.05"
        else
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            SELECTED_BRANCH="openwrt-21.02"
        fi
        echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
        echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
        echo "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH"

    - name: å…‹éš†æºç 
      run: |
        cd $BUILD_DIR
        echo "=== å…‹éš†æºç  ==="
        echo "ä»“åº“: $SELECTED_REPO_URL"
        echo "åˆ†æ”¯: $SELECTED_BRANCH"
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
        echo "âœ… æºç å…‹éš†å®Œæˆ"

    - name: æ·»åŠ  TurboACC æ”¯æŒ
      run: |
        cd $BUILD_DIR
        echo "=== æ·»åŠ  TurboACC æ”¯æŒ ==="
        
        # åªæœ‰æ­£å¸¸æ¨¡å¼æ‰æ·»åŠ  TurboACC æ”¯æŒ
        if [ "${{ github.event.inputs.config_mode }}" = "normal" ]; then
            echo "ğŸ”§ ä¸ºæ­£å¸¸æ¨¡å¼æ·»åŠ  TurboACC æ”¯æŒ"
            
            # ä¸º 23.05 ç‰ˆæœ¬æ·»åŠ  turboacc æ”¯æŒ
            if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
                echo "ğŸ”§ ä¸º 23.05 æ·»åŠ  TurboACC æ”¯æŒ"
                
                # æ·»åŠ  turboacc çš„ feeds
                echo "src-git turboacc https://github.com/chenmozhijin/turboacc" >> feeds.conf.default
                
                echo "âœ… TurboACC feed æ·»åŠ å®Œæˆ"
            else
                echo "â„¹ï¸  21.02 ç‰ˆæœ¬å·²å†…ç½® TurboACCï¼Œæ— éœ€é¢å¤–æ·»åŠ "
            fi
        else
            echo "â„¹ï¸  åŸºç¡€æ¨¡å¼ä¸æ·»åŠ  TurboACC æ”¯æŒ"
        fi

    - name: æ·»åŠ æ–‡ä»¶ä¼ è¾“æ’ä»¶æ”¯æŒ
      run: |
        cd $BUILD_DIR
        echo "=== æ·»åŠ æ–‡ä»¶ä¼ è¾“æ’ä»¶æ”¯æŒ ==="
        
        # ä¸ºæ‰€æœ‰ç‰ˆæœ¬æ·»åŠ æ–‡ä»¶ä¼ è¾“æ’ä»¶æ”¯æŒ
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            echo "ğŸ”§ ä¸º23.05æ·»åŠ æ–‡ä»¶ä¼ è¾“æ’ä»¶æ”¯æŒ"
            # ğŸš¨ å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„small-packageæºï¼ˆä¸æ˜¯smallï¼‰
            echo "src-git small https://github.com/kenzok8/small-package" >> feeds.conf.default
        else
            echo "ğŸ”§ ä¸º21.02æ·»åŠ æ–‡ä»¶ä¼ è¾“æ’ä»¶æ”¯æŒ"
            # 21.02ç‰ˆæœ¬ä½¿ç”¨kenzok8çš„openwrt-packages
            echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
        fi
        
        echo "âœ… æ–‡ä»¶ä¼ è¾“æ’ä»¶æ”¯æŒæ·»åŠ å®Œæˆ"

    - name: è®¾å¤‡é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== è®¾å¤‡é…ç½® ==="
        case "${{ github.event.inputs.device_name }}" in
            "ac42u"|"acrh17")
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="asus_rt-ac42u"
                ;;
            "mi_router_4a_gigabit"|"r4ag")
                TARGET="ramips"
                SUBTARGET="mt76x8"
                DEVICE="xiaomi_mi-router-4a-gigabit"
                ;;
            "mi_router_3g"|"r3g")
                TARGET="ramips"
                SUBTARGET="mt7621"
                DEVICE="xiaomi_mi-router-3g"
                ;;
            *)
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="${{ github.event.inputs.device_name }}"
                ;;
        esac
        echo "TARGET=$TARGET" >> $GITHUB_ENV
        echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
        echo "DEVICE=$DEVICE" >> $GITHUB_ENV
        echo "ç›®æ ‡: $TARGET"
        echo "å­ç›®æ ‡: $SUBTARGET"
        echo "è®¾å¤‡: $DEVICE"

    - name: é…ç½®Feeds
      run: |
        cd $BUILD_DIR
        echo "=== é…ç½®Feeds ==="
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            FEEDS_BRANCH="openwrt-23.05"
        else
            FEEDS_BRANCH="openwrt-21.02"
        fi
        
        # ç¡®ä¿ feeds.conf.default åŒ…å«åŸºæœ¬ feeds
        echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
        echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
        
        # å¦‚æœæ˜¯ 23.05 ä¸”æ­£å¸¸æ¨¡å¼ï¼Œæ·»åŠ  turboacc feed
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ] && [ "${{ github.event.inputs.config_mode }}" = "normal" ]; then
            echo "src-git turboacc https://github.com/chenmozhijin/turboacc" >> feeds.conf.default
        fi
        
        # ä¸ºæ‰€æœ‰ç‰ˆæœ¬æ·»åŠ æ–‡ä»¶ä¼ è¾“æ’ä»¶æº
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            # ğŸš¨ å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„small-packageæº
            echo "src-git small https://github.com/kenzok8/small-package" >> feeds.conf.default
        else
            echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
        fi
        
        # æ›´æ–°å’Œå®‰è£…æ‰€æœ‰ feeds
        echo "=== æ›´æ–°Feeds ==="
        ./scripts/feeds update -a
        echo "=== å®‰è£…Feeds ==="
        ./scripts/feeds install -a
        
        echo "âœ… Feedsé…ç½®å®Œæˆ"

    - name: å®‰è£… TurboACC åŒ…
      if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
      run: |
        cd $BUILD_DIR
        echo "=== å®‰è£… TurboACC åŒ… ==="
        
        # æ›´æ–° turboacc feed
        ./scripts/feeds update turboacc
        
        # å®‰è£… turboacc ç›¸å…³åŒ…
        ./scripts/feeds install -p turboacc luci-app-turboacc
        ./scripts/feeds install -p turboacc kmod-shortcut-fe
        ./scripts/feeds install -p turboacc kmod-fast-classifier
        
        echo "âœ… TurboACC åŒ…å®‰è£…å®Œæˆ"

    - name: å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶åŒ…
      run: |
        cd $BUILD_DIR
        echo "=== å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶åŒ… ==="
        
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            echo "ğŸ”§ ä¸º23.05å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶"
            # æ›´æ–° small feed
            ./scripts/feeds update small
            # å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶
            ./scripts/feeds install -p small luci-app-filetransfer
            # å®‰è£…ä¸­æ–‡è¯­è¨€åŒ…
            ./scripts/feeds install -p small luci-i18n-filetransfer-zh-cn
        else
            echo "ğŸ”§ ä¸º21.02å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶"
            # æ›´æ–° kenzo feed
            ./scripts/feeds update kenzo
            # å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶
            ./scripts/feeds install -p kenzo luci-app-filetransfer
            # å®‰è£…ä¸­æ–‡è¯­è¨€åŒ…
            ./scripts/feeds install -p kenzo luci-i18n-filetransfer-zh-cn
        fi
        
        echo "âœ… æ–‡ä»¶ä¼ è¾“æ’ä»¶åŒ…å®‰è£…å®Œæˆ"

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤é€šç”¨ç‰ˆï¼‰
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆUSBå®Œå…¨ä¿®å¤é€šç”¨ç‰ˆï¼‰==="
        rm -f .config .config.old
        
        # åˆ›å»ºåŸºç¡€é…ç½®
        echo "CONFIG_TARGET_${TARGET}=y" > .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        
        # åŸºç¡€ç³»ç»Ÿç»„ä»¶
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_fstools=y" >> .config
        echo "CONFIG_PACKAGE_libc=y" >> .config
        echo "CONFIG_PACKAGE_libgcc=y" >> .config
        echo "CONFIG_PACKAGE_mtd=y" >> .config
        echo "CONFIG_PACKAGE_netifd=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_procd=y" >> .config
        echo "CONFIG_PACKAGE_ubox=y" >> .config
        echo "CONFIG_PACKAGE_ubus=y" >> .config
        echo "CONFIG_PACKAGE_ubusd=y" >> .config
        echo "CONFIG_PACKAGE_uci=y" >> .config
        echo "CONFIG_PACKAGE_uclient-fetch=y" >> .config
        echo "CONFIG_PACKAGE_usign=y" >> .config
        
        # DNSé…ç½®
        echo "# CONFIG_PACKAGE_dnsmasq is not set" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dhcp=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dnssec=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_ipset=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_conntrack=y" >> .config
        
        # æ— çº¿é©±åŠ¨
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        echo "CONFIG_PACKAGE_ath10k-firmware-qca988x=y" >> .config
        echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
        
        # ç½‘ç»œå·¥å…·
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> .config
        echo "CONFIG_PACKAGE_ip6tables=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ip6tables=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-nat6=y" >> .config
        
        # ============================================================================
        # ğŸš¨ USB å®Œå…¨ä¿®å¤é€šç”¨é…ç½® - é€‚ç”¨äºæ‰€æœ‰å¹³å°å’Œè®¾å¤‡
        # ============================================================================
        echo "=== ğŸš¨ USB å®Œå…¨ä¿®å¤é€šç”¨é…ç½® - å¼€å§‹ ==="
        
        # ==================== USB æ ¸å¿ƒé©±åŠ¨ ====================
        echo "# ğŸŸ¢ USB æ ¸å¿ƒé©±åŠ¨ - åŸºç¡€å¿…é¡»" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
        
        # ==================== USB ä¸»æœºæ§åˆ¶å™¨é©±åŠ¨ ====================
        echo "# ğŸŸ¢ USB ä¸»æœºæ§åˆ¶å™¨é©±åŠ¨ - é€šç”¨æ”¯æŒ" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config      # USB 2.0 é€šç”¨æ”¯æŒ
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config      # USB 3.0 é€šç”¨æ”¯æŒ
        echo "CONFIG_PACKAGE_kmod-usb-ehci=y" >> .config  # USB 2.0 é«˜é€Ÿæ§åˆ¶å™¨
        echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config  # USB 1.1 å…¨é€Ÿæ§åˆ¶å™¨
        echo "CONFIG_PACKAGE_kmod-usb-uhci=y" >> .config  # USB 1.1 é€šç”¨ä¸»æœºæ§åˆ¶å™¨
        echo "CONFIG_PACKAGE_kmod-usb2-pci=y" >> .config  # PCI USB 2.0 æ”¯æŒ
        
        # ==================== å¹³å°ä¸“ç”¨USBæ§åˆ¶å™¨é©±åŠ¨ ====================
        echo "# ğŸŸ¡ å¹³å°ä¸“ç”¨USBæ§åˆ¶å™¨é©±åŠ¨ - æŒ‰å¹³å°å¯ç”¨" >> .config
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šIPQ40xx ä¸“ç”¨USBé©±åŠ¨ï¼ˆå¦‚RT-AC42Uã€RT-AC58Uç­‰è®¾å¤‡ï¼‰
        if [ "$TARGET" = "ipq40xx" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šIPQ40xx ä¸“ç”¨USBæ§åˆ¶å™¨é©±åŠ¨ï¼ˆé«˜é€šæ–¹æ¡ˆï¼‰" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config          # DWC3 USBæ§åˆ¶å™¨æ ¸å¿ƒ
            echo "CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y" >> .config # ç®€å•DWC3è®¾å¤‡æ ‘æ”¯æŒ
            echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config     # é«˜é€šDWC3 USBæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config     # é«˜é€šUSBç‰©ç†å±‚é©±åŠ¨ï¼ˆæœ€å…³é”®ï¼ï¼‰
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šARM64/ARM å¹³å°USBé©±åŠ¨
        if [ "$TARGET" = "rockchip" ] || [ "$TARGET" = "sunxi" ] || [ "$TARGET" = "bcm27xx" ] || [ "$TARGET" = "mvebu" ] || [ "$TARGET" = "mediatek" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šARM/ARM64 å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-dwc2=y" >> .config          # DWC2 USBæ§åˆ¶å™¨ï¼ˆæ ‘è“æ´¾ç­‰ï¼‰
            echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config          # DWC3 USBæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y" >> .config # ç®€å•DWC3è®¾å¤‡æ ‘æ”¯æŒ
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šx86/PC å¹³å°USBé©±åŠ¨
        if [ "$TARGET" = "x86" ] || [ "$TARGET" = "x86_64" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šx86/x64 å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config      # xHCI USB 3.0æ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb-xhci-pci=y" >> .config      # PCI xHCIæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" >> .config      # è”å‘ç§‘xHCIæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" >> .config # å¹³å°xHCIæ§åˆ¶å™¨
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šMT76xx/é›·å‡Œ å¹³å°USBé©±åŠ¨
        if [ "$TARGET" = "ramips" ] || [ "$SUBTARGET" = "mt76x8" ] || [ "$SUBTARGET" = "mt7621" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šMT76xx/é›·å‡Œ å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config          # USB 1.1 OHCIæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb-ohci-pci=y" >> .config      # PCI OHCIæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config              # USB 2.0 EHCIæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb2-pci=y" >> .config          # PCI EHCIæ§åˆ¶å™¨
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šé«˜é€šAtheros å¹³å°USBé©±åŠ¨
        if [ "$TARGET" = "ath79" ] || [ "$TARGET" = "ar71xx" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šAtheros å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config          # USB 1.1 OHCIæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config              # USB 2.0 EHCIæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config          # USBæ ¸å¿ƒé©±åŠ¨
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šåšé€šBCM å¹³å°USBé©±åŠ¨
        if [ "$TARGET" = "bcm53xx" ] || [ "$TARGET" = "brcm47xx" ] || [ "$TARGET" = "brcm63xx" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šåšé€šBCM å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config          # USB 1.1 OHCIæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb-ohci-hcd=y" >> .config      # OHCIä¸»æœºæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config              # USB 2.0 EHCIæ§åˆ¶å™¨
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šå…¨å¿—Sunxi å¹³å°USBé©±åŠ¨
        if [ "$TARGET" = "sunxi" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šå…¨å¿—Sunxi å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-sunxi=y" >> .config         # å…¨å¿—USBæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-phy-sun4i-usb=y" >> .config     # å…¨å¿—USBç‰©ç†å±‚
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šMarvell å¹³å°USBé©±åŠ¨
        if [ "$TARGET" = "mvebu" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šMarvell å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-ehci=y" >> .config          # EHCI USB 2.0æ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config      # xHCI USB 3.0æ§åˆ¶å™¨
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šè”å‘ç§‘MTK å¹³å°USBé©±åŠ¨
        if [ "$TARGET" = "mediatek" ] || [ "$TARGET" = "mt7623" ] || [ "$TARGET" = "mt7629" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šè”å‘ç§‘MTK å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-mtk-phy=y" >> .config       # MTK USBç‰©ç†å±‚
            echo "CONFIG_PACKAGE_kmod-usb-mtk-phy-7621=y" >> .config  # MT7621 USBç‰©ç†å±‚
            echo "CONFIG_PACKAGE_kmod-usb-mtk-phy-7623=y" >> .config  # MT7623 USBç‰©ç†å±‚
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šæ ‘è“æ´¾ å¹³å°USBé©±åŠ¨
        if [ "$TARGET" = "bcm27xx" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šæ ‘è“æ´¾ å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-dwc2=y" >> .config          # DWC2 USBæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb-dwc2-platform=y" >> .config # DWC2å¹³å°æ”¯æŒ
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šé¾™èŠ¯Loongson å¹³å°USBé©±åŠ¨
        if [ "$TARGET" = "loongson" ]; then
            echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šé¾™èŠ¯Loongson å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config          # USB 1.1 OHCIæ§åˆ¶å™¨
            echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config              # USB 2.0 EHCIæ§åˆ¶å™¨
        fi
        
        # ğŸš¨ å…³é”®ä¿®å¤ï¼šå…¶ä»–é€šç”¨å¹³å°USBé©±åŠ¨
        echo "# ğŸš¨ å…³é”®ä¿®å¤ï¼šå…¶ä»–é€šç”¨å¹³å°USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-acm=y" >> .config               # USB ACMè®¾å¤‡ï¼ˆè°ƒåˆ¶è§£è°ƒå™¨ï¼‰
        echo "CONFIG_PACKAGE_kmod-usb-serial=y" >> .config            # USBä¸²å£è®¾å¤‡
        echo "CONFIG_PACKAGE_kmod-usb-serial-ftdi=y" >> .config       # FTDI USBä¸²å£
        echo "CONFIG_PACKAGE_kmod-usb-serial-pl2303=y" >> .config     # PL2303 USBä¸²å£
        echo "CONFIG_PACKAGE_kmod-usb-net=y" >> .config               # USBç½‘ç»œè®¾å¤‡
        echo "CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y" >> .config     # CDC Ethernetç½‘ç»œ
        echo "CONFIG_PACKAGE_kmod-usb-net-rndis=y" >> .config         # RNDISç½‘ç»œ
        
        # ==================== USB å­˜å‚¨é©±åŠ¨ ====================
        echo "# ğŸŸ¢ USB å­˜å‚¨é©±åŠ¨ - æ ¸å¿ƒåŠŸèƒ½" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config           # USBå­˜å‚¨åŸºç¡€é©±åŠ¨
        echo "CONFIG_PACKAGE_kmod-usb-storage-extras=y" >> .config    # USBå­˜å‚¨æ‰©å±•åŠŸèƒ½
        echo "CONFIG_PACKAGE_kmod-usb-storage-uas=y" >> .config       # UASï¼ˆUSB Attached SCSIï¼‰æ”¯æŒ
        
        # ==================== SCSI æ”¯æŒ ====================
        echo "# ğŸŸ¢ SCSI æ”¯æŒ - ç¡¬ç›˜å’ŒUç›˜å¿…éœ€" >> .config
        echo "CONFIG_PACKAGE_kmod-scsi-core=y" >> .config             # SCSIæ ¸å¿ƒé©±åŠ¨
        echo "CONFIG_PACKAGE_kmod-scsi-generic=y" >> .config          # SCSIé€šç”¨è®¾å¤‡æ”¯æŒ
        
        # ==================== æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ ====================
        echo "# ğŸŸ¢ æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ - å®Œæ•´æ–‡ä»¶ç³»ç»Ÿå…¼å®¹" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config               # EXT4æ–‡ä»¶ç³»ç»Ÿ
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config               # FAT/FAT32æ–‡ä»¶ç³»ç»Ÿ
        echo "CONFIG_PACKAGE_kmod-fs-exfat=y" >> .config              # exFATæ–‡ä»¶ç³»ç»Ÿ
        echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config              # NTFSæ–‡ä»¶ç³»ç»Ÿï¼ˆæ–°ç‰ˆï¼‰
        echo "CONFIG_PACKAGE_kmod-fs-autofs4=y" >> .config            # è‡ªåŠ¨æŒ‚è½½æ”¯æŒ
        echo "CONFIG_PACKAGE_kmod-fs-f2fs=y" >> .config               # F2FSé—ªå­˜æ–‡ä»¶ç³»ç»Ÿ
        echo "CONFIG_PACKAGE_kmod-fs-hfsplus=y" >> .config            # HFS+æ–‡ä»¶ç³»ç»Ÿï¼ˆè‹¹æœï¼‰
        
        # ==================== ç¼–ç æ”¯æŒ ====================
        echo "# ğŸŸ¢ ç¼–ç æ”¯æŒ - å¤šè¯­è¨€æ–‡ä»¶åå…¼å®¹" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-utf8=y" >> .config              # UTF-8ç¼–ç ï¼ˆä¸­æ–‡å¿…éœ€ï¼‰
        echo "CONFIG_PACKAGE_kmod-nls-cp437=y" >> .config             # CP437ç¼–ç 
        echo "CONFIG_PACKAGE_kmod-nls-iso8859-1=y" >> .config         # ISO8859-1ç¼–ç 
        echo "CONFIG_PACKAGE_kmod-nls-cp936=y" >> .config             # CP936ç¼–ç ï¼ˆç®€ä½“ä¸­æ–‡ï¼‰
        echo "CONFIG_PACKAGE_kmod-nls-iso8859-15=y" >> .config        # ISO8859-15ç¼–ç 
        
        # ==================== è‡ªåŠ¨æŒ‚è½½å·¥å…· ====================
        echo "# ğŸŸ¢ è‡ªåŠ¨æŒ‚è½½å·¥å…· - å³æ’å³ç”¨æ”¯æŒ" >> .config
        echo "CONFIG_PACKAGE_block-mount=y" >> .config                # å—è®¾å¤‡æŒ‚è½½
        echo "CONFIG_PACKAGE_automount=y" >> .config                  # è‡ªåŠ¨æŒ‚è½½æœåŠ¡
        
        # ==================== USB å·¥å…·å’Œçƒ­æ’æ‹”æ”¯æŒ ====================
        echo "# ğŸŸ¢ USB å·¥å…·å’Œçƒ­æ’æ‹”æ”¯æŒ - è®¾å¤‡ç®¡ç†" >> .config
        echo "CONFIG_PACKAGE_usbutils=y" >> .config                   # USBå·¥å…·é›†
        echo "CONFIG_PACKAGE_lsusb=y" >> .config                      # USBè®¾å¤‡åˆ—è¡¨
        echo "CONFIG_PACKAGE_udev=y" >> .config                       # è®¾å¤‡ç®¡ç†å™¨ï¼ˆå…³é”®ï¼ï¼‰
        echo "CONFIG_PACKAGE_udev-extra=y" >> .config                 # æ‰©å±•è®¾å¤‡è§„åˆ™
        
        # ==================== ç£ç›˜å·¥å…· ====================
        echo "# ğŸŸ¢ ç£ç›˜å·¥å…· - å®Œæ•´ç£ç›˜ç®¡ç†" >> .config
        echo "CONFIG_PACKAGE_blkid=y" >> .config                      # å—è®¾å¤‡ä¿¡æ¯
        echo "CONFIG_PACKAGE_libblkid=y" >> .config                   # å—è®¾å¤‡ä¿¡æ¯åº“
        echo "CONFIG_PACKAGE_libmount=y" >> .config                   # æŒ‚è½½åŠŸèƒ½åº“
        echo "CONFIG_PACKAGE_libuuid=y" >> .config                    # UUIDåº“
        echo "CONFIG_PACKAGE_mount-utils=y" >> .config                # æŒ‚è½½å·¥å…·
        echo "CONFIG_PACKAGE_fdisk=y" >> .config                      # ç£ç›˜åˆ†åŒºå·¥å…·
        echo "CONFIG_PACKAGE_cfdisk=y" >> .config                     # äº¤äº’å¼åˆ†åŒºå·¥å…·
        echo "CONFIG_PACKAGE_sfdisk=y" >> .config                     # è„šæœ¬åˆ†åŒºå·¥å…·
        echo "CONFIG_PACKAGE_lsblk=y" >> .config                      # åˆ—å‡ºå—è®¾å¤‡
        echo "CONFIG_PACKAGE_e2fsprogs=y" >> .config                  # EXTæ–‡ä»¶ç³»ç»Ÿå·¥å…·
        echo "CONFIG_PACKAGE_dosfstools=y" >> .config                 # FATæ–‡ä»¶ç³»ç»Ÿå·¥å…·
        echo "CONFIG_PACKAGE_exfat-fsck=y" >> .config                 # exFATæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥
        echo "CONFIG_PACKAGE_exfat-mkfs=y" >> .config                 # exFATæ–‡ä»¶ç³»ç»Ÿåˆ›å»º
        echo "CONFIG_PACKAGE_ntfs-3g=y" >> .config                    # NTFSè¯»å†™æ”¯æŒï¼ˆå¤‡ç”¨ï¼‰
        
        # ==================== æ˜ç¡®ç¦ç”¨å†²çªçš„åŒ… ====================
        echo "# ğŸ”´ æ˜ç¡®ç¦ç”¨å†²çªçš„åŒ…" >> .config
        echo "# CONFIG_PACKAGE_ntfs-3g-utils is not set" >> .config   # é¿å…ä¸kmod-fs-ntfs3å†²çª
        
        # ==================== ç‰ˆæœ¬ç‰¹å®šçš„automounté…ç½® ====================
        if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
            echo "CONFIG_PACKAGE_ntfs3-mount=y" >> .config            # 21.02éœ€è¦ntfs3-mount
        else
            echo "# CONFIG_PACKAGE_ntfs3-mount is not set" >> .config # 23.05ä¸éœ€è¦ntfs3-mount
        fi
        
        echo "=== ğŸš¨ USB å®Œå…¨ä¿®å¤é€šç”¨é…ç½® - å®Œæˆ ==="
        # ============================================================================
        
        # ç‰ˆæœ¬æ™ºèƒ½æ£€æµ‹å’Œé…ç½®
        echo "=== ç‰ˆæœ¬æ™ºèƒ½æ£€æµ‹: $SELECTED_BRANCH ==="
        
        if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
            echo "ğŸ”§ æ£€æµ‹åˆ° 21.02 ç‰ˆæœ¬ï¼Œåº”ç”¨ç›¸åº”é…ç½®..."
            echo "# CONFIG_PACKAGE_kmod-fs-ntfs is not set" >> .config
            echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config
            
        elif [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            echo "ğŸ”§ æ£€æµ‹åˆ° 23.05 ç‰ˆæœ¬ï¼Œåº”ç”¨ç›¸åº”é…ç½®..."
            echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config
            echo "# CONFIG_PACKAGE_kmod-fs-ntfs is not set" >> .config
        else
            echo "âš ï¸  æœªçŸ¥ç‰ˆæœ¬ï¼Œä½¿ç”¨é€šç”¨é…ç½®..."
            echo "# CONFIG_PACKAGE_kmod-fs-ntfs is not set" >> .config
        fi
        
        # æ ¹æ®é…ç½®æ¨¡å¼é€‰æ‹©æ’ä»¶
        echo "=== é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }} ==="
        
        # åŸºç¡€ä¸­æ–‡è¯­è¨€åŒ… - ä¸¤ä¸ªç‰ˆæœ¬éƒ½éœ€è¦
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y" >> .config
        
        # æ–‡ä»¶ä¼ è¾“æ’ä»¶ - æ‰€æœ‰æ¨¡å¼éƒ½éœ€è¦
        echo "CONFIG_PACKAGE_luci-app-filetransfer=y" >> .config
        if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
            echo "CONFIG_PACKAGE_luci-i18n-filetransfer-zh-cn=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.config_mode }}" = "base" ]; then
            echo "ğŸ”§ ä½¿ç”¨åŸºç¡€æ¨¡å¼ (æœ€å°åŒ–ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘)"
            # åŸºç¡€æ¨¡å¼åªåŒ…å«æ–‡ä»¶ä¼ è¾“ï¼Œå…¶ä»–éƒ½ç¦ç”¨
            
            # åŸºç¡€æ¨¡å¼æ˜ç¡®ç¦ç”¨ TurboACC åŠå…¶è¯­è¨€åŒ…
            echo "# CONFIG_PACKAGE_luci-app-turboacc is not set" >> .config
            echo "# CONFIG_PACKAGE_kmod-shortcut-fe is not set" >> .config
            echo "# CONFIG_PACKAGE_kmod-fast-classifier is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn is not set" >> .config
            
            echo "âœ… åŸºç¡€æ¨¡å¼æ’ä»¶å·²å¯ç”¨"
            
        else
            echo "ğŸ”§ ä½¿ç”¨æ­£å¸¸æ¨¡å¼ (å®Œæ•´åŠŸèƒ½)"
            # æ­£å¸¸é…ç½®æ’ä»¶ - åŒ…å«æ‰€æœ‰åŠŸèƒ½
            NORMAL_PLUGINS=(
              "CONFIG_PACKAGE_luci-app-turboacc=y"
              "CONFIG_PACKAGE_kmod-shortcut-fe=y"
              "CONFIG_PACKAGE_kmod-fast-classifier=y"
              "CONFIG_PACKAGE_luci-app-upnp=y"
              "CONFIG_PACKAGE_miniupnpd=y"
              "CONFIG_PACKAGE_vsftpd=y"
              "CONFIG_PACKAGE_luci-app-vsftpd=y"
              "CONFIG_PACKAGE_luci-app-arpbind=y"
              "CONFIG_PACKAGE_luci-app-cpulimit=y"
              "CONFIG_PACKAGE_samba4-server=y"
              "CONFIG_PACKAGE_luci-app-samba4=y"
              "CONFIG_PACKAGE_luci-app-wechatpush=y"
              "CONFIG_PACKAGE_sqm-scripts=y"
              "CONFIG_PACKAGE_luci-app-sqm=y"
              "CONFIG_PACKAGE_luci-app-hd-idle=y"
              "CONFIG_PACKAGE_luci-app-diskman=y"
              "CONFIG_PACKAGE_luci-app-accesscontrol=y"
              "CONFIG_PACKAGE_vlmcsd=y"
              "CONFIG_PACKAGE_luci-app-vlmcsd=y"
              "CONFIG_PACKAGE_smartdns=y"
              "CONFIG_PACKAGE_luci-app-smartdns=y"
            )
            
            # ä¸º21.02ç‰ˆæœ¬æ·»åŠ å®Œæ•´ä¸­æ–‡è¯­è¨€åŒ…
            if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
                echo "ğŸ”§ ä¸º21.02ç‰ˆæœ¬æ·»åŠ å®Œæ•´ä¸­æ–‡è¯­è¨€åŒ…"
                NORMAL_PLUGINS+=(
                  "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-vsftpd-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-arpbind-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-cpulimit-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-samba4-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-wechatpush-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-sqm-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-hd-idle-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-diskman-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-accesscontrol-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-vlmcsd-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y"
                )
            elif [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
                echo "ğŸ”§ ä¸º23.05ç‰ˆæœ¬æ·»åŠ ä¸­æ–‡è¯­è¨€åŒ…"
                # 23.05çš„ä¸­æ–‡åŒ…åç§°å¯èƒ½ä¸åŒï¼Œæ·»åŠ é€šç”¨ä¸­æ–‡åŒ…
                NORMAL_PLUGINS+=(
                  "CONFIG_PACKAGE_luci-i18n-opkg-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-samba4-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-sqm-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-diskman-zh-cn=y"
                  "CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y"
                )
            fi
            
            for plugin in "${NORMAL_PLUGINS[@]}"; do
                echo "$plugin" >> .config
            done
            
            echo "âœ… æ­£å¸¸æ¨¡å¼æ’ä»¶å·²å¯ç”¨"
        fi
        
        # ç¦ç”¨ç½‘ç»œå”¤é†’
        echo "# CONFIG_PACKAGE_luci-app-wol is not set" >> .config
        echo "# CONFIG_PACKAGE_wol is not set" >> .config
        echo "# CONFIG_PACKAGE_etherwake is not set" >> .config
        
        # ç¦ç”¨ offloading æ’ä»¶
        echo "# CONFIG_PACKAGE_luci-app-software-offloading is not set" >> .config
        
        # ä¿®å¤ dropbear ç›‘å¬é”™è¯¯
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        
        # æ˜ç¡®ç¦ç”¨ä¸éœ€è¦çš„æ’ä»¶
        echo "# æ˜ç¡®ç¦ç”¨ç½‘ç»œç›¸å…³æ’ä»¶" >> .config
        UNWANTED_PLUGINS=(
          "CONFIG_PACKAGE_luci-app-passwall"
          "CONFIG_PACKAGE_luci-app-ssr-plus"
          "CONFIG_PACKAGE_luci-app-vssr"
          "CONFIG_PACKAGE_luci-app-rclone"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Haproxy"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_ShadowsocksR_Libev_Client"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Client"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Server"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Simple_Obfs"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_SingBox"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Trojan_Plus"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Geoview"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Plugin"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-ng"
          "CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-webui"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ChinaDNS_NG"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_IPT2Socks"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ShadowsocksR_Libev_Client"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Client"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Server"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Simple_Obfs"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Trojan"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_ShadowsocksR_Libev_Server"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Trojan"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray_plugin"
        )
        
        for plugin in "${UNWANTED_PLUGINS[@]}"; do
            echo "# ${plugin} is not set" >> .config
        done
        
        # å¤„ç†é¢å¤–å®‰è£…æ’ä»¶
        if [ -n "${{ github.event.inputs.extra_packages }}" ]; then
            echo "ğŸ”§ å¤„ç†é¢å¤–å®‰è£…æ’ä»¶: ${{ github.event.inputs.extra_packages }}"
            
            # ä½¿ç”¨åˆ†å·åˆ†éš”è¾“å…¥
            IFS=';' read -ra EXTRA_PKGS <<< "${{ github.event.inputs.extra_packages }}"
            
            for pkg_cmd in "${EXTRA_PKGS[@]}"; do
                if [ -n "$pkg_cmd" ]; then
                    # å»é™¤å‰åç©ºæ ¼
                    pkg_cmd_clean=$(echo "$pkg_cmd" | xargs)
                    
                    # æ£€æŸ¥æ˜¯å¯ç”¨è¿˜æ˜¯ç¦ç”¨
                    if [[ "$pkg_cmd_clean" == +* ]]; then
                        # å¯ç”¨æ’ä»¶
                        pkg_name="${pkg_cmd_clean:1}"
                        echo "å¯ç”¨æ’ä»¶: $pkg_name"
                        echo "CONFIG_PACKAGE_${pkg_name}=y" >> .config
                    elif [[ "$pkg_cmd_clean" == -* ]]; then
                        # ç¦ç”¨æ’ä»¶
                        pkg_name="${pkg_cmd_clean:1}"
                        echo "ç¦ç”¨æ’ä»¶: $pkg_name"
                        echo "# CONFIG_PACKAGE_${pkg_name} is not set" >> .config
                    else
                        # é»˜è®¤å¯ç”¨
                        echo "å¯ç”¨æ’ä»¶: $pkg_cmd_clean"
                        echo "CONFIG_PACKAGE_${pkg_cmd_clean}=y" >> .config
                    fi
                fi
            done
            
            echo "âœ… é¢å¤–æ’ä»¶å¤„ç†å®Œæˆ"
        else
            echo "â„¹ï¸  æ— é¢å¤–å®‰è£…æ’ä»¶"
        fi
        
        echo "âœ… æ™ºèƒ½é…ç½®ç”Ÿæˆå®Œæˆ"
        
        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        echo "=== ğŸš¨ USB ä¿®å¤é…ç½®æ‘˜è¦ ==="
        echo "ç‰ˆæœ¬: $SELECTED_BRANCH"
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
        echo "ç›®æ ‡è®¾å¤‡: $DEVICE"
        echo "å¯ç”¨çš„åŒ…æ•°é‡: $(grep "^CONFIG_PACKAGE_.*=y$" .config | wc -l)"
        echo "ğŸš¨ å…³é”®USBä¿®å¤æ¨¡å—:"
        grep -E "usb-dwc3|usb-dwc3-qcom|phy-qcom-dwc3|usb-xhci|usb-sunxi|usb-mtk-phy" .config | grep "=y" | sed 's/CONFIG_PACKAGE_//' | sed 's/=y/ âœ…/' | sort
        echo "ğŸŸ¢ é€šç”¨USBæ¨¡å—:"
        grep -E "kmod-usb2|kmod-usb3|kmod-usb-ehci|kmod-usb-ohci" .config | grep "=y" | sed 's/CONFIG_PACKAGE_//' | sed 's/=y/ âœ…/' | sort
        echo "ğŸ”µ USBå­˜å‚¨æ¨¡å—:"
        grep -E "usb-storage|scsi-core" .config | grep "=y" | sed 's/CONFIG_PACKAGE_//' | sed 's/=y/ âœ…/' | sort
        echo "ğŸŸ£ æ–‡ä»¶ç³»ç»Ÿæ¨¡å—:"
        grep "kmod-fs-" .config | grep "=y" | sed 's/CONFIG_PACKAGE_//' | sed 's/=y/ âœ…/' | sort
        echo "ğŸŸ¡ è‡ªåŠ¨æŒ‚è½½ç›¸å…³åŒ…:"
        grep -E "block-mount|automount|ntfs3-mount" .config | grep "=y" | sed 's/CONFIG_PACKAGE_//' | sed 's/=y/ âœ…/' | sort

    - name: éªŒè¯USBé…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== ğŸš¨ è¯¦ç»†éªŒè¯USBå’Œå­˜å‚¨é…ç½® ==="
        
        echo "1. ğŸŸ¢ USBæ ¸å¿ƒæ¨¡å—:"
        grep "CONFIG_PACKAGE_kmod-usb-core" .config | grep "=y" && echo "âœ… USBæ ¸å¿ƒ" || echo "âŒ ç¼ºå°‘USBæ ¸å¿ƒ"
        
        echo "2. ğŸŸ¢ USBæ§åˆ¶å™¨:"
        grep -E "CONFIG_PACKAGE_kmod-usb2|CONFIG_PACKAGE_kmod-usb3|CONFIG_PACKAGE_kmod-usb-ehci|CONFIG_PACKAGE_kmod-usb-ohci" .config | grep "=y" || echo "âŒ ç¼ºå°‘USBæ§åˆ¶å™¨"
        
        echo "3. ğŸš¨ å¹³å°ä¸“ç”¨USBæ§åˆ¶å™¨:"
        grep -E "CONFIG_PACKAGE_kmod-usb-dwc3|CONFIG_PACKAGE_kmod-usb-dwc3-qcom|CONFIG_PACKAGE_kmod-phy-qcom-dwc3|CONFIG_PACKAGE_kmod-usb-xhci|CONFIG_PACKAGE_kmod-usb-sunxi|CONFIG_PACKAGE_kmod-usb-mtk-phy" .config | grep "=y" || echo "â„¹ï¸  æ— å¹³å°ä¸“ç”¨USBæ§åˆ¶å™¨"
        
        echo "4. ğŸŸ¢ USBå­˜å‚¨:"
        grep "CONFIG_PACKAGE_kmod-usb-storage" .config | grep "=y" || echo "âŒ ç¼ºå°‘USBå­˜å‚¨"
        
        echo "5. ğŸŸ¢ æ–‡ä»¶ç³»ç»Ÿ:"
        grep "CONFIG_PACKAGE_kmod-fs-" .config | grep "=y" | head -10
        
        echo "6. ğŸŸ¢ ç¼–ç æ”¯æŒ:"
        grep "CONFIG_PACKAGE_kmod-nls-" .config | grep "=y" || echo "âŒ ç¼ºå°‘ç¼–ç æ”¯æŒ"
        
        echo "7. ğŸŸ¢ è‡ªåŠ¨æŒ‚è½½:"
        grep -E "block-mount|automount" .config | grep "=y" || echo "âŒ ç¼ºå°‘è‡ªåŠ¨æŒ‚è½½"
        
        echo "8. ğŸŸ¢ çƒ­æ’æ‹”æ”¯æŒ:"
        grep "CONFIG_PACKAGE_udev" .config | grep "=y" && echo "âœ… udevæ”¯æŒ" || echo "âŒ ç¼ºå°‘udevæ”¯æŒ"
        
        echo "9. ğŸŸ¢ æ–‡ä»¶ä¼ è¾“æ’ä»¶:"
        grep "CONFIG_PACKAGE_luci-app-filetransfer" .config | grep "=y" && echo "âœ… æ–‡ä»¶ä¼ è¾“æ’ä»¶å·²å¯ç”¨" || echo "âŒ æ–‡ä»¶ä¼ è¾“æ’ä»¶æœªå¯ç”¨"
        
        echo "=== ğŸš¨ USBé…ç½®éªŒè¯å®Œæˆ ==="

    - name: åº”ç”¨é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== åº”ç”¨é…ç½® ==="
        make defconfig
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
        
        # ä¿®å¤åŒ…å†²çªé—®é¢˜
        echo "=== ä¿®å¤åŒ…å†²çª ==="
        
        # å¼ºåˆ¶ç¦ç”¨å†²çªçš„åŒ…
        CONFLICT_PACKAGES=(
          "ntfs-3g-utils" 
        )
        
        for pkg in "${CONFLICT_PACKAGES[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${pkg}=y$" .config || grep -q "^CONFIG_PACKAGE_${pkg}=m$" .config; then
                echo "ä¿®å¤å†²çª: ç¦ç”¨ $pkg"
                sed -i "s/^CONFIG_PACKAGE_${pkg}=y$/# CONFIG_PACKAGE_${pkg} is not set/" .config
                sed -i "s/^CONFIG_PACKAGE_${pkg}=m$/# CONFIG_PACKAGE_${pkg} is not set/" .config
            fi
        done
        
        # ç¡®ä¿ ntfs3 ç›¸å…³é…ç½®æ­£ç¡®
        echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config
        
        # 21.02ç‰ˆæœ¬éœ€è¦ntfs3-mountæ¥æ»¡è¶³automountä¾èµ–
        if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
            echo "CONFIG_PACKAGE_ntfs3-mount=y" >> .config
        else
            echo "# CONFIG_PACKAGE_ntfs3-mount is not set" >> .config
        fi
        
        # åœ¨ defconfig ä¹‹åå¼ºåˆ¶ç¦ç”¨ä¸éœ€è¦çš„æ’ä»¶
        echo "=== å¼ºåˆ¶ç¦ç”¨ä¸éœ€è¦çš„æ’ä»¶ ==="
        
        # å®šä¹‰è¦ç¦ç”¨çš„é…ç½®é¡¹åˆ—è¡¨
        UNWANTED_CONFIGS=(
          "CONFIG_PACKAGE_luci-app-passwall"
          "CONFIG_PACKAGE_luci-app-ssr-plus"
          "CONFIG_PACKAGE_luci-app-vssr"
          "CONFIG_PACKAGE_luci-app-rclone"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Haproxy"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_ShadowsocksR_Libev_Client"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Client"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Server"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Simple_Obfs"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_SingBox"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Trojan_Plus"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Geoview"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Plugin"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-ng"
          "CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-webui"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ChinaDNS_NG"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_IPT2Socks"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ShadowsocksR_Libev_Client"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Client"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Server"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Simple_Obfs"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Trojan"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_ShadowsocksR_Libev_Server"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Trojan"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray_plugin"
        )
        
        # å¼ºåˆ¶ç¦ç”¨æ¯ä¸ªé…ç½®é¡¹
        for config in "${UNWANTED_CONFIGS[@]}"; do
          # å¦‚æœé…ç½®é¡¹å­˜åœ¨ä¸”è¢«å¯ç”¨ï¼Œåˆ™ç¦ç”¨å®ƒ
          if grep -q "^${config}=y$" .config || grep -q "^${config}=m$" .config; then
            echo "ç¦ç”¨: $config"
            sed -i "s/^${config}=y$/# ${config} is not set/" .config
            sed -i "s/^${config}=m$/# ${config} is not set/" .config
          fi
        done
        
        # åŸºç¡€æ¨¡å¼å¼ºåˆ¶ç¦ç”¨ TurboACC åŠå…¶è¯­è¨€åŒ…
        if [ "${{ github.event.inputs.config_mode }}" = "base" ]; then
            echo "=== åŸºç¡€æ¨¡å¼å¼ºåˆ¶ç¦ç”¨ TurboACC ==="
            TURBOACC_CONFIGS=(
              "CONFIG_PACKAGE_luci-app-turboacc"
              "CONFIG_PACKAGE_kmod-shortcut-fe"
              "CONFIG_PACKAGE_kmod-fast-classifier"
              "CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn"
            )
            
            for config in "${TURBOACC_CONFIGS[@]}"; do
                if grep -q "^${config}=y$" .config || grep -q "^${config}=m$" .config; then
                    echo "ç¦ç”¨: $config"
                    sed -i "s/^${config}=y$/# ${config} is not set/" .config
                    sed -i "s/^${config}=m$/# ${config} is not set/" .config
                fi
            done
        fi
        
        echo "âœ… å¼ºåˆ¶ç¦ç”¨å®Œæˆ"
        
        # æ˜¾ç¤ºæœ€ç»ˆé…ç½®ä¿¡æ¯
        echo "=== ğŸš¨ æœ€ç»ˆUSBé…ç½®çŠ¶æ€ ==="
        echo "å¯ç”¨çš„åŒ…æ•°é‡: $(grep "^CONFIG_PACKAGE_.*=y$" .config | wc -l)"
        echo "ğŸš¨ å…³é”®USBä¿®å¤æ¨¡å—çŠ¶æ€:"
        grep -E "usb-dwc3|usb-dwc3-qcom|phy-qcom-dwc3|usb-xhci|usb-sunxi|usb-mtk-phy" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y/ âœ…/' | sed 's/ is not set/ âŒ/' | sort
        echo "ğŸŸ¢ é€šç”¨USBæ§åˆ¶å™¨çŠ¶æ€:"
        grep -E "usb-ehci|usb-ohci|usb2-pci|usb-dwc3" .config | grep "=y" || echo "USBæ§åˆ¶å™¨æœªå¯ç”¨"
        echo "ğŸ”µ USBå­˜å‚¨çŠ¶æ€:"
        grep "usb-storage" .config | grep "=y" || echo "USBå­˜å‚¨æœªå¯ç”¨"
        echo "ğŸŸ¢ çƒ­æ’æ‹”æ”¯æŒ:"
        grep "udev" .config | grep "=y" || echo "çƒ­æ’æ‹”æ”¯æŒæœªå¯ç”¨"
        echo "ğŸŸ£ æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ:"
        grep "kmod-fs-" .config | grep "=y" | sed 's/CONFIG_PACKAGE_//' | sed 's/=y/ âœ…/' | sort
        echo "ğŸŸ¡ è‡ªåŠ¨æŒ‚è½½ç›¸å…³åŒ…çŠ¶æ€:"
        grep -E "block-mount|automount|ntfs3-mount" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y/ âœ…/' | sed 's/ is not set/ âŒ/' | sort
        echo "ğŸŸ¢ æ–‡ä»¶ä¼ è¾“æ’ä»¶çŠ¶æ€:"
        grep "luci-app-filetransfer" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y/ âœ…/' | sed 's/ is not set/ âŒ/' | sort

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        echo "âœ… ç½‘ç»œç¯å¢ƒä¿®å¤å®Œæˆ"

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd $BUILD_DIR
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        make -j1 download
        echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd $BUILD_DIR
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        if [ "${{ github.event.inputs.enable_cache }}" = "true" ]; then
            echo "å¯ç”¨ç¼–è¯‘ç¼“å­˜"
            make -j$(nproc) V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        else
            echo "æ™®é€šç¼–è¯‘æ¨¡å¼"
            make -j$(nproc) V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        fi
        echo "ç¼–è¯‘é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
            if [ -f "build.log" ]; then
                echo "=== ç¼–è¯‘é”™è¯¯æ‘˜è¦ ==="
                grep -i "error:\|failed\|undefined" build.log | head -20
            fi
            exit $BUILD_EXIT_CODE
        fi
        echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"

    - name: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        if [ -d "bin/targets" ]; then
            echo "âœ… å›ºä»¶ç›®å½•å­˜åœ¨"
            find bin/targets -name "*.bin" -o -name "*.img" | while read file; do
                echo "å›ºä»¶æ–‡ä»¶: $file ($(du -h "$file" | cut -f1))"
            done
            echo "=== ç”Ÿæˆçš„å›ºä»¶åˆ—è¡¨ ==="
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec ls -la {} \;
        else
            echo "âŒ å›ºä»¶ç›®å½•ä¸å­˜åœ¨"
            exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/config_backup
        retention-days: 7

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•å·²æ¸…ç†"
