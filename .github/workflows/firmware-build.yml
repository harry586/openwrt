name: OpenWrt 固件构建工作流

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (如: ac42u, acrh17, mi3g, k2p)'
        required: true
        default: 'acrh17'
        type: string
      config_type:
        description: '配置类型'
        required: true
        default: 'minimal'
        type: choice
        options: ['minimal', 'normal', 'custom']
      extra_packages:
        description: '额外安装插件 (空格分隔)'
        required: false
        type: string

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出代码仓库
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取所有历史记录，以便查找所有分支

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libssl-dev python3 unzip zlib1g-dev subversion gcc-multilib git curl

    - name: 创建构建目录
      run: |
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR

    - name: 克隆源码
      run: |
        cd $BUILD_DIR
        git clone https://github.com/immortalwrt/immortalwrt.git .
        git checkout openwrt-23.05

    - name: 查找设备检测脚本
      run: |
        echo "=== 查找设备检测脚本 ==="
        echo "当前工作目录: $(pwd)"
        echo "所有分支:"
        git branch -a
        
        # 在所有分支中查找脚本文件
        echo "在所有分支中查找 device_detection.sh..."
        SCRIPT_FOUND=false
        
        # 方法1: 在当前检出内容中查找
        if [ -f "firmware-config/scripts/device_detection.sh" ]; then
          echo "✅ 在当前分支找到脚本: firmware-config/scripts/device_detection.sh"
          SCRIPT_PATH="firmware-config/scripts/device_detection.sh"
          SCRIPT_FOUND=true
        fi
        
        # 方法2: 使用 git ls-tree 在所有分支中查找
        if [ "$SCRIPT_FOUND" = "false" ]; then
          echo "尝试在所有分支中查找..."
          BRANCHES=$(git branch -a | grep -v HEAD | sed 's/^* //' | sed 's/^.* //')
          for branch in $BRANCHES; do
            SCRIPT_IN_BRANCH=$(git ls-tree -r "$branch" --name-only | grep "device_detection.sh" | head -1)
            if [ -n "$SCRIPT_IN_BRANCH" ]; then
              echo "✅ 在分支 $branch 中找到脚本: $SCRIPT_IN_BRANCH"
              # 从该分支检出脚本
              git checkout "$branch" -- "$SCRIPT_IN_BRANCH"
              SCRIPT_PATH="$SCRIPT_IN_BRANCH"
              SCRIPT_FOUND=true
              break
            fi
          done
        fi
        
        # 方法3: 使用 git grep 在所有分支中搜索
        if [ "$SCRIPT_FOUND" = "false" ]; then
          echo "使用 git grep 搜索..."
          SCRIPT_SEARCH=$(git grep -l "device_detection.sh" --all 2>/dev/null | head -1)
          if [ -n "$SCRIPT_SEARCH" ]; then
            echo "✅ 找到包含 device_detection.sh 的文件: $SCRIPT_SEARCH"
            # 提取脚本路径
            SCRIPT_DIR=$(dirname "$SCRIPT_SEARCH")
            if [ -f "$SCRIPT_SEARCH" ]; then
              SCRIPT_PATH="$SCRIPT_SEARCH"
              SCRIPT_FOUND=true
            fi
          fi
        fi
        
        # 方法4: 查找所有 .sh 文件
        if [ "$SCRIPT_FOUND" = "false" ]; then
          echo "查找所有脚本文件..."
          ALL_SCRIPTS=$(find . -name "*.sh" -type f 2>/dev/null | head -10)
          if [ -n "$ALL_SCRIPTS" ]; then
            echo "找到的脚本文件:"
            echo "$ALL_SCRIPTS"
            # 尝试查找包含设备检测功能的脚本
            for script in $ALL_SCRIPTS; do
              if grep -q "detect_device" "$script" 2>/dev/null; then
                echo "✅ 找到设备检测脚本: $script"
                SCRIPT_PATH="$script"
                SCRIPT_FOUND=true
                break
              fi
            done
          fi
        fi
        
        if [ "$SCRIPT_FOUND" = "true" ]; then
          echo "SCRIPT_PATH=$SCRIPT_PATH" >> $GITHUB_ENV
          echo "✅ 脚本查找成功: $SCRIPT_PATH"
        else
          echo "❌ 在所有分支中均未找到设备检测脚本"
          echo "当前目录结构:"
          find . -type f -name "*.sh" 2>/dev/null | head -20
          exit 1
        fi

    - name: 复制设备检测脚本
      run: |
        cd $BUILD_DIR
        echo "=== 复制设备检测脚本 ==="
        echo "源路径: $GITHUB_WORKSPACE/$SCRIPT_PATH"
        echo "目标路径: $(pwd)/device_detection.sh"
        
        # 检查源文件是否存在
        if [ -f "$GITHUB_WORKSPACE/$SCRIPT_PATH" ]; then
          echo "✅ 找到设备检测脚本"
          cp "$GITHUB_WORKSPACE/$SCRIPT_PATH" .
          chmod +x device_detection.sh
          echo "✅ 脚本复制完成"
        else
          echo "❌ 错误: 设备检测脚本不存在于 $GITHUB_WORKSPACE/$SCRIPT_PATH"
          exit 1
        fi

    - name: 智能设备检测
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== 智能设备检测 ==="
        
        # 检查脚本是否存在
        if [ ! -f "device_detection.sh" ]; then
          echo "❌ 错误: device_detection.sh 不存在"
          exit 1
        fi
        
        # 使用独立脚本进行设备检测
        echo "执行设备检测: ${{ github.event.inputs.device_name }}"
        if ./device_detection.sh "${{ github.event.inputs.device_name }}"; then
          echo "✅ 设备检测成功"
          echo "检测结果:"
          echo "PLATFORM: $PLATFORM"
          echo "DEVICE_SHORT_NAME: $DEVICE_SHORT_NAME"
          echo "DEVICE_FULL_NAME: $DEVICE_FULL_NAME"
        else
          echo "❌ 设备检测失败"
          exit 1
        fi

    - name: 更新安装feeds
      run: |
        cd $BUILD_DIR
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成设备配置
      run: |
        cd $BUILD_DIR
        echo "=== 生成设备配置 ==="
        
        # 基础平台配置
        echo "CONFIG_TARGET_${PLATFORM}=y" > .config
        echo "CONFIG_TARGET_${PLATFORM}_generic=y" >> .config
        echo "CONFIG_TARGET_DEVICE_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        
        # 根据平台添加特定配置
        case "$PLATFORM" in
          "ipq40xx")
            echo "CONFIG_PACKAGE_ath10k-firmware-qca4019=y" >> .config
            echo "CONFIG_PACKAGE_ath10k-board-qca4019=y" >> .config
            ;;
          "ramips")
            echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
            ;;
        esac
        
        # 根据配置类型设置
        case "${{ github.event.inputs.config_type }}" in
          "minimal")
            echo "CONFIG_PACKAGE_luci=n" >> .config
            ;;
          "normal"|"custom")
            echo "CONFIG_PACKAGE_luci=y" >> .config
            echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
            ;;
        esac
        
        # 自定义包
        if [ "${{ github.event.inputs.config_type }}" = "custom" ] && [ -n "${{ github.event.inputs.extra_packages }}" ]; then
          for pkg in ${{ github.event.inputs.extra_packages }}; do
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          done
        fi
        
        # 基础系统包
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        
        echo "✅ 配置生成完成"

    - name: 应用配置并编译
      run: |
        cd $BUILD_DIR
        echo "=== 应用配置并编译 ==="
        
        # 应用配置
        make defconfig
        
        # 下载软件包
        make -j4 download
        
        # 编译固件
        make -j$(nproc) V=s

    - name: 验证固件生成
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== 固件生成验证 ==="
        
        if [ -d "bin/targets" ]; then
          echo "✅ 找到目标目录"
          echo "生成的固件:"
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) | sort
        else
          echo "❌ 未找到目标目录 bin/targets"
        fi

    - name: 上传编译产物
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: 上传配置和日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-and-logs-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/device_detection.sh
        retention-days: 7
