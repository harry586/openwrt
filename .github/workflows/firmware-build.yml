name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ - ä¿®å¤ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'è®¾å¤‡åç§° (å¦‚: ac42uç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: 'auto'
        options:
          - auto
          - 23.05
          - 22.03
          - 21.02
          - 19.07
          - 18.06
          - master
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬'
        required: false
        type: string
        default: ''
      config_type:
        description: 'é…ç½®ç±»å‹'
        required: true
        default: 'normal'
        type: choice
        options:
          - minimal
          - normal
          - custom
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ (å¤šä¸ªæ’ä»¶ç”¨ç©ºæ ¼åˆ†éš”ï¼Œå¦‚: "luci-app-ddns luci-app-wol")'
        required: false
        type: string
        default: ''
      disabled_plugins:
        description: 'ç¦ç”¨æ’ä»¶ (å¤šä¸ªæ’ä»¶ç”¨ç©ºæ ¼åˆ†éš”ï¼Œå¦‚: "luci-app-upnp luci-app-sqm")'
        required: false
        type: string
        default: ''
      save_config:
        description: 'ä¿å­˜é…ç½®æ–‡ä»¶'
        required: false
        default: true
        type: boolean
      enable_cache:
        description: 'å¯ç”¨ç¼–è¯‘ç¼“å­˜'
        required: false
        default: true
        type: boolean
      multithreading:
        description: 'å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘'
        type: boolean
        default: true
      ssh_connection:
        description: 'ä½¿ç”¨ SSH è°ƒè¯•'
        type: boolean
        default: false

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    if: ${{ inputs.ssh_connection == false }}
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo
        pip3 install requests urllib3
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"

    - name: å¤åˆ¶æ„å»ºè„šæœ¬
      run: |
        echo "=== å¤åˆ¶æ„å»ºè„šæœ¬ ==="
        cd $GITHUB_WORKSPACE
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•
        mkdir -p $BUILD_DIR/scripts
        mkdir -p $BUILD_DIR/config-templates
        
        # å¤åˆ¶æ‰€æœ‰å¿…è¦çš„è„šæœ¬
        cp firmware-config/scripts/openwrt_build_manager.sh $BUILD_DIR/
        cp firmware-config/scripts/build_helpers.sh $BUILD_DIR/
        cp firmware-config/scripts/smart_package_matcher.sh $BUILD_DIR/
        cp firmware-config/scripts/branch_plugin_detector.sh $BUILD_DIR/
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp firmware-config/configs/base-template.config $BUILD_DIR/config-templates/
        
        cd $BUILD_DIR
        chmod +x *.sh
        echo "âœ… è„šæœ¬å¤åˆ¶å®Œæˆ"

    - name: æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ - ä¿®å¤ç‰ˆ
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ ==="
        
        # è®¾ç½®è€æ—§è®¾å¤‡æ ‡å¿—
        OLD_DEVICE_FLAG="false"
        case "${{ github.event.inputs.device_name }}" in
            "wr841n"|"wr842n"|"wr941n"|"mr3420"|"ar71xx"*)
                OLD_DEVICE_FLAG="true"
                echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§è®¾å¤‡"
                ;;
        esac
        
        # ç¡®å®šç‰ˆæœ¬å‚æ•°
        USER_VERSION=""
        if [ -n "${{ inputs.custom_version }}" ]; then
            USER_VERSION="${{ inputs.custom_version }}"
        elif [ "${{ inputs.version_selection }}" != "auto" ]; then
            USER_VERSION="${{ inputs.version_selection }}"
        fi
        
        echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬: ${USER_VERSION:-è‡ªåŠ¨}"
        echo "è€æ—§è®¾å¤‡: $OLD_DEVICE_FLAG"
        
        # è°ƒç”¨ç‰ˆæœ¬æ£€æµ‹
        echo "=== å¼€å§‹ç‰ˆæœ¬æ£€æµ‹ ==="
        set +e
        OUTPUT=$(./openwrt_build_manager.sh version_detect "${{ github.event.inputs.device_name }}" "$USER_VERSION" "$OLD_DEVICE_FLAG" 2>&1)
        EXIT_CODE=$?
        set -e
        
        if [ $EXIT_CODE -eq 0 ]; then
            echo "$OUTPUT"
            
            # æå–ç¯å¢ƒå˜é‡
            SELECTED_REPO=$(echo "$OUTPUT" | grep "^SELECTED_REPO=" | head -1 | cut -d'=' -f2)
            SELECTED_BRANCH=$(echo "$OUTPUT" | grep "^SELECTED_BRANCH=" | head -1 | cut -d'=' -f2)
            SELECTED_REPO_URL=$(echo "$OUTPUT" | grep "^SELECTED_REPO_URL=" | head -1 | cut -d'=' -f2)
            
            if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
                echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
                echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
                echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
                echo "âœ… ç‰ˆæœ¬æ£€æµ‹å®Œæˆ"
            else
                echo "âŒ ç‰ˆæœ¬æ£€æµ‹å¤±è´¥ï¼šæ— æ³•æå–ç¯å¢ƒå˜é‡"
                echo "SELECTED_REPO: $SELECTED_REPO"
                echo "SELECTED_BRANCH: $SELECTED_BRANCH" 
                echo "SELECTED_REPO_URL: $SELECTED_REPO_URL"
                exit 1
            fi
        else
            echo "âŒ ç‰ˆæœ¬æ£€æµ‹å¤±è´¥ï¼Œé€€å‡ºä»£ç : $EXIT_CODE"
            echo "è¾“å‡ºå†…å®¹:"
            echo "$OUTPUT"
            exit 1
        fi

    - name: åˆ†æ”¯æ’ä»¶æ£€æµ‹ - ä¸¥æ ¼éªŒè¯
      id: branch-plugin-detection
      run: |
        cd $BUILD_DIR
        echo "=== åˆ†æ”¯æ’ä»¶æ£€æµ‹ - ä¸¥æ ¼éªŒè¯ ==="
        
        # æ˜¾ç¤ºå½“å‰ç›®å½•
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        
        # ä¸¥æ ¼éªŒè¯åˆ†æ”¯å¹¶æ£€æµ‹æ’ä»¶
        echo "ğŸ” éªŒè¯åˆ†æ”¯ $SELECTED_BRANCH å¹¶æ£€æµ‹æ’ä»¶..."
        if ./branch_plugin_detector.sh validate_branch "$SELECTED_REPO_URL" "$SELECTED_BRANCH" "verified_plugins.txt"; then
            echo "âœ… åˆ†æ”¯éªŒè¯å’Œæ’ä»¶æ£€æµ‹æˆåŠŸ"
            
            # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ -f "verified_plugins.txt" ]; then
                echo "ğŸ“„ æ’ä»¶åˆ—è¡¨æ–‡ä»¶å·²åˆ›å»º"
                
                # ç»Ÿè®¡æ’ä»¶æ•°é‡ - ä½¿ç”¨å¯é çš„æ–¹æ³•
                TOTAL_PLUGINS=$(grep -c "^- \`" "verified_plugins.txt" 2>/dev/null || echo "0")
                echo "ğŸ“Š æ£€æµ‹åˆ° $TOTAL_PLUGINS ä¸ªå¯ç”¨æ’ä»¶"
                
                # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                echo "ğŸ“ æ–‡ä»¶å¤§å°: $(wc -l < verified_plugins.txt) è¡Œ"
                
                # æ˜¾ç¤ºä¸€äº›æ¨èæ’ä»¶
                echo ""
                echo "ğŸ¯ æ¨èæ’ä»¶ç¤ºä¾‹:"
                if grep -q "luci-app-" "verified_plugins.txt"; then
                    grep -E "luci-app-(turboacc|upnp|wol|sqm|ddns|firewall)" "verified_plugins.txt" | head -5
                else
                    echo "æœªæ‰¾åˆ°æ¨èæ’ä»¶"
                fi
                
                # è®¾ç½®æˆåŠŸæ ‡å¿—
                echo "BRANCH_VALIDATED=true" >> $GITHUB_ENV
                echo "PLUGINS_COUNT=$TOTAL_PLUGINS" >> $GITHUB_ENV
                
            else
                echo "âŒ é”™è¯¯: æ’ä»¶åˆ—è¡¨æ–‡ä»¶æœªåˆ›å»º"
                echo "BRANCH_VALIDATED=false" >> $GITHUB_ENV
                exit 1
            fi
            
        else
            echo "âŒ åˆ†æ”¯éªŒè¯å¤±è´¥: $SELECTED_BRANCH ä¸å­˜åœ¨æˆ–æ’ä»¶æ£€æµ‹å¤±è´¥"
            echo "BRANCH_VALIDATED=false" >> $GITHUB_ENV
            exit 1
        fi

    - name: éªŒè¯æ’ä»¶åˆ—è¡¨æ–‡ä»¶
      if: env.BRANCH_VALIDATED == 'true'
      run: |
        cd $BUILD_DIR
        echo "=== éªŒè¯æ’ä»¶åˆ—è¡¨æ–‡ä»¶ ==="
        
        if [ -f "verified_plugins.txt" ]; then
            echo "âœ… æ’ä»¶åˆ—è¡¨æ–‡ä»¶å­˜åœ¨"
            echo "æ–‡ä»¶è·¯å¾„: $(pwd)/verified_plugins.txt"
            echo "æ–‡ä»¶å¤§å°: $(wc -l < verified_plugins.txt) è¡Œ"
            echo "æ’ä»¶æ•°é‡: $PLUGINS_COUNT"
            echo ""
            echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
            echo "========================"
            head -20 verified_plugins.txt
            echo "========================"
        else
            echo "âŒ é”™è¯¯: æ’ä»¶åˆ—è¡¨æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
        fi

    - name: ä¸Šä¼ æ’ä»¶åˆ—è¡¨
      if: env.BRANCH_VALIDATED == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: æ’ä»¶åˆ—è¡¨-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/verified_plugins.txt
        retention-days: 7

    - name: æ£€æŸ¥åˆ†æ”¯éªŒè¯ç»“æœ
      if: env.BRANCH_VALIDATED == 'false'
      run: |
        echo "âŒ åˆ†æ”¯éªŒè¯å¤±è´¥ï¼Œæ„å»ºç»ˆæ­¢"
        echo "è¯·æ£€æŸ¥åˆ†æ”¯åç§°æ˜¯å¦æ­£ç¡®ï¼Œæˆ–é€‰æ‹©å…¶ä»–å¯ç”¨åˆ†æ”¯"
        exit 1

    - name: å…‹éš†æºç  - å·²éªŒè¯åˆ†æ”¯
      run: |
        cd $BUILD_DIR
        echo "=== å…‹éš†æºç  - å·²éªŒè¯åˆ†æ”¯ ==="
        echo "ä»“åº“: $SELECTED_REPO_URL"
        echo "åˆ†æ”¯: $SELECTED_BRANCH (å·²éªŒè¯å­˜åœ¨)"
        
        # æ¸…ç†ç›®å½•
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        
        # å…‹éš†æºç  - åˆ†æ”¯å·²ç»éªŒè¯å­˜åœ¨
        echo "å…‹éš†å·²éªŒè¯çš„åˆ†æ”¯: $SELECTED_BRANCH"
        if git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . 2>&1; then
            echo "âœ… æºç å…‹éš†å®Œæˆ"
        else
            echo "âŒ æºç å…‹éš†å¤±è´¥"
            exit 1
        fi

    - name: æ¢å¤æ„å»ºè„šæœ¬
      run: |
        cd $BUILD_DIR
        echo "=== æ¢å¤æ„å»ºè„šæœ¬ ==="
        
        # ç¡®ä¿å¿…è¦çš„ç›®å½•å­˜åœ¨
        mkdir -p config-templates
        mkdir -p scripts
        
        cd $GITHUB_WORKSPACE
        
        # å¤åˆ¶æ‰€æœ‰å¿…è¦çš„è„šæœ¬
        cp firmware-config/scripts/openwrt_build_manager.sh $BUILD_DIR/
        cp firmware-config/scripts/build_helpers.sh $BUILD_DIR/
        cp firmware-config/scripts/smart_package_matcher.sh $BUILD_DIR/
        cp firmware-config/scripts/branch_plugin_detector.sh $BUILD_DIR/
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp firmware-config/configs/base-template.config $BUILD_DIR/config-templates/
        
        cd $BUILD_DIR
        chmod +x *.sh
        echo "âœ… è„šæœ¬æ¢å¤å®Œæˆ"

    - name: æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥
      run: |
        cd $BUILD_DIR
        echo "=== æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥ ==="
        # ä¿®å¤ï¼šæ’ä»¶æ£€æŸ¥ä¸ä¼šç»ˆæ­¢æ„å»ºï¼Œåªè¾“å‡ºè­¦å‘Š
        ./openwrt_build_manager.sh plugin_check "$SELECTED_BRANCH" || echo "âš ï¸ æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥å‘ç°è­¦å‘Šï¼Œä½†æ„å»ºå°†ç»§ç»­"

    - name: Feeds é…ç½® - ä¿®å¤ç‰ˆ
      run: |
        cd $BUILD_DIR
        echo "=== Feeds é…ç½® - ä¿®å¤ç‰ˆ ==="
        
        # ä¿®å¤ï¼šä¸ä½¿ç”¨ local å…³é”®å­—ï¼Œç›´æ¥ä½¿ç”¨å˜é‡
        branch="$SELECTED_BRANCH"
        echo "åˆ†æ”¯: $branch"
        
        feeds_branch="$branch"
        if echo "$branch" | grep -q "openwrt-23.05"; then
            feeds_branch="openwrt-23.05"
        elif echo "$branch" | grep -q "openwrt-22.03"; then
            feeds_branch="openwrt-22.03"
        elif echo "$branch" | grep -q "openwrt-21.02"; then
            feeds_branch="openwrt-21.02"
        elif echo "$branch" | grep -q "openwrt-19.07"; then
            feeds_branch="openwrt-19.07"
        else
            echo "âš ï¸ æœªçŸ¥ç‰ˆæœ¬åˆ†æ”¯ï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯: master"
            feeds_branch="master"
        fi
        
        echo "ä½¿ç”¨çš„feedsåˆ†æ”¯: $feeds_branch"
        
        # é…ç½®feeds - ä¿®å¤ç‰ˆï¼šä½¿ç”¨æ­£ç¡®çš„åˆ†æ”¯æ ¼å¼
        echo "src-git packages https://github.com/immortalwrt/packages.git;$feeds_branch" > feeds.conf.default
        echo "src-git luci https://github.com/immortalwrt/luci.git;$feeds_branch" >> feeds.conf.default
        echo "src-git routing https://github.com/openwrt/routing.git;$feeds_branch" >> feeds.conf.default
        echo "src-git telephony https://github.com/openwrt/telephony.git;$feeds_branch" >> feeds.conf.default
        
        echo "âœ… Feeds é…ç½®å®Œæˆ"
        echo "Feedsé…ç½®å†…å®¹:"
        cat feeds.conf.default

    - name: æ›´æ–°å®‰è£… Feeds - ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶æ›´æ–°
      run: |
        cd $BUILD_DIR
        echo "=== æ›´æ–°å®‰è£… Feeds ==="
        ./scripts/feeds update -a -f
        ./scripts/feeds install -a -f
        echo "âœ… Feeds æ›´æ–°å®‰è£…å®Œæˆ"

    - name: è®¾å¤‡æ£€æµ‹
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== è®¾å¤‡æ£€æµ‹ ==="
        
        OUTPUT=$(./openwrt_build_manager.sh device_detect "${{ github.event.inputs.device_name }}")
        echo "$OUTPUT"
        
        # æå–è®¾å¤‡ä¿¡æ¯
        PLATFORM=$(echo "$OUTPUT" | grep "^PLATFORM=" | head -1 | cut -d'=' -f2)
        DEVICE_SHORT_NAME=$(echo "$OUTPUT" | grep "^DEVICE_SHORT_NAME=" | head -1 | cut -d'=' -f2)
        DEVICE_FULL_NAME=$(echo "$OUTPUT" | grep "^DEVICE_FULL_NAME=" | head -1 | cut -d'=' -f2)
        
        if [ -n "$PLATFORM" ] && [ -n "$DEVICE_SHORT_NAME" ] && [ -n "$DEVICE_FULL_NAME" ]; then
            echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
            echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
            echo "âœ… è®¾å¤‡æ£€æµ‹å®Œæˆ"
        else
            echo "âŒ è®¾å¤‡æ£€æµ‹å¤±è´¥"
            exit 1
        fi

    - name: é…ç½®åŠ è½½å’Œæ™ºèƒ½åŒ…åŒ¹é… - ä¿®å¤ç‰ˆ
      run: |
        cd $BUILD_DIR
        echo "=== é…ç½®åŠ è½½å’Œæ™ºèƒ½åŒ…åŒ¹é… ==="
        
        # æ˜¾ç¤ºæ’ä»¶ä¿¡æ¯
        echo "é¢å¤–å®‰è£…æ’ä»¶: ${{ inputs.extra_packages }}"
        echo "ç¦ç”¨æ’ä»¶: ${{ inputs.disabled_plugins }}"
        
        # ç¡®ä¿feedså°±ç»ª
        echo "=== ç¡®ä¿feedså°±ç»ª ==="
        ./scripts/feeds update -a > /dev/null 2>&1
        ./scripts/feeds install -a > /dev/null 2>&1
        
        # æ£€æŸ¥æ’ä»¶åˆ—è¡¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™éªŒè¯ç”¨æˆ·è¯·æ±‚çš„æ’ä»¶
        if [ -f "verified_plugins.txt" ]; then
            echo "=== éªŒè¯ç”¨æˆ·è¯·æ±‚çš„æ’ä»¶ ==="
            if [ -n "${{ inputs.extra_packages }}" ]; then
                for pkg in ${{ inputs.extra_packages }}; do
                    if grep -q "^\`$pkg\`" "verified_plugins.txt"; then
                        echo "âœ… æ’ä»¶ $pkg åœ¨åˆ†æ”¯ä¸­å­˜åœ¨"
                    else
                        echo "âš ï¸  è­¦å‘Š: æ’ä»¶ $pkg åœ¨åˆ†æ”¯ $SELECTED_BRANCH ä¸­ä¸å­˜åœ¨"
                    fi
                done
            fi
        fi
        
        # ç›´æ¥è°ƒç”¨é…ç½®åŠ è½½å‡½æ•°
        ./openwrt_build_manager.sh config_load \
            "${{ inputs.config_type }}" \
            "$PLATFORM" \
            "$DEVICE_SHORT_NAME" \
            "$SELECTED_BRANCH" \
            "${{ github.event.inputs.device_name }}" \
            "${{ inputs.extra_packages }}" \
            "${{ inputs.disabled_plugins }}"

    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        cd $BUILD_DIR
        echo "=== éªŒè¯é…ç½®æ–‡ä»¶ ==="
        
        if [ -f ".config" ]; then
            echo "âœ… .config æ–‡ä»¶å·²ç”Ÿæˆ"
            echo "é…ç½®æ–‡ä»¶å¤§å°: $(wc -l < .config) è¡Œ"
            echo "å¯ç”¨çš„åŒ…æ•°é‡: $(grep "^CONFIG_PACKAGE_.*=y$" .config | wc -l)"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±åŒ…æŠ¥å‘Š
            if [ -f "missing_packages.txt" ]; then
                echo "âš ï¸  å‘ç°ç¼ºå¤±åŒ…æŠ¥å‘Š:"
                cat missing_packages.txt | head -20
            fi
            
            if [ -f "package_fix_report.txt" ]; then
                echo "ğŸ“‹ åŒ…ä¿®å¤æŠ¥å‘Š:"
                cat package_fix_report.txt | head -30
            fi
        else
            echo "âŒ .config æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
        fi

    - name: åŒ…å¯ç”¨æ€§æ£€æŸ¥ (æ™ºèƒ½æ¨¡å¼)
      id: package-check
      run: |
        cd $BUILD_DIR
        echo "=== åŒ…å¯ç”¨æ€§æ£€æŸ¥ ==="
        
        # è¿è¡ŒåŒ…æ£€æŸ¥
        OUTPUT=$(./openwrt_build_manager.sh package_check ".")
        PACKAGE_CHECK_EXIT_CODE=$?
        
        echo "$OUTPUT"
        
        if [ $PACKAGE_CHECK_EXIT_CODE -eq 0 ]; then
            echo "âœ… åŒ…æ£€æŸ¥é€šè¿‡"
        else
            echo "âŒ åŒ…æ£€æŸ¥å‘ç°ç¼ºå¤±åŒ…ï¼Œåœæ­¢æ„å»º"
            exit $PACKAGE_CHECK_EXIT_CODE
        fi

    - name: è‡ªå®šä¹‰æ–‡ä»¶é›†æˆ
      run: |
        cd $BUILD_DIR
        echo "=== è‡ªå®šä¹‰æ–‡ä»¶é›†æˆ ==="
        ./openwrt_build_manager.sh custom_integrate "$GITHUB_WORKSPACE"

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        echo "âœ… ç½‘ç»œç¯å¢ƒä¿®å¤å®Œæˆ"

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd $BUILD_DIR
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        export MAKE_JOBS=${{ inputs.multithreading && '$(nproc)' || '1' }}
        make -j$MAKE_JOBS download
        echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶ (å¸¦è¯¦ç»†æ—¥å¿—)
      run: |
        cd $BUILD_DIR
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        export MAKE_JOBS=${{ inputs.multithreading && '$(nproc)' || '1' }}
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        mkdir -p logs
        
        if [ "${{ inputs.enable_cache }}" = "true" ]; then
            echo "ğŸ”„ å¯ç”¨ç¼–è¯‘ç¼“å­˜"
            # ä¿å­˜è¯¦ç»†æ—¥å¿—
            make -j$MAKE_JOBS V=s 2>&1 | tee -a build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        else
            echo "ğŸ”„ æ™®é€šç¼–è¯‘æ¨¡å¼"
            make -j$MAKE_JOBS V=s 2>&1 | tee -a build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        fi
        
        echo "ç¼–è¯‘é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
            exit $BUILD_EXIT_CODE
        fi
        echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"

    - name: é”™è¯¯åˆ†æ
      if: failure()
      run: |
        cd $BUILD_DIR
        echo "=== é”™è¯¯åˆ†æ ==="
        ./openwrt_build_manager.sh error_analyze "."

    - name: æ”¶é›†æ„å»ºæ—¥å¿—å’ŒæŠ¥å‘Š
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== æ”¶é›†æ„å»ºæ—¥å¿—å’ŒæŠ¥å‘Š ==="
        
        # åˆ›å»ºæŠ¥å‘Šç›®å½•
        mkdir -p build-reports
        
        # æ”¶é›†é‡è¦æ–‡ä»¶
        [ -f "build.log" ] && cp build.log build-reports/ || echo "æ„å»ºæ—¥å¿—ä¸å­˜åœ¨"
        [ -f "missing_packages.txt" ] && cp missing_packages.txt build-reports/ || echo "ç¼ºå¤±åŒ…æŠ¥å‘Šä¸å­˜åœ¨"
        [ -f "package_fix_report.txt" ] && cp package_fix_report.txt build-reports/ || echo "åŒ…ä¿®å¤æŠ¥å‘Šä¸å­˜åœ¨"
        [ -f ".config" ] && cp .config build-reports/final-config.txt || echo "æœ€ç»ˆé…ç½®ä¸å­˜åœ¨"
        [ -f "verified_plugins.txt" ] && cp verified_plugins.txt build-reports/ || echo "æ’ä»¶åˆ—è¡¨ä¸å­˜åœ¨"
        
        echo "âœ… æ„å»ºæŠ¥å‘Šæ”¶é›†å®Œæˆ"

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        if [ -d "bin/targets" ]; then
            echo "âœ… å›ºä»¶ç›®å½•å­˜åœ¨"
            find bin/targets -name "*.bin" -o -name "*.img" | while read file; do
                echo "ğŸ“¦ å›ºä»¶æ–‡ä»¶: $file ($(du -h "$file" | cut -f1))"
            done
        else
            echo "âŒ å›ºä»¶ç›®å½•ä¸å­˜åœ¨"
            exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: å›ºä»¶-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ inputs.config_type }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ æ„å»ºæŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: æ„å»ºæŠ¥å‘Š-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/build-reports/
        retention-days: 7

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•å·²æ¸…ç†"

  build-firmware-ssh:
    if: ${{ inputs.ssh_connection == true }}
    name: ğŸš€ ç¼–è¯‘ - SSHè°ƒè¯•ç‰ˆ
    runs-on: ubuntu-22.04
    steps:
    - name: å¼€å¯ SSH æœåŠ¡
      uses: lhotari/action-upterm@v1
      with:
        wait-timeout-minutes: 30
    - name: ç¼–è¯‘å‰æç¤º
      run: |
        echo "ğŸš€ SSHè°ƒè¯•æ¨¡å¼å·²å¯åŠ¨"
