#ã€firmware-build.yml-00ã€‘
# OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ - ç³»ç»Ÿä¸»å…¥å£
# ç‰ˆæœ¬: 3.0.1
# æœ€åæ›´æ–°: 2026-02-13

name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§°"
        required: true
        default: "ac42u"
        type: choice
        options: ["ac42u", "cmcc_rax3000m", "netgear_3800"]
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©"
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”"
        required: false
        type: string
        default: ""
      enable_parallel:
        description: "âš¡ å¯ç”¨æ™ºèƒ½å¹¶è¡Œä¼˜åŒ–"
        required: false
        type: boolean
        default: true

env:
  BUILD_DIR: "/mnt/openwrt-build"
  REPO_ROOT: "${{ github.workspace }}"
  ENABLE_PARALLEL: "${{ github.event.inputs.enable_parallel }}"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
#ã€firmware-build.yml-00-endã€‘

    steps:
      #ã€firmware-build.yml-01ã€‘
      - name: "01. ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆUTC+8æ—¶åŒºï¼‰"
        run: |
          echo "=== æ­¥éª¤01: ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆUTC+8æ—¶åŒºï¼‰ ==="
          
          sudo timedatectl set-timezone Asia/Shanghai 2>/dev/null || true
          
          START_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          echo "ğŸ• å¼€å§‹æ—¶é—´: $START_TIME"
          
          TIMESTAMP_LOCAL=$(date +'%Y%m%d_%H%M%S')
          TIMESTAMP_SEC="${{ github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}-$TIMESTAMP_LOCAL"
          
          echo "TIMESTAMP_SEC=$TIMESTAMP_SEC" >> $GITHUB_ENV
          echo "START_TIME=$START_TIME" >> $GITHUB_ENV
          
          echo "âœ… ç”Ÿæˆæ—¶é—´æˆ³: $TIMESTAMP_SEC"
          echo "ğŸ“‹ æ„å»ºé…ç½®:"
          echo "  è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "  ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "  æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "  å¹¶è¡Œä¼˜åŒ–: ${{ github.event.inputs.enable_parallel }}"
      #ã€firmware-build.yml-01-endã€‘

      #ã€firmware-build.yml-02ã€‘
      - name: "02. ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        run: |
          echo "=== æ­¥éª¤02: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç  ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤02 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          
          echo "ğŸ” è·å–ä»“åº“é»˜è®¤åˆ†æ”¯..."
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "âœ… é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
          
          echo "ğŸ“¥ ä¸‹è½½æºä»£ç å‹ç¼©åŒ…..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" \
            -o source.tar.gz
          
          if [ ! -f "source.tar.gz" ]; then
            echo "âŒ é”™è¯¯: ä¸‹è½½æºä»£ç å‹ç¼©åŒ…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(ls -lh source.tar.gz | awk '{print $5}')"
          
          echo "ğŸ“¦ è§£å‹æºä»£ç ..."
          tar -xzf source.tar.gz --strip-components=1
          
          echo "ğŸ” æ£€æŸ¥è§£å‹ç»“æœ..."
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âœ… æºä»£ç è§£å‹æˆåŠŸ"
            echo "âœ… ä¸»è„šæœ¬å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
            
            echo "ğŸ“ å¤åˆ¶æ–‡ä»¶åˆ°å·¥ä½œåŒº..."
            mkdir -p ${{ github.workspace }}
            
            if [ -d "firmware-config/build-Compiler-file" ]; then
              echo "âš ï¸ å‘ç°ç¼–è¯‘å™¨ç›®å½•ï¼Œæ’é™¤ä¸å¤åˆ¶"
              rm -rf firmware-config/build-Compiler-file
            fi
            
            rsync -av --exclude='.git' . ${{ github.workspace }}/
            
            echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
            
            mkdir -p /tmp/build-artifacts/source-archive
            cp source.tar.gz /tmp/build-artifacts/source-archive/
            echo "ğŸ“¦ æºä»£ç å·²ä¿å­˜åˆ°: /tmp/build-artifacts/source-archive/"
          else
            echo "âŒ é”™è¯¯: æºä»£ç è§£å‹å¤±è´¥ï¼Œé‡è¦æ–‡ä»¶ç¼ºå¤±"
            ls -la
            exit 1
          fi
          
          cd /tmp
          rm -rf openwrt-source
          echo "âœ… æ­¥éª¤02 å®Œæˆ"
      #ã€firmware-build.yml-02-endã€‘

      #ã€firmware-build.yml-03ã€‘
      - name: "03. ä¸Šä¼ æºä»£ç Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: source-${{ env.TIMESTAMP_SEC }}
          path: /tmp/build-artifacts/source-archive/
          retention-days: 7
          if-no-files-found: error
      #ã€firmware-build.yml-03-endã€‘

      #ã€firmware-build.yml-04ã€‘
      - name: "04. ä¿®å¤æƒé™é—®é¢˜"
        run: |
          echo "=== æ­¥éª¤04: ä¿®å¤æƒé™é—®é¢˜ ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤04 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ”§ ä¿®å¤æ‰€æœ‰è„šæœ¬çš„æ‰§è¡Œæƒé™..."
          
          if [ -f "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh"
            echo "âœ… ä¿®å¤ä¸»è„šæœ¬æƒé™"
          else
            echo "âŒ é”™è¯¯: ä¸»è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ -f "${{ github.workspace }}/support.sh" ]; then
            chmod +x "${{ github.workspace }}/support.sh"
            echo "âœ… ä¿®å¤support.shæƒé™"
          else
            echo "âŒ é”™è¯¯: support.shä¸å­˜åœ¨"
            exit 1
          fi
          
          find "${{ github.workspace }}/firmware-config/scripts" -name "*.sh" -exec chmod +x {} \;
          echo "âœ… ä¿®å¤æ‰€æœ‰è„šæœ¬æƒé™å®Œæˆ"
      #ã€firmware-build.yml-04-endã€‘

      #ã€firmware-build.yml-05ã€‘
      - name: "05. å®‰è£…åŸºç¡€å·¥å…·ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤05: å®‰è£…åŸºç¡€å·¥å…·ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step05_install_basic_tools
      #ã€firmware-build.yml-05-endã€‘

      #ã€firmware-build.yml-06ã€‘
      - name: "06. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤06: åˆå§‹ç©ºé—´æ£€æŸ¥ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step06_initial_space_check
      #ã€firmware-build.yml-06-endã€‘

      #ã€firmware-build.yml-07ã€‘
      - name: "07. åˆ›å»ºæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤07: åˆ›å»ºæ„å»ºç›®å½• ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step07_create_build_dir
      #ã€firmware-build.yml-07-endã€‘

      #ã€firmware-build.yml-08ã€‘
      - name: "08. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤08: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step08_initialize_build_env \
            "${{ github.event.inputs.device_name }}" \
            "${{ github.event.inputs.version_selection }}" \
            "${{ github.event.inputs.config_mode }}"
      #ã€firmware-build.yml-08-endã€‘

      #ã€firmware-build.yml-09ã€‘
      - name: "09. ä¸‹è½½OpenWrtå®˜æ–¹SDK"
        run: |
          echo "=== æ­¥éª¤09: ä¸‹è½½OpenWrtå®˜æ–¹SDK ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step09_download_sdk \
            "${{ github.event.inputs.device_name }}"
      #ã€firmware-build.yml-09-endã€‘

      #ã€firmware-build.yml-10ã€‘
      - name: "10. éªŒè¯SDKä¸‹è½½ç»“æœ"
        run: |
          echo "=== æ­¥éª¤10: éªŒè¯SDKä¸‹è½½ç»“æœ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step10_verify_sdk
      #ã€firmware-build.yml-10-endã€‘

      #ã€firmware-build.yml-11ã€‘
      - name: "11. æ·»åŠ TurboACCæ”¯æŒ"
        run: |
          echo "=== æ­¥éª¤11: æ·»åŠ TurboACCæ”¯æŒ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step11_add_turboacc
      #ã€firmware-build.yml-11-endã€‘

      #ã€firmware-build.yml-12ã€‘
      - name: "12. é…ç½®Feeds"
        run: |
          echo "=== æ­¥éª¤12: é…ç½®Feeds ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step12_configure_feeds
      #ã€firmware-build.yml-12-endã€‘

      #ã€firmware-build.yml-13ã€‘
      - name: "13. å®‰è£…TurboACCåŒ…"
        if: github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤13: å®‰è£…TurboACCåŒ… ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step13_install_turboacc
      #ã€firmware-build.yml-13-endã€‘

      #ã€firmware-build.yml-14ã€‘
      - name: "14. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤14: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step14_pre_build_space_check
      #ã€firmware-build.yml-14-endã€‘

      #ã€firmware-build.yml-15ã€‘
      - name: "15. æ™ºèƒ½é…ç½®ç”Ÿæˆã€ä¿®å¤ç‰ˆã€‘"
        run: |
          echo "=== æ­¥éª¤15: æ™ºèƒ½é…ç½®ç”Ÿæˆã€ä¿®å¤ç‰ˆã€‘ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step15_generate_config \
            "${{ github.event.inputs.extra_packages }}"
      #ã€firmware-build.yml-15-endã€‘

      #ã€firmware-build.yml-16ã€‘
      - name: "16. éªŒè¯USBé…ç½®"
        run: |
          echo "=== æ­¥éª¤16: éªŒè¯USBé…ç½® ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step16_verify_usb
      #ã€firmware-build.yml-16-endã€‘

      #ã€firmware-build.yml-17ã€‘
      - name: "17. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤17: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step17_check_usb_drivers
      #ã€firmware-build.yml-17-endã€‘

      #ã€firmware-build.yml-18ã€‘
      - name: "18. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯"
        run: |
          echo "=== æ­¥éª¤18: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤18 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          echo "ğŸ”„ è°ƒç”¨ä¸»è„šæœ¬çš„ apply_config å‡½æ•°..."
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            apply_config
          
          echo "âœ… æ­¥éª¤18 å®Œæˆ"
      #ã€firmware-build.yml-18-endã€‘

      #ã€firmware-build.yml-19ã€‘
      - name: "19. å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤19: å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤19 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          if [ ! -f ".config" ]; then
            echo "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
          echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
          echo "ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < .config)"
          
          mkdir -p ${{ github.workspace }}/firmware-config/config-backup
          BACKUP_FILE="${{ github.workspace }}/firmware-config/config-backup/config_${{ env.TIMESTAMP_SEC }}.config"
          
          cp .config "$BACKUP_FILE"
          echo "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½åˆ°: $BACKUP_FILE"
      #ã€firmware-build.yml-19-endã€‘

      #ã€firmware-build.yml-20ã€‘
      - name: "20. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤20: ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step20_fix_network
      #ã€firmware-build.yml-20-endã€‘

      #ã€firmware-build.yml-21ã€‘
      - name: "21. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== æ­¥éª¤21: ä¸‹è½½ä¾èµ–åŒ… ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step21_download_deps
      #ã€firmware-build.yml-21-endã€‘

      #ã€firmware-build.yml-22ã€‘
      - name: "22. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤22: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step22_integrate_custom_files
      #ã€firmware-build.yml-22-endã€‘

      #ã€firmware-build.yml-23ã€‘
      - name: "23. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤23: å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step23_pre_build_check
      #ã€firmware-build.yml-23-endã€‘

      #ã€firmware-build.yml-24ã€‘
      - name: "24. ç¼–è¯‘å‰ç©ºé—´ç¡®è®¤"
        run: |
          echo "=== æ­¥éª¤24: ç¼–è¯‘å‰ç©ºé—´ç¡®è®¤ ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤24 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          df -h /mnt
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1 | awk '{print $1}')
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
      #ã€firmware-build.yml-24-endã€‘

      #ã€firmware-build.yml-25ã€‘
      - name: "25. ç¼–è¯‘å›ºä»¶"
        run: |
          echo "=== æ­¥éª¤25: ç¼–è¯‘å›ºä»¶ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step25_build_firmware \
            "${{ env.ENABLE_PARALLEL }}"
      #ã€firmware-build.yml-25-endã€‘

      #ã€firmware-build.yml-26ã€‘
      - name: "26. æ£€æŸ¥æ„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤26: æ£€æŸ¥æ„å»ºäº§ç‰© ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step26_check_artifacts
      #ã€firmware-build.yml-26-endã€‘

      #ã€firmware-build.yml-27ã€‘
      - name: "27. ä¸Šä¼ å›ºä»¶"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.TIMESTAMP_SEC }}
          path: /mnt/openwrt-build/bin/targets/
          retention-days: 7
          if-no-files-found: error
      #ã€firmware-build.yml-27-endã€‘

      #ã€firmware-build.yml-28ã€‘
      - name: "28. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ env.TIMESTAMP_SEC }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
          if-no-files-found: error
      #ã€firmware-build.yml-28-endã€‘

      #ã€firmware-build.yml-29ã€‘
      - name: "29. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== æ­¥éª¤29: ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step29_post_build_space_check
      #ã€firmware-build.yml-29-endã€‘

      #ã€firmware-build.yml-30ã€‘
      - name: "30. ç¼–è¯‘æ€»ç»“"
        if: always()
        run: |
          echo "=== æ­¥éª¤30: ç¼–è¯‘æ€»ç»“ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step30_build_summary \
            "${{ github.event.inputs.device_name }}" \
            "${{ github.event.inputs.version_selection }}" \
            "${{ github.event.inputs.config_mode }}" \
            "${{ env.TIMESTAMP_SEC }}" \
            "${{ github.event.inputs.enable_parallel }}"
      #ã€firmware-build.yml-30-endã€‘
#ã€firmware-build.yml-99ã€‘
# å·¥ä½œæµæ–‡ä»¶ç»“æŸ
#ã€firmware-build.yml-99-endã€‘
