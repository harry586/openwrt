name: OpenWrt æ™ºèƒ½å›ºä»¶æž„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆ - Git LFS ä¿®å¤ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ðŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, r3gç­‰)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ðŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ðŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºŽæµ‹è¯•ç¼–è¯‘
          ðŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®
          
          ðŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚
        required: false
        type: string
        default: ""
      enable_cache:
        description: "âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)"
        required: false
        default: true
        type: boolean
      commit_toolchain:
        description: "ðŸ’¾ æäº¤å·¥å…·é“¾åˆ°ä»“åº“ (èŠ‚çœä¸‹æ¬¡ç¼–è¯‘æ—¶é—´)"
        required: false
        default: false
        type: boolean
      use_git_archive:
        description: "ðŸ“¦ ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç ï¼ˆå¿«é€Ÿä¸‹è½½ï¼ŒæŽ’é™¤å¤§æ–‡ä»¶ï¼‰"
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  GIT_LFS_SKIP_SMUDGE: 1

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      - name: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç ï¼ˆæŽ’é™¤Toolchainï¼‰
        if: github.event.inputs.use_git_archive == 'true'
        run: |
          echo "=== ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç  ==="
          echo "ðŸ”„ ä»ŽGitHub APIèŽ·å–æºä»£ç åŽ‹ç¼©åŒ…ï¼ˆæŽ’é™¤firmware-config/Toolchain/ï¼‰"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          
          # èŽ·å–é»˜è®¤åˆ†æ”¯
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
          
          # ä½¿ç”¨Git Archive APIä¸‹è½½åŽ‹ç¼©åŒ…
          echo "ä¸‹è½½æºä»£ç åŽ‹ç¼©åŒ…..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" -o source.tar.gz
          
          if [ ! -f "source.tar.gz" ]; then
            echo "âŒ ä¸‹è½½æºä»£ç åŽ‹ç¼©åŒ…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(ls -lh source.tar.gz | awk '{print $5}')"
          
          # è§£åŽ‹åŽ‹ç¼©åŒ…
          echo "è§£åŽ‹æºä»£ç ..."
          tar -xzf source.tar.gz --strip-components=1
          
          # æ£€æŸ¥è§£åŽ‹ç»“æžœ
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âœ… æºä»£ç è§£åŽ‹æˆåŠŸ"
            echo "é‡è¦æ–‡ä»¶å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
            
            # å¤åˆ¶åˆ°å·¥ä½œåŒº - ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–¹å¼
            echo "å¤åˆ¶æ–‡ä»¶åˆ°å·¥ä½œåŒº..."
            
            # ç¡®ä¿å·¥ä½œåŒºç›®å½•å­˜åœ¨
            mkdir -p ${{ github.workspace }}
            
            # ä½¿ç”¨rsyncå¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼ŒæŽ’é™¤.gitç›®å½•å’ŒToolchainç›®å½•
            rsync -av --exclude='.git' --exclude='firmware-config/Toolchain' . ${{ github.workspace }}/
            
            # ç¡®ä¿è„šæœ¬æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
            chmod +x ${{ github.workspace }}/firmware-config/scripts/*.sh 2>/dev/null || true
            
            echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
            
            # ä¿å­˜æºä»£ç åŽ‹ç¼©åŒ…ä½œä¸ºæž„å»ºäº§ç‰©
            mkdir -p /tmp/build-artifacts/source-archive
            cp source.tar.gz /tmp/build-artifacts/source-archive/
          else
            echo "âŒ æºä»£ç è§£åŽ‹å¤±è´¥ï¼Œé‡è¦æ–‡ä»¶ç¼ºå¤±"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          cd /tmp
          rm -rf openwrt-source
          echo "âœ… Git Archive APIä¸‹è½½å®Œæˆ"
      
      # åªåœ¨å¤±è´¥æ—¶ä¸Šä¼ æºä»£ç ï¼ˆä½œä¸ºå¤‡ä»½ï¼‰
      - name: å¤‡ä»½Git Archiveæºä»£ç ï¼ˆä»…å¤±è´¥æ—¶ï¼‰
        if: github.event.inputs.use_git_archive == 'true' && failure()
        uses: actions/upload-artifact@v4
        with:
          name: git-archive-source-backup-${{ github.event.inputs.device_name }}-${{ github.run_id }}
          path: /tmp/build-artifacts/source-archive/
          retention-days: 3
      
      - name: å®‰è£… Git LFS
        if: github.event.inputs.use_git_archive == 'false'
        run: |
          echo "=== å®‰è£… Git LFS ==="
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git lfs install --skip-smudge
          echo "âœ… Git LFS å®‰è£…å®Œæˆ"
      
      - name: æ£€å‡ºé…ç½®ä»“åº“ (å¯ç”¨ LFS)
        if: github.event.inputs.use_git_archive == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          lfs: true
      
      - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
        run: |
          echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
          # æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶å¹¶è®¾ç½®æƒé™
          if [ -d "firmware-config/scripts" ]; then
            find firmware-config/scripts -name "*.sh" -exec chmod +x {} \;
            echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"
          else
            echo "âš ï¸  firmware-config/scripts ç›®å½•ä¸å­˜åœ¨"
            # å°è¯•åœ¨å…¶ä»–ä½ç½®æŸ¥æ‰¾
            find . -name "*.sh" -type f | head -5
          fi
      
      - name: è®¾ç½® Git LFS é…ç½®
        if: github.event.inputs.use_git_archive == 'false'
        run: |
          echo "=== è®¾ç½® Git LFS é…ç½® ==="
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global http.postBuffer 524288000
          git lfs install --force
          git lfs pull
          echo "âœ… Git LFS é…ç½®å®Œæˆ"
      
      - name: æ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€
        if: github.event.inputs.use_git_archive == 'false'
        run: |
          echo "=== æ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            firmware-config/scripts/build_firmware_main.sh check_large_files
          else
            echo "âš ï¸  è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æ£€æŸ¥"
          fi
      
      - name: å¼ºåˆ¶æ‹‰å–Git LFSæ–‡ä»¶
        if: github.event.inputs.use_git_archive == 'false'
        run: |
          echo "=== å¼ºåˆ¶æ‹‰å–Git LFSæ–‡ä»¶ ==="
          git lfs pull --force || echo "Git LFSæ‹‰å–å¤±è´¥ï¼Œç»§ç»­æž„å»º..."
          # æ£€æŸ¥LFSæ–‡ä»¶çŠ¶æ€
          echo "Git LFSæ–‡ä»¶çŠ¶æ€:"
          git lfs ls-files | head -20 || echo "æ— LFSæ–‡ä»¶æˆ–æœªè·Ÿè¸ª"
      
      - name: æ£€æŸ¥å·¥å…·é“¾ç›®å½•çŠ¶æ€
        run: |
          echo "=== æ£€æŸ¥ä»“åº“ä¸­çš„å·¥å…·é“¾çŠ¶æ€ ==="
          TOOLCHAIN_DIR="${{ github.workspace }}/firmware-config/Toolchain"
          
          if [ -d "$TOOLCHAIN_DIR" ]; then
            echo "âœ… å·¥å…·é“¾ç›®å½•å­˜åœ¨"
            echo "è·¯å¾„: $TOOLCHAIN_DIR"
            echo "å·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh "$TOOLCHAIN_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            echo "å·¥å…·é“¾ç›®å½•ç»“æž„:"
            find "$TOOLCHAIN_DIR" -maxdepth 3 -type d 2>/dev/null | sort
            
            # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
            file_count=$(find "$TOOLCHAIN_DIR" -type f 2>/dev/null | wc -l)
            echo "å·¥å…·é“¾æ–‡ä»¶æ€»æ•°: $file_count"
            
            if [ $file_count -gt 0 ]; then
              echo "âœ… å·¥å…·é“¾ç›®å½•éžç©º"
              # æ˜¾ç¤ºä¸€äº›å…³é”®æ–‡ä»¶
              echo "å…³é”®æ–‡ä»¶:"
              find "$TOOLCHAIN_DIR" -type f \( -name "*gcc*" -o -name "*.info" \) 2>/dev/null | head -10
            else
              echo "âš ï¸  å·¥å…·é“¾ç›®å½•ä¸ºç©º"
            fi
          else
            echo "â„¹ï¸  å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°ç›®å½•"
            mkdir -p "$TOOLCHAIN_DIR"
          fi
      
      - name: åˆå§‹ç©ºé—´æ£€æŸ¥
        run: |
          echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
            exit 1
          fi
          echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"
      
      - name: åˆå§‹åŒ–å·¥å…·é“¾ç›®å½•
        run: |
          echo "=== åˆå§‹åŒ–å·¥å…·é“¾ç›®å½• ==="
          # ç›´æŽ¥æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ï¼Œä¸ä¾èµ–è„šæœ¬
          mkdir -p firmware-config/Toolchain
          mkdir -p firmware-config/Toolchain/common
          mkdir -p firmware-config/Toolchain/openwrt-21.02
          mkdir -p firmware-config/Toolchain/openwrt-23.05
          echo "âœ… å·¥å…·é“¾ç›®å½•åˆå§‹åŒ–å®Œæˆ"
      
      - name: è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ
        run: |
          echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
          sudo apt-get update
          
          # åŸºç¡€ç¼–è¯‘å·¥å…·
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip \
            zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath \
            libpython3-dev python3 python3-dev python3-pip python3-setuptools \
            python3-yaml xsltproc zip subversion ninja-build automake autoconf \
            libtool pkg-config help2man texinfo aria2 liblz4-dev zstd \
            libcurl4-openssl-dev groff texlive texinfo cmake \
            curl wget net-tools iputils-ping dnsutils \
            openssh-client ca-certificates gnupg lsb-release \
            squashfs-tools dosfstools e2fsprogs mtools \
            parted fdisk gdisk hdparm smartmontools \
            git-lfs
          
          # åˆå§‹åŒ–Git LFS
          git lfs install || echo "Git LFSåˆå§‹åŒ–å¤±è´¥ï¼Œä½†å°†ç»§ç»­"
          echo "âœ… ç¼–è¯‘çŽ¯å¢ƒè®¾ç½®å®Œæˆ"
      
      - name: åˆ›å»ºæž„å»ºç›®å½•
        run: |
          echo "=== åˆ›å»ºæž„å»ºç›®å½• ==="
          sudo mkdir -p /mnt/openwrt-build
          sudo chown -R $USER:$USER /mnt/openwrt-build
          sudo chmod -R 755 /mnt/openwrt-build
          echo "âœ… æž„å»ºç›®å½•åˆ›å»ºå®Œæˆ: /mnt/openwrt-build"
      
      - name: åˆå§‹åŒ–æž„å»ºçŽ¯å¢ƒ
        run: |
          echo "=== åˆå§‹åŒ–æž„å»ºçŽ¯å¢ƒ ==="
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          
          cd /mnt/openwrt-build
          
          # ç‰ˆæœ¬é€‰æ‹©
          if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            SELECTED_BRANCH="openwrt-23.05"
          else
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            SELECTED_BRANCH="openwrt-21.02"
          fi
          
          # è®¾å¤‡é…ç½®
          case "${{ github.event.inputs.device_name }}" in
            "ac42u"|"acrh17")
              TARGET="ipq40xx"
              SUBTARGET="generic"
              DEVICE="asus_rt-ac42u"
              ;;
            "mi_router_4a_gigabit"|"r4ag")
              TARGET="ramips"
              SUBTARGET="mt76x8"
              DEVICE="xiaomi_mi-router-4a-gigabit"
              ;;
            "mi_router_3g"|"r3g")
              TARGET="ramips"
              SUBTARGET="mt7621"
              DEVICE="xiaomi_mi-router-3g"
              ;;
            *)
              TARGET="ipq40xx"
              SUBTARGET="generic"
              DEVICE="${{ github.event.inputs.device_name }}"
              ;;
          esac
          
          CONFIG_MODE="${{ github.event.inputs.config_mode }}"
          
          echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "DEVICE=$DEVICE" >> $GITHUB_ENV
          echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
          
          # å…‹éš†æºç 
          echo "å…‹éš†æºç ..."
          sudo rm -rf ./* ./.git* 2>/dev/null || true
          git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
          echo "âœ… æºç å…‹éš†å®Œæˆ"
      
      - name: æ·»åŠ  TurboACC æ”¯æŒ
        run: |
          cd /mnt/openwrt-build
          echo "=== æ·»åŠ  TurboACC æ”¯æŒ ==="
          
          if [ "${{ github.event.inputs.config_mode }}" = "normal" ]; then
            if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
              echo "src-git turboacc https://github.com/chenmozhijin/turboacc" >> feeds.conf.default
              echo "âœ… TurboACC feed æ·»åŠ å®Œæˆ"
            else
              echo "â„¹ï¸  21.02 ç‰ˆæœ¬å·²å†…ç½® TurboACCï¼Œæ— éœ€é¢å¤–æ·»åŠ "
            fi
          else
            echo "â„¹ï¸  åŸºç¡€æ¨¡å¼ä¸æ·»åŠ  TurboACC æ”¯æŒ"
          fi
      
      - name: é…ç½®Feeds
        run: |
          cd /mnt/openwrt-build
          echo "=== é…ç½®Feeds ==="
          
          if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            FEEDS_BRANCH="openwrt-23.05"
          else
            FEEDS_BRANCH="openwrt-21.02"
          fi
          
          echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
          echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
          
          if [ "$SELECTED_BRANCH" = "openwrt-23.05" ] && [ "${{ github.event.inputs.config_mode }}" = "normal" ]; then
            echo "src-git turboacc https://github.com/chenmozhijin/turboacc" >> feeds.conf.default
          fi
          
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "âœ… Feedsé…ç½®å®Œæˆ"
      
      - name: å®‰è£… TurboACC åŒ…
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          cd /mnt/openwrt-build
          echo "=== å®‰è£… TurboACC åŒ… ==="
          ./scripts/feeds update turboacc
          ./scripts/feeds install -p turboacc luci-app-turboacc
          ./scripts/feeds install -p turboacc kmod-shortcut-fe
          ./scripts/feeds install -p turboacc kmod-fast-classifier
          echo "âœ… TurboACC åŒ…å®‰è£…å®Œæˆ"
      
      - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
        run: |
          echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 20 ]; then
            echo "âš ï¸  è­¦å‘Š: å¯ç”¨ç©ºé—´è¾ƒä½Ž (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
          fi
      
      - name: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
        run: |
          cd /mnt/openwrt-build
          echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          
          rm -f .config .config.old
          
          # åŸºç¡€é…ç½®
          echo "CONFIG_TARGET_${TARGET}=y" > .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
          
          # USBé©±åŠ¨é…ç½®ï¼ˆç®€åŒ–ç‰ˆï¼‰
          echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
          echo "CONFIG_PACKAGE_kmod-scsi-core=y" >> .config
          
          # æ ¹æ®å¹³å°æ·»åŠ ä¸“ç”¨é©±åŠ¨
          if [ "$TARGET" = "ipq40xx" ]; then
            echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
          fi
          
          if [ "$TARGET" = "ramips" ]; then
            if [ "$SUBTARGET" = "mt76x8" ] || [ "$SUBTARGET" = "mt7621" ]; then
              echo "CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" >> .config
            fi
          fi
          
          echo "âœ… æ™ºèƒ½é…ç½®ç”Ÿæˆå®Œæˆ"
      
      - name: éªŒè¯USBé…ç½®
        run: |
          cd /mnt/openwrt-build
          echo "=== éªŒè¯USBé…ç½® ==="
          echo "å…³é”®USBé©±åŠ¨é…ç½®çŠ¶æ€:"
          grep -E "CONFIG_PACKAGE_kmod-usb|CONFIG_PACKAGE_kmod-scsi" .config | grep "=y" || echo "æœªæ‰¾åˆ°USBé…ç½®"
      
      - name: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
        run: |
          cd /mnt/openwrt-build
          echo "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          make defconfig
          echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
      
      - name: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
        run: |
          echo "=== æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          cd /mnt/openwrt-build
          
          if [ -f ".config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            mkdir -p ${{ github.workspace }}/firmware-config/config-backup
            backup_file="${{ github.workspace }}/firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${SELECTED_BRANCH}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
            cp ".config" "$backup_file"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°: $backup_file"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      - name: ä¿®å¤ç½‘ç»œçŽ¯å¢ƒ
        run: |
          cd /mnt/openwrt-build
          echo "=== ä¿®å¤ç½‘ç»œçŽ¯å¢ƒ ==="
          git config --global http.postBuffer 524288000
          echo "âœ… ç½‘ç»œçŽ¯å¢ƒä¿®å¤å®Œæˆ"
      
      - name: åŠ è½½å·¥å…·é“¾
        run: |
          cd /mnt/openwrt-build
          echo "=== åŠ è½½å·¥å…·é“¾ ==="
          
          # æ£€æŸ¥ä»“åº“ä¸­çš„å·¥å…·é“¾
          TOOLCHAIN_REPO_DIR="${{ github.workspace }}/firmware-config/Toolchain/${SELECTED_BRANCH}/${TARGET}/${SUBTARGET}"
          
          if [ -d "$TOOLCHAIN_REPO_DIR" ] && [ "$(ls -A "$TOOLCHAIN_REPO_DIR" 2>/dev/null)" ]; then
            echo "âœ… ä»Žä»“åº“æ‰¾åˆ°å·¥å…·é“¾: $TOOLCHAIN_REPO_DIR"
            echo "å¤åˆ¶å·¥å…·é“¾åˆ°æž„å»ºç›®å½•..."
            mkdir -p staging_dir
            cp -r "$TOOLCHAIN_REPO_DIR"/* staging_dir/ 2>/dev/null || true
            echo "âœ… å·¥å…·é“¾åŠ è½½å®Œæˆ"
          else
            echo "âš ï¸  ä»“åº“ä¸­æœªæ‰¾åˆ°å·¥å…·é“¾ï¼Œå°†è‡ªåŠ¨ä¸‹è½½"
          fi
      
      - name: æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€
        run: |
          cd /mnt/openwrt-build
          echo "=== æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€ ==="
          
          if [ -d "staging_dir" ]; then
            if find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | grep -q .; then
              echo "âœ… æž„å»ºç›®å½•ä¸­æœ‰å·¥å…·é“¾"
              find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | head -1
            else
              echo "âŒ æž„å»ºç›®å½•ä¸­æ²¡æœ‰å·¥å…·é“¾ï¼Œå°†è‡ªåŠ¨ä¸‹è½½"
            fi
          else
            echo "âŒ staging_dirç›®å½•ä¸å­˜åœ¨"
          fi
      
      - name: ä¸‹è½½ä¾èµ–åŒ…
        run: |
          cd /mnt/openwrt-build
          echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
          make -j1 download V=s 2>&1 | tee download.log || echo "ä¸‹è½½ä¾èµ–åŒ…å¯èƒ½æœ‰é”™è¯¯"
          echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"
      
      - name: å‰ç½®é”™è¯¯æ£€æŸ¥
        run: |
          cd /mnt/openwrt-build
          echo "=== å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          
          error_count=0
          
          if [ ! -f ".config" ]; then
            echo "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨"
            error_count=$((error_count + 1))
          fi
          
          if [ ! -d "dl" ]; then
            echo "âš ï¸  è­¦å‘Š: dl ç›®å½•ä¸å­˜åœ¨"
          fi
          
          if [ $error_count -eq 0 ]; then
            echo "âœ… å‰ç½®æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ å‰ç½®æ£€æŸ¥å‘çŽ° $error_count ä¸ªé”™è¯¯"
            exit 1
          fi
      
      - name: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
        run: |
          echo "=== ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          fi
      
      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd /mnt/openwrt-build
          echo "=== ç¼–è¯‘å›ºä»¶ ==="
          echo "å¯ç”¨ç¼“å­˜: ${{ github.event.inputs.enable_cache }}"
          
          cpu_cores=$(nproc)
          make_jobs=$cpu_cores
          
          if [ "${{ github.event.inputs.enable_cache }}" = "true" ]; then
            make -j$make_jobs V=s 2>&1 | tee build.log
          else
            make -j$make_jobs V=s 2>&1 | tee build.log
          fi
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          echo "ç¼–è¯‘é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            exit $BUILD_EXIT_CODE
          fi
      
      - name: ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•
        if: success() && github.event.inputs.enable_cache == 'true'
        run: |
          cd /mnt/openwrt-build
          echo "=== ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½• ==="
          
          TOOLCHAIN_SAVE_DIR="${{ github.workspace }}/firmware-config/Toolchain/${SELECTED_BRANCH}/${TARGET}/${SUBTARGET}"
          mkdir -p "$TOOLCHAIN_SAVE_DIR"
          
          staging_toolchain=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ -d "$staging_toolchain" ]; then
            echo "ä¿å­˜å·¥å…·é“¾åˆ°: $TOOLCHAIN_SAVE_DIR"
            cp -r "$staging_toolchain"/* "$TOOLCHAIN_SAVE_DIR/" 2>/dev/null || true
            echo "âœ… å·¥å…·é“¾ä¿å­˜å®Œæˆ"
          else
            echo "âš ï¸  æœªæ‰¾åˆ°å·¥å…·é“¾ï¼Œè·³è¿‡ä¿å­˜"
          fi
      
      - name: ä¿å­˜æºä»£ç ä¿¡æ¯
        if: success()
        run: |
          echo "=== ä¿å­˜æºä»£ç ä¿¡æ¯ ==="
          mkdir -p /tmp/build-artifacts/source-info
          
          cat > /tmp/build-artifacts/source-info/build_info.txt << EOF
æž„å»ºä¿¡æ¯
=========
æž„å»ºæ—¶é—´: $(date)
è®¾å¤‡: ${{ github.event.inputs.device_name }}
ç‰ˆæœ¬: ${SELECTED_BRANCH}
ç›®æ ‡å¹³å°: ${TARGET}/${SUBTARGET}
é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}
EOF
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        if: success()
        run: |
          cd /mnt/openwrt-build
          echo "=== ä¸Šä¼ æž„å»ºäº§ç‰© ==="
          
          mkdir -p /tmp/build-artifacts
          
          if [ -d "bin/targets" ]; then
            tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
            echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆ"
          fi
          
          if [ -f "build.log" ]; then
            cp build.log /tmp/build-artifacts/build.log
          fi
      
      # åªåœ¨å¤±è´¥æ—¶ä¸Šä¼ å…³é”®æž„å»ºäº§ç‰©
      - name: ä¸Šä¼ å…³é”®æž„å»ºäº§ç‰©ï¼ˆä»…å¤±è´¥æ—¶ï¼‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: critical-artifacts-${{ github.event.inputs.device_name }}-${{ github.run_id }}
          path: |
            /mnt/openwrt-build/.config
            /mnt/openwrt-build/build.log
            /tmp/build-artifacts/
          retention-days: 3
      
      - name: é”™è¯¯åˆ†æž
        if: failure()
        run: |
          cd /mnt/openwrt-build
          echo "=== é”™è¯¯åˆ†æž ==="
          if [ -f "build.log" ]; then
            echo "ç¼–è¯‘é”™è¯¯æ‘˜è¦:"
            grep -i "error:" build.log | head -10 || echo "æ— é”™è¯¯ä¿¡æ¯"
          fi
      
      - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
        if: success()
        run: |
          cd /mnt/openwrt-build
          echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
          
          if [ -d "bin/targets" ]; then
            echo "âœ… å›ºä»¶ç›®å½•å­˜åœ¨"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) -exec ls -lh {} \;
          else
            echo "âŒ å›ºä»¶ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
      
      - name: ä¸Šä¼ å›ºä»¶
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${SELECTED_BRANCH}-${{ github.event.inputs.config_mode }}
          path: /mnt/openwrt-build/bin/targets/
          retention-days: 7
      
      - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.event.inputs.device_name }}-${SELECTED_BRANCH}-${{ github.event.inputs.config_mode }}
          path: /mnt/openwrt-build/build.log
          retention-days: 7
      
      - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${SELECTED_BRANCH}-${{ github.event.inputs.config_mode }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      - name: æ¸…ç†ç›®å½•
        if: always()
        run: |
          echo "=== æ¸…ç†æž„å»ºç›®å½• ==="
          sudo rm -rf /mnt/openwrt-build || echo "æ¸…ç†å¤±è´¥"
      
      - name: è¾“å‡ºæœ€ç»ˆé…ç½®çŠ¶æ€
        if: always()
        run: |
          echo "=== æž„å»ºæµç¨‹å®Œæˆ ==="
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${SELECTED_BRANCH}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "çŠ¶æ€: ${{ job.status }}"
