name: OpenWrt 智能固件构建工作流 - 使用dnsmasq-full版

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (如: ac42u等)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: '版本选择'
        required: true
        type: choice
        default: '21.02'
        options:
          - 23.05
          - 21.02
      extra_packages:
        description: '额外安装插件 (多个插件用空格分隔)'
        required: false
        type: string
        default: 'luci-app-upnp'
      enable_cache:
        description: '启用编译缓存'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出配置仓库
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 设置编译环境
      run: |
        echo "=== 安装编译依赖包 ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo cmake
        echo "✅ 编译环境设置完成"

    - name: 创建构建目录
      run: |
        echo "=== 创建构建目录 ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        echo "✅ 构建目录创建完成"

    - name: 版本选择
      id: version-selection
      run: |
        cd $BUILD_DIR
        echo "=== 版本选择 ==="
        
        if [ "${{ inputs.version_selection }}" = "23.05" ]; then
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            SELECTED_BRANCH="openwrt-23.05"
        else
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            SELECTED_BRANCH="openwrt-21.02"
        fi
        
        echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
        echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
        echo "✅ 版本选择完成: $SELECTED_BRANCH"

    - name: 克隆源码
      run: |
        cd $BUILD_DIR
        echo "=== 克隆源码 ==="
        echo "仓库: $SELECTED_REPO_URL"
        echo "分支: $SELECTED_BRANCH"
        
        # 清理目录
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        
        # 克隆源码
        git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
        echo "✅ 源码克隆完成"

    - name: 设备配置
      run: |
        cd $BUILD_DIR
        echo "=== 设备配置 ==="
        
        # 设备映射
        case "${{ github.event.inputs.device_name }}" in
            "ac42u"|"acrh17")
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="asus_rt-ac42u"
                ;;
            *)
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="${{ github.event.inputs.device_name }}"
                ;;
        esac
        
        echo "TARGET=$TARGET" >> $GITHUB_ENV
        echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
        echo "DEVICE=$DEVICE" >> $GITHUB_ENV
        
        echo "目标: $TARGET"
        echo "子目标: $SUBTARGET"
        echo "设备: $DEVICE"

    - name: 配置Feeds
      run: |
        cd $BUILD_DIR
        echo "=== 配置Feeds ==="
        
        # 根据分支选择feeds版本
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            FEEDS_BRANCH="openwrt-23.05"
        else
            FEEDS_BRANCH="openwrt-21.02"
        fi
        
        echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
        echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
        
        # 更新feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "✅ Feeds配置完成"

    - name: 生成配置 - 使用dnsmasq-full
      run: |
        cd $BUILD_DIR
        echo "=== 生成配置 - 使用dnsmasq-full ==="
        
        # 创建基础配置
        echo "CONFIG_TARGET_${TARGET}=y" > .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        
        # 核心系统包 - 使用dnsmasq-full而不是dnsmasq
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        
        # 关键修改：使用dnsmasq-full并禁用dnsmasq
        echo "# CONFIG_PACKAGE_dnsmasq is not set" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        
        # 可以选择启用dnsmasq-full的一些有用功能
        echo "CONFIG_PACKAGE_dnsmasq_full_dhcp=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dnssec=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_ipset=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_conntrack=y" >> .config
        
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_fstools=y" >> .config
        echo "CONFIG_PACKAGE_libc=y" >> .config
        echo "CONFIG_PACKAGE_libgcc=y" >> .config
        echo "CONFIG_PACKAGE_mtd=y" >> .config
        echo "CONFIG_PACKAGE_netifd=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_procd=y" >> .config
        echo "CONFIG_PACKAGE_ubox=y" >> .config
        echo "CONFIG_PACKAGE_ubus=y" >> .config
        echo "CONFIG_PACKAGE_ubusd=y" >> .config
        echo "CONFIG_PACKAGE_uci=y" >> .config
        echo "CONFIG_PACKAGE_uclient-fetch=y" >> .config
        echo "CONFIG_PACKAGE_usign=y" >> .config
        
        # 无线驱动
        echo "CONFIG_PACKAGE_kmod-ath10k=y" >> .config
        echo "CONFIG_PACKAGE_ath10k-firmware-qca988x=y" >> .config
        echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
        
        # 网络工具（这些可能与dnsmasq-full配合更好）
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> .config
        
        # 仅添加用户明确请求的包
        if [ -n "${{ inputs.extra_packages }}" ]; then
            for pkg in ${{ inputs.extra_packages }}; do
                echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            done
        fi
        
        # 21.02版本添加网络加速插件
        if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
            echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        fi
        
        echo "✅ 配置生成完成 - 使用dnsmasq-full"

    - name: 应用配置
      run: |
        cd $BUILD_DIR
        echo "=== 应用配置 ==="
        
        # 运行defconfig来完善配置
        make defconfig
        echo "✅ 配置应用完成"
        
        # 显示配置信息
        echo "启用的包数量: $(grep "^CONFIG_PACKAGE_.*=y$" .config | wc -l)"
        echo "DNSMASQ配置状态:"
        grep -E "dnsmasq" .config
        echo "启用的LUCI插件:"
        grep "^CONFIG_PACKAGE_luci" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//' | sort

    - name: 修复网络环境
      run: |
        cd $BUILD_DIR
        echo "=== 修复网络环境 ==="
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        echo "✅ 网络环境修复完成"

    - name: 下载依赖包
      run: |
        cd $BUILD_DIR
        echo "=== 下载依赖包 ==="
        make -j1 download
        echo "✅ 依赖包下载完成"

    - name: 编译固件
      run: |
        cd $BUILD_DIR
        echo "=== 编译固件 ==="
        
        if [ "${{ inputs.enable_cache }}" = "true" ]; then
            echo "启用编译缓存"
            make -j$(nproc) V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        else
            echo "普通编译模式"
            make -j$(nproc) V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        fi
        
        echo "编译退出代码: $BUILD_EXIT_CODE"
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "❌ 编译失败，退出代码: $BUILD_EXIT_CODE"
            exit $BUILD_EXIT_CODE
        fi
        echo "✅ 固件编译完成"

    - name: 固件文件检查
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== 固件文件检查 ==="
        if [ -d "bin/targets" ]; then
            echo "✅ 固件目录存在"
            find bin/targets -name "*.bin" -o -name "*.img" | while read file; do
                echo "固件文件: $file ($(du -h "$file" | cut -f1))"
            done
        else
            echo "❌ 固件目录不存在"
            exit 1
        fi

    - name: 上传固件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-full
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: 上传配置文件
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-full
        path: ${{ env.BUILD_DIR }}/.config
        retention-days: 7

    - name: 清理目录
      if: always()
      run: |
        echo "=== 清理构建目录 ==="
        sudo rm -rf $BUILD_DIR
        echo "✅ 构建目录已清理"
