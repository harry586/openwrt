name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆ - ç¼–è¯‘å™¨é¢„ä¸‹è½½ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© - ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ - ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ  - ğŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼"
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚"
        required: false
        type: string
        default: ""
      use_git_archive:
        description: "ğŸ“¦ ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  COMPILER_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç 
      - name: "1. ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        if: github.event.inputs.use_git_archive == 'true'
        run: |
          echo "=== æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç  ==="
          echo "ğŸ”„ ä»GitHub APIè·å–æºä»£ç å‹ç¼©åŒ…"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          
          # è·å–é»˜è®¤åˆ†æ”¯
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
          
          # ä½¿ç”¨Git Archive APIä¸‹è½½å‹ç¼©åŒ…
          echo "ä¸‹è½½æºä»£ç å‹ç¼©åŒ…..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" -o source.tar.gz
          
          if [ ! -f "source.tar.gz" ]; then
            echo "âŒ ä¸‹è½½æºä»£ç å‹ç¼©åŒ…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(ls -lh source.tar.gz | awk '{print $5}')"
          
          # è§£å‹å‹ç¼©åŒ…
          echo "è§£å‹æºä»£ç ..."
          tar -xzf source.tar.gz --strip-components=1
          
          # æ£€æŸ¥è§£å‹ç»“æœ
          echo "ğŸ“ æ£€æŸ¥è§£å‹ç»“æœ..."
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âœ… ä¸»è„šæœ¬å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
          else
            echo "âŒ ä¸»è„šæœ¬ä¸å­˜åœ¨ï¼Œä½†ç»§ç»­å°è¯•..."
          fi
          
          # åˆ—å‡ºæ‰€æœ‰è„šæœ¬æ–‡ä»¶
          echo "ğŸ“‹ è„šæœ¬æ–‡ä»¶åˆ—è¡¨:"
          find . -name "*.sh" -type f | grep -i script || echo "æœªæ‰¾åˆ°è„šæœ¬æ–‡ä»¶"
          
          # å¤åˆ¶åˆ°å·¥ä½œåŒº
          echo "å¤åˆ¶æ–‡ä»¶åˆ°å·¥ä½œåŒº..."
          mkdir -p ${{ github.workspace }}
          
          # ä½¿ç”¨tarç›´æ¥è§£å‹åˆ°å·¥ä½œåŒºï¼Œé¿å…æƒé™é—®é¢˜
          cd ${{ github.workspace }}
          tar -xzf /tmp/openwrt-source/source.tar.gz --strip-components=1
          
          # ç¡®ä¿è„šæœ¬æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
          echo "è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
          find . -name "*.sh" -type f -exec chmod +x {} \;
          
          # éªŒè¯æ–‡ä»¶
          echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          echo "ğŸ“‹ å·¥ä½œåŒºè„šæœ¬æ–‡ä»¶:"
          ls -la firmware-config/scripts/ 2>/dev/null || echo "è„šæœ¬ç›®å½•å¯èƒ½ä¸å­˜åœ¨"
          
          # ä¿å­˜æºä»£ç å‹ç¼©åŒ…ä½œä¸ºæ„å»ºäº§ç‰©
          mkdir -p /tmp/build-artifacts/source-archive
          cp /tmp/openwrt-source/source.tar.gz /tmp/build-artifacts/source-archive/
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/openwrt-source
          echo "âœ… Git Archive APIä¸‹è½½å®Œæˆ"
      
      # æ­¥éª¤ 2: ç«‹å³ä¸Šä¼ Git Archiveæºä»£ç 
      - name: "2. ç«‹å³ä¸Šä¼ Git Archiveæºä»£ç "
        if: github.event.inputs.use_git_archive == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: git-archive-source-${{ github.event.inputs.device_name }}
          path: /tmp/build-artifacts/source-archive/
          retention-days: 7
      
      # æ­¥éª¤ 3: æ£€å‡ºé…ç½®ä»“åº“
      - name: "3. æ£€å‡ºé…ç½®ä»“åº“"
        if: github.event.inputs.use_git_archive == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      
      # æ­¥éª¤ 4: éªŒè¯å’Œè®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      - name: "4. éªŒè¯å’Œè®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™"
        run: |
          echo "=== æ­¥éª¤ 4: éªŒè¯å’Œè®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
          
          # æ£€æŸ¥å·¥ä½œåŒºç›®å½•
          echo "å·¥ä½œåŒºç›®å½•: ${{ github.workspace }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          # æŸ¥æ‰¾æ‰€æœ‰è„šæœ¬æ–‡ä»¶
          echo "ğŸ” æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶..."
          find . -name "*.sh" -type f | while read script; do
            echo "æ‰¾åˆ°è„šæœ¬: $script"
            chmod +x "$script"
          done
          
          # ç‰¹åˆ«æ£€æŸ¥è„šæœ¬ç›®å½•
          echo "ğŸ“ æ£€æŸ¥è„šæœ¬ç›®å½•..."
          if [ -d "firmware-config/scripts" ]; then
            echo "âœ… è„šæœ¬ç›®å½•å­˜åœ¨"
            ls -la firmware-config/scripts/
            
            # è®¾ç½®æ‰§è¡Œæƒé™
            chmod +x firmware-config/scripts/*.sh 2>/dev/null || true
            
            # éªŒè¯å…³é”®è„šæœ¬
            REQUIRED_SCRIPTS="build_firmware_main.sh build_firmware_main-01.sh build_firmware_main-02.sh"
            
            for script in $REQUIRED_SCRIPTS; do
              script_path="firmware-config/scripts/$script"
              if [ -f "$script_path" ]; then
                echo "âœ… $script å­˜åœ¨ä¸”å¯æ‰§è¡Œ"
                ls -la "$script_path"
              else
                echo "âŒ $script ä¸å­˜åœ¨"
              fi
            done
          else
            echo "âŒ è„šæœ¬ç›®å½•ä¸å­˜åœ¨"
            # å°è¯•åˆ›å»º
            mkdir -p firmware-config/scripts
          fi
          
          echo "âœ… è„šæœ¬æƒé™è®¾ç½®å®Œæˆ"
      
      # æ­¥éª¤ 5: æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•çŠ¶æ€
      - name: "5. æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•çŠ¶æ€"
        run: |
          echo "=== æ­¥éª¤ 5: æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•çŠ¶æ€ ==="
          
          echo "ğŸ” è¿è¡Œç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•çŠ¶æ€æ£€æŸ¥..."
          echo "è„šæœ¬è·¯å¾„: firmware-config/scripts/build_firmware_main.sh"
          echo "ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}"
          
          # éªŒè¯è„šæœ¬å¯æ‰§è¡Œ
          if [ -x "firmware-config/scripts/build_firmware_main.sh" ]; then
            firmware-config/scripts/build_firmware_main.sh check_compiler_dir_status "${{ env.COMPILER_DIR }}"
          else
            echo "âŒ è„šæœ¬ä¸å¯æ‰§è¡Œï¼Œå°è¯•ä¿®å¤..."
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh check_compiler_dir_status "${{ env.COMPILER_DIR }}"
          fi
      
      # æ­¥éª¤ 5.5: ä¸‹è½½ç‰ˆæœ¬ç‰¹å®šçš„ç¼–è¯‘å™¨æ–‡ä»¶
      - name: "5.5. ä¸‹è½½ç‰ˆæœ¬ç‰¹å®šçš„ç¼–è¯‘å™¨æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 5.5: ä¸‹è½½ç‰ˆæœ¬ç‰¹å®šçš„ç¼–è¯‘å™¨æ–‡ä»¶ ==="
          
          echo "ğŸ”§ è¿è¡Œç‰ˆæœ¬ç‰¹å®šçš„ç¼–è¯‘å™¨æ–‡ä»¶ä¸‹è½½è„šæœ¬..."
          
          # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
          SCRIPT_PATH="firmware-config/scripts/build_firmware_main-01.sh"
          if [ -f "$SCRIPT_PATH" ]; then
            if [ ! -x "$SCRIPT_PATH" ]; then
              chmod +x "$SCRIPT_PATH"
            fi
            echo "æ‰§è¡Œè„šæœ¬: $SCRIPT_PATH"
            "$SCRIPT_PATH" download_version_specific_compiler_files
          else
            echo "âŒ è„šæœ¬ä¸å­˜åœ¨: $SCRIPT_PATH"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la firmware-config/scripts/
            exit 1
          fi
      
      # æ­¥éª¤ 6: ä¸‹è½½å¹¶ä¿å­˜ç¼–è¯‘å™¨æ–‡ä»¶åˆ°ä»“åº“
      - name: "6. ä¸‹è½½å¹¶ä¿å­˜ç¼–è¯‘å™¨æ–‡ä»¶åˆ°ä»“åº“"
        run: |
          echo "=== æ­¥éª¤ 6: ä¸‹è½½å¹¶ä¿å­˜ç¼–è¯‘å™¨æ–‡ä»¶åˆ°ä»“åº“ ==="
          
          echo "ğŸ”§ è¿è¡Œç¼–è¯‘å™¨æ–‡ä»¶ä¸‹è½½å’Œä¿å­˜è„šæœ¬..."
          firmware-config/scripts/build_firmware_main.sh download_compiler_files
      
      # æ­¥éª¤ 7: åˆå§‹ç©ºé—´æ£€æŸ¥
      - name: "7. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 7: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
            exit 1
          fi
          echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"
      
      # æ­¥éª¤ 8: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•
      - name: "8. è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 8: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½• ==="
          
          echo "ğŸ”„ æ­¥éª¤ 8.1: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          firmware-config/scripts/build_firmware_main.sh setup_environment
          
          echo "ğŸ”„ æ­¥éª¤ 8.2: åˆ›å»ºæ„å»ºç›®å½•"
          firmware-config/scripts/build_firmware_main.sh create_build_dir
          
          echo "ğŸ”„ æ­¥éª¤ 8.3: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•è®¾ç½®å®Œæˆ"
      
      # æ­¥éª¤ 9: æ·»åŠ  TurboACC æ”¯æŒ
      - name: "9. æ·»åŠ  TurboACC æ”¯æŒ"
        run: |
          echo "=== æ­¥éª¤ 9: æ·»åŠ  TurboACC æ”¯æŒ ==="
          firmware-config/scripts/build_firmware_main.sh add_turboacc_support
      
      # æ­¥éª¤ 10: é…ç½®Feeds
      - name: "10. é…ç½®Feeds"
        run: |
          echo "=== æ­¥éª¤ 10: é…ç½®Feeds ==="
          firmware-config/scripts/build_firmware_main.sh configure_feeds
      
      # æ­¥éª¤ 11: å®‰è£… TurboACC åŒ…
      - name: "11. å®‰è£… TurboACC åŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤ 11: å®‰è£… TurboACC åŒ… ==="
          firmware-config/scripts/build_firmware_main.sh install_turboacc_packages
      
      # æ­¥éª¤ 12: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "12. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 12: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh pre_build_space_check
      
      # æ­¥éª¤ 13: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
      - name: "13. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 13: æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          echo "ğŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨å¼ºåˆ¶å¯ç”¨"
          firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤ 14: éªŒè¯USBé…ç½®
      - name: "14. éªŒè¯USBé…ç½®"
        run: |
          echo "=== æ­¥éª¤ 14: éªŒè¯USBé…ç½® ==="
          firmware-config/scripts/build_firmware_main.sh verify_usb_config
      
      # æ­¥éª¤ 15: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "15. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 15: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity
      
      # æ­¥éª¤ 16: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "16. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== æ­¥éª¤ 16: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          
          # å…ˆä¿å­˜åŸå§‹é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            cp "${{ env.BUILD_DIR }}/.config" "${{ env.BUILD_DIR }}/.config.original"
            echo "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶"
          fi
          
          # åº”ç”¨é…ç½®
          firmware-config/scripts/build_firmware_main.sh apply_config
          
          # æ£€æŸ¥åº”ç”¨åçš„é…ç½®çŠ¶æ€
          echo "=== æ’ä»¶é…ç½®çŠ¶æ€æ£€æŸ¥ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # å®šä¹‰æ­£å¸¸æ¨¡å¼çš„å®Œæ•´æ’ä»¶åˆ—è¡¨
          NORMAL_PLUGINS="TurboACC ç½‘ç»œåŠ é€Ÿ:luci-app-turboacc UPnP è‡ªåŠ¨ç«¯å£è½¬å‘:luci-app-upnp Samba æ–‡ä»¶å…±äº«:luci-app-samba4 ç£ç›˜ç®¡ç†:luci-app-diskman KMS æ¿€æ´»æœåŠ¡:luci-app-vlmcsd SmartDNS æ™ºèƒ½DNS:luci-app-smartdns å®¶é•¿æ§åˆ¶:luci-app-accesscontrol å¾®ä¿¡æ¨é€:luci-app-wechatpush æµé‡æ§åˆ¶ (SQM):luci-app-sqm FTP æœåŠ¡å™¨:luci-app-vsftpd ARP ç»‘å®š:luci-app-arpbind CPU é™åˆ¶:luci-app-cpulimit ç¡¬ç›˜ä¼‘çœ :luci-app-hd-idle"
          
          echo "ğŸ“‹ æ­£å¸¸æ¨¡å¼æ’ä»¶çŠ¶æ€æ£€æŸ¥:"
          
          total_plugins=0
          enabled_plugins=0
          disabled_plugins=0
          
          for plugin_pair in $NORMAL_PLUGINS; do
            plugin_name=$(echo $plugin_pair | cut -d':' -f1)
            plugin_config=$(echo $plugin_pair | cut -d':' -f2)
            total_plugins=$((total_plugins + 1))
            
            if grep -q "^CONFIG_PACKAGE_${plugin_config}=y" .config; then
              echo "  âœ… $plugin_name: å·²å¯ç”¨"
              enabled_plugins=$((enabled_plugins + 1))
            elif grep -q "^# CONFIG_PACKAGE_${plugin_config} is not set$" .config; then
              echo "  âŒ $plugin_name: å·²ç¦ç”¨"
              disabled_plugins=$((disabled_plugins + 1))
            else
              echo "  âš ï¸  $plugin_name: æœªé…ç½®"
            fi
          done
          
          echo ""
          echo "ğŸ“Š æ’ä»¶çŠ¶æ€ç»Ÿè®¡:"
          echo "  æ€»è®¡: $total_plugins ä¸ªæ’ä»¶"
          echo "  å·²å¯ç”¨: $enabled_plugins ä¸ª"
          echo "  å·²ç¦ç”¨: $disabled_plugins ä¸ª"
          
          # æ£€æŸ¥åŸºç¡€æ¨¡å¼æ˜¯å¦ç¦ç”¨äº†æ’ä»¶
          if [ "${{ github.event.inputs.config_mode }}" = "base" ]; then
            echo ""
            echo "ğŸ”§ åŸºç¡€æ¨¡å¼é…ç½®ç¡®è®¤:"
            if [ $enabled_plugins -eq 0 ]; then
              echo "  âœ… åŸºç¡€æ¨¡å¼: æ‰€æœ‰é¢å¤–æ’ä»¶å·²æ­£ç¡®ç¦ç”¨"
            else
              echo "  âš ï¸  åŸºç¡€æ¨¡å¼: æœ‰ $enabled_plugins ä¸ªæ’ä»¶æœªç¦ç”¨ï¼Œéœ€è¦æ£€æŸ¥"
            fi
          fi
          
          # é¢å¤–æ£€æŸ¥USBé©±åŠ¨çŠ¶æ€
          echo ""
          echo "ğŸ”Œ USBé©±åŠ¨çŠ¶æ€ç¡®è®¤:"
          critical_usb_drivers=("kmod-usb-xhci-hcd" "kmod-usb3" "kmod-usb-dwc3" "kmod-usb-storage" "kmod-scsi-core")
          for driver in "${critical_usb_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
              echo "  âœ… $driver: å·²å¯ç”¨"
            else
              echo "  âŒ $driver: æœªå¯ç”¨ (éœ€è¦ä¿®å¤)"
            fi
          done
          
          echo "âœ… é…ç½®è¯¦æƒ…æ£€æŸ¥å®Œæˆ"
      
      # æ­¥éª¤ 17: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "17. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 17: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
            mkdir -p firmware-config/config-backup
            
            # å¤‡ä»½åˆ°ä»“åº“ç›®å½•
            backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
            
            cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
            
            # æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶ä¿¡æ¯
            echo "å¤‡ä»½æ–‡ä»¶å¤§å°: $(ls -lh $backup_file | awk '{print $5}')"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      # æ­¥éª¤ 18: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "18. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤ 18: ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          firmware-config/scripts/build_firmware_main.sh fix_network
      
      # æ­¥éª¤ 19: ä¸‹è½½ä¾èµ–åŒ…
      - name: "19. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== æ­¥éª¤ 19: ä¸‹è½½ä¾èµ–åŒ… ==="
          firmware-config/scripts/build_firmware_main.sh download_dependencies
      
      # æ­¥éª¤ 20: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "20. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 20: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          firmware-config/scripts/build_firmware_main.sh integrate_custom_files
      
      # æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "21. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh pre_build_error_check
      
      # æ­¥éª¤ 22: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "22. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 22: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          # æ£€æŸ¥ç¼–è¯‘æ‰€éœ€ç©ºé—´
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
      
      # æ­¥éª¤ 22.5: æ£€æŸ¥å¹¶ä¿®å¤ç¼–è¯‘ç¯å¢ƒ
      - name: "22.5. æ£€æŸ¥å¹¶ä¿®å¤ç¼–è¯‘ç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤ 22.5: æ£€æŸ¥å¹¶ä¿®å¤ç¼–è¯‘ç¯å¢ƒ ==="
          
          echo "ğŸ”§ è¿è¡Œç¼–è¯‘ç¯å¢ƒæ£€æŸ¥ä¸ä¿®å¤..."
          
          # éªŒè¯è„šæœ¬å­˜åœ¨ä¸”å¯æ‰§è¡Œ
          SCRIPT_PATH="firmware-config/scripts/build_firmware_main-01.sh"
          if [ -f "$SCRIPT_PATH" ]; then
            if [ ! -x "$SCRIPT_PATH" ]; then
              chmod +x "$SCRIPT_PATH"
            fi
            echo "æ‰§è¡Œè„šæœ¬: $SCRIPT_PATH"
            "$SCRIPT_PATH" check_and_fix_build_environment "${{ env.BUILD_DIR }}"
          else
            echo "âŒ è„šæœ¬ä¸å­˜åœ¨: $SCRIPT_PATH"
            echo "å½“å‰è„šæœ¬ç›®å½•å†…å®¹:"
            ls -la firmware-config/scripts/
            exit 1
          fi
      
      # æ­¥éª¤ 22.6: å¼ºåˆ¶ä¿®å¤ xz é…ç½®ï¼ˆç»ˆæç‰ˆï¼‰- æ–°å¢æ­¥éª¤
      - name: "22.6. å¼ºåˆ¶ä¿®å¤ xz é…ç½®ï¼ˆç»ˆæç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 22.6: å¼ºåˆ¶ä¿®å¤ xz é…ç½®ï¼ˆç»ˆæç‰ˆï¼‰==="
          
          echo "ğŸš¨ è¿è¡Œç»ˆæ xz é…ç½®ä¿®å¤..."
          
          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          SCRIPT_PATH="firmware-config/scripts/build_firmware_main-02.sh"
          if [ -f "$SCRIPT_PATH" ]; then
            chmod +x "$SCRIPT_PATH" 2>/dev/null || true
            
            # è¿è¡Œå¼ºåˆ¶ä¿®å¤
            echo "æ‰§è¡Œè„šæœ¬: $SCRIPT_PATH"
            "$SCRIPT_PATH" force_fix_xz_config "${{ env.BUILD_DIR }}"
            
            echo "âœ… ç»ˆæä¿®å¤å®Œæˆ"
            
            # éªŒè¯ä¿®å¤
            echo "ğŸ” éªŒè¯ä¿®å¤ç»“æœ..."
            "$SCRIPT_PATH" check_build_environment "${{ env.BUILD_DIR }}"
          else
            echo "âŒ è„šæœ¬ä¸å­˜åœ¨: $SCRIPT_PATH"
            echo "å½“å‰è„šæœ¬ç›®å½•å†…å®¹:"
            ls -la firmware-config/scripts/
            exit 1
          fi
      
      # æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶ï¼ˆä¿®å¤ç‰ˆï¼‰
      - name: "23. ç¼–è¯‘å›ºä»¶ï¼ˆä¿®å¤ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶ï¼ˆä¿®å¤ç‰ˆï¼‰==="
          
          echo "ğŸ”§ è®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡å’Œäº¤å‰ç¼–è¯‘æ ‡å¿—..."
          cd "${{ env.BUILD_DIR }}"
          
          # åˆ›å»ºç¼–è¯‘å‰ä¿®å¤è„šæœ¬
          PRE_BUILD_FIX_SCRIPT=/tmp/pre_build_fix.sh
          
          # ä½¿ç”¨echoåˆ›å»ºè„šæœ¬æ–‡ä»¶ï¼Œé¿å…heredocè¯­æ³•é—®é¢˜
          echo '#!/bin/bash' > $PRE_BUILD_FIX_SCRIPT
          echo 'echo "=== ç¼–è¯‘å‰æœ€ç»ˆä¿®å¤ ==="' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export ac_cv_c_compiler_gnu=yes' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export ac_cv_prog_cc_g=yes' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export ac_cv_prog_cc_works=yes' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export ac_cv_prog_cc_cross=yes' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export gl_cv_cc_nested_functions=yes' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export gl_cv_func_mbrtowc=yes' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export ac_cv_func_mmap_fixed_mapped=yes' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export ac_cv_sizeof_void_p=4' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export build_alias=x86_64-pc-linux-gnu' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export host_alias=x86_64-pc-linux-gnu' >> $PRE_BUILD_FIX_SCRIPT
          echo 'export target_alias=x86_64-pc-linux-gnu' >> $PRE_BUILD_FIX_SCRIPT
          echo 'xz_dir=$(find build_dir -name "xz-*" -type d 2>/dev/null | head -1)' >> $PRE_BUILD_FIX_SCRIPT
          echo 'if [ -n "$xz_dir" ]; then' >> $PRE_BUILD_FIX_SCRIPT
          echo '  echo "ğŸ”§ ä¿®å¤ xz ç›®å½•: $xz_dir"' >> $PRE_BUILD_FIX_SCRIPT
          echo '  if [ ! -f "$xz_dir/config.status" ]; then' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "#! /bin/sh" > "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "# Generated by configure fix" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "SHELL=/bin/sh" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "srcdir=." >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "host=x86_64-pc-linux-gnu" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "build=x86_64-pc-linux-gnu" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "target=x86_64-pc-linux-gnu" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "CC=gcc" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "CFLAGS=-O2" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "LDFLAGS=" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "LIBS=" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "cross_compiling=yes" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "ac_cv_c_compiler_gnu=yes" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "ac_cv_prog_cc_g=yes" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "ac_cv_prog_cc_works=yes" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "ac_cv_prog_cc_cross=yes" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "ac_cv_func_mmap_fixed_mapped=yes" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "ac_cv_sizeof_void_p=4" >> "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    chmod +x "$xz_dir/config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "âœ… åˆ›å»º config.status"' >> $PRE_BUILD_FIX_SCRIPT
          echo '  fi' >> $PRE_BUILD_FIX_SCRIPT
          echo '  echo "configured at $(date) - pre-build fix" > "$xz_dir/.configured"' >> $PRE_BUILD_FIX_SCRIPT
          echo '  echo "âœ… åˆ›å»º .configured æ ‡è®°æ–‡ä»¶"' >> $PRE_BUILD_FIX_SCRIPT
          echo '  if [ -f "$xz_dir/configure" ]; then' >> $PRE_BUILD_FIX_SCRIPT
          echo '    cp "$xz_dir/configure" "$xz_dir/configure.backup"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    sed -i "s/if test \"\$cross_compiling\" = yes; then/if test \"\$cross_compiling\" = yes -o \"\$cross_compiling\" = \"maybe\"; then/g" "$xz_dir/configure"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    sed -i "s/ac_cv_prog_cc_cross=no/ac_cv_prog_cc_cross=yes/g" "$xz_dir/configure"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    sed -i "s/ac_cv_c_compiler_gnu=no/ac_cv_c_compiler_gnu=yes/g" "$xz_dir/configure"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    echo "âœ… ä¿®å¤ configure æ–‡ä»¶"' >> $PRE_BUILD_FIX_SCRIPT
          echo '  fi' >> $PRE_BUILD_FIX_SCRIPT
          echo 'fi' >> $PRE_BUILD_FIX_SCRIPT
          echo 'for dir in build_dir/*-*; do' >> $PRE_BUILD_FIX_SCRIPT
          echo '  if [ -d "$dir" ] && [[ "$(basename "$dir")" =~ ^[a-z]+-[0-9] ]]; then' >> $PRE_BUILD_FIX_SCRIPT
          echo '    if [ ! -f "$dir/.configured" ]; then' >> $PRE_BUILD_FIX_SCRIPT
          echo '      echo "configured at $(date)" > "$dir/.configured"' >> $PRE_BUILD_FIX_SCRIPT
          echo '    fi' >> $PRE_BUILD_FIX_SCRIPT
          echo '  fi' >> $PRE_BUILD_FIX_SCRIPT
          echo 'done' >> $PRE_BUILD_FIX_SCRIPT
          echo 'echo "âœ… ç¼–è¯‘å‰ä¿®å¤å®Œæˆ"' >> $PRE_BUILD_FIX_SCRIPT
          
          chmod +x $PRE_BUILD_FIX_SCRIPT
          
          # è¿è¡Œç¼–è¯‘å‰ä¿®å¤
          $PRE_BUILD_FIX_SCRIPT
          
          echo "ğŸ”§ è®¾ç½®ç¼–è¯‘ç¯å¢ƒ..."
          # å¯¼å‡ºç¯å¢ƒå˜é‡åˆ° make è¿›ç¨‹
          export ac_cv_prog_cc_cross=yes
          export ac_cv_prog_cc_works=yes
          export ac_cv_func_mmap_fixed_mapped=yes
          
          echo "âœ… ç¯å¢ƒå˜é‡:"
          echo "  ac_cv_prog_cc_cross: $ac_cv_prog_cc_cross"
          echo "  ac_cv_prog_cc_works: $ac_cv_prog_cc_works"
          
          # ä½¿ç”¨ç‰¹å®šçš„ make å‘½ä»¤æ¥ç¼–è¯‘
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          cd "${{ env.BUILD_DIR }}"
          
          # æ–¹æ³•1ï¼šå…ˆç¼–è¯‘å·¥å…·é“¾ï¼Œç„¶åç¼–è¯‘å›ºä»¶
          echo "ğŸ”„ æ–¹æ³•1ï¼šå…ˆç¼–è¯‘å·¥å…·..."
          make tools/compile -j4 V=s 2>&1 | tee tools_build.log
          
          TOOLS_EXIT_CODE=${PIPESTATUS[0]}
          echo "å·¥å…·ç¼–è¯‘é€€å‡ºä»£ç : $TOOLS_EXIT_CODE"
          
          if [ $TOOLS_EXIT_CODE -eq 0 ]; then
            echo "âœ… å·¥å…·ç¼–è¯‘æˆåŠŸï¼Œå¼€å§‹ç¼–è¯‘å›ºä»¶..."
            # è°ƒç”¨ä¸»è„šæœ¬è¿›è¡Œç¼–è¯‘
            firmware-config/scripts/build_firmware_main.sh build_firmware "true"
          else
            echo "âŒ å·¥å…·ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ç›´æ¥ç¼–è¯‘å®Œæ•´å›ºä»¶..."
            echo "ğŸ”§ å°è¯•å¼ºåˆ¶ç¼–è¯‘..."
            
            # æ–¹æ³•2ï¼šç›´æ¥ç¼–è¯‘ï¼Œå¿½ç•¥å·¥å…·é”™è¯¯
            make -j1 V=s 2>&1 | tee direct_build.log
            DIRECT_EXIT_CODE=${PIPESTATUS[0]}
            
            if [ $DIRECT_EXIT_CODE -eq 0 ]; then
              echo "âœ… ç›´æ¥ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•éƒ½å¤±è´¥"
              exit $DIRECT_EXIT_CODE
            fi
          fi
      
      # æ­¥éª¤ 24: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: "24. æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 24: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰© ==="
          cd ${{ env.BUILD_DIR }}
          
          # åˆ›å»ºæ„å»ºäº§ç‰©ç›®å½•
          mkdir -p /tmp/build-artifacts
          
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ–‡ä»¶ï¼Œé¿å…é‡å¤ä¸Šä¼ 
          echo "ğŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ„å»ºäº§ç‰©..."
          need_upload=false
          
          # æ‰“åŒ…å›ºä»¶æ–‡ä»¶
          if [ -d "bin/targets" ]; then
            echo "æ‰“åŒ…å›ºä»¶æ–‡ä»¶..."
            tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°
            firmware_size=$(stat -c%s /tmp/build-artifacts/firmware.tar.gz 2>/dev/null || echo "0")
            if [ $firmware_size -gt 0 ]; then
              echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆï¼Œå¤§å°: $(du -h /tmp/build-artifacts/firmware.tar.gz | cut -f1)"
              need_upload=true
            else
              echo "âš ï¸ å›ºä»¶æ‰“åŒ…å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            fi
          else
            echo "âš ï¸ bin/targetsç›®å½•ä¸å­˜åœ¨"
          fi
          
          # æ‰“åŒ…ç¼–è¯‘æ—¥å¿—
          if [ -f "build.log" ]; then
            echo "æ‰“åŒ…ç¼–è¯‘æ—¥å¿—..."
            cp build.log /tmp/build-artifacts/build.log
            echo "âœ… æ—¥å¿—æ‰“åŒ…å®Œæˆ"
            need_upload=true
          fi
          
          # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
          echo "æ„å»ºæ—¶é—´: $(date)" > /tmp/build-artifacts/build-info.txt
          echo "è®¾å¤‡: ${{ env.DEVICE }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/build-info.txt
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/build-info.txt
          
          if [ "$need_upload" = true ]; then
            echo "âœ… æ„å»ºäº§ç‰©å‡†å¤‡å®Œæˆ"
            echo "ğŸ“¤ æ„å»ºäº§ç‰©å·²ä¿å­˜åœ¨: /tmp/build-artifacts/"
            ls -lh /tmp/build-artifacts/
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„æ„å»ºäº§ç‰©"
          fi
      
      # æ­¥éª¤ 25: ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•
      - name: "25. ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
      
      # æ­¥éª¤ 26: ä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "26. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      # æ­¥éª¤ 27: æ±‡æ€»å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨æ–‡ä»¶å¹¶æäº¤åˆ°ä»“åº“ç›®å½•
      - name: "27. æ±‡æ€»å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨æ–‡ä»¶å¹¶æäº¤åˆ°ä»“åº“ç›®å½•"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 27: æ±‡æ€»å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨æ–‡ä»¶å¹¶æäº¤åˆ°ä»“åº“ç›®å½• ==="
          echo "ğŸ” è¿è¡Œç¼–è¯‘å™¨æ–‡ä»¶æ±‡æ€»è„šæœ¬..."
          firmware-config/scripts/build_firmware_main.sh collect_compiler_files "${{ env.BUILD_DIR }}" "${{ env.COMPILER_DIR }}"
      
      # æ­¥éª¤ 28: ä¸Šä¼ ç¼–è¯‘å™¨æ–‡ä»¶å‹ç¼©åŒ…
      - name: "28. ä¸Šä¼ ç¼–è¯‘å™¨æ–‡ä»¶å‹ç¼©åŒ…"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: compiler-files-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}
          path: ${{ github.workspace }}/firmware-config/build-Compiler-file/compiled-compilers.tar.gz
          retention-days: 7
      
      # æ­¥éª¤ 29: é”™è¯¯åˆ†æï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½è¿è¡Œï¼‰
      - name: "29. é”™è¯¯åˆ†æ"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 29: é”™è¯¯åˆ†æ ==="
          firmware-config/scripts/build_firmware_main.sh run_error_analysis
      
      # æ­¥éª¤ 30: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "30. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 30: ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh post_build_space_check
