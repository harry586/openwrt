name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, r3gç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®
          
          ğŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼
        required: true
        type: choice
        default: 'normal'
        options:
        - 'base'
        - 'normal'
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        find firmware-config/scripts -name "*.sh" -exec chmod +x {} \;
        echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi
        echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"

    - name: åˆå§‹åŒ–å·¥å…·é“¾ç›®å½•
      run: |
        firmware-config/scripts/build_firmware_main.sh init_toolchain_dir

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        firmware-config/scripts/build_firmware_main.sh setup_environment

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        firmware-config/scripts/build_firmware_main.sh create_build_dir

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      run: |
        echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
        echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
        firmware-config/scripts/build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"

    - name: æ·»åŠ  TurboACC æ”¯æŒ
      run: |
        firmware-config/scripts/build_firmware_main.sh add_turboacc_support

    - name: é…ç½®Feeds
      run: |
        firmware-config/scripts/build_firmware_main.sh configure_feeds

    - name: å®‰è£… TurboACC åŒ…
      if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
      run: |
        firmware-config/scripts/build_firmware_main.sh install_turboacc_packages

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh pre_build_space_check

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
      run: |
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
        echo "ğŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨å¼ºåˆ¶å¯ç”¨"
        firmware-config/scripts/build_firmware_main.sh generate_config \
          "${{ github.event.inputs.extra_packages }}"

    - name: éªŒè¯USBé…ç½®
      run: |
        echo "=== éªŒè¯USBé…ç½® ==="
        firmware-config/scripts/build_firmware_main.sh verify_usb_config

    - name: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      run: |
        echo "=== USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity

    - name: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      run: |
        echo "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
        firmware-config/scripts/build_firmware_main.sh apply_config

    - name: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶
        if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
          echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "æ–‡ä»¶å¤§å°: $(ls -lh ${{ env.BUILD_DIR }}/.config | awk '{print $5}')"
          echo "é…ç½®è¡Œæ•°: $(wc -l < ${{ env.BUILD_DIR }}/.config)"
          
          # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
          mkdir -p firmware-config/config-backup
          
          # å¤‡ä»½åˆ°å¤šä¸ªä½ç½®ç¡®ä¿å¯é æ€§
          backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
          
          # å¤‡ä»½1: åˆ°ä»“åº“ç›®å½•
          cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
          echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
          
          # å¤‡ä»½2: åˆ°å·¥ä½œåŒº
          cp "${{ env.BUILD_DIR }}/.config" "${{ github.workspace }}/.config.backup"
          echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°å·¥ä½œåŒº: ${{ github.workspace }}/.config.backup"
          
          # å¤‡ä»½3: åˆ°ä¸´æ—¶ç›®å½•
          cp "${{ env.BUILD_DIR }}/.config" "/tmp/.config.backup"
          echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä¸´æ—¶ç›®å½•: /tmp/.config.backup"
          
          # æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶ä¿¡æ¯
          echo "å¤‡ä»½æ–‡ä»¶å¤§å°: $(ls -lh $backup_file | awk '{print $5}')"
          
          # æ£€æŸ¥å…³é”®USBé…ç½®
          echo ""
          echo "=== å…³é”®USBé…ç½®æ£€æŸ¥ ==="
          critical_usb_configs=(
            "CONFIG_PACKAGE_kmod-usb-core=y"
            "CONFIG_PACKAGE_kmod-usb2=y"
            "CONFIG_PACKAGE_kmod-usb3=y"
            "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
            "CONFIG_PACKAGE_kmod-usb-storage=y"
            "CONFIG_PACKAGE_kmod-scsi-core=y"
          )
          
          missing_count=0
          for config in "${critical_usb_configs[@]}"; do
            if grep -q "^$config" "${{ env.BUILD_DIR }}/.config"; then
              echo "âœ… $(echo $config | sed 's/CONFIG_PACKAGE_//;s/=y//')"
            else
              echo "âŒ $(echo $config | sed 's/CONFIG_PACKAGE_//;s/=y//') - ç¼ºå¤±ï¼"
              missing_count=$((missing_count + 1))
            fi
          done
          
          # æ£€æŸ¥å¹³å°ä¸“ç”¨é©±åŠ¨
          echo ""
          echo "=== å¹³å°ä¸“ç”¨é©±åŠ¨æ£€æŸ¥ ==="
          if [[ "${{ env.TARGET }}" == "ipq40xx" ]]; then
            echo "ğŸ”§ æ£€æµ‹åˆ°é«˜é€šIPQ40xxå¹³å°:"
            qcom_configs=(
              "CONFIG_PACKAGE_kmod-usb-dwc3=y"
              "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y"
              "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y"
            )
            for config in "${qcom_configs[@]}"; do
              if grep -q "^$config" "${{ env.BUILD_DIR }}/.config"; then
                echo "âœ… $(echo $config | sed 's/CONFIG_PACKAGE_//;s/=y//')"
              else
                echo "âŒ $(echo $config | sed 's/CONFIG_PACKAGE_//;s/=y//') - ç¼ºå¤±ï¼"
                missing_count=$((missing_count + 1))
              fi
            done
          elif [[ "${{ env.TARGET }}" == "ramips" ]]; then
            echo "ğŸ”§ æ£€æµ‹åˆ°é›·å‡Œå¹³å°:"
            mtk_configs=(
              "CONFIG_PACKAGE_kmod-usb-ohci-pci=y"
              "CONFIG_PACKAGE_kmod-usb2-pci=y"
              "CONFIG_PACKAGE_kmod-usb-xhci-mtk=y"
            )
            for config in "${mtk_configs[@]}"; do
              if grep -q "^$config" "${{ env.BUILD_DIR }}/.config"; then
                echo "âœ… $(echo $config | sed 's/CONFIG_PACKAGE_//;s/=y//')"
              else
                echo "âŒ $(echo $config | sed 's/CONFIG_PACKAGE_//;s/=y//') - ç¼ºå¤±ï¼"
                missing_count=$((missing_count + 1))
              fi
            done
          fi
          
          # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
          echo ""
          echo "ğŸ“Š é…ç½®ç»Ÿè®¡:"
          enabled_count=$(grep "^CONFIG_PACKAGE_.*=y$" "${{ env.BUILD_DIR }}/.config" | wc -l)
          disabled_count=$(grep "^# CONFIG_PACKAGE_.* is not set$" "${{ env.BUILD_DIR }}/.config" | wc -l)
          echo "âœ… å·²å¯ç”¨æ’ä»¶æ€»æ•°: $enabled_count"
          echo "âŒ å·²ç¦ç”¨æ’ä»¶æ€»æ•°: $disabled_count"
          echo "âš ï¸  ç¼ºå¤±å…³é”®é…ç½®: $missing_count ä¸ª"
          
          if [ $missing_count -gt 0 ]; then
            echo ""
            echo "ğŸš¨ è­¦å‘Š: å‘ç° $missing_count ä¸ªå…³é”®é…ç½®ç¼ºå¤±ï¼"
            echo "å°†åœ¨ make defconfig åå°è¯•ä¿®å¤..."
          fi
        else
          echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
          find ${{ env.BUILD_DIR }} -name ".config" -o -name "config" 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
          exit 1
        fi

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        firmware-config/scripts/build_firmware_main.sh fix_network

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        firmware-config/scripts/build_firmware_main.sh download_dependencies

    - name: åŠ è½½å·¥å…·é“¾
      run: |
        echo "=== åŠ è½½å·¥å…·é“¾ ==="
        firmware-config/scripts/build_firmware_main.sh load_toolchain

    - name: æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€
      run: |
        echo "=== æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€ ==="
        cd ${{ env.BUILD_DIR }}
        if [ -d "staging_dir/toolchain-"* ]; then
          echo "âœ… å·¥å…·é“¾å·²åŠ è½½"
          ls -d staging_dir/toolchain-* | head -1
        else
          echo "âŒ å·¥å…·é“¾æœªåŠ è½½"
          echo "å°è¯•ä»ä»“åº“ç›®å½•åŠ è½½å·¥å…·é“¾..."
          firmware-config/scripts/build_firmware_main.sh load_toolchain
        fi

    - name: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      run: |
        echo "=== é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
        firmware-config/scripts/build_firmware_main.sh integrate_custom_files

    - name: å‰ç½®é”™è¯¯æ£€æŸ¥
      run: |
        echo "=== å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh pre_build_error_check

    - name: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        
        # æ£€æŸ¥ç¼–è¯‘æ‰€éœ€ç©ºé—´
        if [ $AVAILABLE_GB -lt 10 ]; then
          echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          exit 1
        elif [ $AVAILABLE_GB -lt 20 ]; then
          echo "âš ï¸  è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
        else
          echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
        fi

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        echo "å¯ç”¨ç¼“å­˜: ${{ github.event.inputs.enable_cache }}"
        firmware-config/scripts/build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"

    - name: ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•
      if: success() && github.event.inputs.enable_cache == 'true'
      run: |
        echo "=== ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½• ==="
        echo "æ³¨æ„ï¼šå·¥å…·é“¾å°†ä¿å­˜åˆ°ä»“åº“çš„ firmware-config/Toolchain/ ç›®å½•ä¸­"
        echo "è¿™æ ·å¯ä»¥æ°¸ä¹…ä¿å­˜å·¥å…·é“¾ï¼Œä¸‹æ¬¡æ„å»ºæ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨"
        firmware-config/scripts/build_firmware_main.sh save_toolchain

    - name: é”™è¯¯åˆ†æ
      if: failure()
      run: |
        echo "=== é”™è¯¯åˆ†æ ==="
        firmware-config/scripts/error_analysis.sh

    - name: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh post_build_space_check

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: success()
      run: |
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh check_firmware_files

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: |
          ${{ github.workspace }}/.config.backup
          ${{ github.workspace }}/firmware-config/config-backup/
        retention-days: 7

    - name: æ¸…ç†ç›®å½•ï¼ˆä¿ç•™é…ç½®æ–‡ä»¶ï¼‰
      if: always()
      run: |
        echo "=== æ¸…ç†ç›®å½•ä½†ä¿ç•™é…ç½®æ–‡ä»¶ ==="
        if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
          echo "å¤‡ä»½é…ç½®æ–‡ä»¶åˆ°å·¥ä½œåŒº..."
          cp "${{ env.BUILD_DIR }}/.config" "${{ github.workspace }}/last_config.config"
          echo "å¤‡ä»½å®Œæˆ: ${{ github.workspace }}/last_config.config"
        fi
        firmware-config/scripts/build_firmware_main.sh cleanup

    - name: è¾“å‡ºæœ€ç»ˆé…ç½®çŠ¶æ€
      if: always()
      run: |
        echo "=== æœ€ç»ˆé…ç½®çŠ¶æ€æ€»ç»“ ==="
        
        # æ£€æŸ¥å¤‡ä»½çš„é…ç½®æ–‡ä»¶
        if [ -f "${{ github.workspace }}/.config.backup" ]; then
          echo "ä»å¤‡ä»½é…ç½®æ£€æŸ¥æœ€ç»ˆçŠ¶æ€:"
          
          echo ""
          echo "ğŸ“Š é…ç½®ç»Ÿè®¡:"
          enabled_count=$(grep "^CONFIG_PACKAGE_.*=y$" "${{ github.workspace }}/.config.backup" | wc -l)
          disabled_count=$(grep "^# CONFIG_PACKAGE_.* is not set$" "${{ github.workspace }}/.config.backup" | wc -l)
          echo "âœ… å·²å¯ç”¨æ’ä»¶æ€»æ•°: $enabled_count"
          echo "âŒ å·²ç¦ç”¨æ’ä»¶æ€»æ•°: $disabled_count"
          
          echo ""
          echo "ğŸ”§ å…³é”®USBé…ç½®çŠ¶æ€:"
          critical_configs=("kmod-usb-core" "kmod-usb2" "kmod-usb3" "kmod-usb-xhci-hcd" "kmod-usb-storage" "kmod-scsi-core")
          for config in "${critical_configs[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${config}=y" "${{ github.workspace }}/.config.backup"; then
              echo "âœ… $config"
            else
              echo "âŒ $config - ç¼ºå¤±ï¼"
            fi
          done
          
          echo ""
          echo "ğŸ› ï¸ å·¥å…·é“¾çŠ¶æ€:"
          if [ -d "firmware-config/Toolchain" ]; then
            echo "âœ… å·¥å…·é“¾å·²ä¿å­˜åˆ°ä»“åº“ç›®å½•: firmware-config/Toolchain/"
            echo "   ä¸‹æ¬¡æ„å»ºå°†è‡ªåŠ¨ä½¿ç”¨å·²ä¿å­˜çš„å·¥å…·é“¾ï¼ŒåŠ é€Ÿç¼–è¯‘è¿‡ç¨‹"
            
            # æ˜¾ç¤ºå·¥å…·é“¾å¤§å°
            toolchain_size=$(du -sh firmware-config/Toolchain 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            echo "   å·¥å…·é“¾å¤§å°: $toolchain_size"
          else
            echo "âš ï¸  å·¥å…·é“¾æœªä¿å­˜åˆ°ä»“åº“ç›®å½•"
          fi
          
          echo ""
          echo "ğŸ“ é…ç½®æ–‡ä»¶å¤‡ä»½:"
          if [ -f "${{ github.workspace }}/last_config.config" ]; then
            echo "âœ… æœ€åé…ç½®æ–‡ä»¶å·²å¤‡ä»½: last_config.config"
          fi
          
          if [ -d "firmware-config/config-backup" ]; then
            backup_count=$(find firmware-config/config-backup -name "*.config" 2>/dev/null | wc -l)
            echo "âœ… ä»“åº“é…ç½®æ–‡ä»¶å¤‡ä»½: $backup_count ä¸ª"
          fi
        else
          echo "âš ï¸  æœªæ‰¾åˆ°å¤‡ä»½çš„é…ç½®æ–‡ä»¶"
        fi
        
        echo ""
        echo "=== æ„å»ºæµç¨‹å®Œæˆ ==="
