name: OpenWrt 智能固件构建工作流

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (如: ac42u, wr841n, mi3g)'
        required: true
        default: 'ac42u'
        type: string
      old_device:
        description: '是否为老旧设备'
        required: true
        default: false
        type: boolean
      version_spec:
        description: '版本规格 (可选，如: openwrt-23.05 或 immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_type:
        description: '配置类型'
        required: true
        default: 'minimal'
        type: choice
        options: ['minimal', 'normal', 'custom']
      extra_packages:
        description: '额外安装插件 (空格分隔)'
        required: false
        type: string

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出配置仓库
      uses: actions/checkout@v4
      with:
        path: openwrt-config
        fetch-depth: 0

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libssl-dev python3 unzip zlib1g-dev subversion gcc-multilib git curl

    - name: 创建构建目录
      run: |
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR

    - name: 智能查找并复制检测脚本
      run: |
        cd $BUILD_DIR
        echo "=== 智能查找并复制检测脚本 ==="
        
        # 切换到工作空间目录
        cd $GITHUB_WORKSPACE
        
        # 智能文件搜索函数
        smart_find_file() {
            local filename="$1"
            local found_path=""
            
            # 定义可能的搜索路径
            local search_paths=(
                "."
                "./openwrt-config"
                "./openwrt-config/firmware-config"
                "./openwrt-config/firmware-config/scripts"
                "./firmware-config"
                "./firmware-config/scripts"
                "./scripts"
                "../openwrt-config"
                "../openwrt-config/firmware-config/scripts"
            )
            
            # 在预定义路径中搜索
            for path in "${search_paths[@]}"; do
                if [ -f "$path/$filename" ]; then
                    found_path="$path/$filename"
                    break
                fi
            done
            
            # 如果还没找到，使用 find 命令广泛搜索
            if [ -z "$found_path" ]; then
                found_path=$(find . -name "$filename" -type f 2>/dev/null | head -1)
            fi
            
            echo "$found_path"
        }
        
        # 查找版本检测脚本
        VERSION_SCRIPT=$(smart_find_file "complete_version_detector.sh")
        if [ -z "$VERSION_SCRIPT" ]; then
            echo "❌ 错误: 找不到 complete_version_detector.sh"
            echo "当前目录结构:"
            find . -name "*.sh" -type f | head -20
            exit 1
        fi
        
        # 查找设备检测脚本
        DEVICE_SCRIPT=$(smart_find_file "device_detection.sh")
        if [ -z "$DEVICE_SCRIPT" ]; then
            echo "❌ 错误: 找不到 device_detection.sh"
            echo "当前目录结构:"
            find . -name "*.sh" -type f | head -20
            exit 1
        fi
        
        echo "✅ 找到版本检测脚本: $VERSION_SCRIPT"
        echo "✅ 找到设备检测脚本: $DEVICE_SCRIPT"
        
        # 复制到构建目录
        cp "$VERSION_SCRIPT" $BUILD_DIR/complete_version_detector.sh
        cp "$DEVICE_SCRIPT" $BUILD_DIR/device_detection.sh
        
        cd $BUILD_DIR
        chmod +x complete_version_detector.sh device_detection.sh
        
        echo "✅ 脚本复制完成"
        ls -la *.sh

    - name: 智能版本检测
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== 智能版本检测 ==="
        
        # 清理构建目录（确保是空的）
        echo "清理构建目录..."
        find . -mindepth 1 -maxdepth 1 ! -name '*.sh' -exec rm -rf {} + 2>/dev/null || true
        
        # 运行完整版本检测器
        if ./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_spec }}" "${{ github.event.inputs.old_device }}"; then
          echo "✅ 版本检测脚本执行成功"
          
          # 智能查找版本信息文件
          smart_find_generated_file() {
              local filename="$1"
              local search_dirs=(
                  "$BUILD_DIR"
                  "$GITHUB_WORKSPACE"
                  "/tmp"
                  "."
              )
              
              for dir in "${search_dirs[@]}"; do
                  if [ -f "$dir/$filename" ]; then
                      echo "$dir/$filename"
                      return 0
                  fi
              done
              
              # 如果没找到，使用 find 命令
              local found_file=$(find $BUILD_DIR $GITHUB_WORKSPACE /tmp . -name "$filename" -type f 2>/dev/null | head -1)
              echo "$found_file"
          }
          
          VERSION_INFO_FILE=$(smart_find_generated_file "version_info.txt")
          if [ -n "$VERSION_INFO_FILE" ] && [ -f "$VERSION_INFO_FILE" ]; then
            echo "✅ 找到版本信息文件: $VERSION_INFO_FILE"
            echo "=== 版本信息文件内容 ==="
            cat "$VERSION_INFO_FILE"
            
            # 读取变量并设置到环境变量
            SELECTED_REPO=$(grep '^SELECTED_REPO=' "$VERSION_INFO_FILE" | cut -d'=' -f2)
            SELECTED_BRANCH=$(grep '^SELECTED_BRANCH=' "$VERSION_INFO_FILE" | cut -d'=' -f2)
            SELECTED_REPO_URL=$(grep '^SELECTED_REPO_URL=' "$VERSION_INFO_FILE" | cut -d'=' -f2)
            
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            
            echo "✅ 环境变量已设置:"
            echo "SELECTED_REPO: $SELECTED_REPO"
            echo "SELECTED_BRANCH: $SELECTED_BRANCH"
            echo "SELECTED_REPO_URL: $SELECTED_REPO_URL"
          else
            echo "⚠️ 未找到版本信息文件，从脚本输出解析"
            # 直接从脚本输出解析版本信息
            OUTPUT_FILE="version_output.txt"
            ./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_spec }}" "${{ github.event.inputs.old_device }}" > "$OUTPUT_FILE" 2>&1 || true
            
            # 从输出中解析版本信息
            SELECTED_REPO=$(grep "推荐仓库:" "$OUTPUT_FILE" | awk '{print $2}')
            SELECTED_BRANCH=$(grep "推荐分支:" "$OUTPUT_FILE" | awk '{print $2}')
            SELECTED_REPO_URL=$(grep "仓库URL:" "$OUTPUT_FILE" | awk '{print $2}')
            
            if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
              echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
              echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
              echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
              
              echo "✅ 从输出解析环境变量成功:"
              echo "SELECTED_REPO: $SELECTED_REPO"
              echo "SELECTED_BRANCH: $SELECTED_BRANCH"
              echo "SELECTED_REPO_URL: $SELECTED_REPO_URL"
            else
              echo "⚠️ 从输出解析失败，使用默认值"
              # 根据设备设置默认值
              case "${{ github.event.inputs.device_name }}" in
                ac42u|ax42u|redmi_ax6s)
                  echo "SELECTED_REPO=immortalwrt" >> $GITHUB_ENV
                  echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
                  echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
                  ;;
                wr841n|tl-wr841n)
                  echo "SELECTED_REPO=openwrt" >> $GITHUB_ENV
                  echo "SELECTED_BRANCH=openwrt-22.03" >> $GITHUB_ENV
                  echo "SELECTED_REPO_URL=https://git.openwrt.org/openwrt/openwrt.git" >> $GITHUB_ENV
                  ;;
                *)
                  echo "SELECTED_REPO=openwrt" >> $GITHUB_ENV
                  echo "SELECTED_BRANCH=main" >> $GITHUB_ENV
                  echo "SELECTED_REPO_URL=https://git.openwrt.org/openwrt/openwrt.git" >> $GITHUB_ENV
                  ;;
              esac
              echo "✅ 使用默认环境变量"
            fi
          fi
        else
          echo "❌ 版本检测失败"
          exit 1
        fi

    - name: 克隆选定版本的源码
      run: |
        cd $BUILD_DIR
        echo "=== 克隆选定版本的源码 ==="
        echo "仓库: $SELECTED_REPO"
        echo "分支: $SELECTED_BRANCH"
        echo "URL: $SELECTED_REPO_URL"
        
        # 验证环境变量
        if [ -z "$SELECTED_REPO" ] || [ -z "$SELECTED_BRANCH" ] || [ -z "$SELECTED_REPO_URL" ]; then
          echo "❌ 错误: 环境变量未正确设置"
          exit 1
        fi
        
        # 清理构建目录（保留脚本文件）
        echo "清理构建目录..."
        find . -mindepth 1 -maxdepth 1 ! -name '*.sh' -exec rm -rf {} + 2>/dev/null || true
        
        echo "开始克隆仓库..."
        git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
        
        if [ $? -eq 0 ]; then
          echo "✅ 源码克隆完成"
          # 验证克隆是否成功
          if [ -d ".git" ]; then
            echo "✅ Git 仓库验证成功"
          else
            echo "❌ Git 仓库验证失败"
            exit 1
          fi
        else
          echo "❌ 源码克隆失败"
          exit 1
        fi

    - name: 智能设备检测
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== 智能设备检测 ==="
        
        # 运行设备检测脚本
        if ./device_detection.sh "${{ github.event.inputs.device_name }}"; then
          echo "✅ 设备检测脚本执行成功"
          
          # 智能查找设备信息文件
          smart_find_generated_file() {
              local filename="$1"
              local search_dirs=(
                  "$BUILD_DIR"
                  "$GITHUB_WORKSPACE"
                  "/tmp"
                  "."
              )
              
              for dir in "${search_dirs[@]}"; do
                  if [ -f "$dir/$filename" ]; then
                      echo "$dir/$filename"
                      return 0
                  fi
              done
              
              # 如果没找到，使用 find 命令
              local found_file=$(find $BUILD_DIR $GITHUB_WORKSPACE /tmp . -name "$filename" -type f 2>/dev/null | head -1)
              echo "$found_file"
          }
          
          DEVICE_INFO_FILE=$(smart_find_generated_file "device_info.txt")
          if [ -n "$DEVICE_INFO_FILE" ] && [ -f "$DEVICE_INFO_FILE" ]; then
            echo "✅ 找到设备信息文件: $DEVICE_INFO_FILE"
            echo "=== 设备信息文件内容 ==="
            cat "$DEVICE_INFO_FILE"
            
            PLATFORM=$(grep '^PLATFORM=' "$DEVICE_INFO_FILE" | cut -d'=' -f2)
            DEVICE_SHORT_NAME=$(grep '^DEVICE_SHORT_NAME=' "$DEVICE_INFO_FILE" | cut -d'=' -f2)
            DEVICE_FULL_NAME=$(grep '^DEVICE_FULL_NAME=' "$DEVICE_INFO_FILE" | cut -d'=' -f2)
            
            echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
            echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
            
            echo "✅ 设备环境变量已设置:"
            echo "PLATFORM: $PLATFORM"
            echo "DEVICE_SHORT_NAME: $DEVICE_SHORT_NAME"
            echo "DEVICE_FULL_NAME: $DEVICE_FULL_NAME"
          else
            echo "⚠️ 未找到设备信息文件，从脚本输出解析"
            # 直接从脚本输出解析设备信息
            OUTPUT_FILE="device_output.txt"
            ./device_detection.sh "${{ github.event.inputs.device_name }}" > "$OUTPUT_FILE" 2>&1 || true
            
            # 从输出中解析设备信息
            PLATFORM=$(grep "平台:" "$OUTPUT_FILE" | awk '{print $2}')
            DEVICE_SHORT_NAME=$(grep "设备短名:" "$OUTPUT_FILE" | awk '{print $2}')
            DEVICE_FULL_NAME=$(grep "设备全名:" "$OUTPUT_FILE" | cut -d':' -f2- | sed 's/^ *//')
            
            if [ -n "$PLATFORM" ] && [ -n "$DEVICE_SHORT_NAME" ]; then
              echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
              echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
              echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
              
              echo "✅ 从输出解析设备信息成功:"
              echo "PLATFORM: $PLATFORM"
              echo "DEVICE_SHORT_NAME: $DEVICE_SHORT_NAME"
              echo "DEVICE_FULL_NAME: $DEVICE_FULL_NAME"
            else
              echo "⚠️ 从输出解析失败，使用默认值"
              # 根据设备设置默认值
              case "${{ github.event.inputs.device_name }}" in
                ac42u|ax42u|redmi_ax6s)
                  echo "PLATFORM=mediatek" >> $GITHUB_ENV
                  echo "DEVICE_SHORT_NAME=xiaomi_redmi-ax6s" >> $GITHUB_ENV
                  echo "DEVICE_FULL_NAME=Xiaomi Redmi AX6S" >> $GITHUB_ENV
                  ;;
                wr841n|tl-wr841n)
                  echo "PLATFORM=ar71xx" >> $GITHUB_ENV
                  echo "DEVICE_SHORT_NAME=tl-wr841n-v9" >> $GITHUB_ENV
                  echo "DEVICE_FULL_NAME=TP-Link TL-WR841N" >> $GITHUB_ENV
                  ;;
                mi3g|xiaomi_mi3g)
                  echo "PLATFORM=ramips" >> $GITHUB_ENV
                  echo "DEVICE_SHORT_NAME=xiaomi_mi-router-3g" >> $GITHUB_ENV
                  echo "DEVICE_FULL_NAME=Xiaomi Mi Router 3G" >> $GITHUB_ENV
                  ;;
                *)
                  echo "PLATFORM=ramips" >> $GITHUB_ENV
                  echo "DEVICE_SHORT_NAME=generic" >> $GITHUB_ENV
                  echo "DEVICE_FULL_NAME=Generic Device" >> $GITHUB_ENV
                  ;;
              esac
              echo "✅ 使用默认设备环境变量"
            fi
          fi
        else
          echo "❌ 设备检测失败"
          exit 1
        fi

    - name: 更新安装feeds
      run: |
        cd $BUILD_DIR
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成设备配置
      run: |
        cd $BUILD_DIR
        echo "=== 生成设备配置 ==="
        
        # 记录版本信息
        echo "# 智能选择的版本: $SELECTED_REPO - $SELECTED_BRANCH" > .config
        echo "# 设备: ${{ github.event.inputs.device_name }}" >> .config
        echo "# 老旧设备模式: ${{ github.event.inputs.old_device }}" >> .config
        echo "# 生成时间: $(date)" >> .config
        echo "" >> .config
        
        # 基础平台配置
        echo "CONFIG_TARGET_${PLATFORM}=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic=y" >> .config
        echo "CONFIG_TARGET_DEVICE_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        
        # 根据平台添加特定配置
        case "$PLATFORM" in
          "ipq40xx"|"ipq807x"|"mediatek")
            echo "CONFIG_PACKAGE_ath10k-firmware-qca4019=y" >> .config
            echo "CONFIG_PACKAGE_ath10k-board-qca4019=y" >> .config
            ;;
          "ramips")
            echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
            ;;
          "ar71xx")
            # 老旧设备通常使用 ar71xx 平台
            echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
            echo "CONFIG_PACKAGE_kmod-ath9k=y" >> .config
            ;;
        esac
        
        # 根据配置类型设置
        case "${{ github.event.inputs.config_type }}" in
          "minimal")
            echo "CONFIG_PACKAGE_luci=n" >> .config
            echo "CONFIG_PACKAGE_luci-ssl=n" >> .config
            ;;
          "normal"|"custom")
            echo "CONFIG_PACKAGE_luci=y" >> .config
            echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
            echo "CONFIG_PACKAGE_luci-proto-ipv6=y" >> .config
            echo "CONFIG_PACKAGE_luci-proto-ppp=y" >> .config
            ;;
        esac
        
        # 自定义包
        if [ "${{ github.event.inputs.config_type }}" = "custom" ] && [ -n "${{ github.event.inputs.extra_packages }}" ]; then
          for pkg in ${{ github.event.inputs.extra_packages }}; do
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          done
        fi
        
        # 基础系统包
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nft-offload=y" >> .config
        
        echo "✅ 配置生成完成"

    - name: 应用配置并编译
      run: |
        cd $BUILD_DIR
        echo "=== 应用配置并编译 ==="
        
        # 应用配置
        make defconfig
        
        # 下载软件包
        make -j4 download
        
        # 编译固件
        make -j$(nproc) V=s

    - name: 验证固件生成
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== 固件生成验证 ==="
        
        if [ -d "bin/targets" ]; then
          echo "✅ 找到目标目录"
          echo "生成的固件:"
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) -exec ls -lh {} \;
          
          # 显示文件大小和路径
          echo "=== 固件文件详情 ==="
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) | while read file; do
            echo "固件: $file ($(du -h "$file" | cut -f1))"
          done
        else
          echo "❌ 未找到目标目录 bin/targets"
          echo "当前目录内容:"
          ls -la
          echo "bin 目录内容:"
          ls -la bin/ 2>/dev/null || echo "bin 目录不存在"
        fi

    - name: 上传编译产物
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: 上传版本信息
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/version_info.txt
          ${{ env.BUILD_DIR }}/device_info.txt
        retention-days: 7
