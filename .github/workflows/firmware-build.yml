name: OpenWrt 智能固件构建工作流

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (ac42u/RT-ACRH17)'
        required: true
        default: 'ac42u'
        type: string
      version_spec:
        description: '版本规格 (可选，如: openwrt-23.05 或 immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_profile:
        description: '配置模板'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - normal
          - full
      extra_packages:
        description: '额外安装插件 (空格分隔)'
        required: false
        type: string

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出配置仓库
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libssl-dev python3 unzip zlib1g-dev subversion gcc-multilib git curl

    - name: 创建构建目录
      run: |
        echo "=== 创建构建目录 ==="
        # 彻底删除旧目录
        sudo rm -rf $BUILD_DIR
        # 创建新目录
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        cd $BUILD_DIR
        echo "当前目录: $(pwd)"
        ls -la

    - name: 复制配置脚本
      run: |
        echo "=== 复制配置脚本 ==="
        cd $GITHUB_WORKSPACE
        
        VERSION_SCRIPT=$(find . -name "complete_version_detector.sh" -type f | head -1)
        if [ -z "$VERSION_SCRIPT" ]; then
          echo "❌ 错误: 找不到 complete_version_detector.sh"
          exit 1
        fi
        
        echo "✅ 找到版本检测脚本: $VERSION_SCRIPT"
        cp "$VERSION_SCRIPT" $BUILD_DIR/complete_version_detector.sh
        chmod +x $BUILD_DIR/complete_version_detector.sh
        echo "✅ 脚本复制完成"

    - name: 智能版本检测
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== 智能版本检测 ==="
        
        if ./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_spec }}" "false"; then
          echo "✅ 版本检测脚本执行成功"
          
          if [ -f "version_info.txt" ]; then
            echo "✅ 找到版本信息文件"
            echo "=== version_info.txt 内容 ==="
            cat version_info.txt
            
            SELECTED_REPO_URL=$(grep '^SELECTED_REPO_URL=' version_info.txt | cut -d'=' -f2)
            SELECTED_BRANCH=$(grep '^SELECTED_BRANCH=' version_info.txt | cut -d'=' -f2)
            
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            
            echo "✅ 环境变量已设置:"
            echo "SELECTED_REPO_URL: $SELECTED_REPO_URL"
            echo "SELECTED_BRANCH: $SELECTED_BRANCH"
          else
            echo "❌ 未找到版本信息文件"
            exit 1
          fi
        else
          echo "❌ 版本检测失败"
          exit 1
        fi

    - name: 保存版本信息并清理目录
      run: |
        echo "=== 保存版本信息并清理目录 ==="
        
        # 保存版本信息到临时位置
        if [ -f "$BUILD_DIR/version_info.txt" ]; then
          cp $BUILD_DIR/version_info.txt /tmp/version_info.txt
          echo "✅ 版本信息已保存到临时位置"
        fi
        
        # 彻底清理构建目录
        echo "彻底清理构建目录..."
        cd /
        sudo rm -rf $BUILD_DIR
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        
        # 恢复版本信息
        if [ -f "/tmp/version_info.txt" ]; then
          cp /tmp/version_info.txt $BUILD_DIR/version_info.txt
          echo "✅ 版本信息已恢复"
        fi
        
        cd $BUILD_DIR
        echo "清理后目录内容:"
        ls -la
        echo "✅ 目录清理完成"

    - name: 克隆选定版本的源码
      run: |
        cd $BUILD_DIR
        echo "=== 克隆选定版本的源码 ==="
        echo "仓库: $SELECTED_REPO_URL"
        echo "分支: $SELECTED_BRANCH"
        
        if [ -z "$SELECTED_REPO_URL" ] || [ -z "$SELECTED_BRANCH" ]; then
          echo "❌ 错误: 环境变量未正确设置"
          exit 1
        fi
        
        echo "检查目录状态..."
        echo "当前目录内容:"
        ls -la
        
        # 确保目录为空（除了我们保留的version_info.txt）
        FILE_COUNT=$(ls -A | grep -v 'version_info.txt' | wc -l)
        if [ $FILE_COUNT -ne 0 ]; then
          echo "❌ 错误: 目录非空，无法克隆"
          echo "当前文件列表:"
          ls -la
          exit 1
        fi
        
        echo "开始克隆仓库..."
        git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
        
        if [ $? -eq 0 ]; then
          echo "✅ 源码克隆完成"
          echo "克隆后目录内容:"
          ls -la
        else
          echo "❌ 源码克隆失败"
          exit 1
        fi

    - name: 恢复版本信息
      run: |
        cd $BUILD_DIR
        echo "=== 恢复版本信息 ==="
        
        # 如果临时文件存在，复制回来
        if [ -f "/tmp/version_info.txt" ]; then
          cp /tmp/version_info.txt .
          echo "✅ 版本信息已恢复"
          echo "版本信息文件内容:"
          cat version_info.txt
        else
          echo "⚠️ 未找到临时版本信息文件"
        fi

    - name: 更新和安装feeds
      run: |
        cd $BUILD_DIR
        echo "=== 更新和安装feeds ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        if [ $? -ne 0 ]; then
          echo "❌ Feeds 更新失败"
          exit 1
        fi

    - name: 生成基础配置
      run: |
        cd $BUILD_DIR
        echo "=== 生成基础配置 ==="
        
        # 使用defconfig生成基础配置
        make defconfig
        if [ $? -ne 0 ]; then
          echo "❌ 生成基础配置失败"
          exit 1
        fi

    - name: 配置目标设备
      run: |
        cd $BUILD_DIR
        echo "=== 配置目标设备 ==="
        
        # 根据设备名称配置目标平台
        case "${{ github.event.inputs.device_name }}" in
          "ac42u"|"rt-acrh17")
            echo "配置 RT-ACRH17 设备"
            # 设置目标平台为 ipq40xx
            sed -i 's/CONFIG_TARGET_[a-zA-Z0-9]*=y/# &/' .config
            echo "CONFIG_TARGET_ipq40xx=y" >> .config
            echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
            echo "CONFIG_TARGET_DEVICE_ipq40xx_generic_DEVICE_asus_rt-acrh17=y" >> .config
            ;;
          *)
            echo "❌ 不支持的设备: ${{ github.event.inputs.device_name }}"
            exit 1
            ;;
        esac

    - name: 应用配置模板
      run: |
        cd $BUILD_DIR
        echo "=== 应用配置模板 ==="
        
        # 备份原始配置
        cp .config .config.original
        
        # 根据模板修改配置
        case "${{ github.event.inputs.config_profile }}" in
          "minimal")
            echo "应用最小化配置"
            # 取消选择LUCI
            sed -i 's/CONFIG_PACKAGE_luci=y/# CONFIG_PACKAGE_luci is not set/' .config
            ;;
          "normal")
            echo "应用标准配置"
            # 确保选择LUCI
            sed -i 's/# CONFIG_PACKAGE_luci is not set/CONFIG_PACKAGE_luci=y/' .config
            echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
            ;;
          "full")
            echo "应用完整配置"
            # 选择更多包
            sed -i 's/# CONFIG_PACKAGE_luci is not set/CONFIG_PACKAGE_luci=y/' .config
            echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
            ;;
        esac
        
        # 添加额外包
        if [ -n "${{ github.event.inputs.extra_packages }}" ]; then
          echo "添加额外包: ${{ github.event.inputs.extra_packages }}"
          for pkg in ${{ github.event.inputs.extra_packages }}; do
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          done
        fi

    - name: 最终配置确认
      run: |
        cd $BUILD_DIR
        echo "=== 最终配置确认 ==="
        
        # 检查目标平台配置
        echo "目标平台配置:"
        grep "CONFIG_TARGET" .config | head -10
        
        echo "设备配置:"
        grep "CONFIG_TARGET_DEVICE" .config
        
        echo "主要包配置:"
        grep "CONFIG_PACKAGE_luci" .config

    - name: 下载依赖
      run: |
        cd $BUILD_DIR
        echo "=== 下载依赖 ==="
        make -j4 download
        if [ $? -ne 0 ]; then
          echo "❌ 下载依赖失败"
          exit 1
        fi

    - name: 编译固件
      run: |
        cd $BUILD_DIR
        echo "=== 开始编译固件 ==="
        make -j$(nproc) V=s
        if [ $? -ne 0 ]; then
          echo "❌ 编译失败"
          exit 1
        fi

    - name: 验证构建结果
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== 构建结果验证 ==="
        
        if [ -d "bin/targets" ]; then
          echo "✅ 构建成功！生成的固件:"
          find bin/targets -name "*.bin" -o -name "*.img" | head -10
          
          echo "=== 固件大小 ==="
          find bin/targets -name "*.bin" -o -name "*.img" -exec ls -lh {} \;
        else
          echo "❌ 构建失败，未找到目标文件"
          exit 1
        fi

    - name: 上传固件产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: 上传配置和日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/.config.original
          ${{ env.BUILD_DIR }}/version_info.txt
        retention-days: 7
