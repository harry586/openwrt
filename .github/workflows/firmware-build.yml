name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆé›†æˆæ™ºèƒ½ä¿®å¤ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, acrh17, r3gç­‰)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®
          
          ğŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚
        required: false
        type: string
        default: ""
      enable_cache:
        description: "âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)"
        required: false
        default: true
        type: boolean
      commit_toolchain:
        description: "ğŸ’¾ æäº¤å·¥å…·é“¾åˆ°ä»“åº“ (èŠ‚çœä¸‹æ¬¡ç¼–è¯‘æ—¶é—´)"
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  GIT_LFS_SKIP_SMUDGE: 1
  ENABLE_CACHE: "true"
  COMMIT_TOOLCHAIN: "true"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤0ï¼šå‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: "ğŸ“ 0. å‡†å¤‡æ„å»ºç¯å¢ƒ"
        id: prepare_environment
        run: |
          echo "========================================"
          echo "ğŸ“ æ­¥éª¤0ï¼šå‡†å¤‡æ„å»ºç¯å¢ƒ"
          echo "========================================"
          echo ""
          
          # åˆ›å»ºæ„å»ºç›®å½•
          echo "ğŸ“ åˆ›å»ºæ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          sudo mkdir -p ${{ env.BUILD_DIR }}
          sudo chmod 777 ${{ env.BUILD_DIR }}
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ -d "${{ env.BUILD_DIR }}" ]; then
            echo "âœ… æ„å»ºç›®å½•åˆ›å»ºæˆåŠŸ"
            echo "  è·¯å¾„: ${{ env.BUILD_DIR }}"
            echo "  æƒé™: $(ls -ld ${{ env.BUILD_DIR }} | awk '{print $1}')"
          else
            echo "âŒ æ„å»ºç›®å½•åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          # åˆ›å»ºå…¶ä»–å¿…è¦ç›®å½•
          echo "ğŸ“ åˆ›å»ºå…¶ä»–å¿…è¦ç›®å½•..."
          mkdir -p /tmp/source-upload
          mkdir -p /tmp/build-artifacts
          
          echo ""
          echo "ğŸ’½ ç£ç›˜ç©ºé—´æ£€æŸ¥:"
          df -h ${{ env.BUILD_DIR }}
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤0å®Œæˆï¼šç¯å¢ƒå‡†å¤‡å®Œæˆ"
          echo "========================================"
      
      # æ­¥éª¤1ï¼šä¸‹è½½å®Œæ•´æºä»£ç 
      - name: "ğŸ“¥ 1. ä¸‹è½½å®Œæ•´æºä»£ç "
        id: download_source
        run: |
          # åˆ›å»ºå·¥ä½œåŒºç›®å½•
          mkdir -p ${{ github.workspace }}
          cd ${{ github.workspace }}
          
          # æ¸…ç†å·¥ä½œåŒº
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œåŒº..."
          find . -maxdepth 1 ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true
          
          # å…‹éš†å®Œæ•´ä»“åº“
          echo "ğŸ“¦ å…‹éš†å®Œæ•´ä»“åº“..."
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          
          if [ ! -d ".git" ]; then
            echo "âŒ é”™è¯¯: ä»“åº“å…‹éš†å¤±è´¥"
            exit 1
          fi
          
          # è®¾ç½®è„šæœ¬æƒé™
          echo "ğŸ”§ è®¾ç½®è„šæœ¬æƒé™..."
          find . -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null || true
          
          echo "âœ… æºä»£ç ä¸‹è½½å®Œæˆ"
      
      # æ­¥éª¤2ï¼šç«‹å³ä¸Šä¼ æºä»£ç 
      - name: "ğŸ“¤ 2. ç«‹å³ä¸Šä¼ æºä»£ç "
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step2_upload_source
      
      # æ­¥éª¤3ï¼šä¸Šä¼ æºä»£ç å‹ç¼©åŒ…
      - name: "ğŸ“¤ 3. ä¸Šä¼ æºä»£ç å‹ç¼©åŒ…"
        uses: actions/upload-artifact@v4
        with:
          name: "source-code-${{ github.event.inputs.device_name }}-${{ github.run_id }}"
          path: /tmp/source-upload/
          retention-days: 7
      
      # æ­¥éª¤4ï¼šå®‰è£…Git LFS
      - name: "ğŸ”§ 4. å®‰è£…Git LFSå’Œé…ç½®"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step4_install_git_lfs
      
      # æ­¥éª¤5ï¼šæ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€
      - name: "ğŸ“Š 5. æ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step5_check_large_files
      
      # æ­¥éª¤6ï¼šæ£€æŸ¥å·¥å…·é“¾ç›®å½•çŠ¶æ€
      - name: "ğŸ—‚ï¸ 6. æ£€æŸ¥å·¥å…·é“¾ç›®å½•çŠ¶æ€"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step6_check_toolchain_dir
      
      # æ­¥éª¤7ï¼šåˆå§‹åŒ–å·¥å…·é“¾ç›®å½•
      - name: "ğŸ’¾ 7. åˆå§‹åŒ–å·¥å…·é“¾ç›®å½•"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step7_init_toolchain_dir
      
      # æ­¥éª¤8ï¼šè®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      - name: "ğŸ› ï¸ 8. è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step8_setup_environment
      
      # æ­¥éª¤9ï¼šåˆ›å»ºæ„å»ºç›®å½•
      - name: "ğŸ“ 9. åˆ›å»ºæ„å»ºç›®å½•"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step9_create_build_dir
      
      # æ­¥éª¤10ï¼šåˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      - name: "ğŸš€ 10. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        id: init_build_env
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step10_init_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}" "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤11ï¼šæ˜¾ç¤ºæ„å»ºé…ç½®
      - name: "âš¡ 11. æ˜¾ç¤ºæ„å»ºé…ç½®"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step11_show_config
      
      # æ­¥éª¤12ï¼šæ·»åŠ TurboACCæ”¯æŒ
      - name: "ğŸ”Œ 12. æ·»åŠ TurboACCæ”¯æŒ"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step12_add_turboacc_support
      
      # æ­¥éª¤13ï¼šé…ç½®Feeds
      - name: "ğŸ“¦ 13. é…ç½®Feeds"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step13_configure_feeds
      
      # æ­¥éª¤14ï¼šå®‰è£…TurboACCåŒ…
      - name: "ğŸ”§ 14. å®‰è£…TurboACCåŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step14_install_turboacc_packages
      
      # æ­¥éª¤15ï¼šç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 15. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step15_pre_build_space_check
      
      # æ­¥éª¤16ï¼šæ™ºèƒ½é…ç½®ç”Ÿæˆ
      - name: "âš™ï¸ 16. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step16_generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤17ï¼šéªŒè¯USBé…ç½®
      - name: "ğŸ” 17. éªŒè¯USBé…ç½®"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step17_verify_usb_config
      
      # æ­¥éª¤18ï¼šUSBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "ğŸ›¡ï¸ 18. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step18_check_usb_drivers_integrity
      
      # æ­¥éª¤19ï¼šåº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "âœ… 19. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step19_apply_config
      
      # æ­¥éª¤20ï¼šæ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "ğŸ’¾ 20. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step20_backup_config
      
      # æ­¥éª¤21ï¼šä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "ğŸŒ 21. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step21_fix_network
      
      # æ­¥éª¤22ï¼šåŠ è½½å·¥å…·é“¾
      - name: "ğŸ”§ 22. åŠ è½½å·¥å…·é“¾"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step22_load_toolchain
      
      # æ­¥éª¤23ï¼šæ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€
      - name: "ğŸ“Š 23. æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step23_check_toolchain_status
      
      # ğŸ”¥ æ­¥éª¤24ï¼šæ™ºèƒ½æŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬ï¼ˆæ ¸å¿ƒä¿®å¤æ­¥éª¤ï¼‰
      - name: "ğŸ” 24. æ™ºèƒ½æŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬"
        id: find_and_run_fix
        run: |
          echo "========================================"
          echo "ğŸ” æ­¥éª¤24ï¼šæ™ºèƒ½æŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬"
          echo "========================================"
          echo ""
          
          # å®šä¹‰å¯èƒ½çš„è„šæœ¬ä½ç½®ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
          POSSIBLE_PATHS=(
            "firmware-config/scripts/fix-build.sh"           # ç”¨æˆ·æŒ‡å®šä½ç½®ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
            "firmware-config/scripts/fix-build-issues.sh"    # å¤‡ç”¨ä¿®å¤è„šæœ¬
            ".github/scripts/fix-build-issues.sh"           # æ ‡å‡†GitHubè„šæœ¬ä½ç½®
            "scripts/fix-build.sh"                          # æ ¹ç›®å½•scriptsæ–‡ä»¶å¤¹
            "firmware-config/fix-build.sh"                  # é…ç½®ç›®å½•æ ¹
            "fix-script.sh"                                 # æ ¹ç›®å½•é€šç”¨å
            "automation/fix-build.sh"                       # è‡ªåŠ¨åŒ–ç›®å½•
          )
          
          FIX_SCRIPT=""
          SCRIPT_LOCATION=""
          FOUND_IN="é¢„è®¾è·¯å¾„"
          
          echo "ğŸ“‚ å¼€å§‹æŸ¥æ‰¾ä¿®å¤è„šæœ¬..."
          echo "æœç´¢ä¼˜å…ˆçº§:"
          for i in "${!POSSIBLE_PATHS[@]}"; do
            echo "  $((i+1)). ${POSSIBLE_PATHS[$i]}"
          done
          echo ""
          
          # ç¬¬ä¸€é˜¶æ®µï¼šæ£€æŸ¥é¢„è®¾è·¯å¾„
          for path in "${POSSIBLE_PATHS[@]}"; do
            FULL_PATH="${{ github.workspace }}/$path"
            if [ -f "$FULL_PATH" ]; then
              FIX_SCRIPT="$FULL_PATH"
              SCRIPT_LOCATION="$path"
              echo "âœ… åœ¨é¢„è®¾è·¯å¾„æ‰¾åˆ°è„šæœ¬: $path"
              break
            else
              echo "  â³ æ£€æŸ¥: $path ... ä¸å­˜åœ¨"
            fi
          done
          
          # ç¬¬äºŒé˜¶æ®µï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•å…¨å±€æŸ¥æ‰¾
          if [ -z "$FIX_SCRIPT" ]; then
            echo ""
            echo "ğŸ”„ æœªåœ¨é¢„è®¾è·¯å¾„æ‰¾åˆ°è„šæœ¬ï¼Œå°è¯•å…¨å±€æŸ¥æ‰¾..."
            FOUND_SCRIPTS=$(find "${{ github.workspace }}" -type f \( -name "*fix*.sh" -o -name "*repair*.sh" -o -name "*patch*.sh" \) 2>/dev/null | head -10)
            
            if [ -n "$FOUND_SCRIPTS" ]; then
              # æŒ‰ä¼˜å…ˆçº§æ’åºï¼šä¼˜å…ˆé€‰æ‹©åŒ…å«"build"æˆ–"openwrt"çš„è„šæœ¬
              SELECTED_SCRIPT=""
              for script in $FOUND_SCRIPTS; do
                if [[ "$script" == *"build"* ]] || [[ "$script" == *"openwrt"* ]]; then
                  SELECTED_SCRIPT="$script"
                  break
                fi
              done
              
              # å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ…å«å…³é”®å­—çš„ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
              if [ -z "$SELECTED_SCRIPT" ]; then
                SELECTED_SCRIPT=$(echo "$FOUND_SCRIPTS" | head -1)
              fi
              
              FIX_SCRIPT="$SELECTED_SCRIPT"
              SCRIPT_LOCATION=$(echo "$FIX_SCRIPT" | sed "s|${{ github.workspace }}/||")
              FOUND_IN="å…¨å±€æŸ¥æ‰¾"
              echo "ğŸ” å…¨å±€æŸ¥æ‰¾åˆ°è„šæœ¬: $SCRIPT_LOCATION"
              echo "æ‰¾åˆ°çš„å…¶ä»–è„šæœ¬:"
              echo "$FOUND_SCRIPTS" | while read s; do
                if [ "$s" != "$SELECTED_SCRIPT" ]; then
                  echo "  ğŸ“„ $(echo $s | sed "s|${{ github.workspace }}/||")"
                fi
              done
            fi
          fi
          
          # æ‰§è¡Œè„šæœ¬ï¼ˆå¦‚æœæ‰¾åˆ°ï¼‰
          if [ -n "$FIX_SCRIPT" ] && [ -f "$FIX_SCRIPT" ]; then
            echo ""
            echo "ğŸš€ å¼€å§‹æ‰§è¡Œä¿®å¤è„šæœ¬ ($FOUND_IN)"
            echo "è„šæœ¬ä½ç½®: $SCRIPT_LOCATION"
            echo "å®Œæ•´è·¯å¾„: $FIX_SCRIPT"
            echo "========================================"
            
            # è®¾ç½®æ‰§è¡Œæƒé™
            chmod +x "$FIX_SCRIPT"
            
            # è¿›å…¥æ„å»ºç›®å½•
            cd ${{ env.BUILD_DIR }}/openwrt || { echo "âŒ æ— æ³•è¿›å…¥æ„å»ºç›®å½•"; exit 1; }
            
            # æ£€æŸ¥å½“å‰ç›®å½•
            echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
            echo "ç›®å½•å†…å®¹:"
            ls -la 2>/dev/null | head -5 || true
            
            # æ‰§è¡Œä¿®å¤è„šæœ¬å¹¶è®°å½•è¾“å‡º
            echo ""
            echo "ğŸ“ ä¿®å¤è„šæœ¬è¾“å‡º:"
            echo "----------------------------------------"
            
            # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
            LOG_FILE="/tmp/fix-script-output-$(date +%Y%m%d_%H%M%S).log"
            
            # æ‰§è¡Œè„šæœ¬ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰
            timeout 300 "$FIX_SCRIPT" 2>&1 | tee "$LOG_FILE"
            
            # æ£€æŸ¥æ‰§è¡Œç»“æœ
            FIX_EXIT_CODE=${PIPESTATUS[0]}
            
            echo "----------------------------------------"
            
            if [ $FIX_EXIT_CODE -eq 0 ]; then
              echo "âœ… ä¿®å¤è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
              echo "ğŸ“„ ä¿®å¤æ—¥å¿—å·²ä¿å­˜è‡³: $LOG_FILE"
              echo "fix_script_status=success" >> $GITHUB_OUTPUT
              echo "fix_script_location=$SCRIPT_LOCATION" >> $GITHUB_OUTPUT
              echo "fix_script_found_in=$FOUND_IN" >> $GITHUB_OUTPUT
            elif [ $FIX_EXIT_CODE -eq 124 ]; then
              echo "â° ä¿®å¤è„šæœ¬æ‰§è¡Œè¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰ï¼Œä½†å¯èƒ½å·²éƒ¨åˆ†å®Œæˆ"
              echo "fix_script_status=timeout" >> $GITHUB_OUTPUT
              echo "fix_script_location=$SCRIPT_LOCATION" >> $GITHUB_OUTPUT
              echo "fix_script_found_in=$FOUND_IN" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ ä¿®å¤è„šæœ¬æ‰§è¡Œæœ‰é”™è¯¯ (é€€å‡ºç : $FIX_EXIT_CODE)"
              echo "ğŸ“„ é”™è¯¯æ—¥å¿—: $LOG_FILE"
              echo "æœ€å20è¡Œè¾“å‡º:"
              tail -20 "$LOG_FILE" 2>/dev/null || echo "æ— æ³•è¯»å–æ—¥å¿—"
              echo "fix_script_status=error" >> $GITHUB_OUTPUT
              echo "fix_script_location=$SCRIPT_LOCATION" >> $GITHUB_OUTPUT
              echo "fix_script_found_in=$FOUND_IN" >> $GITHUB_OUTPUT
            fi
            
          else
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•ä¿®å¤è„šæœ¬"
            echo ""
            echo "ğŸ’¡ å»ºè®®æ“ä½œ:"
            echo "1. å°†ä¿®å¤è„šæœ¬æ”¾ç½®åœ¨ä»¥ä¸‹ä½ç½®ä¹‹ä¸€:"
            for path in "${POSSIBLE_PATHS[@]}"; do
              echo "   - $path"
            done
            echo ""
            echo "2. è„šæœ¬å‘½åå»ºè®®:"
            echo "   - fix-build.sh (æ¨è)"
            echo "   - fix-openwrt.sh"
            echo "   - repair-build.sh"
            echo ""
            echo "3. ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™ (chmod +x)"
            echo ""
            echo "è·³è¿‡ä¿®å¤æ­¥éª¤ï¼Œç»§ç»­ç¼–è¯‘æµç¨‹..."
            echo "fix_script_status=not_found" >> $GITHUB_OUTPUT
            echo "fix_script_location=none" >> $GITHUB_OUTPUT
            echo "fix_script_found_in=none" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤24å®Œæˆï¼šä¿®å¤è„šæœ¬æŸ¥æ‰¾ä¸æ‰§è¡Œå®Œæˆ"
          echo "========================================"
      
      # æ­¥éª¤25ï¼šæ ¹æ®ä¿®å¤ç»“æœå†³ç­–
      - name: "âš–ï¸ 25. ä¿®å¤ç»“æœè¯„ä¼°"
        run: |
          echo "========================================"
          echo "âš–ï¸ æ­¥éª¤25ï¼šä¿®å¤ç»“æœè¯„ä¼°"
          echo "========================================"
          echo ""
          
          echo "ğŸ“Š ä¿®å¤è„šæœ¬æ‰§è¡Œæƒ…å†µ:"
          echo "  çŠ¶æ€: ${{ steps.find_and_run_fix.outputs.fix_script_status }}"
          echo "  ä½ç½®: ${{ steps.find_and_run_fix.outputs.fix_script_location }}"
          echo "  å‘ç°æ–¹å¼: ${{ steps.find_and_run_fix.outputs.fix_script_found_in }}"
          echo ""
          
          case "${{ steps.find_and_run_fix.outputs.fix_script_status }}" in
            "success")
              echo "âœ… ä¿®å¤æˆåŠŸï¼Œç»§ç»­ç¼–è¯‘æµç¨‹"
              echo "   æ‰€æœ‰å·²çŸ¥é—®é¢˜åº”å·²è§£å†³"
              ;;
            "timeout")
              echo "âš ï¸ ä¿®å¤è„šæœ¬æ‰§è¡Œè¶…æ—¶"
              echo "   ä½†å¯èƒ½å·²ä¿®å¤éƒ¨åˆ†é—®é¢˜ï¼Œç»§ç»­ç¼–è¯‘æµç¨‹"
              echo "   å¦‚éœ€å®Œæ•´ä¿®å¤ï¼Œè¯·ä¼˜åŒ–ä¿®å¤è„šæœ¬æ€§èƒ½"
              ;;
            "error")
              echo "âš ï¸ ä¿®å¤è„šæœ¬æ‰§è¡Œæœ‰é”™è¯¯"
              echo "   ç»§ç»­ç¼–è¯‘æµç¨‹ï¼Œéƒ¨åˆ†é—®é¢˜å¯èƒ½æœªä¿®å¤"
              echo "   å»ºè®®æ£€æŸ¥ä¿®å¤è„šæœ¬æ—¥å¿—"
              ;;
            "not_found")
              echo "â„¹ï¸ æœªæ‰¾åˆ°ä¿®å¤è„šæœ¬"
              echo "   ä½¿ç”¨åŸå§‹é…ç½®ç»§ç»­ç¼–è¯‘"
              echo "   å¦‚éœ€ä¿®å¤åŠŸèƒ½ï¼Œè¯·åˆ›å»ºä¿®å¤è„šæœ¬"
              ;;
            *)
              echo "ğŸ” æœªçŸ¥çŠ¶æ€: ${{ steps.find_and_run_fix.outputs.fix_script_status }}"
              echo "   ç»§ç»­ç¼–è¯‘æµç¨‹"
              ;;
          esac
          
          echo ""
          echo "ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè®®:"
          if [ "${{ steps.find_and_run_fix.outputs.fix_script_status }}" = "not_found" ]; then
            echo "1. åˆ›å»ºä¿®å¤è„šæœ¬å¹¶æ”¾ç½®åœ¨ firmware-config/scripts/fix-build.sh"
            echo "2. ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™"
            echo "3. é‡æ–°è¿è¡Œå·¥ä½œæµ"
          else
            echo "1. ç¼–è¯‘å°†ä½¿ç”¨ä¿®å¤åçš„ç¯å¢ƒè¿›è¡Œ"
            echo "2. å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä¿®å¤è„šæœ¬è¾“å‡ºæ—¥å¿—"
            echo "3. å¯æ‰‹åŠ¨è¿è¡Œä¿®å¤è„šæœ¬è¿›ä¸€æ­¥è°ƒè¯•"
          fi
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤25å®Œæˆï¼šä¿®å¤è¯„ä¼°å®Œæˆ"
          echo "========================================"
      
      # æ­¥éª¤26ï¼šä¸‹è½½ä¾èµ–åŒ…
      - name: "ğŸ“¥ 26. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step24_download_dependencies
      
      # æ­¥éª¤27ï¼šé›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "ğŸ”Œ 27. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step25_integrate_custom_files
      
      # æ­¥éª¤28ï¼šå‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "ğŸš¨ 28. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step26_pre_build_error_check
      
      # æ­¥éª¤29ï¼šç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 29. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step27_final_space_check
      
      # æ­¥éª¤30ï¼šç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰
      - name: "ğŸ”¨ 30. ç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step28_build_firmware
      
      # æ­¥éª¤31ï¼šä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•
      - name: "ğŸ’¾ 31. ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•"
        if: success() && github.event.inputs.enable_cache == 'true'
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step29_save_toolchain
      
      # æ­¥éª¤32ï¼šæäº¤å·¥å…·é“¾åˆ°ä»“åº“
      - name: "ğŸ“¤ 32. æäº¤å·¥å…·é“¾åˆ°ä»“åº“"
        if: success() && github.event.inputs.enable_cache == 'true' && github.event.inputs.commit_toolchain == 'true'
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step30_commit_toolchain
      
      # æ­¥éª¤33ï¼šé”™è¯¯åˆ†æ
      - name: "âš ï¸ 33. é”™è¯¯åˆ†æ"
        if: failure()
        run: |
          echo "========================================"
          echo "âš ï¸ æ­¥éª¤33ï¼šé”™è¯¯åˆ†æ"
          echo "========================================"
          
          # æ£€æŸ¥ä¿®å¤è„šæœ¬çŠ¶æ€
          echo ""
          echo "ğŸ” ä¿®å¤è„šæœ¬æ‰§è¡Œå†å²:"
          echo "  çŠ¶æ€: ${{ steps.find_and_run_fix.outputs.fix_script_status }}"
          echo "  ä½ç½®: ${{ steps.find_and_run_fix.outputs.fix_script_location }}"
          
          # å°è¯•è¿›å…¥æ„å»ºç›®å½•
          cd ${{ env.BUILD_DIR }}/openwrt 2>/dev/null || cd ${{ github.workspace }}
          
          # åˆ†æç¼–è¯‘æ—¥å¿—
          if [ -f "build.log" ]; then
            echo ""
            echo "ğŸ“„ ç¼–è¯‘é”™è¯¯æ‘˜è¦:"
            echo "----------------------------------------"
            
            # æå–å…³é”®é”™è¯¯
            ERROR_COUNT=$(grep -c -i "error:\|ERROR\|failed\|Failed" build.log 2>/dev/null || echo "0")
            WARNING_COUNT=$(grep -c -i "warning:\|WARNING" build.log 2>/dev/null || echo "0")
            
            echo "é”™è¯¯æ•°é‡: $ERROR_COUNT"
            echo "è­¦å‘Šæ•°é‡: $WARNING_COUNT"
            echo ""
            
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "ğŸ”´ å…³é”®é”™è¯¯åˆ—è¡¨:"
              grep -i "error:" build.log 2>/dev/null | head -10 | while read error; do
                echo "  âŒ $error"
              done
              
              # å¸¸è§é”™è¯¯ç±»å‹æ£€æµ‹
              echo ""
              echo "ğŸ”§ å¸¸è§é—®é¢˜æ£€æµ‹:"
              
              if grep -q "libgnuintl.so" build.log 2>/dev/null; then
                echo "  âŒ æ£€æµ‹åˆ° libgnuintl.so ç¼ºå¤±"
                echo "     ä¿®å¤å»ºè®®: ç¡®ä¿ä¿®å¤è„šæœ¬å·²åˆ›å»ºè¯¥æ–‡ä»¶"
              fi
              
              if grep -q "No such file or directory" build.log 2>/dev/null; then
                echo "  âŒ æ£€æµ‹åˆ°æ–‡ä»¶ç¼ºå¤±é”™è¯¯"
                echo "     ç¼ºå¤±æ–‡ä»¶:"
                grep "No such file or directory" build.log 2>/dev/null | head -3 | sed 's/.*error: //'
              fi
              
              if grep -q "undefined reference" build.log 2>/dev/null; then
                echo "  âŒ æ£€æµ‹åˆ°é“¾æ¥é”™è¯¯"
                echo "     å¯èƒ½æ˜¯åº“æ–‡ä»¶ç¼ºå¤±æˆ–ç‰ˆæœ¬ä¸åŒ¹é…"
              fi
              
              if grep -q "out of memory\|Killed" build.log 2>/dev/null; then
                echo "  âŒ æ£€æµ‹åˆ°å†…å­˜ä¸è¶³"
                echo "     å»ºè®®: å¢åŠ ç¼–è¯‘èµ„æºæˆ–å‡å°‘å¹¶è¡Œä»»åŠ¡"
              fi
            fi
            
            # æ˜¾ç¤ºæœ€å50è¡Œæ—¥å¿—
            echo ""
            echo "ğŸ“‹ æœ€å50è¡Œç¼–è¯‘æ—¥å¿—:"
            echo "----------------------------------------"
            tail -50 build.log 2>/dev/null || echo "æ— æ³•è¯»å–build.log"
            echo "----------------------------------------"
          else
            echo "âŒ ç¼–è¯‘æ—¥å¿—ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "ğŸ’¡ è§£å†³å»ºè®®:"
          echo "1. æ£€æŸ¥ä¿®å¤è„šæœ¬æ˜¯å¦å·²æ­£ç¡®å¤„ç†æ‰€æœ‰å·²çŸ¥é—®é¢˜"
          echo "2. æŸ¥çœ‹å®Œæ•´çš„ build.log æ–‡ä»¶"
          echo "3. é‡æ–°è¿è¡Œå·¥ä½œæµ"
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤33å®Œæˆï¼šé”™è¯¯åˆ†æå®Œæˆ"
          echo "========================================"
      
      # æ­¥éª¤34ï¼šç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "ğŸ“Š 34. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step32_post_build_space_check
      
      # æ­¥éª¤35ï¼šå›ºä»¶æ–‡ä»¶æ£€æŸ¥
      - name: "ğŸ“¦ 35. å›ºä»¶æ–‡ä»¶æ£€æŸ¥"
        if: success()
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step33_check_firmware_files
      
      # æ­¥éª¤36ï¼šä¸Šä¼ å›ºä»¶
      - name: "â¬†ï¸ 36. ä¸Šä¼ å›ºä»¶"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: "firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
      
      # æ­¥éª¤37ï¼šä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      - name: "â¬†ï¸ 37. ä¸Šä¼ ç¼–è¯‘æ—¥å¿—"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          path: ${{ env.BUILD_DIR }}/build.log
          retention-days: 7
      
      # æ­¥éª¤38ï¼šä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "â¬†ï¸ 38. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      # æ­¥éª¤39ï¼šä¸Šä¼ ä¿®å¤è„šæœ¬æ—¥å¿—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: "â¬†ï¸ 39. ä¸Šä¼ ä¿®å¤è„šæœ¬æ—¥å¿—"
        if: always() && steps.find_and_run_fix.outputs.fix_script_status != 'not_found'
        run: |
          echo "æŸ¥æ‰¾ä¿®å¤è„šæœ¬æ—¥å¿—..."
          LOG_FILES=$(find /tmp -name "fix-script-output-*.log" 2>/dev/null | head -3)
          if [ -n "$LOG_FILES" ]; then
            echo "æ‰¾åˆ°ä¿®å¤æ—¥å¿—:"
            for log in $LOG_FILES; do
              echo "  ğŸ“„ $log ($(du -h "$log" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥'))"
            done
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾æ—¥å¿—
            mkdir -p /tmp/fix-logs
            cp $LOG_FILES /tmp/fix-logs/ 2>/dev/null || true
            
            echo "âœ… ä¿®å¤æ—¥å¿—å‡†å¤‡å®Œæ¯•"
          else
            echo "æœªæ‰¾åˆ°ä¿®å¤è„šæœ¬æ—¥å¿—"
          fi
        shell: bash
      
      - name: "â¬†ï¸ 39.1 ä¸Šä¼ ä¿®å¤æ—¥å¿—æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "fix-script-logs-${{ github.event.inputs.device_name }}"
          path: /tmp/fix-logs/
          retention-days: 7
      
      # æ­¥éª¤40ï¼šæ¸…ç†ç›®å½•
      - name: "ğŸ§¹ 40. æ¸…ç†ç›®å½•"
        if: always()
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step37_cleanup
      
      # æ­¥éª¤41ï¼šæœ€ç»ˆæ„å»ºæ€»ç»“
      - name: "ğŸ“ˆ 41. æœ€ç»ˆæ„å»ºæ€»ç»“"
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“ˆ æ­¥éª¤41ï¼šæœ€ç»ˆæ„å»ºæ€»ç»“"
          echo "========================================"
          echo ""
          
          echo "ğŸ¯ æ„å»ºé…ç½®:"
          echo "  è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "  ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}"
          echo "  é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "  å¯ç”¨ç¼“å­˜: ${{ github.event.inputs.enable_cache }}"
          echo ""
          
          echo "ğŸ”§ ä¿®å¤è„šæœ¬æ‰§è¡Œæƒ…å†µ:"
          echo "  çŠ¶æ€: ${{ steps.find_and_run_fix.outputs.fix_script_status }}"
          if [ "${{ steps.find_and_run_fix.outputs.fix_script_status }}" != "not_found" ]; then
            echo "  ä½ç½®: ${{ steps.find_and_run_fix.outputs.fix_script_location }}"
            echo "  å‘ç°æ–¹å¼: ${{ steps.find_and_run_fix.outputs.fix_script_found_in }}"
          fi
          echo ""
          
          echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
          echo "  1. å›ºä»¶æ–‡ä»¶: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          echo "  2. ç¼–è¯‘æ—¥å¿—: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          echo "  3. é…ç½®æ–‡ä»¶: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          if [ "${{ steps.find_and_run_fix.outputs.fix_script_status }}" != "not_found" ]; then
            echo "  4. ä¿®å¤æ—¥å¿—: fix-script-logs-${{ github.event.inputs.device_name }}"
          fi
          echo ""
          
          echo "ğŸ“Š æ„å»ºçŠ¶æ€: ${{ job.status }}"
          echo ""
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ æ„å»ºæˆåŠŸï¼æ‰€æœ‰äº§ç‰©å·²ä¸Šä¼ è‡³Artifacts"
            echo ""
            echo "ğŸ’¡ ä¸‹æ¬¡æ„å»ºå»ºè®®:"
            echo "  1. å·¥å…·é“¾å·²ç¼“å­˜ï¼Œä¸‹æ¬¡ç¼–è¯‘æ›´å¿«"
            echo "  2. ä¿®å¤è„šæœ¬å·²å°±ç»ªï¼Œè‡ªåŠ¨å¤„ç†é—®é¢˜"
            echo "  3. å¯è°ƒæ•´é…ç½®æ¨¡å¼å°è¯•ä¸åŒåŠŸèƒ½"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
            echo ""
            echo "ğŸ” æ’æŸ¥å»ºè®®:"
            echo "  1. æŸ¥çœ‹é”™è¯¯åˆ†ææ—¥å¿—ï¼ˆæ­¥éª¤33ï¼‰"
            echo "  2. æ£€æŸ¥ä¿®å¤è„šæœ¬è¾“å‡º"
            echo "  3. éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®"
            echo "  4. æ¸…ç†ç¯å¢ƒåé‡è¯•"
          fi
          
          echo ""
          echo "ğŸ æ„å»ºæµç¨‹å…¨éƒ¨å®Œæˆ"
          echo "========================================"
