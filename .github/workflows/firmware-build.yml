name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'è®¾å¤‡åç§° (å¦‚: ac42u, ac58u, mi4a ç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ç‰ˆæœ¬é€‰æ‹© (æ¨èä½¿ç”¨è‡ªåŠ¨æ£€æµ‹ï¼Œæˆ–æ‰‹åŠ¨é€‰æ‹©ç‰¹å®šç‰ˆæœ¬)'
        required: true
        type: choice
        default: 'auto'
        options:
        - auto
        - 23.05 (æœ€æ–°ç¨³å®šç‰ˆ)
        - 22.03 (ç¨³å®šç‰ˆ)
        - 21.02 (æ—§ç¨³å®šç‰ˆ)
        - 19.07 (è€æ—§ç‰ˆæœ¬)
        - 18.06 (å¾ˆè€ç‰ˆæœ¬)
        - master (å¼€å‘ç‰ˆ)
      custom_version:
        description: 'è‡ªå®šä¹‰ (å¦‚: immortalwrt:openwrt-23.05)'
        required: false
        type: string
        default: ''
      config_type:
        description: 'é…ç½®ç±»å‹'
        required: true
        default: 'normal'
        type: choice
        options:
        - minimal
        - normal
        - custom
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…å)'
        required: false
        type: string
      disabled_plugins:
        description: 'ç¦ç”¨æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…å)'
        required: false
        type: string
        default: ''
      save_config:
        description: 'ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“'
        required: false
        default: true
        type: boolean
      enable_cache:
        description: 'å¯ç”¨ç¼–è¯‘ç¼“å­˜'
        required: false
        default: true
        type: boolean
      multithreading:
        description: 'å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘'
        type: boolean
        default: true
      ssh_connection:
        description: 'ä½¿ç”¨ SSH è¿æ¥åˆ°ç¼–è¯‘ç¯å¢ƒè¿›è¡Œè°ƒè¯•'
        type: boolean
        default: false

env:
  BUILD_DIR: /mnt/openwrt-build
  MIRROR_SOURCE: tuna
  CUSTOM_INSTALL: true

jobs:
  build-firmware:
    if: ${{ inputs.ssh_connection == false }}
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo
        pip3 install requests urllib3
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæ„å»ºç›®å½•å¹¶è®¾ç½®æƒé™
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        sudo chmod u+w $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"
        touch $BUILD_DIR/test_write.txt && echo "âœ… å†™å…¥æµ‹è¯•æˆåŠŸ" && rm $BUILD_DIR/test_write.txt

    - name: å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½•
      run: |
        echo "=== å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½• ==="
        cd $GITHUB_WORKSPACE
        # ç›´æ¥å¤åˆ¶ scripts ç›®å½•ä¸‹çš„æ‰€æœ‰è„šæœ¬
        if [ -d "firmware-config/scripts" ]; then
            cp firmware-config/scripts/*.sh $BUILD_DIR/ 2>/dev/null || true
            echo "âœ… å¤åˆ¶ firmware-config/scripts ç›®å½•ä¸‹çš„æ‰€æœ‰è„šæœ¬"
        else
            echo "âš ï¸ firmware-config/scripts ç›®å½•ä¸å­˜åœ¨ï¼Œå°è¯•æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶"
            SCRIPTS=$(find . -name "*.sh" -type f | grep -E "(detector|detection|analysis|download|diagnose|check|turboacc)" | head -10)
            for script in $SCRIPTS; do
                cp "$script" $BUILD_DIR/
                echo "âœ… å¤åˆ¶è„šæœ¬: $(basename "$script")"
            done
        fi
        cd $BUILD_DIR
        echo "æ„å»ºç›®å½•ä¸­çš„è„šæœ¬:"
        ls -la *.sh 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°.shæ–‡ä»¶"
        chmod +x *.sh 2>/dev/null || true
        echo "âœ… è„šæœ¬å¤åˆ¶å®Œæˆ"

    - name: æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ï¼ˆä¼˜åŒ–ç‰ˆï¼‰==="
        sudo chown -R $USER:$USER . 2>/dev/null || true
        chmod u+w . 2>/dev/null || true
        chmod +x *.sh 2>/dev/null || true
        echo "è®¾å¤‡åç§°: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬é€‰æ‹©: ${{ inputs.version_selection }}"
        echo "è‡ªå®šä¹‰ç‰ˆæœ¬: ${{ inputs.custom_version }}"
        
        if [ ! -f "complete_version_detector.sh" ]; then
          echo "âŒ é”™è¯¯: complete_version_detector.sh ä¸å­˜åœ¨"
          ls -la
          exit 1
        fi
        
        # è®¾ç½®è€æ—§è®¾å¤‡æ ‡å¿—
        OLD_DEVICE_FLAG="false"
        case "${{ github.event.inputs.device_name }}" in
            "wr841n"|"wr842n"|"wr941n"|"mr3420"|"ar71xx"*)
                OLD_DEVICE_FLAG="true"
                echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§è®¾å¤‡: ${{ github.event.inputs.device_name }}"
                ;;
        esac
        
        # æ ¹æ®ç”¨æˆ·é€‰æ‹©ç¡®å®šç‰ˆæœ¬è§„æ ¼
        USER_VERSION=""
        case "${{ inputs.version_selection }}" in
            "auto")
                echo "ğŸ¯ ä½¿ç”¨è‡ªåŠ¨ç‰ˆæœ¬æ£€æµ‹"
                USER_VERSION=""
                ;;
            "23.05 (æœ€æ–°ç¨³å®šç‰ˆ)")
                echo "ğŸ¯ é€‰æ‹©æœ€æ–°ç¨³å®šç‰ˆ 23.05"
                USER_VERSION="23.05"
                ;;
            "22.03 (ç¨³å®šç‰ˆ)")
                echo "ğŸ¯ é€‰æ‹©ç¨³å®šç‰ˆ 22.03"
                USER_VERSION="22.03"
                ;;
            "21.02 (æ—§ç¨³å®šç‰ˆ)")
                echo "ğŸ¯ é€‰æ‹©æ—§ç¨³å®šç‰ˆ 21.02"
                USER_VERSION="21.02"
                ;;
            "19.07 (è€æ—§ç‰ˆæœ¬)")
                echo "ğŸ¯ é€‰æ‹©è€æ—§ç‰ˆæœ¬ 19.07"
                USER_VERSION="19.07"
                ;;
            "18.06 (å¾ˆè€ç‰ˆæœ¬)")
                echo "ğŸ¯ é€‰æ‹©å¾ˆè€ç‰ˆæœ¬ 18.06"
                USER_VERSION="18.06"
                ;;
            "master (å¼€å‘ç‰ˆ)")
                echo "ğŸ¯ é€‰æ‹©å¼€å‘ç‰ˆ master"
                USER_VERSION="master"
                ;;
        esac
        
        # å¦‚æœç”¨æˆ·å¡«å†™äº†è‡ªå®šä¹‰ç‰ˆæœ¬ï¼Œä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬
        if [ -n "${{ inputs.custom_version }}" ]; then
            echo "ğŸ¯ ä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬: ${{ inputs.custom_version }}"
            USER_VERSION="${{ inputs.custom_version }}"
        fi
        
        echo "=== æœ€ç»ˆä½¿ç”¨çš„ç‰ˆæœ¬å‚æ•°: $USER_VERSION ==="
        
        echo "=== ä½¿ç”¨ä¿®å¤ç‰ˆç‰ˆæœ¬æ£€æµ‹ ==="
        set +e
        OUTPUT=$(./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "$USER_VERSION" "$OLD_DEVICE_FLAG" 2>&1)
        SCRIPT_EXIT_CODE=$?
        set -e
        echo "è„šæœ¬è¾“å‡º:"
        echo "$OUTPUT"
        echo "è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE"
        SELECTED_REPO=$(echo "$OUTPUT" | grep "^SELECTED_REPO=" | head -1 | cut -d'=' -f2)
        SELECTED_BRANCH=$(echo "$OUTPUT" | grep "^SELECTED_BRANCH=" | head -1 | cut -d'=' -f2)
        SELECTED_REPO_URL=$(echo "$OUTPUT" | grep "^SELECTED_REPO_URL=" | head -1 | cut -d'=' -f2)
        if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
            echo "âœ… ä»è„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–ç‰ˆæœ¬ä¿¡æ¯"
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            echo "âœ… ç¯å¢ƒå˜é‡å·²è®¾ç½®:"
            echo "  ä»“åº“: $SELECTED_REPO"
            echo "  åˆ†æ”¯: $SELECTED_BRANCH"
            echo "  URL: $SELECTED_REPO_URL"
        else
            echo "âŒ æ— æ³•ä»è„šæœ¬è¾“å‡ºä¸­æå–ç‰ˆæœ¬ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ ç‰ˆæœ¬æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼"
                echo "SELECTED_REPO=immortalwrt" >> $GITHUB_ENV
                echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
                echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
                echo "âœ… ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ä¿¡æ¯"
            fi
        fi

    - name: æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥
      run: |
        cd $BUILD_DIR
        echo "=== æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥ ==="
        echo "æ£€æµ‹åˆ°çš„ç‰ˆæœ¬åˆ†æ”¯: $SELECTED_BRANCH"
        
        # åˆ›å»ºæ’ä»¶å…¼å®¹æ€§æ£€æŸ¥è„šæœ¬
        cat > check_plugin_compatibility.sh << 'EOF'
#!/bin/bash

# æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥è„šæœ¬

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# æ’ä»¶å…¼å®¹æ€§æ•°æ®åº“
declare -A PLUGIN_COMPATIBILITY=(
    # TurboAcc ç½‘ç»œåŠ é€Ÿ
    ["turboacc"]="22.03 23.05"
    ["luci-app-turboacc"]="22.03 23.05"
    ["kmod-nft-fullcone"]="22.03 23.05"
    ["kmod-shortcut-fe"]="22.03 23.05"
    
    # å…¶ä»–æ’ä»¶çš„å…¼å®¹æ€§ä¿¡æ¯å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
    # ["æ’ä»¶å"]="æ”¯æŒçš„ç‰ˆæœ¬"
)

check_plugin_compatibility() {
    local branch="$1"
    local plugin="$2"
    
    # æå–ç‰ˆæœ¬å·
    local version=$(echo "$branch" | grep -oE '[0-9]+\.[0-9]+' | head -1)
    
    if [ -z "$version" ]; then
        # å¦‚æœæ˜¯master/mainåˆ†æ”¯ï¼Œè®¤ä¸ºæ˜¯æœ€æ–°ç‰ˆæœ¬
        if [[ "$branch" =~ master|main ]]; then
            log_warning "âš ï¸  $plugin: å¼€å‘ç‰ˆåˆ†æ”¯ï¼Œå…¼å®¹æ€§æœªçŸ¥"
            return 1
        else
            log_warning "âš ï¸  $plugin: æ— æ³•è¯†åˆ«ç‰ˆæœ¬å·"
            return 1
        fi
    fi
    
    local compatible_versions="${PLUGIN_COMPATIBILITY[$plugin]}"
    
    if [ -z "$compatible_versions" ]; then
        log_info "â„¹ï¸  $plugin: å…¼å®¹æ€§ä¿¡æ¯æœªçŸ¥"
        return 0
    fi
    
    if echo "$compatible_versions" | grep -q "$version"; then
        log_success "âœ… $plugin: å…¼å®¹ç‰ˆæœ¬ $version"
        return 0
    else
        log_error "âŒ $plugin: ä¸å…¼å®¹ç‰ˆæœ¬ $version (ä»…æ”¯æŒ: $compatible_versions)"
        return 1
    fi
}

echo "=== æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥æŠ¥å‘Š ==="
echo "ç›®æ ‡ç‰ˆæœ¬: $SELECTED_BRANCH"

# æ£€æŸ¥ TurboAcc ç›¸å…³æ’ä»¶çš„å…¼å®¹æ€§
echo ""
echo "=== ç½‘ç»œåŠ é€Ÿæ’ä»¶å…¼å®¹æ€§ ==="
check_plugin_compatibility "$SELECTED_BRANCH" "turboacc"
check_plugin_compatibility "$SELECTED_BRANCH" "luci-app-turboacc"
check_plugin_compatibility "$SELECTED_BRANCH" "kmod-nft-fullcone"
check_plugin_compatibility "$SELECTED_BRANCH" "kmod-shortcut-fe"

echo ""
echo "=== å…¼å®¹æ€§è¯´æ˜ ==="
echo "ğŸ”¹ 22.03/23.05 - å®Œå…¨æ”¯æŒ TurboAcc åŠ é€Ÿ"
echo "ğŸ”¹ 21.02       - åŸºç¡€ç½‘ç»œä¼˜åŒ–æ”¯æŒ"
echo "ğŸ”¹ 19.07åŠä»¥ä¸‹ - ä»…åŸºç¡€ç½‘ç»œåŠŸèƒ½"
echo "ğŸ”¹ master      - å¼€å‘ç‰ˆï¼Œå…¼å®¹æ€§ä¸ç¡®å®š"

EOF

        chmod +x check_plugin_compatibility.sh
        ./check_plugin_compatibility.sh

    - name: å¤‡ä»½æ£€æµ‹è„šæœ¬
      run: |
        echo "=== å¤‡ä»½æ£€æµ‹è„šæœ¬ ==="
        mkdir -p /tmp/build-scripts-backup
        cp $BUILD_DIR/*.sh /tmp/build-scripts-backup/ 2>/dev/null || true
        echo "âœ… è„šæœ¬å¤‡ä»½å®Œæˆ"

    - name: æ¸…ç†æ„å»ºç›®å½•
      run: |
        cd $BUILD_DIR
        echo "=== æ¸…ç†æ„å»ºç›®å½•å‡†å¤‡å…‹éš† ==="
        ls -la
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        sudo rm -rf .[!.]* 2>/dev/null || true
        ls -la
        echo "âœ… ç›®å½•æ¸…ç†å®Œæˆ"

    - name: å…‹éš†æºç 
      run: |
        cd $BUILD_DIR
        echo "=== å…‹éš†é€‰å®šç‰ˆæœ¬çš„æºç  ==="
        echo "ä»“åº“: $SELECTED_REPO_URL"
        echo "åˆ†æ”¯: $SELECTED_BRANCH"
        if [ -z "$SELECTED_REPO_URL" ] || [ -z "$SELECTED_BRANCH" ]; then
          echo "âŒ é”™è¯¯: ç¯å¢ƒå˜é‡æœªæ­£ç¡®è®¾ç½®"
          exit 1
        fi
        echo "æ£€æŸ¥ç›®å½•çŠ¶æ€..."
        FILE_COUNT=$(ls -A | wc -l)
        if [ $FILE_COUNT -ne 0 ]; then
          echo "âŒ é”™è¯¯: ç›®å½•éç©ºï¼Œæ— æ³•å…‹éš†"
          exit 1
        fi
        MAX_RETRIES=3
        RETRY_COUNT=0
        CLONE_SUCCESS=false
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$CLONE_SUCCESS" = false ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "å…‹éš†å°è¯•: $RETRY_COUNT/$MAX_RETRIES"
          if git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .; then
            echo "âœ… æºç å…‹éš†å®Œæˆ"
            CLONE_SUCCESS=true
          else
            echo "âŒ å…‹éš†å¤±è´¥ï¼Œå°è¯• $RETRY_COUNT/$MAX_RETRIES"
            if echo "$SELECTED_REPO_URL" | grep -q "github.com" && [ $RETRY_COUNT -eq 2 ]; then
              echo "ğŸ”„ å°è¯•ä½¿ç”¨é•œåƒæº..."
              MIRROR_URL=$(echo "$SELECTED_REPO_URL" | sed 's/github.com/github.com.cnpmjs.org/')
              rm -rf ./* ./.git* 2>/dev/null || true
              if git clone --depth 1 --branch "$SELECTED_BRANCH" "$MIRROR_URL" .; then
                echo "âœ… ä½¿ç”¨é•œåƒæºå…‹éš†æˆåŠŸ"
                CLONE_SUCCESS=true
                break
              fi
            fi
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ æºç å…‹éš†å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            fi
            sleep 10
            rm -rf ./* ./.git* 2>/dev/null || true
          fi
        done

    - name: æ¢å¤æ£€æµ‹è„šæœ¬
      run: |
        cd $BUILD_DIR
        echo "=== æ¢å¤æ£€æµ‹è„šæœ¬ ==="
        cp /tmp/build-scripts-backup/*.sh ./ 2>/dev/null || true
        chmod +x *.sh
        echo "âœ… è„šæœ¬æ¢å¤å®Œæˆ"

    - name: é…ç½®ç¨³å®šfeedsæº
      run: |
        cd $BUILD_DIR
        echo "=== é…ç½®ç¨³å®šfeedsæº ==="
        echo "æ£€æµ‹åˆ°çš„ç‰ˆæœ¬åˆ†æ”¯: $SELECTED_BRANCH"
        FEEDS_BRANCH="$SELECTED_BRANCH"
        if echo "$SELECTED_BRANCH" | grep -q "openwrt-23.05"; then
            FEEDS_BRANCH="openwrt-23.05"
        elif echo "$SELECTED_BRANCH" | grep -q "openwrt-22.03"; then
            FEEDS_BRANCH="openwrt-22.03"
        elif echo "$SELECTED_BRANCH" | grep -q "openwrt-21.02"; then
            FEEDS_BRANCH="openwrt-21.02"
        elif echo "$SELECTED_BRANCH" | grep -q "openwrt-19.07"; then
            FEEDS_BRANCH="openwrt-19.07"
        else
            echo "âš ï¸ æœªçŸ¥ç‰ˆæœ¬åˆ†æ”¯ï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯: master"
            FEEDS_BRANCH="master"
        fi
        echo "ä½¿ç”¨çš„feedsåˆ†æ”¯: $FEEDS_BRANCH"
        echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
        echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git routing https://github.com/openwrt/routing.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git telephony https://github.com/openwrt/telephony.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git nikki https://github.com/nikkinikki-org/OpenWrt-nikki.git;main" >> feeds.conf.default
        echo "âœ… ç¨³å®šfeedsé…ç½®å®Œæˆ"
        echo "Feedsé…ç½®å†…å®¹:"
        cat feeds.conf.default

    - name: æ›´æ–°å®‰è£…feeds
      run: |
        cd $BUILD_DIR
        echo "=== æ›´æ–°å’Œå®‰è£…feeds ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… Feedsæ›´æ–°å®‰è£…å®Œæˆ"

    - name: è®¾å¤‡æ£€æµ‹
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½è®¾å¤‡æ£€æµ‹ä¸åˆ«åè½¬æ¢ ==="
        INPUT_DEVICE="${{ github.event.inputs.device_name }}"
        echo "è¾“å…¥è®¾å¤‡åç§°: $INPUT_DEVICE"
        case "$INPUT_DEVICE" in
            "ac42u"|"acrh17"|"rt-acrh17") ACTUAL_DEVICE="asus_rt-ac42u" ;;
            "ac58u"|"acrh13"|"rt-ac58u"|"rt-acrh13") ACTUAL_DEVICE="asus_rt-ac58u" ;;
            "mi4a"|"r4a") ACTUAL_DEVICE="xiaomi_mi-router-4a-gigabit" ;;
            "mi3g"|"r3g") ACTUAL_DEVICE="xiaomi_mi-router-3g" ;;
            *) ACTUAL_DEVICE="$INPUT_DEVICE" ;;
        esac
        if [ "$ACTUAL_DEVICE" != "$INPUT_DEVICE" ]; then
          echo "âœ… æ£€æµ‹åˆ°è®¾å¤‡é€šç”¨åç§° '$INPUT_DEVICE'ï¼Œè½¬æ¢ä¸ºå®é™…è®¾å¤‡æ ‡è¯† '$ACTUAL_DEVICE'"
        else
          echo "â„¹ï¸ ä½¿ç”¨åŸå§‹è®¾å¤‡åç§°: $ACTUAL_DEVICE"
        fi
        if [ ! -f "device_detection.sh" ]; then
          echo "âŒ é”™è¯¯: è®¾å¤‡æ£€æµ‹è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        chmod +x device_detection.sh
        echo "=== å¼€å§‹è®¾å¤‡æ£€æµ‹ ==="
        TEMP_LOG=$(mktemp)
        set +e
        ./device_detection.sh "$ACTUAL_DEVICE" 2>&1 | tee "$TEMP_LOG"
        SCRIPT_EXIT_CODE=$?
        set -e
        echo "=== è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE ==="
        PLATFORM=$(grep "^PLATFORM=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        DEVICE_SHORT_NAME=$(grep "^DEVICE_SHORT_NAME=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        DEVICE_FULL_NAME=$(grep "^DEVICE_FULL_NAME=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        echo "=== æå–çš„è®¾å¤‡ä¿¡æ¯ ==="
        echo "å¹³å°(PLATFORM): '$PLATFORM'"
        echo "è®¾å¤‡çŸ­åç§°(DEVICE_SHORT_NAME): '$DEVICE_SHORT_NAME'"
        echo "è®¾å¤‡å…¨åç§°(DEVICE_FULL_NAME): '$DEVICE_FULL_NAME'"
        rm -f "$TEMP_LOG"
        if [ -n "$PLATFORM" ] && [ -n "$DEVICE_SHORT_NAME" ] && [ -n "$DEVICE_FULL_NAME" ]; then
            echo "âœ… ä»è„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–è®¾å¤‡ä¿¡æ¯"
            echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
            echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
        else
            echo "âŒ æ— æ³•ä»è„šæœ¬è¾“å‡ºä¸­æå–è®¾å¤‡ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ è®¾å¤‡æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–è®¾å¤‡ä¿¡æ¯ï¼Œä½¿ç”¨å¤‡ç”¨è®¾å¤‡æ˜ å°„"
                case "$ACTUAL_DEVICE" in
                    "asus_rt-ac42u"|"ac42u"|"acrh17"|"rt-acrh17")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac42u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "asus_rt-ac58u"|"ac58u"|"acrh13"|"rt-acrh13")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac58u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "xiaomi_mi-router-4a-gigabit"|"mi4a"|"r4a")
                        echo "PLATFORM=ramips" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=xiaomi_mi-router-4a-gigabit" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    *)
                        echo "âŒ æœªçŸ¥è®¾å¤‡ï¼Œæ— æ³•è®¾ç½®é»˜è®¤å€¼"
                        exit 1
                        ;;
                esac
                echo "âœ… å·²ä½¿ç”¨å¤‡ç”¨è®¾å¤‡ä¿¡æ¯"
            fi
        fi

    - name: åŠ å¼ºæœç´¢å¹¶å¤åˆ¶é…ç½®æ–‡ä»¶
      run: |
        cd $BUILD_DIR
        echo "=== åŠ å¼ºæœç´¢å¹¶å¤åˆ¶é…ç½®æ–‡ä»¶ ==="
        cd $GITHUB_WORKSPACE
        echo "=== åŠ å¼ºæœç´¢é…ç½®æ–‡ä»¶ ==="
        mkdir -p $BUILD_DIR/config-templates
        SEARCH_PATHS=". firmware-config configs firmware-config/configs firmware-config/config-templates"
        CONFIG_FILES="minimal.config normal-new.config normal-old.config"
        for config_file in $CONFIG_FILES; do
          echo "æ­£åœ¨åŠ å¼ºæœç´¢é…ç½®æ–‡ä»¶: $config_file"
          FOUND_CONFIG=""
          for path in $SEARCH_PATHS; do
            if [ -f "$path/$config_file" ]; then
              FOUND_CONFIG="$path/$config_file"
              echo "âœ… åœ¨ $path æ‰¾åˆ°: $config_file"
              break
            fi
          done
          if [ -z "$FOUND_CONFIG" ]; then
            FOUND_CONFIG=$(find . -name "$config_file" -type f | head -1)
            if [ -n "$FOUND_CONFIG" ]; then
              echo "âœ… ä½¿ç”¨findæ‰¾åˆ°: $config_file (åœ¨ $FOUND_CONFIG)"
            fi
          fi
          if [ -n "$FOUND_CONFIG" ]; then
            cp "$FOUND_CONFIG" $BUILD_DIR/config-templates/
            echo "âœ… å¤åˆ¶: $config_file (ä» $FOUND_CONFIG)"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $config_file"
            echo "å½“å‰ç›®å½•ç»“æ„:"
            find . -type f -name "*.config" | head -20
            exit 1
          fi
        done
        echo "=== é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆï¼Œæ£€æŸ¥ç»“æœ ==="
        echo "config-templates ç›®å½•å†…å®¹:"
        ls -la $BUILD_DIR/config-templates/

    - name: ä¿®å¤é…ç½®åŠ è½½é—®é¢˜ - é¢„æ·»åŠ æ‰€æœ‰å¿…è¦é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤é…ç½®åŠ è½½é—®é¢˜ - é¢„æ·»åŠ æ‰€æœ‰å¿…è¦é…ç½® ==="
        export MAKE_JOBS=1
        echo "ğŸ”’ é…ç½®é˜¶æ®µä½¿ç”¨å•çº¿ç¨‹æ¨¡å¼"
        CONFIG_TYPE="${{ inputs.config_type }}"
        echo "é…ç½®ç±»å‹: $CONFIG_TYPE"
        
        if [ "$CONFIG_TYPE" = "minimal" ]; then
            CONFIG_FILE="config-templates/minimal.config"
        elif [ "$CONFIG_TYPE" = "normal" ] || [ "$CONFIG_TYPE" = "custom" ]; then
            IS_OLD_VERSION=0
            case "${{ github.event.inputs.device_name }}" in
                "wr841n"|"wr842n"|"wr941n"|"mr3420"|"ar71xx"*)
                    IS_OLD_VERSION=1
                    echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§è®¾å¤‡: ${{ github.event.inputs.device_name }}"
                    ;;
            esac
            
            if echo "$SELECTED_BRANCH" | grep -q -E "19\.07|21\.02|17\.01|lede"; then
                IS_OLD_VERSION=1
                echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§ç‰ˆæœ¬: $SELECTED_BRANCH"
            fi
            
            if [ "$SELECTED_REPO" = "lede" ] || [ "$SELECTED_REPO" = "openwrt-19.07" ] || [ "$SELECTED_REPO" = "openwrt-21.02" ]; then
                IS_OLD_VERSION=1
                echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§ä»“åº“: $SELECTED_REPO"
            fi
            
            if [ "$IS_OLD_VERSION" -eq 1 ]; then
                CONFIG_FILE="config-templates/normal-old.config"
            else
                CONFIG_FILE="config-templates/normal-new.config"
            fi
        else
            echo "âŒ æœªçŸ¥çš„é…ç½®ç±»å‹: $CONFIG_TYPE"
            exit 1
        fi
        
        echo "=== é€‰æ‹©çš„é…ç½®æ–‡ä»¶: $CONFIG_FILE ==="
        if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILE"
            ls -la config-templates/
            exit 1
        fi
        
        # ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºåŸºç¡€é…ç½®
        echo "=== åˆ›å»ºåŸºç¡€é…ç½® ==="
        echo "# è®¾å¤‡åŸºç¡€é…ç½®" > .config
        echo "CONFIG_TARGET_${PLATFORM}=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
        
        # ç¬¬äºŒæ­¥ï¼šæ™ºèƒ½è¿½åŠ æ¨¡æ¿é…ç½®
        echo "=== æ™ºèƒ½è¿½åŠ æ¨¡æ¿é…ç½® ==="
        grep -v -E "^CONFIG_TARGET_(ROOTFS_SQUASHFS|IMAGES_GZIP|IMAGES_PAD)=" "$CONFIG_FILE" > /tmp/filtered_config
        cat /tmp/filtered_config >> .config
        rm -f /tmp/filtered_config
        
        # ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆï¼ˆç®€åŒ–ç‰ˆï¼‰
        echo "=== é…ç½®ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ ==="
        
        # æ ¹æ®ç‰ˆæœ¬é€‰æ‹©ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ
        if echo "$SELECTED_BRANCH" | grep -q -E "23\.05|22\.03"; then
            echo "âœ… ç‰ˆæœ¬ $SELECTED_BRANCH æ”¯æŒå®Œæ•´ç½‘ç»œåŠ é€Ÿ"
            echo "CONFIG_PACKAGE_kmod-nft-fullcone=y" >> .config
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        elif echo "$SELECTED_BRANCH" | grep -q -E "21\.02|master"; then
            echo "âš ï¸ ç‰ˆæœ¬ $SELECTED_BRANCH æ”¯æŒåŸºç¡€ç½‘ç»œä¼˜åŒ–"
            echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        else
            echo "â„¹ï¸ ç‰ˆæœ¬ $SELECTED_BRANCH ä½¿ç”¨æœ€å°ç½‘ç»œé…ç½®"
        fi
        
        # ç¬¬å››æ­¥ï¼šå¤„ç†ç”¨æˆ·è‡ªå®šä¹‰åŒ…
        EXTRA_PACKAGES="${{ inputs.extra_packages }}"
        DISABLED_PLUGINS="${{ inputs.disabled_plugins }}"
        
        if [ -n "$EXTRA_PACKAGES" ]; then
            echo "=== æ·»åŠ é¢å¤–æ’ä»¶ ==="
            for pkg in $EXTRA_PACKAGES; do
                echo "æ·»åŠ æ’ä»¶: $pkg"
                sed -i "/# CONFIG_PACKAGE_${pkg} is not set/d" .config
                echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            done
        fi
        
        if [ -n "$DISABLED_PLUGINS" ]; then
            echo "=== ç¦ç”¨æŒ‡å®šæ’ä»¶ ==="
            for pkg in $DISABLED_PLUGINS; do
                echo "ç¦ç”¨æ’ä»¶: $pkg"
                sed -i "/CONFIG_PACKAGE_${pkg}=y/d" .config
                echo "# CONFIG_PACKAGE_${pkg} is not set" >> .config
            done
        fi
        
        # ç¬¬äº”æ­¥ï¼šæ¸…ç†é‡å¤çš„é…ç½®é¡¹
        echo "=== æ¸…ç†é‡å¤é…ç½®é¡¹ ==="
        sort .config | uniq > .config.tmp
        mv .config.tmp .config
        
        echo "=== å½“å‰å¯ç”¨çš„luciæ’ä»¶ ==="
        grep "^CONFIG_PACKAGE_luci-app" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//' | sort | uniq || echo "æ— luciæ’ä»¶"
        
        # è¿è¡Œ defconfig æ¥éªŒè¯å’Œè°ƒæ•´é…ç½®
        echo "=== è¿è¡Œå•çº¿ç¨‹ defconfig ==="
        make -j1 defconfig
        
        echo "âœ… åŸºç¡€é…ç½®åŠ è½½å®Œæˆ"

    - name: é‡æ–°è¿è¡Œ defconfig ä»¥æ•´åˆé…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== é‡æ–°è¿è¡Œ defconfig ä»¥æ•´åˆé…ç½® ==="
        export MAKE_JOBS=1
        set +e
        make -j1 defconfig
        DEFCONFIG_EXIT_CODE=$?
        set -e
        
        if [ $DEFCONFIG_EXIT_CODE -ne 0 ]; then
            echo "âŒ defconfig æ‰§è¡Œå¤±è´¥ï¼Œæ£€æŸ¥å¹¶ä¿®å¤é…ç½®é—®é¢˜"
            # æ£€æŸ¥æ˜¯å¦æ˜¯é€’å½’ä¾èµ–é—®é¢˜
            if make -j1 defconfig 2>&1 | grep -q "recursive dependency"; then
                echo "ğŸ”„ æ£€æµ‹åˆ°é€’å½’ä¾èµ–ï¼Œæ¸…é™¤æœ‰é—®é¢˜çš„é…ç½®"
                # æ¸…é™¤æ‰€æœ‰å¯èƒ½å¼•èµ·é€’å½’ä¾èµ–çš„é…ç½®
                PROBLEMATIC_CONFIGS="CONFIG_PACKAGE_luci-app-turboacc CONFIG_PACKAGE_kmod-nft-fullcone CONFIG_PACKAGE_kmod-shortcut-fe"
                for config in $PROBLEMATIC_CONFIGS; do
                    sed -i "/${config}=y/d" .config
                    sed -i "/# ${config} is not set/d" .config
                done
                # é‡æ–°è¿è¡Œ defconfig
                make -j1 defconfig
            else
                echo "âŒ æœªçŸ¥çš„ defconfig é”™è¯¯ï¼Œä½†ç»§ç»­æ„å»ºæµç¨‹"
            fi
        fi
        echo "âœ… é…ç½®æ•´åˆå®Œæˆ"

    - name: é…ç½®å®Œæ•´æ€§æ£€æŸ¥
      run: |
        cd $BUILD_DIR
        echo "=== é…ç½®å®Œæ•´æ€§æ£€æŸ¥ï¼ˆå•çº¿ç¨‹æ¨¡å¼ï¼‰==="
        export MAKE_JOBS=1
        if [ ! -f ".config" ] || [ ! -s ".config" ]; then
            echo "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            exit 1
        fi
        echo "âœ… .config æ–‡ä»¶å­˜åœ¨ä¸”éç©º"
        echo "æ–‡ä»¶å¤§å°: $(wc -l < .config) è¡Œ"
        echo "=== å…³é”®é…ç½®éªŒè¯ ==="
        if ! grep -q "^CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" .config; then
            echo "âŒ é”™è¯¯: è®¾å¤‡é…ç½®ç¼ºå¤±"
            exit 1
        fi
        for pkg in luci luci-base luci-theme-bootstrap; do
            if ! grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
                echo "âŒ é”™è¯¯: æ ¸å¿ƒç»„ä»¶ $pkg æœªå¯ç”¨"
                exit 1
            fi
        done
        echo "=== ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆæ£€æŸ¥ ==="
        if grep -q "CONFIG_PACKAGE_kmod-nft-fullcone=y" .config; then
            echo "âœ… å®Œæ•´ç½‘ç»œåŠ é€Ÿ: å·²å¯ç”¨"
        elif grep -q "CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
            echo "âœ… åŸºç¡€ç½‘ç»œä¼˜åŒ– (BBR): å·²å¯ç”¨"
        else
            echo "âš ï¸ æœªå¯ç”¨ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ"
        fi
        echo "âœ… é…ç½®å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ"

    - name: åŒ…å¯ç”¨æ€§è¯Šæ–­
      run: |
        cd $BUILD_DIR
        echo "=== åŒ…å¯ç”¨æ€§è¯Šæ–­ ==="
        if [ -f "diagnose-packages.sh" ]; then
            chmod +x diagnose-packages.sh
            echo "å¼€å§‹è¯Šæ–­åŒ…å¯ç”¨æ€§..."
            ./diagnose-packages.sh "$BUILD_DIR"
            echo "âœ… åŒ…è¯Šæ–­å®Œæˆ"
        else
            echo "âš ï¸ æœªæ‰¾åˆ°åŒ…è¯Šæ–­è„šæœ¬ï¼Œè·³è¿‡è¯Šæ–­"
        fi

    - name: æ„å»ºæ—¶é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      run: |
        cd $BUILD_DIR
        echo "=== æ„å»ºæ—¶é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
        mkdir -p files/root/custom-install
        cd $GITHUB_WORKSPACE
        IPK_FILES=$(find firmware-config/custom-files -name "*.ipk" -type f 2>/dev/null || true)
        if [ -n "$IPK_FILES" ]; then
            echo "âœ… æ‰¾åˆ°IPKæ–‡ä»¶:"
            for ipk in $IPK_FILES; do
                cp "$ipk" $BUILD_DIR/files/root/custom-install/
                echo "âœ… å¤åˆ¶IPK: $(basename "$ipk")"
            done
        fi
        SCRIPT_FILES=$(find firmware-config/custom-files -name "*.sh" -type f 2>/dev/null | grep -v "detector\|analysis" || true)
        if [ -n "$SCRIPT_FILES" ]; then
            echo "âœ… æ‰¾åˆ°è„šæœ¬æ–‡ä»¶:"
            for script in $SCRIPT_FILES; do
                cp "$script" $BUILD_DIR/files/root/custom-install/
                chmod +x $BUILD_DIR/files/root/custom-install/$(basename "$script")
                echo "âœ… å¤åˆ¶è„šæœ¬: $(basename "$script")"
            done
        fi
        
        # åˆ›å»ºæ„å»ºæ—¶å®‰è£…è„šæœ¬
        cat > $BUILD_DIR/files/root/custom-install/build-time-install.sh << 'EOF'
#!/bin/sh
echo "=== å¼€å§‹æ„å»ºæ—¶è‡ªå®šä¹‰å®‰è£… ==="

if ls /root/custom-install/*.ipk >/dev/null 2>&1; then
    echo "æ„å»ºæ—¶å®‰è£…IPKæ–‡ä»¶..."
    for ipk in /root/custom-install/*.ipk; do
        echo "å®‰è£…: $(basename $ipk)"
        opkg install "$ipk" --force-depends || echo "å®‰è£…å¤±è´¥: $(basename $ipk)"
    done
else
    echo "æœªæ‰¾åˆ°IPKæ–‡ä»¶"
fi

if ls /root/custom-install/*.sh >/dev/null 2>&1; then
    echo "æ‰§è¡Œæ„å»ºæ—¶è„šæœ¬..."
    for script in /root/custom-install/*.sh; do
        if [ "$(basename $script)" != "build-time-install.sh" ]; then
            echo "æ‰§è¡Œ: $(basename $script)"
            sh "$script" || echo "æ‰§è¡Œå¤±è´¥: $(basename $script)"
        fi
    done
else
    echo "æœªæ‰¾åˆ°è„šæœ¬æ–‡ä»¶"
fi

rm -rf /root/custom-install
echo "=== æ„å»ºæ—¶è‡ªå®šä¹‰å®‰è£…å®Œæˆ ==="
EOF

        chmod +x $BUILD_DIR/files/root/custom-install/build-time-install.sh
        
        # åˆ›å»ºrc.localå¯åŠ¨è„šæœ¬
        mkdir -p $BUILD_DIR/files/etc
        cat > $BUILD_DIR/files/etc/rc.local << 'EOF'
#!/bin/sh
[ -f /root/custom-install/build-time-install.sh ] && {
    /root/custom-install/build-time-install.sh >/tmp/build-time-install.log 2>&1 &
}
exit 0
EOF

        chmod +x $BUILD_DIR/files/etc/rc.local
        echo "âœ… æ„å»ºæ—¶è‡ªå®šä¹‰å®‰è£…é…ç½®å®Œæˆ"

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤ç½‘ç»œå’Œä¸‹è½½ç¯å¢ƒ ==="
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        mkdir -p dl
        chmod 755 dl
        echo "âœ… ç½‘ç»œç¯å¢ƒä¿®å¤å®Œæˆ"

    - name: è¿è¡Œé¢„ä¸‹è½½
      run: |
        cd $BUILD_DIR
        echo "=== è¿è¡Œé¢„ä¸‹è½½è„šæœ¬ ==="
        if [ -f "pre_download.sh" ]; then
            chmod +x pre_download.sh
            echo "å¼€å§‹é¢„ä¸‹è½½å¸¸è§ä¾èµ–åŒ…..."
            ./pre_download.sh
            echo "âœ… é¢„ä¸‹è½½å®Œæˆ"
        else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢„ä¸‹è½½è„šæœ¬ï¼Œè·³è¿‡é¢„ä¸‹è½½æ­¥éª¤"
        fi

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd $BUILD_DIR
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        export MAKE_JOBS=${{ inputs.multithreading && '$(nproc)' || '1' }}
        if [ "${{ inputs.enable_cache }}" = "true" ]; then
            echo "ğŸ”„ å¯ç”¨ç¼–è¯‘ç¼“å­˜æ¨¡å¼ä¸‹è½½"
            make -j$MAKE_JOBS download
        else
            echo "ğŸ”„ æ™®é€šæ¨¡å¼ä¸‹è½½"
            make -j$MAKE_JOBS download
        fi
        echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd $BUILD_DIR
        echo "=== å¼€å§‹ç¼–è¯‘å›ºä»¶ ==="
        export MAKE_JOBS=${{ inputs.multithreading && '$(nproc)' || '1' }}
        echo "ä½¿ç”¨çº¿ç¨‹æ•°: $MAKE_JOBS"
        
        # åˆ›å»ºè¯¦ç»†ç¼–è¯‘æ—¥å¿—
        echo "å¼€å§‹ç¼–è¯‘ï¼Œè¯¦ç»†æ—¥å¿—å°†ä¿å­˜åˆ° build_detailed.log"
        if [ "${{ inputs.enable_cache }}" = "true" ]; then
            echo "ğŸ”„ å¯ç”¨ç¼–è¯‘ç¼“å­˜"
            make -j$MAKE_JOBS V=s 2>&1 | tee build_detailed.log
        else
            echo "ğŸ”„ æ™®é€šç¼–è¯‘æ¨¡å¼"
            make -j$MAKE_JOBS V=s 2>&1 | tee build_detailed.log
        fi
        
        COMPILE_EXIT_CODE=${PIPESTATUS[0]}
        if [ $COMPILE_EXIT_CODE -eq 0 ]; then
            echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
        else
            echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $COMPILE_EXIT_CODE"
            exit $COMPILE_EXIT_CODE
        fi

    - name: é”™è¯¯åˆ†æ
      if: failure()
      run: |
        cd $BUILD_DIR
        echo "=== è¿è¡Œé”™è¯¯åˆ†æ ==="
        if [ -f "error_analysis.sh" ]; then
            chmod +x error_analysis.sh
            echo "å¼€å§‹åˆ†æç¼–è¯‘é”™è¯¯..."
            ./error_analysis.sh
            echo "âœ… é”™è¯¯åˆ†æå®Œæˆ"
        else
            echo "âš ï¸ æœªæ‰¾åˆ°é”™è¯¯åˆ†æè„šæœ¬"
            echo "=== åŸºæœ¬é”™è¯¯åˆ†æ ==="
            echo "æ£€æŸ¥å¸¸è§ç¼–è¯‘é”™è¯¯..."
            if grep -q "recursive dependency" build_detailed.log; then
                echo "âŒ å‘ç°é€’å½’ä¾èµ–é”™è¯¯"
            fi
            if grep -q "No such file or directory" build_detailed.log; then
                echo "âŒ å‘ç°æ–‡ä»¶ç¼ºå¤±é”™è¯¯"
            fi
            echo "è¯·æŸ¥çœ‹ build_detailed.log è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        if [ -d "bin/targets" ]; then
            echo "âœ… å›ºä»¶ç›®å½•å­˜åœ¨"
            find bin/targets -name "*.bin" -o -name "*.img" | while read file; do
                echo "ğŸ“¦ å›ºä»¶æ–‡ä»¶: $file ($(du -h "$file" | cut -f1))"
            done
            echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
            find bin/targets -type f | sort
        else
            echo "âŒ é”™è¯¯: å›ºä»¶ç›®å½•ä¸å­˜åœ¨"
            exit 1
        fi

    - name: æ’ä»¶æ£€æŸ¥
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== æ’ä»¶å®Œæ•´æ€§æ£€æŸ¥ ==="
        if [ -f "check-plugins.sh" ]; then
            chmod +x check-plugins.sh
            echo "å¼€å§‹æ£€æŸ¥æ’ä»¶å®Œæ•´æ€§..."
            ./check-plugins.sh
            echo "âœ… æ’ä»¶æ£€æŸ¥å®Œæˆ"
        else
            echo "âš ï¸ æœªæ‰¾åˆ°æ’ä»¶æ£€æŸ¥è„šæœ¬ï¼Œè·³è¿‡æ£€æŸ¥"
        fi

    - name: ä¿å­˜é…ç½®
      if: success() && ${{ inputs.save_config }}
      run: |
        cd $BUILD_DIR
        echo "=== ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“ ==="
        cd $GITHUB_WORKSPACE
        mkdir -p saved-configs
        CONFIG_NAME="config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ inputs.config_type }}-$(date +%Y%m%d-%H%M%S).config"
        cp $BUILD_DIR/.config saved-configs/$CONFIG_NAME
        echo "âœ… é…ç½®æ–‡ä»¶å·²ä¿å­˜: saved-configs/$CONFIG_NAME"
        
        # ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        echo "ç”Ÿæˆæ„å»ºæŠ¥å‘Š..."
        cat > æ„å»ºæŠ¥å‘Š.md << 'EOF'
# OpenWrt å›ºä»¶æ„å»ºæŠ¥å‘Š
- **æ„å»ºæ—¶é—´**: $(date)
- **è®¾å¤‡**: ${{ github.event.inputs.device_name }}
- **ç‰ˆæœ¬**: ${{ env.SELECTED_REPO }}:${{ env.SELECTED_BRANCH }}
- **é…ç½®ç±»å‹**: ${{ inputs.config_type }}
- **å›ºä»¶æ–‡ä»¶**: 
EOF
        cd $BUILD_DIR && find bin/targets -name "*.bin" -o -name "*.img" | sed 's/^/  - /' >> $GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md
        cat >> $GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md << 'EOF'

## å¯ç”¨çš„ä¸»è¦æ’ä»¶
EOF
        cd $BUILD_DIR && grep "^CONFIG_PACKAGE_luci-app" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//' | sort | uniq | sed 's/^/  - /' >> $GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md
        cat >> $GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md << 'EOF'

## ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ
EOF
        cd $BUILD_DIR
        if grep -q "CONFIG_PACKAGE_kmod-nft-fullcone=y" .config; then
            echo "  - âœ… å®Œæ•´ç½‘ç»œåŠ é€Ÿ (Fullcone NAT)" >> $GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md
        elif grep -q "CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
            echo "  - âœ… åŸºç¡€ç½‘ç»œä¼˜åŒ– (BBR)" >> $GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md
        else
            echo "  - âš ï¸ åŸºç¡€ç½‘ç»œåŠŸèƒ½" >> $GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md
        fi
        echo "âœ… æ„å»ºæŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: å›ºä»¶-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ inputs.config_type }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: æ„å»ºä¿¡æ¯-${{ github.event.inputs.device_name }}-${{ inputs.config_type }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/build_detailed.log
          ${{ env.BUILD_DIR }}/enhanced_error_analysis.log
          ${{ env.BUILD_DIR }}/download_attempt_*.log
          $GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md
        retention-days: 7

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•å·²æ¸…ç†"

  build-firmware-ssh:
    if: ${{ inputs.ssh_connection == true }}
    name: ğŸš€ ç¼–è¯‘ (Build) - SSHè°ƒè¯•ç‰ˆ
    runs-on: ubuntu-22.04
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip
        pip3 install requests urllib3
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: å¼€å¯ SSH æœåŠ¡
      uses: lhotari/action-upterm@v1
      with:
        wait-timeout-minutes: 30

    - name: ç¼–è¯‘å‰æç¤º
      run: |
        echo "ğŸš€ SSHè°ƒè¯•æ¨¡å¼å·²å¯åŠ¨"
        echo "æ‚¨å¯ä»¥é€šè¿‡SSHè¿æ¥åˆ°æ„å»ºç¯å¢ƒè¿›è¡Œè°ƒè¯•"
        echo "è°ƒè¯•å®Œæˆåï¼Œæ„å»ºæµç¨‹å°†ç»§ç»­æ‰§è¡Œ"
