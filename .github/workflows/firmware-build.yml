name: OpenWrt æ™ºèƒ½å›ºä»¶æž„å»ºå·¥ä½œæµï¼ˆå®Œæ•´ä¼˜åŒ–ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'è®¾å¤‡åç§° (å¦‚: ac42u, ac58u, mi4a ç­‰)'
        required: true
        default: 'ac42u'
        type: string
      old_device:
        description: 'æ˜¯å¦ä¸ºè€æ—§è®¾å¤‡ (æ€§èƒ½è¾ƒå·®çš„è®¾å¤‡å»ºè®®é€‰æ‹©true)'
        required: true
        default: false
        type: boolean
      version_spec:
        description: 'ç‰ˆæœ¬è§„æ ¼ (å¯é€‰ï¼Œå¦‚: openwrt-23.05 æˆ– immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_type:
        description: 'é…ç½®ç±»åž‹ (minimal:åŸºç¡€åŠŸèƒ½, normal:å®Œæ•´åŠŸèƒ½, custom:è‡ªå®šä¹‰)'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - normal
          - custom
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…å)'
        required: false
        type: string
      disabled_plugins:
        description: 'ç¦ç”¨æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…åï¼Œå¦‚: luci-app-accesscontrol luci-app-ddns)'
        required: false
        type: string
        default: ''
      save_config:
        description: 'ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“'
        required: false
        default: true
        type: boolean
      custom_install:
        description: 'å¯ç”¨è‡ªå®šä¹‰å®‰è£… (IPKå’Œè„šæœ¬)'
        required: false
        default: true
        type: boolean
      enable_cache:
        description: 'å¯ç”¨ç¼–è¯‘ç¼“å­˜ (æ˜¾è‘—åŠ é€ŸåŽç»­ç¼–è¯‘)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  MIRROR_SOURCE: "tuna"
  CACHE_ENABLED: true

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential libncurses5-dev libssl-dev python3 unzip zlib1g-dev subversion gcc-multilib git curl file ninja-build automake autoconf libtool pkg-config gettext help2man texinfo gawk flex bison rsync wget aria2 python3-pip libelf-dev liblz4-dev zstd libssl-dev libcurl4-openssl-dev groff texlive texinfo
        pip3 install requests urllib3
        echo "âœ… ç¼–è¯‘çŽ¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæž„å»ºç›®å½•å¹¶è®¾ç½®æƒé™
      run: |
        echo "=== åˆ›å»ºæž„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        sudo chmod u+w $BUILD_DIR
        echo "âœ… æž„å»ºç›®å½•åˆ›å»ºå®Œæˆ"
        touch $BUILD_DIR/test_write.txt && echo "âœ… å†™å…¥æµ‹è¯•æˆåŠŸ" && rm $BUILD_DIR/test_write.txt

    - name: å¤åˆ¶è„šæœ¬åˆ°æž„å»ºç›®å½•
      run: |
        cd $BUILD_DIR
        echo "=== å¤åˆ¶è„šæœ¬åˆ°æž„å»ºç›®å½• ==="
        cd $GITHUB_WORKSPACE
        VERSION_SCRIPT=$(find . -name "complete_version_detector.sh" -type f | head -1)
        DEVICE_SCRIPT=$(find . -name "device_detection.sh" -type f | head -1)
        ERROR_SCRIPT=$(find . -name "error_analysis.sh" -type f | head -1)
        PRE_DOWNLOAD_SCRIPT=$(find . -name "pre_download.sh" -type f | head -1)
        
        if [ -z "$VERSION_SCRIPT" ] || [ -z "$DEVICE_SCRIPT" ]; then
          echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°å¿…è¦çš„æ£€æµ‹è„šæœ¬"
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°ç‰ˆæœ¬æ£€æµ‹è„šæœ¬: $VERSION_SCRIPT"
        echo "âœ… æ‰¾åˆ°è®¾å¤‡æ£€æµ‹è„šæœ¬: $DEVICE_SCRIPT"
        
        cp "$VERSION_SCRIPT" $BUILD_DIR/complete_version_detector.sh
        cp "$DEVICE_SCRIPT" $BUILD_DIR/device_detection.sh
        
        if [ -n "$ERROR_SCRIPT" ]; then
          echo "âœ… æ‰¾åˆ°é”™è¯¯åˆ†æžè„šæœ¬: $ERROR_SCRIPT"
          cp "$ERROR_SCRIPT" $BUILD_DIR/error_analysis.sh
        fi

        if [ -n "$PRE_DOWNLOAD_SCRIPT" ]; then
          echo "âœ… æ‰¾åˆ°é¢„ä¸‹è½½è„šæœ¬: $PRE_DOWNLOAD_SCRIPT"
          cp "$PRE_DOWNLOAD_SCRIPT" $BUILD_DIR/pre_download.sh
        fi
        
        cd $BUILD_DIR
        chmod +x complete_version_detector.sh device_detection.sh
        if [ -f "error_analysis.sh" ]; then chmod +x error_analysis.sh; fi
        if [ -f "pre_download.sh" ]; then chmod +x pre_download.sh; fi
        echo "âœ… è„šæœ¬å¤åˆ¶å®Œæˆ"

    - name: æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ ==="
        sudo chown -R $USER:$USER . 2>/dev/null || true
        chmod u+w . 2>/dev/null || true
        
        echo "=== å¼€å§‹ç‰ˆæœ¬æ£€æµ‹ ==="
        echo "è®¾å¤‡åç§°: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬è§„æ ¼: ${{ github.event.inputs.version_spec }}"
        echo "è€æ—§è®¾å¤‡: ${{ github.event.inputs.old_device }}"
        
        set +e
        OUTPUT=$(./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_spec }}" "${{ github.event.inputs.old_device }}" 2>&1)
        SCRIPT_EXIT_CODE=$?
        set -e
        
        echo "è„šæœ¬è¾“å‡º:"
        echo "$OUTPUT"
        echo "è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE"
        
        SELECTED_REPO=$(echo "$OUTPUT" | grep "^SELECTED_REPO=" | head -1 | cut -d'=' -f2)
        SELECTED_BRANCH=$(echo "$OUTPUT" | grep "^SELECTED_BRANCH=" | head -1 | cut -d'=' -f2)
        SELECTED_REPO_URL=$(echo "$OUTPUT" | grep "^SELECTED_REPO_URL=" | head -1 | cut -d'=' -f2)
        
        if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
            echo "âœ… ä»Žè„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–ç‰ˆæœ¬ä¿¡æ¯"
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            echo "âœ… çŽ¯å¢ƒå˜é‡å·²è®¾ç½®:"
            echo "  ä»“åº“: $SELECTED_REPO"
            echo "  åˆ†æ”¯: $SELECTED_BRANCH"
            echo "  URL: $SELECTED_REPO_URL"
        else
            echo "âŒ æ— æ³•ä»Žè„šæœ¬è¾“å‡ºä¸­æå–ç‰ˆæœ¬ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ ç‰ˆæœ¬æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼"
                echo "SELECTED_REPO=immortalwrt" >> $GITHUB_ENV
                echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
                echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
                echo "âœ… ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ä¿¡æ¯"
            fi
        fi

    - name: å¤‡ä»½æ£€æµ‹è„šæœ¬åˆ°ä¸´æ—¶ç›®å½•
      run: |
        echo "=== å¤‡ä»½æ£€æµ‹è„šæœ¬åˆ°ä¸´æ—¶ç›®å½• ==="
        mkdir -p /tmp/build-scripts-backup
        cp $BUILD_DIR/complete_version_detector.sh /tmp/build-scripts-backup/
        cp $BUILD_DIR/device_detection.sh /tmp/build-scripts-backup/
        if [ -f "$BUILD_DIR/error_analysis.sh" ]; then
          cp $BUILD_DIR/error_analysis.sh /tmp/build-scripts-backup/
        fi
        if [ -f "$BUILD_DIR/pre_download.sh" ]; then
          cp $BUILD_DIR/pre_download.sh /tmp/build-scripts-backup/
        fi
        echo "âœ… è„šæœ¬å¤‡ä»½å®Œæˆ"

    - name: æ¸…ç†æž„å»ºç›®å½•å‡†å¤‡å…‹éš†
      run: |
        cd $BUILD_DIR
        echo "=== æ¸…ç†æž„å»ºç›®å½•å‡†å¤‡å…‹éš† ==="
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        sudo rm -rf .[!.]* 2>/dev/null || true
        echo "æ¸…ç†åŽç›®å½•å†…å®¹:"
        ls -la
        echo "âœ… ç›®å½•æ¸…ç†å®Œæˆ"

    - name: å…‹éš†é€‰å®šç‰ˆæœ¬çš„æºç 
      run: |
        cd $BUILD_DIR
        echo "=== å…‹éš†é€‰å®šç‰ˆæœ¬çš„æºç  ==="
        echo "ä»“åº“: $SELECTED_REPO_URL"
        echo "åˆ†æ”¯: $SELECTED_BRANCH"
        
        if [ -z "$SELECTED_REPO_URL" ] || [ -z "$SELECTED_BRANCH" ]; then
          echo "âŒ é”™è¯¯: çŽ¯å¢ƒå˜é‡æœªæ­£ç¡®è®¾ç½®"
          exit 1
        fi
        
        echo "æ£€æŸ¥ç›®å½•çŠ¶æ€..."
        FILE_COUNT=$(ls -A | wc -l)
        if [ $FILE_COUNT -ne 0 ]; then
          echo "âŒ é”™è¯¯: ç›®å½•éžç©ºï¼Œæ— æ³•å…‹éš†"
          exit 1
        fi
        
        MAX_RETRIES=3
        RETRY_COUNT=0
        CLONE_SUCCESS=false
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$CLONE_SUCCESS" = false ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "å…‹éš†å°è¯•: $RETRY_COUNT/$MAX_RETRIES"
          
          if git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .; then
            echo "âœ… æºç å…‹éš†å®Œæˆ"
            echo "âœ… æˆåŠŸå…‹éš†ä»“åº“: $SELECTED_REPO, åˆ†æ”¯: $SELECTED_BRANCH"
            CLONE_SUCCESS=true
          else
            echo "âŒ å…‹éš†å¤±è´¥ï¼Œå°è¯• $RETRY_COUNT/$MAX_RETRIES"
            
            if echo "$SELECTED_REPO_URL" | grep -q "github.com" && [ $RETRY_COUNT -eq 2 ]; then
              echo "ðŸ”„ å°è¯•ä½¿ç”¨é•œåƒæº..."
              MIRROR_URL=$(echo "$SELECTED_REPO_URL" | sed 's/github.com/github.com.cnpmjs.org/')
              rm -rf ./* ./.git* 2>/dev/null || true
              if git clone --depth 1 --branch "$SELECTED_BRANCH" "$MIRROR_URL" .; then
                echo "âœ… ä½¿ç”¨é•œåƒæºå…‹éš†æˆåŠŸ"
                CLONE_SUCCESS=true
                break
              fi
            fi
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ æºç å…‹éš†å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            fi
            sleep 10
            rm -rf ./* ./.git* 2>/dev/null || true
          fi
        done

    - name: æ¢å¤æ£€æµ‹è„šæœ¬
      run: |
        cd $BUILD_DIR
        echo "=== æ¢å¤æ£€æµ‹è„šæœ¬ ==="
        cp /tmp/build-scripts-backup/complete_version_detector.sh ./
        cp /tmp/build-scripts-backup/device_detection.sh ./
        if [ -f "/tmp/build-scripts-backup/error_analysis.sh" ]; then
          cp /tmp/build-scripts-backup/error_analysis.sh ./
        fi
        if [ -f "/tmp/build-scripts-backup/pre_download.sh" ]; then
          cp /tmp/build-scripts-backup/pre_download.sh ./
        fi
        chmod +x complete_version_detector.sh device_detection.sh
        if [ -f "error_analysis.sh" ]; then chmod +x error_analysis.sh; fi
        if [ -f "pre_download.sh" ]; then chmod +x pre_download.sh; fi
        echo "âœ… è„šæœ¬æ¢å¤å®Œæˆ"

    - name: é‡æ–°å¤åˆ¶é…ç½®æ–‡ä»¶å’Œé”™è¯¯åˆ†æžè„šæœ¬
      run: |
        cd $BUILD_DIR
        echo "=== é‡æ–°å¤åˆ¶é…ç½®æ–‡ä»¶å’Œé”™è¯¯åˆ†æžè„šæœ¬ ==="
        cd $GITHUB_WORKSPACE
        
        echo "=== æŸ¥æ‰¾é…ç½®æ–‡ä»¶ ==="
        CONFIG_FILES=$(find firmware-config/configs -name "*.config" -type f 2>/dev/null || true)
        if [ -n "$CONFIG_FILES" ]; then
          echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶:"
          echo "$CONFIG_FILES"
          mkdir -p $BUILD_DIR/config-templates
          for config_file in $CONFIG_FILES; do
            filename=$(basename "$config_file")
            cp "$config_file" $BUILD_DIR/config-templates/
            echo "âœ… å¤åˆ¶: $filename"
          done
          echo "âœ… æ‰€æœ‰é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          echo "å½“å‰é…ç½®æ¨¡æ¿ç›®å½•å†…å®¹:"
          ls -la $BUILD_DIR/config-templates/
        else
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        # é‡æ–°å¤åˆ¶é”™è¯¯åˆ†æžè„šæœ¬ï¼ˆå¦‚æžœä»“åº“ä¸­æœ‰æ›´æ–°ï¼‰
        ERROR_SCRIPT=$(find . -name "error_analysis.sh" -type f | head -1)
        if [ -n "$ERROR_SCRIPT" ]; then
          echo "âœ… æ‰¾åˆ°é”™è¯¯åˆ†æžè„šæœ¬: $ERROR_SCRIPT"
          cp "$ERROR_SCRIPT" $BUILD_DIR/error_analysis.sh
          chmod +x $BUILD_DIR/error_analysis.sh
        fi

        # é‡æ–°å¤åˆ¶é¢„ä¸‹è½½è„šæœ¬
        PRE_DOWNLOAD_SCRIPT=$(find . -name "pre_download.sh" -type f | head -1)
        if [ -n "$PRE_DOWNLOAD_SCRIPT" ]; then
          echo "âœ… æ‰¾åˆ°é¢„ä¸‹è½½è„šæœ¬: $PRE_DOWNLOAD_SCRIPT"
          cp "$PRE_DOWNLOAD_SCRIPT" $BUILD_DIR/pre_download.sh
          chmod +x $BUILD_DIR/pre_download.sh
        fi
        
        echo "âœ… é…ç½®æ–‡ä»¶å’Œè„šæœ¬é‡æ–°å¤åˆ¶å®Œæˆ"

    - name: æ™ºèƒ½è®¾å¤‡æ£€æµ‹ä¸Žåˆ«åè½¬æ¢
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½è®¾å¤‡æ£€æµ‹ä¸Žåˆ«åè½¬æ¢ ==="
        
        INPUT_DEVICE="${{ github.event.inputs.device_name }}"
        echo "è¾“å…¥è®¾å¤‡åç§°: $INPUT_DEVICE"
        
        # è®¾å¤‡åˆ«åæ˜ å°„
        case "$INPUT_DEVICE" in
            "ac42u"|"acrh17"|"rt-acrh17") ACTUAL_DEVICE="asus_rt-ac42u" ;;
            "ac58u"|"acrh13"|"rt-ac58u"|"rt-acrh13") ACTUAL_DEVICE="asus_rt-ac58u" ;;
            "mi4a"|"r4a") ACTUAL_DEVICE="xiaomi_mi-router-4a-gigabit" ;;
            "mi3g"|"r3g") ACTUAL_DEVICE="xiaomi_mi-router-3g" ;;
            *) ACTUAL_DEVICE="$INPUT_DEVICE" ;;
        esac
        
        if [ "$ACTUAL_DEVICE" != "$INPUT_DEVICE" ]; then
          echo "âœ… æ£€æµ‹åˆ°è®¾å¤‡é€šç”¨åç§° '$INPUT_DEVICE'ï¼Œè½¬æ¢ä¸ºå®žé™…è®¾å¤‡æ ‡è¯† '$ACTUAL_DEVICE'"
        else
          echo "â„¹ï¸ ä½¿ç”¨åŽŸå§‹è®¾å¤‡åç§°: $ACTUAL_DEVICE (æœªæ‰¾åˆ°åˆ«åæ˜ å°„)"
        fi
        
        if [ ! -f "device_detection.sh" ]; then
          echo "âŒ é”™è¯¯: è®¾å¤‡æ£€æµ‹è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        chmod +x device_detection.sh
        
        echo "=== å¼€å§‹è®¾å¤‡æ£€æµ‹ ==="
        TEMP_LOG=$(mktemp)
        
        set +e
        ./device_detection.sh "$ACTUAL_DEVICE" 2>&1 | tee "$TEMP_LOG"
        SCRIPT_EXIT_CODE=$?
        set -e
        
        echo "=== è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE ==="
        
        PLATFORM=$(grep "^PLATFORM=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        DEVICE_SHORT_NAME=$(grep "^DEVICE_SHORT_NAME=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        DEVICE_FULL_NAME=$(grep "^DEVICE_FULL_NAME=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        
        echo "=== æå–çš„è®¾å¤‡ä¿¡æ¯ ==="
        echo "å¹³å°(PLATFORM): '$PLATFORM'"
        echo "è®¾å¤‡çŸ­åç§°(DEVICE_SHORT_NAME): '$DEVICE_SHORT_NAME'"
        echo "è®¾å¤‡å…¨åç§°(DEVICE_FULL_NAME): '$DEVICE_FULL_NAME'"
        
        rm -f "$TEMP_LOG"
        
        if [ -n "$PLATFORM" ] && [ -n "$DEVICE_SHORT_NAME" ] && [ -n "$DEVICE_FULL_NAME" ]; then
            echo "âœ… ä»Žè„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–è®¾å¤‡ä¿¡æ¯"
            echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
            echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
            echo "âœ… è®¾å¤‡çŽ¯å¢ƒå˜é‡å·²è®¾ç½®:"
            echo "  å¹³å°: $PLATFORM"
            echo "  è®¾å¤‡çŸ­åç§°: $DEVICE_SHORT_NAME"
            echo "  è®¾å¤‡å…¨åç§°: $DEVICE_FULL_NAME"
        else
            echo "âŒ æ— æ³•ä»Žè„šæœ¬è¾“å‡ºä¸­æå–è®¾å¤‡ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ è®¾å¤‡æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–è®¾å¤‡ä¿¡æ¯ï¼Œä½¿ç”¨å¤‡ç”¨è®¾å¤‡æ˜ å°„"
                case "$ACTUAL_DEVICE" in
                    "asus_rt-ac42u"|"ac42u"|"acrh17"|"rt-acrh17")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac42u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "asus_rt-ac58u"|"ac58u"|"acrh13"|"rt-acrh13")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac58u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "xiaomi_mi-router-4a-gigabit"|"mi4a"|"r4a")
                        echo "PLATFORM=ramips" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=xiaomi_mi-router-4a-gigabit" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    *)
                        echo "âŒ æœªçŸ¥è®¾å¤‡ï¼Œæ— æ³•è®¾ç½®é»˜è®¤å€¼"
                        exit 1
                        ;;
                esac
                echo "âœ… å·²ä½¿ç”¨å¤‡ç”¨è®¾å¤‡ä¿¡æ¯"
            fi
        fi

    - name: æ›´æ–°å®‰è£…feeds
      run: |
        cd $BUILD_DIR
        echo "=== æ›´æ–°å’Œå®‰è£…feeds ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ä½¿ç”¨å¤–éƒ¨é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== ä½¿ç”¨å¤–éƒ¨é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½® ==="
        
        > .config
        
        echo "CONFIG_TARGET_${PLATFORM}=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic=y" >> .config
        
        CORRECT_DEVICE_CONFIG="CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}"
        echo "${CORRECT_DEVICE_CONFIG}=y" >> .config
        echo "ä½¿ç”¨çš„è®¾å¤‡é…ç½®é¡¹: ${CORRECT_DEVICE_CONFIG}=y"
        
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
        
        CONFIG_TYPE="${{ github.event.inputs.config_type }}"
        echo "é…ç½®ç±»åž‹: $CONFIG_TYPE"
        
        if [ "$CONFIG_TYPE" = "minimal" ]; then
            CONFIG_FILE="config-templates/minimal.config"
        elif [ "$CONFIG_TYPE" = "normal" ] || [ "$CONFIG_TYPE" = "custom" ]; then
            IS_OLD_VERSION=0
            if [ "${{ github.event.inputs.old_device }}" = "true" ]; then
                IS_OLD_VERSION=1
                echo "âœ… ç”¨æˆ·æŒ‡å®šä¸ºè€æ—§è®¾å¤‡ï¼Œä½¿ç”¨æ—§ç‰ˆæœ¬é…ç½®"
            else
                if echo "$SELECTED_BRANCH" | grep -q -E "19\.07|21\.02|17\.01|lede"; then
                    IS_OLD_VERSION=1
                    echo "âœ… æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬åˆ†æ”¯: $SELECTED_BRANCH"
                fi
                if [ "$SELECTED_REPO" = "lede" ] || [ "$SELECTED_REPO" = "openwrt-19.07" ] || [ "$SELECTED_REPO" = "openwrt-21.02" ]; then
                    IS_OLD_VERSION=1
                    echo "âœ… æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬ä»“åº“: $SELECTED_REPO"
                fi
                case "${{ github.event.inputs.device_name }}" in
                    "wr841n"|"wr842n"|"wr941n"|"mr3420"|"ar71xx"*)
                        IS_OLD_VERSION=1
                        echo "âœ… æ£€æµ‹åˆ°è€æ—§è®¾å¤‡åž‹å·: ${{ github.event.inputs.device_name }}"
                        ;;
                esac
            fi
            
            if [ "$IS_OLD_VERSION" -eq 1 ]; then
                echo "âœ… æœ€ç»ˆå†³å®š: ä½¿ç”¨æ—§ç‰ˆæœ¬é…ç½®"
                CONFIG_FILE="config-templates/normal-old.config"
            else
                echo "âœ… æœ€ç»ˆå†³å®š: ä½¿ç”¨æ–°ç‰ˆæœ¬é…ç½®"
                CONFIG_FILE="config-templates/normal-new.config"
            fi
        else
            echo "âŒ æœªçŸ¥çš„é…ç½®ç±»åž‹: $CONFIG_TYPE"
            exit 1
        fi
        
        if [ -f "$CONFIG_FILE" ]; then
            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FILE"
            cat "$CONFIG_FILE" >> .config
            echo "âœ… é…ç½®å·²åŠ è½½: $(basename "$CONFIG_FILE")"
        else
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILE"
            exit 1
        fi
        
        # å¼ºåˆ¶å¯ç”¨å¿…è¦çš„åŒ…
        echo "# å¼ºåˆ¶å¯ç”¨åŸºç¡€åŒ…" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y" >> .config
        
        if [ "$CONFIG_TYPE" = "normal" ] || [ "$CONFIG_TYPE" = "custom" ]; then
            echo "# å¼ºåˆ¶å¯ç”¨æ­£å¸¸æ¨¡å¼æ’ä»¶" >> .config
            echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-sqm=y" >> .config
        fi
        
        if [ "$CONFIG_TYPE" = "custom" ] && [ -n "${{ github.event.inputs.extra_packages }}" ]; then
            echo "# é¢å¤–åŒ…é…ç½®" >> .config
            for pkg in ${{ github.event.inputs.extra_packages }}; do
                pkg_clean=$(echo "$pkg" | tr '-' '_' | tr -cd '[:alnum:]_')
                echo "CONFIG_PACKAGE_${pkg_clean}=y" >> .config
                echo "âœ… æ·»åŠ é¢å¤–åŒ…: CONFIG_PACKAGE_${pkg_clean}=y"
            done
        fi
        
        if [ -n "${{ github.event.inputs.disabled_plugins }}" ]; then
            echo "# ç¦ç”¨æ’ä»¶é…ç½®" >> .config
            for plugin in ${{ github.event.inputs.disabled_plugins }}; do
                plugin_clean=$(echo "$plugin" | tr '-' '_' | tr -cd '[:alnum:]_')
                echo "# CONFIG_PACKAGE_${plugin_clean} is not set" >> .config
                echo "âœ… ç¦ç”¨æ’ä»¶: $plugin (CONFIG_PACKAGE_${plugin_clean})"
            done
        fi
        
        echo "è¿è¡Œ make defconfig..."
        make defconfig
        
        echo "=== å¼ºåˆ¶å¯ç”¨å…³é”®è½¯ä»¶åŒ… ==="
        # åŸºç¡€Luciç»„ä»¶
        sed -i 's/# CONFIG_PACKAGE_luci is not set/CONFIG_PACKAGE_luci=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci=y" >> .config
        sed -i 's/# CONFIG_PACKAGE_luci-base is not set/CONFIG_PACKAGE_luci-base=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-base=y" >> .config

        # ä¸­æ–‡è¯­è¨€åŒ…
        sed -i 's/# CONFIG_PACKAGE_luci-i18n-base-zh-cn is not set/CONFIG_PACKAGE_luci-i18n-base-zh-cn=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        sed -i 's/# CONFIG_PACKAGE_luci-i18n-firewall-zh-cn is not set/CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y" >> .config

        # æ­£å¸¸æ¨¡å¼æ’ä»¶
        if [ "$CONFIG_TYPE" = "normal" ] || [ "$CONFIG_TYPE" = "custom" ]; then
            sed -i 's/# CONFIG_PACKAGE_luci-app-turboacc is not set/CONFIG_PACKAGE_luci-app-turboacc=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            sed -i 's/# CONFIG_PACKAGE_luci-app-sqm is not set/CONFIG_PACKAGE_luci-app-sqm=y/' .config 2>/dev/null || echo "CONFIG_PACKAGE_luci-app-sqm=y" >> .config
        fi

        echo "âœ… å…³é”®è½¯ä»¶åŒ…å¼ºåˆ¶å¯ç”¨å®Œæˆ"
        
        echo "=== æœ€ç»ˆé…ç½®éªŒè¯ ==="
        if grep -q "^${CORRECT_DEVICE_CONFIG}=y" .config; then
            echo "âœ… è®¾å¤‡ $DEVICE_SHORT_NAME å·²æˆåŠŸå¯ç”¨"
        else
            echo "âŒ è®¾å¤‡ $DEVICE_SHORT_NAME å¯ç”¨å¤±è´¥ï¼Œæž„å»ºç»ˆæ­¢"
            exit 1
        fi

    - name: æž„å»ºæ—¶é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      if: github.event.inputs.custom_install == 'true'
      run: |
        cd $BUILD_DIR
        echo "=== æž„å»ºæ—¶é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
        
        # åˆ›å»ºè‡ªå®šä¹‰ç›®å½•
        mkdir -p files/root/custom-install
        
        # å¤åˆ¶IPKæ–‡ä»¶
        cd $GITHUB_WORKSPACE
        IPK_FILES=$(find firmware-config/custom-files -name "*.ipk" -type f 2>/dev/null || true)
        if [ -n "$IPK_FILES" ]; then
            echo "âœ… æ‰¾åˆ°IPKæ–‡ä»¶:"
            echo "$IPK_FILES"
            for ipk in $IPK_FILES; do
                cp "$ipk" $BUILD_DIR/files/root/custom-install/
                echo "âœ… å¤åˆ¶IPK: $(basename "$ipk")"
            done
        fi
        
        # å¤åˆ¶è„šæœ¬æ–‡ä»¶
        SCRIPT_FILES=$(find firmware-config/custom-files -name "*.sh" -type f 2>/dev/null | grep -v "detector\|analysis" || true)
        if [ -n "$SCRIPT_FILES" ]; then
            echo "âœ… æ‰¾åˆ°è„šæœ¬æ–‡ä»¶:"
            echo "$SCRIPT_FILES"
            for script in $SCRIPT_FILES; do
                cp "$script" $BUILD_DIR/files/root/custom-install/
                chmod +x $BUILD_DIR/files/root/custom-install/$(basename "$script")
                echo "âœ… å¤åˆ¶è„šæœ¬: $(basename "$script")"
            done
        fi
        
        # åˆ›å»ºæž„å»ºæ—¶å®‰è£…è„šæœ¬ - ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤
        echo '#!/bin/sh' > $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'echo "=== å¼€å§‹æž„å»ºæ—¶è‡ªå®šä¹‰å®‰è£… ==="' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '# æž„å»ºæ—¶å®‰è£…IPKæ–‡ä»¶ - ä½¿ç”¨æœ¬åœ°opkgå®‰è£…' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'if ls /root/custom-install/*.ipk >/dev/null 2>&1; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æž„å»ºæ—¶å®‰è£…IPKæ–‡ä»¶..."' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    for ipk in /root/custom-install/*.ipk; do' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        echo "å®‰è£…: $(basename $ipk)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        # ä½¿ç”¨opkgæœ¬åœ°å®‰è£…ï¼Œä¸ä¾èµ–ç½‘ç»œ' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        opkg install "$ipk" --force-depends || echo "å®‰è£…å¤±è´¥: $(basename $ipk)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    done' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'else' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æœªæ‰¾åˆ°IPKæ–‡ä»¶"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '# æ‰§è¡Œæž„å»ºæ—¶è„šæœ¬' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'if ls /root/custom-install/*.sh >/dev/null 2>&1; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æ‰§è¡Œæž„å»ºæ—¶è„šæœ¬..."' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    for script in /root/custom-install/*.sh; do' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        if [ "$(basename $script)" != "build-time-install.sh" ]; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '            echo "æ‰§è¡Œ: $(basename $script)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '            sh "$script" || echo "æ‰§è¡Œå¤±è´¥: $(basename $script)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    done' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'else' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æœªæ‰¾åˆ°è„šæœ¬æ–‡ä»¶"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '# æ¸…ç†å®‰è£…æ–‡ä»¶' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'rm -rf /root/custom-install' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'echo "=== æž„å»ºæ—¶è‡ªå®šä¹‰å®‰è£…å®Œæˆ ==="' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        
        chmod +x $BUILD_DIR/files/root/custom-install/build-time-install.sh
        
        # åˆ›å»ºå¼€æœºæ‰§è¡Œè„šæœ¬ - ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤
        mkdir -p $BUILD_DIR/files/etc
        echo '#!/bin/sh' > $BUILD_DIR/files/etc/rc.local
        echo '' >> $BUILD_DIR/files/etc/rc.local
        echo '# åœ¨åŽå°æ‰§è¡Œæž„å»ºæ—¶è‡ªå®šä¹‰å®‰è£…' >> $BUILD_DIR/files/etc/rc.local
        echo '[ -f /root/custom-install/build-time-install.sh ] && {' >> $BUILD_DIR/files/etc/rc.local
        echo '    /root/custom-install/build-time-install.sh >/tmp/build-time-install.log 2>&1 &' >> $BUILD_DIR/files/etc/rc.local
        echo '}' >> $BUILD_DIR/files/etc/rc.local
        echo '' >> $BUILD_DIR/files/etc/rc.local
        echo 'exit 0' >> $BUILD_DIR/files/etc/rc.local
        
        chmod +x $BUILD_DIR/files/etc/rc.local
        echo "âœ… æž„å»ºæ—¶è‡ªå®šä¹‰å®‰è£…é…ç½®å®Œæˆ"

    - name: ä¿®å¤ç½‘ç»œå’Œä¸‹è½½çŽ¯å¢ƒ
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤ç½‘ç»œå’Œä¸‹è½½çŽ¯å¢ƒ ==="
        
        # è®¾ç½®Gitå’Œcurlé‡è¯•
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        
        # åˆ›å»ºä¸‹è½½ç›®å½•å¹¶è®¾ç½®æƒé™
        mkdir -p dl
        chmod 755 dl
        
        echo "âœ… ç½‘ç»œçŽ¯å¢ƒä¿®å¤å®Œæˆ"

    - name: è¿è¡Œé¢„ä¸‹è½½è„šæœ¬
      run: |
        cd $BUILD_DIR
        echo "=== è¿è¡Œé¢„ä¸‹è½½è„šæœ¬ ==="
        
        if [ -f "pre_download.sh" ]; then
            chmod +x pre_download.sh
            echo "å¼€å§‹é¢„ä¸‹è½½å¸¸è§ä¾èµ–åŒ…..."
            ./pre_download.sh
            echo "âœ… é¢„ä¸‹è½½å®Œæˆ"
        else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢„ä¸‹è½½è„šæœ¬ï¼Œè·³è¿‡é¢„ä¸‹è½½æ­¥éª¤"
        fi

    - name: åŠ å¼ºä¸‹è½½DLåº“å¹¶éªŒè¯å®Œæ•´æ€§
      run: |
        cd $BUILD_DIR
        echo "=== åŠ å¼ºä¸‹è½½DLåº“å¹¶éªŒè¯å®Œæ•´æ€§ ==="
        
        mkdir -p dl
        chmod 755 dl
        
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        
        # è®¾ç½®å›½å†…é•œåƒæº
        echo "=== è®¾ç½®å›½å†…é•œåƒæº: $MIRROR_SOURCE ==="
        case "$MIRROR_SOURCE" in
            "tuna") MIRROR_URL="https://mirrors.tuna.tsinghua.edu.cn/openwrt" ;;
            "ustc") MIRROR_URL="https://mirrors.ustc.edu.cn/openwrt" ;;
            "tencent") MIRROR_URL="https://mirrors.cloud.tencent.com/openwrt" ;;
            "huawei") MIRROR_URL="https://mirrors.huaweicloud.com/openwrt" ;;
            *) MIRROR_URL="https://mirrors.tuna.tsinghua.edu.cn/openwrt" ;;
        esac
        
        # è®¾ç½®feeds.conf.defaultä½¿ç”¨é•œåƒ
        if [ -f "feeds.conf.default" ]; then
            cp feeds.conf.default feeds.conf.default.backup
            sed -i "s|https://github.com|$MIRROR_URL|g" feeds.conf.default
            sed -i "s|git://github.com|$MIRROR_URL|g" feeds.conf.default
            echo "âœ… å·²è®¾ç½®feedsé•œåƒæº"
        fi
        
        MAX_DOWNLOAD_RETRIES=5
        RETRY_COUNT=0
        DOWNLOAD_SUCCESS=false
        
        # é¢„å…ˆä¸‹è½½å…³é”®ä¾èµ–
        echo "=== é¢„å…ˆä¸‹è½½å…³é”®ä¾èµ– ==="
        make -j1 tools/install V=s 2>&1 | grep -E "Downloading|error" || true
        make -j1 toolchain/install V=s 2>&1 | grep -E "Downloading|error" || true
        
        # æ¸…ç†å¯èƒ½æŸåçš„æ–‡ä»¶
        find dl -name "*.tmp" -delete 2>/dev/null || true
        find dl -size 0 -delete 2>/dev/null || true
        
        while [ $RETRY_COUNT -lt $MAX_DOWNLOAD_RETRIES ] && [ "$DOWNLOAD_SUCCESS" = false ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "=== ä¸‹è½½å°è¯• $RETRY_COUNT/$MAX_DOWNLOAD_RETRIES ==="
          
          # ä½¿ç”¨å•çº¿ç¨‹ä¸‹è½½ç¡®ä¿ç¨³å®šæ€§
          if make -j1 download V=s 2>&1 | tee download_attempt_${RETRY_COUNT}.log; then
            echo "âœ… ä¸‹è½½å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å…³é”®é”™è¯¯
            if grep -q "404" download_attempt_${RETRY_COUNT}.log; then
              echo "âš ï¸ æ£€æµ‹åˆ°404é”™è¯¯ï¼Œå°è¯•ä¿®å¤..."
              
              # ä¿®å¤å¸¸è§ä¸‹è½½å¤±è´¥åŒ…
              FAILED_PACKAGES=("csstidy" "groff" "lua-rsa")
              for pkg in "${FAILED_PACKAGES[@]}"; do
                  if grep -q "$pkg.*404" download_attempt_${RETRY_COUNT}.log 2>/dev/null; then
                      echo "ðŸ”„ ä¿®å¤ $pkg ä¸‹è½½é—®é¢˜..."
                      find dl -name "*${pkg}*" -delete 2>/dev/null || true
                      
                      # å°è¯•ä½¿ç”¨å¤‡ç”¨æº
                      case "$pkg" in
                          "csstidy")
                              wget -O dl/csstidy-fixed.tar.xz "https://gitee.com/mirrors/csstidy/repository/archive/707feaec556c40c999514a598b1a1ea5b50826c6.tar.gz" || true
                              ;;
                          "groff")
                              wget -O dl/groff-fixed.tar.gz "https://ftp.gnu.org/gnu/groff/groff-1.22.4.tar.gz" || true
                              ;;
                      esac
                  fi
              done
              
              # è®°å½•å¤±è´¥çš„åŒ…
              FAILED_PACKAGES=$(grep "404" download_attempt_${RETRY_COUNT}.log | grep -oE '[a-zA-Z0-9_.-]+\.(tar\.|zip|gz|bz2)' | sort -u)
              if [ -n "$FAILED_PACKAGES" ]; then
                echo "æœ‰é—®é¢˜çš„åŒ…: $FAILED_PACKAGES"
                for pkg in $FAILED_PACKAGES; do
                  find dl -name "*$pkg*" -delete 2>/dev/null || true
                done
                # ç»§ç»­é‡è¯•
                continue
              fi
            else
              DOWNLOAD_SUCCESS=true
            fi
          else
            echo "âŒ ä¸‹è½½å‘½ä»¤æ‰§è¡Œå¤±è´¥"
            
            if [ $RETRY_COUNT -eq $MAX_DOWNLOAD_RETRIES ]; then
              echo "âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¸‹è½½å¤±è´¥"
              echo "=== æœ€åŽå°è¯•å•çº¿ç¨‹ä¸‹è½½ ==="
              make -j1 download V=s
              break
            else
              echo "ðŸ”„ ç­‰å¾…15ç§’åŽé‡è¯•..."
              sleep 15
              # æ¸…ç†å¯èƒ½çš„æŸåæ–‡ä»¶
              find dl -name "*.tmp" -delete 2>/dev/null || true
              find dl -size 0 -delete 2>/dev/null || true
            fi
          fi
        done
        
        echo "=== ä¸‹è½½å®Œæ•´æ€§è¯¦ç»†æ£€æŸ¥ ==="
        EMPTY_FILES=$(find dl -type f -size 0 2>/dev/null | wc -l)
        if [ "$EMPTY_FILES" -gt 0 ]; then
          echo "âŒ å‘çŽ° $EMPTY_FILES ä¸ªç©ºæ–‡ä»¶ï¼Œåˆ é™¤åŽé‡æ–°ä¸‹è½½..."
          find dl -type f -size 0 -delete
          echo "é‡æ–°ä¸‹è½½ç©ºæ–‡ä»¶..."
          make -j1 download V=s
        fi
        
        # éªŒè¯å…³é”®æ–‡ä»¶
        echo "=== éªŒè¯å…³é”®æ–‡ä»¶ ==="
        CRITICAL_FILES=("lz4" "zlib" "openssl" "libtool" "automake")
        for file in "${CRITICAL_FILES[@]}"; do
          if find dl -name "*${file}*" | grep -q .; then
            echo "âœ… æ‰¾åˆ°å…³é”®æ–‡ä»¶: $file"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å…³é”®æ–‡ä»¶: $file"
          fi
        done
        
        DL_COUNT=$(find dl -type f | wc -l)
        DL_SIZE=$(du -sh dl | cut -f1)
        echo "âœ… ä¸‹è½½ç»Ÿè®¡: $DL_COUNT ä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°: $DL_SIZE"

    - name: éªŒè¯è½¯ä»¶åŒ…é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== éªŒè¯è½¯ä»¶åŒ…é…ç½® ==="
        
        # æ£€æŸ¥å…³é”®è½¯ä»¶åŒ…æ˜¯å¦è¢«æ­£ç¡®é…ç½®
        echo "=== å…³é”®è½¯ä»¶åŒ…é…ç½®çŠ¶æ€ ==="
        
        # åŸºç¡€è½¯ä»¶åŒ…
        for pkg in "luci" "luci-base" "luci-theme-bootstrap"; do
          if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
            echo "âœ… $pkg: å·²å¯ç”¨"
          else
            echo "âŒ $pkg: æœªå¯ç”¨"
          fi
        done
        
        # ä¸­æ–‡è¯­è¨€åŒ…
        for pkg in "luci-i18n-base-zh-cn" "luci-i18n-firewall-zh-cn"; do
          if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
            echo "âœ… $pkg: å·²å¯ç”¨"
          else
            echo "âŒ $pkg: æœªå¯ç”¨"
          fi
        done
        
        # æ ¹æ®é…ç½®ç±»åž‹æ£€æŸ¥æ’ä»¶
        if [ "${{ github.event.inputs.config_type }}" = "normal" ] || [ "${{ github.event.inputs.config_type }}" = "custom" ]; then
          echo "=== æ­£å¸¸æ¨¡å¼æ’ä»¶æ£€æŸ¥ ==="
          for pkg in "luci-app-turboacc" "luci-app-sqm" "luci-app-upnp"; do
            if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
              echo "âœ… $pkg: å·²å¯ç”¨"
            else
              echo "âŒ $pkg: æœªå¯ç”¨"
            fi
          done
        fi
        
        echo "=== é…ç½®éªŒè¯å®Œæˆ ==="

    - name: åº”ç”¨é…ç½®å¹¶ç¼–è¯‘
      run: |
        cd $BUILD_DIR
        echo "::group::ðŸ“± ç¼–è¯‘æ—¥å¿—"
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        
        export FORCE_UNSAFE_CONFIGURE=1
        
        # æ›´ä¿å®ˆçš„å¹¶è¡Œè®¾ç½®ï¼Œé¿å…å†…å­˜ä¸è¶³
        AVAILABLE_CORES=$(nproc)
        AVAILABLE_MEMORY_GB=$(free -g | awk 'NR==2{print $2}')
        
        if [ $AVAILABLE_MEMORY_GB -ge 16 ] && [ $AVAILABLE_CORES -ge 8 ]; then
            BUILD_JOBS=$((AVAILABLE_CORES - 3))
            echo "âœ… é«˜æ€§èƒ½æ¨¡å¼: ä½¿ç”¨ $BUILD_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡ (å†…å­˜: ${AVAILABLE_MEMORY_GB}G)"
        elif [ $AVAILABLE_MEMORY_GB -ge 8 ] && [ $AVAILABLE_CORES -ge 4 ]; then
            BUILD_JOBS=$((AVAILABLE_CORES - 2))
            echo "âœ… å¹³è¡¡æ¨¡å¼: ä½¿ç”¨ $BUILD_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡ (å†…å­˜: ${AVAILABLE_MEMORY_GB}G)"
        else
            BUILD_JOBS=2
            echo "âœ… ä¿å®ˆæ¨¡å¼: ä½¿ç”¨ $BUILD_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡ (å†…å­˜: ${AVAILABLE_MEMORY_GB}G)"
        fi
        
        echo "ðŸš€ å¼€å§‹åˆ†é˜¶æ®µç¼–è¯‘..."
        START_TIME=$(date +%s)
        
        # åˆ†é˜¶æ®µç¼–è¯‘ï¼Œæé«˜ç¨³å®šæ€§
        echo "=== é˜¶æ®µ1: ç¼–è¯‘å·¥å…·é“¾ ==="
        make -j$BUILD_JOBS tools/compile V=s 2>&1 | tee -a build_detailed.log
        
        echo "=== é˜¶æ®µ2: ç¼–è¯‘å·¥å…· ==="
        make -j$BUILD_JOBS toolchain/compile V=s 2>&1 | tee -a build_detailed.log
        
        echo "=== é˜¶æ®µ3: å®Œæ•´ç¼–è¯‘ ==="
        set +e
        time make -j$BUILD_JOBS V=s 2>&1 | tee -a build_detailed.log
        COMPILE_EXIT_CODE=$?
        set -e
        
        END_TIME=$(date +%s)
        
        COMPILE_TIME=$((END_TIME - START_TIME))
        echo "=== ç¼–è¯‘æ—¶é—´ç»Ÿè®¡ ==="
        echo "æ€»ç¼–è¯‘æ—¶é—´: $((COMPILE_TIME / 60))åˆ†é’Ÿ$((COMPILE_TIME % 60))ç§’"
        
        if [ -d "bin/targets" ]; then
            echo "::endgroup::"
            echo "::notice::ðŸŽ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
            echo "âœ… ç¼–è¯‘å®Œæˆï¼Œæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶"
            FIRMWARE_LIST=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | sort)
            if [ -n "$FIRMWARE_LIST" ]; then
                echo "ðŸŽ‰ ç”Ÿæˆçš„å›ºä»¶:"
                echo "$FIRMWARE_LIST"
            fi
            if [ $COMPILE_EXIT_CODE -ne 0 ]; then
                echo "âš ï¸ ç¼–è¯‘è¿‡ç¨‹æœ‰è­¦å‘Šï¼Œä½†ç”Ÿæˆäº†å›ºä»¶æ–‡ä»¶"
            fi
        else
            echo "::endgroup::"
            echo "::notice::âŒ ç¼–è¯‘å¤±è´¥"
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆç›®æ ‡æ–‡ä»¶"
            if [ $COMPILE_EXIT_CODE -eq 0 ]; then
                echo "âŒ ç¼–è¯‘å‘½ä»¤æˆåŠŸä½†æœªç”Ÿæˆç›®æ ‡æ–‡ä»¶"
                echo "=== æž„å»ºç›®å½•ç»“æž„ ==="
                find . -maxdepth 3 -type d | sort | head -20
            fi
            exit 1
        fi

    - name: è¿è¡Œé”™è¯¯åˆ†æž
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== è¿è¡Œé”™è¯¯åˆ†æž ==="
        
        # ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤åˆ›å»ºå¢žå¼ºç‰ˆé”™è¯¯åˆ†æžè„šæœ¬
        echo '#!/bin/bash' > enhanced_error_analysis.sh
        echo 'set -e' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo 'BUILD_DIR="${1:-.}"' >> enhanced_error_analysis.sh
        echo 'LOG_FILE="$BUILD_DIR/build_detailed.log"' >> enhanced_error_analysis.sh
        echo 'REPORT_FILE="$BUILD_DIR/enhanced_error_analysis.log"' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo 'echo "=== å¢žå¼ºç‰ˆå›ºä»¶æž„å»ºé”™è¯¯åˆ†æžæŠ¥å‘Š ===" > "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'echo "ç”Ÿæˆæ—¶é—´: $(date)" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'echo "" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo '# é…ç½®éªŒè¯' >> enhanced_error_analysis.sh
        echo 'echo "=== é…ç½®éªŒè¯ç»“æžœ ===" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'if [ -f "$BUILD_DIR/.config" ]; then' >> enhanced_error_analysis.sh
        echo '    for pkg in "luci" "luci-base" "luci-theme-bootstrap" "luci-i18n-base-zh-cn" "luci-i18n-firewall-zh-cn" "luci-app-turboacc" "luci-app-sqm" "luci-app-upnp"; do' >> enhanced_error_analysis.sh
        echo '        if grep -q "CONFIG_PACKAGE_${pkg}=y" "$BUILD_DIR/.config"; then' >> enhanced_error_analysis.sh
        echo '            echo "âœ… $pkg: å·²å¯ç”¨" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '        else' >> enhanced_error_analysis.sh
        echo '            echo "âŒ $pkg: æœªå¯ç”¨" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '        fi' >> enhanced_error_analysis.sh
        echo '    done' >> enhanced_error_analysis.sh
        echo 'else' >> enhanced_error_analysis.sh
        echo '    echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'fi' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo '# é”™è¯¯åˆ†ç±»ç»Ÿè®¡' >> enhanced_error_analysis.sh
        echo 'echo "" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'echo "=== é”™è¯¯åˆ†ç±»ç»Ÿè®¡ ===" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo 'ERROR_TYPES=("ç¼–è¯‘é”™è¯¯:error:" "è­¦å‘Š:warning:" "ç½‘ç»œé”™è¯¯:curl.*404" "Makeé”™è¯¯:make.*Error" "æ–‡ä»¶ç¼ºå¤±:No such file" "ç®¡é“é”™è¯¯:Broken pipe" "ä¾èµ–ç¼ºå¤±:requires")' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo 'for error_type in "${ERROR_TYPES[@]}"; do' >> enhanced_error_analysis.sh
        echo '    name="${error_type%:*}"' >> enhanced_error_analysis.sh
        echo '    pattern="${error_type#*:}"' >> enhanced_error_analysis.sh
        echo '    count=$(grep -c "$pattern" "$LOG_FILE" 2>/dev/null || echo "0")' >> enhanced_error_analysis.sh
        echo '    echo "- $name: $count" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'done' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo '# å…³é”®é”™è¯¯è¯¦æƒ…' >> enhanced_error_analysis.sh
        echo 'echo "" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'echo "=== å…³é”®é”™è¯¯è¯¦æƒ… ===" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo 'if grep -q "curl.*404" "$LOG_FILE" 2>/dev/null; then' >> enhanced_error_analysis.sh
        echo '    echo "âŒ ç½‘ç»œä¸‹è½½é”™è¯¯:" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    grep "curl.*404" "$LOG_FILE" | head -5 | sed "s/^/  /" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'fi' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo 'if grep -q "groff.*fatal error" "$LOG_FILE" 2>/dev/null; then' >> enhanced_error_analysis.sh
        echo '    echo "âŒ ç¼–è¯‘çŽ¯å¢ƒé”™è¯¯:" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    grep "groff.*fatal error" "$LOG_FILE" | head -3 >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    echo "ðŸ’¡ è§£å†³æ–¹æ¡ˆ: å®‰è£… groff åŒ…: sudo apt-get install groff" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'fi' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo '# æž„å»ºç»“æžœæ€»ç»“' >> enhanced_error_analysis.sh
        echo 'echo "" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'echo "=== æž„å»ºç»“æžœæ€»ç»“ ===" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'if [ -d "$BUILD_DIR/bin/targets" ]; then' >> enhanced_error_analysis.sh
        echo '    echo "âœ… æž„å»ºçŠ¶æ€: æˆåŠŸ" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    echo "âœ… ç”Ÿæˆçš„å›ºä»¶:" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    find "$BUILD_DIR/bin/targets" -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'else' >> enhanced_error_analysis.sh
        echo '    echo "âŒ æž„å»ºçŠ¶æ€: å¤±è´¥" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'fi' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo '# ä¿®å¤å»ºè®®' >> enhanced_error_analysis.sh
        echo 'echo "" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'echo "=== ä¿®å¤å»ºè®® ===" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo 'if grep -q "luci.*æœªå¯ç”¨" "$REPORT_FILE"; then' >> enhanced_error_analysis.sh
        echo '    echo "ðŸ”§ Luciç»„ä»¶æœªå¯ç”¨ä¿®å¤:" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    echo "  1. æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­ Luci ç›¸å…³é€‰é¡¹" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    echo "  2. ç¡®ä¿åœ¨ make defconfig åŽæ‰‹åŠ¨å¯ç”¨" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    echo "  3. ä½¿ç”¨ sed å‘½ä»¤å¼ºåˆ¶å¯ç”¨: sed -i '"'"'s/# CONFIG_PACKAGE_luci is not set/CONFIG_PACKAGE_luci=y/'"'"' .config" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'fi' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo 'if grep -q "curl.*404" "$LOG_FILE" 2>/dev/null; then' >> enhanced_error_analysis.sh
        echo '    echo "ðŸ”§ ç½‘ç»œä¸‹è½½é—®é¢˜ä¿®å¤:" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    echo "  1. ä½¿ç”¨å›½å†…é•œåƒæº" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    echo "  2. æ‰‹åŠ¨é¢„ä¸‹è½½å¤±è´¥åŒ…" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo '    echo "  3. å¢žåŠ ä¸‹è½½é‡è¯•æ¬¡æ•°" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        echo 'fi' >> enhanced_error_analysis.sh
        echo '' >> enhanced_error_analysis.sh
        echo 'echo "âœ… é”™è¯¯åˆ†æžå®Œæˆ" >> "$REPORT_FILE"' >> enhanced_error_analysis.sh
        
        chmod +x enhanced_error_analysis.sh
        ./enhanced_error_analysis.sh "$BUILD_DIR"
        
        # æ˜¾ç¤ºå…³é”®ä¿¡æ¯
        if [ -f "enhanced_error_analysis.log" ]; then
            echo "=== å…³é”®é”™è¯¯æ‘˜è¦ ==="
            grep -E "âŒ|âœ…|ðŸ’¡|ðŸ”§" enhanced_error_analysis.log | head -20
        fi

    - name: éªŒè¯å›ºä»¶ç”Ÿæˆ
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== å›ºä»¶ç”ŸæˆéªŒè¯ ==="
        if [ -d "bin/targets" ]; then
          echo "âœ… æž„å»ºæˆåŠŸï¼ç”Ÿæˆçš„å›ºä»¶:"
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) | sort
          for firmware in $(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null); do
            echo "å›ºä»¶: $firmware"
            echo "å¤§å°: $(du -h "$firmware" | cut -f1)"
            echo ""
          done
        else
          echo "âŒ æž„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶"
        fi

    - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Šæ–‡æ¡£
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== ç”Ÿæˆæž„å»ºæŠ¥å‘Šæ–‡æ¡£ ==="
        
        # ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤åˆ›å»ºæž„å»ºæŠ¥å‘Š
        echo "# OpenWrt å›ºä»¶æž„å»ºæŠ¥å‘Š" > "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "## æž„å»ºä¿¡æ¯" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "- **è®¾å¤‡**: ${{ env.DEVICE_FULL_NAME }}" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "- **å¹³å°**: ${{ env.PLATFORM }}" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "- **ç‰ˆæœ¬**: ${{ env.SELECTED_REPO }} (${{ env.SELECTED_BRANCH }})" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "- **é…ç½®ç±»åž‹**: ${{ github.event.inputs.config_type }}" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "- **æž„å»ºæ—¶é—´**: $(date)" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "- **ç¼–è¯‘æ—¶é•¿**: $((COMPILE_TIME / 60))åˆ†é’Ÿ$((COMPILE_TIME % 60))ç§’" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "## æž„å»ºçŠ¶æ€" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        
        if [ -d "bin/targets" ]; then
            echo "âœ… **æž„å»ºçŠ¶æ€**: æˆåŠŸ" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            echo "" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            echo "## ç”Ÿæˆçš„å›ºä»¶" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            find bin/targets -name "*.bin" -o -name "*.img" | while read firmware; do
                FIRMWARE_NAME=$(basename "$firmware")
                FIRMWARE_SIZE=$(du -h "$firmware" | cut -f1)
                echo "- **$FIRMWARE_NAME** ($FIRMWARE_SIZE)" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            done
            
            echo "" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            echo "## åŒ…å«çš„åŠŸèƒ½" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            
            # åŠ¨æ€æ£€æŸ¥å®žé™…åŒ…å«çš„åŒ…
            if grep -q "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" .config; then
                echo "- âœ… ä¸­æ–‡ç•Œé¢æ”¯æŒ" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            else
                echo "- âŒ ä¸­æ–‡ç•Œé¢æ”¯æŒ" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            fi
            
            echo "- âœ… Bootstrapä¸»é¢˜" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            
            if [ "${{ github.event.inputs.config_type }}" = "normal" ] || [ "${{ github.event.inputs.config_type }}" = "custom" ]; then
                if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
                    echo "- âœ… TurboACCç½‘ç»œåŠ é€Ÿ" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
                else
                    echo "- âŒ TurboACCç½‘ç»œåŠ é€Ÿ" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
                fi
                if grep -q "CONFIG_PACKAGE_luci-app-sqm=y" .config; then
                    echo "- âœ… SQMæ™ºèƒ½é˜Ÿåˆ—ç®¡ç†" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
                else
                    echo "- âŒ SQMæ™ºèƒ½é˜Ÿåˆ—ç®¡ç†" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
                fi
                echo "- âœ… UPnPè‡ªåŠ¨ç«¯å£æ˜ å°„" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            fi
            
            if [ "${{ github.event.inputs.custom_install }}" = "true" ]; then
                echo "" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
                echo "## è‡ªå®šä¹‰å®‰è£…" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
                echo "- âœ… è‡ªåŠ¨å®‰è£…è‡ªå®šä¹‰IPKåŒ…" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
                echo "- âœ… è‡ªåŠ¨æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
                echo "- âš ï¸ æ³¨æ„: è‡ªå®šä¹‰å®‰è£…å°†åœ¨é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            fi
        else
            echo "âŒ **æž„å»ºçŠ¶æ€**: å¤±è´¥" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            echo "" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            echo "## é”™è¯¯ä¿¡æ¯" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            if [ -f "build_detailed.log" ]; then
                grep -E "error:|Error" build_detailed.log | head -10 >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
            fi
        fi
        
        echo "" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "## åˆ·æœºè¯´æ˜Ž" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "1. ä¸‹è½½å¯¹åº”çš„å›ºä»¶æ–‡ä»¶" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "2. è¿›å…¥è·¯ç”±å™¨ç®¡ç†ç•Œé¢ â†’ ç³»ç»Ÿ â†’ å¤‡ä»½/å‡çº§" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "3. é€‰æ‹©å›ºä»¶æ–‡ä»¶è¿›è¡Œåˆ·æœº" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        echo "4. ç­‰å¾…è·¯ç”±å™¨é‡å¯å®Œæˆ" >> "$GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md"
        
        echo "âœ… æž„å»ºæŠ¥å‘Šå·²ç”Ÿæˆ"

    - name: ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“
      if: success() && github.event.inputs.save_config == 'true'
      run: |
        echo "=== ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“ ==="
        CONFIG_FILENAME="${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}.config"
        mkdir -p $GITHUB_WORKSPACE/firmware-config/configs
        
        if [ ! -f "$BUILD_DIR/.config" ]; then
          echo "âŒ é”™è¯¯: æºé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        if [ -f "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" ]; then
          if diff -q "$BUILD_DIR/.config" "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" >/dev/null; then
            echo "â„¹ï¸ é…ç½®æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡ä¿å­˜"
            echo "CONFIG_UNCHANGED=true" >> $GITHUB_ENV
            exit 0
          else
            echo "âœ… æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œå°†ä¿å­˜æ–°é…ç½®"
          fi
        else
          echo "âœ… é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°é…ç½®"
        fi
        
        cp $BUILD_DIR/.config $GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME
        
        if [ -f "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" ]; then
          echo "âœ… é…ç½®æ–‡ä»¶å·²ä¿å­˜ä¸º: firmware-config/configs/$CONFIG_FILENAME"
          echo "CONFIG_UNCHANGED=false" >> $GITHUB_ENV
        else
          echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¿å­˜å¤±è´¥"
          exit 1
        fi

    - name: æäº¤é…ç½®æ–‡ä»¶æ›´æ”¹
      if: success() && github.event.inputs.save_config == 'true' && env.CONFIG_UNCHANGED == 'false'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "=== æäº¤é…ç½®æ–‡ä»¶æ›´æ”¹ ==="
        cd $GITHUB_WORKSPACE
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
        git add firmware-config/configs/
        git add "æž„å»ºæŠ¥å‘Š.md" 2>/dev/null || true
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰é…ç½®æ–‡ä»¶æ›´æ”¹éœ€è¦æäº¤"
          exit 0
        fi
        
        git commit -m "è‡ªåŠ¨ä¿å­˜é…ç½®æ–‡ä»¶: ${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }} [skip ci]"
        git pull origin main --rebase --no-edit
        git push origin main
        
        echo "âœ… é…ç½®æ–‡ä»¶æäº¤å®Œæˆ"

    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_type }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®å’Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/build_detailed.log
          ${{ env.BUILD_DIR }}/enhanced_error_analysis.log
          ${{ env.BUILD_DIR }}/download_attempt_*.log
          $GITHUB_WORKSPACE/æž„å»ºæŠ¥å‘Š.md
        retention-days: 7

    - name: æ¸…ç†æž„å»ºç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†æž„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR
        echo "âœ… æž„å»ºç›®å½•å·²æ¸…ç†"
