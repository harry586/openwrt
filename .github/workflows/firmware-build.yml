name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'è®¾å¤‡åç§° (å¦‚: ac42uç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: 'auto'
        options:
          - auto
          - 23.05
          - 22.03
          - 21.02
          - 19.07
          - 18.06
          - master
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬'
        required: false
        type: string
        default: ''
      config_type:
        description: 'é…ç½®ç±»å‹'
        required: true
        default: 'normal'
        type: choice
        options:
          - minimal
          - normal
          - custom
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶'
        required: false
        type: string
      disabled_plugins:
        description: 'ç¦ç”¨æ’ä»¶'
        required: false
        type: string
        default: ''
      save_config:
        description: 'ä¿å­˜é…ç½®æ–‡ä»¶'
        required: false
        default: true
        type: boolean
      enable_cache:
        description: 'å¯ç”¨ç¼–è¯‘ç¼“å­˜'
        required: false
        default: true
        type: boolean
      multithreading:
        description: 'å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘'
        type: boolean
        default: true
      ssh_connection:
        description: 'ä½¿ç”¨ SSH è°ƒè¯•'
        type: boolean
        default: false

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    if: ${{ inputs.ssh_connection == false }}
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo
        pip3 install requests urllib3
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"

    - name: å¤åˆ¶æ„å»ºè„šæœ¬
      run: |
        echo "=== å¤åˆ¶æ„å»ºè„šæœ¬ ==="
        cd $GITHUB_WORKSPACE
        mkdir -p $BUILD_DIR/scripts
        mkdir -p $BUILD_DIR/config-templates
        
        # å¤åˆ¶ä¸»æ„å»ºç®¡ç†å™¨
        cp firmware-config/scripts/openwrt_build_manager.sh $BUILD_DIR/
        cp firmware-config/scripts/build_helpers.sh $BUILD_DIR/
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp firmware-config/configs/*.config $BUILD_DIR/config-templates/
        
        cd $BUILD_DIR
        chmod +x *.sh
        echo "âœ… è„šæœ¬å¤åˆ¶å®Œæˆ"

    - name: æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ ==="
        
        # è®¾ç½®è€æ—§è®¾å¤‡æ ‡å¿—
        OLD_DEVICE_FLAG="false"
        case "${{ github.event.inputs.device_name }}" in
            "wr841n"|"wr842n"|"wr941n"|"mr3420"|"ar71xx"*)
                OLD_DEVICE_FLAG="true"
                echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§è®¾å¤‡"
                ;;
        esac
        
        # ç¡®å®šç‰ˆæœ¬å‚æ•°
        USER_VERSION=""
        if [ -n "${{ inputs.custom_version }}" ]; then
            USER_VERSION="${{ inputs.custom_version }}"
        elif [ "${{ inputs.version_selection }}" != "auto" ]; then
            USER_VERSION="${{ inputs.version_selection }}"
        fi
        
        echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬: ${USER_VERSION:-è‡ªåŠ¨}"
        echo "è€æ—§è®¾å¤‡: $OLD_DEVICE_FLAG"
        
        # è°ƒç”¨ç‰ˆæœ¬æ£€æµ‹
        OUTPUT=$(./openwrt_build_manager.sh version_detect "${{ github.event.inputs.device_name }}" "$USER_VERSION" "$OLD_DEVICE_FLAG")
        echo "$OUTPUT"
        
        # æå–ç¯å¢ƒå˜é‡
        SELECTED_REPO=$(echo "$OUTPUT" | grep "^SELECTED_REPO=" | head -1 | cut -d'=' -f2)
        SELECTED_BRANCH=$(echo "$OUTPUT" | grep "^SELECTED_BRANCH=" | head -1 | cut -d'=' -f2)
        SELECTED_REPO_URL=$(echo "$OUTPUT" | grep "^SELECTED_REPO_URL=" | head -1 | cut -d'=' -f2)
        
        if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            echo "âœ… ç‰ˆæœ¬æ£€æµ‹å®Œæˆ"
        else
            echo "âŒ ç‰ˆæœ¬æ£€æµ‹å¤±è´¥"
            exit 1
        fi

    - name: å…‹éš†æºç 
      run: |
        cd $BUILD_DIR
        echo "=== å…‹éš†æºç  ==="
        echo "ä»“åº“: $SELECTED_REPO_URL"
        echo "åˆ†æ”¯: $SELECTED_BRANCH"
        
        # æ¸…ç†ç›®å½•
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        
        # å…‹éš†æºç 
        if git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .; then
            echo "âœ… æºç å…‹éš†å®Œæˆ"
        else
            echo "âŒ æºç å…‹éš†å¤±è´¥"
            exit 1
        fi

    - name: æ¢å¤æ„å»ºè„šæœ¬
      run: |
        cd $BUILD_DIR
        echo "=== æ¢å¤æ„å»ºè„šæœ¬ ==="
        
        # ç¡®ä¿å¿…è¦çš„ç›®å½•å­˜åœ¨
        mkdir -p config-templates
        mkdir -p scripts
        
        cd $GITHUB_WORKSPACE
        
        # å¤åˆ¶ä¸»æ„å»ºç®¡ç†å™¨
        cp firmware-config/scripts/openwrt_build_manager.sh $BUILD_DIR/
        cp firmware-config/scripts/build_helpers.sh $BUILD_DIR/
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp firmware-config/configs/*.config $BUILD_DIR/config-templates/
        
        cd $BUILD_DIR
        chmod +x *.sh
        echo "âœ… è„šæœ¬æ¢å¤å®Œæˆ"

    - name: æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥
      run: |
        cd $BUILD_DIR
        echo "=== æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥ ==="
        ./openwrt_build_manager.sh plugin_check "$SELECTED_BRANCH"

    - name: Feeds é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== Feeds é…ç½® ==="
        ./openwrt_build_manager.sh feeds_config "$SELECTED_BRANCH"

    - name: æ›´æ–°å®‰è£… Feeds
      run: |
        cd $BUILD_DIR
        echo "=== æ›´æ–°å®‰è£… Feeds ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… Feeds æ›´æ–°å®‰è£…å®Œæˆ"

    - name: åŒ…å¯ç”¨æ€§æ£€æŸ¥ (ä¸¥æ ¼æ¨¡å¼)
      id: package-check
      run: |
        cd $BUILD_DIR
        echo "=== åŒ…å¯ç”¨æ€§æ£€æŸ¥ ==="
        
        # é¦–å…ˆè¿è¡ŒåŒ…è¯Šæ–­
        echo "=== è¿è¡ŒåŒ…è¯Šæ–­ ==="
        ./build_helpers.sh diagnose_packages "."
        DIAGNOSE_EXIT_CODE=$?
        
        if [ $DIAGNOSE_EXIT_CODE -ne 0 ]; then
            echo "âŒ åŒ…è¯Šæ–­å‘ç°ç¼ºå¤±åŒ…ï¼Œåœæ­¢æ„å»º"
            exit 1
        fi
        
        # ç„¶åè¿è¡ŒåŒ…æ£€æŸ¥
        echo "=== è¿è¡ŒåŒ…æ£€æŸ¥ ==="
        OUTPUT=$(./openwrt_build_manager.sh package_check ".")
        PACKAGE_CHECK_EXIT_CODE=$?
        
        echo "$OUTPUT"
        
        if [ $PACKAGE_CHECK_EXIT_CODE -eq 0 ]; then
            echo "âœ… åŒ…æ£€æŸ¥é€šè¿‡"
        else
            echo "âŒ åŒ…æ£€æŸ¥å‘ç°ç¼ºå¤±åŒ…ï¼Œåœæ­¢æ„å»º"
            exit $PACKAGE_CHECK_EXIT_CODE
        fi

    - name: è®¾å¤‡æ£€æµ‹
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== è®¾å¤‡æ£€æµ‹ ==="
        
        OUTPUT=$(./openwrt_build_manager.sh device_detect "${{ github.event.inputs.device_name }}")
        echo "$OUTPUT"
        
        # æå–è®¾å¤‡ä¿¡æ¯
        PLATFORM=$(echo "$OUTPUT" | grep "^PLATFORM=" | head -1 | cut -d'=' -f2)
        DEVICE_SHORT_NAME=$(echo "$OUTPUT" | grep "^DEVICE_SHORT_NAME=" | head -1 | cut -d'=' -f2)
        DEVICE_FULL_NAME=$(echo "$OUTPUT" | grep "^DEVICE_FULL_NAME=" | head -1 | cut -d'=' -f2)
        
        if [ -n "$PLATFORM" ] && [ -n "$DEVICE_SHORT_NAME" ] && [ -n "$DEVICE_FULL_NAME" ]; then
            echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
            echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
            echo "âœ… è®¾å¤‡æ£€æµ‹å®Œæˆ"
        else
            echo "âŒ è®¾å¤‡æ£€æµ‹å¤±è´¥"
            exit 1
        fi

    - name: é…ç½®åŠ è½½å’Œå†²çªè§£å†³
      run: |
        cd $BUILD_DIR
        echo "=== é…ç½®åŠ è½½å’Œå†²çªè§£å†³ ==="
        ./openwrt_build_manager.sh config_load \
            "${{ inputs.config_type }}" \
            "$PLATFORM" \
            "$DEVICE_SHORT_NAME" \
            "$SELECTED_BRANCH" \
            "${{ github.event.inputs.device_name }}" \
            "${{ inputs.extra_packages }}" \
            "${{ inputs.disabled_plugins }}"

    - name: è‡ªå®šä¹‰æ–‡ä»¶é›†æˆ
      run: |
        cd $BUILD_DIR
        echo "=== è‡ªå®šä¹‰æ–‡ä»¶é›†æˆ ==="
        ./openwrt_build_manager.sh custom_integrate "$GITHUB_WORKSPACE"

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        echo "âœ… ç½‘ç»œç¯å¢ƒä¿®å¤å®Œæˆ"

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd $BUILD_DIR
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        export MAKE_JOBS=${{ inputs.multithreading && '$(nproc)' || '1' }}
        make -j$MAKE_JOBS download
        echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶ (å¸¦è¯¦ç»†æ—¥å¿—)
      run: |
        cd $BUILD_DIR
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        export MAKE_JOBS=${{ inputs.multithreading && '$(nproc)' || '1' }}
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        mkdir -p logs
        
        if [ "${{ inputs.enable_cache }}" = "true" ]; then
            echo "ğŸ”„ å¯ç”¨ç¼–è¯‘ç¼“å­˜"
            # ä¿å­˜è¯¦ç»†æ—¥å¿—
            make -j$MAKE_JOBS V=s 2>&1 | tee logs/build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        else
            echo "ğŸ”„ æ™®é€šç¼–è¯‘æ¨¡å¼"
            make -j$MAKE_JOBS V=s 2>&1 | tee logs/build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        fi
        
        echo "ç¼–è¯‘é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
            exit $BUILD_EXIT_CODE
        fi
        echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"

    - name: é”™è¯¯åˆ†æ
      if: failure()
      run: |
        cd $BUILD_DIR
        echo "=== é”™è¯¯åˆ†æ ==="
        ./openwrt_build_manager.sh error_analyze "."

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        if [ -d "bin/targets" ]; then
            echo "âœ… å›ºä»¶ç›®å½•å­˜åœ¨"
            find bin/targets -name "*.bin" -o -name "*.img" | while read file; do
                echo "ğŸ“¦ å›ºä»¶æ–‡ä»¶: $file ($(du -h "$file" | cut -f1))"
            done
        else
            echo "âŒ å›ºä»¶ç›®å½•ä¸å­˜åœ¨"
            exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: å›ºä»¶-${{ github.event.inputs.device_name }}-$SELECTED_BRANCH-${{ inputs.config_type }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•å·²æ¸…ç†"

  build-firmware-ssh:
    if: ${{ inputs.ssh_connection == true }}
    name: ğŸš€ ç¼–è¯‘ - SSHè°ƒè¯•ç‰ˆ
    runs-on: ubuntu-22.04
    steps:
    - name: å¼€å¯ SSH æœåŠ¡
      uses: lhotari/action-upterm@v1
      with:
        wait-timeout-minutes: 30
    - name: ç¼–è¯‘å‰æç¤º
      run: |
        echo "ğŸš€ SSHè°ƒè¯•æ¨¡å¼å·²å¯åŠ¨"
