name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´ä¿®å¤ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§°'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
          - '23.05'
          - '21.02'
      config_mode:
        description: 'âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©'
        required: true
        type: choice
        default: 'normal'
        options:
          - 'base'
          - 'normal'
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶'
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  SCRIPT_DIR: ./scripts  # ä¿®å¤ï¼šæ”¹ä¸ºç›¸å¯¹è·¯å¾„

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ç§»é™¤ path å‚æ•°ï¼Œè®©ä»“åº“æ£€å‡ºåˆ°å½“å‰ç›®å½•
          # path: firmware-config  # ç§»é™¤è¿™ä¸€è¡Œ

      - name: è®¾ç½®è„šæœ¬æƒé™
        run: |
          echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la
          echo "scriptsç›®å½•å†…å®¹:"
          ls -la scripts/
          chmod -R +x scripts/
          echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"

      - name: åˆå§‹ç©ºé—´æ£€æŸ¥
        run: |
          echo "=== åˆå§‹ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
            exit 1
          fi
          echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"

      - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        run: |
          scripts/build_firmware_main.sh setup_environment  # ä¿®å¤ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„

      - name: åˆ›å»ºæ„å»ºç›®å½•
        run: |
          scripts/build_firmware_main.sh create_build_dir

      - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
        run: |
          scripts/build_firmware_main.sh initialize_build_env \
            "${{ github.event.inputs.device_name }}" \
            "${{ github.event.inputs.version_selection }}" \
            "${{ github.event.inputs.config_mode }}"

      - name: æ·»åŠ  TurboACC æ”¯æŒ
        run: |
          scripts/build_firmware_main.sh add_turboacc_support

      - name: é…ç½®Feeds
        run: |
          scripts/build_firmware_main.sh configure_feeds

      - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
        run: |
          scripts/build_firmware_main.sh pre_build_space_check

      - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
        run: |
          scripts/build_firmware_main.sh generate_config \
            "${{ github.event.inputs.extra_packages }}"

      - name: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
        run: |
          scripts/build_firmware_main.sh integrate_custom_files

      - name: éªŒè¯USBé…ç½®
        run: |
          scripts/build_firmware_main.sh verify_usb_config

      - name: åº”ç”¨é…ç½®ï¼ˆè¯¦ç»†ï¼‰
        run: |
          scripts/build_firmware_main.sh apply_config

      - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
        run: |
          scripts/build_firmware_main.sh fix_network

      - name: ä¸‹è½½ä¾èµ–åŒ…
        run: |
          scripts/build_firmware_main.sh download_dependencies

      - name: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆå¢å¼ºç‰ˆï¼‰
        run: |
          scripts/build_firmware_main.sh pre_build_check

      - name: å·¥å…·é“¾ç®¡ç†ï¼ˆæ£€æŸ¥ï¼‰
        run: |
          scripts/build_firmware_main.sh toolchain_manager check || \
          echo "â„¹ï¸ å·¥å…·é“¾ä¸å­˜åœ¨æˆ–éœ€è¦é‡æ–°ç”Ÿæˆ"

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          scripts/build_firmware_main.sh build_firmware \
            "${{ github.event.inputs.enable_cache }}"

      - name: é”™è¯¯åˆ†æ
        if: failure()
        run: |
          scripts/error_analysis.sh "$BUILD_DIR"

      - name: ä¿å­˜å·¥å…·é“¾ï¼ˆè¯¦ç»†ï¼‰
        if: success()
        run: |
          echo "=== ä¿å­˜å·¥å…·é“¾ ==="
          echo "å·¥ä½œç©ºé—´: $(pwd)"
          echo "ä»“åº“åç§°: ${{ github.repository }}"
          
          # æ‰§è¡Œä¿å­˜æ“ä½œ
          scripts/build_firmware_main.sh toolchain_manager save

      - name: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
        run: |
          scripts/build_firmware_main.sh post_build_space_check

      - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
        if: success()
        run: |
          scripts/build_firmware_main.sh check_firmware_files

      - name: æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if: always()
        run: |
          echo "=== æ£€æŸ¥é…ç½®æ–‡ä»¶ ==="
          if [ -f "$BUILD_DIR/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            echo "æ–‡ä»¶å¤§å°: $(du -h $BUILD_DIR/.config | cut -f1)"
            echo "é…ç½®è¡Œæ•°: $(wc -l < $BUILD_DIR/.config)"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            echo "å°è¯•æŸ¥æ‰¾å…¶ä»–é…ç½®æ–‡ä»¶..."
            ls -la $BUILD_DIR/.config* 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
            
            # å°è¯•æ¢å¤å¤‡ä»½
            if [ -f "$BUILD_DIR/.config.backup" ]; then
              echo "æ¢å¤å¤‡ä»½é…ç½®æ–‡ä»¶"
              cp "$BUILD_DIR/.config.backup" "$BUILD_DIR/.config"
              echo "âœ… é…ç½®æ–‡ä»¶å·²ä»å¤‡ä»½æ¢å¤"
            fi
          fi

      - name: ä¸Šä¼ å›ºä»¶
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7

      - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}
          path: |
            ${{ env.BUILD_DIR }}/build.log
            ${{ env.BUILD_DIR }}/compile.log
            ${{ env.BUILD_DIR }}/error_analysis.log
          retention-days: 7

      - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}
          path: |
            ${{ env.BUILD_DIR }}/.config
            ${{ env.BUILD_DIR }}/.config.backup
            ${{ env.BUILD_DIR }}/.config.old
            ${{ env.BUILD_DIR }}/build_env.sh
          retention-days: 7

      - name: æ¸…ç†ç›®å½•
        if: always()
        run: |
          scripts/build_firmware_main.sh cleanup
