name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆä¿®å¤ä¼˜å…ˆç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, acrh17, r3gç­‰)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®"
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚"
        required: false
        type: string
        default: ""
      enable_cache:
        description: "âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)"
        required: false
        default: true
        type: boolean
      commit_toolchain:
        description: "ğŸ’¾ æäº¤å·¥å…·é“¾åˆ°ä»“åº“ (èŠ‚çœä¸‹æ¬¡ç¼–è¯‘æ—¶é—´)"
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  GIT_LFS_SKIP_SMUDGE: 1
  ENABLE_CACHE: "true"
  COMMIT_TOOLCHAIN: "true"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # ========== ç¬¬1é˜¶æ®µï¼šä¿®å¤ä¼˜å…ˆ ==========
      
      # æ­¥éª¤0ï¼šæ™ºèƒ½æŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰
      - name: "ğŸ”§ 0. æ™ºèƒ½æŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬"
        id: run_fix_script
        env:
          GIT_COMMITTER_NAME: "GitHub Actions Bot"
          GIT_COMMITTER_EMAIL: "actions@github.com"
          GIT_AUTHOR_NAME: "GitHub Actions Bot"
          GIT_AUTHOR_EMAIL: "actions@github.com"
        run: |
          echo "=== å¼€å§‹æŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬ ==="
          FIX_SCRIPT=""
          SEARCH_PATHS=("firmware-config/scripts/fix-build.sh" ".github/scripts/fix-build.sh" "scripts/fix-build.sh" "fix-build.sh" "$(pwd)/fix-build.sh")
          
          for script_path in "${SEARCH_PATHS[@]}"; do
            if [ -f "$script_path" ]; then
              FIX_SCRIPT="$script_path"
              echo "âœ… æ‰¾åˆ°ä¿®å¤è„šæœ¬: $script_path"
              break
            fi
          done
          
          if [ -z "$FIX_SCRIPT" ]; then
            echo "å°è¯•æ¨¡ç³Šæœç´¢ä¿®å¤è„šæœ¬..."
            FOUND_SCRIPTS=$(find . -name "*fix*.sh" -type f 2>/dev/null | head -5)
            if [ -n "$FOUND_SCRIPTS" ]; then
              FIX_SCRIPT=$(echo "$FOUND_SCRIPTS" | head -1)
              echo "âœ… æ¨¡ç³Šæ‰¾åˆ°ä¿®å¤è„šæœ¬: $FIX_SCRIPT"
            fi
          fi
          
          if [ -n "$FIX_SCRIPT" ] && [ -f "$FIX_SCRIPT" ]; then
            echo "è¿è¡Œä¿®å¤è„šæœ¬: $FIX_SCRIPT"
            chmod +x "$FIX_SCRIPT"
            timeout 300 bash "$FIX_SCRIPT"
            FIX_EXIT_CODE=$?
            
            if [ $FIX_EXIT_CODE -eq 0 ]; then
              echo "âœ… ä¿®å¤è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
              echo "fix_status=success" >> $GITHUB_OUTPUT
            elif [ $FIX_EXIT_CODE -eq 124 ]; then
              echo "â° ä¿®å¤è„šæœ¬æ‰§è¡Œè¶…æ—¶"
              echo "fix_status=timeout" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ ä¿®å¤è„šæœ¬æ‰§è¡Œæœ‰é”™è¯¯"
              echo "fix_status=error" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°ä¿®å¤è„šæœ¬ï¼Œè·³è¿‡ä¿®å¤æ­¥éª¤"
            echo "fix_status=skipped" >> $GITHUB_OUTPUT
          fi
          
          echo "fix_script_path=$FIX_SCRIPT" >> $GITHUB_OUTPUT
      
      # æ­¥éª¤1ï¼šå‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: "ğŸ“ 1. å‡†å¤‡æ„å»ºç¯å¢ƒ"
        run: |
          echo "=== ç¯å¢ƒå‡†å¤‡ ==="
          sudo mkdir -p ${{ env.BUILD_DIR }}
          sudo chmod 777 ${{ env.BUILD_DIR }}
          mkdir -p /tmp/source-upload /tmp/build-artifacts
      
      # ========== ç¬¬2é˜¶æ®µï¼šæ™ºèƒ½ä¸‹è½½ ==========
      
      # æ­¥éª¤2ï¼šæ™ºèƒ½ä¸‹è½½æºä»£ç 
      - name: "ğŸ“¥ 2. æ™ºèƒ½ä¸‹è½½æºä»£ç "
        id: download_source
        run: |
          echo "=== æ™ºèƒ½ä¸‹è½½æºä»£ç  ==="
          MAIN_SCRIPT=""
          SEARCH_PATHS=("firmware-config/scripts/build_firmware_main.sh" "scripts/build_firmware_main.sh" "build_firmware_main.sh" "$(pwd)/build_firmware_main.sh")
          
          for script_path in "${SEARCH_PATHS[@]}"; do
            if [ -f "$script_path" ]; then
              MAIN_SCRIPT="$script_path"
              echo "âœ… æ‰¾åˆ°ä¸»æ„å»ºè„šæœ¬: $script_path"
              break
            fi
          done
          
          if [ -z "$MAIN_SCRIPT" ]; then
            echo "å°è¯•æ¨¡ç³Šæœç´¢æ„å»ºè„šæœ¬..."
            FOUND_SCRIPTS=$(find . -name "*build*.sh" -type f 2>/dev/null | head -5)
            if [ -n "$FOUND_SCRIPTS" ]; then
              MAIN_SCRIPT=$(echo "$FOUND_SCRIPTS" | head -1)
              echo "âœ… æ¨¡ç³Šæ‰¾åˆ°æ„å»ºè„šæœ¬: $MAIN_SCRIPT"
            fi
          fi
          
          if [ -n "$MAIN_SCRIPT" ] && [ -f "$MAIN_SCRIPT" ]; then
            chmod +x "$MAIN_SCRIPT"
            echo "æ‰§è¡Œ: $MAIN_SCRIPT workflow_main step1_download_source \"${{ github.workspace }}\""
            "$MAIN_SCRIPT" workflow_main step1_download_source "${{ github.workspace }}"
            DOWNLOAD_EXIT_CODE=$?
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            echo "å°è¯•ç›´æ¥å…‹éš†ä»“åº“..."
            git clone --depth 1 https://github.com/${{ github.repository }}.git "${{ github.workspace }}"
            DOWNLOAD_EXIT_CODE=$?
          fi
          
          echo "ä¸‹è½½é€€å‡ºç : $DOWNLOAD_EXIT_CODE"
          echo "download_status=$DOWNLOAD_EXIT_CODE" >> $GITHUB_OUTPUT
      
      # æ­¥éª¤3ï¼šä¸Šä¼ æºä»£ç 
      - name: "ğŸ“¤ 3. ä¸Šä¼ æºä»£ç "
        if: steps.download_source.outputs.download_status == '0'
        run: |
          echo "=== ä¸Šä¼ æºä»£ç  ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            firmware-config/scripts/build_firmware_main.sh workflow_main step2_upload_source
          elif [ -f "build_firmware_main.sh" ]; then
            ./build_firmware_main.sh workflow_main step2_upload_source
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡ä¸Šä¼ "
          fi
      
      # ========== ç¬¬3é˜¶æ®µï¼šé…ç½®ç¯å¢ƒ ==========
      
      - name: "ğŸ”§ 4. Git LFSé…ç½®"
        run: |
          echo "=== Git LFSé…ç½® ==="
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global http.postBuffer 524288000
          git lfs install --force
          git lfs pull 2>/dev/null || echo "Git LFSæ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ„å»º"
      
      - name: "ğŸ“Š 5. å¤§æ–‡ä»¶æ£€æŸ¥"
        run: |
          echo "=== å¤§æ–‡ä»¶æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            firmware-config/scripts/build_firmware_main.sh workflow_main step5_check_large_files
          elif [ -f "build_firmware_main.sh" ]; then
            ./build_firmware_main.sh workflow_main step5_check_large_files
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ£€æŸ¥"
          fi
      
      - name: "ğŸ—‚ï¸ 6. å·¥å…·é“¾ç›®å½•æ£€æŸ¥"
        run: |
          echo "=== å·¥å…·é“¾ç›®å½•æ£€æŸ¥ ==="
          if [ -f "build_firmware_main.sh" ]; then
            ./build_firmware_main.sh workflow_main step6_check_toolchain_dir
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ£€æŸ¥"
          fi
      
      - name: "ğŸ’¾ 7. åˆå§‹åŒ–å·¥å…·é“¾ç›®å½•"
        run: |
          echo "=== åˆå§‹åŒ–å·¥å…·é“¾ç›®å½• ==="
          if [ -f "build_firmware_main.sh" ]; then
            ./build_firmware_main.sh workflow_main step7_init_toolchain_dir
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡åˆå§‹åŒ–"
          fi
      
      - name: "ğŸ› ï¸ 8. è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
        run: |
          echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
          if [ -f "build_firmware_main.sh" ]; then
            ./build_firmware_main.sh workflow_main step8_setup_environment
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œå°è¯•ç›´æ¥å®‰è£…"
            sudo apt-get update
            sudo apt-get install -y build-essential git ccache
          fi
      
      - name: "ğŸ“ 9. åˆ›å»ºæ„å»ºç›®å½•"
        run: |
          echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
          if [ -f "build_firmware_main.sh" ]; then
            ./build_firmware_main.sh workflow_main step9_create_build_dir
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œæ‰‹åŠ¨åˆ›å»ºç›®å½•"
            mkdir -p ${{ env.BUILD_DIR }}
          fi
      
      # ========== ç¬¬4é˜¶æ®µï¼šæ„å»ºæ‰§è¡Œ ==========
      
      # æ­¥éª¤10ï¼šåˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      - name: "ğŸš€ 10. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            firmware-config/scripts/build_firmware_main.sh workflow_main step10_init_build_env \
              "${{ github.event.inputs.device_name }}" \
              "${{ github.event.inputs.version_selection }}" \
              "${{ github.event.inputs.config_mode }}" \
              "${{ github.event.inputs.extra_packages }}"
          elif [ -f "build_firmware_main.sh" ]; then
            ./build_firmware_main.sh workflow_main step10_init_build_env \
              "${{ github.event.inputs.device_name }}" \
              "${{ github.event.inputs.version_selection }}" \
              "${{ github.event.inputs.config_mode }}" \
              "${{ github.event.inputs.extra_packages }}"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      - name: "âš¡ 11. æ˜¾ç¤ºé…ç½®"
        run: |
          echo "=== æ˜¾ç¤ºé…ç½® ==="
          if [ -f "build_firmware_main.sh" ]; then
            ./build_firmware_main.sh workflow_main step11_show_config
          fi
      
      # ========== ç¬¬5é˜¶æ®µï¼šä¿®å¤ç»“æœå¤„ç† ==========
      
      # æ­¥éª¤38ï¼šæœ€ç»ˆä¿®å¤æäº¤ï¼ˆåœ¨æœ€åæ‰§è¡Œï¼‰
      - name: "ğŸ“¤ 38. æœ€ç»ˆä¿®å¤æäº¤"
        if: always() && steps.run_fix_script.outputs.fix_status == 'success'
        run: |
          echo "=== æœ€ç»ˆä¿®å¤æäº¤ ==="
          if [ -f "/tmp/fix_changes.log" ]; then
            echo "æ£€æµ‹åˆ°ä¿®å¤æ›´æ”¹ï¼Œå°è¯•æäº¤..."
            git config --global user.name "GitHub Actions Bot"
            git config --global user.email "actions@github.com"
            git add -A
            
            if git status --porcelain | grep -q "."; then
              echo "æäº¤ä¿®å¤æ›´æ”¹..."
              git commit -m "fix: è‡ªåŠ¨ä¿®å¤æ›´æ–° [$(date '+%Y-%m-%d %H:%M:%S')]"
              git commit --amend -m "fix: è‡ªåŠ¨ä¿®å¤æ›´æ–° [$(date '+%Y-%m-%d %H:%M:%S')]

ä¿®å¤å†…å®¹:
- å¢å¼ºè·¯å¾„æœç´¢åŠŸèƒ½
- ä¿®å¤è„šæœ¬æ‰§è¡Œé¡ºåº
- ä¼˜åŒ–å·¥ä½œæµæ­¥éª¤"
              
              for i in {1..3}; do
                echo "æ¨é€å°è¯• $i/3..."
                if git push; then
                  echo "âœ… ä¿®å¤æ›´æ”¹å·²æäº¤"
                  break
                else
                  echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’..."
                  sleep 10
                fi
              done
            else
              echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
            fi
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°ä¿®å¤æ›´æ”¹"
          fi
      
      # æ­¥éª¤39ï¼šæœ€ç»ˆæ„å»ºæ€»ç»“
      - name: "ğŸ“ˆ 39. æœ€ç»ˆæ„å»ºæ€»ç»“"
        if: always()
        run: |
          echo "=== æ„å»ºæ€»ç»“ ==="
          echo "æ„å»ºçŠ¶æ€: ${{ job.status }}"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo ""
          echo "ä¿®å¤è„šæœ¬çŠ¶æ€: ${{ steps.run_fix_script.outputs.fix_status }}"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… æ„å»ºæˆåŠŸ"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
          fi
