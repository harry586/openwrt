name: "OpenWrt 智能固件构建工作流（已编译编译器版）"

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "📱 设备名称 (如: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "🔄 版本选择"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: "⚙️ 配置模式选择"
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: "额外安装插件，格式：用分号;分隔。启用插件：+插件名。禁用插件：-插件名。"
        required: false
        type: string
        default: ""

env:
  BUILD_DIR: "/mnt/openwrt-build"
  COMPILER_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      - name: "1. 使用Git Archive API下载源代码（智能排除编译器）"
        run: |
          echo "=== 步骤 1: 使用Git Archive API下载源代码（智能排除编译器） ==="
          echo "🔄 从GitHub API获取源代码压缩包（排除编译器目录）"
          
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "默认分支: $DEFAULT_BRANCH"
          
          echo "下载源代码压缩包..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" -o source.tar.gz
          
          if [ ! -f "source.tar.gz" ]; then
            echo "❌ 下载源代码压缩包失败"
            exit 1
          fi
          
          echo "✅ 下载完成，文件大小: $(ls -lh source.tar.gz | awk '{print $5}')"
          
          echo "解压源代码..."
          tar -xzf source.tar.gz --strip-components=1
          
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "✅ 源代码解压成功"
            echo "重要文件存在: firmware-config/scripts/build_firmware_main.sh"
            
            echo "📊 检查目录结构:"
            echo "当前目录: $(pwd)"
            echo "目录内容:"
            ls -la
            echo ""
            
            if [ -d "firmware-config/build-Compiler-file" ]; then
              echo "🔍 检查编译器目录: firmware-config/build-Compiler-file"
              echo "编译器目录大小: $(du -sh firmware-config/build-Compiler-file 2>/dev/null | cut -f1 || echo '未知')"
              
              if [ -d "firmware-config/build-Compiler-file/compiled" ]; then
                echo "✅ 找到预编译编译器: compiled/"
                compiled_size=$(du -sh firmware-config/build-Compiler-file/compiled 2>/dev/null | cut -f1 || echo "未知")
                echo "预编译编译器大小: $compiled_size"
              else
                echo "ℹ️ 未找到预编译编译器目录"
              fi
              
              if [ -d "firmware-config/build-Compiler-file/source" ]; then
                echo "✅ 找到编译器源代码: source/"
                source_size=$(du -sh firmware-config/build-Compiler-file/source 2>/dev/null | cut -f1 || echo "未知")
                echo "编译器源代码大小: $source_size"
              else
                echo "ℹ️ 未找到编译器源代码目录"
              fi
            else
              echo "ℹ️ 编译器目录不存在，将创建"
            fi
            
            echo "复制文件到工作区..."
            mkdir -p ${{ github.workspace }}
            
            echo "🔧 复制策略: 保留所有文件，包括编译器目录"
            rsync -av --exclude='.git' --exclude='.github' . ${{ github.workspace }}/
            
            chmod +x ${{ github.workspace }}/firmware-config/scripts/*.sh 2>/dev/null || true
            
            echo "✅ 文件复制完成"
            echo "工作区内容:"
            ls -la ${{ github.workspace }}/ 2>/dev/null | head -10
            
            if [ -d "${{ github.workspace }}/firmware-config/build-Compiler-file" ]; then
              echo "🎉 编译器目录已成功复制到工作区"
              echo "工作区编译器目录: ${{ github.workspace }}/firmware-config/build-Compiler-file"
              echo "目录大小: $(du -sh ${{ github.workspace }}/firmware-config/build-Compiler-file 2>/dev/null | cut -f1 || echo '未知')"
            else
              echo "⚠️ 编译器目录未复制到工作区"
            fi
            
            mkdir -p /tmp/build-artifacts/source-archive
            cp source.tar.gz /tmp/build-artifacts/source-archive/
            echo "✅ 源代码归档保存"
          else
            echo "❌ 源代码解压失败，重要文件缺失"
            echo "当前目录内容:"
            ls -la
            exit 1
          fi
          
          cd /tmp
          rm -rf openwrt-source
          echo "✅ Git Archive API下载完成"

      - name: "2. 立即上传Git Archive源代码"
        uses: actions/upload-artifact@v4
        with:
          name: "git-archive-source-${{ github.event.inputs.device_name }}"
          path: /tmp/build-artifacts/source-archive/
          retention-days: 7

      - name: "3. 详细检查编译器文件目录状态"
        run: |
          echo "=== 步骤 3: 详细检查编译器文件目录状态 ==="
          COMPILER_DIR="${{ env.COMPILER_DIR }}"
          
          echo "📁 编译器目录路径: $COMPILER_DIR"
          echo "📁 工作区路径: ${{ github.workspace }}"
          
          if [ -d "$COMPILER_DIR" ]; then
            echo "✅ 编译器文件目录存在"
            
            echo "📊 编译器目录详细信息:"
            
            echo "📁 目录结构:"
            find "$COMPILER_DIR" -maxdepth 3 -type d 2>/dev/null | sort | while read dir; do
              depth=$(echo "$dir" | tr -cd '/' | wc -c)
              indent=$(printf "%${depth}s" "")
              dir_name=$(basename "$dir")
              echo "$indent📁 $dir_name"
            done || echo "无法列出目录结构"
            
            if [ -d "$COMPILER_DIR/compiled" ]; then
              echo "🎯 找到预编译编译器: compiled/"
              compiled_size=$(du -sh "$COMPILER_DIR/compiled" 2>/dev/null | cut -f1 || echo "未知")
              file_count=$(find "$COMPILER_DIR/compiled" -type f 2>/dev/null | wc -l)
              
              echo "📦 预编译编译器大小: $compiled_size"
              echo "📄 文件数量: $file_count 个"
              
              echo "🔍 检查关键编译器文件:"
              CRITICAL_FILES=("bin/arm-openwrt-linux-muslgnueabi-gcc" "bin/arm-openwrt-linux-muslgnueabi-g++" "bin/arm-openwrt-linux-muslgnueabi-ld" "bin/arm-openwrt-linux-muslgnueabi-ar" "bin/arm-openwrt-linux-muslgnueabi-strip")
              
              found_count=0
              for file in "${CRITICAL_FILES[@]}"; do
                if [ -f "$COMPILER_DIR/compiled/$file" ]; then
                  echo "  ✅ $file: 存在 ($(du -h "$COMPILER_DIR/compiled/$file" 2>/dev/null | cut -f1))"
                  found_count=$((found_count + 1))
                else
                  echo "  ❌ $file: 缺失"
                fi
              done
              
              if [ $found_count -eq ${#CRITICAL_FILES[@]} ]; then
                echo "🎉 所有关键编译器文件完整！"
                echo "💡 预编译编译器可用，将用于加速构建"
              else
                echo "⚠️ 预编译编译器不完整，缺失 $(( ${#CRITICAL_FILES[@]} - $found_count )) 个文件"
                echo "💡 可能需要重新编译编译器"
              fi
              
              echo "📋 编译器文件列表（前20个）:"
              find "$COMPILER_DIR/compiled" -type f 2>/dev/null | head -20 | while read file; do
                file_name=$(basename "$file")
                file_size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "未知")
                echo "  📄 $file_name ($file_size)"
              done
            else
              echo "⚠️ 未找到预编译编译器目录 (compiled/)"
            fi
            
            if [ -d "$COMPILER_DIR/source" ]; then
              echo "📦 找到编译器源代码: source/"
              source_size=$(du -sh "$COMPILER_DIR/source" 2>/dev/null | cut -f1 || echo "未知")
              source_count=$(find "$COMPILER_DIR/source" -name "*.tar.*" -o -name "*.gz" 2>/dev/null | wc -l)
              
              echo "📦 编译器源代码大小: $source_size"
              echo "📄 源代码包数量: $source_count 个"
              
              if [ $source_count -gt 0 ]; then
                echo "📋 编译器源代码包列表:"
                find "$COMPILER_DIR/source" -name "*.tar.*" -o -name "*.gz" 2>/dev/null | head -10 | while read file; do
                  file_name=$(basename "$file")
                  file_size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "未知")
                  echo "  📦 $file_name ($file_size)"
                done
                
                if [ $source_count -gt 10 ]; then
                  echo "  ... 还有 $((source_count - 10)) 个文件"
                fi
                
                echo "💡 编译器源代码已准备，可用于编译器重新编译"
              fi
            else
              echo "ℹ️ 未找到编译器源代码目录 (source/)"
            fi
            
          else
            echo "❌ 编译器文件目录不存在"
            echo "💡 将创建新的编译器目录"
            mkdir -p "$COMPILER_DIR"
            echo "✅ 已创建编译器文件目录: $COMPILER_DIR"
          fi
          
          echo ""
          echo "📊 编译器状态总结:"
          if [ -d "$COMPILER_DIR/compiled" ] && [ -f "$COMPILER_DIR/compiled/bin/arm-openwrt-linux-muslgnueabi-gcc" ]; then
            echo "✅ 状态: 预编译编译器可用"
            echo "💡 将使用预编译编译器加速构建"
          elif [ -d "$COMPILER_DIR/source" ]; then
            echo "⚠️ 状态: 只有编译器源代码"
            echo "💡 需要从源代码编译编译器"
          else
            echo "❌ 状态: 无编译器文件"
            echo "💡 需要从网络下载并编译编译器"
          fi

      - name: "4. 初始空间检查"
        run: |
          echo "=== 步骤 4: 初始磁盘空间检查 ==="
          echo "📊 磁盘使用情况:"
          df -h
          
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo ""
          echo "📈 空间分析:"
          echo "  /mnt 可用空间: ${AVAILABLE_GB}G"
          echo "  构建目录: ${{ env.BUILD_DIR }}"
          
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "❌ 错误: /mnt 空间不足50G"
            echo "💡 建议: 至少需要50G空间用于完整构建"
            exit 1
          elif [ $AVAILABLE_GB -lt 100 ]; then
            echo "⚠️ 警告: /mnt 空间低于100G，可能影响大型构建"
            echo "✅ 但仍可继续构建"
          else
            echo "✅ 空间充足，可以开始构建"
          fi
          
          echo ""
          echo "🧠 内存使用情况:"
          free -h
          TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
          echo "  总内存: ${TOTAL_MEM}MB"
          
          if [ $TOTAL_MEM -lt 2048 ]; then
            echo "⚠️ 警告: 内存低于2GB，编译速度可能较慢"
          fi
          
          echo ""
          echo "⚡ CPU信息:"
          CPU_CORES=$(nproc)
          echo "  CPU核心数: $CPU_CORES"
          
          echo "✅ 初始空间检查通过"

      - name: "5. 设置编译环境和构建目录"
        run: |
          echo "=== 步骤 5: 设置编译环境和构建目录 ==="
          
          echo "🔄 步骤 5.1: 设置编译环境"
          firmware-config/scripts/build_firmware_main.sh setup_environment
          
          echo "🔄 步骤 5.2: 创建构建目录"
          firmware-config/scripts/build_firmware_main.sh create_build_dir
          
          echo "🔄 步骤 5.3: 初始化构建环境"
          echo "📋 构建参数:"
          echo "  设备: ${{ github.event.inputs.device_name }}"
          echo "  版本: ${{ github.event.inputs.version_selection }}"
          echo "  配置模式: ${{ github.event.inputs.config_mode }}"
          
          firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          echo "✅ 编译环境和构建目录设置完成"

      - name: "6. 添加 TurboACC 支持"
        run: |
          echo "=== 步骤 6: 添加 TurboACC 支持 ==="
          firmware-config/scripts/build_firmware_main.sh add_turboacc_support

      - name: "7. 配置Feeds"
        run: |
          echo "=== 步骤 7: 配置Feeds ==="
          firmware-config/scripts/build_firmware_main.sh configure_feeds

      - name: "8. 安装 TurboACC 包"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== 步骤 8: 安装 TurboACC 包 ==="
          firmware-config/scripts/build_firmware_main.sh install_turboacc_packages

      - name: "9. 编译前空间检查"
        run: |
          echo "=== 步骤 9: 编译前空间检查 ==="
          firmware-config/scripts/build_firmware_main.sh pre_build_space_check

      - name: "10. 智能配置生成（USB完全修复加强版）"
        run: |
          echo "=== 步骤 10: 智能配置生成 ==="
          echo "🚨 USB 3.0加强：所有关键USB驱动强制启用"
          firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"

      - name: "11. 验证USB配置"
        run: |
          echo "=== 步骤 11: 验证USB配置 ==="
          firmware-config/scripts/build_firmware_main.sh verify_usb_config

      - name: "12. USB驱动完整性检查"
        run: |
          echo "=== 步骤 12: USB驱动完整性检查 ==="
          firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity

      - name: "13. 应用配置并显示详情"
        run: |
          echo "=== 步骤 13: 应用配置并显示详情 ==="
          
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            cp "${{ env.BUILD_DIR }}/.config" "${{ env.BUILD_DIR }}/.config.original"
            echo "✅ 已备份原始配置文件"
          fi
          
          firmware-config/scripts/build_firmware_main.sh apply_config
          
          echo "=== 插件配置状态检查 ==="
          cd "${{ env.BUILD_DIR }}"
          
          declare -A normal_plugins
          normal_plugins["TurboACC 网络加速"]="luci-app-turboacc"
          normal_plugins["UPnP 自动端口转发"]="luci-app-upnp"
          normal_plugins["Samba 文件共享"]="luci-app-samba4"
          normal_plugins["磁盘管理"]="luci-app-diskman"
          normal_plugins["KMS 激活服务"]="luci-app-vlmcsd"
          normal_plugins["SmartDNS 智能DNS"]="luci-app-smartdns"
          normal_plugins["家长控制"]="luci-app-accesscontrol"
          normal_plugins["微信推送"]="luci-app-wechatpush"
          normal_plugins["流量控制 (SQM)"]="luci-app-sqm"
          normal_plugins["FTP 服务器"]="luci-app-vsftpd"
          normal_plugins["ARP 绑定"]="luci-app-arpbind"
          normal_plugins["CPU 限制"]="luci-app-cpulimit"
          normal_plugins["硬盘休眠"]="luci-app-hd-idle"
          
          echo "📋 正常模式插件状态检查:"
          
          total_plugins=0
          enabled_plugins=0
          disabled_plugins=0
          
          for plugin_name in "${!normal_plugins[@]}"; do
            plugin_config="${normal_plugins[$plugin_name]}"
            total_plugins=$((total_plugins + 1))
            
            if grep -q "^CONFIG_PACKAGE_${plugin_config}=y" .config; then
              echo "  ✅ $plugin_name: 已启用"
              enabled_plugins=$((enabled_plugins + 1))
            elif grep -q "^# CONFIG_PACKAGE_${plugin_config} is not set$" .config; then
              echo "  ❌ $plugin_name: 已禁用"
              disabled_plugins=$((disabled_plugins + 1))
            else
              echo "  ⚠️  $plugin_name: 未配置"
            fi
          done
          
          echo ""
          echo "📊 插件状态统计:"
          echo "  总计: $total_plugins 个插件"
          echo "  已启用: $enabled_plugins 个"
          echo "  已禁用: $disabled_plugins 个"
          
          if [ "${{ github.event.inputs.config_mode }}" = "base" ]; then
            echo ""
            echo "🔧 基础模式配置确认:"
            if [ $enabled_plugins -eq 0 ]; then
              echo "  ✅ 基础模式: 所有额外插件已正确禁用"
            else
              echo "  ⚠️  基础模式: 有 $enabled_plugins 个插件未禁用，需要检查"
            fi
          fi
          
          echo ""
          echo "🔌 USB驱动状态确认:"
          critical_usb_drivers=("kmod-usb-xhci-hcd" "kmod-usb3" "kmod-usb-dwc3" "kmod-usb-storage" "kmod-scsi-core")
          for driver in "${critical_usb_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
              echo "  ✅ $driver: 已启用"
            else
              echo "  ❌ $driver: 未启用 (需要修复)"
            fi
          done
          
          echo "✅ 配置详情检查完成"

      - name: "14. 检查并备份配置文件"
        run: |
          echo "=== 步骤 14: 检查并备份配置文件 ==="
          
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            echo "✅ .config 文件存在"
            
            mkdir -p firmware-config/config-backup
            
            backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
            
            cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
            echo "✅ 配置文件备份到仓库目录: $backup_file"
            
            echo "备份文件大小: $(ls -lh $backup_file | awk '{print $5}')"
            echo "备份文件内容预览:"
            head -20 "$backup_file"
          else
            echo "❌ .config 文件不存在"
            exit 1
          fi

      - name: "15. 修复网络环境"
        run: |
          echo "=== 步骤 15: 修复网络环境 ==="
          firmware-config/scripts/build_firmware_main.sh fix_network

      - name: "16. 下载依赖包"
        run: |
          echo "=== 步骤 16: 下载依赖包 ==="
          firmware-config/scripts/build_firmware_main.sh download_dependencies

      - name: "17. 集成自定义文件"
        run: |
          echo "=== 步骤 17: 集成自定义文件 ==="
          firmware-config/scripts/build_firmware_main.sh integrate_custom_files

      - name: "18. 前置错误检查（包含编译器状态）"
        run: |
          echo "=== 步骤 18: 前置错误检查 ==="
          
          echo "🔍 详细检查交叉编译器状态:"
          COMPILER_DIR="${{ env.COMPILER_DIR }}"
          
          echo "📁 编译器目录: $COMPILER_DIR"
          
          if [ -d "$COMPILER_DIR/compiled" ]; then
            echo "🎯 找到预编译的交叉编译器"
            
            COMPILER_OUTPUT_DIR="$COMPILER_DIR/compiled"
            total_size=$(du -sh "$COMPILER_OUTPUT_DIR" 2>/dev/null | cut -f1 || echo "未知")
            file_count=$(find "$COMPILER_OUTPUT_DIR" -type f 2>/dev/null | wc -l)
            
            echo "📊 编译器详细信息:"
            echo "  📁 预编译编译器目录: $COMPILER_OUTPUT_DIR"
            echo "  📦 总大小: $total_size"
            echo "  📄 文件数量: $file_count 个"
            
            echo "🔧 检查关键编译器文件:"
            REQUIRED_FILES=("bin/arm-openwrt-linux-muslgnueabi-gcc" "bin/arm-openwrt-linux-muslgnueabi-g++" "bin/arm-openwrt-linux-muslgnueabi-ld" "bin/arm-openwrt-linux-muslgnueabi-ar" "bin/arm-openwrt-linux-muslgnueabi-strip" "lib/gcc/arm-openwrt-linux-muslgnueabi/8.4.0/libgcc.a")
            
            missing_files=0
            for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "$COMPILER_OUTPUT_DIR/$file" ]; then
                file_size=$(du -h "$COMPILER_OUTPUT_DIR/$file" 2>/dev/null | cut -f1)
                echo "  ✅ $file: 存在 ($file_size)"
              else
                echo "  ❌ $file: 缺失"
                missing_files=$((missing_files + 1))
              fi
            done
            
            if [ $missing_files -eq 0 ]; then
              echo "🎉 所有关键编译器文件完整！"
              
              echo "🔧 测试编译器功能..."
              if [ -x "$COMPILER_OUTPUT_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" ]; then
                test_output=$("$COMPILER_OUTPUT_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" --version 2>&1 | head -1)
                echo "  ✅ 编译器工作正常"
                echo "  📋 版本信息: $test_output"
              else
                echo "  ⚠️ 编译器不可执行"
              fi
              
              echo "💡 预编译编译器状态: 完整可用，将用于加速构建"
            else
              echo "⚠️ 警告: 预编译编译器缺失 $missing_files 个关键文件"
              echo "💡 可能需要重新编译编译器"
            fi
          else
            echo "⚠️ 未找到预编译的交叉编译器 (compiled/)"
            echo "💡 将使用内置的编译器构建流程"
          fi
          
          if [ -d "$COMPILER_DIR/source" ]; then
            echo "📦 找到编译器源代码包"
            COMPILER_SOURCE_DIR="$COMPILER_DIR/source"
            source_size=$(du -sh "$COMPILER_SOURCE_DIR" 2>/dev/null | cut -f1 || echo "未知")
            source_count=$(find "$COMPILER_SOURCE_DIR" -name "*.tar.*" -o -name "*.gz" 2>/dev/null | wc -l)
            
            echo "📊 编译器源代码信息:"
            echo "  📁 编译器源代码目录: $COMPILER_SOURCE_DIR"
            echo "  📦 总大小: $source_size"
            echo "  📄 源代码包数量: $source_count 个"
          else
            echo "ℹ️ 未找到编译器源代码包 (source/)"
            echo "💡 将在编译过程中从网络下载编译器源代码"
          fi
          
          echo ""
          echo "🔧 执行前置错误检查脚本..."
          firmware-config/scripts/build_firmware_main.sh pre_build_error_check

      - name: "19. 编译固件前的空间检查"
        run: |
          echo "=== 步骤 19: 编译固件前的空间检查 ==="
          echo "📊 编译前磁盘使用情况:"
          df -h
          
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo ""
          echo "📈 空间分析:"
          echo "  /mnt 可用空间: ${AVAILABLE_GB}G"
          echo "  构建目录大小: $(du -sh ${{ env.BUILD_DIR }} 2>/dev/null | cut -f1 || echo '未知')"
          
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "❌ 错误: 编译前空间不足 (需要至少10G，当前${AVAILABLE_GB}G)"
            echo "💡 建议: 清理空间或使用更大的磁盘"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "⚠️ 警告: 编译前空间较低 (建议至少20G，当前${AVAILABLE_GB}G)"
            echo "✅ 但仍可继续编译"
          else
            echo "✅ 编译前空间充足"
          fi

      - name: "20. 智能编译固件（优先使用预编译编译器）"
        run: |
          echo "=== 步骤 20: 智能编译固件 ==="
          
          COMPILER_DIR="${{ env.COMPILER_DIR }}"
          COMPILER_OUTPUT_DIR="$COMPILER_DIR/compiled"
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          echo "🔧 智能编译器管理流程:"
          echo "1. 检查预编译编译器可用性"
          echo "2. 如果可用，直接使用加速构建"
          echo "3. 如果不可用，从源代码编译编译器"
          echo "4. 编译固件"
          
          cd "$BUILD_DIR"
          COMPILER_USABLE=false
          
          if [ -d "$COMPILER_OUTPUT_DIR" ]; then
            echo "🔍 详细检查预编译编译器可用性..."
            
            REQUIRED_FILES=("bin/arm-openwrt-linux-muslgnueabi-gcc" "bin/arm-openwrt-linux-muslgnueabi-g++" "bin/arm-openwrt-linux-muslgnueabi-ld" "bin/arm-openwrt-linux-muslgnueabi-ar" "bin/arm-openwrt-linux-muslgnueabi-strip")
            
            missing_files=0
            echo "📋 检查关键文件:"
            for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "$COMPILER_OUTPUT_DIR/$file" ]; then
                echo "  ✅ $file: 存在"
              else
                echo "  ❌ $file: 缺失"
                missing_files=$((missing_files + 1))
              fi
            done
            
            if [ $missing_files -eq 0 ]; then
              echo "✅ 预编译编译器文件完整"
              
              echo "🔧 测试编译器功能..."
              if [ -x "$COMPILER_OUTPUT_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" ]; then
                test_output=$("$COMPILER_OUTPUT_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" --version 2>&1)
                if echo "$test_output" | grep -q "gcc"; then
                  echo "✅ 编译器工作正常"
                  COMPILER_USABLE=true
                  
                  echo "📋 编译器版本信息:"
                  echo "$test_output" | head -3
                else
                  echo "❌ 编译器测试失败"
                  echo "错误输出: $test_output"
                fi
              else
                echo "❌ 编译器不可执行"
              fi
            else
              echo "❌ 预编译编译器缺失 $missing_files 个关键文件"
            fi
          else
            echo "❌ 未找到预编译编译器目录"
          fi
          
          if [ "$COMPILER_USABLE" = true ]; then
            echo "🚀 使用预编译的交叉编译器加速构建..."
            
            if [ -d "staging_dir" ]; then
              echo "📦 备份现有staging_dir..."
              mv staging_dir staging_dir.backup.$(date +%s) 2>/dev/null || true
            fi
            
            mkdir -p staging_dir
            
            toolchain_dir=$(find "$COMPILER_OUTPUT_DIR" -maxdepth 1 -type d -name "toolchain-*" | head -1)
            
            if [ -n "$toolchain_dir" ] && [ -d "$toolchain_dir" ]; then
              echo "📁 复制预编译toolchain..."
              cp -r "$toolchain_dir" staging_dir/
              echo "✅ 预编译编译器已复制到构建目录"
              
              if [ -d "staging_dir/toolchain-"* ]; then
                echo "✅ 编译器复制验证通过"
                echo "📁 staging_dir内容:"
                ls -la staging_dir/
              fi
            else
              echo "📁 复制整个预编译编译器目录..."
              cp -r "$COMPILER_OUTPUT_DIR" staging_dir/compiler-prebuilt
              echo "✅ 预编译编译器已复制到 staging_dir/compiler-prebuilt"
            fi
            
            echo "💡 预编译编译器已就绪，将显著加快构建速度"
          else
            echo "⚠️ 预编译编译器不可用，将使用标准构建流程"
            echo "💡 编译器会在构建过程中自动编译"
          fi
          
          echo "🔨 开始编译固件..."
          
          cpu_cores=$(nproc)
          make_jobs=$cpu_cores
          
          total_mem=$(free -m | awk '/^Mem:/{print $2}')
          if [ $total_mem -lt 4096 ]; then
            make_jobs=$((cpu_cores / 2))
            if [ $make_jobs -lt 1 ]; then
              make_jobs=1
            fi
            echo "⚠️ 内存较低(${total_mem}MB)，减少并行任务到 $make_jobs"
          fi
          
          echo "⚙️ 编译参数:"
          echo "  并行任务数: $make_jobs"
          echo "  详细输出: 启用"
          echo "  编译器缓存: 启用"
          
          echo "使用 $make_jobs 个并行任务进行编译..."
          firmware-config/scripts/build_firmware_main.sh build_firmware "true"
          
          echo "✅ 智能编译完成"

      - name: "21. 搜索并打包构建产物"
        if: success()
        run: |
          echo "=== 步骤 21: 搜索并打包构建产物 ==="
          cd ${{ env.BUILD_DIR }}
          
          mkdir -p /tmp/build-artifacts
          
          echo "🔍 搜索构建产物..."
          
          if [ -d "bin/targets" ]; then
            echo "📦 打包固件文件..."
            
            echo "📋 找到的固件文件:"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.tar" \) 2>/dev/null | while read file; do
              file_size=$(du -h "$file" 2>/dev/null | cut -f1)
              echo "  📄 $file ($file_size)"
            done
            
            total_size=0
            while read size; do
              total_size=$((total_size + size))
            done < <(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.tar" \) -exec stat -c%s {} \; 2>/dev/null)
            
            if [ $total_size -gt 0 ]; then
              total_size_mb=$((total_size / 1024 / 1024))
              echo "📊 固件总大小: ${total_size_mb}MB"
              
              tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
              
              firmware_archive_size=$(du -h /tmp/build-artifacts/firmware.tar.gz | cut -f1)
              echo "✅ 固件打包完成，归档大小: $firmware_archive_size"
            else
              echo "⚠️ 未找到固件文件"
            fi
          else
            echo "⚠️ bin/targets目录不存在"
          fi
          
          if [ -f "build.log" ]; then
            echo "📝 打包编译日志..."
            cp build.log /tmp/build-artifacts/build.log
            log_size=$(du -h build.log | cut -f1)
            echo "✅ 日志打包完成，大小: $log_size"
          fi
          
          if [ -f "download.log" ]; then
            echo "📥 打包下载日志..."
            cp download.log /tmp/build-artifacts/download.log
          fi
          
          echo "📋 创建构建信息文件..."
          echo "=== OpenWrt固件构建信息 ===" > /tmp/build-artifacts/build-info.txt
          echo "" >> /tmp/build-artifacts/build-info.txt
          echo "📅 构建时间: $(date)" >> /tmp/build-artifacts/build-info.txt
          echo "🏷️ 设备: ${{ env.DEVICE }}" >> /tmp/build-artifacts/build-info.txt
          echo "🔄 版本: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/build-info.txt
          echo "🎯 目标平台: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/build-info.txt
          echo "⚙️ 配置模式: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/build-info.txt
          echo "📁 构建目录: ${{ env.BUILD_DIR }}" >> /tmp/build-artifacts/build-info.txt
          echo "" >> /tmp/build-artifacts/build-info.txt
          echo "📦 构建产物:" >> /tmp/build-artifacts/build-info.txt
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
            file_name=$(basename "$file")
            file_size=$(du -h "$file" 2>/dev/null | cut -f1)
            echo "  - $file_name ($file_size)" >> /tmp/build-artifacts/build-info.txt
          done
          echo "" >> /tmp/build-artifacts/build-info.txt
          echo "🔧 编译器使用:" >> /tmp/build-artifacts/build-info.txt
          if [ -d "${{ env.COMPILER_DIR }}/compiled" ]; then
            echo "  ✅ 使用了预编译编译器" >> /tmp/build-artifacts/build-info.txt
            echo "  📁 编译器目录: ${{ env.COMPILER_DIR }}/compiled" >> /tmp/build-artifacts/build-info.txt
          else
            echo "  🔨 从源代码编译了编译器" >> /tmp/build-artifacts/build-info.txt
          fi
          echo "" >> /tmp/build-artifacts/build-info.txt
          echo "🎉 构建完成!" >> /tmp/build-artifacts/build-info.txt
          
          echo "✅ 构建信息文件创建完成"
          
          echo ""
          echo "📤 最终构建产物:"
          ls -lh /tmp/build-artifacts/

      - name: "22. 上传固件原始目录"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: "firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7

      - name: "23. 上传配置文件"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7

      - name: "24. 上传构建产物包"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: "build-artifacts-${{ github.event.inputs.device_name }}"
          path: /tmp/build-artifacts/
          retention-days: 7

      - name: "25. 错误分析"
        if: always()
        run: |
          echo "=== 步骤 25: 错误分析 ==="
          if [ -f "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh" ]; then
            firmware-config/scripts/error_analysis.sh
          else
            echo "ℹ️ 错误分析脚本不存在，跳过此步骤"
          fi

      - name: "26. 编译后空间检查"
        if: always()
        run: |
          echo "=== 步骤 26: 编译后空间检查 ==="
          firmware-config/scripts/build_firmware_main.sh post_build_space_check

      - name: "27. 显示最终构建成果"
        if: success()
        run: |
          echo "=== 步骤 27: 最终构建成果总结 ==="
          echo ""
          echo "🎉 🎉 🎉 固件构建成功完成！ 🎉 🎉 🎉"
          echo ""
          
          echo "📊 构建参数:"
          echo "  📱 设备: ${{ env.DEVICE }}"
          echo "  🏷️ 版本: ${{ env.SELECTED_BRANCH }}"
          echo "  🎯 平台: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "  ⚙️ 模式: ${{ github.event.inputs.config_mode }}"
          echo ""
          
          echo "📦 生成的文件:"
          cd ${{ env.BUILD_DIR }}
          if [ -d "bin/targets" ]; then
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
              file_name=$(basename "$file")
              file_path=$(dirname "$file")
              file_size=$(du -h "$file" 2>/dev/null | cut -f1)
              file_date=$(stat -c "%y" "$file" 2>/dev/null | cut -d' ' -f1)
              echo "  📄 $file_name"
              echo "    📁 路径: $file_path/"
              echo "    📦 大小: $file_size"
              echo "    📅 日期: $file_date"
              echo ""
            done
            
            firmware_count=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
            total_size=0
            while read size; do
              total_size=$((total_size + size))
            done < <(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) -exec stat -c%s {} \; 2>/dev/null)
            
            if [ $total_size -gt 0 ]; then
              total_size_mb=$((total_size / 1024 / 1024))
              echo "📊 统计:"
              echo "  固件数量: $firmware_count 个"
              echo "  总大小: ${total_size_mb}MB"
            fi
          else
            echo "  ⚠️ 未找到固件文件"
          fi
          
          echo ""
          echo "📤 产物上传:"
          echo "  ✅ 固件文件已上传到Artifacts"
          echo "  ✅ 配置文件已备份"
          echo "  ✅ 构建日志已保存"
          echo ""
          
          echo "🔧 构建详情:"
          echo "  查看Artifacts获取完整构建产物"
          echo "  查看日志了解详细构建过程"
          echo ""
          
          echo "🚀 下一步:"
          echo "  1. 下载生成的固件文件"
          echo "  2. 刷入路由器设备"
          echo "  3. 享受新固件的功能！"
          echo ""
          
          echo "✅ 构建流程全部完成！"
