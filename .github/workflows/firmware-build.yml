name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
          - '23.05'
          - '21.02'
      config_mode:
        description: 'âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© - ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ï¼šâœ… æ–‡ä»¶ä¼ è¾“ã€‚ ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ ã€‚'
        required: true
        type: choice
        default: 'normal'
        options:
          - 'base'
          - 'normal'
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šğŸ”´ç”¨é¡¿å·ã€åˆ†éš”ã€‚ğŸ”´ å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ğŸ”´ ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚ğŸ”´ ç¤ºä¾‹ï¼š+luci-app-wolã€+luci-app-ddns'
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)'
        required: false
        default: true
        type: boolean
      rebuild_toolchain:
        description: 'ğŸ”„ å¼ºåˆ¶é‡æ–°æ„å»ºå·¥å…·é“¾'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'ğŸ› å¯ç”¨è°ƒè¯•æ¨¡å¼ (æ˜¾ç¤ºæ›´å¤šè¯¦ç»†ä¿¡æ¯)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  TOOLCHAIN_DIR: /mnt/openwrt-toolchain
  WORKSPACE_DIR: /tmp/openwrt-workspace
  DEBUG_MODE: ${{ github.event.inputs.debug_mode }}

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: åˆ›å»ºç›®å½•æ ‡è®°ç³»ç»Ÿ
      run: |
        echo "=== åˆ›å»ºç›®å½•æ ‡è®°ç³»ç»Ÿ ==="
        
        # åˆ›å»ºå·¥ä½œåŒºç›®å½•
        mkdir -p $WORKSPACE_DIR
        
        # åˆ›å»ºæ ‡è®°æ–‡ä»¶
        echo "åˆ›å»ºæ ‡è®°æ–‡ä»¶..."
        
        # åˆ›å»ºé…ç½®ä»“åº“æ ‡è®°
        echo "$(pwd)" > $WORKSPACE_DIR/MARK_CONFIG_REPO
        echo "âœ… é…ç½®ä»“åº“æ ‡è®°: $(cat $WORKSPACE_DIR/MARK_CONFIG_REPO)"
        
        # åˆ›å»ºè„šæœ¬ç›®å½•æ ‡è®°
        if [ -d "firmware-config/scripts" ]; then
          echo "$(pwd)/firmware-config/scripts" > $WORKSPACE_DIR/MARK_SCRIPTS_DIR
          echo "âœ… è„šæœ¬ç›®å½•æ ‡è®°: $(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)"
        else
          echo "âŒ è„šæœ¬ç›®å½•ä¸å­˜åœ¨"
          find . -name "*.sh" -type f 2>/dev/null | head -5
        fi
        
        # åˆ›å»ºè‡ªå®šä¹‰æ–‡ä»¶ç›®å½•æ ‡è®°
        if [ -d "firmware-config/custom-files" ]; then
          echo "$(pwd)/firmware-config/custom-files" > $WORKSPACE_DIR/MARK_CUSTOM_FILES
          echo "âœ… è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•æ ‡è®°: $(cat $WORKSPACE_DIR/MARK_CUSTOM_FILES)"
        fi
        
        echo ""
        echo "ğŸ“ å·¥ä½œåŒºå†…å®¹:"
        ls -la $WORKSPACE_DIR/

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        INSTALL_LOG="/tmp/install_deps.log"
        echo "å®‰è£…æ—¥å¿—: $INSTALL_LOG"
        echo "1. æ›´æ–°åŒ…åˆ—è¡¨..."
        sudo apt-get update 2>&1 | tee $INSTALL_LOG
        echo ""
        echo "2. å®‰è£…ç¼–è¯‘OpenWrtæ‰€éœ€çš„æ‰€æœ‰ä¾èµ–åŒ…..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo cmake jq ccache u-boot-tools gperf nodejs npm swig time xsltproc libxml2-utils 2>&1 | tee -a $INSTALL_LOG
        echo ""
        echo "3. æ£€æŸ¥å…³é”®å·¥å…·å®‰è£…æƒ…å†µ:"
        echo "gcc: $(gcc --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "g++: $(g++ --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "make: $(make --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "cmake: $(cmake --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "git: $(git --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "python3: $(python3 --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "ccache: $(ccache --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: ä¸‹è½½å·¥å…·é“¾ç¼“å­˜
      id: download_toolchain
      uses: actions/download-artifact@v4
      with:
        name: openwrt-toolchain-cache
        path: ${{ env.TOOLCHAIN_DIR }}
      continue-on-error: true

    - name: æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€
      run: |
        echo "=== æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€ ==="
        echo "å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
        
        if [ -d "$TOOLCHAIN_DIR" ]; then
          echo "âœ… å·¥å…·é“¾ç›®å½•å­˜åœ¨"
          echo "ğŸ“¦ å·¥å…·é“¾ç¼“å­˜å†…å®¹:"
          find $TOOLCHAIN_DIR -type f -name "*.txt" -o -name "*.json" 2>/dev/null | head -10
          echo ""
          echo "å·¥å…·é“¾æ•°æ®åº“:"
          if [ -f "$TOOLCHAIN_DIR/toolchain_db.json" ]; then
            cat $TOOLCHAIN_DIR/toolchain_db.json | head -20
          else
            echo "âŒ å·¥å…·é“¾æ•°æ®åº“ä¸å­˜åœ¨"
          fi
        else
          echo "âŒ å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°æ„å»º"
        fi

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        echo "åˆ›å»ºç›®å½•: $BUILD_DIR"
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        echo "ç›®å½•æƒé™è®¾ç½®å®Œæˆ:"
        ls -ld $BUILD_DIR

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      id: init_env
      run: |
        echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR 2>/dev/null || echo "")
        if [ -z "$SCRIPTS_DIR" ]; then
          echo "âŒ è„šæœ¬ç›®å½•æ ‡è®°ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "è„šæœ¬ç›®å½•: $SCRIPTS_DIR"
        cd "$SCRIPTS_DIR"
        echo "åˆ‡æ¢åˆ°è„šæœ¬ç›®å½•: $(pwd)"
        
        # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
        ./build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"
        
        # è¯»å–ç¯å¢ƒå˜é‡
        if [ -f "$BUILD_DIR/build_env.sh" ]; then
          echo ""
          echo "=== ç”Ÿæˆçš„ç¯å¢ƒå˜é‡ ==="
          cat $BUILD_DIR/build_env.sh
          
          # å¯¼å‡ºåˆ°GitHubç¯å¢ƒ
          source $BUILD_DIR/build_env.sh
          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_OUTPUT
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_OUTPUT
          echo "DEVICE=$DEVICE" >> $GITHUB_OUTPUT
          echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
        else
          echo "âŒ ç¯å¢ƒæ–‡ä»¶æœªåˆ›å»º"
          exit 1
        fi

    - name: é…ç½®Feeds
      run: |
        echo "=== é…ç½®Feeds ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        ./build_firmware_main.sh configure_feeds

    - name: æ·»åŠ TurboACCæ”¯æŒ
      if: github.event.inputs.config_mode == 'normal' && steps.init_env.outputs.SELECTED_BRANCH == 'openwrt-23.05'
      run: |
        echo "=== æ·»åŠ TurboACCæ”¯æŒ ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        ./build_firmware_main.sh add_turboacc_support

    - name: å®‰è£…æ’ä»¶åŒ…
      run: |
        echo "=== å®‰è£…æ’ä»¶åŒ… ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        echo "1. å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶åŒ…:"
        ./build_firmware_main.sh install_filetransfer_packages
        
        if [ "${{ github.event.inputs.config_mode }}" = "normal" ] && [ "${{ steps.init_env.outputs.SELECTED_BRANCH }}" = "openwrt-23.05" ]; then
          echo ""
          echo "2. å®‰è£…TurboACCåŒ…:"
          ./build_firmware_main.sh install_turboacc_packages
        fi

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      run: |
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        echo "ç”Ÿæˆé…ç½®ï¼Œé¢å¤–æ’ä»¶: ${{ github.event.inputs.extra_packages }}"
        ./build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"

    - name: éªŒè¯USBé…ç½®
      run: |
        echo "=== éªŒè¯USBé…ç½® ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        ./build_firmware_main.sh verify_usb_config

    - name: åº”ç”¨é…ç½®
      run: |
        echo "=== åº”ç”¨é…ç½® ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        ./build_firmware_main.sh apply_config

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        ./build_firmware_main.sh fix_network

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        echo "å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…..."
        ./build_firmware_main.sh download_dependencies

    - name: å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶
      run: |
        echo "=== å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶ ==="
        
        # åŠ è½½è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•æ ‡è®°
        CUSTOM_FILES_DIR=$(cat $WORKSPACE_DIR/MARK_CUSTOM_FILES 2>/dev/null || echo "")
        if [ -z "$CUSTOM_FILES_DIR" ]; then
          echo "âŒ è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•æ ‡è®°ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•: $CUSTOM_FILES_DIR"
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        ./build_firmware_main.sh process_custom_files

    - name: ç¼–è¯‘å›ºä»¶
      id: build_firmware
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        echo "ç¼–è¯‘å‚æ•°:"
        echo "  ç¼“å­˜æ¨¡å¼: ${{ github.event.inputs.enable_cache }}"
        echo "  CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "  è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug_mode }}"
        echo ""
        
        # è®°å½•å¼€å§‹æ—¶é—´
        START_TIME=$(date +%s)
        echo "â° ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        
        # æ‰§è¡Œç¼–è¯‘
        ./build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"
        BUILD_EXIT_CODE=$?
        
        # è®°å½•ç»“æŸæ—¶é—´
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo ""
        echo "â±ï¸ ç¼–è¯‘è€—æ—¶: $((DURATION / 60))åˆ†é’Ÿ $((DURATION % 60))ç§’"
        
        # è®¾ç½®æ­¥éª¤ç»“æœ
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ… ç¼–è¯‘å®Œæˆ"
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç : $BUILD_EXIT_CODE"
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
        fi

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      run: |
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        ./build_firmware_main.sh check_firmware_files

    - name: å¤‡ä»½é…ç½®æ–‡ä»¶
      if: always()
      run: |
        echo "=== å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
        
        # åŠ è½½è„šæœ¬ç›®å½•æ ‡è®°
        SCRIPTS_DIR=$(cat $WORKSPACE_DIR/MARK_SCRIPTS_DIR)
        cd "$SCRIPTS_DIR"
        
        cd $BUILD_DIR
        ./build_firmware_main.sh backup_config

    - name: æ„å»ºå·¥å…·é“¾
      if: steps.download_toolchain.outcome == 'failure' || github.event.inputs.rebuild_toolchain == 'true'
      run: |
        echo "=== æ„å»ºå·¥å…·é“¾ ==="
        
        cd $BUILD_DIR
        
        # åŠ è½½ç¯å¢ƒå˜é‡
        source build_env.sh 2>/dev/null || echo "ç¯å¢ƒæ–‡ä»¶åŠ è½½å¤±è´¥"
        
        echo "æ„å»ºå·¥å…·é“¾: $SELECTED_BRANCH-$TARGET-$SUBTARGET"
        
        # åˆ›å»ºå·¥å…·é“¾é…ç½®
        echo "CONFIG_TARGET_${TARGET}=y" > .config.toolchain
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config.toolchain
        echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config.toolchain
        echo "CONFIG_TOOLCHAIN=y" >> .config.toolchain
        echo "CONFIG_TOOLCHAIN_BUILD=y" >> .config.toolchain
        echo "CONFIG_SDK=y" >> .config.toolchain
        echo "CONFIG_IB=y" >> .config.toolchain
        
        echo "åº”ç”¨å·¥å…·é“¾é…ç½®..."
        cp .config.toolchain .config
        make defconfig
        
        echo "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
        make toolchain/install -j2 V=s
        
        # ä¿å­˜å·¥å…·é“¾
        echo "ğŸ’¾ ä¿å­˜å·¥å…·é“¾..."
        mkdir -p $TOOLCHAIN_DIR
        if [ -d "staging_dir" ]; then
          cp -r staging_dir/* $TOOLCHAIN_DIR/
          echo "âœ… å·¥å…·é“¾ä¿å­˜åˆ°: $TOOLCHAIN_DIR"
          
          # åˆ›å»ºå·¥å…·é“¾ä¿¡æ¯
          echo "å·¥å…·é“¾ä¿¡æ¯:" > $TOOLCHAIN_DIR/toolchain_info.txt
          echo "ç‰ˆæœ¬: $SELECTED_BRANCH" >> $TOOLCHAIN_DIR/toolchain_info.txt
          echo "ç›®æ ‡: $TARGET-$SUBTARGET" >> $TOOLCHAIN_DIR/toolchain_info.txt
          echo "è®¾å¤‡: $DEVICE" >> $TOOLCHAIN_DIR/toolchain_info.txt
          echo "ç¼–è¯‘æ—¶é—´: $(date)" >> $TOOLCHAIN_DIR/toolchain_info.txt
          
          # åˆ›å»ºå·¥å…·é“¾æ•°æ®åº“
          echo '{' > $TOOLCHAIN_DIR/toolchain_db.json
          echo '  "version": "1.0.0",' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '  "toolchains": {' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '    "'$SELECTED_BRANCH'-'$TARGET'-'$SUBTARGET'": {' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '      "created": "'$(date -I)'",' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '      "size": "'$(du -sh $TOOLCHAIN_DIR | cut -f1)'",' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '      "target": "'$TARGET'",' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '      "subtarget": "'$SUBTARGET'",' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '      "version": "'$SELECTED_BRANCH'"' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '    }' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '  },' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '  "statistics": {' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '    "total_builds": 1,' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '    "cache_hits": 0,' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '    "cache_misses": 1' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '  },' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '  "last_updated": "'$(date -I)'"' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '}' >> $TOOLCHAIN_DIR/toolchain_db.json
        fi

    - name: ä¸Šä¼ å·¥å…·é“¾ç¼“å­˜
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-toolchain-cache
        path: ${{ env.TOOLCHAIN_DIR }}
        retention-days: 30
        if-no-files-found: warn

    - name: ä¸Šä¼ å›ºä»¶
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ steps.init_env.outputs.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/*.log
          ${{ env.BUILD_DIR }}/config_backup/
          ${{ env.TOOLCHAIN_DIR }}/
        retention-days: 7

    - name: æ˜¾ç¤ºå·¥å…·é“¾ç»Ÿè®¡ä¿¡æ¯
      if: always()
      run: |
        echo "=== å·¥å…·é“¾ç»Ÿè®¡ä¿¡æ¯ ==="
        
        if [ -f "$TOOLCHAIN_DIR/toolchain_db.json" ]; then
          echo "ğŸ“Š å·¥å…·é“¾æ•°æ®åº“:"
          cat $TOOLCHAIN_DIR/toolchain_db.json
        else
          echo "âŒ å·¥å…·é“¾æ•°æ®åº“ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "å·¥å…·é“¾ç¼“å­˜ç›®å½•: $TOOLCHAIN_DIR"
        if [ -d "$TOOLCHAIN_DIR" ]; then
          echo "ğŸ“¦ æ€»å¤§å°: $(du -sh $TOOLCHAIN_DIR | cut -f1)"
          echo "ğŸ“ ç›®å½•å†…å®¹:"
          ls -la $TOOLCHAIN_DIR/
        fi
