name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©"
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ (ç”¨åˆ†å·åˆ†éš”)"
        required: false
        type: string
        default: ""
      use_fix_script:
        description: "ğŸ”§ ä½¿ç”¨ä¿®å¤è„šæœ¬ä¿®å¤ç¯å¢ƒ"
        required: false
        type: boolean
        default: true
      save_toolchain_to_repo:
        description: "ğŸ’¾ æäº¤å·¥å…·é“¾åˆ°ä»“åº“ (èŠ‚çœä¸‹æ¬¡ç¼–è¯‘æ—¶é—´)"
        required: false
        type: boolean
        default: true

env:
  BUILD_DIR: "/mnt/openwrt-build"
  GIT_LFS_SKIP_SMUDGE: 1
  ENABLE_CACHE: "true"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # ========== é˜¶æ®µ1ï¼šåˆå§‹åŒ–å’Œä¿®å¤ ==========
      
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç å¹¶ä¿®å¤æƒé™
      - name: "ğŸ“¥ 1. æ£€å‡ºä»£ç å¹¶ä¿®å¤æƒé™"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤2ï¼šä¿®å¤è„šæœ¬æƒé™
      - name: "ğŸ”§ 2. ä¿®å¤è„šæœ¬æƒé™"
        run: |
          echo "=== ä¿®å¤è„šæœ¬æ‰§è¡Œæƒé™ ==="
          
          # ä¿®å¤æ‰€æœ‰è„šæœ¬çš„æ‰§è¡Œæƒé™
          find firmware-config/scripts -name "*.sh" -type f -exec chmod +x {} \;
          
          echo "âœ… è„šæœ¬æƒé™ä¿®å¤å®Œæˆ"
          echo "ä¿®å¤çš„è„šæœ¬:"
          find firmware-config/scripts -name "*.sh" -type f -exec ls -la {} \;
      
      # æ­¥éª¤3ï¼šè¿è¡Œä¿®å¤è„šæœ¬ï¼ˆå¯é€‰ï¼‰
      - name: "ğŸ”§ 3. è¿è¡Œä¿®å¤è„šæœ¬"
        if: github.event.inputs.use_fix_script == 'true'
        run: |
          echo "=== è¿è¡Œä¿®å¤è„šæœ¬ ==="
          
          # éªŒè¯è„šæœ¬å¯æ‰§è¡Œ
          if [ -x "firmware-config/scripts/fix-build.sh" ]; then
            echo "âœ… ä¿®å¤è„šæœ¬å¯æ‰§è¡Œ"
            firmware-config/scripts/fix-build.sh quick
          else
            echo "âŒ ä¿®å¤è„šæœ¬ä¸å¯æ‰§è¡Œï¼Œè·³è¿‡"
          fi
      
      # æ­¥éª¤4ï¼šå‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: "ğŸ“ 4. å‡†å¤‡ç¯å¢ƒ"
        run: |
          echo "=== å‡†å¤‡æ„å»ºç¯å¢ƒ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step4_prepare_environment
      
      # ========== é˜¶æ®µ2ï¼šç¯å¢ƒè®¾ç½® ==========
      
      # æ­¥éª¤5ï¼šè®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      - name: "ğŸ› ï¸ 5. è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
        run: |
          echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step5_setup_environment
      
      # æ­¥éª¤6ï¼šåˆ›å»ºæ„å»ºç›®å½•
      - name: "ğŸ“ 6. åˆ›å»ºæ„å»ºç›®å½•"
        run: |
          echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step6_create_build_dir
      
      # æ­¥éª¤7ï¼šæ£€æŸ¥å·¥å…·é“¾ç›®å½•
      - name: "ğŸ—‚ï¸ 7. æ£€æŸ¥å·¥å…·é“¾ç›®å½•"
        run: |
          echo "=== æ£€æŸ¥å·¥å…·é“¾ç›®å½• ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step7_check_toolchain_dir
      
      # æ­¥éª¤8ï¼šåˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      - name: "ğŸš€ 8. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step8_init_build_env \
            "${{ github.event.inputs.device_name }}" \
            "${{ github.event.inputs.version_selection }}" \
            "${{ github.event.inputs.config_mode }}" \
            "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤9ï¼šæ˜¾ç¤ºé…ç½®
      - name: "âš¡ 9. æ˜¾ç¤ºé…ç½®"
        run: |
          echo "=== æ˜¾ç¤ºé…ç½® ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step9_show_config
      
      # ========== é˜¶æ®µ3ï¼šæºç ç®¡ç† ==========
      
      # æ­¥éª¤10ï¼šä¸‹è½½æºä»£ç 
      - name: "ğŸ“¥ 10. ä¸‹è½½æºä»£ç "
        run: |
          echo "=== ä¸‹è½½æºä»£ç  ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step10_download_source
      
      # ========== é˜¶æ®µ4ï¼šé…ç½®ç”Ÿæˆ ==========
      
      # æ­¥éª¤11ï¼šæ·»åŠ TurboACCæ”¯æŒ
      - name: "ğŸ”Œ 11. æ·»åŠ TurboACCæ”¯æŒ"
        if: github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ·»åŠ TurboACCæ”¯æŒ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step11_add_turboacc_support
      
      # æ­¥éª¤12ï¼šé…ç½®Feeds
      - name: "ğŸ“¦ 12. é…ç½®Feeds"
        run: |
          echo "=== é…ç½®Feeds ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step12_configure_feeds
      
      # æ­¥éª¤13ï¼šå®‰è£…TurboACCåŒ…
      - name: "ğŸ”§ 13. å®‰è£…TurboACCåŒ…"
        if: github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== å®‰è£…TurboACCåŒ… ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step13_install_turboacc_packages
      
      # æ­¥éª¤14ï¼šç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 14. ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== ç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step14_space_check
      
      # æ­¥éª¤15ï¼šç”Ÿæˆé…ç½®
      - name: "âš™ï¸ 15. ç”Ÿæˆé…ç½®"
        run: |
          echo "=== ç”Ÿæˆé…ç½® ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step15_generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤16ï¼šéªŒè¯USBé…ç½®
      - name: "ğŸ” 16. éªŒè¯USBé…ç½®"
        run: |
          echo "=== éªŒè¯USBé…ç½® ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step16_verify_usb_config
      
      # æ­¥éª¤17ï¼šUSBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "ğŸ›¡ï¸ 17. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step17_check_usb_drivers_integrity
      
      # æ­¥éª¤18ï¼šåº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "âœ… 18. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step18_apply_config
      
      # æ­¥éª¤19ï¼šå¤‡ä»½é…ç½®
      - name: "ğŸ’¾ 19. å¤‡ä»½é…ç½®"
        run: |
          echo "=== å¤‡ä»½é…ç½® ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step19_backup_config
      
      # ========== é˜¶æ®µ5ï¼šå·¥å…·é“¾å’Œä¾èµ– ==========
      
      # æ­¥éª¤20ï¼šä¿®å¤ç½‘ç»œ
      - name: "ğŸŒ 20. ä¿®å¤ç½‘ç»œ"
        run: |
          echo "=== ä¿®å¤ç½‘ç»œ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step20_fix_network
      
      # æ­¥éª¤21ï¼šåŠ è½½å·¥å…·é“¾
      - name: "ğŸ”§ 21. åŠ è½½å·¥å…·é“¾"
        run: |
          echo "=== åŠ è½½å·¥å…·é“¾ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step21_load_toolchain
      
      # æ­¥éª¤22ï¼šæ£€æŸ¥å·¥å…·é“¾çŠ¶æ€
      - name: "ğŸ“Š 22. æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€"
        run: |
          echo "=== æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step22_check_toolchain_status
      
      # æ­¥éª¤23ï¼šä¸‹è½½ä¾èµ–åŒ…
      - name: "ğŸ“¥ 23. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step23_download_dependencies
      
      # æ­¥éª¤24ï¼šé›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "ğŸ”Œ 24. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step24_integrate_custom_files
      
      # ========== é˜¶æ®µ6ï¼šæ„å»ºå‰å‡†å¤‡ ==========
      
      # æ­¥éª¤25ï¼šå‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "ğŸš¨ 25. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          echo "=== å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step25_pre_build_error_check
      
      # æ­¥éª¤26ï¼šæœ€ç»ˆç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 26. æœ€ç»ˆç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æœ€ç»ˆç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step26_final_space_check
      
      # æ­¥éª¤27ï¼šç¼–è¯‘å‰ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“
      - name: "ğŸ’¾ 27. ç¼–è¯‘å‰ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“"
        if: github.event.inputs.save_toolchain_to_repo == 'true'
        run: |
          echo "=== ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ ==="
          
          # ä¿å­˜å·¥å…·é“¾
          if [ -x "firmware-config/scripts/build_firmware_main.sh" ]; then
            firmware-config/scripts/build_firmware_main.sh save_essential_toolchain
          else
            echo "âŒ ä¸»è„šæœ¬ä¸å¯æ‰§è¡Œï¼Œè·³è¿‡ä¿å­˜å·¥å…·é“¾"
          fi
          
          # æäº¤åˆ°ä»“åº“
          echo "æäº¤å·¥å…·é“¾åˆ°Gitä»“åº“..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # åªæäº¤å·¥å…·é“¾ç›®å½•
          git add firmware-config/Toolchain/
          
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å·¥å…·é“¾æ›´æ”¹éœ€è¦æäº¤"
          else
            git commit -m "ä¿å­˜ç¼–è¯‘å·¥å…·é“¾ [$(date '+%Y-%m-%d %H:%M:%S')]"
            git push || echo "âš ï¸ å·¥å…·é“¾æäº¤å¤±è´¥ï¼Œå¯èƒ½ç¼ºå°‘å†™å…¥æƒé™"
          fi
      
      # ========== é˜¶æ®µ7ï¼šæ„å»ºå›ºä»¶ ==========
      
      # æ­¥éª¤28ï¼šç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰
      - name: "ğŸ”¨ 28. ç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰"
        run: |
          echo "=== ç¼–è¯‘å›ºä»¶ ==="
          echo "ç¼–è¯‘ç¼“å­˜çŠ¶æ€: $ENABLE_CACHE"
          firmware-config/scripts/build_firmware_main.sh workflow_main step28_build_firmware "$ENABLE_CACHE"
      
      # ========== é˜¶æ®µ8ï¼šæ„å»ºåå¤„ç† ==========
      
      # æ­¥éª¤29ï¼šæ„å»ºåˆ†æ
      - name: "ğŸ“Š 29. æ„å»ºåˆ†æ"
        if: always()
        run: |
          echo "=== æ„å»ºåˆ†æ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step29_build_analysis "${{ job.status }}"
      
      # æ­¥éª¤30ï¼šç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "ğŸ“Š 30. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step30_post_build_space_check
      
      # æ­¥éª¤31ï¼šå›ºä»¶æ–‡ä»¶æ£€æŸ¥
      - name: "ğŸ“¦ 31. å›ºä»¶æ–‡ä»¶æ£€æŸ¥"
        if: success()
        run: |
          echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step31_check_firmware_files
      
      # æ­¥éª¤32ï¼šä¸Šä¼ å›ºä»¶
      - name: "â¬†ï¸ 32. ä¸Šä¼ å›ºä»¶"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: "firmware-${{ github.event.inputs.device_name }}-${{ github.run_id }}"
          path: /mnt/openwrt-build/openwrt/bin/targets/
          retention-days: 7
      
      # æ­¥éª¤33ï¼šä¸Šä¼ æ—¥å¿—
      - name: "â¬†ï¸ 33. ä¸Šä¼ æ—¥å¿—"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "build-log-${{ github.event.inputs.device_name }}-${{ github.run_id }}"
          path: /mnt/openwrt-build/openwrt/build.log
          retention-days: 7
      
      # æ­¥éª¤34ï¼šä¸Šä¼ é…ç½®å¤‡ä»½
      - name: "â¬†ï¸ 34. ä¸Šä¼ é…ç½®å¤‡ä»½"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "config-backup-${{ github.event.inputs.device_name }}-${{ github.run_id }}"
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      # ========== é˜¶æ®µ9ï¼šæ¸…ç†å’Œæ€»ç»“ ==========
      
      # æ­¥éª¤35ï¼šæ¸…ç†ç›®å½•
      - name: "ğŸ§¹ 35. æ¸…ç†ç›®å½•"
        if: always()
        run: |
          echo "=== æ¸…ç†ç›®å½• ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step35_cleanup
      
      # æ­¥éª¤36ï¼šæœ€ç»ˆæ€»ç»“
      - name: "ğŸ“ˆ 36. æœ€ç»ˆæ€»ç»“"
        if: always()
        run: |
          echo "=== æ„å»ºæ€»ç»“ ==="
          firmware-config/scripts/build_firmware_main.sh workflow_main step36_final_summary "${{ job.status }}"
