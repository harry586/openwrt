name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆä¿®å¤ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
          - '23.05'
          - '21.02'
      config_mode:
        description: 'âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©'
        required: true
        type: choice
        default: 'normal'
        options:
          - 'base'
          - 'normal'
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šç”¨é¡¿å·ã€åˆ†éš”ï¼Œå¦‚ï¼š+luci-app-wolã€+luci-app-ddns'
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜'
        required: false
        default: true
        type: boolean
      rebuild_toolchain:
        description: 'ğŸ”„ å¼ºåˆ¶é‡æ–°æ„å»ºå·¥å…·é“¾'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'ğŸ› å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  TOOLCHAIN_DIR: /mnt/openwrt-toolchain
  WORKSPACE: ${{ github.workspace }}
  DEBUG_MODE: ${{ github.event.inputs.debug_mode }}

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: openwrt-config

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        chmod +x openwrt-config/firmware-config/scripts/*.sh

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        echo ""
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "ğŸ“Š /mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo cmake jq ccache u-boot-tools gperf nodejs npm swig time xsltproc libxml2-utils tree jq rsync

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR $TOOLCHAIN_DIR
        sudo chown -R $USER:$USER $BUILD_DIR $TOOLCHAIN_DIR
        sudo chmod -R 755 $BUILD_DIR $TOOLCHAIN_DIR

    - name: å¤åˆ¶é…ç½®æ–‡ä»¶
      run: |
        echo "=== å¤åˆ¶é…ç½®æ–‡ä»¶ ==="
        cp openwrt-config/firmware-config/scripts/build_firmware_main.sh $BUILD_DIR/
        chmod +x $BUILD_DIR/*.sh

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      id: init_env
      run: |
        echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
        echo "è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
        
        # è¿›å…¥æ„å»ºç›®å½•
        cd $BUILD_DIR
        
        # æ¸…ç†ç›®å½•ï¼Œä½†ä¿ç•™è„šæœ¬
        echo "æ¸…ç†æ„å»ºç›®å½•ï¼ˆä¿ç•™è„šæœ¬ï¼‰..."
        
        # å¤‡ä»½è„šæœ¬æ–‡ä»¶åˆ°ä¸´æ—¶ä½ç½®
        if [ -f "build_firmware_main.sh" ]; then
          echo "å¤‡ä»½ build_firmware_main.sh"
          cp build_firmware_main.sh /tmp/build_firmware_main.sh.bak
        fi
        
        # æ˜¾ç¤ºå½“å‰ç›®å½•å†…å®¹
        echo "æ¸…ç†å‰ç›®å½•å†…å®¹:"
        ls -la
        
        # åˆ é™¤æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•ï¼ˆåŒ…æ‹¬éšè—çš„.gitç›®å½•ï¼‰
        echo "æ‰§è¡Œæ¸…ç†..."
        find . -mindepth 1 ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true
        
        # æ¢å¤è„šæœ¬
        if [ -f "/tmp/build_firmware_main.sh.bak" ]; then
          echo "æ¢å¤ build_firmware_main.sh"
          cp /tmp/build_firmware_main.sh.bak build_firmware_main.sh
          chmod +x build_firmware_main.sh
          rm -f /tmp/build_firmware_main.sh.bak
        fi
        
        # æ˜¾ç¤ºæ¸…ç†åç›®å½•å†…å®¹
        echo "æ¸…ç†åç›®å½•å†…å®¹:"
        ls -la
        
        # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›è„šæœ¬ä½¿ç”¨
        export DEBUG_MODE="$DEBUG_MODE"
        
        # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
        ./build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"
        
        # æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶æ˜¯å¦åˆ›å»º
        if [ -f "build_env.sh" ]; then
          echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²åˆ›å»º"
          source build_env.sh
          
          # è¾“å‡ºåˆ°GitHubç¯å¢ƒå˜é‡
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_OUTPUT
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_OUTPUT
          echo "DEVICE=$DEVICE" >> $GITHUB_ENV
          echo "DEVICE=$DEVICE" >> $GITHUB_OUTPUT
          echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
        else
          echo "âŒ ç¯å¢ƒæ–‡ä»¶æœªåˆ›å»º"
          exit 1
        fi

    - name: æ£€æŸ¥ä»“åº“ä¸­çš„å·¥å…·é“¾
      run: |
        echo "=== æ£€æŸ¥ä»“åº“ä¸­çš„å·¥å…·é“¾ ==="
        TOOLCHAIN_ID="${{ steps.init_env.outputs.SELECTED_BRANCH }}-${{ steps.init_env.outputs.TARGET }}-${{ steps.init_env.outputs.SUBTARGET }}"
        echo "å·¥å…·é“¾ID: $TOOLCHAIN_ID"
        
        if [ -d "openwrt-config/toolchain-cache/$TOOLCHAIN_ID" ]; then
          echo "âœ… ä»“åº“ä¸­å­˜åœ¨å·¥å…·é“¾: $TOOLCHAIN_ID"
          echo "TOOLCHAIN_EXISTS=true" >> $GITHUB_ENV
        else
          echo "âŒ ä»“åº“ä¸­æ— å·¥å…·é“¾ï¼Œéœ€è¦æ„å»º"
          echo "TOOLCHAIN_EXISTS=false" >> $GITHUB_ENV
        fi

    - name: ä»ä»“åº“æ¢å¤å·¥å…·é“¾
      if: env.TOOLCHAIN_EXISTS == 'true' && github.event.inputs.rebuild_toolchain == 'false'
      run: |
        echo "=== ä»ä»“åº“æ¢å¤å·¥å…·é“¾ ==="
        TOOLCHAIN_ID="${{ steps.init_env.outputs.SELECTED_BRANCH }}-${{ steps.init_env.outputs.TARGET }}-${{ steps.init_env.outputs.SUBTARGET }}"
        
        echo "æ¢å¤å·¥å…·é“¾: $TOOLCHAIN_ID"
        mkdir -p "$TOOLCHAIN_DIR/$TOOLCHAIN_ID"
        
        if [ -d "openwrt-config/toolchain-cache/$TOOLCHAIN_ID" ]; then
          echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
          cp -r "openwrt-config/toolchain-cache/$TOOLCHAIN_ID/"* "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/" 2>/dev/null || true
          
          if [ -f "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/toolchain_info.txt" ]; then
            echo "âœ… å·¥å…·é“¾æ¢å¤æˆåŠŸ"
            cat "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/toolchain_info.txt"
            echo "TOOLCHAIN_RESTORED=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ å·¥å…·é“¾æ–‡ä»¶ä¸å®Œæ•´"
            echo "TOOLCHAIN_RESTORED=false" >> $GITHUB_ENV
          fi
        else
          echo "âŒ å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨"
          echo "TOOLCHAIN_RESTORED=false" >> $GITHUB_ENV
        fi

    - name: é…ç½®Feeds
      run: |
        echo "=== é…ç½®Feeds ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh configure_feeds

    - name: æ·»åŠ TurboACCæ”¯æŒ
      if: github.event.inputs.config_mode == 'normal' && steps.init_env.outputs.SELECTED_BRANCH == 'openwrt-23.05'
      run: |
        echo "=== æ·»åŠ TurboACCæ”¯æŒ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh add_turboacc_support

    - name: å®‰è£…æ’ä»¶åŒ…
      run: |
        echo "=== å®‰è£…æ’ä»¶åŒ… ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh install_filetransfer_packages

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      run: |
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"

    - name: éªŒè¯USBé…ç½®
      run: |
        echo "=== éªŒè¯USBé…ç½® ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh verify_usb_config

    - name: åº”ç”¨é…ç½®
      run: |
        echo "=== åº”ç”¨é…ç½® ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh apply_config

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh fix_network

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh download_dependencies

    - name: å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶
      run: |
        echo "=== å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh process_custom_files

    - name: ç¼–è¯‘å›ºä»¶
      id: build_firmware
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        
        START_TIME=$(date +%s)
        ./build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"
        BUILD_EXIT_CODE=$?
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        echo "â±ï¸ ç¼–è¯‘è€—æ—¶: $((DURATION / 60))åˆ†é’Ÿ $((DURATION % 60))ç§’"
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
        fi

    - name: æ„å»ºå·¥å…·é“¾ï¼ˆå¦‚éœ€ï¼‰
      if: env.TOOLCHAIN_EXISTS == 'false' || github.event.inputs.rebuild_toolchain == 'true'
      run: |
        echo "=== æ„å»ºå·¥å…·é“¾ ==="
        cd $BUILD_DIR
        
        if [ -f "build_env.sh" ]; then
          source build_env.sh
        fi
        
        SELECTED_BRANCH="${{ steps.init_env.outputs.SELECTED_BRANCH }}"
        TARGET="${{ steps.init_env.outputs.TARGET }}"
        SUBTARGET="${{ steps.init_env.outputs.SUBTARGET }}"
        DEVICE="${{ steps.init_env.outputs.DEVICE }}"
        
        echo "æ„å»ºå·¥å…·é“¾: $SELECTED_BRANCH-$TARGET-$SUBTARGET"
        
        echo "CONFIG_TARGET_${TARGET}=y" > .config.toolchain
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config.toolchain
        echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config.toolchain
        echo "CONFIG_TOOLCHAIN=y" >> .config.toolchain
        echo "CONFIG_TOOLCHAIN_BUILD=y" >> .config.toolchain
        echo "CONFIG_SDK=y" >> .config.toolchain
        echo "CONFIG_IB=y" >> .config.toolchain
        
        cp .config.toolchain .config
        make defconfig
        
        echo "å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
        make toolchain/install -j$(nproc) V=s
        
        TOOLCHAIN_ID="$SELECTED_BRANCH-$TARGET-$SUBTARGET"
        mkdir -p "$TOOLCHAIN_DIR/$TOOLCHAIN_ID"
        
        if [ -d "staging_dir" ]; then
          echo "ä¿å­˜å·¥å…·é“¾åˆ°: $TOOLCHAIN_DIR/$TOOLCHAIN_ID"
          cp -r staging_dir "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/" 2>/dev/null || true
          
          echo "ç‰ˆæœ¬: $SELECTED_BRANCH" > "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/toolchain_info.txt"
          echo "ç›®æ ‡: $TARGET-$SUBTARGET" >> "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/toolchain_info.txt"
          echo "è®¾å¤‡: $DEVICE" >> "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/toolchain_info.txt"
          echo "ç¼–è¯‘æ—¶é—´: $(date)" >> "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/toolchain_info.txt"
          echo "å¤§å°: $(du -sh staging_dir 2>/dev/null | cut -f1)" >> "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/toolchain_info.txt"
        fi

    - name: ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“
      if: always() && steps.init_env.outputs.SELECTED_BRANCH != ''
      run: |
        echo "=== ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ ==="
        TOOLCHAIN_ID="${{ steps.init_env.outputs.SELECTED_BRANCH }}-${{ steps.init_env.outputs.TARGET }}-${{ steps.init_env.outputs.SUBTARGET }}"
        
        if [ -d "$TOOLCHAIN_DIR/$TOOLCHAIN_ID" ]; then
          echo "ä¿å­˜å·¥å…·é“¾: $TOOLCHAIN_ID"
          mkdir -p "openwrt-config/toolchain-cache/$TOOLCHAIN_ID"
          
          echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
          cp -r "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/"* "openwrt-config/toolchain-cache/$TOOLCHAIN_ID/" 2>/dev/null || true
          
          echo "å·¥å…·é“¾ä¿å­˜å®Œæˆ"
        else
          echo "âŒ å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜"
        fi

    - name: æäº¤å·¥å…·é“¾åˆ°Gitä»“åº“
      if: always() && steps.init_env.outputs.SELECTED_BRANCH != ''
      run: |
        echo "=== æäº¤å·¥å…·é“¾åˆ°Gitä»“åº“ ==="
        
        cd openwrt-config
        
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        if [ -d "toolchain-cache" ]; then
          echo "æ·»åŠ å·¥å…·é“¾æ–‡ä»¶åˆ°Git..."
          git add toolchain-cache/ || echo "æ²¡æœ‰å·¥å…·é“¾æ–‡ä»¶å¯æ·»åŠ "
          
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ä¿å­˜å·¥å…·é“¾: ${{ steps.init_env.outputs.SELECTED_BRANCH }}-${{ steps.init_env.outputs.TARGET }}-${{ steps.init_env.outputs.SUBTARGET }} [skip ci]"
            git push origin HEAD || echo "æ¨é€å¤±è´¥"
          fi
        else
          echo "âŒ toolchain-cacheç›®å½•ä¸å­˜åœ¨"
        fi

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      run: |
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh check_firmware_files

    - name: ä¸Šä¼ å›ºä»¶
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ steps.init_env.outputs.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 30

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/*.log
          ${{ env.BUILD_DIR }}/config_backup/
        retention-days: 30

    - name: æ˜¾ç¤ºå·¥å…·é“¾ç»Ÿè®¡ä¿¡æ¯
      if: always()
      run: |
        echo "=== å·¥å…·é“¾ç»Ÿè®¡ä¿¡æ¯ ==="
        echo "å·¥å…·é“¾ä¿å­˜ä½ç½®: toolchain-cache/"
        
        if [ -d "openwrt-config/toolchain-cache" ]; then
          echo "å·¥å…·é“¾åˆ—è¡¨:"
          ls -la openwrt-config/toolchain-cache/
          echo ""
          echo "æ€»å¤§å°: $(du -sh openwrt-config/toolchain-cache | cut -f1)"
        else
          echo "âŒ toolchain-cacheç›®å½•ä¸å­˜åœ¨"
        fi
