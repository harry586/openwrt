name: OpenWrt 智能固件构建工作流

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (如: ac42u, wr841n, mi3g)'
        required: true
        default: 'ac42u'
        type: string
      old_device:
        description: '是否为老旧设备'
        required: true
        default: false
        type: boolean
      version_spec:
        description: '版本规格 (可选，如: openwrt-23.05 或 immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_type:
        description: '配置类型'
        required: true
        default: 'minimal'
        type: choice
        options: ['minimal', 'normal', 'custom']
      extra_packages:
        description: '额外安装插件 (空格分隔)'
        required: false
        type: string

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出配置仓库（完整深度）
      uses: actions/checkout@v4
      with:
        path: openwrt-config
        fetch-depth: 0  # 完整克隆，不是浅层克隆

    - name: 详细文件结构检查
      run: |
        echo "=== 详细目录结构 ==="
        pwd
        ls -la
        echo "=== openwrt-config 目录结构 ==="
        ls -la openwrt-config/
        echo "=== 查找所有脚本文件 ==="
        find . -name "*.sh" -type f | head -20
        echo "=== 检查 firmware-config 目录 ==="
        find . -type d -name "firmware-config" | head -10
        echo "=== 检查 scripts 目录 ==="
        find . -type d -name "scripts" | grep -E "(firmware|config)" | head -10

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libssl-dev python3 unzip zlib1g-dev subversion gcc-multilib git curl

    - name: 创建构建目录
      run: |
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR

    - name: 智能查找并复制检测脚本
      id: find-scripts
      run: |
        cd $BUILD_DIR
        echo "=== 智能查找脚本文件 ==="
        
        # 定义可能的脚本路径
        POSSIBLE_PATHS=(
          "../openwrt-config/firmware-config/scripts"
          "openwrt-config/firmware-config/scripts"
          "../openwrt-config/scripts"
          "openwrt-config/scripts"
          "../scripts"
          "scripts"
        )
        
        # 查找版本检测脚本
        VERSION_SCRIPT_FOUND=""
        DEVICE_SCRIPT_FOUND=""
        
        for path in "${POSSIBLE_PATHS[@]}"; do
          if [ -f "$path/complete_version_detector.sh" ]; then
            VERSION_SCRIPT_FOUND="$path/complete_version_detector.sh"
            echo "找到版本检测脚本: $VERSION_SCRIPT_FOUND"
          fi
          if [ -f "$path/device_detection.sh" ]; then
            DEVICE_SCRIPT_FOUND="$path/device_detection.sh"
            echo "找到设备检测脚本: $DEVICE_SCRIPT_FOUND"
          fi
        done
        
        # 如果没找到，尝试更广泛的搜索
        if [ -z "$VERSION_SCRIPT_FOUND" ] || [ -z "$DEVICE_SCRIPT_FOUND" ]; then
          echo "=== 广泛搜索脚本文件 ==="
          VERSION_SCRIPT_FOUND=$(find .. -name "complete_version_detector.sh" -type f 2>/dev/null | head -1)
          DEVICE_SCRIPT_FOUND=$(find .. -name "device_detection.sh" -type f 2>/dev/null | head -1)
        fi
        
        # 验证并复制脚本
        if [ -n "$VERSION_SCRIPT_FOUND" ] && [ -n "$DEVICE_SCRIPT_FOUND" ]; then
          echo "复制版本检测脚本: $VERSION_SCRIPT_FOUND"
          cp "$VERSION_SCRIPT_FOUND" ./complete_version_detector.sh
          echo "复制设备检测脚本: $DEVICE_SCRIPT_FOUND"
          cp "$DEVICE_SCRIPT_FOUND" ./device_detection.sh
          chmod +x complete_version_detector.sh device_detection.sh
          echo "✅ 脚本复制成功"
          echo "scripts_copied=true" >> $GITHUB_OUTPUT
        else
          echo "❌ 无法找到所需的脚本文件"
          echo "版本检测脚本: $VERSION_SCRIPT_FOUND"
          echo "设备检测脚本: $DEVICE_SCRIPT_FOUND"
          echo "scripts_copied=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "验证复制的脚本:"
        ls -la *.sh

    - name: 创建备用检测脚本（如果找不到）
      if: steps.find-scripts.outputs.scripts_copied == 'false'
      run: |
        cd $BUILD_DIR
        echo "=== 创建备用检测脚本 ==="
        
        # 创建基础版本检测脚本
        cat > complete_version_detector.sh << 'EOF'
        #!/bin/bash
        set -e
        
        DEVICE_NAME="$1"
        VERSION_SPEC="$2"
        OLD_DEVICE="$3"
        
        echo "设备: $DEVICE_NAME"
        echo "版本规格: $VERSION_SPEC"
        echo "老旧设备: $OLD_DEVICE"
        
        # 默认选择
        if [ -n "$VERSION_SPEC" ]; then
          # 解析版本规格
          if [[ "$VERSION_SPEC" == *"immortalwrt"* ]]; then
            SELECTED_REPO="immortalwrt"
            SELECTED_BRANCH="master"
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
          elif [[ "$VERSION_SPEC" == *"23.05"* ]]; then
            SELECTED_REPO="openwrt"
            SELECTED_BRANCH="openwrt-23.05"
            SELECTED_REPO_URL="https://git.openwrt.org/openwrt/openwrt.git"
          else
            SELECTED_REPO="openwrt"
            SELECTED_BRANCH="main"
            SELECTED_REPO_URL="https://git.openwrt.org/openwrt/openwrt.git"
          fi
        else
          # 根据设备类型选择
          if [ "$OLD_DEVICE" = "true" ]; then
            SELECTED_REPO="openwrt"
            SELECTED_BRANCH="openwrt-22.03"
            SELECTED_REPO_URL="https://git.openwrt.org/openwrt/openwrt.git"
          else
            SELECTED_REPO="openwrt"
            SELECTED_BRANCH="main"
            SELECTED_REPO_URL="https://git.openwrt.org/openwrt/openwrt.git"
          fi
        fi
        
        echo "SELECTED_REPO=$SELECTED_REPO" > version_info.txt
        echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> version_info.txt
        echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> version_info.txt
        
        echo "选择的仓库: $SELECTED_REPO"
        echo "选择的分支: $SELECTED_BRANCH"
        echo "仓库URL: $SELECTED_REPO_URL"
        
        exit 0
        EOF
        
        # 创建基础设备检测脚本
        cat > device_detection.sh << 'EOF'
        #!/bin/bash
        set -e
        
        DEVICE_NAME="$1"
        
        echo "检测设备: $DEVICE_NAME"
        
        # 简单的设备映射
        case "$DEVICE_NAME" in
          ac42u|ax42u|redmi_ax6s)
            PLATFORM="mediatek"
            DEVICE_SHORT_NAME="xiaomi_redmi-ax6s"
            DEVICE_FULL_NAME="Xiaomi Redmi AX6S"
            ;;
          wr841n|tl-wr841n)
            PLATFORM="ar71xx"
            DEVICE_SHORT_NAME="tl-wr841n-v9"
            DEVICE_FULL_NAME="TP-Link TL-WR841N"
            ;;
          mi3g|xiaomi_mi3g)
            PLATFORM="ramips"
            DEVICE_SHORT_NAME="xiaomi_mi-router-3g"
            DEVICE_FULL_NAME="Xiaomi Mi Router 3G"
            ;;
          *)
            # 默认值
            PLATFORM="ramips"
            DEVICE_SHORT_NAME="generic"
            DEVICE_FULL_NAME="Generic Device"
            ;;
        esac
        
        echo "PLATFORM=$PLATFORM" > device_info.txt
        echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> device_info.txt
        echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> device_info.txt
        
        echo "平台: $PLATFORM"
        echo "设备短名: $DEVICE_SHORT_NAME"
        echo "设备全名: $DEVICE_FULL_NAME"
        
        exit 0
        EOF
        
        chmod +x complete_version_detector.sh device_detection.sh
        echo "✅ 备用脚本创建完成"

    # 其余步骤保持不变...
    - name: 智能版本检测
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== 智能版本检测 ==="
        
        # 运行完整版本检测器
        if ./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_spec }}" "${{ github.event.inputs.old_device }}"; then
          echo "✅ 版本检测成功"
          # 从版本信息文件中读取变量
          if [ -f "version_info.txt" ]; then
            source version_info.txt
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
          fi
          echo "SELECTED_REPO: $SELECTED_REPO"
          echo "SELECTED_BRANCH: $SELECTED_BRANCH"
          echo "SELECTED_REPO_URL: $SELECTED_REPO_URL"
        else
          echo "❌ 版本检测失败"
          exit 1
        fi

    # ... 其余步骤与之前相同
