name: OpenWrt æ™ºèƒ½å›ºä»¶æž„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ðŸ“± è®¾å¤‡åç§°'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ðŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
          - '23.05'
          - '21.02'
      config_mode:
        description: 'âš™ï¸ é…ç½®æ¨¡å¼'
        required: true
        type: choice
        default: 'normal'
        options:
          - 'base'
          - 'normal'
      debug_mode:
        description: 'ðŸ› å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  TOOLCHAIN_DIR: /mnt/openwrt-toolchain
  WORKSPACE: ${{ github.workspace }}
  DEBUG_MODE: ${{ github.event.inputs.debug_mode }}

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: openwrt-config

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        chmod +x openwrt-config/firmware-config/scripts/*.sh

    - name: åˆ›å»ºæž„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæž„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR $TOOLCHAIN_DIR
        sudo chown -R $USER:$USER $BUILD_DIR $TOOLCHAIN_DIR
        sudo chmod -R 755 $BUILD_DIR $TOOLCHAIN_DIR

    - name: å¤åˆ¶é…ç½®æ–‡ä»¶
      run: |
        echo "=== å¤åˆ¶é…ç½®æ–‡ä»¶ ==="
        cp openwrt-config/firmware-config/scripts/build_firmware_main.sh $BUILD_DIR/
        chmod +x $BUILD_DIR/*.sh

    - name: åˆå§‹åŒ–æž„å»ºçŽ¯å¢ƒ
      id: init_env
      run: |
        echo "=== åˆå§‹åŒ–æž„å»ºçŽ¯å¢ƒ ==="
        echo "è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "å·¥ä½œåŒº: $WORKSPACE"
        
        cd $BUILD_DIR
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡ä¾›è„šæœ¬ä½¿ç”¨
        export DEBUG_MODE="$DEBUG_MODE"
        
        ./build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"
        
        if [ -f "build_env.sh" ]; then
          source build_env.sh
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_OUTPUT
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_OUTPUT
          echo "DEVICE=$DEVICE" >> $GITHUB_ENV
          echo "DEVICE=$DEVICE" >> $GITHUB_OUTPUT
        else
          echo "âŒ çŽ¯å¢ƒæ–‡ä»¶æœªåˆ›å»º"
          exit 1
        fi

    - name: é…ç½®Feeds
      run: |
        echo "=== é…ç½®Feeds ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh configure_feeds

    - name: æ·»åŠ TurboACCæ”¯æŒ
      if: github.event.inputs.config_mode == 'normal' && steps.init_env.outputs.SELECTED_BRANCH == 'openwrt-23.05'
      run: |
        echo "=== æ·»åŠ TurboACCæ”¯æŒ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh add_turboacc_support

    - name: å®‰è£…æ’ä»¶åŒ…
      run: |
        echo "=== å®‰è£…æ’ä»¶åŒ… ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh install_filetransfer_packages

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      run: |
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"

    - name: éªŒè¯USBé…ç½®
      run: |
        echo "=== éªŒè¯USBé…ç½® ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh verify_usb_config

    - name: åº”ç”¨é…ç½®
      run: |
        echo "=== åº”ç”¨é…ç½® ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh apply_config

    - name: ä¿®å¤ç½‘ç»œçŽ¯å¢ƒ
      run: |
        echo "=== ä¿®å¤ç½‘ç»œçŽ¯å¢ƒ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh fix_network

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh download_dependencies

    - name: å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶
      run: |
        echo "=== å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh process_custom_files

    - name: ç¼–è¯‘å›ºä»¶
      id: build_firmware
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        
        START_TIME=$(date +%s)
        ./build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"
        BUILD_EXIT_CODE=$?
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        echo "â±ï¸ ç¼–è¯‘è€—æ—¶: $((DURATION / 60))åˆ†é’Ÿ $((DURATION % 60))ç§’"
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
        fi

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      run: |
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        cd $BUILD_DIR
        export DEBUG_MODE="$DEBUG_MODE"
        ./build_firmware_main.sh check_firmware_files

    - name: ä¸Šä¼ å›ºä»¶
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ steps.init_env.outputs.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 30

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/*.log
          ${{ env.BUILD_DIR }}/config_backup/
        retention-days: 30
