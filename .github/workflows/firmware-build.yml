
name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆ - Git LFS ä¿®å¤ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, r3gç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®
          
          ğŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼
        required: true
        type: choice
        default: 'normal'
        options:
        - 'base'
        - 'normal'
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)'
        required: false
        default: true
        type: boolean
      commit_toolchain:
        description: 'ğŸ’¾ æäº¤å·¥å…·é“¾åˆ°ä»“åº“ (èŠ‚çœä¸‹æ¬¡ç¼–è¯‘æ—¶é—´)'
        required: false
        default: false
        type: boolean
      use_git_archive:
        description: 'ğŸ“¦ ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç ï¼ˆå¿«é€Ÿä¸‹è½½ï¼Œæ’é™¤å¤§æ–‡ä»¶ï¼‰'
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  GIT_LFS_SKIP_SMUDGE: 1

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç ï¼ˆæ’é™¤Toolchainï¼‰
      if: github.event.inputs.use_git_archive == 'true'
      run: |
        echo "=== ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç  ==="
        echo "ğŸ”„ ä»GitHub APIè·å–æºä»£ç å‹ç¼©åŒ…ï¼ˆæ’é™¤firmware-config/Toolchain/ï¼‰"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p /tmp/openwrt-source
        cd /tmp/openwrt-source
        
        # è·å–é»˜è®¤åˆ†æ”¯
        DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
        echo "é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
        
        # ä½¿ç”¨Git Archive APIä¸‹è½½å‹ç¼©åŒ…
        echo "ä¸‹è½½æºä»£ç å‹ç¼©åŒ…..."
        curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" \
          -o source.tar.gz
        
        if [ ! -f "source.tar.gz" ]; then
          echo "âŒ ä¸‹è½½æºä»£ç å‹ç¼©åŒ…å¤±è´¥"
          exit 1
        fi
        
        echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(ls -lh source.tar.gz | awk '{print $5}')"
        
        # è§£å‹å‹ç¼©åŒ…
        echo "è§£å‹æºä»£ç ..."
        tar -xzf source.tar.gz --strip-components=1
        
        # æ£€æŸ¥è§£å‹ç»“æœ
        if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
          echo "âœ… æºä»£ç è§£å‹æˆåŠŸ"
          echo "é‡è¦æ–‡ä»¶å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
          
          # å¤åˆ¶åˆ°å·¥ä½œåŒº - ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–¹å¼
          echo "å¤åˆ¶æ–‡ä»¶åˆ°å·¥ä½œåŒº..."
          
          # ç¡®ä¿å·¥ä½œåŒºç›®å½•å­˜åœ¨
          mkdir -p ${{ github.workspace }}
          
          # ä½¿ç”¨rsyncå¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼Œæ’é™¤.gitç›®å½•å’ŒToolchainç›®å½•
          rsync -av --exclude='.git' --exclude='firmware-config/Toolchain' . ${{ github.workspace }}/
          
          # ç¡®ä¿è„šæœ¬æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
          chmod +x ${{ github.workspace }}/firmware-config/scripts/*.sh 2>/dev/null || true
          
          echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          
          # ä¿å­˜æºä»£ç å‹ç¼©åŒ…ä½œä¸ºæ„å»ºäº§ç‰©
          mkdir -p /tmp/build-artifacts/source-archive
          cp source.tar.gz /tmp/build-artifacts/source-archive/
        else
          echo "âŒ æºä»£ç è§£å‹å¤±è´¥ï¼Œé‡è¦æ–‡ä»¶ç¼ºå¤±"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          exit 1
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        cd /tmp
        rm -rf openwrt-source
        echo "âœ… Git Archive APIä¸‹è½½å®Œæˆ"

    - name: å®‰è£… Git LFS
      if: github.event.inputs.use_git_archive == 'false'
      run: |
        echo "=== å®‰è£… Git LFS ==="
        sudo apt-get update
        sudo apt-get install -y git-lfs
        git lfs install --skip-smudge
        echo "âœ… Git LFS å®‰è£…å®Œæˆ"

    - name: æ£€å‡ºé…ç½®ä»“åº“ (å¯ç”¨ LFS)
      if: github.event.inputs.use_git_archive == 'false'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        lfs: true

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        find firmware-config/scripts -name "*.sh" -exec chmod +x {} \;
        echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"

    - name: è®¾ç½® Git LFS é…ç½®
      if: github.event.inputs.use_git_archive == 'false'
      run: |
        echo "=== è®¾ç½® Git LFS é…ç½® ==="
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global http.postBuffer 524288000
        git lfs install --force
        git lfs pull
        echo "âœ… Git LFS é…ç½®å®Œæˆ"

    - name: æ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€
      if: github.event.inputs.use_git_archive == 'false'
      run: |
        echo "=== æ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€ ==="
        firmware-config/scripts/build_firmware_main.sh check_large_files

    - name: å¼ºåˆ¶æ‹‰å–Git LFSæ–‡ä»¶
      if: github.event.inputs.use_git_archive == 'false'
      run: |
        echo "=== å¼ºåˆ¶æ‹‰å–Git LFSæ–‡ä»¶ ==="
        git lfs pull --force || echo "Git LFSæ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ„å»º..."
        # æ£€æŸ¥LFSæ–‡ä»¶çŠ¶æ€
        echo "Git LFSæ–‡ä»¶çŠ¶æ€:"
        git lfs ls-files | head -20 || echo "æ— LFSæ–‡ä»¶æˆ–æœªè·Ÿè¸ª"

    - name: æ£€æŸ¥å·¥å…·é“¾ç›®å½•çŠ¶æ€
      run: |
        echo "=== æ£€æŸ¥ä»“åº“ä¸­çš„å·¥å…·é“¾çŠ¶æ€ ==="
        if [ -d "firmware-config/Toolchain" ]; then
          echo "âœ… å·¥å…·é“¾ç›®å½•å­˜åœ¨"
          echo "å·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh firmware-config/Toolchain 2>/dev/null | cut -f1 || echo '0')"
          echo "å·¥å…·é“¾ç›®å½•ç»“æ„:"
          find firmware-config/Toolchain -type f -name "*.info" 2>/dev/null | head -10
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºGit LFSæŒ‡é’ˆ
          echo "æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºLFSæŒ‡é’ˆ:"
          find firmware-config/Toolchain -type f -size +10M 2>/dev/null | head -5 | while read file; do
            echo "æ£€æŸ¥: $file"
            head -c 100 "$file" | grep -q "version https://git-lfs" && echo "  âš ï¸  è¿™æ˜¯LFSæŒ‡é’ˆæ–‡ä»¶" || echo "  âœ… è¿™æ˜¯å®é™…æ–‡ä»¶"
          done
        else
          echo "â„¹ï¸  å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°ç›®å½•"
        fi

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi
        echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"

    - name: åˆå§‹åŒ–å·¥å…·é“¾ç›®å½•
      run: |
        firmware-config/scripts/build_firmware_main.sh init_toolchain_dir

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        firmware-config/scripts/build_firmware_main.sh setup_environment

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        firmware-config/scripts/build_firmware_main.sh create_build_dir

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      run: |
        echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
        echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
        firmware-config/scripts/build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"

    - name: æ·»åŠ  TurboACC æ”¯æŒ
      run: |
        firmware-config/scripts/build_firmware_main.sh add_turboacc_support

    - name: é…ç½®Feeds
      run: |
        firmware-config/scripts/build_firmware_main.sh configure_feeds

    - name: å®‰è£… TurboACC åŒ…
      if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
      run: |
        firmware-config/scripts/build_firmware_main.sh install_turboacc_packages

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh pre_build_space_check

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
      run: |
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
        echo "ğŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨å¼ºåˆ¶å¯ç”¨"
        firmware-config/scripts/build_firmware_main.sh generate_config \
          "${{ github.event.inputs.extra_packages }}"

    - name: éªŒè¯USBé…ç½®
      run: |
        echo "=== éªŒè¯USBé…ç½® ==="
        firmware-config/scripts/build_firmware_main.sh verify_usb_config

    - name: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      run: |
        echo "=== USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity

    - name: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      run: |
        echo "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
        firmware-config/scripts/build_firmware_main.sh apply_config

    - name: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶
        if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
          echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
          
          # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
          mkdir -p firmware-config/config-backup
          
          # å¤‡ä»½åˆ°ä»“åº“ç›®å½•
          backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
          
          cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
          echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
          
          # æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶ä¿¡æ¯
          echo "å¤‡ä»½æ–‡ä»¶å¤§å°: $(ls -lh $backup_file | awk '{print $5}')"
        else
          echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        firmware-config/scripts/build_firmware_main.sh fix_network

    - name: åŠ è½½å·¥å…·é“¾
      run: |
        echo "=== åŠ è½½å·¥å…·é“¾ ==="
        firmware-config/scripts/build_firmware_main.sh load_toolchain

    - name: ä¿®å¤å·¥å…·é“¾æƒé™
      run: |
        echo "=== ä¿®å¤å·¥å…·é“¾æƒé™ ==="
        cd ${{ env.BUILD_DIR }}
        
        if [ -d "staging_dir" ]; then
          echo "ä¿®å¤å·¥å…·é“¾æ–‡ä»¶æƒé™..."
          
          # æŸ¥æ‰¾æ‰€æœ‰å·¥å…·é“¾ç›®å½•
          find staging_dir -type d -name "toolchain-*" | while read toolchain_dir; do
            echo "å¤„ç†å·¥å…·é“¾: $toolchain_dir"
            
            # ä¿®å¤binç›®å½•ä¸­çš„æ–‡ä»¶æƒé™
            if [ -d "$toolchain_dir/bin" ]; then
              echo "ä¿®å¤ $toolchain_dir/bin æƒé™..."
              find "$toolchain_dir/bin" -type f -exec chmod +x {} \; 2>/dev/null || true
            fi
            
            # ä¿®å¤å¯èƒ½åœ¨å…¶ä»–ä½ç½®çš„ç¼–è¯‘å™¨æ–‡ä»¶
            echo "æŸ¥æ‰¾å¹¶ä¿®å¤ç¼–è¯‘å™¨æ–‡ä»¶..."
            find "$toolchain_dir" -type f \( -name "*gcc*" -o -name "*g++*" -o -name "*ld*" -o -name "*as*" -o -name "*ar*" \) \
              ! -name "*.stamp*" ! -name ".gcc_*" -exec chmod +x {} \; 2>/dev/null || true
          done
          
          echo "âœ… å·¥å…·é“¾æƒé™ä¿®å¤å®Œæˆ"
        else
          echo "â„¹ï¸  æœªæ‰¾åˆ°staging_dirç›®å½•"
        fi

    - name: æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€
      run: |
        echo "=== æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€ ==="
        cd ${{ env.BUILD_DIR }}
        if [ -d "staging_dir/toolchain-"* ]; then
          echo "âœ… å·¥å…·é“¾å·²åŠ è½½"
          ls -d staging_dir/toolchain-* | head -1
          echo "å·¥å…·é“¾å¤§å°: $(du -sh staging_dir/toolchain-* 2>/dev/null | head -1 | cut -f1 || echo 'æœªçŸ¥')"
          
          # éªŒè¯å·¥å…·é“¾å®Œæ•´æ€§
          echo "éªŒè¯å·¥å…·é“¾å®Œæ•´æ€§..."
          firmware-config/scripts/build_firmware_main.sh check_toolchain_completeness
        else
          echo "âŒ å·¥å…·é“¾æœªåŠ è½½"
          echo "å°†è‡ªåŠ¨ä¸‹è½½å·¥å…·é“¾..."
        fi

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        firmware-config/scripts/build_firmware_main.sh download_dependencies

    - name: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      run: |
        echo "=== é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
        firmware-config/scripts/build_firmware_main.sh integrate_custom_files

    - name: å‰ç½®é”™è¯¯æ£€æŸ¥
      run: |
        echo "=== å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh pre_build_error_check

    - name: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        
        # æ£€æŸ¥ç¼–è¯‘æ‰€éœ€ç©ºé—´
        if [ $AVAILABLE_GB -lt 10 ]; then
          echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          exit 1
        elif [ $AVAILABLE_GB -lt 20 ]; then
          echo "âš ï¸  è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
        else
          echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
        fi

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        echo "å¯ç”¨ç¼“å­˜: ${{ github.event.inputs.enable_cache }}"
        firmware-config/scripts/build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"

    - name: ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•
      if: success() && github.event.inputs.enable_cache == 'true'
      run: |
        echo "=== ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½• ==="
        echo "æ³¨æ„ï¼šå·¥å…·é“¾å°†ä¿å­˜åˆ°ä»“åº“çš„ firmware-config/Toolchain/ ç›®å½•ä¸­"
        echo "è¿™æ ·å¯ä»¥æ°¸ä¹…ä¿å­˜å·¥å…·é“¾ï¼Œä¸‹æ¬¡æ„å»ºæ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨"
        
        # ä¿å­˜å·¥å…·é“¾
        firmware-config/scripts/build_firmware_main.sh save_toolchain
        
        # æ˜¾ç¤ºä¿å­˜ç»“æœ
        echo "=== å·¥å…·é“¾ä¿å­˜ç»“æœ ==="
        if [ -d "firmware-config/Toolchain" ]; then
          echo "âœ… å·¥å…·é“¾å·²ä¿å­˜åˆ°ä»“åº“ç›®å½•"
          echo "å·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh firmware-config/Toolchain 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
          echo "å·¥å…·é“¾ç»“æ„:"
          find firmware-config/Toolchain -type d 2>/dev/null | head -20
        else
          echo "âŒ å·¥å…·é“¾ä¿å­˜å¤±è´¥"
        fi

    - name: å‡†å¤‡æäº¤å·¥å…·é“¾ï¼ˆä½¿ç”¨ Git LFSï¼‰
      if: success() && github.event.inputs.enable_cache == 'true' && github.event.inputs.commit_toolchain == 'true' && github.event.inputs.use_git_archive == 'false'
      run: |
        echo "=== å‡†å¤‡æäº¤å·¥å…·é“¾åˆ°ä»“åº“ï¼ˆä½¿ç”¨ Git LFSï¼‰==="
        echo "è¿™å°†æŠŠå·¥å…·é“¾æ–‡ä»¶æäº¤åˆ°Gitä»“åº“ï¼Œä½¿ç”¨Git LFSç®¡ç†å¤§æ–‡ä»¶"
        
        # æ£€æŸ¥å½“å‰ç›®å½•æ˜¯å¦æ˜¯Gitä»“åº“
        if [ ! -d ".git" ]; then
          echo "âŒ å½“å‰ç›®å½•ä¸æ˜¯Gitä»“åº“ï¼Œè·³è¿‡å·¥å…·é“¾æäº¤"
          echo "â„¹ï¸  åŸå› ï¼šå¯èƒ½ä½¿ç”¨äº†Git Archive APIä¸‹è½½ï¼Œæˆ–è€….gitç›®å½•ä¸å­˜åœ¨"
          exit 0
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·é“¾æ–‡ä»¶
        if [ -d "firmware-config/Toolchain" ] && [ -n "$(ls -A firmware-config/Toolchain 2>/dev/null)" ]; then
          echo "ğŸ”§ æœ‰å·¥å…·é“¾æ–‡ä»¶éœ€è¦æäº¤"
          
          # é…ç½®gitç”¨æˆ·
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æ·»åŠ .gitattributesæ–‡ä»¶ç¡®ä¿LFSé…ç½®
          echo "ğŸ”§ ç¡®ä¿.gitattributesæ–‡ä»¶å­˜åœ¨å¹¶é…ç½®æ­£ç¡®"
          if [ ! -f ".gitattributes" ]; then
            cp firmware-config/scripts/.gitattributes ./
          fi
          
          # ç¡®ä¿Git LFSå·²æ­£ç¡®è®¾ç½®
          git lfs install --force
          
          # æ·»åŠ æ‰€æœ‰å·¥å…·é“¾æ–‡ä»¶åˆ°LFSè·Ÿè¸ª
          echo "ğŸ”§ æ·»åŠ å·¥å…·é“¾æ–‡ä»¶åˆ°Git LFSè·Ÿè¸ª..."
          
          # ä½¿ç”¨Git LFSè·Ÿè¸ªå·¥å…·é“¾æ–‡ä»¶
          git add .gitattributes
          
          # æ·»åŠ å·¥å…·é“¾æ–‡ä»¶åˆ°æš‚å­˜åŒºï¼ˆGit LFSä¼šè‡ªåŠ¨å¤„ç†å¤§æ–‡ä»¶ï¼‰
          echo "ğŸ“¦ æ·»åŠ å·¥å…·é“¾æ–‡ä»¶åˆ°æš‚å­˜åŒº..."
          git add firmware-config/Toolchain/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git status --porcelain | grep -q "firmware-config/Toolchain" || git status --porcelain | grep -q ".gitattributes"; then
            echo "ğŸ“¦ æäº¤å·¥å…·é“¾æ–‡ä»¶..."
            git commit -m "chore: æ›´æ–°å·¥å…·é“¾æ–‡ä»¶ [Git LFS] - ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }} - ç›®æ ‡: ${{ env.TARGET }}/${{ env.SUBTARGET }} - è®¾å¤‡: ${{ env.DEVICE }} - æ¨¡å¼: ${{ github.event.inputs.config_mode }} - æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            
            echo "ğŸš€ æ¨é€å·¥å…·é“¾åˆ°è¿œç¨‹ä»“åº“..."
            
            # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™é‡è¯•
            for i in {1..3}; do
              echo "å°è¯•æ¨é€ #$i..."
              if git push origin HEAD:${{ github.ref_name }}; then
                echo "âœ… å·¥å…·é“¾å·²æˆåŠŸæäº¤å¹¶æ¨é€åˆ°ä»“åº“"
                break
              else
                echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
                sleep 10
                if [ $i -eq 3 ]; then
                  echo "âŒ æ¨é€å¤±è´¥3æ¬¡ï¼Œè·³è¿‡å·¥å…·é“¾æäº¤"
                  exit 0
                fi
              fi
            done
          else
            echo "â„¹ï¸  æ²¡æœ‰æ–°çš„å·¥å…·é“¾æ–‡ä»¶éœ€è¦æäº¤"
          fi
        else
          echo "â„¹ï¸  æ²¡æœ‰å·¥å…·é“¾æ–‡ä»¶éœ€è¦æäº¤"
        fi

    - name: ä¿å­˜æºä»£ç ä¿¡æ¯
      if: success()
      run: |
        echo "=== ä¿å­˜æºä»£ç ä¿¡æ¯ ==="
        
        # åˆ›å»ºæºä»£ç ä¿¡æ¯ç›®å½•
        mkdir -p /tmp/build-artifacts/source-info
        
        # ä½¿ç”¨å¤šä¸ª echo å‘½ä»¤æ›¿ä»£ heredoc
        echo "æ„å»ºä¿¡æ¯" > /tmp/build-artifacts/source-info/build_info.txt
        echo "=========" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "æ„å»ºæ—¶é—´: $(date)" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "Git Archive APIæ¨¡å¼: ${{ github.event.inputs.use_git_archive }}" >> /tmp/build-artifacts/source-info/build_info.txt
        
        echo "âœ… æºä»£ç ä¿¡æ¯ä¿å­˜å®Œæˆ"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      if: success()
      run: |
        echo "=== ä¸Šä¼ æ„å»ºäº§ç‰© ==="
        cd ${{ env.BUILD_DIR }}
        
        # åˆ›å»ºæ„å»ºäº§ç‰©ç›®å½•
        mkdir -p /tmp/build-artifacts
        
        # æ‰“åŒ…å›ºä»¶æ–‡ä»¶
        if [ -d "bin/targets" ]; then
          echo "æ‰“åŒ…å›ºä»¶æ–‡ä»¶..."
          tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
          echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆ"
        fi
        
        # æ‰“åŒ…ç¼–è¯‘æ—¥å¿—
        if [ -f "build.log" ]; then
          echo "æ‰“åŒ…ç¼–è¯‘æ—¥å¿—..."
          cp build.log /tmp/build-artifacts/build.log
          echo "âœ… æ—¥å¿—æ‰“åŒ…å®Œæˆ"
        fi
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶ï¼ˆä½¿ç”¨å¤šä¸ª echo å‘½ä»¤æ›¿ä»£ heredocï¼‰
        echo "åˆ›å»ºæ„å»ºä¿¡æ¯..."
        echo "æ„å»ºæ—¶é—´: $(date)" > /tmp/build-artifacts/build-info.txt
        echo "è®¾å¤‡: ${{ env.DEVICE }}" >> /tmp/build-artifacts/build-info.txt
        echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/build-info.txt
        echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/build-info.txt
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/build-info.txt
        
        echo "âœ… æ„å»ºäº§ç‰©å‡†å¤‡å®Œæˆ"
        echo "ğŸ“¤ æ„å»ºäº§ç‰©å·²ä¿å­˜åœ¨: /tmp/build-artifacts/"
        ls -lh /tmp/build-artifacts/

    - name: é”™è¯¯åˆ†æ
      if: failure()
      run: |
        echo "=== é”™è¯¯åˆ†æ ==="
        firmware-config/scripts/error_analysis.sh

    - name: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh post_build_space_check

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: success()
      run: |
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh check_firmware_files

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ æºä»£ç ä¿¡æ¯
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: source-info-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}
        path: /tmp/build-artifacts/source-info/
        retention-days: 7

    - name: ä¸Šä¼ æºä»£ç å‹ç¼©åŒ…ï¼ˆGit Archive APIæ¨¡å¼ï¼‰
      if: success() && github.event.inputs.use_git_archive == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: source-archive-${{ github.event.inputs.device_name }}
        path: /tmp/build-artifacts/source-archive/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: |
          ${{ github.workspace }}/firmware-config/config-backup/
        retention-days: 7

    - name: æ¸…ç†ç›®å½•ï¼ˆä¿ç•™é…ç½®æ–‡ä»¶ï¼‰
      if: always()
      run: |
        echo "=== æ¸…ç†ç›®å½•ä½†ä¿ç•™é…ç½®æ–‡ä»¶ ==="
        firmware-config/scripts/build_firmware_main.sh cleanup

    - name: è¾“å‡ºæœ€ç»ˆé…ç½®çŠ¶æ€
      if: always()
      run: |
        echo "=== æœ€ç»ˆé…ç½®çŠ¶æ€æ€»ç»“ ==="
        
        # æ£€æŸ¥å¤‡ä»½çš„é…ç½®æ–‡ä»¶
        if [ -d "firmware-config/config-backup" ]; then
          backup_count=$(find firmware-config/config-backup -name "*.config" 2>/dev/null | wc -l)
          echo "âœ… ä»“åº“é…ç½®æ–‡ä»¶å¤‡ä»½: $backup_count ä¸ª"
        fi
        
        echo ""
        echo "ğŸ› ï¸ å·¥å…·é“¾çŠ¶æ€:"
        if [ -d "firmware-config/Toolchain" ]; then
          echo "âœ… å·¥å…·é“¾ç›®å½•å­˜åœ¨: firmware-config/Toolchain/"
          
          # æ˜¾ç¤ºå·¥å…·é“¾å¤§å°
          toolchain_size=$(du -sh firmware-config/Toolchain 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
          echo "   å·¥å…·é“¾å¤§å°: $toolchain_size"
          
          # æ˜¾ç¤ºç‰ˆæœ¬ç›®å½•
          echo "   ç‰ˆæœ¬ç›®å½•:"
          ls -la firmware-config/Toolchain/ 2>/dev/null || echo "   æ— æ³•åˆ—å‡ºç›®å½•"
          
          if [ "${{ github.event.inputs.commit_toolchain }}" = "true" ] && [ "${{ github.event.inputs.enable_cache }}" = "true" ] && [ "${{ github.event.inputs.use_git_archive }}" = "false" ]; then
            echo "   å·¥å…·é“¾å·²é€šè¿‡Git LFSæäº¤åˆ°ä»“åº“ï¼Œä¸‹æ¬¡æ„å»ºå°†è‡ªåŠ¨ä½¿ç”¨"
            echo "   ğŸ’¡ æ³¨æ„: å¤§æ–‡ä»¶å·²ä½¿ç”¨Git LFSç®¡ç†ï¼Œä¸ä¼šè¶…è¿‡GitHubæ–‡ä»¶å¤§å°é™åˆ¶"
          else
            echo "   å·¥å…·é“¾æœªæäº¤åˆ°ä»“åº“ï¼Œä»…åœ¨æœ¬æ¬¡å·¥ä½œæµä¸­å¯ç”¨"
          fi
        else
          echo "âš ï¸  å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "ğŸ“ è‡ªå®šä¹‰æ–‡ä»¶çŠ¶æ€:"
        if [ -d "firmware-config/custom-files" ]; then
          custom_count=$(find firmware-config/custom-files -type f 2>/dev/null | wc -l)
          echo "âœ… è‡ªå®šä¹‰æ–‡ä»¶: $custom_count ä¸ª"
        fi
        
        echo ""
        echo "ğŸ”„ Git LFS çŠ¶æ€:"
        if command -v git-lfs >/dev/null 2>&1; then
          echo "âœ… Git LFS å·²å®‰è£…"
          git lfs ls-files 2>/dev/null | head -5 || echo "   æ— LFSæ–‡ä»¶æˆ–æœªè·Ÿè¸ª"
        else
          echo "âš ï¸  Git LFS æœªå®‰è£…"
        fi
        
        echo ""
        echo "=== æ„å»ºæµç¨‹å®Œæˆ ==="
[file content end]
