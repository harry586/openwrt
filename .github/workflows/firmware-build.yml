name: OpenWrt Firmware Build Workflow

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'Device name (e.g., ac42u)'
        required: true
        default: 'ac42u'
        type: string
      config_type:
        description: 'Configuration type (选择 custom 才能使用插件管理)'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - normal
          - custom
      extra_packages:
        description: 'Additional packages to install (space separated) - 仅 custom 类型可用'
        required: false
        type: string
      disable_packages:
        description: 'Packages to disable (space separated) - 仅 custom 类型可用'
        required: false
        type: string

env:
  WORKSPACE: ${{ github.workspace }}
  BUILD_DIR: /mnt/openwrt-build
  CONFIG_DIR: ${{ github.workspace }}/firmware-config

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1_Check initial disk space
      run: |
        echo "=== Initial disk space check ==="
        df -h
        echo "Workspace: ${{ github.workspace }}"
        echo "Build directory: $BUILD_DIR"
        
        if [ ! -d "/mnt" ]; then
          echo "Error: /mnt directory does not exist!"
          exit 1
        fi
        
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt available space: ${AVAILABLE_GB}G"
        
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "Error: /mnt has less than 50G space, currently only ${AVAILABLE_GB}G"
          exit 1
        fi
        
        echo "Space check passed: /mnt has ${AVAILABLE_GB}G available space"

    - name: 2_Checkout code repository
      uses: actions/checkout@v4

    - name: 3_Setup build environment
      run: |
        echo "Installing build environment..."
        sudo apt-get update
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 unzip zlib1g-dev libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib curl lib32gcc-s1 libc6-dev-x32 linux-libc-dev
        echo "Installing terminal support..."
        sudo apt-get install -y ncurses-term
        echo "Installing missing tools..."
        sudo apt-get install -y help2man

    - name: 4_Create build directory and set permissions
      run: |
        echo "Creating build directory: $BUILD_DIR"
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        echo "Directory permissions set"

    - name: 5_Clone source code
      run: |
        cd $BUILD_DIR
        echo "Cloning ImmortalWrt source code..."
        git clone https://github.com/immortalwrt/immortalwrt.git .
        git checkout openwrt-21.02
        echo "Source code cloned, current directory size:"
        du -sh .

    - name: 6_Update and install feeds
      run: |
        cd $BUILD_DIR
        echo "Updating and installing feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "Feeds installed, current directory size:"
        du -sh .

    - name: 7_Dynamically generate device configuration
      run: |
        cd $BUILD_DIR
        
        case "${{ github.event.inputs.device_name }}" in
          "ac42u")
            PLATFORM="ipq40xx"
            DEVICE_FULL_NAME="asus_rt-ac42u"
            ;;
          *)
            echo "Unknown device: ${{ github.event.inputs.device_name }}"
            exit 1
            ;;
        esac
        
        echo "=== 配置类型说明 ==="
        echo "minimal - 最小配置: 基础系统 + 必要驱动 + 基本网络功能"
        echo "normal  - 正常配置: 最小配置 + Web管理界面 + 常用功能"
        echo "custom  - 自定义配置: 以normal为模板 + 用户自定义插件管理"
        echo ""
        echo "选择的配置类型: ${{ github.event.inputs.config_type }}"
        
        # 检查插件输入是否在非custom类型下使用
        if [ "${{ github.event.inputs.config_type }}" != "custom" ]; then
          if [ -n "${{ github.event.inputs.extra_packages }}" ] || [ -n "${{ github.event.inputs.disable_packages }}" ]; then
            echo "警告: 插件管理仅在 custom 类型下可用，将忽略插件设置"
          fi
        else
          echo "额外安装插件: ${{ github.event.inputs.extra_packages }}"
          echo "禁用插件: ${{ github.event.inputs.disable_packages }}"
        fi
        
        chmod +x $CONFIG_DIR/scripts/generate_config.sh
        $CONFIG_DIR/scripts/generate_config.sh \
          "${{ github.event.inputs.config_type }}" \
          "$PLATFORM" \
          "$DEVICE_FULL_NAME" \
          "${{ github.event.inputs.extra_packages }}" \
          "${{ github.event.inputs.disable_packages }}" \
          "$BUILD_DIR"
        
        mkdir -p $CONFIG_DIR/configs/
        cp .config $CONFIG_DIR/configs/${{ github.event.inputs.device_name }}_final_config

    - name: 8_Use defconfig to avoid menuconfig
      run: |
        cd $BUILD_DIR
        echo "Using defconfig to avoid menuconfig calls..."
        export TERM=linux
        make defconfig

    - name: 9_Download packages
      run: |
        cd $BUILD_DIR
        echo "Downloading packages..."
        make -j8 download V=s
        echo "Download completed, current directory size:"
        du -sh .

    - name: 10_Pre-compilation space check
      run: |
        echo "=== Pre-compilation disk space check ==="
        df -h
        
        if [ ! -d "/mnt" ]; then
          echo "Error: /mnt directory does not exist!"
          exit 1
        fi
        
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt available space: ${AVAILABLE_GB}G"
        
        if [ $AVAILABLE_GB -lt 30 ]; then
          echo "Warning: /mnt has less than 30G space, currently only ${AVAILABLE_GB}G"
          echo "Compilation may fail due to insufficient space"
        else
          echo "Sufficient space available, starting compilation"
        fi
        
        cd $BUILD_DIR
        echo "Current build directory size:"
        du -sh .

    - name: 11_Compile firmware
      run: |
        cd $BUILD_DIR
        echo "Starting firmware compilation..."
        export TERM=linux
        
        # 清理可能的问题
        echo "Cleaning build environment..."
        make clean 2>/dev/null || true
        
        # 分步编译，避免package/install错误
        {
          echo "=== Step 1: Compiling toolchain ==="
          make tools/install -j$(nproc) V=s
          
          echo "=== Step 2: Compiling target toolchain ==="  
          make toolchain/install -j$(nproc) V=s
          
          echo "=== Step 3: Compiling target ==="
          make target/install -j$(nproc) V=s
          
          echo "=== Step 4: Compiling packages ==="
          # 单线程编译包，避免并发问题
          make package/compile -j1 V=sc
          
          echo "=== Step 5: Final installation ==="
          make package/install -j1 V=sc
          
          echo "=== Step 6: Generating images ==="
          make target/install -j$(nproc) V=s
          
        } 2>&1 | tee build_detailed.log
        
        # 检查编译结果
        echo "=== Compilation result check ==="
        if [ -f "build.log" ]; then
            echo "Build log exists"
            # 检查特定错误
            if grep -q "package/install.*Error 255" build.log; then
                echo "Found package/install Error 255, attempting to fix..."
                # 尝试重新编译失败的包
                make package/install -j1 V=sc 2>&1 | tee -a build_fix.log
            fi
        fi
        
        # 最终检查固件
        FIRMWARE_COUNT=$(find bin -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | wc -l)
        echo "Generated firmware count: $FIRMWARE_COUNT"

    - name: 11.5_Fix package errors if any
      if: always()
      run: |
        cd $BUILD_DIR
        echo "Checking and fixing package compilation errors..."
        
        # 检查是否有package/install错误
        if grep -q "package/install.*Error 255" build.log 2>/dev/null; then
            echo "Found package installation error, attempting to fix..."
            
            # 方法1: 清理并重新编译包
            echo "Method 1: Recompiling packages..."
            make package/cleanup 2>/dev/null || true
            make package/compile -j1 V=sc 2>&1 | tee build_fix1.log
            
            # 方法2: 如果还失败，尝试逐个编译
            if [ $? -ne 0 ]; then
                echo "Method 2: Identifying failed packages..."
                # 找出编译失败的包
                FAILED_PACKAGES=$(grep "Building package" build.log | tail -5)
                echo "Recently compiled packages: $FAILED_PACKAGES"
                
                # 尝试单独编译
                make package/install -j1 V=sc 2>&1 | tee build_fix2.log
            fi
        fi

    - name: 12_Run error analysis script
      run: |
        cd $BUILD_DIR
        chmod +x $CONFIG_DIR/scripts/error_analysis.sh
        $CONFIG_DIR/scripts/error_analysis.sh $BUILD_DIR

    - name: 13_Firmware summary analysis report
      run: |
        cd $BUILD_DIR
        echo "=== Firmware Summary Analysis Report ===" > firmware_report.log
        
        # 详细检查bin目录
        echo "=== Detailed bin directory structure ===" >> firmware_report.log
        find bin -type f 2>/dev/null | sort >> firmware_report.log
        echo "" >> firmware_report.log
        
        if [ ! -d "bin" ]; then
          echo "ERROR: bin directory does not exist, build may have failed" >> firmware_report.log
          echo "Build status: Failed" >> firmware_report.log
        else
          # 检查目标平台目录
          echo "=== Checking target directories ===" >> firmware_report.log
          find bin/targets -type f 2>/dev/null | head -20 >> firmware_report.log
          echo "" >> firmware_report.log
          
          FIRMWARE_FILES=$(find bin -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) 2>/dev/null | wc -l)
          
          if [ $FIRMWARE_FILES -gt 0 ]; then
            echo "Build status: Success" >> firmware_report.log
          else
            echo "Build status: Partial (no firmware files)" >> firmware_report.log
          fi
        fi
        
        echo "Device: ${{ github.event.inputs.device_name }}" >> firmware_report.log
        echo "Platform: ipq40xx" >> firmware_report.log
        echo "Configuration type: ${{ github.event.inputs.config_type }}" >> firmware_report.log
        echo "Additional packages: ${{ github.event.inputs.extra_packages }}" >> firmware_report.log
        echo "Disabled packages: ${{ github.event.inputs.disable_packages }}" >> firmware_report.log
        echo "" >> firmware_report.log
        
        echo "=== All firmware files ===" >> firmware_report.log
        find bin -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) 2>/dev/null | sort >> firmware_report.log
        echo "" >> firmware_report.log
        
        echo "=== Upgrade images (sysupgrade) ===" >> firmware_report.log
        UPGRADE_COUNT=0
        find bin -type f -name "*sysupgrade*" 2>/dev/null | while read file; do
          UPGRADE_COUNT=$((UPGRADE_COUNT+1))
          echo "File: $file" >> firmware_report.log
          echo "Size: $(du -h "$file" | cut -f1)" >> firmware_report.log
          echo "MD5: $(md5sum "$file" | cut -d' ' -f1)" >> firmware_report.log
          echo "" >> firmware_report.log
        done
        
        if [ $UPGRADE_COUNT -eq 0 ]; then
          echo "No upgrade images found" >> firmware_report.log
        fi
        echo "" >> firmware_report.log
        
        echo "=== Factory images (factory) ===" >> firmware_report.log
        FACTORY_COUNT=0
        find bin -type f -name "*factory*" 2>/dev/null | while read file; do
          FACTORY_COUNT=$((FACTORY_COUNT+1))
          echo "File: $file" >> firmware_report.log
          echo "Size: $(du -h "$file" | cut -f1)" >> firmware_report.log
          echo "MD5: $(md5sum "$file" | cut -d' ' -f1)" >> firmware_report.log
          echo "" >> firmware_report.log
        done
        
        if [ $FACTORY_COUNT -eq 0 ]; then
          echo "No factory images found" >> firmware_report.log
        fi
        echo "" >> firmware_report.log
        
        TOTAL_FILES=$(find bin -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) 2>/dev/null | wc -l)
        
        echo "=== Build statistics ===" >> firmware_report.log
        echo "Total firmware files: $TOTAL_FILES" >> firmware_report.log
        echo "Upgrade images: $UPGRADE_COUNT" >> firmware_report.log
        echo "Factory images: $FACTORY_COUNT" >> firmware_report.log
        echo "" >> firmware_report.log
        
        echo "=== Firmware quality assessment ===" >> firmware_report.log
        if [ $TOTAL_FILES -gt 0 ]; then
          echo "✓ Firmware generation successful" >> firmware_report.log
          if [ $UPGRADE_COUNT -gt 0 ]; then
            echo "✓ Includes upgrade images" >> firmware_report.log
          else
            echo "✗ Missing upgrade images" >> firmware_report.log
          fi
          if [ $FACTORY_COUNT -gt 0 ]; then
            echo "✓ Includes factory images" >> firmware_report.log
          else
            echo "⚠ Missing factory images (may not be needed)" >> firmware_report.log
          fi
        else
          echo "✗ Firmware generation failed" >> firmware_report.log
          echo "Checking for common issues..." >> firmware_report.log
          echo "1. Check if device configuration is correct" >> firmware_report.log
          echo "2. Check build.log for compilation errors" >> firmware_report.log
          echo "3. Verify sufficient disk space" >> firmware_report.log
          echo "4. Check target platform support" >> firmware_report.log
        fi
        
        echo "Firmware analysis report completed"
        cat firmware_report.log

    - name: 14_Final space check
      run: |
        echo "=== Final space usage ==="
        df -h /mnt
        cd $BUILD_DIR
        echo "Final build directory size:"
        du -sh .
        echo "bin directory size:"
        du -sh bin/ || echo "bin directory does not exist"

    - name: 15_Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}
        path: |
          ${{ env.BUILD_DIR }}/bin/
          ${{ env.BUILD_DIR }}/error_analysis.log
          ${{ env.BUILD_DIR }}/error_summary.log
          ${{ env.BUILD_DIR }}/firmware_report.log
          ${{ env.BUILD_DIR }}/build.log
          ${{ env.BUILD_DIR }}/build_detailed.log
        retention-days: 7

    - name: 16_Upload configuration files
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}
        path: ${{ env.CONFIG_DIR }}/configs/${{ github.event.inputs.device_name }}_final_config
        retention-days: 30
