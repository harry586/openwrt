name: OpenWrt 固件构建工作流

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称'
        required: true
        default: 'ac42u'
        type: string
      config_type:
        description: '配置类型'
        required: true
        default: 'minimal'
        type: choice
        options: ['minimal', 'normal', 'custom']
      extra_packages:
        description: '额外安装插件 (空格分隔)'
        required: false
        type: string
      disable_packages:
        description: '禁用插件 (空格分隔)'
        required: false
        type: string

env:
  WORKSPACE: ${{ github.workspace }}
  BUILD_DIR: /mnt/openwrt-build
  CONFIG_DIR: ${{ github.workspace }}/firmware-config

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出代码仓库
      uses: actions/checkout@v4

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 unzip zlib1g-dev libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib curl lib32gcc-s1 libc6-dev-x32 linux-libc-dev ncurses-term help2man

    - name: 创建构建目录
      run: |
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR

    - name: 克隆源码
      run: |
        cd $BUILD_DIR
        git clone https://github.com/immortalwrt/immortalwrt.git .
        git checkout openwrt-21.02

    - name: 更新安装feeds
      run: |
        cd $BUILD_DIR
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 验证设备支持
      run: |
        cd $BUILD_DIR
        case "${{ github.event.inputs.device_name }}" in
          "ac42u")
            PLATFORM="ipq40xx"
            DEVICE_SHORT_NAME="ac42u"
            DEVICE_FULL_NAME="asus_rt-ac42u"
            ;;
          *)
            echo "未知设备"
            exit 1
            ;;
        esac
        echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
        echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
        echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV

    - name: 生成设备配置
      run: |
        cd $BUILD_DIR
        chmod +x $CONFIG_DIR/scripts/generate_config.sh
        $CONFIG_DIR/scripts/generate_config.sh "${{ github.event.inputs.config_type }}" "ipq40xx" "${{ env.DEVICE_SHORT_NAME }}" "${{ env.DEVICE_FULL_NAME }}" "${{ github.event.inputs.extra_packages }}" "${{ github.event.inputs.disable_packages }}" "$BUILD_DIR"

    - name: 应用配置
      run: |
        cd $BUILD_DIR
        make defconfig

    - name: 强制设置设备配置
      run: |
        cd $BUILD_DIR
        echo "CONFIG_TARGET_ipq40xx=y" > .config
        echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
        echo "CONFIG_TARGET_DEVICE_ipq40xx_generic_${{ env.DEVICE_FULL_NAME }}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        make defconfig

    - name: 下载软件包
      run: |
        cd $BUILD_DIR
        make download

    - name: 编译固件
      run: |
        cd $BUILD_DIR
        if make -j$(nproc) V=s; then
          echo "编译成功"
        else
          echo "编译失败"
          exit 1
        fi

    - name: 验证固件生成
      if: always()
      run: |
        cd $BUILD_DIR
        if [ -d "bin/targets" ]; then
          echo "生成的固件:"
          find bin/targets -name "*.bin" -o -name "*.img"
        fi

    - name: 上传编译产物
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}
        path: ${{ env.BUILD_DIR }}/bin/
        retention-days: 7
