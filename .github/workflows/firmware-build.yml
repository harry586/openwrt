name: OpenWrt 智能固件构建工作流（完整功能版 - Git LFS 修复版）

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '📱 设备名称 (如: ac42u, r3g等)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: '🔄 版本选择'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      config_mode:
        description: |
          ⚙️ 配置模式选择
          
          🟣 基础模式 - 最小化配置，用于测试编译
          🟠 正常模式 - 完整功能配置
          
          🔧 USB 3.0加强：所有平台的关键USB驱动都已强制启用！
        required: true
        type: choice
        default: 'normal'
        options:
        - 'base'
        - 'normal'
      extra_packages:
        description: |
          额外安装插件
          格式：用分号;分隔。启用插件：+插件名。禁用插件：-插件名。
        required: false
        type: string
        default: ''
      enable_cache:
        description: '⚡ 启用编译缓存 (加速编译过程)'
        required: false
        default: true
        type: boolean
      commit_toolchain:
        description: '💾 提交工具链到仓库 (节省下次编译时间)'
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  GIT_LFS_SKIP_SMUDGE: 1

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: 安装 Git LFS
      run: |
        echo "=== 安装 Git LFS ==="
        sudo apt-get update
        sudo apt-get install -y git-lfs
        git lfs install --skip-smudge
        echo "✅ Git LFS 安装完成"

    - name: 检出配置仓库 (启用 LFS)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        lfs: true

    - name: 设置脚本执行权限
      run: |
        echo "=== 设置脚本执行权限 ==="
        find firmware-config/scripts -name "*.sh" -exec chmod +x {} \;
        echo "✅ 脚本执行权限设置完成"

    - name: 设置 Git LFS 配置
      run: |
        echo "=== 设置 Git LFS 配置 ==="
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global http.postBuffer 524288000
        git lfs install --force
        git lfs pull
        echo "✅ Git LFS 配置完成"

    - name: 检查大文件状态
      run: |
        echo "=== 检查大文件状态 ==="
        firmware-config/scripts/build_firmware_main.sh check_large_files

    - name: 强制拉取Git LFS文件
      run: |
        echo "=== 强制拉取Git LFS文件 ==="
        git lfs pull --force || echo "Git LFS拉取失败，继续构建..."
        # 检查LFS文件状态
        echo "Git LFS文件状态:"
        git lfs ls-files | head -20 || echo "无LFS文件或未跟踪"

    - name: 检查工具链目录状态
      run: |
        echo "=== 检查仓库中的工具链状态 ==="
        if [ -d "firmware-config/Toolchain" ]; then
          echo "✅ 工具链目录存在"
          echo "工具链目录大小: $(du -sh firmware-config/Toolchain 2>/dev/null | cut -f1 || echo '0')"
          echo "工具链目录结构:"
          find firmware-config/Toolchain -type f -name "*.info" 2>/dev/null | head -10
          
          # 检查文件是否为Git LFS指针
          echo "检查文件是否为LFS指针:"
          find firmware-config/Toolchain -type f -size +10M 2>/dev/null | head -5 | while read file; do
            echo "检查: $file"
            head -c 100 "$file" | grep -q "version https://git-lfs" && echo "  ⚠️  这是LFS指针文件" || echo "  ✅ 这是实际文件"
          done
        else
          echo "ℹ️  工具链目录不存在，将创建新目录"
        fi

    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "❌ 错误: /mnt 空间不足50G"
          exit 1
        fi
        echo "✅ 初始空间检查通过"

    - name: 初始化工具链目录
      run: |
        firmware-config/scripts/build_firmware_main.sh init_toolchain_dir

    - name: 设置编译环境
      run: |
        firmware-config/scripts/build_firmware_main.sh setup_environment

    - name: 创建构建目录
      run: |
        firmware-config/scripts/build_firmware_main.sh create_build_dir

    - name: 初始化构建环境
      run: |
        echo "=== 初始化构建环境 ==="
        echo "设备: ${{ github.event.inputs.device_name }}"
        echo "版本: ${{ github.event.inputs.version_selection }}"
        echo "配置模式: ${{ github.event.inputs.config_mode }}"
        firmware-config/scripts/build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"

    - name: 添加 TurboACC 支持
      run: |
        firmware-config/scripts/build_firmware_main.sh add_turboacc_support

    - name: 配置Feeds
      run: |
        firmware-config/scripts/build_firmware_main.sh configure_feeds

    - name: 安装 TurboACC 包
      if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
      run: |
        firmware-config/scripts/build_firmware_main.sh install_turboacc_packages

    - name: 编译前空间检查
      run: |
        echo "=== 编译前空间检查 ==="
        firmware-config/scripts/build_firmware_main.sh pre_build_space_check

    - name: 智能配置生成（USB完全修复加强版）
      run: |
        echo "=== 智能配置生成 ==="
        echo "🚨 USB 3.0加强：所有关键USB驱动强制启用"
        firmware-config/scripts/build_firmware_main.sh generate_config \
          "${{ github.event.inputs.extra_packages }}"

    - name: 验证USB配置
      run: |
        echo "=== 验证USB配置 ==="
        firmware-config/scripts/build_firmware_main.sh verify_usb_config

    - name: USB驱动完整性检查
      run: |
        echo "=== USB驱动完整性检查 ==="
        firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity

    - name: 应用配置并显示详情
      run: |
        echo "=== 应用配置并显示详情 ==="
        firmware-config/scripts/build_firmware_main.sh apply_config

    - name: 检查并备份配置文件
      run: |
        echo "=== 检查并备份配置文件 ==="
        
        # 检查配置文件
        if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
          echo "✅ .config 文件存在"
          
          # 确保备份目录存在
          mkdir -p firmware-config/config-backup
          
          # 备份到仓库目录
          backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
          
          cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
          echo "✅ 配置文件备份到仓库目录: $backup_file"
          
          # 显示备份文件信息
          echo "备份文件大小: $(ls -lh $backup_file | awk '{print $5}')"
        else
          echo "❌ .config 文件不存在"
          exit 1
        fi

    - name: 修复网络环境
      run: |
        echo "=== 修复网络环境 ==="
        firmware-config/scripts/build_firmware_main.sh fix_network

    - name: 加载工具链
      run: |
        echo "=== 加载工具链 ==="
        firmware-config/scripts/build_firmware_main.sh load_toolchain

    - name: 检查工具链加载状态
      run: |
        echo "=== 检查工具链加载状态 ==="
        cd ${{ env.BUILD_DIR }}
        if [ -d "staging_dir/toolchain-"* ]; then
          echo "✅ 工具链已加载"
          ls -d staging_dir/toolchain-* | head -1
          echo "工具链大小: $(du -sh staging_dir/toolchain-* 2>/dev/null | head -1 | cut -f1 || echo '未知')"
          
          # 验证工具链完整性
          echo "验证工具链完整性..."
          TOOLCHAIN_DIR=$(ls -d staging_dir/toolchain-* | head -1)
          if [ -d "$TOOLCHAIN_DIR/bin" ]; then
            echo "✅ 工具链bin目录存在"
            ls -la $TOOLCHAIN_DIR/bin/ | grep -E "gcc|g++|arm-|mipsel-" | head -10
          else
            echo "❌ 工具链bin目录不存在"
          fi
        else
          echo "❌ 工具链未加载"
          echo "将自动下载工具链..."
        fi

    - name: 下载依赖包
      run: |
        echo "=== 下载依赖包 ==="
        firmware-config/scripts/build_firmware_main.sh download_dependencies

    - name: 集成自定义文件
      run: |
        echo "=== 集成自定义文件 ==="
        firmware-config/scripts/build_firmware_main.sh integrate_custom_files

    - name: 前置错误检查
      run: |
        echo "=== 前置错误检查 ==="
        firmware-config/scripts/build_firmware_main.sh pre_build_error_check

    - name: 编译固件前的空间检查
      run: |
        echo "=== 编译固件前的空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        
        # 检查编译所需空间
        if [ $AVAILABLE_GB -lt 10 ]; then
          echo "❌ 错误: 编译前空间不足 (需要至少10G，当前${AVAILABLE_GB}G)"
          exit 1
        elif [ $AVAILABLE_GB -lt 20 ]; then
          echo "⚠️  警告: 编译前空间较低 (建议至少20G，当前${AVAILABLE_GB}G)"
        else
          echo "✅ 编译前空间充足"
        fi

    - name: 编译固件
      run: |
        echo "=== 编译固件 ==="
        echo "启用缓存: ${{ github.event.inputs.enable_cache }}"
        firmware-config/scripts/build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"

    - name: 保存工具链到仓库目录
      if: success() && github.event.inputs.enable_cache == 'true'
      run: |
        echo "=== 保存工具链到仓库目录 ==="
        echo "注意：工具链将保存到仓库的 firmware-config/Toolchain/ 目录中"
        echo "这样可以永久保存工具链，下次构建时可以直接使用"
        
        # 保存工具链
        firmware-config/scripts/build_firmware_main.sh save_toolchain
        
        # 显示保存结果
        echo "=== 工具链保存结果 ==="
        if [ -d "firmware-config/Toolchain" ]; then
          echo "✅ 工具链已保存到仓库目录"
          echo "工具链目录大小: $(du -sh firmware-config/Toolchain 2>/dev/null | cut -f1 || echo '未知')"
          echo "工具链结构:"
          find firmware-config/Toolchain -type d 2>/dev/null | head -20
        else
          echo "❌ 工具链保存失败"
        fi

    - name: 准备提交工具链（使用 Git LFS）
      if: success() && github.event.inputs.enable_cache == 'true' && github.event.inputs.commit_toolchain == 'true'
      run: |
        echo "=== 准备提交工具链到仓库（使用 Git LFS）==="
        echo "这将把工具链文件提交到Git仓库，使用Git LFS管理大文件"
        
        # 检查是否有工具链文件
        if [ -d "firmware-config/Toolchain" ] && [ -n "$(ls -A firmware-config/Toolchain 2>/dev/null)" ]; then
          echo "🔧 有工具链文件需要提交"
          
          # 配置git用户
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 添加.gitattributes文件确保LFS配置
          echo "🔧 确保.gitattributes文件存在并配置正确"
          if [ ! -f ".gitattributes" ]; then
            cp firmware-config/scripts/.gitattributes ./
          fi
          
          # 确保Git LFS已正确设置
          git lfs install --force
          
          # 添加所有工具链文件到LFS跟踪
          echo "🔧 添加工具链文件到Git LFS跟踪..."
          
          # 使用Git LFS跟踪工具链文件
          git add .gitattributes
          
          # 添加工具链文件到暂存区（Git LFS会自动处理大文件）
          echo "📦 添加工具链文件到暂存区..."
          git add firmware-config/Toolchain/
          
          # 检查是否有变更
          if git status --porcelain | grep -q "firmware-config/Toolchain" || git status --porcelain | grep -q ".gitattributes"; then
            echo "📦 提交工具链文件..."
            git commit -m "chore: 更新工具链文件 [使用 Git LFS 管理大文件]
            
            版本: ${{ env.SELECTED_BRANCH }}
            目标: ${{ env.TARGET }}/${{ env.SUBTARGET }}
            设备: ${{ env.DEVICE }}
            模式: ${{ github.event.inputs.config_mode }}
            时间: $(date '+%Y-%m-%d %H:%M:%S')
            使用Git LFS管理大文件"
            
            echo "🚀 推送工具链到远程仓库..."
            
            # 尝试推送，如果失败则重试
            for i in {1..3}; do
              echo "尝试推送 #$i..."
              if git push origin HEAD:${{ github.ref_name }}; then
                echo "✅ 工具链已成功提交并推送到仓库"
                break
              else
                echo "⚠️  推送失败，等待10秒后重试..."
                sleep 10
                if [ $i -eq 3 ]; then
                  echo "❌ 推送失败3次，跳过工具链提交"
                  exit 0
                fi
              fi
            done
          else
            echo "ℹ️  没有新的工具链文件需要提交"
          fi
        else
          echo "ℹ️  没有工具链文件需要提交"
        fi

    - name: 错误分析
      if: failure()
      run: |
        echo "=== 错误分析 ==="
        firmware-config/scripts/error_analysis.sh

    - name: 编译后空间检查
      run: |
        echo "=== 编译后空间检查 ==="
        firmware-config/scripts/build_firmware_main.sh post_build_space_check

    - name: 固件文件检查
      if: success()
      run: |
        echo "=== 固件文件检查 ==="
        firmware-config/scripts/build_firmware_main.sh check_firmware_files

    - name: 上传固件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: 上传编译日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: 上传配置文件
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: |
          ${{ github.workspace }}/firmware-config/config-backup/
        retention-days: 7

    - name: 清理目录（保留配置文件）
      if: always()
      run: |
        echo "=== 清理目录但保留配置文件 ==="
        firmware-config/scripts/build_firmware_main.sh cleanup

    - name: 输出最终配置状态
      if: always()
      run: |
        echo "=== 最终配置状态总结 ==="
        
        # 检查备份的配置文件
        if [ -d "firmware-config/config-backup" ]; then
          backup_count=$(find firmware-config/config-backup -name "*.config" 2>/dev/null | wc -l)
          echo "✅ 仓库配置文件备份: $backup_count 个"
        fi
        
        echo ""
        echo "🛠️ 工具链状态:"
        if [ -d "firmware-config/Toolchain" ]; then
          echo "✅ 工具链目录存在: firmware-config/Toolchain/"
          
          # 显示工具链大小
          toolchain_size=$(du -sh firmware-config/Toolchain 2>/dev/null | cut -f1 || echo "未知")
          echo "   工具链大小: $toolchain_size"
          
          # 显示版本目录
          echo "   版本目录:"
          ls -la firmware-config/Toolchain/ 2>/dev/null || echo "   无法列出目录"
          
          if [ "${{ github.event.inputs.commit_toolchain }}" = "true" ] && [ "${{ github.event.inputs.enable_cache }}" = "true" ]; then
            echo "   工具链已通过Git LFS提交到仓库，下次构建将自动使用"
            echo "   💡 注意: 大文件已使用Git LFS管理，不会超过GitHub文件大小限制"
          else
            echo "   工具链未提交到仓库，仅在本次工作流中可用"
          fi
        else
          echo "⚠️  工具链目录不存在"
        fi
        
        echo ""
        echo "📁 自定义文件状态:"
        if [ -d "firmware-config/custom-files" ]; then
          custom_count=$(find firmware-config/custom-files -type f 2>/dev/null | wc -l)
          echo "✅ 自定义文件: $custom_count 个"
        fi
        
        echo ""
        echo "🔄 Git LFS 状态:"
        if command -v git-lfs >/dev/null 2>&1; then
          echo "✅ Git LFS 已安装"
          git lfs ls-files 2>/dev/null | head -5 || echo "   无LFS文件或未跟踪"
        else
          echo "⚠️  Git LFS 未安装"
        fi
        
        echo ""
        echo "=== 构建流程完成 ==="
