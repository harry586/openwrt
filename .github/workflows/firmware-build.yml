# OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ
# åŠŸèƒ½ï¼šæ ¹æ®è®¾å¤‡ç±»å‹å’Œé…ç½®é€‰é¡¹è‡ªåŠ¨ç¼–è¯‘OpenWrtå›ºä»¶
# æ”¯æŒï¼šå¤šç‰ˆæœ¬æºç ã€å¤šé…ç½®æ¨¡å¼ã€è‡ªå®šä¹‰å®‰è£…ã€é”™è¯¯åˆ†æ

name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'è®¾å¤‡åç§° (å¦‚: ac42u, ac58u ç­‰)'
        required: true
        default: 'ac42u'
        type: string
      old_device:
        description: 'æ˜¯å¦ä¸ºè€æ—§è®¾å¤‡ (æ€§èƒ½è¾ƒå·®çš„è®¾å¤‡å»ºè®®é€‰æ‹©true)'
        required: true
        default: false
        type: boolean
      version_spec:
        description: 'ç‰ˆæœ¬è§„æ ¼ (å¯é€‰ï¼Œå¦‚: openwrt-23.05 æˆ– immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_type:
        description: 'é…ç½®ç±»å‹ (minimal:åŸºç¡€åŠŸèƒ½, normal:å®Œæ•´åŠŸèƒ½, custom:è‡ªå®šä¹‰)'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - normal
          - custom
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…å)'
        required: false
        type: string
      save_config:
        description: 'ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“'
        required: false
        default: true
        type: boolean
      custom_install:
        description: 'å¯ç”¨è‡ªå®šä¹‰å®‰è£… (IPKå’Œè„šæœ¬)'
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build  # æ„å»ºç›®å½•è·¯å¾„

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    # åˆå§‹æ£€æŸ¥æ­¥éª¤
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        # æ£€æŸ¥ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼ˆè‡³å°‘50GBï¼‰
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    # æ£€å‡ºä»£ç æ­¥éª¤
    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

    # ç¯å¢ƒè®¾ç½®æ­¥éª¤
    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libssl-dev python3 unzip zlib1g-dev subversion gcc-multilib git curl file

    # ç›®å½•å‡†å¤‡æ­¥éª¤
    - name: åˆ›å»ºæ„å»ºç›®å½•å¹¶è®¾ç½®æƒé™
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        sudo chmod u+w $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"
        ls -ld $BUILD_DIR
        # æµ‹è¯•å†™å…¥æƒé™
        touch $BUILD_DIR/test_write.txt && echo "âœ… å†™å…¥æµ‹è¯•æˆåŠŸ" && rm $BUILD_DIR/test_write.txt

    # è„šæœ¬å¤åˆ¶æ­¥éª¤
    - name: å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½•
      run: |
        cd $BUILD_DIR
        echo "=== å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½• ==="
        cd $GITHUB_WORKSPACE
        
        # æŸ¥æ‰¾æ‰€æœ‰å¿…è¦çš„è„šæœ¬æ–‡ä»¶
        VERSION_SCRIPT=$(find . -name "complete_version_detector.sh" -type f | head -1)
        DEVICE_SCRIPT=$(find . -name "device_detection.sh" -type f | head -1)
        ERROR_SCRIPT=$(find . -name "error_analysis.sh" -type f | head -1)
        
        # æ£€æŸ¥å¿…è¦è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ -z "$VERSION_SCRIPT" ] || [ -z "$DEVICE_SCRIPT" ]; then
          echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°å¿…è¦çš„æ£€æµ‹è„šæœ¬"
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°ç‰ˆæœ¬æ£€æµ‹è„šæœ¬: $VERSION_SCRIPT"
        echo "âœ… æ‰¾åˆ°è®¾å¤‡æ£€æµ‹è„šæœ¬: $DEVICE_SCRIPT"
        
        # å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½•
        cp "$VERSION_SCRIPT" $BUILD_DIR/complete_version_detector.sh
        cp "$DEVICE_SCRIPT" $BUILD_DIR/device_detection.sh
        
        # å¤åˆ¶é”™è¯¯åˆ†æè„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -n "$ERROR_SCRIPT" ]; then
          echo "âœ… æ‰¾åˆ°é”™è¯¯åˆ†æè„šæœ¬: $ERROR_SCRIPT"
          cp "$ERROR_SCRIPT" $BUILD_DIR/error_analysis.sh
        else
          echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°é”™è¯¯åˆ†æè„šæœ¬"
        fi
        
        cd $BUILD_DIR
        chmod +x complete_version_detector.sh device_detection.sh error_analysis.sh 2>/dev/null || true
        echo "âœ… è„šæœ¬å¤åˆ¶å®Œæˆ"

    # ç‰ˆæœ¬æ£€æµ‹æ­¥éª¤ - æ™ºèƒ½é€‰æ‹©é€‚åˆè®¾å¤‡çš„æºç ç‰ˆæœ¬
    - name: æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ ==="
        # ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®
        sudo chown -R $USER:$USER . 2>/dev/null || true
        chmod u+w . 2>/dev/null || true
        
        echo "=== å¼€å§‹ç‰ˆæœ¬æ£€æµ‹ ==="
        echo "è®¾å¤‡åç§°: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬è§„æ ¼: ${{ github.event.inputs.version_spec }}"
        echo "è€æ—§è®¾å¤‡: ${{ github.event.inputs.old_device }}"
        
        # è¿è¡Œç‰ˆæœ¬æ£€æµ‹è„šæœ¬
        set +e  # å…è®¸è„šæœ¬é”™è¯¯ï¼Œä»¥ä¾¿æ•è·è¾“å‡º
        OUTPUT=$(./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_spec }}" "${{ github.event.inputs.old_device }}" 2>&1)
        SCRIPT_EXIT_CODE=$?
        set -e
        
        echo "è„šæœ¬è¾“å‡º:"
        echo "$OUTPUT"
        echo "è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE"
        
        # ä»è„šæœ¬è¾“å‡ºä¸­æå–ç‰ˆæœ¬ä¿¡æ¯
        SELECTED_REPO=$(echo "$OUTPUT" | grep "^SELECTED_REPO=" | head -1 | cut -d'=' -f2)
        SELECTED_BRANCH=$(echo "$OUTPUT" | grep "^SELECTED_BRANCH=" | head -1 | cut -d'=' -f2)
        SELECTED_REPO_URL=$(echo "$OUTPUT" | grep "^SELECTED_REPO_URL=" | head -1 | cut -d'=' -f2)
        
        # éªŒè¯ç‰ˆæœ¬ä¿¡æ¯æ˜¯å¦æå–æˆåŠŸ
        if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
            echo "âœ… ä»è„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–ç‰ˆæœ¬ä¿¡æ¯"
            # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            echo "âœ… ç¯å¢ƒå˜é‡å·²è®¾ç½®:"
            echo "SELECTED_REPO: $SELECTED_REPO"
            echo "SELECTED_BRANCH: $SELECTED_BRANCH"
            echo "SELECTED_REPO_URL: $SELECTED_REPO_URL"
        else
            echo "âŒ æ— æ³•ä»è„šæœ¬è¾“å‡ºä¸­æå–ç‰ˆæœ¬ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ ç‰ˆæœ¬æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼"
                # è®¾ç½®é»˜è®¤å€¼ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                echo "SELECTED_REPO=immortalwrt" >> $GITHUB_ENV
                echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
                echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
            fi
        fi

    # ç›®å½•æ¸…ç†æ­¥éª¤ - ä¸ºå…‹éš†æ–°æºç åšå‡†å¤‡
    - name: æ¸…ç†æ„å»ºç›®å½•å‡†å¤‡å…‹éš†
      run: |
        cd $BUILD_DIR
        echo "=== æ¸…ç†æ„å»ºç›®å½•å‡†å¤‡å…‹éš† ==="
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        # å½»åº•æ¸…ç†ç›®å½•
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        sudo rm -rf .[!.]* 2>/dev/null || true
        echo "æ¸…ç†åç›®å½•å†…å®¹:"
        ls -la
        echo "âœ… ç›®å½•æ¸…ç†å®Œæˆ"

    # æºç å…‹éš†æ­¥éª¤
    - name: å…‹éš†é€‰å®šç‰ˆæœ¬çš„æºç 
      run: |
        cd $BUILD_DIR
        echo "=== å…‹éš†é€‰å®šç‰ˆæœ¬çš„æºç  ==="
        echo "ä»“åº“: $SELECTED_REPO_URL"
        echo "åˆ†æ”¯: $SELECTED_BRANCH"
        
        # éªŒè¯ç¯å¢ƒå˜é‡
        if [ -z "$SELECTED_REPO_URL" ] || [ -z "$SELECTED_BRANCH" ]; then
          echo "âŒ é”™è¯¯: ç¯å¢ƒå˜é‡æœªæ­£ç¡®è®¾ç½®"
          exit 1
        fi
        
        echo "æ£€æŸ¥ç›®å½•çŠ¶æ€..."
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        FILE_COUNT=$(ls -A | wc -l)
        if [ $FILE_COUNT -ne 0 ]; then
          echo "âŒ é”™è¯¯: ç›®å½•éç©ºï¼Œæ— æ³•å…‹éš†"
          echo "å½“å‰æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          exit 1
        fi
        
        echo "å¼€å§‹å…‹éš†ä»“åº“..."
        # å…‹éš†æŒ‡å®šåˆ†æ”¯çš„æºç ï¼ˆæµ…å…‹éš†ä»¥èŠ‚çœæ—¶é—´å’Œç©ºé—´ï¼‰
        git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
        if [ $? -eq 0 ]; then
          echo "âœ… æºç å…‹éš†å®Œæˆ"
        else
          echo "âŒ æºç å…‹éš†å¤±è´¥"
          exit 1
        fi

    # é‡æ–°å¤åˆ¶è„šæœ¬æ­¥éª¤ - ç¡®ä¿è„šæœ¬åœ¨æºç ç›®å½•ä¸­å¯ç”¨
    - name: é‡æ–°å¤åˆ¶è„šæœ¬å’Œé…ç½®æ–‡ä»¶
      run: |
        cd $BUILD_DIR
        echo "=== é‡æ–°å¤åˆ¶è„šæœ¬å’Œé…ç½®æ–‡ä»¶ ==="
        cd $GITHUB_WORKSPACE
        
        # å¤åˆ¶è„šæœ¬æ–‡ä»¶
        VERSION_SCRIPT=$(find . -name "complete_version_detector.sh" -type f | head -1)
        DEVICE_SCRIPT=$(find . -name "device_detection.sh" -type f | head -1)
        ERROR_SCRIPT=$(find . -name "error_analysis.sh" -type f | head -1)
        
        cp "$VERSION_SCRIPT" $BUILD_DIR/complete_version_detector.sh
        cp "$DEVICE_SCRIPT" $BUILD_DIR/device_detection.sh
        if [ -n "$ERROR_SCRIPT" ]; then
          cp "$ERROR_SCRIPT" $BUILD_DIR/error_analysis.sh
        fi
        
        # æŸ¥æ‰¾å¹¶å¤åˆ¶é…ç½®æ–‡ä»¶
        echo "=== æŸ¥æ‰¾é…ç½®æ–‡ä»¶ ==="
        CONFIG_FILES=$(find firmware-config/configs -name "*.config" -type f 2>/dev/null || true)
        if [ -n "$CONFIG_FILES" ]; then
          echo "æ‰¾åˆ°é…ç½®æ–‡ä»¶:"
          echo "$CONFIG_FILES"
          mkdir -p $BUILD_DIR/config-templates
          for config_file in $CONFIG_FILES; do
            filename=$(basename "$config_file")
            cp "$config_file" $BUILD_DIR/config-templates/
            echo "å¤åˆ¶: $filename"
          done
          echo "âœ… æ‰€æœ‰é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          echo "å½“å‰é…ç½®æ¨¡æ¿ç›®å½•å†…å®¹:"
          ls -la $BUILD_DIR/config-templates/
        else
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
          echo "æœç´¢è·¯å¾„: firmware-config/configs/"
          exit 1
        fi
        
        cd $BUILD_DIR
        chmod +x complete_version_detector.sh device_detection.sh error_analysis.sh 2>/dev/null || true
        echo "âœ… è„šæœ¬å’Œé…ç½®æ–‡ä»¶é‡æ–°å¤åˆ¶å®Œæˆ"

    # è®¾å¤‡æ£€æµ‹æ­¥éª¤ - è¯†åˆ«è®¾å¤‡å¹³å°å’Œé…ç½®
    - name: æ™ºèƒ½è®¾å¤‡æ£€æµ‹ä¸åˆ«åè½¬æ¢
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½è®¾å¤‡æ£€æµ‹ä¸åˆ«åè½¬æ¢ ==="
        
        # è®¾å¤‡åˆ«åæ˜ å°„è¡¨ - å°†é€šç”¨åç§°æ˜ å°„åˆ°å…·ä½“è®¾å¤‡æ ‡è¯†
        declare -A DEVICE_ALIAS_MAP=(
          ["ac42u"]="asus_rt-ac42u"
          ["acrh17"]="asus_rt-ac42u"
          ["rt-acrh17"]="asus_rt-ac42u"
          ["ac58u"]="asus_rt-ac58u"
          ["acrh13"]="asus_rt-ac58u"
          ["rt-acrh13"]="asus_rt-ac58u"
        )
        
        INPUT_DEVICE="${{ github.event.inputs.device_name }}"
        echo "è¾“å…¥è®¾å¤‡åç§°: $INPUT_DEVICE"
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºåˆ«åå¹¶è¿›è¡Œè½¬æ¢
        if [ -n "${DEVICE_ALIAS_MAP[$INPUT_DEVICE]}" ]; then
          ACTUAL_DEVICE="${DEVICE_ALIAS_MAP[$INPUT_DEVICE]}"
          echo "âœ… æ£€æµ‹åˆ°è®¾å¤‡åˆ«å '$INPUT_DEVICE'ï¼Œè½¬æ¢ä¸º '$ACTUAL_DEVICE'"
        else
          ACTUAL_DEVICE="$INPUT_DEVICE"
          echo "ä½¿ç”¨åŸå§‹è®¾å¤‡åç§°: $ACTUAL_DEVICE"
        fi
        
        # éªŒè¯è®¾å¤‡æ£€æµ‹è„šæœ¬
        if [ ! -f "device_detection.sh" ]; then
          echo "âŒ é”™è¯¯: è®¾å¤‡æ£€æµ‹è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        chmod +x device_detection.sh
        
        # è¿è¡Œè®¾å¤‡æ£€æµ‹è„šæœ¬
        echo "=== å¼€å§‹è®¾å¤‡æ£€æµ‹ ==="
        set +e
        OUTPUT=$(./device_detection.sh "$ACTUAL_DEVICE" 2>&1)
        SCRIPT_EXIT_CODE=$?
        set -e
        
        echo "=== è„šæœ¬åŸå§‹è¾“å‡º ==="
        echo "$OUTPUT"
        echo "=== è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE ==="
        
        # ä»è„šæœ¬è¾“å‡ºä¸­æå–è®¾å¤‡ä¿¡æ¯
        PLATFORM=$(echo "$OUTPUT" | grep "^PLATFORM=" | tail -1 | cut -d'=' -f2)
        DEVICE_SHORT_NAME=$(echo "$OUTPUT" | grep "^DEVICE_SHORT_NAME=" | tail -1 | cut -d'=' -f2)
        DEVICE_FULL_NAME=$(echo "$OUTPUT" | grep "^DEVICE_FULL_NAME=" | tail -1 | cut -d'=' -f2)
        
        echo "=== æå–çš„è®¾å¤‡ä¿¡æ¯ ==="
        echo "PLATFORM: '$PLATFORM'"
        echo "DEVICE_SHORT_NAME: '$DEVICE_SHORT_NAME'"
        echo "DEVICE_FULL_NAME: '$DEVICE_FULL_NAME'"
        
        # éªŒè¯è®¾å¤‡ä¿¡æ¯æå–ç»“æœ
        if [ -n "$PLATFORM" ] && [ -n "$DEVICE_SHORT_NAME" ] && [ -n "$DEVICE_FULL_NAME" ]; then
            echo "âœ… ä»è„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–è®¾å¤‡ä¿¡æ¯"
            # è®¾ç½®ç¯å¢ƒå˜é‡
            echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
            echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
            echo "âœ… è®¾å¤‡ç¯å¢ƒå˜é‡å·²è®¾ç½®"
            
            # é¢å¤–éªŒè¯ï¼šæ£€æŸ¥è®¾å¤‡æ ‘æ–‡ä»¶ï¼ˆä½¿ç”¨æ›´çµæ´»çš„æœç´¢æ¨¡å¼ï¼‰
            echo "=== éªŒè¯è®¾å¤‡æ ‘æ–‡ä»¶ ==="
            DTS_FILES=$(find "target/linux/$PLATFORM" -name "*.dts" -type f 2>/dev/null | grep -i "$DEVICE_SHORT_NAME" | head -5 || true)
            if [ -n "$DTS_FILES" ]; then
                echo "âœ… æ‰¾åˆ°ç›¸å…³çš„è®¾å¤‡æ ‘æ–‡ä»¶:"
                echo "$DTS_FILES"
            else
                echo "âš ï¸ æœªæ‰¾åˆ°ç²¾ç¡®åŒ¹é…çš„è®¾å¤‡æ ‘æ–‡ä»¶ï¼Œå°è¯•æ¨¡ç³Šæœç´¢..."
                # å°è¯•æœç´¢åŒ…å«è®¾å¤‡å…³é”®å­—çš„dtsæ–‡ä»¶
                DTS_FILES=$(find "target/linux/$PLATFORM" -name "*.dts" -type f 2>/dev/null | xargs grep -l "$DEVICE_SHORT_NAME" 2>/dev/null | head -5 || true)
                if [ -n "$DTS_FILES" ]; then
                    echo "âœ… é€šè¿‡æ¨¡ç³Šæœç´¢æ‰¾åˆ°è®¾å¤‡æ ‘æ–‡ä»¶:"
                    echo "$DTS_FILES"
                else
                    echo "âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡æ ‘æ–‡ä»¶ï¼Œä½†è¿™å¯èƒ½ä¸å½±å“æ„å»º"
                fi
            fi
        else
            echo "âŒ æ— æ³•ä»è„šæœ¬è¾“å‡ºä¸­æå–è®¾å¤‡ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ è®¾å¤‡æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–è®¾å¤‡ä¿¡æ¯ï¼Œä½¿ç”¨å¤‡ç”¨è®¾å¤‡æ˜ å°„"
                # ä½¿ç”¨å·²çŸ¥è®¾å¤‡æ˜ å°„ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                case "$ACTUAL_DEVICE" in
                    "asus_rt-ac42u"|"ac42u"|"acrh17"|"rt-acrh17")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac42u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "asus_rt-ac58u"|"ac58u"|"acrh13"|"rt-acrh13")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac58u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    *)
                        echo "âŒ æœªçŸ¥è®¾å¤‡ï¼Œæ— æ³•è®¾ç½®é»˜è®¤å€¼"
                        exit 1
                        ;;
                esac
                echo "âœ… å·²ä½¿ç”¨å¤‡ç”¨è®¾å¤‡ä¿¡æ¯"
            fi
        fi

    # è®¾å¤‡å®šä¹‰éªŒè¯æ­¥éª¤ - ç¡®ä¿è®¾å¤‡åœ¨æºç ä¸­è¢«æ­£ç¡®å®šä¹‰
    - name: éªŒè¯è®¾å¤‡å®šä¹‰
      run: |
        cd $BUILD_DIR
        echo "=== éªŒè¯è®¾å¤‡å®šä¹‰ ==="
        echo "å¹³å°: $PLATFORM"
        echo "è®¾å¤‡: $DEVICE_SHORT_NAME"
        
        # æœç´¢è®¾å¤‡å®šä¹‰æ–‡ä»¶
        echo "=== è¿‡æ»¤åçš„è®¾å¤‡å®šä¹‰åˆ—è¡¨ï¼ˆåŒ…å« $DEVICE_SHORT_NAMEï¼‰==="
        find "target/linux/$PLATFORM" -name "*.mk" -type f -exec grep -l "define Device/$DEVICE_SHORT_NAME" {} \; | while read file; do
            echo "æ–‡ä»¶: $file"
            awk "/define Device\/$DEVICE_SHORT_NAME/{flag=1} flag; /endef/{if(flag) exit}" "$file"
        done
        
        # æ£€æŸ¥å…·ä½“è®¾å¤‡å®šä¹‰
        echo "=== æ£€æŸ¥è®¾å¤‡ $DEVICE_SHORT_NAME çš„è¯¦ç»†å®šä¹‰ ==="
        FOUND=0
        for mk_file in $(find "target/linux/$PLATFORM" -name "*.mk" -type f); do
            if grep -q "define Device/$DEVICE_SHORT_NAME" "$mk_file"; then
                echo "âœ… åœ¨æ–‡ä»¶ $mk_file ä¸­æ‰¾åˆ°è®¾å¤‡å®šä¹‰:"
                # æ˜¾ç¤ºå®Œæ•´çš„è®¾å¤‡å®šä¹‰å—
                awk "/define Device\/$DEVICE_SHORT_NAME/{flag=1} flag; /endef/{flag=0}" "$mk_file"
                FOUND=1
                break
            fi
        done
        
        # å¦‚æœæœªæ‰¾åˆ°è®¾å¤‡å®šä¹‰ï¼Œå°è¯•ä½¿ç”¨å·²çŸ¥è®¾å¤‡åç§°
        if [ "$FOUND" -eq 0 ]; then
            echo "âŒ æœªæ‰¾åˆ°è®¾å¤‡ $DEVICE_SHORT_NAME"
            echo "=== æœç´¢ç›¸ä¼¼è®¾å¤‡ ==="
            find "target/linux/$PLATFORM" -name "*.mk" -type f -exec grep -l "$DEVICE_SHORT_NAME" {} \; | head -5
            
            # å°è¯•ä½¿ç”¨å·²çŸ¥çš„è®¾å¤‡åç§°
            echo "=== å°è¯•ä½¿ç”¨å·²çŸ¥è®¾å¤‡åç§° ==="
            case "$DEVICE_SHORT_NAME" in
                "asus_rt-ac42u"|"ac42u"|"acrh17"|"rt-acrh17")
                    KNOWN_DEVICE="asus_rt-ac42u"
                    ;;
                "asus_rt-ac58u"|"ac58u"|"acrh13"|"rt-acrh13")
                    KNOWN_DEVICE="asus_rt-ac58u"
                    ;;
                *)
                    KNOWN_DEVICE=""
                    ;;
            esac
            
            if [ -n "$KNOWN_DEVICE" ]; then
                echo "å°è¯•ä½¿ç”¨å·²çŸ¥è®¾å¤‡: $KNOWN_DEVICE"
                for mk_file in $(find "target/linux/$PLATFORM" -name "*.mk" -type f); do
                    if grep -q "define Device/$KNOWN_DEVICE" "$mk_file"; then
                        echo "âœ… åœ¨æ–‡ä»¶ $mk_file ä¸­æ‰¾åˆ°å·²çŸ¥è®¾å¤‡å®šä¹‰: $KNOWN_DEVICE"
                        awk "/define Device\/$KNOWN_DEVICE/{flag=1} flag; /endef/{flag=0}" "$mk_file"
                        # æ›´æ–°ç¯å¢ƒå˜é‡
                        echo "DEVICE_SHORT_NAME=$KNOWN_DEVICE" >> $GITHUB_ENV
                        FOUND=1
                        break
                    fi
                done
            fi
            
            if [ "$FOUND" -eq 0 ]; then
                exit 1
            fi
        fi
        
        # æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨ç›®æ ‡è®¾å¤‡åˆ—è¡¨ä¸­
        echo "=== æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨ TARGET_DEVICES ä¸­ ==="
        for mk_file in $(find "target/linux/$PLATFORM" -name "*.mk" -type f); do
            if grep -q "TARGET_DEVICES.*+=.*$DEVICE_SHORT_NAME" "$mk_file"; then
                echo "âœ… è®¾å¤‡ $DEVICE_SHORT_NAME åœ¨ TARGET_DEVICES ä¸­"
                break
            fi
        done

    # è½¯ä»¶åŒ…æºæ›´æ–°æ­¥éª¤
    - name: æ›´æ–°å®‰è£…feeds
      run: |
        cd $BUILD_DIR
        echo "=== æ›´æ–°å’Œå®‰è£…feeds ==="
        ./scripts/feeds update -a  # æ›´æ–°æ‰€æœ‰è½¯ä»¶åŒ…æº
        ./scripts/feeds install -a  # å®‰è£…æ‰€æœ‰è½¯ä»¶åŒ…

    # é…ç½®æ­¥éª¤ - ä½¿ç”¨å¤–éƒ¨é…ç½®æ–‡ä»¶è¿›è¡Œå›ºä»¶é…ç½®
    - name: ä½¿ç”¨å¤–éƒ¨é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== ä½¿ç”¨å¤–éƒ¨é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½® ==="
        
        # å®Œå…¨æ¸…ç©ºé…ç½®
        > .config
        
        # è®¾ç½®å¹³å°å’Œå­å¹³å°
        echo "CONFIG_TARGET_${PLATFORM}=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic=y" >> .config
        
        # ä½¿ç”¨æ­£ç¡®çš„è®¾å¤‡é…ç½®é¡¹æ ¼å¼
        CORRECT_DEVICE_CONFIG="CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}"
        echo "${CORRECT_DEVICE_CONFIG}=y" >> .config
        echo "ä½¿ç”¨çš„è®¾å¤‡é…ç½®é¡¹: ${CORRECT_DEVICE_CONFIG}=y"
        
        # åŸºç¡€æ–‡ä»¶ç³»ç»Ÿé…ç½®
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
        
        # åŸºç¡€åŒ…é…ç½®ï¼ˆæ‰€æœ‰æ¨¡å¼éƒ½åŒ…å«ï¼‰
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-extra=y" >> .config
        
        # åŸºç¡€ç½‘ç»œåŒ…ï¼ˆæ‰€æœ‰æ¨¡å¼éƒ½åŒ…å«ï¼‰
        echo "CONFIG_PACKAGE_ppp=y" >> .config
        echo "CONFIG_PACKAGE_ppp-mod-pppoe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ppp=y" >> .config
        echo "CONFIG_PACKAGE_kmod-pppoe=y" >> .config
        
        CONFIG_TYPE="${{ github.event.inputs.config_type }}"
        echo "é…ç½®ç±»å‹: $CONFIG_TYPE"
        
        # æ ¹æ®é…ç½®ç±»å‹å’Œç‰ˆæœ¬åŠ è½½å¯¹åº”çš„é…ç½®æ–‡ä»¶
        if [ "$CONFIG_TYPE" = "minimal" ]; then
            # æœ€å°åŒ–æ¨¡å¼ä½¿ç”¨é€šç”¨é…ç½®
            CONFIG_FILE="config-templates/minimal.config"
        elif [ "$CONFIG_TYPE" = "normal" ] || [ "$CONFIG_TYPE" = "custom" ]; then
            # åˆ¤æ–­ç‰ˆæœ¬ç±»å‹ä»¥é€‰æ‹©æ­£ç¡®çš„é…ç½®æ–‡ä»¶
            echo "=== åˆ¤æ–­ç‰ˆæœ¬ç±»å‹ ==="
            echo "ä»“åº“: $SELECTED_REPO"
            echo "åˆ†æ”¯: $SELECTED_BRANCH"
            echo "è®¾å¤‡ç±»å‹: ${{ github.event.inputs.old_device }}"
            
            # åˆ¤æ–­æ˜¯å¦ä¸ºæ—§ç‰ˆæœ¬ï¼ˆè€ƒè™‘è®¾å¤‡æ€§èƒ½å’Œæºç ç‰ˆæœ¬ï¼‰
            IS_OLD_VERSION=0
            
            # ä¼˜å…ˆçº§1: ç”¨æˆ·æ˜ç¡®æŒ‡å®šä¸ºè€æ—§è®¾å¤‡
            if [ "${{ github.event.inputs.old_device }}" = "true" ]; then
                IS_OLD_VERSION=1
                echo "âœ… ç”¨æˆ·æŒ‡å®šä¸ºè€æ—§è®¾å¤‡ï¼Œä½¿ç”¨æ—§ç‰ˆæœ¬é…ç½®"
            else
                # ä¼˜å…ˆçº§2: æ ¹æ®æºç ä»“åº“å’Œåˆ†æ”¯åˆ¤æ–­
                # æ£€æŸ¥åˆ†æ”¯åæ˜¯å¦åŒ…å«æ—§ç‰ˆæœ¬æ ‡è¯†
                if echo "$SELECTED_BRANCH" | grep -q -E "19\.07|21\.02|17\.01|lede"; then
                    IS_OLD_VERSION=1
                    echo "âœ… æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬åˆ†æ”¯: $SELECTED_BRANCH"
                fi
                # æ£€æŸ¥ä»“åº“æ˜¯å¦ä¸ºæ—§ç‰ˆæœ¬
                if [ "$SELECTED_REPO" = "lede" ] || [ "$SELECTED_REPO" = "openwrt-19.07" ] || [ "$SELECTED_REPO" = "openwrt-21.02" ]; then
                    IS_OLD_VERSION=1
                    echo "âœ… æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬ä»“åº“: $SELECTED_REPO"
                fi
                # ä¼˜å…ˆçº§3: æ ¹æ®è®¾å¤‡åç§°åˆ¤æ–­ï¼ˆæ€§èƒ½è¾ƒå·®çš„è®¾å¤‡ï¼‰
                case "${{ github.event.inputs.device_name }}" in
                    "wr841n"|"wr842n"|"wr941n"|"mr3420"|"ar71xx"*)
                        IS_OLD_VERSION=1
                        echo "âœ… æ£€æµ‹åˆ°è€æ—§è®¾å¤‡å‹å·: ${{ github.event.inputs.device_name }}"
                        ;;
                esac
            fi
            
            if [ "$IS_OLD_VERSION" -eq 1 ]; then
                echo "âœ… æœ€ç»ˆå†³å®š: ä½¿ç”¨æ—§ç‰ˆæœ¬é…ç½®"
                CONFIG_FILE="config-templates/normal-old.config"
            else
                echo "âœ… æœ€ç»ˆå†³å®š: ä½¿ç”¨æ–°ç‰ˆæœ¬é…ç½®"
                CONFIG_FILE="config-templates/normal-new.config"
            fi
        else
            echo "âŒ æœªçŸ¥çš„é…ç½®ç±»å‹: $CONFIG_TYPE"
            exit 1
        fi
        
        # åŠ è½½é€‰å®šçš„é…ç½®æ–‡ä»¶
        if [ -f "$CONFIG_FILE" ]; then
            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FILE"
            echo "=== å¼€å§‹åŠ è½½å¤–éƒ¨é…ç½® ==="
            cat "$CONFIG_FILE" >> .config
            echo "âœ… é…ç½®å·²åŠ è½½: $(basename "$CONFIG_FILE")"
            
            # éªŒè¯é…ç½®åŠ è½½
            echo "=== é…ç½®åŠ è½½éªŒè¯ ==="
            if grep -q "CONFIG_PACKAGE_luci" .config; then
                echo "âœ… LuCI é…ç½®å·²åŠ è½½"
            else
                echo "âŒ LuCI é…ç½®æœªåŠ è½½"
            fi
            
            # éªŒè¯ç‰ˆæœ¬ç‰¹å®šé…ç½®
            if [ "$CONFIG_TYPE" != "minimal" ]; then
                if [ "$IS_OLD_VERSION" -eq 1 ]; then
                    if grep -q "CONFIG_PACKAGE_samba=y" .config && grep -q "CONFIG_PACKAGE_luci-app-sqm=y" .config; then
                        echo "âœ… æ—§ç‰ˆæœ¬é…ç½®æ­£ç¡®åŠ è½½: samba + sqm"
                    else
                        echo "âŒ æ—§ç‰ˆæœ¬é…ç½®åŠ è½½å¼‚å¸¸"
                    fi
                else
                    if grep -q "CONFIG_PACKAGE_samba4=y" .config && grep -q "CONFIG_PACKAGE_sqm-autorate=y" .config; then
                        echo "âœ… æ–°ç‰ˆæœ¬é…ç½®æ­£ç¡®åŠ è½½: samba4 + sqm-autorate"
                    else
                        echo "âŒ æ–°ç‰ˆæœ¬é…ç½®åŠ è½½å¼‚å¸¸"
                    fi
                fi
            fi
        else
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILE"
            echo "å½“å‰å¯ç”¨çš„é…ç½®æ–‡ä»¶:"
            ls -la config-templates/ 2>/dev/null || echo "æ— é…ç½®æ–‡ä»¶"
            exit 1
        fi
        
        # è‡ªå®šä¹‰åŒ…å¤„ç†ï¼ˆä»…é™customæ¨¡å¼ï¼‰
        if [ "$CONFIG_TYPE" = "custom" ] && [ -n "${{ github.event.inputs.extra_packages }}" ]; then
            echo "# é¢å¤–åŒ…é…ç½®" >> .config
            for pkg in ${{ github.event.inputs.extra_packages }}; do
                pkg_clean=$(echo "$pkg" | tr '-' '_' | tr -cd '[:alnum:]_')
                echo "CONFIG_PACKAGE_${pkg_clean}=y" >> .config
                echo "æ·»åŠ é¢å¤–åŒ…: CONFIG_PACKAGE_${pkg_clean}=y"
            done
        fi
        
        # é…ç½®æ‘˜è¦
        echo "=== é¢„é…ç½®å†…å®¹æ‘˜è¦ ==="
        echo "è®¾å¤‡é…ç½®:"
        grep "^CONFIG_TARGET" .config
        echo ""
        echo "LuCIç›¸å…³é…ç½®:"
        grep "CONFIG_PACKAGE_luci" .config | head -10
        echo ""
        echo "ç‰ˆæœ¬ç‰¹å®šé…ç½®:"
        if [ "$CONFIG_TYPE" != "minimal" ]; then
            if [ "$IS_OLD_VERSION" -eq 1 ]; then
                grep -E "CONFIG_PACKAGE_samba|CONFIG_PACKAGE_luci-app-sqm" .config
            else
                grep -E "CONFIG_PACKAGE_samba4|CONFIG_PACKAGE_sqm-autorate" .config
            fi
        fi
        echo ""
        echo "ç¦ç”¨æ’ä»¶:"
        grep "is not set" .config | head -10
        
        # è¿è¡Œdefconfigæ¥å®Œå–„é…ç½®
        echo "è¿è¡Œ make defconfig..."
        make defconfig
        
        # æœ€ç»ˆé…ç½®éªŒè¯
        echo "=== æœ€ç»ˆé…ç½®éªŒè¯ ==="
        # æ£€æŸ¥è®¾å¤‡é…ç½®é¡¹æ˜¯å¦å¯ç”¨ï¼ˆè¿‡æ»¤æ‰æ³¨é‡Šè¡Œï¼‰
        if grep -q "^${CORRECT_DEVICE_CONFIG}=y" .config; then
            echo "âœ… è®¾å¤‡ $DEVICE_SHORT_NAME å·²æˆåŠŸå¯ç”¨"
            echo "ä½¿ç”¨çš„é…ç½®é¡¹: ${CORRECT_DEVICE_CONFIG}"
        else
            echo "âŒ è®¾å¤‡ $DEVICE_SHORT_NAME å¯ç”¨å¤±è´¥ï¼Œæ„å»ºç»ˆæ­¢"
            echo "æœŸæœ›çš„é…ç½®é¡¹: ${CORRECT_DEVICE_CONFIG}"
            echo "å½“å‰è®¾å¤‡ç›¸å…³é…ç½®:"
            grep "CONFIG_TARGET.*${DEVICE_SHORT_NAME}" .config || echo "æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é…ç½®"
            echo "æ‰€æœ‰ç›®æ ‡ç›¸å…³é…ç½®:"
            grep "^CONFIG_TARGET" .config | head -20
            exit 1
        fi
        
        # éªŒè¯ç¦ç”¨æ’ä»¶
        echo "=== ç¦ç”¨æ’ä»¶éªŒè¯ ==="
        DISABLED_PLUGINS=("luci-app-accesscontrol" "luci-app-ddns" "luci-app-bandwidth" "luci-app-wol")
        for plugin in "${DISABLED_PLUGINS[@]}"; do
            if grep -q "# CONFIG_PACKAGE_${plugin} is not set" .config; then
                echo "âœ… ${plugin} å·²æ­£ç¡®ç¦ç”¨"
            else
                echo "âš ï¸ ${plugin} ç¦ç”¨çŠ¶æ€æœªçŸ¥"
            fi
        done

    # è‡ªå®šä¹‰å®‰è£…å¤„ç†æ­¥éª¤
    - name: è‡ªå®šä¹‰å®‰è£…å¤„ç†
      if: github.event.inputs.custom_install == 'true'
      run: |
        cd $BUILD_DIR
        echo "=== è‡ªå®šä¹‰å®‰è£…å¤„ç† ==="
        
        # æŸ¥æ‰¾è‡ªå®šä¹‰æ–‡ä»¶
        cd $GITHUB_WORKSPACE
        
        # å¤„ç†é¢„ç¼–è¯‘IPKæ–‡ä»¶
        IPK_FILES=$(find firmware-config/custom-files/prebuilt-ipks -name "*.ipk" -type f 2>/dev/null || true)
        if [ -n "$IPK_FILES" ]; then
            echo "âœ… æ‰¾åˆ°é¢„ç¼–è¯‘IPKæ–‡ä»¶:"
            echo "$IPK_FILES"
            mkdir -p $BUILD_DIR/custom-ipks
            for ipk_file in $IPK_FILES; do
                cp "$ipk_file" $BUILD_DIR/custom-ipks/
                echo "å¤åˆ¶IPK: $(basename "$ipk_file")"
            done
            echo "âœ… IPKæ–‡ä»¶å·²å¤åˆ¶åˆ°æ„å»ºç›®å½•"
        else
            echo "â„¹ï¸ æœªæ‰¾åˆ°é¢„ç¼–è¯‘IPKæ–‡ä»¶"
        fi
        
        # å¤„ç†è‡ªå®šä¹‰è„šæœ¬
        SCRIPT_FILES=$(find firmware-config/custom-files/scripts -name "*.sh" -type f 2>/dev/null || true)
        if [ -n "$SCRIPT_FILES" ]; then
            echo "âœ… æ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬:"
            echo "$SCRIPT_FILES"
            mkdir -p $BUILD_DIR/custom-scripts
            for script_file in $SCRIPT_FILES; do
                cp "$script_file" $BUILD_DIR/custom-scripts/
                chmod +x $BUILD_DIR/custom-scripts/$(basename "$script_file")
                echo "å¤åˆ¶è„šæœ¬: $(basename "$script_file")"
            done
            echo "âœ… è‡ªå®šä¹‰è„šæœ¬å·²å¤åˆ¶åˆ°æ„å»ºç›®å½•"
        else
            echo "â„¹ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬"
        fi

    # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬æ­¥éª¤ - æ–°å¢æ­¥éª¤
    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
      if: github.event.inputs.custom_install == 'true'
      run: |
        cd $BUILD_DIR
        echo "=== æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ ==="
        
        if [ -d "custom-scripts" ] && [ "$(ls -A custom-scripts/*.sh 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "æ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬ç›®å½•ï¼Œå¼€å§‹æ‰§è¡Œè„šæœ¬..."
            cd custom-scripts
            
            # æŒ‰æ–‡ä»¶åæ’åºæ‰§è¡Œè„šæœ¬
            for script in $(ls *.sh | sort); do
                if [ -f "$script" ] && [ -x "$script" ]; then
                    echo "ğŸ”„ æ‰§è¡Œè„šæœ¬: $script"
                    echo "=== è„šæœ¬ $script è¾“å‡ºå¼€å§‹ ==="
                    # è®¾ç½®è„šæœ¬æ‰§è¡Œç¯å¢ƒ
                    export BUILD_DIR="$BUILD_DIR"
                    export PLATFORM="$PLATFORM"
                    export DEVICE_SHORT_NAME="$DEVICE_SHORT_NAME"
                    export CONFIG_TYPE="${{ github.event.inputs.config_type }}"
                    
                    # æ‰§è¡Œè„šæœ¬å¹¶æ•è·è¾“å‡ºå’Œé€€å‡ºçŠ¶æ€
                    set +e
                    ./"$script"
                    SCRIPT_EXIT_CODE=$?
                    set -e
                    
                    echo "=== è„šæœ¬ $script è¾“å‡ºç»“æŸ ==="
                    
                    if [ $SCRIPT_EXIT_CODE -eq 0 ]; then
                        echo "âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ: $script"
                    else
                        echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥: $script (é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE)"
                        exit 1
                    fi
                else
                    echo "âš ï¸ è·³è¿‡ä¸å¯æ‰§è¡Œæ–‡ä»¶: $script"
                fi
            done
            
            cd ..
            echo "âœ… æ‰€æœ‰è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"
        else
            echo "â„¹ï¸ æ²¡æœ‰è‡ªå®šä¹‰è„šæœ¬éœ€è¦æ‰§è¡Œ"
        fi

    # é…ç½®ä¿¡æ¯ä¿å­˜æ­¥éª¤
    - name: ä¿å­˜é…ç½®ä¿¡æ¯
      run: |
        cd $BUILD_DIR
        echo "=== ä¿å­˜é…ç½®ä¿¡æ¯ ==="
        # ä¿å­˜è®¾å¤‡ä¿¡æ¯
        echo "è®¾å¤‡: $DEVICE_SHORT_NAME" > device_info.txt
        echo "å¹³å°: $PLATFORM" >> device_info.txt
        echo "é…ç½®é¡¹: CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}" >> device_info.txt
        echo "é…ç½®ç±»å‹: ${{ github.event.inputs.config_type }}" >> device_info.txt
        echo "æºç ä»“åº“: $SELECTED_REPO" >> device_info.txt
        echo "æºç åˆ†æ”¯: $SELECTED_BRANCH" >> device_info.txt
        echo "=== å®Œæ•´ç›®æ ‡é…ç½® ===" >> device_info.txt
        grep "^CONFIG_TARGET" .config >> device_info.txt
        echo "=== é…ç½®æ‘˜è¦ ===" >> device_info.txt
        echo "ç›®æ ‡æ¿: $(grep 'CONFIG_TARGET_BOARD' .config || echo 'æœªè®¾ç½®')" >> device_info.txt
        echo "å­ç›®æ ‡: $(grep 'CONFIG_TARGET_SUBTARGET' .config || echo 'æœªè®¾ç½®')" >> device_info.txt

    # DLåº“ä¸‹è½½å’ŒéªŒè¯æ­¥éª¤ - æ–°å¢æ­¥éª¤
    - name: ä¸‹è½½DLåº“å¹¶éªŒè¯å®Œæ•´æ€§
      run: |
        cd $BUILD_DIR
        echo "=== ä¸‹è½½DLåº“å¹¶éªŒè¯å®Œæ•´æ€§ ==="
        
        # åˆ›å»ºä¸‹è½½ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p dl
        
        echo "å¼€å§‹å¹¶è¡Œä¸‹è½½ä¾èµ–..."
        # ä½¿ç”¨å¹¶è¡Œä¸‹è½½åŠ é€Ÿ
        make -j8 download V=s
        
        echo "=== éªŒè¯ä¸‹è½½å®Œæ•´æ€§ ==="
        
        # æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å®Œæ•´æ€§
        echo "1. æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å¤§å°..."
        EMPTY_FILES=$(find dl -type f -size 0 2>/dev/null | wc -l)
        if [ "$EMPTY_FILES" -gt 0 ]; then
            echo "âŒ å‘ç° $EMPTY_FILES ä¸ªç©ºæ–‡ä»¶ï¼Œä¸‹è½½å¯èƒ½ä¸å®Œæ•´"
            find dl -type f -size 0 | head -10
            echo "å°è¯•é‡æ–°ä¸‹è½½ç©ºæ–‡ä»¶..."
            # é‡æ–°ä¸‹è½½ç©ºæ–‡ä»¶
            for empty_file in $(find dl -type f -size 0); do
                filename=$(basename "$empty_file")
                echo "é‡æ–°ä¸‹è½½: $filename"
                make package/download V=s 2>&1 | grep "$filename" || true
            done
        else
            echo "âœ… æ²¡æœ‰ç©ºæ–‡ä»¶ï¼Œä¸‹è½½æ–‡ä»¶å¤§å°æ­£å¸¸"
        fi
        
        echo "2. æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å®Œæ•´æ€§ï¼ˆå“ˆå¸Œæ ¡éªŒï¼‰..."
        # æ£€æŸ¥æ˜¯å¦æœ‰æŸåçš„åŒ…
        if make -j1 V=s CHECK=hack ./scripts/download.pl 2>&1 | grep -i "error\|failed"; then
            echo "âŒ ä¸‹è½½æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥"
            echo "å°è¯•ä¿®å¤ä¸‹è½½..."
            make download V=s
        else
            echo "âœ… ä¸‹è½½æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"
        fi
        
        echo "3. æ˜¾ç¤ºä¸‹è½½ç»Ÿè®¡..."
        DL_COUNT=$(find dl -type f | wc -l)
        DL_SIZE=$(du -sh dl | cut -f1)
        echo "âœ… ä¸‹è½½å®Œæˆ: $DL_COUNT ä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°: $DL_SIZE"
        
        echo "4. é‡è¦æ–‡ä»¶éªŒè¯..."
        # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        CRITICAL_PATTERNS=(
            "dl/linux-*.tar.xz"
            "dl/gcc-*.tar.xz"
            "dl/uclibc-*.tar.xz"
            "dl/binutils-*.tar.xz"
        )
        
        for pattern in "${CRITICAL_PATTERNS[@]}"; do
            if ls $pattern 1> /dev/null 2>&1; then
                echo "âœ… æ‰¾åˆ°: $pattern"
            else
                echo "âš ï¸ æœªæ‰¾åˆ°: $pattern"
            fi
        done

    # ç¼–è¯‘æ­¥éª¤
    - name: åº”ç”¨é…ç½®å¹¶ç¼–è¯‘
      run: |
        cd $BUILD_DIR
        echo "=== åº”ç”¨é…ç½®å¹¶ç¼–è¯‘ ==="
        
        # æ³¨æ„ï¼šä¸‹è½½æ­¥éª¤å·²ç»åœ¨å‰é¢å•ç‹¬æ‰§è¡Œ
        
        # ä¿å­˜è¯¦ç»†æ„å»ºæ—¥å¿—
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        make -j$(nproc) V=s 2>&1 | tee build_detailed.log
        
        # æ£€æŸ¥æ„å»ºçŠ¶æ€
        if [ -d "bin/targets" ]; then
            echo "âœ… ç¼–è¯‘å®Œæˆ"
        else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            # å¦‚æœç¼–è¯‘å¤±è´¥ï¼Œå°è¯•é‡æ–°ç¼–è¯‘å•çº¿ç¨‹ä»¥è·å–æ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
            echo "å°è¯•å•çº¿ç¨‹ç¼–è¯‘ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯..."
            make V=s 2>&1 | tee build_single_thread.log
            exit 1
        fi

    # é”™è¯¯åˆ†ææ­¥éª¤
    - name: è¿è¡Œé”™è¯¯åˆ†æ
      if: always()  # æ— è®ºæ„å»ºæˆåŠŸä¸å¦éƒ½è¿è¡Œ
      run: |
        cd $BUILD_DIR
        echo "=== è¿è¡Œé”™è¯¯åˆ†æ ==="
        if [ -f "error_analysis.sh" ] && [ -f "build_detailed.log" ]; then
            chmod +x error_analysis.sh
            echo "å¼€å§‹é”™è¯¯åˆ†æ..."
            ./error_analysis.sh "$BUILD_DIR"
            echo "âœ… é”™è¯¯åˆ†æå®Œæˆ"
            
            # æ˜¾ç¤ºé”™è¯¯åˆ†ææŠ¥å‘Šæ‘˜è¦
            if [ -f "error_analysis.log" ]; then
                echo "=== é”™è¯¯åˆ†ææŠ¥å‘Šæ‘˜è¦ ==="
                head -20 error_analysis.log
            fi
        else
            echo "âš ï¸ é”™è¯¯åˆ†ææ¡ä»¶ä¸æ»¡è¶³:"
            [ -f "error_analysis.sh" ] || echo "  - é”™è¯¯åˆ†æè„šæœ¬ä¸å­˜åœ¨"
            [ -f "build_detailed.log" ] || echo "  - è¯¦ç»†æ„å»ºæ—¥å¿—ä¸å­˜åœ¨"
        fi

    # å›ºä»¶éªŒè¯æ­¥éª¤
    - name: éªŒè¯å›ºä»¶ç”Ÿæˆ
      if: always()  # æ— è®ºæ„å»ºæˆåŠŸä¸å¦éƒ½è¿è¡Œ
      run: |
        cd $BUILD_DIR
        echo "=== å›ºä»¶ç”ŸæˆéªŒè¯ ==="
        if [ -d "bin/targets" ]; then
          echo "âœ… æ„å»ºæˆåŠŸï¼ç”Ÿæˆçš„å›ºä»¶:"
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) | sort
          echo "=== å›ºä»¶è¯¦ç»†ä¿¡æ¯ ==="
          for firmware in $(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null); do
            echo "å›ºä»¶: $firmware"
            echo "å¤§å°: $(du -h "$firmware" | cut -f1)"
            echo ""
          done
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶"
          echo "=== æ£€æŸ¥æ„å»ºç›®å½•ç»“æ„ ==="
          find . -name "bin" -type d | head -5
          echo "=== æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ ==="
          find . -name "*.log" -type f | head -5
        fi

    # é…ç½®æ–‡ä»¶ä¿å­˜æ­¥éª¤
    - name: ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“
      if: success() && github.event.inputs.save_config == 'true'
      run: |
        echo "=== ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“ ==="
        CONFIG_FILENAME="${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}.config"
        mkdir -p $GITHUB_WORKSPACE/firmware-config/configs
        cp $BUILD_DIR/.config $GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME
        echo "âœ… é…ç½®æ–‡ä»¶å·²ä¿å­˜ä¸º: firmware-config/configs/$CONFIG_FILENAME"

    # é…ç½®æ–‡ä»¶æäº¤æ­¥éª¤
    - name: æäº¤é…ç½®æ–‡ä»¶æ›´æ”¹
      if: success() && github.event.inputs.save_config == 'true'
      run: |
        echo "=== æäº¤é…ç½®æ–‡ä»¶æ›´æ”¹ ==="
        cd $GITHUB_WORKSPACE
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add firmware-config/configs/
        git diff --staged --quiet || git commit -m "è‡ªåŠ¨ä¿å­˜é…ç½®æ–‡ä»¶: ${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}"
        git push

    # äº§ç‰©ä¸Šä¼ æ­¥éª¤
    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_type }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    # æ—¥å¿—å’Œé…ç½®ä¸Šä¼ æ­¥éª¤
    - name: ä¸Šä¼ é…ç½®å’Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/version_info.txt
          ${{ env.BUILD_DIR }}/device_info.txt
          ${{ env.BUILD_DIR }}/build_detailed.log
          ${{ env.BUILD_DIR }}/error_analysis.log
        retention-days: 7

    # æ¸…ç†æ­¥éª¤
    - name: æ¸…ç†æ„å»ºç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•å·²æ¸…ç†"
