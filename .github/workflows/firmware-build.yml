name: OpenWrt Êô∫ËÉΩÂõ∫‰ª∂ÊûÑÂª∫Â∑•‰ΩúÊµÅ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ËÆæÂ§áÂêçÁß∞ (Â¶Ç: ac42u, ac58u, mi4a Á≠â)'
        required: true
        default: 'ac42u'
        type: string
      version_spec:
        description: 'ÁâàÊú¨ËßÑÊ†º (ÂèØÈÄâÔºåÂ¶Ç: openwrt-23.05 Êàñ immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_type:
        description: 'ÈÖçÁΩÆÁ±ªÂûã (minimal:Âü∫Á°ÄÂäüËÉΩ, normal:ÂÆåÊï¥ÂäüËÉΩ, custom:Ëá™ÂÆö‰πâ)'
        required: true
        default: 'normal'
        type: choice
        options: ['minimal', 'normal', 'custom']
      extra_packages:
        description: 'È¢ùÂ§ñÂÆâË£ÖÊèí‰ª∂ (Á©∫Ê†ºÂàÜÈöîÁöÑÂåÖÂêç)'
        required: false
        type: string
      disabled_plugins:
        description: 'Á¶ÅÁî®Êèí‰ª∂ (Á©∫Ê†ºÂàÜÈöîÁöÑÂåÖÂêçÔºåÂ¶Ç: luci-app-accesscontrol luci-app-ddns)'
        required: false
        type: string
        default: ''
      save_config:
        description: '‰øùÂ≠òÈÖçÁΩÆÊñá‰ª∂Âà∞‰ªìÂ∫ì'
        required: false
        default: true
        type: boolean
      enable_cache:
        description: 'ÂêØÁî®ÁºñËØëÁºìÂ≠ò (ÊòæËëóÂä†ÈÄüÂêéÁª≠ÁºñËØë)'
        required: false
        default: true
        type: boolean
      multithreading:
        description: 'ÂºÄÂêØÂ§öÁ∫øÁ®ãÁºñËØë'
        type: boolean
        default: true
      ssh_connection:
        description: '‰ΩøÁî® SSH ËøûÊé•Âà∞ÁºñËØëÁéØÂ¢ÉËøõË°åË∞ÉËØï'
        type: boolean
        default: false

env:
  BUILD_DIR: /mnt/openwrt-build
  MIRROR_SOURCE: "tuna"
  CUSTOM_INSTALL: true

jobs:
  build-firmware:
    if: ${{ inputs.ssh_connection == false }}
    runs-on: ubuntu-22.04
    
    steps:
    - name: ÂàùÂßãÁ©∫Èó¥Ê£ÄÊü•
      run: |
        echo "=== ÂàùÂßãÁ£ÅÁõòÁ©∫Èó¥Ê£ÄÊü• ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt ÂèØÁî®Á©∫Èó¥: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "ÈîôËØØ: /mnt Á©∫Èó¥‰∏çË∂≥50G"
          exit 1
        fi

    - name: Ê£ÄÂá∫ÈÖçÁΩÆ‰ªìÂ∫ì
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ËÆæÁΩÆÁºñËØëÁéØÂ¢É
      run: |
        echo "=== ÂÆâË£ÖÁºñËØë‰æùËµñÂåÖ ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo
        pip3 install requests urllib3
        echo "‚úÖ ÁºñËØëÁéØÂ¢ÉËÆæÁΩÆÂÆåÊàê"

    - name: ÂàõÂª∫ÊûÑÂª∫ÁõÆÂΩïÂπ∂ËÆæÁΩÆÊùÉÈôê
      run: |
        echo "=== ÂàõÂª∫ÊûÑÂª∫ÁõÆÂΩï ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        sudo chmod u+w $BUILD_DIR
        echo "‚úÖ ÊûÑÂª∫ÁõÆÂΩïÂàõÂª∫ÂÆåÊàê"
        touch $BUILD_DIR/test_write.txt && echo "‚úÖ ÂÜôÂÖ•ÊµãËØïÊàêÂäü" && rm $BUILD_DIR/test_write.txt

    - name: Â§çÂà∂ËÑöÊú¨Âà∞ÊûÑÂª∫ÁõÆÂΩï
      run: |
        echo "=== Â§çÂà∂ËÑöÊú¨Âà∞ÊûÑÂª∫ÁõÆÂΩï ==="
        cd $GITHUB_WORKSPACE
        SCRIPTS="complete_version_detector.sh device_detection.sh error_analysis.sh pre_download.sh check-plugins.sh diagnose-packages.sh"
        COPIED_COUNT=0
        for script in $SCRIPTS; do
          echo "Ê≠£Âú®Êü•Êâæ: $script"
          FOUND_SCRIPT=$(find . -name "$script" -type f | head -1)
          if [ -n "$FOUND_SCRIPT" ]; then
            cp "$FOUND_SCRIPT" $BUILD_DIR/
            echo "‚úÖ ÊâæÂà∞Âπ∂Â§çÂà∂: $script (‰ªé $FOUND_SCRIPT)"
            COPIED_COUNT=$((COPIED_COUNT + 1))
          else
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞: $script"
          fi
        done
        echo "ÊÄªÂÖ±Â§çÂà∂‰∫Ü $COPIED_COUNT ‰∏™ËÑöÊú¨Êñá‰ª∂"
        cd $BUILD_DIR
        echo "ÊûÑÂª∫ÁõÆÂΩï‰∏≠ÁöÑËÑöÊú¨:"
        ls -la *.sh 2>/dev/null || echo "Ê≤°ÊúâÊâæÂà∞.shÊñá‰ª∂"
        chmod +x *.sh 2>/dev/null || true
        echo "‚úÖ ËÑöÊú¨Â§çÂà∂ÂÆåÊàê"

    - name: È™åËØÅËÑöÊú¨Â≠òÂú®ÊÄß
      run: |
        cd $BUILD_DIR
        echo "=== È™åËØÅËÑöÊú¨Â≠òÂú®ÊÄß ==="
        echo "ÊûÑÂª∫ÁõÆÂΩïÂÜÖÂÆπ:"
        ls -la
        REQUIRED_SCRIPTS="complete_version_detector.sh device_detection.sh"
        ALL_SCRIPTS_EXIST=true
        for script in $REQUIRED_SCRIPTS; do
          if [ -f "$script" ]; then
            echo "‚úÖ $script Â≠òÂú®"
            chmod +x "$script"
          else
            echo "‚ùå ÈîôËØØ: $script ‰∏çÂ≠òÂú®"
            ALL_SCRIPTS_EXIST=false
          fi
        done
        if [ "$ALL_SCRIPTS_EXIST" = false ]; then
          echo "ÂΩìÂâçÁõÆÂΩï‰∏≠ÁöÑÊñá‰ª∂:"
          ls -la
          echo "‚ùå ÂÖ≥ÈîÆËÑöÊú¨Áº∫Â§±ÔºåÊûÑÂª∫ÁªàÊ≠¢"
          exit 1
        fi

    - name: Êô∫ËÉΩÁâàÊú¨Ê£ÄÊµã
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== Êô∫ËÉΩÁâàÊú¨Ê£ÄÊµã ==="
        sudo chown -R $USER:$USER . 2>/dev/null || true
        chmod u+w . 2>/dev/null || true
        chmod +x *.sh 2>/dev/null || true
        echo "ËÆæÂ§áÂêçÁß∞: ${{ github.event.inputs.device_name }}"
        echo "ÁâàÊú¨ËßÑÊ†º: ${{ inputs.version_spec }}"
        if [ ! -f "complete_version_detector.sh" ]; then
          echo "‚ùå ÈîôËØØ: complete_version_detector.sh ‰∏çÂ≠òÂú®"
          ls -la
          exit 1
        fi
        chmod +x complete_version_detector.sh
        set +e
        OUTPUT=$(./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ inputs.version_spec }}" "" 2>&1)
        SCRIPT_EXIT_CODE=$?
        set -e
        echo "ËÑöÊú¨ËæìÂá∫:"
        echo "$OUTPUT"
        echo "ËÑöÊú¨ÈÄÄÂá∫‰ª£Á†Å: $SCRIPT_EXIT_CODE"
        SELECTED_REPO=$(echo "$OUTPUT" | grep "^SELECTED_REPO=" | head -1 | cut -d'=' -f2)
        SELECTED_BRANCH=$(echo "$OUTPUT" | grep "^SELECTED_BRANCH=" | head -1 | cut -d'=' -f2)
        SELECTED_REPO_URL=$(echo "$OUTPUT" | grep "^SELECTED_REPO_URL=" | head -1 | cut -d'=' -f2)
        if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
            echo "‚úÖ ‰ªéËÑöÊú¨ËæìÂá∫‰∏≠ÊàêÂäüÊèêÂèñÁâàÊú¨‰ø°ÊÅØ"
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            echo "‚úÖ ÁéØÂ¢ÉÂèòÈáèÂ∑≤ËÆæÁΩÆ:"
            echo "  ‰ªìÂ∫ì: $SELECTED_REPO"
            echo "  ÂàÜÊîØ: $SELECTED_BRANCH"
            echo "  URL: $SELECTED_REPO_URL"
        else
            echo "‚ùå Êó†Ê≥ï‰ªéËÑöÊú¨ËæìÂá∫‰∏≠ÊèêÂèñÁâàÊú¨‰ø°ÊÅØ"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "‚ùå ÁâàÊú¨Ê£ÄÊµãÂ§±Ë¥•"
                exit 1
            else
                echo "‚ö†Ô∏è ËÑöÊú¨ÊàêÂäü‰ΩÜÊó†Ê≥ïÊèêÂèñÁâàÊú¨‰ø°ÊÅØÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº"
                echo "SELECTED_REPO=immortalwrt" >> $GITHUB_ENV
                echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
                echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
                echo "‚úÖ ‰ΩøÁî®ÈªòËÆ§ÁâàÊú¨‰ø°ÊÅØ"
            fi
        fi

    - name: Â§á‰ªΩÊ£ÄÊµãËÑöÊú¨
      run: |
        echo "=== Â§á‰ªΩÊ£ÄÊµãËÑöÊú¨ ==="
        mkdir -p /tmp/build-scripts-backup
        cp $BUILD_DIR/*.sh /tmp/build-scripts-backup/ 2>/dev/null || true
        echo "‚úÖ ËÑöÊú¨Â§á‰ªΩÂÆåÊàê"

    - name: Ê∏ÖÁêÜÊûÑÂª∫ÁõÆÂΩï
      run: |
        cd $BUILD_DIR
        echo "=== Ê∏ÖÁêÜÊûÑÂª∫ÁõÆÂΩïÂáÜÂ§áÂÖãÈöÜ ==="
        ls -la
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        sudo rm -rf .[!.]* 2>/dev/null || true
        ls -la
        echo "‚úÖ ÁõÆÂΩïÊ∏ÖÁêÜÂÆåÊàê"

    - name: ÂÖãÈöÜÊ∫êÁ†Å
      run: |
        cd $BUILD_DIR
        echo "=== ÂÖãÈöÜÈÄâÂÆöÁâàÊú¨ÁöÑÊ∫êÁ†Å ==="
        echo "‰ªìÂ∫ì: $SELECTED_REPO_URL"
        echo "ÂàÜÊîØ: $SELECTED_BRANCH"
        if [ -z "$SELECTED_REPO_URL" ] || [ -z "$SELECTED_BRANCH" ]; then
          echo "‚ùå ÈîôËØØ: ÁéØÂ¢ÉÂèòÈáèÊú™Ê≠£Á°ÆËÆæÁΩÆ"
          exit 1
        fi
        echo "Ê£ÄÊü•ÁõÆÂΩïÁä∂ÊÄÅ..."
        FILE_COUNT=$(ls -A | wc -l)
        if [ $FILE_COUNT -ne 0 ]; then
          echo "‚ùå ÈîôËØØ: ÁõÆÂΩïÈùûÁ©∫ÔºåÊó†Ê≥ïÂÖãÈöÜ"
          exit 1
        fi
        MAX_RETRIES=3
        RETRY_COUNT=0
        CLONE_SUCCESS=false
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$CLONE_SUCCESS" = false ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "ÂÖãÈöÜÂ∞ùËØï: $RETRY_COUNT/$MAX_RETRIES"
          if git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .; then
            echo "‚úÖ Ê∫êÁ†ÅÂÖãÈöÜÂÆåÊàê"
            CLONE_SUCCESS=true
          else
            echo "‚ùå ÂÖãÈöÜÂ§±Ë¥•ÔºåÂ∞ùËØï $RETRY_COUNT/$MAX_RETRIES"
            if echo "$SELECTED_REPO_URL" | grep -q "github.com" && [ $RETRY_COUNT -eq 2 ]; then
              echo "üîÑ Â∞ùËØï‰ΩøÁî®ÈïúÂÉèÊ∫ê..."
              MIRROR_URL=$(echo "$SELECTED_REPO_URL" | sed 's/github.com/github.com.cnpmjs.org/')
              rm -rf ./* ./.git* 2>/dev/null || true
              if git clone --depth 1 --branch "$SELECTED_BRANCH" "$MIRROR_URL" .; then
                echo "‚úÖ ‰ΩøÁî®ÈïúÂÉèÊ∫êÂÖãÈöÜÊàêÂäü"
                CLONE_SUCCESS=true
                break
              fi
            fi
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "‚ùå Ê∫êÁ†ÅÂÖãÈöÜÂ§±Ë¥•ÔºåËææÂà∞ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞"
              exit 1
            fi
            sleep 10
            rm -rf ./* ./.git* 2>/dev/null || true
          fi
        done

    - name: ÊÅ¢Â§çÊ£ÄÊµãËÑöÊú¨
      run: |
        cd $BUILD_DIR
        echo "=== ÊÅ¢Â§çÊ£ÄÊµãËÑöÊú¨ ==="
        cp /tmp/build-scripts-backup/*.sh ./ 2>/dev/null || true
        chmod +x *.sh
        echo "‚úÖ ËÑöÊú¨ÊÅ¢Â§çÂÆåÊàê"

    - name: Âä†Âº∫ÊêúÁ¥¢Âπ∂Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
      run: |
        cd $BUILD_DIR
        echo "=== Âä†Âº∫ÊêúÁ¥¢Âπ∂Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂ ==="
        cd $GITHUB_WORKSPACE
        
        echo "=== Âä†Âº∫ÊêúÁ¥¢ÈÖçÁΩÆÊñá‰ª∂ ==="
        mkdir -p $BUILD_DIR/config-templates
        
        # Âä†Âº∫ÊêúÁ¥¢ÔºöÂú®Â§ö‰∏™ÂèØËÉΩÁöÑ‰ΩçÁΩÆÊü•ÊâæÈÖçÁΩÆÊñá‰ª∂
        SEARCH_PATHS=". firmware-config configs firmware-config/configs firmware-config/config-templates"
        CONFIG_FILES="minimal.config normal-new.config normal-old.config"
        
        for config_file in $CONFIG_FILES; do
          echo "Ê≠£Âú®Âä†Âº∫ÊêúÁ¥¢ÈÖçÁΩÆÊñá‰ª∂: $config_file"
          FOUND_CONFIG=""
          
          # Âú®Â§ö‰∏™Ë∑ØÂæÑ‰∏≠ÊêúÁ¥¢
          for path in $SEARCH_PATHS; do
            if [ -f "$path/$config_file" ]; then
              FOUND_CONFIG="$path/$config_file"
              echo "‚úÖ Âú® $path ÊâæÂà∞: $config_file"
              break
            fi
          done
          
          # Â¶ÇÊûúÊ≤°ÊâæÂà∞Ôºå‰ΩøÁî®findÂëΩ‰ª§Ê∑±Â∫¶ÊêúÁ¥¢
          if [ -z "$FOUND_CONFIG" ]; then
            FOUND_CONFIG=$(find . -name "$config_file" -type f | head -1)
            if [ -n "$FOUND_CONFIG" ]; then
              echo "‚úÖ ‰ΩøÁî®findÊâæÂà∞: $config_file (Âú® $FOUND_CONFIG)"
            fi
          fi
          
          if [ -n "$FOUND_CONFIG" ]; then
            cp "$FOUND_CONFIG" $BUILD_DIR/config-templates/
            echo "‚úÖ Â§çÂà∂: $config_file (‰ªé $FOUND_CONFIG)"
          else
            echo "‚ùå ÈîôËØØ: Êú™ÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂ $config_file"
            echo "ÂΩìÂâçÁõÆÂΩïÁªìÊûÑ:"
            find . -type f -name "*.config" | head -20
            exit 1
          fi
        done
        
        echo "=== ÈÖçÁΩÆÊñá‰ª∂Â§çÂà∂ÂÆåÊàêÔºåÊ£ÄÊü•ÁªìÊûú ==="
        echo "config-templates ÁõÆÂΩïÂÜÖÂÆπ:"
        ls -la $BUILD_DIR/config-templates/
        
        echo "=== Â§çÂà∂ËÑöÊú¨Êñá‰ª∂ ==="
        SCRIPTS="error_analysis.sh pre_download.sh check-plugins.sh diagnose-packages.sh"
        for script in $SCRIPTS; do
          FOUND_SCRIPT=$(find . -name "$script" -type f | head -1)
          if [ -n "$FOUND_SCRIPT" ]; then
            cp "$FOUND_SCRIPT" $BUILD_DIR/
            chmod +x $BUILD_DIR/"$script"
            echo "‚úÖ Â§çÂà∂ËÑöÊú¨: $script"
          else
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞: $script"
          fi
        done
        
        echo "‚úÖ ÈÖçÁΩÆÊñá‰ª∂ÂíåËÑöÊú¨Â§çÂà∂ÂÆåÊàê"

    - name: ÈÖçÁΩÆÁ®≥ÂÆöfeedsÊ∫ê
      run: |
        cd $BUILD_DIR
        echo "=== ÈÖçÁΩÆÁ®≥ÂÆöfeedsÊ∫ê ==="
        echo "Ê£ÄÊµãÂà∞ÁöÑÁâàÊú¨ÂàÜÊîØ: $SELECTED_BRANCH"
        
        # Ê†πÊçÆÁâàÊú¨ÂàÜÊîØËÆæÁΩÆfeedsÂàÜÊîØ
        FEEDS_BRANCH="$SELECTED_BRANCH"
        if echo "$SELECTED_BRANCH" | grep -q "openwrt-24.10"; then
            FEEDS_BRANCH="openwrt-24.10"
        elif echo "$SELECTED_BRANCH" | grep -q "openwrt-23.05"; then
            FEEDS_BRANCH="openwrt-23.05"
        elif echo "$SELECTED_BRANCH" | grep -q "openwrt-22.03"; then
            FEEDS_BRANCH="openwrt-22.03"
        elif echo "$SELECTED_BRANCH" | grep -q "openwrt-21.02"; then
            FEEDS_BRANCH="openwrt-21.02"
        else
            echo "‚ö†Ô∏è Êú™Áü•ÁâàÊú¨ÂàÜÊîØÔºå‰ΩøÁî®ÈªòËÆ§ÂàÜÊîØ: master"
            FEEDS_BRANCH="master"
        fi
        
        echo "‰ΩøÁî®ÁöÑfeedsÂàÜÊîØ: $FEEDS_BRANCH"
        
        echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
        echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git routing https://github.com/openwrt/routing.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git telephony https://github.com/openwrt/telephony.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git nikki https://github.com/nikkinikki-org/OpenWrt-nikki.git;main" >> feeds.conf.default
        
        echo "‚úÖ Á®≥ÂÆöfeedsÈÖçÁΩÆÂÆåÊàê"
        echo "FeedsÈÖçÁΩÆÂÜÖÂÆπ:"
        cat feeds.conf.default

    - name: Êõ¥Êñ∞ÂÆâË£Öfeeds
      run: |
        cd $BUILD_DIR
        echo "=== Êõ¥Êñ∞ÂíåÂÆâË£Öfeeds ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "‚úÖ FeedsÊõ¥Êñ∞ÂÆâË£ÖÂÆåÊàê"

    - name: ËÆæÂ§áÊ£ÄÊµã
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== Êô∫ËÉΩËÆæÂ§áÊ£ÄÊµã‰∏éÂà´ÂêçËΩ¨Êç¢ ==="
        INPUT_DEVICE="${{ github.event.inputs.device_name }}"
        echo "ËæìÂÖ•ËÆæÂ§áÂêçÁß∞: $INPUT_DEVICE"
        case "$INPUT_DEVICE" in
            "ac42u"|"acrh17"|"rt-acrh17") ACTUAL_DEVICE="asus_rt-ac42u" ;;
            "ac58u"|"acrh13"|"rt-ac58u"|"rt-acrh13") ACTUAL_DEVICE="asus_rt-ac58u" ;;
            "mi4a"|"r4a") ACTUAL_DEVICE="xiaomi_mi-router-4a-gigabit" ;;
            "mi3g"|"r3g") ACTUAL_DEVICE="xiaomi_mi-router-3g" ;;
            *) ACTUAL_DEVICE="$INPUT_DEVICE" ;;
        esac
        if [ "$ACTUAL_DEVICE" != "$INPUT_DEVICE" ]; then
          echo "‚úÖ Ê£ÄÊµãÂà∞ËÆæÂ§áÈÄöÁî®ÂêçÁß∞ '$INPUT_DEVICE'ÔºåËΩ¨Êç¢‰∏∫ÂÆûÈôÖËÆæÂ§áÊ†áËØÜ '$ACTUAL_DEVICE'"
        else
          echo "‚ÑπÔ∏è ‰ΩøÁî®ÂéüÂßãËÆæÂ§áÂêçÁß∞: $ACTUAL_DEVICE"
        fi
        if [ ! -f "device_detection.sh" ]; then
          echo "‚ùå ÈîôËØØ: ËÆæÂ§áÊ£ÄÊµãËÑöÊú¨‰∏çÂ≠òÂú®"
          exit 1
        fi
        chmod +x device_detection.sh
        echo "=== ÂºÄÂßãËÆæÂ§áÊ£ÄÊµã ==="
        TEMP_LOG=$(mktemp)
        set +e
        ./device_detection.sh "$ACTUAL_DEVICE" 2>&1 | tee "$TEMP_LOG"
        SCRIPT_EXIT_CODE=$?
        set -e
        echo "=== ËÑöÊú¨ÈÄÄÂá∫‰ª£Á†Å: $SCRIPT_EXIT_CODE ==="
        PLATFORM=$(grep "^PLATFORM=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        DEVICE_SHORT_NAME=$(grep "^DEVICE_SHORT_NAME=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        DEVICE_FULL_NAME=$(grep "^DEVICE_FULL_NAME=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        echo "=== ÊèêÂèñÁöÑËÆæÂ§á‰ø°ÊÅØ ==="
        echo "Âπ≥Âè∞(PLATFORM): '$PLATFORM'"
        echo "ËÆæÂ§áÁü≠ÂêçÁß∞(DEVICE_SHORT_NAME): '$DEVICE_SHORT_NAME'"
        echo "ËÆæÂ§áÂÖ®ÂêçÁß∞(DEVICE_FULL_NAME): '$DEVICE_FULL_NAME'"
        rm -f "$TEMP_LOG"
        if [ -n "$PLATFORM" ] && [ -n "$DEVICE_SHORT_NAME" ] && [ -n "$DEVICE_FULL_NAME" ]; then
            echo "‚úÖ ‰ªéËÑöÊú¨ËæìÂá∫‰∏≠ÊàêÂäüÊèêÂèñËÆæÂ§á‰ø°ÊÅØ"
            echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
            echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
        else
            echo "‚ùå Êó†Ê≥ï‰ªéËÑöÊú¨ËæìÂá∫‰∏≠ÊèêÂèñËÆæÂ§á‰ø°ÊÅØ"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "‚ùå ËÆæÂ§áÊ£ÄÊµãÂ§±Ë¥•"
                exit 1
            else
                echo "‚ö†Ô∏è ËÑöÊú¨ÊàêÂäü‰ΩÜÊó†Ê≥ïÊèêÂèñËÆæÂ§á‰ø°ÊÅØÔºå‰ΩøÁî®Â§áÁî®ËÆæÂ§áÊò†Â∞Ñ"
                case "$ACTUAL_DEVICE" in
                    "asus_rt-ac42u"|"ac42u"|"acrh17"|"rt-acrh17")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac42u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "asus_rt-ac58u"|"ac58u"|"acrh13"|"rt-acrh13")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac58u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "xiaomi_mi-router-4a-gigabit"|"mi4a"|"r4a")
                        echo "PLATFORM=ramips" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=xiaomi_mi-router-4a-gigabit" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    *)
                        echo "‚ùå Êú™Áü•ËÆæÂ§áÔºåÊó†Ê≥ïËÆæÁΩÆÈªòËÆ§ÂÄº"
                        exit 1
                        ;;
                esac
                echo "‚úÖ Â∑≤‰ΩøÁî®Â§áÁî®ËÆæÂ§á‰ø°ÊÅØ"
            fi
        fi

    - name: ÂàõÂª∫Â¢ûÂº∫ÁâàÊèí‰ª∂Ê£ÄÊü•ËÑöÊú¨
      run: |
        cd $BUILD_DIR
        echo "=== ÂàõÂª∫Â¢ûÂº∫ÁâàÊèí‰ª∂Ê£ÄÊü•ËÑöÊú¨ ==="
        echo '#!/bin/bash' > check-plugins.sh
        echo 'set -e' >> check-plugins.sh
        echo 'BUILD_DIR="${1:-.}"' >> check-plugins.sh
        echo 'cd "$BUILD_DIR"' >> check-plugins.sh
        echo 'echo "=== Â¢ûÂº∫ÁâàÊèí‰ª∂ÂèØÁî®ÊÄßÊ£ÄÊü• ==="' >> check-plugins.sh
        echo '' >> check-plugins.sh
        echo 'if [ ! -d "feeds" ] || [ -z "$(ls -A feeds 2>/dev/null)" ]; then' >> check-plugins.sh
        echo '    echo "‚ùå FeedsÁõÆÂΩï‰∏∫Á©∫ÔºåË∑≥ËøáÊèí‰ª∂Ê£ÄÊü•"' >> check-plugins.sh
        echo '    echo "FeedsÁõÆÂΩï‰∏∫Á©∫" > plugin_availability_report.txt' >> check-plugins.sh
        echo '    exit 0' >> check-plugins.sh
        echo 'fi' >> check-plugins.sh
        echo '' >> check-plugins.sh
        echo 'echo "Êõ¥Êñ∞feeds..."' >> check-plugins.sh
        echo './scripts/feeds update -a > /dev/null 2>&1 || echo "‚ö†Ô∏è FeedsÊõ¥Êñ∞ÊúâË≠¶Âëä"' >> check-plugins.sh
        echo '' >> check-plugins.sh
        echo '# Êâ©Â±ïÊ†∏ÂøÉÊèí‰ª∂ÂàóË°®' >> check-plugins.sh
        echo 'CORE_PLUGINS="luci luci-base luci-theme-bootstrap luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn"' >> check-plugins.sh
        echo '' >> check-plugins.sh
        echo '# Êâ©Â±ïÂ∏∏Áî®Êèí‰ª∂ÂàóË°®' >> check-plugins.sh
        echo 'COMMON_PLUGINS="luci-app-turboacc luci-app-flowoffload luci-app-sfe luci-app-sqm luci-app-upnp luci-app-samba4 luci-app-samba luci-app-smartdns luci-app-wireguard luci-app-ddns luci-app-adblock luci-app-acl luci-app-commands luci-app-dockerman luci-app-frpc luci-app-frps luci-app-mwan3 luci-app-openvpn luci-app-wol"' >> check-plugins.sh
        echo '' >> check-plugins.sh
        echo 'REPORT_FILE="plugin_availability_report.txt"' >> check-plugins.sh
        echo 'echo "Êèí‰ª∂ÂèØÁî®ÊÄßÊ£ÄÊü•Êä•Âëä" > $REPORT_FILE' >> check-plugins.sh
        echo 'echo "ÁîüÊàêÊó∂Èó¥: $(date)" >> $REPORT_FILE' >> check-plugins.sh
        echo 'echo "==========================================" >> $REPORT_FILE' >> check-plugins.sh
        echo '' >> check-plugins.sh
        echo 'echo "Ê£ÄÊü•Ê†∏ÂøÉÊèí‰ª∂..." | tee -a $REPORT_FILE' >> check-plugins.sh
        echo 'CORE_MISSING=""' >> check-plugins.sh
        echo 'for plugin in $CORE_PLUGINS; do' >> check-plugins.sh
        echo '    if ./scripts/feeds install "$plugin" > /dev/null 2>&1; then' >> check-plugins.sh
        echo '        echo "‚úÖ $plugin - ÂèØÁî®" >> $REPORT_FILE' >> check-plugins.sh
        echo '    else' >> check-plugins.sh
        echo '        echo "‚ùå $plugin - Áº∫Â§±" >> $REPORT_FILE' >> check-plugins.sh
        echo '        CORE_MISSING="$CORE_MISSING $plugin"' >> check-plugins.sh
        echo '    fi' >> check-plugins.sh
        echo 'done' >> check-plugins.sh
        echo '' >> check-plugins.sh
        echo 'echo "" >> $REPORT_FILE' >> check-plugins.sh
        echo 'echo "Ê£ÄÊü•Â∏∏Áî®Êèí‰ª∂..." >> $REPORT_FILE' >> check-plugins.sh
        echo 'COMMON_MISSING=""' >> check-plugins.sh
        echo 'for plugin in $COMMON_PLUGINS; do' >> check-plugins.sh
        echo '    if ./scripts/feeds install "$plugin" > /dev/null 2>&1; then' >> check-plugins.sh
        echo '        echo "‚úÖ $plugin - ÂèØÁî®" >> $REPORT_FILE' >> check-plugins.sh
        echo '    else' >> check-plugins.sh
        echo '        echo "‚ùå $plugin - Áº∫Â§±" >> $REPORT_FILE' >> check-plugins.sh
        echo '        COMMON_MISSING="$COMMON_MISSING $plugin"' >> check-plugins.sh
        echo '    fi' >> check-plugins.sh
        echo 'done' >> check-plugins.sh
        echo '' >> check-plugins.sh
        echo 'echo "" >> $REPORT_FILE' >> check-plugins.sh
        echo 'echo "=== Ê£ÄÊü•ÊÄªÁªì ===" >> $REPORT_FILE' >> check-plugins.sh
        echo 'if [ -z "$CORE_MISSING" ]; then' >> check-plugins.sh
        echo '    echo "‚úÖ ÊâÄÊúâÊ†∏ÂøÉÊèí‰ª∂ÈÉΩÂèØÁî®" >> $REPORT_FILE' >> check-plugins.sh
        echo 'else' >> check-plugins.sh
        echo '    echo "‚ùå Ê†∏ÂøÉÊèí‰ª∂Áº∫Â§±:$CORE_MISSING" >> $REPORT_FILE' >> check-plugins.sh
        echo 'fi' >> check-plugins.sh
        echo '' >> check-plugins.sh
        echo 'if [ -z "$COMMON_MISSING" ]; then' >> check-plugins.sh
        echo '    echo "‚úÖ ÊâÄÊúâÂ∏∏Áî®Êèí‰ª∂ÈÉΩÂèØÁî®" >> $REPORT_FILE' >> check-plugins.sh
        echo 'else' >> check-plugins.sh
        echo '    echo "‚ö†Ô∏è Â∏∏Áî®Êèí‰ª∂Áº∫Â§±:$COMMON_MISSING" >> $REPORT_FILE' >> check-plugins.sh
        echo 'fi' >> check-plugins.sh
        echo '' >> check-plugins.sh
        echo 'echo "‚úÖ Êèí‰ª∂Ê£ÄÊü•ÂÆåÊàê"' >> check-plugins.sh
        echo 'exit 0' >> check-plugins.sh
        chmod +x check-plugins.sh
        echo "‚úÖ Â¢ûÂº∫ÁâàÊèí‰ª∂Ê£ÄÊü•ËÑöÊú¨ÂàõÂª∫ÂÆåÊàê"

    - name: Êô∫ËÉΩÊ£ÄÊü•Êèí‰ª∂ÂèØÁî®ÊÄß
      run: |
        cd $BUILD_DIR
        echo "=== Êô∫ËÉΩÊ£ÄÊü•Êèí‰ª∂ÂèØÁî®ÊÄß ==="
        if [ -f "check-plugins.sh" ]; then
            chmod +x check-plugins.sh
            echo "ÂºÄÂßãÊ£ÄÊü•Êèí‰ª∂ÂèØÁî®ÊÄß..."
            set +e
            ./check-plugins.sh "$BUILD_DIR"
            CHECK_RESULT=$?
            set -e
            if [ -f "plugin_availability_report.txt" ]; then
                echo "=== Êèí‰ª∂Ê£ÄÊü•Êä•Âëä ==="
                cat plugin_availability_report.txt
            fi
            if [ $CHECK_RESULT -eq 0 ]; then
                echo "‚úÖ Êèí‰ª∂Ê£ÄÊü•ÂÆåÊàê"
            else
                echo "‚ö†Ô∏è Êèí‰ª∂Ê£ÄÊü•ÂèëÁé∞ÈóÆÈ¢òÔºå‰ΩÜÁªßÁª≠ÊûÑÂª∫"
            fi
        else
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞Êèí‰ª∂Ê£ÄÊü•ËÑöÊú¨ÔºåË∑≥ËøáÊèí‰ª∂Ê£ÄÊü•"
        fi

    - name: ÂåÖÂèØÁî®ÊÄßËØäÊñ≠
      run: |
        cd $BUILD_DIR
        echo "=== ÂåÖÂèØÁî®ÊÄßËØäÊñ≠ ==="
        if [ -f "diagnose-packages.sh" ]; then
            chmod +x diagnose-packages.sh
            echo "ÂºÄÂßãËØäÊñ≠ÂåÖÂèØÁî®ÊÄß..."
            ./diagnose-packages.sh "$BUILD_DIR"
            echo "‚úÖ ÂåÖËØäÊñ≠ÂÆåÊàê"
        else
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞ÂåÖËØäÊñ≠ËÑöÊú¨ÔºåË∑≥ËøáËØäÊñ≠"
        fi

    - name: Êô∫ËÉΩÊèí‰ª∂ÊõøÊç¢ÈÖçÁΩÆ
      run: |
        cd $BUILD_DIR
        echo "=== Êô∫ËÉΩÊèí‰ª∂ÊõøÊç¢ÈÖçÁΩÆ ==="
        
        # ÊòæÁ§∫ÈÄâÊã©ÁöÑÈÖçÁΩÆÊñá‰ª∂ÂÜÖÂÆπ
        CONFIG_TYPE="${{ inputs.config_type }}"
        echo "ÈÖçÁΩÆÁ±ªÂûã: $CONFIG_TYPE"
        
        if [ "$CONFIG_TYPE" = "minimal" ]; then
            CONFIG_FILE="config-templates/minimal.config"
        elif [ "$CONFIG_TYPE" = "normal" ] || [ "$CONFIG_TYPE" = "custom" ]; then
            # Ëá™Âä®Âà§Êñ≠ÊòØÂê¶‰∏∫ËÄÅÊóßËÆæÂ§á
            IS_OLD_VERSION=0
            case "${{ github.event.inputs.device_name }}" in
                "wr841n"|"wr842n"|"wr941n"|"mr3420"|"ar71xx"*)
                    IS_OLD_VERSION=1
                    echo "‚úÖ Ëá™Âä®Âà§Êñ≠‰∏∫ËÄÅÊóßËÆæÂ§á: ${{ github.event.inputs.device_name }}"
                    ;;
            esac
            
            # Ê†πÊçÆÁâàÊú¨ÂàÜÊîØËá™Âä®Âà§Êñ≠
            if echo "$SELECTED_BRANCH" | grep -q -E "19\.07|21\.02|17\.01|lede"; then
                IS_OLD_VERSION=1
                echo "‚úÖ Ëá™Âä®Âà§Êñ≠‰∏∫ËÄÅÊóßÁâàÊú¨: $SELECTED_BRANCH"
            fi
            
            if [ "$SELECTED_REPO" = "lede" ] || [ "$SELECTED_REPO" = "openwrt-19.07" ] || [ "$SELECTED_REPO" = "openwrt-21.02" ]; then
                IS_OLD_VERSION=1
                echo "‚úÖ Ëá™Âä®Âà§Êñ≠‰∏∫ËÄÅÊóß‰ªìÂ∫ì: $SELECTED_REPO"
            fi
            
            if [ "$IS_OLD_VERSION" -eq 1 ]; then
                CONFIG_FILE="config-templates/normal-old.config"
            else
                CONFIG_FILE="config-templates/normal-new.config"
            fi
        else
            echo "‚ùå Êú™Áü•ÁöÑÈÖçÁΩÆÁ±ªÂûã: $CONFIG_TYPE"
            exit 1
        fi
        
        echo "=== ÈÄâÊã©ÁöÑÈÖçÁΩÆÊñá‰ª∂: $CONFIG_FILE ==="
        if [ ! -f "$CONFIG_FILE" ]; then
            echo "‚ùå ÈîôËØØ: Êâæ‰∏çÂà∞ÈÖçÁΩÆÊñá‰ª∂ $CONFIG_FILE"
            ls -la config-templates/
            exit 1
        fi
        
        # ÊòæÁ§∫ÂéüÂßãÈÖçÁΩÆÊñá‰ª∂ÂÜÖÂÆπ
        echo "=== ÂéüÂßãÈÖçÁΩÆÊñá‰ª∂ÂÜÖÂÆπ ==="
        grep "^CONFIG_PACKAGE" "$CONFIG_FILE" | head -20
        echo "..."
        
        # ÂàùÂßãÂåñÂü∫Á°ÄÈÖçÁΩÆ
        > .config
        echo "CONFIG_TARGET_${PLATFORM}=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
        
        cp "$CONFIG_FILE" temp_config
        
        # Â§ÑÁêÜÈ¢ùÂ§ñÊèí‰ª∂ÂíåÁ¶ÅÁî®Êèí‰ª∂
        EXTRA_PACKAGES="${{ inputs.extra_packages }}"
        DISABLED_PLUGINS="${{ inputs.disabled_plugins }}"
        
        if [ -n "$EXTRA_PACKAGES" ]; then
            echo "=== Ê∑ªÂä†È¢ùÂ§ñÊèí‰ª∂ ==="
            for pkg in $EXTRA_PACKAGES; do
                echo "Ê∑ªÂä†Êèí‰ª∂: $pkg"
                echo "CONFIG_PACKAGE_${pkg}=y" >> temp_config
            done
        fi
        
        if [ -n "$DISABLED_PLUGINS" ]; then
            echo "=== Á¶ÅÁî®ÊåáÂÆöÊèí‰ª∂ ==="
            for pkg in $DISABLED_PLUGINS; do
                echo "Á¶ÅÁî®Êèí‰ª∂: $pkg"
                sed -i "s/CONFIG_PACKAGE_${pkg}=y/# CONFIG_PACKAGE_${pkg} is not set/" temp_config
            done
        fi
        
        echo "=== ÊâßË°åÊô∫ËÉΩÊèí‰ª∂ÊõøÊç¢ ==="
        
        # Â¢ûÂº∫ÁöÑÊèí‰ª∂ÊõøÊç¢ÈÄªËæë
        if [ -f "plugin_availability_report.txt" ]; then
            echo "‰ΩøÁî®Êèí‰ª∂Ê£ÄÊü•Êä•ÂëäËøõË°åÊô∫ËÉΩÊõøÊç¢..."
            
            # ÁΩëÁªúÂä†ÈÄüÊèí‰ª∂ÊõøÊç¢
            if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" temp_config; then
                if ! grep -q "‚úÖ luci-app-turboacc" plugin_availability_report.txt && grep -q "‚ùå luci-app-turboacc" plugin_availability_report.txt; then
                    echo "‚ö†Ô∏è Á¶ÅÁî®‰∏çÂèØÁî®ÁöÑÊèí‰ª∂: luci-app-turboacc"
                    sed -i 's/CONFIG_PACKAGE_luci-app-turboacc=y/# CONFIG_PACKAGE_luci-app-turboacc is not set/' temp_config
                    # Â∞ùËØïÂêØÁî®Êõø‰ª£Êèí‰ª∂
                    if ./scripts/feeds install luci-app-flowoffload >/dev/null 2>&1; then
                        echo "üîÑ ÂêØÁî®Êõø‰ª£Êèí‰ª∂: luci-app-flowoffload"
                        echo "CONFIG_PACKAGE_luci-app-flowoffload=y" >> temp_config
                    elif ./scripts/feeds install luci-app-sfe >/dev/null 2>&1; then
                        echo "üîÑ ÂêØÁî®Êõø‰ª£Êèí‰ª∂: luci-app-sfe"
                        echo "CONFIG_PACKAGE_luci-app-sfe=y" >> temp_config
                    fi
                fi
            fi
            
            # SambaÊèí‰ª∂ÊõøÊç¢
            if grep -q "CONFIG_PACKAGE_luci-app-samba4=y" temp_config; then
                if ! grep -q "‚úÖ luci-app-samba4" plugin_availability_report.txt && grep -q "‚ùå luci-app-samba4" plugin_availability_report.txt; then
                    echo "‚ö†Ô∏è Á¶ÅÁî®‰∏çÂèØÁî®ÁöÑÊèí‰ª∂: luci-app-samba4"
                    sed -i 's/CONFIG_PACKAGE_luci-app-samba4=y/# CONFIG_PACKAGE_luci-app-samba4 is not set/' temp_config
                    # Â∞ùËØïÂêØÁî®ÊóßÁâàSamba
                    if ./scripts/feeds install luci-app-samba >/dev/null 2>&1; then
                        echo "üîÑ ÂêØÁî®Êõø‰ª£Êèí‰ª∂: luci-app-samba"
                        echo "CONFIG_PACKAGE_luci-app-samba=y" >> temp_config
                    fi
                fi
            fi
            
            # Ê£ÄÊü•ÂÖ∂‰ªñÂ∏∏Áî®Êèí‰ª∂
            for plugin in luci-app-wireguard luci-app-ddns luci-app-adblock luci-app-upnp luci-app-sqm; do
                if grep -q "CONFIG_PACKAGE_${plugin}=y" temp_config; then
                    if ! grep -q "‚úÖ ${plugin}" plugin_availability_report.txt && grep -q "‚ùå ${plugin}" plugin_availability_report.txt; then
                        echo "‚ö†Ô∏è Á¶ÅÁî®‰∏çÂèØÁî®ÁöÑÊèí‰ª∂: ${plugin}"
                        sed -i "s/CONFIG_PACKAGE_${plugin}=y/# CONFIG_PACKAGE_${plugin} is not set/" temp_config
                    fi
                fi
            done
        else
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞Êèí‰ª∂Ê£ÄÊü•Êä•ÂëäÔºå‰ΩøÁî®Âü∫Á°ÄÊõøÊç¢ÈÄªËæë"
            # Âü∫Á°ÄÊõøÊç¢ÈÄªËæë
            if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" temp_config && ! ./scripts/feeds install luci-app-turboacc >/dev/null 2>&1; then
                echo "üîÑ ÊõøÊç¢: luci-app-turboacc ‚Üí luci-app-flowoffload"
                sed -i 's/CONFIG_PACKAGE_luci-app-turboacc=y/CONFIG_PACKAGE_luci-app-flowoffload=y/' temp_config
            fi
        fi
        
        # ÊòæÁ§∫ÊõøÊç¢ÂêéÁöÑÈÖçÁΩÆ
        echo "=== ÊõøÊç¢ÂêéÁöÑÈÖçÁΩÆÊñá‰ª∂ÂÜÖÂÆπ ==="
        grep "^CONFIG_PACKAGE" temp_config | head -30
        echo "..."
        
        cat temp_config >> .config
        rm -f temp_config
        
        echo "‚úÖ ÈÖçÁΩÆÂä†ËΩΩÂÆåÊàê"
        
        echo "ËøêË°å make defconfig..."
        make defconfig
        
        # Á´ãÂç≥È™åËØÅÈÖçÁΩÆ
        echo "=== ÈÖçÁΩÆÈ™åËØÅ ==="
        echo "=== ÂÖ≥ÈîÆËΩØ‰ª∂ÂåÖÈÖçÁΩÆÁä∂ÊÄÅ ==="
        for pkg in luci luci-base luci-theme-bootstrap; do
          if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
            echo "‚úÖ $pkg: Â∑≤ÂêØÁî®"
          else
            echo "‚ùå $pkg: Êú™ÂêØÁî® - Â∞ùËØï‰øÆÂ§ç"
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          fi
        done
        
        for pkg in luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn; do
          if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
            echo "‚úÖ $pkg: Â∑≤ÂêØÁî®"
          else
            echo "‚ö†Ô∏è $pkg: Êú™ÂêØÁî®"
          fi
        done
        
        if [ "${{ inputs.config_type }}" = "normal" ] || [ "${{ inputs.config_type }}" = "custom" ]; then
          echo "=== Ê≠£Â∏∏Ê®°ÂºèÊèí‰ª∂Ê£ÄÊü• ==="
          for pkg in luci-app-turboacc luci-app-flowoffload luci-app-sfe luci-app-sqm luci-app-upnp luci-app-samba4 luci-app-samba luci-app-smartdns luci-app-wireguard luci-app-ddns luci-app-adblock; do
            if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
              echo "‚úÖ $pkg: Â∑≤ÂêØÁî®"
            else
              echo "‚ùå $pkg: Êú™ÂêØÁî®"
            fi
          done
        fi
        
        echo "=== ËÆæÂ§áÈÖçÁΩÆÈ™åËØÅ ==="
        if grep -q "^CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" .config; then
            echo "‚úÖ ËÆæÂ§áÈÖçÁΩÆÊ≠£Á°Æ"
        else
            echo "‚ùå ËÆæÂ§áÈÖçÁΩÆÈîôËØØ"
            exit 1
        fi
        
        echo "=== ÈÖçÁΩÆÈ™åËØÅÂÆåÊàê ==="
        make defconfig

    - name: ÊûÑÂª∫Êó∂ÈõÜÊàêËá™ÂÆö‰πâÊñá‰ª∂
      run: |
        cd $BUILD_DIR
        echo "=== ÊûÑÂª∫Êó∂ÈõÜÊàêËá™ÂÆö‰πâÊñá‰ª∂ ==="
        mkdir -p files/root/custom-install
        
        cd $GITHUB_WORKSPACE
        IPK_FILES=$(find firmware-config/custom-files -name "*.ipk" -type f 2>/dev/null || true)
        if [ -n "$IPK_FILES" ]; then
            echo "‚úÖ ÊâæÂà∞IPKÊñá‰ª∂:"
            for ipk in $IPK_FILES; do
                cp "$ipk" $BUILD_DIR/files/root/custom-install/
                echo "‚úÖ Â§çÂà∂IPK: $(basename "$ipk")"
            done
        fi
        
        SCRIPT_FILES=$(find firmware-config/custom-files -name "*.sh" -type f 2>/dev/null | grep -v "detector\|analysis" || true)
        if [ -n "$SCRIPT_FILES" ]; then
            echo "‚úÖ ÊâæÂà∞ËÑöÊú¨Êñá‰ª∂:"
            for script in $SCRIPT_FILES; do
                cp "$script" $BUILD_DIR/files/root/custom-install/
                chmod +x $BUILD_DIR/files/root/custom-install/$(basename "$script")
                echo "‚úÖ Â§çÂà∂ËÑöÊú¨: $(basename "$script")"
            done
        fi
        
        echo '#!/bin/sh' > $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'echo "=== ÂºÄÂßãÊûÑÂª∫Êó∂Ëá™ÂÆö‰πâÂÆâË£Ö ==="' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'if ls /root/custom-install/*.ipk >/dev/null 2>&1; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "ÊûÑÂª∫Êó∂ÂÆâË£ÖIPKÊñá‰ª∂..."' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    for ipk in /root/custom-install/*.ipk; do' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        echo "ÂÆâË£Ö: $(basename $ipk)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        opkg install "$ipk" --force-depends || echo "ÂÆâË£ÖÂ§±Ë¥•: $(basename $ipk)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    done' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'else' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "Êú™ÊâæÂà∞IPKÊñá‰ª∂"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'if ls /root/custom-install/*.sh >/dev/null 2>&1; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "ÊâßË°åÊûÑÂª∫Êó∂ËÑöÊú¨..."' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    for script in /root/custom-install/*.sh; do' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        if [ "$(basename $script)" != "build-time-install.sh" ]; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '            echo "ÊâßË°å: $(basename $script)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '            sh "$script" || echo "ÊâßË°åÂ§±Ë¥•: $(basename $script)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    done' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'else' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "Êú™ÊâæÂà∞ËÑöÊú¨Êñá‰ª∂"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'rm -rf /root/custom-install' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'echo "=== ÊûÑÂª∫Êó∂Ëá™ÂÆö‰πâÂÆâË£ÖÂÆåÊàê ==="' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        
        chmod +x $BUILD_DIR/files/root/custom-install/build-time-install.sh
        
        mkdir -p $BUILD_DIR/files/etc
        echo '#!/bin/sh' > $BUILD_DIR/files/etc/rc.local
        echo '' >> $BUILD_DIR/files/etc/rc.local
        echo '[ -f /root/custom-install/build-time-install.sh ] && {' >> $BUILD_DIR/files/etc/rc.local
        echo '    /root/custom-install/build-time-install.sh >/tmp/build-time-install.log 2>&1 &' >> $BUILD_DIR/files/etc/rc.local
        echo '}' >> $BUILD_DIR/files/etc/rc.local
        echo '' >> $BUILD_DIR/files/etc/rc.local
        echo 'exit 0' >> $BUILD_DIR/files/etc/rc.local
        
        chmod +x $BUILD_DIR/files/etc/rc.local
        echo "‚úÖ ÊûÑÂª∫Êó∂Ëá™ÂÆö‰πâÂÆâË£ÖÈÖçÁΩÆÂÆåÊàê"

    - name: ‰øÆÂ§çÁΩëÁªúÁéØÂ¢É
      run: |
        cd $BUILD_DIR
        echo "=== ‰øÆÂ§çÁΩëÁªúÂíå‰∏ãËΩΩÁéØÂ¢É ==="
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        mkdir -p dl
        chmod 755 dl
        echo "‚úÖ ÁΩëÁªúÁéØÂ¢É‰øÆÂ§çÂÆåÊàê"

    - name: ËøêË°åÈ¢Ñ‰∏ãËΩΩ
      run: |
        cd $BUILD_DIR
        echo "=== ËøêË°åÈ¢Ñ‰∏ãËΩΩËÑöÊú¨ ==="
        if [ -f "pre_download.sh" ]; then
            chmod +x pre_download.sh
            echo "ÂºÄÂßãÈ¢Ñ‰∏ãËΩΩÂ∏∏ËßÅ‰æùËµñÂåÖ..."
            ./pre_download.sh
            echo "‚úÖ È¢Ñ‰∏ãËΩΩÂÆåÊàê"
        else
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞È¢Ñ‰∏ãËΩΩËÑöÊú¨ÔºåË∑≥ËøáÈ¢Ñ‰∏ãËΩΩÊ≠•È™§"
        fi

    - name: ‰øÆÂ§çÁºñËØëÁéØÂ¢É
      run: |
        cd $BUILD_DIR
        echo "=== ‰øÆÂ§çÁºñËØëÁéØÂ¢É ==="
        # Ê∏ÖÁêÜÂèØËÉΩÁöÑÈóÆÈ¢ò
        find . -name "*.rej" -delete 2>/dev/null || true
        find . -name "*.orig" -delete 2>/dev/null || true
        
        # Á°Æ‰øùÂÖ≥ÈîÆÁõÆÂΩïÂ≠òÂú®
        mkdir -p staging_dir/host/bin
        mkdir -p staging_dir/target-*/host/bin
        
        # ÈáçÊñ∞ÁîüÊàêÈÖçÁΩÆ
        make defconfig
        echo "‚úÖ ÁºñËØëÁéØÂ¢É‰øÆÂ§çÂÆåÊàê"

    - name: ‰∏ãËΩΩ‰æùËµñ
      run: |
        cd $BUILD_DIR
        echo "=== ‰∏ãËΩΩDLÂ∫ìÂπ∂È™åËØÅÂÆåÊï¥ÊÄß ==="
        mkdir -p dl
        chmod 755 dl
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        echo "=== ËÆæÁΩÆÂõΩÂÜÖÈïúÂÉèÊ∫ê: $MIRROR_SOURCE ==="
        case "$MIRROR_SOURCE" in
            "tuna") MIRROR_URL="https://mirrors.tuna.tsinghua.edu.cn/openwrt" ;;
            "ustc") MIRROR_URL="https://mirrors.ustc.edu.cn/openwrt" ;;
            "tencent") MIRROR_URL="https://mirrors.cloud.tencent.com/openwrt" ;;
            "huawei") MIRROR_URL="https://mirrors.huaweicloud.com/openwrt" ;;
            *) MIRROR_URL="https://mirrors.tuna.tsinghua.edu.cn/openwrt" ;;
        esac
        MAX_DOWNLOAD_RETRIES=3
        RETRY_COUNT=0
        DOWNLOAD_SUCCESS=false
        echo "=== È¢ÑÂÖà‰∏ãËΩΩÂÖ≥ÈîÆ‰æùËµñ ==="
        make -j1 tools/install V=s 2>&1 | grep -E "Downloading|error" || true
        make -j1 toolchain/install V=s 2>&1 | grep -E "Downloading|error" || true
        find dl -name "*.tmp" -delete 2>/dev/null || true
        find dl -size 0 -delete 2>/dev/null || true
        while [ $RETRY_COUNT -lt $MAX_DOWNLOAD_RETRIES ] && [ "$DOWNLOAD_SUCCESS" = false ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "=== ‰∏ãËΩΩÂ∞ùËØï $RETRY_COUNT/$MAX_DOWNLOAD_RETRIES ==="
          if make -j1 download V=s; then
            echo "‚úÖ ‰∏ãËΩΩÂëΩ‰ª§ÊâßË°åÊàêÂäü"
            DOWNLOAD_SUCCESS=true
          else
            echo "‚ùå ‰∏ãËΩΩÂëΩ‰ª§ÊâßË°åÂ§±Ë¥•"
            if [ $RETRY_COUNT -eq $MAX_DOWNLOAD_RETRIES ]; then
              echo "‚ùå ËææÂà∞ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞Ôºå‰∏ãËΩΩÂ§±Ë¥•"
              echo "=== ÊúÄÂêéÂ∞ùËØïÂçïÁ∫øÁ®ã‰∏ãËΩΩ ==="
              make -j1 download V=s
              break
            else
              echo "üîÑ Á≠âÂæÖ15ÁßíÂêéÈáçËØï..."
              sleep 15
              find dl -name "*.tmp" -delete 2>/dev/null || true
              find dl -size 0 -delete 2>/dev/null || true
            fi
          fi
        done
        echo "=== ‰∏ãËΩΩÂÆåÊï¥ÊÄßÊ£ÄÊü• ==="
        EMPTY_FILES=$(find dl -type f -size 0 2>/dev/null | wc -l)
        if [ "$EMPTY_FILES" -gt 0 ]; then
          echo "‚ùå ÂèëÁé∞ $EMPTY_FILES ‰∏™Á©∫Êñá‰ª∂ÔºåÂà†Èô§ÂêéÈáçÊñ∞‰∏ãËΩΩ..."
          find dl -type f -size 0 -delete
          echo "ÈáçÊñ∞‰∏ãËΩΩÁ©∫Êñá‰ª∂..."
          make -j1 download V=s
        fi
        DL_COUNT=$(find dl -type f | wc -l)
        DL_SIZE=$(du -sh dl | cut -f1)
        echo "‚úÖ ‰∏ãËΩΩÁªüËÆ°: $DL_COUNT ‰∏™Êñá‰ª∂ÔºåÊÄªÂ§ßÂ∞è: $DL_SIZE"

    - name: È™åËØÅÈÖçÁΩÆ
      run: |
        cd $BUILD_DIR
        echo "=== ÊúÄÁªàËΩØ‰ª∂ÂåÖÈÖçÁΩÆÈ™åËØÅ ==="
        echo "=== ÂÖ≥ÈîÆËΩØ‰ª∂ÂåÖÈÖçÁΩÆÁä∂ÊÄÅ ==="
        for pkg in luci luci-base luci-theme-bootstrap; do
          if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
            echo "‚úÖ $pkg: Â∑≤ÂêØÁî®"
          else
            echo "‚ùå $pkg: Êú™ÂêØÁî® - Â∞ùËØï‰øÆÂ§ç"
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          fi
        done
        for pkg in luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn; do
          if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
            echo "‚úÖ $pkg: Â∑≤ÂêØÁî®"
          else
            echo "‚ö†Ô∏è $pkg: Êú™ÂêØÁî®"
          fi
        done
        if [ "${{ inputs.config_type }}" = "normal" ] || [ "${{ inputs.config_type }}" = "custom" ]; then
          echo "=== Ê≠£Â∏∏Ê®°ÂºèÊèí‰ª∂Ê£ÄÊü• ==="
          for pkg in luci-app-turboacc luci-app-flowoffload luci-app-sfe luci-app-sqm luci-app-upnp luci-app-samba4 luci-app-samba luci-app-smartdns luci-app-wireguard luci-app-ddns luci-app-adblock; do
            if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
              echo "‚úÖ $pkg: Â∑≤ÂêØÁî®"
            else
              echo "‚ùå $pkg: Êú™ÂêØÁî®"
            fi
          done
        fi
        echo "=== ÈÖçÁΩÆÈ™åËØÅÂÆåÊàê ==="
        make defconfig

    - name: ÁºñËØëÂõ∫‰ª∂
      run: |
        cd $BUILD_DIR
        echo "::group::üì± ÁºñËØëÊó•Âøó"
        echo "ÁºñËØëÂºÄÂßãÊó∂Èó¥: $(date)"
        export FORCE_UNSAFE_CONFIGURE=1
        if ${{ inputs.multithreading }}; then
          BUILD_JOBS=$(nproc)
          echo "‚úÖ Â§öÁ∫øÁ®ãÁºñËØë: ‰ΩøÁî® $BUILD_JOBS ‰∏™Âπ∂Ë°å‰ªªÂä°"
        else
          BUILD_JOBS=1
          echo "‚úÖ ÂçïÁ∫øÁ®ãÁºñËØë"
        fi
        echo "üöÄ ÂºÄÂßãÂàÜÈò∂ÊÆµÁºñËØë..."
        START_TIME=$(date +%s)
        echo "=== Èò∂ÊÆµ1: ÁºñËØëÂ∑•ÂÖ∑Èìæ ==="
        make -j$BUILD_JOBS tools/compile V=s 2>&1 | tee -a build_detailed.log
        echo "=== Èò∂ÊÆµ2: ÁºñËØëÂ∑•ÂÖ∑ ==="
        make -j$BUILD_JOBS toolchain/compile V=s 2>&1 | tee -a build_detailed.log
        echo "=== Èò∂ÊÆµ3: ÂÆåÊï¥ÁºñËØë ==="
        set +e
        time make -j$BUILD_JOBS V=s 2>&1 | tee -a build_detailed.log
        COMPILE_EXIT_CODE=$?
        set -e
        END_TIME=$(date +%s)
        COMPILE_TIME=$((END_TIME - START_TIME))
        echo "=== ÁºñËØëÊó∂Èó¥ÁªüËÆ° ==="
        echo "ÊÄªÁºñËØëÊó∂Èó¥: $((COMPILE_TIME / 60))ÂàÜÈíü$((COMPILE_TIME % 60))Áßí"
        if [ -d "bin/targets" ]; then
            echo "::endgroup::"
            echo "::notice::üéâ ÁºñËØëÊàêÂäüÂÆåÊàêÔºÅ"
            echo "‚úÖ ÁºñËØëÂÆåÊàêÔºåÊâæÂà∞ÁõÆÊ†áÊñá‰ª∂"
            FIRMWARE_LIST=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | sort)
            if [ -n "$FIRMWARE_LIST" ]; then
                echo "üéâ ÁîüÊàêÁöÑÂõ∫‰ª∂:"
                echo "$FIRMWARE_LIST"
            fi
            if [ $COMPILE_EXIT_CODE -ne 0 ]; then
                echo "‚ö†Ô∏è ÁºñËØëËøáÁ®ãÊúâË≠¶ÂëäÔºå‰ΩÜÁîüÊàê‰∫ÜÂõ∫‰ª∂Êñá‰ª∂"
            fi
        else
            echo "::endgroup::"
            echo "::notice::‚ùå ÁºñËØëÂ§±Ë¥•"
            echo "‚ùå ÁºñËØëÂ§±Ë¥•ÔºåÊú™ÁîüÊàêÁõÆÊ†áÊñá‰ª∂"
            if [ $COMPILE_EXIT_CODE -eq 0 ]; then
                echo "‚ùå ÁºñËØëÂëΩ‰ª§ÊàêÂäü‰ΩÜÊú™ÁîüÊàêÁõÆÊ†áÊñá‰ª∂"
                find . -maxdepth 3 -type d | sort | head -20
            fi
            exit 1
        fi

    - name: ÈîôËØØÂàÜÊûê
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== ËøêË°åÈîôËØØÂàÜÊûê ==="
        if [ -f "error_analysis.sh" ]; then
            chmod +x error_analysis.sh
            echo "ÂºÄÂßãÈîôËØØÂàÜÊûê..."
            ./error_analysis.sh "$BUILD_DIR"
            echo "‚úÖ ÈîôËØØÂàÜÊûêÂÆåÊàê"
        else
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞ÈîôËØØÂàÜÊûêËÑöÊú¨ÔºåË∑≥ËøáÈîôËØØÂàÜÊûê"
        fi

    - name: ÁîüÊàêÊèí‰ª∂Êò†Â∞ÑÊä•Âëä
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== ÁîüÊàêÊèí‰ª∂Êò†Â∞ÑÂàÜÊûêÊä•Âëä ==="
        if [ -f "plugin_availability_report.txt" ]; then
            echo "üìä Êèí‰ª∂ÂèØÁî®ÊÄßÂàÜÊûêÊä•Âëä:"
            cat plugin_availability_report.txt
            cp plugin_availability_report.txt "$GITHUB_WORKSPACE/Êèí‰ª∂Êò†Â∞ÑÊä•Âëä.txt"
            echo "‚úÖ Êèí‰ª∂Êò†Â∞ÑÊä•ÂëäÂ∑≤‰øùÂ≠òÂà∞‰ªìÂ∫ì"
        else
            echo "‚ÑπÔ∏è Êú™ÊâæÂà∞Êèí‰ª∂Ê£ÄÊü•Êä•Âëä"
        fi

    - name: È™åËØÅÂõ∫‰ª∂
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== Âõ∫‰ª∂ÁîüÊàêÈ™åËØÅ ==="
        if [ -d "bin/targets" ]; then
          echo "‚úÖ ÊûÑÂª∫ÊàêÂäüÔºÅÁîüÊàêÁöÑÂõ∫‰ª∂:"
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) | sort
          for firmware in $(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null); do
            echo "Âõ∫‰ª∂: $firmware"
            echo "Â§ßÂ∞è: $(du -h "$firmware" | cut -f1)"
            echo ""
          done
        else
          echo "‚ùå ÊûÑÂª∫Â§±Ë¥•ÔºåÊú™ÊâæÂà∞ÁõÆÊ†áÊñá‰ª∂"
        fi

    - name: ÁîüÊàêÊä•Âëä
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== ÁîüÊàêÊûÑÂª∫Êä•ÂëäÊñáÊ°£ ==="
        echo "# OpenWrt Âõ∫‰ª∂ÊûÑÂª∫Êä•Âëä" > "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        echo "" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        echo "## ÊûÑÂª∫‰ø°ÊÅØ" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        echo "- **ËÆæÂ§á**: ${{ env.DEVICE_FULL_NAME }}" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        echo "- **Âπ≥Âè∞**: ${{ env.PLATFORM }}" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        echo "- **ÁâàÊú¨**: ${{ env.SELECTED_REPO }} (${{ env.SELECTED_BRANCH }})" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        echo "- **ÈÖçÁΩÆÁ±ªÂûã**: ${{ inputs.config_type }}" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        echo "- **ÊûÑÂª∫Êó∂Èó¥**: $(date)" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        echo "- **ÁºñËØëÊó∂Èïø**: $((COMPILE_TIME / 60))ÂàÜÈíü$((COMPILE_TIME % 60))Áßí" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        echo "" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        echo "## ÊûÑÂª∫Áä∂ÊÄÅ" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        if [ -d "bin/targets" ]; then
            echo "‚úÖ **ÊûÑÂª∫Áä∂ÊÄÅ**: ÊàêÂäü" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
            echo "" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
            echo "## ÁîüÊàêÁöÑÂõ∫‰ª∂" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
            find bin/targets -name "*.bin" -o -name "*.img" | while read firmware; do
                FIRMWARE_NAME=$(basename "$firmware")
                FIRMWARE_SIZE=$(du -h "$firmware" | cut -f1)
                echo "- **$FIRMWARE_NAME** ($FIRMWARE_SIZE)" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
            done
        else
            echo "‚ùå **ÊûÑÂª∫Áä∂ÊÄÅ**: Â§±Ë¥•" >> "$GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md"
        fi
        echo "‚úÖ ÊûÑÂª∫Êä•ÂëäÂ∑≤ÁîüÊàê"

    - name: ‰øùÂ≠òÈÖçÁΩÆ
      if: success() && ${{ inputs.save_config }}
      run: |
        echo "=== ‰øùÂ≠òÈÖçÁΩÆÊñá‰ª∂Âà∞‰ªìÂ∫ì ==="
        CONFIG_FILENAME="${{ github.event.inputs.device_name }}-${{ inputs.config_type }}.config"
        mkdir -p $GITHUB_WORKSPACE/firmware-config/configs
        if [ ! -f "$BUILD_DIR/.config" ]; then
          echo "‚ùå ÈîôËØØ: Ê∫êÈÖçÁΩÆÊñá‰ª∂‰∏çÂ≠òÂú®"
          exit 1
        fi
        if [ -f "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" ]; then
          if diff -q "$BUILD_DIR/.config" "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" >/dev/null; then
            echo "‚ÑπÔ∏è ÈÖçÁΩÆÊñá‰ª∂Êó†ÂèòÂåñÔºåË∑≥Ëøá‰øùÂ≠ò"
            echo "CONFIG_UNCHANGED=true" >> $GITHUB_ENV
            exit 0
          else
            echo "‚úÖ Ê£ÄÊµãÂà∞ÈÖçÁΩÆÊñá‰ª∂ÂèòÂåñÔºåÂ∞Ü‰øùÂ≠òÊñ∞ÈÖçÁΩÆ"
          fi
        else
          echo "‚úÖ ÈÖçÁΩÆÊñá‰ª∂‰∏çÂ≠òÂú®ÔºåÂ∞ÜÂàõÂª∫Êñ∞ÈÖçÁΩÆ"
        fi
        cp $BUILD_DIR/.config $GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME
        if [ -f "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" ]; then
          echo "‚úÖ ÈÖçÁΩÆÊñá‰ª∂Â∑≤‰øùÂ≠ò‰∏∫: firmware-config/configs/$CONFIG_FILENAME"
          echo "CONFIG_UNCHANGED=false" >> $GITHUB_ENV
        else
          echo "‚ùå ÈîôËØØ: ÈÖçÁΩÆÊñá‰ª∂‰øùÂ≠òÂ§±Ë¥•"
          exit 1
        fi

    - name: Êèê‰∫§ÈÖçÁΩÆ
      if: success() && ${{ inputs.save_config }} && env.CONFIG_UNCHANGED == 'false'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "=== Êèê‰∫§ÈÖçÁΩÆÊñá‰ª∂Êõ¥Êîπ ==="
        cd $GITHUB_WORKSPACE
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
        git add firmware-config/configs/
        git add "ÊûÑÂª∫Êä•Âëä.md" 2>/dev/null || true
        git add "Êèí‰ª∂Êò†Â∞ÑÊä•Âëä.txt" 2>/dev/null || true
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è Ê≤°ÊúâÈÖçÁΩÆÊñá‰ª∂Êõ¥ÊîπÈúÄË¶ÅÊèê‰∫§"
          exit 0
        fi
        git commit -m "Ëá™Âä®‰øùÂ≠òÈÖçÁΩÆÊñá‰ª∂: ${{ github.event.inputs.device_name }}-${{ inputs.config_type }} [skip ci]"
        git pull origin main --rebase --no-edit
        git push origin main
        echo "‚úÖ ÈÖçÁΩÆÊñá‰ª∂Êèê‰∫§ÂÆåÊàê"

    - name: ‰∏ä‰º†Âõ∫‰ª∂
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ inputs.config_type }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ‰∏ä‰º†Êó•Âøó
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.device_name }}-${{ inputs.config_type }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/build_detailed.log
          ${{ env.BUILD_DIR }}/enhanced_error_analysis.log
          ${{ env.BUILD_DIR }}/download_attempt_*.log
          ${{ env.BUILD_DIR }}/plugin_availability_report.txt
          $GITHUB_WORKSPACE/ÊûÑÂª∫Êä•Âëä.md
          $GITHUB_WORKSPACE/Êèí‰ª∂Êò†Â∞ÑÊä•Âëä.txt
        retention-days: 7

    - name: Ê∏ÖÁêÜÁõÆÂΩï
      if: always()
      run: |
        echo "=== Ê∏ÖÁêÜÊûÑÂª∫ÁõÆÂΩï ==="
        sudo rm -rf $BUILD_DIR
        echo "‚úÖ ÊûÑÂª∫ÁõÆÂΩïÂ∑≤Ê∏ÖÁêÜ"

  build-firmware-ssh:
    if: ${{ inputs.ssh_connection == true }}
    name: üöÄ ÁºñËØë (Build) - SSHË∞ÉËØïÁâà
    runs-on: ubuntu-22.04
    steps:
    - name: ÂàùÂßãÁ©∫Èó¥Ê£ÄÊü•
      run: |
        echo "=== ÂàùÂßãÁ£ÅÁõòÁ©∫Èó¥Ê£ÄÊü• ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt ÂèØÁî®Á©∫Èó¥: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "ÈîôËØØ: /mnt Á©∫Èó¥‰∏çË∂≥50G"
          exit 1
        fi

    - name: Ê£ÄÂá∫ÈÖçÁΩÆ‰ªìÂ∫ì
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ËÆæÁΩÆÁºñËØëÁéØÂ¢É
      run: |
        echo "=== ÂÆâË£ÖÁºñËØë‰æùËµñÂåÖ ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip
        pip3 install requests urllib3
        echo "‚úÖ ÁºñËØëÁéØÂ¢ÉËÆæÁΩÆÂÆåÊàê"

    - name: ÂºÄÂêØ SSH ÊúçÂä°
      uses: lhotari/action-upterm@v1
      with:
        wait-timeout-minutes: 30

    - name: ÁºñËØëÂâçÊèêÁ§∫
      run: |
        echo "üöÄ SSHË∞ÉËØïÊ®°ÂºèÂ∑≤ÂêØÂä®"
        echo "ÊÇ®ÂèØ‰ª•ÈÄöËøáSSHËøûÊé•Âà∞ÊûÑÂª∫ÁéØÂ¢ÉËøõË°åË∞ÉËØï"
        echo "Ë∞ÉËØïÂÆåÊàêÂêéÔºåÊûÑÂª∫ÊµÅÁ®ãÂ∞ÜÁªßÁª≠ÊâßË°å"
