name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆé›†æˆæ™ºèƒ½ä¿®å¤ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, acrh17, r3gç­‰)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®
          
          ğŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚
        required: false
        type: string
        default: ""
      enable_cache:
        description: "âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)"
        required: false
        default: true
        type: boolean
      commit_toolchain:
        description: "ğŸ’¾ æäº¤å·¥å…·é“¾åˆ°ä»“åº“ (èŠ‚çœä¸‹æ¬¡ç¼–è¯‘æ—¶é—´)"
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  GIT_LFS_SKIP_SMUDGE: 1
  ENABLE_CACHE: "true"
  COMMIT_TOOLCHAIN: "true"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤0ï¼šå‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: "ğŸ“ 0. å‡†å¤‡æ„å»ºç¯å¢ƒ"
        run: |
          echo "=== ç¯å¢ƒå‡†å¤‡ ==="
          sudo mkdir -p ${{ env.BUILD_DIR }}
          sudo chmod 777 ${{ env.BUILD_DIR }}
          mkdir -p /tmp/source-upload /tmp/build-artifacts
      
      # æ­¥éª¤1-10ï¼šåŸæœ‰æ­¥éª¤ä¿æŒä¸å˜
      - name: "ğŸ“¥ 1. ä¸‹è½½æºä»£ç "
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step1_download_source "${{ github.workspace }}"
      
      - name: "ğŸ“¤ 2. ä¸Šä¼ æºä»£ç "
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step2_upload_source
      
      - name: "ğŸ“¤ 3. ä¸Šä¼ å‹ç¼©åŒ…"
        uses: actions/upload-artifact@v4
        with:
          name: "source-code-${{ github.event.inputs.device_name }}-${{ github.run_id }}"
          path: /tmp/source-upload/
      
      - name: "ğŸ”§ 4. Git LFSé…ç½®"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step4_install_git_lfs
      
      - name: "ğŸ“Š 5. å¤§æ–‡ä»¶æ£€æŸ¥"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step5_check_large_files
      
      - name: "ğŸ—‚ï¸ 6. å·¥å…·é“¾ç›®å½•æ£€æŸ¥"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step6_check_toolchain_dir
      
      - name: "ğŸ’¾ 7. åˆå§‹åŒ–å·¥å…·é“¾"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step7_init_toolchain_dir
      
      - name: "ğŸ› ï¸ 8. è®¾ç½®ç¯å¢ƒ"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step8_setup_environment
      
      - name: "ğŸ“ 9. åˆ›å»ºç›®å½•"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step9_create_build_dir
      
      - name: "ğŸš€ 10. åˆå§‹åŒ–ç¯å¢ƒ"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step10_init_build_env \
            "${{ github.event.inputs.device_name }}" \
            "${{ github.event.inputs.version_selection }}" \
            "${{ github.event.inputs.config_mode }}" \
            "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤11-22ï¼šåŸæœ‰æ­¥éª¤
      - name: "âš¡ 11. æ˜¾ç¤ºé…ç½®"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step11_show_config
      
      - name: "ğŸ”Œ 12. æ·»åŠ TurboACC"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step12_add_turboacc_support
      
      - name: "ğŸ“¦ 13. é…ç½®Feeds"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step13_configure_feeds
      
      - name: "ğŸ”§ 14. å®‰è£…TurboACCåŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step14_install_turboacc_packages
      
      - name: "ğŸ’½ 15. ç©ºé—´æ£€æŸ¥"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step15_pre_build_space_check
      
      - name: "âš™ï¸ 16. ç”Ÿæˆé…ç½®"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step16_generate_config "${{ github.event.inputs.extra_packages }}"
      
      - name: "ğŸ” 17. éªŒè¯USB"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step17_verify_usb_config
      
      - name: "ğŸ›¡ï¸ 18. USBå®Œæ•´æ€§"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step18_check_usb_drivers_integrity
      
      - name: "âœ… 19. åº”ç”¨é…ç½®"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step19_apply_config
      
      - name: "ğŸ’¾ 20. å¤‡ä»½é…ç½®"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step20_backup_config
      
      - name: "ğŸŒ 21. ä¿®å¤ç½‘ç»œ"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step21_fix_network
      
      - name: "ğŸ”§ 22. åŠ è½½å·¥å…·é“¾"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step22_load_toolchain
      
      # æ­¥éª¤23ï¼šæ£€æŸ¥å·¥å…·é“¾çŠ¶æ€
      - name: "ğŸ“Š 23. å·¥å…·é“¾çŠ¶æ€"
        run: firmware-config/scripts/build_firmware_main.sh workflow_main step23_check_toolchain_status
      
      # ğŸ”¥ æ­¥éª¤24ï¼šæ™ºèƒ½æŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬
      - name: "ğŸ” 24. æ™ºèƒ½æŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬"
        id: find_and_run_fix
        env:
          GIT_COMMITTER_NAME: "GitHub Actions Bot"
          GIT_COMMITTER_EMAIL: "actions@github.com"
          GIT_AUTHOR_NAME: "GitHub Actions Bot"
          GIT_AUTHOR_EMAIL: "actions@github.com"
        run: |
          echo "=== å¼€å§‹æŸ¥æ‰¾ä¿®å¤è„šæœ¬ ==="
          
          POSSIBLE_PATHS=(
            "firmware-config/scripts/fix-build.sh"
            "firmware-config/scripts/fix-build-issues.sh"
            ".github/scripts/fix-build-issues.sh"
            "scripts/fix-build.sh"
            "firmware-config/fix-build.sh"
            "fix-script.sh"
            "automation/fix-build.sh"
          )
          
          FIX_SCRIPT=""
          SCRIPT_LOCATION=""
          FOUND_IN="é¢„è®¾è·¯å¾„"
          
          echo "æœç´¢ä¿®å¤è„šæœ¬..."
          for path in "${POSSIBLE_PATHS[@]}"; do
            FULL_PATH="${{ github.workspace }}/$path"
            if [ -f "$FULL_PATH" ]; then
              FIX_SCRIPT="$FULL_PATH"
              SCRIPT_LOCATION="$path"
              echo "âœ… åœ¨é¢„è®¾è·¯å¾„æ‰¾åˆ°è„šæœ¬: $path"
              break
            fi
          done
          
          if [ -z "$FIX_SCRIPT" ]; then
            echo "å°è¯•å…¨å±€æŸ¥æ‰¾..."
            FOUND_SCRIPTS=$(find "${{ github.workspace }}" -type f \( -name "*fix*.sh" -o -name "*repair*.sh" -o -name "*patch*.sh" \) 2>/dev/null | head -10)
            
            if [ -n "$FOUND_SCRIPTS" ]; then
              SELECTED_SCRIPT=""
              for script in $FOUND_SCRIPTS; do
                if [[ "$script" == *"build"* ]] || [[ "$script" == *"openwrt"* ]]; then
                  SELECTED_SCRIPT="$script"
                  break
                fi
              done
              
              if [ -z "$SELECTED_SCRIPT" ]; then
                SELECTED_SCRIPT=$(echo "$FOUND_SCRIPTS" | head -1)
              fi
              
              FIX_SCRIPT="$SELECTED_SCRIPT"
              SCRIPT_LOCATION=$(echo "$FIX_SCRIPT" | sed "s|${{ github.workspace }}/||")
              FOUND_IN="å…¨å±€æŸ¥æ‰¾"
              echo "ğŸ” å…¨å±€æŸ¥æ‰¾åˆ°è„šæœ¬: $SCRIPT_LOCATION"
            fi
          fi
          
          if [ -n "$FIX_SCRIPT" ] && [ -f "$FIX_SCRIPT" ]; then
            echo "å¼€å§‹æ‰§è¡Œä¿®å¤è„šæœ¬..."
            chmod +x "$FIX_SCRIPT"
            
            cd ${{ env.BUILD_DIR }}/openwrt || { echo "âŒ æ— æ³•è¿›å…¥æ„å»ºç›®å½•"; exit 1; }
            
            LOG_FILE="/tmp/fix-script-output-$(date +%Y%m%d_%H%M%S).log"
            
            timeout 300 "$FIX_SCRIPT" 2>&1 | tee "$LOG_FILE"
            
            FIX_EXIT_CODE=${PIPESTATUS[0]}
            
            if [ $FIX_EXIT_CODE -eq 0 ]; then
              echo "âœ… ä¿®å¤è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
              echo "fix_script_status=success" >> $GITHUB_OUTPUT
            elif [ $FIX_EXIT_CODE -eq 124 ]; then
              echo "â° ä¿®å¤è„šæœ¬æ‰§è¡Œè¶…æ—¶"
              echo "fix_script_status=timeout" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ ä¿®å¤è„šæœ¬æ‰§è¡Œæœ‰é”™è¯¯"
              echo "fix_script_status=error" >> $GITHUB_OUTPUT
            fi
            
            echo "fix_script_location=$SCRIPT_LOCATION" >> $GITHUB_OUTPUT
            echo "fix_script_found_in=$FOUND_IN" >> $GITHUB_OUTPUT
            
            if [ -f "/tmp/fix_results.log" ]; then
              echo "ä¿®å¤è„šæœ¬æäº¤æŠ¥å‘Š:"
              if grep -q "changes_committed=true" /tmp/fix_results.log; then
                echo "âœ… ä¿®å¤è„šæœ¬å·²æäº¤æ›´æ”¹åˆ°ä»“åº“"
                echo "commit_status=success" >> $GITHUB_OUTPUT
              elif grep -q "push_failed=true" /tmp/fix_results.log; then
                echo "âš ï¸ ä¿®å¤è„šæœ¬æäº¤äº†æ›´æ”¹ä½†æ¨é€å¤±è´¥"
                echo "commit_status=push_failed" >> $GITHUB_OUTPUT
              fi
            fi
            
          else
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•ä¿®å¤è„šæœ¬"
            echo "è·³è¿‡ä¿®å¤æ­¥éª¤ï¼Œç»§ç»­ç¼–è¯‘æµç¨‹..."
            echo "fix_script_status=not_found" >> $GITHUB_OUTPUT
            echo "fix_script_location=none" >> $GITHUB_OUTPUT
            echo "fix_script_found_in=none" >> $GITHUB_OUTPUT
          fi
      
      # æ­¥éª¤24.5ï¼šæ£€æŸ¥å¹¶åº”ç”¨æ›´æ–°
      - name: "ğŸ”„ 24.5 æ£€æŸ¥å¹¶åº”ç”¨æ›´æ–°"
        if: steps.find_and_run_fix.outputs.commit_status == 'success'
        run: |
          echo "=== ä¿®å¤è„šæœ¬å·²æäº¤æ›´æ–° ==="
          echo "æ£€æµ‹åˆ°ä¿®å¤è„šæœ¬æäº¤äº†æ–‡ä»¶æ›´æ”¹"
          echo "è¿™äº›æ›´æ”¹å°†åœ¨ä¸‹æ¬¡å·¥ä½œæµè¿è¡Œæ—¶ç”Ÿæ•ˆ"
          echo ""
          echo "æäº¤çš„æ›´æ”¹åŒ…æ‹¬:"
          git log --oneline -1 || echo "æ— æ³•è·å–æäº¤ä¿¡æ¯"
          echo ""
          echo "ğŸ’¡ å»ºè®®: é‡æ–°è¿è¡Œå·¥ä½œæµä»¥ä½¿ç”¨æ›´æ–°åçš„æ–‡ä»¶"
      
      # æ­¥éª¤25ï¼šæ ¹æ®ä¿®å¤ç»“æœå†³ç­–
      - name: "âš–ï¸ 25. ä¿®å¤ç»“æœè¯„ä¼°"
        run: |
          echo "=== ä¿®å¤ç»“æœè¯„ä¼° ==="
          echo "ä¿®å¤è„šæœ¬çŠ¶æ€: ${{ steps.find_and_run_fix.outputs.fix_script_status }}"
          echo "è„šæœ¬ä½ç½®: ${{ steps.find_and_run_fix.outputs.fix_script_location }}"
          
          case "${{ steps.find_and_run_fix.outputs.fix_script_status }}" in
            "success")
              echo "âœ… ä¿®å¤æˆåŠŸï¼Œç»§ç»­ç¼–è¯‘æµç¨‹"
              ;;
            "timeout")
              echo "âš ï¸ ä¿®å¤è„šæœ¬æ‰§è¡Œè¶…æ—¶"
              echo "ä½†å¯èƒ½å·²ä¿®å¤éƒ¨åˆ†é—®é¢˜ï¼Œç»§ç»­ç¼–è¯‘æµç¨‹"
              ;;
            "error")
              echo "âš ï¸ ä¿®å¤è„šæœ¬æ‰§è¡Œæœ‰é”™è¯¯"
              echo "ç»§ç»­ç¼–è¯‘æµç¨‹ï¼Œéƒ¨åˆ†é—®é¢˜å¯èƒ½æœªä¿®å¤"
              ;;
            "not_found")
              echo "â„¹ï¸ æœªæ‰¾åˆ°ä¿®å¤è„šæœ¬"
              echo "ä½¿ç”¨åŸå§‹é…ç½®ç»§ç»­ç¼–è¯‘"
              ;;
            *)
              echo "ğŸ” æœªçŸ¥çŠ¶æ€ï¼Œç»§ç»­ç¼–è¯‘æµç¨‹"
              ;;
          esac
      
      # æ­¥éª¤26ï¼šä¸‹è½½ä¾èµ–åŒ…
      - name: "ğŸ“¥ 26. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step24_download_dependencies
      
      # æ­¥éª¤27ï¼šé›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "ğŸ”Œ 27. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step25_integrate_custom_files
      
      # æ­¥éª¤28ï¼šå‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "ğŸš¨ 28. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step26_pre_build_error_check
      
      # æ­¥éª¤29ï¼šç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 29. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step27_final_space_check
      
      # æ­¥éª¤30ï¼šç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰
      - name: "ğŸ”¨ 30. ç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step28_build_firmware
      
      # æ­¥éª¤31ï¼šä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•
      - name: "ğŸ’¾ 31. ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•"
        if: success() && github.event.inputs.enable_cache == 'true'
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step29_save_toolchain
      
      # æ­¥éª¤32ï¼šæäº¤å·¥å…·é“¾åˆ°ä»“åº“
      - name: "ğŸ“¤ 32. æäº¤å·¥å…·é“¾åˆ°ä»“åº“"
        if: success() && github.event.inputs.enable_cache == 'true' && github.event.inputs.commit_toolchain == 'true'
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step30_commit_toolchain
      
      # æ­¥éª¤33ï¼šé”™è¯¯åˆ†æ
      - name: "âš ï¸ 33. é”™è¯¯åˆ†æ"
        if: failure()
        run: |
          echo "=== ç¼–è¯‘å¤±è´¥åˆ†æ ==="
          cd ${{ env.BUILD_DIR }}/openwrt 2>/dev/null || exit 0
          [ -f "build.log" ] && tail -200 build.log | grep -A5 -B5 "error:\|Error:\|ERROR\|failed\|Failed"
      
      # æ­¥éª¤34ï¼šç¼–è¯‘åæ£€æŸ¥
      - name: "ğŸ“Š 34. ç¼–è¯‘åæ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step32_post_build_space_check
      
      # æ­¥éª¤35ï¼šå›ºä»¶æ£€æŸ¥
      - name: "ğŸ“¦ 35. å›ºä»¶æ£€æŸ¥"
        if: success()
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step33_check_firmware_files
      
      # æ­¥éª¤36ï¼šä¸Šä¼ å›ºä»¶
      - name: "â¬†ï¸ 36. ä¸Šä¼ å›ºä»¶"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: "firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          path: ${{ env.BUILD_DIR }}/bin/targets/
      
      # æ­¥éª¤37ï¼šä¸Šä¼ æ—¥å¿—
      - name: "â¬†ï¸ 37. ä¸Šä¼ æ—¥å¿—"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "build-log-${{ github.event.inputs.device_name }}"
          path: ${{ env.BUILD_DIR }}/build.log
      
      # æ­¥éª¤38ï¼šä¸Šä¼ é…ç½®
      - name: "â¬†ï¸ 38. ä¸Šä¼ é…ç½®"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "config-${{ github.event.inputs.device_name }}"
          path: ${{ github.workspace }}/firmware-config/config-backup/
      
      # æ­¥éª¤39ï¼šä¸Šä¼ ä¿®å¤è„šæœ¬æ—¥å¿—
      - name: "â¬†ï¸ 39. ä¸Šä¼ ä¿®å¤è„šæœ¬æ—¥å¿—"
        if: always() && steps.find_and_run_fix.outputs.fix_script_status != 'not_found'
        run: |
          echo "æŸ¥æ‰¾ä¿®å¤è„šæœ¬æ—¥å¿—..."
          LOG_FILES=$(find /tmp -name "fix-script-output-*.log" 2>/dev/null | head -3)
          if [ -n "$LOG_FILES" ]; then
            mkdir -p /tmp/fix-logs
            cp $LOG_FILES /tmp/fix-logs/ 2>/dev/null || true
            echo "âœ… ä¿®å¤æ—¥å¿—å‡†å¤‡å®Œæ¯•"
          fi
      
      - name: "â¬†ï¸ 39.1 ä¸Šä¼ ä¿®å¤æ—¥å¿—æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "fix-script-logs-${{ github.event.inputs.device_name }}"
          path: /tmp/fix-logs/
      
      # æ­¥éª¤40ï¼šæ¸…ç†ç›®å½•
      - name: "ğŸ§¹ 40. æ¸…ç†ç›®å½•"
        if: always()
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step37_cleanup
      
      # æ­¥éª¤41ï¼šæœ€ç»ˆæ„å»ºæ€»ç»“
      - name: "ğŸ“ˆ 41. æœ€ç»ˆæ„å»ºæ€»ç»“"
        if: always()
        run: |
          echo "=== æ„å»ºæ€»ç»“ ==="
          echo "çŠ¶æ€: ${{ job.status }}"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          [ "${{ job.status }}" = "success" ] && echo "âœ… æ„å»ºæˆåŠŸ" || echo "âŒ æ„å»ºå¤±è´¥"
