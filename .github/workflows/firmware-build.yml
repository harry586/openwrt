name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆUSBå®Œå…¨ä¿®å¤é€šç”¨ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, r3gç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ï¼šâœ… åŸºç¡€åŠŸèƒ½
          
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ ã€‚
        required: true
        type: choice
        default: 'normal'
        options:
        - 'base'
        - 'normal'
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šğŸ”´ç”¨åˆ†å·;åˆ†éš”ã€‚ğŸ”´ å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ğŸ”´ ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚ğŸ”´ ç¤ºä¾‹ï¼š+luci-app-wol;+luci-app-ddns
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        find firmware-config/scripts -name "*.sh" -exec chmod +x {} \;
        echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        firmware-config/scripts/build_firmware_main.sh setup_environment

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        firmware-config/scripts/build_firmware_main.sh create_build_dir

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      run: |
        firmware-config/scripts/build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"

    - name: æ·»åŠ  TurboACC æ”¯æŒ
      run: |
        firmware-config/scripts/build_firmware_main.sh add_turboacc_support

    - name: é…ç½®Feeds
      run: |
        firmware-config/scripts/build_firmware_main.sh configure_feeds

    - name: å®‰è£… TurboACC åŒ…
      if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
      run: |
        firmware-config/scripts/build_firmware_main.sh install_turboacc_packages

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        firmware-config/scripts/build_firmware_main.sh pre_build_space_check

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤é€šç”¨ç‰ˆï¼‰
      run: |
        firmware-config/scripts/build_firmware_main.sh generate_config \
          "${{ github.event.inputs.extra_packages }}"

    - name: éªŒè¯USBé…ç½®
      run: |
        firmware-config/scripts/build_firmware_main.sh verify_usb_config

    - name: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      run: |
        firmware-config/scripts/build_firmware_main.sh apply_config

    - name: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
        if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
          echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
          echo "æ–‡ä»¶å¤§å°: $(ls -lh ${{ env.BUILD_DIR }}/.config | awk '{print $5}')"
          echo "é…ç½®è¡Œæ•°: $(wc -l < ${{ env.BUILD_DIR }}/.config)"
          # å¤‡ä»½é…ç½®æ–‡ä»¶åˆ°å·¥ä½œåŒº
          cp "${{ env.BUILD_DIR }}/.config" "${{ github.workspace }}/.config.backup"
          echo "âœ… é…ç½®æ–‡ä»¶å·²å¤‡ä»½åˆ°å·¥ä½œåŒº"
        else
          echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
          find ${{ env.BUILD_DIR }} -name ".config" -o -name "config" 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
        fi

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        firmware-config/scripts/build_firmware_main.sh fix_network

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        firmware-config/scripts/build_firmware_main.sh download_dependencies

    - name: åŠ è½½å·¥å…·é“¾
      run: |
        firmware-config/scripts/build_firmware_main.sh load_toolchain

    - name: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      run: |
        firmware-config/scripts/build_firmware_main.sh integrate_custom_files

    - name: å‰ç½®é”™è¯¯æ£€æŸ¥
      run: |
        firmware-config/scripts/build_firmware_main.sh pre_build_error_check

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        firmware-config/scripts/build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"

    - name: ä¿å­˜å·¥å…·é“¾
      if: success() && github.event.inputs.enable_cache == 'true'
      run: |
        firmware-config/scripts/build_firmware_main.sh save_toolchain

    - name: é”™è¯¯åˆ†æ
      if: failure()
      run: |
        firmware-config/scripts/error_analysis.sh

    - name: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      run: |
        firmware-config/scripts/build_firmware_main.sh post_build_space_check

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: success()
      run: |
        firmware-config/scripts/build_firmware_main.sh check_firmware_files

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ github.workspace }}/.config.backup
        retention-days: 7

    - name: ä¸Šä¼ å·¥å…·é“¾ï¼ˆå¯é€‰ï¼‰
      if: success() && github.event.inputs.enable_cache == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: toolchain-${{ env.SELECTED_BRANCH }}-${{ env.TARGET }}-${{ env.SUBTARGET }}
        path: firmware-config/Toolchain/
        retention-days: 30

    - name: æ¸…ç†ç›®å½•ï¼ˆä¿ç•™é…ç½®æ–‡ä»¶ï¼‰
      if: always()
      run: |
        echo "=== æ¸…ç†ç›®å½•ä½†ä¿ç•™é…ç½®æ–‡ä»¶ ==="
        if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
          echo "å¤‡ä»½é…ç½®æ–‡ä»¶åˆ°å·¥ä½œåŒº..."
          cp "${{ env.BUILD_DIR }}/.config" "${{ github.workspace }}/last_config.config"
          echo "å¤‡ä»½å®Œæˆ"
        fi
        firmware-config/scripts/build_firmware_main.sh cleanup
