name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, acrh17, r3gç­‰)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©"
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ (ç”¨åˆ†å·åˆ†éš”)"
        required: false
        type: string
        default: ""
      enable_cache:
        description: "âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜"
        required: false
        default: true
        type: boolean
      save_toolchain:
        description: "ğŸ’¾ ä¿å­˜é€šç”¨å·¥å…·é“¾"
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  ENABLE_CACHE: "true"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # ========== ç¬¬1é˜¶æ®µï¼šå‡†å¤‡ç¯å¢ƒ ==========
      
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: "ğŸ“¥ 1. æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤2ï¼šè¿è¡Œä¿®å¤è„šæœ¬
      - name: "ğŸ”§ 2. è¿è¡Œä¿®å¤è„šæœ¬"
        run: |
          echo "=== è¿è¡Œä¿®å¤è„šæœ¬ ==="
          if [ -f "firmware-config/scripts/fix-build.sh" ]; then
            chmod +x firmware-config/scripts/fix-build.sh
            firmware-config/scripts/fix-build.sh || echo "ä¿®å¤è„šæœ¬æ‰§è¡Œå®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä¿®å¤è„šæœ¬"
          fi
      
      # æ­¥éª¤3ï¼šå‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: "ğŸ“ 3. å‡†å¤‡ç¯å¢ƒ"
        run: |
          echo "=== å‡†å¤‡æ„å»ºç¯å¢ƒ ==="
          sudo mkdir -p /mnt/openwrt-build
          sudo chmod 777 /mnt/openwrt-build
          mkdir -p /tmp/build-artifacts
      
      # ========== ç¬¬2é˜¶æ®µï¼šåˆå§‹åŒ–æ„å»º ==========
      
      # æ­¥éª¤4ï¼šè®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      - name: "ğŸ› ï¸ 4. è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
        run: |
          echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step8_setup_environment
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤5ï¼šåˆ›å»ºæ„å»ºç›®å½•
      - name: "ğŸ“ 5. åˆ›å»ºæ„å»ºç›®å½•"
        run: |
          echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step9_create_build_dir
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤6ï¼šæ£€æŸ¥å·¥å…·é“¾ç›®å½•
      - name: "ğŸ—‚ï¸ 6. æ£€æŸ¥å·¥å…·é“¾ç›®å½•"
        run: |
          echo "=== æ£€æŸ¥å·¥å…·é“¾ç›®å½• ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step6_check_toolchain_dir
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤7ï¼šåˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      - name: "ğŸš€ 7. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step10_init_build_env \
              "${{ github.event.inputs.device_name }}" \
              "${{ github.event.inputs.version_selection }}" \
              "${{ github.event.inputs.config_mode }}" \
              "${{ github.event.inputs.extra_packages }}"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # ========== ç¬¬3é˜¶æ®µï¼šé…ç½®å’Œç¼–è¯‘ ==========
      
      # æ­¥éª¤8ï¼šé…ç½®Feeds
      - name: "ğŸ“¦ 8. é…ç½®Feeds"
        run: |
          echo "=== é…ç½®Feeds ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step13_configure_feeds
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤9ï¼šç”Ÿæˆé…ç½®
      - name: "âš™ï¸ 9. ç”Ÿæˆé…ç½®"
        run: |
          echo "=== ç”Ÿæˆé…ç½® ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤10ï¼šåº”ç”¨é…ç½®
      - name: "âœ… 10. åº”ç”¨é…ç½®"
        run: |
          echo "=== åº”ç”¨é…ç½® ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh apply_config
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤11ï¼šä¸‹è½½ä¾èµ–åŒ…
      - name: "ğŸ“¥ 11. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step24_download_dependencies
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤12ï¼šç¼–è¯‘å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 12. ç¼–è¯‘å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== ç¼–è¯‘å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step27_final_space_check
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤13ï¼šç¼–è¯‘å›ºä»¶
      - name: "ğŸ”¨ 13. ç¼–è¯‘å›ºä»¶"
        run: |
          echo "=== ç¼–è¯‘å›ºä»¶ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step28_build_firmware
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤14ï¼šä¿å­˜é€šç”¨å·¥å…·é“¾
      - name: "ğŸ’¾ 14. ä¿å­˜é€šç”¨å·¥å…·é“¾"
        if: github.event.inputs.save_toolchain == 'true'
        run: |
          echo "=== ä¿å­˜é€šç”¨å·¥å…·é“¾ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step29_save_essential_toolchain
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # ========== ç¬¬4é˜¶æ®µï¼šç»“æœå¤„ç† ==========
      
      # æ­¥éª¤15ï¼šå›ºä»¶æ–‡ä»¶æ£€æŸ¥
      - name: "ğŸ“¦ 15. å›ºä»¶æ–‡ä»¶æ£€æŸ¥"
        if: success()
        run: |
          echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step33_check_firmware_files
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤16ï¼šé”™è¯¯åˆ†æï¼ˆå¦‚æœå¤±è´¥ï¼‰
      - name: "âš ï¸ 16. é”™è¯¯åˆ†æ"
        if: failure()
        run: |
          echo "=== é”™è¯¯åˆ†æ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step31_error_analysis
          else
            echo "æ‰§è¡ŒåŸºæœ¬é”™è¯¯åˆ†æ..."
            df -h
            free -h
          fi
      
      # æ­¥éª¤17ï¼šç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "ğŸ“Š 17. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step32_post_build_space_check
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤18ï¼šæœ€ç»ˆæ€»ç»“
      - name: "ğŸ“ˆ 18. æœ€ç»ˆæ€»ç»“"
        if: always()
        run: |
          echo "=== æ„å»ºæ€»ç»“ ==="
          echo "æ„å»ºçŠ¶æ€: ${{ job.status }}"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "å¯ç”¨ç¼“å­˜: ${{ github.event.inputs.enable_cache }}"
          echo "ä¿å­˜é€šç”¨å·¥å…·é“¾: ${{ github.event.inputs.save_toolchain }}"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… æ„å»ºæˆåŠŸ"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
          fi
