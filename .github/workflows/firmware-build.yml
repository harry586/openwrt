name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, acrh17, r3gç­‰)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®"
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚"
        required: false
        type: string
        default: ""
      enable_cache:
        description: "âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)"
        required: false
        default: true
        type: boolean
      commit_toolchain:
        description: "ğŸ’¾ æäº¤å·¥å…·é“¾åˆ°ä»“åº“ (èŠ‚çœä¸‹æ¬¡ç¼–è¯‘æ—¶é—´)"
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  GIT_LFS_SKIP_SMUDGE: 1
  ENABLE_CACHE: "true"
  COMMIT_TOOLCHAIN: "true"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # ========== ç¬¬0é˜¶æ®µï¼šæ£€å‡ºä»£ç  ==========
      
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: "ğŸ“¥ 1. æ£€å‡ºä»“åº“ä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿Git LFSæ­£å¸¸å·¥ä½œ
          lfs: true  # å¯ç”¨Git LFSæ”¯æŒ
      
      # ========== ç¬¬1é˜¶æ®µï¼šåˆå§‹å‡†å¤‡ ==========
      
      # æ­¥éª¤2ï¼šå‡†å¤‡åˆå§‹ç¯å¢ƒ
      - name: "ğŸ“ 2. å‡†å¤‡åˆå§‹ç¯å¢ƒ"
        run: |
          echo "=== å‡†å¤‡åˆå§‹ç¯å¢ƒ ==="
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "åˆ—å‡ºæ–‡ä»¶:"
          ls -la
          echo "åˆ›å»ºå¿…è¦ç›®å½•..."
          sudo mkdir -p ${{ env.BUILD_DIR }}
          sudo chmod 777 ${{ env.BUILD_DIR }}
          mkdir -p /tmp/source-upload /tmp/build-artifacts
      
      # æ­¥éª¤3ï¼šæŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬
      - name: "ğŸ”§ 3. æŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬"
        id: run_fix_script
        run: |
          echo "=== æŸ¥æ‰¾å¹¶è¿è¡Œä¿®å¤è„šæœ¬ ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "åˆ—å‡ºæ‰€æœ‰shæ–‡ä»¶:"
          find . -name "*.sh" -type f | head -10
          
          # æŸ¥æ‰¾ä¿®å¤è„šæœ¬
          if [ -f "./fix-build.sh" ]; then
            echo "âœ… æ‰¾åˆ°ä¿®å¤è„šæœ¬: ./fix-build.sh"
            chmod +x ./fix-build.sh
            timeout 300 bash ./fix-build.sh
            echo "fix_status=success" >> $GITHUB_OUTPUT
          elif [ -f "firmware-config/scripts/fix-build.sh" ]; then
            echo "âœ… æ‰¾åˆ°ä¿®å¤è„šæœ¬: firmware-config/scripts/fix-build.sh"
            chmod +x firmware-config/scripts/fix-build.sh
            timeout 300 bash firmware-config/scripts/fix-build.sh
            echo "fix_status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä¿®å¤è„šæœ¬ï¼Œè·³è¿‡ä¿®å¤æ­¥éª¤"
            echo "fix_status=skipped" >> $GITHUB_OUTPUT
          fi
      
      # æ­¥éª¤4ï¼šæŸ¥æ‰¾å¹¶å‡†å¤‡ä¸»æ„å»ºè„šæœ¬
      - name: "ğŸ”§ 4. æŸ¥æ‰¾å¹¶å‡†å¤‡ä¸»æ„å»ºè„šæœ¬"
        id: find_main_script
        run: |
          echo "=== æŸ¥æ‰¾ä¸»æ„å»ºè„šæœ¬ ==="
          echo "å½“å‰ç›®å½•ç»“æ„:"
          find . -maxdepth 3 -type d | sort
          
          # æ£€æŸ¥æ„å»ºè„šæœ¬æ˜¯å¦å­˜åœ¨å¹¶æ·»åŠ æƒé™
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âœ… æ‰¾åˆ°ä¸»æ„å»ºè„šæœ¬: firmware-config/scripts/build_firmware_main.sh"
            chmod +x firmware-config/scripts/build_firmware_main.sh
            echo "MAIN_SCRIPT_PATH=firmware-config/scripts/build_firmware_main.sh" >> $GITHUB_OUTPUT
            echo "main_script_found=true" >> $GITHUB_OUTPUT
          elif [ -f "./build_firmware_main.sh" ]; then
            echo "âœ… æ‰¾åˆ°ä¸»æ„å»ºè„šæœ¬: ./build_firmware_main.sh"
            chmod +x ./build_firmware_main.sh
            echo "MAIN_SCRIPT_PATH=./build_firmware_main.sh" >> $GITHUB_OUTPUT
            echo "main_script_found=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°ä¸»æ„å»ºè„šæœ¬"
            echo "åˆ—å‡ºå¯èƒ½çš„æ–‡ä»¶:"
            find . -name "*build*.sh" -type f
            echo "MAIN_SCRIPT_PATH=" >> $GITHUB_OUTPUT
            echo "main_script_found=false" >> $GITHUB_OUTPUT
          fi
      
      # ========== ç¬¬2é˜¶æ®µï¼šæ™ºèƒ½ä¸‹è½½ ==========
      
      # æ­¥éª¤5ï¼šæ™ºèƒ½ä¸‹è½½æºä»£ç 
      - name: "ğŸ“¥ 5. æ™ºèƒ½ä¸‹è½½æºä»£ç "
        id: download_source
        run: |
          echo "=== æ™ºèƒ½ä¸‹è½½æºä»£ç  ==="
          
          # å¦‚æœä¸»æ„å»ºè„šæœ¬å­˜åœ¨ï¼Œä½¿ç”¨å®ƒä¸‹è½½
          if [ "${{ steps.find_main_script.outputs.main_script_found }}" = "true" ]; then
            MAIN_SCRIPT="${{ steps.find_main_script.outputs.MAIN_SCRIPT_PATH }}"
            echo "ä½¿ç”¨ä¸»æ„å»ºè„šæœ¬: $MAIN_SCRIPT"
            "$MAIN_SCRIPT" workflow_main step1_download_source "${{ github.workspace }}"
            DOWNLOAD_EXIT_CODE=$?
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡ä¸‹è½½æ­¥éª¤"
            echo "æ³¨æ„ï¼šä»£ç å·²é€šè¿‡æ£€å‡ºæ­¥éª¤è·å–ï¼Œæ— éœ€å†æ¬¡ä¸‹è½½"
            DOWNLOAD_EXIT_CODE=0
          fi
          
          echo "ä¸‹è½½é€€å‡ºç : $DOWNLOAD_EXIT_CODE"
          echo "download_status=$DOWNLOAD_EXIT_CODE" >> $GITHUB_OUTPUT
      
      # æ­¥éª¤6ï¼šä¸Šä¼ æºä»£ç 
      - name: "ğŸ“¤ 6. ä¸Šä¼ æºä»£ç "
        if: steps.download_source.outputs.download_status == '0'
        run: |
          echo "=== ä¸Šä¼ æºä»£ç  ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step2_upload_source
          elif [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step2_upload_source
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡ä¸Šä¼ "
          fi
      
      # ========== ç¬¬3é˜¶æ®µï¼šé…ç½®ç¯å¢ƒ ==========
      
      # æ­¥éª¤7ï¼šGit LFSé…ç½®
      - name: "ğŸ”§ 7. Git LFSé…ç½®"
        run: |
          echo "=== Git LFSé…ç½® ==="
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global http.postBuffer 524288000
          git lfs install --force
          git lfs pull 2>/dev/null || echo "Git LFSæ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ„å»º"
      
      # æ­¥éª¤8ï¼šå¤§æ–‡ä»¶æ£€æŸ¥
      - name: "ğŸ“Š 8. å¤§æ–‡ä»¶æ£€æŸ¥"
        run: |
          echo "=== å¤§æ–‡ä»¶æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step5_check_large_files
          elif [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step5_check_large_files
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ£€æŸ¥"
          fi
      
      # æ­¥éª¤9ï¼šå·¥å…·é“¾ç›®å½•æ£€æŸ¥
      - name: "ğŸ—‚ï¸ 9. å·¥å…·é“¾ç›®å½•æ£€æŸ¥"
        run: |
          echo "=== å·¥å…·é“¾ç›®å½•æ£€æŸ¥ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step6_check_toolchain_dir
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ£€æŸ¥"
          fi
      
      # æ­¥éª¤10ï¼šåˆå§‹åŒ–å·¥å…·é“¾ç›®å½•
      - name: "ğŸ’¾ 10. åˆå§‹åŒ–å·¥å…·é“¾ç›®å½•"
        run: |
          echo "=== åˆå§‹åŒ–å·¥å…·é“¾ç›®å½• ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step7_init_toolchain_dir
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡åˆå§‹åŒ–"
          fi
      
      # æ­¥éª¤11ï¼šè®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      - name: "ğŸ› ï¸ 11. è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
        run: |
          echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step8_setup_environment
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œå°è¯•ç›´æ¥å®‰è£…"
            sudo apt-get update
            sudo apt-get install -y build-essential git ccache
          fi
      
      # æ­¥éª¤12ï¼šåˆ›å»ºæ„å»ºç›®å½•
      - name: "ğŸ“ 12. åˆ›å»ºæ„å»ºç›®å½•"
        run: |
          echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step9_create_build_dir
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œæ‰‹åŠ¨åˆ›å»ºç›®å½•"
            mkdir -p ${{ env.BUILD_DIR }}
          fi
      
      # ========== ç¬¬4é˜¶æ®µï¼šæ„å»ºæ‰§è¡Œ ==========
      
      # æ­¥éª¤13ï¼šåˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      - name: "ğŸš€ 13. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step10_init_build_env \
              "${{ github.event.inputs.device_name }}" \
              "${{ github.event.inputs.version_selection }}" \
              "${{ github.event.inputs.config_mode }}" \
              "${{ github.event.inputs.extra_packages }}"
          elif [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step10_init_build_env \
              "${{ github.event.inputs.device_name }}" \
              "${{ github.event.inputs.version_selection }}" \
              "${{ github.event.inputs.config_mode }}" \
              "${{ github.event.inputs.extra_packages }}"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            echo "å¯ç”¨è„šæœ¬åˆ—è¡¨:"
            find . -name "*.sh" -type f
            exit 1
          fi
      
      # æ­¥éª¤14ï¼šæ˜¾ç¤ºé…ç½®
      - name: "âš¡ 14. æ˜¾ç¤ºé…ç½®"
        run: |
          echo "=== æ˜¾ç¤ºé…ç½® ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step11_show_config
          fi
      
      # æ­¥éª¤15ï¼šæ·»åŠ TurboACCæ”¯æŒ
      - name: "ğŸ”Œ 15. æ·»åŠ TurboACCæ”¯æŒ"
        run: |
          echo "=== æ·»åŠ TurboACCæ”¯æŒ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step12_add_turboacc_support
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤16ï¼šé…ç½®Feeds
      - name: "ğŸ“¦ 16. é…ç½®Feeds"
        run: |
          echo "=== é…ç½®Feeds ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step13_configure_feeds
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤17ï¼šå®‰è£…TurboACCåŒ…
      - name: "ğŸ”§ 17. å®‰è£…TurboACCåŒ…"
        run: |
          echo "=== å®‰è£…TurboACCåŒ… ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step14_install_turboacc_packages
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤18ï¼šç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 18. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step15_pre_build_space_check
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤19ï¼šæ™ºèƒ½é…ç½®ç”Ÿæˆ
      - name: "âš™ï¸ 19. æ™ºèƒ½é…ç½®ç”Ÿæˆ"
        run: |
          echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step16_generate_config "${{ github.event.inputs.extra_packages }}"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤20ï¼šéªŒè¯USBé…ç½®
      - name: "ğŸ” 20. éªŒè¯USBé…ç½®"
        run: |
          echo "=== éªŒè¯USBé…ç½® ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step17_verify_usb_config
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤21ï¼šUSBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "ğŸ›¡ï¸ 21. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step18_check_usb_drivers_integrity
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤22ï¼šåº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "âœ… 22. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step19_apply_config
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤23ï¼šæ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "ğŸ’¾ 23. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step20_backup_config
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤24ï¼šä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "ğŸŒ 24. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step21_fix_network
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤25ï¼šåŠ è½½å·¥å…·é“¾
      - name: "ğŸ”§ 25. åŠ è½½å·¥å…·é“¾"
        run: |
          echo "=== åŠ è½½å·¥å…·é“¾ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step22_load_toolchain
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤26ï¼šæ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€
      - name: "ğŸ“Š 26. æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€"
        run: |
          echo "=== æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step23_check_toolchain_status
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤27ï¼šä¸‹è½½ä¾èµ–åŒ…
      - name: "ğŸ“¥ 27. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step24_download_dependencies
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤28ï¼šé›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "ğŸ”Œ 28. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step25_integrate_custom_files
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤29ï¼šå‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "ğŸš¨ 29. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          echo "=== å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step26_pre_build_error_check
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤30ï¼šç¼–è¯‘å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 30. ç¼–è¯‘å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== ç¼–è¯‘å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step27_final_space_check
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤31ï¼šç¼–è¯‘å›ºä»¶
      - name: "ğŸ”¨ 31. ç¼–è¯‘å›ºä»¶"
        run: |
          echo "=== ç¼–è¯‘å›ºä»¶ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step28_build_firmware
          else
            echo "âŒ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œæ— æ³•ç¼–è¯‘"
            exit 1
          fi
      
      # æ­¥éª¤32ï¼šä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•
      - name: "ğŸ’¾ 32. ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•"
        if: github.event.inputs.commit_toolchain == 'true'
        run: |
          echo "=== ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½• ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step29_save_toolchain
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤33ï¼šæäº¤å·¥å…·é“¾åˆ°ä»“åº“
      - name: "ğŸ“¤ 33. æäº¤å·¥å…·é“¾åˆ°ä»“åº“"
        if: github.event.inputs.commit_toolchain == 'true'
        run: |
          echo "=== æäº¤å·¥å…·é“¾åˆ°ä»“åº“ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step30_commit_toolchain
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤34ï¼šé”™è¯¯åˆ†æï¼ˆå¦‚æœå¤±è´¥ï¼‰
      - name: "âš ï¸ 34. é”™è¯¯åˆ†æ"
        if: failure()
        run: |
          echo "=== é”™è¯¯åˆ†æ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step31_error_analysis
          else
            echo "ğŸ“Š æ‰§è¡ŒåŸºæœ¬é”™è¯¯åˆ†æ..."
            echo "=== åŸºæœ¬é”™è¯¯åˆ†æ ==="
            echo "åˆ†ææ—¶é—´: $(date)"
            echo "å½“å‰ç›®å½•: $(pwd)"
            df -h
          fi
      
      # æ­¥éª¤35ï¼šç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "ğŸ“Š 35. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step32_post_build_space_check
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤36ï¼šå›ºä»¶æ–‡ä»¶æ£€æŸ¥
      - name: "ğŸ“¦ 36. å›ºä»¶æ–‡ä»¶æ£€æŸ¥"
        if: success()
        run: |
          echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step33_check_firmware_files
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # æ­¥éª¤37ï¼šæ¸…ç†ç›®å½•
      - name: "ğŸ§¹ 37. æ¸…ç†ç›®å½•"
        if: always()
        run: |
          echo "=== æ¸…ç†ç›®å½• ==="
          if [ -f "build_firmware_main.sh" ]; then
            chmod +x build_firmware_main.sh
            ./build_firmware_main.sh workflow_main step37_cleanup
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
      
      # ========== ç¬¬5é˜¶æ®µï¼šä¿®å¤ç»“æœå¤„ç† ==========
      
      # æ­¥éª¤38ï¼šæœ€ç»ˆä¿®å¤æäº¤
      - name: "ğŸ“¤ 38. æœ€ç»ˆä¿®å¤æäº¤"
        if: always() && steps.run_fix_script.outputs.fix_status == 'success'
        run: |
          echo "=== æœ€ç»ˆä¿®å¤æäº¤ ==="
          if [ -f "/tmp/fix_changes.log" ]; then
            echo "æ£€æµ‹åˆ°ä¿®å¤æ›´æ”¹ï¼Œå°è¯•æäº¤..."
            git config --global user.name "GitHub Actions Bot"
            git config --global user.email "actions@github.com"
            git add -A
            
            if git status --porcelain | grep -q "."; then
              echo "æäº¤ä¿®å¤æ›´æ”¹..."
              git commit -m "fix: è‡ªåŠ¨ä¿®å¤æ›´æ–° [$(date '+%Y-%m-%d %H:%M:%S')]"
              git commit --amend -m "fix: è‡ªåŠ¨ä¿®å¤æ›´æ–° [$(date '+%Y-%m-%d %H:%M:%S')]
              ä¿®å¤å†…å®¹:
              - å¢å¼ºè·¯å¾„æœç´¢åŠŸèƒ½
              - ä¿®å¤è„šæœ¬æ‰§è¡Œé¡ºåº
              - ä¼˜åŒ–å·¥ä½œæµæ­¥éª¤"
              
              for i in {1..3}; do
                echo "æ¨é€å°è¯• $i/3..."
                if git push; then
                  echo "âœ… ä¿®å¤æ›´æ”¹å·²æäº¤"
                  break
                else
                  echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’..."
                  sleep 10
                fi
              done
            else
              echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
            fi
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°ä¿®å¤æ›´æ”¹"
          fi
      
      # æ­¥éª¤39ï¼šæœ€ç»ˆæ„å»ºæ€»ç»“
      - name: "ğŸ“ˆ 39. æœ€ç»ˆæ„å»ºæ€»ç»“"
        if: always()
        run: |
          echo "=== æ„å»ºæ€»ç»“ ==="
          echo "æ„å»ºçŠ¶æ€: ${{ job.status }}"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "é¢å¤–æ’ä»¶: ${{ github.event.inputs.extra_packages }}"
          echo "å¯ç”¨ç¼“å­˜: ${{ github.event.inputs.enable_cache }}"
          echo "æäº¤å·¥å…·é“¾: ${{ github.event.inputs.commit_toolchain }}"
          echo ""
          echo "ä¿®å¤è„šæœ¬çŠ¶æ€: ${{ steps.run_fix_script.outputs.fix_status }}"
          echo "ä¸»æ„å»ºè„šæœ¬çŠ¶æ€: ${{ steps.find_main_script.outputs.main_script_found }}"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… æ„å»ºæˆåŠŸ"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
          fi
