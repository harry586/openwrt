name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œå…¨è‡ªåŠ¨åŒ–ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, acrh17, r3gç­‰)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®
          
          ğŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚
        required: false
        type: string
        default: ""
      enable_cache:
        description: "âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)"
        required: false
        default: true
        type: boolean
      commit_toolchain:
        description: "ğŸ’¾ æäº¤å·¥å…·é“¾åˆ°ä»“åº“ (èŠ‚çœä¸‹æ¬¡ç¼–è¯‘æ—¶é—´)"
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  GIT_LFS_SKIP_SMUDGE: 1
  ENABLE_CACHE: "true"
  COMMIT_TOOLCHAIN: "true"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤0ï¼šå‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: "ğŸ“ 0. å‡†å¤‡æ„å»ºç¯å¢ƒ"
        id: prepare_environment
        run: |
          echo "========================================"
          echo "ğŸ“ æ­¥éª¤0ï¼šå‡†å¤‡æ„å»ºç¯å¢ƒ"
          echo "========================================"
          echo ""
          
          # åˆ›å»ºæ„å»ºç›®å½•
          echo "ğŸ“ åˆ›å»ºæ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          sudo mkdir -p ${{ env.BUILD_DIR }}
          sudo chmod 777 ${{ env.BUILD_DIR }}
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ -d "${{ env.BUILD_DIR }}" ]; then
            echo "âœ… æ„å»ºç›®å½•åˆ›å»ºæˆåŠŸ"
            echo "  è·¯å¾„: ${{ env.BUILD_DIR }}"
            echo "  æƒé™: $(ls -ld ${{ env.BUILD_DIR }} | awk '{print $1}')"
          else
            echo "âŒ æ„å»ºç›®å½•åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          # åˆ›å»ºå…¶ä»–å¿…è¦ç›®å½•
          echo "ğŸ“ åˆ›å»ºå…¶ä»–å¿…è¦ç›®å½•..."
          mkdir -p /tmp/source-upload
          mkdir -p /tmp/build-artifacts
          
          echo ""
          echo "ğŸ’½ ç£ç›˜ç©ºé—´æ£€æŸ¥:"
          df -h ${{ env.BUILD_DIR }}
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤0å®Œæˆï¼šç¯å¢ƒå‡†å¤‡å®Œæˆ"
          echo "========================================"
      
      # æ­¥éª¤1ï¼šä¸‹è½½å®Œæ•´æºä»£ç 
      - name: "ğŸ“¥ 1. ä¸‹è½½å®Œæ•´æºä»£ç "
        id: download_source
        run: |
          # åˆ›å»ºå·¥ä½œåŒºç›®å½•
          mkdir -p ${{ github.workspace }}
          cd ${{ github.workspace }}
          
          # æ¸…ç†å·¥ä½œåŒº
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œåŒº..."
          find . -maxdepth 1 ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true
          
          # å…‹éš†å®Œæ•´ä»“åº“
          echo "ğŸ“¦ å…‹éš†å®Œæ•´ä»“åº“..."
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          
          if [ ! -d ".git" ]; then
            echo "âŒ é”™è¯¯: ä»“åº“å…‹éš†å¤±è´¥"
            exit 1
          fi
          
          # è®¾ç½®è„šæœ¬æƒé™
          echo "ğŸ”§ è®¾ç½®è„šæœ¬æƒé™..."
          find . -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null || true
          
          echo "âœ… æºä»£ç ä¸‹è½½å®Œæˆ"
      
      # æ­¥éª¤2ï¼šç«‹å³ä¸Šä¼ æºä»£ç 
      - name: "ğŸ“¤ 2. ç«‹å³ä¸Šä¼ æºä»£ç "
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step2_upload_source
      
      # æ­¥éª¤3ï¼šä¸Šä¼ æºä»£ç å‹ç¼©åŒ…
      - name: "ğŸ“¤ 3. ä¸Šä¼ æºä»£ç å‹ç¼©åŒ…"
        uses: actions/upload-artifact@v4
        with:
          name: "source-code-${{ github.event.inputs.device_name }}-${{ github.run_id }}"
          path: /tmp/source-upload/
          retention-days: 7
      
      # æ­¥éª¤4ï¼šå®‰è£…Git LFS
      - name: "ğŸ”§ 4. å®‰è£…Git LFSå’Œé…ç½®"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step4_install_git_lfs
      
      # æ­¥éª¤5ï¼šæ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€
      - name: "ğŸ“Š 5. æ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step5_check_large_files
      
      # æ­¥éª¤6ï¼šæ£€æŸ¥å·¥å…·é“¾ç›®å½•çŠ¶æ€
      - name: "ğŸ—‚ï¸ 6. æ£€æŸ¥å·¥å…·é“¾ç›®å½•çŠ¶æ€"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step6_check_toolchain_dir
      
      # æ­¥éª¤7ï¼šåˆå§‹åŒ–å·¥å…·é“¾ç›®å½•
      - name: "ğŸ’¾ 7. åˆå§‹åŒ–å·¥å…·é“¾ç›®å½•"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step7_init_toolchain_dir
      
      # æ­¥éª¤8ï¼šè®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      - name: "ğŸ› ï¸ 8. è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step8_setup_environment
      
      # æ­¥éª¤9ï¼šåˆ›å»ºæ„å»ºç›®å½•
      - name: "ğŸ“ 9. åˆ›å»ºæ„å»ºç›®å½•"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step9_create_build_dir
      
      # æ­¥éª¤10ï¼šåˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      - name: "ğŸš€ 10. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        id: init_build_env
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step10_init_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}" "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤11ï¼šæ˜¾ç¤ºæ„å»ºé…ç½®
      - name: "âš¡ 11. æ˜¾ç¤ºæ„å»ºé…ç½®"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step11_show_config
      
      # æ­¥éª¤12ï¼šæ·»åŠ TurboACCæ”¯æŒ
      - name: "ğŸ”Œ 12. æ·»åŠ TurboACCæ”¯æŒ"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step12_add_turboacc_support
      
      # æ­¥éª¤13ï¼šé…ç½®Feeds
      - name: "ğŸ“¦ 13. é…ç½®Feeds"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step13_configure_feeds
      
      # æ­¥éª¤14ï¼šå®‰è£…TurboACCåŒ…
      - name: "ğŸ”§ 14. å®‰è£…TurboACCåŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step14_install_turboacc_packages
      
      # æ­¥éª¤15ï¼šç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 15. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step15_pre_build_space_check
      
      # æ­¥éª¤16ï¼šæ™ºèƒ½é…ç½®ç”Ÿæˆ
      - name: "âš™ï¸ 16. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step16_generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤17ï¼šéªŒè¯USBé…ç½®
      - name: "ğŸ” 17. éªŒè¯USBé…ç½®"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step17_verify_usb_config
      
      # æ­¥éª¤18ï¼šUSBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "ğŸ›¡ï¸ 18. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step18_check_usb_drivers_integrity
      
      # æ­¥éª¤19ï¼šåº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "âœ… 19. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step19_apply_config
      
      # æ­¥éª¤20ï¼šæ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "ğŸ’¾ 20. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step20_backup_config
      
      # æ­¥éª¤21ï¼šä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "ğŸŒ 21. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step21_fix_network
      
      # æ­¥éª¤22ï¼šåŠ è½½å·¥å…·é“¾
      - name: "ğŸ”§ 22. åŠ è½½å·¥å…·é“¾"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step22_load_toolchain
      
      # æ­¥éª¤23ï¼šæ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€
      - name: "ğŸ“Š 23. æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step23_check_toolchain_status
      
      # æ­¥éª¤24ï¼šä¸‹è½½ä¾èµ–åŒ…
      - name: "ğŸ“¥ 24. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step24_download_dependencies
      
      # æ­¥éª¤25ï¼šé›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "ğŸ”Œ 25. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step25_integrate_custom_files
      
      # æ­¥éª¤26ï¼šå‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "ğŸš¨ 26. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step26_pre_build_error_check
      
      # æ­¥éª¤27ï¼šç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 27. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step27_final_space_check
      
      # æ­¥éª¤28ï¼šç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰
      - name: "ğŸ”¨ 28. ç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step28_build_firmware
      
      # æ­¥éª¤29ï¼šä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•
      - name: "ğŸ’¾ 29. ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰"
        if: success() && github.event.inputs.enable_cache == 'true'
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step29_save_toolchain
      
      # æ­¥éª¤30ï¼šæäº¤å·¥å…·é“¾åˆ°ä»“åº“
      - name: "ğŸ“¤ 30. æäº¤å·¥å…·é“¾åˆ°ä»“åº“ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰"
        if: success() && github.event.inputs.enable_cache == 'true' && github.event.inputs.commit_toolchain == 'true'
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step30_commit_toolchain
      
      # æ­¥éª¤31ï¼šé”™è¯¯åˆ†æ
      - name: "âš ï¸ 31. é”™è¯¯åˆ†æï¼ˆå¦‚æœå¤±è´¥ï¼‰"
        if: failure()
        run: |
          echo "=== é”™è¯¯åˆ†æå¼€å§‹ ==="
          echo "æ£€æŸ¥æ„å»ºç›®å½•..."
          if [ -d "${{ env.BUILD_DIR }}" ]; then
            echo "âœ… æ„å»ºç›®å½•å­˜åœ¨: ${{ env.BUILD_DIR }}"
            if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
              firmware-config/scripts/build_firmware_main.sh workflow_main step31_error_analysis
            else
              echo "âŒ ä¸»æ„å»ºè„šæœ¬ä¸å­˜åœ¨"
              echo "åŸºæœ¬é”™è¯¯åˆ†æ:"
              df -h
              ls -la ${{ env.BUILD_DIR }}/ 2>/dev/null || echo "æ„å»ºç›®å½•ä¸ºç©º"
            fi
          else
            echo "âŒ æ„å»ºç›®å½•ä¸å­˜åœ¨: ${{ env.BUILD_DIR }}"
            echo "åˆ›å»ºæ„å»ºç›®å½•..."
            mkdir -p ${{ env.BUILD_DIR }}
            echo "åŸºæœ¬é”™è¯¯åˆ†æ:"
            df -h
            echo "å½“å‰å·¥ä½œåŒº:"
            pwd
            ls -la
          fi
          echo "=== é”™è¯¯åˆ†æç»“æŸ ==="
      
      # æ­¥éª¤32ï¼šç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "ğŸ“Š 32. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step32_post_build_space_check
      
      # æ­¥éª¤33ï¼šå›ºä»¶æ–‡ä»¶æ£€æŸ¥
      - name: "ğŸ“¦ 33. å›ºä»¶æ–‡ä»¶æ£€æŸ¥"
        if: success()
        run: |
          firmware-config/scripts/build_firmware_main.sh workflow_main step33_check_firmware_files
      
      # æ­¥éª¤34ï¼šä¸Šä¼ å›ºä»¶
      - name: "â¬†ï¸ 34. ä¸Šä¼ å›ºä»¶"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: "firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
      
      # æ­¥éª¤35ï¼šä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      - name: "â¬†ï¸ 35. ä¸Šä¼ ç¼–è¯‘æ—¥å¿—"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          path: ${{ env.BUILD_DIR }}/build.log
          retention-days: 7
      
      # æ­¥éª¤36ï¼šä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "â¬†ï¸ 36. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      # æ­¥éª¤37ï¼šæ¸…ç†ç›®å½•
      - name: "ğŸ§¹ 37. æ¸…ç†ç›®å½•"
        if: always()
        run: |
          echo "=== æ¸…ç†ç›®å½•å¼€å§‹ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            firmware-config/scripts/build_firmware_main.sh workflow_main step37_cleanup
          else
            echo "ä¸»æ„å»ºè„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰§è¡ŒåŸºæœ¬æ¸…ç†..."
            rm -rf /tmp/source-upload 2>/dev/null || true
            rm -rf /tmp/build-artifacts 2>/dev/null || true
            echo "âœ… åŸºæœ¬æ¸…ç†å®Œæˆ"
          fi
          echo "=== æ¸…ç†ç›®å½•ç»“æŸ ==="
      
      # æ­¥éª¤38ï¼šæœ€ç»ˆæ„å»ºæ€»ç»“
      - name: "ğŸ“ˆ 38. æœ€ç»ˆæ„å»ºæ€»ç»“"
        if: always()
        run: |
          echo "=== æœ€ç»ˆæ„å»ºæ€»ç»“ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            firmware-config/scripts/build_firmware_main.sh workflow_main step38_final_summary "${{ job.status }}"
          else
            echo "ä¸»æ„å»ºè„šæœ¬ä¸å­˜åœ¨"
            echo "æ„å»ºçŠ¶æ€: ${{ job.status }}"
          fi
