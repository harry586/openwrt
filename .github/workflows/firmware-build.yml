name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'è®¾å¤‡åç§° (å¦‚: ac42u, ac58u, mi4a ç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_spec:
        description: 'ç‰ˆæœ¬è§„æ ¼ (å¯é€‰ï¼Œå¦‚: openwrt-23.05 æˆ– immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_type:
        description: 'é…ç½®ç±»å‹ (minimal:åŸºç¡€åŠŸèƒ½, normal:å®Œæ•´åŠŸèƒ½, custom:è‡ªå®šä¹‰)'
        required: true
        default: 'normal'
        type: choice
        options:
        - minimal
        - normal
        - custom
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…å)'
        required: false
        type: string
      disabled_plugins:
        description: 'ç¦ç”¨æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…åï¼Œå¦‚: luci-app-accesscontrol luci-app-ddns)'
        required: false
        type: string
        default: ''
      save_config:
        description: 'ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“'
        required: false
        default: true
        type: boolean
      enable_cache:
        description: 'å¯ç”¨ç¼–è¯‘ç¼“å­˜ (æ˜¾è‘—åŠ é€Ÿåç»­ç¼–è¯‘)'
        required: false
        default: true
        type: boolean
      multithreading:
        description: 'å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘'
        type: boolean
        default: true
      ssh_connection:
        description: 'ä½¿ç”¨ SSH è¿æ¥åˆ°ç¼–è¯‘ç¯å¢ƒè¿›è¡Œè°ƒè¯•'
        type: boolean
        default: false

env:
  BUILD_DIR: /mnt/openwrt-build
  MIRROR_SOURCE: tuna
  CUSTOM_INSTALL: true

jobs:
  build-firmware:
    if: ${{ inputs.ssh_connection == false }}
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo
        pip3 install requests urllib3
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæ„å»ºç›®å½•å¹¶è®¾ç½®æƒé™
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        sudo chmod u+w $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"
        touch $BUILD_DIR/test_write.txt && echo "âœ… å†™å…¥æµ‹è¯•æˆåŠŸ" && rm $BUILD_DIR/test_write.txt

    - name: å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½•
      run: |
        echo "=== å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½• ==="
        cd $GITHUB_WORKSPACE
        SCRIPTS="complete_version_detector.sh device_detection.sh error_analysis.sh pre_download.sh check-plugins.sh diagnose-packages.sh"
        COPIED_COUNT=0
        for script in $SCRIPTS; do
          echo "æ­£åœ¨æŸ¥æ‰¾: $script"
          FOUND_SCRIPT=$(find . -name "$script" -type f | head -1)
          if [ -n "$FOUND_SCRIPT" ]; then
            cp "$FOUND_SCRIPT" $BUILD_DIR/
            echo "âœ… æ‰¾åˆ°å¹¶å¤åˆ¶: $script (ä» $FOUND_SCRIPT)"
            COPIED_COUNT=$((COPIED_COUNT + 1))
          else
            echo "âš ï¸ æœªæ‰¾åˆ°: $script"
          fi
        done
        echo "æ€»å…±å¤åˆ¶äº† $COPIED_COUNT ä¸ªè„šæœ¬æ–‡ä»¶"
        cd $BUILD_DIR
        echo "æ„å»ºç›®å½•ä¸­çš„è„šæœ¬:"
        ls -la *.sh 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°.shæ–‡ä»¶"
        chmod +x *.sh 2>/dev/null || true
        echo "âœ… è„šæœ¬å¤åˆ¶å®Œæˆ"

    - name: éªŒè¯è„šæœ¬å­˜åœ¨æ€§
      run: |
        cd $BUILD_DIR
        echo "=== éªŒè¯è„šæœ¬å­˜åœ¨æ€§ ==="
        echo "æ„å»ºç›®å½•å†…å®¹:"
        ls -la
        REQUIRED_SCRIPTS="complete_version_detector.sh device_detection.sh"
        ALL_SCRIPTS_EXIST=true
        for script in $REQUIRED_SCRIPTS; do
          if [ -f "$script" ]; then
            echo "âœ… $script å­˜åœ¨"
            chmod +x "$script"
          else
            echo "âŒ é”™è¯¯: $script ä¸å­˜åœ¨"
            ALL_SCRIPTS_EXIST=false
          fi
        done
        if [ "$ALL_SCRIPTS_EXIST" = false ]; then
          echo "å½“å‰ç›®å½•ä¸­çš„æ–‡ä»¶:"
          ls -la
          echo "âŒ å…³é”®è„šæœ¬ç¼ºå¤±ï¼Œæ„å»ºç»ˆæ­¢"
          exit 1
        fi

    - name: æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ ==="
        sudo chown -R $USER:$USER . 2>/dev/null || true
        chmod u+w . 2>/dev/null || true
        chmod +x *.sh 2>/dev/null || true
        echo "è®¾å¤‡åç§°: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬è§„æ ¼: ${{ inputs.version_spec }}"
        if [ ! -f "complete_version_detector.sh" ]; then
          echo "âŒ é”™è¯¯: complete_version_detector.sh ä¸å­˜åœ¨"
          ls -la
          exit 1
        fi
        chmod +x complete_version_detector.sh
        set +e
        OUTPUT=$(./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ inputs.version_spec }}" "" 2>&1)
        SCRIPT_EXIT_CODE=$?
        set -e
        echo "è„šæœ¬è¾“å‡º:"
        echo "$OUTPUT"
        echo "è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE"
        SELECTED_REPO=$(echo "$OUTPUT" | grep "^SELECTED_REPO=" | head -1 | cut -d'=' -f2)
        SELECTED_BRANCH=$(echo "$OUTPUT" | grep "^SELECTED_BRANCH=" | head -1 | cut -d'=' -f2)
        SELECTED_REPO_URL=$(echo "$OUTPUT" | grep "^SELECTED_REPO_URL=" | head -1 | cut -d'=' -f2)
        if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
            echo "âœ… ä»è„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–ç‰ˆæœ¬ä¿¡æ¯"
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            echo "âœ… ç¯å¢ƒå˜é‡å·²è®¾ç½®:"
            echo "  ä»“åº“: $SELECTED_REPO"
            echo "  åˆ†æ”¯: $SELECTED_BRANCH"
            echo "  URL: $SELECTED_REPO_URL"
        else
            echo "âŒ æ— æ³•ä»è„šæœ¬è¾“å‡ºä¸­æå–ç‰ˆæœ¬ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ ç‰ˆæœ¬æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼"
                echo "SELECTED_REPO=immortalwrt" >> $GITHUB_ENV
                echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
                echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
                echo "âœ… ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ä¿¡æ¯"
            fi
        fi

    - name: å¤‡ä»½æ£€æµ‹è„šæœ¬
      run: |
        echo "=== å¤‡ä»½æ£€æµ‹è„šæœ¬ ==="
        mkdir -p /tmp/build-scripts-backup
        cp $BUILD_DIR/*.sh /tmp/build-scripts-backup/ 2>/dev/null || true
        echo "âœ… è„šæœ¬å¤‡ä»½å®Œæˆ"

    - name: æ¸…ç†æ„å»ºç›®å½•
      run: |
        cd $BUILD_DIR
        echo "=== æ¸…ç†æ„å»ºç›®å½•å‡†å¤‡å…‹éš† ==="
        ls -la
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        sudo rm -rf .[!.]* 2>/dev/null || true
        ls -la
        echo "âœ… ç›®å½•æ¸…ç†å®Œæˆ"

    - name: å…‹éš†æºç 
      run: |
        cd $BUILD_DIR
        echo "=== å…‹éš†é€‰å®šç‰ˆæœ¬çš„æºç  ==="
        echo "ä»“åº“: $SELECTED_REPO_URL"
        echo "åˆ†æ”¯: $SELECTED_BRANCH"
        if [ -z "$SELECTED_REPO_URL" ] || [ -z "$SELECTED_BRANCH" ]; then
          echo "âŒ é”™è¯¯: ç¯å¢ƒå˜é‡æœªæ­£ç¡®è®¾ç½®"
          exit 1
        fi
        echo "æ£€æŸ¥ç›®å½•çŠ¶æ€..."
        FILE_COUNT=$(ls -A | wc -l)
        if [ $FILE_COUNT -ne 0 ]; then
          echo "âŒ é”™è¯¯: ç›®å½•éç©ºï¼Œæ— æ³•å…‹éš†"
          exit 1
        fi
        MAX_RETRIES=3
        RETRY_COUNT=0
        CLONE_SUCCESS=false
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$CLONE_SUCCESS" = false ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "å…‹éš†å°è¯•: $RETRY_COUNT/$MAX_RETRIES"
          if git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .; then
            echo "âœ… æºç å…‹éš†å®Œæˆ"
            CLONE_SUCCESS=true
          else
            echo "âŒ å…‹éš†å¤±è´¥ï¼Œå°è¯• $RETRY_COUNT/$MAX_RETRIES"
            if echo "$SELECTED_REPO_URL" | grep -q "github.com" && [ $RETRY_COUNT -eq 2 ]; then
              echo "ğŸ”„ å°è¯•ä½¿ç”¨é•œåƒæº..."
              MIRROR_URL=$(echo "$SELECTED_REPO_URL" | sed 's/github.com/github.com.cnpmjs.org/')
              rm -rf ./* ./.git* 2>/dev/null || true
              if git clone --depth 1 --branch "$SELECTED_BRANCH" "$MIRROR_URL" .; then
                echo "âœ… ä½¿ç”¨é•œåƒæºå…‹éš†æˆåŠŸ"
                CLONE_SUCCESS=true
                break
              fi
            fi
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ æºç å…‹éš†å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            fi
            sleep 10
            rm -rf ./* ./.git* 2>/dev/null || true
          fi
        done

    - name: æ¢å¤æ£€æµ‹è„šæœ¬
      run: |
        cd $BUILD_DIR
        echo "=== æ¢å¤æ£€æµ‹è„šæœ¬ ==="
        cp /tmp/build-scripts-backup/*.sh ./ 2>/dev/null || true
        chmod +x *.sh
        echo "âœ… è„šæœ¬æ¢å¤å®Œæˆ"

    - name: åŠ å¼ºæœç´¢å¹¶å¤åˆ¶é…ç½®æ–‡ä»¶
      run: |
        cd $BUILD_DIR
        echo "=== åŠ å¼ºæœç´¢å¹¶å¤åˆ¶é…ç½®æ–‡ä»¶ ==="
        cd $GITHUB_WORKSPACE
        echo "=== åŠ å¼ºæœç´¢é…ç½®æ–‡ä»¶ ==="
        mkdir -p $BUILD_DIR/config-templates
        SEARCH_PATHS=". firmware-config configs firmware-config/configs firmware-config/config-templates"
        CONFIG_FILES="minimal.config normal-new.config normal-old.config"
        for config_file in $CONFIG_FILES; do
          echo "æ­£åœ¨åŠ å¼ºæœç´¢é…ç½®æ–‡ä»¶: $config_file"
          FOUND_CONFIG=""
          for path in $SEARCH_PATHS; do
            if [ -f "$path/$config_file" ]; then
              FOUND_CONFIG="$path/$config_file"
              echo "âœ… åœ¨ $path æ‰¾åˆ°: $config_file"
              break
            fi
          done
          if [ -z "$FOUND_CONFIG" ]; then
            FOUND_CONFIG=$(find . -name "$config_file" -type f | head -1)
            if [ -n "$FOUND_CONFIG" ]; then
              echo "âœ… ä½¿ç”¨findæ‰¾åˆ°: $config_file (åœ¨ $FOUND_CONFIG)"
            fi
          fi
          if [ -n "$FOUND_CONFIG" ]; then
            cp "$FOUND_CONFIG" $BUILD_DIR/config-templates/
            echo "âœ… å¤åˆ¶: $config_file (ä» $FOUND_CONFIG)"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $config_file"
            echo "å½“å‰ç›®å½•ç»“æ„:"
            find . -type f -name "*.config" | head -20
            exit 1
          fi
        done
        echo "=== é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆï¼Œæ£€æŸ¥ç»“æœ ==="
        echo "config-templates ç›®å½•å†…å®¹:"
        ls -la $BUILD_DIR/config-templates/
        echo "=== å¤åˆ¶è„šæœ¬æ–‡ä»¶ ==="
        SCRIPTS="error_analysis.sh pre_download.sh check-plugins.sh diagnose-packages.sh"
        for script in $SCRIPTS; do
          FOUND_SCRIPT=$(find . -name "$script" -type f | head -1)
          if [ -n "$FOUND_SCRIPT" ]; then
            cp "$FOUND_SCRIPT" $BUILD_DIR/
            chmod +x $BUILD_DIR/"$script"
            echo "âœ… å¤åˆ¶è„šæœ¬: $script"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°: $script"
          fi
        done
        echo "âœ… é…ç½®æ–‡ä»¶å’Œè„šæœ¬å¤åˆ¶å®Œæˆ"

    - name: é…ç½®ç¨³å®šfeedsæº
      run: |
        cd $BUILD_DIR
        echo "=== é…ç½®ç¨³å®šfeedsæº ==="
        echo "æ£€æµ‹åˆ°çš„ç‰ˆæœ¬åˆ†æ”¯: $SELECTED_BRANCH"
        FEEDS_BRANCH="$SELECTED_BRANCH"
        if echo "$SELECTED_BRANCH" | grep -q "openwrt-24.10"; then
            FEEDS_BRANCH="openwrt-24.10"
        elif echo "$SELECTED_BRANCH" | grep -q "openwrt-23.05"; then
            FEEDS_BRANCH="openwrt-23.05"
        elif echo "$SELECTED_BRANCH" | grep -q "openwrt-22.03"; then
            FEEDS_BRANCH="openwrt-22.03"
        elif echo "$SELECTED_BRANCH" | grep -q "openwrt-21.02"; then
            FEEDS_BRANCH="openwrt-21.02"
        else
            echo "âš ï¸ æœªçŸ¥ç‰ˆæœ¬åˆ†æ”¯ï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯: master"
            FEEDS_BRANCH="master"
        fi
        echo "ä½¿ç”¨çš„feedsåˆ†æ”¯: $FEEDS_BRANCH"
        echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
        echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git routing https://github.com/openwrt/routing.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git telephony https://github.com/openwrt/telephony.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git nikki https://github.com/nikkinikki-org/OpenWrt-nikki.git;main" >> feeds.conf.default
        echo "âœ… ç¨³å®šfeedsé…ç½®å®Œæˆ"
        echo "Feedsé…ç½®å†…å®¹:"
        cat feeds.conf.default

    - name: æ›´æ–°å®‰è£…feeds
      run: |
        cd $BUILD_DIR
        echo "=== æ›´æ–°å’Œå®‰è£…feeds ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… Feedsæ›´æ–°å®‰è£…å®Œæˆ"

    - name: è®¾å¤‡æ£€æµ‹
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½è®¾å¤‡æ£€æµ‹ä¸åˆ«åè½¬æ¢ ==="
        INPUT_DEVICE="${{ github.event.inputs.device_name }}"
        echo "è¾“å…¥è®¾å¤‡åç§°: $INPUT_DEVICE"
        case "$INPUT_DEVICE" in
            "ac42u"|"acrh17"|"rt-acrh17") ACTUAL_DEVICE="asus_rt-ac42u" ;;
            "ac58u"|"acrh13"|"rt-ac58u"|"rt-acrh13") ACTUAL_DEVICE="asus_rt-ac58u" ;;
            "mi4a"|"r4a") ACTUAL_DEVICE="xiaomi_mi-router-4a-gigabit" ;;
            "mi3g"|"r3g") ACTUAL_DEVICE="xiaomi_mi-router-3g" ;;
            *) ACTUAL_DEVICE="$INPUT_DEVICE" ;;
        esac
        if [ "$ACTUAL_DEVICE" != "$INPUT_DEVICE" ]; then
          echo "âœ… æ£€æµ‹åˆ°è®¾å¤‡é€šç”¨åç§° '$INPUT_DEVICE'ï¼Œè½¬æ¢ä¸ºå®é™…è®¾å¤‡æ ‡è¯† '$ACTUAL_DEVICE'"
        else
          echo "â„¹ï¸ ä½¿ç”¨åŸå§‹è®¾å¤‡åç§°: $ACTUAL_DEVICE"
        fi
        if [ ! -f "device_detection.sh" ]; then
          echo "âŒ é”™è¯¯: è®¾å¤‡æ£€æµ‹è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        chmod +x device_detection.sh
        echo "=== å¼€å§‹è®¾å¤‡æ£€æµ‹ ==="
        TEMP_LOG=$(mktemp)
        set +e
        ./device_detection.sh "$ACTUAL_DEVICE" 2>&1 | tee "$TEMP_LOG"
        SCRIPT_EXIT_CODE=$?
        set -e
        echo "=== è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE ==="
        PLATFORM=$(grep "^PLATFORM=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        DEVICE_SHORT_NAME=$(grep "^DEVICE_SHORT_NAME=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        DEVICE_FULL_NAME=$(grep "^DEVICE_FULL_NAME=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        echo "=== æå–çš„è®¾å¤‡ä¿¡æ¯ ==="
        echo "å¹³å°(PLATFORM): '$PLATFORM'"
        echo "è®¾å¤‡çŸ­åç§°(DEVICE_SHORT_NAME): '$DEVICE_SHORT_NAME'"
        echo "è®¾å¤‡å…¨åç§°(DEVICE_FULL_NAME): '$DEVICE_FULL_NAME'"
        rm -f "$TEMP_LOG"
        if [ -n "$PLATFORM" ] && [ -n "$DEVICE_SHORT_NAME" ] && [ -n "$DEVICE_FULL_NAME" ]; then
            echo "âœ… ä»è„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–è®¾å¤‡ä¿¡æ¯"
            echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
            echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
        else
            echo "âŒ æ— æ³•ä»è„šæœ¬è¾“å‡ºä¸­æå–è®¾å¤‡ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ è®¾å¤‡æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–è®¾å¤‡ä¿¡æ¯ï¼Œä½¿ç”¨å¤‡ç”¨è®¾å¤‡æ˜ å°„"
                case "$ACTUAL_DEVICE" in
                    "asus_rt-ac42u"|"ac42u"|"acrh17"|"rt-acrh17")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac42u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "asus_rt-ac58u"|"ac58u"|"acrh13"|"rt-acrh13")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac58u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "xiaomi_mi-router-4a-gigabit"|"mi4a"|"r4a")
                        echo "PLATFORM=ramips" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=xiaomi_mi-router-4a-gigabit" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    *)
                        echo "âŒ æœªçŸ¥è®¾å¤‡ï¼Œæ— æ³•è®¾ç½®é»˜è®¤å€¼"
                        exit 1
                        ;;
                esac
                echo "âœ… å·²ä½¿ç”¨å¤‡ç”¨è®¾å¤‡ä¿¡æ¯"
            fi
        fi

    - name: ä¿®å¤é…ç½®åŠ è½½é—®é¢˜ - æ·±åº¦ turboacc æ”¯æŒåˆ†æ
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤é…ç½®åŠ è½½é—®é¢˜ - æ·±åº¦ turboacc æ”¯æŒåˆ†æ ==="
        export MAKE_JOBS=1
        echo "ğŸ”’ é…ç½®é˜¶æ®µä½¿ç”¨å•çº¿ç¨‹æ¨¡å¼"
        CONFIG_TYPE="${{ inputs.config_type }}"
        echo "é…ç½®ç±»å‹: $CONFIG_TYPE"
        if [ "$CONFIG_TYPE" = "minimal" ]; then
            CONFIG_FILE="config-templates/minimal.config"
        elif [ "$CONFIG_TYPE" = "normal" ] || [ "$CONFIG_TYPE" = "custom" ]; then
            IS_OLD_VERSION=0
            case "${{ github.event.inputs.device_name }}" in
                "wr841n"|"wr842n"|"wr941n"|"mr3420"|"ar71xx"*)
                    IS_OLD_VERSION=1
                    echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§è®¾å¤‡: ${{ github.event.inputs.device_name }}"
                    ;;
            esac
            if echo "$SELECTED_BRANCH" | grep -q -E "19\.07|21\.02|17\.01|lede"; then
                IS_OLD_VERSION=1
                echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§ç‰ˆæœ¬: $SELECTED_BRANCH"
            fi
            if [ "$SELECTED_REPO" = "lede" ] || [ "$SELECTED_REPO" = "openwrt-19.07" ] || [ "$SELECTED_REPO" = "openwrt-21.02" ]; then
                IS_OLD_VERSION=1
                echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§ä»“åº“: $SELECTED_REPO"
            fi
            if [ "$IS_OLD_VERSION" -eq 1 ]; then
                CONFIG_FILE="config-templates/normal-old.config"
            else
                CONFIG_FILE="config-templates/normal-new.config"
            fi
        else
            echo "âŒ æœªçŸ¥çš„é…ç½®ç±»å‹: $CONFIG_TYPE"
            exit 1
        fi
        echo "=== é€‰æ‹©çš„é…ç½®æ–‡ä»¶: $CONFIG_FILE ==="
        if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILE"
            ls -la config-templates/
            exit 1
        fi
        echo "=== åˆ›å»ºåŸºç¡€é…ç½® ==="
        echo "# è®¾å¤‡åŸºç¡€é…ç½®" > .config
        echo "CONFIG_TARGET_${PLATFORM}=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
        echo "=== æ™ºèƒ½è¿½åŠ æ¨¡æ¿é…ç½® ==="
        grep -v -E "^CONFIG_TARGET_(ROOTFS_SQUASHFS|IMAGES_GZIP|IMAGES_PAD)=" "$CONFIG_FILE" > /tmp/filtered_config
        cat /tmp/filtered_config >> .config
        rm -f /tmp/filtered_config
        EXTRA_PACKAGES="${{ inputs.extra_packages }}"
        DISABLED_PLUGINS="${{ inputs.disabled_plugins }}"
        if [ -n "$EXTRA_PACKAGES" ]; then
            echo "=== æ·»åŠ é¢å¤–æ’ä»¶ ==="
            for pkg in $EXTRA_PACKAGES; do
                echo "æ·»åŠ æ’ä»¶: $pkg"
                sed -i "/# CONFIG_PACKAGE_${pkg} is not set/d" .config
                echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            done
        fi
        if [ -n "$DISABLED_PLUGINS" ]; then
            echo "=== ç¦ç”¨æŒ‡å®šæ’ä»¶ ==="
            for pkg in $DISABLED_PLUGINS; do
                echo "ç¦ç”¨æ’ä»¶: $pkg"
                sed -i "/CONFIG_PACKAGE_${pkg}=y/d" .config
                echo "# CONFIG_PACKAGE_${pkg} is not set" >> .config
            done
        fi
        echo "=== æ¸…ç†ä¸éœ€è¦çš„æ’ä»¶ ==="
        UNWANTED_PLUGINS="luci-app-rclone_INCLUDE_rclone-ng luci-app-rclone_INCLUDE_rclone-webui luci-app-timewol luci-app-passwall_INCLUDE_Haproxy luci-app-passwall_INCLUDE_Shadowsocks_Rust_Client luci-app-passwall_INCLUDE_Shadowsocks_Rust_Server luci-app-passwall_INCLUDE_Simple_Obfs luci-app-passwall_INCLUDE_SingBox luci-app-passwall_INCLUDE_V2ray_Geoview luci-app-passwall_INCLUDE_V2ray_Plugin luci-app-passwall_INCLUDE_Xray"
        for plugin in $UNWANTED_PLUGINS; do
            if grep -q "CONFIG_PACKAGE_${plugin}=y" .config; then
                echo "ğŸš« åˆ é™¤æ’ä»¶: $plugin"
                sed -i "/CONFIG_PACKAGE_${plugin}=y/d" .config
                echo "# CONFIG_PACKAGE_${plugin} is not set" >> .config
            fi
        done
        echo "=== æ·±åº¦åˆ†æ turboacc æ”¯æŒæ€§ ==="
        echo "=== å¹³å°å…¼å®¹æ€§åˆ†æ ==="
        echo "å¹³å°: $PLATFORM"
        echo "è®¾å¤‡: $DEVICE_SHORT_NAME"
        echo "ç‰ˆæœ¬åˆ†æ”¯: $SELECTED_BRANCH"
        SUPPORT_SHORTCUT_FE=1
        TURBOACC_SUPPORT_REASON=""
        case "$PLATFORM" in
            "ipq40xx"|"ipq806x"|"mediatek"|"ramips"|"ath79"|"rockchip")
                TURBOACC_SUPPORT_REASON="å¹³å° $PLATFORM é€šå¸¸æ”¯æŒ shortcut-fe"
                echo "âœ… $TURBOACC_SUPPORT_REASON"
                ;;
            "ar71xx"|"brcm47xx"|"brcm63xx"|"lantiq"|"oxnas"|"gemini")
                SUPPORT_SHORTCUT_FE=0
                TURBOACC_SUPPORT_REASON="å¹³å° $PLATFORM é€šå¸¸ä¸æ”¯æŒæˆ–æœ‰é™æ”¯æŒ shortcut-fe"
                echo "âŒ $TURBOACC_SUPPORT_REASON"
                ;;
            *)
                echo "âš ï¸ æœªçŸ¥å¹³å° $PLATFORMï¼Œå‡è®¾æ”¯æŒ shortcut-fe"
                TURBOACC_SUPPORT_REASON="æœªçŸ¥å¹³å° $PLATFORMï¼Œå°è¯•æ”¯æŒ shortcut-fe"
                ;;
        esac
        if echo "$SELECTED_BRANCH" | grep -q -E "19\.07|21\.02"; then
            echo "âš ï¸ ç‰ˆæœ¬ $SELECTED_BRANCH å¯èƒ½å¯¹ shortcut-fe æ”¯æŒæœ‰é™"
            TURBOACC_SUPPORT_REASON="$TURBOACC_SUPPORT_REASON (ç‰ˆæœ¬é™åˆ¶)"
        fi
        echo "=== turboacc æ”¯æŒæ€§ç»“è®º ==="
        if [ "$SUPPORT_SHORTCUT_FE" -eq 1 ]; then
            echo "âœ… ç»“è®º: å¹³å°æ”¯æŒ turboaccï¼Œå°†å¯ç”¨å®Œæ•´é…ç½®"
            echo "æ”¯æŒåŸå› : $TURBOACC_SUPPORT_REASON"
        else
            echo "âŒ ç»“è®º: å¹³å°ä¸æ”¯æŒ turboaccï¼Œå°†ä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ"
            echo "ä¸æ”¯æŒåŸå› : $TURBOACC_SUPPORT_REASON"
        fi
        echo "=== è®°å½•åˆå§‹ turboacc çŠ¶æ€ ==="
        echo "ğŸ” åˆå§‹ turboacc ç›¸å…³é…ç½®:"
        grep -E "CONFIG_PACKAGE_(luci-app-turboacc|luci-i18n-turboacc|kmod-shortcut|kmod-fast-classifier)" .config || echo "æœªæ‰¾åˆ°ç›¸å…³é…ç½®"
        if [ "$SUPPORT_SHORTCUT_FE" -eq 1 ]; then
            echo "=== è®¾ç½®å®Œæ•´ turboacc ä¾èµ–é“¾ ==="
            echo "=== å¯ç”¨åŸºç¡€åŒ…ä¾èµ–ï¼ˆè‡ªåŠ¨è®¾ç½®å†…æ ¸é…ç½®ï¼‰==="
            BASE_PACKAGE_DEPS="CONFIG_PACKAGE_kmod-nf-conntrack=y CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y CONFIG_PACKAGE_kmod-nf-nat=y CONFIG_PACKAGE_kmod-nf-reject=y CONFIG_PACKAGE_kmod-nfnetlink=y CONFIG_PACKAGE_kmod-ipt-core=y CONFIG_PACKAGE_kmod-ipt-conntrack=y CONFIG_PACKAGE_kmod-ipt-nat=y CONFIG_PACKAGE_kmod-ipt-raw=y CONFIG_PACKAGE_kmod-ipt-conntrack-extra=y CONFIG_PACKAGE_kmod-ipt-offload=y CONFIG_PACKAGE_kmod-sched-core=y CONFIG_PACKAGE_kmod-sched=y CONFIG_PACKAGE_kmod-ipt-ipset=y"
            for pkg in $BASE_PACKAGE_DEPS; do
                echo "$pkg" >> .config
            done
            echo "=== å¯ç”¨ shortcut-fe æ¨¡å— ==="
            SHORTCUT_FE_MODULES="CONFIG_PACKAGE_kmod-shortcut-fe=y CONFIG_PACKAGE_kmod-shortcut-fe-cm=y CONFIG_PACKAGE_kmod-fast-classifier=y"
            for module in $SHORTCUT_FE_MODULES; do
                echo "$module" >> .config
            done
            echo "=== å¯ç”¨ turboacc ==="
            echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y" >> .config
        else
            echo "=== è®¾ç½®æ›¿ä»£ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ ==="
            echo "ğŸ”§ ç”±äºå¹³å°ä¸æ”¯æŒ turboaccï¼Œå¯ç”¨æ›¿ä»£åŠ é€Ÿæ–¹æ¡ˆ"
            ALTERNATIVE_ACCELERATION="CONFIG_PACKAGE_kmod-tcp-bbr=y CONFIG_PACKAGE_kmod-nft-offload=y CONFIG_PACKAGE_kmod-nft-fastnet=y CONFIG_PACKAGE_kmod-nft-core=y CONFIG_PACKAGE_kmod-nft-nat=y CONFIG_PACKAGE_kmod-ipt-filter=y CONFIG_PACKAGE_iptables-mod-conntrack-extra=y CONFIG_PACKAGE_iptables-mod-ipopt=y"
            for config in $ALTERNATIVE_ACCELERATION; do
                echo "$config" >> .config
            done
            echo "âœ… æ›¿ä»£ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆå·²å¯ç”¨"
        fi
        echo "=== è®°å½•æ·»åŠ ä¾èµ–åçš„ turboacc çŠ¶æ€ ==="
        echo "ğŸ” æ·»åŠ ä¾èµ–å turboacc ç›¸å…³é…ç½®:"
        grep -E "CONFIG_PACKAGE_(luci-app-turboacc|luci-i18n-turboacc|kmod-shortcut|kmod-fast-classifier|kmod-tcp-bbr)" .config || echo "æœªæ‰¾åˆ°ç›¸å…³é…ç½®"
        echo "=== è¿è¡Œå•çº¿ç¨‹ defconfig ==="
        echo "âš ï¸ æ³¨æ„: defconfig å¯èƒ½ä¼šæ ¹æ®ä¾èµ–å…³ç³»è‡ªåŠ¨ç¦ç”¨æŸäº›é…ç½®"
        make -j1 defconfig
        echo "=== æ£€æŸ¥ defconfig åçš„ä¾èµ–çŠ¶æ€ ==="
        echo "ğŸ” defconfig å turboacc ç›¸å…³é…ç½®:"
        grep -E "CONFIG_PACKAGE_(luci-app-turboacc|luci-i18n-turboacc|kmod-shortcut|kmod-fast-classifier|kmod-tcp-bbr)" .config || echo "æœªæ‰¾åˆ°ç›¸å…³é…ç½®"
        echo "=== åˆ†æ defconfig ç¦ç”¨åŸå›  ==="
        if [ "$SUPPORT_SHORTCUT_FE" -eq 1 ]; then
            echo "=== æ£€æŸ¥å†…æ ¸é…ç½®çŠ¶æ€ ==="
            KERNEL_CONFIGS="NF_CONNTRACK NF_NAT NETFILTER_XTABLES IP_NF_IPTABLES NET_SCHED"
            for config in $KERNEL_CONFIGS; do
                if grep -q "CONFIG_${config}=y" .config; then
                    echo "âœ… å†…æ ¸é…ç½® $config: å·²å¯ç”¨"
                else
                    echo "âŒ å†…æ ¸é…ç½® $config: æœªå¯ç”¨ - è¿™å¯èƒ½å¯¼è‡´ shortcut-fe è¢«ç¦ç”¨"
                fi
            done
            echo "=== æ£€æŸ¥åŒ…ä¾èµ–çŠ¶æ€ ==="
            PACKAGE_DEPS="kmod-nf-conntrack kmod-ipt-core kmod-ipt-raw kmod-sched-core kmod-shortcut-fe kmod-fast-classifier"
            for pkg in $PACKAGE_DEPS; do
                if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
                    echo "âœ… åŒ…ä¾èµ– $pkg: å·²å¯ç”¨"
                else
                    echo "âŒ åŒ…ä¾èµ– $pkg: æœªå¯ç”¨ - è¿™å¯èƒ½å¯¼è‡´ shortcut-fe è¢«ç¦ç”¨"
                fi
            done
            echo "=== å¼ºåŠ›ä¿®å¤ï¼šé‡æ–°å¯ç”¨æ‰€æœ‰ turboacc ç›¸å…³é…ç½® ==="
            TURBOACC_COMPLETE_DEPS="CONFIG_NF_CONNTRACK=y CONFIG_NF_CONNTRACK_EVENTS=y CONFIG_NF_CONNTRACK_PROCFS=y CONFIG_NF_CT_NETLINK=y CONFIG_NF_NAT=y CONFIG_NF_NAT_NEEDED=y CONFIG_NETFILTER_XTABLES=y CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y CONFIG_IP_NF_IPTABLES=y CONFIG_IP_NF_FILTER=y CONFIG_IP_NF_NAT=y CONFIG_IP_NF_TARGET_MASQUERADE=y CONFIG_NET_SCHED=y CONFIG_PACKAGE_kmod-nf-conntrack=y CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y CONFIG_PACKAGE_kmod-nf-nat=y CONFIG_PACKAGE_kmod-nf-reject=y CONFIG_PACKAGE_kmod-nfnetlink=y CONFIG_PACKAGE_kmod-ipt-core=y CONFIG_PACKAGE_kmod-ipt-conntrack=y CONFIG_PACKAGE_kmod-ipt-nat=y CONFIG_PACKAGE_kmod-ipt-raw=y CONFIG_PACKAGE_kmod-ipt-conntrack-extra=y CONFIG_PACKAGE_kmod-ipt-offload=y CONFIG_PACKAGE_kmod-sched-core=y CONFIG_PACKAGE_kmod-sched=y CONFIG_PACKAGE_kmod-ipt-ipset=y CONFIG_PACKAGE_kmod-shortcut-fe=y CONFIG_PACKAGE_kmod-shortcut-fe-cm=y CONFIG_PACKAGE_kmod-fast-classifier=y CONFIG_PACKAGE_luci-app-turboacc=y CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y"
            echo "=== æ¸…ç†æ‰€æœ‰ç¦ç”¨é…ç½® ==="
            for dep in $TURBOACC_COMPLETE_DEPS; do
                if echo "$dep" | grep -q "^CONFIG_PACKAGE_"; then
                    pkg_name=$(echo "$dep" | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//')
                    sed -i "/# CONFIG_PACKAGE_${pkg_name} is not set/d" .config
                    sed -i "/CONFIG_PACKAGE_${pkg_name}=y/d" .config
                elif echo "$dep" | grep -q "^CONFIG_"; then
                    config_name=$(echo "$dep" | sed 's/CONFIG_//' | sed 's/=y//')
                    sed -i "/# CONFIG_${config_name} is not set/d" .config
                    sed -i "/CONFIG_${config_name}=y/d" .config
                fi
            done
            echo "=== é‡æ–°å†™å…¥æ‰€æœ‰ turboacc é…ç½® ==="
            for dep in $TURBOACC_COMPLETE_DEPS; do
                echo "$dep" >> .config
            done
            echo "âœ… å¼ºåŠ›ä¿®å¤å®Œæˆï¼šæ‰€æœ‰ turboacc ç›¸å…³é…ç½®å·²é‡æ–°å¯ç”¨"
        else
            echo "âš ï¸ ç”±äºå¹³å°ä¸æ”¯æŒï¼Œè·³è¿‡ turboacc ç›¸å…³ä¿®å¤"
            echo "âœ… æ›¿ä»£åŠ é€Ÿæ–¹æ¡ˆçŠ¶æ€:"
            grep -E "CONFIG_PACKAGE_(kmod-tcp-bbr|kmod-nft-offload)" .config || echo "æœªæ‰¾åˆ°æ›¿ä»£åŠ é€Ÿæ–¹æ¡ˆé…ç½®"
        fi
        echo "=== æœ€ç»ˆ turboacc çŠ¶æ€æŠ¥å‘Š ==="
        echo "ğŸ” æœ€ç»ˆ turboacc ç›¸å…³é…ç½®:"
        grep -E "CONFIG_PACKAGE_(luci-app-turboacc|luci-i18n-turboacc|kmod-shortcut|kmod-fast-classifier|kmod-tcp-bbr)" .config || echo "æœªæ‰¾åˆ°ç›¸å…³é…ç½®"
        echo "=== æœ€ç»ˆå¼ºåŠ›é”å®š turboacc é…ç½® ==="
        echo "# =============================================" > /tmp/turboacc_lock.config
        echo "# TurboACC é…ç½®é”å®š" >> /tmp/turboacc_lock.config
        echo "# æ­¤éƒ¨åˆ†é…ç½®ç”±æ„å»ºç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤ï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹" >> /tmp/turboacc_lock.config
        echo "# =============================================" >> /tmp/turboacc_lock.config
        echo "" >> /tmp/turboacc_lock.config
        echo "# å†…æ ¸ç½‘ç»œæ ¸å¿ƒé…ç½®" >> /tmp/turboacc_lock.config
        echo "CONFIG_NF_CONNTRACK=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_NF_CONNTRACK_EVENTS=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_NF_CONNTRACK_PROCFS=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_NF_CT_NETLINK=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_NF_NAT=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_NF_NAT_NEEDED=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_NETFILTER_XTABLES=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_IP_NF_IPTABLES=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_IP_NF_FILTER=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_IP_NF_NAT=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_IP_NF_TARGET_MASQUERADE=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_NET_SCHED=y" >> /tmp/turboacc_lock.config
        echo "" >> /tmp/turboacc_lock.config
        echo "# åŸºç¡€åŒ…ä¾èµ–" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-nf-conntrack=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-nf-nat=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-nf-reject=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-nfnetlink=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-ipt-core=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-ipt-conntrack=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-ipt-nat=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-ipt-raw=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-ipt-conntrack-extra=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-ipt-offload=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-sched-core=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-sched=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-ipt-ipset=y" >> /tmp/turboacc_lock.config
        echo "" >> /tmp/turboacc_lock.config
        echo "# shortcut-fe æ ¸å¿ƒæ¨¡å—" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-shortcut-fe-cm=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> /tmp/turboacc_lock.config
        echo "" >> /tmp/turboacc_lock.config
        echo "# turboacc åº”ç”¨" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> /tmp/turboacc_lock.config
        echo "CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y" >> /tmp/turboacc_lock.config
        echo "" >> /tmp/turboacc_lock.config
        echo "# =============================================" >> /tmp/turboacc_lock.config
        echo "# TurboACC é…ç½®é”å®šç»“æŸ" >> /tmp/turboacc_lock.config
        echo "# =============================================" >> /tmp/turboacc_lock.config
        echo "åº”ç”¨é…ç½®é”å®š..."
        while IFS= read -r line; do
            if [ -n "$line" ] && [[ ! "$line" =~ ^# ]]; then
                config_name=$(echo "$line" | cut -d'=' -f1)
                sed -i "/${config_name}=/d" .config
                sed -i "/# ${config_name} is not set/d" .config
                echo "$line" >> .config
            fi
        done < /tmp/turboacc_lock.config
        rm -f /tmp/turboacc_lock.config
        echo "âœ… TurboACC é…ç½®å·²å¼ºåŠ›é”å®šï¼Œé˜²æ­¢è¢«åç»­æ­¥éª¤æ¸…é™¤"
        echo "=== æœ€ç»ˆé…ç½®éªŒè¯ï¼ˆè¯¦ç»†ç‰ˆï¼‰==="
        echo "âœ… é…ç½®åŠ è½½å®Œæˆï¼ˆå•çº¿ç¨‹æ¨¡å¼ + turboacc æ·±åº¦åˆ†æä¿®å¤ + å¼ºåŠ›ä¾èµ–è¡¥å…¨ + é…ç½®é”å®šï¼‰"

    - name: é…ç½®å®Œæ•´æ€§æ£€æŸ¥
      run: |
        cd $BUILD_DIR
        echo "=== é…ç½®å®Œæ•´æ€§æ£€æŸ¥ï¼ˆå•çº¿ç¨‹æ¨¡å¼ï¼‰==="
        export MAKE_JOBS=1
        if [ ! -f ".config" ] || [ ! -s ".config" ]; then
            echo "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            exit 1
        fi
        echo "âœ… .config æ–‡ä»¶å­˜åœ¨ä¸”éç©º"
        echo "æ–‡ä»¶å¤§å°: $(wc -l < .config) è¡Œ"
        echo "=== å…³é”®é…ç½®éªŒè¯ ==="
        if ! grep -q "^CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" .config; then
            echo "âŒ é”™è¯¯: è®¾å¤‡é…ç½®ç¼ºå¤±"
            exit 1
        fi
        for pkg in luci luci-base luci-theme-bootstrap; do
            if ! grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
                echo "âŒ é”™è¯¯: æ ¸å¿ƒç»„ä»¶ $pkg æœªå¯ç”¨"
                exit 1
            fi
        done
        echo "=== ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆå®Œæ•´æ€§æ£€æŸ¥ ==="
        if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            echo "âœ… turboacc æ–¹æ¡ˆ: å·²å¯ç”¨"
            TURBOACC_DEPS_CHECK="kmod-shortcut-fe kmod-fast-classifier kmod-nf-conntrack kmod-ipt-raw"
            MISSING_DEPS=0
            for dep in $TURBOACC_DEPS_CHECK; do
                if ! grep -q "CONFIG_PACKAGE_${dep}=y" .config; then
                    echo "âŒ é”™è¯¯: turboacc ä¾èµ– $dep æœªå¯ç”¨"
                    MISSING_DEPS=$((MISSING_DEPS + 1))
                else
                    echo "âœ… turboacc ä¾èµ– $dep: å·²å¯ç”¨"
                fi
            done
            if [ $MISSING_DEPS -gt 0 ]; then
                echo "âŒ turboacc ç¼ºå°‘ $MISSING_DEPS ä¸ªå…³é”®ä¾èµ–"
                exit 1
            fi
        elif grep -q "CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
            echo "âœ… æ›¿ä»£åŠ é€Ÿæ–¹æ¡ˆ (BBR): å·²å¯ç”¨"
        else
            echo "âš ï¸ æœªå¯ç”¨ä»»ä½•ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ"
        fi
        echo "âœ… é…ç½®å®Œæ•´æ€§æ£€æŸ¥å®Œæˆï¼ˆå•çº¿ç¨‹æ¨¡å¼ï¼‰"

    - name: æœ€ç»ˆæ¸…ç†ä¸éœ€è¦çš„æ’ä»¶ï¼ˆå¸¦éªŒè¯ï¼‰
      run: |
        cd $BUILD_DIR
        echo "=== æœ€ç»ˆæ¸…ç†ä¸éœ€è¦çš„æ’ä»¶ï¼ˆå¸¦éªŒè¯ï¼‰==="
        echo "=== æ¸…ç†å‰çŠ¶æ€ ==="
        UNWANTED_PLUGINS="luci-app-rclone_INCLUDE_rclone-ng luci-app-rclone_INCLUDE_rclone-webui luci-app-timewol luci-app-passwall_INCLUDE_Haproxy luci-app-passwall_INCLUDE_Shadowsocks_Rust_Client luci-app-passwall_INCLUDE_Shadowsocks_Rust_Server luci-app-passwall_INCLUDE_Simple_Obfs luci-app-passwall_INCLUDE_SingBox luci-app-passwall_INCLUDE_V2ray_Geoview luci-app-passwall_INCLUDE_V2ray_Plugin luci-app-passwall_INCLUDE_Xray"
        echo "æ¸…ç†å‰ä¸éœ€è¦çš„æ’ä»¶çŠ¶æ€:"
        for plugin in $UNWANTED_PLUGINS; do
            if grep -q "CONFIG_PACKAGE_${plugin}=y" .config; then
                echo "âŒ $plugin: å¯ç”¨ï¼ˆéœ€è¦æ¸…ç†ï¼‰"
            else
                echo "âœ… $plugin: å·²ç¦ç”¨"
            fi
        done
        CLEANED_COUNT=0
        for plugin in $UNWANTED_PLUGINS; do
            if grep -q "CONFIG_PACKAGE_${plugin}=y" .config; then
                echo "ğŸš« åˆ é™¤æ’ä»¶: $plugin"
                sed -i "/CONFIG_PACKAGE_${plugin}=y/d" .config
                echo "# CONFIG_PACKAGE_${plugin} is not set" >> .config
                CLEANED_COUNT=$((CLEANED_COUNT + 1))
            fi
        done
        echo "=== æ¸…ç†åçŠ¶æ€ ==="
        for plugin in $UNWANTED_PLUGINS; do
            if grep -q "CONFIG_PACKAGE_${plugin}=y" .config; then
                echo "âŒ $plugin: ä»ç„¶å¯ç”¨ï¼ˆæ¸…ç†å¤±è´¥ï¼‰"
            else
                echo "âœ… $plugin: å·²æ­£ç¡®ç¦ç”¨"
            fi
        done
        if [ $CLEANED_COUNT -gt 0 ]; then
            echo "âœ… æœ€ç»ˆæ¸…ç†å®Œæˆï¼šåˆ é™¤äº† $CLEANED_COUNT ä¸ªä¸éœ€è¦çš„æ’ä»¶"
        else
            echo "âœ… æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ’ä»¶"
        fi

    - name: åŒ…å¯ç”¨æ€§è¯Šæ–­
      run: |
        cd $BUILD_DIR
        echo "=== åŒ…å¯ç”¨æ€§è¯Šæ–­ ==="
        if [ -f "diagnose-packages.sh" ]; then
            chmod +x diagnose-packages.sh
            echo "å¼€å§‹è¯Šæ–­åŒ…å¯ç”¨æ€§..."
            ./diagnose-packages.sh "$BUILD_DIR"
            echo "âœ… åŒ…è¯Šæ–­å®Œæˆ"
        else
            echo "âš ï¸ æœªæ‰¾åˆ°åŒ…è¯Šæ–­è„šæœ¬ï¼Œè·³è¿‡è¯Šæ–­"
        fi

    - name: æ„å»ºæ—¶é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      run: |
        cd $BUILD_DIR
        echo "=== æ„å»ºæ—¶é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
        mkdir -p files/root/custom-install
        cd $GITHUB_WORKSPACE
        IPK_FILES=$(find firmware-config/custom-files -name "*.ipk" -type f 2>/dev/null || true)
        if [ -n "$IPK_FILES" ]; then
            echo "âœ… æ‰¾åˆ°IPKæ–‡ä»¶:"
            for ipk in $IPK_FILES; do
                cp "$ipk" $BUILD_DIR/files/root/custom-install/
                echo "âœ… å¤åˆ¶IPK: $(basename "$ipk")"
            done
        fi
        SCRIPT_FILES=$(find firmware-config/custom-files -name "*.sh" -type f 2>/dev/null | grep -v "detector\|analysis" || true)
        if [ -n "$SCRIPT_FILES" ]; then
            echo "âœ… æ‰¾åˆ°è„šæœ¬æ–‡ä»¶:"
            for script in $SCRIPT_FILES; do
                cp "$script" $BUILD_DIR/files/root/custom-install/
                chmod +x $BUILD_DIR/files/root/custom-install/$(basename "$script")
                echo "âœ… å¤åˆ¶è„šæœ¬: $(basename "$script")"
            done
        fi
        echo '#!/bin/sh' > $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'echo "=== å¼€å§‹æ„å»ºæ—¶è‡ªå®šä¹‰å®‰è£… ==="' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'if ls /root/custom-install/*.ipk >/dev/null 2>&1; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æ„å»ºæ—¶å®‰è£…IPKæ–‡ä»¶..."' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    for ipk in /root/custom-install/*.ipk; do' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        echo "å®‰è£…: $(basename $ipk)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        opkg install "$ipk" --force-depends || echo "å®‰è£…å¤±è´¥: $(basename $ipk)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    done' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'else' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æœªæ‰¾åˆ°IPKæ–‡ä»¶"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'if ls /root/custom-install/*.sh >/dev/null 2>&1; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æ‰§è¡Œæ„å»ºæ—¶è„šæœ¬..."' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    for script in /root/custom-install/*.sh; do' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        if [ "$(basename $script)" != "build-time-install.sh" ]; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '            echo "æ‰§è¡Œ: $(basename $script)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '            sh "$script" || echo "æ‰§è¡Œå¤±è´¥: $(basename $script)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    done' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'else' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æœªæ‰¾åˆ°è„šæœ¬æ–‡ä»¶"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'rm -rf /root/custom-install' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'echo "=== æ„å»ºæ—¶è‡ªå®šä¹‰å®‰è£…å®Œæˆ ==="' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        chmod +x $BUILD_DIR/files/root/custom-install/build-time-install.sh
        mkdir -p $BUILD_DIR/files/etc
        echo '#!/bin/sh' > $BUILD_DIR/files/etc/rc.local
        echo '' >> $BUILD_DIR/files/etc/rc.local
        echo '[ -f /root/custom-install/build-time-install.sh ] && {' >> $BUILD_DIR/files/etc/rc.local
        echo '    /root/custom-install/build-time-install.sh >/tmp/build-time-install.log 2>&1 &' >> $BUILD_DIR/files/etc/rc.local
        echo '}' >> $BUILD_DIR/files/etc/rc.local
        echo '' >> $BUILD_DIR/files/etc/rc.local
        echo 'exit 0' >> $BUILD_DIR/files/etc/rc.local
        chmod +x $BUILD_DIR/files/etc/rc.local
        echo "âœ… æ„å»ºæ—¶è‡ªå®šä¹‰å®‰è£…é…ç½®å®Œæˆ"

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤ç½‘ç»œå’Œä¸‹è½½ç¯å¢ƒ ==="
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        mkdir -p dl
        chmod 755 dl
        echo "âœ… ç½‘ç»œç¯å¢ƒä¿®å¤å®Œæˆ"

    - name: è¿è¡Œé¢„ä¸‹è½½
      run: |
        cd $BUILD_DIR
        echo "=== è¿è¡Œé¢„ä¸‹è½½è„šæœ¬ ==="
        if [ -f "pre_download.sh" ]; then
            chmod +x pre_download.sh
            echo "å¼€å§‹é¢„ä¸‹è½½å¸¸è§ä¾èµ–åŒ…..."
            ./pre_download.sh
            echo "âœ… é¢„ä¸‹è½½å®Œæˆ"
        else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢„ä¸‹è½½è„šæœ¬ï¼Œè·³è¿‡é¢„ä¸‹è½½æ­¥éª¤"
        fi

    - name: ä¸‹è½½å‰é…ç½®éªŒè¯ï¼ˆåŠ å¼ºç‰ˆï¼‰
      run: |
        cd $BUILD_DIR
        echo "=== ä¸‹è½½å‰é…ç½®éªŒè¯ï¼ˆåŠ å¼ºç‰ˆï¼‰==="
        export MAKE_JOBS=1
        echo "=== éªŒè¯å®é™…é…ç½®æ–‡ä»¶ ==="
        echo "å½“å‰å¯ç”¨çš„åŒ…æ•°é‡: $(grep "^CONFIG_PACKAGE_.*=y" .config | wc -l)"
        echo "=== ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆçŠ¶æ€éªŒè¯ï¼ˆå…³é”®æ£€æŸ¥ï¼‰==="
        echo "ğŸ” ä¸‹è½½å‰ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆçŠ¶æ€æ£€æŸ¥:"
        if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            echo "âœ… turboacc æ–¹æ¡ˆ: å·²å¯ç”¨"
            TURBOACC_CRITICAL_DEPS="kmod-shortcut-fe kmod-fast-classifier kmod-nf-conntrack kmod-ipt-raw"
            CRITICAL_MISSING=0
            for dep in $TURBOACC_CRITICAL_DEPS; do
                if grep -q "CONFIG_PACKAGE_${dep}=y" .config; then
                    echo "âœ… $dep: å·²å¯ç”¨"
                else
                    echo "âŒ $dep: æœªå¯ç”¨ - å…³é”®ä¾èµ–ç¼ºå¤±ï¼"
                    CRITICAL_MISSING=$((CRITICAL_MISSING + 1))
                fi
            done
            if [ $CRITICAL_MISSING -gt 0 ]; then
                echo "ğŸš¨ å‘ç° $CRITICAL_MISSING ä¸ªå…³é”®ä¾èµ–ç¼ºå¤±ï¼Œç´§æ€¥ä¿®å¤..."
                for dep in $TURBOACC_CRITICAL_DEPS; do
                    if ! grep -q "CONFIG_PACKAGE_${dep}=y" .config; then
                        echo "ğŸ”„ ç´§æ€¥å¯ç”¨: $dep"
                        sed -i "/# CONFIG_PACKAGE_${dep} is not set/d" .config
                        echo "CONFIG_PACKAGE_${dep}=y" >> .config
                    fi
                done
                echo "âœ… å…³é”®ä¾èµ–ç´§æ€¥ä¿®å¤å®Œæˆ"
            fi
        elif grep -q "CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
            echo "âœ… æ›¿ä»£åŠ é€Ÿæ–¹æ¡ˆ (BBR): å·²å¯ç”¨"
        else
            echo "âŒ ä¸¥é‡é”™è¯¯: æœªå¯ç”¨ä»»ä½•ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆï¼"
            echo "=== æ‰§è¡Œç´§æ€¥ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆæ¢å¤ ==="
            case "$PLATFORM" in
                "ipq40xx"|"ipq806x"|"mediatek"|"ramips"|"ath79"|"rockchip")
                    echo "ğŸ”„ ç´§æ€¥å¯ç”¨ turboacc æ–¹æ¡ˆ"
                    EMERGENCY_CONFIG="CONFIG_PACKAGE_kmod-nf-conntrack=y CONFIG_PACKAGE_kmod-ipt-core=y CONFIG_PACKAGE_kmod-ipt-raw=y CONFIG_PACKAGE_kmod-sched-core=y CONFIG_PACKAGE_kmod-shortcut-fe=y CONFIG_PACKAGE_kmod-fast-classifier=y CONFIG_PACKAGE_luci-app-turboacc=y CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y"
                    ;;
                *)
                    echo "ğŸ”„ ç´§æ€¥å¯ç”¨ BBR æ›¿ä»£æ–¹æ¡ˆ"
                    EMERGENCY_CONFIG="CONFIG_PACKAGE_kmod-tcp-bbr=y CONFIG_PACKAGE_kmod-nft-core=y CONFIG_PACKAGE_kmod-nft-offload=y"
                    ;;
            esac
            for config in $EMERGENCY_CONFIG; do
                echo "$config" >> .config
            done
            echo "âœ… ç´§æ€¥ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆæ¢å¤å®Œæˆ"
        fi
        echo "=== æœ€ç»ˆæ£€æŸ¥ä¸éœ€è¦çš„æ’ä»¶ ==="
        UNWANTED_PLUGINS_FINAL_CHECK="luci-app-rclone_INCLUDE_rclone-ng luci-app-rclone_INCLUDE_rclone-webui luci-app-timewol luci-app-passwall_INCLUDE_Haproxy luci-app-passwall_INCLUDE_Shadowsocks_Rust_Client luci-app-passwall_INCLUDE_Shadowsocks_Rust_Server luci-app-passwall_INCLUDE_Simple_Obfs luci-app-passwall_INCLUDE_SingBox luci-app-passwall_INCLUDE_V2ray_Geoview luci-app-passwall_INCLUDE_V2ray_Plugin luci-app-passwall_INCLUDE_Xray"
        FOUND_UNWANTED=0
        for plugin in $UNWANTED_PLUGINS_FINAL_CHECK; do
            if grep -q "CONFIG_PACKAGE_${plugin}=y" .config; then
                echo "âŒ ä¸éœ€è¦çš„æ’ä»¶ä»ç„¶å­˜åœ¨: $plugin"
                FOUND_UNWANTED=$((FOUND_UNWANTED + 1))
            fi
        done
        if [ $FOUND_UNWANTED -gt 0 ]; then
            echo "âš ï¸ å‘ç° $FOUND_UNWANTED ä¸ªä¸éœ€è¦çš„æ’ä»¶ä»ç„¶å¯ç”¨"
        else
            echo "âœ… æ‰€æœ‰ä¸éœ€è¦çš„æ’ä»¶éƒ½å·²æ­£ç¡®ç¦ç”¨"
        fi
        echo "=== é…ç½®éªŒè¯å®Œæˆ ==="

    - name: ä¿®å¤ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤ç¼–è¯‘ç¯å¢ƒï¼ˆå•çº¿ç¨‹æ¨¡å¼ï¼‰==="
        export MAKE_JOBS=1
        find . -name "*.rej" -delete 2>/dev/null || true
        find . -name "*.orig" -delete 2>/dev/null || true
        mkdir -p staging_dir/host/bin
        mkdir -p staging_dir/target-*/host/bin
        echo "=== è¿è¡Œ defconfig ä»¥ç¡®ä¿é…ç½®æ­£ç¡® ==="
        make -j1 defconfig
        echo "=== æ£€æŸ¥å¹¶ä¿®å¤ turboacc é…ç½® ==="
        if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            echo "âœ… turboacc é…ç½®åœ¨ defconfig åä»ç„¶å­˜åœ¨"
        else
            echo "âŒ turboacc é…ç½®åœ¨ defconfig åè¢«æ¸…é™¤ï¼Œç´§æ€¥ä¿®å¤..."
            EMERGENCY_TURBOACC="CONFIG_PACKAGE_kmod-nf-conntrack=y CONFIG_PACKAGE_kmod-ipt-core=y CONFIG_PACKAGE_kmod-ipt-raw=y CONFIG_PACKAGE_kmod-sched-core=y CONFIG_PACKAGE_kmod-shortcut-fe=y CONFIG_PACKAGE_kmod-fast-classifier=y CONFIG_PACKAGE_luci-app-turboacc=y CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y"
            for config in $EMERGENCY_TURBOACC; do
                echo "$config" >> .config
            done
            echo "âœ… turboacc é…ç½®ç´§æ€¥ä¿®å¤å®Œæˆ"
        fi
        echo "âœ… ç¼–è¯‘ç¯å¢ƒä¿®å¤å®Œæˆ"

    - name: æ™ºèƒ½ä¸‹è½½ä¾èµ–
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½ä¸‹è½½ä¾èµ– ==="
        mkdir -p dl
        chmod 755 dl
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        echo "=== è®¾ç½®å›½å†…é•œåƒæº: $MIRROR_SOURCE ==="
        case "$MIRROR_SOURCE" in
            "tuna") MIRROR_URL="https://mirrors.tuna.tsinghua.edu.cn/openwrt" ;;
            "ustc") MIRROR_URL="https://mirrors.ustc.edu.cn/openwrt" ;;
            "tencent") MIRROR_URL="https://mirrors.cloud.tencent.com/openwrt" ;;
            "huawei") MIRROR_URL="https://mirrors.huaweicloud.com/openwrt" ;;
            *) MIRROR_URL="https://mirrors.tuna.tsinghua.edu.cn/openwrt" ;;
        esac
        MAX_DOWNLOAD_RETRIES=3
        RETRY_COUNT=0
        DOWNLOAD_SUCCESS=false
        echo "=== é¢„å…ˆä¸‹è½½å…³é”®ä¾èµ– ==="
        make -j1 tools/install V=s 2>&1 | grep -E "Downloading|error" || true
        make -j1 toolchain/install V=s 2>&1 | grep -E "Downloading|error" || true
        find dl -name "*.tmp" -delete 2>/dev/null || true
        find dl -size 0 -delete 2>/dev/null || true
        for ROUND in 1 2; do
            echo "=== ç¬¬ $ROUND è½®ä¸‹è½½éªŒè¯å¾ªç¯ ==="
            while [ $RETRY_COUNT -lt $MAX_DOWNLOAD_RETRIES ] && [ "$DOWNLOAD_SUCCESS" = false ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "=== ä¸‹è½½å°è¯• $RETRY_COUNT/$MAX_DOWNLOAD_RETRIES ==="
              set +e
              make -j1 download V=s
              DOWNLOAD_EXIT_CODE=$?
              set -e
              if [ $DOWNLOAD_EXIT_CODE -eq 0 ]; then
                echo "âœ… ä¸‹è½½å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
                DOWNLOAD_SUCCESS=true
              else
                echo "âŒ ä¸‹è½½å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºä»£ç : $DOWNLOAD_EXIT_CODE"
                if [ $RETRY_COUNT -eq $MAX_DOWNLOAD_RETRIES ]; then
                  echo "âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¸‹è½½å¤±è´¥"
                  echo "=== æœ€åå°è¯•å•çº¿ç¨‹ä¸‹è½½ ==="
                  set +e
                  make -j1 download V=s
                  FINAL_DOWNLOAD_EXIT_CODE=$?
                  set -e
                  if [ $FINAL_DOWNLOAD_EXIT_CODE -eq 0 ]; then
                    echo "âœ… æœ€åå°è¯•ä¸‹è½½æˆåŠŸ"
                    DOWNLOAD_SUCCESS=true
                  else
                    echo "âŒ æœ€åå°è¯•ä¸‹è½½å¤±è´¥"
                  fi
                  break
                else
                  echo "ğŸ”„ ç­‰å¾…15ç§’åé‡è¯•..."
                  sleep 15
                  find dl -name "*.tmp" -delete 2>/dev/null || true
                  find dl -size 0 -delete 2>/dev/null || true
                fi
              fi
            done
            echo "=== ä¸‹è½½å®Œæ•´æ€§æ£€æŸ¥ ==="
            EMPTY_FILES=$(find dl -type f -size 0 2>/dev/null | wc -l)
            if [ "$EMPTY_FILES" -gt 0 ]; then
              echo "âŒ å‘ç° $EMPTY_FILES ä¸ªç©ºæ–‡ä»¶ï¼Œåˆ é™¤åé‡æ–°ä¸‹è½½..."
              find dl -type f -size 0 -delete
              echo "é‡æ–°ä¸‹è½½ç©ºæ–‡ä»¶..."
              make -j1 download V=s
            fi
            if find dl -name "*.tmp" | grep -q ".tmp"; then
              echo "âŒ å‘ç°æœªå®Œæˆçš„ä¸‹è½½æ–‡ä»¶ï¼Œåˆ é™¤åé‡æ–°ä¸‹è½½..."
              find dl -name "*.tmp" -delete
              echo "é‡æ–°ä¸‹è½½æœªå®Œæˆçš„æ–‡ä»¶..."
              make -j1 download V=s
            fi
            DL_COUNT=$(find dl -type f | wc -l)
            DL_SIZE=$(du -sh dl | cut -f1)
            echo "âœ… ä¸‹è½½ç»Ÿè®¡: $DL_COUNT ä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°: $DL_SIZE"
            if [ $ROUND -eq 2 ]; then
                echo "=== ç¬¬äºŒè½®ï¼šéªŒè¯å…³é”®ä¾èµ–åŒ… ==="
                MISSING_CRITICAL=0
                if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
                    CRITICAL_PACKAGES="kmod-shortcut-fe kmod-fast-classifier kmod-sched-core kmod-nf-conntrack"
                else
                    CRITICAL_PACKAGES="kmod-tcp-bbr kmod-nft-core kmod-nft-offload"
                fi
                for pkg in $CRITICAL_PACKAGES; do
                    if ! find dl -name "*${pkg}*" | grep -q "."; then
                        echo "âŒ å…³é”®ä¾èµ–åŒ…ç¼ºå¤±: $pkg"
                        MISSING_CRITICAL=$((MISSING_CRITICAL + 1))
                    else
                        echo "âœ… å…³é”®ä¾èµ–åŒ…å­˜åœ¨: $pkg"
                    fi
                done
                if [ $MISSING_CRITICAL -gt 0 ]; then
                    echo "âŒ ç¼ºå¤± $MISSING_CRITICAL ä¸ªå…³é”®ä¾èµ–åŒ…ï¼Œå°è¯•å•ç‹¬ä¸‹è½½..."
                    for pkg in $CRITICAL_PACKAGES; do
                        if ! find dl -name "*${pkg}*" | grep -q "."; then
                            echo "ğŸ”„ å•ç‹¬ä¸‹è½½: $pkg"
                            make -j1 package/$pkg/download V=s
                        fi
                    done
                fi
            fi
            RETRY_COUNT=0
            DOWNLOAD_SUCCESS=false
        done
        echo "âœ… æ‰€æœ‰ä¾èµ–ä¸‹è½½å®Œæˆ"

    - name: æœ€ç»ˆä¾èµ–éªŒè¯
      run: |
        cd $BUILD_DIR
        echo "=== æœ€ç»ˆä¾èµ–éªŒè¯ ==="
        echo "=== æ£€æŸ¥ä¸‹è½½ç›®å½•çŠ¶æ€ ==="
        DL_COUNT=$(find dl -type f | wc -l)
        DL_SIZE=$(du -sh dl | cut -f1)
        echo "ä¸‹è½½æ–‡ä»¶æ€»æ•°: $DL_COUNT"
        echo "ä¸‹è½½æ€»å¤§å°: $DL_SIZE"
        echo "=== æ£€æŸ¥ç©ºæ–‡ä»¶å’ŒæŸåæ–‡ä»¶ ==="
        EMPTY_FILES=$(find dl -type f -size 0 2>/dev/null | wc -l)
        TEMP_FILES=$(find dl -name "*.tmp" 2>/dev/null | wc -l)
        if [ "$EMPTY_FILES" -gt 0 ]; then
            echo "âŒ å‘ç° $EMPTY_FILES ä¸ªç©ºæ–‡ä»¶"
            find dl -type f -size 0 -delete
            echo "å·²åˆ é™¤ç©ºæ–‡ä»¶"
        else
            echo "âœ… æ²¡æœ‰ç©ºæ–‡ä»¶"
        fi
        if [ "$TEMP_FILES" -gt 0 ]; then
            echo "âŒ å‘ç° $TEMP_FILES ä¸ªä¸´æ—¶æ–‡ä»¶"
            find dl -name "*.tmp" -delete
            echo "å·²åˆ é™¤ä¸´æ—¶æ–‡ä»¶"
        else
            echo "âœ… æ²¡æœ‰ä¸´æ—¶æ–‡ä»¶"
        fi
        echo "=== éªŒè¯å…³é”®ä¾èµ–åŒ… ==="
        if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            CRITICAL_PACKAGES="kmod-shortcut-fe kmod-fast-classifier kmod-sched-core kmod-nf-conntrack"
        else
            CRITICAL_PACKAGES="kmod-tcp-bbr kmod-nft-core kmod-nft-offload"
        fi
        ALL_CRITICAL_EXIST=true
        for pkg in $CRITICAL_PACKAGES; do
            if find dl -name "*${pkg}*" | grep -q "."; then
                echo "âœ… å…³é”®ä¾èµ–åŒ…å­˜åœ¨: $pkg"
            else
                echo "âŒ å…³é”®ä¾èµ–åŒ…ç¼ºå¤±: $pkg"
                ALL_CRITICAL_EXIST=false
            fi
        done
        if [ "$ALL_CRITICAL_EXIST" = false ]; then
            echo "âš ï¸ éƒ¨åˆ†å…³é”®ä¾èµ–åŒ…ç¼ºå¤±ï¼Œä½†ç»§ç»­æ„å»º"
        else
            echo "âœ… æ‰€æœ‰å…³é”®ä¾èµ–åŒ…éƒ½å­˜åœ¨"
        fi

    - name: æœ€ç»ˆé…ç½®éªŒè¯ï¼ˆè¯¦ç»†ç‰ˆï¼‰
      run: |
        cd $BUILD_DIR
        echo "=== æœ€ç»ˆé…ç½®éªŒè¯ï¼ˆè¯¦ç»†ç‰ˆï¼‰==="
        export MAKE_JOBS=1
        echo "=== .config æ–‡ä»¶çŠ¶æ€ ==="
        ls -la .config
        echo "æ–‡ä»¶å¤§å°: $(wc -l < .config) è¡Œ"
        echo "=== æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³• ==="
        if grep -q "missing separator" .config 2>/dev/null; then
            echo "âŒ å‘ç°é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯: missing separator"
            echo "æœ‰é—®é¢˜çš„è¡Œ:"
            grep -n "missing separator" .config 2>/dev/null || true
            exit 1
        fi
        if grep -q $'\t' .config; then
            echo "âš ï¸ å‘ç°åˆ¶è¡¨ç¬¦ï¼Œå¯èƒ½ä¼šå½±å“é…ç½®è§£æ"
        fi
        echo "=== å…³é”®è½¯ä»¶åŒ…é…ç½®çŠ¶æ€ ==="
        for pkg in luci luci-base luci-theme-bootstrap; do
          if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
            echo "âœ… $pkg: åœ¨.configä¸­å·²å¯ç”¨"
          else
            echo "âŒ $pkg: åœ¨.configä¸­æœªå¯ç”¨"
          fi
        done
        echo "=== ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆæœ€ç»ˆçŠ¶æ€éªŒè¯ ==="
        echo "ğŸ” ç¼–è¯‘å‰æœ€ç»ˆç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆçŠ¶æ€æ£€æŸ¥:"
        if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" .config; then
            echo "âœ… turboacc æ–¹æ¡ˆ: åœ¨.configä¸­å·²å¯ç”¨"
            TURBOACC_FINAL_DEPS="kmod-shortcut-fe kmod-fast-classifier kmod-nf-conntrack kmod-ipt-raw kmod-ipt-offload kmod-nf-conntrack-netlink kmod-nf-nat kmod-ipt-core kmod-sched-core"
            ALL_DEPS_ENABLED=true
            for dep in $TURBOACC_FINAL_DEPS; do
                if grep -q "CONFIG_PACKAGE_${dep}=y" .config; then
                    echo "âœ… $dep: åœ¨.configä¸­å·²å¯ç”¨"
                else
                    echo "âŒ $dep: åœ¨.configä¸­æœªå¯ç”¨"
                    ALL_DEPS_ENABLED=false
                fi
            done
            if [ "$ALL_DEPS_ENABLED" = true ]; then
                echo "ğŸ‰ æ‰€æœ‰ turboacc ä¾èµ–éƒ½å·²æ­£ç¡®å¯ç”¨ï¼"
            else
                echo "âš ï¸ éƒ¨åˆ† turboacc ä¾èµ–æœªå¯ç”¨ï¼Œå°è¯•ç´§æ€¥ä¿®å¤..."
                for dep in $TURBOACC_FINAL_DEPS; do
                    if ! grep -q "CONFIG_PACKAGE_${dep}=y" .config; then
                        echo "ğŸ”„ ç´§æ€¥å¯ç”¨: $dep"
                        sed -i "/# CONFIG_PACKAGE_${dep} is not set/d" .config
                        echo "CONFIG_PACKAGE_${dep}=y" >> .config
                    fi
                done
                echo "âœ… ç´§æ€¥ä¿®å¤å®Œæˆ"
            fi
        elif grep -q "CONFIG_PACKAGE_kmod-tcp-bbr=y" .config; then
            echo "âœ… æ›¿ä»£åŠ é€Ÿæ–¹æ¡ˆ (BBR): åœ¨.configä¸­å·²å¯ç”¨"
        else
            echo "âŒ æœªå¯ç”¨ä»»ä½•ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ - è¿™æ˜¯ä¸¥é‡é—®é¢˜ï¼"
            echo "=== ç´§æ€¥å¯ç”¨ turboacc æ–¹æ¡ˆ ==="
            EMERGENCY_TURBOACC_CONFIG="CONFIG_PACKAGE_kmod-nf-conntrack=y CONFIG_PACKAGE_kmod-ipt-core=y CONFIG_PACKAGE_kmod-ipt-raw=y CONFIG_PACKAGE_kmod-sched-core=y CONFIG_PACKAGE_kmod-shortcut-fe=y CONFIG_PACKAGE_kmod-fast-classifier=y CONFIG_PACKAGE_luci-app-turboacc=y CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y"
            for config in $EMERGENCY_TURBOACC_CONFIG; do
                echo "$config" >> .config
            done
            echo "âœ… å·²ç´§æ€¥å¯ç”¨ turboacc æ–¹æ¡ˆ"
        fi
        echo "=== ç”¨æˆ·å¯ç”¨çš„luciæ’ä»¶ ==="
        grep "^CONFIG_PACKAGE_luci-app" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//' | sort
        echo "=== é…ç½®éªŒè¯å®Œæˆ ==="

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd $BUILD_DIR
        echo "::group::ğŸ“± ç¼–è¯‘æ—¥å¿—"
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        export FORCE_UNSAFE_CONFIGURE=1
        if ${{ inputs.multithreading }}; then
          BUILD_JOBS=$(nproc)
          echo "âœ… å¤šçº¿ç¨‹ç¼–è¯‘: ä½¿ç”¨ $BUILD_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡"
        else
          BUILD_JOBS=1
          echo "âœ… å•çº¿ç¨‹ç¼–è¯‘"
        fi
        echo "ğŸš€ å¼€å§‹åˆ†é˜¶æ®µç¼–è¯‘..."
        START_TIME=$(date +%s)
        echo "=== é˜¶æ®µ1: ç¼–è¯‘å·¥å…·é“¾ ==="
        make -j$BUILD_JOBS tools/compile V=s 2>&1 | tee -a build_detailed.log
        echo "=== é˜¶æ®µ2: ç¼–è¯‘å·¥å…· ==="
        make -j$BUILD_JOBS toolchain/compile V=s 2>&1 | tee -a build_detailed.log
        echo "=== é˜¶æ®µ3: å®Œæ•´ç¼–è¯‘ ==="
        set +e
        time make -j$BUILD_JOBS V=s 2>&1 | tee -a build_detailed.log
        COMPILE_EXIT_CODE=$?
        set -e
        END_TIME=$(date +%s)
        COMPILE_TIME=$((END_TIME - START_TIME))
        echo "=== ç¼–è¯‘æ—¶é—´ç»Ÿè®¡ ==="
        echo "æ€»ç¼–è¯‘æ—¶é—´: $((COMPILE_TIME / 60))åˆ†é’Ÿ$((COMPILE_TIME % 60))ç§’"
        if [ -d "bin/targets" ]; then
            echo "::endgroup::"
            echo "::notice::ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
            echo "âœ… ç¼–è¯‘å®Œæˆï¼Œæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶"
            FIRMWARE_LIST=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | sort)
            if [ -n "$FIRMWARE_LIST" ]; then
                echo "ğŸ‰ ç”Ÿæˆçš„å›ºä»¶:"
                echo "$FIRMWARE_LIST"
            fi
            if [ $COMPILE_EXIT_CODE -ne 0 ]; then
                echo "âš ï¸ ç¼–è¯‘è¿‡ç¨‹æœ‰è­¦å‘Šï¼Œä½†ç”Ÿæˆäº†å›ºä»¶æ–‡ä»¶"
            fi
        else
            echo "::endgroup::"
            echo "::notice::âŒ ç¼–è¯‘å¤±è´¥"
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆç›®æ ‡æ–‡ä»¶"
            if [ $COMPILE_EXIT_CODE -eq 0 ]; then
                echo "âŒ ç¼–è¯‘å‘½ä»¤æˆåŠŸä½†æœªç”Ÿæˆç›®æ ‡æ–‡ä»¶"
                find . -maxdepth 3 -type d | sort | head -20
            fi
            exit 1
        fi

    - name: é”™è¯¯åˆ†æ
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== è¿è¡Œé”™è¯¯åˆ†æ ==="
        if [ -f "error_analysis.sh" ]; then
            chmod +x error_analysis.sh
            echo "å¼€å§‹é”™è¯¯åˆ†æ..."
            ./error_analysis.sh "$BUILD_DIR"
            echo "âœ… é”™è¯¯åˆ†æå®Œæˆ"
        else
            echo "âš ï¸ æœªæ‰¾åˆ°é”™è¯¯åˆ†æè„šæœ¬ï¼Œè·³è¿‡é”™è¯¯åˆ†æ"
        fi

    - name: éªŒè¯å›ºä»¶
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== å›ºä»¶ç”ŸæˆéªŒè¯ ==="
        if [ -d "bin/targets" ]; then
          echo "âœ… æ„å»ºæˆåŠŸï¼ç”Ÿæˆçš„å›ºä»¶:"
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) | sort
          for firmware in $(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null); do
            echo "å›ºä»¶: $firmware"
            echo "å¤§å°: $(du -h "$firmware" | cut -f1)"
            echo ""
          done
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶"
        fi

    - name: ç”ŸæˆæŠ¥å‘Š
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== ç”Ÿæˆæ„å»ºæŠ¥å‘Šæ–‡æ¡£ ==="
        echo "# OpenWrt å›ºä»¶æ„å»ºæŠ¥å‘Š" > "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "## æ„å»ºä¿¡æ¯" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "- **è®¾å¤‡**: ${{ env.DEVICE_FULL_NAME }}" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "- **å¹³å°**: ${{ env.PLATFORM }}" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "- **ç‰ˆæœ¬**: ${{ env.SELECTED_REPO }} (${{ env.SELECTED_BRANCH }})" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "- **é…ç½®ç±»å‹**: ${{ inputs.config_type }}" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "- **æ„å»ºæ—¶é—´**: $(date)" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "- **ç¼–è¯‘æ—¶é•¿**: $((COMPILE_TIME / 60))åˆ†é’Ÿ$((COMPILE_TIME % 60))ç§’" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "## é…ç½®çŠ¶æ€" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "### å¯ç”¨çš„luciæ’ä»¶" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        grep "^CONFIG_PACKAGE_luci-app" .config 2>/dev/null | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//' | sort | while read plugin; do
            echo "- $plugin" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        done || echo "- æ— luciæ’ä»¶æˆ–é…ç½®æ–‡ä»¶ä¸å¯è¯»" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "## ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆçŠ¶æ€" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" .config 2>/dev/null; then
            echo "âœ… **turboacc æ–¹æ¡ˆ**: å·²å¯ç”¨" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
            for dep in kmod-shortcut-fe kmod-fast-classifier kmod-nf-conntrack kmod-ipt-raw; do
                if grep -q "CONFIG_PACKAGE_${dep}=y" .config 2>/dev/null; then
                    echo "âœ… **${dep}**: å·²å¯ç”¨" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
                else
                    echo "âŒ **${dep}**: æœªå¯ç”¨" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
                fi
            done
        elif grep -q "CONFIG_PACKAGE_kmod-tcp-bbr=y" .config 2>/dev/null; then
            echo "âœ… **æ›¿ä»£åŠ é€Ÿæ–¹æ¡ˆ (BBR)**: å·²å¯ç”¨" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        else
            echo "âš ï¸ **ç½‘ç»œåŠ é€Ÿæ–¹æ¡ˆ**: æœªå¯ç”¨" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        fi
        echo "" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        echo "## æ„å»ºçŠ¶æ€" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        if [ -d "bin/targets" ]; then
            echo "âœ… **æ„å»ºçŠ¶æ€**: æˆåŠŸ" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
            echo "" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
            echo "## ç”Ÿæˆçš„å›ºä»¶" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
            find bin/targets -name "*.bin" -o -name "*.img" | while read firmware; do
                FIRMWARE_NAME=$(basename "$firmware")
                FIRMWARE_SIZE=$(du -h "$firmware" | cut -f1)
                echo "- **$FIRMWARE_NAME** ($FIRMWARE_SIZE)" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
            done
        else
            echo "âŒ **æ„å»ºçŠ¶æ€**: å¤±è´¥" >> "$GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md"
        fi
        echo "âœ… æ„å»ºæŠ¥å‘Šå·²ç”Ÿæˆ"

    - name: ä¿å­˜é…ç½®
      if: success() && ${{ inputs.save_config }}
      run: |
        echo "=== ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“ ==="
        CONFIG_FILENAME="${{ github.event.inputs.device_name }}-${{ inputs.config_type }}.config"
        mkdir -p $GITHUB_WORKSPACE/firmware-config/configs
        if [ ! -f "$BUILD_DIR/.config" ]; then
          echo "âŒ é”™è¯¯: æºé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ -f "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" ]; then
          if diff -q "$BUILD_DIR/.config" "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" >/dev/null; then
            echo "â„¹ï¸ é…ç½®æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡ä¿å­˜"
            echo "CONFIG_UNCHANGED=true" >> $GITHUB_ENV
            exit 0
          else
            echo "âœ… æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œå°†ä¿å­˜æ–°é…ç½®"
          fi
        else
          echo "âœ… é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°é…ç½®"
        fi
        cp $BUILD_DIR/.config $GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME
        if [ -f "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" ]; then
          echo "âœ… é…ç½®æ–‡ä»¶å·²ä¿å­˜ä¸º: firmware-config/configs/$CONFIG_FILENAME"
          echo "CONFIG_UNCHANGED=false" >> $GITHUB_ENV
        else
          echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¿å­˜å¤±è´¥"
          exit 1
        fi

    - name: æäº¤é…ç½®
      if: success() && ${{ inputs.save_config }} && env.CONFIG_UNCHANGED == 'false'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "=== æäº¤é…ç½®æ–‡ä»¶æ›´æ”¹ ==="
        cd $GITHUB_WORKSPACE
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
        git add firmware-config/configs/
        git add "æ„å»ºæŠ¥å‘Š.md" 2>/dev/null || true
        if git diff --staged --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰é…ç½®æ–‡ä»¶æ›´æ”¹éœ€è¦æäº¤"
          exit 0
        fi
        git commit -m "è‡ªåŠ¨ä¿å­˜é…ç½®æ–‡ä»¶: ${{ github.event.inputs.device_name }}-${{ inputs.config_type }} [skip ci]"
        git pull origin main --rebase --no-edit
        git push origin main
        echo "âœ… é…ç½®æ–‡ä»¶æäº¤å®Œæˆ"

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ inputs.config_type }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.device_name }}-${{ inputs.config_type }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/build_detailed.log
          ${{ env.BUILD_DIR }}/enhanced_error_analysis.log
          ${{ env.BUILD_DIR }}/download_attempt_*.log
          $GITHUB_WORKSPACE/æ„å»ºæŠ¥å‘Š.md
        retention-days: 7

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•å·²æ¸…ç†"

  build-firmware-ssh:
    if: ${{ inputs.ssh_connection == true }}
    name: ğŸš€ ç¼–è¯‘ (Build) - SSHè°ƒè¯•ç‰ˆ
    runs-on: ubuntu-22.04
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip
        pip3 install requests urllib3
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: å¼€å¯ SSH æœåŠ¡
      uses: lhotari/action-upterm@v1
      with:
        wait-timeout-minutes: 30

    - name: ç¼–è¯‘å‰æç¤º
      run: |
        echo "ğŸš€ SSHè°ƒè¯•æ¨¡å¼å·²å¯åŠ¨"
        echo "æ‚¨å¯ä»¥é€šè¿‡SSHè¿æ¥åˆ°æ„å»ºç¯å¢ƒè¿›è¡Œè°ƒè¯•"
        echo "è°ƒè¯•å®Œæˆåï¼Œæ„å»ºæµç¨‹å°†ç»§ç»­æ‰§è¡Œ"
