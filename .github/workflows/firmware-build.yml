name: OpenWrt 固件构建工作流

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称'
        required: true
        default: 'ac42u'
        type: string
      config_type:
        description: '配置类型'
        required: true
        default: 'minimal'
        type: choice
        options: ['minimal', 'normal', 'custom']
      extra_packages:
        description: '额外安装插件 (空格分隔)'
        required: false
        type: string
      disable_packages:
        description: '禁用插件 (空格分隔)'
        required: false
        type: string

env:
  WORKSPACE: ${{ github.workspace }}
  BUILD_DIR: /mnt/openwrt-build
  CONFIG_DIR: ${{ github.workspace }}/firmware-config

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出代码仓库
      uses: actions/checkout@v4

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 unzip zlib1g-dev libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib curl lib32gcc-s1 libc6-dev-x32 linux-libc-dev ncurses-term help2man

    - name: 创建构建目录
      run: |
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR

    - name: 克隆源码
      run: |
        cd $BUILD_DIR
        git clone https://github.com/immortalwrt/immortalwrt.git .
        git checkout openwrt-23.05

    - name: 更新安装feeds
      run: |
        cd $BUILD_DIR
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 调试信息收集
      run: |
        cd $BUILD_DIR
        echo "=== 调试信息 ==="
        echo "当前目录: $(pwd)"
        echo "目录内容:"
        ls -la
        echo "config 目录内容:"
        ls -la config/ || echo "无 config 目录"
        echo "构建系统信息:"
        make --version || echo "make 不可用"

    - name: 验证设备支持
      run: |
        cd $BUILD_DIR
        echo "=== 验证设备支持 ==="
        
        DEVICE_NAME="${{ github.event.inputs.device_name }}"
        case "$DEVICE_NAME" in
          "ac42u")
            PLATFORM="ipq40xx"
            DEVICE_SHORT_NAME="ac42u"
            DEVICE_FULL_NAME="asus_rt-ac42u"
            DEVICE_CONFIG_NAME="asus_rt-ac42u"
            ;;
          *)
            echo "未知设备: $DEVICE_NAME"
            exit 1
            ;;
        esac
        
        echo "目标平台: $PLATFORM"
        echo "设备简称: $DEVICE_SHORT_NAME" 
        echo "完整设备名称: $DEVICE_FULL_NAME"
        echo "配置名称: $DEVICE_CONFIG_NAME"
        
        echo "=== 检查设备支持文件 ==="
        
        if [ -f "target/linux/$PLATFORM/image/generic.mk" ]; then
          echo "✅ 找到平台配置文件"
          
          # 精确检查设备定义
          if grep -q "define Device/asus_rt-ac42u" "target/linux/$PLATFORM/image/generic.mk"; then
            echo "✅ 找到设备定义: $DEVICE_FULL_NAME"
            echo "设备定义详情:"
            grep -A 30 "define Device/asus_rt-ac42u" "target/linux/$PLATFORM/image/generic.mk"
            
            # 检查是否在 TARGET_DEVICES 中
            if grep -q "TARGET_DEVICES += asus_rt-ac42u" "target/linux/$PLATFORM/image/generic.mk"; then
              echo "✅ 设备已添加到目标设备列表"
            else
              echo "❌ 设备未添加到目标设备列表"
              exit 1
            fi
          else
            echo "❌ 未找到设备定义: $DEVICE_FULL_NAME"
            echo "可用的 ASUS 设备:"
            grep "define Device" "target/linux/$PLATFORM/image/generic.mk" | grep -i asus
            exit 1
          fi
        else
          echo "❌ 找不到平台配置文件: target/linux/$PLATFORM/image/generic.mk"
          exit 1
        fi
        
        echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
        echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
        echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV

    - name: 生成设备配置
      run: |
        cd $BUILD_DIR
        echo "=== 生成设备配置 ==="
        
        # 在工作区根目录生成配置
        CONFIG_FILE="$WORKSPACE/.config"
        
        # 检查配置脚本是否存在
        if [ -f "$CONFIG_DIR/scripts/generate_config.sh" ]; then
          echo "✅ 找到配置脚本，执行配置生成..."
          chmod +x $CONFIG_DIR/scripts/generate_config.sh
          $CONFIG_DIR/scripts/generate_config.sh "${{ github.event.inputs.config_type }}" "${{ env.PLATFORM }}" "${{ env.DEVICE_SHORT_NAME }}" "${{ env.DEVICE_FULL_NAME }}" "${{ github.event.inputs.extra_packages }}" "${{ github.event.inputs.disable_packages }}" "$BUILD_DIR"
          echo "✅ 配置脚本执行完成"
          
          # 如果脚本生成了配置，复制到工作区
          if [ -f ".config" ]; then
            cp .config $CONFIG_FILE
            echo "✅ 配置已复制到工作区: $CONFIG_FILE"
          fi
        else
          echo "⚠️ 配置脚本不存在，创建手动配置..."
          
          # 在工作区根目录创建配置
          cat > $CONFIG_FILE << 'EOF'
CONFIG_TARGET_ipq40xx=y
CONFIG_TARGET_ipq40xx_generic=y
CONFIG_TARGET_DEVICE_ipq40xx_generic_DEVICE_asus_rt-ac42u=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_EXT4FS=n
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_IMAGES_PAD=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_ath10k-firmware-qca9984-ct=y
CONFIG_PACKAGE_kmod-usb-ledtrig-usbport=y
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_fstools=y
CONFIG_PACKAGE_ip6tables=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iwinfo=y
CONFIG_PACKAGE_jshn=y
CONFIG_PACKAGE_kmod-gpio-button-hotplug=y
CONFIG_PACKAGE_kmod-ip6tables=y
CONFIG_PACKAGE_kmod-ipt-conntrack=y
CONFIG_PACKAGE_kmod-ipt-core=y
CONFIG_PACKAGE_kmod-ipt-nat=y
CONFIG_PACKAGE_kmod-ipt-offload=y
CONFIG_PACKAGE_kmod-nf-conntrack=y
CONFIG_PACKAGE_kmod-nf-conntrack6=y
CONFIG_PACKAGE_kmod-nf-flow=y
CONFIG_PACKAGE_kmod-nf-ipt=y
CONFIG_PACKAGE_kmod-nf-nat=y
CONFIG_PACKAGE_kmod-nf-reject6=y
CONFIG_PACKAGE_kmod-nfnetlink=y
CONFIG_PACKAGE_kmod-ppp=y
CONFIG_PACKAGE_kmod-pppoe=y
CONFIG_PACKAGE_kmod-pppox=y
CONFIG_PACKAGE_kmod-slhc=y
CONFIG_PACKAGE_libatomic=y
CONFIG_PACKAGE_libc=y
CONFIG_PACKAGE_libgcc=y
CONFIG_PACKAGE_libiwinfo-lua=y
CONFIG_PACKAGE_liblua=y
CONFIG_PACKAGE_libubus-lua=y
CONFIG_PACKAGE_libuci-lua=y
CONFIG_PACKAGE_lua=y
CONFIG_PACKAGE_mtd=y
CONFIG_PACKAGE_netifd=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_odhcpd=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_ppp-mod-pppoe=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_rpcd=y
CONFIG_PACKAGE_rpcd-mod-file=y
CONFIG_PACKAGE_rpcd-mod-iwinfo=y
CONFIG_PACKAGE_rpcd-mod-luci=y
CONFIG_PACKAGE_rpcd-mod-rrdns=y
CONFIG_PACKAGE_swconfig=y
CONFIG_PACKAGE_uboot-envtools=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubusd=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_uclient-fetch=y
CONFIG_PACKAGE_urandom-seed=y
CONFIG_PACKAGE_urngd=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y
EOF
          echo "✅ 手动配置创建完成: $CONFIG_FILE"
        fi
        
        # 将配置复制到构建目录
        if [ -f "$CONFIG_FILE" ]; then
          cp $CONFIG_FILE $BUILD_DIR/.config
          echo "✅ 配置已复制到构建目录"
        else
          echo "❌ 配置生成失败"
          exit 1
        fi
        
        # 验证生成的配置
        echo "=== 验证生成的配置 ==="
        if [ -f ".config" ]; then
          echo "配置预览:"
          head -30 .config
        fi

    - name: 应用配置并验证
      run: |
        cd $BUILD_DIR
        echo "=== 应用配置并验证 ==="
        
        # 检查配置是否存在
        if [ ! -f ".config" ]; then
          echo "❌ .config 文件不存在"
          exit 1
        fi
        
        echo "=== 初始配置检查 ==="
        echo "配置大小: $(wc -l < .config) 行"
        echo "目标平台配置:"
        grep "CONFIG_TARGET" .config | head -20
        
        # 执行 defconfig
        echo "执行 defconfig..."
        if make defconfig; then
          echo "✅ defconfig 成功"
        else
          echo "❌ defconfig 失败"
          exit 1
        fi
        
        # 验证配置
        echo "=== 配置验证 ==="
        if [ -f ".config" ]; then
          echo "defconfig 后的配置:"
          echo "配置大小: $(wc -l < .config) 行"
          echo "目标平台配置:"
          grep "CONFIG_TARGET" .config | head -30
          
          # 检查设备配置
          echo "=== 设备配置检查 ==="
          if grep -q "CONFIG_TARGET_ipq40xx_generic=y" .config && \
             grep -q "CONFIG_TARGET_DEVICE" .config; then
            echo "✅ 平台和设备配置正常"
            echo "找到的设备配置:"
            grep "CONFIG_TARGET_DEVICE" .config | head -10
          else
            echo "⚠️ 设备配置可能有问题，但继续构建..."
          fi
        fi

    - name: 下载软件包
      run: |
        cd $BUILD_DIR
        echo "下载软件包..."
        if make -j4 download V=s; then
          echo "✅ 下载成功"
        else
          echo "❌ 下载失败，尝试重新下载..."
          make download V=s
        fi

    - name: 编译固件
      run: |
        cd $BUILD_DIR
        echo "开始编译固件..."
        
        echo "=== 最终配置验证 ==="
        if ! grep -q "CONFIG_TARGET_ipq40xx_generic=y" .config; then
          echo "❌ 错误: 目标平台配置丢失!"
          exit 1
        fi
        
        echo "执行编译..."
        if make -j$(nproc) V=s 2>&1 | tee build_detailed.log; then
          echo "✅ 编译成功"
        else
          echo "❌ 编译失败"
          exit 1
        fi

    - name: 验证固件生成
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== 固件生成验证 ==="
        
        if [ -d "bin/targets" ]; then
          echo "✅ 找到目标目录"
          
          # 详细列出所有固件
          echo "所有生成的固件:"
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.tar" \) | sort
          
          echo ""
          echo "=== 目标设备固件验证 ==="
          
          # 检查目标设备固件
          TARGET_FIRMWARE=$(find bin/targets -name "*asus_rt-ac42u*" -o -name "*rt-ac42u*" -o -name "*ac42u*" -o -name "*rt-ac82u*" -o -name "*acrh17*" -o -name "*ac2200*")
          
          if [ -n "$TARGET_FIRMWARE" ]; then
            echo "✅ 找到目标设备固件:"
            echo "$TARGET_FIRMWARE"
            echo "固件详情:"
            ls -la $TARGET_FIRMWARE
            
            # 检查固件大小
            FIRMWARE_SIZE=$(stat -c%s "$TARGET_FIRMWARE" 2>/dev/null || echo "0")
            echo "固件大小: $FIRMWARE_SIZE bytes"
          else
            echo "❌ 未找到目标设备固件: asus_rt-ac42u"
            echo "生成的固件列表:"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) -exec ls -la {} \;
            
            # 分析实际生成的设备
            echo "=== 实际生成的设备分析 ==="
            for firmware in $(find bin/targets -name "*.bin" | head -5); do
              FIRMWARE_NAME=$(basename "$firmware")
              echo "固件: $firmware"
              echo "名称: $FIRMWARE_NAME"
            done
          fi
        else
          echo "❌ 未找到目标目录 bin/targets"
          echo "当前目录内容:"
          ls -la
        fi

    - name: 错误分析
      if: always()
      run: |
        cd $BUILD_DIR
        echo "运行错误分析..."
        
        # 创建错误分析日志
        echo "=== 固件构建错误分析报告 ===" > error_analysis.log
        echo "生成时间: $(date)" >> error_analysis.log
        echo "" >> error_analysis.log
        
        # 检查构建状态
        if find bin/targets -name "*asus_rt-ac42u*" -o -name "*rt-ac42u*" -o -name "*ac42u*" | grep -q .; then
          echo "✅ 构建状态: 成功" >> error_analysis.log
          echo "✅ 生成的固件文件:" >> error_analysis.log
          find bin/targets -name "*asus_rt-ac42u*" -o -name "*rt-ac42u*" -o -name "*ac42u*" >> error_analysis.log
        else
          echo "❌ 构建状态: 失败或目标设备固件未生成" >> error_analysis.log
          echo "所有生成的固件:" >> error_analysis.log
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) >> error_analysis.log 2>/dev/null || echo "无固件生成" >> error_analysis.log
        fi
        
        echo "" >> error_analysis.log
        echo "=== 配置分析 ===" >> error_analysis.log
        if [ -f ".config" ]; then
          echo "目标平台配置:" >> error_analysis.log
          grep "CONFIG_TARGET" .config | head -20 >> error_analysis.log
        fi
        
        echo "" >> error_analysis.log
        echo "=== 关键错误检查 ===" >> error_analysis.log
        echo "检查日志文件: build_detailed.log" >> error_analysis.log
        
        # 查找错误
        if [ -f "build_detailed.log" ]; then
          if grep -q "error:" build_detailed.log; then
            echo "❌ 发现编译错误:" >> error_analysis.log
            grep "error:" build_detailed.log | head -20 >> error_analysis.log
          else
            echo "✅ 未发现编译错误" >> error_analysis.log
          fi
          
          if grep -q "failed" build_detailed.log; then
            echo "❌ 发现失败信息:" >> error_analysis.log
            grep "failed" build_detailed.log | head -20 >> error_analysis.log
          fi
          
          # 检查编译结束状态
          if tail -20 build_detailed.log | grep -q "make.*Error"; then
            echo "❌ 编译以错误结束" >> error_analysis.log
            tail -20 build_detailed.log >> error_analysis.log
          fi
        else
          echo "❌ 构建日志文件不存在" >> error_analysis.log
        fi
        
        echo "错误分析完成"

    - name: 上传编译产物
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}
        path: ${{ env.BUILD_DIR }}/bin/
        retention-days: 7

    - name: 上传日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}
        path: |
          ${{ env.BUILD_DIR }}/build_detailed.log
          ${{ env.BUILD_DIR }}/error_analysis.log
        retention-days: 7

    - name: 上传配置信息
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ github.event.inputs.config_type }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.WORKSPACE }}/.config
        retention-days: 7
