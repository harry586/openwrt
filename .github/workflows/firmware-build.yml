name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆ - ç¼–è¯‘å™¨é¢„æ„å»ºç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ 
          
          ğŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚
        required: false
        type: string
        default: ""
      use_git_archive:
        description: "ğŸ“¦ ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  REPO_ROOT: "${{ github.workspace }}"
  COMPILER_ROOT: "${{ github.workspace }}/firmware-config/build-Compiler-file"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç ï¼ˆä½†æ’é™¤ç¼–è¯‘å™¨æ–‡ä»¶ï¼‰
      - name: "1. ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç ï¼ˆæ’é™¤ç¼–è¯‘å™¨æ–‡ä»¶ï¼‰"
        if: github.event.inputs.use_git_archive == 'true'
        run: |
          echo "=== æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç ï¼ˆæ’é™¤ç¼–è¯‘å™¨æ–‡ä»¶ï¼‰==="
          echo "âš ï¸ æ³¨æ„ï¼šç”±äºç¼–è¯‘å™¨æ–‡ä»¶è¿‡å¤§ï¼Œæˆ‘ä»¬å°†åªä¸‹è½½é…ç½®æ–‡ä»¶"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          
          # åˆ›å»ºæœ€å°åŒ–çš„å·¥ä½œåŒºç»“æ„
          echo "ğŸ”„ åˆ›å»ºæœ€å°åŒ–å·¥ä½œåŒº..."
          mkdir -p ${{ github.workspace }}/firmware-config
          mkdir -p ${{ github.workspace }}/firmware-config/scripts
          mkdir -p ${{ github.workspace }}/firmware-config/custom-files
          mkdir -p ${{ github.workspace }}/firmware-config/build-Compiler-file
          mkdir -p ${{ github.workspace }}/firmware-config/config-backup
          
          # ç›´æ¥ä»åŸå§‹ä»“åº“ä¸‹è½½å¿…è¦çš„æ–‡ä»¶
          echo "ğŸ“¥ ç›´æ¥ä¸‹è½½å¿…è¦çš„é…ç½®æ–‡ä»¶..."
          
          # ä¸‹è½½è„šæœ¬æ–‡ä»¶
          echo "ä¸‹è½½è„šæœ¬æ–‡ä»¶..."
          SCRIPT_FILES=(
            "build_firmware_main.sh"
            "error_analysis.sh"
          )
          
          for script in "${SCRIPT_FILES[@]}"; do
            echo "ä¸‹è½½: firmware-config/scripts/$script"
            curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://raw.githubusercontent.com/${{ github.repository }}/main/firmware-config/scripts/$script" \
              -o "${{ github.workspace }}/firmware-config/scripts/$script" 2>/dev/null || echo "âš ï¸ æ— æ³•ä¸‹è½½: $script"
          done
          
          # ç¡®ä¿è„šæœ¬æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
          chmod +x ${{ github.workspace }}/firmware-config/scripts/*.sh 2>/dev/null || true
          
          # å¤åˆ¶å·¥ä½œæµæ–‡ä»¶
          echo "å¤åˆ¶å·¥ä½œæµæ–‡ä»¶..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://raw.githubusercontent.com/${{ github.repository }}/main/.github/workflows/firmware-build.yml" \
            -o "${{ github.workspace }}/.github/workflows/firmware-build.yml" 2>/dev/null || true
          
          # å¤åˆ¶å…¶ä»–å¿…è¦æ–‡ä»¶
          echo "å¤åˆ¶å…¶ä»–å¿…è¦æ–‡ä»¶..."
          ESSENTIAL_FILES=(
            ".gitignore"
            "README.md"
            "LICENSE"
          )
          
          for file in "${ESSENTIAL_FILES[@]}"; do
            echo "ä¸‹è½½: $file"
            curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://raw.githubusercontent.com/${{ github.repository }}/main/$file" \
              -o "${{ github.workspace }}/$file" 2>/dev/null || echo "âš ï¸ æ— æ³•ä¸‹è½½: $file"
          done
          
          echo "âœ… æœ€å°åŒ–æºä»£ç ä¸‹è½½å®Œæˆ"
          
          # æ£€æŸ¥å·¥ä½œåŒºå¤§å°
          echo "ğŸ“Š å·¥ä½œåŒºå¤§å°: $(du -sh ${{ github.workspace }} 2>/dev/null | cut -f1)"
          echo "ğŸ“Š æ–‡ä»¶åˆ—è¡¨:"
          find ${{ github.workspace }} -type f 2>/dev/null | while read file; do
            size=$(du -h "$file" 2>/dev/null | cut -f1)
            echo "  $size - $file"
          done
      
      # æ­¥éª¤ 2: æ£€æŸ¥å·¥ä½œåŒºå¤§å°
      - name: "2. æ£€æŸ¥å·¥ä½œåŒºå¤§å°"
        if: github.event.inputs.use_git_archive == 'true'
        run: |
          echo "=== æ­¥éª¤ 2: æ£€æŸ¥å·¥ä½œåŒºå¤§å° ==="
          
          WORKSPACE="${{ github.workspace }}"
          
          # è®¡ç®—æ€»å¤§å°
          TOTAL_SIZE=$(du -sb $WORKSPACE 2>/dev/null | awk '{print $1}' || echo "0")
          
          echo "ğŸ“Š å·¥ä½œåŒºæ€»å¤§å°: $((TOTAL_SIZE / 1024))KB ($((TOTAL_SIZE / 1024 / 1024))MB)"
          echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $(find $WORKSPACE -type f 2>/dev/null | wc -l)"
          
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶åŠå…¶å¤§å°
          echo "ğŸ“‹ æ–‡ä»¶åˆ—è¡¨:"
          find $WORKSPACE -type f -exec du -h {} \; 2>/dev/null | sort -hr
          
          # 2MBæ£€æŸ¥
          SIZE_LIMIT=$((2 * 1024 * 1024))
          
          if [ $TOTAL_SIZE -gt $SIZE_LIMIT ]; then
            echo "âŒ é”™è¯¯: å·¥ä½œåŒºå¤§å°è¶…è¿‡2MBé™åˆ¶"
            echo "å½“å‰å¤§å°: $((TOTAL_SIZE / 1024))KB"
            echo "é™åˆ¶å¤§å°: 2048KB"
            echo "è¶…å‡º: $((TOTAL_SIZE - SIZE_LIMIT)) å­—èŠ‚ ($((($TOTAL_SIZE - SIZE_LIMIT) / 1024))KB)"
            
            # åˆ é™¤å¤§æ–‡ä»¶
            echo "ğŸ”„ å°è¯•åˆ é™¤å¤§æ–‡ä»¶..."
            find $WORKSPACE -type f -size +500k -exec echo "åˆ é™¤: {}" \; -exec rm -f {} \; 2>/dev/null
            
            # é‡æ–°è®¡ç®—
            TOTAL_SIZE=$(du -sb $WORKSPACE 2>/dev/null | awk '{print $1}' || echo "0")
            echo "æ¸…ç†åå¤§å°: $((TOTAL_SIZE / 1024))KB"
            
            if [ $TOTAL_SIZE -gt $SIZE_LIMIT ]; then
              echo "âŒ ä»ç„¶è¶…è¿‡é™åˆ¶ï¼Œè¯·æ‰‹åŠ¨æ¸…ç†"
              exit 1
            fi
          fi
          
          echo "âœ… å·¥ä½œåŒºå¤§å°æ£€æŸ¥é€šè¿‡: $((TOTAL_SIZE / 1024))KB < 2048KB"
      
      # æ­¥éª¤ 3: ä¸Šä¼ æœ€å°åŒ–æºä»£ç ï¼ˆå¯é€‰ï¼‰
      - name: "3. ä¸Šä¼ æœ€å°åŒ–æºä»£ç "
        if: github.event.inputs.use_git_archive == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: minimal-source-${{ github.event.inputs.device_name }}
          path: ${{ github.workspace }}
          retention-days: 1
      
      # æ­¥éª¤ 4: æœ€ç»ˆéªŒè¯
      - name: "4. æœ€ç»ˆéªŒè¯"
        run: |
          echo "=== æ­¥éª¤ 4: æœ€ç»ˆéªŒè¯ ==="
          
          WORKSPACE="${{ github.workspace }}"
          
          # éªŒè¯å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "ğŸ” éªŒè¯å¿…è¦æ–‡ä»¶..."
          REQUIRED_FILES=(
            "firmware-config/scripts/build_firmware_main.sh"
          )
          
          missing_files=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$WORKSPACE/$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âŒ $file ç¼ºå¤±"
              missing_files=$((missing_files + 1))
            fi
          done
          
          if [ $missing_files -gt 0 ]; then
            echo "âŒ ç¼ºå¤± $missing_files ä¸ªå¿…è¦æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰å¿…è¦æ–‡ä»¶éƒ½å­˜åœ¨"
      
      # æ­¥éª¤ 5: æ£€å‡ºé…ç½®ä»“åº“ï¼ˆå½“ä¸ä½¿ç”¨Git Archiveæ—¶ï¼‰
      - name: "5. æ£€å‡ºé…ç½®ä»“åº“"
        if: github.event.inputs.use_git_archive == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      
      # æ­¥éª¤ 6: æ£€æŸ¥Gitæºä»£ç å¤§å°ï¼ˆæ‰‹åŠ¨æ£€å‡ºæ—¶ï¼‰
      - name: "6. æ£€æŸ¥Gitæºä»£ç å¤§å°ï¼ˆæ‰‹åŠ¨æ£€å‡ºæ—¶ï¼‰"
        if: github.event.inputs.use_git_archive == 'false'
        run: |
          echo "=== æ­¥éª¤ 6: æ£€æŸ¥Gitæºä»£ç å¤§å°ï¼ˆæ‰‹åŠ¨æ£€å‡ºæ—¶ï¼‰==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            firmware-config/scripts/build_firmware_main.sh check_git_source_size
          else
            echo "âš ï¸ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æºä»£ç å¤§å°æ£€æŸ¥"
          fi
      
      # æ­¥éª¤ 7: æ£€æŸ¥å¹¶å‡†å¤‡ç¼–è¯‘å™¨ç›®å½•
      - name: "7. æ£€æŸ¥å¹¶å‡†å¤‡ç¼–è¯‘å™¨ç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 7: æ£€æŸ¥å¹¶å‡†å¤‡ç¼–è¯‘å™¨ç›®å½• ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            firmware-config/scripts/build_firmware_main.sh check_and_prepare_compiler_dir
          else
            echo "âš ï¸ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ç¼–è¯‘å™¨ç›®å½•æ£€æŸ¥"
          fi
      
      # æ­¥éª¤ 8: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      - name: "8. è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™"
        run: |
          echo "=== æ­¥éª¤ 8: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
          find firmware-config/scripts -name "*.sh" -exec chmod +x {} \;
          echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"
      
      # æ­¥éª¤ 9: æ™ºèƒ½æŸ¥æ‰¾æ­£ç¡®çš„ç¼–è¯‘å™¨æ–‡ä»¶
      - name: "9. æ™ºèƒ½æŸ¥æ‰¾æ­£ç¡®çš„ç¼–è¯‘å™¨æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 9: æ™ºèƒ½æŸ¥æ‰¾æ­£ç¡®çš„ç¼–è¯‘å™¨æ–‡ä»¶ ==="
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          REPO_ROOT="${{ github.workspace }}"
          COMPILER_ROOT="$REPO_ROOT/firmware-config/build-Compiler-file"
          
          echo "ğŸ“ ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
          echo "ğŸ”§ ç¼–è¯‘å™¨æ ¹ç›®å½•: $COMPILER_ROOT"
          
          # ç¡®å®šç›®æ ‡å¹³å°
          DEVICE_NAME="${{ github.event.inputs.device_name }}"
          echo "ğŸ¯ è®¾å¤‡åç§°: $DEVICE_NAME"
          
          # æ ¹æ®è®¾å¤‡ç¡®å®šå¹³å°
          case "$DEVICE_NAME" in
            "ac42u"|"acrh17")
              TARGET_PLATFORM="arm"
              TARGET_SUFFIX="arm_cortex-a7"
              echo "ç›®æ ‡å¹³å°: ARM (IPQ40xx)"
              echo "ç›®æ ‡æ¶æ„: $TARGET_SUFFIX"
              ;;
            "mi_router_4a_gigabit"|"r4ag")
              TARGET_PLATFORM="mips"
              TARGET_SUFFIX="mipsel_24kc"
              echo "ç›®æ ‡å¹³å°: MIPS (MT76x8)"
              echo "ç›®æ ‡æ¶æ„: $TARGET_SUFFIX"
              ;;
            "mi_router_3g"|"r3g")
              TARGET_PLATFORM="mips"
              TARGET_SUFFIX="mipsel_24kc"
              echo "ç›®æ ‡å¹³å°: MIPS (MT7621)"
              echo "ç›®æ ‡æ¶æ„: $TARGET_SUFFIX"
              ;;
            *)
              TARGET_PLATFORM="generic"
              TARGET_SUFFIX="generic"
              echo "ç›®æ ‡å¹³å°: é€šç”¨"
              ;;
          esac
          
          # æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$COMPILER_ROOT" ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å™¨æ ¹ç›®å½•ä¸å­˜åœ¨: $COMPILER_ROOT"
            echo "è¯·ç¡®ä¿ firmware-config/build-Compiler-file ç›®å½•å­˜åœ¨"
            echo "å½“å‰ç›®å½•ç»“æ„:"
            ls -la "$REPO_ROOT/firmware-config/" 2>/dev/null || echo "æ— æ³•åˆ—å‡ºç›®å½•"
            exit 1
          fi
          
          echo "âœ… ç¼–è¯‘å™¨æ ¹ç›®å½•å­˜åœ¨"
          
          # æ™ºèƒ½æœç´¢æ­£ç¡®çš„ç¼–è¯‘å™¨
          echo "ğŸ” æ™ºèƒ½æœç´¢ç¼–è¯‘å™¨..."
          COMPILER_DIR=""
          
          # 1. é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…ï¼šå¹³å° + gcc-11.3.0
          if [ "$TARGET_PLATFORM" = "arm" ]; then
            echo "ğŸ” æœç´¢ARMå¹³å°çš„gcc-11.3.0ç¼–è¯‘å™¨..."
            COMPILER_DIR=$(find "$COMPILER_ROOT" -type d -path "*arm*" -name "*gcc-11.3.0*" 2>/dev/null | head -1)
          elif [ "$TARGET_PLATFORM" = "mips" ]; then
            echo "ğŸ” æœç´¢MIPSå¹³å°çš„gcc-11.3.0ç¼–è¯‘å™¨..."
            COMPILER_DIR=$(find "$COMPILER_ROOT" -type d -path "*mips*" -name "*gcc-11.3.0*" 2>/dev/null | head -1)
          fi
          
          # 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•å¹³å° + gcc-11
          if [ -z "$COMPILER_DIR" ] || [ ! -d "$COMPILER_DIR" ]; then
            echo "ğŸ” æœç´¢å¹³å°çš„gcc-11ç¼–è¯‘å™¨..."
            if [ "$TARGET_PLATFORM" = "arm" ]; then
              COMPILER_DIR=$(find "$COMPILER_ROOT" -type d -path "*arm*" -name "*gcc-11*" 2>/dev/null | head -1)
            elif [ "$TARGET_PLATFORM" = "mips" ]; then
              COMPILER_DIR=$(find "$COMPILER_ROOT" -type d -path "*mips*" -name "*gcc-11*" 2>/dev/null | head -1)
            fi
          fi
          
          # 3. å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œå°è¯•ä»»ä½•gcc-11.3.0
          if [ -z "$COMPILER_DIR" ] || [ ! -d "$COMPILER_DIR" ]; then
            echo "ğŸ” æœç´¢ä»»ä½•gcc-11.3.0ç¼–è¯‘å™¨..."
            COMPILER_DIR=$(find "$COMPILER_ROOT" -type d -name "*gcc-11.3.0*" 2>/dev/null | head -1)
          fi
          
          # 4. å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œæœç´¢åŒ…å«binç›®å½•çš„ç¼–è¯‘å™¨
          if [ -z "$COMPILER_DIR" ] || [ ! -d "$COMPILER_DIR" ]; then
            echo "ğŸ” æœç´¢åŒ…å«binç›®å½•çš„ç¼–è¯‘å™¨..."
            BIN_DIRS=$(find "$COMPILER_ROOT" -type d -name "bin" 2>/dev/null | head -5)
            
            for BIN_DIR in $BIN_DIRS; do
              # æ£€æŸ¥binç›®å½•ä¸­æ˜¯å¦æœ‰åŒ¹é…å¹³å°çš„gcc
              if [ "$TARGET_PLATFORM" = "arm" ]; then
                if find "$BIN_DIR" -name "*arm*gcc*" -type f 2>/dev/null | head -1 >/dev/null; then
                  COMPILER_DIR=$(dirname "$BIN_DIR")
                  echo "âœ… æ‰¾åˆ°ARMç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
                  break
                fi
              elif [ "$TARGET_PLATFORM" = "mips" ]; then
                if find "$BIN_DIR" -name "*mips*gcc*" -type f 2>/dev/null | head -1 >/dev/null; then
                  COMPILER_DIR=$(dirname "$BIN_DIR")
                  echo "âœ… æ‰¾åˆ°MIPSç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
                  break
                fi
              fi
            done
          fi
          
          # 5. å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç¼–è¯‘å™¨
          if [ -z "$COMPILER_DIR" ] || [ ! -d "$COMPILER_DIR" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°ç‰¹å®šç¼–è¯‘å™¨ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç¼–è¯‘å™¨..."
            COMPILER_DIR=$(find "$COMPILER_ROOT" -type d -name "*gcc*" 2>/dev/null | head -1)
          fi
          
          # 6. æœ€åå›é€€åˆ°æ ¹ç›®å½•
          if [ -z "$COMPILER_DIR" ] || [ ! -d "$COMPILER_DIR" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•ç¼–è¯‘å™¨ç›®å½•ï¼Œä½¿ç”¨æ ¹ç›®å½•"
            COMPILER_DIR="$COMPILER_ROOT"
          fi
          
          echo "âœ… æœ€ç»ˆç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
          echo "COMPILER_DIR=$COMPILER_DIR" >> $GITHUB_ENV
          
          # éªŒè¯ç¼–è¯‘å™¨
          echo "ğŸ“Š ç¼–è¯‘å™¨éªŒè¯:"
          echo "  è·¯å¾„: $COMPILER_DIR"
          echo "  å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
          
          # æŸ¥æ‰¾GCC
          GCC_PATH=$(find "$COMPILER_DIR" -type f -name "*gcc*" -executable 2>/dev/null | head -1)
          
          if [ -n "$GCC_PATH" ]; then
            echo "âœ… æ‰¾åˆ°å¯æ‰§è¡ŒGCC: $GCC_PATH"
            GCC_NAME=$(basename "$GCC_PATH")
            
            # æ£€æŸ¥å¹³å°åŒ¹é…
            if [ "$TARGET_PLATFORM" = "arm" ]; then
              if [[ "$GCC_NAME" == *arm* ]] || [[ "$GCC_NAME" == *aarch64* ]]; then
                echo "  ğŸ¯ GCCä¸ç›®æ ‡å¹³å°(ARM)åŒ¹é…"
              else
                echo "  âš ï¸  GCCå¹³å°ä¸åŒ¹é…: $GCC_NAME (æœŸæœ›: ARM)"
              fi
            elif [ "$TARGET_PLATFORM" = "mips" ]; then
              if [[ "$GCC_NAME" == *mips* ]] || [[ "$GCC_NAME" == *mipsel* ]]; then
                echo "  ğŸ¯ GCCä¸ç›®æ ‡å¹³å°(MIPS)åŒ¹é…"
              else
                echo "  âš ï¸  GCCå¹³å°ä¸åŒ¹é…: $GCC_NAME (æœŸæœ›: MIPS)"
              fi
            fi
            
            # è·å–GCCç‰ˆæœ¬
            if "$GCC_PATH" --version 2>&1 | head -1 >/dev/null 2>&1; then
              VERSION=$("$GCC_PATH" --version 2>&1 | head -1)
              echo "  ç‰ˆæœ¬: $VERSION"
              
              # æ£€æŸ¥æ˜¯å¦æ˜¯gcc 11.xç‰ˆæœ¬
              if [[ "$VERSION" == *"11."* ]]; then
                echo "  âœ… ç‰ˆæœ¬æ­£ç¡®: GCC 11.x"
              else
                echo "  âš ï¸  ç‰ˆæœ¬ä¸æ˜¯GCC 11.x: $VERSION"
              fi
            else
              echo "  âš ï¸ æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯"
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œçš„GCCç¼–è¯‘å™¨"
            echo "  åœ¨ç›®å½• $COMPILER_DIR ä¸­æœç´¢:"
            find "$COMPILER_DIR" -type f -name "*gcc*" 2>/dev/null | head -5
          fi
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«binç›®å½•
          if [ -d "$COMPILER_DIR/bin" ]; then
            echo "âœ… ç¼–è¯‘å™¨åŒ…å«binç›®å½•"
            echo "ğŸ”§ binç›®å½•å†…å®¹(å‰10ä¸ª):"
            ls "$COMPILER_DIR/bin" | head -10
          fi
          
          echo "âœ… ç¼–è¯‘å™¨æŸ¥æ‰¾å®Œæˆ"
      
      # æ­¥éª¤ 10: åˆå§‹ç©ºé—´æ£€æŸ¥
      - name: "10. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 10: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
            exit 1
          fi
          echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"
      
      # æ­¥éª¤ 11: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•
      - name: "11. è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 11: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½• ==="
          
          echo "ğŸ”„ æ­¥éª¤ 11.1: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          firmware-config/scripts/build_firmware_main.sh setup_environment
          
          echo "ğŸ”„ æ­¥éª¤ 11.2: åˆ›å»ºæ„å»ºç›®å½•"
          firmware-config/scripts/build_firmware_main.sh create_build_dir
          
          echo "ğŸ”„ æ­¥éª¤ 11.3: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•è®¾ç½®å®Œæˆ"
      
      # æ­¥éª¤ 12: æ·»åŠ  TurboACC æ”¯æŒ
      - name: "12. æ·»åŠ  TurboACC æ”¯æŒ"
        run: |
          echo "=== æ­¥éª¤ 12: æ·»åŠ  TurboACC æ”¯æŒ ==="
          firmware-config/scripts/build_firmware_main.sh add_turboacc_support
      
      # æ­¥éª¤ 13: é…ç½®Feeds
      - name: "13. é…ç½®Feeds"
        run: |
          echo "=== æ­¥éª¤ 13: é…ç½®Feeds ==="
          firmware-config/scripts/build_firmware_main.sh configure_feeds
      
      # æ­¥éª¤ 14: å®‰è£… TurboACC åŒ…
      - name: "14. å®‰è£… TurboACC åŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤ 14: å®‰è£… TurboACC åŒ… ==="
          firmware-config/scripts/build_firmware_main.sh install_turboacc_packages
      
      # æ­¥éª¤ 15: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "15. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 15: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh pre_build_space_check
      
      # æ­¥éª¤ 16: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
      - name: "16. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 16: æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          echo "ğŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨å¼ºåˆ¶å¯ç”¨"
          firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤ 17: éªŒè¯USBé…ç½®
      - name: "17. éªŒè¯USBé…ç½®"
        run: |
          echo "=== æ­¥éª¤ 17: éªŒè¯USBé…ç½® ==="
          firmware-config/scripts/build_firmware_main.sh verify_usb_config
      
      # æ­¥éª¤ 18: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "18. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 18: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity
      
      # æ­¥éª¤ 19: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "19. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== æ­¥éª¤ 19: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          
          # å…ˆä¿å­˜åŸå§‹é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            cp "${{ env.BUILD_DIR }}/.config" "${{ env.BUILD_DIR }}/.config.original"
            echo "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶"
          fi
          
          # åº”ç”¨é…ç½®
          firmware-config/scripts/build_firmware_main.sh apply_config
          
          echo "âœ… é…ç½®è¯¦æƒ…æ£€æŸ¥å®Œæˆ"
      
      # æ­¥éª¤ 20: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "20. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 20: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
            mkdir -p firmware-config/config-backup
            
            # å¤‡ä»½åˆ°ä»“åº“ç›®å½•
            backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
            
            cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      # æ­¥éª¤ 21: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "21. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤ 21: ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          firmware-config/scripts/build_firmware_main.sh fix_network
      
      # æ­¥éª¤ 22: ä¸‹è½½ä¾èµ–åŒ…
      - name: "22. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== æ­¥éª¤ 22: ä¸‹è½½ä¾èµ–åŒ… ==="
          firmware-config/scripts/build_firmware_main.sh download_dependencies
      
      # æ­¥éª¤ 23: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "23. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 23: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          firmware-config/scripts/build_firmware_main.sh integrate_custom_files
      
      # æ­¥éª¤ 24: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆåŒ…å«ç¼–è¯‘å™¨éªŒè¯ï¼‰
      - name: "24. å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆåŒ…å«ç¼–è¯‘å™¨éªŒè¯ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 24: å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh pre_build_error_check
      
      # æ­¥éª¤ 25: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "25. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 25: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          # æ£€æŸ¥ç¼–è¯‘æ‰€éœ€ç©ºé—´
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
      
      # æ­¥éª¤ 26: ç¼–è¯‘å›ºä»¶ï¼ˆä½¿ç”¨æ”¹è¿›çš„ç¼–è¯‘å™¨æœç´¢å’Œè°ƒç”¨ï¼‰
      - name: "26. ç¼–è¯‘å›ºä»¶ï¼ˆä½¿ç”¨æ”¹è¿›çš„ç¼–è¯‘å™¨æœç´¢å’Œè°ƒç”¨ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 26: ç¼–è¯‘å›ºä»¶ ==="
          echo "ğŸ”§ ä½¿ç”¨æ”¹è¿›çš„ç¼–è¯‘å™¨æœç´¢å’Œè°ƒç”¨åŠŸèƒ½..."
          
          # æ˜¾ç¤ºç¼–è¯‘å™¨ä¿¡æ¯
          echo "ğŸ“Œ ç¼–è¯‘å™¨è°ƒç”¨ä¿¡æ¯:"
          echo "  ç¼–è¯‘å™¨æ ¹ç›®å½•: ${{ env.COMPILER_ROOT }}"
          echo "  ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}"
          
          # éªŒè¯ç¼–è¯‘å™¨å®Œæ•´æ€§
          echo "ğŸ” éªŒè¯ç¼–è¯‘å™¨..."
          firmware-config/scripts/build_firmware_main.sh verify_compiler_files
          
          # æ£€æŸ¥ç¼–è¯‘å™¨è°ƒç”¨çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥ç¼–è¯‘å™¨è°ƒç”¨çŠ¶æ€..."
          firmware-config/scripts/build_firmware_main.sh check_compiler_invocation
          
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼Œå°†å°è¯•è°ƒç”¨é¢„æ„å»ºç¼–è¯‘å™¨..."
          
          # å¯ç”¨ç¼–è¯‘ç¼“å­˜ï¼Œä½¿ç”¨å¹¶è¡Œç¼–è¯‘
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          firmware-config/scripts/build_firmware_main.sh build_firmware "true"
      
      # æ­¥éª¤ 27: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: "27. æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 27: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰© ==="
          cd ${{ env.BUILD_DIR }}
          
          # åˆ›å»ºæ„å»ºäº§ç‰©ç›®å½•
          mkdir -p /tmp/build-artifacts
          
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ–‡ä»¶ï¼Œé¿å…é‡å¤ä¸Šä¼ 
          echo "ğŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ„å»ºäº§ç‰©..."
          need_upload=false
          
          # æ‰“åŒ…å›ºä»¶æ–‡ä»¶
          if [ -d "bin/targets" ]; then
            echo "æ‰“åŒ…å›ºä»¶æ–‡ä»¶..."
            tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°
            firmware_size=$(stat -c%s /tmp/build-artifacts/firmware.tar.gz 2>/dev/null || echo "0")
            if [ $firmware_size -gt 0 ]; then
              echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆï¼Œå¤§å°: $(du -h /tmp/build-artifacts/firmware.tar.gz | cut -f1)"
              need_upload=true
            else
              echo "âš ï¸ å›ºä»¶æ‰“åŒ…å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            fi
          else
            echo "âš ï¸ bin/targetsç›®å½•ä¸å­˜åœ¨"
          fi
          
          # æ‰“åŒ…ç¼–è¯‘æ—¥å¿—
          if [ -f "build.log" ]; then
            echo "æ‰“åŒ…ç¼–è¯‘æ—¥å¿—..."
            cp build.log /tmp/build-artifacts/build.log
            echo "âœ… æ—¥å¿—æ‰“åŒ…å®Œæˆ"
            need_upload=true
          fi
          
          # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
          echo "æ„å»ºæ—¶é—´: $(date)" > /tmp/build-artifacts/build-info.txt
          echo "è®¾å¤‡: ${{ env.DEVICE }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/build-info.txt
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}" >> /tmp/build-artifacts/build-info.txt
          
          if [ "$need_upload" = true ]; then
            echo "âœ… æ„å»ºäº§ç‰©å‡†å¤‡å®Œæˆ"
            echo "ğŸ“¤ æ„å»ºäº§ç‰©å·²ä¿å­˜åœ¨: /tmp/build-artifacts/"
            ls -lh /tmp/build-artifacts/
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„æ„å»ºäº§ç‰©"
          fi
      
      # æ­¥éª¤ 28: ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•
      - name: "28. ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
      
      # æ­¥éª¤ 29: ä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "29. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      # æ­¥éª¤ 30: é”™è¯¯åˆ†æ
      - name: "30. é”™è¯¯åˆ†æ"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 30: é”™è¯¯åˆ†æ ==="
          firmware-config/scripts/error_analysis.sh
      
      # æ­¥éª¤ 31: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "31. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 31: ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh post_build_space_check
