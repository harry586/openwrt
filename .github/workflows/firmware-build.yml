name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ï¼šâœ… æ–‡ä»¶ä¼ è¾“ã€‚
          
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ ã€‚
        required: true
        type: choice
        default: 'normal'
        options:
        - 'base'
        - 'normal'
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šğŸ”´ç”¨é¡¿å·ã€åˆ†éš”ã€‚ğŸ”´ å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ğŸ”´ ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚ğŸ”´ ç¤ºä¾‹ï¼š+luci-app-wolã€+luci-app-ddns
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)'
        required: false
        default: true
        type: boolean
      skip_toolchain:
        description: 'â­ï¸ è·³è¿‡å·¥å…·é“¾ç¼“å­˜ (ç›´æ¥ä½¿ç”¨ç³»ç»Ÿå·¥å…·é“¾)'
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  TOOLCHAIN_BASE: ./firmware-config/build-tools

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        find . -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
        echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 30 ]; then
          echo "è­¦å‘Š: /mnt ç©ºé—´ä¸è¶³30Gï¼Œå¯èƒ½ç¼–è¯‘å¤±è´¥"
        fi

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        firmware-config/scripts/build_firmware_main.sh setup_environment

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        firmware-config/scripts/build_firmware_main.sh create_build_dir

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      id: init_env
      run: |
        echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
        firmware-config/scripts/build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"
        
        # è·å–ç¯å¢ƒå˜é‡
        source /mnt/openwrt-build/build_env.sh 2>/dev/null || echo "ç¯å¢ƒæ–‡ä»¶æœªç”Ÿæˆ"
        echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
        echo "SUBTARGET=$SUBTARGET" >> $GITHUB_OUTPUT
        echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_OUTPUT

    - name: åˆå§‹åŒ–å·¥å…·é“¾ç³»ç»Ÿ
      if: github.event.inputs.skip_toolchain == 'false'
      run: |
        echo "=== åˆå§‹åŒ–å·¥å…·é“¾ç³»ç»Ÿ ==="
        # åˆ›å»ºåŸºç¡€ç›®å½•ç»“æ„
        mkdir -p firmware-config/build-tools/{common,platforms,versions,cache,logs,archives}
        echo "å·¥å…·é“¾ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"

    - name: é…ç½®Feeds
      run: |
        echo "=== é…ç½®Feeds ==="
        firmware-config/scripts/build_firmware_main.sh configure_feeds

    - name: æ·»åŠ TurboACCæ”¯æŒ
      if: github.event.inputs.config_mode == 'normal' && steps.init_env.outputs.SELECTED_BRANCH == 'openwrt-23.05'
      run: |
        firmware-config/scripts/build_firmware_main.sh add_turboacc_support

    - name: å®‰è£…TurboACCåŒ…
      if: github.event.inputs.config_mode == 'normal' && steps.init_env.outputs.SELECTED_BRANCH == 'openwrt-23.05'
      run: |
        firmware-config/scripts/build_firmware_main.sh install_turboacc_packages

    - name: å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶åŒ…
      run: |
        firmware-config/scripts/build_firmware_main.sh install_filetransfer_packages

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        firmware-config/scripts/build_firmware_main.sh pre_build_space_check

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      run: |
        firmware-config/scripts/build_firmware_main.sh generate_config \
          "${{ github.event.inputs.extra_packages }}"

    - name: éªŒè¯USBé…ç½®
      run: |
        firmware-config/scripts/build_firmware_main.sh verify_usb_config

    - name: åº”ç”¨é…ç½®
      run: |
        firmware-config/scripts/build_firmware_main.sh apply_config

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        firmware-config/scripts/build_firmware_main.sh fix_network

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        firmware-config/scripts/build_firmware_main.sh download_dependencies

    - name: å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶
      run: |
        firmware-config/scripts/build_firmware_main.sh process_custom_files

    - name: ç¼–è¯‘å›ºä»¶
      id: build_step
      run: |
        firmware-config/scripts/build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"

    - name: é”™è¯¯åˆ†æ
      if: always()
      run: |
        firmware-config/scripts/error_analysis.sh

    - name: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      run: |
        firmware-config/scripts/build_firmware_main.sh post_build_space_check

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: steps.build_step.outcome == 'success'
      run: |
        firmware-config/scripts/build_firmware_main.sh check_firmware_files

    - name: å¤‡ä»½é…ç½®æ–‡ä»¶
      if: always()
      run: |
        firmware-config/scripts/build_firmware_main.sh backup_config

    - name: ä¸Šä¼ å›ºä»¶
      if: steps.build_step.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ steps.init_env.outputs.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/build.log
          ${{ env.BUILD_DIR }}/error_analysis.log
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}
        path: ${{ env.BUILD_DIR }}/config_backup/
        retention-days: 7

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        firmware-config/scripts/build_firmware_main.sh cleanup
