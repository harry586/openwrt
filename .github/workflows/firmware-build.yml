name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, acrh17, r3gç­‰)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©"
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ (ç”¨åˆ†å·åˆ†éš”)"
        required: false
        type: string
        default: ""
      enable_cache:
        description: "âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜"
        required: false
        default: true
        type: boolean
      save_toolchain:
        description: "ğŸ’¾ ä¿å­˜é€šç”¨å·¥å…·é“¾"
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  GIT_LFS_SKIP_SMUDGE: 1
  ENABLE_CACHE: "true"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: "ğŸ“¥ 1. æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤2ï¼šè¿è¡Œä¿®å¤è„šæœ¬
      - name: "ğŸ”§ 2. è¿è¡Œä¿®å¤è„šæœ¬"
        run: |
          echo "=== è¿è¡Œä¿®å¤è„šæœ¬ ==="
          if [ -f "firmware-config/scripts/fix-build.sh" ]; then
            chmod +x firmware-config/scripts/fix-build.sh
            firmware-config/scripts/fix-build.sh || echo "ä¿®å¤è„šæœ¬æ‰§è¡Œå®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä¿®å¤è„šæœ¬ï¼Œåˆ›å»ºå¿…è¦ç›®å½•"
            mkdir -p firmware-config/scripts
            mkdir -p firmware-config/Toolchain
            mkdir -p .github/workflows
          fi
      
      # æ­¥éª¤3ï¼šå‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: "ğŸ“ 3. å‡†å¤‡ç¯å¢ƒ"
        run: |
          echo "=== å‡†å¤‡æ„å»ºç¯å¢ƒ ==="
          sudo mkdir -p /mnt/openwrt-build
          sudo chmod 777 /mnt/openwrt-build
          mkdir -p /tmp/build-artifacts
      
      # æ­¥éª¤4ï¼šè®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      - name: "ğŸ› ï¸ 4. è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
        run: |
          echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step8_setup_environment
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤5ï¼šåˆ›å»ºæ„å»ºç›®å½•
      - name: "ğŸ“ 5. åˆ›å»ºæ„å»ºç›®å½•"
        run: |
          echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step9_create_build_dir
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤6ï¼šæ£€æŸ¥å·¥å…·é“¾ç›®å½•
      - name: "ğŸ—‚ï¸ 6. æ£€æŸ¥å·¥å…·é“¾ç›®å½•"
        run: |
          echo "=== æ£€æŸ¥å·¥å…·é“¾ç›®å½• ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step6_check_toolchain_dir
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤7ï¼šä¸‹è½½æºä»£ç 
      - name: "ğŸ“¥ 7. ä¸‹è½½æºä»£ç "
        run: |
          echo "=== ä¸‹è½½æºä»£ç  ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            # æ”¹ä¸ºæ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨æºä»£ç ï¼Œè€Œä¸æ˜¯é‡å¤å…‹éš†
            if [ ! -d "/mnt/openwrt-build/openwrt" ]; then
              firmware-config/scripts/build_firmware_main.sh workflow_main step1_download_source "/mnt/openwrt-build"
            else
              echo "âœ… æºä»£ç å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½"
            fi
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤8ï¼šä¸Šä¼ æºä»£ç å‹ç¼©åŒ…
      - name: "ğŸ“¤ 8. ä¸Šä¼ æºä»£ç å‹ç¼©åŒ…"
        run: |
          echo "=== ä¸Šä¼ æºä»£ç å‹ç¼©åŒ… ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step2_upload_source
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤9ï¼šä¸Šä¼ æºä»£ç å‹ç¼©åŒ…åˆ°Artifacts
      - name: "ğŸ“¦ 9. ä¸Šä¼ æºä»£ç å‹ç¼©åŒ…åˆ°Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: "source-code-${{ github.event.inputs.device_name }}-${{ github.run_id }}"
          path: /tmp/source-upload/
      
      # æ­¥éª¤10ï¼šåˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      - name: "ğŸš€ 10. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step10_init_build_env \
              "${{ github.event.inputs.device_name }}" \
              "${{ github.event.inputs.version_selection }}" \
              "${{ github.event.inputs.config_mode }}" \
              "${{ github.event.inputs.extra_packages }}"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤11ï¼šæ˜¾ç¤ºé…ç½®
      - name: "âš¡ 11. æ˜¾ç¤ºé…ç½®"
        run: |
          echo "=== æ˜¾ç¤ºé…ç½® ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step11_show_config
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤12ï¼šæ·»åŠ TurboACCæ”¯æŒ
      - name: "ğŸ”Œ 12. æ·»åŠ TurboACCæ”¯æŒ"
        if: github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ·»åŠ TurboACCæ”¯æŒ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step12_add_turboacc_support
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤13ï¼šé…ç½®Feeds
      - name: "ğŸ“¦ 13. é…ç½®Feeds"
        run: |
          echo "=== é…ç½®Feeds ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step13_configure_feeds
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤14ï¼šå®‰è£…TurboACCåŒ…
      - name: "ğŸ”§ 14. å®‰è£…TurboACCåŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== å®‰è£…TurboACCåŒ… ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step14_install_turboacc_packages
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤15ï¼šç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 15. ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== ç©ºé—´æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step15_pre_build_space_check
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤16ï¼šç”Ÿæˆé…ç½®
      - name: "âš™ï¸ 16. ç”Ÿæˆé…ç½®"
        run: |
          echo "=== ç”Ÿæˆé…ç½® ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step16_generate_config "${{ github.event.inputs.extra_packages }}"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤17ï¼šéªŒè¯USBé…ç½®
      - name: "ğŸ” 17. éªŒè¯USBé…ç½®"
        run: |
          echo "=== éªŒè¯USBé…ç½® ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step17_verify_usb_config
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤18ï¼šUSBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "ğŸ›¡ï¸ 18. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step18_check_usb_drivers_integrity
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤19ï¼šåº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "âœ… 19. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step19_apply_config
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤20ï¼šå¤‡ä»½é…ç½®
      - name: "ğŸ’¾ 20. å¤‡ä»½é…ç½®"
        run: |
          echo "=== å¤‡ä»½é…ç½® ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step20_backup_config
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤21ï¼šä¿®å¤ç½‘ç»œ
      - name: "ğŸŒ 21. ä¿®å¤ç½‘ç»œ"
        run: |
          echo "=== ä¿®å¤ç½‘ç»œ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step21_fix_network
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤22ï¼šåŠ è½½å·¥å…·é“¾
      - name: "ğŸ”§ 22. åŠ è½½å·¥å…·é“¾"
        run: |
          echo "=== åŠ è½½å·¥å…·é“¾ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step22_load_toolchain
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤23ï¼šæ£€æŸ¥å·¥å…·é“¾çŠ¶æ€
      - name: "ğŸ“Š 23. æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€"
        run: |
          echo "=== æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step23_check_toolchain_status
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤24ï¼šä¸‹è½½ä¾èµ–åŒ…
      - name: "ğŸ“¥ 24. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step24_download_dependencies
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤25ï¼šé›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "ğŸ”Œ 25. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step25_integrate_custom_files
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤26ï¼šå‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "ğŸš¨ 26. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          echo "=== å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step26_pre_build_error_check
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤27ï¼šæœ€ç»ˆç©ºé—´æ£€æŸ¥
      - name: "ğŸ’½ 27. æœ€ç»ˆç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æœ€ç»ˆç©ºé—´æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step27_final_space_check
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤28ï¼šç¼–è¯‘å›ºä»¶
      - name: "ğŸ”¨ 28. ç¼–è¯‘å›ºä»¶"
        run: |
          echo "=== ç¼–è¯‘å›ºä»¶ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step28_build_firmware
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤29ï¼šä¿å­˜é€šç”¨å·¥å…·é“¾
      - name: "ğŸ’¾ 29. ä¿å­˜é€šç”¨å·¥å…·é“¾"
        if: github.event.inputs.save_toolchain == 'true' && success()
        run: |
          echo "=== ä¿å­˜é€šç”¨å·¥å…·é“¾ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step29_save_essential_toolchain
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤30ï¼šæäº¤ä¿®å¤ç»“æœ
      - name: "ğŸ’¾ 30. æäº¤ä¿®å¤ç»“æœåˆ°ä»“åº“"
        if: steps.smart_fix.outputs.fix_script_status == 'success' && success()
        run: |
          echo "=== æäº¤ä¿®å¤ç»“æœ ==="
          
          cd "${{ github.workspace }}"
          
          # æ£€æŸ¥GitçŠ¶æ€
          git status --porcelain | head -20
          
          CHANGED_FILES=$(git status --porcelain | grep -E "\.(sh|yml|md)$" | wc -l)
          
          if [ $CHANGED_FILES -gt 0 ]; then
            echo "æ£€æµ‹åˆ° $CHANGED_FILES ä¸ªæ–‡ä»¶æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
            
            # é…ç½®Git
            git config --global user.name "GitHub Actions Bot"
            git config --global user.email "actions@github.com"
            
            # æ·»åŠ æ›´æ”¹
            git add -A
            
            # åˆ›å»ºæäº¤ä¿¡æ¯
            COMMIT_MSG="fix: è‡ªåŠ¨ä¿®å¤æ›´æ–° [$(date '+%Y-%m-%d %H:%M:%S')]
            
            ä¿®å¤å†…å®¹:
            - è·¯å¾„é—®é¢˜ä¿®å¤
            - è„šæœ¬æƒé™ä¿®å¤
            - é…ç½®æ–‡ä»¶ä¼˜åŒ–
            ä¿®å¤è„šæœ¬çŠ¶æ€: ${{ steps.smart_fix.outputs.fix_script_status }}
            è®¾å¤‡: ${{ github.event.inputs.device_name }}
            æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
            
            # æäº¤æ›´æ”¹
            if git commit -m "$COMMIT_MSG"; then
              echo "æ›´æ”¹å·²æäº¤åˆ°æœ¬åœ°ä»“åº“"
              
              # å°è¯•æ¨é€
              for i in {1..3}; do
                echo "æ¨é€å°è¯• #$i/3"
                if git push; then
                  echo "ä¿®å¤ç»“æœå·²æˆåŠŸæ¨é€åˆ°è¿œç¨‹ä»“åº“"
                  break
                else
                  echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•"
                  sleep 10
                fi
              done
            else
              echo "æäº¤å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
            fi
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          fi
      
      # æ­¥éª¤31ï¼šæ„å»ºåˆ†æï¼ˆæˆåŠŸå’Œå¤±è´¥éƒ½è¿è¡Œï¼‰
      - name: "ğŸ“Š 31. æ„å»ºåˆ†æ"
        if: always()
        run: |
          echo "=== æ„å»ºåˆ†æ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step31_build_analysis "${{ job.status }}"
          else
            echo "æ‰§è¡ŒåŸºæœ¬æ„å»ºåˆ†æ..."
            echo "åˆ†ææ—¶é—´: $(date)"
            echo "æ„å»ºçŠ¶æ€: ${{ job.status }}"
            echo ""
            echo "=== ç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
            df -h
            echo ""
            echo "=== å†…å­˜ä½¿ç”¨æƒ…å†µ ==="
            free -h
          fi
      
      # æ­¥éª¤32ï¼šç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "ğŸ“Š 32. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step32_post_build_space_check
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤33ï¼šå›ºä»¶æ–‡ä»¶æ£€æŸ¥
      - name: "ğŸ“¦ 33. å›ºä»¶æ–‡ä»¶æ£€æŸ¥"
        if: success()
        run: |
          echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step33_check_firmware_files
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºè„šæœ¬"
            exit 1
          fi
      
      # æ­¥éª¤34ï¼šä¸Šä¼ å›ºä»¶
      - name: "â¬†ï¸ 34. ä¸Šä¼ å›ºä»¶"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: "firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH || 'unknown' }}-${{ github.event.inputs.config_mode }}"
          path: /mnt/openwrt-build/bin/targets/
          retention-days: 30
      
      # æ­¥éª¤35ï¼šä¸Šä¼ æ—¥å¿—
      - name: "â¬†ï¸ 35. ä¸Šä¼ æ—¥å¿—"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "build-log-${{ github.event.inputs.device_name }}-${{ github.run_id }}"
          path: /mnt/openwrt-build/build.log
          retention-days: 30
      
      # æ­¥éª¤36ï¼šä¸Šä¼ é…ç½®
      - name: "â¬†ï¸ 36. ä¸Šä¼ é…ç½®"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "config-${{ github.event.inputs.device_name }}-${{ github.run_id }}"
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 30
      
      # æ­¥éª¤37ï¼šæ¸…ç†ç›®å½•
      - name: "ğŸ§¹ 37. æ¸…ç†ç›®å½•"
        if: always()
        run: |
          echo "=== æ¸…ç†ç›®å½• ==="
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            firmware-config/scripts/build_firmware_main.sh workflow_main step37_cleanup
          else
            echo "åŸºæœ¬æ¸…ç†"
            if [ -d "/mnt/openwrt-build" ]; then
              echo "æ¸…ç†æ„å»ºç›®å½•"
              sudo rm -rf /mnt/openwrt-build/* 2>/dev/null || true
            fi
          fi
      
      # æ­¥éª¤38ï¼šæœ€ç»ˆæ€»ç»“
      - name: "ğŸ“ˆ 38. æœ€ç»ˆæ€»ç»“"
        if: always()
        run: |
          echo "=== æ„å»ºæ€»ç»“ ==="
          echo "æ„å»ºçŠ¶æ€: ${{ job.status }}"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "å¯ç”¨ç¼“å­˜: ${{ github.event.inputs.enable_cache }}"
          echo "ä¿å­˜é€šç”¨å·¥å…·é“¾: ${{ github.event.inputs.save_toolchain }}"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… æ„å»ºæˆåŠŸ"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
          fi
