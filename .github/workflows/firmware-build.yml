# .github/workflows/firmware-build.yml
name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

# å…³é”®ï¼šæ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write    # å…è®¸å†™å…¥ä»“åº“ï¼ˆä¸Šä¼ Artifactsï¼‰
  actions: write     # å…è®¸è§¦å‘å·¥ä½œæµï¼ˆå¦‚æœéœ€è¦é€’å½’è§¦å‘ï¼‰
  checks: write      # å…è®¸åˆ›å»ºæ£€æŸ¥çŠ¶æ€
  deployments: write # å…è®¸åˆ›å»ºéƒ¨ç½²çŠ¶æ€

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (è‡ªåŠ¨ä» support.sh åŒæ­¥è®¾å¤‡åˆ—è¡¨)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© - ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ã€‚ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®"
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "ğŸ“¦ é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚"
        required: false
        type: string
        default: ""
      enable_parallel:
        description: "âš¡ å¯ç”¨æ™ºèƒ½å¹¶è¡Œä¼˜åŒ– (è‡ªåŠ¨åˆ¤æ–­æœ€ä½³ä»»åŠ¡æ•°)"
        required: false
        type: choice
        default: "true"
        options: ["true", "false"]
      web_session_id:
        description: "ğŸ”‘ ç½‘é¡µä¼šè¯ID (ç”¨äºè·Ÿè¸ª)"
        required: false
        type: string
        default: ""

env:
  BUILD_DIR: "/mnt/openwrt-build"
  REPO_ROOT: "${{ github.workspace }}"
  ENABLE_PARALLEL: "${{ github.event.inputs.enable_parallel }}"
  WEB_SESSION_ID: "${{ github.event.inputs.web_session_id }}"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # ============ æ˜¾ç¤ºæ„å»ºå‚æ•° ============
      - name: "ğŸ“‹ æ˜¾ç¤ºæ„å»ºå‚æ•°"
        run: |
          echo "=================================================="
          echo "ğŸ¯ OpenWrt å›ºä»¶æ„å»ºå·¥ä½œæµ"
          echo "=================================================="
          echo ""
          echo "ğŸ“± è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ğŸ”„ ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "âš™ï¸ æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "ğŸ“¦ æ’ä»¶: ${{ github.event.inputs.extra_packages }}"
          echo "âš¡ å¹¶è¡Œ: ${{ github.event.inputs.enable_parallel }}"
          echo "ğŸ”‘ ä¼šè¯ID: ${{ env.WEB_SESSION_ID }}"
          echo ""
          
          # ç”Ÿæˆå”¯ä¸€æ„å»ºID
          TIMESTAMP="$(date -u +'%Y%m%d_%H%M%S')"
          BUILD_ID="build_${TIMESTAMP}_$(openssl rand -hex 4)"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "BUILD_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          
          echo "ğŸ†” æ„å»ºID: $BUILD_ID"
          echo "ğŸ“… æ—¶é—´æˆ³: $TIMESTAMP"
          echo "ğŸ”— å·¥ä½œæµURL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "=================================================="
      
      # æ­¥éª¤ 0: ç”Ÿæˆæ—¶é—´æˆ³
      - name: "0. ç”Ÿæˆæ—¶é—´æˆ³"
        run: |
          echo "=== æ­¥éª¤ 0: ç”Ÿæˆæ—¶é—´æˆ³ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ç”Ÿæˆæ—¥æœŸæ ¼å¼çš„æ—¶é—´æˆ³ï¼ˆå¹´æœˆæ—¥ï¼‰
          BASE_DATE=$(date -u +'%Y%m%d')
          
          # å¦‚æœå·²ç»ç”Ÿæˆäº†æ„å»ºIDï¼Œä½¿ç”¨å®ƒ
          if [ -n "$BUILD_ID" ]; then
            TIMESTAMP="$BUILD_ID"
          else
            TIMESTAMP="${{ github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}-$BASE_DATE"
          fi
          
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          
          echo "âœ… æ—¶é—´æˆ³: $TIMESTAMP"
          echo "ğŸ“‹ æ„å»ºé…ç½®:"
          echo "  è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "  ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "  æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "  å¹¶è¡Œä¼˜åŒ–: ${{ github.event.inputs.enable_parallel }}"
          echo "  ä¼šè¯ID: ${{ env.WEB_SESSION_ID }}"
          
          echo "ğŸŸ¢ æ­¥éª¤ 0 å®Œæˆ"
      
      # æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç 
      - name: "1. ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        run: |
          echo "=== æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç  ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 1 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          
          # è·å–é»˜è®¤åˆ†æ”¯
          echo "ğŸ” è·å–ä»“åº“é»˜è®¤åˆ†æ”¯..."
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "âœ… é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
          
          # ä½¿ç”¨Git Archive APIä¸‹è½½å‹ç¼©åŒ…
          echo "ğŸ“¥ ä¸‹è½½æºä»£ç å‹ç¼©åŒ…..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" -o source.tar.gz
          
          if [ ! -f "source.tar.gz" ]; then
            echo "âŒ é”™è¯¯: ä¸‹è½½æºä»£ç å‹ç¼©åŒ…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(ls -lh source.tar.gz | awk '{print $5}')"
          
          # è§£å‹å‹ç¼©åŒ…
          echo "ğŸ“¦ è§£å‹æºä»£ç ..."
          tar -xzf source.tar.gz --strip-components=1
          
          # æ£€æŸ¥è§£å‹ç»“æœ
          echo "ğŸ” æ£€æŸ¥è§£å‹ç»“æœ..."
          
          # å¿…é¡»å­˜åœ¨çš„æ–‡ä»¶
          REQUIRED_FILES=("firmware-config/scripts/build_firmware_main.sh" "support.sh")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… å…³é”®æ–‡ä»¶å­˜åœ¨: $file"
            else
              echo "âŒ é”™è¯¯: å…³é”®æ–‡ä»¶ä¸å­˜åœ¨: $file"
              echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
              ls -la
              exit 1
            fi
          done
          
          echo "ğŸ“ å¤åˆ¶æ–‡ä»¶åˆ°å¤šä¸ªä½ç½®..."
          
          # 1. å¤åˆ¶åˆ° GitHub å·¥ä½œåŒº
          echo "ğŸ”§ å¤åˆ¶åˆ° GitHub å·¥ä½œåŒº..."
          mkdir -p ${{ github.workspace }}
          cp -r ./* ${{ github.workspace }}/ 2>/dev/null || true
          echo "âœ… GitHub å·¥ä½œåŒºå¤åˆ¶å®Œæˆ"
          
          # 2. å…³é”®æ–‡ä»¶å¤åˆ¶åˆ°æ„å»ºç›®å½•
          echo "ğŸ”§ å‡†å¤‡å¤åˆ¶å…³é”®æ–‡ä»¶åˆ°æ„å»ºç›®å½•..."
          
          # é¦–å…ˆå°è¯•åœ¨ /mnt ä¸‹åˆ›å»ºç›®å½•ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨ /tmp
          if sudo mkdir -p /mnt/openwrt-build 2>/dev/null; then
            echo "âœ… ä½¿ç”¨ sudo åœ¨ /mnt åˆ›å»ºæ„å»ºç›®å½•æˆåŠŸ"
            sudo chmod 777 /mnt/openwrt-build
            BUILD_DIR="/mnt/openwrt-build"
          else
            echo "âš ï¸ æ— æ³•åœ¨ /mnt ä¸‹åˆ›å»ºç›®å½•ï¼Œå°†ä½¿ç”¨ /tmp ç›®å½•"
            BUILD_DIR="/tmp/openwrt-build"
            mkdir -p "$BUILD_DIR"
            echo "ğŸ“Œ ä½¿ç”¨å¤‡ç”¨æ„å»ºç›®å½•: $BUILD_DIR"
          fi
          
          # æ›´æ–°ç¯å¢ƒå˜é‡
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "ğŸ“Œ æœ€ç»ˆæ„å»ºç›®å½•: $BUILD_DIR"
          
          # å¤åˆ¶ support.sh åˆ°æ„å»ºç›®å½•
          if [ -f "support.sh" ]; then
            cp support.sh "$BUILD_DIR/"
            chmod +x "$BUILD_DIR/support.sh"
            echo "âœ… support.sh å·²å¤åˆ¶åˆ° $BUILD_DIR/"
          else
            echo "âŒ é”™è¯¯: support.sh ä¸å­˜åœ¨"
            exit 1
          fi
          
          # å¤åˆ¶ build_firmware_main.sh åˆ°æ„å»ºç›®å½•
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            mkdir -p "$BUILD_DIR/firmware-config/scripts"
            cp firmware-config/scripts/build_firmware_main.sh "$BUILD_DIR/firmware-config/scripts/"
            chmod +x "$BUILD_DIR/firmware-config/scripts/build_firmware_main.sh"
            echo "âœ… build_firmware_main.sh å·²å¤åˆ¶åˆ° $BUILD_DIR/firmware-config/scripts/"
          else
            echo "âŒ é”™è¯¯: build_firmware_main.sh ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ä¿å­˜æºä»£ç å‹ç¼©åŒ…ä½œä¸ºæ„å»ºäº§ç‰©
          mkdir -p /tmp/build-artifacts/source-archive
          cp source.tar.gz /tmp/build-artifacts/source-archive/
          echo "ğŸ“¦ æºä»£ç å·²ä¿å­˜åˆ°: /tmp/build-artifacts/source-archive/"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          cd /tmp
          rm -rf openwrt-source
          echo "âœ… Git Archive APIä¸‹è½½å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 1 å®Œæˆ"
      
      # æ­¥éª¤ 2: ä¸Šä¼ æºä»£ç Artifacts
      - name: "2. ä¸Šä¼ æºä»£ç Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: source-${{ env.TIMESTAMP }}
          path: /tmp/build-artifacts/source-archive/
          retention-days: 7
          if-no-files-found: error
      
      # æ­¥éª¤ 3: ä¿®å¤æƒé™é—®é¢˜
      - name: "3. ä¿®å¤æƒé™é—®é¢˜"
        run: |
          echo "=== æ­¥éª¤ 3: ä¿®å¤æƒé™é—®é¢˜ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 3 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ”§ ä¿®å¤æ‰€æœ‰è„šæœ¬çš„æ‰§è¡Œæƒé™..."
          
          if [ -f "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh"
            echo "âœ… ä¿®å¤ä¸»è„šæœ¬æƒé™: firmware-config/scripts/build_firmware_main.sh"
          else
            echo "âŒ é”™è¯¯: ä¸»è„šæœ¬ä¸å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
            exit 1
          fi
          
          if [ -f "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh"
            echo "âœ… ä¿®å¤é”™è¯¯åˆ†æè„šæœ¬æƒé™: firmware-config/scripts/error_analysis.sh"
          fi
          
          # ä¿®å¤å…¶ä»–è„šæœ¬æƒé™
          find "${{ github.workspace }}/firmware-config/scripts" -name "*.sh" -exec chmod +x {} \;
          echo "âœ… ä¿®å¤æ‰€æœ‰è„šæœ¬æƒé™å®Œæˆ"
          echo "ğŸŸ¢ æ­¥éª¤ 3 å®Œæˆ"
      
      # æ­¥éª¤ 4: å®‰è£…åŸºç¡€å·¥å…·
      - name: "4. å®‰è£…åŸºç¡€å·¥å…·"
        run: |
          echo "=== æ­¥éª¤ 4: å®‰è£…åŸºç¡€å·¥å…· ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 4 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ”„ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          sudo apt-get update -q
          
          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘å¿…éœ€å·¥å…·..."
          sudo apt-get install -y -q \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            python3-distutils \
            rsync \
            unzip \
            zlib1g-dev \
            file \
            wget \
            libelf-dev \
            cmake \
            ninja-build \
            python3 \
            python3-dev \
            python3-pip \
            python3-setuptools \
            python3-yaml \
            xsltproc \
            zip \
            subversion \
            automake \
            autoconf \
            libtool \
            pkg-config \
            help2man \
            texinfo \
            groff \
            texlive \
            texinfo \
            curl \
            net-tools \
            iputils-ping \
            dnsutils \
            openssh-client \
            ca-certificates \
            gnupg \
            lsb-release \
            aria2 \
            libcurl4-openssl-dev \
            squashfs-tools \
            dosfstools \
            e2fsprogs \
            mtools \
            parted \
            fdisk \
            gdisk \
            hdparm \
            smartmontools
          
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 4 å®Œæˆ"
      
      # æ­¥éª¤ 5: åˆå§‹ç©ºé—´æ£€æŸ¥
      - name: "5. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 5: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          echo "ğŸ• æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 5 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ“Š ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h
          
          # æ£€æŸ¥æ„å»ºç›®å½•æ‰€åœ¨åˆ†åŒºçš„ç©ºé—´
          BUILD_DIR="${{ env.BUILD_DIR }}"
          echo "ğŸ” æ£€æŸ¥æ„å»ºç›®å½•: $BUILD_DIR"
          
          # ç¡®å®šæ„å»ºç›®å½•æ‰€åœ¨çš„åˆ†åŒº
          if [ -d "$BUILD_DIR" ]; then
            PARTITION=$(df "$BUILD_DIR" | tail -1 | awk '{print $6}')
            echo "ğŸ“Œ æ„å»ºç›®å½•æ‰€åœ¨åˆ†åŒº: $PARTITION"
            
            AVAILABLE_SPACE=$(df "$PARTITION" --output=avail | tail -1 | awk '{print $1}')
            AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
            echo "$PARTITION å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
            
            if [ $AVAILABLE_GB -lt 50 ]; then
              echo "âŒ é”™è¯¯: $PARTITION ç©ºé—´ä¸è¶³50Gï¼Œå½“å‰åªæœ‰${AVAILABLE_GB}G"
              exit 1
            else
              echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡ - ${AVAILABLE_GB}G å¯ç”¨"
            fi
          else
            echo "âš ï¸ æ„å»ºç›®å½•ä¸å­˜åœ¨ï¼Œæ£€æŸ¥æ ¹åˆ†åŒº..."
            AVAILABLE_SPACE=$(df / --output=avail | tail -1 | awk '{print $1}')
            AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
            echo "/ å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
            
            if [ $AVAILABLE_GB -lt 50 ]; then
              echo "âŒ é”™è¯¯: æ ¹åˆ†åŒºç©ºé—´ä¸è¶³50Gï¼Œå½“å‰åªæœ‰${AVAILABLE_GB}G"
              exit 1
            else
              echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡ - ${AVAILABLE_GB}G å¯ç”¨"
            fi
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 5 å®Œæˆ"
      
      # æ­¥éª¤ 6: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•
      - name: "6. è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 6: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½• ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 6 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          echo "ğŸ“Œ ä½¿ç”¨æ„å»ºç›®å½•: $BUILD_DIR"
          
          # éªŒè¯å…³é”®æ–‡ä»¶åœ¨æ„å»ºç›®å½•ä¸­å­˜åœ¨
          echo "ğŸ” éªŒè¯æ„å»ºç›®å½•ä¸­çš„æ–‡ä»¶..."
          if [ -f "$BUILD_DIR/support.sh" ]; then
            echo "âœ… support.sh å­˜åœ¨äºæ„å»ºç›®å½•"
          else
            echo "âŒ é”™è¯¯: support.sh ä¸å­˜åœ¨äºæ„å»ºç›®å½•"
            exit 1
          fi
          
          if [ -f "$BUILD_DIR/firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âœ… build_firmware_main.sh å­˜åœ¨äºæ„å»ºç›®å½•"
          else
            echo "âŒ é”™è¯¯: build_firmware_main.sh ä¸å­˜åœ¨äºæ„å»ºç›®å½•"
            exit 1
          fi
          
          echo "ğŸ”„ æ­¥éª¤ 6.1: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh setup_environment
          
          echo "ğŸ”„ æ­¥éª¤ 6.2: åˆ›å»ºæ„å»ºç›®å½•"
          ./firmware-config/scripts/build_firmware_main.sh create_build_dir
          
          echo "ğŸ”„ æ­¥éª¤ 6.3: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
          echo "ğŸ“± è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ğŸ”„ ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "âš™ï¸ é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          
          ./firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•è®¾ç½®å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 6 å®Œæˆ"
      
      # æ­¥éª¤ 7: ä¸‹è½½OpenWrtå®˜æ–¹SDK
      - name: "7. ä¸‹è½½OpenWrtå®˜æ–¹SDK"
        run: |
          echo "=== æ­¥éª¤ 7: ä¸‹è½½OpenWrtå®˜æ–¹SDK ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 7 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸš€ å¼€å§‹ä¸‹è½½OpenWrtå®˜æ–¹SDKå·¥å…·é“¾..."
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          echo "ğŸ“Œ ä½¿ç”¨æ„å»ºç›®å½•: $BUILD_DIR"
          
          # é‡æ–°å¤åˆ¶æ”¯æŒæ–‡ä»¶åˆ°æ„å»ºç›®å½•
          echo "ğŸ”§ é‡æ–°å¤åˆ¶æ”¯æŒæ–‡ä»¶åˆ°æ„å»ºç›®å½•..."
          
          # 1. å¤åˆ¶ support.sh
          SOURCE_SUPPORT="${{ github.workspace }}/support.sh"
          if [ -f "$SOURCE_SUPPORT" ]; then
            cp "$SOURCE_SUPPORT" "$BUILD_DIR/support.sh"
            chmod +x "$BUILD_DIR/support.sh"
            echo "âœ… support.sh å·²é‡æ–°å¤åˆ¶åˆ°æ„å»ºç›®å½•"
          else
            echo "âŒ é”™è¯¯: æºä»£ç ä¸­æ‰¾ä¸åˆ° support.sh"
            exit 1
          fi
          
          # 2. å¤åˆ¶ build_firmware_main.sh
          SOURCE_SCRIPT="${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh"
          if [ -f "$SOURCE_SCRIPT" ]; then
            mkdir -p "$BUILD_DIR/firmware-config/scripts"
            cp "$SOURCE_SCRIPT" "$BUILD_DIR/firmware-config/scripts/"
            chmod +x "$BUILD_DIR/firmware-config/scripts/build_firmware_main.sh"
            echo "âœ… build_firmware_main.sh å·²é‡æ–°å¤åˆ¶åˆ°æ„å»ºç›®å½•"
          else
            echo "âŒ é”™è¯¯: æºä»£ç ä¸­æ‰¾ä¸åˆ° build_firmware_main.sh"
            exit 1
          fi
          
          echo "ğŸ“‹ éªŒè¯æ”¯æŒæ–‡ä»¶..."
          if [ ! -f "$BUILD_DIR/support.sh" ]; then
            echo "âŒ é”™è¯¯: å¤åˆ¶åä»ç„¶æ‰¾ä¸åˆ° support.sh"
            exit 1
          fi
          
          if [ ! -f "$BUILD_DIR/firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âŒ é”™è¯¯: å¤åˆ¶åä»ç„¶æ‰¾ä¸åˆ° build_firmware_main.sh"
            exit 1
          fi
          
          echo "ğŸ“ å½“å‰æ„å»ºç›®å½•å†…å®¹:"
          ls -la "$BUILD_DIR/" || echo "æ— æ³•åˆ—å‡ºç›®å½•å†…å®¹"
          
          echo "ğŸ“‹ åŠ è½½ support.sh..."
          source "$BUILD_DIR/support.sh"
          echo "âœ… support.sh åŠ è½½æˆåŠŸ"
          
          # æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶æ˜¯å¦å·²ç»å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶..."
          if [ -f "$BUILD_DIR/build_env.sh" ]; then
            echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²å­˜åœ¨ï¼ˆç”±æ­¥éª¤6.3åˆ›å»ºï¼‰"
            
            # åŠ è½½ç°æœ‰ç¯å¢ƒå˜é‡
            source "$BUILD_DIR/build_env.sh"
            echo "âœ… ä»ç°æœ‰ç¯å¢ƒæ–‡ä»¶åŠ è½½å˜é‡:"
            echo "  SELECTED_BRANCH: $SELECTED_BRANCH"
            echo "  TARGET: $TARGET"
            echo "  SUBTARGET: $SUBTARGET"
            echo "  DEVICE: $DEVICE"
            echo "  CONFIG_MODE: $CONFIG_MODE"
            echo "  REPO_ROOT: $REPO_ROOT"
            echo "  DEVICE_NAME: $DEVICE_NAME"
            echo ""
            
            echo "ğŸ’¡ ä½¿ç”¨æ­¥éª¤6.3å·²è®¾ç½®çš„ç¯å¢ƒå˜é‡è¿›è¡ŒSDKä¸‹è½½"
          else
            echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯æ­¥éª¤6.3å¤±è´¥"
            exit 1
          fi
          
          # æ‰§è¡ŒSDKä¸‹è½½
          echo "ğŸ”„ å¼€å§‹æ‰§è¡ŒSDKä¸‹è½½..."
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh initialize_compiler_env "${{ github.event.inputs.device_name }}"
          
          SDK_EXIT_CODE=$?
          if [ $SDK_EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ è­¦å‘Š: SDKä¸‹è½½å¯èƒ½æœ‰é—®é¢˜ï¼Œé€€å‡ºä»£ç : $SDK_EXIT_CODE"
            echo "ğŸ’¡ å°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨ä½œä¸ºåå¤‡"
          fi
          
          echo "âœ… SDKä¸‹è½½æ­¥éª¤å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 7 å®Œæˆ"
      
      # æ­¥éª¤ 8: éªŒè¯SDKä¸‹è½½ç»“æœ
      - name: "8. éªŒè¯SDKä¸‹è½½ç»“æœ"
        run: |
          echo "=== æ­¥éª¤ 8: éªŒè¯SDKä¸‹è½½ç»“æœ ==="
          echo "ğŸ• éªŒè¯æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯éªŒè¯
          trap 'echo "âš ï¸ æ­¥éª¤ 8 éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          echo "ğŸ” æ£€æŸ¥SDKä¸‹è½½ç»“æœ..."
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          if [ -f "$BUILD_DIR/build_env.sh" ]; then
            source "$BUILD_DIR/build_env.sh"
            echo "âœ… ä»ç¯å¢ƒæ–‡ä»¶åŠ è½½å˜é‡: COMPILER_DIR=$COMPILER_DIR"
          else
            echo "âš ï¸ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          if [ -d "$BUILD_DIR/sdk" ]; then
            echo "âœ… SDKç›®å½•å­˜åœ¨: $BUILD_DIR/sdk"
            echo "ğŸ“Š SDKç›®å½•å¤§å°: $(du -sh "$BUILD_DIR/sdk" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            
            # æŸ¥æ‰¾çœŸæ­£çš„GCCï¼Œæ’é™¤è™šå‡ç¼–è¯‘å™¨
            GCC_FILE=$(find "$BUILD_DIR/sdk" -type f -executable \
              -name "*gcc" \
              ! -name "*gcc-ar" \
              ! -name "*gcc-ranlib" \
              ! -name "*gcc-nm" \
              ! -path "*dummy-tools*" \
              ! -path "*scripts*" \
              2>/dev/null | head -1)
            
            if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
              echo "âœ… æ‰¾åˆ°å¯æ‰§è¡ŒGCCç¼–è¯‘å™¨: $(basename "$GCC_FILE")"
              echo "ğŸ”§ GCCç‰ˆæœ¬æµ‹è¯•:"
              "$GCC_FILE" --version 2>&1 | head -1
              
              # åŠ¨æ€æ˜¾ç¤ºSDK GCCç‰ˆæœ¬ä¿¡æ¯
              SDK_VERSION=$("$GCC_FILE" --version 2>&1 | head -1)
              MAJOR_VERSION=$(echo "$SDK_VERSION" | grep -o "[0-9]\+" | head -1)
              
              echo "ğŸ’¡ è¿™æ˜¯OpenWrtå®˜æ–¹SDKäº¤å‰ç¼–è¯‘å™¨ï¼Œç”¨äºç¼–è¯‘ç›®æ ‡å¹³å°å›ºä»¶"
              
              if [ "$MAJOR_VERSION" = "12" ]; then
                echo "ğŸ’¡ SDK GCCç‰ˆæœ¬: 12.3.0 (OpenWrt 23.05 SDK)"
              elif [ "$MAJOR_VERSION" = "8" ]; then
                echo "ğŸ’¡ SDK GCCç‰ˆæœ¬: 8.4.0 (OpenWrt 21.02 SDK)"
              else
                echo "ğŸ’¡ SDK GCCç‰ˆæœ¬: $MAJOR_VERSION.x"
              fi
            else
              echo "âš ï¸ æœªæ‰¾åˆ°å¯æ‰§è¡Œçš„GCCç¼–è¯‘å™¨ï¼ˆå¯èƒ½æ˜¯è™šå‡çš„dummy-toolsï¼‰"
              
              # æ£€æŸ¥æ˜¯å¦æœ‰è™šå‡çš„ç¼–è¯‘å™¨
              DUMMY_GCC=$(find "$BUILD_DIR/sdk" -type f -executable \
                -name "*gcc" \
                -path "*dummy-tools*" \
                2>/dev/null | head -1)
              
              if [ -n "$DUMMY_GCC" ]; then
                echo "âš ï¸ æ£€æµ‹åˆ°è™šå‡çš„dummy-toolsç¼–è¯‘å™¨: $DUMMY_GCC"
                echo "ğŸ’¡ è¿™æ˜¯OpenWrtæ„å»ºç³»ç»Ÿçš„å ä½ç¬¦ï¼Œä¸æ˜¯çœŸæ­£çš„ç¼–è¯‘å™¨"
              fi
            fi
          else
            echo "âŒ SDKç›®å½•ä¸å­˜åœ¨"
            echo "ğŸ’¡ å°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
          fi
          
          echo "âœ… SDKéªŒè¯å®Œæˆ"
          echo "ğŸŸ¢ æ­¥éª¤ 8 å®Œæˆ"
      
      # æ­¥éª¤ 9: æ·»åŠ  TurboACC æ”¯æŒ
      - name: "9. æ·»åŠ  TurboACC æ”¯æŒ"
        run: |
          echo "=== æ­¥éª¤ 9: æ·»åŠ  TurboACC æ”¯æŒ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 9 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh add_turboacc_support
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 9 å®Œæˆ"
      
      # æ­¥éª¤ 10: é…ç½®Feeds
      - name: "10. é…ç½®Feeds"
        run: |
          echo "=== æ­¥éª¤ 10: é…ç½®Feeds ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 10 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh configure_feeds
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 10 å®Œæˆ"
      
      # æ­¥éª¤ 11: å®‰è£… TurboACC åŒ…
      - name: "11. å®‰è£… TurboACC åŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤ 11: å®‰è£… TurboACC åŒ… ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 11 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh install_turboacc_packages
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 11 å®Œæˆ"
      
      # æ­¥éª¤ 12: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "12. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 12: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          echo "ğŸ• æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 12 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh pre_build_space_check
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 12 å®Œæˆ"
      
      # æ­¥éª¤ 13: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      - name: "13. æ™ºèƒ½é…ç½®ç”Ÿæˆ"
        run: |
          echo "=== æ­¥éª¤ 13: æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 13 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          # é‡æ–°å¤åˆ¶ support.sh åˆ°æ„å»ºç›®å½•
          echo "ğŸ”§ é‡æ–°å¤åˆ¶ support.sh..."
          SOURCE_SUPPORT="${{ github.workspace }}/support.sh"
          
          if [ -f "$SOURCE_SUPPORT" ]; then
            cp "$SOURCE_SUPPORT" "$BUILD_DIR/support.sh"
            chmod +x "$BUILD_DIR/support.sh"
            echo "âœ… support.sh å·²é‡æ–°å¤åˆ¶åˆ°æ„å»ºç›®å½•"
          else
            echo "âŒ é”™è¯¯: support.sh æ–‡ä»¶ä¸å­˜åœ¨äºæºä»£ç "
            exit 1
          fi
          
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 13 å®Œæˆ"
      
      # æ­¥éª¤ 14: éªŒè¯USBé…ç½®
      - name: "14. éªŒè¯USBé…ç½®"
        run: |
          echo "=== æ­¥éª¤ 14: éªŒè¯USBé…ç½® ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯éªŒè¯
          trap 'echo "âš ï¸ æ­¥éª¤ 14 éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh verify_usb_config
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 14 å®Œæˆ"
      
      # æ­¥éª¤ 15: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "15. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 15: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯æ£€æŸ¥
          trap 'echo "âš ï¸ æ­¥éª¤ 15 æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 15 å®Œæˆ"
      
      # æ­¥éª¤ 16: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "16. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== æ­¥éª¤ 16: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 16 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          
          if [ -f ".config" ]; then
            cp ".config" ".config.original"
            echo "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶"
          fi
          
          ./firmware-config/scripts/build_firmware_main.sh apply_config
          
          echo "=== æœ€ç»ˆé…ç½®çŠ¶æ€æ£€æŸ¥ ==="
          if [ -f ".config" ]; then
            echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh ".config" | awk '{print $5}')"
            echo "ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < ".config")"
            
            echo ""
            echo "ğŸ”§ å…³é”®é…ç½®æ£€æŸ¥:"
            echo "1. âœ… ç›®æ ‡å¹³å°é…ç½®:"
            grep "CONFIG_TARGET_" ".config" | head -5
            
            echo ""
            echo "2. âœ… USB 3.0é©±åŠ¨é…ç½®:"
            grep "CONFIG_PACKAGE_kmod-usb-xhci" ".config"
            
            echo ""
            echo "3. âœ… å…³é”®USBé©±åŠ¨çŠ¶æ€:"
            grep -E "CONFIG_PACKAGE_kmod-usb-core|CONFIG_PACKAGE_kmod-usb2|CONFIG_PACKAGE_kmod-usb3|CONFIG_PACKAGE_kmod-usb-storage" ".config"
            
            echo ""
            echo "4. âœ… æ’ä»¶é…ç½®ç»Ÿè®¡:"
            enabled=$(grep -c "CONFIG_PACKAGE_.*=y" ".config")
            disabled=$(grep -c "# CONFIG_PACKAGE_.* is not set" ".config")
            echo "   âœ… å·²å¯ç”¨æ’ä»¶: $enabled ä¸ª"
            echo "   âŒ å·²ç¦ç”¨æ’ä»¶: $disabled ä¸ª"
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
          echo "ğŸŸ¢ æ­¥éª¤ 16 å®Œæˆ"
      
      # æ­¥éª¤ 17: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "17. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 17: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 17 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f ".config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh ".config" | awk '{print $5}')"
            echo "ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < ".config")"
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
            mkdir -p "${{ github.workspace }}/firmware-config/config-backup"
            
            # å¤‡ä»½åˆ°ä»“åº“ç›®å½•
            BACKUP_FILE="${{ github.workspace }}/firmware-config/config-backup/config_${{ env.TIMESTAMP }}.config"
            
            cp ".config" "$BACKUP_FILE"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $BACKUP_FILE"
            echo "ğŸ“Š å¤‡ä»½æ–‡ä»¶å¤§å°: $(ls -lh "$BACKUP_FILE" | awk '{print $5}')"
          else
            echo "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 17 å®Œæˆ"
      
      # æ­¥éª¤ 18: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "18. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤ 18: ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯å°è¯•ä¿®å¤
          trap 'echo "âš ï¸ æ­¥éª¤ 18 ä¿®å¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh fix_network
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 18 å®Œæˆ"
      
      # æ­¥éª¤ 19: ä¸‹è½½ä¾èµ–åŒ…
      - name: "19. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== æ­¥éª¤ 19: ä¸‹è½½ä¾èµ–åŒ… ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 19 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          
          echo "ğŸ”§ æ£€æŸ¥ä¾èµ–åŒ…ç›®å½•..."
          if [ ! -d "dl" ]; then
            mkdir -p dl
            echo "âœ… åˆ›å»ºä¾èµ–åŒ…ç›®å½•: dl"
          fi
          
          DEP_COUNT=$(find dl -type f 2>/dev/null | wc -l)
          echo "ğŸ“Š å½“å‰ä¾èµ–åŒ…æ•°é‡: $DEP_COUNT ä¸ª"
          
          echo "ğŸš€ å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…..."
          make -j4 download V=s 2>&1 | tee download.log
          
          DOWNLOAD_EXIT_CODE=${PIPESTATUS[0]}
          if [ $DOWNLOAD_EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ è­¦å‘Š: ä¾èµ–åŒ…ä¸‹è½½è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œé€€å‡ºä»£ç : $DOWNLOAD_EXIT_CODE"
            echo "ğŸ’¡ æŸ¥çœ‹ä¸‹è½½æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯:"
            grep -i "error\|failed\|404\|not found" download.log | head -10 || true
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # æ£€æŸ¥ä¸‹è½½ç»“æœ
          NEW_DEP_COUNT=$(find dl -type f 2>/dev/null | wc -l)
          echo "ğŸ“Š ä¸‹è½½åä¾èµ–åŒ…æ•°é‡: $NEW_DEP_COUNT ä¸ª"
          echo "ğŸ“ˆ æ–°å¢ä¾èµ–åŒ…: $((NEW_DEP_COUNT - DEP_COUNT)) ä¸ª"
          
          echo "ğŸŸ¢ æ­¥éª¤ 19 å®Œæˆ"
      
      # æ­¥éª¤ 20: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "20. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 20: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯å°è¯•é›†æˆ
          trap 'echo "âš ï¸ æ­¥éª¤ 20 é›†æˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          echo "ğŸ” æ£€æŸ¥è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•..."
          CUSTOM_DIR="${{ github.workspace }}/firmware-config/custom-files"
          
          if [ -d "$CUSTOM_DIR" ]; then
            echo "âœ… è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•å­˜åœ¨: $CUSTOM_DIR"
            
            BUILD_DIR="${{ env.BUILD_DIR }}"
            cd "$BUILD_DIR"
            ./firmware-config/scripts/build_firmware_main.sh integrate_custom_files
            
            echo ""
            echo "ğŸ‰ è‡ªå®šä¹‰æ–‡ä»¶é›†æˆå®Œæˆ"
            echo "ğŸ’¡ è‡ªå®šä¹‰æ–‡ä»¶å°†åœ¨ç¬¬ä¸€æ¬¡å¼€æœºæ—¶è‡ªåŠ¨å®‰è£…å’Œè¿è¡Œ"
          else
            echo "â„¹ï¸ è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨: $CUSTOM_DIR"
            echo "ğŸ“ è·³è¿‡è‡ªå®šä¹‰æ–‡ä»¶é›†æˆ"
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 20 å®Œæˆ"
      
      # æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "21. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 21 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          if [ -f "$BUILD_DIR/build_env.sh" ]; then
            source "$BUILD_DIR/build_env.sh"
            echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: SELECTED_BRANCH=$SELECTED_BRANCH, TARGET=$TARGET"
          fi
          
          echo "ğŸš€ æ‰§è¡Œå‰ç½®é”™è¯¯æ£€æŸ¥..."
          cd "$BUILD_DIR"
          ./firmware-config/scripts/build_firmware_main.sh pre_build_error_check
          
          CHECK_EXIT_CODE=$?
          if [ $CHECK_EXIT_CODE -ne 0 ]; then
            echo "âŒ é”™è¯¯: å‰ç½®é”™è¯¯æ£€æŸ¥å¤±è´¥ï¼Œé€€å‡ºä»£ç : $CHECK_EXIT_CODE"
            echo "ğŸ’¡ è¯·æŸ¥çœ‹ä¸Šæ–¹é”™è¯¯ä¿¡æ¯è¿›è¡Œä¿®å¤"
            
            if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
              echo ""
              echo "ğŸš¨ 23.05ç‰ˆæœ¬SDKéªŒè¯é—®é¢˜ä¿®å¤æç¤º:"
              echo "ğŸ’¡ 23.05 SDKä½¿ç”¨GCC 12.3.0ï¼Œå·²æ”¾å®½éªŒè¯æ¡ä»¶"
              echo "ğŸ“Œ åªéœ€è¦æœ‰GCCç¼–è¯‘å™¨æ–‡ä»¶å³å¯ï¼Œä¸è¦æ±‚ç‰¹å®šç›®å½•ç»“æ„"
              echo "ğŸ”§ å·²æ’é™¤è™šå‡çš„dummy-toolsç¼–è¯‘å™¨æ£€æµ‹"
            fi
            
            exit 1
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 21 å®Œæˆ"
      
      # æ­¥éª¤ 22: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "22. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 22: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          echo "ğŸ• æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 22 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          df -h
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          # æ£€æŸ¥æ„å»ºç›®å½•æ‰€åœ¨åˆ†åŒºçš„ç©ºé—´
          if [ -d "$BUILD_DIR" ]; then
            PARTITION=$(df "$BUILD_DIR" | tail -1 | awk '{print $6}')
            AVAILABLE_SPACE=$(df "$PARTITION" --output=avail | tail -1 | awk '{print $1}')
            AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
            echo "$PARTITION å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
            
            if [ $AVAILABLE_GB -lt 10 ]; then
              echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
              exit 1
            elif [ $AVAILABLE_GB -lt 20 ]; then
              echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            else
              echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
            fi
          else
            echo "âš ï¸ æ„å»ºç›®å½•ä¸å­˜åœ¨ï¼Œæ£€æŸ¥æ ¹åˆ†åŒº..."
            AVAILABLE_SPACE=$(df / --output=avail | tail -1 | awk '{print $1}')
            AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
            echo "/ å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
            
            if [ $AVAILABLE_GB -lt 10 ]; then
              echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
              exit 1
            elif [ $AVAILABLE_GB -lt 20 ]; then
              echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            else
              echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
            fi
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 22 å®Œæˆ"
      
      # æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶
      - name: "23. ç¼–è¯‘å›ºä»¶"
        run: |
          echo "=== æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          
          # è·å–ç³»ç»Ÿä¿¡æ¯
          CPU_CORES=$(nproc)
          TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
          
          echo "ğŸ”§ ç³»ç»Ÿä¿¡æ¯:"
          echo "  CPUæ ¸å¿ƒæ•°: $CPU_CORES"
          echo "  å†…å­˜å¤§å°: ${TOTAL_MEM}MB"
          echo "  å¹¶è¡Œä¼˜åŒ–: ${{ env.ENABLE_PARALLEL }}"
          
          # æ™ºèƒ½åˆ¤æ–­æœ€ä½³å¹¶è¡Œä»»åŠ¡æ•°
          if [ "${{ env.ENABLE_PARALLEL }}" = "true" ]; then
            echo "ğŸ§  æ™ºèƒ½åˆ¤æ–­æœ€ä½³å¹¶è¡Œä»»åŠ¡æ•°..."
            
            if [ $CPU_CORES -ge 4 ]; then
              if [ $TOTAL_MEM -ge 8000 ]; then
                MAKE_JOBS=4
                echo "âœ… æ£€æµ‹åˆ°é«˜æ€§èƒ½Runner (4æ ¸+8GB)"
              else
                MAKE_JOBS=3
                echo "âœ… æ£€æµ‹åˆ°æ ‡å‡†Runner (4æ ¸)"
              fi
            elif [ $CPU_CORES -ge 2 ]; then
              if [ $TOTAL_MEM -ge 7000 ]; then
                MAKE_JOBS=3
                echo "âœ… æ£€æµ‹åˆ°GitHubæ ‡å‡†Runner (2æ ¸7GB)"
              else
                MAKE_JOBS=2
                echo "âœ… æ£€æµ‹åˆ°2æ ¸Runner"
              fi
            else
              MAKE_JOBS=2
              echo "âš ï¸ æ£€æµ‹åˆ°å•æ ¸Runner"
            fi
            
            echo "ğŸ¯ å†³å®šä½¿ç”¨ $MAKE_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡"
          else
            MAKE_JOBS=1
            echo "ğŸ”„ ç¦ç”¨å¹¶è¡Œä¼˜åŒ–ï¼Œä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘"
          fi
          
          echo ""
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶"
          echo "ğŸ’¡ ç¼–è¯‘é…ç½®:"
          echo "  - å¹¶è¡Œä»»åŠ¡: $MAKE_JOBS"
          echo "  - è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "  - ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "  - é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "  - å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡
          export FORCE_UNSAFE_CONFIGURE=1
          
          # å¼€å§‹ç¼–è¯‘
          START_TIME=$(date +%s)
          time make -j$MAKE_JOBS V=s 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "ğŸ“Š ç¼–è¯‘ç»Ÿè®¡:"
          echo "  - æ€»è€—æ—¶: $((DURATION / 60))åˆ†é’Ÿ$((DURATION % 60))ç§’"
          echo "  - é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
            
            if [ -d "bin/targets" ]; then
              FIRMWARE_COUNT=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
              echo "âœ… ç”Ÿæˆå›ºä»¶æ–‡ä»¶: $FIRMWARE_COUNT ä¸ª"
              
              # æ˜¾ç¤ºå‰3ä¸ªå›ºä»¶æ–‡ä»¶
              echo "ğŸ“ ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ (å‰3ä¸ª):"
              find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | head -3 | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                echo "  ğŸ“„ $(basename "$file") ($SIZE)"
              done
            fi
          else
            echo "âŒ é”™è¯¯: ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
            echo "ğŸ” ç¼–è¯‘æ—¥å¿—ä¸­çš„é”™è¯¯æ‘˜è¦:"
            grep -i "error\|failed" build.log | tail -20 || true
            exit $BUILD_EXIT_CODE
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 23 å®Œæˆ"
      
      # æ­¥éª¤ 24: æ£€æŸ¥æ„å»ºäº§ç‰©
      - name: "24. æ£€æŸ¥æ„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 24: æ£€æŸ¥æ„å»ºäº§ç‰© ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 24 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          cd "$BUILD_DIR"
          
          if [ -d "bin/targets" ]; then
            echo "âœ… æ‰¾åˆ°å›ºä»¶ç›®å½•"
            
            # ç»Ÿè®¡å„ç§ç±»å‹æ–‡ä»¶
            FIRMWARE_COUNT=0
            PACKAGE_COUNT=0
            OTHER_COUNT=0
            
            # è®¡ç®—æ–‡ä»¶æ•°é‡
            echo "ğŸ“Š æ­£åœ¨ç»Ÿè®¡æ–‡ä»¶..."
            
            # ç»Ÿè®¡å›ºä»¶æ–‡ä»¶ï¼ˆ.binå’Œ.imgï¼‰
            FIRMWARE_COUNT=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
            
            # ç»Ÿè®¡åŒ…æ–‡ä»¶ï¼ˆ.gzå’Œ.ipkï¼‰
            PACKAGE_COUNT=$(find bin/targets -type f \( -name "*.gz" -o -name "*.ipk" \) 2>/dev/null | wc -l)
            
            # ç»Ÿè®¡å…¶ä»–æ–‡ä»¶ï¼ˆæ’é™¤ä¸Šé¢ä¸¤ç§ç±»å‹ï¼‰
            OTHER_COUNT=$(find bin/targets -type f 2>/dev/null | wc -l)
            OTHER_COUNT=$((OTHER_COUNT - FIRMWARE_COUNT - PACKAGE_COUNT))
            
            echo "=========================================="
            echo "ğŸ“ˆ æ„å»ºäº§ç‰©ç»Ÿè®¡:"
            echo "  å›ºä»¶æ–‡ä»¶: $FIRMWARE_COUNT ä¸ª (.bin/.img)"
            echo "  åŒ…æ–‡ä»¶: $PACKAGE_COUNT ä¸ª (.gz/.ipk)"
            echo "  å…¶ä»–æ–‡ä»¶: $OTHER_COUNT ä¸ª"
            echo "  æ€»æ–‡ä»¶æ•°: $((FIRMWARE_COUNT + PACKAGE_COUNT + OTHER_COUNT)) ä¸ª"
            echo ""
            
            # æ˜¾ç¤ºæ‰€æœ‰å›ºä»¶æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯
            if [ $FIRMWARE_COUNT -gt 0 ]; then
              echo "ğŸ“ å›ºä»¶æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
              echo "------------------------------------------"
              find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                FULL_SIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
                FILE_NAME=$(basename "$file")
                FILE_PATH=$(echo "$file" | sed "s|$BUILD_DIR/||")
                
                echo "ğŸ¯ æ–‡ä»¶: $FILE_NAME"
                echo "  å¤§å°: $SIZE ($FULL_SIZE å­—èŠ‚)"
                echo "  è·¯å¾„: $FILE_PATH"
                
                # åˆ¤æ–­æ–‡ä»¶ç±»å‹
                if [[ "$FILE_NAME" == *factory* ]]; then
                  echo "  ç±»å‹: ğŸ­ å·¥å‚å›ºä»¶ (ç”¨äºé¦–æ¬¡åˆ·æœº)"
                elif [[ "$FILE_NAME" == *sysupgrade* ]]; then
                  echo "  ç±»å‹: ğŸ”„ ç³»ç»Ÿå‡çº§å›ºä»¶ (ç”¨äºå·²å®‰è£…OpenWrtçš„è®¾å¤‡)"
                elif [[ "$FILE_NAME" == *initramfs* ]]; then
                  echo "  ç±»å‹: ğŸš€ å†…å­˜å¯åŠ¨å›ºä»¶ (ç”¨äºæµ‹è¯•å’Œæ•‘æ´)"
                else
                  echo "  ç±»å‹: ğŸ”§ æ™®é€šå›ºä»¶"
                fi
                
                echo ""
              done
            else
              echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶ (.bin/.img)"
              echo "ğŸ” ç›®å½•å†…å®¹ (å‰10ä¸ªæ–‡ä»¶):"
              find bin/targets -type f 2>/dev/null | head -10 | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                echo "  ğŸ“„ $(basename "$file") ($SIZE)"
              done
            fi
            
            # è®¡ç®—æ€»å¤§å°
            echo "ğŸ“ å¤§å°ç»Ÿè®¡:"
            TOTAL_SIZE=0
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
              SIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
              TOTAL_SIZE=$((TOTAL_SIZE + SIZE))
            done
            
            if [ $TOTAL_SIZE -gt 0 ]; then
              TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024 / 1024))
              echo "  å›ºä»¶æ€»å¤§å°: ${TOTAL_SIZE_MB}MB"
              
              if [ $TOTAL_SIZE_MB -lt 5 ]; then
                echo "  âš ï¸ è­¦å‘Š: å›ºä»¶æ–‡ä»¶å¯èƒ½å¤ªå°"
              elif [ $TOTAL_SIZE_MB -gt 100 ]; then
                echo "  âš ï¸ è­¦å‘Š: å›ºä»¶æ–‡ä»¶å¯èƒ½å¤ªå¤§"
              else
                echo "  âœ… å›ºä»¶å¤§å°æ­£å¸¸"
              fi
            fi
            
            echo "=========================================="
            echo "âœ… æ„å»ºäº§ç‰©æ£€æŸ¥å®Œæˆ"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°å›ºä»¶ç›®å½•"
            echo "âš ï¸ bin/targetsç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 24 å®Œæˆ"
      
      # æ­¥éª¤ 25: ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•
      - name: "25. ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.TIMESTAMP }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
          if-no-files-found: error
      
      # æ­¥éª¤ 26: ä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "26. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ env.TIMESTAMP }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
          if-no-files-found: error
      
      # æ­¥éª¤ 27: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "27. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 27: ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          echo "ğŸ• æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯æ£€æŸ¥
          trap 'echo "âš ï¸ æ­¥éª¤ 27 æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          echo "ğŸ“Š ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h
          
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          # æ£€æŸ¥æ„å»ºç›®å½•æ‰€åœ¨åˆ†åŒºçš„ç©ºé—´
          if [ -d "$BUILD_DIR" ]; then
            PARTITION=$(df "$BUILD_DIR" | tail -1 | awk '{print $6}')
            AVAILABLE_SPACE=$(df "$PARTITION" --output=avail | tail -1 | awk '{print $1}')
            AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
            echo "$PARTITION å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
            
            if [ $AVAILABLE_GB -lt 5 ]; then
              echo "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´è¾ƒä½ï¼Œå»ºè®®æ¸…ç†"
            else
              echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
            fi
          else
            echo "âš ï¸ æ„å»ºç›®å½•ä¸å­˜åœ¨ï¼Œæ£€æŸ¥æ ¹åˆ†åŒº..."
            AVAILABLE_SPACE=$(df / --output=avail | tail -1 | awk '{print $1}')
            AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
            echo "/ å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
            
            if [ $AVAILABLE_GB -lt 5 ]; then
              echo "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´è¾ƒä½ï¼Œå»ºè®®æ¸…ç†"
            else
              echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
            fi
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 27 å®Œæˆ"
      
      # æ­¥éª¤ 28: æ„å»ºæ€»ç»“
      - name: "28. æ„å»ºæ€»ç»“"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 28: æ„å»ºæ€»ç»“ ==="
          echo "ğŸ• æ€»ç»“æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          echo ""
          echo "=================================================="
          echo "ğŸ‰ OpenWrtå›ºä»¶æ„å»ºå®Œæˆï¼"
          echo "=================================================="
          echo ""
          echo "ğŸ“± è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ğŸ”„ ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "âš™ï¸ æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "ğŸ†” æ„å»ºID: ${{ env.BUILD_ID }}"
          echo "ğŸ“… æ—¶é—´: ${{ env.BUILD_TIMESTAMP }}"
          echo ""
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          BUILD_DIR="${{ env.BUILD_DIR }}"
          if [ -d "$BUILD_DIR/bin/targets" ]; then
            FIRMWARE_COUNT=$(find "$BUILD_DIR/bin/targets" -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
            
            if [ $FIRMWARE_COUNT -gt 0 ]; then
              echo "âœ… æ„å»ºçŠ¶æ€: æˆåŠŸç”Ÿæˆ $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
              echo ""
              echo "ğŸ“¦ å›ºä»¶æ–‡ä»¶:"
              find "$BUILD_DIR/bin/targets" -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                echo "  ğŸ“„ $(basename "$file") ($SIZE)"
              done
              echo ""
              echo "ğŸ’¾ ä¸‹è½½ä½ç½®: åœ¨Actionsé¡µé¢çš„Artifactsä¸­"
              echo "  äº§ç‰©åç§°: firmware-${{ env.TIMESTAMP }}"
            else
              echo "âš ï¸ æ„å»ºçŠ¶æ€: ç¼–è¯‘å®Œæˆä½†æœªç”Ÿæˆå›ºä»¶æ–‡ä»¶"
            fi
          else
            echo "âŒ æ„å»ºçŠ¶æ€: æ„å»ºå¤±è´¥ï¼Œæœªç”Ÿæˆå›ºä»¶ç›®å½•"
          fi
          
          echo ""
          echo "ğŸ”— æ„å»ºè¯¦æƒ…:"
          echo "  https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          if [ -n "${{ env.WEB_SESSION_ID }}" ]; then
            echo ""
            echo "ğŸŒ ç½‘é¡µè§¦å‘ä¿¡æ¯:"
            echo "  ä¼šè¯ID: ${{ env.WEB_SESSION_ID }}"
          fi
          
          echo ""
          echo "=================================================="
          echo "ğŸ’¡ æç¤º: å¯ä»¥åœ¨ç½‘é¡µä¸­è‡ªåŠ¨åˆ·æ–°æŸ¥çœ‹æ„å»ºçŠ¶æ€"
          echo "=================================================="
          echo "ğŸŸ¢ æ­¥éª¤ 28 å®Œæˆ"
