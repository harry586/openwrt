name: OpenWrt 智能固件构建工作流

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (ac42u/RT-ACRH17)'
        required: true
        default: 'ac42u'
        type: string
      version_spec:
        description: '版本规格 (可选，如: openwrt-23.05 或 immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_profile:
        description: '配置模板'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - normal
          - full
      extra_packages:
        description: '额外安装插件 (空格分隔)'
        required: false
        type: string

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出配置仓库
      uses: actions/checkout@v4
      with:
        path: openwrt-config
        fetch-depth: 0

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libssl-dev python3 unzip zlib1g-dev subversion gcc-multilib git curl

    - name: 创建构建目录
      run: |
        mkdir -p $BUILD_DIR
        chown -R $USER:$USER $BUILD_DIR
        chmod -R 755 $BUILD_DIR

    - name: 复制配置脚本
      run: |
        cd $BUILD_DIR
        echo "=== 复制配置脚本 ==="
        
        cd $GITHUB_WORKSPACE
        
        # 复制版本检测脚本
        VERSION_SCRIPT=$(find . -name "complete_version_detector.sh" -type f | head -1)
        if [ -n "$VERSION_SCRIPT" ]; then
          cp "$VERSION_SCRIPT" $BUILD_DIR/complete_version_detector.sh
          chmod +x $BUILD_DIR/complete_version_detector.sh
          echo "✅ 版本检测脚本复制完成"
        else
          echo "⚠️ 未找到版本检测脚本，使用默认配置"
        fi

    - name: 选择源码版本
      id: select-version
      run: |
        cd $BUILD_DIR
        echo "=== 选择源码版本 ==="
        
        if [ -f "complete_version_detector.sh" ]; then
          echo "使用版本检测脚本选择版本..."
          if ./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_spec }}"; then
            echo "✅ 版本检测完成"
          else
            echo "❌ 版本检测失败，使用默认版本"
            echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
          fi
        else
          echo "使用默认源码版本"
          echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
          echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
        fi

    - name: 克隆源码
      run: |
        cd $BUILD_DIR
        echo "=== 克隆源码 ==="
        echo "仓库: $SELECTED_REPO_URL"
        echo "分支: $SELECTED_BRANCH"
        
        # 清理目录（保留脚本）
        find . -mindepth 1 -maxdepth 1 ! -name '*.sh' -exec rm -rf {} + 2>/dev/null || true
        
        git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
        
        if [ $? -eq 0 ]; then
          echo "✅ 源码克隆完成"
        else
          echo "❌ 源码克隆失败"
          exit 1
        fi

    - name: 更新和安装feeds
      run: |
        cd $BUILD_DIR
        echo "=== 更新和安装feeds ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成基础配置
      run: |
        cd $BUILD_DIR
        echo "=== 生成基础配置 ==="
        
        # 使用defconfig生成基础配置
        make defconfig
        
        # 应用设备特定配置
        case "${{ github.event.inputs.device_name }}" in
          "ac42u")
            echo "应用 RT-ACRH17 配置"
            ./scripts/feeds install -a
            make menuconfig <<EOF


EOF
            ;;
          *)
            echo "使用默认配置"
            ;;
        esac

    - name: 应用配置模板
      run: |
        cd $BUILD_DIR
        echo "=== 应用配置模板 ==="
        
        # 备份原始配置
        cp .config .config.original
        
        # 根据模板修改配置
        case "${{ github.event.inputs.config_profile }}" in
          "minimal")
            echo "应用最小化配置"
            # 取消选择LUCI
            sed -i 's/CONFIG_PACKAGE_luci=y/# CONFIG_PACKAGE_luci is not set/' .config
            ;;
          "normal")
            echo "应用标准配置"
            # 确保选择LUCI
            sed -i 's/# CONFIG_PACKAGE_luci is not set/CONFIG_PACKAGE_luci=y/' .config
            echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
            ;;
          "full")
            echo "应用完整配置"
            # 选择更多包
            sed -i 's/# CONFIG_PACKAGE_luci is not set/CONFIG_PACKAGE_luci=y/' .config
            echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
            ;;
        esac
        
        # 添加额外包
        if [ -n "${{ github.event.inputs.extra_packages }}" ]; then
          echo "添加额外包: ${{ github.event.inputs.extra_packages }}"
          for pkg in ${{ github.event.inputs.extra_packages }}; do
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          done
        fi

    - name: 最终配置确认
      run: |
        cd $BUILD_DIR
        echo "=== 最终配置确认 ==="
        
        # 检查目标平台配置
        echo "目标平台配置:"
        grep "CONFIG_TARGET" .config | head -10
        
        echo "设备配置:"
        grep "CONFIG_TARGET_DEVICE" .config
        
        echo "主要包配置:"
        grep "CONFIG_PACKAGE_luci" .config

    - name: 下载依赖
      run: |
        cd $BUILD_DIR
        echo "=== 下载依赖 ==="
        make -j4 download

    - name: 编译固件
      run: |
        cd $BUILD_DIR
        echo "=== 开始编译固件 ==="
        make -j$(nproc) V=s

    - name: 验证构建结果
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== 构建结果验证 ==="
        
        if [ -d "bin/targets" ]; then
          echo "✅ 构建成功！生成的固件:"
          find bin/targets -name "*.bin" -o -name "*.img" | head -10
          
          echo "=== 固件大小 ==="
          find bin/targets -name "*.bin" -o -name "*.img" -exec ls -lh {} \;
        else
          echo "❌ 构建失败，未找到目标文件"
          echo "=== 构建目录内容 ==="
          ls -la bin/ 2>/dev/null || echo "bin目录不存在"
        fi

    - name: 上传固件产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: 上传配置和日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/.config.original
          ${{ env.BUILD_DIR }}/version_info.txt
        retention-days: 7
