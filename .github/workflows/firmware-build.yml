name: OpenWrt 智能固件构建工作流 - 修复编译错误版

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (如: ac42u等)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: '版本选择'
        required: true
        type: choice
        default: 'auto'
        options:
          - auto
          - 23.05
          - 22.03
          - 21.02
          - 19.07
      config_type:
        description: '配置类型'
        required: true
        default: 'normal'
        type: choice
        options:
          - minimal
          - normal
          - custom
      extra_packages:
        description: '额外安装插件 (多个插件用空格分隔)'
        required: false
        type: string
        default: ''
      enable_cache:
        description: '启用编译缓存'
        required: false
        default: true
        type: boolean
      multithreading:
        description: '开启多线程编译'
        type: boolean
        default: true

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出配置仓库
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 设置编译环境
      run: |
        echo "=== 安装编译依赖包 ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo
        echo "✅ 编译环境设置完成"

    - name: 创建构建目录
      run: |
        echo "=== 创建构建目录 ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        echo "✅ 构建目录创建完成"

    - name: 智能版本检测
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== 智能版本检测 ==="
        
        # 简单版本选择逻辑
        case "${{ github.event.inputs.device_name }}" in
            "wr841n"|"wr842n"|"wr941n"|"mr3420")
                SELECTED_REPO_URL="https://github.com/openwrt/openwrt.git"
                SELECTED_BRANCH="openwrt-19.07"
                ;;
            *)
                SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
                SELECTED_BRANCH="openwrt-21.02"
                ;;
        esac
        
        # 如果用户指定了版本
        if [ "${{ inputs.version_selection }}" != "auto" ]; then
            case "${{ inputs.version_selection }}" in
                "23.05") SELECTED_BRANCH="openwrt-23.05" ;;
                "22.03") SELECTED_BRANCH="openwrt-22.03" ;;
                "21.02") SELECTED_BRANCH="openwrt-21.02" ;;
                "19.07") SELECTED_BRANCH="openwrt-19.07" ;;
            esac
        fi
        
        echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
        echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
        echo "✅ 版本选择完成: $SELECTED_BRANCH"

    - name: 克隆源码
      run: |
        cd $BUILD_DIR
        echo "=== 克隆源码 ==="
        echo "仓库: $SELECTED_REPO_URL"
        echo "分支: $SELECTED_BRANCH"
        
        # 清理目录
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        
        # 克隆源码
        git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
        echo "✅ 源码克隆完成"

    - name: 基础配置设置
      run: |
        cd $BUILD_DIR
        echo "=== 基础配置设置 ==="
        
        # 设备映射
        case "${{ github.event.inputs.device_name }}" in
            "ac42u"|"acrh17")
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="asus_rt-ac42u"
                ;;
            "mi4a"|"r4a")
                TARGET="ramips"
                SUBTARGET="mt76x8"
                DEVICE="xiaomi_mi-router-4a-gigabit"
                ;;
            "wr841n")
                TARGET="ar71xx"
                SUBTARGET="generic"
                DEVICE="tl-wr841n-v11"
                ;;
            *)
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="${{ github.event.inputs.device_name }}"
                ;;
        esac
        
        echo "TARGET=$TARGET" >> $GITHUB_ENV
        echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
        echo "DEVICE=$DEVICE" >> $GITHUB_ENV
        
        echo "目标: $TARGET"
        echo "子目标: $SUBTARGET"
        echo "设备: $DEVICE"

    - name: 配置Feeds
      run: |
        cd $BUILD_DIR
        echo "=== 配置Feeds ==="
        
        # 根据分支选择feeds版本
        case "$SELECTED_BRANCH" in
            "openwrt-23.05")
                FEEDS_BRANCH="openwrt-23.05"
                ;;
            "openwrt-22.03")
                FEEDS_BRANCH="openwrt-22.03"
                ;;
            "openwrt-21.02")
                FEEDS_BRANCH="openwrt-21.02"
                ;;
            "openwrt-19.07")
                FEEDS_BRANCH="openwrt-19.07"
                ;;
            *)
                FEEDS_BRANCH="master"
                ;;
        esac
        
        echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
        echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git routing https://github.com/openwrt/routing.git;$FEEDS_BRANCH" >> feeds.conf.default
        echo "src-git telephony https://github.com/openwrt/telephony.git;$FEEDS_BRANCH" >> feeds.conf.default
        
        # 更新feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "✅ Feeds配置完成"

    - name: 生成最小化配置
      run: |
        cd $BUILD_DIR
        echo "=== 生成最小化配置 ==="
        
        # 创建最小化配置，避免包冲突
        echo "CONFIG_TARGET_${TARGET}=y" > .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        
        # 仅包含绝对必要的包
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_fstools=y" >> .config
        echo "CONFIG_PACKAGE_libc=y" >> .config
        echo "CONFIG_PACKAGE_libgcc=y" >> .config
        echo "CONFIG_PACKAGE_mtd=y" >> .config
        echo "CONFIG_PACKAGE_netifd=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_procd=y" >> .config
        echo "CONFIG_PACKAGE_ubox=y" >> .config
        echo "CONFIG_PACKAGE_ubus=y" >> .config
        echo "CONFIG_PACKAGE_ubusd=y" >> .config
        echo "CONFIG_PACKAGE_uci=y" >> .config
        echo "CONFIG_PACKAGE_uclient-fetch=y" >> .config
        echo "CONFIG_PACKAGE_usign=y" >> .config
        
        echo "✅ 最小化配置生成完成"

    - name: 应用配置
      run: |
        cd $BUILD_DIR
        echo "=== 应用配置 ==="
        
        # 运行defconfig来完善配置
        make defconfig
        echo "✅ 配置应用完成"
        
        # 显示启用的包数量
        ENABLED_PACKAGES=$(grep "^CONFIG_PACKAGE_.*=y$" .config | wc -l)
        echo "启用的包数量: $ENABLED_PACKAGES"

    - name: 修复权限和文件系统
      run: |
        cd $BUILD_DIR
        echo "=== 修复权限和文件系统 ==="
        
        # 修复可能的权限问题
        sudo chown -R $USER:$USER .
        sudo chmod -R 755 .
        
        # 清理可能的锁定文件
        find . -name "*.lock" -delete 2>/dev/null || true
        find . -name "*.tmp" -delete 2>/dev/null || true
        
        # 确保必要的目录存在
        mkdir -p staging_dir/host/bin
        mkdir -p staging_dir/target-*/bin
        mkdir -p build_dir/target-*/
        
        echo "✅ 权限和文件系统修复完成"

    - name: 修复网络环境
      run: |
        cd $BUILD_DIR
        echo "=== 修复网络环境 ==="
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        echo "✅ 网络环境修复完成"

    - name: 下载依赖包
      run: |
        cd $BUILD_DIR
        echo "=== 下载依赖包 ==="
        export MAKE_JOBS=${{ inputs.multithreading && '$(nproc)' || '1' }}
        make -j$MAKE_JOBS download
        echo "✅ 依赖包下载完成"

    - name: 编译host工具
      run: |
        cd $BUILD_DIR
        echo "=== 编译host工具 ==="
        # 先编译host工具，确保usign等工具可用
        make -j1 tools/install
        make -j1 toolchain/install
        echo "✅ host工具编译完成"

    - name: 编译固件 - 分步进行
      run: |
        cd $BUILD_DIR
        echo "=== 编译固件 - 分步进行 ==="
        export MAKE_JOBS=${{ inputs.multithreading && '$(nproc)' || '1' }}
        
        # 创建日志目录
        mkdir -p logs
        
        echo "步骤1: 编译工具链"
        make -j$MAKE_JOBS toolchain/install || echo "工具链编译可能有警告"
        
        echo "步骤2: 编译目标工具"
        make -j$MAKE_JOBS target/compile || echo "目标工具编译可能有警告"
        
        echo "步骤3: 编译包"
        make -j$MAKE_JOBS package/compile || echo "包编译可能有警告"
        
        echo "步骤4: 编译固件镜像"
        make -j$MAKE_JOBS target/install || echo "目标安装可能有警告"
        
        echo "步骤5: 最终编译"
        if [ "${{ inputs.enable_cache }}" = "true" ]; then
            echo "启用编译缓存"
            make -j$MAKE_JOBS V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        else
            echo "普通编译模式"
            make -j$MAKE_JOBS V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        fi
        
        echo "编译退出代码: $BUILD_EXIT_CODE"
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "❌ 编译失败，退出代码: $BUILD_EXIT_CODE"
            exit $BUILD_EXIT_CODE
        fi
        echo "✅ 固件编译完成"

    - name: 错误分析和诊断
      if: failure()
      run: |
        cd $BUILD_DIR
        echo "=== 错误分析和诊断 ==="
        
        # 检查磁盘空间
        echo "磁盘空间使用:"
        df -h
        
        # 检查内存使用
        echo "内存使用:"
        free -h
        
        # 检查构建目录状态
        echo "构建目录状态:"
        ls -la bin/targets/ 2>/dev/null || echo "bin/targets 目录不存在"
        ls -la staging_dir/ 2>/dev/null || echo "staging_dir 目录不存在"
        ls -la build_dir/ 2>/dev/null || echo "build_dir 目录不存在"
        
        # 检查构建日志中的错误
        if [ -f "build.log" ]; then
            echo "构建日志中的错误:"
            grep -i "error" build.log | tail -20
            echo "构建日志中的警告:"
            grep -i "warning" build.log | tail -10
        fi
        
        # 检查包编译状态
        echo "包编译状态:"
        find build_dir -name ".configured" | wc -l
        find build_dir -name ".built" | wc -l
        find build_dir -name ".failed" | wc -l

    - name: 固件文件检查
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== 固件文件检查 ==="
        if [ -d "bin/targets" ]; then
            echo "✅ 固件目录存在"
            find bin/targets -name "*.bin" -o -name "*.img" | while read file; do
                echo "固件文件: $file ($(du -h "$file" | cut -f1))"
            done
        else
            echo "❌ 固件目录不存在"
            exit 1
        fi

    - name: 上传固件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: 上传构建日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: 清理目录
      if: always()
      run: |
        echo "=== 清理构建目录 ==="
        sudo rm -rf $BUILD_DIR
        echo "✅ 构建目录已清理"
