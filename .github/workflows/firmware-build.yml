#ã€firmware-build.yml-00ã€‘
# OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ - ç³»ç»Ÿä¸»å…¥å£
# ç‰ˆæœ¬: 3.4.0
# æœ€åæ›´æ–°: 2026-02-27

name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      # æºç ä»“åº“é€‰æ‹©
      source_repo:
        description: "ğŸ“¦ æºç ä»“åº“é€‰æ‹©"
        required: true
        type: choice
        default: "immortalwrt"
        options: ["immortalwrt", "openwrt", "lede"]
      
      # é¢„å®šä¹‰è®¾å¤‡ä¸‹æ‹‰é€‰æ‹©ï¼ˆä¿ç•™ï¼‰
      device_name:
        description: "ğŸ“± é¢„å®šä¹‰è®¾å¤‡ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰"
        required: false
        type: choice
        default: "ac42u"
        options: ["ac42u", "cmcc_rax3000m", "netgear_wndr3800"]
      
      # æ‰‹åŠ¨è¾“å…¥æ¡†ï¼ˆç«–å‘æ’åˆ—ï¼‰
      manual_device_name:
        description: "ğŸ“ è®¾å¤‡åç§°ï¼ˆä½¿ç”¨è‡ªå®šä¹‰ï¼‰"
        required: false
        type: string
        default: ""
      manual_target:
        description: "ğŸ¯ èŠ¯ç‰‡å‹å·ï¼ˆipq40xxï¼‰"
        required: false
        type: string
        default: ""
      manual_subtarget:
        description: "ğŸ”§ å­å¹³å°ï¼ˆgenericã€filogicï¼‰"
        required: false
        type: string
        default: ""
      
      # ç‰ˆæœ¬é€‰æ‹©
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©"
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”"
        required: false
        type: string
        default: ""
      
      # æ–°å¢ï¼šè‡ªå®šä¹‰ç¦ç”¨æ’ä»¶
      forbidden_packages:
        description: "ğŸš« è‡ªå®šä¹‰ç¦ç”¨æ’ä»¶ - æ ¼å¼ï¼šç”¨ç©ºæ ¼åˆ†éš”ï¼Œé»˜è®¤ç¦ç”¨ vssr ssr-plus passwall rclone ddns qbittorrent filetransfer"
        required: false
        type: string
        default: "vssr ssr-plus passwall rclone ddns qbittorrent filetransfer"
      
      enable_parallel:
        description: "âš¡ å¯ç”¨æ™ºèƒ½å¹¶è¡Œä¼˜åŒ–"
        required: false
        type: boolean
        default: true

env:
  BUILD_DIR: "/mnt/openwrt-build"
  REPO_ROOT: "${{ github.workspace }}"
  ENABLE_PARALLEL: "${{ github.event.inputs.enable_parallel }}"
  SOURCE_REPO: "${{ github.event.inputs.source_repo }}"
  FORBIDDEN_PACKAGES: "${{ github.event.inputs.forbidden_packages }}"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
#ã€firmware-build.yml-00-endã€‘

    steps:
      #ã€firmware-build.yml-01ã€‘
      - name: "01. ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆUTC+8æ—¶åŒºï¼‰"
        run: |
          echo "=== æ­¥éª¤01: ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆUTC+8æ—¶åŒºï¼‰ ==="
          
          sudo timedatectl set-timezone Asia/Shanghai 2>/dev/null || true
          
          START_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          echo "ğŸ• å¼€å§‹æ—¶é—´: $START_TIME"
          
          TIMESTAMP_LOCAL=$(date +'%Y%m%d_%H%M%S')
          TIMESTAMP_SEC="${{ github.event.inputs.manual_device_name != '' && github.event.inputs.manual_device_name || github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}-$TIMESTAMP_LOCAL"
          
          echo "TIMESTAMP_SEC=$TIMESTAMP_SEC" >> $GITHUB_ENV
          echo "START_TIME=$START_TIME" >> $GITHUB_ENV
          
          echo "âœ… ç”Ÿæˆæ—¶é—´æˆ³: $TIMESTAMP_SEC"
          echo "ğŸ“‹ æ„å»ºé…ç½®:"
          echo "  é¢„å®šä¹‰è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "  æ‰‹åŠ¨è®¾å¤‡å: ${{ github.event.inputs.manual_device_name }}"
          echo "  æ‰‹åŠ¨èŠ¯ç‰‡å‹å·: ${{ github.event.inputs.manual_target }}"
          echo "  æ‰‹åŠ¨å­å¹³å°: ${{ github.event.inputs.manual_subtarget }}"
          echo "  ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "  æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "  å¹¶è¡Œä¼˜åŒ–: ${{ github.event.inputs.enable_parallel }}"
      #ã€firmware-build.yml-01-endã€‘

      #ã€firmware-build.yml-02ã€‘
      - name: "02. ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        run: |
          echo "=== æ­¥éª¤02: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç  ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤02 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          
          echo "ğŸ” è·å–ä»“åº“é»˜è®¤åˆ†æ”¯..."
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "âœ… é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
          
          echo "ğŸ“¥ ä¸‹è½½æºä»£ç å‹ç¼©åŒ…..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" \
            -o source.tar.gz
          
          if [ ! -f "source.tar.gz" ]; then
            echo "âŒ é”™è¯¯: ä¸‹è½½æºä»£ç å‹ç¼©åŒ…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(ls -lh source.tar.gz | awk '{print $5}')"
          
          echo "ğŸ“¦ è§£å‹æºä»£ç ..."
          tar -xzf source.tar.gz --strip-components=1
          
          echo "ğŸ” æ£€æŸ¥è§£å‹ç»“æœ..."
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âœ… æºä»£ç è§£å‹æˆåŠŸ"
            echo "âœ… ä¸»è„šæœ¬å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
            
            echo "ğŸ“ å¤åˆ¶æ–‡ä»¶åˆ°å·¥ä½œåŒº..."
            mkdir -p ${{ github.workspace }}
            
            if [ -d "firmware-config/build-Compiler-file" ]; then
              echo "âš ï¸ å‘ç°ç¼–è¯‘å™¨ç›®å½•ï¼Œæ’é™¤ä¸å¤åˆ¶"
              rm -rf firmware-config/build-Compiler-file
            fi
            
            rsync -av --exclude='.git' . ${{ github.workspace }}/
            
            echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
            
            mkdir -p /tmp/build-artifacts/source-archive
            cp source.tar.gz /tmp/build-artifacts/source-archive/
            echo "ğŸ“¦ æºä»£ç å·²ä¿å­˜åˆ°: /tmp/build-artifacts/source-archive/"
          else
            echo "âŒ é”™è¯¯: æºä»£ç è§£å‹å¤±è´¥ï¼Œé‡è¦æ–‡ä»¶ç¼ºå¤±"
            ls -la
            exit 1
          fi
          
          cd /tmp
          rm -rf openwrt-source
          echo "âœ… æ­¥éª¤02 å®Œæˆ"
      #ã€firmware-build.yml-02-endã€‘

      #ã€firmware-build.yml-03ã€‘
      - name: "03. ä¸Šä¼ æºä»£ç Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: source-${{ env.TIMESTAMP_SEC }}
          path: /tmp/build-artifacts/source-archive/
          retention-days: 7
          if-no-files-found: error
      #ã€firmware-build.yml-03-endã€‘

      #ã€firmware-build.yml-04ã€‘
      - name: "04. ä¿®å¤æƒé™é—®é¢˜"
        run: |
          echo "=== æ­¥éª¤04: ä¿®å¤æƒé™é—®é¢˜ ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤04 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ”§ ä¿®å¤æ‰€æœ‰è„šæœ¬çš„æ‰§è¡Œæƒé™..."
          
          if [ -f "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh"
            echo "âœ… ä¿®å¤ä¸»è„šæœ¬æƒé™"
          else
            echo "âŒ é”™è¯¯: ä¸»è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ -f "${{ github.workspace }}/support.sh" ]; then
            chmod +x "${{ github.workspace }}/support.sh"
            echo "âœ… ä¿®å¤support.shæƒé™"
          else
            echo "âŒ é”™è¯¯: support.shä¸å­˜åœ¨"
            exit 1
          fi
          
          find "${{ github.workspace }}/firmware-config/scripts" -name "*.sh" -exec chmod +x {} \;
          echo "âœ… ä¿®å¤æ‰€æœ‰è„šæœ¬æƒé™å®Œæˆ"
      #ã€firmware-build.yml-04-endã€‘

      #ã€firmware-build.yml-05ã€‘
      - name: "05. å®‰è£…åŸºç¡€å·¥å…·ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤05: å®‰è£…åŸºç¡€å·¥å…·ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step05_install_basic_tools
      #ã€firmware-build.yml-05-endã€‘

      #ã€firmware-build.yml-06ã€‘
      - name: "06. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤06: åˆå§‹ç©ºé—´æ£€æŸ¥ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step06_initial_space_check
      #ã€firmware-build.yml-06-endã€‘

      #ã€firmware-build.yml-07ã€‘
      - name: "07. åˆ›å»ºæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤07: åˆ›å»ºæ„å»ºç›®å½• ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step07_create_build_dir
      #ã€firmware-build.yml-07-endã€‘

      #ã€firmware-build.yml-08ã€‘
      - name: "08. åˆå§‹åŒ–æ„å»ºç¯å¢ƒï¼ˆæ··åˆæ¨¡å¼ï¼šä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥ï¼‰"
        run: |
          echo "=== æ­¥éª¤08: åˆå§‹åŒ–æ„å»ºç¯å¢ƒï¼ˆæ··åˆæ¨¡å¼ï¼‰ ==="
          
          # ç¡®å®šæœ€ç»ˆä½¿ç”¨çš„è®¾å¤‡åç§°
          if [ -n "${{ github.event.inputs.manual_device_name }}" ]; then
            FINAL_DEVICE_NAME="${{ github.event.inputs.manual_device_name }}"
          else
            FINAL_DEVICE_NAME="${{ github.event.inputs.device_name }}"
          fi
          
          echo "ğŸ“Œ æœ€ç»ˆè®¾å¤‡åç§°: $FINAL_DEVICE_NAME"
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step08_initialize_build_env_hybrid \
            "$FINAL_DEVICE_NAME" \
            "${{ github.event.inputs.version_selection }}" \
            "${{ github.event.inputs.config_mode }}" \
            "${{ github.event.inputs.manual_target }}" \
            "${{ github.event.inputs.manual_subtarget }}"
      #ã€firmware-build.yml-08-endã€‘

      #ã€firmware-build.yml-09ã€‘
      - name: "09. é…ç½®Feedsã€åŠ¨æ€ç¦ç”¨æ’ä»¶ã€‘"
        run: |
          echo "=== æ­¥éª¤09: é…ç½®Feedsã€åŠ¨æ€ç¦ç”¨æ’ä»¶ã€‘ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step11_configure_feeds
      #ã€firmware-build.yml-09-endã€‘

      #ã€firmware-build.yml-10ã€‘
      - name: "10. å®‰è£…TurboACCåŒ…"
        if: github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤10: å®‰è£…TurboACCåŒ… ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step12_install_turboacc
      #ã€firmware-build.yml-10-endã€‘

      #ã€firmware-build.yml-11ã€‘
      - name: "11. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤11: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step13_pre_build_space_check
      #ã€firmware-build.yml-11-endã€‘

      #ã€firmware-build.yml-12ã€‘
      - name: "12. æ™ºèƒ½é…ç½®ç”Ÿæˆã€ä¿®å¤ç‰ˆã€‘"
        run: |
          echo "=== æ­¥éª¤12: æ™ºèƒ½é…ç½®ç”Ÿæˆã€ä¿®å¤ç‰ˆã€‘ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step14_generate_config \
            "${{ github.event.inputs.extra_packages }}"
      #ã€firmware-build.yml-12-endã€‘

      #ã€firmware-build.yml-13ã€‘
      - name: "13. éªŒè¯USBé…ç½®"
        run: |
          echo "=== æ­¥éª¤13: éªŒè¯USBé…ç½® ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step15_verify_usb
      #ã€firmware-build.yml-13-endã€‘

      #ã€firmware-build.yml-14ã€‘
      - name: "14. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯"
        run: |
          echo "=== æ­¥éª¤14: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤14 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          echo "ğŸ”„ è°ƒç”¨ä¸»è„šæœ¬çš„ apply_config å‡½æ•°..."
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step16_apply_config
          
          echo "âœ… æ­¥éª¤14 å®Œæˆ"
      #ã€firmware-build.yml-14-endã€‘

      #ã€firmware-build.yml-15ã€‘
      - name: "15. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤15: ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step17_fix_network
      #ã€firmware-build.yml-15-endã€‘

      #ã€firmware-build.yml-16ã€‘
      - name: "16. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== æ­¥éª¤16: ä¸‹è½½ä¾èµ–åŒ… ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step18_download_deps
      #ã€firmware-build.yml-16-endã€‘

      #ã€firmware-build.yml-17ã€‘
      - name: "17. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤17: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step19_integrate_custom_files
      #ã€firmware-build.yml-17-endã€‘

      #ã€firmware-build.yml-18ã€‘
      - name: "18. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤18: å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step20_pre_build_check
      #ã€firmware-build.yml-18-endã€‘

      #ã€firmware-build.yml-19ã€‘
      - name: "19. ç¼–è¯‘å‰ç©ºé—´ç¡®è®¤"
        run: |
          echo "=== æ­¥éª¤19: ç¼–è¯‘å‰ç©ºé—´ç¡®è®¤ ==="
          
          set -e
          trap 'echo "âŒ æ­¥éª¤19 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          df -h /mnt
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1 | awk '{print $1}')
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
      #ã€firmware-build.yml-19-endã€‘

      #ã€firmware-build.yml-20ã€‘
      - name: "20. ç¼–è¯‘å›ºä»¶"
        run: |
          echo "=== æ­¥éª¤20: ç¼–è¯‘å›ºä»¶ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step22_build_firmware \
            "${{ env.ENABLE_PARALLEL }}"
      #ã€firmware-build.yml-20-endã€‘

      #ã€firmware-build.yml-21ã€‘
      - name: "21. æ£€æŸ¥æ„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤21: æ£€æŸ¥æ„å»ºäº§ç‰© ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step23_check_artifacts
      #ã€firmware-build.yml-21-endã€‘

      #ã€firmware-build.yml-22ã€‘
      - name: "22. ä¸Šä¼ å›ºä»¶"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.TIMESTAMP_SEC }}
          path: /mnt/openwrt-build/bin/targets/
          retention-days: 7
          if-no-files-found: error
      #ã€firmware-build.yml-22-endã€‘

      #ã€firmware-build.yml-23ã€‘
      - name: "23. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== æ­¥éª¤23: ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step24_post_build_space_check
      #ã€firmware-build.yml-23-endã€‘

      #ã€firmware-build.yml-24ã€‘
      - name: "24. ç¼–è¯‘æ€»ç»“"
        if: always()
        run: |
          echo "=== æ­¥éª¤24: ç¼–è¯‘æ€»ç»“ ==="
          
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh \
            step25_build_summary \
            "$FINAL_DEVICE_NAME" \
            "${{ github.event.inputs.version_selection }}" \
            "${{ github.event.inputs.config_mode }}" \
            "${{ env.TIMESTAMP_SEC }}" \
            "${{ github.event.inputs.enable_parallel }}"
      #ã€firmware-build.yml-24-endã€‘
#ã€firmware-build.yml-99ã€‘
# å·¥ä½œæµæ–‡ä»¶ç»“æŸ
#ã€firmware-build.yml-99-endã€‘
