name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ - å®Œæ•´æ’ä»¶ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'è®¾å¤‡åç§° (å¦‚: ac42uç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
          - 23.05
          - 21.02
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ (å¤šä¸ªæ’ä»¶ç”¨ç©ºæ ¼åˆ†éš”)'
        required: false
        type: string
        default: 'luci-app-upnp'
      enable_cache:
        description: 'å¯ç”¨ç¼–è¯‘ç¼“å­˜'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo cmake
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"

    - name: ç‰ˆæœ¬é€‰æ‹©
      id: version-selection
      run: |
        cd $BUILD_DIR
        echo "=== ç‰ˆæœ¬é€‰æ‹© ==="
        
        if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            SELECTED_BRANCH="openwrt-23.05"
        else
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            SELECTED_BRANCH="openwrt-21.02"
        fi
        
        echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
        echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
        echo "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH"

    - name: å…‹éš†æºç 
      run: |
        cd $BUILD_DIR
        echo "=== å…‹éš†æºç  ==="
        echo "ä»“åº“: $SELECTED_REPO_URL"
        echo "åˆ†æ”¯: $SELECTED_BRANCH"
        
        # æ¸…ç†ç›®å½•
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        
        # å…‹éš†æºç 
        git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
        echo "âœ… æºç å…‹éš†å®Œæˆ"

    - name: è®¾å¤‡é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== è®¾å¤‡é…ç½® ==="
        
        # è®¾å¤‡æ˜ å°„
        case "${{ github.event.inputs.device_name }}" in
            "ac42u"|"acrh17")
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="asus_rt-ac42u"
                ;;
            *)
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="${{ github.event.inputs.device_name }}"
                ;;
        esac
        
        echo "TARGET=$TARGET" >> $GITHUB_ENV
        echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
        echo "DEVICE=$DEVICE" >> $GITHUB_ENV
        
        echo "ç›®æ ‡: $TARGET"
        echo "å­ç›®æ ‡: $SUBTARGET"
        echo "è®¾å¤‡: $DEVICE"

    - name: é…ç½®Feeds
      run: |
        cd $BUILD_DIR
        echo "=== é…ç½®Feeds ==="
        
        # æ ¹æ®åˆ†æ”¯é€‰æ‹©feedsç‰ˆæœ¬
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            FEEDS_BRANCH="openwrt-23.05"
        else
            FEEDS_BRANCH="openwrt-21.02"
        fi
        
        echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
        echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… Feedsé…ç½®å®Œæˆ"

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿ ==="
        
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§é…ç½®
        rm -f .config .config.old
        
        # åˆ›å»ºåŸºç¡€é…ç½®
        echo "CONFIG_TARGET_${TARGET}=y" > .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        
        # åŸºç¡€ç³»ç»Ÿç»„ä»¶ï¼ˆæ‰€æœ‰ç‰ˆæœ¬é€šç”¨ï¼‰
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_fstools=y" >> .config
        echo "CONFIG_PACKAGE_libc=y" >> .config
        echo "CONFIG_PACKAGE_libgcc=y" >> .config
        echo "CONFIG_PACKAGE_mtd=y" >> .config
        echo "CONFIG_PACKAGE_netifd=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_procd=y" >> .config
        echo "CONFIG_PACKAGE_ubox=y" >> .config
        echo "CONFIG_PACKAGE_ubus=y" >> .config
        echo "CONFIG_PACKAGE_ubusd=y" >> .config
        echo "CONFIG_PACKAGE_uci=y" >> .config
        echo "CONFIG_PACKAGE_uclient-fetch=y" >> .config
        echo "CONFIG_PACKAGE_usign=y" >> .config
        
        # DNSé…ç½® - ä½¿ç”¨dnsmasq-fullï¼ˆæ‰€æœ‰ç‰ˆæœ¬é€šç”¨ï¼‰
        echo "# CONFIG_PACKAGE_dnsmasq is not set" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dhcp=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dnssec=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_ipset=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_conntrack=y" >> .config
        
        # æ— çº¿é©±åŠ¨ - ä½¿ç”¨ç¤¾åŒºä¼˜åŒ–ç‰ˆæœ¬ï¼ˆæ‰€æœ‰ç‰ˆæœ¬é€šç”¨ï¼‰
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        echo "CONFIG_PACKAGE_ath10k-firmware-qca988x=y" >> .config
        echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
        
        # ç½‘ç»œå·¥å…·ï¼ˆæ‰€æœ‰ç‰ˆæœ¬é€šç”¨ï¼‰
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> .config
        
        # IPv6æ”¯æŒï¼ˆæ‰€æœ‰ç‰ˆæœ¬é€šç”¨ï¼‰
        echo "CONFIG_PACKAGE_ip6tables=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ip6tables=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-nat6=y" >> .config
        
        # ç‰ˆæœ¬æ™ºèƒ½æ£€æµ‹å’Œé…ç½®
        echo "=== ç‰ˆæœ¬æ™ºèƒ½æ£€æµ‹: $SELECTED_BRANCH ==="
        
        # æ£€æµ‹ç‰ˆæœ¬å¹¶è®¾ç½®ç›¸åº”çš„é…ç½®
        if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
            echo "ğŸ”§ æ£€æµ‹åˆ° 21.02 ç‰ˆæœ¬ï¼Œåº”ç”¨ç›¸åº”é…ç½®..."
            
            # 21.02 ç‰¹å®šçš„é…ç½®
            echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            
            # 21.02 æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ - ä½¿ç”¨NTFS3é©±åŠ¨
            echo "# CONFIG_PACKAGE_kmod-fs-ntfs is not set" >> .config
            echo "# CONFIG_PACKAGE_ntfs-3g is not set" >> .config
            echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config
            echo "CONFIG_PACKAGE_automount=y" >> .config
            
            # 21.02 ç‰¹å®šçš„ç¦ç”¨ç»„ä»¶ - ç¡®ä¿å®Œå…¨ç¦ç”¨
            echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Client is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Server is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Xray is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-vssr_INCLUDE_ShadowsocksR_Libev_Server is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Trojan is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray_plugin is not set" >> .config
            
        elif [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            echo "ğŸ”§ æ£€æµ‹åˆ° 23.05 ç‰ˆæœ¬ï¼Œåº”ç”¨ç›¸åº”é…ç½®..."
            
            # 23.05 ç‰¹å®šçš„é…ç½®
            echo "CONFIG_PACKAGE_luci-app-software-offloading=y" >> .config
            
            # 23.05 æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨
            echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config
            echo "# CONFIG_PACKAGE_kmod-fs-ntfs is not set" >> .config
            echo "# CONFIG_PACKAGE_ntfs-3g is not set" >> .config
            
            # 23.05 ç‰¹å®šçš„ç¦ç”¨ç»„ä»¶
            echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_SingBox is not set" >> .config
            echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Geoview is not set" >> .config
            
        else
            echo "âš ï¸  æœªçŸ¥ç‰ˆæœ¬ï¼Œä½¿ç”¨é€šç”¨é…ç½®..."
            # å¯¹äºæœªçŸ¥ç‰ˆæœ¬ï¼Œä½¿ç”¨æœ€å…¼å®¹çš„é…ç½®
            echo "# CONFIG_PACKAGE_kmod-fs-ntfs is not set" >> .config
            echo "# CONFIG_PACKAGE_ntfs-3g is not set" >> .config
        fi
        
        # é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ”¯æŒï¼ˆæ‰€æœ‰ç‰ˆæœ¬ï¼‰
        echo "CONFIG_PACKAGE_block-mount=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        
        # åŸºç¡€é€šç”¨æ’ä»¶ï¼ˆæ‰€æœ‰ç‰ˆæœ¬ï¼‰
        echo "CONFIG_PACKAGE_vlmcsd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vlmcsd=y" >> .config
        echo "CONFIG_PACKAGE_smartdns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        
        # æ–°å¢çš„å®Œæ•´æ’ä»¶åˆ—è¡¨ï¼ˆæ‰€æœ‰ç‰ˆæœ¬ï¼‰- ç¦ç”¨ç½‘ç»œå”¤é†’
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_miniupnpd=y" >> .config
        echo "CONFIG_PACKAGE_vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-arpbind=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-cpulimit=y" >> .config
        echo "CONFIG_PACKAGE_samba4-server=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wechatpush=y" >> .config
        echo "CONFIG_PACKAGE_sqm-scripts=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-sqm=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-hd-idle=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-filetransfer=y" >> .config
        
        # ç£ç›˜ç®¡ç†å’Œå®¶é•¿æ§åˆ¶ - ç¦ç”¨ç½‘ç»œå”¤é†’ç›¸å…³åŠŸèƒ½
        echo "CONFIG_PACKAGE_luci-app-diskman=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-accesscontrol=y" >> .config
        
        # ç¦ç”¨ç½‘ç»œå”¤é†’ç›¸å…³åŠŸèƒ½
        echo "# CONFIG_PACKAGE_luci-app-wol is not set" >> .config
        echo "# CONFIG_PACKAGE_wol is not set" >> .config
        echo "# CONFIG_PACKAGE_etherwake is not set" >> .config
        
        # é€šç”¨ç¦ç”¨ç»„ä»¶ï¼ˆæ‰€æœ‰ç‰ˆæœ¬ï¼‰
        echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Haproxy is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_ShadowsocksR_Libev_Client is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Client is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Server is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Simple_Obfs is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Trojan_Plus is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Plugin is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-ng is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-webui is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ChinaDNS_NG is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_IPT2Socks is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ShadowsocksR_Libev_Client is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Client is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Server is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Simple_Obfs is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Trojan is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Xray is not set" >> .config
        
        # ç”¨æˆ·è‡ªå®šä¹‰åŒ…
        if [ -n "${{ github.event.inputs.extra_packages }}" ]; then
            echo "ğŸ”§ æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰åŒ…: ${{ github.event.inputs.extra_packages }}"
            for pkg in ${{ github.event.inputs.extra_packages }}; do
                echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            done
        fi
        
        echo "âœ… æ™ºèƒ½é…ç½®ç”Ÿæˆå®Œæˆ"
        
        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        echo "=== é…ç½®æ‘˜è¦ ==="
        echo "ç‰ˆæœ¬: $SELECTED_BRANCH"
        echo "ç›®æ ‡è®¾å¤‡: $DEVICE"
        echo "å¯ç”¨çš„åŒ…æ•°é‡: $(grep "^CONFIG_PACKAGE_.*=y$" .config | wc -l)"
        echo "ç½‘ç»œåŠ é€Ÿ: $(grep "turboacc\\|offloading" .config | grep "=y" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')"
        echo "æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨: $(grep "kmod-fs-" .config | grep "=y" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//' | tr '\n' ' ')"

    - name: åº”ç”¨é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== åº”ç”¨é…ç½® ==="
        
        # è¿è¡Œdefconfigæ¥å®Œå–„é…ç½®
        make defconfig
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
        
        # æ˜¾ç¤ºæœ€ç»ˆé…ç½®ä¿¡æ¯
        echo "=== æœ€ç»ˆé…ç½®çŠ¶æ€ ==="
        echo "å¯ç”¨çš„åŒ…æ•°é‡: $(grep "^CONFIG_PACKAGE_.*=y$" .config | wc -l)"
        echo "DNSMASQé…ç½®: $(grep "dnsmasq" .config | grep "=y" | head -1 | sed 's/CONFIG_PACKAGE_//')"
        echo "æ— çº¿é©±åŠ¨: $(grep "ath10k" .config | grep "=y" | head -1 | sed 's/CONFIG_PACKAGE_//')"
        echo "æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨: $(grep "kmod-fs-" .config | grep "=y" | sed 's/CONFIG_PACKAGE_//' | tr '\n' ' ')"
        echo "ç½‘ç»œåŠ é€Ÿæ’ä»¶: $(grep "turboacc\\|offloading" .config | grep "=y" | sed 's/CONFIG_PACKAGE_//')"
        echo "å¯ç”¨çš„LUCIæ’ä»¶:"
        grep "^CONFIG_PACKAGE_luci" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//' | sort
        
        # å¤‡ä»½é…ç½®æ–‡ä»¶ç”¨äºåç»­ä¸Šä¼ 
        cp .config config_backup

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        echo "âœ… ç½‘ç»œç¯å¢ƒä¿®å¤å®Œæˆ"

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd $BUILD_DIR
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        make -j1 download
        echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd $BUILD_DIR
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        
        if [ "${{ github.event.inputs.enable_cache }}" = "true" ]; then
            echo "å¯ç”¨ç¼–è¯‘ç¼“å­˜"
            make -j$(nproc) V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        else
            echo "æ™®é€šç¼–è¯‘æ¨¡å¼"
            make -j$(nproc) V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        fi
        
        echo "ç¼–è¯‘é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
            if [ -f "build.log" ]; then
                echo "=== ç¼–è¯‘é”™è¯¯æ‘˜è¦ ==="
                grep -i "error:\|failed\|undefined" build.log | head -20
            fi
            exit $BUILD_EXIT_CODE
        fi
        echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"

    - name: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        USED_SPACE=$((100 - AVAILABLE_GB * 100 / 50))
        echo "ç¼–è¯‘è¿‡ç¨‹ä½¿ç”¨äº†çº¦ ${USED_SPACE}% çš„å¯ç”¨ç©ºé—´"

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        if [ -d "bin/targets" ]; then
            echo "âœ… å›ºä»¶ç›®å½•å­˜åœ¨"
            find bin/targets -name "*.bin" -o -name "*.img" | while read file; do
                echo "å›ºä»¶æ–‡ä»¶: $file ($(du -h "$file" | cut -f1))"
            done
            
            # æ˜¾ç¤ºå›ºä»¶è¯¦ç»†ä¿¡æ¯
            echo "=== ç”Ÿæˆçš„å›ºä»¶åˆ—è¡¨ ==="
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec ls -la {} \;
        else
            echo "âŒ å›ºä»¶ç›®å½•ä¸å­˜åœ¨"
            exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-full
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-full
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-full
        path: ${{ env.BUILD_DIR }}/config_backup
        retention-days: 7

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•å·²æ¸…ç†"
