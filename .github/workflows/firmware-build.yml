# .github/workflows/firmware-build.yml
name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆ - ç¼–è¯‘å™¨é¢„æ„å»ºç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© - ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ã€‚ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®"
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚"
        required: false
        type: string
        default: ""
      use_git_archive:
        description: "ğŸ“¦ ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  REPO_ROOT: "${{ github.workspace }}"
  COMPILER_ROOT: "${{ github.workspace }}/firmware-config/build-Compiler-file"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºæºä»£ç ï¼ˆè§£å†³å·¥ä½œæµæ–‡ä»¶ç¼ºå¤±é—®é¢˜ï¼‰
      - name: "1. æ£€å‡ºæºä»£ç ï¼ˆå®Œæ•´æ£€å‡ºï¼‰"
        if: github.event.inputs.use_git_archive == 'true'
        run: |
          echo "=== æ­¥éª¤ 1: æ£€å‡ºæºä»£ç ï¼ˆå®Œæ•´æ£€å‡ºï¼‰==="
          echo "ğŸ”„ ä½¿ç”¨å®Œæ•´æ£€å‡ºç¡®ä¿å·¥ä½œæµæ–‡ä»¶å­˜åœ¨..."
          
          # åˆ›å»ºå·¥ä½œåŒºç›®å½•
          mkdir -p ${{ github.workspace }}
          cd ${{ github.workspace }}
          
          # æ£€å‡ºå®Œæ•´ä»“åº“ï¼ˆæµ…å…‹éš†ï¼‰
          git init
          git remote add origin "https://github.com/${{ github.repository }}.git"
          git config core.sparseCheckout false
          git fetch --depth=3 origin main
          git checkout main
          
          # éªŒè¯å·¥ä½œæµæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "éªŒè¯é‡è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨..."
          
          if [ -f ".github/workflows/firmware-build.yml" ]; then
            echo "âœ… å·¥ä½œæµæ–‡ä»¶å­˜åœ¨: .github/workflows/firmware-build.yml"
            echo "å·¥ä½œæµæ–‡ä»¶å¤§å°: $(ls -lh .github/workflows/firmware-build.yml | awk '{print $5}')"
          else
            echo "âŒ å·¥ä½œæµæ–‡ä»¶ç¼ºå¤±"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âœ… ä¸»æ„å»ºè„šæœ¬å­˜åœ¨"
            echo "è„šæœ¬å¤§å°: $(ls -lh firmware-config/scripts/build_firmware_main.sh | awk '{print $5}')"
          else
            echo "âŒ ä¸»æ„å»ºè„šæœ¬ç¼ºå¤±"
            exit 1
          fi
          
          # æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "firmware-config/build-Compiler-file" ]; then
            echo "âœ… ç¼–è¯‘å™¨ç›®å½•å­˜åœ¨ï¼ˆä»“åº“é‡Œï¼‰"
            echo "ç¼–è¯‘å™¨ç›®å½•å¤§å°: $(du -sh firmware-config/build-Compiler-file 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
          else
            echo "âš ï¸ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼ˆä»“åº“é‡Œæ²¡æœ‰ï¼‰"
          fi
          
          echo "âœ… æºä»£ç æ£€å‡ºå®Œæˆ"
      
      # æ­¥éª¤ 2: åˆ é™¤ç¼–è¯‘å™¨å¤§æ–‡ä»¶ç›®å½•ï¼ˆä»…åœ¨å·¥ä½œç©ºé—´ä¸­åˆ é™¤ï¼Œé¿å…2MBé™åˆ¶ï¼‰
      - name: "2. åˆ é™¤ç¼–è¯‘å™¨å¤§æ–‡ä»¶ç›®å½•ï¼ˆå·¥ä½œç©ºé—´ï¼‰"
        if: github.event.inputs.use_git_archive == 'true'
        run: |
          echo "=== æ­¥éª¤ 2: åˆ é™¤ç¼–è¯‘å™¨å¤§æ–‡ä»¶ç›®å½•ï¼ˆå·¥ä½œç©ºé—´ï¼‰==="
          
          COMPILER_DIR="firmware-config/build-Compiler-file"
          echo "è¦åˆ é™¤çš„ç¼–è¯‘å™¨ç›®å½•ï¼ˆå·¥ä½œç©ºé—´ä¸­ï¼‰: $COMPILER_DIR"
          
          if [ -d "$COMPILER_DIR" ]; then
            echo "åˆ é™¤ç¼–è¯‘å™¨ç›®å½•åŠå…¶å†…å®¹ï¼ˆä»…åœ¨æœ¬æ¬¡æ„å»ºçš„å·¥ä½œç©ºé—´ï¼‰..."
            rm -rf "$COMPILER_DIR"
            echo "âœ… ç¼–è¯‘å™¨ç›®å½•å·²ä»å·¥ä½œç©ºé—´åˆ é™¤"
            echo "â„¹ï¸ æ³¨æ„ï¼šè¿™åªä¼šåˆ é™¤æœ¬æ¬¡æ„å»ºå·¥ä½œç©ºé—´çš„å‰¯æœ¬ï¼Œä»“åº“ä¸­çš„ç¼–è¯‘å™¨ç›®å½•ä»ç„¶å­˜åœ¨"
          else
            echo "âš ï¸ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨äºå·¥ä½œç©ºé—´"
          fi
          
          # é‡æ–°åˆ›å»ºç©ºçš„ç¼–è¯‘å™¨ç›®å½•ï¼ˆä¾›åç»­ä½¿ç”¨ï¼‰
          mkdir -p "$COMPILER_DIR"
          echo "ğŸ“ åˆ›å»ºç©ºçš„ç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
      
      # æ­¥éª¤ 3: ç«‹å³ä¸Šä¼ æºä»£ç å¤‡ä»½
      - name: "3. ç«‹å³ä¸Šä¼ æºä»£ç å¤‡ä»½"
        if: github.event.inputs.use_git_archive == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: source-code-backup-${{ github.event.inputs.device_name }}
          path: ${{ github.workspace }}
          retention-days: 1
      
      # æ­¥éª¤ 4: æœ€ç»ˆéªŒè¯æºä»£ç å¤§å°ï¼ˆä¸è¶…è¿‡10MBï¼‰
      - name: "4. æœ€ç»ˆéªŒè¯æºä»£ç å¤§å°"
        if: github.event.inputs.use_git_archive == 'true'
        run: |
          echo "=== æ­¥éª¤ 4: æœ€ç»ˆéªŒè¯æºä»£ç å¤§å° ==="
          echo "ğŸ”„ éªŒè¯å®é™…æºä»£ç å¤§å°ï¼ˆåˆ é™¤ç¼–è¯‘å™¨ç›®å½•åï¼‰..."
          
          REPO_ROOT="${{ github.workspace }}"
          
          # è®¡ç®—å®é™…æºä»£ç å¤§å°ï¼ˆæ’é™¤.gitï¼‰
          REAL_SIZE=0
          while IFS= read -r -d '' file; do
              if [ -f "$file" ]; then
                  size=$(stat -c%s "$file" 2>/dev/null || echo "0")
                  REAL_SIZE=$((REAL_SIZE + size))
              fi
          done < <(find "$REPO_ROOT" -type f ! -path "*/.git/*" -print0 2>/dev/null)
          
          SIZE_LIMIT=$((10 * 1024 * 1024))
          
          echo "æœ€ç»ˆæ£€æŸ¥ - å®é™…æºä»£ç å¤§å°: $((REAL_SIZE / 1024))KB"
          echo "å¤§å°é™åˆ¶: $((SIZE_LIMIT / 1024))KB"
          
          if [ $REAL_SIZE -gt $SIZE_LIMIT ]; then
            echo "âŒ æœ€ç»ˆæ£€æŸ¥å¤±è´¥: å®é™…æºä»£ç å¤§å°è¶…è¿‡10MBé™åˆ¶"
            echo "è¶…å‡º: $((REAL_SIZE - SIZE_LIMIT)) å­—èŠ‚"
            exit 1
          else
            echo "âœ… æœ€ç»ˆæ£€æŸ¥é€šè¿‡: $((REAL_SIZE / 1024))KB < $((SIZE_LIMIT / 1024))KB"
          fi
      
      # æ­¥éª¤ 5: ä½¿ç”¨æ ‡å‡†æ£€å‡ºï¼ˆå½“ä¸ä½¿ç”¨Git Archiveæ—¶ï¼‰
      - name: "5. æ ‡å‡†æ£€å‡ºæºä»£ç "
        if: github.event.inputs.use_git_archive == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤ 6: ä¿®å¤æƒé™é—®é¢˜ï¼ˆå…³é”®ä¿®å¤ï¼‰
      - name: "6. ä¿®å¤æƒé™é—®é¢˜ï¼ˆå…³é”®ä¿®å¤ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 6: ä¿®å¤æƒé™é—®é¢˜ ==="
          echo "âš ï¸ ä¿®å¤æ‰€æœ‰è„šæœ¬çš„æ‰§è¡Œæƒé™..."
          
          # æŸ¥æ‰¾å¹¶ä¿®å¤æ‰€æœ‰è„šæœ¬æ–‡ä»¶çš„æƒé™
          find firmware-config -type f -name "*.sh" -exec chmod +x {} \;
          
          # ä¿®å¤ä¸»è„šæœ¬æƒé™
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            echo "âœ… ä¿®å¤ä¸»è„šæœ¬æƒé™: firmware-config/scripts/build_firmware_main.sh"
          else
            echo "âŒ ä¸»è„šæœ¬ä¸å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
            echo "åˆ—å‡ºfirmware-configç›®å½•å†…å®¹:"
            find firmware-config -type f 2>/dev/null || echo "firmware-configç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # éªŒè¯æƒé™
          echo "éªŒè¯è„šæœ¬æƒé™:"
          ls -la firmware-config/scripts/*.sh 2>/dev/null || echo "scriptsç›®å½•ä¸å­˜åœ¨"
          
          echo "âœ… æƒé™ä¿®å¤å®Œæˆ"
      
      # æ­¥éª¤ 7: æ·±åº¦æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½•
      - name: "7. æ·±åº¦æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 7: æ·±åº¦æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½• ==="
          
          REPO_ROOT="${{ github.workspace }}"
          COMPILER_ROOT="$REPO_ROOT/firmware-config/build-Compiler-file"
          
          echo "ğŸ“ ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
          echo "ğŸ”§ ç¼–è¯‘å™¨æ ¹ç›®å½•: $COMPILER_ROOT"
          
          # æ£€æŸ¥ç¼–è¯‘å™¨æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$COMPILER_ROOT" ]; then
            echo "âš ï¸ ç¼–è¯‘å™¨æ ¹ç›®å½•ä¸å­˜åœ¨äºå·¥ä½œç©ºé—´: $COMPILER_ROOT"
            echo "â„¹ï¸ è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºç¼–è¯‘å™¨å¤§æ–‡ä»¶å¯èƒ½å·²è¢«åˆ é™¤ä»¥é¿å…2MBé™åˆ¶"
            echo "âœ… å°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
          else
            echo "âœ… ç¼–è¯‘å™¨æ ¹ç›®å½•å­˜åœ¨äºå·¥ä½œç©ºé—´"
            
            # æ·±åº¦æœç´¢æ‰€æœ‰å­ç›®å½•å’Œæ–‡ä»¶
            echo "ğŸ” æ·±åº¦æœç´¢ç¼–è¯‘å™¨ç›®å½•ç»“æ„..."
            TOTAL_DIRS=$(find "$COMPILER_ROOT" -type d 2>/dev/null | wc -l)
            TOTAL_FILES=$(find "$COMPILER_ROOT" -type f 2>/dev/null | wc -l)
            
            echo "æ€»ç›®å½•æ•°: $TOTAL_DIRS"
            echo "æ€»æ–‡ä»¶æ•°: $TOTAL_FILES"
            
            if [ $TOTAL_FILES -gt 0 ]; then
              echo "ğŸ“‹ ç›®å½•ç»“æ„:"
              find "$COMPILER_ROOT" -type d 2>/dev/null | sort | while read dir; do
                depth=$(echo "$dir" | tr -cd '/' | wc -c)
                if [ $depth -le 8 ]; then  # æ˜¾ç¤ºå‰8å±‚
                  indent=""
                  for ((i=1; i<=depth; i++)); do indent="$indent  "; done
                  dir_name=$(basename "$dir")
                  file_count=$(find "$dir" -maxdepth 1 -type f 2>/dev/null | wc -l)
                  echo "${indent}ğŸ“ $dir_name/ ($file_count ä¸ªæ–‡ä»¶)"
                fi
              done
              
              # æŸ¥æ‰¾ä»»ä½•gccæ–‡ä»¶
              echo "ğŸ” æŸ¥æ‰¾GCCæ–‡ä»¶..."
              GCC_FILES=$(find "$COMPILER_ROOT" -type f -name "*gcc*" 2>/dev/null)
              GCC_COUNT=$(echo "$GCC_FILES" | wc -l)
              
              if [ $GCC_COUNT -gt 0 ]; then
                echo "âœ… æ‰¾åˆ° $GCC_COUNT ä¸ªGCCæ–‡ä»¶"
                echo "$GCC_FILES" | head -5 | while read file; do
                  if [ -f "$file" ]; then
                    size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
                    relative_path=$(echo "$file" | sed "s|$REPO_ROOT/||")
                    echo "  ğŸ“„ $size - $relative_path"
                  fi
                done
              else
                echo "âŒ æœªæ‰¾åˆ°GCCæ–‡ä»¶"
              fi
            else
              echo "âš ï¸ ç¼–è¯‘å™¨ç›®å½•ä¸ºç©ºï¼ˆæ²¡æœ‰æ–‡ä»¶ï¼‰"
              echo "â„¹ï¸ å¯èƒ½å·²è¢«æ¸…ç†ä»¥é¿å…2MBé™åˆ¶"
            fi
          fi
          
          echo "âœ… ç¼–è¯‘å™¨ç›®å½•æ·±åº¦æ£€æŸ¥å®Œæˆ"
      
      # æ­¥éª¤ 8: æ™ºèƒ½æŸ¥æ‰¾æ­£ç¡®çš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼ˆå¢å¼ºæ·±åº¦æœç´¢ç‰ˆï¼‰
      - name: "8. æ™ºèƒ½æŸ¥æ‰¾æ­£ç¡®çš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼ˆå¢å¼ºæ·±åº¦æœç´¢ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 8: æ™ºèƒ½æŸ¥æ‰¾æ­£ç¡®çš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼ˆå¢å¼ºæ·±åº¦æœç´¢ç‰ˆï¼‰==="
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          REPO_ROOT="${{ github.workspace }}"
          COMPILER_ROOT="$REPO_ROOT/firmware-config/build-Compiler-file"
          
          echo "ğŸ“ ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
          echo "ğŸ”§ ç¼–è¯‘å™¨æ ¹ç›®å½•: $COMPILER_ROOT"
          
          # æ£€æŸ¥ç¼–è¯‘å™¨æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$COMPILER_ROOT" ]; then
            echo "âš ï¸ ç¼–è¯‘å™¨æ ¹ç›®å½•ä¸å­˜åœ¨äºå·¥ä½œç©ºé—´: $COMPILER_ROOT"
            echo "â„¹ï¸ å°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
            echo "COMPILER_DIR=" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "âœ… ç¼–è¯‘å™¨æ ¹ç›®å½•å­˜åœ¨äºå·¥ä½œç©ºé—´"
          
          # ç¡®å®šç›®æ ‡å¹³å°
          DEVICE_NAME="${{ github.event.inputs.device_name }}"
          echo "ğŸ¯ è®¾å¤‡åç§°: $DEVICE_NAME"
          
          # æ ¹æ®è®¾å¤‡ç¡®å®šå¹³å°å’Œæœç´¢å…³é”®è¯
          if [[ "$DEVICE_NAME" == "ac42u" || "$DEVICE_NAME" == "acrh17" ]]; then
            TARGET_PLATFORM="arm"
            SEARCH_KEYWORDS=("arm" "aarch64" "cortex-a7" "cortex-a53" "ipq40xx" "musl" "gcc-11" "binutils")
            echo "ç›®æ ‡å¹³å°: ARM (IPQ40xx)"
            echo "æœç´¢å…³é”®è¯: ${SEARCH_KEYWORDS[*]}"
          elif [[ "$DEVICE_NAME" == "mi_router_4a_gigabit" || "$DEVICE_NAME" == "r4ag" ]]; then
            TARGET_PLATFORM="mips"
            SEARCH_KEYWORDS=("mips" "mipsel" "mt76x8" "24kc" "musl" "gcc-11" "binutils")
            echo "ç›®æ ‡å¹³å°: MIPS (MT76x8)"
            echo "æœç´¢å…³é”®è¯: ${SEARCH_KEYWORDS[*]}"
          elif [[ "$DEVICE_NAME" == "mi_router_3g" || "$DEVICE_NAME" == "r3g" ]]; then
            TARGET_PLATFORM="mips"
            SEARCH_KEYWORDS=("mips" "mipsel" "mt7621" "1004kc" "musl" "gcc-11" "binutils")
            echo "ç›®æ ‡å¹³å°: MIPS (MT7621)"
            echo "æœç´¢å…³é”®è¯: ${SEARCH_KEYWORDS[*]}"
          else
            TARGET_PLATFORM="generic"
            SEARCH_KEYWORDS=("gcc" "compiler" "toolchain" "musl" "binutils")
            echo "ç›®æ ‡å¹³å°: é€šç”¨"
            echo "æœç´¢å…³é”®è¯: ${SEARCH_KEYWORDS[*]}"
          fi
          
          # æ™ºèƒ½æ·±åº¦æœç´¢ç¼–è¯‘å™¨æ–‡ä»¶
          echo ""
          echo "ğŸ” æ™ºèƒ½æ·±åº¦æœç´¢ç¼–è¯‘å™¨æ–‡ä»¶..."
          
          FOUND_COMPILER_DIR=""
          
          # æ–¹æ³•1: æ·±åº¦æœç´¢åŒ…å«å¹³å°å…³é”®è¯çš„ç›®å½•ï¼ˆé€’å½’æœç´¢ï¼‰
          echo "1. æ·±åº¦æœç´¢åŒ…å«å¹³å°å…³é”®è¯çš„ç›®å½•..."
          for keyword in "${SEARCH_KEYWORDS[@]}"; do
            echo "  æœç´¢å…³é”®è¯: $keyword"
            # ä½¿ç”¨findé€’å½’æœç´¢ï¼Œä¸é™åˆ¶æ·±åº¦
            DIRS=$(find "$COMPILER_ROOT" -type d -iname "*$keyword*" 2>/dev/null | head -10)
            if [ -n "$DIRS" ]; then
              echo "  æ‰¾åˆ°ç›®å½•:"
              while read dir; do
                echo "    ğŸ“ $(echo "$dir" | sed "s|$REPO_ROOT/||")"
                
                # åœ¨è¯¥ç›®å½•ä¸­æœç´¢gccæ–‡ä»¶ï¼ˆé€’å½’æœç´¢ï¼‰
                GCC_FILES=$(find "$dir" -type f -iname "*gcc*" 2>/dev/null | head -3)
                if [ -n "$GCC_FILES" ]; then
                  echo "      ğŸ”§ æ‰¾åˆ°GCCæ–‡ä»¶:"
                  for gcc_file in $GCC_FILES; do
                    if [ -f "$gcc_file" ]; then
                      size=$(du -h "$gcc_file" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
                      echo "        ğŸ“„ $size - $(basename "$gcc_file")"
                    fi
                  done
                  FOUND_COMPILER_DIR="$dir"
                  break 2
                fi
              done <<< "$DIRS"
            fi
          done
          
          # æ–¹æ³•2: å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ·±åº¦æœç´¢ä»»ä½•åŒ…å«gccçš„ç›®å½•ï¼ˆé€’å½’æœç´¢ï¼‰
          if [ -z "$FOUND_COMPILER_DIR" ]; then
            echo "2. æ·±åº¦æœç´¢ä»»ä½•åŒ…å«gccçš„ç›®å½•..."
            # ä½¿ç”¨findé€’å½’æœç´¢gccæ–‡ä»¶
            GCC_FILES=$(find "$COMPILER_ROOT" -type f -iname "*gcc*" 2>/dev/null | head -10)
            if [ -n "$GCC_FILES" ]; then
              echo "  æ‰¾åˆ°GCCæ–‡ä»¶:"
              for gcc_file in $GCC_FILES; do
                if [ -f "$gcc_file" ]; then
                  # è·å–æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼ˆå‘ä¸Šä¸¤çº§å¯èƒ½æ˜¯ç¼–è¯‘å™¨æ ¹ç›®å½•ï¼‰
                  dir=$(dirname "$gcc_file")
                  # å¦‚æœæ˜¯binç›®å½•ä¸­çš„gccï¼Œå‘ä¸Šæ‰¾ä¸€çº§
                  if [[ "$dir" == */bin ]]; then
                    dir=$(dirname "$dir")
                  fi
                  size=$(du -h "$gcc_file" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
                  relative_path=$(echo "$dir" | sed "s|$REPO_ROOT/||")
                  echo "    ğŸ“„ $size - $(basename "$gcc_file") (åœ¨ $relative_path)"
                  FOUND_COMPILER_DIR="$dir"
                  break
                fi
              done
            fi
          fi
          
          # æ–¹æ³•3: æœç´¢binç›®å½•ç»“æ„ï¼ˆæ·±åº¦æœç´¢ï¼‰
          if [ -z "$FOUND_COMPILER_DIR" ]; then
            echo "3. æ·±åº¦æœç´¢ç¼–è¯‘å™¨ç›®å½•ç»“æ„..."
            # å¯»æ‰¾åŒ…å«binç›®å½•çš„ç›®å½•ç»“æ„ï¼ˆé€’å½’æœç´¢ï¼‰
            BIN_DIRS=$(find "$COMPILER_ROOT" -type d -name "bin" 2>/dev/null | head -10)
            if [ -n "$BIN_DIRS" ]; then
              echo "  æ‰¾åˆ°binç›®å½•:"
              for bin_dir in $BIN_DIRS; do
                parent_dir=$(dirname "$bin_dir")
                relative_path=$(echo "$parent_dir" | sed "s|$REPO_ROOT/||")
                echo "    ğŸ“ $relative_path (åŒ…å«binç›®å½•)"
                
                # æ£€æŸ¥binç›®å½•ä¸­æ˜¯å¦æœ‰ç¼–è¯‘å™¨
                COMPILER_FILES=$(find "$bin_dir" -type f \( -iname "*gcc*" -o -iname "*g++*" -o -iname "*ar*" -o -iname "*ld*" \) 2>/dev/null | head -3)
                if [ -n "$COMPILER_FILES" ]; then
                  echo "      ğŸ”§ æ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶"
                  FOUND_COMPILER_DIR="$parent_dir"
                  break
                fi
              done
            fi
          fi
          
          # æ–¹æ³•4: æœç´¢ç›®å½•åç§°åŒ…å«ç¼–è¯‘å™¨å…³é”®è¯ï¼ˆæ·±åº¦æœç´¢ï¼‰
          if [ -z "$FOUND_COMPILER_DIR" ]; then
            echo "4. æœç´¢ç›®å½•åç§°åŒ…å«ç¼–è¯‘å™¨å…³é”®è¯..."
            # æœç´¢åŒ…å«ç¼–è¯‘å™¨ç›¸å…³å…³é”®è¯çš„ç›®å½•
            COMPILER_DIRS=$(find "$COMPILER_ROOT" -type d \( -iname "*compiler*" -o -iname "*toolchain*" -o -iname "*gcc*" -o -iname "*binutils*" \) 2>/dev/null | head -10)
            if [ -n "$COMPILER_DIRS" ]; then
              echo "  æ‰¾åˆ°ç¼–è¯‘å™¨ç›¸å…³ç›®å½•:"
              for comp_dir in $COMPILER_DIRS; do
                relative_path=$(echo "$comp_dir" | sed "s|$REPO_ROOT/||")
                echo "    ğŸ“ $relative_path"
                
                # æ£€æŸ¥è¯¥ç›®å½•æ˜¯å¦æœ‰gccæ–‡ä»¶
                if find "$comp_dir" -type f -iname "*gcc*" 2>/dev/null | head -1; then
                  FOUND_COMPILER_DIR="$comp_dir"
                  echo "      âœ… åŒ…å«GCCæ–‡ä»¶"
                  break
                fi
              done
            fi
          fi
          
          # æ–¹æ³•5: å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªåŒ…å«æ–‡ä»¶çš„ç›®å½•
          if [ -z "$FOUND_COMPILER_DIR" ]; then
            echo "5. ä½¿ç”¨ç¬¬ä¸€ä¸ªåŒ…å«æ–‡ä»¶çš„ç›®å½•..."
            # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ…å«æ–‡ä»¶çš„ç›®å½•
            FIRST_DIR_WITH_FILES=$(find "$COMPILER_ROOT" -type d -exec sh -c '[ -n "$(find "$1" -maxdepth 1 -type f -name "*" 2>/dev/null | head -1)" ]' _ {} \; -print 2>/dev/null | head -1)
            if [ -n "$FIRST_DIR_WITH_FILES" ]; then
              relative_path=$(echo "$FIRST_DIR_WITH_FILES" | sed "s|$REPO_ROOT/||")
              echo "  æ‰¾åˆ°åŒ…å«æ–‡ä»¶çš„ç›®å½•: $relative_path"
              FOUND_COMPILER_DIR="$FIRST_DIR_WITH_FILES"
            fi
          fi
          
          # æœ€ç»ˆå†³ç­–
          echo ""
          echo "=== æœç´¢ç»“æœ ==="
          if [ -n "$FOUND_COMPILER_DIR" ]; then
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨ç›®å½•: $FOUND_COMPILER_DIR"
            
            # éªŒè¯ç›®å½•
            echo "ğŸ“Š ç›®å½•éªŒè¯:"
            relative_path=$(echo "$FOUND_COMPILER_DIR" | sed "s|$REPO_ROOT/||")
            echo "  è·¯å¾„: $relative_path"
            echo "  å¤§å°: $(du -sh "$FOUND_COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            echo "  æ–‡ä»¶æ•°: $(find "$FOUND_COMPILER_DIR" -type f 2>/dev/null | wc -l)"
            echo "  ç›®å½•æ•°: $(find "$FOUND_COMPILER_DIR" -type d 2>/dev/null | wc -l)"
            
            # è®¾ç½®ç¯å¢ƒå˜é‡
            echo "COMPILER_DIR=$FOUND_COMPILER_DIR" >> $GITHUB_ENV
            echo "âœ… å·²è®¾ç½®ç¼–è¯‘å™¨ç›®å½•ç¯å¢ƒå˜é‡"
            
          else
            echo "âŒ æœªæ‰¾åˆ°åˆé€‚çš„ç¼–è¯‘å™¨ç›®å½•"
            echo "ğŸ”„ ä½¿ç”¨æ ¹ç›®å½•ä½œä¸ºç¼–è¯‘å™¨ç›®å½•"
            echo "COMPILER_DIR=$COMPILER_ROOT" >> $GITHUB_ENV
            echo "âš ï¸ æ³¨æ„: å°†ä½¿ç”¨æ ¹ç›®å½•ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨é…ç½®ç¼–è¯‘å™¨"
          fi
          
          # æ˜¾ç¤ºå®Œæ•´çš„ç›®å½•ç»“æ„ç”¨äºè°ƒè¯•
          echo ""
          echo "ğŸ“ å®Œæ•´ç›®å½•ç»“æ„ï¼ˆç”¨äºè°ƒè¯•ï¼‰:"
          find "$COMPILER_ROOT" -type d 2>/dev/null | sort | while read dir; do
            depth=$(echo "$dir" | tr -cd '/' | wc -c)
            if [ $depth -le 6 ]; then  # åªæ˜¾ç¤ºå‰6å±‚
              indent=""
              for ((i=1; i<=depth; i++)); do indent="$indent  "; done
              dir_name=$(basename "$dir")
              file_count=$(find "$dir" -maxdepth 1 -type f 2>/dev/null | wc -l)
              relative_path=$(echo "$dir" | sed "s|$REPO_ROOT/||")
              echo "${indent}ğŸ“ $dir_name/ ($file_count ä¸ªæ–‡ä»¶) [$relative_path]"
            fi
          done | head -30
          
          echo ""
          echo "âœ… ç¼–è¯‘å™¨æœç´¢å®Œæˆ"
      
      # æ­¥éª¤ 9: åˆå§‹ç©ºé—´æ£€æŸ¥
      - name: "9. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 9: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
            exit 1
          fi
          echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"
      
      # æ­¥éª¤ 10: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•
      - name: "10. è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 10: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½• ==="
          
          echo "ğŸ”„ æ­¥éª¤ 10.1: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          # è¿è¡Œä¸»è„šæœ¬è®¾ç½®ç¯å¢ƒ
          chmod +x firmware-config/scripts/build_firmware_main.sh
          firmware-config/scripts/build_firmware_main.sh setup_environment
          
          echo "ğŸ”„ æ­¥éª¤ 10.2: åˆ›å»ºæ„å»ºç›®å½•"
          firmware-config/scripts/build_firmware_main.sh create_build_dir
          
          echo "ğŸ”„ æ­¥éª¤ 10.3: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•è®¾ç½®å®Œæˆ"
      
      # æ­¥éª¤ 11: æ·»åŠ  TurboACC æ”¯æŒ
      - name: "11. æ·»åŠ  TurboACC æ”¯æŒ"
        run: firmware-config/scripts/build_firmware_main.sh add_turboacc_support
      
      # æ­¥éª¤ 12: é…ç½®Feeds
      - name: "12. é…ç½®Feeds"
        run: firmware-config/scripts/build_firmware_main.sh configure_feeds
      
      # æ­¥éª¤ 13: å®‰è£… TurboACC åŒ…
      - name: "13. å®‰è£… TurboACC åŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: firmware-config/scripts/build_firmware_main.sh install_turboacc_packages
      
      # æ­¥éª¤ 14: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "14. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: firmware-config/scripts/build_firmware_main.sh pre_build_space_check
      
      # æ­¥éª¤ 15: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
      - name: "15. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 15: æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          echo "ğŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨å¼ºåˆ¶å¯ç”¨"
          firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤ 16: éªŒè¯USBé…ç½®
      - name: "16. éªŒè¯USBé…ç½®"
        run: firmware-config/scripts/build_firmware_main.sh verify_usb_config
      
      # æ­¥éª¤ 17: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "17. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity
      
      # æ­¥éª¤ 18: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "18. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== æ­¥éª¤ 18: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          
          # å…ˆä¿å­˜åŸå§‹é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            cp "${{ env.BUILD_DIR }}/.config" "${{ env.BUILD_DIR }}/.config.original"
            echo "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶"
          fi
          
          # åº”ç”¨é…ç½®
          firmware-config/scripts/build_firmware_main.sh apply_config
          
          # æ£€æŸ¥åº”ç”¨åçš„é…ç½®çŠ¶æ€
          echo "=== æ’ä»¶é…ç½®çŠ¶æ€æ£€æŸ¥ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # å®šä¹‰æ­£å¸¸æ¨¡å¼çš„å®Œæ•´æ’ä»¶åˆ—è¡¨
          declare -A normal_plugins
          normal_plugins["TurboACC ç½‘ç»œåŠ é€Ÿ"]="luci-app-turboacc"
          normal_plugins["UPnP è‡ªåŠ¨ç«¯å£è½¬å‘"]="luci-app-upnp"
          normal_plugins["Samba æ–‡ä»¶å…±äº«"]="luci-app-samba4"
          normal_plugins["ç£ç›˜ç®¡ç†"]="luci-app-diskman"
          normal_plugins["KMS æ¿€æ´»æœåŠ¡"]="luci-app-vlmcsd"
          normal_plugins["SmartDNS æ™ºèƒ½DNS"]="luci-app-smartdns"
          normal_plugins["å®¶é•¿æ§åˆ¶"]="luci-app-accesscontrol"
          normal_plugins["å¾®ä¿¡æ¨é€"]="luci-app-wechatpush"
          normal_plugins["æµé‡æ§åˆ¶ (SQM)"]="luci-app-sqm"
          normal_plugins["FTP æœåŠ¡å™¨"]="luci-app-vsftpd"
          normal_plugins["ARP ç»‘å®š"]="luci-app-arpbind"
          normal_plugins["CPU é™åˆ¶"]="luci-app-cpulimit"
          normal_plugins["ç¡¬ç›˜ä¼‘çœ "]="luci-app-hd-idle"
          
          echo "ğŸ“‹ æ­£å¸¸æ¨¡å¼æ’ä»¶çŠ¶æ€æ£€æŸ¥:"
          
          total_plugins=0
          enabled_plugins=0
          disabled_plugins=0
          
          for plugin_name in "${!normal_plugins[@]}"; do
            plugin_config="${normal_plugins[$plugin_name]}"
            total_plugins=$((total_plugins + 1))
            
            if grep -q "^CONFIG_PACKAGE_${plugin_config}=y" .config; then
              echo "  âœ… $plugin_name: å·²å¯ç”¨"
              enabled_plugins=$((enabled_plugins + 1))
            elif grep -q "^# CONFIG_PACKAGE_${plugin_config} is not set$" .config; then
              echo "  âŒ $plugin_name: å·²ç¦ç”¨"
              disabled_plugins=$((disabled_plugins + 1))
            else
              echo "  âš ï¸  $plugin_name: æœªé…ç½®"
            fi
          done
          
          echo ""
          echo "ğŸ“Š æ’ä»¶çŠ¶æ€ç»Ÿè®¡:"
          echo "  æ€»è®¡: $total_plugins ä¸ªæ’ä»¶"
          echo "  å·²å¯ç”¨: $enabled_plugins ä¸ª"
          echo "  å·²ç¦ç”¨: $disabled_plugins ä¸ª"
          
          # æ£€æŸ¥åŸºç¡€æ¨¡å¼æ˜¯å¦ç¦ç”¨äº†æ’ä»¶
          if [ "${{ github.event.inputs.config_mode }}" = "base" ]; then
            echo ""
            echo "ğŸ”§ åŸºç¡€æ¨¡å¼é…ç½®ç¡®è®¤:"
            if [ $enabled_plugins -eq 0 ]; then
              echo "  âœ… åŸºç¡€æ¨¡å¼: æ‰€æœ‰é¢å¤–æ’ä»¶å·²æ­£ç¡®ç¦ç”¨"
            else
              echo "  âš ï¸  åŸºç¡€æ¨¡å¼: æœ‰ $enabled_plugins ä¸ªæ’ä»¶æœªç¦ç”¨ï¼Œéœ€è¦æ£€æŸ¥"
            fi
          fi
          
          # é¢å¤–æ£€æŸ¥USBé©±åŠ¨çŠ¶æ€
          echo ""
          echo "ğŸ”Œ USBé©±åŠ¨çŠ¶æ€ç¡®è®¤:"
          critical_usb_drivers=("kmod-usb-xhci-hcd" "kmod-usb3" "kmod-usb-dwc3" "kmod-usb-storage" "kmod-scsi-core")
          for driver in "${critical_usb_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
              echo "  âœ… $driver: å·²å¯ç”¨"
            else
              echo "  âŒ $driver: æœªå¯ç”¨ (éœ€è¦ä¿®å¤)"
            fi
          done
          
          echo "âœ… é…ç½®è¯¦æƒ…æ£€æŸ¥å®Œæˆ"
      
      # æ­¥éª¤ 19: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "19. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 19: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
            mkdir -p firmware-config/config-backup
            
            # å¤‡ä»½åˆ°ä»“åº“ç›®å½•
            timestamp=$(date +%Y%m%d_%H%M%S)
            backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$timestamp.config"
            
            cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
            
            # æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶ä¿¡æ¯
            echo "å¤‡ä»½æ–‡ä»¶å¤§å°: $(ls -lh $backup_file | awk '{print $5}')"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      # æ­¥éª¤ 20: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "20. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: firmware-config/scripts/build_firmware_main.sh fix_network
      
      # æ­¥éª¤ 21: ä¸‹è½½ä¾èµ–åŒ…
      - name: "21. ä¸‹è½½ä¾èµ–åŒ…"
        run: firmware-config/scripts/build_firmware_main.sh download_dependencies
      
      # æ­¥éª¤ 22: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "22. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: firmware-config/scripts/build_firmware_main.sh integrate_custom_files
      
      # æ­¥éª¤ 23: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆåŒ…å«ç¼–è¯‘å™¨éªŒè¯ï¼‰
      - name: "23. å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆåŒ…å«ç¼–è¯‘å™¨éªŒè¯ï¼‰"
        run: firmware-config/scripts/build_firmware_main.sh pre_build_error_check
      
      # æ­¥éª¤ 24: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "24. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 24: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          # æ£€æŸ¥ç¼–è¯‘æ‰€éœ€ç©ºé—´
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
      
      # æ­¥éª¤ 25: ç¼–è¯‘å›ºä»¶
      - name: "25. ç¼–è¯‘å›ºä»¶"
        run: |
          echo "=== æ­¥éª¤ 25: ç¼–è¯‘å›ºä»¶ ==="
          echo "ğŸ”§ ä½¿ç”¨å¢å¼ºçš„ç¼–è¯‘å™¨æœç´¢å’Œè°ƒç”¨åŠŸèƒ½..."
          
          # æ˜¾ç¤ºç¼–è¯‘å™¨ä¿¡æ¯
          echo "ğŸ“Œ ç¼–è¯‘å™¨è°ƒç”¨ä¿¡æ¯:"
          echo "  ç¼–è¯‘å™¨æ ¹ç›®å½•: ${{ env.COMPILER_ROOT }}"
          echo "  ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}"
          
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼Œå°†å°è¯•è°ƒç”¨é¢„æ„å»ºç¼–è¯‘å™¨..."
          
          # å¯ç”¨ç¼–è¯‘ç¼“å­˜ï¼Œä½¿ç”¨å¹¶è¡Œç¼–è¯‘
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          firmware-config/scripts/build_firmware_main.sh build_firmware "true"
      
      # æ­¥éª¤ 26: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: "26. æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 26: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰© ==="
          cd ${{ env.BUILD_DIR }}
          
          # åˆ›å»ºæ„å»ºäº§ç‰©ç›®å½•
          mkdir -p /tmp/build-artifacts
          
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ–‡ä»¶ï¼Œé¿å…é‡å¤ä¸Šä¼ 
          echo "ğŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ„å»ºäº§ç‰©..."
          need_upload=false
          
          # æ‰“åŒ…å›ºä»¶æ–‡ä»¶
          if [ -d "bin/targets" ]; then
            echo "æ‰“åŒ…å›ºä»¶æ–‡ä»¶..."
            tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°
            firmware_size=$(stat -c%s /tmp/build-artifacts/firmware.tar.gz 2>/dev/null || echo "0")
            if [ $firmware_size -gt 0 ]; then
              echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆï¼Œå¤§å°: $(du -h /tmp/build-artifacts/firmware.tar.gz | cut -f1)"
              need_upload=true
            else
              echo "âš ï¸ å›ºä»¶æ‰“åŒ…å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            fi
          else
            echo "âš ï¸ bin/targetsç›®å½•ä¸å­˜åœ¨"
          fi
          
          # æ‰“åŒ…ç¼–è¯‘æ—¥å¿—
          if [ -f "build.log" ]; then
            echo "æ‰“åŒ…ç¼–è¯‘æ—¥å¿—..."
            cp build.log /tmp/build-artifacts/build.log
            echo "âœ… æ—¥å¿—æ‰“åŒ…å®Œæˆ"
            need_upload=true
          fi
          
          # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
          echo "æ„å»ºæ—¶é—´: $(date)" > /tmp/build-artifacts/build-info.txt
          echo "è®¾å¤‡: ${{ env.DEVICE }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/build-info.txt
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}" >> /tmp/build-artifacts/build-info.txt
          
          if [ "$need_upload" = true ]; then
            echo "âœ… æ„å»ºäº§ç‰©å‡†å¤‡å®Œæˆ"
            echo "ğŸ“¤ æ„å»ºäº§ç‰©å·²ä¿å­˜åœ¨: /tmp/build-artifacts/"
            ls -lh /tmp/build-artifacts/
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„æ„å»ºäº§ç‰©"
          fi
      
      # æ­¥éª¤ 27: ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•
      - name: "27. ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
      
      # æ­¥éª¤ 28: ä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "28. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      # æ­¥éª¤ 29: æ‰§è¡Œé”™è¯¯åˆ†æ
      - name: "29. æ‰§è¡Œé”™è¯¯åˆ†æ"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 29: æ‰§è¡Œé”™è¯¯åˆ†æ ==="
          
          # æ£€æŸ¥é”™è¯¯åˆ†æè„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ -f "firmware-config/scripts/error_analysis.sh" ]; then
            echo "âœ… æ‰¾åˆ°é”™è¯¯åˆ†æè„šæœ¬"
            chmod +x firmware-config/scripts/error_analysis.sh
            firmware-config/scripts/error_analysis.sh
          else
            echo "âš ï¸ é”™è¯¯åˆ†æè„šæœ¬ä¸å­˜åœ¨ï¼Œåˆ›å»ºç®€æ˜“åˆ†æ..."
            
            # åˆ›å»ºç®€æ˜“é”™è¯¯åˆ†æ
            echo "ç®€æ˜“é”™è¯¯åˆ†ææŠ¥å‘Š:" > /tmp/error-analysis.txt
            echo "========================" >> /tmp/error-analysis.txt
            
            if [ -f "${{ env.BUILD_DIR }}/build.log" ]; then
              echo "ğŸ“Š ç¼–è¯‘æ—¥å¿—åˆ†æ:" >> /tmp/error-analysis.txt
              echo "æ–‡ä»¶å¤§å°: $(ls -lh ${{ env.BUILD_DIR }}/build.log | awk '{print $5}')" >> /tmp/error-analysis.txt
              
              # æ£€æŸ¥å¸¸è§é”™è¯¯
              ERROR_COUNT=$(grep -c -i "error\|failed" ${{ env.BUILD_DIR }}/build.log || echo "0")
              WARNING_COUNT=$(grep -c -i "warning" ${{ env.BUILD_DIR }}/build.log || echo "0")
              
              echo "é”™è¯¯æ•°é‡: $ERROR_COUNT" >> /tmp/error-analysis.txt
              echo "è­¦å‘Šæ•°é‡: $WARNING_COUNT" >> /tmp/error-analysis.txt
              
              if [ $ERROR_COUNT -gt 0 ]; then
                echo "å‰10ä¸ªé”™è¯¯:" >> /tmp/error-analysis.txt
                grep -i "error\|failed" ${{ env.BUILD_DIR }}/build.log | head -10 >> /tmp/error-analysis.txt
              fi
              
              echo "âœ… ç®€æ˜“åˆ†æå®Œæˆ"
              cat /tmp/error-analysis.txt
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°ç¼–è¯‘æ—¥å¿—"
            fi
          fi
      
      # æ­¥éª¤ 30: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "30. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: firmware-config/scripts/build_firmware_main.sh post_build_space_check
