# .github/workflows/firmware-build.yml
name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆ - å®˜æ–¹SDKç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© - ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ã€‚ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ "
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚"
        required: false
        type: string
        default: ""

env:
  BUILD_DIR: "/mnt/openwrt-build"
  REPO_ROOT: "${{ github.workspace }}"
  ENABLE_STEP_LOGS: "true"  # å¯ç”¨æ­¥éª¤æ—¥å¿—è®°å½•

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤ 1: å®Œæ•´æ£€å‡ºä»£ç ï¼ˆä¿®å¤ç‰ˆï¼‰
      - name: "1. å®Œæ•´æ£€å‡ºä»£ç ï¼ˆä¿®å¤ç‰ˆï¼‰"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥éª¤ 2: ä¸‹è½½æºä»£ç å’ŒéªŒè¯
      - name: "2. ä¸‹è½½æºä»£ç å’ŒéªŒè¯"
        run: |
          echo "=== æ­¥éª¤ 2: ä¸‹è½½æºä»£ç å’ŒéªŒè¯ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}"
          echo "å·¥ä½œæµè¿è¡Œå·: ${{ github.run_number }}"
          echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "æ„å»ºæ—¶é—´æˆ³: ${{ github.run_id }}"
          echo ""
          
          # æ˜¾ç¤ºå·¥ä½œåŒºä¿¡æ¯
          echo "ğŸ“ å·¥ä½œåŒºç›®å½•: ${{ github.workspace }}"
          echo "ğŸ“Š å·¥ä½œåŒºå¤§å°: $(du -sh ${{ github.workspace }} | cut -f1)"
          echo ""
          
          # æ˜¾ç¤ºå½“å‰ç›®å½•å†…å®¹
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          echo ""
          
          # ç®€å•éªŒè¯firmware-configç›®å½•
          echo "ğŸ” ç®€å•éªŒè¯ firmware-config ç›®å½•..."
          if [ -d "firmware-config" ]; then
            echo "âœ… firmware-config ç›®å½•å­˜åœ¨"
            echo "ğŸ“Š ç›®å½•å†…å®¹:"
            ls -la firmware-config/
          else
            echo "âŒ firmware-config ç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          echo "âœ… æ­¥éª¤2å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 3: ä¸Šä¼ æºä»£ç Artifacts
      - name: "3. ä¸Šä¼ æºä»£ç Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: source-${{ github.event.inputs.device_name }}-${{ github.run_id }}
          path: ${{ github.workspace }}
          retention-days: 7
          if-no-files-found: error
      
      # æ­¥éª¤ 4: ä¿®å¤æƒé™é—®é¢˜
      - name: "4. ä¿®å¤æƒé™é—®é¢˜"
        run: |
          echo "=== æ­¥éª¤ 4: ä¿®å¤æƒé™é—®é¢˜ ==="
          echo "ğŸ”§ ä¿®å¤æ‰€æœ‰è„šæœ¬çš„æ‰§è¡Œæƒé™..."
          
          # è®¾ç½®ä¸»è„šæœ¬æƒé™
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            echo "âœ… ä¿®å¤ä¸»è„šæœ¬æƒé™: firmware-config/scripts/build_firmware_main.sh"
          else
            echo "âŒ ä¸»è„šæœ¬ä¸å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
            exit 1
          fi
          
          # è®¾ç½®é”™è¯¯åˆ†æè„šæœ¬æƒé™
          if [ -f "firmware-config/scripts/error_analysis.sh" ]; then
            chmod +x firmware-config/scripts/error_analysis.sh
            echo "âœ… ä¿®å¤é”™è¯¯åˆ†æè„šæœ¬æƒé™: firmware-config/scripts/error_analysis.sh"
          fi
          
          echo "âœ… æƒé™ä¿®å¤å®Œæˆ"
      
      # æ­¥éª¤ 5: åˆå§‹ç©ºé—´æ£€æŸ¥
      - name: "5. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 5: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          echo "æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          echo "ğŸ“Š ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h
          
          echo ""
          echo "ğŸ“Š /mnt åˆ†åŒºè¯¦ç»†ä¿¡æ¯:"
          df -h /mnt
          
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50Gï¼Œå½“å‰åªæœ‰${AVAILABLE_GB}G"
            exit 1
          fi
          echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"
      
      # æ­¥éª¤ 6: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•
      - name: "6. è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 6: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½• ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          echo "ğŸ”„ æ­¥éª¤ 6.1: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          chmod +x firmware-config/scripts/build_firmware_main.sh
          firmware-config/scripts/build_firmware_main.sh setup_environment
          
          echo "ğŸ”„ æ­¥éª¤ 6.2: åˆ›å»ºæ„å»ºç›®å½•"
          firmware-config/scripts/build_firmware_main.sh create_build_dir
          
          echo "ğŸ”„ æ­¥éª¤ 6.3: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•è®¾ç½®å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 7: ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆç‹¬ç«‹æ­¥éª¤ï¼‰
      - name: "7. ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆç‹¬ç«‹æ­¥éª¤ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 7: ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆç‹¬ç«‹æ­¥éª¤ï¼‰==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸš€ å¼€å§‹ä¸‹è½½OpenWrtå®˜æ–¹SDKå·¥å…·é“¾..."
          
          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x firmware-config/scripts/build_firmware_main.sh
          
          # æ‰§è¡ŒSDKä¸‹è½½
          firmware-config/scripts/build_firmware_main.sh initialize_compiler_env "${{ github.event.inputs.device_name }}"
          
          echo "âœ… SDKä¸‹è½½æ­¥éª¤å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 8: éªŒè¯SDKä¸‹è½½ç»“æœï¼ˆä¿®å¤ç‰ˆï¼‰- å¢å¼ºæ—¥å¿—
      - name: "8. éªŒè¯SDKä¸‹è½½ç»“æœï¼ˆä¿®å¤ç‰ˆï¼‰- å¢å¼ºæ—¥å¿—"
        run: |
          echo "=== æ­¥éª¤ 8: éªŒè¯SDKä¸‹è½½ç»“æœï¼ˆä¿®å¤ç‰ˆï¼‰- å¢å¼ºæ—¥å¿— ==="
          echo "éªŒè¯æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          echo "ğŸ” æ£€æŸ¥SDKä¸‹è½½ç»“æœ..."
          
          # æ˜¾ç¤ºæ‰€æœ‰å¯èƒ½çš„ç¯å¢ƒæ–‡ä»¶
          echo "ğŸ” æŸ¥æ‰¾ç¯å¢ƒæ–‡ä»¶..."
          find /mnt/openwrt-build -name "*.sh" -type f 2>/dev/null | head -5
          
          # é¦–å…ˆåŠ è½½ç¯å¢ƒå˜é‡
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… ä»ç¯å¢ƒæ–‡ä»¶åŠ è½½å˜é‡: COMPILER_DIR=$COMPILER_DIR"
          else
            echo "âš ï¸ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨: /mnt/openwrt-build/build_env.sh"
            echo "ğŸ” æ‰‹åŠ¨æœç´¢ç¼–è¯‘å™¨ç›®å½•..."
          fi
          
          # æ£€æŸ¥SDKç›®å½•
          if [ -d "/mnt/openwrt-build/sdk" ]; then
            echo "âœ… SDKç›®å½•å­˜åœ¨: /mnt/openwrt-build/sdk"
            echo "ğŸ“Š SDKç›®å½•å¤§å°: $(du -sh /mnt/openwrt-build/sdk 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            echo "ğŸ“ SDKç›®å½•å†…å®¹:"
            ls -la /mnt/openwrt-build/sdk/ 2>/dev/null | head -10 || echo "æ— æ³•åˆ—å‡º"
          else
            echo "âŒ SDKç›®å½•ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½•
          COMPILER_DIR_OVERRIDE="/mnt/openwrt-build/sdk/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi"
          
          if [ -d "$COMPILER_DIR_OVERRIDE" ]; then
            echo "âœ… ç¼–è¯‘å™¨ç›®å½•å­˜åœ¨: $COMPILER_DIR_OVERRIDE"
            echo "ğŸ“Š ç¼–è¯‘å™¨ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR_OVERRIDE" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            
            # æŸ¥æ‰¾GCCç¼–è¯‘å™¨
            echo "ğŸ” æŸ¥æ‰¾GCCç¼–è¯‘å™¨..."
            GCC_FILE=$(find "$COMPILER_DIR_OVERRIDE" -type f -executable \
              -name "*gcc" \
              ! -name "*gcc-ar" \
              ! -name "*gcc-ranlib" \
              ! -name "*gcc-nm" \
              2>/dev/null | head -1)
            
            if [ -n "$GCC_FILE" ]; then
              echo "âœ… æ‰¾åˆ°GCCç¼–è¯‘å™¨: $(basename "$GCC_FILE")"
              echo "ğŸ”§ GCCç‰ˆæœ¬: $("$GCC_FILE" --version 2>&1 | head -1)"
              echo "ğŸ”§ å®Œæ•´è·¯å¾„: $GCC_FILE"
            else
              echo "âš ï¸ æœªæ‰¾åˆ°çœŸæ­£çš„GCCç¼–è¯‘å™¨"
              echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰gccç›¸å…³æ–‡ä»¶:"
              find "$COMPILER_DIR_OVERRIDE" -name "*gcc*" -type f 2>/dev/null | head -10
            fi
            
            # å¼ºåˆ¶è®¾ç½®ç¯å¢ƒå˜é‡
            echo "ğŸ”§ å¼ºåˆ¶è®¾ç½®COMPILER_DIRç¯å¢ƒå˜é‡"
            export COMPILER_DIR="$COMPILER_DIR_OVERRIDE"
            echo "COMPILER_DIR=$COMPILER_DIR" >> $GITHUB_ENV
            echo "export COMPILER_DIR=\"$COMPILER_DIR\"" > /mnt/openwrt-build/build_env.sh
            echo "âœ… å·²åˆ›å»º/æ›´æ–°ç¯å¢ƒæ–‡ä»¶"
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨: $COMPILER_DIR_OVERRIDE"
            echo "ğŸ” æœç´¢å…¶ä»–å¯èƒ½çš„ç¼–è¯‘å™¨ç›®å½•..."
            find /mnt/openwrt-build -name "toolchain-*" -type d 2>/dev/null | head -5
          fi
          
          echo "âœ… SDKéªŒè¯å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 9: æ·»åŠ  TurboACC æ”¯æŒ
      - name: "9. æ·»åŠ  TurboACC æ”¯æŒ"
        run: |
          echo "=== æ­¥éª¤ 9: æ·»åŠ  TurboACC æ”¯æŒ ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          firmware-config/scripts/build_firmware_main.sh add_turboacc_support
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 10: é…ç½®Feeds
      - name: "10. é…ç½®Feeds"
        run: |
          echo "=== æ­¥éª¤ 10: é…ç½®Feeds ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          firmware-config/scripts/build_firmware_main.sh configure_feeds
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 11: å®‰è£… TurboACC åŒ…
      - name: "11. å®‰è£… TurboACC åŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤ 11: å®‰è£… TurboACC åŒ… ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          firmware-config/scripts/build_firmware_main.sh install_turboacc_packages
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 12: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "12. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 12: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          echo "æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          firmware-config/scripts/build_firmware_main.sh pre_build_space_check
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 13: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
      - name: "13. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 13: æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼"
          firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 14: éªŒè¯USBé…ç½®
      - name: "14. éªŒè¯USBé…ç½®"
        run: |
          echo "=== æ­¥éª¤ 14: éªŒè¯USBé…ç½® ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          firmware-config/scripts/build_firmware_main.sh verify_usb_config
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 15: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "15. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 15: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 16: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "16. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== æ­¥éª¤ 16: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # å…ˆä¿å­˜åŸå§‹é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            cp "${{ env.BUILD_DIR }}/.config" "${{ env.BUILD_DIR }}/.config.original"
            echo "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶"
          fi
          
          # åº”ç”¨é…ç½®
          firmware-config/scripts/build_firmware_main.sh apply_config
          
          echo "âœ… é…ç½®è¯¦æƒ…æ£€æŸ¥å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 17: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "17. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 17: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh "${{ env.BUILD_DIR }}/.config" | awk '{print $5}')"
            echo "ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < "${{ env.BUILD_DIR }}/.config")"
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
            mkdir -p firmware-config/config-backup
            
            # å¤‡ä»½åˆ°ä»“åº“ç›®å½•
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${TIMESTAMP}.config"
            
            cp "${{ env.BUILD_DIR }}/.config" "$BACKUP_FILE"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $BACKUP_FILE"
            echo "ğŸ“Š å¤‡ä»½æ–‡ä»¶å¤§å°: $(ls -lh "$BACKUP_FILE" | awk '{print $5}')"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      # æ­¥éª¤ 18: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "18. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤ 18: ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          firmware-config/scripts/build_firmware_main.sh fix_network
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 19: ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¸¦é‡è¯•ï¼‰- å¢å¼ºæ—¥å¿—
      - name: "19. ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¸¦é‡è¯•ï¼‰- å¢å¼ºæ—¥å¿—"
        run: |
          echo "=== æ­¥éª¤ 19: ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¸¦é‡è¯•ï¼‰- å¢å¼ºæ—¥å¿— ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ç¡®ä¿ç¯å¢ƒå˜é‡åŠ è½½
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: COMPILER_DIR=$COMPILER_DIR"
          fi
          
          # æœ€å¤šé‡è¯•3æ¬¡
          for i in {1..3}; do
            echo "ğŸ” ä¸‹è½½ä¾èµ–åŒ… - ç¬¬ $i æ¬¡å°è¯•"
            
            # åˆ›å»ºè¯¦ç»†æ—¥å¿—æ–‡ä»¶
            LOG_FILE="/tmp/download_log_attempt_$i.txt"
            
            echo "=== ä¸‹è½½ä¾èµ–åŒ…è¯¦ç»†æ—¥å¿— - ç¬¬ $i æ¬¡å°è¯• ===" > $LOG_FILE
            echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $LOG_FILE
            
            # æ‰§è¡Œä¸‹è½½ï¼Œè®°å½•è¯¦ç»†æ—¥å¿—
            firmware-config/scripts/build_firmware_main.sh download_dependencies 2>&1 | tee -a $LOG_FILE
            
            DOWNLOAD_EXIT_CODE=${PIPESTATUS[0]}
            
            echo "é€€å‡ºä»£ç : $DOWNLOAD_EXIT_CODE" >> $LOG_FILE
            echo "ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $LOG_FILE
            
            # æ£€æŸ¥ä¸‹è½½ç»“æœ
            dl_count=$(find ${{ env.BUILD_DIR }}/dl -type f 2>/dev/null | wc -l)
            echo "ğŸ“Š ä¾èµ–åŒ…æ•°é‡: $dl_count ä¸ª"
            
            # åˆ†ææ—¥å¿—ä¸­çš„é”™è¯¯
            ERROR_COUNT=$(grep -c -i "error\|failed\|404\|not found" $LOG_FILE 2>/dev/null || echo "0")
            echo "ğŸ“Š ä¸‹è½½é”™è¯¯æ•°é‡: $ERROR_COUNT ä¸ª"
            
            if [ $DOWNLOAD_EXIT_CODE -eq 0 ] && [ $dl_count -gt 100 ] && [ $ERROR_COUNT -lt 10 ]; then
              echo "âœ… ä¾èµ–åŒ…ä¸‹è½½æˆåŠŸ"
              
              # æ˜¾ç¤ºä¸‹è½½ç»Ÿè®¡
              echo "ğŸ“ˆ ä¸‹è½½ç»Ÿè®¡:"
              echo "  ä¾èµ–åŒ…æ€»æ•°: $dl_count"
              echo "  ä¸‹è½½é”™è¯¯: $ERROR_COUNT"
              
              # æ˜¾ç¤ºå¸¸è§é”™è¯¯ï¼ˆå¦‚æœæœ‰ï¼‰
              if [ $ERROR_COUNT -gt 0 ]; then
                echo "âš ï¸ ä¸‹è½½è¿‡ç¨‹ä¸­çš„é”™è¯¯:"
                grep -i "error\|failed\|404\|not found" $LOG_FILE | head -5
              fi
              
              break
            else
              echo "âš ï¸ ç¬¬ $i æ¬¡ä¸‹è½½ä¸å®Œæ•´æˆ–æœ‰é”™è¯¯ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
              echo "  é€€å‡ºä»£ç : $DOWNLOAD_EXIT_CODE"
              echo "  ä¾èµ–åŒ…æ•°é‡: $dl_count (æœŸæœ›>100)"
              echo "  é”™è¯¯æ•°é‡: $ERROR_COUNT"
              
              # æ˜¾ç¤ºå…·ä½“é”™è¯¯
              if [ $ERROR_COUNT -gt 0 ]; then
                echo "  å…·ä½“é”™è¯¯:"
                grep -i "error\|failed\|404\|not found" $LOG_FILE | head -3
              fi
              
              sleep 10
            fi
          done
          
          # æœ€ç»ˆæ£€æŸ¥
          dl_count=$(find ${{ env.BUILD_DIR }}/dl -type f 2>/dev/null | wc -l)
          echo "ğŸ“Š æœ€ç»ˆä¾èµ–åŒ…æ•°é‡: $dl_count ä¸ª"
          
          if [ $dl_count -lt 50 ]; then
            echo "âŒ ä¾èµ–åŒ…æ•°é‡ä¸è¶³ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥"
            echo "ğŸ’¡ å»ºè®®æ‰‹åŠ¨ä¸‹è½½æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥"
            
            # æ˜¾ç¤ºdlç›®å½•å†…å®¹
            echo "ğŸ“ dlç›®å½•å†…å®¹:"
            ls -la ${{ env.BUILD_DIR }}/dl/ 2>/dev/null | head -10
          else
            echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 20: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "20. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 20: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          firmware-config/scripts/build_firmware_main.sh integrate_custom_files
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ - å¢å¼ºæ—¥å¿—
      - name: "21. å‰ç½®é”™è¯¯æ£€æŸ¥ - å¢å¼ºæ—¥å¿—"
        run: |
          echo "=== æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ - å¢å¼ºæ—¥å¿— ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ç¡®ä¿ç¯å¢ƒå˜é‡åŠ è½½
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: COMPILER_DIR=$COMPILER_DIR"
          fi
          
          # è¯¦ç»†æ£€æŸ¥ç¯å¢ƒ
          echo "ğŸ” è¯¦ç»†ç¯å¢ƒæ£€æŸ¥:"
          echo "  æ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          echo "  è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "  ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}"
          echo "  é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "  ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}"
          
          # æ£€æŸ¥å…³é”®ç›®å½•
          echo "ğŸ” å…³é”®ç›®å½•æ£€æŸ¥:"
          for dir in "${{ env.BUILD_DIR }}" "${{ env.BUILD_DIR }}/dl" "${{ env.BUILD_DIR }}/feeds"; do
            if [ -d "$dir" ]; then
              echo "  âœ… $dir: å­˜åœ¨"
            else
              echo "  âŒ $dir: ä¸å­˜åœ¨"
            fi
          done
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          echo "ğŸ” å…³é”®æ–‡ä»¶æ£€æŸ¥:"
          for file in "${{ env.BUILD_DIR }}/.config" "${{ env.BUILD_DIR }}/Makefile" "${{ env.BUILD_DIR }}/feeds.conf.default"; do
            if [ -f "$file" ]; then
              echo "  âœ… $file: å­˜åœ¨"
            else
              echo "  âŒ $file: ä¸å­˜åœ¨"
            fi
          done
          
          # æ‰§è¡Œå‰ç½®é”™è¯¯æ£€æŸ¥
          firmware-config/scripts/build_firmware_main.sh pre_build_error_check
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 22: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "22. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 22: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          echo "æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
      
      # æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶å‰æ˜¾ç¤ºSDKä¿¡æ¯ - ä¿®å¤ç‰ˆ
      - name: "23. ç¼–è¯‘å›ºä»¶å‰æ˜¾ç¤ºSDKä¿¡æ¯ - ä¿®å¤ç‰ˆ"
        run: |
          echo "=== æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶å‰æ˜¾ç¤ºSDKä¿¡æ¯ - ä¿®å¤ç‰ˆ ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”§ ä½¿ç”¨OpenWrtå®˜æ–¹SDKå·¥å…·é“¾..."
          
          # ç¡®ä¿ç¯å¢ƒå˜é‡åŠ è½½
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… ä»ç¯å¢ƒæ–‡ä»¶åŠ è½½å˜é‡"
          fi
          
          # æ˜¾ç¤ºç¼–è¯‘å™¨ä¿¡æ¯
          echo "ğŸ“Œ ç¼–è¯‘å™¨ä¿¡æ¯:"
          echo "  è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "  ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}"
          echo "  ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "  ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}"
          
          if [ -n "${{ env.COMPILER_DIR }}" ] && [ -d "${{ env.COMPILER_DIR }}" ]; then
            echo "  âœ… SDKå·¥å…·é“¾å·²ä¸‹è½½"
            echo "ğŸ” æŸ¥æ‰¾GCCç¼–è¯‘å™¨ç‰ˆæœ¬:"
            
            # æ­£ç¡®è·å–GCCç‰ˆæœ¬
            GCC_FILE=$(find "${{ env.COMPILER_DIR }}" -type f -executable \
              -name "*gcc" \
              ! -name "*gcc-ar" \
              ! -name "*gcc-ranlib" \
              ! -name "*gcc-nm" \
              2>/dev/null | head -1)
            
            if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
              echo "  ğŸ”§ æ‰¾åˆ°GCCç¼–è¯‘å™¨: $(basename "$GCC_FILE")"
              echo "  ğŸ“ å®Œæ•´è·¯å¾„: $GCC_FILE"
              
              # ç›´æ¥è°ƒç”¨GCCè·å–ç‰ˆæœ¬
              if "$GCC_FILE" --version 2>&1 | head -1; then
                echo "  âœ… æˆåŠŸè·å–GCCç‰ˆæœ¬"
              else
                echo "  âŒ æ— æ³•è·å–GCCç‰ˆæœ¬"
              fi
            else
              echo "  âš ï¸ æœªæ‰¾åˆ°å¯æ‰§è¡Œçš„GCCç¼–è¯‘å™¨"
              echo "  ğŸ” æŸ¥æ‰¾æ‰€æœ‰gccç›¸å…³æ–‡ä»¶:"
              find "${{ env.COMPILER_DIR }}" -name "*gcc*" -type f 2>/dev/null | head -5
            fi
          else
            echo "  â„¹ï¸ æœªä½¿ç”¨é¢„ä¸‹è½½SDKï¼Œå°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 24: ç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼‰- ä¿®å¤ç‰ˆ
      - name: "24. ç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼‰- ä¿®å¤ç‰ˆ"
        run: |
          echo "=== æ­¥éª¤ 24: ç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼‰- ä¿®å¤ç‰ˆ ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘..."
          
          # ç¡®ä¿ç¯å¢ƒå˜é‡åŠ è½½
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: COMPILER_DIR=$COMPILER_DIR"
          fi
          
          # åˆ›å»ºæ—¥å¿—ç›®å½•
          mkdir -p /tmp/build-logs
          
          # è®°å½•å¼€å§‹æ—¶é—´
          echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" > /tmp/build-logs/compile_start.log
          echo "å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}" >> /tmp/build-logs/compile_start.log
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}" >> /tmp/build-logs/compile_start.log
          echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-logs/compile_start.log
          echo "ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}" >> /tmp/build-logs/compile_start.log
          
          # æ‰§è¡Œç¼–è¯‘ï¼ŒåŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ—¥å¿—æ–‡ä»¶
          echo "æ‰§è¡Œç¼–è¯‘å‘½ä»¤..."
          
          # åˆ›å»ºç¼–è¯‘è¯¦ç»†æ—¥å¿—æ–‡ä»¶
          COMPILE_LOG="/tmp/build-logs/compile_detailed.log"
          echo "=== OpenWrtå›ºä»¶ç¼–è¯‘è¯¦ç»†æ—¥å¿— ===" > $COMPILE_LOG
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $COMPILE_LOG
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_DIR }}" >> $COMPILE_LOG
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}" >> $COMPILE_LOG
          echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> $COMPILE_LOG
          echo "" >> $COMPILE_LOG
          
          # å¼€å§‹ç¼–è¯‘ï¼ŒåŒæ—¶è®°å½•åˆ°è¯¦ç»†æ—¥å¿—å’Œæ§åˆ¶å°
          {
            firmware-config/scripts/build_firmware_main.sh build_firmware "true"
          } 2>&1 | tee -a $COMPILE_LOG
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          echo "ç¼–è¯‘é€€å‡ºä»£ç : $BUILD_EXIT_CODE" >> $COMPILE_LOG
          echo "ç¼–è¯‘ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $COMPILE_LOG
          
          # è®°å½•ç»“æŸæ—¶é—´
          echo "ç¼–è¯‘ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> /tmp/build-logs/compile_start.log
          echo "ç¼–è¯‘é€€å‡ºä»£ç : $BUILD_EXIT_CODE" >> /tmp/build-logs/compile_start.log
          
          echo "ç¼–è¯‘é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "âœ… ç¼–è¯‘å®Œæˆï¼Œæ—¥å¿—å·²ä¿å­˜ï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
            echo "ğŸ“ è¯¦ç»†æ—¥å¿—: $COMPILE_LOG"
            
            # æå–å…³é”®é”™è¯¯ä¿¡æ¯
            echo "ğŸš¨ ç¼–è¯‘é”™è¯¯æ‘˜è¦:"
            grep -i "error\|failed\|undefined reference\|No such file" $COMPILE_LOG | head -20
            
            exit $BUILD_EXIT_CODE
          fi
      
      # æ­¥éª¤ 25: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: "25. æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 25: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰© ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          cd ${{ env.BUILD_DIR }}
          
          # æ£€æŸ¥å¹¶æ˜¾ç¤ºå›ºä»¶æ–‡ä»¶è¯¦æƒ…
          if [ -d "bin/targets" ]; then
            echo "âœ… æ‰¾åˆ°å›ºä»¶ç›®å½•"
            
            # ç»Ÿè®¡å›ºä»¶æ–‡ä»¶
            FIRMWARE_COUNT=0
            TOTAL_SIZE=0
            
            echo "ğŸ“Š å›ºä»¶æ–‡ä»¶è¯¦æƒ…:"
            echo "=========================================="
            
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) 2>/dev/null | while read file; do
                FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                BYTES=$(stat -c%s "$file" 2>/dev/null || echo "0")
                TOTAL_SIZE=$((TOTAL_SIZE + BYTES))
                
                echo "ğŸ“ æ–‡ä»¶ #$FIRMWARE_COUNT:"
                echo "  åç§°: $(basename "$file")"
                echo "  å¤§å°: $SIZE ($BYTES å­—èŠ‚)"
                echo "  è·¯å¾„: $(echo "$file" | sed "s|${{ env.BUILD_DIR }}/||")"
                echo ""
            done
            
            echo "=========================================="
            echo "ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯:"
            echo "  å›ºä»¶æ€»æ•°: $FIRMWARE_COUNT ä¸ª"
            echo "  æ€»å¤§å°: $(numfmt --to=iec $TOTAL_SIZE)"
            
          else
            echo "âŒ æœªæ‰¾åˆ°å›ºä»¶ç›®å½•"
            echo "âš ï¸ bin/targetsç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 26: ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•
      - name: "26. ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
          if-no-files-found: error
      
      # æ­¥éª¤ 27: ä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "27. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
          if-no-files-found: error
      
      # æ­¥éª¤ 28: ä¸Šä¼ ç¼–è¯‘æ—¥å¿— - åˆ†æ­¥éª¤ä¸Šä¼ 
      - name: "28. ä¸Šä¼ ç¼–è¯‘æ—¥å¿— - åˆ†æ­¥éª¤ä¸Šä¼ "
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-detailed-${{ github.event.inputs.device_name }}-${{ github.run_id }}
          path: |
            /tmp/build-logs/
            ${{ env.BUILD_DIR }}/build.log
            ${{ env.BUILD_DIR }}/download.log
            ${{ env.BUILD_DIR }}/.config
          retention-days: 7
          if-no-files-found: warn
      
      # æ­¥éª¤ 29: æ‰§è¡Œé”™è¯¯åˆ†æ - å¢å¼ºç‰ˆ
      - name: "29. æ‰§è¡Œé”™è¯¯åˆ†æ - å¢å¼ºç‰ˆ"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 29: æ‰§è¡Œé”™è¯¯åˆ†æ - å¢å¼ºç‰ˆ ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # æ£€æŸ¥é”™è¯¯åˆ†æè„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ -f "firmware-config/scripts/error_analysis.sh" ]; then
            echo "âœ… æ‰¾åˆ°é”™è¯¯åˆ†æè„šæœ¬"
            chmod +x firmware-config/scripts/error_analysis.sh
            
            # è®¾ç½®è¯¦ç»†æ—¥å¿—è¾“å‡º
            export ERROR_ANALYSIS_VERBOSE=1
            export BUILD_DIR="${{ env.BUILD_DIR }}"
            
            # æ‰§è¡Œé”™è¯¯åˆ†æï¼Œæ•è·è¯¦ç»†è¾“å‡º
            ANALYSIS_LOG="/tmp/error_analysis_detailed.log"
            echo "=== é”™è¯¯åˆ†æè¯¦ç»†æ—¥å¿— ===" > $ANALYSIS_LOG
            echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $ANALYSIS_LOG
            echo "" >> $ANALYSIS_LOG
            
            firmware-config/scripts/error_analysis.sh 2>&1 | tee -a $ANALYSIS_LOG
            
            ANALYSIS_EXIT_CODE=${PIPESTATUS[0]}
            
            echo "" >> $ANALYSIS_LOG
            echo "ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $ANALYSIS_LOG
            echo "é€€å‡ºä»£ç : $ANALYSIS_EXIT_CODE" >> $ANALYSIS_LOG
            
            echo "âœ… é”™è¯¯åˆ†æå®Œæˆï¼Œé€€å‡ºä»£ç : $ANALYSIS_EXIT_CODE"
            
            # ä¸Šä¼ é”™è¯¯åˆ†ææ—¥å¿—
            echo "ğŸ“¤ ä¸Šä¼ é”™è¯¯åˆ†ææ—¥å¿—..."
            cp $ANALYSIS_LOG /tmp/build-logs/error_analysis_detailed.log
            
            # æ˜¾ç¤ºå…³é”®é”™è¯¯æ‘˜è¦
            echo "ğŸš¨ å…³é”®é”™è¯¯æ‘˜è¦:"
            if [ -f "/tmp/build-logs/error_analysis_detailed.log" ]; then
              grep -A2 -B2 "âŒ\|ğŸš¨\|ğŸ’¥" /tmp/build-logs/error_analysis_detailed.log | head -20
            fi
            
          else
            echo "âš ï¸ é”™è¯¯åˆ†æè„šæœ¬ä¸å­˜åœ¨"
            echo "ğŸ” æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶..."
            find . -name "error_analysis.sh" -type f 2>/dev/null
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 30: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "30. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 30: ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          echo "æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          firmware-config/scripts/build_firmware_main.sh post_build_space_check
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      
      # æ­¥éª¤ 31: ä¸Šä¼ åˆ†æ­¥éª¤æ—¥å¿—
      - name: "31. ä¸Šä¼ åˆ†æ­¥éª¤æ—¥å¿—"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: step-logs-${{ github.event.inputs.device_name }}-${{ github.run_id }}
          path: |
            /tmp/build-logs/compile_detailed.log
            /tmp/build-logs/error_analysis_detailed.log
            /tmp/build-logs/compile_start.log
          retention-days: 7
          if-no-files-found: warn
