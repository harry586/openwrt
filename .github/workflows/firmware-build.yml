name: OpenWrt 智能固件构建工作流（稳定版）

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (如: ac42u, ac58u, mi4a 等)'
        required: true
        default: 'ac42u'
        type: string
      old_device:
        description: '是否为老旧设备 (性能较差的设备建议选择true)'
        required: true
        default: false
        type: boolean
      version_spec:
        description: '版本规格 (可选，如: openwrt-23.05 或 immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_type:
        description: '配置类型 (minimal:基础功能, normal:完整功能, custom:自定义)'
        required: true
        default: 'normal'
        type: choice
        options:
          - minimal
          - normal
          - custom
      extra_packages:
        description: '额外安装插件 (空格分隔的包名)'
        required: false
        type: string
      disabled_plugins:
        description: '禁用插件 (空格分隔的包名，如: luci-app-accesscontrol luci-app-ddns)'
        required: false
        type: string
        default: ''
      save_config:
        description: '保存配置文件到仓库'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出配置仓库
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 设置编译环境
      run: |
        echo "=== 安装编译依赖包 ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential libncurses5-dev libssl-dev python3 unzip zlib1g-dev subversion gcc-multilib git curl file ninja-build automake autoconf libtool pkg-config gettext help2man texinfo gawk flex bison rsync wget aria2 python3-pip libelf-dev liblz4-dev zstd libssl-dev libcurl4-openssl-dev groff texlive texinfo
        pip3 install requests urllib3
        echo "✅ 编译环境设置完成"

    - name: 创建构建目录并设置权限
      run: |
        echo "=== 创建构建目录 ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        sudo chmod u+w $BUILD_DIR
        echo "✅ 构建目录创建完成"

    - name: 克隆源码
      run: |
        cd $BUILD_DIR
        echo "=== 克隆源码 ==="
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        git clone --depth 1 https://github.com/immortalwrt/immortalwrt.git .
        echo "✅ 源码克隆完成"

    - name: 配置基础feeds
      run: |
        cd $BUILD_DIR
        echo "=== 配置基础feeds ==="
        echo "src-git packages https://git.openwrt.org/feed/packages.git;master" > feeds.conf.default
        echo "src-git luci https://git.openwrt.org/project/luci.git;master" >> feeds.conf.default
        echo "src-git routing https://git.openwrt.org/feed/routing.git;master" >> feeds.conf.default
        echo "src-git telephony https://git.openwrt.org/feed/telephony.git;master" >> feeds.conf.default
        echo "✅ 基础feeds配置完成"

    - name: 更新安装feeds
      run: |
        cd $BUILD_DIR
        echo "=== 更新和安装feeds ==="
        set +e
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        set -e
        echo "✅ feeds处理完成"

    - name: 复制配置文件
      run: |
        cd $BUILD_DIR
        echo "=== 复制配置文件 ==="
        cd $GITHUB_WORKSPACE
        mkdir -p $BUILD_DIR/config-templates
        CONFIG_FILES=("minimal.config" "normal-new.config" "normal-old.config")
        for config_file in "${CONFIG_FILES[@]}"; do
          FOUND_CONFIG=$(find . -name "$config_file" -type f | head -1)
          if [ -n "$FOUND_CONFIG" ]; then
            cp "$FOUND_CONFIG" $BUILD_DIR/config-templates/
            echo "✅ 复制: $config_file"
          else
            echo "⚠️ 未找到: $config_file"
          fi
        done
        echo "✅ 配置文件复制完成"

    - name: 应用配置模板
      run: |
        cd $BUILD_DIR
        echo "=== 应用配置模板 ==="
        CONFIG_TYPE="${{ github.event.inputs.config_type }}"
        IS_OLD_DEVICE="${{ github.event.inputs.old_device }}"
        echo "配置类型: $CONFIG_TYPE"
        echo "是否为老旧设备: $IS_OLD_DEVICE"
        case "$CONFIG_TYPE" in
            "minimal")
                CONFIG_FILE="config-templates/minimal.config"
                ;;
            "normal")
                if [ "$IS_OLD_DEVICE" = "true" ]; then
                    CONFIG_FILE="config-templates/normal-old.config"
                else
                    CONFIG_FILE="config-templates/normal-new.config"
                fi
                ;;
            "custom")
                if [ "$IS_OLD_DEVICE" = "true" ]; then
                    CONFIG_FILE="config-templates/normal-old.config"
                else
                    CONFIG_FILE="config-templates/normal-new.config"
                fi
                ;;
            *)
                echo "使用默认配置"
                CONFIG_FILE=""
                ;;
        esac
        if [ -n "$CONFIG_FILE" ] && [ -f "$CONFIG_FILE" ]; then
            echo "✅ 使用配置文件: $CONFIG_FILE"
            cp "$CONFIG_FILE" .config
            make defconfig
        else
            echo "⚠️ 使用默认配置"
        fi
        echo "✅ 配置应用完成"

    - name: 编译固件
      timeout-minutes: 180
      run: |
        cd $BUILD_DIR
        echo "=== 开始编译固件 ==="
        CPU_CORES=$(nproc)
        JOBS=$((CPU_CORES > 8 ? CPU_CORES - 2 : CPU_CORES))
        echo "使用编译线程数: $JOBS"
        set +e
        make -j$JOBS V=s
        BUILD_RESULT=$?
        set -e
        if [ $BUILD_RESULT -eq 0 ]; then
            echo "✅ 固件编译成功"
        else
            echo "❌ 固件编译失败"
            exit 1
        fi

    - name: 收集构建产物
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== 收集构建产物 ==="
        mkdir -p $GITHUB_WORKSPACE/firmware-output
        FIRMWARE_FILES=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.gz" 2>/dev/null | head -10)
        if [ -n "$FIRMWARE_FILES" ]; then
            echo "找到固件文件:"
            for firmware in $FIRMWARE_FILES; do
                if [ -f "$firmware" ]; then
                    cp "$firmware" $GITHUB_WORKSPACE/firmware-output/
                    echo "✅ 复制: $(basename "$firmware")"
                fi
            done
        else
            echo "⚠️ 未找到固件文件"
        fi
        echo "✅ 构建产物收集完成"

    - name: 上传构建产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ github.run_id }}
        path: firmware-output/
        retention-days: 7

    - name: 构建完成通知
      if: always()
      run: |
        echo "=== 构建完成状态 ==="
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ 固件构建成功完成"
          echo "设备: ${{ github.event.inputs.device_name }}"
        else
          echo "❌ 固件构建失败"
          echo "请检查构建日志了解详细错误信息"
        fi
