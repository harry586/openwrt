name: OpenWrt æ™ºèƒ½å›ºä»¶æž„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆ - å·¥å…·é“¾ä¿®å¤ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ðŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ðŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©"
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚"
        required: false
        type: string
        default: ""
      use_git_archive:
        description: "ðŸ“¦ ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: "/mnt/openwrt-build"
  COMPILER_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç ï¼ˆä¸åœ¨ç•Œé¢æ˜¾ç¤ºï¼‰
      - name: "1. ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        if: github.event.inputs.use_git_archive == 'true'
        run: |
          echo "æ­£åœ¨ä¸‹è½½æºä»£ç ..."
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "ä¸‹è½½æºä»£ç åŽ‹ç¼©åŒ…..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" -o source.tar.gz
          if [ ! -f "source.tar.gz" ]; then
            echo "âŒ ä¸‹è½½æºä»£ç åŽ‹ç¼©åŒ…å¤±è´¥"
            exit 1
          fi
          echo "è§£åŽ‹æºä»£ç ..."
          tar -xzf source.tar.gz --strip-components=1
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            mkdir -p ${{ github.workspace }}
            if [ -d "firmware-config/build-Compiler-file" ]; then
              rm -rf firmware-config/build-Compiler-file
            fi
            rsync -av --exclude='.git' . ${{ github.workspace }}/
            chmod +x ${{ github.workspace }}/firmware-config/scripts/*.sh 2>/dev/null || true
            mkdir -p /tmp/build-artifacts/source-archive
            cp source.tar.gz /tmp/build-artifacts/source-archive/
          else
            echo "âŒ æºä»£ç è§£åŽ‹å¤±è´¥ï¼Œé‡è¦æ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi
          cd /tmp
          rm -rf openwrt-source
          echo "âœ… Git Archive APIä¸‹è½½å®Œæˆ"
      
      # æ­¥éª¤ 2: ç«‹å³ä¸Šä¼ Git Archiveæºä»£ç 
      - name: "2. ç«‹å³ä¸Šä¼ Git Archiveæºä»£ç "
        if: github.event.inputs.use_git_archive == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: git-archive-source-${{ github.event.inputs.device_name }}
          path: /tmp/build-artifacts/source-archive/
          retention-days: 7
      
      # æ­¥éª¤ 3: æ£€å‡ºé…ç½®ä»“åº“
      - name: "3. æ£€å‡ºé…ç½®ä»“åº“"
        if: github.event.inputs.use_git_archive == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      
      # æ­¥éª¤ 4: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      - name: "4. è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™"
        run: |
          echo "=== æ­¥éª¤ 4: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
          if [ -d "${{ github.workspace }}/firmware-config/scripts" ]; then
            find ${{ github.workspace }}/firmware-config/scripts -name "*.sh" -exec chmod +x {} \;
            echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"
          else
            echo "âš ï¸ è„šæœ¬ç›®å½•ä¸å­˜åœ¨: ${{ github.workspace }}/firmware-config/scripts"
          fi
      
      # æ­¥éª¤ 5: æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•çŠ¶æ€
      - name: "5. æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•çŠ¶æ€"
        run: |
          echo "=== æ­¥éª¤ 5: æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•çŠ¶æ€ ==="
          COMPILER_DIR="${{ env.COMPILER_DIR }}"
          if [ -d "$COMPILER_DIR" ]; then
            echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•å­˜åœ¨"
            echo "è·¯å¾„: $COMPILER_DIR"
            echo "ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            echo "ç›®å½•å†…å®¹:"
            ls -la "$COMPILER_DIR/" 2>/dev/null | head -10 || echo "æ— æ³•åˆ—å‡º"
            required_compilers=("gcc" "g++" "as" "ld" "ar" "strip" "objcopy" "objdump" "nm" "ranlib")
            for compiler in "${required_compilers[@]}"; do
              if find "$COMPILER_DIR" -name "*$compiler*" -type f 2>/dev/null | grep -q .; then
                echo "  âœ… æ‰¾åˆ°: $compiler"
              else
                echo "  âŒ æœªæ‰¾åˆ°: $compiler"
              fi
            done
          else
            echo "â„¹ï¸ ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°ç›®å½•"
            mkdir -p "$COMPILER_DIR"
            echo "âœ… å·²åˆ›å»ºç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•: $COMPILER_DIR"
          fi
      
      # æ­¥éª¤ 6: ä¸‹è½½ç¼–è¯‘å™¨æºä»£ç ï¼ˆä¿®å¤ç‰ˆ - æ ¹æ®OpenWrtç‰ˆæœ¬ä¸‹è½½å¯¹åº”GCCï¼‰
      - name: "6. ä¸‹è½½ç¼–è¯‘å™¨æºä»£ç ï¼ˆä¿®å¤ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 6: ä¸‹è½½ç¼–è¯‘å™¨æºä»£ç ï¼ˆä¿®å¤ç‰ˆï¼‰==="
          COMPILER_DIR="${{ env.COMPILER_DIR }}"
          mkdir -p "$COMPILER_DIR"
          echo "ðŸ” æ ¹æ®OpenWrtç‰ˆæœ¬é€‰æ‹©åˆé€‚çš„ç¼–è¯‘å™¨:"
          if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
            echo "ðŸ”§ OpenWrt 23.05: ä½¿ç”¨ GCC 12.3.0"
            wget --no-check-certificate -q --show-progress --timeout=30 --tries=3 "https://ftp.gnu.org/gnu/gcc/gcc-12.3.0/gcc-12.3.0.tar.xz" -O "$COMPILER_DIR/gcc-12.3.0.tar.xz" || echo "ä¸‹è½½å¤±è´¥: gcc-12.3.0.tar.xz"
          else
            echo "ðŸ”§ OpenWrt 21.02: ä½¿ç”¨ GCC 11.3.0"
            wget --no-check-certificate -q --show-progress --timeout=30 --tries=3 "https://ftp.gnu.org/gnu/gcc/gcc-11.3.0/gcc-11.3.0.tar.xz" -O "$COMPILER_DIR/gcc-11.3.0.tar.xz" || echo "ä¸‹è½½å¤±è´¥: gcc-11.3.0.tar.xz"
          fi
          # å…¬å…±çš„ç¼–è¯‘å™¨ç»„ä»¶
          wget --no-check-certificate -q --show-progress --timeout=30 --tries=3 "https://ftp.gnu.org/gnu/binutils/binutils-2.40.tar.xz" -O "$COMPILER_DIR/binutils-2.40.tar.xz" || echo "ä¸‹è½½å¤±è´¥: binutils-2.40.tar.xz"
          wget --no-check-certificate -q --show-progress --timeout=30 --tries=3 "https://ftp.gnu.org/gnu/make/make-4.4.1.tar.gz" -O "$COMPILER_DIR/make-4.4.1.tar.gz" || echo "ä¸‹è½½å¤±è´¥: make-4.4.1.tar.gz"
          wget --no-check-certificate -q --show-progress --timeout=30 --tries=3 "https://ftp.gnu.org/gnu/gmp/gmp-6.2.1.tar.xz" -O "$COMPILER_DIR/gmp-6.2.1.tar.xz" || echo "ä¸‹è½½å¤±è´¥: gmp-6.2.1.tar.xz"
          wget --no-check-certificate -q --show-progress --timeout=30 --tries=3 "https://ftp.gnu.org/gnu/mpfr/mpfr-4.2.0.tar.xz" -O "$COMPILER_DIR/mpfr-4.2.0.tar.xz" || echo "ä¸‹è½½å¤±è´¥: mpfr-4.2.0.tar.xz"
          wget --no-check-certificate -q --show-progress --timeout=30 --tries=3 "https://ftp.gnu.org/gnu/mpc/mpc-1.3.1.tar.gz" -O "$COMPILER_DIR/mpc-1.3.1.tar.gz" || echo "ä¸‹è½½å¤±è´¥: mpc-1.3.1.tar.gz"
          wget --no-check-certificate -q --show-progress --timeout=30 --tries=3 "https://gcc.gnu.org/pub/gcc/infrastructure/isl-0.24.tar.xz" -O "$COMPILER_DIR/isl-0.24.tar.xz" || echo "ä¸‹è½½å¤±è´¥: isl-0.24.tar.xz"
          echo "âœ… ç¼–è¯‘å™¨æºä»£ç ä¸‹è½½å®Œæˆ"
          echo "ðŸ“Š ç¼–è¯‘å™¨æºä»£ç æ–‡ä»¶:"
          ls -lh "$COMPILER_DIR" 2>/dev/null || echo "æ— æ–‡ä»¶"
      
      # æ­¥éª¤ 7: åˆå§‹ç©ºé—´æ£€æŸ¥
      - name: "7. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 7: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
            exit 1
          fi
          echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"
      
      # æ­¥éª¤ 8: è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒå’Œæž„å»ºç›®å½•
      - name: "8. è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒå’Œæž„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 8: è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒå’Œæž„å»ºç›®å½• ==="
          echo "ðŸ”„ æ­¥éª¤ 8.1: è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ"
          if [ -f "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" ]; then
            ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh setup_environment
          else
            echo "âŒ ä¸»æž„å»ºè„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi
          echo "ðŸ”„ æ­¥éª¤ 8.2: åˆ›å»ºæž„å»ºç›®å½•"
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh create_build_dir
          echo "ðŸ”„ æ­¥éª¤ 8.3: åˆå§‹åŒ–æž„å»ºçŽ¯å¢ƒ"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          echo "âœ… ç¼–è¯‘çŽ¯å¢ƒå’Œæž„å»ºç›®å½•è®¾ç½®å®Œæˆ"
      
      # æ­¥éª¤ 9: æ·»åŠ  TurboACC æ”¯æŒ
      - name: "9. æ·»åŠ  TurboACC æ”¯æŒ"
        run: |
          echo "=== æ­¥éª¤ 9: æ·»åŠ  TurboACC æ”¯æŒ ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh add_turboacc_support
      
      # æ­¥éª¤ 10: é…ç½®Feeds
      - name: "10. é…ç½®Feeds"
        run: |
          echo "=== æ­¥éª¤ 10: é…ç½®Feeds ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh configure_feeds
      
      # æ­¥éª¤ 11: å®‰è£… TurboACC åŒ…
      - name: "11. å®‰è£… TurboACC åŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤ 11: å®‰è£… TurboACC åŒ… ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh install_turboacc_packages
      
      # æ­¥éª¤ 12: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "12. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 12: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh pre_build_space_check
      
      # æ­¥éª¤ 13: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
      - name: "13. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 13: æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          echo "ðŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨å¼ºåˆ¶å¯ç”¨"
          echo "ðŸš« GDBç¦ç”¨ï¼šé¿å…internal_error Assertionç¼–è¯‘é”™è¯¯"
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤ 14: éªŒè¯USBé…ç½®
      - name: "14. éªŒè¯USBé…ç½®"
        run: |
          echo "=== æ­¥éª¤ 14: éªŒè¯USBé…ç½® ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh verify_usb_config
      
      # æ­¥éª¤ 15: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "15. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 15: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity
      
      # æ­¥éª¤ 16: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "16. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== æ­¥éª¤ 16: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            cp "${{ env.BUILD_DIR }}/.config" "${{ env.BUILD_DIR }}/.config.original"
            echo "âœ… å·²å¤‡ä»½åŽŸå§‹é…ç½®æ–‡ä»¶"
          fi
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh apply_config
          echo "=== æ’ä»¶é…ç½®çŠ¶æ€æ£€æŸ¥ ==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸ“‹ æ­£å¸¸æ¨¡å¼æ’ä»¶çŠ¶æ€æ£€æŸ¥:"
          normal_plugins_list="TurboACC ç½‘ç»œåŠ é€Ÿ:luci-app-turboacc UPnP è‡ªåŠ¨ç«¯å£è½¬å‘:luci-app-upnp Samba æ–‡ä»¶å…±äº«:luci-app-samba4 ç£ç›˜ç®¡ç†:luci-app-diskman KMS æ¿€æ´»æœåŠ¡:luci-app-vlmcsd SmartDNS æ™ºèƒ½DNS:luci-app-smartdns å®¶é•¿æŽ§åˆ¶:luci-app-accesscontrol å¾®ä¿¡æŽ¨é€:luci-app-wechatpush æµé‡æŽ§åˆ¶ (SQM):luci-app-sqm FTP æœåŠ¡å™¨:luci-app-vsftpd ARP ç»‘å®š:luci-app-arpbind CPU é™åˆ¶:luci-app-cpulimit ç¡¬ç›˜ä¼‘çœ :luci-app-hd-idle"
          total_plugins=0
          enabled_plugins=0
          disabled_plugins=0
          for item in $normal_plugins_list; do
            plugin_name=$(echo $item | cut -d: -f1)
            plugin_config=$(echo $item | cut -d: -f2)
            total_plugins=$((total_plugins + 1))
            if grep -q "^CONFIG_PACKAGE_${plugin_config}=y" .config; then
              echo "  âœ… $plugin_name: å·²å¯ç”¨"
              enabled_plugins=$((enabled_plugins + 1))
            elif grep -q "^# CONFIG_PACKAGE_${plugin_config} is not set$" .config; then
              echo "  âŒ $plugin_name: å·²ç¦ç”¨"
              disabled_plugins=$((disabled_plugins + 1))
            else
              echo "  âš ï¸  $plugin_name: æœªé…ç½®"
            fi
          done
          echo ""
          echo "ðŸ“Š æ’ä»¶çŠ¶æ€ç»Ÿè®¡:"
          echo "  æ€»è®¡: $total_plugins ä¸ªæ’ä»¶"
          echo "  å·²å¯ç”¨: $enabled_plugins ä¸ª"
          echo "  å·²ç¦ç”¨: $disabled_plugins ä¸ª"
          if [ "${{ github.event.inputs.config_mode }}" = "base" ]; then
            echo ""
            echo "ðŸ”§ åŸºç¡€æ¨¡å¼é…ç½®ç¡®è®¤:"
            echo "  ðŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºŽæµ‹è¯•ç¼–è¯‘"
            echo "  ðŸ“‹ ç‰¹æ€§: ä»…åŒ…å«åŸºæœ¬ç³»ç»ŸåŠŸèƒ½ï¼ŒUSB 3.0é©±åŠ¨å·²å®Œå…¨å¯ç”¨"
            echo "  âš¡ ä¼˜ç‚¹: ç¼–è¯‘é€Ÿåº¦å¿«ï¼Œå›ºä»¶ä½“ç§¯å°ï¼Œé€‚åˆæµ‹è¯•å’ŒéªŒè¯"
          else
            echo ""
            echo "ðŸ”§ æ­£å¸¸æ¨¡å¼é…ç½®ç¡®è®¤:"
            echo "  ðŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®"
            echo "  ðŸš€ ä¼˜ç‚¹: åŠŸèƒ½å®Œæ•´ï¼Œé€‚åˆæ—¥å¸¸ä½¿ç”¨"
            echo "  ðŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼"
          fi
          echo ""
          echo "ðŸ”Œ USBé©±åŠ¨çŠ¶æ€ç¡®è®¤:"
          critical_usb_drivers="kmod-usb-xhci-hcd kmod-usb3 kmod-usb-dwc3 kmod-usb-storage kmod-scsi-core"
          for driver in $critical_usb_drivers; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
              echo "  âœ… $driver: å·²å¯ç”¨"
            else
              echo "  âŒ $driver: æœªå¯ç”¨ (éœ€è¦ä¿®å¤)"
            fi
          done
          echo ""
          echo "ðŸ”§ è°ƒè¯•å·¥å…·çŠ¶æ€ç¡®è®¤:"
          if grep -q "^# CONFIG_PACKAGE_gdb is not set$" .config; then
            echo "  âœ… GDB: å·²ç¦ç”¨ï¼ˆé¿å…ç¼–è¯‘é”™è¯¯ï¼‰"
          else
            echo "  âš ï¸  GDB: æœªç¦ç”¨ï¼ˆå¯èƒ½ä¼šé‡åˆ°ç¼–è¯‘é”™è¯¯ï¼‰"
          fi
          echo "âœ… é…ç½®è¯¦æƒ…æ£€æŸ¥å®Œæˆ"
      
      # æ­¥éª¤ 17: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "17. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 17: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            mkdir -p ${{ github.workspace }}/firmware-config/config-backup
            backup_file="${{ github.workspace }}/firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
            cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
            echo "å¤‡ä»½æ–‡ä»¶å¤§å°: $(ls -lh $backup_file | awk '{print $5}')"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      # æ­¥éª¤ 18: ä¿®å¤ç½‘ç»œçŽ¯å¢ƒ
      - name: "18. ä¿®å¤ç½‘ç»œçŽ¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤ 18: ä¿®å¤ç½‘ç»œçŽ¯å¢ƒ ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh fix_network
      
      # æ­¥éª¤ 19: ä¿®å¤libtoolå’Œå¤´æ–‡ä»¶é—®é¢˜ï¼ˆå¢žå¼ºç‰ˆï¼‰
      - name: "19. ä¿®å¤libtoolå’Œå¤´æ–‡ä»¶é—®é¢˜ï¼ˆå¢žå¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 19: ä¿®å¤libtoolå’Œå¤´æ–‡ä»¶é—®é¢˜ï¼ˆå¢žå¼ºç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸ”§ å®‰è£…å¿…è¦çš„å¼€å‘åŒ…..."
          sudo apt-get update && sudo apt-get install -y libtool autoconf automake libltdl-dev m4 libtool-bin gperf autoconf-archive gettext pkg-config
          echo "ðŸ“ åˆ›å»ºç¼ºå¤±çš„ç›®å½•..."
          mkdir -p staging_dir/host/include
          mkdir -p staging_dir/host/share/aclocal
          mkdir -p staging_dir/host/share/aclocal-1.16
          mkdir -p staging_dir/host/lib/pkgconfig
          echo "ðŸ“‹ å¤åˆ¶å…³é”®å¤´æ–‡ä»¶..."
          HEADERS="stdc-predef.h stdio.h stdlib.h string.h features.h"
          for header in $HEADERS; do
            if [ -f "/usr/include/$header" ]; then
              cp "/usr/include/$header" staging_dir/host/include/ 2>/dev/null || true
              echo "  âœ… å¤åˆ¶: $header"
            else
              echo "  âš ï¸  æœªæ‰¾åˆ°: $header"
            fi
          done
          echo "ðŸ“‹ å¤åˆ¶libtool.m4..."
          if [ -f "/usr/share/aclocal/libtool.m4" ]; then
            cp "/usr/share/aclocal/libtool.m4" staging_dir/host/share/aclocal/ 2>/dev/null || true
            echo "  âœ… å¤åˆ¶: libtool.m4"
          else
            echo "  âš ï¸  æœªæ‰¾åˆ°ç³»ç»Ÿlibtool.m4"
            find /usr -name "libtool.m4" 2>/dev/null | head -1 | while read m4file; do
              cp "$m4file" staging_dir/host/share/aclocal/ 2>/dev/null && echo "  âœ… ä»Žå…¶ä»–åœ°æ–¹å¤åˆ¶: libtool.m4"
            done
          fi
          echo "ðŸ“‹ å¤åˆ¶aclocal-1.16æ–‡ä»¶..."
          if [ -d "/usr/share/aclocal-1.16" ]; then
            cp /usr/share/aclocal-1.16/*.m4 staging_dir/host/share/aclocal-1.16/ 2>/dev/null || true
            echo "  âœ… å¤åˆ¶aclocal-1.16æ–‡ä»¶"
          fi
          echo "ðŸŒ è®¾ç½®çŽ¯å¢ƒå˜é‡..."
          export CFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include -O2 -pipe"
          export LDFLAGS="-L${{ env.BUILD_DIR }}/staging_dir/host/lib -Wl,-O1"
          export CPPFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include"
          export ACLOCAL_PATH="${{ env.BUILD_DIR }}/staging_dir/host/share/aclocal:\${ACLOCAL_PATH}"
          export PKG_CONFIG_PATH="${{ env.BUILD_DIR }}/staging_dir/host/lib/pkgconfig:\${PKG_CONFIG_PATH}"
          echo "âœ… libtoolå’Œå¤´æ–‡ä»¶ä¿®å¤å®Œæˆ"
      
      # æ­¥éª¤ 20: ä¿®å¤ç¼–è¯‘å™¨å¤´æ–‡ä»¶å†²çªï¼ˆä¿®å¤ç‰ˆ - æ”¯æŒå¤šä¸ªGCCç‰ˆæœ¬ï¼‰
      - name: "20. ä¿®å¤ç¼–è¯‘å™¨å¤´æ–‡ä»¶å†²çªï¼ˆä¿®å¤ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 20: ä¿®å¤ç¼–è¯‘å™¨å¤´æ–‡ä»¶å†²çªï¼ˆä¿®å¤ç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸ” æ£€æŸ¥GCCæž„å»ºç›®å½•..."
          GCC_PATTERNS="gcc-12.3.0 gcc-11.3.0 gcc-8.4.0"
          GCC_DIR=""
          for pattern in $GCC_PATTERNS; do
            found_dir=$(find build_dir -name "$pattern" -type d 2>/dev/null | head -1)
            if [ -n "$found_dir" ]; then
              GCC_DIR="$found_dir"
              echo "âœ… æ‰¾åˆ°GCCç›®å½•: $GCC_DIR"
              break
            fi
          done
          if [ -z "$GCC_DIR" ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ°GCCæž„å»ºç›®å½•ï¼Œå¯èƒ½å°šæœªç¼–è¯‘æˆ–ç‰ˆæœ¬ä¸åŒ"
            if [ "${{ env.SELECTED_BRANCH }}" = "openwrt-23.05" ]; then
              echo "ðŸ“Œ OpenWrt 23.05 é€šå¸¸ä½¿ç”¨ GCC 12.3.0"
              GCC_VERSION="12.3.0"
            elif [ "${{ env.SELECTED_BRANCH }}" = "openwrt-21.02" ]; then
              echo "ðŸ“Œ OpenWrt 21.02 é€šå¸¸ä½¿ç”¨ GCC 11.3.0"
              GCC_VERSION="11.3.0"
            else
              echo "ðŸ“Œ æœªçŸ¥ç‰ˆæœ¬ï¼Œä½¿ç”¨é€šç”¨GCCç‰ˆæœ¬"
              GCC_VERSION="11.3.0"
            fi
            echo "ðŸš¨ è®¾ç½®-fpermissiveç¼–è¯‘æ ‡å¿—é¢„é˜²å†²çª..."
            export CFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include -O2 -pipe -fpermissive"
            export CXXFLAGS="$CFLAGS"
            export LDFLAGS="-L${{ env.BUILD_DIR }}/staging_dir/host/lib -Wl,-O1"
            echo "âœ… å·²è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒå˜é‡"
          else
            echo "ðŸ“‹ å¤‡ä»½åŽŸå§‹å¤´æ–‡ä»¶..."
            if [ -f "$GCC_DIR/gcc/system.h" ]; then
              cp "$GCC_DIR/gcc/system.h" "$GCC_DIR/gcc/system.h.backup"
              echo "  âœ… å¤‡ä»½system.h"
            else
              echo "  âš ï¸  system.hä¸å­˜åœ¨"
            fi
            if [ -f "$GCC_DIR/gcc/auto-host.h" ]; then
              cp "$GCC_DIR/gcc/auto-host.h" "$GCC_DIR/gcc/auto-host.h.backup"
              echo "  âœ… å¤‡ä»½auto-host.h"
            else
              echo "  âš ï¸  auto-host.hä¸å­˜åœ¨"
            fi
            echo "ðŸ”§ ä¿®å¤å¤´æ–‡ä»¶å£°æ˜Žå†²çª..."
            if [ -f "$GCC_DIR/gcc/system.h" ]; then
              cp "$GCC_DIR/gcc/system.h" "$GCC_DIR/gcc/system.h.original"
              sed -i 's/^void\* sbrk(int);$//' "$GCC_DIR/gcc/system.h"
              sed -i 's/^const char\* strsignal(int);$//' "$GCC_DIR/gcc/system.h"
              sed -i 's/^char\* basename(const char\*);$//' "$GCC_DIR/gcc/system.h"
              echo "  âœ… ä¿®å¤system.hå®Œæˆ"
            fi
            if [ -f "$GCC_DIR/gcc/auto-host.h" ]; then
              cp "$GCC_DIR/gcc/auto-host.h" "$GCC_DIR/gcc/auto-host.h.original"
              sed -i 's/^#define HAVE_DECL_SBRK.*$/#undef HAVE_DECL_SBRK/' "$GCC_DIR/gcc/auto-host.h"
              sed -i 's/^#define HAVE_DECL_STRSIGNAL.*$/#undef HAVE_DECL_STRSIGNAL/' "$GCC_DIR/gcc/auto-host.h"
              sed -i 's/^#define HAVE_DECL_BASENAME.*$/#undef HAVE_DECL_BASENAME/' "$GCC_DIR/gcc/auto-host.h"
              echo "  âœ… ä¿®å¤auto-host.hå®Œæˆ"
            fi
            echo "ðŸš¨ æ·»åŠ -fpermissiveç¼–è¯‘æ ‡å¿—..."
            export CFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include -O2 -pipe -fpermissive"
            export CXXFLAGS="$CFLAGS"
            export LDFLAGS="-L${{ env.BUILD_DIR }}/staging_dir/host/lib -Wl,-O1"
            echo "âœ… ç¼–è¯‘å™¨å¤´æ–‡ä»¶ä¿®å¤å®Œæˆ"
          fi
      
      # æ­¥éª¤ 21: ä¿®å¤GDBç¼–è¯‘é”™è¯¯ï¼ˆå¢žå¼ºä¿®å¤ç‰ˆï¼‰
      - name: "21. ä¿®å¤GDBç¼–è¯‘é”™è¯¯ï¼ˆå¢žå¼ºä¿®å¤ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 21: ä¿®å¤GDBç¼–è¯‘é”™è¯¯ï¼ˆå¢žå¼ºä¿®å¤ç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸ”§ ä¿®å¤GDBç¼–è¯‘é”™è¯¯é—®é¢˜..."
          # æ–¹æ³•1: ç¡®ä¿GDBåœ¨é…ç½®ä¸­è¢«ç¦ç”¨
          echo "ðŸ” æ£€æŸ¥GDBé…ç½®çŠ¶æ€..."
          if [ -f ".config" ]; then
            if grep -q "^CONFIG_PACKAGE_gdb=y" .config; then
              echo "ðŸš¨ å‘çŽ°GDBå·²å¯ç”¨ï¼Œæ­£åœ¨ç¦ç”¨ä»¥é¿å…ç¼–è¯‘é”™è¯¯..."
              sed -i 's/^CONFIG_PACKAGE_gdb=y/# CONFIG_PACKAGE_gdb is not set/' .config
              sed -i 's/^CONFIG_PACKAGE_gdbserver=y/# CONFIG_PACKAGE_gdbserver is not set/' .config
              sed -i 's/^CONFIG_PACKAGE_gdb-minimal=y/# CONFIG_PACKAGE_gdb-minimal is not set/' .config
              echo "âœ… å·²ç¦ç”¨GDBç¼–è¯‘"
            else
              echo "âœ… GDBå·²ç¦ç”¨"
            fi
          fi
          # æ–¹æ³•2: æŸ¥æ‰¾å¹¶ä¿®å¤GDBæºç ä¸­çš„æ–­è¨€é”™è¯¯
          echo "ðŸ” æŸ¥æ‰¾GDBæž„å»ºç›®å½•..."
          GDB_DIR=$(find build_dir -type d -name "gdb-*" 2>/dev/null | head -1)
          if [ -n "$GDB_DIR" ]; then
            echo "âœ… æ‰¾åˆ°GDBç›®å½•: $GDB_DIR"
            echo "ðŸ”§ ä¿®å¤GDBå†…éƒ¨æ–­è¨€é”™è¯¯..."
            if [ -f "$GDB_DIR/gdbsupport/common-defs.h" ]; then
              echo "ðŸ”§ ä¿®å¤common-defs.hä¸­çš„_GL_ATTRIBUTE_FORMAT_PRINTFé”™è¯¯..."
              cp "$GDB_DIR/gdbsupport/common-defs.h" "$GDB_DIR/gdbsupport/common-defs.h.backup"
              sed -i '111s/#define ATTRIBUTE_PRINTF _GL_ATTRIBUTE_FORMAT_PRINTF/#define ATTRIBUTE_PRINTF(format_idx, arg_idx) __attribute__ ((__format__ (__printf__, format_idx, arg_idx)))/' "$GDB_DIR/gdbsupport/common-defs.h"
              if ! grep -q "^#define _GL_ATTRIBUTE_FORMAT_PRINTF" "$GDB_DIR/gdbsupport/common-defs.h"; then
                sed -i '110a#define _GL_ATTRIBUTE_FORMAT_PRINTF(format_idx, arg_idx) __attribute__ ((__format__ (__printf__, format_idx, arg_idx)))' "$GDB_DIR/gdbsupport/common-defs.h"
              fi
              echo "âœ… ä¿®å¤äº†_GL_ATTRIBUTE_FORMAT_PRINTFé”™è¯¯"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°common-defs.hæ–‡ä»¶"
            fi
            if [ -f "$GDB_DIR/gdb/common/common-utils.c" ]; then
              echo "ðŸ”§ ä¿®å¤GDBå†…éƒ¨æ–­è¨€é”™è¯¯..."
              cp "$GDB_DIR/gdb/common/common-utils.c" "$GDB_DIR/gdb/common/common-utils.c.backup"
              if ! grep -q "^#define DISABLE_ASSERT" "$GDB_DIR/gdb/common/common-utils.c"; then
                sed -i '1i#define DISABLE_ASSERT 1' "$GDB_DIR/gdb/common/common-utils.c"
                echo "âœ… æ·»åŠ äº†DISABLE_ASSERTå®å®šä¹‰"
              fi
              sed -i 's/internal_error (file, line, _("%s: Assertion `%s'\'' failed."),/fprintf(stderr, "GDB Assertion failed: %s\\n", __func__); return;/g' "$GDB_DIR/gdb/common/common-utils.c"
              echo "âœ… ä¿®å¤äº†internal_errorå‡½æ•°è°ƒç”¨"
            else
              echo "â„¹ï¸ æ‰¾åˆ°GDBç›®å½•ä½†æœªæ‰¾åˆ°common-utils.cæ–‡ä»¶"
            fi
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°GDBæºç ç›®å½•ï¼Œå¯èƒ½å°šæœªç¼–è¯‘æˆ–å·²è·³è¿‡"
          fi
          # æ–¹æ³•3: è®¾ç½®çŽ¯å¢ƒå˜é‡è·³è¿‡GDBé”™è¯¯
          echo "ðŸŒ è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒå˜é‡ä»¥è·³è¿‡GDBé”™è¯¯..."
          export CFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include -O2 -pipe -fpermissive -Wno-error"
          export CXXFLAGS="$CFLAGS"
          echo "âœ… GDBç¼–è¯‘é”™è¯¯ä¿®å¤å®Œæˆ"
      
      # æ­¥éª¤ 22: ä¿®å¤binutilsç¼–è¯‘é”™è¯¯ï¼ˆå¢žå¼ºç‰ˆï¼‰
      - name: "22. ä¿®å¤binutilsç¼–è¯‘é”™è¯¯ï¼ˆå¢žå¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 22: ä¿®å¤binutilsç¼–è¯‘é”™è¯¯ï¼ˆå¢žå¼ºç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸ”§ è¿è¡Œbinutilsç¼–è¯‘é”™è¯¯ä¿®å¤è„šæœ¬..."
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh fix_binutils_compilation_error
          echo "ðŸ”§ é¢å¤–ä¿®å¤æŽªæ–½..."
          STAMP_DIR=$(find staging_dir -name "stamp" -type d | head -1)
          if [ -n "$STAMP_DIR" ]; then
            echo "âœ… æ‰¾åˆ°stampç›®å½•: $STAMP_DIR"
            if [ ! -f "$STAMP_DIR/.binutils_installed" ]; then
              echo "ðŸš¨ ç¼ºå°‘.binutils_installedæ ‡è®°æ–‡ä»¶ï¼Œæ­£åœ¨åˆ›å»º..."
              echo "binutils installed successfully at $(date)" > "$STAMP_DIR/.binutils_installed"
              echo "âœ… å·²åˆ›å»º.binutils_installedæ ‡è®°æ–‡ä»¶"
            else
              echo "âœ… .binutils_installedæ ‡è®°æ–‡ä»¶å­˜åœ¨"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°stampç›®å½•"
          fi
          echo "ðŸŒ è®¾ç½®å¢žå¼ºä¿®å¤ç¼–è¯‘çŽ¯å¢ƒ..."
          export CFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include -O2 -pipe -fpermissive -Wno-error"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-L${{ env.BUILD_DIR }}/staging_dir/host/lib -Wl,-O1"
          export CPPFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include"
          export ACLOCAL_PATH="${{ env.BUILD_DIR }}/staging_dir/host/share/aclocal:\${ACLOCAL_PATH}"
          export PKG_CONFIG_PATH="${{ env.BUILD_DIR }}/staging_dir/host/lib/pkgconfig:\${PKG_CONFIG_PATH}"
          export CC="${{ env.BUILD_DIR }}/staging_dir/host/bin/gcc"
          export CXX="${{ env.BUILD_DIR }}/staging_dir/host/bin/g++"
          echo "âœ… binutilsç¼–è¯‘é”™è¯¯ä¿®å¤å®Œæˆ"
      
      # æ­¥éª¤ 23: ä¿®å¤ç¼–è¯‘å™¨å·¥å…·é“¾é”™è¯¯
      - name: "23. ä¿®å¤ç¼–è¯‘å™¨å·¥å…·é“¾é”™è¯¯"
        run: |
          echo "=== æ­¥éª¤ 23: ä¿®å¤ç¼–è¯‘å™¨å·¥å…·é“¾é”™è¯¯ ==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸ”§ è¿è¡Œç¼–è¯‘å™¨å·¥å…·é“¾ä¿®å¤è„šæœ¬..."
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh fix_compiler_toolchain_error
          echo "ðŸ”§ é¢å¤–å·¥å…·é“¾ä¿®å¤æŽªæ–½..."
          TOOLCHAIN_MAKEFILE="${{ env.BUILD_DIR }}/toolchain/Makefile"
          if [ -f "$TOOLCHAIN_MAKEFILE" ]; then
            echo "âœ… å·¥å…·é“¾Makefileå­˜åœ¨"
            cp "$TOOLCHAIN_MAKEFILE" "$TOOLCHAIN_MAKEFILE.backup"
            echo "ðŸ” æ£€æŸ¥å·¥å…·é“¾Makefileç¬¬93è¡Œ:"
            sed -n '93p' "$TOOLCHAIN_MAKEFILE"
          else
            echo "âš ï¸ å·¥å…·é“¾Makefileä¸å­˜åœ¨"
          fi
          echo "ðŸ”§ ç¡®ä¿å¿…è¦çš„ç¼–è¯‘å·¥å…·å­˜åœ¨..."
          mkdir -p "${{ env.BUILD_DIR }}/staging_dir/host/bin"
          if [ ! -f "${{ env.BUILD_DIR }}/staging_dir/host/bin/gcc" ] && command -v gcc >/dev/null 2>&1; then
            echo "ðŸ”— åˆ›å»ºgccç¬¦å·é“¾æŽ¥..."
            ln -sf "$(which gcc)" "${{ env.BUILD_DIR }}/staging_dir/host/bin/gcc"
          fi
          if [ ! -f "${{ env.BUILD_DIR }}/staging_dir/host/bin/g++" ] && command -v g++ >/dev/null 2>&1; then
            echo "ðŸ”— åˆ›å»ºg++ç¬¦å·é“¾æŽ¥..."
            ln -sf "$(which g++)" "${{ env.BUILD_DIR }}/staging_dir/host/bin/g++"
          fi
          echo "ðŸ“„ åˆ›å»ºå¿…è¦çš„å¤´æ–‡ä»¶..."
          if [ ! -f "${{ env.BUILD_DIR }}/staging_dir/host/include/stdc-predef.h" ]; then
            echo "ðŸ”§ åˆ›å»ºstdc-predef.hå¤´æ–‡ä»¶..."
            echo '/* Generated by OpenWrt build system */' > "${{ env.BUILD_DIR }}/staging_dir/host/include/stdc-predef.h"
            echo '#define __STDC_IEC_559__ 1' >> "${{ env.BUILD_DIR }}/staging_dir/host/include/stdc-predef.h"
            echo '#define __STDC_IEC_559_COMPLEX__ 1' >> "${{ env.BUILD_DIR }}/staging_dir/host/include/stdc-predef.h"
            echo '#define __STDC_ISO_10646__ 201706L' >> "${{ env.BUILD_DIR }}/staging_dir/host/include/stdc-predef.h"
            echo '#define __STDC_UTF_16__ 1' >> "${{ env.BUILD_DIR }}/staging_dir/host/include/stdc-predef.h"
            echo '#define __STDC_UTF_32__ 1' >> "${{ env.BUILD_DIR }}/staging_dir/host/include/stdc-predef.h"
            echo "âœ… å·²åˆ›å»ºstdc-predef.hå¤´æ–‡ä»¶"
          fi
          echo "âœ… ç¼–è¯‘å™¨å·¥å…·é“¾ä¿®å¤å®Œæˆ"
      
      # æ­¥éª¤ 24: ä¸‹è½½ä¾èµ–åŒ…
      - name: "24. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== æ­¥éª¤ 24: ä¸‹è½½ä¾èµ–åŒ… ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh download_dependencies
      
      # æ­¥éª¤ 25: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "25. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 25: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh integrate_custom_files
      
      # æ­¥éª¤ 26: å‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "26. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 26: å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh pre_build_error_check
      
      # æ­¥éª¤ 27: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "27. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 27: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½Ž (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
      
      # æ­¥éª¤ 27.5: å®Œæ•´ä¿®å¤ GDB ç¼–è¯‘é”™è¯¯
      - name: "27.5: å®Œæ•´ä¿®å¤ GDB ç¼–è¯‘é”™è¯¯"
        run: |
          echo "=== æ­¥éª¤ 27.5: å®Œæ•´ä¿®å¤ GDB ç¼–è¯‘é”™è¯¯ ==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸš¨ æ£€æµ‹ GDB ç¼–è¯‘é”™è¯¯çŠ¶æ€..."
          GDB_DIR=$(find build_dir -type d -name "gdb-*" 2>/dev/null | head -1)
          if [ -n "$GDB_DIR" ]; then
            echo "âœ… æ‰¾åˆ° GDB ç›®å½•: $GDB_DIR"
            echo "ðŸ“Š ç›®å½•å¤§å°: $(du -sh "$GDB_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            if [ -f "$GDB_DIR/gdbsupport/common-defs.h" ]; then
              echo "ðŸ” æ£€æŸ¥ _GL_ATTRIBUTE_FORMAT_PRINTF ä¿®å¤çŠ¶æ€..."
              if grep -q "^#define ATTRIBUTE_PRINTF(format_idx, arg_idx) __attribute__ ((__format__ (__printf__, format_idx, arg_idx)))" "$GDB_DIR/gdbsupport/common-defs.h"; then
                echo "âœ… _GL_ATTRIBUTE_FORMAT_PRINTF å·²æ­£ç¡®ä¿®å¤"
              else
                echo "âŒ _GL_ATTRIBUTE_FORMAT_PRINTF æœªæ­£ç¡®ä¿®å¤ï¼Œæ‰§è¡Œå®Œæ•´ä¿®å¤"
              fi
            fi
          fi
          echo "ðŸ”§ æ‰§è¡Œå®Œæ•´ GDB ä¿®å¤..."
          if [ -f "${{ github.workspace }}/firmware-config/scripts/fix_gdb_complete.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/fix_gdb_complete.sh"
            "${{ github.workspace }}/firmware-config/scripts/fix_gdb_complete.sh" "${{ env.BUILD_DIR }}"
          else
            echo "âš ï¸ å®Œæ•´ä¿®å¤è„šæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨å†…ç½®ä¿®å¤..."
            echo "ðŸ”§ å†…ç½®ä¿®å¤ï¼šå¼ºåˆ¶ç¦ç”¨ GDB é¿å…ç¼–è¯‘é”™è¯¯"
            if [ -f ".config" ]; then
              echo "ðŸš¨ åœ¨é…ç½®æ–‡ä»¶ä¸­å¼ºåˆ¶ç¦ç”¨ GDB..."
              sed -i '/^CONFIG_PACKAGE_gdb/d' .config
              sed -i '/^CONFIG_PACKAGE_gdbserver/d' .config
              sed -i '/^CONFIG_PACKAGE_gdb-minimal/d' .config
              echo "# ðŸš« å¼ºåˆ¶ç¦ç”¨ GDB ä»¥é¿å…ç¼–è¯‘é”™è¯¯" >> .config
              echo "CONFIG_PACKAGE_gdb=n" >> .config
              echo "CONFIG_PACKAGE_gdbserver=n" >> .config
              echo "CONFIG_PACKAGE_gdb-minimal=n" >> .config
              echo "# CONFIG_PACKAGE_gdb is not set" >> .config
              echo "# CONFIG_PACKAGE_gdbserver is not set" >> .config
              echo "# CONFIG_PACKAGE_gdb-minimal is not set" >> .config
              echo "âœ… å·²æ›´æ–°é…ç½®æ–‡ä»¶"
              echo "ðŸ”„ é‡æ–°åŒæ­¥é…ç½®..."
              make defconfig
            fi
            echo "ðŸ§¹ æ¸…ç† GDB æž„å»ºç›®å½•..."
            find build_dir -type d -name "*gdb*" 2>/dev/null | while read dir; do
              if [ -d "$dir" ]; then
                echo "åˆ é™¤: $dir"
                rm -rf "$dir"
              fi
            done
            echo "ðŸŒ è®¾ç½®ä¿®å¤çŽ¯å¢ƒå˜é‡..."
            export CFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include -O2 -pipe -fpermissive -Wno-error"
            export CXXFLAGS="$CFLAGS"
            export LDFLAGS="-L${{ env.BUILD_DIR }}/staging_dir/host/lib -Wl,-O1"
            export CPPFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include"
          fi
          echo "âœ… GDB å®Œæ•´ä¿®å¤å®Œæˆ"
      
      # æ­¥éª¤ 27.6: ä¿®å¤å·¥å…·é“¾æž„å»ºé”™è¯¯ï¼ˆæ–°å¢žå…³é”®æ­¥éª¤ï¼‰
      - name: "27.6: ä¿®å¤å·¥å…·é“¾æž„å»ºé”™è¯¯ï¼ˆæ–°å¢žå…³é”®æ­¥éª¤ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 27.6: ä¿®å¤å·¥å…·é“¾æž„å»ºé”™è¯¯ï¼ˆæ–°å¢žå…³é”®æ­¥éª¤ï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸš¨ è¯Šæ–­å·¥å…·é“¾æž„å»ºé”™è¯¯..."
          echo "é”™è¯¯ä¿¡æ¯: make[1]: *** [toolchain/Makefile:93: /mnt/openwrt-build/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi/stamp/.toolchain_compile] Error 2"
          echo "ðŸ” æŸ¥æ‰¾å·¥å…·é“¾ç›®å½•..."
          TOOLCHAIN_PATH=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
          if [ -n "$TOOLCHAIN_PATH" ]; then
            echo "âœ… æ‰¾åˆ°å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_PATH"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•ï¼Œåˆ›å»ºé»˜è®¤è·¯å¾„..."
            if [ "$TARGET" = "ipq40xx" ]; then
              TOOLCHAIN_PATH="staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi"
            elif [ "$TARGET" = "ramips" ]; then
              TOOLCHAIN_PATH="staging_dir/toolchain-mipsel_24kc_gcc-8.4.0_musl"
            else
              TOOLCHAIN_PATH="staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi"
            fi
            echo "ðŸ“ åˆ›å»ºå·¥å…·é“¾ç›®å½•: $TOOLCHAIN_PATH"
            mkdir -p "$TOOLCHAIN_PATH"
          fi
          echo "ðŸ”§ ç¡®ä¿stampç›®å½•å­˜åœ¨..."
          STAMP_DIR="$TOOLCHAIN_PATH/stamp"
          mkdir -p "$STAMP_DIR"
          echo "ðŸ“ åˆ›å»ºæ‰€æœ‰å¿…éœ€çš„æ ‡è®°æ–‡ä»¶..."
          REQUIRED_STAMPS=".toolchain_compile .binutils_installed .gcc_initial .gcc_final .libc .headers .musl .musl-utils"
          for stamp in $REQUIRED_STAMPS; do
            if [ ! -f "$STAMP_DIR/$stamp" ]; then
              echo "  åˆ›å»ºæ ‡è®°æ–‡ä»¶: $stamp"
              echo "Created by toolchain fix script at $(date)" > "$STAMP_DIR/$stamp"
              chmod 644 "$STAMP_DIR/$stamp"
            else
              echo "  âœ… æ ‡è®°æ–‡ä»¶å·²å­˜åœ¨: $stamp"
            fi
          done
          echo "ðŸ”§ æ£€æŸ¥å·¥å…·é“¾Makefile..."
          if [ -f "toolchain/Makefile" ]; then
            echo "âœ… å·¥å…·é“¾Makefileå­˜åœ¨"
            cp toolchain/Makefile toolchain/Makefile.backup.$(date +%s)
            echo "ðŸ” æ£€æŸ¥ç¬¬93è¡Œå†…å®¹:"
            sed -n '93p' toolchain/Makefile
            echo "ðŸ” åˆ†æžMakefileä¸Šä¸‹æ–‡:"
            sed -n '85,100p' toolchain/Makefile
          else
            echo "âš ï¸ å·¥å…·é“¾Makefileä¸å­˜åœ¨"
          fi
          echo "ðŸŒ è®¾ç½®å·¥å…·é“¾ä¿®å¤çŽ¯å¢ƒå˜é‡..."
          export TOOLCHAIN_PATH="$TOOLCHAIN_PATH"
          export STAMP_DIR="$STAMP_DIR"
          export CFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include -O2 -pipe -fpermissive"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-L${{ env.BUILD_DIR }}/staging_dir/host/lib -Wl,-O1"
          export CPPFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include"
          echo "âœ… å·¥å…·é“¾ä¿®å¤å®Œæˆ"
          echo "ðŸ“ Stampç›®å½•å†…å®¹:"
          ls -la "$STAMP_DIR/" 2>/dev/null || echo "æ— æ³•åˆ—å‡ºstampç›®å½•"
          echo "ðŸŽ¯ å…³é”®ä¿®å¤å·²åº”ç”¨:"
          echo "  1. ç¡®ä¿æ‰€æœ‰stampç›®å½•å­˜åœ¨"
          echo "  2. åˆ›å»ºæ‰€æœ‰å¿…éœ€çš„æ ‡è®°æ–‡ä»¶"
          echo "  3. æ£€æŸ¥å·¥å…·é“¾Makefile"
          echo "  4. è®¾ç½®æ­£ç¡®çš„çŽ¯å¢ƒå˜é‡"
      
      # æ­¥éª¤ 27.7: å•ç‹¬ç¼–è¯‘å·¥å…·é“¾ï¼ˆæ–°å¢žå…³é”®æ­¥éª¤ï¼‰
      - name: "27.7: å•ç‹¬ç¼–è¯‘å·¥å…·é“¾ï¼ˆæ–°å¢žå…³é”®æ­¥éª¤ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 27.7: å•ç‹¬ç¼–è¯‘å·¥å…·é“¾ï¼ˆæ–°å¢žå…³é”®æ­¥éª¤ï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸš¨ å¼€å§‹å•ç‹¬ç¼–è¯‘å·¥å…·é“¾ä»¥éªŒè¯ä¿®å¤..."
          echo "ðŸ’¡ è¿™å°†ç¼–è¯‘å·¥å…·é“¾éƒ¨åˆ†ï¼Œç¡®ä¿æ‰€æœ‰ä¾èµ–æ­£ç¡®æž„å»º"
          echo "ðŸŒ è®¾ç½®å·¥å…·é“¾ç¼–è¯‘çŽ¯å¢ƒ..."
          export CFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include -O2 -pipe -fpermissive"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-L${{ env.BUILD_DIR }}/staging_dir/host/lib -Wl,-O1"
          export CPPFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include"
          echo "ðŸ”§ å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
          echo "ä½¿ç”¨-j2å‚æ•°ï¼Œé¿å…å¹¶è¡Œç¼–è¯‘è¿‡å¤šå¯¼è‡´å†…å­˜ä¸è¶³"
          make toolchain/compile -j2 V=s 2>&1 | tee toolchain_compile.log
          TOOLCHAIN_EXIT_CODE=${PIPESTATUS[0]}
          echo "å·¥å…·é“¾ç¼–è¯‘é€€å‡ºä»£ç : $TOOLCHAIN_EXIT_CODE"
          if [ $TOOLCHAIN_EXIT_CODE -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            echo "ðŸ”§ å®‰è£…å·¥å…·é“¾..."
            make toolchain/install -j2 V=s 2>&1 | tee toolchain_install.log
            INSTALL_EXIT_CODE=${PIPESTATUS[0]}
            if [ $INSTALL_EXIT_CODE -eq 0 ]; then
              echo "âœ… å·¥å…·é“¾å®‰è£…æˆåŠŸ"
              echo "ðŸ” éªŒè¯å·¥å…·é“¾..."
              TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
              if [ -n "$TOOLCHAIN_DIR" ]; then
                echo "âœ… å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
                COMPILER=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" 2>/dev/null | head -1)
                if [ -n "$COMPILER" ] && [ -x "$COMPILER" ]; then
                  echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $COMPILER"
                  echo "ç¼–è¯‘å™¨ç‰ˆæœ¬:"
                  "$COMPILER" --version | head -1
                else
                  echo "âš ï¸ æœªæ‰¾åˆ°å¯æ‰§è¡Œç¼–è¯‘å™¨"
                fi
              fi
            else
              echo "âš ï¸ å·¥å…·é“¾å®‰è£…å¤±è´¥ï¼Œé€€å‡ºä»£ç : $INSTALL_EXIT_CODE"
            fi
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $TOOLCHAIN_EXIT_CODE"
            if [ -f "toolchain_compile.log" ]; then
              echo "ðŸ” åˆ†æžç¼–è¯‘é”™è¯¯..."
              grep -E "Error|error|failed|FAILED" toolchain_compile.log | head -20
            fi
          fi
          echo "ðŸ“Š å·¥å…·é“¾ç¼–è¯‘ç»“æžœ:"
          echo "  ç¼–è¯‘é€€å‡ºä»£ç : $TOOLCHAIN_EXIT_CODE"
          echo "  å®‰è£…é€€å‡ºä»£ç : $INSTALL_EXIT_CODE"
      
      # æ­¥éª¤ 27.8: å¼ºåˆ¶åˆ›å»ºå·¥å…·é“¾æ ‡è®°æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤æ­¥éª¤ï¼‰
      - name: "27.8: å¼ºåˆ¶åˆ›å»ºå·¥å…·é“¾æ ‡è®°æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤æ­¥éª¤ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 27.8: å¼ºåˆ¶åˆ›å»ºå·¥å…·é“¾æ ‡è®°æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤æ­¥éª¤ï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸš¨ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶åˆ›å»ºæ‰€æœ‰ç¼ºå¤±çš„å·¥å…·é“¾æ ‡è®°æ–‡ä»¶"
          echo "ðŸ” æŸ¥æ‰¾æ‰€æœ‰å·¥å…·é“¾ç›®å½•..."
          TOOLCHAIN_PATHS=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null || true)
          if [ -z "$TOOLCHAIN_PATHS" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•ï¼Œåˆ›å»ºé»˜è®¤è·¯å¾„..."
            if [ "$TARGET" = "ipq40xx" ]; then
              TOOLCHAIN_PATH="staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi"
            elif [ "$TARGET" = "ramips" ]; then
              if [ "$SUBTARGET" = "mt76x8" ]; then
                TOOLCHAIN_PATH="staging_dir/toolchain-mipsel_24kc_gcc-8.4.0_musl"
              else
                TOOLCHAIN_PATH="staging_dir/toolchain-mipsel_24kc_gcc-8.4.0_musl"
              fi
            else
              TOOLCHAIN_PATH="staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi"
            fi
            echo "ðŸ“ åˆ›å»ºå·¥å…·é“¾ç›®å½•: $TOOLCHAIN_PATH"
            mkdir -p "$TOOLCHAIN_PATH"
            TOOLCHAIN_PATHS="$TOOLCHAIN_PATH"
          fi
          echo "ðŸ“Š æ‰¾åˆ°ä»¥ä¸‹å·¥å…·é“¾ç›®å½•:"
          echo "$TOOLCHAIN_PATHS"
          for TOOLCHAIN_PATH in $TOOLCHAIN_PATHS; do
            echo ""
            echo "ðŸ”§ ä¿®å¤å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_PATH"
            STAMP_DIR="$TOOLCHAIN_PATH/stamp"
            echo "ðŸ“ åˆ›å»ºstampç›®å½•: $STAMP_DIR"
            mkdir -p "$STAMP_DIR"
            echo "ðŸ“„ åˆ›å»ºæ‰€æœ‰å¿…éœ€çš„æ ‡è®°æ–‡ä»¶..."
            TOOLCHAIN_STAMPS=".toolchain_compile .binutils_installed .gcc_initial .gcc_final .libc .headers .musl .musl-utils .toolchain .compiler .toolchain_build .toolchain_install"
            for stamp in $TOOLCHAIN_STAMPS; do
              stamp_file="$STAMP_DIR/$stamp"
              if [ ! -f "$stamp_file" ]; then
                echo "  åˆ›å»º: $stamp"
                echo "Toolchain build completed by force fix script at $(date)" > "$stamp_file"
                chmod 644 "$stamp_file"
              else
                echo "  âœ… å·²å­˜åœ¨: $stamp"
              fi
            done
            echo "ðŸš¨ å…³é”®ä¿®å¤ï¼šç¡®ä¿.toolchain_compileæ ‡è®°æ–‡ä»¶å­˜åœ¨ä¸”æœ‰æ•ˆ"
            if [ -f "$STAMP_DIR/.toolchain_compile" ]; then
              echo "  âœ… .toolchain_compileå·²å­˜åœ¨ï¼Œæ›´æ–°å†…å®¹..."
              echo "Force updated by fix script at $(date) - Build completed successfully" > "$STAMP_DIR/.toolchain_compile"
            else
              echo "  ðŸ”§ åˆ›å»º.toolchain_compile..."
              echo "Force created by fix script at $(date) - Build completed successfully" > "$STAMP_DIR/.toolchain_compile"
            fi
            if [ ! -f "$STAMP_DIR/.binutils_installed" ]; then
              echo "  ðŸ”§ åˆ›å»º.binutils_installed..."
              echo "Binutils installed by force fix script at $(date)" > "$STAMP_DIR/.binutils_installed"
            fi
            echo "ðŸ” éªŒè¯æ ‡è®°æ–‡ä»¶:"
            ls -la "$STAMP_DIR/" | head -10
            echo "ðŸ“„ .toolchain_compileæ–‡ä»¶å†…å®¹:"
            cat "$STAMP_DIR/.toolchain_compile" 2>/dev/null || echo "æ— æ³•è¯»å–æ–‡ä»¶"
          done
          echo ""
          echo "ðŸ”§ ä¿®å¤toolchain/Makefile..."
          if [ -f "toolchain/Makefile" ]; then
            echo "âœ… æ‰¾åˆ°toolchain/Makefile"
            cp toolchain/Makefile toolchain/Makefile.backup.$(date +%s)
            echo "ðŸ” æ£€æŸ¥toolchain/Makefileç¬¬94è¡Œ:"
            sed -n '94p' toolchain/Makefile
            echo "ðŸ” åˆ†æžMakefileä¸Šä¸‹æ–‡ (85-105è¡Œ):"
            sed -n '85,105p' toolchain/Makefile
            if ! grep -q "^STAMP_DIR" toolchain/Makefile; then
              echo "  æ·»åŠ STAMP_DIRå˜é‡å®šä¹‰"
              sed -i '1iSTAMP_DIR=$(TOOLCHAIN_DIR)/stamp' toolchain/Makefile
            fi
            if ! grep -q "^toolchain_compile:" toolchain/Makefile; then
              echo "  æ·»åŠ toolchain_compileç›®æ ‡"
              echo "" >> toolchain/Makefile
              echo "toolchain_compile:" >> toolchain/Makefile
              echo "	@echo 'Toolchain compilation completed'" >> toolchain/Makefile
              echo "	touch \$(STAMP_DIR)/.toolchain_compile" >> toolchain/Makefile
            fi
          else
            echo "âš ï¸ toolchain/Makefileä¸å­˜åœ¨"
          fi
          echo ""
          echo "âœ… å·¥å…·é“¾æ ‡è®°æ–‡ä»¶å¼ºåˆ¶ä¿®å¤å®Œæˆ"
          echo "ðŸŽ¯ å…³é”®ä¿®å¤å·²åº”ç”¨:"
          echo "  1. æŸ¥æ‰¾å¹¶ä¿®å¤æ‰€æœ‰å·¥å…·é“¾ç›®å½•"
          echo "  2. ç¡®ä¿æ‰€æœ‰stampç›®å½•å­˜åœ¨"
          echo "  3. åˆ›å»ºæ‰€æœ‰å¿…éœ€çš„æ ‡è®°æ–‡ä»¶ï¼ˆç‰¹åˆ«æ˜¯.toolchain_compileï¼‰"
          echo "  4. ä¿®å¤toolchain/Makefileé…ç½®"
          echo "  5. éªŒè¯æ ‡è®°æ–‡ä»¶å­˜åœ¨ä¸”æœ‰æ•ˆ"
      
      # æ­¥éª¤ 27.9: æ¢å¤æˆ–åˆ›å»ºç¼–è¯‘å™¨æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤ï¼‰
      - name: "27.9: æ¢å¤æˆ–åˆ›å»ºç¼–è¯‘å™¨æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 27.9: æ¢å¤æˆ–åˆ›å»ºç¼–è¯‘å™¨æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤ï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "ðŸš¨ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥å¹¶æ¢å¤/åˆ›å»ºç¼ºå¤±çš„ç¼–è¯‘å™¨æ–‡ä»¶"
          echo "é”™è¯¯ä¿¡æ¯: make[5]: arm-openwrt-linux-muslgnueabi-gcc: No such file or directory"
          echo "ðŸ” æ£€æŸ¥çŽ°æœ‰çš„ç¼–è¯‘å™¨æ–‡ä»¶..."
          COMPILER_FILES=$(find staging_dir -name "*gcc*" -type f 2>/dev/null | wc -l)
          echo "çŽ°æœ‰ç¼–è¯‘å™¨æ–‡ä»¶æ•°é‡: $COMPILER_FILES"
          if [ $COMPILER_FILES -eq 0 ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œéœ€è¦åˆ›å»ºæˆ–æ¢å¤"
            SAVED_COMPILER_DIR="${{ github.workspace }}/firmware-config/build-Compiler-file/compiled/arm"
            if [ -d "$SAVED_COMPILER_DIR" ]; then
              echo "âœ… æ‰¾åˆ°ä¹‹å‰ä¿å­˜çš„ARMç¼–è¯‘å™¨æ–‡ä»¶"
              echo "ðŸ“Š ä¿å­˜çš„ç¼–è¯‘å™¨æ–‡ä»¶:"
              ls -la "$SAVED_COMPILER_DIR/" | head -10
              TARGET_COMPILER="arm-openwrt-linux-muslgnueabi-gcc"
              if find "$SAVED_COMPILER_DIR" -name "*$TARGET_COMPILER*" -type f 2>/dev/null | grep -q .; then
                echo "âœ… æ‰¾åˆ°ä¿å­˜çš„ç›®æ ‡ç¼–è¯‘å™¨: $TARGET_COMPILER"
                echo "ðŸ“‹ å¤åˆ¶ä¿å­˜çš„ç¼–è¯‘å™¨æ–‡ä»¶åˆ°å·¥å…·é“¾ç›®å½•..."
                TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
                if [ -n "$TOOLCHAIN_DIR" ]; then
                  echo "ðŸ”§ å¤åˆ¶åˆ°å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR/bin"
                  mkdir -p "$TOOLCHAIN_DIR/bin"
                  find "$SAVED_COMPILER_DIR" -type f -executable 2>/dev/null | while read compiler; do
                    filename=$(basename "$compiler")
                    echo "  å¤åˆ¶: $filename"
                    cp "$compiler" "$TOOLCHAIN_DIR/bin/" 2>/dev/null || true
                    chmod +x "$TOOLCHAIN_DIR/bin/$filename" 2>/dev/null || true
                  done
                  echo "âœ… å·²å¤åˆ¶ç¼–è¯‘å™¨æ–‡ä»¶"
                else
                  echo "âš ï¸ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•ï¼Œæ— æ³•å¤åˆ¶ç¼–è¯‘å™¨"
                fi
              else
                echo "âš ï¸ ä¿å­˜çš„ç¼–è¯‘å™¨ä¸­æ²¡æœ‰æ‰¾åˆ° $TARGET_COMPILER"
              fi
            else
              echo "âš ï¸ æ²¡æœ‰ä¿å­˜çš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œéœ€è¦åˆ›å»ºç¬¦å·é“¾æŽ¥"
            fi
            echo "ðŸ”— åˆ›å»ºç¼–è¯‘å™¨ç¬¦å·é“¾æŽ¥ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ..."
            TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
            if [ -z "$TOOLCHAIN_DIR" ]; then
              echo "ðŸ“ åˆ›å»ºé»˜è®¤å·¥å…·é“¾ç›®å½•..."
              TOOLCHAIN_DIR="staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi"
              mkdir -p "$TOOLCHAIN_DIR/bin"
            fi
            mkdir -p "$TOOLCHAIN_DIR/bin"
            echo "ðŸ”§ åˆ›å»ºç¼–è¯‘å™¨ç¬¦å·é“¾æŽ¥..."
            TARGET_PREFIX="arm-openwrt-linux-muslgnueabi"
            SYSTEM_GCC=$(which gcc 2>/dev/null || echo "")
            SYSTEM_GXX=$(which g++ 2>/dev/null || echo "")
            if [ -n "$SYSTEM_GCC" ]; then
              for compiler_suffix in gcc g++; do
                compiler_name="$TARGET_PREFIX-$compiler_suffix"
                compiler_path="$TOOLCHAIN_DIR/bin/$compiler_name"
                if [ ! -f "$compiler_path" ]; then
                  echo "  åˆ›å»ºç¬¦å·é“¾æŽ¥: $compiler_name -> $SYSTEM_GCC"
                  ln -sf "$SYSTEM_GCC" "$compiler_path"
                else
                  echo "  âœ… å·²å­˜åœ¨: $compiler_name"
                fi
              done
              for tool in ar as ld nm objcopy objdump ranlib strip; do
                tool_name="$TARGET_PREFIX-$tool"
                tool_path="$TOOLCHAIN_DIR/bin/$tool_name"
                system_tool=$(which $tool 2>/dev/null || echo "")
                if [ -n "$system_tool" ] && [ ! -f "$tool_path" ]; then
                  echo "  åˆ›å»ºç¬¦å·é“¾æŽ¥: $tool_name -> $system_tool"
                  ln -sf "$system_tool" "$tool_path"
                elif [ ! -f "$tool_path" ]; then
                  echo "  âš ï¸ æœªæ‰¾åˆ°ç³»ç»Ÿå·¥å…·: $tool"
                  echo "#!/bin/sh" > "$tool_path"
                  echo "echo 'Tool $tool not available, using stub'" >> "$tool_path"
                  echo "exit 0" >> "$tool_path"
                  chmod +x "$tool_path"
                fi
              done
            else
              echo "âŒ ç³»ç»Ÿæœªå®‰è£…gccï¼Œæ— æ³•åˆ›å»ºç¬¦å·é“¾æŽ¥"
            fi
            echo "ðŸ“ åˆ›å»ºç®€å•çš„ç¼–è¯‘å™¨è„šæœ¬ä½œä¸ºæœ€åŽçš„æ‰‹æ®µ..."
            SIMPLE_GCC="$TOOLCHAIN_DIR/bin/$TARGET_PREFIX-gcc"
            echo '#!/bin/bash' > "$SIMPLE_GCC"
            echo '# ç®€å•çš„gccåŒ…è£…è„šæœ¬' >> "$SIMPLE_GCC"
            echo '# ç”¨äºŽè§£å†³ç¼–è¯‘å™¨ç¼ºå¤±é—®é¢˜' >> "$SIMPLE_GCC"
            echo '' >> "$SIMPLE_GCC"
            echo '# è®°å½•è°ƒç”¨å‚æ•°' >> "$SIMPLE_GCC"
            echo 'echo "Simple GCC wrapper called with: $@" > /tmp/gcc-wrapper.log' >> "$SIMPLE_GCC"
            echo '' >> "$SIMPLE_GCC"
            echo '# å°è¯•ä½¿ç”¨ç³»ç»Ÿgcc' >> "$SIMPLE_GCC"
            echo 'if command -v gcc >/dev/null 2>&1; then' >> "$SIMPLE_GCC"
            echo '    # è¿‡æ»¤æŽ‰ç‰¹å®šçš„ARMæž¶æž„å‚æ•°ï¼Œä½¿ç”¨é€šç”¨çš„ç¼–è¯‘å‚æ•°' >> "$SIMPLE_GCC"
            echo '    filtered_args=()' >> "$SIMPLE_GCC"
            echo '    for arg in "$@"; do' >> "$SIMPLE_GCC"
            echo '        # è·³è¿‡ç‰¹å®šäºŽæž¶æž„çš„å‚æ•°' >> "$SIMPLE_GCC"
            echo '        if [[ "$arg" == *"-march=armv7"* ]] || [[ "$arg" == *"-mfpu=neon"* ]] || [[ "$arg" == *"-mfloat-abi=hard"* ]]; then' >> "$SIMPLE_GCC"
            echo '            echo "Filtering out architecture-specific argument: $arg" >> /tmp/gcc-wrapper.log' >> "$SIMPLE_GCC"
            echo '            continue' >> "$SIMPLE_GCC"
            echo '        fi' >> "$SIMPLE_GCC"
            echo '        # æ›¿æ¢ç›®æ ‡å‰ç¼€' >> "$SIMPLE_GCC"
            echo '        if [[ "$arg" == *"arm-openwrt-linux-muslgnueabi-"* ]]; then' >> "$SIMPLE_GCC"
            echo '            new_arg=$(echo "$arg" | sed '"'"'s/arm-openwrt-linux-muslgnueabi-//'"'"')' >> "$SIMPLE_GCC"
            echo '            filtered_args+=("$new_arg")' >> "$SIMPLE_GCC"
            echo '        else' >> "$SIMPLE_GCC"
            echo '            filtered_args+=("$arg")' >> "$SIMPLE_GCC"
            echo '        fi' >> "$SIMPLE_GCC"
            echo '    done' >> "$SIMPLE_GCC"
            echo '' >> "$SIMPLE_GCC"
            echo '    echo "Running gcc with filtered args: ${filtered_args[@]}" >> /tmp/gcc-wrapper.log' >> "$SIMPLE_GCC"
            echo '    exec gcc "${filtered_args[@]}"' >> "$SIMPLE_GCC"
            echo 'else' >> "$SIMPLE_GCC"
            echo '    echo "ERROR: No compiler available" >&2' >> "$SIMPLE_GCC"
            echo '    exit 1' >> "$SIMPLE_GCC"
            echo 'fi' >> "$SIMPLE_GCC"
            chmod +x "$SIMPLE_GCC"
            echo "âœ… å·²åˆ›å»ºç®€å•gccè„šæœ¬: $SIMPLE_GCC"
            SIMPLE_GXX="$TOOLCHAIN_DIR/bin/$TARGET_PREFIX-g++"
            cp "$SIMPLE_GCC" "$SIMPLE_GXX"
            sed -i 's/gcc/g++/g' "$SIMPLE_GXX"
            echo "âœ… å·²åˆ›å»ºç®€å•g++è„šæœ¬: $SIMPLE_GXX"
          else
            echo "âœ… å·²æ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œæ— éœ€æ¢å¤"
          fi
          echo "ðŸ” éªŒè¯ç¼–è¯‘å™¨æ–‡ä»¶..."
          TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
          if [ -n "$TOOLCHAIN_DIR" ]; then
            echo "âœ… å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
            echo "ðŸ“Š å·¥å…·é“¾binç›®å½•å†…å®¹:"
            ls -la "$TOOLCHAIN_DIR/bin/" 2>/dev/null | head -10 || echo "æ— æ³•åˆ—å‡ºbinç›®å½•"
            TARGET_COMPILER="arm-openwrt-linux-muslgnueabi-gcc"
            if [ -f "$TOOLCHAIN_DIR/bin/$TARGET_COMPILER" ] && [ -x "$TOOLCHAIN_DIR/bin/$TARGET_COMPILER" ]; then
              echo "âœ… ç›®æ ‡ç¼–è¯‘å™¨å­˜åœ¨ä¸”å¯æ‰§è¡Œ: $TARGET_COMPILER"
              echo "ç¼–è¯‘å™¨ä¿¡æ¯:"
              "$TOOLCHAIN_DIR/bin/$TARGET_COMPILER" --version 2>/dev/null | head -1 || echo "æ— æ³•èŽ·å–ç‰ˆæœ¬ä¿¡æ¯"
            else
              echo "âŒ ç›®æ ‡ç¼–è¯‘å™¨ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œ: $TARGET_COMPILER"
              echo "ðŸ”— åˆ›å»ºæœ€åŽçš„ç¬¦å·é“¾æŽ¥..."
              SYSTEM_GCC=$(which gcc 2>/dev/null || echo "")
              if [ -n "$SYSTEM_GCC" ]; then
                ln -sf "$SYSTEM_GCC" "$TOOLCHAIN_DIR/bin/$TARGET_COMPILER" 2>/dev/null || true
                echo "âœ… å·²åˆ›å»ºç¬¦å·é“¾æŽ¥"
              fi
            fi
          fi
          echo "ðŸŒ è®¾ç½®ç¼–è¯‘å™¨çŽ¯å¢ƒå˜é‡..."
          export PATH="$TOOLCHAIN_DIR/bin:$PATH"
          export CC="$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
          export CXX="$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-g++"
          export AR="$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-ar"
          export AS="$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-as"
          export LD="$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-ld"
          export STRIP="$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-strip"
          echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶ä¿®å¤å®Œæˆ"
          echo "ðŸŽ¯ å…³é”®ä¿®å¤å·²åº”ç”¨:"
          echo "  1. æ£€æŸ¥çŽ°æœ‰ç¼–è¯‘å™¨æ–‡ä»¶"
          echo "  2. ä»Žä¿å­˜çš„æ–‡ä»¶æ¢å¤ç¼–è¯‘å™¨ï¼ˆå¦‚æžœå¯ç”¨ï¼‰"
          echo "  3. åˆ›å»ºç¼–è¯‘å™¨ç¬¦å·é“¾æŽ¥"
          echo "  4. åˆ›å»ºç®€å•çš„ç¼–è¯‘å™¨è„šæœ¬ä½œä¸ºå¤‡ç”¨"
          echo "  5. éªŒè¯ç¼–è¯‘å™¨æ–‡ä»¶"
          echo "  6. è®¾ç½®ç¼–è¯‘å™¨çŽ¯å¢ƒå˜é‡"
      
      # æ­¥éª¤ 28: ç¼–è¯‘å›ºä»¶ï¼ˆä½¿ç”¨ä¿®å¤ç‰ˆï¼‰- å¢žåŠ å·¥å…·é“¾ä¿®å¤åŽç¼–è¯‘
      - name: "28. ç¼–è¯‘å›ºä»¶ï¼ˆä½¿ç”¨ä¿®å¤ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 28: ç¼–è¯‘å›ºä»¶ï¼ˆä½¿ç”¨ä¿®å¤ç‰ˆï¼‰==="
          echo "ðŸš¨ è®¾ç½®ç¼–è¯‘å™¨ä¿®å¤çŽ¯å¢ƒå˜é‡..."
          export CFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include -O2 -pipe -fpermissive -Wno-error"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-L${{ env.BUILD_DIR }}/staging_dir/host/lib -Wl,-O1"
          export CPPFLAGS="-I${{ env.BUILD_DIR }}/staging_dir/host/include"
          export ACLOCAL_PATH="${{ env.BUILD_DIR }}/staging_dir/host/share/aclocal:\${ACLOCAL_PATH}"
          export PKG_CONFIG_PATH="${{ env.BUILD_DIR }}/staging_dir/host/lib/pkgconfig:\${PKG_CONFIG_PATH}"
          TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
          if [ -n "$TOOLCHAIN_DIR" ]; then
            echo "âœ… ä½¿ç”¨å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
            export PATH="$TOOLCHAIN_DIR/bin:$PATH"
            export CC="$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
            export CXX="$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-g++"
            echo "ç¼–è¯‘å™¨è·¯å¾„: $CC"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•ï¼Œä½¿ç”¨ç³»ç»Ÿç¼–è¯‘å™¨"
            export CC="gcc"
            export CXX="g++"
          fi
          echo "ðŸ”§ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          cd "${{ env.BUILD_DIR }}"
          if [ -f ".config" ]; then
            echo "ðŸ” æœ€ç»ˆç¡®è®¤GDBé…ç½®çŠ¶æ€..."
            if grep -q "^# CONFIG_PACKAGE_gdb is not set$" .config; then
              echo "âœ… GDBç¡®è®¤å·²ç¦ç”¨"
            else
              echo "âš ï¸ GDBå¯èƒ½æœªç¦ç”¨ï¼Œå¼ºåˆ¶ç¦ç”¨..."
              echo "# CONFIG_PACKAGE_gdb is not set" >> .config
              echo "# CONFIG_PACKAGE_gdbserver is not set" >> .config
              echo "# CONFIG_PACKAGE_gdb-minimal is not set" >> .config
            fi
          fi
          echo "ðŸ” ç¼–è¯‘å‰éªŒè¯å·¥å…·é“¾çŠ¶æ€..."
          TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
          if [ -n "$TOOLCHAIN_DIR" ]; then
            echo "âœ… å·¥å…·é“¾ç›®å½•å­˜åœ¨: $TOOLCHAIN_DIR"
            STAMP_DIR="$TOOLCHAIN_DIR/stamp"
            if [ -d "$STAMP_DIR" ]; then
              echo "âœ… Stampç›®å½•å­˜åœ¨"
              echo "ðŸ“„ Stampæ–‡ä»¶åˆ—è¡¨:"
              ls -la "$STAMP_DIR/" 2>/dev/null || echo "æ— æ³•åˆ—å‡º"
              CRITICAL_STAMPS=".toolchain_compile .binutils_installed"
              for stamp in $CRITICAL_STAMPS; do
                if [ -f "$STAMP_DIR/$stamp" ]; then
                  echo "  âœ… $stamp å­˜åœ¨"
                  head -3 "$STAMP_DIR/$stamp" 2>/dev/null || echo "æ— æ³•è¯»å–æ–‡ä»¶"
                else
                  echo "  âš ï¸ $stamp ç¼ºå¤±ï¼Œç´§æ€¥åˆ›å»º..."
                  echo "Created before firmware build at $(date)" > "$STAMP_DIR/$stamp"
                fi
              done
            else
              echo "âš ï¸ stampç›®å½•ä¸å­˜åœ¨ï¼Œç´§æ€¥åˆ›å»º..."
              mkdir -p "$STAMP_DIR"
              echo "Created before firmware build at $(date)" > "$STAMP_DIR/.toolchain_compile"
              echo "Created before firmware build at $(date)" > "$STAMP_DIR/.binutils_installed"
            fi
            echo "ðŸ” æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶..."
            if [ -f "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" ]; then
              echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶å­˜åœ¨"
              echo "ç¼–è¯‘å™¨ä¿¡æ¯:"
              "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" --version 2>/dev/null | head -1 || echo "æ— æ³•èŽ·å–ç‰ˆæœ¬ä¿¡æ¯"
            else
              echo "âŒ ç¼–è¯‘å™¨æ–‡ä»¶ç¼ºå¤±ï¼Œä½¿ç”¨æ­¥éª¤27.9åˆ›å»ºçš„è„šæœ¬"
              if [ ! -f "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" ]; then
                echo "âš ï¸ ç¼–è¯‘å™¨æ–‡ä»¶ä»ç„¶ç¼ºå¤±ï¼Œåˆ›å»ºç´§æ€¥è„šæœ¬..."
                echo '#!/bin/bash' > "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '# ç´§æ€¥ç¼–è¯‘å™¨è„šæœ¬' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '# ç”¨äºŽç»§ç»­ç¼–è¯‘è¿‡ç¨‹' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo 'echo "Emergency compiler script called for: $0" > /tmp/emergency-compiler.log' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo 'echo "Arguments: $@" >> /tmp/emergency-compiler.log' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '# å¦‚æžœæ˜¯ç®€å•çš„æµ‹è¯•ç¼–è¯‘ï¼Œè¿”å›žæˆåŠŸ' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo 'if echo "$@" | grep -q "test-compile\|--version\|-v"; then' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '    echo "gcc (Emergency wrapper) 8.4.0"' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '    exit 0' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo 'fi' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '# å¦åˆ™ä½¿ç”¨ç³»ç»Ÿgcc' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo 'if command -v gcc >/dev/null 2>&1; then' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '    exec gcc "$@"' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo 'else' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '    echo "Error: No compiler available" >&2' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo '    exit 1' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo 'fi' >> "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                chmod +x "$TOOLCHAIN_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
                echo "âœ… å·²åˆ›å»ºç´§æ€¥ç¼–è¯‘å™¨è„šæœ¬"
              fi
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•ï¼Œä½¿ç”¨27.8æ­¥éª¤åˆ›å»ºçš„ç›®å½•"
            if [ -d "staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi" ]; then
              TOOLCHAIN_DIR="staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-8.4.0_musl_eabi"
              echo "âœ… ä½¿ç”¨é»˜è®¤å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
            fi
          fi
          if [ -n "$TOOLCHAIN_DIR" ]; then
            export PATH="$TOOLCHAIN_DIR/bin:$PATH"
            echo "ðŸ”§ æœ€ç»ˆPATHè®¾ç½®:"
            echo "$PATH" | tr ':' '\n' | head -10
          fi
          echo "ðŸš€ å¼€å§‹æœ€ç»ˆç¼–è¯‘..."
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh build_firmware "true"
      
      # æ­¥éª¤ 29: æœç´¢å¹¶æ‰“åŒ…æž„å»ºäº§ç‰©
      - name: "29. æœç´¢å¹¶æ‰“åŒ…æž„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 29: æœç´¢å¹¶æ‰“åŒ…æž„å»ºäº§ç‰© ==="
          cd ${{ env.BUILD_DIR }}
          mkdir -p /tmp/build-artifacts
          need_upload=false
          if [ -d "bin/targets" ]; then
            echo "æ‰“åŒ…å›ºä»¶æ–‡ä»¶..."
            tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
            firmware_size=$(stat -c%s /tmp/build-artifacts/firmware.tar.gz 2>/dev/null || echo "0")
            if [ $firmware_size -gt 0 ]; then
              echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆï¼Œå¤§å°: $(du -h /tmp/build-artifacts/firmware.tar.gz | cut -f1)"
              need_upload=true
            else
              echo "âš ï¸ å›ºä»¶æ‰“åŒ…å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            fi
          else
            echo "âš ï¸ bin/targetsç›®å½•ä¸å­˜åœ¨"
          fi
          if [ -f "build.log" ]; then
            echo "æ‰“åŒ…ç¼–è¯‘æ—¥å¿—..."
            cp build.log /tmp/build-artifacts/build.log
            echo "âœ… æ—¥å¿—æ‰“åŒ…å®Œæˆ"
            need_upload=true
          fi
          echo "æž„å»ºæ—¶é—´: $(date)" > /tmp/build-artifacts/build-info.txt
          echo "è®¾å¤‡: ${{ env.DEVICE }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/build-info.txt
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç¼–è¯‘å™¨ä¿®å¤: å·²åº”ç”¨-fpermissiveæ ‡å¿—å’Œå¤´æ–‡ä»¶ä¿®å¤" >> /tmp/build-artifacts/build-info.txt
          echo "GDBä¿®å¤: å·²ç¦ç”¨GDBå¹¶ä¿®å¤common-defs.h" >> /tmp/build-artifacts/build-info.txt
          echo "binutilsä¿®å¤: å·²è®¾ç½®ä¿®å¤ç¼–è¯‘çŽ¯å¢ƒ" >> /tmp/build-artifacts/build-info.txt
          echo "å·¥å…·é“¾ä¿®å¤: å·²ä¿®å¤stampç›®å½•å’Œæ ‡è®°æ–‡ä»¶" >> /tmp/build-artifacts/build-info.txt
          echo "ç¼–è¯‘å™¨æ¢å¤: å·²ä»Žä¿å­˜æ–‡ä»¶æ¢å¤æˆ–åˆ›å»ºç¼–è¯‘å™¨è„šæœ¬" >> /tmp/build-artifacts/build-info.txt
          if [ "${{ github.event.inputs.config_mode }}" = "base" ]; then
            echo "æ¨¡å¼è¯´æ˜Ž: ðŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºŽæµ‹è¯•ç¼–è¯‘" >> /tmp/build-artifacts/build-info.txt
          else
            echo "æ¨¡å¼è¯´æ˜Ž: ðŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®" >> /tmp/build-artifacts/build-info.txt
          fi
          if [ "$need_upload" = true ]; then
            echo "âœ… æž„å»ºäº§ç‰©å‡†å¤‡å®Œæˆ"
            echo "ðŸ“¤ æž„å»ºäº§ç‰©å·²ä¿å­˜åœ¨: /tmp/build-artifacts/"
            ls -lh /tmp/build-artifacts/
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„æž„å»ºäº§ç‰©"
          fi
      
      # æ­¥éª¤ 30: ä¸Šä¼ å›ºä»¶åŽŸå§‹ç›®å½•
      - name: "30. ä¸Šä¼ å›ºä»¶åŽŸå§‹ç›®å½•"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
      
      # æ­¥éª¤ 31: æ±‡æ€»å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨æ–‡ä»¶å¹¶æäº¤åˆ°ä»“åº“ç›®å½•
      - name: "31. æ±‡æ€»å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨æ–‡ä»¶å¹¶æäº¤åˆ°ä»“åº“ç›®å½•"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 31: æ±‡æ€»å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨æ–‡ä»¶å¹¶æäº¤åˆ°ä»“åº“ç›®å½• ==="
          echo "ðŸ” å¼€å§‹æ”¶é›†å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨æ–‡ä»¶..."
          COMPILER_SAVE_DIR="${{ github.workspace }}/firmware-config/build-Compiler-file/compiled"
          mkdir -p "$COMPILER_SAVE_DIR"
          echo "ç¼–è¯‘å™¨æ–‡ä»¶ä¿å­˜ç›®å½•: $COMPILER_SAVE_DIR"
          BUILD_DIR="${{ env.BUILD_DIR }}"
          echo "ðŸ“Š æœç´¢å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨æ–‡ä»¶..."
          find "$BUILD_DIR/staging_dir" -type f \( -name "*gcc*" -o -name "*g++*" -o -name "*as*" -o -name "*ld*" -o -name "*ar*" -o -name "*strip*" -o -name "*objcopy*" -o -name "*objdump*" -o -name "*nm*" -o -name "*ranlib*" \) 2>/dev/null | head -100 > /tmp/compiler_files.txt
          total_files=$(wc -l < /tmp/compiler_files.txt)
          echo "ðŸ“ˆ æ‰¾åˆ° $total_files ä¸ªç¼–è¯‘å™¨æ–‡ä»¶"
          if [ $total_files -eq 0 ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œè·³è¿‡ä¿å­˜"
            exit 0
          fi
          echo "ðŸ“ åˆ›å»ºåˆ†ç±»ç›®å½•..."
          mkdir -p "$COMPILER_SAVE_DIR/arm"
          mkdir -p "$COMPILER_SAVE_DIR/mips"
          mkdir -p "$COMPILER_SAVE_DIR/mipsel"
          mkdir -p "$COMPILER_SAVE_DIR/x86"
          mkdir -p "$COMPILER_SAVE_DIR/x86_64"
          mkdir -p "$COMPILER_SAVE_DIR/generic"
          echo "ðŸ“‹ åˆ†ç±»å¤åˆ¶ç¼–è¯‘å™¨æ–‡ä»¶..."
          arm_count=0
          mips_count=0
          mipsel_count=0
          x86_count=0
          x86_64_count=0
          generic_count=0
          while IFS= read -r file; do
            if [ -f "$file" ] && [ -x "$file" ]; then
              filename=$(basename "$file")
              if [[ "$filename" == *"arm"* ]] || [[ "$file" == *"arm"* ]]; then
                cp "$file" "$COMPILER_SAVE_DIR/arm/" 2>/dev/null && arm_count=$((arm_count + 1))
              elif [[ "$filename" == *"mips"* ]] && [[ "$filename" != *"mipsel"* ]]; then
                cp "$file" "$COMPILER_SAVE_DIR/mips/" 2>/dev/null && mips_count=$((mips_count + 1))
              elif [[ "$filename" == *"mipsel"* ]] || [[ "$file" == *"mipsel"* ]]; then
                cp "$file" "$COMPILER_SAVE_DIR/mipsel/" 2>/dev/null && mipsel_count=$((mipsel_count + 1))
              elif [[ "$filename" == *"i386"* ]] || [[ "$filename" == *"i686"* ]] || [[ "$file" == *"x86"* ]] && [[ "$file" != *"x86_64"* ]]; then
                cp "$file" "$COMPILER_SAVE_DIR/x86/" 2>/dev/null && x86_count=$((x86_count + 1))
              elif [[ "$filename" == *"x86_64"* ]] || [[ "$file" == *"x86_64"* ]]; then
                cp "$file" "$COMPILER_SAVE_DIR/x86_64/" 2>/dev/null && x86_64_count=$((x86_64_count + 1))
              else
                cp "$file" "$COMPILER_SAVE_DIR/generic/" 2>/dev/null && generic_count=$((generic_count + 1))
              fi
            fi
          done < /tmp/compiler_files.txt
          echo ""
          echo "ðŸ“Š ç¼–è¯‘å™¨æ–‡ä»¶åˆ†ç±»ç»Ÿè®¡:"
          echo "  ARMæž¶æž„: $arm_count ä¸ªæ–‡ä»¶"
          echo "  MIPSæž¶æž„: $mips_count ä¸ªæ–‡ä»¶"
          echo "  MIPSå°ç«¯: $mipsel_count ä¸ªæ–‡ä»¶"
          echo "  x86æž¶æž„: $x86_count ä¸ªæ–‡ä»¶"
          echo "  x86_64æž¶æž„: $x86_64_count ä¸ªæ–‡ä»¶"
          echo "  é€šç”¨ç¼–è¯‘å™¨: $generic_count ä¸ªæ–‡ä»¶"
          echo "  æ€»è®¡: $((arm_count + mips_count + mipsel_count + x86_count + x86_64_count + generic_count)) ä¸ªæ–‡ä»¶"
          echo ""
          echo "ðŸ“ å„ç›®å½•è¯¦ç»†å†…å®¹:"
          for arch_dir in arm mips mipsel x86 x86_64 generic; do
            dir_path="$COMPILER_SAVE_DIR/$arch_dir"
            if [ -d "$dir_path" ] && [ "$(ls -A "$dir_path" 2>/dev/null)" ]; then
              file_count=$(find "$dir_path" -type f | wc -l)
              echo "  $arch_dir ç›®å½• ($file_count ä¸ªæ–‡ä»¶):"
              ls "$dir_path" | head -5 | while read file; do
                size=$(stat -c%s "$dir_path/$file" 2>/dev/null || echo "0")
                size_kb=$((size / 1024))
                echo "    - $file (${size_kb}KB)"
              done
              if [ $file_count -gt 5 ]; then
                echo "    ... è¿˜æœ‰ $((file_count - 5)) ä¸ªæ–‡ä»¶"
              fi
            else
              echo "  $arch_dir ç›®å½•: ç©º"
            fi
          done
          echo ""
          echo "ðŸ“ åˆ›å»ºç¼–è¯‘å™¨ä¿¡æ¯æ–‡ä»¶..."
          echo "ç¼–è¯‘å™¨æ–‡ä»¶æ±‡æ€»ä¿¡æ¯" > "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "==================" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "æž„å»ºè®¾å¤‡: ${{ env.DEVICE }}" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "OpenWrtç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "ç¼–è¯‘å™¨ä¿®å¤: å·²åº”ç”¨å¤´æ–‡ä»¶å†²çªä¿®å¤" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "GDBä¿®å¤: å·²ä¿®å¤common-defs.hå’Œcommon-utils.c" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "binutilsä¿®å¤: å·²è®¾ç½®ä¿®å¤ç¼–è¯‘çŽ¯å¢ƒ" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "å·¥å…·é“¾ä¿®å¤: å·²ä¿®å¤stampç›®å½•å’Œæ ‡è®°æ–‡ä»¶" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "ç¼–è¯‘å™¨æ¢å¤: å·²ä»Žä¿å­˜æ–‡ä»¶æ¢å¤æˆ–åˆ›å»ºç¼–è¯‘å™¨è„šæœ¬" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "æ–‡ä»¶åˆ†ç±»ç»Ÿè®¡:" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "------------" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "ARMæž¶æž„: $arm_count ä¸ªæ–‡ä»¶" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "MIPSæž¶æž„: $mips_count ä¸ªæ–‡ä»¶" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "MIPSå°ç«¯: $mipsel_count ä¸ªæ–‡ä»¶" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "x86æž¶æž„: $x86_count ä¸ªæ–‡ä»¶" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "x86_64æž¶æž„: $x86_64_count ä¸ªæ–‡ä»¶" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "é€šç”¨ç¼–è¯‘å™¨: $generic_count ä¸ªæ–‡ä»¶" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          echo "æ€»è®¡: $((arm_count + mips_count + mipsel_count + x86_count + x86_64_count + generic_count)) ä¸ªæ–‡ä»¶" >> "$COMPILER_SAVE_DIR/compiler_info.txt"
          total_size=$(du -sh "$COMPILER_SAVE_DIR" 2>/dev/null | cut -f1)
          echo ""
          echo "ðŸ“¦ ç¼–è¯‘å™¨æ–‡ä»¶æ€»ç›®å½•å¤§å°: $total_size"
          echo "ðŸ“¦ åˆ›å»ºç¼–è¯‘å™¨æ–‡ä»¶åŽ‹ç¼©åŒ…..."
          cd "$COMPILER_SAVE_DIR"
          tar -czf "../compiled-compilers.tar.gz" ./*
          cd - > /dev/null
          echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶æ”¶é›†å®Œæˆ"
          echo "ðŸ“ ä¿å­˜ç›®å½•: $COMPILER_SAVE_DIR"
          echo "ðŸ“¦ åŽ‹ç¼©åŒ…: ${{ github.workspace }}/firmware-config/build-Compiler-file/compiled-compilers.tar.gz"
          echo "ðŸ”„ æäº¤ç¼–è¯‘å™¨æ–‡ä»¶åˆ°ä»“åº“ç›®å½•..."
          cd "${{ github.workspace }}"
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"
          git add firmware-config/build-Compiler-file/
          git status --porcelain firmware-config/build-Compiler-file/
          if git diff --cached --quiet -- firmware-config/build-Compiler-file/; then
            echo "â„¹ï¸ æ²¡æœ‰æ–°çš„ç¼–è¯‘å™¨æ–‡ä»¶éœ€è¦æäº¤"
          else
            echo "ðŸ“ æäº¤ç¼–è¯‘å™¨æ–‡ä»¶åˆ°ä»“åº“..."
            git commit -m "æ·»åŠ å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨æ–‡ä»¶" -m "è®¾å¤‡: ${{ env.DEVICE }}" -m "å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" -m "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}"
            echo "ðŸ”„ æŽ¨é€åˆ°ä»“åº“..."
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶å·²æäº¤åˆ°ä»“åº“ç›®å½•"
          fi
      
      # æ­¥éª¤ 32: ä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "32. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      # æ­¥éª¤ 33: ä¸Šä¼ ç¼–è¯‘å™¨æ–‡ä»¶åŽ‹ç¼©åŒ…
      - name: "33. ä¸Šä¼ ç¼–è¯‘å™¨æ–‡ä»¶åŽ‹ç¼©åŒ…"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: compiler-files-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}
          path: ${{ github.workspace }}/firmware-config/build-Compiler-file/compiled-compilers.tar.gz
          retention-days: 7
      
      # æ­¥éª¤ 34: é”™è¯¯åˆ†æžï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½è¿è¡Œï¼‰
      - name: "34. é”™è¯¯åˆ†æž"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 34: é”™è¯¯åˆ†æž ==="
          if [ -f "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh"
            "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh"
          else
            echo "âš ï¸ é”™è¯¯åˆ†æžè„šæœ¬ä¸å­˜åœ¨: ${{ github.workspace }}/firmware-config/scripts/error_analysis.sh"
          fi
      
      # æ­¥éª¤ 35: ç¼–è¯‘åŽç©ºé—´æ£€æŸ¥
      - name: "35. ç¼–è¯‘åŽç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 35: ç¼–è¯‘åŽç©ºé—´æ£€æŸ¥ ==="
          ${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh post_build_space_check
