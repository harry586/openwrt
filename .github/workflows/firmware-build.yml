name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'è®¾å¤‡åç§° (å¦‚: ac42uç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      config_mode:
        description: |
          é…ç½®æ¨¡å¼é€‰æ‹©ï¼š
          
          åŸºç¡€æ¨¡å¼ (æœ€å°åŒ–ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘)
          - æ–‡ä»¶ä¼ è¾“
          
          æ­£å¸¸æ¨¡å¼ (å®Œæ•´åŠŸèƒ½)
          - TurboACC ç½‘ç»œåŠ é€Ÿ
          - UPnP è‡ªåŠ¨ç«¯å£è½¬å‘
          - Samba æ–‡ä»¶å…±äº«
          - ç£ç›˜ç®¡ç†
          - KMS æ¿€æ´»æœåŠ¡
          - SmartDNS æ™ºèƒ½DNS
          - å®¶é•¿æ§åˆ¶
          - å¾®ä¿¡æ¨é€
          - æµé‡æ§åˆ¶ (SQM)
          - FTP æœåŠ¡å™¨
          - ARP ç»‘å®š
          - CPU é™åˆ¶
          - ç¡¬ç›˜ä¼‘çœ 
        required: true
        type: choice
        default: 'normal'
        options:
        - 'base'
        - 'normal'
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶ (ç”¨åˆ†å·;åˆ†éš”)
          
          å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶å
          ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶å
          
          ç¤ºä¾‹ï¼š
          +luci-app-wol;+luci-app-ddns;-luci-app-upnp
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'å¯ç”¨ç¼–è¯‘ç¼“å­˜'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo cmake
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"

    - name: ç‰ˆæœ¬é€‰æ‹©
      id: version-selection
      run: |
        cd $BUILD_DIR
        echo "=== ç‰ˆæœ¬é€‰æ‹© ==="
        if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            SELECTED_BRANCH="openwrt-23.05"
        else
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            SELECTED_BRANCH="openwrt-21.02"
        fi
        echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
        echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
        echo "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH"

    - name: å…‹éš†æºç 
      run: |
        cd $BUILD_DIR
        echo "=== å…‹éš†æºç  ==="
        echo "ä»“åº“: $SELECTED_REPO_URL"
        echo "åˆ†æ”¯: $SELECTED_BRANCH"
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
        echo "âœ… æºç å…‹éš†å®Œæˆ"

    - name: æ·»åŠ  TurboACC æ”¯æŒ
      run: |
        cd $BUILD_DIR
        echo "=== æ·»åŠ  TurboACC æ”¯æŒ ==="
        
        # ä¸º 23.05 ç‰ˆæœ¬æ·»åŠ  turboacc æ”¯æŒ
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            echo "ğŸ”§ ä¸º 23.05 æ·»åŠ  TurboACC æ”¯æŒ"
            
            # æ·»åŠ  turboacc çš„ feeds
            echo "src-git turboacc https://github.com/chenmozhijin/turboacc" >> feeds.conf.default
            
            echo "âœ… TurboACC feed æ·»åŠ å®Œæˆ"
        else
            echo "â„¹ï¸  21.02 ç‰ˆæœ¬å·²å†…ç½® TurboACCï¼Œæ— éœ€é¢å¤–æ·»åŠ "
        fi

    - name: è®¾å¤‡é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== è®¾å¤‡é…ç½® ==="
        case "${{ github.event.inputs.device_name }}" in
            "ac42u"|"acrh17")
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="asus_rt-ac42u"
                ;;
            "mi_router_4a_gigabit"|"r4ag")
                TARGET="ramips"
                SUBTARGET="mt76x8"
                DEVICE="xiaomi_mi-router-4a-gigabit"
                ;;
            "mi_router_3g"|"r3g")
                TARGET="ramips"
                SUBTARGET="mt7621"
                DEVICE="xiaomi_mi-router-3g"
                ;;
            *)
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="${{ github.event.inputs.device_name }}"
                ;;
        esac
        echo "TARGET=$TARGET" >> $GITHUB_ENV
        echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
        echo "DEVICE=$DEVICE" >> $GITHUB_ENV
        echo "ç›®æ ‡: $TARGET"
        echo "å­ç›®æ ‡: $SUBTARGET"
        echo "è®¾å¤‡: $DEVICE"

    - name: é…ç½®Feeds
      run: |
        cd $BUILD_DIR
        echo "=== é…ç½®Feeds ==="
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            FEEDS_BRANCH="openwrt-23.05"
        else
            FEEDS_BRANCH="openwrt-21.02"
        fi
        
        # ç¡®ä¿ feeds.conf.default åŒ…å«åŸºæœ¬ feeds
        echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
        echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
        
        # å¦‚æœæ˜¯ 23.05ï¼Œæ·»åŠ  turboacc feed
        if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            echo "src-git turboacc https://github.com/chenmozhijin/turboacc" >> feeds.conf.default
        fi
        
        # æ›´æ–°å’Œå®‰è£…æ‰€æœ‰ feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        echo "âœ… Feedsé…ç½®å®Œæˆ"

    - name: å®‰è£… TurboACC åŒ…
      if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
      run: |
        cd $BUILD_DIR
        echo "=== å®‰è£… TurboACC åŒ… ==="
        
        # æ›´æ–° turboacc feed
        ./scripts/feeds update turboacc
        
        # å®‰è£… turboacc ç›¸å…³åŒ…
        ./scripts/feeds install -p turboacc luci-app-turboacc
        ./scripts/feeds install -p turboacc kmod-shortcut-fe
        ./scripts/feeds install -p turboacc kmod-fast-classifier
        
        echo "âœ… TurboACC åŒ…å®‰è£…å®Œæˆ"

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿ ==="
        rm -f .config .config.old
        
        # åˆ›å»ºåŸºç¡€é…ç½®
        echo "CONFIG_TARGET_${TARGET}=y" > .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        
        # åŸºç¡€ç³»ç»Ÿç»„ä»¶
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_fstools=y" >> .config
        echo "CONFIG_PACKAGE_libc=y" >> .config
        echo "CONFIG_PACKAGE_libgcc=y" >> .config
        echo "CONFIG_PACKAGE_mtd=y" >> .config
        echo "CONFIG_PACKAGE_netifd=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_procd=y" >> .config
        echo "CONFIG_PACKAGE_ubox=y" >> .config
        echo "CONFIG_PACKAGE_ubus=y" >> .config
        echo "CONFIG_PACKAGE_ubusd=y" >> .config
        echo "CONFIG_PACKAGE_uci=y" >> .config
        echo "CONFIG_PACKAGE_uclient-fetch=y" >> .config
        echo "CONFIG_PACKAGE_usign=y" >> .config
        
        # DNSé…ç½®
        echo "# CONFIG_PACKAGE_dnsmasq is not set" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dhcp=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_dnssec=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_ipset=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_conntrack=y" >> .config
        
        # æ— çº¿é©±åŠ¨
        echo "# CONFIG_PACKAGE_kmod-ath10k is not set" >> .config
        echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
        echo "CONFIG_PACKAGE_ath10k-firmware-qca988x=y" >> .config
        echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
        
        # ç½‘ç»œå·¥å…·
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> .config
        echo "CONFIG_PACKAGE_ip6tables=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ip6tables=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-nat6=y" >> .config
        
        # ç‰ˆæœ¬æ™ºèƒ½æ£€æµ‹å’Œé…ç½®
        echo "=== ç‰ˆæœ¬æ™ºèƒ½æ£€æµ‹: $SELECTED_BRANCH ==="
        
        if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
            echo "ğŸ”§ æ£€æµ‹åˆ° 21.02 ç‰ˆæœ¬ï¼Œåº”ç”¨ç›¸åº”é…ç½®..."
            echo "# CONFIG_PACKAGE_kmod-fs-ntfs is not set" >> .config
            echo "# CONFIG_PACKAGE_ntfs-3g is not set" >> .config
            echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config
            echo "CONFIG_PACKAGE_automount=y" >> .config
            
        elif [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            echo "ğŸ”§ æ£€æµ‹åˆ° 23.05 ç‰ˆæœ¬ï¼Œåº”ç”¨ç›¸åº”é…ç½®..."
            echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config
            echo "# CONFIG_PACKAGE_kmod-fs-ntfs is not set" >> .config
            echo "# CONFIG_PACKAGE_ntfs-3g is not set" >> .config
        else
            echo "âš ï¸  æœªçŸ¥ç‰ˆæœ¬ï¼Œä½¿ç”¨é€šç”¨é…ç½®..."
            echo "# CONFIG_PACKAGE_kmod-fs-ntfs is not set" >> .config
            echo "# CONFIG_PACKAGE_ntfs-3g is not set" >> .config
        fi
        
        # é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
        echo "CONFIG_PACKAGE_block-mount=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        
        # æ ¹æ®é…ç½®æ¨¡å¼é€‰æ‹©æ’ä»¶
        echo "=== é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }} ==="
        
        if [ "${{ github.event.inputs.config_mode }}" = "base" ]; then
            echo "ğŸ”§ ä½¿ç”¨åŸºç¡€æ¨¡å¼ (æœ€å°åŒ–ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘)"
            # åŸºç¡€é…ç½®æ’ä»¶ - ä»…æ–‡ä»¶ä¼ è¾“
            BASE_PLUGINS=(
              "CONFIG_PACKAGE_luci-app-filetransfer=y"
            )
            
            for plugin in "${BASE_PLUGINS[@]}"; do
                echo "$plugin" >> .config
            done
            
            echo "âœ… åŸºç¡€æ¨¡å¼æ’ä»¶å·²å¯ç”¨"
            
        else
            echo "ğŸ”§ ä½¿ç”¨æ­£å¸¸æ¨¡å¼ (å®Œæ•´åŠŸèƒ½)"
            # æ­£å¸¸é…ç½®æ’ä»¶ - åŒ…å«æ‰€æœ‰åŠŸèƒ½
            NORMAL_PLUGINS=(
              "CONFIG_PACKAGE_luci-app-turboacc=y"
              "CONFIG_PACKAGE_kmod-shortcut-fe=y"
              "CONFIG_PACKAGE_kmod-fast-classifier=y"
              "CONFIG_PACKAGE_luci-app-upnp=y"
              "CONFIG_PACKAGE_miniupnpd=y"
              "CONFIG_PACKAGE_vsftpd=y"
              "CONFIG_PACKAGE_luci-app-vsftpd=y"
              "CONFIG_PACKAGE_luci-app-arpbind=y"
              "CONFIG_PACKAGE_luci-app-cpulimit=y"
              "CONFIG_PACKAGE_samba4-server=y"
              "CONFIG_PACKAGE_luci-app-samba4=y"
              "CONFIG_PACKAGE_luci-app-wechatpush=y"
              "CONFIG_PACKAGE_sqm-scripts=y"
              "CONFIG_PACKAGE_luci-app-sqm=y"
              "CONFIG_PACKAGE_luci-app-hd-idle=y"
              "CONFIG_PACKAGE_luci-app-filetransfer=y"
              "CONFIG_PACKAGE_luci-app-diskman=y"
              "CONFIG_PACKAGE_luci-app-accesscontrol=y"
              "CONFIG_PACKAGE_vlmcsd=y"
              "CONFIG_PACKAGE_luci-app-vlmcsd=y"
              "CONFIG_PACKAGE_smartdns=y"
              "CONFIG_PACKAGE_luci-app-smartdns=y"
            )
            
            for plugin in "${NORMAL_PLUGINS[@]}"; do
                echo "$plugin" >> .config
            done
            
            echo "âœ… æ­£å¸¸æ¨¡å¼æ’ä»¶å·²å¯ç”¨"
        fi
        
        # ç¦ç”¨ç½‘ç»œå”¤é†’
        echo "# CONFIG_PACKAGE_luci-app-wol is not set" >> .config
        echo "# CONFIG_PACKAGE_wol is not set" >> .config
        echo "# CONFIG_PACKAGE_etherwake is not set" >> .config
        
        # ç¦ç”¨ offloading æ’ä»¶
        echo "# CONFIG_PACKAGE_luci-app-software-offloading is not set" >> .config
        
        # æ˜ç¡®ç¦ç”¨ä¸éœ€è¦çš„æ’ä»¶
        echo "# æ˜ç¡®ç¦ç”¨ç½‘ç»œç›¸å…³æ’ä»¶" >> .config
        UNWANTED_PLUGINS=(
          "CONFIG_PACKAGE_luci-app-passwall"
          "CONFIG_PACKAGE_luci-app-ssr-plus"
          "CONFIG_PACKAGE_luci-app-vssr"
          "CONFIG_PACKAGE_luci-app-rclone"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Haproxy"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_ShadowsocksR_Libev_Client"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Client"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Server"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Simple_Obfs"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_SingBox"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Trojan_Plus"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Geoview"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Plugin"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-ng"
          "CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-webui"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ChinaDNS_NG"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_IPT2Socks"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ShadowsocksR_Libev_Client"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Client"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Server"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Simple_Obfs"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Trojan"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_ShadowsocksR_Libev_Server"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Trojan"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray_plugin"
        )
        
        for plugin in "${UNWANTED_PLUGINS[@]}"; do
            echo "# ${plugin} is not set" >> .config
        done
        
        # å¤„ç†é¢å¤–å®‰è£…æ’ä»¶
        if [ -n "${{ github.event.inputs.extra_packages }}" ]; then
            echo "ğŸ”§ å¤„ç†é¢å¤–å®‰è£…æ’ä»¶: ${{ github.event.inputs.extra_packages }}"
            
            # ä½¿ç”¨åˆ†å·åˆ†éš”è¾“å…¥
            IFS=';' read -ra EXTRA_PKGS <<< "${{ github.event.inputs.extra_packages }}"
            
            for pkg_cmd in "${EXTRA_PKGS[@]}"; do
                if [ -n "$pkg_cmd" ]; then
                    # å»é™¤å‰åç©ºæ ¼
                    pkg_cmd_clean=$(echo "$pkg_cmd" | xargs)
                    
                    # æ£€æŸ¥æ˜¯å¯ç”¨è¿˜æ˜¯ç¦ç”¨
                    if [[ "$pkg_cmd_clean" == +* ]]; then
                        # å¯ç”¨æ’ä»¶
                        pkg_name="${pkg_cmd_clean:1}"
                        echo "å¯ç”¨æ’ä»¶: $pkg_name"
                        echo "CONFIG_PACKAGE_${pkg_name}=y" >> .config
                    elif [[ "$pkg_cmd_clean" == -* ]]; then
                        # ç¦ç”¨æ’ä»¶
                        pkg_name="${pkg_cmd_clean:1}"
                        echo "ç¦ç”¨æ’ä»¶: $pkg_name"
                        echo "# CONFIG_PACKAGE_${pkg_name} is not set" >> .config
                    else
                        # é»˜è®¤å¯ç”¨
                        echo "å¯ç”¨æ’ä»¶: $pkg_cmd_clean"
                        echo "CONFIG_PACKAGE_${pkg_cmd_clean}=y" >> .config
                    fi
                fi
            done
            
            echo "âœ… é¢å¤–æ’ä»¶å¤„ç†å®Œæˆ"
        else
            echo "â„¹ï¸  æ— é¢å¤–å®‰è£…æ’ä»¶"
        fi
        
        echo "âœ… æ™ºèƒ½é…ç½®ç”Ÿæˆå®Œæˆ"
        
        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        echo "=== é…ç½®æ‘˜è¦ ==="
        echo "ç‰ˆæœ¬: $SELECTED_BRANCH"
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
        echo "ç›®æ ‡è®¾å¤‡: $DEVICE"
        echo "å¯ç”¨çš„åŒ…æ•°é‡: $(grep "^CONFIG_PACKAGE_.*=y$" .config | wc -l)"
        echo "å¯ç”¨çš„LUCIæ’ä»¶:"
        grep "^CONFIG_PACKAGE_luci" .config | grep "=y" | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//' | sort

    - name: åº”ç”¨é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== åº”ç”¨é…ç½® ==="
        make defconfig
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
        
        # åœ¨ defconfig ä¹‹åå¼ºåˆ¶ç¦ç”¨ä¸éœ€è¦çš„æ’ä»¶
        echo "=== å¼ºåˆ¶ç¦ç”¨ä¸éœ€è¦çš„æ’ä»¶ ==="
        
        # å®šä¹‰è¦ç¦ç”¨çš„é…ç½®é¡¹åˆ—è¡¨
        UNWANTED_CONFIGS=(
          "CONFIG_PACKAGE_luci-app-passwall"
          "CONFIG_PACKAGE_luci-app-ssr-plus"
          "CONFIG_PACKAGE_luci-app-vssr"
          "CONFIG_PACKAGE_luci-app-rclone"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Haproxy"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_ShadowsocksR_Libev_Client"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Client"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Server"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Simple_Obfs"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_SingBox"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Trojan_Plus"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Geoview"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Plugin"
          "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-ng"
          "CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-webui"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ChinaDNS_NG"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_IPT2Socks"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ShadowsocksR_Libev_Client"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Client"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Libev_Server"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Simple_Obfs"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Trojan"
          "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_ShadowsocksR_Libev_Server"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Trojan"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray"
          "CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray_plugin"
        )
        
        # å¼ºåˆ¶ç¦ç”¨æ¯ä¸ªé…ç½®é¡¹
        for config in "${UNWANTED_CONFIGS[@]}"; do
          # å¦‚æœé…ç½®é¡¹å­˜åœ¨ä¸”è¢«å¯ç”¨ï¼Œåˆ™ç¦ç”¨å®ƒ
          if grep -q "^${config}=y$" .config || grep -q "^${config}=m$" .config; then
            echo "ç¦ç”¨: $config"
            sed -i "s/^${config}=y$/# ${config} is not set/" .config
            sed -i "s/^${config}=m$/# ${config} is not set/" .config
          fi
        done
        
        echo "âœ… å¼ºåˆ¶ç¦ç”¨å®Œæˆ"
        
        # æ˜¾ç¤ºæœ€ç»ˆé…ç½®ä¿¡æ¯
        echo "=== æœ€ç»ˆé…ç½®çŠ¶æ€ ==="
        echo "å¯ç”¨çš„åŒ…æ•°é‡: $(grep "^CONFIG_PACKAGE_.*=y$" .config | wc -l)"
        echo "TurboACC çŠ¶æ€:"
        grep "turboacc\\|shortcut\\|fast-classifier" .config | grep "=y" || echo "TurboACC æœªå¯ç”¨"
        echo "å¯ç”¨çš„LUCIæ’ä»¶:"
        grep "^CONFIG_PACKAGE_luci" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//' | sort
        
        # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¸éœ€è¦çš„æ’ä»¶
        echo "=== æ£€æŸ¥ä¸éœ€è¦çš„æ’ä»¶çŠ¶æ€ ==="
        UNWANTED_PLUGINS=$(grep -E "passwall|ssr-plus|vssr|rclone" .config | grep "=y" || true)
        if [ -n "$UNWANTED_PLUGINS" ]; then
            echo "âŒ å‘ç°ä¸éœ€è¦çš„æ’ä»¶è¢«å¯ç”¨:"
            echo "$UNWANTED_PLUGINS"
        else
            echo "âœ… ä¸éœ€è¦çš„æ’ä»¶å·²æ­£ç¡®ç¦ç”¨"
        fi
        
        # å¤‡ä»½é…ç½®æ–‡ä»¶
        cp .config config_backup

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        cd $BUILD_DIR
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        export GIT_SSL_NO_VERIFY=1
        export PYTHONHTTPSVERIFY=0
        echo "âœ… ç½‘ç»œç¯å¢ƒä¿®å¤å®Œæˆ"

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd $BUILD_DIR
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        make -j1 download
        echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd $BUILD_DIR
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        if [ "${{ github.event.inputs.enable_cache }}" = "true" ]; then
            echo "å¯ç”¨ç¼–è¯‘ç¼“å­˜"
            make -j$(nproc) V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        else
            echo "æ™®é€šç¼–è¯‘æ¨¡å¼"
            make -j$(nproc) V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
        fi
        echo "ç¼–è¯‘é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
            if [ -f "build.log" ]; then
                echo "=== ç¼–è¯‘é”™è¯¯æ‘˜è¦ ==="
                grep -i "error:\|failed\|undefined" build.log | head -20
            fi
            exit $BUILD_EXIT_CODE
        fi
        echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"

    - name: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        if [ -d "bin/targets" ]; then
            echo "âœ… å›ºä»¶ç›®å½•å­˜åœ¨"
            find bin/targets -name "*.bin" -o -name "*.img" | while read file; do
                echo "å›ºä»¶æ–‡ä»¶: $file ($(du -h "$file" | cut -f1))"
            done
            echo "=== ç”Ÿæˆçš„å›ºä»¶åˆ—è¡¨ ==="
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec ls -la {} \;
        else
            echo "âŒ å›ºä»¶ç›®å½•ä¸å­˜åœ¨"
            exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/config_backup
        retention-days: 7

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•å·²æ¸…ç†"
