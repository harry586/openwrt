name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
          - '23.05'
          - '21.02'
      config_mode:
        description: 'âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© - ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ï¼šâœ… æ–‡ä»¶ä¼ è¾“ã€‚ ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ ã€‚'
        required: true
        type: choice
        default: 'normal'
        options:
          - 'base'
          - 'normal'
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šğŸ”´ç”¨é¡¿å·ã€åˆ†éš”ã€‚ğŸ”´ å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ğŸ”´ ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚ğŸ”´ ç¤ºä¾‹ï¼š+luci-app-wolã€+luci-app-ddns'
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)'
        required: false
        default: true
        type: boolean
      rebuild_toolchain:
        description: 'ğŸ”„ å¼ºåˆ¶é‡æ–°æ„å»ºå·¥å…·é“¾'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'ğŸ› å¯ç”¨è°ƒè¯•æ¨¡å¼ (æ˜¾ç¤ºæ›´å¤šè¯¦ç»†ä¿¡æ¯)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  TOOLCHAIN_DIR: /mnt/openwrt-toolchain
  DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
  SCRIPT_PATH: ./firmware-config/scripts/build_firmware_main.sh

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: æ˜¾ç¤ºå·¥ä½œç©ºé—´ä¿¡æ¯
      run: |
        echo "=== å·¥ä½œç©ºé—´ä¿¡æ¯ ==="
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "ç”¨æˆ·: $(whoami)"
        echo "ä¸»æœºå: $(hostname)"
        echo "GitHubå·¥ä½œåŒº: $GITHUB_WORKSPACE"
        echo ""
        echo "ç›®å½•ç»“æ„:"
        ls -la
        echo ""
        echo "è„šæœ¬ç›®å½•:"
        ls -la firmware-config/scripts/ 2>/dev/null || echo "scriptsç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•:"
        ls -la firmware-config/custom-files/ 2>/dev/null || echo "custom-filesç›®å½•ä¸å­˜åœ¨"

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        echo "è®¾ç½®æ‰€æœ‰.shæ–‡ä»¶å¯æ‰§è¡Œæƒé™..."
        find . -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null || true
        echo "æƒé™è®¾ç½®å®Œæˆ:"
        ls -la firmware-config/scripts/*.sh 2>/dev/null | head -10

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo ""
        echo "/mnt åˆ†åŒºè¯¦æƒ…:"
        df -h /mnt
        echo ""
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "ğŸ“Š /mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 30 ]; then
          echo "âš ï¸ è­¦å‘Š: /mnt ç©ºé—´ä¸è¶³30Gï¼Œå¯èƒ½ç¼–è¯‘å¤±è´¥"
        else
          echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
        fi

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        INSTALL_LOG="/tmp/install_deps_$(date +%Y%m%d_%H%M%S).log"
        echo "å®‰è£…æ—¥å¿—: $INSTALL_LOG"
        echo "1. æ›´æ–°åŒ…åˆ—è¡¨..."
        sudo apt-get update 2>&1 | tee $INSTALL_LOG
        echo ""
        echo "2. å®‰è£…ç¼–è¯‘OpenWrtæ‰€éœ€çš„æ‰€æœ‰ä¾èµ–åŒ…..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo cmake jq ccache u-boot-tools gperf nodejs npm swig time xsltproc libxml2-utils 2>&1 | tee -a $INSTALL_LOG
        echo ""
        echo "3. æ£€æŸ¥å…³é”®å·¥å…·å®‰è£…æƒ…å†µ:"
        echo "gcc: $(gcc --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "g++: $(g++ --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "make: $(make --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "cmake: $(cmake --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "git: $(git --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "python3: $(python3 --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "ccache: $(ccache --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        echo "åˆ›å»ºç›®å½•: $BUILD_DIR"
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        echo "ç›®å½•æƒé™è®¾ç½®å®Œæˆ:"
        ls -ld $BUILD_DIR

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      id: init_env
      run: |
        echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
        echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
        echo ""
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "è„šæœ¬è·¯å¾„: $SCRIPT_PATH"
        echo "è„šæœ¬æ˜¯å¦å­˜åœ¨: $(test -f "$SCRIPT_PATH" && echo "âœ… å­˜åœ¨" || echo "âŒ ä¸å­˜åœ¨")"
        
        # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
        chmod +x "$SCRIPT_PATH" 2>/dev/null || true
        
        # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
        if [ -f "$SCRIPT_PATH" ]; then
          echo "æ‰§è¡Œè„šæœ¬: $SCRIPT_PATH initialize_build_env"
          $SCRIPT_PATH initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
        else
          echo "âŒ é”™è¯¯: è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $SCRIPT_PATH"
          echo "æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶:"
          find . -name "*.sh" -type f 2>/dev/null
          exit 1
        fi

    - name: åˆ›å»ºç¯å¢ƒæ–‡ä»¶ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
      id: create_env_backup
      run: |
        echo "=== åˆ›å»ºç¯å¢ƒæ–‡ä»¶ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰ ==="
        echo "æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨: $BUILD_DIR/build_env.sh"
        
        # å¦‚æœç¯å¢ƒæ–‡ä»¶å·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨
        if [ -f "$BUILD_DIR/build_env.sh" ]; then
          echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²å­˜åœ¨ï¼ŒåŠ è½½ç°æœ‰ç¯å¢ƒå˜é‡"
          source $BUILD_DIR/build_env.sh
          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_OUTPUT
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_OUTPUT
          echo "DEVICE=$DEVICE" >> $GITHUB_OUTPUT
          echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
          exit 0
        fi
        
        echo "ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¤‡ç”¨ç¯å¢ƒæ–‡ä»¶..."
        
        DEVICE_NAME="${{ github.event.inputs.device_name }}"
        VERSION="${{ github.event.inputs.version_selection }}"
        CONFIG_MODE="${{ github.event.inputs.config_mode }}"
        
        # è®¾ç½®åˆ†æ”¯
        if [ "$VERSION" = "23.05" ]; then
            SELECTED_BRANCH="openwrt-23.05"
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        else
            SELECTED_BRANCH="openwrt-21.02"
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
        fi
        
        # è®¾ç½®ç›®æ ‡å¹³å°
        case "$DEVICE_NAME" in
            "ac42u"|"acrh17")
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="asus_rt-ac42u"
                ;;
            "mi_router_4a_gigabit"|"r4ag")
                TARGET="ramips"
                SUBTARGET="mt76x8"
                DEVICE="xiaomi_mi-router-4a-gigabit"
                ;;
            "mi_router_3g"|"r3g")
                TARGET="ramips"
                SUBTARGET="mt7621"
                DEVICE="xiaomi_mi-router-3g"
                ;;
            *)
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="$DEVICE_NAME"
                ;;
        esac
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        
        # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
        echo "åˆ›å»ºç¯å¢ƒæ–‡ä»¶: $BUILD_DIR/build_env.sh"
        cat > $BUILD_DIR/build_env.sh << 'EOF'
#!/bin/bash
export SELECTED_REPO_URL="$SELECTED_REPO_URL"
export SELECTED_BRANCH="$SELECTED_BRANCH"
export TARGET="$TARGET"
export SUBTARGET="$SUBTARGET"
export DEVICE="$DEVICE"
export CONFIG_MODE="$CONFIG_MODE"
EOF
        
        # æ›¿æ¢å˜é‡å€¼
        sed -i "s|\\\$SELECTED_REPO_URL|$SELECTED_REPO_URL|g" $BUILD_DIR/build_env.sh
        sed -i "s|\\\$SELECTED_BRANCH|$SELECTED_BRANCH|g" $BUILD_DIR/build_env.sh
        sed -i "s|\\\$TARGET|$TARGET|g" $BUILD_DIR/build_env.sh
        sed -i "s|\\\$SUBTARGET|$SUBTARGET|g" $BUILD_DIR/build_env.sh
        sed -i "s|\\\$DEVICE|$DEVICE|g" $BUILD_DIR/build_env.sh
        sed -i "s|\\\$CONFIG_MODE|$CONFIG_MODE|g" $BUILD_DIR/build_env.sh
        
        chmod +x $BUILD_DIR/build_env.sh
        
        echo "âœ… å¤‡ç”¨ç¯å¢ƒæ–‡ä»¶åˆ›å»ºå®Œæˆ:"
        cat $BUILD_DIR/build_env.sh
        
        # å¯¼å‡ºåˆ°GitHubè¾“å‡º
        echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
        echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_OUTPUT
        echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
        echo "SUBTARGET=$SUBTARGET" >> $GITHUB_OUTPUT
        echo "DEVICE=$DEVICE" >> $GITHUB_OUTPUT
        echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV

    - name: åˆå§‹åŒ–å·¥å…·é“¾ç³»ç»Ÿ
      run: |
        echo "=== åˆå§‹åŒ–å·¥å…·é“¾ç³»ç»Ÿ ==="
        echo "åˆ›å»ºå·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
        sudo mkdir -p $TOOLCHAIN_DIR
        sudo chown -R $USER:$USER $TOOLCHAIN_DIR
        sudo chmod -R 755 $TOOLCHAIN_DIR
        TOOLCHAIN_DB="$TOOLCHAIN_DIR/toolchain_db.json"
        echo "åˆ›å»ºå·¥å…·é“¾æ•°æ®åº“: $TOOLCHAIN_DB"
        echo '{' > $TOOLCHAIN_DB
        echo '  "version": "1.0.0",' >> $TOOLCHAIN_DB
        echo '  "toolchains": {},' >> $TOOLCHAIN_DB
        echo '  "statistics": {' >> $TOOLCHAIN_DB
        echo '    "total_builds": 0,' >> $TOOLCHAIN_DB
        echo '    "cache_hits": 0,' >> $TOOLCHAIN_DB
        echo '    "cache_misses": 0' >> $TOOLCHAIN_DB
        echo '  },' >> $TOOLCHAIN_DB
        echo '  "last_updated": "'$(date -I)'"' >> $TOOLCHAIN_DB
        echo '}' >> $TOOLCHAIN_DB
        echo "âœ… å·¥å…·é“¾ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"
        echo "å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"

    - name: æ£€æŸ¥å·¥å…·é“¾ç¼“å­˜
      id: check_toolchain
      run: |
        echo "=== æ£€æŸ¥å·¥å…·é“¾ç¼“å­˜ ==="
        
        # åŠ è½½ç¯å¢ƒå˜é‡
        if [ -f "$BUILD_DIR/build_env.sh" ]; then
          echo "âœ… ä»ç¯å¢ƒæ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡"
          source $BUILD_DIR/build_env.sh
        else
          echo "âŒ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä»GitHubè¾“å‡ºè·å–"
          SELECTED_BRANCH="${{ steps.create_env_backup.outputs.SELECTED_BRANCH }}"
          TARGET="${{ steps.create_env_backup.outputs.TARGET }}"
          SUBTARGET="${{ steps.create_env_backup.outputs.SUBTARGET }}"
          DEVICE="${{ steps.create_env_backup.outputs.DEVICE }}"
        fi
        
        echo "ç¯å¢ƒå˜é‡:"
        echo "  SELECTED_BRANCH=$SELECTED_BRANCH"
        echo "  TARGET=$TARGET"
        echo "  SUBTARGET=$SUBTARGET"
        echo "  DEVICE=$DEVICE"
        
        TOOLCHAIN_KEY="$SELECTED_BRANCH-$TARGET-$SUBTARGET"
        TOOLCHAIN_PATH="$TOOLCHAIN_DIR/$TOOLCHAIN_KEY"
        
        echo "ğŸ”‘ å·¥å…·é“¾é”®å€¼: $TOOLCHAIN_KEY"
        echo "ğŸ“ å·¥å…·é“¾è·¯å¾„: $TOOLCHAIN_PATH"
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶é‡å»º
        if [ "${{ github.event.inputs.rebuild_toolchain }}" = "true" ]; then
          echo "ğŸ”„ å¼ºåˆ¶é‡å»ºå·¥å…·é“¾"
          echo "TOOLCHAIN_EXISTS=false" >> $GITHUB_OUTPUT
          echo "FORCE_REBUILD=true" >> $GITHUB_OUTPUT
        elif [ -d "$TOOLCHAIN_PATH" ] && [ -f "$TOOLCHAIN_PATH/toolchain_info.txt" ]; then
          echo "âœ… å·¥å…·é“¾ç¼“å­˜å­˜åœ¨"
          echo "TOOLCHAIN_EXISTS=true" >> $GITHUB_OUTPUT
          echo "FORCE_REBUILD=false" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ç¼“å­˜ä¿¡æ¯:"
          echo "  å¤§å°: $(du -sh $TOOLCHAIN_PATH | cut -f1)"
          echo "  åˆ›å»ºæ—¶é—´: $(cat $TOOLCHAIN_PATH/toolchain_info.txt 2>/dev/null | head -1 || echo 'æœªçŸ¥')"
          echo "  ç¼–è¯‘å™¨: $(find $TOOLCHAIN_PATH -name '*-gcc' -type f | head -1 | xargs basename 2>/dev/null || echo 'æœªçŸ¥')"
        else
          echo "ğŸ”„ å·¥å…·é“¾ç¼“å­˜ä¸å­˜åœ¨"
          echo "TOOLCHAIN_EXISTS=false" >> $GITHUB_OUTPUT
          echo "FORCE_REBUILD=false" >> $GITHUB_OUTPUT
        fi

    - name: æ„å»ºå·¥å…·é“¾ï¼ˆå¦‚éœ€ï¼‰
      if: steps.check_toolchain.outputs.TOOLCHAIN_EXISTS == 'false'
      run: |
        echo "=== æ„å»ºå·¥å…·é“¾ ==="
        
        # åŠ è½½ç¯å¢ƒå˜é‡
        if [ -f "$BUILD_DIR/build_env.sh" ]; then
          source $BUILD_DIR/build_env.sh
        else
          echo "âŒ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¤‡ç”¨å€¼"
          SELECTED_BRANCH="${{ steps.create_env_backup.outputs.SELECTED_BRANCH }}"
          TARGET="${{ steps.create_env_backup.outputs.TARGET }}"
          SUBTARGET="${{ steps.create_env_backup.outputs.SUBTARGET }}"
          DEVICE="${{ steps.create_env_backup.outputs.DEVICE }}"
          CONFIG_MODE="${{ steps.create_env_backup.outputs.CONFIG_MODE }}"
        fi
        
        echo "è¿›å…¥æ„å»ºç›®å½•: $BUILD_DIR"
        cd $BUILD_DIR
        
        TOOLCHAIN_KEY="$SELECTED_BRANCH-$TARGET-$SUBTARGET"
        TOOLCHAIN_PATH="$TOOLCHAIN_DIR/$TOOLCHAIN_KEY"
        
        echo "ğŸ”‘ å·¥å…·é“¾é”®å€¼: $TOOLCHAIN_KEY"
        echo "ğŸ’¾ ä¿å­˜è·¯å¾„: $TOOLCHAIN_PATH"
        
        # æ¸…ç†æ—§ç›®å½•
        rm -rf $TOOLCHAIN_PATH
        mkdir -p $TOOLCHAIN_PATH
        
        echo "ğŸ“ åˆ›å»ºå·¥å…·é“¾é…ç½®..."
        echo "CONFIG_TARGET_${TARGET}=y" > .config.toolchain
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config.toolchain
        echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config.toolchain
        echo "CONFIG_TOOLCHAIN=y" >> .config.toolchain
        echo "CONFIG_TOOLCHAIN_BUILD=y" >> .config.toolchain
        echo "CONFIG_SDK=y" >> .config.toolchain
        echo "CONFIG_IB=y" >> .config.toolchain
        echo "CONFIG_KERNEL_KALLSYMS=n" >> .config.toolchain
        echo "CONFIG_KERNEL_DEBUG_INFO=n" >> .config.toolchain
        echo "CONFIG_KERNEL_DEBUG_KERNEL=n" >> .config.toolchain
        echo "CONFIG_BUILD_PATENTED=y" >> .config.toolchain
        
        echo "åº”ç”¨å·¥å…·é“¾é…ç½®..."
        cp .config.toolchain .config
        make defconfig
        
        echo "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
        TOOLCHAIN_LOG="$TOOLCHAIN_PATH/build.log"
        
        # ç¼–è¯‘å·¥å…·é“¾ï¼ˆä½¿ç”¨2ä¸ªæ ¸å¿ƒé¿å…èµ„æºç«äº‰ï¼‰
        make toolchain/install -j2 V=s 2>&1 | tee $TOOLCHAIN_LOG
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
          echo "ğŸ’¾ ä¿å­˜å·¥å…·é“¾æ–‡ä»¶..."
          if [ -d "staging_dir" ]; then
            cp -r staging_dir/* $TOOLCHAIN_PATH/ 2>/dev/null || true
            echo "å·¥å…·é“¾ä¿¡æ¯:" > $TOOLCHAIN_PATH/toolchain_info.txt
            echo "ç‰ˆæœ¬: $SELECTED_BRANCH" >> $TOOLCHAIN_PATH/toolchain_info.txt
            echo "ç›®æ ‡: $TARGET-$SUBTARGET" >> $TOOLCHAIN_PATH/toolchain_info.txt
            echo "è®¾å¤‡: $DEVICE" >> $TOOLCHAIN_PATH/toolchain_info.txt
            echo "ç¼–è¯‘æ—¶é—´: $(date)" >> $TOOLCHAIN_PATH/toolchain_info.txt
            echo "å¤§å°: $(du -sh $TOOLCHAIN_PATH | cut -f1)" >> $TOOLCHAIN_PATH/toolchain_info.txt
            echo "ğŸ“Š å·¥å…·é“¾ä¿å­˜å®Œæˆ:"
            echo "  è·¯å¾„: $TOOLCHAIN_PATH"
            echo "  å¤§å°: $(du -sh $TOOLCHAIN_PATH | cut -f1)"
            echo "  ç¼–è¯‘å™¨: $(find $TOOLCHAIN_PATH -name '*-gcc' -type f | head -1 | xargs basename 2>/dev/null || echo 'æœªçŸ¥')"
          fi
          
          # æ›´æ–°æ•°æ®åº“
          TOOLCHAIN_DB="$TOOLCHAIN_DIR/toolchain_db.json"
          if [ -f "$TOOLCHAIN_DB" ] && command -v jq >/dev/null 2>&1; then
            jq --arg key "$TOOLCHAIN_KEY" --arg date "$(date -I)" --arg size "$(du -sh $TOOLCHAIN_PATH | cut -f1)" '.toolchains[$key] = { "created": $date, "size": $size, "target": "'$TARGET'", "subtarget": "'$SUBTARGET'", "version": "'$SELECTED_BRANCH'" } | .last_updated = $date | .statistics.total_builds += 1 | .statistics.cache_misses += 1' $TOOLCHAIN_DB > $TOOLCHAIN_DB.tmp && mv $TOOLCHAIN_DB.tmp $TOOLCHAIN_DB
            echo "ğŸ“ˆ å·¥å…·é“¾æ•°æ®åº“å·²æ›´æ–°"
          fi
        else
          echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
          echo "ğŸ“„ æŸ¥çœ‹æ—¥å¿—: $TOOLCHAIN_LOG"
          echo "æœ€å50è¡Œæ—¥å¿—:"
          tail -50 $TOOLCHAIN_LOG
          exit 1
        fi

    - name: æ¢å¤å·¥å…·é“¾ï¼ˆå¦‚å·²ç¼“å­˜ï¼‰
      if: steps.check_toolchain.outputs.TOOLCHAIN_EXISTS == 'true'
      run: |
        echo "=== æ¢å¤å·¥å…·é“¾ ==="
        
        # åŠ è½½ç¯å¢ƒå˜é‡
        if [ -f "$BUILD_DIR/build_env.sh" ]; then
          source $BUILD_DIR/build_env.sh
        else
          SELECTED_BRANCH="${{ steps.create_env_backup.outputs.SELECTED_BRANCH }}"
          TARGET="${{ steps.create_env_backup.outputs.TARGET }}"
          SUBTARGET="${{ steps.create_env_backup.outputs.SUBTARGET }}"
        fi
        
        TOOLCHAIN_KEY="$SELECTED_BRANCH-$TARGET-$SUBTARGET"
        TOOLCHAIN_PATH="$TOOLCHAIN_DIR/$TOOLCHAIN_KEY"
        
        echo "ğŸ”‘ å·¥å…·é“¾é”®å€¼: $TOOLCHAIN_KEY"
        echo "ğŸ“ ä»ç¼“å­˜æ¢å¤: $TOOLCHAIN_PATH"
        
        if [ -d "$TOOLCHAIN_PATH" ]; then
          echo "å¤åˆ¶å·¥å…·é“¾åˆ°æ„å»ºç›®å½•..."
          mkdir -p $BUILD_DIR/staging_dir
          cp -r $TOOLCHAIN_PATH/* $BUILD_DIR/staging_dir/ 2>/dev/null || true
          echo "âœ… å·¥å…·é“¾æ¢å¤å®Œæˆ"
          echo "ğŸ“Š æ¢å¤çš„å·¥å…·é“¾å†…å®¹:"
          find $BUILD_DIR/staging_dir -name "*-gcc" -type f | head -3 | while read file; do
            echo "  ğŸ”§ $(basename $file)"
          done
          
          # æ›´æ–°æ•°æ®åº“ç»Ÿè®¡
          TOOLCHAIN_DB="$TOOLCHAIN_DIR/toolchain_db.json"
          if [ -f "$TOOLCHAIN_DB" ] && command -v jq >/dev/null 2>&1; then
            jq '.statistics.cache_hits += 1' $TOOLCHAIN_DB > $TOOLCHAIN_DB.tmp && mv $TOOLCHAIN_DB.tmp $TOOLCHAIN_DB
            echo "ğŸ“ˆ ç¼“å­˜å‘½ä¸­æ¬¡æ•°æ›´æ–°"
          fi
        else
          echo "âŒ å·¥å…·é“¾ç¼“å­˜ä¸å­˜åœ¨ï¼Œæ— æ³•æ¢å¤"
          exit 1
        fi

    - name: é…ç½®Feeds
      run: |
        echo "=== é…ç½®Feeds ==="
        cd $BUILD_DIR
        
        # å°è¯•ä½¿ç”¨è„šæœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™æ‰‹åŠ¨é…ç½®
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH configure_feeds
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨é…ç½®Feeds"
          
          # ä»ç¯å¢ƒæ–‡ä»¶è·å–åˆ†æ”¯
          if [ -f "build_env.sh" ]; then
            source build_env.sh
          fi
          
          if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            FEEDS_BRANCH="openwrt-23.05"
          else
            FEEDS_BRANCH="openwrt-21.02"
          fi
          
          echo "é…ç½®feeds.conf.default"
          cat > feeds.conf.default << EOF
src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH
src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH
EOF
          
          ./scripts/feeds update -a
          ./scripts/feeds install -a
        fi

    - name: æ·»åŠ TurboACCæ”¯æŒ
      if: github.event.inputs.config_mode == 'normal' && steps.create_env_backup.outputs.SELECTED_BRANCH == 'openwrt-23.05'
      run: |
        echo "=== æ·»åŠ TurboACCæ”¯æŒ ==="
        cd $BUILD_DIR
        
        # å°è¯•ä½¿ç”¨è„šæœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™è·³è¿‡
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH add_turboacc_support
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ TurboACCæ”¯æŒ"
        fi

    - name: å®‰è£…æ’ä»¶åŒ…
      run: |
        echo "=== å®‰è£…æ’ä»¶åŒ… ==="
        cd $BUILD_DIR
        
        echo "1. å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶åŒ…:"
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH install_filetransfer_packages
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶"
          ./scripts/feeds update luci
          ./scripts/feeds install -p luci luci-app-filetransfer 2>/dev/null || true
        fi
        
        if [ "${{ github.event.inputs.config_mode }}" = "normal" ] && [ "${{ steps.create_env_backup.outputs.SELECTED_BRANCH }}" = "openwrt-23.05" ]; then
          echo ""
          echo "2. å®‰è£…TurboACCåŒ…:"
          if [ -f "$SCRIPT_PATH" ]; then
            $SCRIPT_PATH install_turboacc_packages
          else
            echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…TurboACCåŒ…"
          fi
        fi

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
        df -h
        echo ""
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "ğŸ“Š /mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        
        if [ -d "$TOOLCHAIN_DIR" ]; then
          echo ""
          echo "ğŸ“¦ å·¥å…·é“¾ç¼“å­˜å¤§å°:"
          du -sh $TOOLCHAIN_DIR
        fi

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      run: |
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
        cd $BUILD_DIR
        
        echo "ç”Ÿæˆé…ç½®ï¼Œé¢å¤–æ’ä»¶: ${{ github.event.inputs.extra_packages }}"
        
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH generate_config "${{ github.event.inputs.extra_packages }}"
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨ç”ŸæˆåŸºç¡€é…ç½®"
          
          # ä»ç¯å¢ƒæ–‡ä»¶è·å–å˜é‡
          if [ -f "build_env.sh" ]; then
            source build_env.sh
          fi
          
          echo "CONFIG_TARGET_${TARGET}=y" > .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
        fi
        
        echo ""
        echo "ğŸ“‹ ç”Ÿæˆçš„é…ç½®æ‘˜è¦:"
        if [ -f ".config" ]; then
          echo "âœ… å¯ç”¨åŒ…æ•°é‡: $(grep "^CONFIG_PACKAGE_.*=y$" .config 2>/dev/null | wc -l)"
          echo "âŒ ç¦ç”¨åŒ…æ•°é‡: $(grep "^# CONFIG_PACKAGE_.* is not set$" .config 2>/dev/null | wc -l)"
          
          if [ "$DEBUG_MODE" = "true" ]; then
            echo ""
            echo "=== å¯ç”¨çš„æ’ä»¶åˆ—è¡¨ ==="
            grep "^CONFIG_PACKAGE_luci-app-.*=y$" .config 2>/dev/null | sed 's/CONFIG_PACKAGE_//;s/=y//' | head -20
          fi
        else
          echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        fi

    - name: éªŒè¯USBé…ç½®
      run: |
        echo "=== éªŒè¯USBé…ç½® ==="
        cd $BUILD_DIR
        
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH verify_usb_config
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡USBé…ç½®éªŒè¯"
        fi

    - name: åº”ç”¨é…ç½®
      run: |
        echo "=== åº”ç”¨é…ç½® ==="
        cd $BUILD_DIR
        
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH apply_config
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨åº”ç”¨é…ç½®"
          make defconfig || echo "åº”ç”¨é…ç½®å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
        fi

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        cd $BUILD_DIR
        
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH fix_network
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨ä¿®å¤ç½‘ç»œç¯å¢ƒ"
          git config --global http.postBuffer 524288000
          export GIT_SSL_NO_VERIFY=1
        fi

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        cd $BUILD_DIR
        
        echo "å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…..."
        
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH download_dependencies
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨ä¸‹è½½ä¾èµ–åŒ…"
          for i in {1..3}; do
            echo "ç¬¬ $i æ¬¡å°è¯•ä¸‹è½½ä¾èµ–åŒ…..."
            if make -j1 download V=s; then
              echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"
              break
            else
              echo "âš ï¸ ç¬¬ $i æ¬¡ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
              sleep 10
            fi
          done
        fi
        
        echo ""
        echo "ğŸ“¦ ä¸‹è½½ç›®å½•å†…å®¹:"
        ls -la dl/ 2>/dev/null | head -5 || echo "ä¸‹è½½ç›®å½•ä¸ºç©º"

    - name: å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶ï¼ˆä¿®å¤ç‰ˆï¼‰
      run: |
        echo "=== å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶ ==="
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo ""
        
        # è¯¦ç»†æ£€æŸ¥ç›®å½•ç»“æ„
        echo "=== ç›®å½•ç»“æ„æ£€æŸ¥ ==="
        echo "1. æ£€æŸ¥å½“å‰ç›®å½•:"
        ls -la
        
        echo ""
        echo "2. æ£€æŸ¥ firmware-config ç›®å½•:"
        if [ -d "firmware-config" ]; then
          echo "âœ… firmware-config ç›®å½•å­˜åœ¨"
          ls -la firmware-config/
          
          echo ""
          echo "3. æ£€æŸ¥ custom-files ç›®å½•:"
          if [ -d "firmware-config/custom-files" ]; then
            echo "âœ… firmware-config/custom-files ç›®å½•å­˜åœ¨"
            echo "ç›®å½•å†…å®¹:"
            ls -la firmware-config/custom-files/
            
            echo ""
            echo "4. æŸ¥æ‰¾æ‰€æœ‰è‡ªå®šä¹‰æ–‡ä»¶:"
            find firmware-config/custom-files -type f | while read file; do
              echo "ğŸ“„ $file"
            done
          else
            echo "âŒ firmware-config/custom-files ç›®å½•ä¸å­˜åœ¨"
            echo "å°è¯•æŸ¥æ‰¾å…¶ä»–ä½ç½®..."
            find . -name "custom-files" -type d 2>/dev/null | head -5
          fi
        else
          echo "âŒ firmware-config ç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "=== å¼€å§‹å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶ ==="
        cd $BUILD_DIR
        
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH process_custom_files
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶"
        fi

    - name: ç¼–è¯‘å›ºä»¶
      id: build_firmware
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        cd $BUILD_DIR
        
        echo "ç¼–è¯‘å‚æ•°:"
        echo "  ç¼“å­˜æ¨¡å¼: ${{ github.event.inputs.enable_cache }}"
        echo "  CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "  è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug_mode }}"
        echo ""
        
        # è®°å½•å¼€å§‹æ—¶é—´
        START_TIME=$(date +%s)
        echo "â° ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        
        # æ‰§è¡Œç¼–è¯‘
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH build_firmware "${{ github.event.inputs.enable_cache }}"
          BUILD_EXIT_CODE=$?
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨ç¼–è¯‘"
          num_cores=$(nproc)
          build_jobs=$((num_cores))
          
          if [ "${{ github.event.inputs.enable_cache }}" = "true" ]; then
            echo "å¯ç”¨ç¼–è¯‘ç¼“å­˜ (ä½¿ç”¨ $build_jobs çº¿ç¨‹)"
            export CCACHE_DIR="/tmp/ccache_openwrt"
            export CCACHE_MAXSIZE="10G"
            mkdir -p $CCACHE_DIR
            make -j$build_jobs V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
          else
            echo "æ™®é€šç¼–è¯‘æ¨¡å¼ (ä½¿ç”¨ $build_jobs çº¿ç¨‹)"
            make -j$build_jobs V=s 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
          fi
        fi
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo ""
        echo "â±ï¸ ç¼–è¯‘è€—æ—¶: $((DURATION / 60))åˆ†é’Ÿ $((DURATION % 60))ç§’"
        
        # è®¾ç½®æ­¥éª¤ç»“æœ
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ… ç¼–è¯‘å®Œæˆ"
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç : $BUILD_EXIT_CODE"
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
        fi

    - name: è¯¦ç»†é”™è¯¯åˆ†æ
      if: always()
      run: |
        echo "=== è¯¦ç»†é”™è¯¯åˆ†æ ==="
        cd $BUILD_DIR
        
        # é¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨æ—¥å¿—æ–‡ä»¶
        echo "æ£€æŸ¥æ—¥å¿—æ–‡ä»¶..."
        if [ -f "build.log" ]; then
          echo "âœ… æ‰¾åˆ°ç¼–è¯‘æ—¥å¿—: build.log"
          LOG_SIZE=$(wc -l < build.log)
          echo "ğŸ“Š æ—¥å¿—å¤§å°: $LOG_SIZE è¡Œ"
          echo "ğŸ“„ æ—¥å¿—å¤§å°: $(du -h build.log | cut -f1)"
          
          # ä½¿ç”¨è¯¦ç»†é”™è¯¯åˆ†æè„šæœ¬
          if [ -f "$(pwd)/firmware-config/scripts/error_analysis_detailed.sh" ]; then
            $(pwd)/firmware-config/scripts/error_analysis_detailed.sh
          else
            echo "âš ï¸ è¯¦ç»†é”™è¯¯åˆ†æè„šæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç®€å•åˆ†æ"
            echo "æœ€å100è¡Œæ—¥å¿—:"
            tail -100 build.log
          fi
        else
          echo "âŒ ç¼–è¯‘æ—¥å¿—ä¸å­˜åœ¨"
          echo "å¯èƒ½çš„åŸå› :"
          echo "1. ç¼–è¯‘æœªå¼€å§‹"
          echo "2. ç¼–è¯‘è¿‡ç¨‹è¢«ä¸­æ–­"
          echo "3. ç£ç›˜ç©ºé—´ä¸è¶³"
          echo ""
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
        fi

    - name: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
        df -h
        echo ""
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "ğŸ“Š /mnt å‰©ä½™ç©ºé—´: ${AVAILABLE_GB}G"

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      run: |
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        cd $BUILD_DIR
        
        echo "æ£€æŸ¥å›ºä»¶æ–‡ä»¶..."
        
        if [ -f "$SCRIPT_PATH" ]; then
          $SCRIPT_PATH check_firmware_files
        else
          echo "âš ï¸ è„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨æ£€æŸ¥å›ºä»¶æ–‡ä»¶"
          if [ -d "bin/targets" ]; then
            echo "âœ… å›ºä»¶ç›®å½•å­˜åœ¨"
            echo "ç”Ÿæˆçš„å›ºä»¶åˆ—è¡¨:"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec ls -la {} \; | head -20
          fi
        fi
        
        echo ""
        echo "=== ç”Ÿæˆçš„å›ºä»¶è¯¦æƒ… ==="
        FIRMWARE_FILES=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) 2>/dev/null | head -10)
        if [ -n "$FIRMWARE_FILES" ]; then
          for file in $FIRMWARE_FILES; do
            size=$(du -h "$file" | cut -f1)
            echo "âœ… ğŸ“„ $file ($size)"
          done
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "å¯èƒ½çš„åŸå› :"
          echo "1. ç¼–è¯‘å¤±è´¥"
          echo "2. è¾“å‡ºè·¯å¾„é”™è¯¯"
          echo "3. è®¾å¤‡é…ç½®é”™è¯¯"
        fi

    - name: å¤‡ä»½é…ç½®æ–‡ä»¶
      if: always()
      run: |
        echo "=== å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "è„šæœ¬è·¯å¾„: $SCRIPT_PATH"
        
        # ç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•
        cd $BUILD_DIR
        echo "åˆ‡æ¢åˆ°æ„å»ºç›®å½•: $BUILD_DIR"
        
        # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ -f "../$SCRIPT_PATH" ]; then
          echo "ä½¿ç”¨ç›¸å¯¹è·¯å¾„è„šæœ¬"
          ../$SCRIPT_PATH backup_config
        elif [ -f "$(pwd)/../$SCRIPT_PATH" ]; then
          echo "ä½¿ç”¨ç»å¯¹è·¯å¾„è„šæœ¬"
          $(pwd)/../$SCRIPT_PATH backup_config
        elif [ -f "$SCRIPT_PATH" ]; then
          echo "ä½¿ç”¨å½“å‰ç›®å½•è„šæœ¬"
          $SCRIPT_PATH backup_config
        else
          echo "âŒ è„šæœ¬ä¸å­˜åœ¨ï¼Œå°è¯•æ‰‹åŠ¨å¤‡ä»½"
          # æ‰‹åŠ¨å¤‡ä»½é…ç½®
          mkdir -p config_backup
          if [ -f ".config" ]; then
            cp .config config_backup/
            echo "âœ… æ‰‹åŠ¨å¤‡ä»½ .config æ–‡ä»¶"
          fi
          if [ -f "build.log" ]; then
            cp build.log config_backup/ 2>/dev/null || true
            echo "âœ… æ‰‹åŠ¨å¤‡ä»½ç¼–è¯‘æ—¥å¿—"
          fi
        fi
        
        echo ""
        echo "ğŸ“ å¤‡ä»½å†…å®¹:"
        ls -la config_backup/ 2>/dev/null || echo "æ²¡æœ‰å¤‡ä»½æ–‡ä»¶"

    - name: æ˜¾ç¤ºå·¥å…·é“¾ç»Ÿè®¡ä¿¡æ¯
      if: always()
      run: |
        echo "=== å·¥å…·é“¾ç»Ÿè®¡ä¿¡æ¯ ==="
        
        TOOLCHAIN_DB="$TOOLCHAIN_DIR/toolchain_db.json"
        if [ -f "$TOOLCHAIN_DB" ]; then
          echo "ğŸ“Š å·¥å…·é“¾æ•°æ®åº“: $TOOLCHAIN_DB"
          echo ""
          echo "ç»Ÿè®¡ä¿¡æ¯:"
          if command -v jq >/dev/null 2>&1; then
            jq '.statistics' $TOOLCHAIN_DB
          else
            grep -A 10 '"statistics"' $TOOLCHAIN_DB || echo "æ— æ³•è§£æç»Ÿè®¡ä¿¡æ¯"
          fi
          
          echo ""
          echo "ç¼“å­˜çš„å·¥å…·é“¾:"
          if command -v jq >/dev/null 2>&1; then
            jq -r '.toolchains | keys[]' $TOOLCHAIN_DB 2>/dev/null | while read key; do
              size=$(jq -r ".toolchains.\"$key\".size" $TOOLCHAIN_DB 2>/dev/null)
              date=$(jq -r ".toolchains.\"$key\".created" $TOOLCHAIN_DB 2>/dev/null)
              echo "  ğŸ”§ $key ($size, åˆ›å»ºäº: $date)"
            done
          fi
        else
          echo "âŒ å·¥å…·é“¾æ•°æ®åº“ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "å·¥å…·é“¾ç¼“å­˜ç›®å½•: $TOOLCHAIN_DIR"
        if [ -d "$TOOLCHAIN_DIR" ]; then
          echo "ğŸ“¦ æ€»å¤§å°: $(du -sh $TOOLCHAIN_DIR | cut -f1)"
          echo "ğŸ“ ç›®å½•å†…å®¹:"
          ls -la $TOOLCHAIN_DIR/
        fi

    - name: ä¸Šä¼ å›ºä»¶
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ steps.create_env_backup.outputs.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/*.log
          ${{ env.BUILD_DIR }}/config_backup/
          ${{ env.TOOLCHAIN_DIR }}/toolchain_db.json
        retention-days: 7

    - name: æ¸…ç†æ„å»ºç›®å½•ï¼ˆä¿ç•™å·¥å…·é“¾ï¼‰
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œä¿ç•™æºç å’Œå·¥å…·é“¾..."
        
        if [ -d "$BUILD_DIR" ]; then
          cd $BUILD_DIR
          echo "æ¸…ç†å‰å¤§å°: $(du -sh . | cut -f1)"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œä¿ç•™é‡è¦æ–‡ä»¶
          rm -rf build_dir tmp logs dl .config.old
          echo "æ¸…ç†åå¤§å°: $(du -sh . | cut -f1)"
          
          echo "ğŸ“ ä¿ç•™çš„æ–‡ä»¶:"
          ls -la
        fi
        
        echo ""
        echo "ğŸ“¦ å·¥å…·é“¾ç¼“å­˜ä¿¡æ¯:"
        if [ -d "$TOOLCHAIN_DIR" ]; then
          echo "ä½ç½®: $TOOLCHAIN_DIR"
          echo "å¤§å°: $(du -sh $TOOLCHAIN_DIR | cut -f1)"
          echo "å†…å®¹:"
          ls -la $TOOLCHAIN_DIR/
        fi
