name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆ - ç¼–è¯‘å™¨é¢„ä¸‹è½½ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ 
          
          ğŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚
        required: false
        type: string
        default: ""

env:
  BUILD_DIR: "/mnt/openwrt-build"
  COMPILER_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
      - name: "1. ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        run: |
          echo "=== æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç  ==="
          echo "ğŸ”„ ä»GitHub APIè·å–æºä»£ç å‹ç¼©åŒ…"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          
          # è·å–é»˜è®¤åˆ†æ”¯
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
          
          # ä½¿ç”¨Git Archive APIä¸‹è½½å‹ç¼©åŒ…
          echo "ä¸‹è½½æºä»£ç å‹ç¼©åŒ…..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" -o source.tar.gz
          
          if [ ! -f "source.tar.gz" ]; then
            echo "âŒ ä¸‹è½½æºä»£ç å‹ç¼©åŒ…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(ls -lh source.tar.gz | awk '{print $5}')"
          
          # è§£å‹å‹ç¼©åŒ…
          echo "è§£å‹æºä»£ç ..."
          tar -xzf source.tar.gz --strip-components=1
          
          # æ£€æŸ¥è§£å‹ç»“æœ
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âœ… æºä»£ç è§£å‹æˆåŠŸ"
            echo "é‡è¦æ–‡ä»¶å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
            
            # å¤åˆ¶åˆ°å·¥ä½œåŒº - ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–¹å¼
            echo "å¤åˆ¶æ–‡ä»¶åˆ°å·¥ä½œåŒº..."
            
            # ç¡®ä¿å·¥ä½œåŒºç›®å½•å­˜åœ¨
            mkdir -p ${{ github.workspace }}
            
            # æ£€æŸ¥å¹¶åˆ é™¤ç¼–è¯‘å™¨ç›®å½•ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if [ -d "firmware-config/build-Compiler-file" ]; then
              echo "âš ï¸ å‘ç°ç¼–è¯‘å™¨ç›®å½•ï¼Œæ’é™¤ä¸å¤åˆ¶"
              rm -rf firmware-config/build-Compiler-file
            fi
            
            # ä½¿ç”¨rsyncå¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼Œæ’é™¤.gitç›®å½•
            rsync -av --exclude='.git' . ${{ github.workspace }}/
            
            # ç¡®ä¿è„šæœ¬æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
            chmod +x ${{ github.workspace }}/firmware-config/scripts/*.sh 2>/dev/null || true
            
            echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
            
            # ä¿å­˜æºä»£ç å‹ç¼©åŒ…ä½œä¸ºæ„å»ºäº§ç‰©
            mkdir -p /tmp/build-artifacts/source-archive
            cp source.tar.gz /tmp/build-artifacts/source-archive/
          else
            echo "âŒ æºä»£ç è§£å‹å¤±è´¥ï¼Œé‡è¦æ–‡ä»¶ç¼ºå¤±"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          cd /tmp
          rm -rf openwrt-source
          echo "âœ… Git Archive APIä¸‹è½½å®Œæˆ"
      
      # æ­¥éª¤ 2: ç«‹å³ä¸Šä¼ Git Archiveæºä»£ç 
      - name: "2. ç«‹å³ä¸Šä¼ Git Archiveæºä»£ç "
        uses: actions/upload-artifact@v4
        with:
          name: git-archive-source-${{ github.event.inputs.device_name }}
          path: /tmp/build-artifacts/source-archive/
          retention-days: 7
      
      # æ­¥éª¤ 3: æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•çŠ¶æ€
      - name: "3. æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•çŠ¶æ€"
        run: |
          echo "=== æ­¥éª¤ 3: æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•çŠ¶æ€ ==="
          COMPILER_DIR="${{ env.COMPILER_DIR }}"
          
          if [ -d "$COMPILER_DIR" ]; then
            echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•å­˜åœ¨"
            echo "è·¯å¾„: $COMPILER_DIR"
            echo "ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            echo "ç›®å½•å†…å®¹:"
            ls -la "$COMPILER_DIR/" 2>/dev/null | head -10 || echo "æ— æ³•åˆ—å‡º"
          else
            echo "â„¹ï¸ ç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°ç›®å½•"
            mkdir -p "$COMPILER_DIR"
            echo "âœ… å·²åˆ›å»ºç¼–è¯‘å™¨æ–‡ä»¶ç›®å½•: $COMPILER_DIR"
          fi
      
      # æ­¥éª¤ 4: æ™ºèƒ½æ£€æŸ¥å¹¶ç¼–è¯‘äº¤å‰ç¼–è¯‘å™¨ï¼ˆä¿®å¤äº†YAMLè¯­æ³•ï¼‰
      - name: "4. æ™ºèƒ½æ£€æŸ¥å¹¶ç¼–è¯‘äº¤å‰ç¼–è¯‘å™¨"
        run: |
          echo "=== æ­¥éª¤ 4: æ™ºèƒ½æ£€æŸ¥å¹¶ç¼–è¯‘äº¤å‰ç¼–è¯‘å™¨ ==="
          
          COMPILER_DIR="${{ env.COMPILER_DIR }}"
          COMPILER_OUTPUT_DIR="$COMPILER_DIR/compiled"
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          echo "ğŸ”§ æ™ºèƒ½ç¼–è¯‘å™¨ç®¡ç†æµç¨‹:"
          echo "1. æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨çŠ¶æ€"
          echo "2. åªåœ¨å¿…è¦æ—¶é‡æ–°ç¼–è¯‘"
          echo "3. ç¼–è¯‘åä¿å­˜å¹¶æäº¤åˆ°ä»“åº“"
          echo "4. æ˜¾ç¤ºç¼–è¯‘å™¨è¯¦ç»†ä¿¡æ¯"
          
          # 1. æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨çŠ¶æ€..."
          NEED_COMPILE=false
          NEED_COMMIT=false
          
          if [ -d "$COMPILER_OUTPUT_DIR" ]; then
            echo "âœ… æ‰¾åˆ°å·²ç¼–è¯‘çš„äº¤å‰ç¼–è¯‘å™¨"
            
            # æ£€æŸ¥ç¼–è¯‘å™¨å®Œæ•´æ€§
            REQUIRED_FILES=("bin/arm-openwrt-linux-muslgnueabi-gcc" "bin/arm-openwrt-linux-muslgnueabi-g++" "bin/arm-openwrt-linux-muslgnueabi-ld" "bin/arm-openwrt-linux-muslgnueabi-ar" "bin/arm-openwrt-linux-muslgnueabi-strip" "lib/gcc/arm-openwrt-linux-muslgnueabi/8.4.0/libgcc.a")
            
            missing_files=0
            echo "ğŸ“‹ æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶å®Œæ•´æ€§:"
            for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "$COMPILER_OUTPUT_DIR/$file" ]; then
                echo "  âœ… $file"
              else
                echo "  âŒ $file - ç¼ºå¤±"
                missing_files=$((missing_files + 1))
              fi
            done
            
            if [ $missing_files -eq 0 ]; then
              echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶å®Œæ•´ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘"
              echo "ğŸ’¡ äº¤å‰ç¼–è¯‘å™¨æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥é•¿æœŸä½¿ç”¨"
              
              # è·å–ç¼–è¯‘å™¨ç‰ˆæœ¬
              gcc_file="$COMPILER_OUTPUT_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc"
              if [ -x "$gcc_file" ]; then
                compiler_version=$($gcc_file --version 2>&1 | head -1)
                echo "ğŸ”§ ç¼–è¯‘å™¨ç‰ˆæœ¬: $compiler_version"
              fi
              
              # æ˜¾ç¤ºç¼–è¯‘å™¨å¤§å°
              compiler_size=$(du -sh "$COMPILER_OUTPUT_DIR" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
              echo "ğŸ“¦ ç¼–è¯‘å™¨å¤§å°: $compiler_size"
              
              # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
              file_count=$(find "$COMPILER_OUTPUT_DIR" -type f 2>/dev/null | wc -l)
              dir_count=$(find "$COMPILER_OUTPUT_DIR" -type d 2>/dev/null | wc -l)
              echo "ğŸ“Š ç¼–è¯‘å™¨ç»Ÿè®¡: $file_count ä¸ªæ–‡ä»¶, $((dir_count - 1)) ä¸ªç›®å½•"
              
              # æ£€æŸ¥GitçŠ¶æ€ï¼ˆæ˜¯å¦å·²æäº¤ï¼‰
              cd "${{ github.workspace }}"
              git_status=$(git status --porcelain "firmware-config/build-Compiler-file/compiled/" 2>/dev/null)
              
              if [ -n "$git_status" ]; then
                echo "ğŸ”„ ç¼–è¯‘å™¨æœ‰æœªæäº¤çš„æ›´æ”¹ï¼Œéœ€è¦æäº¤"
                NEED_COMMIT=true
              fi
            else
              echo "âŒ ç¼–è¯‘å™¨ä¸å®Œæ•´ï¼Œç¼ºå¤± $missing_files ä¸ªå…³é”®æ–‡ä»¶ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
              NEED_COMPILE=true
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°å·²ç¼–è¯‘çš„äº¤å‰ç¼–è¯‘å™¨ï¼Œéœ€è¦ç¼–è¯‘"
            NEED_COMPILE=true
          fi
          
          # 2. åªåœ¨å¿…è¦æ—¶ç¼–è¯‘
          if [ "$NEED_COMPILE" = true ]; then
            echo "ğŸš€ å¼€å§‹ç¼–è¯‘äº¤å‰ç¼–è¯‘å™¨..."
            
            # åˆ›å»ºæ„å»ºç›®å½•
            mkdir -p "$BUILD_DIR"
            cd "$BUILD_DIR"
            
            # æ¸…ç†æ—§ç›®å½•
            rm -rf ./* ./.git* 2>/dev/null || true
            
            # å…‹éš†æºç 
            echo "ğŸ“¥ å…‹éš†OpenWrtæºç ..."
            git clone --depth 1 https://github.com/immortalwrt/immortalwrt.git . --branch openwrt-21.02
            
            # åˆ›å»ºæœ€å°é…ç½® - ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤æ›¿ä»£heredoc
            echo "âš™ï¸ åˆ›å»ºç¼–è¯‘å™¨æ„å»ºé…ç½®..."
            echo "CONFIG_TARGET_ipq40xx=y" > .config
            echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
            echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config
            echo "CONFIG_EXTERNAL_TOOLCHAIN=y" >> .config
            echo "CONFIG_USE_MUSL=y" >> .config
            
            # ä¸‹è½½ä¾èµ–
            echo "ğŸ“¦ ä¸‹è½½ç¼–è¯‘å™¨ä¾èµ–..."
            mkdir -p dl
            
            # ä¸‹è½½ç¼–è¯‘å™¨æ–‡ä»¶ - ä½¿ç”¨æ•°ç»„
            COMPILER_FILES=("gcc-11.3.0.tar.xz" "binutils-2.38.tar.xz" "linux-5.15.133.tar.xz" "musl-1.2.4.tar.gz" "gmp-6.2.1.tar.xz" "mpfr-4.1.0.tar.xz" "mpc-1.2.1.tar.gz")
            COMPILER_URLS=("https://ftp.gnu.org/gnu/gcc/gcc-11.3.0/gcc-11.3.0.tar.xz" "https://ftp.gnu.org/gnu/binutils/binutils-2.38.tar.xz" "https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.15.133.tar.xz" "https://musl.libc.org/releases/musl-1.2.4.tar.gz" "https://ftp.gnu.org/gnu/gmp/gmp-6.2.1.tar.xz" "https://ftp.gnu.org/gnu/mpfr/mpfr-4.1.0.tar.xz" "https://ftp.gnu.org/gnu/mpc/mpc-1.2.1.tar.gz")
            
            downloaded=0
            for i in "${!COMPILER_FILES[@]}"; do
              file="${COMPILER_FILES[$i]}"
              url="${COMPILER_URLS[$i]}"
              if [ ! -f "dl/$file" ]; then
                echo "ä¸‹è½½: $file"
                wget --no-check-certificate -q --show-progress -O "dl/$file" "$url" && downloaded=$((downloaded + 1)) || echo "ä¸‹è½½å¤±è´¥: $file"
              fi
            done
            
            echo "ğŸ“Š ä¾èµ–ä¸‹è½½å®Œæˆ: æ–°ä¸‹è½½ $downloaded ä¸ªæ–‡ä»¶"
            
            # ç¼–è¯‘ç¼–è¯‘å™¨
            echo "ğŸ”¨ ç¼–è¯‘äº¤å‰ç¼–è¯‘å™¨ (å¯èƒ½éœ€è¦10-20åˆ†é’Ÿ)..."
            
            # åªç¼–è¯‘toolchain
            make toolchain/install -j$(nproc) V=s 2>&1 | tee compiler-build.log
            
            # æ£€æŸ¥ç¼–è¯‘ç»“æœ
            if [ $? -eq 0 ] && [ -d "staging_dir/toolchain-"* ]; then
              echo "âœ… äº¤å‰ç¼–è¯‘å™¨ç¼–è¯‘æˆåŠŸï¼"
              
              # æ¸…ç†æ—§çš„ç¼–è¯‘å™¨ç›®å½•
              rm -rf "$COMPILER_OUTPUT_DIR"
              mkdir -p "$COMPILER_OUTPUT_DIR"
              
              # å¤åˆ¶ç¼–è¯‘å™¨
              echo "ğŸ’¾ ä¿å­˜ç¼–è¯‘å¥½çš„ç¼–è¯‘å™¨..."
              cp -r staging_dir/toolchain-* "$COMPILER_OUTPUT_DIR/" 2>/dev/null || true
              
              NEED_COMMIT=true
            else
              echo "âŒ äº¤å‰ç¼–è¯‘å™¨ç¼–è¯‘å¤±è´¥"
              echo "ğŸ“‹ ç¼–è¯‘æ—¥å¿—æ‘˜è¦:"
              tail -20 compiler-build.log 2>/dev/null || echo "æ— æ—¥å¿—"
              exit 1
            fi
          else
            echo "âœ… ä½¿ç”¨ç°æœ‰çš„ç¼–è¯‘å™¨ï¼Œè·³è¿‡ç¼–è¯‘æ­¥éª¤"
          fi
          
          # 3. æ˜¾ç¤ºæœ€ç»ˆç¼–è¯‘å™¨ä¿¡æ¯
          echo "ğŸ“Š æœ€ç»ˆç¼–è¯‘å™¨ä¿¡æ¯:"
          if [ -d "$COMPILER_OUTPUT_DIR" ]; then
            total_size=$(du -sh "$COMPILER_OUTPUT_DIR" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            file_count=$(find "$COMPILER_OUTPUT_DIR" -type f 2>/dev/null | wc -l)
            
            echo "ğŸ“ è·¯å¾„: $COMPILER_OUTPUT_DIR"
            echo "ğŸ“¦ æ€»å¤§å°: $total_size"
            echo "ğŸ“„ æ–‡ä»¶æ•°é‡: $file_count ä¸ª"
            
            # æ˜¾ç¤ºå…³é”®æ–‡ä»¶
            echo "ğŸ”§ å…³é”®ç¼–è¯‘å™¨æ–‡ä»¶:"
            find "$COMPILER_OUTPUT_DIR/bin" -type f -name "*gcc*" -o -name "*g++*" -o -name "*ar" -o -name "*ld" -o -name "*strip" 2>/dev/null | head -10 | while read file; do
              file_name=$(basename "$file")
              file_size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
              echo "  ğŸ“„ $file_name ($file_size)"
            done
            
            # åˆ›å»ºç¼–è¯‘å™¨ä¿¡æ¯æ–‡ä»¶ - ä½¿ç”¨å¤šä¸ªecho
            echo "äº¤å‰ç¼–è¯‘å™¨ä¿¡æ¯" > "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "===============" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "ç¼–è¯‘æ—¶é—´: $(date)" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "ç›®æ ‡å¹³å°: arm_cortex-a7+neon-vfpv4" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "ç¼–è¯‘å™¨: gcc-8.4.0" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "Cåº“: musl" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "æ€»å¤§å°: $total_size" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "æ–‡ä»¶æ•°é‡: $file_count" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "Gitæäº¤: ${{ github.sha }}" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "æ„å»ºå·¥ä½œæµ: ${{ github.workflow }}" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "çŠ¶æ€: å®Œæ•´å¯ç”¨" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
            echo "è¯´æ˜: æ­¤äº¤å‰ç¼–è¯‘å™¨æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥é•¿æœŸä½¿ç”¨" >> "$COMPILER_OUTPUT_DIR/compiler-info.txt"
          fi
          
          # 4. æ™ºèƒ½æäº¤åˆ°ä»“åº“
          if [ "$NEED_COMMIT" = true ]; then
            echo "ğŸ“¤ å‡†å¤‡æäº¤ç¼–è¯‘å™¨åˆ°ä»“åº“..."
            cd "${{ github.workspace }}"
            
            # é…ç½®Git
            git config --global user.email "github-actions@github.com"
            git config --global user.name "GitHub Actions"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
            git_status=$(git status --porcelain "firmware-config/build-Compiler-file/compiled/" 2>/dev/null)
            
            if [ -n "$git_status" ]; then
              echo "ğŸ”„ æ£€æµ‹åˆ°ç¼–è¯‘å™¨æ›´æ”¹ï¼Œæ­£åœ¨æäº¤..."
              
              # æ·»åŠ æ–‡ä»¶
              git add "firmware-config/build-Compiler-file/compiled/"
              
              # æäº¤
              commit_message="build: æ›´æ–°äº¤å‰ç¼–è¯‘å™¨ (${{ github.event.inputs.device_name }} - $(date +%Y%m%d))"
              git commit -m "$commit_message"
              
              echo "âœ… ç¼–è¯‘å™¨å·²æäº¤åˆ°æœ¬åœ°ä»“åº“"
              echo "ğŸ“ æäº¤ä¿¡æ¯: $commit_message"
              
              # æ˜¾ç¤ºæäº¤çš„ç»Ÿè®¡
              echo "ğŸ“Š æäº¤ç»Ÿè®¡:"
              echo "  æ·»åŠ /ä¿®æ”¹æ–‡ä»¶: $(git diff --cached --name-only | wc -l)"
              echo "  æ€»å¤§å°: $total_size"
              
              # å°è¯•æ¨é€
              echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
              if git push origin ${GITHUB_REF##*/}; then
                echo "ğŸ‰ ç¼–è¯‘å™¨å·²æˆåŠŸæ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼"
                echo "ğŸ”— å¯ä»¥åœ¨ä»“åº“çš„ firmware-config/build-Compiler-file/compiled/ ç›®å½•æŸ¥çœ‹"
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜"
                echo "ğŸ’¡ æäº¤å·²ä¿å­˜åœ¨æœ¬åœ°ï¼Œå¯åœ¨åç»­æ­¥éª¤ä¸­æ‰‹åŠ¨æ¨é€"
              fi
            else
              echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶æ²¡æœ‰æ›´æ”¹ï¼Œæ— éœ€æäº¤"
            fi
          else
            echo "âœ… ç¼–è¯‘å™¨æ— éœ€æäº¤åˆ°ä»“åº“"
          fi
          
          echo "âœ… æ™ºèƒ½ç¼–è¯‘å™¨ç®¡ç†å®Œæˆ"
      
      # æ­¥éª¤ 5: åˆå§‹ç©ºé—´æ£€æŸ¥
      - name: "5. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 5: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
            exit 1
          fi
          echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"
      
      # æ­¥éª¤ 6: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•
      - name: "6. è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 6: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½• ==="
          
          echo "ğŸ”„ æ­¥éª¤ 6.1: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          firmware-config/scripts/build_firmware_main.sh setup_environment
          
          echo "ğŸ”„ æ­¥éª¤ 6.2: åˆ›å»ºæ„å»ºç›®å½•"
          firmware-config/scripts/build_firmware_main.sh create_build_dir
          
          echo "ğŸ”„ æ­¥éª¤ 6.3: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•è®¾ç½®å®Œæˆ"
      
      # æ­¥éª¤ 7: æ·»åŠ  TurboACC æ”¯æŒ
      - name: "7. æ·»åŠ  TurboACC æ”¯æŒ"
        run: |
          echo "=== æ­¥éª¤ 7: æ·»åŠ  TurboACC æ”¯æŒ ==="
          firmware-config/scripts/build_firmware_main.sh add_turboacc_support
      
      # æ­¥éª¤ 8: é…ç½®Feeds
      - name: "8. é…ç½®Feeds"
        run: |
          echo "=== æ­¥éª¤ 8: é…ç½®Feeds ==="
          firmware-config/scripts/build_firmware_main.sh configure_feeds
      
      # æ­¥éª¤ 9: å®‰è£… TurboACC åŒ…
      - name: "9. å®‰è£… TurboACC åŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤ 9: å®‰è£… TurboACC åŒ… ==="
          firmware-config/scripts/build_firmware_main.sh install_turboacc_packages
      
      # æ­¥éª¤ 10: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "10. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 10: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh pre_build_space_check
      
      # æ­¥éª¤ 11: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
      - name: "11. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 11: æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          echo "ğŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨å¼ºåˆ¶å¯ç”¨"
          firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤ 12: éªŒè¯USBé…ç½®
      - name: "12. éªŒè¯USBé…ç½®"
        run: |
          echo "=== æ­¥éª¤ 12: éªŒè¯USBé…ç½® ==="
          firmware-config/scripts/build_firmware_main.sh verify_usb_config
      
      # æ­¥éª¤ 13: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "13. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 13: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity
      
      # æ­¥éª¤ 14: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "14. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== æ­¥éª¤ 14: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          
          # å…ˆä¿å­˜åŸå§‹é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            cp "${{ env.BUILD_DIR }}/.config" "${{ env.BUILD_DIR }}/.config.original"
            echo "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶"
          fi
          
          # åº”ç”¨é…ç½®
          firmware-config/scripts/build_firmware_main.sh apply_config
          
          # æ£€æŸ¥åº”ç”¨åçš„é…ç½®çŠ¶æ€
          echo "=== æ’ä»¶é…ç½®çŠ¶æ€æ£€æŸ¥ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # å®šä¹‰æ­£å¸¸æ¨¡å¼çš„å®Œæ•´æ’ä»¶åˆ—è¡¨
          declare -A normal_plugins
          normal_plugins["TurboACC ç½‘ç»œåŠ é€Ÿ"]="luci-app-turboacc"
          normal_plugins["UPnP è‡ªåŠ¨ç«¯å£è½¬å‘"]="luci-app-upnp"
          normal_plugins["Samba æ–‡ä»¶å…±äº«"]="luci-app-samba4"
          normal_plugins["ç£ç›˜ç®¡ç†"]="luci-app-diskman"
          normal_plugins["KMS æ¿€æ´»æœåŠ¡"]="luci-app-vlmcsd"
          normal_plugins["SmartDNS æ™ºèƒ½DNS"]="luci-app-smartdns"
          normal_plugins["å®¶é•¿æ§åˆ¶"]="luci-app-accesscontrol"
          normal_plugins["å¾®ä¿¡æ¨é€"]="luci-app-wechatpush"
          normal_plugins["æµé‡æ§åˆ¶ (SQM)"]="luci-app-sqm"
          normal_plugins["FTP æœåŠ¡å™¨"]="luci-app-vsftpd"
          normal_plugins["ARP ç»‘å®š"]="luci-app-arpbind"
          normal_plugins["CPU é™åˆ¶"]="luci-app-cpulimit"
          normal_plugins["ç¡¬ç›˜ä¼‘çœ "]="luci-app-hd-idle"
          
          echo "ğŸ“‹ æ­£å¸¸æ¨¡å¼æ’ä»¶çŠ¶æ€æ£€æŸ¥:"
          
          total_plugins=0
          enabled_plugins=0
          disabled_plugins=0
          
          for plugin_name in "${!normal_plugins[@]}"; do
            plugin_config="${normal_plugins[$plugin_name]}"
            total_plugins=$((total_plugins + 1))
            
            if grep -q "^CONFIG_PACKAGE_${plugin_config}=y" .config; then
              echo "  âœ… $plugin_name: å·²å¯ç”¨"
              enabled_plugins=$((enabled_plugins + 1))
            elif grep -q "^# CONFIG_PACKAGE_${plugin_config} is not set$" .config; then
              echo "  âŒ $plugin_name: å·²ç¦ç”¨"
              disabled_plugins=$((disabled_plugins + 1))
            else
              echo "  âš ï¸  $plugin_name: æœªé…ç½®"
            fi
          done
          
          echo ""
          echo "ğŸ“Š æ’ä»¶çŠ¶æ€ç»Ÿè®¡:"
          echo "  æ€»è®¡: $total_plugins ä¸ªæ’ä»¶"
          echo "  å·²å¯ç”¨: $enabled_plugins ä¸ª"
          echo "  å·²ç¦ç”¨: $disabled_plugins ä¸ª"
          
          # æ£€æŸ¥åŸºç¡€æ¨¡å¼æ˜¯å¦ç¦ç”¨äº†æ’ä»¶
          if [ "${{ github.event.inputs.config_mode }}" = "base" ]; then
            echo ""
            echo "ğŸ”§ åŸºç¡€æ¨¡å¼é…ç½®ç¡®è®¤:"
            if [ $enabled_plugins -eq 0 ]; then
              echo "  âœ… åŸºç¡€æ¨¡å¼: æ‰€æœ‰é¢å¤–æ’ä»¶å·²æ­£ç¡®ç¦ç”¨"
            else
              echo "  âš ï¸  åŸºç¡€æ¨¡å¼: æœ‰ $enabled_plugins ä¸ªæ’ä»¶æœªç¦ç”¨ï¼Œéœ€è¦æ£€æŸ¥"
            fi
          fi
          
          # é¢å¤–æ£€æŸ¥USBé©±åŠ¨çŠ¶æ€
          echo ""
          echo "ğŸ”Œ USBé©±åŠ¨çŠ¶æ€ç¡®è®¤:"
          critical_usb_drivers=("kmod-usb-xhci-hcd" "kmod-usb3" "kmod-usb-dwc3" "kmod-usb-storage" "kmod-scsi-core")
          for driver in "${critical_usb_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
              echo "  âœ… $driver: å·²å¯ç”¨"
            else
              echo "  âŒ $driver: æœªå¯ç”¨ (éœ€è¦ä¿®å¤)"
            fi
          done
          
          echo "âœ… é…ç½®è¯¦æƒ…æ£€æŸ¥å®Œæˆ"
      
      # æ­¥éª¤ 15: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "15. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 15: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
            mkdir -p firmware-config/config-backup
            
            # å¤‡ä»½åˆ°ä»“åº“ç›®å½•
            backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
            
            cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
            
            # æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶ä¿¡æ¯
            echo "å¤‡ä»½æ–‡ä»¶å¤§å°: $(ls -lh $backup_file | awk '{print $5}')"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      # æ­¥éª¤ 16: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "16. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤ 16: ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          firmware-config/scripts/build_firmware_main.sh fix_network
      
      # æ­¥éª¤ 17: ä¸‹è½½ä¾èµ–åŒ…
      - name: "17. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== æ­¥éª¤ 17: ä¸‹è½½ä¾èµ–åŒ… ==="
          firmware-config/scripts/build_firmware_main.sh download_dependencies
      
      # æ­¥éª¤ 18: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "18. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 18: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          firmware-config/scripts/build_firmware_main.sh integrate_custom_files
      
      # æ­¥éª¤ 19: å‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "19. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 19: å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          
          # å…ˆæ˜¾ç¤ºç¼–è¯‘å™¨æ–‡ä»¶çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥äº¤å‰ç¼–è¯‘å™¨çŠ¶æ€:"
          COMPILER_DIR="${{ env.COMPILER_DIR }}"
          COMPILER_OUTPUT_DIR="$COMPILER_DIR/compiled"
          
          if [ -d "$COMPILER_OUTPUT_DIR" ]; then
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘å¥½çš„äº¤å‰ç¼–è¯‘å™¨"
            total_size=$(du -sh "$COMPILER_OUTPUT_DIR" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            file_count=$(find "$COMPILER_OUTPUT_DIR" -type f 2>/dev/null | wc -l)
            echo "ğŸ“ ç¼–è¯‘å™¨ç›®å½•: $COMPILER_OUTPUT_DIR"
            echo "ğŸ“¦ æ€»å¤§å°: $total_size"
            echo "ğŸ“„ æ–‡ä»¶æ•°é‡: $file_count ä¸ª"
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            echo "ğŸ”§ æ£€æŸ¥å…³é”®ç¼–è¯‘å™¨æ–‡ä»¶:"
            if [ -f "$COMPILER_OUTPUT_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" ]; then
              echo "  âœ… arm-openwrt-linux-muslgnueabi-gcc: å­˜åœ¨"
            else
              echo "  âŒ arm-openwrt-linux-muslgnueabi-gcc: ç¼ºå¤±"
            fi
            
            if [ -f "$COMPILER_OUTPUT_DIR/bin/arm-openwrt-linux-muslgnueabi-g++" ]; then
              echo "  âœ… arm-openwrt-linux-muslgnueabi-g++: å­˜åœ¨"
            else
              echo "  âŒ arm-openwrt-linux-muslgnueabi-g++: ç¼ºå¤±"
            fi
            
            echo "ğŸ’¡ ç¼–è¯‘å™¨çŠ¶æ€: å®Œæ•´çš„äº¤å‰ç¼–è¯‘å™¨ï¼Œå¯ä»¥ç”¨äºåŠ é€Ÿæ„å»º"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç¼–è¯‘å¥½çš„äº¤å‰ç¼–è¯‘å™¨"
            echo "ğŸ“ å°†åœ¨æ„å»ºè¿‡ç¨‹ä¸­ç¼–è¯‘ç¼–è¯‘å™¨"
          fi
          
          echo ""
          echo "ğŸ”§ æ‰§è¡Œå‰ç½®é”™è¯¯æ£€æŸ¥è„šæœ¬..."
          firmware-config/scripts/build_firmware_main.sh pre_build_error_check
      
      # æ­¥éª¤ 20: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "20. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 20: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          # æ£€æŸ¥ç¼–è¯‘æ‰€éœ€ç©ºé—´
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
      
      # æ­¥éª¤ 21: æ™ºèƒ½ç¼–è¯‘å›ºä»¶ï¼ˆå«ç¼–è¯‘å™¨æ£€æŸ¥å’Œé‡ç¼–è¯‘ï¼‰
      - name: "21. æ™ºèƒ½ç¼–è¯‘å›ºä»¶"
        run: |
          echo "=== æ­¥éª¤ 21: æ™ºèƒ½ç¼–è¯‘å›ºä»¶ ==="
          
          COMPILER_DIR="${{ env.COMPILER_DIR }}"
          COMPILER_OUTPUT_DIR="$COMPILER_DIR/compiled"
          BUILD_DIR="${{ env.BUILD_DIR }}"
          
          echo "ğŸ”§ æ™ºèƒ½ç¼–è¯‘å™¨æ£€æŸ¥æµç¨‹:"
          
          # 1. æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨æ˜¯å¦å¯ç”¨
          cd "$BUILD_DIR"
          COMPILER_USABLE=false
          NEED_RECOMPILE=false
          
          if [ -d "$COMPILER_OUTPUT_DIR" ]; then
            echo "ğŸ” æ£€æŸ¥é¢„ç¼–è¯‘ç¼–è¯‘å™¨å¯ç”¨æ€§..."
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶å®Œæ•´æ€§
            REQUIRED_FILES=("bin/arm-openwrt-linux-muslgnueabi-gcc" "bin/arm-openwrt-linux-muslgnueabi-g++" "bin/arm-openwrt-linux-muslgnueabi-ld" "bin/arm-openwrt-linux-muslgnueabi-ar" "bin/arm-openwrt-linux-muslgnueabi-strip" "lib/gcc/arm-openwrt-linux-muslgnueabi/8.4.0/libgcc.a")
            
            missing_files=0
            for file in "${REQUIRED_FILES[@]}"; do
              if [ ! -f "$COMPILER_OUTPUT_DIR/$file" ]; then
                missing_files=$((missing_files + 1))
              fi
            done
            
            if [ $missing_files -eq 0 ]; then
              echo "âœ… é¢„ç¼–è¯‘ç¼–è¯‘å™¨å®Œæ•´"
              
              # æµ‹è¯•ç¼–è¯‘å™¨æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œ
              if [ -x "$COMPILER_OUTPUT_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" ]; then
                echo "ğŸ”§ æµ‹è¯•ç¼–è¯‘å™¨åŠŸèƒ½..."
                test_output=$("$COMPILER_OUTPUT_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" --version 2>&1)
                if echo "$test_output" | grep -q "gcc"; then
                  echo "âœ… ç¼–è¯‘å™¨å·¥ä½œæ­£å¸¸"
                  COMPILER_USABLE=true
                else
                  echo "âŒ ç¼–è¯‘å™¨æµ‹è¯•å¤±è´¥"
                  NEED_RECOMPILE=true
                fi
              else
                echo "âŒ ç¼–è¯‘å™¨ä¸å¯æ‰§è¡Œ"
                NEED_RECOMPILE=true
              fi
            else
              echo "âŒ é¢„ç¼–è¯‘ç¼–è¯‘å™¨ç¼ºå¤± $missing_files ä¸ªå…³é”®æ–‡ä»¶"
              NEED_RECOMPILE=true
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°é¢„ç¼–è¯‘ç¼–è¯‘å™¨"
            NEED_RECOMPILE=true
          fi
          
          # 2. å¦‚æœéœ€è¦é‡æ–°ç¼–è¯‘ç¼–è¯‘å™¨
          if [ "$NEED_RECOMPILE" = true ]; then
            echo "ğŸš¨ éœ€è¦é‡æ–°ç¼–è¯‘äº¤å‰ç¼–è¯‘å™¨"
            
            # ä¿å­˜å½“å‰é…ç½®
            if [ -f ".config" ]; then
              cp .config .config.backup
              echo "âœ… å¤‡ä»½å½“å‰é…ç½®"
            fi
            
            # æ¸…ç†æ—§ç¼–è¯‘å™¨ç›®å½•
            rm -rf "$COMPILER_OUTPUT_DIR"
            mkdir -p "$COMPILER_OUTPUT_DIR"
            
            # è®¾ç½®ç¼–è¯‘å™¨æ„å»ºé…ç½® - ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤
            echo "CONFIG_TARGET_ipq40xx=y" > .config
            echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
            echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config
            echo "CONFIG_EXTERNAL_TOOLCHAIN=y" >> .config
            echo "CONFIG_USE_MUSL=y" >> .config
            
            # ç¼–è¯‘ç¼–è¯‘å™¨
            echo "ğŸ”¨ ç¼–è¯‘äº¤å‰ç¼–è¯‘å™¨..."
            make toolchain/install -j$(nproc) V=s 2>&1 | tee compiler-rebuild.log
            
            if [ $? -eq 0 ] && [ -d "staging_dir/toolchain-"* ]; then
              echo "âœ… äº¤å‰ç¼–è¯‘å™¨é‡æ–°ç¼–è¯‘æˆåŠŸ"
              
              # å¤åˆ¶ç¼–è¯‘å™¨åˆ°é¢„ç¼–è¯‘ç›®å½•
              cp -r staging_dir/toolchain-* "$COMPILER_OUTPUT_DIR/" 2>/dev/null || true
              
              # æ£€æŸ¥ç¼–è¯‘å™¨æ˜¯å¦å®Œæ•´
              if [ -f "$COMPILER_OUTPUT_DIR/bin/arm-openwrt-linux-muslgnueabi-gcc" ]; then
                COMPILER_USABLE=true
                
                # æäº¤ç¼–è¯‘å™¨åˆ°ä»“åº“
                cd "${{ github.workspace }}"
                if [ -d "$COMPILER_OUTPUT_DIR" ]; then
                  echo "ğŸ“¤ å‡†å¤‡æäº¤é‡æ–°ç¼–è¯‘çš„ç¼–è¯‘å™¨åˆ°ä»“åº“..."
                  
                  # é…ç½®Git
                  git config --global user.email "github-actions@github.com"
                  git config --global user.name "GitHub Actions"
                  
                  # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
                  git_status=$(git status --porcelain "firmware-config/build-Compiler-file/compiled/" 2>/dev/null)
                  
                  if [ -n "$git_status" ]; then
                    echo "ğŸ”„ æ£€æµ‹åˆ°ç¼–è¯‘å™¨æ›´æ”¹ï¼Œæ­£åœ¨æäº¤..."
                    
                    # æ·»åŠ æ–‡ä»¶
                    git add "firmware-config/build-Compiler-file/compiled/"
                    
                    # ä¸ä»“åº“ä¸­çš„ç‰ˆæœ¬æ¯”è¾ƒ
                    echo "ğŸ” æ¯”è¾ƒç¼–è¯‘å™¨ç‰ˆæœ¬..."
                    compiler_date=$(date +%Y%m%d_%H%M%S)
                    git_commit=$(git log -1 --format="%h" -- firmware-config/build-Compiler-file/compiled/ 2>/dev/null || echo "æ— å†å²æäº¤")
                    
                    # æäº¤
                    commit_message="fix: é‡æ–°ç¼–è¯‘äº¤å‰ç¼–è¯‘å™¨ (${{ github.event.inputs.device_name }} - $compiler_date) ä¹‹å‰æäº¤: $git_commit"
                    git commit -m "$commit_message"
                    
                    echo "âœ… ç¼–è¯‘å™¨å·²æäº¤åˆ°æœ¬åœ°ä»“åº“"
                    echo "ğŸ“ æäº¤ä¿¡æ¯: $commit_message"
                    
                    # å°è¯•æ¨é€
                    echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
                    if git push origin ${GITHUB_REF##*/}; then
                      echo "ğŸ‰ ç¼–è¯‘å™¨å·²æˆåŠŸæ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼"
                    else
                      echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œæäº¤å·²ä¿å­˜åœ¨æœ¬åœ°"
                    fi
                  else
                    echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶æ²¡æœ‰æ›´æ”¹ï¼Œæ— éœ€æäº¤"
                  fi
                fi
              fi
            else
              echo "âŒ äº¤å‰ç¼–è¯‘å™¨é‡æ–°ç¼–è¯‘å¤±è´¥"
              echo "ğŸ“‹ ç¼–è¯‘æ—¥å¿—æ‘˜è¦:"
              tail -20 compiler-rebuild.log 2>/dev/null || echo "æ— æ—¥å¿—"
            fi
            
            # æ¢å¤é…ç½®
            if [ -f ".config.backup" ]; then
              cp .config.backup .config
              echo "âœ… æ¢å¤åŸå§‹é…ç½®"
            fi
          fi
          
          # 3. ä½¿ç”¨é¢„ç¼–è¯‘ç¼–è¯‘å™¨åŠ é€Ÿæ„å»ºï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if [ "$COMPILER_USABLE" = true ]; then
            echo "ğŸš€ ä½¿ç”¨é¢„ç¼–è¯‘çš„äº¤å‰ç¼–è¯‘å™¨åŠ é€Ÿæ„å»º..."
            
            # å¦‚æœstaging_dirä¸­å·²æœ‰ç¼–è¯‘å™¨ï¼Œå…ˆå¤‡ä»½
            if [ -d "staging_dir/toolchain-"* ]; then
              mv staging_dir/toolchain-* staging_dir/toolchain-backup-$(date +%s) 2>/dev/null || true
            fi
            
            # å¤åˆ¶é¢„ç¼–è¯‘ç¼–è¯‘å™¨åˆ°staging_dir
            if [ -d "$COMPILER_OUTPUT_DIR/toolchain-"* ]; then
              cp -r "$COMPILER_OUTPUT_DIR/toolchain-"* staging_dir/
              echo "âœ… é¢„ç¼–è¯‘ç¼–è¯‘å™¨å·²å¤åˆ¶åˆ°æ„å»ºç›®å½•"
            fi
          else
            echo "âš ï¸ å°†ä½¿ç”¨å†…ç½®çš„ç¼–è¯‘å™¨æ„å»ºæµç¨‹"
          fi
          
          # 4. å¼€å§‹ç¼–è¯‘å›ºä»¶
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          
          # è·å–CPUæ ¸å¿ƒæ•°
          cpu_cores=$(nproc)
          make_jobs=$cpu_cores
          
          # å¦‚æœå†…å­˜å°äº4GBï¼Œå‡å°‘å¹¶è¡Œä»»åŠ¡
          total_mem=$(free -m | awk '/^Mem:/{print $2}')
          if [ $total_mem -lt 4096 ]; then
            make_jobs=$((cpu_cores / 2))
            if [ $make_jobs -lt 1 ]; then
              make_jobs=1
            fi
            echo "âš ï¸ å†…å­˜è¾ƒä½(${total_mem}MB)ï¼Œå‡å°‘å¹¶è¡Œä»»åŠ¡åˆ° $make_jobs"
          fi
          
          # å¯ç”¨ç¼–è¯‘ç¼“å­˜ï¼Œä½¿ç”¨å¹¶è¡Œç¼–è¯‘
          echo "ä½¿ç”¨ $make_jobs ä¸ªå¹¶è¡Œä»»åŠ¡è¿›è¡Œç¼–è¯‘..."
          firmware-config/scripts/build_firmware_main.sh build_firmware "true"
          
          echo "âœ… æ™ºèƒ½ç¼–è¯‘å®Œæˆ"
      
      # æ­¥éª¤ 22: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: "22. æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 22: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰© ==="
          cd ${{ env.BUILD_DIR }}
          
          # åˆ›å»ºæ„å»ºäº§ç‰©ç›®å½•
          mkdir -p /tmp/build-artifacts
          
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ–‡ä»¶ï¼Œé¿å…é‡å¤ä¸Šä¼ 
          echo "ğŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ„å»ºäº§ç‰©..."
          need_upload=false
          
          # æ‰“åŒ…å›ºä»¶æ–‡ä»¶
          if [ -d "bin/targets" ]; then
            echo "æ‰“åŒ…å›ºä»¶æ–‡ä»¶..."
            tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°
            firmware_size=$(stat -c%s /tmp/build-artifacts/firmware.tar.gz 2>/dev/null || echo "0")
            if [ $firmware_size -gt 0 ]; then
              echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆï¼Œå¤§å°: $(du -h /tmp/build-artifacts/firmware.tar.gz | cut -f1)"
              need_upload=true
            else
              echo "âš ï¸ å›ºä»¶æ‰“åŒ…å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            fi
          else
            echo "âš ï¸ bin/targetsç›®å½•ä¸å­˜åœ¨"
          fi
          
          # æ‰“åŒ…ç¼–è¯‘æ—¥å¿—
          if [ -f "build.log" ]; then
            echo "æ‰“åŒ…ç¼–è¯‘æ—¥å¿—..."
            cp build.log /tmp/build-artifacts/build.log
            echo "âœ… æ—¥å¿—æ‰“åŒ…å®Œæˆ"
            need_upload=true
          fi
          
          # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
          echo "æ„å»ºæ—¶é—´: $(date)" > /tmp/build-artifacts/build-info.txt
          echo "è®¾å¤‡: ${{ env.DEVICE }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/build-info.txt
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/build-info.txt
          
          if [ "$need_upload" = true ]; then
            echo "âœ… æ„å»ºäº§ç‰©å‡†å¤‡å®Œæˆ"
            echo "ğŸ“¤ æ„å»ºäº§ç‰©å·²ä¿å­˜åœ¨: /tmp/build-artifacts/"
            ls -lh /tmp/build-artifacts/
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„æ„å»ºäº§ç‰©"
          fi
      
      # æ­¥éª¤ 23: ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•
      - name: "23. ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
      
      # æ­¥éª¤ 24: ä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "24. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      # æ­¥éª¤ 25: é”™è¯¯åˆ†æï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½è¿è¡Œï¼‰
      - name: "25. é”™è¯¯åˆ†æ"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 25: é”™è¯¯åˆ†æ ==="
          firmware-config/scripts/error_analysis.sh
      
      # æ­¥éª¤ 26: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "26. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 26: ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh post_build_space_check
