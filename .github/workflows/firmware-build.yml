name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆæ°¸ä¹…å·¥å…·é“¾ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
          - '23.05'
          - '21.02'
      config_mode:
        description: 'âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© - ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ï¼šâœ… æ–‡ä»¶ä¼ è¾“ã€‚ ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ ã€‚'
        required: true
        type: choice
        default: 'normal'
        options:
          - 'base'
          - 'normal'
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šğŸ”´ç”¨é¡¿å·ã€åˆ†éš”ã€‚ğŸ”´ å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ğŸ”´ ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚ğŸ”´ ç¤ºä¾‹ï¼š+luci-app-wolã€+luci-app-ddns'
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)'
        required: false
        default: true
        type: boolean
      rebuild_toolchain:
        description: 'ğŸ”„ å¼ºåˆ¶é‡æ–°æ„å»ºå·¥å…·é“¾'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'ğŸ› å¯ç”¨è°ƒè¯•æ¨¡å¼ (æ˜¾ç¤ºæ›´å¤šè¯¦ç»†ä¿¡æ¯)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  TOOLCHAIN_DIR: /mnt/openwrt-toolchain
  WORKSPACE: ${{ github.workspace }}
  DEBUG_MODE: ${{ github.event.inputs.debug_mode }}

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºé…ç½®ä»“åº“ï¼ˆåŒ…å«å·¥å…·é“¾ï¼‰
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: openwrt-config
        
    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        chmod +x openwrt-config/firmware-config/scripts/*.sh
        chmod +x openwrt-config/firmware-config/scripts/toolchain_manager.sh
        
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        echo ""
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "ğŸ“Š /mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip \
          zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath \
          libpython3-dev python3 python3-dev python3-pip python3-setuptools \
          python3-yaml xsltproc zip subversion ninja-build automake autoconf \
          libtool pkg-config help2man texinfo aria2 liblz4-dev zstd \
          libcurl4-openssl-dev groff texlive texinfo cmake jq ccache \
          u-boot-tools gperf nodejs npm swig time xsltproc libxml2-utils \
          tree jq rsync

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR $TOOLCHAIN_DIR
        sudo chown -R $USER:$USER $BUILD_DIR $TOOLCHAIN_DIR
        sudo chmod -R 755 $BUILD_DIR $TOOLCHAIN_DIR
        
    - name: å¤åˆ¶é…ç½®æ–‡ä»¶
      run: |
        echo "=== å¤åˆ¶é…ç½®æ–‡ä»¶ ==="
        cp -r openwrt-config/firmware-config/scripts/* $BUILD_DIR/ 2>/dev/null || true
        cp openwrt-config/firmware-config/scripts/build_firmware_main.sh $BUILD_DIR/
        cp openwrt-config/firmware-config/scripts/toolchain_manager.sh $BUILD_DIR/
        chmod +x $BUILD_DIR/*.sh

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      id: init_env
      run: |
        echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
        cd $BUILD_DIR
        
        # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
        ./build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"
        
        # è¯»å–ç¯å¢ƒå˜é‡
        if [ -f "build_env.sh" ]; then
          echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²åˆ›å»º"
          source build_env.sh
          
          # è¾“å‡ºåˆ°GitHubç¯å¢ƒ
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "DEVICE=$DEVICE" >> $GITHUB_ENV
          echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
          
          # è¾“å‡ºåˆ°æ­¥éª¤è¾“å‡º
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_OUTPUT
          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_OUTPUT
          echo "DEVICE=$DEVICE" >> $GITHUB_OUTPUT
        else
          echo "âŒ ç¯å¢ƒæ–‡ä»¶æœªåˆ›å»ºï¼Œå°è¯•æ‰‹åŠ¨åˆ›å»º"
          # æ‰‹åŠ¨åˆ›å»ºç¯å¢ƒå˜é‡
          if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
            echo "SELECTED_BRANCH=openwrt-23.05" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=openwrt-23.05" >> $GITHUB_OUTPUT
          else
            echo "SELECTED_BRANCH=openwrt-21.02" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=openwrt-21.02" >> $GITHUB_OUTPUT
          fi
        fi

    - name: æ¢å¤å·¥å…·é“¾ï¼ˆä»ä»“åº“ï¼‰
      id: restore_toolchain
      continue-on-error: true
      run: |
        echo "=== æ¢å¤å·¥å…·é“¾ ==="
        cd $BUILD_DIR
        
        # ä½¿ç”¨å·¥å…·é“¾ç®¡ç†å™¨
        if [ -f "toolchain_manager.sh" ]; then
          ./toolchain_manager.sh restore \
            "${{ steps.init_env.outputs.SELECTED_BRANCH }}" \
            "${{ steps.init_env.outputs.TARGET }}" \
            "${{ steps.init_env.outputs.SUBTARGET }}"
          
          if [ $? -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾æ¢å¤æˆåŠŸ"
            echo "TOOLCHAIN_RESTORED=true" >> $GITHUB_ENV
          else
            echo "âŒ å·¥å…·é“¾æ¢å¤å¤±è´¥ï¼Œéœ€è¦é‡æ–°æ„å»º"
            echo "TOOLCHAIN_RESTORED=false" >> $GITHUB_ENV
          fi
        else
          echo "âŒ å·¥å…·é“¾ç®¡ç†å™¨ä¸å­˜åœ¨"
          echo "TOOLCHAIN_RESTORED=false" >> $GITHUB_ENV
        fi
        
    - name: é…ç½®Feeds
      run: |
        echo "=== é…ç½®Feeds ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh configure_feeds

    - name: æ·»åŠ TurboACCæ”¯æŒ
      if: github.event.inputs.config_mode == 'normal' && steps.init_env.outputs.SELECTED_BRANCH == 'openwrt-23.05'
      run: |
        echo "=== æ·»åŠ TurboACCæ”¯æŒ ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh add_turboacc_support

    - name: å®‰è£…æ’ä»¶åŒ…
      run: |
        echo "=== å®‰è£…æ’ä»¶åŒ… ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh install_filetransfer_packages

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      run: |
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"

    - name: éªŒè¯USBé…ç½®
      run: |
        echo "=== éªŒè¯USBé…ç½® ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh verify_usb_config

    - name: åº”ç”¨é…ç½®
      run: |
        echo "=== åº”ç”¨é…ç½® ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh apply_config

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh fix_network

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh download_dependencies

    - name: å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶
      run: |
        echo "=== å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶ ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh process_custom_files

    - name: ç¼–è¯‘å›ºä»¶
      id: build_firmware
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        cd $BUILD_DIR
        
        START_TIME=$(date +%s)
        
        # æ‰§è¡Œç¼–è¯‘
        ./build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"
        BUILD_EXIT_CODE=$?
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "â±ï¸ ç¼–è¯‘è€—æ—¶: $((DURATION / 60))åˆ†é’Ÿ $((DURATION % 60))ç§’"
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
        fi

    - name: æ„å»ºå·¥å…·é“¾ï¼ˆå¦‚éœ€ï¼‰
      if: steps.init_env.outputs.SELECTED_BRANCH != '' && (env.TOOLCHAIN_RESTORED == 'false' || github.event.inputs.rebuild_toolchain == 'true')
      run: |
        echo "=== æ„å»ºå·¥å…·é“¾ ==="
        cd $BUILD_DIR
        
        # åŠ è½½ç¯å¢ƒå˜é‡
        source build_env.sh 2>/dev/null || {
          echo "SELECTED_BRANCH=${{ steps.init_env.outputs.SELECTED_BRANCH }}"
          echo "TARGET=${{ steps.init_env.outputs.TARGET }}"
          echo "SUBTARGET=${{ steps.init_env.outputs.SUBTARGET }}"
          echo "DEVICE=${{ steps.init_env.outputs.DEVICE }}"
        }
        
        echo "ğŸ”§ æ„å»ºå·¥å…·é“¾: $SELECTED_BRANCH-$TARGET-$SUBTARGET"
        
        # åˆ›å»ºå·¥å…·é“¾é…ç½®
        cat > .config.toolchain << EOF
CONFIG_TARGET_${TARGET}=y
CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
CONFIG_TARGET_ROOTFS_INITRAMFS=y
CONFIG_TOOLCHAIN=y
CONFIG_TOOLCHAIN_BUILD=y
CONFIG_SDK=y
CONFIG_IB=y
EOF
        
        cp .config.toolchain .config
        make defconfig
        
        echo "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
        make toolchain/install -j$(nproc) V=s
        
        # ä¿å­˜å·¥å…·é“¾
        TOOLCHAIN_ID="$SELECTED_BRANCH-$TARGET-$SUBTARGET"
        mkdir -p "$TOOLCHAIN_DIR/$TOOLCHAIN_ID"
        
        # å¤åˆ¶å…³é”®æ–‡ä»¶
        if [ -d "staging_dir" ]; then
          echo "ğŸ’¾ ä¿å­˜å·¥å…·é“¾åˆ°: $TOOLCHAIN_DIR/$TOOLCHAIN_ID"
          
          # åªå¤åˆ¶å¿…è¦çš„å·¥å…·é“¾æ–‡ä»¶
          find staging_dir -name "toolchain-*" -type d | while read toolchain; do
            cp -r "$toolchain" "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/" 2>/dev/null || true
          done
          
          # ä¿å­˜é…ç½®
          cp staging_dir/.config "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/" 2>/dev/null || true
          
          # åˆ›å»ºå·¥å…·é“¾ä¿¡æ¯
          cat > "$TOOLCHAIN_DIR/$TOOLCHAIN_ID/toolchain_info.txt" << EOF
ç‰ˆæœ¬: $SELECTED_BRANCH
ç›®æ ‡: $TARGET-$SUBTARGET
è®¾å¤‡: $DEVICE
ç¼–è¯‘æ—¶é—´: $(date)
å¤§å°: $(du -sh staging_dir/toolchain-* 2>/dev/null | tail -1)
EOF
        fi

    - name: ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“
      if: always() && steps.init_env.outputs.SELECTED_BRANCH != ''
      run: |
        echo "=== ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ ==="
        cd $BUILD_DIR
        
        if [ -f "toolchain_manager.sh" ]; then
          ./toolchain_manager.sh save \
            "${{ steps.init_env.outputs.SELECTED_BRANCH }}" \
            "${{ steps.init_env.outputs.TARGET }}" \
            "${{ steps.init_env.outputs.SUBTARGET }}"
        else
          echo "âŒ å·¥å…·é“¾ç®¡ç†å™¨ä¸å­˜åœ¨"
        fi
        
    - name: æäº¤å·¥å…·é“¾åˆ°Gitä»“åº“
      if: always() && steps.init_env.outputs.SELECTED_BRANCH != ''
      run: |
        echo "=== æäº¤å·¥å…·é“¾åˆ°Gitä»“åº“ ==="
        
        # åˆ‡æ¢åˆ°ä»“åº“ç›®å½•
        cd openwrt-config
        
        # é…ç½®Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # åˆ›å»ºå·¥å…·é“¾ç›®å½•
        mkdir -p toolchain-cache
        
        # å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶
        TOOLCHAIN_ID="${{ steps.init_env.outputs.SELECTED_BRANCH }}-${{ steps.init_env.outputs.TARGET }}-${{ steps.init_env.outputs.SUBTARGET }}"
        
        if [ -d "$TOOLCHAIN_DIR/$TOOLCHAIN_ID" ]; then
          echo "ğŸ“¦ å¤åˆ¶å·¥å…·é“¾: $TOOLCHAIN_ID"
          mkdir -p "toolchain-cache/$TOOLCHAIN_ID"
          cp -r "$TOOLCHAIN_DIR/$TOOLCHAIN_ID"/* "toolchain-cache/$TOOLCHAIN_ID/" 2>/dev/null || true
          
          # æ·»åŠ å¹¶æäº¤
          git add toolchain-cache/
          git commit -m "ä¿å­˜å·¥å…·é“¾: $TOOLCHAIN_ID [skip ci]" || echo "æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          
          # æ¨é€åˆ°ä»“åº“
          git push origin HEAD || echo "æ¨é€å¤±è´¥"
        else
          echo "âŒ å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨: $TOOLCHAIN_DIR/$TOOLCHAIN_ID"
        fi

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      run: |
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh check_firmware_files

    - name: å¤‡ä»½é…ç½®æ–‡ä»¶
      if: always()
      run: |
        echo "=== å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh backup_config

    - name: ä¸Šä¼ å›ºä»¶
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ steps.init_env.outputs.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 30

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/*.log
          ${{ env.BUILD_DIR }}/config_backup/
        retention-days: 30

    - name: æ˜¾ç¤ºå·¥å…·é“¾ç»Ÿè®¡ä¿¡æ¯
      if: always()
      run: |
        echo "=== å·¥å…·é“¾ç»Ÿè®¡ä¿¡æ¯ ==="
        cd $BUILD_DIR
        
        if [ -f "toolchain_manager.sh" ]; then
          ./toolchain_manager.sh list
        fi
        
        echo ""
        echo "ğŸ“¦ å·¥å…·é“¾ä¿å­˜ä½ç½®:"
        echo "æœ¬åœ°: $TOOLCHAIN_DIR"
        echo "ä»“åº“: toolchain-cache/"
        
        if [ -d "toolchain-cache" ]; then
          echo "ä»“åº“å·¥å…·é“¾å¤§å°: $(du -sh toolchain-cache | cut -f1)"
        fi
