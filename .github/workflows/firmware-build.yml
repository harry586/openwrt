[file name]: firmware-build.yml
[file content begin]
name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆ - Git LFS ä¿®å¤ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, r3gç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      config_mode:
        description: 'âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© (åŸºç¡€/æ­£å¸¸)'
        required: true
        type: choice
        default: 'normal'
        options:
        - 'base'
        - 'normal'
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ (æ ¼å¼: +æ’ä»¶å;-æ’ä»¶å)'
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜'
        required: false
        default: true
        type: boolean
      commit_toolchain:
        description: 'ğŸ’¾ æäº¤å·¥å…·é“¾åˆ°ä»“åº“'
        required: false
        default: false
        type: boolean
      use_git_archive:
        description: 'ğŸ“¦ ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç '
        required: false
        default: false
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  GIT_LFS_SKIP_SMUDGE: 1

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç 
      if: github.event.inputs.use_git_archive == 'true'
      run: |
        echo "=== ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç  ==="
        echo "ğŸ”„ ä»GitHub APIè·å–æºä»£ç å‹ç¼©åŒ…"
        
        mkdir -p /tmp/openwrt-source
        cd /tmp/openwrt-source
        
        DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
        echo "é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
        
        echo "ä¸‹è½½æºä»£ç å‹ç¼©åŒ…..."
        curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" \
          -o source.tar.gz
        
        if [ ! -f "source.tar.gz" ]; then
          echo "âŒ ä¸‹è½½æºä»£ç å‹ç¼©åŒ…å¤±è´¥"
          exit 1
        fi
        
        echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(ls -lh source.tar.gz | awk '{print $5}')"
        
        echo "è§£å‹æºä»£ç ..."
        tar -xzf source.tar.gz --strip-components=1
        
        if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
          echo "âœ… æºä»£ç è§£å‹æˆåŠŸ"
          
          mkdir -p ${{ github.workspace }}
          rsync -av --exclude='.git' --exclude='firmware-config/Toolchain' . ${{ github.workspace }}/
          
          chmod +x ${{ github.workspace }}/firmware-config/scripts/*.sh 2>/dev/null || true
          
          echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        else
          echo "âŒ æºä»£ç è§£å‹å¤±è´¥"
          exit 1
        fi
        
        mkdir -p /tmp/build-artifacts/source-archive
        cp source.tar.gz /tmp/build-artifacts/source-archive/
        cd /tmp
        rm -rf openwrt-source
        echo "âœ… Git Archive APIä¸‹è½½å®Œæˆ"

    - name: å®‰è£… Git LFS
      if: github.event.inputs.use_git_archive == 'false'
      run: |
        echo "=== å®‰è£… Git LFS ==="
        sudo apt-get update
        sudo apt-get install -y git-lfs
        git lfs install --skip-smudge
        echo "âœ… Git LFS å®‰è£…å®Œæˆ"

    - name: æ£€å‡ºé…ç½®ä»“åº“ (å¯ç”¨ LFS)
      if: github.event.inputs.use_git_archive == 'false'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        lfs: true

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        find firmware-config/scripts -name "*.sh" -exec chmod +x {} \;
        echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"

    - name: è®¾ç½® Git LFS é…ç½®
      if: github.event.inputs.use_git_archive == 'false'
      run: |
        echo "=== è®¾ç½® Git LFS é…ç½® ==="
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global http.postBuffer 524288000
        git lfs install --force
        git lfs pull
        echo "âœ… Git LFS é…ç½®å®Œæˆ"

    - name: æ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€
      if: github.event.inputs.use_git_archive == 'false'
      run: |
        echo "=== æ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€ ==="
        firmware-config/scripts/build_firmware_main.sh check_large_files

    - name: å¼ºåˆ¶æ‹‰å–Git LFSæ–‡ä»¶
      if: github.event.inputs.use_git_archive == 'false'
      run: |
        echo "=== å¼ºåˆ¶æ‹‰å–Git LFSæ–‡ä»¶ ==="
        git lfs pull --force || echo "Git LFSæ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ„å»º..."

    - name: æ£€æŸ¥å·¥å…·é“¾ç›®å½•çŠ¶æ€
      run: |
        echo "=== æ£€æŸ¥ä»“åº“ä¸­çš„å·¥å…·é“¾çŠ¶æ€ ==="
        if [ -d "firmware-config/Toolchain" ]; then
          echo "âœ… å·¥å…·é“¾ç›®å½•å­˜åœ¨"
          echo "å·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh firmware-config/Toolchain 2>/dev/null | cut -f1 || echo '0')"
        else
          echo "â„¹ï¸  å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°ç›®å½•"
        fi

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi
        echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"

    - name: åˆå§‹åŒ–å·¥å…·é“¾ç›®å½•
      run: |
        firmware-config/scripts/build_firmware_main.sh init_toolchain_dir

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        firmware-config/scripts/build_firmware_main.sh setup_environment

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        firmware-config/scripts/build_firmware_main.sh create_build_dir

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      run: |
        echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
        echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
        firmware-config/scripts/build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"

    - name: æ·»åŠ  TurboACC æ”¯æŒ
      run: |
        firmware-config/scripts/build_firmware_main.sh add_turboacc_support

    - name: é…ç½®Feeds
      run: |
        firmware-config/scripts/build_firmware_main.sh configure_feeds

    - name: å®‰è£… TurboACC åŒ…
      if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
      run: |
        firmware-config/scripts/build_firmware_main.sh install_turboacc_packages

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh pre_build_space_check

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      run: |
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
        firmware-config/scripts/build_firmware_main.sh generate_config \
          "${{ github.event.inputs.extra_packages }}"

    - name: éªŒè¯USBé…ç½®
      run: |
        echo "=== éªŒè¯USBé…ç½® ==="
        firmware-config/scripts/build_firmware_main.sh verify_usb_config

    - name: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      run: |
        echo "=== USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity

    - name: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      run: |
        echo "=== åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
        firmware-config/scripts/build_firmware_main.sh apply_config

    - name: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
        if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
          echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
          mkdir -p firmware-config/config-backup
          backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
          cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
          echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
        else
          echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        firmware-config/scripts/build_firmware_main.sh fix_network

    - name: åŠ è½½å·¥å…·é“¾
      run: |
        echo "=== åŠ è½½å·¥å…·é“¾ ==="
        firmware-config/scripts/build_firmware_main.sh load_toolchain

    - name: ä¿®å¤å·¥å…·é“¾æƒé™
      run: |
        echo "=== ä¿®å¤å·¥å…·é“¾æƒé™ ==="
        cd ${{ env.BUILD_DIR }}
        if [ -d "staging_dir" ]; then
          echo "ä¿®å¤å·¥å…·é“¾æ–‡ä»¶æƒé™..."
          find staging_dir -type d -name "toolchain-*" | while read toolchain_dir; do
            echo "å¤„ç†å·¥å…·é“¾: $toolchain_dir"
            if [ -d "$toolchain_dir/bin" ]; then
              find "$toolchain_dir/bin" -type f -exec chmod +x {} \; 2>/dev/null || true
            fi
          done
          echo "âœ… å·¥å…·é“¾æƒé™ä¿®å¤å®Œæˆ"
        else
          echo "â„¹ï¸  æœªæ‰¾åˆ°staging_dirç›®å½•"
        fi

    - name: æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€
      run: |
        echo "=== æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€ ==="
        cd ${{ env.BUILD_DIR }}
        if [ -d "staging_dir/toolchain-"* ]; then
          echo "âœ… å·¥å…·é“¾å·²åŠ è½½"
          firmware-config/scripts/build_firmware_main.sh check_toolchain_completeness
        else
          echo "âŒ å·¥å…·é“¾æœªåŠ è½½"
          echo "å°†è‡ªåŠ¨ä¸‹è½½å·¥å…·é“¾..."
        fi

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        firmware-config/scripts/build_firmware_main.sh download_dependencies

    - name: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      run: |
        echo "=== é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
        firmware-config/scripts/build_firmware_main.sh integrate_custom_files

    - name: å‰ç½®é”™è¯¯æ£€æŸ¥
      run: |
        echo "=== å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh pre_build_error_check

    - name: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 10 ]; then
          echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          exit 1
        elif [ $AVAILABLE_GB -lt 20 ]; then
          echo "âš ï¸  è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
        else
          echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
        fi

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        echo "å¯ç”¨ç¼“å­˜: ${{ github.event.inputs.enable_cache }}"
        firmware-config/scripts/build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"

    - name: ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•
      if: success() && github.event.inputs.enable_cache == 'true'
      run: |
        echo "=== ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½• ==="
        firmware-config/scripts/build_firmware_main.sh save_toolchain
        if [ -d "firmware-config/Toolchain" ]; then
          echo "âœ… å·¥å…·é“¾å·²ä¿å­˜åˆ°ä»“åº“ç›®å½•"
        else
          echo "âŒ å·¥å…·é“¾ä¿å­˜å¤±è´¥"
        fi

    - name: å‡†å¤‡æäº¤å·¥å…·é“¾ï¼ˆä½¿ç”¨ Git LFSï¼‰
      if: success() && github.event.inputs.enable_cache == 'true' && github.event.inputs.commit_toolchain == 'true' && github.event.inputs.use_git_archive == 'false'
      run: |
        echo "=== å‡†å¤‡æäº¤å·¥å…·é“¾åˆ°ä»“åº“ï¼ˆä½¿ç”¨ Git LFSï¼‰==="
        if [ ! -d ".git" ]; then
          echo "âŒ å½“å‰ç›®å½•ä¸æ˜¯Gitä»“åº“ï¼Œè·³è¿‡å·¥å…·é“¾æäº¤"
          exit 0
        fi
        
        if [ -d "firmware-config/Toolchain" ] && [ -n "$(ls -A firmware-config/Toolchain 2>/dev/null)" ]; then
          echo "ğŸ”§ æœ‰å·¥å…·é“¾æ–‡ä»¶éœ€è¦æäº¤"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          if [ ! -f ".gitattributes" ]; then
            cp firmware-config/scripts/.gitattributes ./
          fi
          
          git lfs install --force
          git add .gitattributes
          git add firmware-config/Toolchain/
          
          if git status --porcelain | grep -q "firmware-config/Toolchain" || git status --porcelain | grep -q ".gitattributes"; then
            git commit -m "chore: æ›´æ–°å·¥å…·é“¾æ–‡ä»¶ [Git LFS]
            ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}
            ç›®æ ‡: ${{ env.TARGET }}/${{ env.SUBTARGET }}
            è®¾å¤‡: ${{ env.DEVICE }}
            æ¨¡å¼: ${{ github.event.inputs.config_mode }}
            æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            
            for i in {1..3}; do
              echo "å°è¯•æ¨é€ #$i..."
              if git push origin HEAD:${{ github.ref_name }}; then
                echo "âœ… å·¥å…·é“¾å·²æˆåŠŸæäº¤å¹¶æ¨é€åˆ°ä»“åº“"
                break
              else
                echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
                sleep 10
                if [ $i -eq 3 ]; then
                  echo "âŒ æ¨é€å¤±è´¥3æ¬¡ï¼Œè·³è¿‡å·¥å…·é“¾æäº¤"
                  exit 0
                fi
              fi
            done
          else
            echo "â„¹ï¸  æ²¡æœ‰æ–°çš„å·¥å…·é“¾æ–‡ä»¶éœ€è¦æäº¤"
          fi
        else
          echo "â„¹ï¸  æ²¡æœ‰å·¥å…·é“¾æ–‡ä»¶éœ€è¦æäº¤"
        fi

    - name: ä¿å­˜æºä»£ç ä¿¡æ¯
      if: success()
      run: |
        echo "=== ä¿å­˜æºä»£ç ä¿¡æ¯ ==="
        mkdir -p /tmp/build-artifacts/source-info
        echo "æ„å»ºä¿¡æ¯" > /tmp/build-artifacts/source-info/build_info.txt
        echo "=========" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "æ„å»ºæ—¶é—´: $(date)" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "Git Archive APIæ¨¡å¼: ${{ github.event.inputs.use_git_archive }}" >> /tmp/build-artifacts/source-info/build_info.txt
        echo "âœ… æºä»£ç ä¿¡æ¯ä¿å­˜å®Œæˆ"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      if: success()
      run: |
        echo "=== ä¸Šä¼ æ„å»ºäº§ç‰© ==="
        cd ${{ env.BUILD_DIR }}
        mkdir -p /tmp/build-artifacts
        
        if [ -d "bin/targets" ]; then
          echo "æ‰“åŒ…å›ºä»¶æ–‡ä»¶..."
          tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
          echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆ"
        fi
        
        if [ -f "build.log" ]; then
          cp build.log /tmp/build-artifacts/build.log
          echo "âœ… æ—¥å¿—æ‰“åŒ…å®Œæˆ"
        fi
        
        echo "æ„å»ºæ—¶é—´: $(date)" > /tmp/build-artifacts/build-info.txt
        echo "è®¾å¤‡: ${{ env.DEVICE }}" >> /tmp/build-artifacts/build-info.txt
        echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/build-info.txt
        echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/build-info.txt
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/build-info.txt
        
        echo "âœ… æ„å»ºäº§ç‰©å‡†å¤‡å®Œæˆ"

    - name: é”™è¯¯åˆ†æ
      if: failure()
      run: |
        echo "=== é”™è¯¯åˆ†æ ==="
        firmware-config/scripts/error_analysis.sh

    - name: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh post_build_space_check

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: success()
      run: |
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        firmware-config/scripts/build_firmware_main.sh check_firmware_files

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ æºä»£ç ä¿¡æ¯
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: source-info-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}
        path: /tmp/build-artifacts/source-info/
        retention-days: 7

    - name: ä¸Šä¼ æºä»£ç å‹ç¼©åŒ…
      if: success() && github.event.inputs.use_git_archive == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: source-archive-${{ github.event.inputs.device_name }}
        path: /tmp/build-artifacts/source-archive/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
        path: ${{ github.workspace }}/firmware-config/config-backup/
        retention-days: 7

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†ç›®å½•ä½†ä¿ç•™é…ç½®æ–‡ä»¶ ==="
        firmware-config/scripts/build_firmware_main.sh cleanup

    - name: è¾“å‡ºæœ€ç»ˆé…ç½®çŠ¶æ€
      if: always()
      run: |
        echo "=== æœ€ç»ˆé…ç½®çŠ¶æ€æ€»ç»“ ==="
        if [ -d "firmware-config/config-backup" ]; then
          backup_count=$(find firmware-config/config-backup -name "*.config" 2>/dev/null | wc -l)
          echo "âœ… ä»“åº“é…ç½®æ–‡ä»¶å¤‡ä»½: $backup_count ä¸ª"
        fi
        
        echo ""
        echo "ğŸ› ï¸ å·¥å…·é“¾çŠ¶æ€:"
        if [ -d "firmware-config/Toolchain" ]; then
          echo "âœ… å·¥å…·é“¾ç›®å½•å­˜åœ¨: firmware-config/Toolchain/"
        else
          echo "âš ï¸  å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "ğŸ“ è‡ªå®šä¹‰æ–‡ä»¶çŠ¶æ€:"
        if [ -d "firmware-config/custom-files" ]; then
          custom_count=$(find firmware-config/custom-files -type f 2>/dev/null | wc -l)
          echo "âœ… è‡ªå®šä¹‰æ–‡ä»¶: $custom_count ä¸ª"
        fi
        
        echo ""
        echo "=== æ„å»ºæµç¨‹å®Œæˆ ==="
[file content end]
