#ã€firmware-build.yml-01ã€‘
# .github/workflows/firmware-build.yml
name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§°"
        required: true
        default: "ac42u"
        type: choice
        options: ["ac42u", "cmcc_rax3000m", "netgear_3800"]
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© - ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ã€‚ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ  âœ… TCP BBRæ‹¥å¡æ§åˆ¶"
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚"
        required: false
        type: string
        default: ""
      enable_parallel:
        description: "âš¡ å¯ç”¨æ™ºèƒ½å¹¶è¡Œä¼˜åŒ– (è‡ªåŠ¨åˆ¤æ–­æœ€ä½³ä»»åŠ¡æ•°)"
        required: false
        type: boolean
        default: true

env:
  BUILD_DIR: "/mnt/openwrt-build"
  REPO_ROOT: "${{ github.workspace }}"
  ENABLE_PARALLEL: "${{ github.event.inputs.enable_parallel }}"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
#ã€firmware-build.yml-01ã€‘

#ã€firmware-build.yml-02ã€‘
    
    steps:
      # æ­¥éª¤ 0: ç”Ÿæˆæ—¶é—´æˆ³ - ä¿®å¤ç‰ˆï¼šæ·»åŠ UTC+8æ—¶åŒº
      - name: "0. ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆUTC+8æ—¶åŒºï¼‰"
        run: |
          echo "=== æ­¥éª¤ 0: ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆUTC+8æ—¶åŒºï¼‰ ==="
          
          # è®¾ç½®æ—¶åŒºä¸ºUTC+8ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          echo "è®¾ç½®æ—¶åŒºä¸ºUTC+8..."
          sudo timedatectl set-timezone Asia/Shanghai 2>/dev/null || true
          
          # ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆä½¿ç”¨ä¿®å¤åçš„å®é™…æ—¶é—´ï¼‰
          START_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          echo "ğŸ• ä¿®å¤åçš„å¼€å§‹æ—¶é—´: $START_TIME"
          
          # ç”Ÿæˆç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æˆ³
          TIMESTAMP_LOCAL=$(date +'%Y%m%d_%H%M%S')
          BASE_DATE=$(date +'%Y%m%d')
          
          # å¤šä¸ªæ—¶é—´æˆ³æ ¼å¼
          TIMESTAMP_SEC="${{ github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}-$TIMESTAMP_LOCAL"
          TIMESTAMP_DAY="${{ github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}-$BASE_DATE"
          
          echo "TIMESTAMP_SEC=$TIMESTAMP_SEC" >> $GITHUB_ENV
          echo "TIMESTAMP_DAY=$TIMESTAMP_DAY" >> $GITHUB_ENV
          echo "START_TIME=$START_TIME" >> $GITHUB_ENV
          echo "BASE_DATE=$BASE_DATE" >> $GITHUB_ENV
          
          echo "âœ… ç”Ÿæˆæ—¶é—´æˆ³:"
          echo "  ç²¾ç¡®åˆ°ç§’: $TIMESTAMP_SEC"
          echo "  ä»…åˆ°æ—¥: $TIMESTAMP_DAY"
          echo "  å¼€å§‹æ—¶é—´: $START_TIME"
          echo "ğŸ“‹ æ„å»ºé…ç½®:"
          echo "  è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "  ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "  æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "  å¹¶è¡Œä¼˜åŒ–: ${{ github.event.inputs.enable_parallel }}"
          
          echo "ğŸŸ¢ æ­¥éª¤ 0 å®Œæˆ"
#ã€firmware-build.yml-02ã€‘

#ã€firmware-build.yml-03ã€‘
      # æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç 
      - name: "1. ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        run: |
          echo "=== æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç  ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 1 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          
          # è·å–é»˜è®¤åˆ†æ”¯
          echo "ğŸ” è·å–ä»“åº“é»˜è®¤åˆ†æ”¯..."
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "âœ… é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
          
          # ä½¿ç”¨Git Archive APIä¸‹è½½å‹ç¼©åŒ…
          echo "ğŸ“¥ ä¸‹è½½æºä»£ç å‹ç¼©åŒ…..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" -o source.tar.gz
          
          if [ ! -f "source.tar.gz" ]; then
            echo "âŒ é”™è¯¯: ä¸‹è½½æºä»£ç å‹ç¼©åŒ…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(ls -lh source.tar.gz | awk '{print $5}')"
          
          # è§£å‹å‹ç¼©åŒ…
          echo "ğŸ“¦ è§£å‹æºä»£ç ..."
          tar -xzf source.tar.gz --strip-components=1
          
          # æ£€æŸ¥è§£å‹ç»“æœ
          echo "ğŸ” æ£€æŸ¥è§£å‹ç»“æœ..."
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âœ… æºä»£ç è§£å‹æˆåŠŸ"
            echo "âœ… é‡è¦æ–‡ä»¶å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
            
            # å¤åˆ¶åˆ°å·¥ä½œåŒº
            echo "ğŸ“ å¤åˆ¶æ–‡ä»¶åˆ°å·¥ä½œåŒº..."
            mkdir -p ${{ github.workspace }}
            
            # æ£€æŸ¥å¹¶åˆ é™¤ç¼–è¯‘å™¨ç›®å½•ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if [ -d "firmware-config/build-Compiler-file" ]; then
              echo "âš ï¸ å‘ç°ç¼–è¯‘å™¨ç›®å½•ï¼Œæ’é™¤ä¸å¤åˆ¶"
              rm -rf firmware-config/build-Compiler-file
            fi
            
            # ä½¿ç”¨rsyncå¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼Œæ’é™¤.gitç›®å½•
            rsync -av --exclude='.git' . ${{ github.workspace }}/
            
            # ç¡®ä¿è„šæœ¬æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
            chmod +x ${{ github.workspace }}/firmware-config/scripts/*.sh 2>/dev/null || true
            
            echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
            
            # ä¿å­˜æºä»£ç å‹ç¼©åŒ…ä½œä¸ºæ„å»ºäº§ç‰©
            mkdir -p /tmp/build-artifacts/source-archive
            cp source.tar.gz /tmp/build-artifacts/source-archive/
            echo "ğŸ“¦ æºä»£ç å·²ä¿å­˜åˆ°: /tmp/build-artifacts/source-archive/"
          else
            echo "âŒ é”™è¯¯: æºä»£ç è§£å‹å¤±è´¥ï¼Œé‡è¦æ–‡ä»¶ç¼ºå¤±"
            echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          cd /tmp
          rm -rf openwrt-source
          echo "âœ… Git Archive APIä¸‹è½½å®Œæˆï¼Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 1 å®Œæˆ"
#ã€firmware-build.yml-03ã€‘

#ã€firmware-build.yml-04ã€‘
      # æ­¥éª¤ 2: ä¸Šä¼ æºä»£ç Artifactsï¼ˆä½¿ç”¨ç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æˆ³ï¼‰
      - name: "2. ä¸Šä¼ æºä»£ç Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: source-${{ env.TIMESTAMP_SEC }}
          path: /tmp/build-artifacts/source-archive/
          retention-days: 7
          if-no-files-found: error
#ã€firmware-build.yml-04ã€‘

#ã€firmware-build.yml-05ã€‘
      # æ­¥éª¤ 3: ä¿®å¤æƒé™é—®é¢˜
      - name: "3. ä¿®å¤æƒé™é—®é¢˜"
        run: |
          echo "=== æ­¥éª¤ 3: ä¿®å¤æƒé™é—®é¢˜ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 3 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ”§ ä¿®å¤æ‰€æœ‰è„šæœ¬çš„æ‰§è¡Œæƒé™..."
          
          if [ -f "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh"
            echo "âœ… ä¿®å¤ä¸»è„šæœ¬æƒé™: firmware-config/scripts/build_firmware_main.sh"
          else
            echo "âŒ é”™è¯¯: ä¸»è„šæœ¬ä¸å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
            exit 1
          fi
          
          if [ -f "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh"
            echo "âœ… ä¿®å¤é”™è¯¯åˆ†æè„šæœ¬æƒé™: firmware-config/scripts/error_analysis.sh"
          fi
          
          # ä¿®å¤support.shæƒé™
          if [ -f "${{ github.workspace }}/support.sh" ]; then
            chmod +x "${{ github.workspace }}/support.sh"
            echo "âœ… ä¿®å¤support.shæƒé™"
          else
            echo "âŒ é”™è¯¯: support.shä¸å­˜åœ¨"
            exit 1
          fi
          
          # ä¿®å¤å…¶ä»–è„šæœ¬æƒé™
          find "${{ github.workspace }}/firmware-config/scripts" -name "*.sh" -exec chmod +x {} \;
          echo "âœ… ä¿®å¤æ‰€æœ‰è„šæœ¬æƒé™å®Œæˆ"
          echo "ğŸŸ¢ æ­¥éª¤ 3 å®Œæˆ"
#ã€firmware-build.yml-05ã€‘

#ã€firmware-build.yml-06ã€‘
      # æ­¥éª¤ 4: å®‰è£…åŸºç¡€å·¥å…·ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
      - name: "4. å®‰è£…åŸºç¡€å·¥å…·ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 4: å®‰è£…åŸºç¡€å·¥å…·ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 4 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ”„ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          sudo apt-get update -q
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: apt-get update å¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘å¿…éœ€å·¥å…· (åˆ†ç»„å®‰è£…ï¼Œæé«˜æ•ˆç‡)..."
          
          # åˆ†ç»„1: æ ¸å¿ƒç¼–è¯‘å·¥å…·
          echo "ğŸ”§ å®‰è£…æ ¸å¿ƒç¼–è¯‘å·¥å…·..."
          sudo apt-get install -y -q \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            python3-distutils \
            rsync \
            unzip \
            zlib1g-dev \
            file \
            wget \
            libelf-dev \
            cmake \
            ninja-build
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: æ ¸å¿ƒç¼–è¯‘å·¥å…·å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # åˆ†ç»„2: Pythonå’Œè„šæœ¬å·¥å…·
          echo "ğŸ å®‰è£…Pythonå’Œè„šæœ¬å·¥å…·..."
          sudo apt-get install -y -q \
            python3 \
            python3-dev \
            python3-pip \
            python3-setuptools \
            python3-yaml \
            xsltproc \
            zip \
            subversion \
            automake \
            autoconf \
            libtool \
            pkg-config \
            help2man \
            texinfo \
            groff \
            texlive \
            texinfo
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: Pythonå’Œè„šæœ¬å·¥å…·å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # åˆ†ç»„3: ç½‘ç»œå’Œä¸‹è½½å·¥å…·
          echo "ğŸŒ å®‰è£…ç½‘ç»œå’Œä¸‹è½½å·¥å…·..."
          sudo apt-get install -y -q \
            curl \
            net-tools \
            iputils-ping \
            dnsutils \
            openssh-client \
            ca-certificates \
            gnupg \
            lsb-release \
            aria2 \
            libcurl4-openssl-dev
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: ç½‘ç»œå’Œä¸‹è½½å·¥å…·å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # åˆ†ç»„4: æ–‡ä»¶ç³»ç»Ÿå·¥å…·
          echo "ğŸ’¿ å®‰è£…æ–‡ä»¶ç³»ç»Ÿå·¥å…·..."
          sudo apt-get install -y -q \
            squashfs-tools \
            dosfstools \
            e2fsprogs \
            mtools \
            parted \
            fdisk \
            gdisk \
            hdparm \
            smartmontools
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: æ–‡ä»¶ç³»ç»Ÿå·¥å…·å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # åˆ†ç»„5: è°ƒè¯•å’Œå¼€å‘å·¥å…·
          echo "ğŸ” å®‰è£…è°ƒè¯•å’Œå¼€å‘å·¥å…·..."
          sudo apt-get install -y -q \
            gdb \
            strace \
            ltrace \
            valgrind \
            binutils-dev \
            libdw-dev \
            libiberty-dev \
            ecj \
            fastjar \
            java-propose-classpath \
            libpython3-dev \
            liblz4-dev \
            zstd
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: è°ƒè¯•å’Œå¼€å‘å·¥å…·å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆï¼Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # éªŒè¯é‡è¦å·¥å…·
          echo "ğŸ” éªŒè¯é‡è¦å·¥å…·å®‰è£…..."
          echo "ğŸ“‹ æ£€æŸ¥ä»¥ä¸‹é‡è¦å·¥å…·æ˜¯å¦å®‰è£…æˆåŠŸ:"
          
          # å®šä¹‰è¦æ£€æŸ¥çš„å·¥å…·æ•°ç»„
          tools_to_check=("gcc" "g++" "make" "git" "python3" "cmake" "flex" "bison")
          missing_tools=()
          
          # æ£€æŸ¥æ¯ä¸ªå·¥å…·
          for tool in "${tools_to_check[@]}"; do
            if command -v $tool >/dev/null 2>&1; then
              echo "âœ… $tool å·²å®‰è£…: $(which $tool)"
            else
              echo "âŒ $tool æœªå®‰è£…"
              missing_tools+=("$tool")
            fi
          done
          
          if [ ${#missing_tools[@]} -gt 0 ]; then
            echo "âŒ é”™è¯¯: ä»¥ä¸‹é‡è¦å·¥å…·ç¼ºå¤±: ${missing_tools[*]}"
            exit 1
          fi
          
          echo "ğŸ” é¢å¤–æ£€æŸ¥:"
          # æ£€æŸ¥gccç‰ˆæœ¬
          if command -v gcc >/dev/null 2>&1; then
            GCC_VERSION=$(gcc --version | head -1)
            echo "ğŸ”§ ç³»ç»ŸGCCç‰ˆæœ¬: $GCC_VERSION"
            echo "ğŸ’¡ ç³»ç»ŸGCCç”¨äºç¼–è¯‘å·¥å…·é“¾ï¼ŒSDK GCCç”¨äºäº¤å‰ç¼–è¯‘å›ºä»¶"
          fi
          
          # æ£€æŸ¥makeç‰ˆæœ¬
          if command -v make >/dev/null 2>&1; then
            MAKE_VERSION=$(make --version | head -1)
            echo "ğŸ”¨ Makeç‰ˆæœ¬: $MAKE_VERSION"
          fi
          
          echo "âœ… å·¥å…·éªŒè¯å®Œæˆ"
          echo "ğŸŸ¢ æ­¥éª¤ 4 å®Œæˆ"
#ã€firmware-build.yml-06ã€‘

#ã€firmware-build.yml-07ã€‘
      # æ­¥éª¤ 5: åˆå§‹ç©ºé—´æ£€æŸ¥
      - name: "5. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 5: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          echo "ğŸ• æ£€æŸ¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 5 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ“Š /mnt åˆ†åŒºè¯¦ç»†ä¿¡æ¯:"
          df -h /mnt
          
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1 | awk '{print $1}')
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50Gï¼Œå½“å‰åªæœ‰${AVAILABLE_GB}G"
            exit 1
          else
            echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡ - ${AVAILABLE_GB}G å¯ç”¨"
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 5 å®Œæˆ"
#ã€firmware-build.yml-07ã€‘

#ã€firmware-build.yml-08ã€‘
      # æ­¥éª¤ 6: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•
      - name: "6. è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 6: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½• ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 6 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ”„ æ­¥éª¤ 6.1: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" setup_environment
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ”„ æ­¥éª¤ 6.2: åˆ›å»ºæ„å»ºç›®å½•"
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" create_build_dir
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: åˆ›å»ºæ„å»ºç›®å½•å¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ”„ æ­¥éª¤ 6.3: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
          echo "ğŸ“± è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ğŸ”„ ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "âš™ï¸ é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: åˆå§‹åŒ–æ„å»ºç¯å¢ƒå¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•è®¾ç½®å®Œæˆï¼Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 6 å®Œæˆ"
#ã€firmware-build.yml-08ã€‘

#ã€firmware-build.yml-09ã€‘
      # æ­¥éª¤ 7: ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆä¿®å¤ç‰ˆï¼‰
      - name: "7. ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆä¿®å¤ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 7: ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆä¿®å¤ç‰ˆï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 7 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸš€ å¼€å§‹ä¸‹è½½OpenWrtå®˜æ–¹SDKå·¥å…·é“¾..."
          
          # å…ˆæ£€æŸ¥ç¯å¢ƒæ–‡ä»¶æ˜¯å¦å·²ç»å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶..."
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²å­˜åœ¨ï¼ˆç”±æ­¥éª¤6.3åˆ›å»ºï¼‰"
            echo "ğŸ“Š ç¯å¢ƒæ–‡ä»¶å†…å®¹æ‘˜è¦:"
            head -15 /mnt/openwrt-build/build_env.sh
            
            # åŠ è½½ç°æœ‰ç¯å¢ƒå˜é‡
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… ä»ç°æœ‰ç¯å¢ƒæ–‡ä»¶åŠ è½½å˜é‡:"
            echo "  SELECTED_BRANCH: $SELECTED_BRANCH"
            echo "  TARGET: $TARGET"
            echo "  SUBTARGET: $SUBTARGET"
            echo "  DEVICE: $DEVICE"
            echo "  CONFIG_MODE: $CONFIG_MODE"
            echo "  REPO_ROOT: $REPO_ROOT"
            echo "  COMPILER_DIR: $COMPILER_DIR"
            echo ""
            
            echo "ğŸ’¡ ä½¿ç”¨æ­¥éª¤6.3å·²è®¾ç½®çš„ç¯å¢ƒå˜é‡è¿›è¡ŒSDKä¸‹è½½"
          else
            echo "âš ï¸ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯æ­¥éª¤6.3å¤±è´¥"
            echo "ğŸ“ é‡æ–°åˆ›å»ºç¯å¢ƒå˜é‡..."
            
            # è°ƒç”¨support.shè·å–è®¾å¤‡ä¿¡æ¯
            if [ -f "${{ github.workspace }}/support.sh" ]; then
              echo "ğŸ” è°ƒç”¨support.shè·å–è®¾å¤‡ä¿¡æ¯..."
              PLATFORM_INFO=$("${{ github.workspace }}/support.sh" get-platform "${{ github.event.inputs.device_name }}")
              if [ -n "$PLATFORM_INFO" ]; then
                TARGET=$(echo "$PLATFORM_INFO" | awk '{print $1}')
                SUBTARGET=$(echo "$PLATFORM_INFO" | awk '{print $2}')
                DEVICE="${{ github.event.inputs.device_name }}"
                echo "âœ… ä»support.shè·å–å¹³å°ä¿¡æ¯: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
              else
                echo "âŒ æ— æ³•ä»support.shè·å–å¹³å°ä¿¡æ¯"
                exit 1
              fi
            else
              echo "âŒ support.shä¸å­˜åœ¨"
              exit 1
            fi
            
            # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
            echo "#!/bin/bash" > /mnt/openwrt-build/build_env.sh
            echo "export SELECTED_REPO_URL=\"https://github.com/immortalwrt/immortalwrt.git\"" >> /mnt/openwrt-build/build_env.sh
            echo "export SELECTED_BRANCH=\"${{ github.event.inputs.version_selection == '23.05' && 'openwrt-23.05' || 'openwrt-21.02' }}\"" >> /mnt/openwrt-build/build_env.sh
            echo "export TARGET=\"$TARGET\"" >> /mnt/openwrt-build/build_env.sh
            echo "export SUBTARGET=\"$SUBTARGET\"" >> /mnt/openwrt-build/build_env.sh
            echo "export DEVICE=\"$DEVICE\"" >> /mnt/openwrt-build/build_env.sh
            echo "export CONFIG_MODE=\"${{ github.event.inputs.config_mode }}\"" >> /mnt/openwrt-build/build_env.sh
            echo "export REPO_ROOT=\"${{ github.workspace }}\"" >> /mnt/openwrt-build/build_env.sh
            echo "export COMPILER_DIR=\"\"" >> /mnt/openwrt-build/build_env.sh
            chmod +x /mnt/openwrt-build/build_env.sh
            echo "âœ… å·²åˆ›å»ºç¯å¢ƒæ–‡ä»¶"
          fi
          
          # æ‰§è¡ŒSDKä¸‹è½½
          echo "ğŸ”„ å¼€å§‹æ‰§è¡ŒSDKä¸‹è½½..."
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" initialize_compiler_env "${{ github.event.inputs.device_name }}"
          
          SDK_EXIT_CODE=$?
          if [ $SDK_EXIT_CODE -ne 0 ]; then
            echo "âŒ é”™è¯¯: SDKä¸‹è½½å¤±è´¥ï¼Œé€€å‡ºä»£ç : $SDK_EXIT_CODE"
            exit 1
          fi
          
          echo "âœ… SDKä¸‹è½½æ­¥éª¤å®Œæˆï¼Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 7 å®Œæˆ"
#ã€firmware-build.yml-09ã€‘

#ã€firmware-build.yml-10ã€‘
      # æ­¥éª¤ 8: éªŒè¯SDKä¸‹è½½ç»“æœï¼ˆä¿®å¤ç‰ˆï¼šåŠ¨æ€æ£€æŸ¥ï¼‰
      - name: "8. éªŒè¯SDKä¸‹è½½ç»“æœï¼ˆä¿®å¤ç‰ˆï¼šåŠ¨æ€æ£€æŸ¥ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 8: éªŒè¯SDKä¸‹è½½ç»“æœï¼ˆä¿®å¤ç‰ˆï¼šåŠ¨æ€æ£€æŸ¥ï¼‰ ==="
          echo "ğŸ• éªŒè¯æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯éªŒè¯
          trap 'echo "âš ï¸ æ­¥éª¤ 8 éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          echo "ğŸ” æ£€æŸ¥SDKä¸‹è½½ç»“æœ..."
          
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… ä»ç¯å¢ƒæ–‡ä»¶åŠ è½½å˜é‡: COMPILER_DIR=$COMPILER_DIR"
          else
            echo "âŒ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          # ä¿®å¤ï¼šæ£€æŸ¥COMPILER_DIRå˜é‡æŒ‡å‘çš„ç›®å½•ï¼Œè€Œä¸æ˜¯å›ºå®šçš„sdkç›®å½•
          if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
            echo "âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
            echo "ğŸ“Š SDKç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            
            # æŸ¥æ‰¾çœŸæ­£çš„GCCï¼Œæ’é™¤è™šå‡ç¼–è¯‘å™¨
            GCC_FILE=$(find "$COMPILER_DIR" -type f -executable \
              -name "*gcc" \
              ! -name "*gcc-ar" \
              ! -name "*gcc-ranlib" \
              ! -name "*gcc-nm" \
              ! -path "*dummy-tools*" \
              ! -path "*scripts*" \
              2>/dev/null | head -1)
            
            if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
              echo "âœ… æ‰¾åˆ°å¯æ‰§è¡ŒGCCç¼–è¯‘å™¨: $(basename "$GCC_FILE")"
              echo "ğŸ”§ GCCç‰ˆæœ¬æµ‹è¯•:"
              "$GCC_FILE" --version 2>&1 | head -1
              
              # åŠ¨æ€æ˜¾ç¤ºSDK GCCç‰ˆæœ¬ä¿¡æ¯
              SDK_VERSION=$("$GCC_FILE" --version 2>&1 | head -1)
              MAJOR_VERSION=$(echo "$SDK_VERSION" | grep -o "[0-9]\+" | head -1)
              
              echo "ğŸ’¡ è¿™æ˜¯OpenWrtå®˜æ–¹SDKäº¤å‰ç¼–è¯‘å™¨ï¼Œç”¨äºç¼–è¯‘ç›®æ ‡å¹³å°å›ºä»¶"
              
              if [ "$MAJOR_VERSION" = "12" ]; then
                echo "ğŸ’¡ SDK GCCç‰ˆæœ¬: 12.3.0 (OpenWrt 23.05 SDK)"
              elif [ "$MAJOR_VERSION" = "8" ]; then
                echo "ğŸ’¡ SDK GCCç‰ˆæœ¬: 8.4.0 (OpenWrt 21.02 SDK)"
              else
                echo "ğŸ’¡ SDK GCCç‰ˆæœ¬: $MAJOR_VERSION.x"
              fi
              
              echo "ğŸ’¡ ç³»ç»ŸGCC (11.4.0) ç”¨äºç¼–è¯‘å·¥å…·é“¾ï¼ŒSDK GCC ($MAJOR_VERSION.x) ç”¨äºäº¤å‰ç¼–è¯‘å›ºä»¶"
            else
              echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œçš„GCCç¼–è¯‘å™¨"
              
              # æ£€æŸ¥æ˜¯å¦æœ‰è™šå‡çš„ç¼–è¯‘å™¨
              DUMMY_GCC=$(find "$COMPILER_DIR" -type f -executable \
                -name "*gcc" \
                -path "*dummy-tools*" \
                2>/dev/null | head -1)
              
              if [ -n "$DUMMY_GCC" ]; then
                echo "âš ï¸ æ£€æµ‹åˆ°è™šå‡çš„dummy-toolsç¼–è¯‘å™¨: $DUMMY_GCC"
                echo "ğŸ’¡ è¿™æ˜¯OpenWrtæ„å»ºç³»ç»Ÿçš„å ä½ç¬¦ï¼Œä¸æ˜¯çœŸæ­£çš„ç¼–è¯‘å™¨"
              fi
            fi
          else
            echo "âŒ SDKç›®å½•ä¸å­˜åœ¨: $COMPILER_DIR"
            echo "ğŸ’¡ æ£€æŸ¥å¯èƒ½çš„SDKç›®å½•..."
            
            # å°è¯•æŸ¥æ‰¾SDKç›®å½•
            local found_dirs=$(find "/mnt/openwrt-build" -maxdepth 1 -type d -name "*sdk*" 2>/dev/null)
            if [ -n "$found_dirs" ]; then
              echo "æ‰¾åˆ°å¯èƒ½çš„SDKç›®å½•:"
              echo "$found_dirs"
              
              # ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç›®å½•
              local first_dir=$(echo "$found_dirs" | head -1)
              echo "ä½¿ç”¨ç›®å½•: $first_dir"
              COMPILER_DIR="$first_dir"
              
              # ä¿å­˜åˆ°ç¯å¢ƒæ–‡ä»¶
              echo "#!/bin/bash" > /mnt/openwrt-build/build_env.sh
              echo "export SELECTED_REPO_URL=\"https://github.com/immortalwrt/immortalwrt.git\"" >> /mnt/openwrt-build/build_env.sh
              echo "export SELECTED_BRANCH=\"$SELECTED_BRANCH\"" >> /mnt/openwrt-build/build_env.sh
              echo "export TARGET=\"$TARGET\"" >> /mnt/openwrt-build/build_env.sh
              echo "export SUBTARGET=\"$SUBTARGET\"" >> /mnt/openwrt-build/build_env.sh
              echo "export DEVICE=\"$DEVICE\"" >> /mnt/openwrt-build/build_env.sh
              echo "export CONFIG_MODE=\"$CONFIG_MODE\"" >> /mnt/openwrt-build/build_env.sh
              echo "export REPO_ROOT=\"$REPO_ROOT\"" >> /mnt/openwrt-build/build_env.sh
              echo "export COMPILER_DIR=\"$COMPILER_DIR\"" >> /mnt/openwrt-build/build_env.sh
              chmod +x /mnt/openwrt-build/build_env.sh
              echo "âœ… å·²æ›´æ–°ç¯å¢ƒæ–‡ä»¶"
            else
              echo "æœªæ‰¾åˆ°SDKç›®å½•"
            fi
          fi
          
          echo "âœ… SDKéªŒè¯å®Œæˆ"
          echo "ğŸŸ¢ æ­¥éª¤ 8 å®Œæˆ"
#ã€firmware-build.yml-10ã€‘

#ã€firmware-build.yml-11ã€‘
      # æ­¥éª¤ 9: æ·»åŠ  TurboACC æ”¯æŒ - ä¿®å¤ç‰ˆï¼šæ‰€æœ‰ç‰ˆæœ¬éƒ½æ·»åŠ 
      - name: "9. æ·»åŠ  TurboACC æ”¯æŒ"
        run: |
          echo "=== æ­¥éª¤ 9: æ·»åŠ  TurboACC æ”¯æŒ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 9 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" add_turboacc_support
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: æ·»åŠ TurboACCæ”¯æŒå¤±è´¥"
            exit 1
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 9 å®Œæˆ"
#ã€firmware-build.yml-11ã€‘

#ã€firmware-build.yml-12ã€‘
      # æ­¥éª¤ 10: é…ç½®Feeds - ä¿®å¤ç‰ˆï¼šç»Ÿä¸€å¤„ç†TurboACC
      - name: "10. é…ç½®Feeds"
        run: |
          echo "=== æ­¥éª¤ 10: é…ç½®Feeds ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 10 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" configure_feeds
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: é…ç½®Feedså¤±è´¥"
            exit 1
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 10 å®Œæˆ"
#ã€firmware-build.yml-12ã€‘

#ã€firmware-build.yml-13ã€‘
      # æ­¥éª¤ 11: å®‰è£… TurboACC åŒ… - ä¿®å¤ç‰ˆï¼šæ­£å¸¸æ¨¡å¼éƒ½å®‰è£…
      - name: "11. å®‰è£… TurboACC åŒ…"
        if: github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤ 11: å®‰è£… TurboACC åŒ… ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 11 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" install_turboacc_packages
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: å®‰è£…TurboACCåŒ…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 11 å®Œæˆ"
#ã€firmware-build.yml-13ã€‘

#ã€firmware-build.yml-14ã€‘
      # æ­¥éª¤ 12: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "12. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 12: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          echo "ğŸ• æ£€æŸ¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 12 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" pre_build_space_check
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 12 å®Œæˆ"
#ã€firmware-build.yml-14ã€‘

#ã€firmware-build.yml-15ã€‘
      # æ­¥éª¤ 13: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      - name: "13. æ™ºèƒ½é…ç½®ç”Ÿæˆ"
        run: |
          echo "=== æ­¥éª¤ 13: æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 13 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" generate_config "${{ github.event.inputs.extra_packages }}"
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: æ™ºèƒ½é…ç½®ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 13 å®Œæˆ"
#ã€firmware-build.yml-15ã€‘

#ã€firmware-build.yml-16ã€‘
      # æ­¥éª¤ 14: éªŒè¯USBé…ç½®ï¼ˆä¿®å¤ç‰ˆï¼šç²¾ç¡®åŒ¹é…ï¼‰
      - name: "14. éªŒè¯USBé…ç½®ï¼ˆä¿®å¤ç‰ˆï¼šç²¾ç¡®åŒ¹é…ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 14: éªŒè¯USBé…ç½®ï¼ˆä¿®å¤ç‰ˆï¼šç²¾ç¡®åŒ¹é…ï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯éªŒè¯
          trap 'echo "âš ï¸ æ­¥éª¤ 14 éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          cd /mnt/openwrt-build
          
          # ä½¿ç”¨ç²¾ç¡®åŒ¹é…æ£€æŸ¥USBé…ç½®
          echo "=== ğŸš¨ USBé…ç½®ç²¾ç¡®åŒ¹é…æ£€æŸ¥ ==="
          
          echo "1. ğŸŸ¢ USBæ ¸å¿ƒæ¨¡å—ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰:"
          if grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" .config; then
            echo "âœ… USBæ ¸å¿ƒ: å·²å¯ç”¨"
          else
            echo "âŒ USBæ ¸å¿ƒ: æœªå¯ç”¨"
          fi
          
          echo "2. ğŸŸ¢ USBæ§åˆ¶å™¨ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰:"
          echo "  - kmod-usb2:" $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" .config && echo "âœ…" || echo "âŒ")
          echo "  - kmod-usb3:" $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" .config && echo "âœ…" || echo "âŒ")
          echo "  - kmod-usb-xhci-hcd:" $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" .config && echo "âœ…" || echo "âŒ")
          
          echo "3. ğŸŸ¢ USBå­˜å‚¨é©±åŠ¨ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰:"
          echo "  - kmod-usb-storage:" $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" .config && echo "âœ…" || echo "âŒ")
          echo "  - kmod-scsi-core:" $(grep -q "^CONFIG_PACKAGE_kmod-scsi-core=y" .config && echo "âœ…" || echo "âŒ")
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤é…ç½®
          echo "4. ğŸŸ¢ æ£€æŸ¥é‡å¤é…ç½®:"
          duplicates=$(grep "CONFIG_PACKAGE_kmod-usb-xhci-hcd" .config | wc -l)
          if [ $duplicates -gt 1 ]; then
            echo "âš ï¸ å‘ç°é‡å¤é…ç½®: kmod-usb-xhci-hcd ($duplicates æ¬¡)"
            echo "ğŸ” æ˜¾ç¤ºæ‰€æœ‰åŒ¹é…è¡Œ:"
            grep -n "CONFIG_PACKAGE_kmod-usb-xhci-hcd" .config
          else
            echo "âœ… æ— é‡å¤é…ç½®"
          fi
          
          echo "5. ğŸŸ¢ å¹³å°ä¸“ç”¨é©±åŠ¨æ£€æŸ¥ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰:"
          if grep -q "^CONFIG_TARGET_ipq40xx=y" .config; then
            echo "ğŸ”§ æ£€æµ‹åˆ°é«˜é€šIPQ40xxå¹³å°:"
            echo "  - kmod-usb-dwc3-qcom:" $(grep -q "^CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" .config && echo "âœ…" || echo "âŒ")
            echo "  - kmod-phy-qcom-dwc3:" $(grep -q "^CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" .config && echo "âœ…" || echo "âŒ")
          fi
          
          echo "âœ… USBé…ç½®æ£€æŸ¥å®Œæˆ"
          echo "ğŸŸ¢ æ­¥éª¤ 14 å®Œæˆ"
#ã€firmware-build.yml-16ã€‘

#ã€firmware-build.yml-17ã€‘
      # æ­¥éª¤ 15: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼‰
      - name: "15. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 15: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯æ£€æŸ¥
          trap 'echo "âš ï¸ æ­¥éª¤ 15 æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          cd /mnt/openwrt-build
          
          echo "=== USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰ ==="
          
          # åŸºç¡€USBé©±åŠ¨ï¼ˆæ‰€æœ‰å¹³å°å¿…éœ€ï¼‰
          local missing_drivers=()
          local required_drivers=(
            "kmod-usb-core"
            "kmod-usb2"
            "kmod-usb-storage"
            "kmod-scsi-core"
          )
          
          echo "ğŸ” æ£€æŸ¥åŸºç¡€USBé©±åŠ¨..."
          for driver in "${required_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
              echo "âœ… $driver: å·²å¯ç”¨"
            else
              echo "âŒ $driver: æœªå¯ç”¨"
              missing_drivers+=("$driver")
            fi
          done
          
          echo ""
          echo "ğŸ” æ£€æŸ¥USB 3.0é©±åŠ¨..."
          local usb3_drivers=("kmod-usb3" "kmod-usb-xhci-hcd")
          for driver in "${usb3_drivers[@]}"; do
            if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
              echo "âœ… $driver: å·²å¯ç”¨"
            else
              echo "âš ï¸ $driver: æœªå¯ç”¨ï¼ˆå¦‚æœè®¾å¤‡æ”¯æŒUSB 3.0å¯èƒ½éœ€è¦ï¼‰"
            fi
          done
          
          echo ""
          echo "ğŸ” æ£€æŸ¥å¹³å°ä¸“ç”¨é©±åŠ¨..."
          # æ ¹æ®å¹³å°æ£€æŸ¥ä¸“ç”¨é©±åŠ¨
          if grep -q "^CONFIG_TARGET_ipq40xx=y" .config; then
            echo "ğŸ”§ æ£€æµ‹åˆ°é«˜é€šIPQ40xxå¹³å°ï¼Œæ£€æŸ¥ä¸“ç”¨é©±åŠ¨:"
            local ipq40xx_drivers=("kmod-usb-dwc3-qcom" "kmod-phy-qcom-dwc3" "kmod-usb-dwc3")
            for driver in "${ipq40xx_drivers[@]}"; do
              if grep -q "^CONFIG_PACKAGE_${driver}=y" .config; then
                echo "âœ… $driver: å·²å¯ç”¨"
              else
                echo "â„¹ï¸ $driver: æœªå¯ç”¨ï¼ˆå¯èƒ½ä¸æ˜¯å¿…éœ€ï¼‰"
              fi
            done
          fi
          
          echo ""
          echo "ğŸ“Š ç»Ÿè®¡:"
          echo "  å¿…éœ€é©±åŠ¨: ${#required_drivers[@]} ä¸ª"
          echo "  ç¼ºå¤±é©±åŠ¨: ${#missing_drivers[@]} ä¸ª"
          
          if [ ${#missing_drivers[@]} -gt 0 ]; then
            echo "âš ï¸ å‘ç°ç¼ºå¤±é©±åŠ¨: ${missing_drivers[*]}"
            echo "ğŸ’¡ å»ºè®®åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨è¿™äº›é©±åŠ¨"
          else
            echo "âœ… æ‰€æœ‰å¿…éœ€USBé©±åŠ¨éƒ½å·²å¯ç”¨"
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 15 å®Œæˆ"
#ã€firmware-build.yml-17ã€‘

#ã€firmware-build.yml-18ã€‘
      # æ­¥éª¤ 16: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…ï¼ˆå®Œæ•´ç‰ˆï¼‰- ä¿®å¤libustreamå†²çª
      - name: "16. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…ï¼ˆå®Œæ•´ç‰ˆï¼‰- ä¿®å¤libustreamå†²çª"
        run: |
          echo "=== æ­¥éª¤ 16: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…ï¼ˆå®Œæ•´ç‰ˆï¼‰- ä¿®å¤libustreamå†²çª ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 16 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          if [ -f "/mnt/openwrt-build/.config" ]; then
            cp "/mnt/openwrt-build/.config" "/mnt/openwrt-build/.config.original"
            echo "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶"
          fi
          
          # åº”ç”¨é…ç½®å‰å…ˆä¿®å¤libustreamå†²çª
          echo "ğŸ”§ åº”ç”¨é…ç½®å‰ä¿®å¤libustreamå†²çª..."
          cd /mnt/openwrt-build
          
          # å¦‚æœå­˜åœ¨libustream-opensslå’Œlibustream-wolfsslï¼Œåªä¿ç•™ä¸€ä¸ª
          if grep -q "^CONFIG_PACKAGE_libustream-openssl=y" .config && grep -q "^CONFIG_PACKAGE_libustream-wolfssl=y" .config; then
            echo "âš ï¸ å‘ç°libustream-opensslå’Œlibustream-wolfsslå†²çª"
            echo "ğŸ”§ ä¿®å¤å†²çª: ç¦ç”¨libustream-wolfssl"
            sed -i 's/^CONFIG_PACKAGE_libustream-wolfssl=y/# CONFIG_PACKAGE_libustream-wolfssl is not set/' .config
            echo "âœ… å†²çªå·²ä¿®å¤"
          fi
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" apply_config
          
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯: åº”ç”¨é…ç½®å¤±è´¥"
            exit 1
          fi
          
          echo "=== ğŸš¨ æœ€ç»ˆé…ç½®çŠ¶æ€æ£€æŸ¥ï¼ˆç²¾ç¡®åŒ¹é…ç‰ˆï¼‰==="
          if [ -f "/mnt/openwrt-build/.config" ]; then
            echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh "/mnt/openwrt-build/.config" | awk '{print $5}')"
            echo "ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < "/mnt/openwrt-build/.config")"
            
            echo ""
            echo "ğŸ”§ å…³é”®é…ç½®æ£€æŸ¥ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰:"
            echo "1. âœ… ç›®æ ‡å¹³å°é…ç½®:"
            grep "^CONFIG_TARGET_" "/mnt/openwrt-build/.config" 2>/dev/null | head -3 || true
            
            echo ""
            echo "2. âœ… USB 3.0é©±åŠ¨é…ç½®ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰:"
            echo "  - kmod-usb-xhci-hcd:" $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
            
            echo ""
            echo "3. âœ… TCP BBRæ‹¥å¡æ§åˆ¶ç®—æ³•é…ç½®:"
            echo "  - kmod-tcp-bbr:" $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
            
            echo ""
            echo "4. âœ… å…³é”®USBé©±åŠ¨çŠ¶æ€ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰:"
            echo "  - kmod-usb-core:" $(grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  - kmod-usb2:" $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  - kmod-usb3:" $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  - kmod-usb-storage:" $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  - kmod-scsi-core:" $(grep -q "^CONFIG_PACKAGE_kmod-scsi-core=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            
            echo ""
            echo "5. âœ… æ’ä»¶é…ç½®ç»Ÿè®¡ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰:"
            enabled=$(grep -c "^CONFIG_PACKAGE_.*=y" "/mnt/openwrt-build/.config" 2>/dev/null || echo "0")
            disabled=$(grep -c "^# CONFIG_PACKAGE_.* is not set" "/mnt/openwrt-build/.config" 2>/dev/null || echo "0")
            echo "   âœ… å·²å¯ç”¨æ’ä»¶: $enabled ä¸ª"
            echo "   âŒ å·²ç¦ç”¨æ’ä»¶: $disabled ä¸ª"
            
            echo ""
            echo "=== ğŸ¯ è¯¦ç»†é…ç½®çŠ¶æ€æ ‡è¯†ï¼ˆç²¾ç¡®åŒ¹é…ç‰ˆï¼‰==="
            echo "ğŸ“‹ USBé…ç½®çŠ¶æ€:"
            echo "  CONFIG_PACKAGE_kmod-usb-core:" $(grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  CONFIG_PACKAGE_kmod-usb2:" $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  CONFIG_PACKAGE_kmod-usb3:" $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  CONFIG_PACKAGE_kmod-usb-xhci-hcd:" $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  CONFIG_PACKAGE_kmod-usb-storage:" $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  CONFIG_PACKAGE_kmod-scsi-core:" $(grep -q "^CONFIG_PACKAGE_kmod-scsi-core=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            
            echo ""
            echo "ğŸ“¦ åŠŸèƒ½æ€§æ’ä»¶çŠ¶æ€:"
            echo "  TurboACC ç½‘ç»œåŠ é€Ÿ (luci-app-turboacc):" $(grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  TCP BBRæ‹¥å¡æ§åˆ¶ç®—æ³• (kmod-tcp-bbr):" $(grep -q "^CONFIG_PACKAGE_kmod-tcp-bbr=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤é…ç½®è¡Œ
            echo ""
            echo "ğŸ” æ£€æŸ¥é‡å¤é…ç½®è¡Œ:"
            duplicates=$(grep "^CONFIG_PACKAGE_kmod-usb-xhci-hcd" "/mnt/openwrt-build/.config" | wc -l)
            if [ $duplicates -gt 1 ]; then
              echo "âš ï¸ å‘ç°é‡å¤é…ç½®: kmod-usb-xhci-hcd ($duplicates æ¬¡)"
              echo "ğŸ’¡ è¿™å¯èƒ½å¯¼è‡´é…ç½®å†²çªï¼Œå»ºè®®æ¸…ç†é…ç½®æ–‡ä»¶"
            else
              echo "âœ… æ— é‡å¤é…ç½®"
            fi
            
            echo ""
            echo "ğŸ” libustreamå†²çªçŠ¶æ€:"
            echo "  libustream-openssl:" $(grep -q "^CONFIG_PACKAGE_libustream-openssl=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            echo "  libustream-wolfssl:" $(grep -q "^CONFIG_PACKAGE_libustream-wolfssl=y" "/mnt/openwrt-build/.config" 2>/dev/null && echo "âœ…" || echo "âŒ")
            
            if grep -q "^CONFIG_PACKAGE_libustream-openssl=y" "/mnt/openwrt-build/.config" && grep -q "^CONFIG_PACKAGE_libustream-wolfssl=y" "/mnt/openwrt-build/.config"; then
              echo "âš ï¸ è­¦å‘Š: libustream-opensslå’Œlibustream-wolfsslåŒæ—¶å¯ç”¨ï¼Œå¯èƒ½å¯¼è‡´å†²çª"
              echo "ğŸ’¡ å»ºè®®åªå¯ç”¨å…¶ä¸­ä¸€ä¸ª"
            fi
            
            echo ""
            echo "ğŸ¯ é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
            if [ "${{ github.event.inputs.config_mode }}" = "normal" ]; then
              echo "âœ… å½“å‰ä¸ºæ­£å¸¸æ¨¡å¼ï¼ˆå®Œæ•´åŠŸèƒ½ï¼‰"
            else
              echo "ğŸ”§ å½“å‰ä¸ºåŸºç¡€æ¨¡å¼ï¼ˆæœ€å°åŒ–é…ç½®ï¼‰"
            fi
            
            echo ""
            echo "ğŸ” é…ç½®æ‘˜è¦:"
            echo "  - ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
            echo "  - ç›®æ ‡è®¾å¤‡: $DEVICE"
            echo "  - OpenWrtç‰ˆæœ¬: $SELECTED_BRANCH"
            echo "  - é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
            echo "  - USBé©±åŠ¨: å·²å¯ç”¨æ ¸å¿ƒé©±åŠ¨"
            echo "  - æ’ä»¶æ•°é‡: $enabled ä¸ªå·²å¯ç”¨"
            
            # æ˜¾ç¤ºå‰10ä¸ªå¯ç”¨çš„æ’ä»¶ - ç²¾ç¡®åŒ¹é…
            echo ""
            echo "ğŸ“‹ å¯ç”¨çš„æ’ä»¶ (å‰10ä¸ªï¼Œç²¾ç¡®åŒ¹é…):"
            grep "^CONFIG_PACKAGE_.*=y" "/mnt/openwrt-build/.config" 2>/dev/null | head -10 | sed 's/^CONFIG_PACKAGE_//g' | sed 's/=y//g' | while read pkg; do
              echo "  âœ… $pkg"
            done
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
          echo "ğŸŸ¢ æ­¥éª¤ 16 å®Œæˆ"
#ã€firmware-build.yml-18ã€‘

#ã€firmware-build.yml-19ã€‘
      # æ­¥éª¤ 17: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ï¼ˆä¿®å¤ç‰ˆï¼šæ¸…ç†é‡å¤é…ç½®ï¼‰
      - name: "17. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ï¼ˆä¿®å¤ç‰ˆï¼šæ¸…ç†é‡å¤é…ç½®ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 17: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ï¼ˆä¿®å¤ç‰ˆï¼šæ¸…ç†é‡å¤é…ç½®ï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 17 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f "/mnt/openwrt-build/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh "/mnt/openwrt-build/.config" | awk '{print $5}')"
            echo "ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < "/mnt/openwrt-build/.config")"
            
            # æ¸…ç†é‡å¤é…ç½®
            echo "ğŸ”§ æ¸…ç†é‡å¤é…ç½®..."
            cd /mnt/openwrt-build
            
            # å¤‡ä»½æ¸…ç†å‰çš„é…ç½®æ–‡ä»¶
            cp .config .config.before_cleanup
            
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥å­˜å‚¨å”¯ä¸€çš„é…ç½®è¡Œ
            awk '!seen[$0]++' .config > .config.temp
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤è¡Œè¢«ç§»é™¤
            original_lines=$(wc -l < .config)
            unique_lines=$(wc -l < .config.temp)
            removed_lines=$((original_lines - unique_lines))
            
            if [ $removed_lines -gt 0 ]; then
              echo "âœ… æ¸…ç†äº† $removed_lines ä¸ªé‡å¤é…ç½®è¡Œ"
              mv .config.temp .config
            else
              echo "âœ… æ— é‡å¤é…ç½®è¡Œ"
              rm -f .config.temp
            fi
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
            mkdir -p "${{ github.workspace }}/firmware-config/config-backup"
            
            # å¤‡ä»½åˆ°ä»“åº“ç›®å½• - ä½¿ç”¨ç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æˆ³
            BACKUP_FILE="${{ github.workspace }}/firmware-config/config-backup/config_${{ env.TIMESTAMP_SEC }}.config"
            
            cp "/mnt/openwrt-build/.config" "$BACKUP_FILE"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $BACKUP_FILE"
            echo "ğŸ“Š å¤‡ä»½æ–‡ä»¶å¤§å°: $(ls -lh "$BACKUP_FILE" | awk '{print $5}')"
            echo "ğŸ“ å¤‡ä»½æ–‡ä»¶è¡Œæ•°: $(wc -l < "$BACKUP_FILE")"
            
            # å¦‚æœæ¸…ç†äº†é‡å¤è¡Œï¼Œä¹Ÿå¤‡ä»½æ¸…ç†å‰çš„ç‰ˆæœ¬
            if [ $removed_lines -gt 0 ]; then
              BACKUP_FILE_BEFORE="${{ github.workspace }}/firmware-config/config-backup/config_${{ env.TIMESTAMP_SEC }}_before_cleanup.config"
              cp "/mnt/openwrt-build/.config.before_cleanup" "$BACKUP_FILE_BEFORE"
              echo "âœ… æ¸…ç†å‰çš„é…ç½®æ–‡ä»¶ä¹Ÿå¤‡ä»½åˆ°: $BACKUP_FILE_BEFORE"
            fi
          else
            echo "âŒ é”™è¯¯: .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 17 å®Œæˆ"
#ã€firmware-build.yml-19ã€‘

#ã€firmware-build.yml-20ã€‘
      # æ­¥éª¤ 18: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "18. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤ 18: ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯å°è¯•ä¿®å¤
          trap 'echo "âš ï¸ æ­¥éª¤ 18 ä¿®å¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" fix_network
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 18 å®Œæˆ"
#ã€firmware-build.yml-20ã€‘

#ã€firmware-build.yml-21ã€‘
      # æ­¥éª¤ 19: ä¸‹è½½ä¾èµ–åŒ…ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
      - name: "19. ä¸‹è½½ä¾èµ–åŒ…ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 19: ä¸‹è½½ä¾èµ–åŒ…ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 19 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          echo "ğŸ”§ æ£€æŸ¥ä¾èµ–åŒ…ç›®å½•..."
          if [ ! -d "dl" ]; then
            mkdir -p dl
            echo "âœ… åˆ›å»ºä¾èµ–åŒ…ç›®å½•: dl"
          fi
          
          DEP_COUNT=$(find dl -type f 2>/dev/null | wc -l)
          echo "ğŸ“Š å½“å‰ä¾èµ–åŒ…æ•°é‡: $DEP_COUNT ä¸ª"
          
          echo "ğŸš€ å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¯ç”¨å¹¶è¡Œä¸‹è½½ï¼‰..."
          # ä½¿ç”¨å¹¶è¡Œä¸‹è½½åŠ é€Ÿï¼Œè®¾ç½®è¾“å‡ºç¼“å†²åŒºæ›´å¤§é˜²æ­¢stdouté”™è¯¯
          stdbuf -oL -eL make -j4 download V=s 2>&1 | tee download.log
          
          DOWNLOAD_EXIT_CODE=${PIPESTATUS[0]}
          if [ $DOWNLOAD_EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ è­¦å‘Š: ä¾èµ–åŒ…ä¸‹è½½è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œé€€å‡ºä»£ç : $DOWNLOAD_EXIT_CODE"
            echo "ğŸ’¡ æŸ¥çœ‹ä¸‹è½½æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯:"
            grep -i "error\|failed\|404\|not found" download.log | head -10 || true
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # æ£€æŸ¥ä¸‹è½½ç»“æœ
          NEW_DEP_COUNT=$(find dl -type f 2>/dev/null | wc -l)
          echo "ğŸ“Š ä¸‹è½½åä¾èµ–åŒ…æ•°é‡: $NEW_DEP_COUNT ä¸ª"
          echo "ğŸ“ˆ æ–°å¢ä¾èµ–åŒ…: $((NEW_DEP_COUNT - DEP_COUNT)) ä¸ª"
          
          echo "ğŸŸ¢ æ­¥éª¤ 19 å®Œæˆ"
#ã€firmware-build.yml-21ã€‘

#ã€firmware-build.yml-22ã€‘
      # æ­¥éª¤ 20: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ï¼ˆå¢å¼ºç‰ˆï¼‰
      - name: "20. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ï¼ˆå¢å¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 20: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ï¼ˆå¢å¼ºç‰ˆï¼‰==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯å°è¯•é›†æˆ
          trap 'echo "âš ï¸ æ­¥éª¤ 20 é›†æˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          echo "ğŸ” æ£€æŸ¥è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•..."
          CUSTOM_DIR="${{ github.workspace }}/firmware-config/custom-files"
          
          if [ -d "$CUSTOM_DIR" ]; then
            echo "âœ… è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•å­˜åœ¨: $CUSTOM_DIR"
            
            # é€’å½’æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶
            echo "ğŸ“ é€’å½’æŸ¥æ‰¾æ‰€æœ‰è‡ªå®šä¹‰æ–‡ä»¶..."
            
            # å®šä¹‰è‹±æ–‡æ–‡ä»¶åæ£€æŸ¥å‡½æ•° - ä¿®å¤æ­£åˆ™è¡¨è¾¾å¼
            is_english_name() {
              local filename="$1"
              if [[ "$filename" =~ ^[a-zA-Z0-9_.\-]+$ ]]; then
                return 0  # è‹±æ–‡æ–‡ä»¶å
              else
                return 1  # éè‹±æ–‡æ–‡ä»¶å
              fi
            }
            
            # é€’å½’æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶
            ALL_FILES=$(find "$CUSTOM_DIR" -type f 2>/dev/null | sort)
            FILE_COUNT=$(echo "$ALL_FILES" | wc -l)
            
            if [ $FILE_COUNT -eq 0 ]; then
              echo "â„¹ï¸ ç›®å½•ä¸ºç©º"
            else
              echo "ğŸ“Š æ‰¾åˆ° $FILE_COUNT ä¸ªè‡ªå®šä¹‰æ–‡ä»¶"
              
              # åˆ†ç±»ç»Ÿè®¡
              IPK_COUNT=0
              SCRIPT_COUNT=0
              CONFIG_COUNT=0
              OTHER_COUNT=0
              ENGLISH_COUNT=0
              NON_ENGLISH_COUNT=0
              
              # è¯¦ç»†æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶
              echo ""
              echo "ğŸ“‹ è¯¦ç»†æ–‡ä»¶åˆ—è¡¨:"
              echo "================================================"
              
              while IFS= read -r file; do
                [ -z "$file" ] && continue
                
                REL_PATH="${file#$CUSTOM_DIR/}"
                FILE_NAME=$(basename "$file")
                FILE_SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                
                # æ£€æŸ¥æ˜¯å¦ä¸ºè‹±æ–‡æ–‡ä»¶å - ä½¿ç”¨ä¿®å¤ç‰ˆæ£€æµ‹
                if is_english_name "$FILE_NAME"; then
                  NAME_STATUS="âœ… è‹±æ–‡"
                  ENGLISH_COUNT=$((ENGLISH_COUNT + 1))
                else
                  NAME_STATUS="âš ï¸ éè‹±æ–‡"
                  NON_ENGLISH_COUNT=$((NON_ENGLISH_COUNT + 1))
                fi
                
                # æ–‡ä»¶ç±»å‹ç»Ÿè®¡
                if [[ "$FILE_NAME" =~ \.ipk$ ]] || [[ "$FILE_NAME" =~ \.IPK$ ]] || [[ "$FILE_NAME" =~ \.Ipk$ ]]; then
                  TYPE_DESC="ğŸ“¦ IPKåŒ…"
                  IPK_COUNT=$((IPK_COUNT + 1))
                elif [[ "$FILE_NAME" =~ \.sh$ ]] || [[ "$FILE_NAME" =~ \.Sh$ ]] || [[ "$FILE_NAME" =~ \.SH$ ]]; then
                  TYPE_DESC="ğŸ“œ è„šæœ¬"
                  SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
                elif [[ "$FILE_NAME" =~ \.conf$ ]] || [[ "$FILE_NAME" =~ \.config$ ]] || [[ "$FILE_NAME" =~ \.CONF$ ]]; then
                  TYPE_DESC="âš™ï¸ é…ç½®"
                  CONFIG_COUNT=$((CONFIG_COUNT + 1))
                else
                  TYPE_DESC="ğŸ“ å…¶ä»–"
                  OTHER_COUNT=$((OTHER_COUNT + 1))
                fi
                
                printf "%-45s %-8s %-12s %s\n" "$REL_PATH" "$FILE_SIZE" "$TYPE_DESC" "$NAME_STATUS"
                
              done <<< "$ALL_FILES"
              
              echo "================================================"
              
              # ç»Ÿè®¡ä¿¡æ¯
              echo ""
              echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
              echo "  æ–‡ä»¶æ€»æ•°: $FILE_COUNT ä¸ª"
              echo "  ğŸ“¦ IPKæ–‡ä»¶: $IPK_COUNT ä¸ª"
              echo "  ğŸ“œ è„šæœ¬æ–‡ä»¶: $SCRIPT_COUNT ä¸ª"
              echo "  âš™ï¸ é…ç½®æ–‡ä»¶: $CONFIG_COUNT ä¸ª"
              echo "  ğŸ“ å…¶ä»–æ–‡ä»¶: $OTHER_COUNT ä¸ª"
              echo "  âœ… è‹±æ–‡æ–‡ä»¶å: $ENGLISH_COUNT ä¸ª"
              echo "  âš ï¸ éè‹±æ–‡æ–‡ä»¶å: $NON_ENGLISH_COUNT ä¸ª"
              
              # æ–‡ä»¶åå»ºè®® - ç®€åŒ–ç‰ˆæœ¬
              if [ $NON_ENGLISH_COUNT -gt 0 ]; then
                echo ""
                echo "ğŸ’¡ æ–‡ä»¶åå…¼å®¹æ€§å»ºè®®:"
                echo "  ä¸ºäº†æ›´å¥½çš„å…¼å®¹æ€§ï¼Œæ–¹ä¾¿å¤åˆ¶ã€è¿è¡Œï¼Œå»ºè®®ä½¿ç”¨è‹±æ–‡æ–‡ä»¶å"
                echo "  å½“å‰ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†éè‹±æ–‡æ–‡ä»¶åï¼Œä½†è‹±æ–‡åæœ‰æ›´å¥½çš„å…¼å®¹æ€§"
              fi
              
              echo ""
              echo "ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªå®šä¹‰æ–‡ä»¶é›†æˆï¼ˆå¢å¼ºç‰ˆï¼‰..."
              "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" integrate_custom_files
              
              # éªŒè¯é›†æˆç»“æœ
              echo ""
              echo "ğŸ” éªŒè¯é›†æˆç»“æœ..."
              cd /mnt/openwrt-build
              
              # æ£€æŸ¥è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•
              if [ -d "files/etc/custom-files" ]; then
                echo "âœ… è‡ªå®šä¹‰æ–‡ä»¶å·²å¤åˆ¶åˆ°: files/etc/custom-files"
                
                # ç»Ÿè®¡å¤åˆ¶åçš„æ–‡ä»¶
                FINAL_FILES=$(find "files/etc/custom-files" -type f 2>/dev/null | wc -l)
                echo "ğŸ“Š å¤åˆ¶åæ–‡ä»¶æ€»æ•°: $FINAL_FILES ä¸ª"
                
                # æ˜¾ç¤ºç›®å½•ç»“æ„ - æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶
                if [ $FINAL_FILES -gt 0 ]; then
                  echo "ğŸ“ å¤åˆ¶åçš„æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨:"
                  find "files/etc/custom-files" -type f 2>/dev/null | while read file; do
                    REL_PATH="${file#files/etc/custom-files/}"
                    FILE_SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                    echo "  ğŸ“„ $REL_PATH ($FILE_SIZE)"
                  done
                fi
                
                # æ£€æŸ¥å¯åŠ¨è„šæœ¬
                if [ -f "files/etc/uci-defaults/99-custom-files" ]; then
                  echo "âœ… ç¬¬ä¸€æ¬¡å¼€æœºå¯åŠ¨è„šæœ¬: files/etc/uci-defaults/99-custom-files"
                  echo "ğŸ“ è„šæœ¬å¢å¼ºåŠŸèƒ½:"
                  echo "  - âœ… é€’å½’æŸ¥æ‰¾æ‰€æœ‰è‡ªå®šä¹‰æ–‡ä»¶"
                  echo "  - âœ… ä¿æŒåŸæ–‡ä»¶å"
                  echo "  - âœ… IPKå®‰è£…é”™è¯¯ä¸é€€å‡ºï¼Œç»§ç»­ä¸‹ä¸€ä¸ª"
                  echo "  - âœ… è¯¦ç»†æ—¥å¿—è®°å½•æ¯ä¸ªæ–‡ä»¶çš„å¤„ç†ç»“æœ"
                  echo "  - âœ… åˆ†ç±»ç»Ÿè®¡å’ŒæˆåŠŸç‡è®¡ç®—"
                  echo "  - âœ… æ—¥å¿—å­˜å‚¨åˆ° /root/logs/ ç›®å½•ï¼ˆé‡å¯ä¸ä¸¢å¤±ï¼‰"
                fi
                
                # æ£€æŸ¥æ–‡ä»¶åæ£€æŸ¥è„šæœ¬
                if [ -f "files/etc/custom-files/check_filenames.sh" ]; then
                  echo "âœ… æ–‡ä»¶åæ£€æŸ¥è„šæœ¬: files/etc/custom-files/check_filenames.sh"
                fi
                
                echo ""
                echo "ğŸ¯ å¢å¼ºç‰ˆåŠŸèƒ½è¯´æ˜:"
                echo "  ğŸ”§ é€’å½’æŸ¥æ‰¾: æ”¯æŒè‡ªå®šä¹‰ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•"
                echo "  ğŸ“ ä¿æŒåŸæ–‡ä»¶å: ä¸è‡ªåŠ¨é‡å‘½åï¼Œä¿æŒç”¨æˆ·è®¾ç½®çš„æ–‡ä»¶å"
                echo "  ğŸ”„ é”™è¯¯ä¸é€€å‡º: IPKå®‰è£…å¤±è´¥ç»§ç»­å®‰è£…ä¸‹ä¸€ä¸ª"
                echo "  ğŸ“Š è¯¦ç»†æ—¥å¿—: è®°å½•æ¯ä¸ªæ–‡ä»¶çš„å¤„ç†ç»“æœå’Œç»Ÿè®¡ä¿¡æ¯"
                echo "  ğŸ“ æŒä¹…æ—¥å¿—: æ—¥å¿—å­˜å‚¨åœ¨ /root/logs/ï¼ˆé‡å¯ä¸ä¸¢å¤±ï¼‰"
                
                if [ $NON_ENGLISH_COUNT -gt 0 ]; then
                  echo ""
                  echo "âš ï¸ æ–‡ä»¶åå…¼å®¹æ€§æé†’:"
                  echo "  å½“å‰æœ‰ $NON_ENGLISH_COUNT ä¸ªæ–‡ä»¶ä½¿ç”¨éè‹±æ–‡æ–‡ä»¶å"
                  echo "  ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ï¼Œä½†å»ºè®®æ”¹ä¸ºè‹±æ–‡æ–‡ä»¶å"
                  echo "  å¯ä»¥åœ¨å›ºä»¶å¯åŠ¨åè¿è¡Œ: /etc/custom-files/check_filenames.sh"
                fi
                
              else
                echo "âŒ æœªæ‰¾åˆ°è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•"
              fi
              
            fi
            
            echo ""
            echo "ğŸ‰ è‡ªå®šä¹‰æ–‡ä»¶é›†æˆå®Œæˆ"
            echo "ğŸ’¡ è‡ªå®šä¹‰æ–‡ä»¶å°†åœ¨ç¬¬ä¸€æ¬¡å¼€æœºæ—¶è‡ªåŠ¨å®‰è£…å’Œè¿è¡Œ"
            echo "ğŸ“Œ å®‰è£…é¡ºåº: IPKåŒ… â†’ è„šæœ¬æ–‡ä»¶ â†’ å…¶ä»–æ–‡ä»¶"
            echo "ğŸ”§ é”™è¯¯å¤„ç†: å•ä¸ªæ–‡ä»¶å®‰è£…å¤±è´¥ä¸ä¼šå½±å“å…¶ä»–æ–‡ä»¶"
            echo "ğŸ“ æ—¥å¿—ä½ç½®: /root/logs/ï¼ˆé‡å¯ä¸ä¸¢å¤±ï¼‰"
            
          else
            echo "â„¹ï¸ è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨: $CUSTOM_DIR"
            echo "ğŸ“ è·³è¿‡è‡ªå®šä¹‰æ–‡ä»¶é›†æˆ"
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 20 å®Œæˆ"
#ã€firmware-build.yml-22ã€‘

#ã€firmware-build.yml-23ã€‘
      # æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼šç²¾ç¡®æ£€æŸ¥ï¼‰
      - name: "21. å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼šç²¾ç¡®æ£€æŸ¥ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼šç²¾ç¡®æ£€æŸ¥ï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 21 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: SELECTED_BRANCH=$SELECTED_BRANCH, TARGET=$TARGET"
          fi
          
          echo "ğŸš€ æ‰§è¡Œå‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆç²¾ç¡®æ£€æŸ¥ç‰ˆï¼‰..."
          
          cd /mnt/openwrt-build
          
          echo "=== ğŸš¨ ç²¾ç¡®é”™è¯¯æ£€æŸ¥ ==="
          
          local error_count=0
          local warning_count=0
          
          # 1. æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
          echo "1. âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥:"
          if [ -f ".config" ]; then
            echo "  âœ… .config æ–‡ä»¶å­˜åœ¨"
            echo "  ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh .config | awk '{print $5}')"
            echo "  ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < .config)"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤é…ç½®
            local duplicates=$(grep "^CONFIG_PACKAGE_kmod-usb-xhci-hcd" .config | wc -l)
            if [ $duplicates -gt 1 ]; then
              echo "  âš ï¸ å‘ç°é‡å¤é…ç½®: kmod-usb-xhci-hcd ($duplicates æ¬¡)"
              warning_count=$((warning_count + 1))
            fi
            
            # æ£€æŸ¥libustreamå†²çª
            local has_openssl=$(grep -c "^CONFIG_PACKAGE_libustream-openssl=y" .config)
            local has_wolfssl=$(grep -c "^CONFIG_PACKAGE_libustream-wolfssl=y" .config)
            if [ $has_openssl -gt 0 ] && [ $has_wolfssl -gt 0 ]; then
              echo "  âš ï¸ å‘ç°libustream-opensslå’Œlibustream-wolfsslå†²çª"
              warning_count=$((warning_count + 1))
            fi
            
          else
            echo "  âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            error_count=$((error_count + 1))
          fi
          
          # 2. æ£€æŸ¥SDKç›®å½•ï¼ˆä½¿ç”¨COMPILER_DIRå˜é‡ï¼‰
          echo ""
          echo "2. âœ… SDKç›®å½•æ£€æŸ¥:"
          if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
            echo "  âœ… SDKç›®å½•å­˜åœ¨: $COMPILER_DIR"
            echo "  ğŸ“Š ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            
            # æ£€æŸ¥GCCç¼–è¯‘å™¨
            local gcc_file=$(find "$COMPILER_DIR" -type f -executable \
              -name "*gcc" \
              ! -name "*gcc-ar" \
              ! -name "*gcc-ranlib" \
              ! -name "*gcc-nm" \
              ! -path "*dummy-tools*" \
              ! -path "*scripts*" \
              2>/dev/null | head -1)
            
            if [ -n "$gcc_file" ]; then
              echo "  âœ… æ‰¾åˆ°GCCç¼–è¯‘å™¨: $(basename "$gcc_file")"
            else
              echo "  âš ï¸ æœªæ‰¾åˆ°çœŸæ­£çš„GCCç¼–è¯‘å™¨"
              warning_count=$((warning_count + 1))
            fi
            
          else
            echo "  âŒ SDKç›®å½•ä¸å­˜åœ¨: $COMPILER_DIR"
            error_count=$((error_count + 1))
          fi
          
          # 3. æ£€æŸ¥feeds
          echo ""
          echo "3. âœ… Feedsæ£€æŸ¥:"
          if [ -d "feeds" ]; then
            echo "  âœ… feeds ç›®å½•å­˜åœ¨"
          else
            echo "  âŒ feeds ç›®å½•ä¸å­˜åœ¨"
            error_count=$((error_count + 1))
          fi
          
          # 4. æ£€æŸ¥ä¾èµ–åŒ…
          echo ""
          echo "4. âœ… ä¾èµ–åŒ…æ£€æŸ¥:"
          if [ -d "dl" ]; then
            local dl_count=$(find dl -type f 2>/dev/null | wc -l)
            echo "  âœ… dl ç›®å½•å­˜åœ¨ï¼Œæ–‡ä»¶æ•°: $dl_count ä¸ª"
          else
            echo "  âš ï¸ dl ç›®å½•ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦ä¸‹è½½ä¾èµ–"
            warning_count=$((warning_count + 1))
          fi
          
          # 5. æ£€æŸ¥ç£ç›˜ç©ºé—´
          echo ""
          echo "5. âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥:"
          local available_space=$(df /mnt --output=avail | tail -1 | awk '{print $1}')
          local available_gb=$((available_space / 1024 / 1024))
          echo "  ğŸ“Š /mnt å¯ç”¨ç©ºé—´: ${available_gb}G"
          
          if [ $available_gb -lt 10 ]; then
            echo "  âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${available_gb}G)"
            error_count=$((error_count + 1))
          elif [ $available_gb -lt 20 ]; then
            echo "  âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${available_gb}G)"
            warning_count=$((warning_count + 1))
          else
            echo "  âœ… ç£ç›˜ç©ºé—´å……è¶³"
          fi
          
          # æ€»ç»“
          echo ""
          echo "=== ğŸ¯ æ£€æŸ¥ç»“æœ ==="
          echo "  é”™è¯¯æ•°é‡: $error_count ä¸ª"
          echo "  è­¦å‘Šæ•°é‡: $warning_count ä¸ª"
          
          if [ $error_count -eq 0 ]; then
            if [ $warning_count -eq 0 ]; then
              echo "âœ… å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘"
            else
              echo "âš ï¸ å‰ç½®æ£€æŸ¥é€šè¿‡ï¼Œä½†æœ‰ $warning_count ä¸ªè­¦å‘Šï¼Œå»ºè®®ä¿®å¤"
            fi
          else
            echo "âŒ å‰ç½®æ£€æŸ¥å‘ç° $error_count ä¸ªé”™è¯¯ï¼Œ$warning_count ä¸ªè­¦å‘Š"
            echo "ğŸ’¡ è¯·ä¿®å¤é”™è¯¯åå†ç¼–è¯‘"
            exit 1
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 21 å®Œæˆ"
#ã€firmware-build.yml-23ã€‘

#ã€firmware-build.yml-24ã€‘
      # æ­¥éª¤ 22: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "22. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 22: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          echo "ğŸ• æ£€æŸ¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 22 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          df -h /mnt
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1 | awk '{print $1}')
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${available_gb}G)"
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 22 å®Œæˆ"
#ã€firmware-build.yml-24ã€‘

#ã€firmware-build.yml-25ã€‘
      # æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶ï¼ˆæ™ºèƒ½å¹¶è¡Œä¼˜åŒ–ç‰ˆï¼‰
      - name: "23. ç¼–è¯‘å›ºä»¶ï¼ˆæ™ºèƒ½å¹¶è¡Œä¼˜åŒ–ç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶ï¼ˆæ™ºèƒ½å¹¶è¡Œä¼˜åŒ–ç‰ˆï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          # è·å–ç³»ç»Ÿä¿¡æ¯
          CPU_CORES=$(nproc)
          TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
          
          echo "ğŸ”§ ç³»ç»Ÿä¿¡æ¯:"
          echo "  CPUæ ¸å¿ƒæ•°: $CPU_CORES"
          echo "  å†…å­˜å¤§å°: ${TOTAL_MEM}MB"
          echo "  å¹¶è¡Œä¼˜åŒ–: ${{ env.ENABLE_PARALLEL }}"
          
          # æ™ºèƒ½åˆ¤æ–­æœ€ä½³å¹¶è¡Œä»»åŠ¡æ•° - ä¼˜åŒ–ç‰ˆ
          if [ "${{ env.ENABLE_PARALLEL }}" = "true" ]; then
            echo "ğŸ§  æ™ºèƒ½åˆ¤æ–­æœ€ä½³å¹¶è¡Œä»»åŠ¡æ•°..."
            
            # GitHub Actions Runner ä¼˜åŒ–é…ç½®
            if [ $CPU_CORES -ge 4 ]; then
              if [ $TOTAL_MEM -ge 8000 ]; then
                MAKE_JOBS=4
                echo "âœ… æ£€æµ‹åˆ°é«˜æ€§èƒ½Runner (4æ ¸+8GB)"
              else
                MAKE_JOBS=3
                echo "âœ… æ£€æµ‹åˆ°æ ‡å‡†Runner (4æ ¸)"
              fi
            elif [ $CPU_CORES -ge 2 ]; then
              if [ $TOTAL_MEM -ge 7000 ]; then
                MAKE_JOBS=3
                echo "âœ… æ£€æµ‹åˆ°GitHubæ ‡å‡†Runner (2æ ¸7GB)"
              else
                MAKE_JOBS=2
                echo "âœ… æ£€æµ‹åˆ°2æ ¸Runner"
              fi
            else
              MAKE_JOBS=2
              echo "âš ï¸ æ£€æµ‹åˆ°å•æ ¸Runner"
            fi
            
            echo "ğŸ¯ å†³å®šä½¿ç”¨ $MAKE_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡"
          else
            MAKE_JOBS=1
            echo "ğŸ”„ ç¦ç”¨å¹¶è¡Œä¼˜åŒ–ï¼Œä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘"
          fi
          
          echo ""
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶"
          echo "ğŸ’¡ ç¼–è¯‘é…ç½®:"
          echo "  - å¹¶è¡Œä»»åŠ¡: $MAKE_JOBS"
          echo "  - è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "  - ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "  - é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "  - å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡
          export FORCE_UNSAFE_CONFIGURE=1
          
          # å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨stdbufé˜²æ­¢stdouté”™è¯¯
          START_TIME=$(date +%s)
          stdbuf -oL -eL time make -j$MAKE_JOBS V=s 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "ğŸ“Š ç¼–è¯‘ç»Ÿè®¡:"
          echo "  - æ€»è€—æ—¶: $((DURATION / 60))åˆ†é’Ÿ$((DURATION % 60))ç§’"
          echo "  - é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
            
            if [ -d "bin/targets" ]; then
              FIRMWARE_COUNT=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
              echo "âœ… ç”Ÿæˆå›ºä»¶æ–‡ä»¶: $FIRMWARE_COUNT ä¸ª"
              
              # æ˜¾ç¤ºå‰3ä¸ªå›ºä»¶æ–‡ä»¶
              echo "ğŸ“ ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ (å‰3ä¸ª):"
              find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | head -3 | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                echo "  ğŸ“„ $(basename "$file") ($SIZE)"
              done
            fi
          else
            echo "âŒ é”™è¯¯: ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
            echo "ğŸ” ç¼–è¯‘æ—¥å¿—ä¸­çš„é”™è¯¯æ‘˜è¦:"
            grep -i "error\|failed" build.log | tail -20 || true
            exit $BUILD_EXIT_CODE
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 23 å®Œæˆ"
#ã€firmware-build.yml-25ã€‘

#ã€firmware-build.yml-26ã€‘
      # æ­¥éª¤ 24: æ£€æŸ¥æ„å»ºäº§ç‰©ï¼ˆä¿®å¤ç‰ˆï¼‰
      - name: "24. æ£€æŸ¥æ„å»ºäº§ç‰©ï¼ˆä¿®å¤ç‰ˆï¼‰"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 24: æ£€æŸ¥æ„å»ºäº§ç‰©ï¼ˆä¿®å¤ç‰ˆï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 24 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          if [ -d "bin/targets" ]; then
            echo "âœ… æ‰¾åˆ°å›ºä»¶ç›®å½•"
            
            # ç»Ÿè®¡å„ç§ç±»å‹æ–‡ä»¶
            FIRMWARE_COUNT=0
            PACKAGE_COUNT=0
            OTHER_COUNT=0
            
            # è®¡ç®—æ–‡ä»¶æ•°é‡
            echo "ğŸ“Š æ­£åœ¨ç»Ÿè®¡æ–‡ä»¶..."
            
            # ç»Ÿè®¡å›ºä»¶æ–‡ä»¶ï¼ˆ.binå’Œ.imgï¼‰
            FIRMWARE_COUNT=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
            
            # ç»Ÿè®¡åŒ…æ–‡ä»¶ï¼ˆ.gzå’Œ.ipkï¼‰
            PACKAGE_COUNT=$(find bin/targets -type f \( -name "*.gz" -o -name "*.ipk" \) 2>/dev/null | wc -l)
            
            # ç»Ÿè®¡å…¶ä»–æ–‡ä»¶ï¼ˆæ’é™¤ä¸Šé¢ä¸¤ç§ç±»å‹ï¼‰
            OTHER_COUNT=$(find bin/targets -type f 2>/dev/null | wc -l)
            OTHER_COUNT=$((OTHER_COUNT - FIRMWARE_COUNT - PACKAGE_COUNT))
            
            echo "=========================================="
            echo "ğŸ“ˆ æ„å»ºäº§ç‰©ç»Ÿè®¡:"
            echo "  å›ºä»¶æ–‡ä»¶: $FIRMWARE_COUNT ä¸ª (.bin/.img)"
            echo "  åŒ…æ–‡ä»¶: $PACKAGE_COUNT ä¸ª (.gz/.ipk)"
            echo "  å…¶ä»–æ–‡ä»¶: $OTHER_COUNT ä¸ª"
            echo "  æ€»æ–‡ä»¶æ•°: $((FIRMWARE_COUNT + PACKAGE_COUNT + OTHER_COUNT)) ä¸ª"
            echo ""
            
            # æ˜¾ç¤ºæ‰€æœ‰å›ºä»¶æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯
            if [ $FIRMWARE_COUNT -gt 0 ]; then
              echo "ğŸ“ å›ºä»¶æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
              echo "------------------------------------------"
              find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                FULL_SIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
                FILE_NAME=$(basename "$file")
                FILE_PATH=$(echo "$file" | sed "s|/mnt/openwrt-build/||")
                
                echo "ğŸ¯ æ–‡ä»¶: $FILE_NAME"
                echo "  å¤§å°: $SIZE ($FULL_SIZE å­—èŠ‚)"
                echo "  è·¯å¾„: $FILE_PATH"
                
                # åˆ¤æ–­æ–‡ä»¶ç±»å‹
                if [[ "$FILE_NAME" == *factory* ]]; then
                  echo "  ç±»å‹: ğŸ­ å·¥å‚å›ºä»¶ (ç”¨äºé¦–æ¬¡åˆ·æœº)"
                elif [[ "$FILE_NAME" == *sysupgrade* ]]; then
                  echo "  ç±»å‹: ğŸ”„ ç³»ç»Ÿå‡çº§å›ºä»¶ (ç”¨äºå·²å®‰è£…OpenWrtçš„è®¾å¤‡)"
                elif [[ "$FILE_NAME" == *initramfs* ]]; then
                  echo "  ç±»å‹: ğŸš€ å†…å­˜å¯åŠ¨å›ºä»¶ (ç”¨äºæµ‹è¯•å’Œæ•‘æ´)"
                else
                  echo "  ç±»å‹: ğŸ”§ æ™®é€šå›ºä»¶"
                fi
                
                echo ""
              done
            else
              echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶ (.bin/.img)"
              echo "ğŸ” ç›®å½•å†…å®¹ (å‰10ä¸ªæ–‡ä»¶):"
              find bin/targets -type f 2>/dev/null | head -10 | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                echo "  ğŸ“„ $(basename "$file") ($SIZE)"
              done
            fi
            
            # è®¡ç®—æ€»å¤§å°
            echo "ğŸ“ å¤§å°ç»Ÿè®¡:"
            TOTAL_SIZE=0
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
              SIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
              TOTAL_SIZE=$((TOTAL_SIZE + SIZE))
            done
            
            if [ $TOTAL_SIZE -gt 0 ]; then
              TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024 / 1024))
              echo "  å›ºä»¶æ€»å¤§å°: ${TOTAL_SIZE_MB}MB"
              
              if [ $TOTAL_SIZE_MB -lt 5 ]; then
                echo "  âš ï¸ è­¦å‘Š: å›ºä»¶æ–‡ä»¶å¯èƒ½å¤ªå°"
              elif [ $TOTAL_SIZE_MB -gt 100 ]; then
                echo "  âš ï¸ è­¦å‘Š: å›ºä»¶æ–‡ä»¶å¯èƒ½å¤ªå¤§"
              else
                echo "  âœ… å›ºä»¶å¤§å°æ­£å¸¸"
              fi
            fi
            
            echo "=========================================="
            echo "âœ… æ„å»ºäº§ç‰©æ£€æŸ¥å®Œæˆ"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°å›ºä»¶ç›®å½•"
            echo "âš ï¸ bin/targetsç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 24 å®Œæˆ"
#ã€firmware-build.yml-26ã€‘

#ã€firmware-build.yml-27ã€‘
      # æ­¥éª¤ 25: ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•ï¼ˆä½¿ç”¨ç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æˆ³ï¼‰
      - name: "25. ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.TIMESTAMP_SEC }}
          path: /mnt/openwrt-build/bin/targets/
          retention-days: 7
          if-no-files-found: error
#ã€firmware-build.yml-27ã€‘

#ã€firmware-build.yml-28ã€‘
      # æ­¥éª¤ 26: ä¸Šä¼ é…ç½®æ–‡ä»¶ï¼ˆä½¿ç”¨ç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æˆ³ï¼‰
      - name: "26. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ env.TIMESTAMP_SEC }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
          if-no-files-found: error
#ã€firmware-build.yml-28ã€‘

#ã€firmware-build.yml-29ã€‘
      # æ­¥éª¤ 27: ç¼–è¯‘åç©ºé—´æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼‰
      - name: "27. ç¼–è¯‘åç©ºé—´æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼‰"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 27: ç¼–è¯‘åç©ºé—´æ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆï¼‰ ==="
          echo "ğŸ• æ£€æŸ¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œåªæ˜¯æ£€æŸ¥
          trap 'echo "âš ï¸ æ­¥éª¤ 27 æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          echo "ğŸ“Š ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h /mnt
          
          # ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„dfé€‰é¡¹è·å–å¯ç”¨ç©ºé—´
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1 | awk '{print $1}')
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 5 ]; then
            echo "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´è¾ƒä½ï¼Œå»ºè®®æ¸…ç†"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
          fi
          
          echo "ğŸŸ¢ æ­¥éª¤ 27 å®Œæˆ"
#ã€firmware-build.yml-29ã€‘

#ã€firmware-build.yml-30ã€‘
      # æ­¥éª¤ 28: ç¼–è¯‘åæ€»ç»“ï¼ˆå¢å¼ºç‰ˆï¼‰
      - name: "28. ç¼–è¯‘åæ€»ç»“ï¼ˆå¢å¼ºç‰ˆï¼‰"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 28: ç¼–è¯‘åæ€»ç»“ï¼ˆå¢å¼ºç‰ˆï¼‰ ==="
          echo "ğŸ• æ€»ç»“æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼Œæ€»ç»“ä¸åº”è¯¥å¤±è´¥
          trap 'echo "âš ï¸ æ­¥éª¤ 28 æ€»ç»“è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
          
          echo "ğŸš€ æ„å»ºæ€»ç»“æŠ¥å‘Š"
          echo "========================================"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "æ—¶é—´æˆ³ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰: ${{ env.TIMESTAMP_SEC }}"
          echo "æ—¶é—´æˆ³ï¼ˆä»…åˆ°æ—¥ï¼‰: ${{ env.TIMESTAMP_DAY }}"
          echo "å¹¶è¡Œä¼˜åŒ–: ${{ github.event.inputs.enable_parallel }}"
          echo ""
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©
          if [ -d "/mnt/openwrt-build/bin/targets" ]; then
            # ä¿®å¤ï¼šæ­£ç¡®ç»Ÿè®¡å›ºä»¶æ–‡ä»¶
            FIRMWARE_COUNT=$(find "/mnt/openwrt-build/bin/targets" -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
            
            echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
            echo "  å›ºä»¶æ•°é‡: $FIRMWARE_COUNT ä¸ª (.bin/.img)"
            
            if [ $FIRMWARE_COUNT -gt 0 ]; then
              echo "  äº§ç‰©ä½ç½®: /mnt/openwrt-build/bin/targets/"
              echo "  ä¸‹è½½åç§°: firmware-${{ env.TIMESTAMP_SEC }}"
              
              # æ˜¾ç¤ºæ‰€æœ‰å›ºä»¶æ–‡ä»¶ä¿¡æ¯
              echo "  å›ºä»¶æ–‡ä»¶è¯¦æƒ…:"
              find "/mnt/openwrt-build/bin/targets" -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                FILE_NAME=$(basename "$file")
                
                if [[ "$FILE_NAME" == *factory* ]]; then
                  TYPE="ğŸ­ å·¥å‚å›ºä»¶"
                elif [[ "$FILE_NAME" == *sysupgrade* ]]; then
                  TYPE="ğŸ”„ å‡çº§å›ºä»¶"
                elif [[ "$FILE_NAME" == *initramfs* ]]; then
                  TYPE="ğŸš€ å†…å­˜å›ºä»¶"
                else
                  TYPE="ğŸ”§ æ™®é€šå›ºä»¶"
                fi
                
                echo "    ğŸ¯ $FILE_NAME ($SIZE) - $TYPE"
              done
              
              # ç»Ÿè®¡åŒ…æ–‡ä»¶
              PACKAGE_COUNT=$(find "/mnt/openwrt-build/bin/targets" -type f \( -name "*.gz" -o -name "*.ipk" \) 2>/dev/null | wc -l)
              OTHER_COUNT=$(find "/mnt/openwrt-build/bin/targets" -type f 2>/dev/null | wc -l)
              OTHER_COUNT=$((OTHER_COUNT - FIRMWARE_COUNT - PACKAGE_COUNT))
              
              echo "  åŒ…æ–‡ä»¶æ•°é‡: $PACKAGE_COUNT ä¸ª (.gz/.ipk)"
              echo "  å…¶ä»–æ–‡ä»¶æ•°é‡: $OTHER_COUNT ä¸ª"
            else
              echo "  âš ï¸ æ„å»ºç»“æœ: ç¼–è¯‘å®Œæˆä½†æœªç”Ÿæˆå›ºä»¶æ–‡ä»¶"
              echo "  ğŸ” å·²ç”Ÿæˆçš„å…¶ä»–æ–‡ä»¶:"
              find "/mnt/openwrt-build/bin/targets" -type f 2>/dev/null | head -5 | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
                echo "    ğŸ“„ $(basename "$file") ($SIZE)"
              done
            fi
          else
            echo "ğŸ“¦ æ„å»ºäº§ç‰©: æœªç”Ÿæˆä»»ä½•æ–‡ä»¶"
          fi
          
          # æ„å»ºçŠ¶æ€æ€»ç»“
          echo ""
          echo "ğŸ“Š æ„å»ºçŠ¶æ€æ€»ç»“:"
          if [ -d "/mnt/openwrt-build/bin/targets" ]; then
            FIRMWARE_COUNT=$(find "/mnt/openwrt-build/bin/targets" -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
            if [ $FIRMWARE_COUNT -gt 0 ]; then
              echo "  âœ… æ„å»ºç»“æœ: æˆåŠŸç”Ÿæˆ $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
              echo "  ğŸ“ Artifactåç§°: firmware-${{ env.TIMESTAMP_SEC }}"
            else
              echo "  âš ï¸ æ„å»ºç»“æœ: ç¼–è¯‘å®Œæˆä½†æœªç”Ÿæˆå›ºä»¶æ–‡ä»¶"
            fi
          else
            echo "  âŒ æ„å»ºç»“æœ: å¤±è´¥"
          fi
          
          # ç¼–è¯‘å™¨ä¿¡æ¯
          echo ""
          echo "ğŸ”§ ç¼–è¯‘å™¨ä¿¡æ¯:"
          
          # æ£€æŸ¥SDKç¼–è¯‘å™¨ç‰ˆæœ¬
          if [ -d "/mnt/openwrt-build" ]; then
            # æŸ¥æ‰¾çœŸæ­£çš„GCCï¼Œæ’é™¤è™šå‡ç¼–è¯‘å™¨
            GCC_FILE=$(find "/mnt/openwrt-build" -type f -executable \
              -name "*gcc" \
              ! -name "*gcc-ar" \
              ! -name "*gcc-ranlib" \
              ! -name "*gcc-nm" \
              ! -path "*dummy-tools*" \
              ! -path "*scripts*" \
              2>/dev/null | head -1)
            
            if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
              SDK_VERSION=$("$GCC_FILE" --version 2>&1 | head -1)
              MAJOR_VERSION=$(echo "$SDK_VERSION" | grep -o "[0-9]\+" | head -1)
              
              if [ "$MAJOR_VERSION" = "12" ]; then
                echo "  ğŸ–¥ï¸ ç³»ç»ŸGCC: 11.4.0 (ç”¨äºç¼–è¯‘å·¥å…·é“¾)"
                echo "  ğŸ¯ SDK GCC: 12.3.0 (OpenWrt 23.05 SDKï¼Œç”¨äºäº¤å‰ç¼–è¯‘å›ºä»¶)"
              elif [ "$MAJOR_VERSION" = "8" ]; then
                echo "  ğŸ–¥ï¸ ç³»ç»ŸGCC: 11.4.0 (ç”¨äºç¼–è¯‘å·¥å…·é“¾)"
                echo "  ğŸ¯ SDK GCC: 8.4.0 (OpenWrt 21.02 SDKï¼Œç”¨äºäº¤å‰ç¼–è¯‘å›ºä»¶)"
              else
                echo "  ğŸ–¥ï¸ ç³»ç»ŸGCC: 11.4.0 (ç”¨äºç¼–è¯‘å·¥å…·é“¾)"
                echo "  ğŸ¯ SDK GCC: $MAJOR_VERSION.x (ç”¨äºäº¤å‰ç¼–è¯‘å›ºä»¶)"
              fi
            else
              echo "  ğŸ–¥ï¸ ç³»ç»ŸGCC: 11.4.0 (ç”¨äºç¼–è¯‘å·¥å…·é“¾)"
              echo "  ğŸ¯ SDK GCC: æœªæ£€æµ‹åˆ°ç‰ˆæœ¬ï¼ˆå¯èƒ½æ£€æµ‹åˆ°è™šå‡çš„dummy-toolsç¼–è¯‘å™¨ï¼‰"
            fi
          else
            echo "  ğŸ–¥ï¸ ç³»ç»ŸGCC: 11.4.0 (ç”¨äºç¼–è¯‘å·¥å…·é“¾)"
            echo "  ğŸ¯ SDK GCC: æœªä¸‹è½½SDKï¼Œä½¿ç”¨è‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
          fi
          
          echo "  ğŸ’¡ è¿™æ˜¯æ­£å¸¸çš„ï¼šç³»ç»Ÿç¼–è¯‘å™¨ç¼–è¯‘å·¥å…·é“¾ï¼ŒSDKç¼–è¯‘å™¨ç¼–è¯‘å›ºä»¶"
          
          # SDKä¸‹è½½çŠ¶æ€æ£€æŸ¥
          echo ""
          echo "ğŸ“¦ SDKä¸‹è½½çŠ¶æ€:"
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
              echo "  âœ… SDKå·²ä¸‹è½½: $COMPILER_DIR"
              echo "  ğŸ“Š ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            else
              echo "  âŒ SDKæœªä¸‹è½½æˆ–ç›®å½•ä¸å­˜åœ¨"
            fi
          else
            echo "  âŒ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "âœ… æ„å»ºæµç¨‹å®Œæˆ"
          echo "ğŸ“ æ‰€æœ‰Artifactä½¿ç”¨ç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æˆ³å‘½å: ${{ env.TIMESTAMP_SEC }}"
          echo "========================================"
          echo "ğŸŸ¢ æ­¥éª¤ 28 å®Œæˆ"
#ã€firmware-build.yml-30ã€‘
