name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆç¼–è¯‘å™¨å¼ºåˆ¶æœç´¢ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ 
          
          ğŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚
        required: false
        type: string
        default: ""

env:
  BUILD_DIR: "/mnt/openwrt-build"
  REPO_ROOT: "${{ github.workspace }}"
  COMPILER_ROOT: "${{ github.workspace }}/firmware-config/build-Compiler-file"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»“åº“
      - name: "1. æ£€å‡ºä»“åº“"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      
      # æ­¥éª¤ 2: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      - name: "2. è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™"
        run: |
          echo "=== æ­¥éª¤ 2: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
          find firmware-config/scripts -name "*.sh" -exec chmod +x {} \;
          echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"
      
      # æ­¥éª¤ 3: è¶…å¼ºåˆ¶æœç´¢ç¼–è¯‘å™¨æ–‡ä»¶ï¼ˆå¿…é¡»æ‰¾åˆ°ï¼ï¼‰
      - name: "3. è¶…å¼ºåˆ¶æœç´¢ç¼–è¯‘å™¨æ–‡ä»¶ï¼ˆå¿…é¡»æ‰¾åˆ°ï¼ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 3: è¶…å¼ºåˆ¶æœç´¢ç¼–è¯‘å™¨æ–‡ä»¶ ==="
          echo "ğŸš¨ æ­¤æ­¥éª¤å¿…é¡»æ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œå¦åˆ™ç¼–è¯‘å°†å¤±è´¥ï¼"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          REPO_ROOT="${{ env.REPO_ROOT }}"
          
          echo "ğŸ“ ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
          echo "ğŸ”§ å¼€å§‹è¶…å¼ºåˆ¶æœç´¢..."
          
          # é¦–å…ˆæ˜¾ç¤ºä»“åº“å†…å®¹ï¼Œå¸®åŠ©è°ƒè¯•
          echo "ğŸ“‹ ä»“åº“å†…å®¹æ¦‚è§ˆ (å‰30ä¸ªç›®å½•):"
          find "$REPO_ROOT" -maxdepth 3 -type d 2>/dev/null | sort | head -30
          
          # ç¡®å®šç›®æ ‡å¹³å°
          DEVICE_NAME="${{ github.event.inputs.device_name }}"
          echo "ğŸ¯ è®¾å¤‡åç§°: $DEVICE_NAME"
          
          TARGET_PLATFORM=""
          if [[ "$DEVICE_NAME" =~ ^(ac42u|acrh17)$ ]]; then
            TARGET_PLATFORM="arm"
            echo "ç›®æ ‡å¹³å°: ARM (IPQ40xx)"
          elif [[ "$DEVICE_NAME" =~ ^(mi_router_4a_gigabit|r4ag|mi_router_3g|r3g)$ ]]; then
            TARGET_PLATFORM="mips"
            echo "ç›®æ ‡å¹³å°: MIPS (MT76xx)"
          else
            TARGET_PLATFORM="generic"
            echo "ç›®æ ‡å¹³å°: é€šç”¨"
          fi
          
          # æ‰§è¡Œè¶…å¼ºåˆ¶æœç´¢
          echo "ğŸ” æ‰§è¡Œè¶…å¼ºåˆ¶æœç´¢..."
          cd firmware-config/scripts
          
          # ç›´æ¥è°ƒç”¨æœç´¢å‡½æ•°
          COMPILER_DIR=$(./build_firmware_main.sh search_compiler_files "$REPO_ROOT" "$TARGET_PLATFORM")
          
          if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
            echo "ğŸ¯ æ‰¾åˆ°ç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
            echo "COMPILER_DIR=$COMPILER_DIR" >> $GITHUB_ENV
            
            # æ˜¾ç¤ºæ‰¾åˆ°çš„ç›®å½•è¯¦æƒ…
            echo "ğŸ“Š ç¼–è¯‘å™¨ç›®å½•éªŒè¯:"
            echo "  è·¯å¾„: $COMPILER_DIR"
            echo "  å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            
            # æ˜¾ç¤ºå…³é”®æ–‡ä»¶
            echo "âš™ï¸ å…³é”®æ–‡ä»¶åˆ—è¡¨:"
            find "$COMPILER_DIR" -type f \( -iname "*gcc*" -o -iname "*g++*" \) 2>/dev/null | head -10 | while read file; do
              echo "  ğŸ“„ $(basename "$file")"
            done
            
            # æµ‹è¯•ç¼–è¯‘å™¨
            local test_gcc=$(find "$COMPILER_DIR" -type f -executable -iname "*gcc*" 2>/dev/null | head -1)
            if [ -n "$test_gcc" ]; then
              echo "ğŸ”§ æµ‹è¯•ç¼–è¯‘å™¨: $(basename "$test_gcc")"
              if "$test_gcc" --version 2>&1 | head -1 >/dev/null 2>&1; then
                local version=$("$test_gcc" --version 2>&1 | head -1)
                echo "  ç‰ˆæœ¬: $version"
              fi
            fi
            
            echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶æœç´¢æˆåŠŸ"
          else
            echo "âŒ è‡´å‘½é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½•ç¼–è¯‘å™¨æ–‡ä»¶ï¼"
            echo "ğŸ’¡ è°ƒè¯•ä¿¡æ¯:"
            
            # æ˜¾ç¤ºæ‰€æœ‰å¯èƒ½çš„ç¼–è¯‘å™¨æ–‡ä»¶
            echo "ğŸ” æœç´¢æ‰€æœ‰å¯èƒ½çš„ç¼–è¯‘å™¨æ–‡ä»¶:"
            find "$REPO_ROOT" -type f \( -iname "*gcc*" -o -iname "*arm*" -o -iname "*mips*" -o -iname "*toolchain*" \) 2>/dev/null | head -50
            
            # æ˜¾ç¤ºä»“åº“ç»“æ„
            echo "ğŸ“ ä»“åº“ç»“æ„:"
            find "$REPO_ROOT" -maxdepth 2 -type d | sort
            
            exit 1
          fi
      
      # æ­¥éª¤ 4: åˆå§‹ç©ºé—´æ£€æŸ¥
      - name: "4. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 4: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
            exit 1
          fi
          echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"
      
      # æ­¥éª¤ 5: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•
      - name: "5. è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 5: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½• ==="
          
          echo "ğŸ”„ æ­¥éª¤ 5.1: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          firmware-config/scripts/build_firmware_main.sh setup_environment
          
          echo "ğŸ”„ æ­¥éª¤ 5.2: åˆ›å»ºæ„å»ºç›®å½•"
          firmware-config/scripts/build_firmware_main.sh create_build_dir
          
          echo "ğŸ”„ æ­¥éª¤ 5.3: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•è®¾ç½®å®Œæˆ"
      
      # æ­¥éª¤ 6: éªŒè¯ç¼–è¯‘å™¨æ–‡ä»¶å®Œæ•´æ€§
      - name: "6. éªŒè¯ç¼–è¯‘å™¨æ–‡ä»¶å®Œæ•´æ€§"
        run: |
          echo "=== æ­¥éª¤ 6: éªŒè¯ç¼–è¯‘å™¨æ–‡ä»¶å®Œæ•´æ€§ ==="
          echo "ğŸ”§ å¼ºåˆ¶éªŒè¯ç¼–è¯‘å™¨æ–‡ä»¶..."
          
          firmware-config/scripts/build_firmware_main.sh verify_compiler_files
          
          echo "âœ… ç¼–è¯‘å™¨éªŒè¯å®Œæˆ"
      
      # æ­¥éª¤ 7: æ·»åŠ  TurboACC æ”¯æŒ
      - name: "7. æ·»åŠ  TurboACC æ”¯æŒ"
        run: |
          echo "=== æ­¥éª¤ 7: æ·»åŠ  TurboACC æ”¯æŒ ==="
          firmware-config/scripts/build_firmware_main.sh add_turboacc_support
      
      # æ­¥éª¤ 8: é…ç½®Feeds
      - name: "8. é…ç½®Feeds"
        run: |
          echo "=== æ­¥éª¤ 8: é…ç½®Feeds ==="
          firmware-config/scripts/build_firmware_main.sh configure_feeds
      
      # æ­¥éª¤ 9: å®‰è£… TurboACC åŒ…
      - name: "9. å®‰è£… TurboACC åŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤ 9: å®‰è£… TurboACC åŒ… ==="
          firmware-config/scripts/build_firmware_main.sh install_turboacc_packages
      
      # æ­¥éª¤ 10: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "10. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 10: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh pre_build_space_check
      
      # æ­¥éª¤ 11: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
      - name: "11. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 11: æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          echo "ğŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨å¼ºåˆ¶å¯ç”¨"
          firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤ 12: éªŒè¯USBé…ç½®
      - name: "12. éªŒè¯USBé…ç½®"
        run: |
          echo "=== æ­¥éª¤ 12: éªŒè¯USBé…ç½® ==="
          firmware-config/scripts/build_firmware_main.sh verify_usb_config
      
      # æ­¥éª¤ 13: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "13. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 13: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity
      
      # æ­¥éª¤ 14: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "14. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== æ­¥éª¤ 14: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          
          # å…ˆä¿å­˜åŸå§‹é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            cp "${{ env.BUILD_DIR }}/.config" "${{ env.BUILD_DIR }}/.config.original"
            echo "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶"
          fi
          
          # åº”ç”¨é…ç½®
          firmware-config/scripts/build_firmware_main.sh apply_config
          
          echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
      
      # æ­¥éª¤ 15: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "15. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 15: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
            mkdir -p firmware-config/config-backup
            
            # å¤‡ä»½åˆ°ä»“åº“ç›®å½•
            backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
            
            cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      # æ­¥éª¤ 16: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "16. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤ 16: ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          firmware-config/scripts/build_firmware_main.sh fix_network
      
      # æ­¥éª¤ 17: ä¸‹è½½ä¾èµ–åŒ…
      - name: "17. ä¸‹è½½ä¾èµ–åŒ…"
        run: |
          echo "=== æ­¥éª¤ 17: ä¸‹è½½ä¾èµ–åŒ… ==="
          firmware-config/scripts/build_firmware_main.sh download_dependencies
      
      # æ­¥éª¤ 18: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "18. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 18: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          firmware-config/scripts/build_firmware_main.sh integrate_custom_files
      
      # æ­¥éª¤ 19: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆåŒ…å«ç¼–è¯‘å™¨éªŒè¯ï¼‰
      - name: "19. å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆåŒ…å«ç¼–è¯‘å™¨éªŒè¯ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 19: å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh pre_build_error_check
      
      # æ­¥éª¤ 20: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "20. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 20: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          fi
          
          echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
      
      # æ­¥éª¤ 21: ç¼–è¯‘å›ºä»¶ï¼ˆä½¿ç”¨é¢„æ„å»ºç¼–è¯‘å™¨ï¼‰
      - name: "21. ç¼–è¯‘å›ºä»¶ï¼ˆä½¿ç”¨é¢„æ„å»ºç¼–è¯‘å™¨ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 21: ç¼–è¯‘å›ºä»¶ ==="
          echo "ğŸ”§ ä½¿ç”¨é¢„æ„å»ºç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘..."
          
          # æ˜¾ç¤ºç¼–è¯‘å™¨ä¿¡æ¯
          echo "ğŸ“Œ ç¼–è¯‘å™¨ä¿¡æ¯:"
          echo "  ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}"
          
          # å¼€å§‹ç¼–è¯‘
          firmware-config/scripts/build_firmware_main.sh build_firmware "true"
      
      # æ­¥éª¤ 22: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: "22. æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 22: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰© ==="
          cd ${{ env.BUILD_DIR }}
          
          # åˆ›å»ºæ„å»ºäº§ç‰©ç›®å½•
          mkdir -p /tmp/build-artifacts
          
          # æ‰“åŒ…å›ºä»¶æ–‡ä»¶
          if [ -d "bin/targets" ]; then
            echo "æ‰“åŒ…å›ºä»¶æ–‡ä»¶..."
            tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
            echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆ"
          fi
          
          # æ‰“åŒ…ç¼–è¯‘æ—¥å¿—
          if [ -f "build.log" ]; then
            echo "æ‰“åŒ…ç¼–è¯‘æ—¥å¿—..."
            cp build.log /tmp/build-artifacts/build.log
            echo "âœ… æ—¥å¿—æ‰“åŒ…å®Œæˆ"
          fi
          
          # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
          echo "æ„å»ºæ—¶é—´: $(date)" > /tmp/build-artifacts/build-info.txt
          echo "è®¾å¤‡: ${{ env.DEVICE }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> /tmp/build-artifacts/build-info.txt
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}" >> /tmp/build-artifacts/build-info.txt
          echo "ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}" >> /tmp/build-artifacts/build-info.txt
      
      # æ­¥éª¤ 23: ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•
      - name: "23. ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
      
      # æ­¥éª¤ 24: ä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "24. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      # æ­¥éª¤ 25: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "25. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 25: ç¼–è¯‘åç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh post_build_space_check
