name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´ä¿®å¤ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'è®¾å¤‡åç§° (å¦‚: ac42u, ac58u, mi4a ç­‰)'
        required: true
        default: 'ac42u'
        type: string
      old_device:
        description: 'æ˜¯å¦ä¸ºè€æ—§è®¾å¤‡ (æ€§èƒ½è¾ƒå·®çš„è®¾å¤‡å»ºè®®é€‰æ‹©true)'
        required: true
        default: false
        type: boolean
      version_spec:
        description: 'ç‰ˆæœ¬è§„æ ¼ (å¯é€‰ï¼Œå¦‚: openwrt-23.05 æˆ– immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_type:
        description: 'é…ç½®ç±»å‹ (minimal:åŸºç¡€åŠŸèƒ½, normal:å®Œæ•´åŠŸèƒ½, custom:è‡ªå®šä¹‰)'
        required: true
        default: 'normal'
        type: choice
        options:
          - minimal
          - normal
          - custom
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…å)'
        required: false
        type: string
      disabled_plugins:
        description: 'ç¦ç”¨æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…åï¼Œå¦‚: luci-app-accesscontrol luci-app-ddns)'
        required: false
        type: string
        default: ''
      save_config:
        description: 'ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“'
        required: false
        default: true
        type: boolean
      custom_install:
        description: 'å¯ç”¨è‡ªå®šä¹‰å®‰è£… (IPKå’Œè„šæœ¬)'
        required: false
        default: true
        type: boolean
      enable_cache:
        description: 'å¯ç”¨ç¼–è¯‘ç¼“å­˜ (æ˜¾è‘—åŠ é€Ÿåç»­ç¼–è¯‘)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  MIRROR_SOURCE: "tuna"
  CACHE_ENABLED: true

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential libncurses5-dev libssl-dev python3 unzip zlib1g-dev subversion gcc-multilib git curl file ninja-build automake autoconf libtool pkg-config gettext help2man texinfo gawk flex bison rsync wget aria2 python3-pip libelf-dev liblz4-dev zstd libssl-dev libcurl4-openssl-dev groff texlive texinfo
        pip3 install requests urllib3
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæ„å»ºç›®å½•å¹¶è®¾ç½®æƒé™
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        sudo chmod u+w $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"
        touch $BUILD_DIR/test_write.txt && echo "âœ… å†™å…¥æµ‹è¯•æˆåŠŸ" && rm $BUILD_DIR/test_write.txt

    - name: å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½•
      run: |
        echo "=== å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½• ==="
        cd $GITHUB_WORKSPACE
        SCRIPTS=("complete_version_detector.sh" "device_detection.sh" "error_analysis.sh" "pre_download.sh" "check-plugins.sh" "diagnose-packages.sh")
        echo "è¦å¤åˆ¶çš„è„šæœ¬åˆ—è¡¨: ${SCRIPTS[*]}"
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        find . -name "*.sh" -type f | head -20
        COPIED_COUNT=0
        for script in "${SCRIPTS[@]}"; do
          echo "æ­£åœ¨æŸ¥æ‰¾: $script"
          FOUND_SCRIPT=$(find . -name "$script" -type f | head -1)
          if [ -n "$FOUND_SCRIPT" ]; then
            cp "$FOUND_SCRIPT" $BUILD_DIR/
            echo "âœ… æ‰¾åˆ°å¹¶å¤åˆ¶: $script (ä» $FOUND_SCRIPT)"
            COPIED_COUNT=$((COPIED_COUNT + 1))
          else
            echo "âš ï¸ æœªæ‰¾åˆ°: $script"
          fi
        done
        echo "æ€»å…±å¤åˆ¶äº† $COPIED_COUNT ä¸ªè„šæœ¬æ–‡ä»¶"
        cd $BUILD_DIR
        echo "æ„å»ºç›®å½•ä¸­çš„è„šæœ¬:"
        ls -la *.sh 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°.shæ–‡ä»¶"
        chmod +x *.sh 2>/dev/null || true
        echo "âœ… è„šæœ¬å¤åˆ¶å®Œæˆ"

    - name: éªŒè¯è„šæœ¬å­˜åœ¨æ€§
      run: |
        cd $BUILD_DIR
        echo "=== éªŒè¯è„šæœ¬å­˜åœ¨æ€§ ==="
        echo "æ„å»ºç›®å½•å†…å®¹:"
        ls -la
        REQUIRED_SCRIPTS=("complete_version_detector.sh" "device_detection.sh")
        ALL_SCRIPTS_EXIST=true
        for script in "${REQUIRED_SCRIPTS[@]}"; do
          if [ -f "$script" ]; then
            echo "âœ… $script å­˜åœ¨"
            chmod +x "$script"
          else
            echo "âŒ é”™è¯¯: $script ä¸å­˜åœ¨"
            ALL_SCRIPTS_EXIST=false
          fi
        done
        if [ "$ALL_SCRIPTS_EXIST" = false ]; then
          echo "å½“å‰ç›®å½•ä¸­çš„æ–‡ä»¶:"
          ls -la
          echo "âŒ å…³é”®è„šæœ¬ç¼ºå¤±ï¼Œæ„å»ºç»ˆæ­¢"
          exit 1
        fi

    - name: æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ ==="
        sudo chown -R $USER:$USER . 2>/dev/null || true
        chmod u+w . 2>/dev/null || true
        chmod +x *.sh 2>/dev/null || true
        echo "è®¾å¤‡åç§°: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬è§„æ ¼: ${{ github.event.inputs.version_spec }}"
        echo "è€æ—§è®¾å¤‡: ${{ github.event.inputs.old_device }}"
        if [ ! -f "complete_version_detector.sh" ]; then
          echo "âŒ é”™è¯¯: complete_version_detector.sh ä¸å­˜åœ¨"
          ls -la
          exit 1
        fi
        chmod +x complete_version_detector.sh
        set +e
        OUTPUT=$(./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_spec }}" "${{ github.event.inputs.old_device }}" 2>&1)
        SCRIPT_EXIT_CODE=$?
        set -e
        echo "è„šæœ¬è¾“å‡º:"
        echo "$OUTPUT"
        echo "è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE"
        SELECTED_REPO=$(echo "$OUTPUT" | grep "^SELECTED_REPO=" | head -1 | cut -d'=' -f2)
        SELECTED_BRANCH=$(echo "$OUTPUT" | grep "^SELECTED_BRANCH=" | head -1 | cut -d'=' -f2)
        SELECTED_REPO_URL=$(echo "$OUTPUT" | grep "^SELECTED_REPO_URL=" | head -1 | cut -d'=' -f2)
        if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
            echo "âœ… ä»è„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–ç‰ˆæœ¬ä¿¡æ¯"
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            echo "âœ… ç¯å¢ƒå˜é‡å·²è®¾ç½®:"
            echo "  ä»“åº“: $SELECTED_REPO"
            echo "  åˆ†æ”¯: $SELECTED_BRANCH"
            echo "  URL: $SELECTED_REPO_URL"
        else
            echo "âŒ æ— æ³•ä»è„šæœ¬è¾“å‡ºä¸­æå–ç‰ˆæœ¬ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ ç‰ˆæœ¬æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼"
                echo "SELECTED_REPO=immortalwrt" >> $GITHUB_ENV
                echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
                echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
                echo "âœ… ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ä¿¡æ¯"
            fi
        fi

    - name: å¤‡ä»½æ£€æµ‹è„šæœ¬
      run: |
        echo "=== å¤‡ä»½æ£€æµ‹è„šæœ¬ ==="
        mkdir -p /tmp/build-scripts-backup
        cp $BUILD_DIR/*.sh /tmp/build-scripts-backup/ 2>/dev/null || true
        echo "âœ… è„šæœ¬å¤‡ä»½å®Œæˆ"

    - name: æ¸…ç†æ„å»ºç›®å½•
      run: |
        cd $BUILD_DIR
        echo "=== æ¸…ç†æ„å»ºç›®å½•å‡†å¤‡å…‹éš† ==="
        ls -la
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        sudo rm -rf .[!.]* 2>/dev/null || true
        ls -la
        echo "âœ… ç›®å½•æ¸…ç†å®Œæˆ"

    - name: å…‹éš†æºç 
      run: |
        cd $BUILD_DIR
        echo "=== å…‹éš†é€‰å®šç‰ˆæœ¬çš„æºç  ==="
        echo "ä»“åº“: $SELECTED_REPO_URL"
        echo "åˆ†æ”¯: $SELECTED_BRANCH"
        if [ -z "$SELECTED_REPO_URL" ] || [ -z "$SELECTED_BRANCH" ]; then
          echo "âŒ é”™è¯¯: ç¯å¢ƒå˜é‡æœªæ­£ç¡®è®¾ç½®"
          exit 1
        fi
        echo "æ£€æŸ¥ç›®å½•çŠ¶æ€..."
        FILE_COUNT=$(ls -A | wc -l)
        if [ $FILE_COUNT -ne 0 ]; then
          echo "âŒ é”™è¯¯: ç›®å½•éç©ºï¼Œæ— æ³•å…‹éš†"
          exit 1
        fi
        MAX_RETRIES=3
        RETRY_COUNT=0
        CLONE_SUCCESS=false
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$CLONE_SUCCESS" = false ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "å…‹éš†å°è¯•: $RETRY_COUNT/$MAX_RETRIES"
          if git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .; then
            echo "âœ… æºç å…‹éš†å®Œæˆ"
            CLONE_SUCCESS=true
          else
            echo "âŒ å…‹éš†å¤±è´¥ï¼Œå°è¯• $RETRY_COUNT/$MAX_RETRIES"
            if echo "$SELECTED_REPO_URL" | grep -q "github.com" && [ $RETRY_COUNT -eq 2 ]; then
              echo "ğŸ”„ å°è¯•ä½¿ç”¨é•œåƒæº..."
              MIRROR_URL=$(echo "$SELECTED_REPO_URL" | sed 's/github.com/github.com.cnpmjs.org/')
              rm -rf ./* ./.git* 2>/dev/null || true
              if git clone --depth 1 --branch "$SELECTED_BRANCH" "$MIRROR_URL" .; then
                echo "âœ… ä½¿ç”¨é•œåƒæºå…‹éš†æˆåŠŸ"
                CLONE_SUCCESS=true
                break
              fi
            fi
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ æºç å…‹éš†å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            fi
            sleep 10
            rm -rf ./* ./.git* 2>/dev/null || true
          fi
        done

    - name: æ¢å¤æ£€æµ‹è„šæœ¬
      run: |
        cd $BUILD_DIR
        echo "=== æ¢å¤æ£€æµ‹è„šæœ¬ ==="
        cp /tmp/build-scripts-backup/*.sh ./ 2>/dev/null || true
        chmod +x *.sh
        echo "âœ… è„šæœ¬æ¢å¤å®Œæˆ"

    - name: é…ç½®å¤šæºfeeds
      run: |
        cd $BUILD_DIR
        echo "=== é…ç½®å¤šæºfeeds ==="
        cp feeds.conf.default feeds.conf.default.backup
        echo "src-git immortalwrt_packages https://github.com/immortalwrt/packages;master" > feeds.conf.default
        echo "src-git immortalwrt_luci https://github.com/immortalwrt/luci;master" >> feeds.conf.default
        echo "src-git immortalwrt_routing https://github.com/immortalwrt/routing;master" >> feeds.conf.default
        echo "src-git immortalwrt_telephony https://github.com/immortalwrt/telephony;master" >> feeds.conf.default
        echo "" >> feeds.conf.default
        echo "# OpenWrt å®˜æ–¹æº" >> feeds.conf.default
        echo "src-git openwrt_packages https://git.openwrt.org/feed/packages.git;master" >> feeds.conf.default
        echo "src-git openwrt_luci https://git.openwrt.org/project/luci.git;master" >> feeds.conf.default
        echo "src-git openwrt_routing https://git.openwrt.org/feed/routing.git;master" >> feeds.conf.default
        echo "src-git openwrt_telephony https://git.openwrt.org/feed/telephony.git;master" >> feeds.conf.default
        echo "" >> feeds.conf.default
        echo "# ç¬¬ä¸‰æ–¹æ’ä»¶æº" >> feeds.conf.default
        echo "src-git lienol_packages https://github.com/Lienol/openwrt-packages;master" >> feeds.conf.default
        echo "src-git kenzo_packages https://github.com/kenzok8/openwrt-packages;master" >> feeds.conf.default
        echo "src-git small_packages https://github.com/kenzok8/small;master" >> feeds.conf.default
        echo "" >> feeds.conf.default
        echo "# ç‰¹å®šåŠŸèƒ½æ’ä»¶æº" >> feeds.conf.default
        echo "src-git smartdns https://github.com/pymumu/openwrt-smartdns;master" >> feeds.conf.default
        echo "src-git openclash https://github.com/vernesong/OpenClash;master" >> feeds.conf.default
        echo "âœ… å¤šæºfeedsé…ç½®å®Œæˆ"
        echo "Feedsé…ç½®å†…å®¹:"
        cat feeds.conf.default

    - name: æ›´æ–°å®‰è£…feeds
      run: |
        cd $BUILD_DIR
        echo "=== æ›´æ–°å’Œå®‰è£…feeds ==="
        echo "ç¬¬ä¸€æ¬¡æ›´æ–°feeds..."
        set +e
        ./scripts/feeds update -a
        UPDATE_RESULT=$?
        set -e
        if [ $UPDATE_RESULT -ne 0 ]; then
            echo "âš ï¸ ç¬¬ä¸€æ¬¡æ›´æ–°å¤±è´¥ï¼Œæ£€æŸ¥å¹¶ä¿®å¤åˆ†æ”¯é…ç½®..."
            FAILED_FEEDS=$(./scripts/feeds list -n 2>/dev/null | awk '{print $1}' | sort -u)
            for feed in $FAILED_FEEDS; do
                echo "å°è¯•ä¿®å¤feed: $feed"
                rm -rf "./feeds/$feed" 2>/dev/null || true
            done
            echo "ç¬¬äºŒæ¬¡æ›´æ–°feeds..."
            set +e
            ./scripts/feeds update -a
            UPDATE_RESULT=$?
            set -e
            if [ $UPDATE_RESULT -ne 0 ]; then
                echo "âŒ æ›´æ–°feedså¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•å®‰è£…..."
            fi
        fi
        echo "å®‰è£…feeds..."
        set +e
        ./scripts/feeds install -a
        INSTALL_RESULT=$?
        set -e
        if [ $INSTALL_RESULT -ne 0 ]; then
            echo "âš ï¸ éƒ¨åˆ†feedså®‰è£…å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»ºæµç¨‹..."
            echo "å¤±è´¥çš„feedså¯èƒ½å½±å“éƒ¨åˆ†åŠŸèƒ½ï¼Œä½†æ ¸å¿ƒæ„å»ºå¯ä»¥ç»§ç»­"
        else
            echo "âœ… feedså®‰è£…å®Œæˆ"
        fi
        echo "=== å¯ç”¨çš„feedsåˆ—è¡¨ ==="
        ./scripts/feeds list | head -20

    - name: éªŒè¯feedsçŠ¶æ€
      run: |
        cd $BUILD_DIR
        echo "=== éªŒè¯feedsçŠ¶æ€ ==="
        echo "Feedsç›®å½•å†…å®¹:"
        ls -la feeds/ 2>/dev/null || echo "feedsç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
        CRITICAL_FEEDS=("packages" "luci")
        for feed in "${CRITICAL_FEEDS[@]}"; do
            if [ -d "feeds/$feed" ]; then
                echo "âœ… å…³é”®feedå­˜åœ¨: $feed"
            else
                echo "âš ï¸ å…³é”®feedç¼ºå¤±: $feed"
            fi
        done

    - name: å¤åˆ¶é…ç½®æ–‡ä»¶å’Œè„šæœ¬
      run: |
        cd $BUILD_DIR
        echo "=== é‡æ–°å¤åˆ¶é…ç½®æ–‡ä»¶å’Œè„šæœ¬ ==="
        cd $GITHUB_WORKSPACE
        echo "=== æŸ¥æ‰¾é…ç½®æ–‡ä»¶ ==="
        mkdir -p $BUILD_DIR/config-templates
        CONFIG_FILES=("minimal.config" "normal-new.config" "normal-old.config")
        for config_file in "${CONFIG_FILES[@]}"; do
          echo "æ­£åœ¨æŸ¥æ‰¾é…ç½®æ–‡ä»¶: $config_file"
          FOUND_CONFIG=$(find . -name "$config_file" -type f | head -1)
          if [ -n "$FOUND_CONFIG" ]; then
            cp "$FOUND_CONFIG" $BUILD_DIR/config-templates/
            echo "âœ… å¤åˆ¶: $config_file (ä» $FOUND_CONFIG)"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°: $config_file"
          fi
        done
        echo "âœ… é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        SCRIPTS=("error_analysis.sh" "pre_download.sh" "check-plugins.sh" "diagnose-packages.sh")
        for script in "${SCRIPTS[@]}"; do
          FOUND_SCRIPT=$(find . -name "$script" -type f | head -1)
          if [ -n "$FOUND_SCRIPT" ]; then
            cp "$FOUND_SCRIPT" $BUILD_DIR/
            chmod +x $BUILD_DIR/"$script"
            echo "âœ… æ›´æ–°è„šæœ¬: $script"
          fi
        done
        echo "âœ… é…ç½®æ–‡ä»¶å’Œè„šæœ¬é‡æ–°å¤åˆ¶å®Œæˆ"

    - name: è®¾å¤‡æ£€æµ‹
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½è®¾å¤‡æ£€æµ‹ä¸åˆ«åè½¬æ¢ ==="
        INPUT_DEVICE="${{ github.event.inputs.device_name }}"
        echo "è¾“å…¥è®¾å¤‡åç§°: $INPUT_DEVICE"
        case "$INPUT_DEVICE" in
            "ac42u"|"acrh17"|"rt-acrh17") ACTUAL_DEVICE="asus_rt-ac42u" ;;
            "ac58u"|"acrh13"|"rt-ac58u"|"rt-acrh13") ACTUAL_DEVICE="asus_rt-ac58u" ;;
            "mi4a"|"r4a") ACTUAL_DEVICE="xiaomi_mi-router-4a-gigabit" ;;
            "mi3g"|"r3g") ACTUAL_DEVICE="xiaomi_mi-router-3g" ;;
            *) ACTUAL_DEVICE="$INPUT_DEVICE" ;;
        esac
        if [ "$ACTUAL_DEVICE" != "$INPUT_DEVICE" ]; then
          echo "âœ… æ£€æµ‹åˆ°è®¾å¤‡é€šç”¨åç§° '$INPUT_DEVICE'ï¼Œè½¬æ¢ä¸ºå®é™…è®¾å¤‡æ ‡è¯† '$ACTUAL_DEVICE'"
        else
          echo "â„¹ï¸ ä½¿ç”¨åŸå§‹è®¾å¤‡åç§°: $ACTUAL_DEVICE"
        fi
        if [ ! -f "device_detection.sh" ]; then
          echo "âŒ é”™è¯¯: è®¾å¤‡æ£€æµ‹è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        chmod +x device_detection.sh
        echo "=== å¼€å§‹è®¾å¤‡æ£€æµ‹ ==="
        TEMP_LOG=$(mktemp)
        set +e
        ./device_detection.sh "$ACTUAL_DEVICE" 2>&1 | tee "$TEMP_LOG"
        SCRIPT_EXIT_CODE=$?
        set -e
        echo "=== è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE ==="
        PLATFORM=$(grep "^PLATFORM=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        DEVICE_SHORT_NAME=$(grep "^DEVICE_SHORT_NAME=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        DEVICE_FULL_NAME=$(grep "^DEVICE_FULL_NAME=" "$TEMP_LOG" | tail -1 | cut -d'=' -f2)
        echo "=== æå–çš„è®¾å¤‡ä¿¡æ¯ ==="
        echo "å¹³å°(PLATFORM): '$PLATFORM'"
        echo "è®¾å¤‡çŸ­åç§°(DEVICE_SHORT_NAME): '$DEVICE_SHORT_NAME'"
        echo "è®¾å¤‡å…¨åç§°(DEVICE_FULL_NAME): '$DEVICE_FULL_NAME'"
        rm -f "$TEMP_LOG"
        if [ -n "$PLATFORM" ] && [ -n "$DEVICE_SHORT_NAME" ] && [ -n "$DEVICE_FULL_NAME" ]; then
            echo "âœ… ä»è„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–è®¾å¤‡ä¿¡æ¯"
            echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
            echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
        else
            echo "âŒ æ— æ³•ä»è„šæœ¬è¾“å‡ºä¸­æå–è®¾å¤‡ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ è®¾å¤‡æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–è®¾å¤‡ä¿¡æ¯ï¼Œä½¿ç”¨å¤‡ç”¨è®¾å¤‡æ˜ å°„"
                case "$ACTUAL_DEVICE" in
                    "asus_rt-ac42u"|"ac42u"|"acrh17"|"rt-acrh17")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac42u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "asus_rt-ac58u"|"ac58u"|"acrh13"|"rt-acrh13")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac58u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    "xiaomi_mi-router-4a-gigabit"|"mi4a"|"r4a")
                        echo "PLATFORM=ramips" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=xiaomi_mi-router-4a-gigabit" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$ACTUAL_DEVICE" >> $GITHUB_ENV
                        ;;
                    *)
                        echo "âŒ æœªçŸ¥è®¾å¤‡ï¼Œæ— æ³•è®¾ç½®é»˜è®¤å€¼"
                        exit 1
                        ;;
                esac
                echo "âœ… å·²ä½¿ç”¨å¤‡ç”¨è®¾å¤‡ä¿¡æ¯"
            fi
        fi

    - name: åˆ›å»ºæ™ºèƒ½æ’ä»¶æ£€æŸ¥è„šæœ¬
      run: |
        cd $BUILD_DIR
        echo "=== åˆ›å»ºæ™ºèƒ½æ’ä»¶æ£€æŸ¥è„šæœ¬ ==="
        echo '#!/bin/bash' > check-plugins.sh
        echo 'set -e' >> check-plugins.sh
        echo 'BUILD_DIR="${1:-.}"' >> check-plugins.sh
        echo 'cd "$BUILD_DIR"' >> check-plugins.sh
        echo 'echo "=== æ™ºèƒ½æ’ä»¶å¯ç”¨æ€§æ£€æŸ¥ä¸æ˜ å°„ç³»ç»Ÿ ==="' >> check-plugins.sh
        echo 'echo "æ›´æ–°feeds..."' >> check-plugins.sh
        echo './scripts/feeds update -a > /dev/null 2>&1' >> check-plugins.sh
        echo 'CRITICAL_PLUGINS=("luci" "luci-base" "luci-theme-bootstrap" "luci-i18n-base-zh-cn" "luci-i18n-firewall-zh-cn")' >> check-plugins.sh
        echo 'FEATURE_PLUGINS=("luci-app-turboacc" "luci-app-samba4" "luci-app-smartdns" "luci-app-arpbind" "luci-app-cpulimit" "luci-app-diskman")' >> check-plugins.sh
        echo 'REPORT_FILE="plugin_availability_report.txt"' >> check-plugins.sh
        echo 'echo "æ’ä»¶å¯ç”¨æ€§æ£€æŸ¥æŠ¥å‘Š" > $REPORT_FILE' >> check-plugins.sh
        echo 'echo "ç”Ÿæˆæ—¶é—´: $(date)" >> $REPORT_FILE' >> check-plugins.sh
        echo 'echo "=== å…³é”®æ’ä»¶æ£€æŸ¥ ===" >> $REPORT_FILE' >> check-plugins.sh
        echo 'CRITICAL_MISSING=()' >> check-plugins.sh
        echo 'for plugin in "${CRITICAL_PLUGINS[@]}"; do' >> check-plugins.sh
        echo '    if ./scripts/feeds install "$plugin" > /dev/null 2>&1; then' >> check-plugins.sh
        echo '        echo "âœ… $plugin" | tee -a $REPORT_FILE' >> check-plugins.sh
        echo '    else' >> check-plugins.sh
        echo '        echo "âŒ $plugin" | tee -a $REPORT_FILE' >> check-plugins.sh
        echo '        CRITICAL_MISSING+=("$plugin")' >> check-plugins.sh
        echo '    fi' >> check-plugins.sh
        echo 'done' >> check-plugins.sh
        echo 'echo "=== åŠŸèƒ½æ’ä»¶æ£€æŸ¥ ===" >> $REPORT_FILE' >> check-plugins.sh
        echo 'FEATURE_MISSING=()' >> check-plugins.sh
        echo 'for plugin in "${FEATURE_PLUGINS[@]}"; do' >> check-plugins.sh
        echo '    if ./scripts/feeds install "$plugin" > /dev/null 2>&1; then' >> check-plugins.sh
        echo '        echo "âœ… $plugin" | tee -a $REPORT_FILE' >> check-plugins.sh
        echo '    else' >> check-plugins.sh
        echo '        echo "âš ï¸ $plugin (æ— æ›¿ä»£)" | tee -a $REPORT_FILE' >> check-plugins.sh
        echo '        FEATURE_MISSING+=("$plugin")' >> check-plugins.sh
        echo '    fi' >> check-plugins.sh
        echo 'done' >> check-plugins.sh
        echo 'echo "=== æ£€æŸ¥æ€»ç»“ ===" >> $REPORT_FILE' >> check-plugins.sh
        echo 'if [ ${#CRITICAL_MISSING[@]} -gt 0 ]; then' >> check-plugins.sh
        echo '    echo "âŒ å…³é”®æ’ä»¶ç¼ºå¤±: ${CRITICAL_MISSING[*]}" >> $REPORT_FILE' >> check-plugins.sh
        echo '    echo "âŒ å…³é”®æ’ä»¶ç¼ºå¤±ï¼Œæ„å»ºç»ˆæ­¢"' >> check-plugins.sh
        echo '    exit 1' >> check-plugins.sh
        echo 'else' >> check-plugins.sh
        echo '    echo "âœ… æ‰€æœ‰å…³é”®æ’ä»¶éƒ½å¯ç”¨" >> $REPORT_FILE' >> check-plugins.sh
        echo '    echo "âœ… æ’ä»¶æ£€æŸ¥é€šè¿‡"' >> check-plugins.sh
        echo '    exit 0' >> check-plugins.sh
        echo 'fi' >> check-plugins.sh
        chmod +x check-plugins.sh
        echo "âœ… æ™ºèƒ½æ’ä»¶æ£€æŸ¥è„šæœ¬åˆ›å»ºå®Œæˆ"

    - name: æ™ºèƒ½æ£€æŸ¥æ’ä»¶å¯ç”¨æ€§
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½æ£€æŸ¥æ’ä»¶å¯ç”¨æ€§ ==="
        if [ -f "check-plugins.sh" ]; then
            chmod +x check-plugins.sh
            echo "å¼€å§‹æ™ºèƒ½æ£€æŸ¥æ’ä»¶åœ¨feedsä¸­çš„å¯ç”¨æ€§..."
            set +e
            ./check-plugins.sh "$BUILD_DIR"
            CHECK_RESULT=$?
            set -e
            case $CHECK_RESULT in
                0)
                    echo "âœ… æ’ä»¶æ£€æŸ¥å®Œæˆ - æ‰€æœ‰åŒ…éƒ½å¯ç”¨"
                    ;;
                1)
                    echo "âŒ æ’ä»¶æ£€æŸ¥å¤±è´¥ - æœ‰å…³é”®åŒ…ç¼ºå¤±"
                    exit 1
                    ;;
                *)
                    echo "â„¹ï¸ æ’ä»¶æ£€æŸ¥å®Œæˆ"
                    ;;
            esac
        else
            echo "âš ï¸ æœªæ‰¾åˆ°æ’ä»¶æ£€æŸ¥è„šæœ¬ï¼Œè·³è¿‡æ’ä»¶æ£€æŸ¥"
        fi

    - name: åº”ç”¨é…ç½®æ¨¡æ¿
      run: |
        cd $BUILD_DIR
        echo "=== åº”ç”¨é…ç½®æ¨¡æ¿ ==="
        CONFIG_TYPE="${{ github.event.inputs.config_type }}"
        IS_OLD_DEVICE="${{ github.event.inputs.old_device }}"
        echo "é…ç½®ç±»å‹: $CONFIG_TYPE"
        echo "æ˜¯å¦ä¸ºè€æ—§è®¾å¤‡: $IS_OLD_DEVICE"
        case "$CONFIG_TYPE" in
            "minimal")
                CONFIG_FILE="config-templates/minimal.config"
                ;;
            "normal")
                if [ "$IS_OLD_DEVICE" = "true" ]; then
                    CONFIG_FILE="config-templates/normal-old.config"
                else
                    CONFIG_FILE="config-templates/normal-new.config"
                fi
                ;;
            "custom")
                if [ "$IS_OLD_DEVICE" = "true" ]; then
                    CONFIG_FILE="config-templates/normal-old.config"
                else
                    CONFIG_FILE="config-templates/normal-new.config"
                fi
                ;;
            *)
                echo "âŒ æœªçŸ¥çš„é…ç½®ç±»å‹: $CONFIG_TYPE"
                exit 1
                ;;
        esac
        if [ -f "$CONFIG_FILE" ]; then
            echo "âœ… ä½¿ç”¨é…ç½®æ–‡ä»¶: $CONFIG_FILE"
            cp "$CONFIG_FILE" .config
        else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
            echo "å¯ç”¨çš„é…ç½®æ–‡ä»¶:"
            ls -la config-templates/ 2>/dev/null || echo "config-templatesç›®å½•ä¸å­˜åœ¨"
            exit 1
        fi
        echo "åº”ç”¨é…ç½®..."
        make defconfig
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"

    - name: è‡ªå®šä¹‰é…ç½®è°ƒæ•´
      if: inputs.extra_packages != '' || inputs.disabled_plugins != ''
      run: |
        cd $BUILD_DIR
        echo "=== è‡ªå®šä¹‰é…ç½®è°ƒæ•´ ==="
        EXTRA_PACKAGES="${{ github.event.inputs.extra_packages }}"
        DISABLED_PLUGINS="${{ github.event.inputs.disabled_plugins }}"
        echo "é¢å¤–åŒ…: $EXTRA_PACKAGES"
        echo "ç¦ç”¨æ’ä»¶: $DISABLED_PLUGINS"
        if [ -n "$EXTRA_PACKAGES" ]; then
            for package in $EXTRA_PACKAGES; do
                echo "å¯ç”¨åŒ…: $package"
                if grep -q "CONFIG_PACKAGE_${package}=m" .config || grep -q "CONFIG_PACKAGE_${package}=y" .config; then
                    echo "âœ… åŒ… $package å·²å­˜åœ¨é…ç½®ä¸­"
                else
                    echo "CONFIG_PACKAGE_${package}=y" >> .config
                    echo "âœ… æ·»åŠ åŒ… $package åˆ°é…ç½®"
                fi
            done
        fi
        if [ -n "$DISABLED_PLUGINS" ]; then
            for plugin in $DISABLED_PLUGINS; do
                echo "ç¦ç”¨æ’ä»¶: $plugin"
                sed -i "s/CONFIG_PACKAGE_${plugin}=y/CONFIG_PACKAGE_${plugin}=n/" .config
                sed -i "s/CONFIG_PACKAGE_${plugin}=m/CONFIG_PACKAGE_${plugin}=n/" .config
                echo "âœ… ç¦ç”¨æ’ä»¶ $plugin"
            done
        fi
        make defconfig
        echo "âœ… è‡ªå®šä¹‰é…ç½®è°ƒæ•´å®Œæˆ"

    - name: é¢„ä¸‹è½½æºæ–‡ä»¶
      run: |
        cd $BUILD_DIR
        echo "=== é¢„ä¸‹è½½æºæ–‡ä»¶ ==="
        echo '#!/bin/bash' > pre-download-sources.sh
        echo 'set -e' >> pre-download-sources.sh
        echo 'echo "=== å¼€å§‹é¢„ä¸‹è½½æºæ–‡ä»¶ ==="' >> pre-download-sources.sh
        echo 'mkdir -p dl' >> pre-download-sources.sh
        echo 'cd dl' >> pre-download-sources.sh
        echo 'COMMON_SOURCES=(' >> pre-download-sources.sh
        echo '  "https://github.com/protocolbuffers/protobuf/releases/download/v3.20.1/protobuf-cpp-3.20.1.tar.gz"' >> pre-download-sources.sh
        echo '  "https://www.openssl.org/source/openssl-1.1.1q.tar.gz"' >> pre-download-sources.sh
        echo '  "https://www.zlib.net/zlib-1.2.12.tar.gz"' >> pre-download-sources.sh
        echo '  "https://sqlite.org/2022/sqlite-autoconf-3390400.tar.gz"' >> pre-download-sources.sh
        echo '  "https://github.com/libevent/libevent/releases/download/release-2.1.12-stable/libevent-2.1.12-stable.tar.gz"' >> pre-download-sources.sh
        echo '  "https://github.com/curl/curl/releases/download/curl-7_86_0/curl-7.86.0.tar.xz"' >> pre-download-sources.sh
        echo ')' >> pre-download-sources.sh
        echo 'for source in "${COMMON_SOURCES[@]}"; do' >> pre-download-sources.sh
        echo '    filename=$(basename "$source")' >> pre-download-sources.sh
        echo '    if [ ! -f "$filename" ]; then' >> pre-download-sources.sh
        echo '        echo "ä¸‹è½½: $filename"' >> pre-download-sources.sh
        echo '        wget --timeout=60 --tries=3 "$source" || echo "ä¸‹è½½å¤±è´¥: $filename"' >> pre-download-sources.sh
        echo '    else' >> pre-download-sources.sh
        echo '        echo "å·²å­˜åœ¨: $filename"' >> pre-download-sources.sh
        echo '    fi' >> pre-download-sources.sh
        echo 'done' >> pre-download-sources.sh
        echo 'echo "âœ… é¢„ä¸‹è½½å®Œæˆ"' >> pre-download-sources.sh
        chmod +x pre-download-sources.sh
        ./pre-download-sources.sh

    - name: ç¼–è¯‘å›ºä»¶
      timeout-minutes: 180
      run: |
        cd $BUILD_DIR
        echo "=== å¼€å§‹ç¼–è¯‘å›ºä»¶ ==="
        CPU_CORES=$(nproc)
        if [ $CPU_CORES -gt 8 ]; then
            JOBS=$((CPU_CORES - 2))
        else
            JOBS=$CPU_CORES
        fi
        echo "ä½¿ç”¨ç¼–è¯‘çº¿ç¨‹æ•°: $JOBS"
        set +e
        make -j$JOBS V=s
        BUILD_RESULT=$?
        set -e
        if [ $BUILD_RESULT -eq 0 ]; then
            echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
        else
            echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥"
            if [ -f "error_analysis.sh" ]; then
                chmod +x error_analysis.sh
                ./error_analysis.sh
            fi
            exit 1
        fi

    - name: æ”¶é›†æ„å»ºäº§ç‰©
      if: success()
      run: |
        cd $BUILD_DIR
        echo "=== æ”¶é›†æ„å»ºäº§ç‰© ==="
        mkdir -p $GITHUB_WORKSPACE/firmware-output
        FIRMWARE_FILES=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.gz" 2>/dev/null | head -10)
        if [ -n "$FIRMWARE_FILES" ]; then
            echo "æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
            echo "$FIRMWARE_FILES"
            for firmware in $FIRMWARE_FILES; do
                if [ -f "$firmware" ]; then
                    cp "$firmware" $GITHUB_WORKSPACE/firmware-output/
                    echo "âœ… å¤åˆ¶: $(basename "$firmware")"
                fi
            done
        else
            echo "âš ï¸ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
            echo "æ„å»ºç›®å½•å†…å®¹:"
            find bin/targets -type f 2>/dev/null | head -20
        fi
        cp .config $GITHUB_WORKSPACE/firmware-output/build-config.txt 2>/dev/null || true
        echo "âœ… æ„å»ºäº§ç‰©æ”¶é›†å®Œæˆ"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ github.run_id }}
        path: firmware-output/
        retention-days: 7

    - name: ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“
      if: success() && inputs.save_config == 'true'
      run: |
        cd $BUILD_DIR
        echo "=== ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“ ==="
        cd $GITHUB_WORKSPACE
        mkdir -p config-backups
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        DEVICE_NAME="${{ github.event.inputs.device_name }}"
        CONFIG_BACKUP_FILE="config-backups/${DEVICE_NAME}_${TIMESTAMP}.config"
        if [ -f "$BUILD_DIR/.config" ]; then
            cp "$BUILD_DIR/.config" "$CONFIG_BACKUP_FILE"
            echo "âœ… é…ç½®æ–‡ä»¶å·²ä¿å­˜: $CONFIG_BACKUP_FILE"
        else
            echo "âš ï¸ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
        fi
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add config-backups/
        git commit -m "ä¿å­˜æ„å»ºé…ç½®: $DEVICE_NAME - $TIMESTAMP" || echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
        git push

    - name: æ„å»ºå®Œæˆé€šçŸ¥
      if: always()
      run: |
        echo "=== æ„å»ºå®ŒæˆçŠ¶æ€ ==="
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… å›ºä»¶æ„å»ºæˆåŠŸå®Œæˆ"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: $SELECTED_REPO/$SELECTED_BRANCH"
        else
          echo "âŒ å›ºä»¶æ„å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi
