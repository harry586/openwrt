# .github/workflows/firmware-build.yml
name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆ - ç¼–è¯‘å™¨é¢„æ„å»ºç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© - ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ã€‚ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ "
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚"
        required: false
        type: string
        default: ""

env:
  BUILD_DIR: "/mnt/openwrt-build"
  REPO_ROOT: "${{ github.workspace }}"
  COMPILER_ROOT: "${{ github.workspace }}/firmware-config/build-Compiler-file"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      # æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç 
      - name: "1. ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç "
        run: |
          echo "=== æ­¥éª¤ 1: ä½¿ç”¨Git Archive APIä¸‹è½½æºä»£ç  ==="
          echo "ğŸ”„ ä»GitHub APIè·å–æºä»£ç å‹ç¼©åŒ…..."
          
          # æ¸…ç©ºå·¥ä½œåŒº
          echo "æ¸…ç©ºå·¥ä½œåŒº..."
          rm -rf ${{ github.workspace }}/*
          
          # è¿›å…¥å·¥ä½œåŒºç›®å½•
          cd ${{ github.workspace }}
          
          # è·å–é»˜è®¤åˆ†æ”¯
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
          
          # ä½¿ç”¨Git Archive APIä¸‹è½½å‹ç¼©åŒ…åˆ°å·¥ä½œåŒº
          echo "ä¸‹è½½æºä»£ç å‹ç¼©åŒ…åˆ°å·¥ä½œåŒº..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" -o source.tar.gz
          
          if [ ! -f "source.tar.gz" ]; then
            echo "âŒ ä¸‹è½½æºä»£ç å‹ç¼©åŒ…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(ls -lh source.tar.gz | awk '{print $5}')"
          
          # è§£å‹å‹ç¼©åŒ…åˆ°å·¥ä½œåŒº
          echo "è§£å‹æºä»£ç åˆ°å·¥ä½œåŒº..."
          tar -xzf source.tar.gz --strip-components=1
          
          # åˆ é™¤å‹ç¼©åŒ…
          rm -f source.tar.gz
          
          # æ£€æŸ¥è§£å‹ç»“æœ
          echo "æ£€æŸ¥æºä»£ç ç»“æ„..."
          if [ -d "firmware-config" ]; then
            echo "âœ… æºä»£ç è§£å‹æˆåŠŸ"
            echo "é‡è¦ç›®å½•å­˜åœ¨: firmware-config"
            
            # æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½•
            if [ -d "firmware-config/build-Compiler-file" ]; then
              echo "ğŸ”§ å‘ç°ç¼–è¯‘å™¨ç›®å½•..."
              compiler_size=$(du -sh firmware-config/build-Compiler-file 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
              echo "ç¼–è¯‘å™¨ç›®å½•å¤§å°: $compiler_size"
              echo "âœ… ç¼–è¯‘å™¨ç›®å½•å­˜åœ¨"
            else
              echo "â„¹ï¸ æœªå‘ç°ç¼–è¯‘å™¨ç›®å½•"
            fi
            
            # å»ºç«‹Artifactsç›®å½•
            echo "ğŸ“¦ å»ºç«‹Artifactsç›®å½•..."
            mkdir -p /tmp/build-artifacts/source-archive
            
            # ä»å·¥ä½œåŒºç›´æ¥åˆ›å»ºæ’é™¤ç¼–è¯‘å™¨ç›®å½•çš„ç²¾ç®€æºä»£ç å‹ç¼©åŒ…
            echo "ğŸ“¦ åˆ›å»ºæ’é™¤ç¼–è¯‘å™¨ç›®å½•çš„ç²¾ç®€æºä»£ç å‹ç¼©åŒ…..."
            echo "æºç›®å½•: ${{ github.workspace }}"
            echo "Artifactsç›®å½•: /tmp/build-artifacts/source-archive/"
            
            # åˆ›å»ºå‹ç¼©åŒ…ï¼Œæ’é™¤ç¼–è¯‘å™¨ç›®å½•å’Œ.gitç›®å½•
            tar -czf /tmp/build-artifacts/source-archive/source-filtered.tar.gz \
              --exclude='firmware-config/build-Compiler-file' \
              --exclude='.git' \
              -C ${{ github.workspace }} .
            
            echo "âœ… ç²¾ç®€æºä»£ç å‹ç¼©åŒ…åˆ›å»ºå®Œæˆ"
            
            # æ˜¾ç¤ºArtifactså†…å®¹å’Œå¤§å°
            echo "ğŸ“‹ æ˜¾ç¤ºArtifactså†…å®¹å’Œå¤§å°..."
            echo "Artifactsç›®å½•å†…å®¹:"
            ls -lh /tmp/build-artifacts/source-archive/
            echo ""
            echo "Artifactsæ€»å¤§å°: $(du -sh /tmp/build-artifacts/source-archive | cut -f1)"
            echo "å‹ç¼©åŒ…å¤§å°: $(ls -lh /tmp/build-artifacts/source-archive/source-filtered.tar.gz | awk '{print $5}')"
            
            # ç¡®ä¿è„šæœ¬æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
            echo "ğŸ”§ è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
            chmod +x firmware-config/scripts/*.sh 2>/dev/null || true
            
            if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
              echo "âœ… ä¸»æ„å»ºè„šæœ¬æƒé™è®¾ç½®å®Œæˆ"
            else
              echo "âŒ ä¸»æ„å»ºè„šæœ¬ä¸å­˜åœ¨"
              exit 1
            fi
            
            # æ˜¾ç¤ºå·¥ä½œåŒºå¤§å°
            echo ""
            echo "ğŸ“Š å·¥ä½œåŒºå¤§å°:"
            echo "å·¥ä½œåŒºæ€»å¤§å°: $(du -sh ${{ github.workspace }} | cut -f1 || echo 'æœªçŸ¥')"
            
            echo "âœ… æ­¥éª¤1å®Œæˆ"
            
          else
            echo "âŒ æºä»£ç è§£å‹å¤±è´¥ï¼Œé‡è¦ç›®å½•ç¼ºå¤±"
            echo "å½“å‰å·¥ä½œåŒºå†…å®¹:"
            ls -la
            exit 1
          fi
      
      # æ­¥éª¤ 2: ä¸Šä¼ ç²¾ç®€æºä»£ç Artifacts
      - name: "2. ä¸Šä¼ ç²¾ç®€æºä»£ç Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: filtered-source-${{ github.event.inputs.device_name }}
          path: /tmp/build-artifacts/source-archive/
          retention-days: 7
          if-no-files-found: error
      
      # æ­¥éª¤ 3: ä¿®å¤æƒé™é—®é¢˜
      - name: "3. ä¿®å¤æƒé™é—®é¢˜"
        run: |
          echo "=== æ­¥éª¤ 3: ä¿®å¤æƒé™é—®é¢˜ ==="
          echo "ğŸ”§ ä¿®å¤æ‰€æœ‰è„šæœ¬çš„æ‰§è¡Œæƒé™..."
          
          # æŸ¥æ‰¾å¹¶ä¿®å¤æ‰€æœ‰è„šæœ¬æ–‡ä»¶çš„æƒé™
          find firmware-config -type f -name "*.sh" -exec chmod +x {} \;
          
          # ä¿®å¤ä¸»è„šæœ¬æƒé™
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x firmware-config/scripts/build_firmware_main.sh
            echo "âœ… ä¿®å¤ä¸»è„šæœ¬æƒé™: firmware-config/scripts/build_firmware_main.sh"
          else
            echo "âŒ ä¸»è„šæœ¬ä¸å­˜åœ¨: firmware-config/scripts/build_firmware_main.sh"
            echo "åˆ—å‡ºfirmware-configç›®å½•å†…å®¹:"
            find firmware-config -type f 2>/dev/null || echo "firmware-configç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æƒé™ä¿®å¤å®Œæˆ"
      
      # æ­¥éª¤ 4: æ·±åº¦æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½•å¹¶æ™ºèƒ½æŸ¥æ‰¾æ­£ç¡®çš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼ˆä¸¤æ­¥æœç´¢æ³•ï¼‰
      - name: "4. æ·±åº¦æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½•å¹¶æ™ºèƒ½æŸ¥æ‰¾ï¼ˆä¸¤æ­¥æœç´¢æ³•ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 4: æ·±åº¦æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½•å¹¶æ™ºèƒ½æŸ¥æ‰¾ï¼ˆä¸¤æ­¥æœç´¢æ³•ï¼‰==="
          
          REPO_ROOT="${{ github.workspace }}"
          COMPILER_ROOT="$REPO_ROOT/firmware-config/build-Compiler-file"
          
          echo "ğŸ“ ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
          echo "ğŸ”§ ç¼–è¯‘å™¨æ ¹ç›®å½•: $COMPILER_ROOT"
          
          # æ£€æŸ¥ç¼–è¯‘å™¨æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$COMPILER_ROOT" ]; then
            echo "âš ï¸ ç¼–è¯‘å™¨æ ¹ç›®å½•ä¸å­˜åœ¨äºå·¥ä½œç©ºé—´"
            echo "COMPILER_DIR=" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "âœ… ç¼–è¯‘å™¨æ ¹ç›®å½•å­˜åœ¨äºå·¥ä½œç©ºé—´"
          
          # æ˜¾ç¤ºç¼–è¯‘å™¨ç›®å½•ç»“æ„
          echo "ğŸ“Š ç¼–è¯‘å™¨ç›®å½•ç»“æ„ï¼ˆæ·±åº¦3ï¼‰:"
          find "$COMPILER_ROOT" -maxdepth 3 -type d 2>/dev/null | while read dir; do
            dir_name=$(basename "$dir")
            relative_path=$(echo "$dir" | sed "s|$COMPILER_ROOT/||")
            echo "  $dir_name/ [$relative_path]"
          done
          
          # æ ¹æ®è®¾å¤‡ç¡®å®šå¹³å°å’Œç±»å‹å…³é”®è¯
          DEVICE_NAME="${{ github.event.inputs.device_name }}"
          echo "ğŸ¯ è®¾å¤‡åç§°: $DEVICE_NAME"
          
          # ç¡®å®šå¹³å°ç±»å‹
          if [[ "$DEVICE_NAME" == "ac42u" || "$DEVICE_NAME" == "acrh17" ]]; then
            TARGET_PLATFORM="arm"
            TYPE_KEYWORDS=("arm_cortex-a7" "arm")
            echo "å¹³å°: ARM"
            echo "ç±»å‹å…³é”®è¯: ${TYPE_KEYWORDS[*]}"
          elif [[ "$DEVICE_NAME" == "mi_router_4a_gigabit" || "$DEVICE_NAME" == "r4ag" ]]; then
            TARGET_PLATFORM="mips"
            TYPE_KEYWORDS=("mips")
            echo "å¹³å°: MIPS (MT76x8)"
            echo "ç±»å‹å…³é”®è¯: ${TYPE_KEYWORDS[*]}"
          elif [[ "$DEVICE_NAME" == "mi_router_3g" || "$DEVICE_NAME" == "r3g" ]]; then
            TARGET_PLATFORM="mips"
            TYPE_KEYWORDS=("mips")
            echo "å¹³å°: MIPS (MT7621)"
            echo "ç±»å‹å…³é”®è¯: ${TYPE_KEYWORDS[*]}"
          else
            TARGET_PLATFORM="generic"
            TYPE_KEYWORDS=("compilers")
            echo "å¹³å°: é€šç”¨"
            echo "ç±»å‹å…³é”®è¯: ${TYPE_KEYWORDS[*]}"
          fi
          
          FOUND_COMPILER_DIR=""
          
          # ç¬¬ä¸€æ­¥ï¼šæŒ‰ç±»å‹å…³é”®è¯æœç´¢ç›®å½•
          echo ""
          echo "ğŸ” ç¬¬ä¸€æ­¥ï¼šæŒ‰ç±»å‹å…³é”®è¯æœç´¢ç›®å½•"
          
          for keyword in "${TYPE_KEYWORDS[@]}"; do
            echo "  æœç´¢å…³é”®è¯: '$keyword'"
            
            TYPE_DIRS=$(find "$COMPILER_ROOT" -type d -iname "*$keyword*" 2>/dev/null | head -10)
            
            if [ -n "$TYPE_DIRS" ]; then
              echo "  âœ… æ‰¾åˆ°åŒ¹é…ç±»å‹ç›®å½•:"
              
              while read type_dir; do
                echo "    ğŸ“ $type_dir"
                
                # ç¬¬äºŒæ­¥ï¼šåœ¨ç±»å‹ç›®å½•å†…æœç´¢çœŸæ­£çš„GCCç¼–è¯‘å™¨
                echo "    ğŸ” ç¬¬äºŒæ­¥ï¼šåœ¨è¯¥ç›®å½•å†…æœç´¢çœŸæ­£çš„GCCç¼–è¯‘å™¨æ–‡ä»¶"
                
                GCC_FILES=$(find "$type_dir" -type f -executable \
                  -name "*gcc" \
                  ! -name "*gcc-ar" \
                  ! -name "*gcc-ranlib" \
                  ! -name "*gcc-nm" \
                  2>/dev/null | head -3)
                
                if [ -n "$GCC_FILES" ]; then
                  echo "    âœ… æ‰¾åˆ°çœŸæ­£çš„GCCç¼–è¯‘å™¨æ–‡ä»¶:"
                  echo "$GCC_FILES" | while read gcc_file; do
                    echo "      ğŸ“„ $(basename "$gcc_file")"
                  done
                  
                  # å–ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„GCCæ–‡ä»¶
                  FIRST_GCC=$(echo "$GCC_FILES" | head -1)
                  GCC_DIR=$(dirname "$FIRST_GCC")
                  
                  # å¦‚æœgccåœ¨binç›®å½•ä¸­ï¼Œä½¿ç”¨çˆ¶ç›®å½•
                  if [[ "$GCC_DIR" == */bin ]]; then
                    FOUND_COMPILER_DIR=$(dirname "$GCC_DIR")
                    echo "    ğŸ“ GCCåœ¨binç›®å½•ä¸­ï¼Œä½¿ç”¨çˆ¶ç›®å½•: $FOUND_COMPILER_DIR"
                  else
                    FOUND_COMPILER_DIR="$GCC_DIR"
                    echo "    ğŸ“ GCCæ‰€åœ¨ç›®å½•: $FOUND_COMPILER_DIR"
                  fi
                  
                  # éªŒè¯ç¼–è¯‘å™¨ç‰ˆæœ¬
                  echo "    ğŸ”§ éªŒè¯ç¼–è¯‘å™¨ç‰ˆæœ¬..."
                  VERSION=$("$FIRST_GCC" --version 2>&1 | head -1)
                  echo "     ç‰ˆæœ¬ä¿¡æ¯: $VERSION"
                  
                  # æ£€æŸ¥ä¸»è¦ç‰ˆæœ¬
                  MAJOR_VERSION=$(echo "$VERSION" | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1 | cut -d. -f1)
                  if [ -n "$MAJOR_VERSION" ]; then
                    if [ "$MAJOR_VERSION" -ge 8 ] && [ "$MAJOR_VERSION" -le 15 ]; then
                      echo "      âœ… GCC $MAJOR_VERSION.x ç‰ˆæœ¬å…¼å®¹"
                    else
                      echo "      âš ï¸ GCCç‰ˆæœ¬ $MAJOR_VERSION.x å¯èƒ½ä¸å…¼å®¹ï¼ˆæœŸæœ›8-15ï¼‰"
                    fi
                  fi
                  
                  break 2
                else
                  echo "    âš ï¸ è¯¥ç›®å½•æœªæ‰¾åˆ°çœŸæ­£çš„GCCç¼–è¯‘å™¨æ–‡ä»¶"
                  
                  # æ˜¾ç¤ºè¯¥ç›®å½•ä¸­çš„å…¶ä»–æ–‡ä»¶
                  OTHER_FILES=$(find "$type_dir" -type f \( -name "*gcc*" -o -name "*g++*" \) 2>/dev/null | head -5)
                  if [ -n "$OTHER_FILES" ]; then
                    echo "    æ‰¾åˆ°çš„å…¶ä»–æ–‡ä»¶:"
                    echo "$OTHER_FILES" | while read file; do
                      echo "      - $(basename "$file")"
                    done
                  fi
                fi
              done <<< "$TYPE_DIRS"
            else
              echo "  âš ï¸ æœªæ‰¾åˆ°åŒ¹é… '$keyword' çš„ç›®å½•"
            fi
          done
          
          # æœ€ç»ˆå†³ç­–
          if [ -n "$FOUND_COMPILER_DIR" ]; then
            echo ""
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨ç›®å½•: $FOUND_COMPILER_DIR"
            echo "COMPILER_DIR=$FOUND_COMPILER_DIR" >> $GITHUB_ENV
          else
            echo ""
            echo "âŒ æœªæ‰¾åˆ°åˆé€‚çš„ç¼–è¯‘å™¨ç›®å½•"
            echo "â„¹ï¸ å°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
            echo "COMPILER_DIR=" >> $GITHUB_ENV
          fi
          
          echo "âœ… ç¼–è¯‘å™¨æœç´¢å®Œæˆ"
      
      # æ­¥éª¤ 5: åˆå§‹ç©ºé—´æ£€æŸ¥
      - name: "5. åˆå§‹ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 5: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "âŒ é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
            exit 1
          fi
          echo "âœ… åˆå§‹ç©ºé—´æ£€æŸ¥é€šè¿‡"
      
      # æ­¥éª¤ 6: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•
      - name: "6. è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•"
        run: |
          echo "=== æ­¥éª¤ 6: è®¾ç½®ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½• ==="
          
          echo "ğŸ”„ æ­¥éª¤ 6.1: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          chmod +x firmware-config/scripts/build_firmware_main.sh
          firmware-config/scripts/build_firmware_main.sh setup_environment
          
          echo "ğŸ”„ æ­¥éª¤ 6.2: åˆ›å»ºæ„å»ºç›®å½•"
          firmware-config/scripts/build_firmware_main.sh create_build_dir
          
          echo "ğŸ”„ æ­¥éª¤ 6.3: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
          echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          echo "ğŸ”„ æ­¥éª¤ 6.4: åˆå§‹åŒ–ç¼–è¯‘å™¨ç¯å¢ƒï¼ˆä½¿ç”¨ä¸¤æ­¥æœç´¢æ³•ï¼‰"
          firmware-config/scripts/build_firmware_main.sh initialize_compiler_env "${{ github.event.inputs.device_name }}"
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºç›®å½•è®¾ç½®å®Œæˆ"
      
      # æ­¥éª¤ 7: æ·»åŠ  TurboACC æ”¯æŒ
      - name: "7. æ·»åŠ  TurboACC æ”¯æŒ"
        run: |
          echo "=== æ­¥éª¤ 7: æ·»åŠ  TurboACC æ”¯æŒ ==="
          firmware-config/scripts/build_firmware_main.sh add_turboacc_support
      
      # æ­¥éª¤ 8: é…ç½®Feeds
      - name: "8. é…ç½®Feeds"
        run: |
          echo "=== æ­¥éª¤ 8: é…ç½®Feeds ==="
          firmware-config/scripts/build_firmware_main.sh configure_feeds
      
      # æ­¥éª¤ 9: å®‰è£… TurboACC åŒ…
      - name: "9. å®‰è£… TurboACC åŒ…"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== æ­¥éª¤ 9: å®‰è£… TurboACC åŒ… ==="
          firmware-config/scripts/build_firmware_main.sh install_turboacc_packages
      
      # æ­¥éª¤ 10: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      - name: "10. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 10: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh pre_build_space_check
      
      # æ­¥éª¤ 11: æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
      - name: "11. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
        run: |
          echo "=== æ­¥éª¤ 11: æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
          echo "ğŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼"
          firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
      
      # æ­¥éª¤ 12: éªŒè¯USBé…ç½®
      - name: "12. éªŒè¯USBé…ç½®"
        run: |
          echo "=== æ­¥éª¤ 12: éªŒè¯USBé…ç½® ==="
          firmware-config/scripts/build_firmware_main.sh verify_usb_config
      
      # æ­¥éª¤ 13: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
      - name: "13. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 13: USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity
      
      # æ­¥éª¤ 14: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
      - name: "14. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
        run: |
          echo "=== æ­¥éª¤ 14: åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ… ==="
          
          # å…ˆä¿å­˜åŸå§‹é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            cp "${{ env.BUILD_DIR }}/.config" "${{ env.BUILD_DIR }}/.config.original"
            echo "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶"
          fi
          
          # åº”ç”¨é…ç½®
          firmware-config/scripts/build_firmware_main.sh apply_config
          
          echo "âœ… é…ç½®è¯¦æƒ…æ£€æŸ¥å®Œæˆ"
      
      # æ­¥éª¤ 15: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
      - name: "15. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 15: æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
            mkdir -p firmware-config/config-backup
            
            # å¤‡ä»½åˆ°ä»“åº“ç›®å½•
            timestamp=$(date +%Y%m%d_%H%M%S)
            backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$timestamp.config"
            
            cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      # æ­¥éª¤ 16: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      - name: "16. ä¿®å¤ç½‘ç»œç¯å¢ƒ"
        run: |
          echo "=== æ­¥éª¤ 16: ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
          firmware-config/scripts/build_firmware_main.sh fix_network
      
      # æ­¥éª¤ 17: ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¸¦é‡è¯•ï¼‰
      - name: "17. ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¸¦é‡è¯•ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 17: ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¸¦é‡è¯•ï¼‰ ==="
          
          # æœ€å¤šé‡è¯•3æ¬¡
          for i in {1..3}; do
            echo "ğŸ” ä¸‹è½½ä¾èµ–åŒ… - ç¬¬ $i æ¬¡å°è¯•"
            
            firmware-config/scripts/build_firmware_main.sh download_dependencies
            
            # æ£€æŸ¥ä¸‹è½½ç»“æœ
            if [ $? -eq 0 ] && [ $(find ${{ env.BUILD_DIR }}/dl -type f 2>/dev/null | wc -l) -gt 100 ]; then
              echo "âœ… ä¾èµ–åŒ…ä¸‹è½½æˆåŠŸ"
              break
            else
              echo "âš ï¸ ç¬¬ $i æ¬¡ä¸‹è½½ä¸å®Œæ•´ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
              sleep 10
            fi
          done
          
          # æœ€ç»ˆæ£€æŸ¥
          dl_count=$(find ${{ env.BUILD_DIR }}/dl -type f 2>/dev/null | wc -l)
          echo "ğŸ“Š æœ€ç»ˆä¾èµ–åŒ…æ•°é‡: $dl_count ä¸ª"
          
          if [ $dl_count -lt 50 ]; then
            echo "âŒ ä¾èµ–åŒ…æ•°é‡ä¸è¶³ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥"
            echo "ğŸ’¡ å»ºè®®æ‰‹åŠ¨ä¸‹è½½æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥"
          fi
      
      # æ­¥éª¤ 18: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      - name: "18. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
        run: |
          echo "=== æ­¥éª¤ 18: é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
          firmware-config/scripts/build_firmware_main.sh integrate_custom_files
      
      # æ­¥éª¤ 19: å‰ç½®é”™è¯¯æ£€æŸ¥
      - name: "19. å‰ç½®é”™è¯¯æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 19: å‰ç½®é”™è¯¯æ£€æŸ¥ ==="
          firmware-config/scripts/build_firmware_main.sh pre_build_error_check
      
      # æ­¥éª¤ 20: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
      - name: "20. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
        run: |
          echo "=== æ­¥éª¤ 20: ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥ ==="
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
      
      # æ­¥éª¤ 21: ç¼–è¯‘å›ºä»¶
      - name: "21. ç¼–è¯‘å›ºä»¶"
        run: |
          echo "=== æ­¥éª¤ 21: ç¼–è¯‘å›ºä»¶ ==="
          echo "ğŸ”§ ä½¿ç”¨ä¸¤æ­¥æœç´¢æ³•æ‰¾åˆ°çš„ç¼–è¯‘å™¨..."
          
          # æ˜¾ç¤ºç¼–è¯‘å™¨ä¿¡æ¯
          echo "ğŸ“Œ ç¼–è¯‘å™¨è°ƒç”¨ä¿¡æ¯:"
          echo "  ç¼–è¯‘å™¨æ ¹ç›®å½•: ${{ env.COMPILER_ROOT }}"
          echo "  ç¼–è¯‘å™¨ç›®å½•: ${{ env.COMPILER_DIR }}"
          
          # æ£€æŸ¥ç¼–è¯‘å™¨ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -n "${{ env.COMPILER_DIR }}" ] && [ -d "${{ env.COMPILER_DIR }}" ]; then
            echo "  âœ… é¢„æ„å»ºç¼–è¯‘å™¨ç›®å½•å­˜åœ¨"
            echo "  ç›®å½•å†…å®¹é¢„è§ˆ:"
            find "${{ env.COMPILER_DIR }}" -maxdepth 2 -type f -name "*gcc*" 2>/dev/null | head -5
          else
            echo "  â„¹ï¸ æœªè®¾ç½®é¢„æ„å»ºç¼–è¯‘å™¨ç›®å½•ï¼Œå°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
          fi
          
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘..."
          firmware-config/scripts/build_firmware_main.sh build_firmware "true"
      
      # æ­¥éª¤ 22: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: "22. æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰©"
        if: success()
        run: |
          echo "=== æ­¥éª¤ 22: æœç´¢å¹¶æ‰“åŒ…æ„å»ºäº§ç‰© ==="
          cd ${{ env.BUILD_DIR }}
          
          # åˆ›å»ºæ„å»ºäº§ç‰©ç›®å½•
          mkdir -p /tmp/build-artifacts
          
          # æ‰“åŒ…å›ºä»¶æ–‡ä»¶
          if [ -d "bin/targets" ]; then
            echo "æ‰“åŒ…å›ºä»¶æ–‡ä»¶..."
            tar -czf /tmp/build-artifacts/firmware.tar.gz -C bin targets/
            echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆ"
          else
            echo "âš ï¸ bin/targetsç›®å½•ä¸å­˜åœ¨"
          fi
          
          # æ‰“åŒ…ç¼–è¯‘æ—¥å¿—
          if [ -f "build.log" ]; then
            echo "æ‰“åŒ…ç¼–è¯‘æ—¥å¿—..."
            cp build.log /tmp/build-artifacts/build.log
            echo "âœ… æ—¥å¿—æ‰“åŒ…å®Œæˆ"
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©å‡†å¤‡å®Œæˆ"
      
      # æ­¥éª¤ 23: ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•
      - name: "23. ä¸Šä¼ å›ºä»¶åŸå§‹ç›®å½•"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
          if-no-files-found: error
      
      # æ­¥éª¤ 24: ä¸Šä¼ é…ç½®æ–‡ä»¶
      - name: "24. ä¸Šä¼ é…ç½®æ–‡ä»¶"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
          if-no-files-found: error
      
      # æ­¥éª¤ 25: æ‰§è¡Œé”™è¯¯åˆ†æ
      - name: "25. æ‰§è¡Œé”™è¯¯åˆ†æ"
        if: always()
        run: |
          echo "=== æ­¥éª¤ 25: æ‰§è¡Œé”™è¯¯åˆ†æ ==="
          
          # æ£€æŸ¥é”™è¯¯åˆ†æè„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ -f "firmware-config/scripts/error_analysis.sh" ]; then
            echo "âœ… æ‰¾åˆ°é”™è¯¯åˆ†æè„šæœ¬"
            chmod +x firmware-config/scripts/error_analysis.sh
            firmware-config/scripts/error_analysis.sh
          else
            echo "âš ï¸ é”™è¯¯åˆ†æè„šæœ¬ä¸å­˜åœ¨"
          fi
      
      # æ­¥éª¤ 26: ç¼–è¯‘åç©ºé—´æ£€æŸ¥
      - name: "26. ç¼–è¯‘åç©ºé—´æ£€æŸ¥"
        if: always()
        run: firmware-config/scripts/build_firmware_main.sh post_build_space_check
