name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œæ•´ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u)'
        required: true
        default: 'ac42u'
        type: string
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
          - '23.05'
          - '21.02'
      config_mode:
        description: 'âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹© - ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘ï¼šâœ… æ–‡ä»¶ä¼ è¾“ã€‚ ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®ï¼šâœ… TurboACC ç½‘ç»œåŠ é€Ÿ âœ… UPnP è‡ªåŠ¨ç«¯å£è½¬å‘ âœ… Samba æ–‡ä»¶å…±äº« âœ… ç£ç›˜ç®¡ç† âœ… KMS æ¿€æ´»æœåŠ¡ âœ… SmartDNS æ™ºèƒ½DNS âœ… å®¶é•¿æ§åˆ¶ âœ… å¾®ä¿¡æ¨é€ âœ… æµé‡æ§åˆ¶ (SQM) âœ… FTP æœåŠ¡å™¨ âœ… ARP ç»‘å®š âœ… CPU é™åˆ¶ âœ… ç¡¬ç›˜ä¼‘çœ ã€‚'
        required: true
        type: choice
        default: 'normal'
        options:
          - 'base'
          - 'normal'
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ - æ ¼å¼ï¼šğŸ”´ç”¨é¡¿å·ã€åˆ†éš”ã€‚ğŸ”´ å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ğŸ”´ ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚ğŸ”´ ç¤ºä¾‹ï¼š+luci-app-wolã€+luci-app-ddns'
        required: false
        type: string
        default: ''
      enable_cache:
        description: 'âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜ (åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹)'
        required: false
        default: true
        type: boolean
      rebuild_toolchain:
        description: 'ğŸ”„ å¼ºåˆ¶é‡æ–°æ„å»ºå·¥å…·é“¾'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'ğŸ› å¯ç”¨è°ƒè¯•æ¨¡å¼ (æ˜¾ç¤ºæ›´å¤šè¯¦ç»†ä¿¡æ¯)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build
  TOOLCHAIN_DIR: /mnt/openwrt-toolchain
  WORKSPACE: ${{ github.workspace }}
  DEBUG_MODE: ${{ github.event.inputs.debug_mode }}

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: æ˜¾ç¤ºå·¥ä½œç©ºé—´ä¿¡æ¯
      run: |
        echo "=== å·¥ä½œç©ºé—´ä¿¡æ¯ ==="
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "ç”¨æˆ·: $(whoami)"
        echo "ä¸»æœºå: $(hostname)"
        echo "GitHubå·¥ä½œåŒº: $WORKSPACE"
        echo ""
        echo "ç›®å½•ç»“æ„:"
        ls -la
        echo ""
        echo "è„šæœ¬ç›®å½•:"
        ls -la firmware-config/scripts/ 2>/dev/null || echo "scriptsç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•:"
        ls -la firmware-config/custom-files/ 2>/dev/null || echo "custom-filesç›®å½•ä¸å­˜åœ¨"

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        echo "è®¾ç½®æ‰€æœ‰.shæ–‡ä»¶å¯æ‰§è¡Œæƒé™..."
        find . -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null || true
        echo "æƒé™è®¾ç½®å®Œæˆ:"
        ls -la firmware-config/scripts/*.sh 2>/dev/null | head -10

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo ""
        echo "/mnt åˆ†åŒºè¯¦æƒ…:"
        df -h /mnt
        echo ""
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "ğŸ“Š /mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 30 ]; then
          echo "âš ï¸ è­¦å‘Š: /mnt ç©ºé—´ä¸è¶³30Gï¼Œå¯èƒ½ç¼–è¯‘å¤±è´¥"
        else
          echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
        fi

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        INSTALL_LOG="/tmp/install_deps_$(date +%Y%m%d_%H%M%S).log"
        echo "å®‰è£…æ—¥å¿—: $INSTALL_LOG"
        echo "1. æ›´æ–°åŒ…åˆ—è¡¨..."
        sudo apt-get update 2>&1 | tee $INSTALL_LOG
        echo ""
        echo "2. å®‰è£…ç¼–è¯‘OpenWrtæ‰€éœ€çš„æ‰€æœ‰ä¾èµ–åŒ…..."
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo cmake jq ccache u-boot-tools gperf nodejs npm swig time xsltproc libxml2-utils 2>&1 | tee -a $INSTALL_LOG
        echo ""
        echo "3. æ£€æŸ¥å…³é”®å·¥å…·å®‰è£…æƒ…å†µ:"
        echo "gcc: $(gcc --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "g++: $(g++ --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "make: $(make --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "cmake: $(cmake --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "git: $(git --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "python3: $(python3 --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "ccache: $(ccache --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: ä¸‹è½½å·¥å…·é“¾ç¼“å­˜
      uses: actions/download-artifact@v4
      with:
        name: openwrt-toolchain-cache
        path: ${{ env.TOOLCHAIN_DIR }}
      continue-on-error: true

    - name: æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€
      run: |
        echo "=== æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€ ==="
        echo "å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
        
        if [ -d "$TOOLCHAIN_DIR" ]; then
          echo "âœ… å·¥å…·é“¾ç›®å½•å­˜åœ¨"
          echo "ğŸ“¦ å·¥å…·é“¾ç¼“å­˜å†…å®¹:"
          find $TOOLCHAIN_DIR -type f -name "*.txt" -o -name "*.json" 2>/dev/null | head -10
          echo ""
          echo "å·¥å…·é“¾æ•°æ®åº“:"
          if [ -f "$TOOLCHAIN_DIR/toolchain_db.json" ]; then
            cat $TOOLCHAIN_DIR/toolchain_db.json | head -20
          else
            echo "âŒ å·¥å…·é“¾æ•°æ®åº“ä¸å­˜åœ¨"
          fi
        else
          echo "âŒ å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°æ„å»º"
        fi

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        echo "åˆ›å»ºç›®å½•: $BUILD_DIR"
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        echo "ç›®å½•æƒé™è®¾ç½®å®Œæˆ:"
        ls -ld $BUILD_DIR

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      id: init_env
      run: |
        echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
        echo "è®¾å¤‡: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
        echo "é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
        echo ""
        echo "å½“å‰ç›®å½•: $(pwd)"
        
        # å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½•
        echo "å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½•..."
        cp -f "$WORKSPACE/firmware-config/scripts/build_firmware_main.sh" $BUILD_DIR/
        chmod +x $BUILD_DIR/build_firmware_main.sh
        
        cd $BUILD_DIR
        echo "åˆ‡æ¢åˆ°æ„å»ºç›®å½•: $BUILD_DIR"
        
        # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
        ./build_firmware_main.sh initialize_build_env \
          "${{ github.event.inputs.device_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.config_mode }}"
        
        # è¯»å–ç¯å¢ƒå˜é‡
        if [ -f "build_env.sh" ]; then
          echo ""
          echo "=== ç”Ÿæˆçš„ç¯å¢ƒå˜é‡ ==="
          cat build_env.sh
          
          # å¯¼å‡ºåˆ°GitHubç¯å¢ƒ
          source build_env.sh
          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_OUTPUT
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_OUTPUT
          echo "DEVICE=$DEVICE" >> $GITHUB_OUTPUT
          echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
        else
          echo "âŒ ç¯å¢ƒæ–‡ä»¶æœªåˆ›å»º"
          exit 1
        fi

    - name: é…ç½®Feeds
      run: |
        echo "=== é…ç½®Feeds ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh configure_feeds

    - name: æ·»åŠ TurboACCæ”¯æŒ
      if: github.event.inputs.config_mode == 'normal' && steps.init_env.outputs.SELECTED_BRANCH == 'openwrt-23.05'
      run: |
        echo "=== æ·»åŠ TurboACCæ”¯æŒ ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh add_turboacc_support

    - name: å®‰è£…æ’ä»¶åŒ…
      run: |
        echo "=== å®‰è£…æ’ä»¶åŒ… ==="
        cd $BUILD_DIR
        
        echo "1. å®‰è£…æ–‡ä»¶ä¼ è¾“æ’ä»¶åŒ…:"
        ./build_firmware_main.sh install_filetransfer_packages
        
        if [ "${{ github.event.inputs.config_mode }}" = "normal" ] && [ "${{ steps.init_env.outputs.SELECTED_BRANCH }}" = "openwrt-23.05" ]; then
          echo ""
          echo "2. å®‰è£…TurboACCåŒ…:"
          ./build_firmware_main.sh install_turboacc_packages
        fi

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
        df -h
        echo ""
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "ğŸ“Š /mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        
        if [ -d "$TOOLCHAIN_DIR" ]; then
          echo ""
          echo "ğŸ“¦ å·¥å…·é“¾ç¼“å­˜å¤§å°:"
          du -sh $TOOLCHAIN_DIR
        fi

    - name: æ™ºèƒ½é…ç½®ç”Ÿæˆ
      run: |
        echo "=== æ™ºèƒ½é…ç½®ç”Ÿæˆ ==="
        cd $BUILD_DIR
        
        echo "ç”Ÿæˆé…ç½®ï¼Œé¢å¤–æ’ä»¶: ${{ github.event.inputs.extra_packages }}"
        ./build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
        
        echo ""
        echo "ğŸ“‹ ç”Ÿæˆçš„é…ç½®æ‘˜è¦:"
        if [ -f ".config" ]; then
          echo "âœ… å¯ç”¨åŒ…æ•°é‡: $(grep "^CONFIG_PACKAGE_.*=y$" .config 2>/dev/null | wc -l)"
          echo "âŒ ç¦ç”¨åŒ…æ•°é‡: $(grep "^# CONFIG_PACKAGE_.* is not set$" .config 2>/dev/null | wc -l)"
          
          if [ "$DEBUG_MODE" = "true" ]; then
            echo ""
            echo "=== å¯ç”¨çš„æ’ä»¶åˆ—è¡¨ ==="
            grep "^CONFIG_PACKAGE_luci-app-.*=y$" .config 2>/dev/null | sed 's/CONFIG_PACKAGE_//;s/=y//' | head -20
          fi
        else
          echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        fi

    - name: éªŒè¯USBé…ç½®
      run: |
        echo "=== éªŒè¯USBé…ç½® ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh verify_usb_config

    - name: åº”ç”¨é…ç½®
      run: |
        echo "=== åº”ç”¨é…ç½® ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh apply_config

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh fix_network

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        cd $BUILD_DIR
        
        echo "å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…..."
        ./build_firmware_main.sh download_dependencies
        
        echo ""
        echo "ğŸ“¦ ä¸‹è½½ç›®å½•å†…å®¹:"
        ls -la dl/ 2>/dev/null | head -5 || echo "ä¸‹è½½ç›®å½•ä¸ºç©º"

    - name: å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶
      run: |
        echo "=== å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶ ==="
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo ""
        
        # è¯¦ç»†æ£€æŸ¥ç›®å½•ç»“æ„
        echo "=== ç›®å½•ç»“æ„æ£€æŸ¥ ==="
        echo "1. æ£€æŸ¥å½“å‰ç›®å½•:"
        ls -la
        
        echo ""
        echo "2. æ£€æŸ¥ firmware-config ç›®å½•:"
        if [ -d "firmware-config" ]; then
          echo "âœ… firmware-config ç›®å½•å­˜åœ¨"
          ls -la firmware-config/
          
          echo ""
          echo "3. æ£€æŸ¥ custom-files ç›®å½•:"
          if [ -d "firmware-config/custom-files" ]; then
            echo "âœ… firmware-config/custom-files ç›®å½•å­˜åœ¨"
            echo "ç›®å½•å†…å®¹:"
            ls -la firmware-config/custom-files/
            
            echo ""
            echo "4. æŸ¥æ‰¾æ‰€æœ‰è‡ªå®šä¹‰æ–‡ä»¶:"
            find firmware-config/custom-files -type f | while read file; do
              echo "ğŸ“„ $file"
            done
          else
            echo "âŒ firmware-config/custom-files ç›®å½•ä¸å­˜åœ¨"
            echo "å°è¯•æŸ¥æ‰¾å…¶ä»–ä½ç½®..."
            find . -name "custom-files" -type d 2>/dev/null | head -5
          fi
        else
          echo "âŒ firmware-config ç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "=== å¼€å§‹å¤„ç†è‡ªå®šä¹‰æ–‡ä»¶ ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh process_custom_files

    - name: ç¼–è¯‘å›ºä»¶
      id: build_firmware
      run: |
        echo "=== ç¼–è¯‘å›ºä»¶ ==="
        cd $BUILD_DIR
        
        echo "ç¼–è¯‘å‚æ•°:"
        echo "  ç¼“å­˜æ¨¡å¼: ${{ github.event.inputs.enable_cache }}"
        echo "  CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "  è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug_mode }}"
        echo ""
        
        # è®°å½•å¼€å§‹æ—¶é—´
        START_TIME=$(date +%s)
        echo "â° ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        
        # æ‰§è¡Œç¼–è¯‘
        ./build_firmware_main.sh build_firmware "${{ github.event.inputs.enable_cache }}"
        BUILD_EXIT_CODE=$?
        
        # è®°å½•ç»“æŸæ—¶é—´
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo ""
        echo "â±ï¸ ç¼–è¯‘è€—æ—¶: $((DURATION / 60))åˆ†é’Ÿ $((DURATION % 60))ç§’"
        
        # è®¾ç½®æ­¥éª¤ç»“æœ
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ… ç¼–è¯‘å®Œæˆ"
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç : $BUILD_EXIT_CODE"
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
        fi

    - name: è¯¦ç»†é”™è¯¯åˆ†æ
      if: always()
      run: |
        echo "=== è¯¦ç»†é”™è¯¯åˆ†æ ==="
        cd $BUILD_DIR
        
        # é¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨æ—¥å¿—æ–‡ä»¶
        echo "æ£€æŸ¥æ—¥å¿—æ–‡ä»¶..."
        if [ -f "build.log" ]; then
          echo "âœ… æ‰¾åˆ°ç¼–è¯‘æ—¥å¿—: build.log"
          LOG_SIZE=$(wc -l < build.log)
          echo "ğŸ“Š æ—¥å¿—å¤§å°: $LOG_SIZE è¡Œ"
          echo "ğŸ“„ æ—¥å¿—å¤§å°: $(du -h build.log | cut -f1)"
          
          # ä½¿ç”¨è¯¦ç»†é”™è¯¯åˆ†æè„šæœ¬
          if [ -f "$WORKSPACE/firmware-config/scripts/error_analysis_detailed.sh" ]; then
            $WORKSPACE/firmware-config/scripts/error_analysis_detailed.sh
          else
            echo "âš ï¸ è¯¦ç»†é”™è¯¯åˆ†æè„šæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç®€å•åˆ†æ"
            echo "æœ€å100è¡Œæ—¥å¿—:"
            tail -100 build.log
          fi
        else
          echo "âŒ ç¼–è¯‘æ—¥å¿—ä¸å­˜åœ¨"
          echo "å¯èƒ½çš„åŸå› :"
          echo "1. ç¼–è¯‘æœªå¼€å§‹"
          echo "2. ç¼–è¯‘è¿‡ç¨‹è¢«ä¸­æ–­"
          echo "3. ç£ç›˜ç©ºé—´ä¸è¶³"
          echo ""
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
        fi

    - name: å›ºä»¶æ–‡ä»¶æ£€æŸ¥
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      run: |
        echo "=== å›ºä»¶æ–‡ä»¶æ£€æŸ¥ ==="
        cd $BUILD_DIR
        
        echo "æ£€æŸ¥å›ºä»¶æ–‡ä»¶..."
        ./build_firmware_main.sh check_firmware_files
        
        echo ""
        echo "=== ç”Ÿæˆçš„å›ºä»¶è¯¦æƒ… ==="
        FIRMWARE_FILES=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) 2>/dev/null | head -10)
        if [ -n "$FIRMWARE_FILES" ]; then
          for file in $FIRMWARE_FILES; do
            size=$(du -h "$file" | cut -f1)
            echo "âœ… ğŸ“„ $file ($size)"
          done
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "å¯èƒ½çš„åŸå› :"
          echo "1. ç¼–è¯‘å¤±è´¥"
          echo "2. è¾“å‡ºè·¯å¾„é”™è¯¯"
          echo "3. è®¾å¤‡é…ç½®é”™è¯¯"
        fi

    - name: å¤‡ä»½é…ç½®æ–‡ä»¶
      if: always()
      run: |
        echo "=== å¤‡ä»½é…ç½®æ–‡ä»¶ ==="
        cd $BUILD_DIR
        ./build_firmware_main.sh backup_config
        
        echo ""
        echo "ğŸ“ å¤‡ä»½å†…å®¹:"
        ls -la config_backup/ 2>/dev/null || echo "æ²¡æœ‰å¤‡ä»½æ–‡ä»¶"

    - name: æ„å»ºå·¥å…·é“¾ï¼ˆå¦‚éœ€ï¼‰
      if: steps.init_env.outputs.SELECTED_BRANCH != '' && (failure() || github.event.inputs.rebuild_toolchain == 'true')
      run: |
        echo "=== æ„å»ºå·¥å…·é“¾ ==="
        cd $BUILD_DIR
        
        # åŠ è½½ç¯å¢ƒå˜é‡
        if [ -f "build_env.sh" ]; then
          source build_env.sh
        else
          echo "âŒ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "æ„å»ºå·¥å…·é“¾: $SELECTED_BRANCH-$TARGET-$SUBTARGET"
        
        # åˆ›å»ºå·¥å…·é“¾é…ç½®
        echo "CONFIG_TARGET_${TARGET}=y" > .config.toolchain
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config.toolchain
        echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config.toolchain
        echo "CONFIG_TOOLCHAIN=y" >> .config.toolchain
        echo "CONFIG_TOOLCHAIN_BUILD=y" >> .config.toolchain
        echo "CONFIG_SDK=y" >> .config.toolchain
        echo "CONFIG_IB=y" >> .config.toolchain
        
        echo "åº”ç”¨å·¥å…·é“¾é…ç½®..."
        cp .config.toolchain .config
        make defconfig
        
        echo "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
        make toolchain/install -j2 V=s
        
        # ä¿å­˜å·¥å…·é“¾
        echo "ğŸ’¾ ä¿å­˜å·¥å…·é“¾..."
        mkdir -p $TOOLCHAIN_DIR
        if [ -d "staging_dir" ]; then
          cp -r staging_dir/* $TOOLCHAIN_DIR/
          echo "âœ… å·¥å…·é“¾ä¿å­˜åˆ°: $TOOLCHAIN_DIR"
          
          # åˆ›å»ºå·¥å…·é“¾ä¿¡æ¯
          echo "å·¥å…·é“¾ä¿¡æ¯:" > $TOOLCHAIN_DIR/toolchain_info.txt
          echo "ç‰ˆæœ¬: $SELECTED_BRANCH" >> $TOOLCHAIN_DIR/toolchain_info.txt
          echo "ç›®æ ‡: $TARGET-$SUBTARGET" >> $TOOLCHAIN_DIR/toolchain_info.txt
          echo "è®¾å¤‡: $DEVICE" >> $TOOLCHAIN_DIR/toolchain_info.txt
          echo "ç¼–è¯‘æ—¶é—´: $(date)" >> $TOOLCHAIN_DIR/toolchain_info.txt
          
          # åˆ›å»ºå·¥å…·é“¾æ•°æ®åº“
          echo '{' > $TOOLCHAIN_DIR/toolchain_db.json
          echo '  "version": "1.0.0",' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '  "toolchains": {' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '    "'$SELECTED_BRANCH'-'$TARGET'-'$SUBTARGET'": {' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '      "created": "'$(date -I)'",' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '      "size": "'$(du -sh $TOOLCHAIN_DIR | cut -f1)'",' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '      "target": "'$TARGET'",' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '      "subtarget": "'$SUBTARGET'",' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '      "version": "'$SELECTED_BRANCH'"' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '    }' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '  },' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '  "statistics": {' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '    "total_builds": 1,' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '    "cache_hits": 0,' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '    "cache_misses": 1' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '  },' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '  "last_updated": "'$(date -I)'"' >> $TOOLCHAIN_DIR/toolchain_db.json
          echo '}' >> $TOOLCHAIN_DIR/toolchain_db.json
        fi

    - name: ä¸Šä¼ å·¥å…·é“¾ç¼“å­˜
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-toolchain-cache
        path: ${{ env.TOOLCHAIN_DIR }}
        retention-days: 365
        if-no-files-found: warn

    - name: ä¸Šä¼ å›ºä»¶
      if: steps.build_firmware.outputs.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ steps.init_env.outputs.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/*.log
          ${{ env.BUILD_DIR }}/config_backup/
          ${{ env.TOOLCHAIN_DIR }}/
        retention-days: 7

    - name: æ˜¾ç¤ºå·¥å…·é“¾ç»Ÿè®¡ä¿¡æ¯
      if: always()
      run: |
        echo "=== å·¥å…·é“¾ç»Ÿè®¡ä¿¡æ¯ ==="
        
        if [ -f "$TOOLCHAIN_DIR/toolchain_db.json" ]; then
          echo "ğŸ“Š å·¥å…·é“¾æ•°æ®åº“:"
          cat $TOOLCHAIN_DIR/toolchain_db.json
        else
          echo "âŒ å·¥å…·é“¾æ•°æ®åº“ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "å·¥å…·é“¾ç¼“å­˜ç›®å½•: $TOOLCHAIN_DIR"
        if [ -d "$TOOLCHAIN_DIR" ]; then
          echo "ğŸ“¦ æ€»å¤§å°: $(du -sh $TOOLCHAIN_DIR | cut -f1)"
          echo "ğŸ“ ç›®å½•å†…å®¹:"
          ls -la $TOOLCHAIN_DIR/
        fi

    - name: æ¸…ç†æ„å»ºç›®å½•ï¼ˆä¿ç•™å·¥å…·é“¾ï¼‰
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œä¿ç•™æºç å’Œå·¥å…·é“¾..."
        
        if [ -d "$BUILD_DIR" ]; then
          cd $BUILD_DIR
          echo "æ¸…ç†å‰å¤§å°: $(du -sh . | cut -f1)"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œä¿ç•™é‡è¦æ–‡ä»¶
          rm -rf build_dir tmp logs dl .config.old
          echo "æ¸…ç†åå¤§å°: $(du -sh . | cut -f1)"
          
          echo "ğŸ“ ä¿ç•™çš„æ–‡ä»¶:"
          ls -la
        fi
        
        echo ""
        echo "ğŸ“¦ å·¥å…·é“¾ç¼“å­˜ä¿¡æ¯:"
        if [ -d "$TOOLCHAIN_DIR" ]; then
          echo "ä½ç½®: $TOOLCHAIN_DIR"
          echo "å¤§å°: $(du -sh $TOOLCHAIN_DIR | cut -f1)"
          echo "å†…å®¹:"
          ls -la $TOOLCHAIN_DIR/
        fi
