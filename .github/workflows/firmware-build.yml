name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'è®¾å¤‡åç§° (å¦‚: ac42u, ac58u, mi4a ç­‰)'
        required: true
        default: 'ac42u'
        type: string
      version_spec:
        description: 'ç‰ˆæœ¬è§„æ ¼ (å¯é€‰ï¼Œå¦‚: openwrt-23.05 æˆ– immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_type:
        description: 'é…ç½®ç±»å‹ (minimal:åŸºç¡€åŠŸèƒ½, normal:å®Œæ•´åŠŸèƒ½, custom:è‡ªå®šä¹‰)'
        required: true
        default: 'normal'
        type: choice
        options: ['minimal', 'normal', 'custom']
      extra_packages:
        description: 'é¢å¤–å®‰è£…æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…å)'
        required: false
        type: string
      disabled_plugins:
        description: 'ç¦ç”¨æ’ä»¶ (ç©ºæ ¼åˆ†éš”çš„åŒ…åï¼Œå¦‚: luci-app-accesscontrol luci-app-ddns)'
        required: false
        type: string
        default: ''
      save_config:
        description: 'ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“'
        required: false
        default: true
        type: boolean
      enable_cache:
        description: 'å¯ç”¨ç¼–è¯‘ç¼“å­˜ (æ˜¾è‘—åŠ é€Ÿåç»­ç¼–è¯‘)'
        required: false
        default: true
        type: boolean
      multithreading:
        description: 'å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘'
        type: boolean
        default: true
      ssh_connection:
        description: 'ä½¿ç”¨ SSH è¿æ¥åˆ°ç¼–è¯‘ç¯å¢ƒè¿›è¡Œè°ƒè¯•'
        type: boolean
        default: false

env:
  BUILD_DIR: /mnt/openwrt-build
  MIRROR_SOURCE: "tuna"
  # é»˜è®¤å¼€å¯è‡ªå®šä¹‰å®‰è£…åŠŸèƒ½
  CUSTOM_INSTALL: true

jobs:
  build-firmware:
    if: ${{ inputs.ssh_connection == false }}
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo
        pip3 install requests urllib3
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: åˆ›å»ºæ„å»ºç›®å½•å¹¶è®¾ç½®æƒé™
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        sudo chmod u+w $BUILD_DIR
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"
        touch $BUILD_DIR/test_write.txt && echo "âœ… å†™å…¥æµ‹è¯•æˆåŠŸ" && rm $BUILD_DIR/test_write.txt

    - name: å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½•
      run: |
        echo "=== å¤åˆ¶è„šæœ¬åˆ°æ„å»ºç›®å½• ==="
        cd $GITHUB_WORKSPACE
        SCRIPTS="complete_version_detector.sh device_detection.sh error_analysis.sh pre_download.sh check-plugins.sh diagnose-packages.sh"
        COPIED_COUNT=0
        for script in $SCRIPTS; do
          echo "æ­£åœ¨æŸ¥æ‰¾: $script"
          FOUND_SCRIPT=$(find . -name "$script" -type f | head -1)
          if [ -n "$FOUND_SCRIPT" ]; then
            cp "$FOUND_SCRIPT" $BUILD_DIR/
            echo "âœ… æ‰¾åˆ°å¹¶å¤åˆ¶: $script (ä» $FOUND_SCRIPT)"
            COPIED_COUNT=$((COPIED_COUNT + 1))
          else
            echo "âš ï¸ æœªæ‰¾åˆ°: $script"
          fi
        done
        echo "æ€»å…±å¤åˆ¶äº† $COPIED_COUNT ä¸ªè„šæœ¬æ–‡ä»¶"
        cd $BUILD_DIR
        echo "æ„å»ºç›®å½•ä¸­çš„è„šæœ¬:"
        ls -la *.sh 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°.shæ–‡ä»¶"
        chmod +x *.sh 2>/dev/null || true
        echo "âœ… è„šæœ¬å¤åˆ¶å®Œæˆ"

    - name: éªŒè¯è„šæœ¬å­˜åœ¨æ€§
      run: |
        cd $BUILD_DIR
        echo "=== éªŒè¯è„šæœ¬å­˜åœ¨æ€§ ==="
        echo "æ„å»ºç›®å½•å†…å®¹:"
        ls -la
        REQUIRED_SCRIPTS="complete_version_detector.sh device_detection.sh"
        ALL_SCRIPTS_EXIST=true
        for script in $REQUIRED_SCRIPTS; do
          if [ -f "$script" ]; then
            echo "âœ… $script å­˜åœ¨"
            chmod +x "$script"
          else
            echo "âŒ é”™è¯¯: $script ä¸å­˜åœ¨"
            ALL_SCRIPTS_EXIST=false
          fi
        done
        if [ "$ALL_SCRIPTS_EXIST" = false ]; then
          echo "å½“å‰ç›®å½•ä¸­çš„æ–‡ä»¶:"
          ls -la
          echo "âŒ å…³é”®è„šæœ¬ç¼ºå¤±ï¼Œæ„å»ºç»ˆæ­¢"
          exit 1
        fi

    - name: æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ ==="
        sudo chown -R $USER:$USER . 2>/dev/null || true
        chmod u+w . 2>/dev/null || true
        chmod +x *.sh 2>/dev/null || true
        echo "è®¾å¤‡åç§°: ${{ github.event.inputs.device_name }}"
        echo "ç‰ˆæœ¬è§„æ ¼: ${{ inputs.version_spec }}"
        # ç§»é™¤è€æ—§è®¾å¤‡å‚æ•°ï¼Œå°†åœ¨åç»­æ­¥éª¤ä¸­è‡ªåŠ¨åˆ¤æ–­
        if [ ! -f "complete_version_detector.sh" ]; then
          echo "âŒ é”™è¯¯: complete_version_detector.sh ä¸å­˜åœ¨"
          ls -la
          exit 1
        fi
        chmod +x complete_version_detector.sh
        set +e
        # ä¼ é€’ç©ºå€¼ä½œä¸ºè€æ—§è®¾å¤‡å‚æ•°ï¼Œè®©è„šæœ¬è‡ªåŠ¨åˆ¤æ–­
        OUTPUT=$(./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ inputs.version_spec }}" "" 2>&1)
        SCRIPT_EXIT_CODE=$?
        set -e
        echo "è„šæœ¬è¾“å‡º:"
        echo "$OUTPUT"
        echo "è„šæœ¬é€€å‡ºä»£ç : $SCRIPT_EXIT_CODE"
        SELECTED_REPO=$(echo "$OUTPUT" | grep "^SELECTED_REPO=" | head -1 | cut -d'=' -f2)
        SELECTED_BRANCH=$(echo "$OUTPUT" | grep "^SELECTED_BRANCH=" | head -1 | cut -d'=' -f2)
        SELECTED_REPO_URL=$(echo "$OUTPUT" | grep "^SELECTED_REPO_URL=" | head -1 | cut -d'=' -f2)
        if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
            echo "âœ… ä»è„šæœ¬è¾“å‡ºä¸­æˆåŠŸæå–ç‰ˆæœ¬ä¿¡æ¯"
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            echo "âœ… ç¯å¢ƒå˜é‡å·²è®¾ç½®:"
            echo "  ä»“åº“: $SELECTED_REPO"
            echo "  åˆ†æ”¯: $SELECTED_BRANCH"
            echo "  URL: $SELECTED_REPO_URL"
        else
            echo "âŒ æ— æ³•ä»è„šæœ¬è¾“å‡ºä¸­æå–ç‰ˆæœ¬ä¿¡æ¯"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "âŒ ç‰ˆæœ¬æ£€æµ‹å¤±è´¥"
                exit 1
            else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æ— æ³•æå–ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼"
                echo "SELECTED_REPO=immortalwrt" >> $GITHUB_ENV
                echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
                echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
                echo "âœ… ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ä¿¡æ¯"
            fi
        fi

    # ... ä¸­é—´æ­¥éª¤ä¿æŒä¸å˜ ...

    - name: æ™ºèƒ½æ’ä»¶æ›¿æ¢é…ç½®
      run: |
        cd $BUILD_DIR
        echo "=== æ™ºèƒ½æ’ä»¶æ›¿æ¢é…ç½® ==="
        > .config
        echo "CONFIG_TARGET_${PLATFORM}=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic=y" >> .config
        echo "CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
        
        CONFIG_TYPE="${{ inputs.config_type }}"
        echo "é…ç½®ç±»å‹: $CONFIG_TYPE"
        
        if [ "$CONFIG_TYPE" = "minimal" ]; then
            CONFIG_FILE="config-templates/minimal.config"
        elif [ "$CONFIG_TYPE" = "normal" ] || [ "$CONFIG_TYPE" = "custom" ]; then
            # è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦ä¸ºè€æ—§è®¾å¤‡
            IS_OLD_VERSION=0
            # æ ¹æ®è®¾å¤‡åç§°è‡ªåŠ¨åˆ¤æ–­
            case "${{ github.event.inputs.device_name }}" in
                "wr841n"|"wr842n"|"wr941n"|"mr3420"|"ar71xx"*)
                    IS_OLD_VERSION=1
                    echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§è®¾å¤‡: ${{ github.event.inputs.device_name }}"
                    ;;
            esac
            
            # æ ¹æ®ç‰ˆæœ¬åˆ†æ”¯è‡ªåŠ¨åˆ¤æ–­
            if echo "$SELECTED_BRANCH" | grep -q -E "19\.07|21\.02|17\.01|lede"; then
                IS_OLD_VERSION=1
                echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§ç‰ˆæœ¬: $SELECTED_BRANCH"
            fi
            
            if [ "$SELECTED_REPO" = "lede" ] || [ "$SELECTED_REPO" = "openwrt-19.07" ] || [ "$SELECTED_REPO" = "openwrt-21.02" ]; then
                IS_OLD_VERSION=1
                echo "âœ… è‡ªåŠ¨åˆ¤æ–­ä¸ºè€æ—§ä»“åº“: $SELECTED_REPO"
            fi
            
            if [ "$IS_OLD_VERSION" -eq 1 ]; then
                CONFIG_FILE="config-templates/normal-old.config"
            else
                CONFIG_FILE="config-templates/normal-new.config"
            fi
        else
            echo "âŒ æœªçŸ¥çš„é…ç½®ç±»å‹: $CONFIG_TYPE"
            exit 1
        fi
        
        echo "=== é€‰æ‹©çš„é…ç½®æ–‡ä»¶: $CONFIG_FILE ==="
        if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILE"
            exit 1
        fi
        
        cp "$CONFIG_FILE" temp_config
        
        # å¤„ç†é¢å¤–æ’ä»¶å’Œç¦ç”¨æ’ä»¶
        EXTRA_PACKAGES="${{ inputs.extra_packages }}"
        DISABLED_PLUGINS="${{ inputs.disabled_plugins }}"
        
        if [ -n "$EXTRA_PACKAGES" ]; then
            echo "=== æ·»åŠ é¢å¤–æ’ä»¶ ==="
            for pkg in $EXTRA_PACKAGES; do
                echo "æ·»åŠ æ’ä»¶: $pkg"
                echo "CONFIG_PACKAGE_${pkg}=y" >> temp_config
            done
        fi
        
        if [ -n "$DISABLED_PLUGINS" ]; then
            echo "=== ç¦ç”¨æŒ‡å®šæ’ä»¶ ==="
            for pkg in $DISABLED_PLUGINS; do
                echo "ç¦ç”¨æ’ä»¶: $pkg"
                sed -i "s/CONFIG_PACKAGE_${pkg}=y/# CONFIG_PACKAGE_${pkg} is not set/" temp_config
            done
        fi
        
        echo "=== æ‰§è¡Œæ™ºèƒ½æ’ä»¶æ›¿æ¢ ==="
        
        if [ -f "plugin_availability_report.txt" ]; then
            echo "ä½¿ç”¨æ’ä»¶æ£€æŸ¥æŠ¥å‘Šè¿›è¡Œæ™ºèƒ½æ›¿æ¢..."
            
            if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" temp_config; then
                if ! grep -q "âœ… luci-app-turboacc" plugin_availability_report.txt && grep -q "âŒ luci-app-turboacc" plugin_availability_report.txt; then
                    echo "âš ï¸ ç¦ç”¨ä¸å¯ç”¨çš„æ’ä»¶: luci-app-turboacc"
                    sed -i 's/CONFIG_PACKAGE_luci-app-turboacc=y/# CONFIG_PACKAGE_luci-app-turboacc is not set/' temp_config
                fi
            fi
            
            if grep -q "CONFIG_PACKAGE_luci-app-samba4=y" temp_config; then
                if ! grep -q "âœ… luci-app-samba4" plugin_availability_report.txt && grep -q "âŒ luci-app-samba4" plugin_availability_report.txt; then
                    echo "âš ï¸ ç¦ç”¨ä¸å¯ç”¨çš„æ’ä»¶: luci-app-samba4"
                    sed -i 's/CONFIG_PACKAGE_luci-app-samba4=y/# CONFIG_PACKAGE_luci-app-samba4 is not set/' temp_config
                fi
            fi
        else
            echo "âš ï¸ æœªæ‰¾åˆ°æ’ä»¶æ£€æŸ¥æŠ¥å‘Šï¼Œä½¿ç”¨åŸºç¡€æ›¿æ¢é€»è¾‘"
            if grep -q "CONFIG_PACKAGE_luci-app-turboacc=y" temp_config && ! ./scripts/feeds install luci-app-turboacc >/dev/null 2>&1; then
                echo "ğŸ”„ æ›¿æ¢: luci-app-turboacc â†’ luci-app-flowoffload"
                sed -i 's/CONFIG_PACKAGE_luci-app-turboacc=y/CONFIG_PACKAGE_luci-app-flowoffload=y/' temp_config
            fi
        fi
        
        cat temp_config >> .config
        rm -f temp_config
        
        echo "âœ… é…ç½®åŠ è½½å®Œæˆ"
        
        echo "è¿è¡Œ make defconfig..."
        make defconfig
        
        echo "=== æœ€ç»ˆé…ç½®éªŒè¯ ==="
        if grep -q "^CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" .config; then
            echo "âœ… è®¾å¤‡é…ç½®æ­£ç¡®"
        else
            echo "âŒ è®¾å¤‡é…ç½®é”™è¯¯"
            exit 1
        fi

    - name: æ„å»ºæ—¶é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
      # é»˜è®¤å¼€å¯è‡ªå®šä¹‰å®‰è£…ï¼Œä¸éœ€è¦æ¡ä»¶åˆ¤æ–­
      run: |
        cd $BUILD_DIR
        echo "=== æ„å»ºæ—¶é›†æˆè‡ªå®šä¹‰æ–‡ä»¶ ==="
        mkdir -p files/root/custom-install
        
        cd $GITHUB_WORKSPACE
        IPK_FILES=$(find firmware-config/custom-files -name "*.ipk" -type f 2>/dev/null || true)
        if [ -n "$IPK_FILES" ]; then
            echo "âœ… æ‰¾åˆ°IPKæ–‡ä»¶:"
            for ipk in $IPK_FILES; do
                cp "$ipk" $BUILD_DIR/files/root/custom-install/
                echo "âœ… å¤åˆ¶IPK: $(basename "$ipk")"
            done
        fi
        
        SCRIPT_FILES=$(find firmware-config/custom-files -name "*.sh" -type f 2>/dev/null | grep -v "detector\|analysis" || true)
        if [ -n "$SCRIPT_FILES" ]; then
            echo "âœ… æ‰¾åˆ°è„šæœ¬æ–‡ä»¶:"
            for script in $SCRIPT_FILES; do
                cp "$script" $BUILD_DIR/files/root/custom-install/
                chmod +x $BUILD_DIR/files/root/custom-install/$(basename "$script")
                echo "âœ… å¤åˆ¶è„šæœ¬: $(basename "$script")"
            done
        fi
        
        echo '#!/bin/sh' > $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'echo "=== å¼€å§‹æ„å»ºæ—¶è‡ªå®šä¹‰å®‰è£… ==="' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'if ls /root/custom-install/*.ipk >/dev/null 2>&1; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æ„å»ºæ—¶å®‰è£…IPKæ–‡ä»¶..."' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    for ipk in /root/custom-install/*.ipk; do' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        echo "å®‰è£…: $(basename $ipk)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        opkg install "$ipk" --force-depends || echo "å®‰è£…å¤±è´¥: $(basename $ipk)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    done' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'else' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æœªæ‰¾åˆ°IPKæ–‡ä»¶"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'if ls /root/custom-install/*.sh >/dev/null 2>&1; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æ‰§è¡Œæ„å»ºæ—¶è„šæœ¬..."' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    for script in /root/custom-install/*.sh; do' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        if [ "$(basename $script)" != "build-time-install.sh" ]; then' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '            echo "æ‰§è¡Œ: $(basename $script)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '            sh "$script" || echo "æ‰§è¡Œå¤±è´¥: $(basename $script)"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '        fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    done' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'else' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '    echo "æœªæ‰¾åˆ°è„šæœ¬æ–‡ä»¶"' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'fi' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo '' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'rm -rf /root/custom-install' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        echo 'echo "=== æ„å»ºæ—¶è‡ªå®šä¹‰å®‰è£…å®Œæˆ ==="' >> $BUILD_DIR/files/root/custom-install/build-time-install.sh
        
        chmod +x $BUILD_DIR/files/root/custom-install/build-time-install.sh
        
        mkdir -p $BUILD_DIR/files/etc
        echo '#!/bin/sh' > $BUILD_DIR/files/etc/rc.local
        echo '' >> $BUILD_DIR/files/etc/rc.local
        echo '[ -f /root/custom-install/build-time-install.sh ] && {' >> $BUILD_DIR/files/etc/rc.local
        echo '    /root/custom-install/build-time-install.sh >/tmp/build-time-install.log 2>&1 &' >> $BUILD_DIR/files/etc/rc.local
        echo '}' >> $BUILD_DIR/files/etc/rc.local
        echo '' >> $BUILD_DIR/files/etc/rc.local
        echo 'exit 0' >> $BUILD_DIR/files/etc/rc.local
        
        chmod +x $BUILD_DIR/files/etc/rc.local
        echo "âœ… æ„å»ºæ—¶è‡ªå®šä¹‰å®‰è£…é…ç½®å®Œæˆ"

    # ... å…¶ä½™æ­¥éª¤ä¿æŒä¸å˜ï¼Œåªéœ€è¦å°†åŸæ¥çš„æ¡ä»¶åˆ¤æ–­ä¸­çš„ custom_install å’Œ old_device ç§»é™¤ ...

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd $BUILD_DIR
        echo "::group::ğŸ“± ç¼–è¯‘æ—¥å¿—"
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        export FORCE_UNSAFE_CONFIGURE=1
        
        if ${{ inputs.multithreading }}; then
          BUILD_JOBS=$(nproc)
          echo "âœ… å¤šçº¿ç¨‹ç¼–è¯‘: ä½¿ç”¨ $BUILD_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡"
        else
          BUILD_JOBS=1
          echo "âœ… å•çº¿ç¨‹ç¼–è¯‘"
        fi
        
        echo "ğŸš€ å¼€å§‹åˆ†é˜¶æ®µç¼–è¯‘..."
        START_TIME=$(date +%s)
        
        echo "=== é˜¶æ®µ1: ç¼–è¯‘å·¥å…·é“¾ ==="
        make -j$BUILD_JOBS tools/compile V=s 2>&1 | tee -a build_detailed.log
        
        echo "=== é˜¶æ®µ2: ç¼–è¯‘å·¥å…· ==="
        make -j$BUILD_JOBS toolchain/compile V=s 2>&1 | tee -a build_detailed.log
        
        echo "=== é˜¶æ®µ3: å®Œæ•´ç¼–è¯‘ ==="
        set +e
        time make -j$BUILD_JOBS V=s 2>&1 | tee -a build_detailed.log
        COMPILE_EXIT_CODE=$?
        set -e
        
        END_TIME=$(date +%s)
        
        COMPILE_TIME=$((END_TIME - START_TIME))
        echo "=== ç¼–è¯‘æ—¶é—´ç»Ÿè®¡ ==="
        echo "æ€»ç¼–è¯‘æ—¶é—´: $((COMPILE_TIME / 60))åˆ†é’Ÿ$((COMPILE_TIME % 60))ç§’"
        
        if [ -d "bin/targets" ]; then
            echo "::endgroup::"
            echo "::notice::ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
            echo "âœ… ç¼–è¯‘å®Œæˆï¼Œæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶"
            FIRMWARE_LIST=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | sort)
            if [ -n "$FIRMWARE_LIST" ]; then
                echo "ğŸ‰ ç”Ÿæˆçš„å›ºä»¶:"
                echo "$FIRMWARE_LIST"
            fi
            if [ $COMPILE_EXIT_CODE -ne 0 ]; then
                echo "âš ï¸ ç¼–è¯‘è¿‡ç¨‹æœ‰è­¦å‘Šï¼Œä½†ç”Ÿæˆäº†å›ºä»¶æ–‡ä»¶"
            fi
        else
            echo "::endgroup::"
            echo "::notice::âŒ ç¼–è¯‘å¤±è´¥"
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆç›®æ ‡æ–‡ä»¶"
            if [ $COMPILE_EXIT_CODE -eq 0 ]; then
                echo "âŒ ç¼–è¯‘å‘½ä»¤æˆåŠŸä½†æœªç”Ÿæˆç›®æ ‡æ–‡ä»¶"
                find . -maxdepth 3 -type d | sort | head -20
            fi
            exit 1
        fi

    # ... å…¶ä½™æ­¥éª¤ä¿æŒä¸å˜ ...

    - name: ä¿å­˜é…ç½®
      if: success() && ${{ inputs.save_config }}
      run: |
        echo "=== ä¿å­˜é…ç½®æ–‡ä»¶åˆ°ä»“åº“ ==="
        CONFIG_FILENAME="${{ github.event.inputs.device_name }}-${{ inputs.config_type }}.config"
        mkdir -p $GITHUB_WORKSPACE/firmware-config/configs
        
        if [ ! -f "$BUILD_DIR/.config" ]; then
          echo "âŒ é”™è¯¯: æºé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        if [ -f "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" ]; then
          if diff -q "$BUILD_DIR/.config" "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" >/dev/null; then
            echo "â„¹ï¸ é…ç½®æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡ä¿å­˜"
            echo "CONFIG_UNCHANGED=true" >> $GITHUB_ENV
            exit 0
          else
            echo "âœ… æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œå°†ä¿å­˜æ–°é…ç½®"
          fi
        else
          echo "âœ… é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°é…ç½®"
        fi
        
        cp $BUILD_DIR/.config $GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME
        
        if [ -f "$GITHUB_WORKSPACE/firmware-config/configs/$CONFIG_FILENAME" ]; then
          echo "âœ… é…ç½®æ–‡ä»¶å·²ä¿å­˜ä¸º: firmware-config/configs/$CONFIG_FILENAME"
          echo "CONFIG_UNCHANGED=false" >> $GITHUB_ENV
        else
          echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¿å­˜å¤±è´¥"
          exit 1
        fi

    # ... å…¶ä½™æ­¥éª¤ä¿æŒä¸å˜ ...

  build-firmware-ssh:
    if: ${{ inputs.ssh_connection == true }}
    name: ğŸš€ ç¼–è¯‘ (Build) - SSHè°ƒè¯•ç‰ˆ
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³50G"
          exit 1
        fi

    - name: æ£€å‡ºé…ç½®ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ–åŒ… ==="
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip
        pip3 install requests urllib3
        echo "âœ… ç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: å¼€å¯ SSH æœåŠ¡
      uses: lhotari/action-upterm@v1
      with:
        wait-timeout-minutes: 30

    - name: ç¼–è¯‘å‰æç¤º
      run: |
        echo "ğŸš€ SSHè°ƒè¯•æ¨¡å¼å·²å¯åŠ¨"
        echo "æ‚¨å¯ä»¥é€šè¿‡SSHè¿æ¥åˆ°æ„å»ºç¯å¢ƒè¿›è¡Œè°ƒè¯•"
        echo "è°ƒè¯•å®Œæˆåï¼Œæ„å»ºæµç¨‹å°†ç»§ç»­æ‰§è¡Œ"
