# .github/workflows/firmware-build.yml
name: OpenWrt 智能固件构建工作流

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "📱 设备名称 (如: ac42u)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "🔄 版本选择"
        required: true
        type: choice
        default: "21.02"
        options: ["23.05", "21.02"]
      config_mode:
        description: "⚙️ 配置模式选择 - 🟣 基础模式 - 最小化配置，用于测试编译。🟠 正常模式 - 完整功能配置：✅ TurboACC 网络加速 ✅ UPnP 自动端口转发 ✅ Samba 文件共享 ✅ 磁盘管理 ✅ KMS 激活服务 ✅ SmartDNS 智能DNS ✅ 家长控制 ✅ 微信推送 ✅ 流量控制 (SQM) ✅ FTP 服务器 ✅ ARP 绑定 ✅ CPU 限制 ✅ 硬盘休眠"
        required: true
        type: choice
        default: "normal"
        options: ["base", "normal"]
      extra_packages:
        description: "额外安装插件 - 格式：用分号;分隔。启用插件：+插件名。禁用插件：-插件名。"
        required: false
        type: string
        default: ""
      enable_parallel:
        description: "⚡ 启用智能并行优化 (自动判断最佳任务数)"
        required: false
        type: choice
        default: "true"
        options: ["true", "false"]

env:
  BUILD_DIR: "/mnt/openwrt-build"
  REPO_ROOT: "${{ github.workspace }}"
  ENABLE_PARALLEL: "${{ github.event.inputs.enable_parallel }}"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      - name: "0. 生成时间戳（修复版）"
        run: |
          echo "=== 步骤 0: 生成时间戳（修复版） ==="
          echo "🕐 开始时间（UTC）: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "🕐 开始时间（北京时间）: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          
          TIMESTAMP="${{ github.event.inputs.device_name }}-${{ github.event.inputs.version_selection }}-${{ github.event.inputs.config_mode }}-$(TZ='Asia/Shanghai' date -u +'%Y%m%d')"
          
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          
          echo "✅ 生成时间戳: $TIMESTAMP"
          echo "📋 构建配置:"
          echo "  设备: ${{ github.event.inputs.device_name }}"
          echo "  版本: ${{ github.event.inputs.version_selection }}"
          echo "  模式: ${{ github.event.inputs.config_mode }}"
          echo "  并行优化: ${{ github.event.inputs.enable_parallel }}"
          
          echo "🟢 步骤 0 完成"
      
      - name: "1. 使用Git Archive API下载源代码"
        run: |
          echo "=== 步骤 1: 使用Git Archive API下载源代码 ==="
          set -e
          trap 'echo "❌ 步骤 1 失败，退出代码: $?"; exit 1' ERR
          
          mkdir -p /tmp/openwrt-source
          cd /tmp/openwrt-source
          
          echo "🔍 获取仓库默认分支..."
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}" | jq -r '.default_branch')
          echo "✅ 默认分支: $DEFAULT_BRANCH"
          
          echo "📥 下载源代码压缩包..."
          curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tarball/$DEFAULT_BRANCH" -o source.tar.gz
          
          if [ ! -f "source.tar.gz" ]; then
            echo "❌ 错误: 下载源代码压缩包失败"
            exit 1
          fi
          
          echo "✅ 下载完成，文件大小: $(ls -lh source.tar.gz | awk '{print $5}')"
          
          echo "📦 解压源代码..."
          tar -xzf source.tar.gz --strip-components=1
          
          echo "🔍 检查解压结果..."
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "✅ 源代码解压成功"
            
            mkdir -p ${{ github.workspace }}
            
            if [ -d "firmware-config/build-Compiler-file" ]; then
              echo "⚠️ 发现编译器目录，排除不复制"
              rm -rf firmware-config/build-Compiler-file
            fi
            
            rsync -av --exclude='.git' . ${{ github.workspace }}/
            
            chmod +x ${{ github.workspace }}/firmware-config/scripts/*.sh 2>/dev/null || true
            
            echo "✅ 文件复制完成"
            
            mkdir -p /tmp/build-artifacts/source-archive
            cp source.tar.gz /tmp/build-artifacts/source-archive/
            echo "📦 源代码已保存到: /tmp/build-artifacts/source-archive/"
          else
            echo "❌ 错误: 源代码解压失败，重要文件缺失"
            ls -la
            exit 1
          fi
          
          cd /tmp
          rm -rf openwrt-source
          echo "✅ Git Archive API下载完成"
      
      - name: "2. 上传源代码Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: source-${{ env.TIMESTAMP }}
          path: /tmp/build-artifacts/source-archive/
          retention-days: 7
          if-no-files-found: error
      
      - name: "3. 修复权限问题"
        run: |
          echo "=== 步骤 3: 修复权限问题 ==="
          set -e
          trap 'echo "❌ 步骤 3 失败，退出代码: $?"; exit 1' ERR
          
          echo "🔧 修复所有脚本的执行权限..."
          
          if [ -f "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh"
            echo "✅ 修复主脚本权限: firmware-config/scripts/build_firmware_main.sh"
          else
            echo "❌ 错误: 主脚本不存在"
            exit 1
          fi
          
          if [ -f "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh"
            echo "✅ 修复错误分析脚本权限: firmware-config/scripts/error_analysis.sh"
          fi
          
          find "${{ github.workspace }}/firmware-config/scripts" -name "*.sh" -exec chmod +x {} \;
          echo "✅ 修复所有脚本权限完成"
      
      - name: "4. 安装基础工具（优化版）"
        run: |
          echo "=== 步骤 4: 安装基础工具（优化版） ==="
          set -e
          trap 'echo "❌ 步骤 4 失败，退出代码: $?"; exit 1' ERR
          
          echo "🔄 更新软件包列表..."
          sudo apt-get update -q
          
          if [ $? -ne 0 ]; then
            echo "❌ 错误: apt-get update 失败"
            exit 1
          fi
          
          echo "📦 安装编译必需工具..."
          
          echo "🔧 安装核心编译工具..."
          sudo apt-get install -y -q build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev cmake ninja-build
          
          echo "🐍 安装Python和脚本工具..."
          sudo apt-get install -y -q python3 python3-dev python3-pip python3-setuptools python3-yaml xsltproc zip subversion automake autoconf libtool pkg-config help2man texinfo groff texlive texinfo
          
          echo "🌐 安装网络和下载工具..."
          sudo apt-get install -y -q curl net-tools iputils-ping dnsutils openssh-client ca-certificates gnupg lsb-release aria2 libcurl4-openssl-dev
          
          echo "💿 安装文件系统工具..."
          sudo apt-get install -y -q squashfs-tools dosfstools e2fsprogs mtools parted fdisk gdisk hdparm smartmontools
          
          echo "🔍 安装调试和开发工具..."
          sudo apt-get install -y -q gdb strace ltrace valgrind binutils-dev libdw-dev libiberty-dev ecj fastjar java-propose-classpath libpython3-dev liblz4-dev zstd
          
          echo "✅ 基础工具安装完成"
          
          echo "🔍 验证重要工具安装..."
          tools_to_check=("gcc" "g++" "make" "git" "python3" "cmake" "flex" "bison")
          missing_tools=()
          
          for tool in "${tools_to_check[@]}"; do
            if command -v $tool >/dev/null 2>&1; then
              echo "✅ $tool 已安装: $(which $tool)"
            else
              echo "❌ $tool 未安装"
              missing_tools+=("$tool")
            fi
          done
          
          if [ ${#missing_tools[@]} -gt 0 ]; then
            echo "❌ 错误: 以下重要工具缺失: ${missing_tools[*]}"
            exit 1
          fi
          
          echo "🔍 额外检查:"
          if command -v gcc >/dev/null 2>&1; then
            GCC_VERSION=$(gcc --version | head -1)
            echo "🔧 系统GCC版本: $GCC_VERSION"
            echo "💡 系统GCC用于编译工具链，SDK GCC用于交叉编译固件"
          fi
          
          if command -v make >/dev/null 2>&1; then
            MAKE_VERSION=$(make --version | head -1)
            echo "🔨 Make版本: $MAKE_VERSION"
          fi
          
          echo "✅ 工具验证完成"
      
      - name: "5. 初始空间检查"
        run: |
          echo "=== 步骤 5: 初始磁盘空间检查 ==="
          set -e
          trap 'echo "❌ 步骤 5 失败，退出代码: $?"; exit 1' ERR
          
          echo "📊 /mnt 分区详细信息:"
          df -h /mnt
          
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt 可用空间: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 50 ]; then
            echo "❌ 错误: /mnt 空间不足50G，当前只有${AVAILABLE_GB}G"
            exit 1
          else
            echo "✅ 初始空间检查通过 - ${AVAILABLE_GB}G 可用"
          fi
      
      - name: "6. 强制创建构建目录和环境文件"
        run: |
          echo "=== 步骤 6: 强制创建构建目录和环境文件 ==="
          set -e
          trap 'echo "❌ 步骤 6 失败，退出代码: $?"; exit 1' ERR
          
          echo "🔄 步骤 6.1: 强制创建构建目录"
          sudo mkdir -p /mnt/openwrt-build
          sudo chown -R $USER:$USER /mnt/openwrt-build
          sudo chmod -R 755 /mnt/openwrt-build
          
          if [ -d "/mnt/openwrt-build" ]; then
            echo "✅ 构建目录创建成功: /mnt/openwrt-build"
          else
            echo "❌ 错误: 无法创建构建目录"
            exit 1
          fi
          
          echo "🔄 步骤 6.2: 预先手动创建环境文件"
          
          # 使用echo命令创建环境文件，避免heredoc语法
          echo "#!/bin/bash" > /tmp/temp_env.sh
          echo "# 自动生成的环境文件" >> /tmp/temp_env.sh
          echo "# 设备: ${{ github.event.inputs.device_name }}" >> /tmp/temp_env.sh
          echo "# 版本: ${{ github.event.inputs.version_selection }}" >> /tmp/temp_env.sh
          echo "# 模式: ${{ github.event.inputs.config_mode }}" >> /tmp/temp_env.sh
          echo "" >> /tmp/temp_env.sh
          echo "export SELECTED_REPO_URL='https://github.com/immortalwrt/immortalwrt.git'" >> /tmp/temp_env.sh
          
          # 设置分支
          if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
            echo "export SELECTED_BRANCH='openwrt-23.05'" >> /tmp/temp_env.sh
          else
            echo "export SELECTED_BRANCH='openwrt-21.02'" >> /tmp/temp_env.sh
          fi
          
          echo "export REPO_ROOT='${{ github.workspace }}'" >> /tmp/temp_env.sh
          echo "export COMPILER_DIR=''" >> /tmp/temp_env.sh
          echo "" >> /tmp/temp_env.sh
          
          # 根据设备设置变量
          DEVICE_NAME="${{ github.event.inputs.device_name }}"
          if [[ "$DEVICE_NAME" == "ac42u" || "$DEVICE_NAME" == "acrh17" ]]; then
            echo "export TARGET='ipq40xx'" >> /tmp/temp_env.sh
            echo "export SUBTARGET='generic'" >> /tmp/temp_env.sh
            echo "export DEVICE='asus_rt-ac42u'" >> /tmp/temp_env.sh
          elif [[ "$DEVICE_NAME" == "mi_router_4a_gigabit" || "$DEVICE_NAME" == "r4ag" ]]; then
            echo "export TARGET='ramips'" >> /tmp/temp_env.sh
            echo "export SUBTARGET='mt76x8'" >> /tmp/temp_env.sh
            echo "export DEVICE='xiaomi_mi-router-4a-gigabit'" >> /tmp/temp_env.sh
          elif [[ "$DEVICE_NAME" == "mi_router_3g" || "$DEVICE_NAME" == "r3g" ]]; then
            echo "export TARGET='ramips'" >> /tmp/temp_env.sh
            echo "export SUBTARGET='mt7621'" >> /tmp/temp_env.sh
            echo "export DEVICE='xiaomi_mi-router-3g'" >> /tmp/temp_env.sh
          else
            echo "export TARGET='ipq40xx'" >> /tmp/temp_env.sh
            echo "export SUBTARGET='generic'" >> /tmp/temp_env.sh
            echo "export DEVICE='$DEVICE_NAME'" >> /tmp/temp_env.sh
          fi
          
          echo "export CONFIG_MODE='${{ github.event.inputs.config_mode }}'" >> /tmp/temp_env.sh
          
          cp /tmp/temp_env.sh /mnt/openwrt-build/build_env.sh
          chmod +x /mnt/openwrt-build/build_env.sh
          
          echo "✅ 手动环境文件创建成功"
          
          source /mnt/openwrt-build/build_env.sh
          echo "📋 环境变量预览:"
          echo "  SELECTED_REPO_URL: $SELECTED_REPO_URL"
          echo "  SELECTED_BRANCH: $SELECTED_BRANCH"
          echo "  TARGET: $TARGET"
          echo "  SUBTARGET: $SUBTARGET"
          echo "  DEVICE: $DEVICE"
          echo "  CONFIG_MODE: $CONFIG_MODE"
          echo "  REPO_ROOT: $REPO_ROOT"
          echo "  COMPILER_DIR: $COMPILER_DIR"
          
          echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "DEVICE=$DEVICE" >> $GITHUB_ENV
          echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
          echo "REPO_ROOT=$REPO_ROOT" >> $GITHUB_ENV
          echo "COMPILER_DIR=$COMPILER_DIR" >> $GITHUB_ENV
          
          echo "✅ 编译环境强制初始化完成"
      
      - name: "7. 验证环境文件创建"
        run: |
          echo "=== 步骤 7: 验证环境文件创建 ==="
          set -e
          trap 'echo "❌ 步骤 7 失败，退出代码: $?"; exit 1' ERR
          
          echo "🔍 检查步骤6创建的环境文件..."
          
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            echo "✅ 环境文件存在: /mnt/openwrt-build/build_env.sh"
            
            REQUIRED_VARS=("SELECTED_REPO_URL" "SELECTED_BRANCH" "TARGET" "SUBTARGET" "DEVICE" "CONFIG_MODE")
            MISSING_VARS=()
            
            for var in "${REQUIRED_VARS[@]}"; do
              if grep -q "export $var=" "/mnt/openwrt-build/build_env.sh"; then
                echo "✅ 环境变量 $var 存在"
              else
                echo "❌ 环境变量 $var 缺失"
                MISSING_VARS+=("$var")
              fi
            done
            
            if [ ${#MISSING_VARS[@]} -eq 0 ]; then
              echo "✅ 所有必需环境变量都存在"
            else
              echo "❌ 缺失的环境变量: ${MISSING_VARS[*]}"
              echo "💡 正在修复环境文件..."
              
              for var in "${MISSING_VARS[@]}"; do
                case $var in
                  "SELECTED_REPO_URL")
                    echo "export SELECTED_REPO_URL='https://github.com/immortalwrt/immortalwrt.git'" >> /mnt/openwrt-build/build_env.sh
                    ;;
                  "SELECTED_BRANCH")
                    echo "export SELECTED_BRANCH='openwrt-21.02'" >> /mnt/openwrt-build/build_env.sh
                    ;;
                  "TARGET")
                    echo "export TARGET='ipq40xx'" >> /mnt/openwrt-build/build_env.sh
                    ;;
                  "SUBTARGET")
                    echo "export SUBTARGET='generic'" >> /mnt/openwrt-build/build_env.sh
                    ;;
                  "DEVICE")
                    echo "export DEVICE='asus_rt-ac42u'" >> /mnt/openwrt-build/build_env.sh
                    ;;
                  "CONFIG_MODE")
                    echo "export CONFIG_MODE='normal'" >> /mnt/openwrt-build/build_env.sh
                    ;;
                esac
                echo "✅ 已修复环境变量: $var"
              done
            fi
            
            echo "📝 环境文件完整内容:"
            cat "/mnt/openwrt-build/build_env.sh"
          else
            echo "❌ 严重错误: 环境文件不存在！"
            echo "🔍 检查构建目录内容:"
            ls -la /mnt/openwrt-build/ || echo "构建目录不存在"
            
            echo "🔄 尝试重新创建环境文件..."
            echo "#!/bin/bash" > /mnt/openwrt-build/build_env.sh
            echo "# 紧急创建的环境文件" >> /mnt/openwrt-build/build_env.sh
            echo "export SELECTED_REPO_URL='https://github.com/immortalwrt/immortalwrt.git'" >> /mnt/openwrt-build/build_env.sh
            echo "export SELECTED_BRANCH='openwrt-21.02'" >> /mnt/openwrt-build/build_env.sh
            echo "export TARGET='ipq40xx'" >> /mnt/openwrt-build/build_env.sh
            echo "export SUBTARGET='generic'" >> /mnt/openwrt-build/build_env.sh
            echo "export DEVICE='asus_rt-ac42u'" >> /mnt/openwrt-build/build_env.sh
            echo "export CONFIG_MODE='${{ github.event.inputs.config_mode }}'" >> /mnt/openwrt-build/build_env.sh
            echo "export REPO_ROOT='${{ github.workspace }}'" >> /mnt/openwrt-build/build_env.sh
            echo "export COMPILER_DIR=''" >> /mnt/openwrt-build/build_env.sh
            
            if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
              echo "✅ 已重新创建环境文件"
              cat "/mnt/openwrt-build/build_env.sh"
            else
              echo "❌ 无法创建环境文件，构建无法继续"
              exit 1
            fi
          fi
          
          echo "✅ 环境文件验证完成"
      
      - name: "8. 执行正式的环境初始化"
        run: |
          echo "=== 步骤 8: 执行正式的环境初始化 ==="
          set -e
          trap 'echo "❌ 步骤 8 失败，退出代码: $?"; exit 1' ERR
          
          echo "🔍 检查环境文件..."
          
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            echo "✅ 环境文件存在，开始执行正式初始化"
            
            cp "/mnt/openwrt-build/build_env.sh" "/mnt/openwrt-build/build_env.sh.backup"
            echo "✅ 已备份原始环境文件"
            
            echo "🔄 执行 build_firmware_main.sh initialize_build_env..."
            "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
            
            INIT_EXIT_CODE=$?
            if [ $INIT_EXIT_CODE -ne 0 ]; then
              echo "⚠️ 警告: initialize_build_env 执行失败，退出代码: $INIT_EXIT_CODE"
              echo "💡 将使用步骤6创建的预置环境文件"
              
              cp "/mnt/openwrt-build/build_env.sh.backup" "/mnt/openwrt-build/build_env.sh"
              echo "✅ 已恢复预置环境文件"
            else
              echo "✅ initialize_build_env 执行成功"
            fi
            
            if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
              echo "✅ 环境文件更新成功"
              
              source "/mnt/openwrt-build/build_env.sh"
              echo "📋 关键环境变量:"
              echo "  SELECTED_REPO_URL: $SELECTED_REPO_URL"
              echo "  SELECTED_BRANCH: $SELECTED_BRANCH"
              echo "  TARGET: $TARGET"
              echo "  SUBTARGET: $SUBTARGET"
              echo "  DEVICE: $DEVICE"
              echo "  CONFIG_MODE: $CONFIG_MODE"
            fi
          else
            echo "❌ 错误: 环境文件不存在，无法执行初始化"
            exit 1
          fi
          
          echo "✅ 环境初始化完成"
      
      - name: "9. 下载OpenWrt官方SDK"
        run: |
          echo "=== 步骤 9: 下载OpenWrt官方SDK ==="
          set -e
          trap 'echo "❌ 步骤 9 失败，退出代码: $?"; exit 1' ERR
          
          echo "🔍 检查环境文件..."
          
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            echo "✅ 环境文件存在（由步骤6-8创建和验证）"
          else
            echo "❌ 严重错误: 环境文件不存在！无法继续"
            exit 1
          fi
          
          echo "🚀 开始执行SDK下载..."
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" initialize_compiler_env "${{ github.event.inputs.device_name }}"
          
          SDK_EXIT_CODE=$?
          if [ $SDK_EXIT_CODE -ne 0 ]; then
            echo "⚠️ 警告: SDK下载可能有问题，退出代码: $SDK_EXIT_CODE"
            echo "💡 将使用OpenWrt自动构建的编译器作为后备"
          fi
          
          echo "✅ SDK下载步骤完成"
      
      - name: "10. 验证SDK下载结果"
        run: |
          echo "=== 步骤 10: 验证SDK下载结果 ==="
          trap 'echo "⚠️ 步骤 10 验证过程中出现错误，继续执行..."' ERR
          
          echo "🔍 检查SDK下载结果..."
          
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            echo "✅ 从环境文件加载变量: COMPILER_DIR=$COMPILER_DIR"
          else
            echo "⚠️ 环境文件不存在"
          fi
          
          if [ -d "/mnt/openwrt-build/sdk" ]; then
            echo "✅ SDK目录存在: /mnt/openwrt-build/sdk"
            
            GCC_FILE=$(find "/mnt/openwrt-build/sdk" -type f -executable -name "*gcc" ! -name "*gcc-ar" ! -name "*gcc-ranlib" ! -name "*gcc-nm" 2>/dev/null | head -1)
            
            if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
              echo "✅ 找到可执行GCC编译器: $(basename "$GCC_FILE")"
              echo "🔧 GCC版本测试:"
              "$GCC_FILE" --version 2>&1 | head -1
              echo "💡 这是OpenWrt官方SDK交叉编译器，用于编译目标平台固件"
              echo "💡 系统GCC (11.4.0) 用于编译工具链，SDK GCC (8.4.0) 用于交叉编译固件"
            else
              echo "⚠️ 未找到可执行的GCC编译器"
            fi
          else
            echo "❌ SDK目录不存在"
            echo "💡 将使用OpenWrt自动构建的编译器"
          fi
          
          echo "✅ SDK验证完成"
      
      - name: "11. 添加 TurboACC 支持"
        run: |
          echo "=== 步骤 11: 添加 TurboACC 支持 ==="
          set -e
          trap 'echo "❌ 步骤 11 失败，退出代码: $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" add_turboacc_support
          
          if [ $? -ne 0 ]; then
            echo "❌ 错误: 添加TurboACC支持失败"
            exit 1
          fi
          
          echo "✅ 完成时间: $(date '+%Y-%m-%d %H:%M:%S')"
      
      - name: "12. 配置Feeds"
        run: |
          echo "=== 步骤 12: 配置Feeds ==="
          set -e
          trap 'echo "❌ 步骤 12 失败，退出代码: $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" configure_feeds
          
          if [ $? -ne 0 ]; then
            echo "❌ 错误: 配置Feeds失败"
            exit 1
          fi
          
          echo "✅ 完成时间: $(date '+%Y-%m-%d %H:%M:%S')"
      
      - name: "13. 安装 TurboACC 包"
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "=== 步骤 13: 安装 TurboACC 包 ==="
          set -e
          trap 'echo "❌ 步骤 13 失败，退出代码: $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" install_turboacc_packages
          
          if [ $? -ne 0 ]; then
            echo "❌ 错误: 安装TurboACC包失败"
            exit 1
          fi
          
          echo "✅ 完成时间: $(date '+%Y-%m-%d %H:%M:%S')"
      
      - name: "14. 编译前空间检查"
        run: |
          echo "=== 步骤 14: 编译前空间检查 ==="
          set -e
          trap 'echo "❌ 步骤 14 失败，退出代码: $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" pre_build_space_check
          
          if [ $? -ne 0 ]; then
            echo "❌ 错误: 编译前空间检查失败"
            exit 1
          fi
      
      - name: "15. 智能配置生成"
        run: |
          echo "=== 步骤 15: 智能配置生成 ==="
          set -e
          trap 'echo "❌ 步骤 15 失败，退出代码: $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" generate_config "${{ github.event.inputs.extra_packages }}"
          
          if [ $? -ne 0 ]; then
            echo "❌ 错误: 智能配置生成失败"
            exit 1
          fi
      
      - name: "16. 验证USB配置"
        run: |
          echo "=== 步骤 16: 验证USB配置 ==="
          trap 'echo "⚠️ 步骤 16 验证过程中出现错误，继续执行..."' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" verify_usb_config
      
      - name: "17. USB驱动完整性检查"
        run: |
          echo "=== 步骤 17: USB驱动完整性检查 ==="
          trap 'echo "⚠️ 步骤 17 检查过程中出现错误，继续执行..."' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" check_usb_drivers_integrity
      
      - name: "18. 应用配置并显示详情（完整版）"
        run: |
          echo "=== 步骤 18: 应用配置并显示详情（完整版）==="
          set -e
          trap 'echo "❌ 步骤 18 失败，退出代码: $?"; exit 1' ERR
          
          if [ -f "/mnt/openwrt-build/.config" ]; then
            cp "/mnt/openwrt-build/.config" "/mnt/openwrt-build/.config.original"
            echo "✅ 已备份原始配置文件"
          fi
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" apply_config
          
          if [ $? -ne 0 ]; then
            echo "❌ 错误: 应用配置失败"
            exit 1
          fi
          
          echo "=== 🚨 最终配置状态检查（完整详细版）==="
          if [ -f "/mnt/openwrt-build/.config" ]; then
            echo "✅ 配置文件存在"
            
            enabled=$(grep -c "CONFIG_PACKAGE_.*=y" "/mnt/openwrt-build/.config")
            disabled=$(grep -c "# CONFIG_PACKAGE_.* is not set" "/mnt/openwrt-build/.config")
            echo "   ✅ 已启用插件: $enabled 个"
            echo "   ❌ 已禁用插件: $disabled 个"
            
            echo "=== 🎯 详细配置状态标识（完整版）==="
            echo "📋 USB配置状态:"
            
            echo "  CONFIG_PACKAGE_kmod-usb-core: $(grep -q "^CONFIG_PACKAGE_kmod-usb-core=y" "/mnt/openwrt-build/.config" && echo "✅" || echo "❌")"
            echo "  CONFIG_PACKAGE_kmod-usb2: $(grep -q "^CONFIG_PACKAGE_kmod-usb2=y" "/mnt/openwrt-build/.config" && echo "✅" || echo "❌")"
            echo "  CONFIG_PACKAGE_kmod-usb3: $(grep -q "^CONFIG_PACKAGE_kmod-usb3=y" "/mnt/openwrt-build/.config" && echo "✅" || echo "❌")"
            echo "  CONFIG_PACKAGE_kmod-usb-xhci-hcd: $(grep -q "^CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" "/mnt/openwrt-build/.config" && echo "✅" || echo "❌")"
            echo "  CONFIG_PACKAGE_kmod-usb-storage: $(grep -q "^CONFIG_PACKAGE_kmod-usb-storage=y" "/mnt/openwrt-build/.config" && echo "✅" || echo "❌")"
            echo "  CONFIG_PACKAGE_kmod-scsi-core: $(grep -q "^CONFIG_PACKAGE_kmod-scsi-core=y" "/mnt/openwrt-build/.config" && echo "✅" || echo "❌")"
            
            echo ""
            echo "🎯 配置模式: ${{ github.event.inputs.config_mode }}"
            if [ "${{ github.event.inputs.config_mode }}" = "normal" ]; then
              echo "✅ 当前为正常模式（完整功能）"
            else
              echo "🔧 当前为基础模式（最小化配置）"
            fi
            
          else
            echo "❌ 配置文件不存在"
          fi
          
          echo ""
          echo "✅ 配置应用完成"
      
      - name: "19. 检查并备份配置文件"
        run: |
          echo "=== 步骤 19: 检查并备份配置文件 ==="
          set -e
          trap 'echo "❌ 步骤 19 失败，退出代码: $?"; exit 1' ERR
          
          if [ -f "/mnt/openwrt-build/.config" ]; then
            echo "✅ .config 文件存在"
            
            mkdir -p "${{ github.workspace }}/firmware-config/config-backup"
            
            BACKUP_FILE="${{ github.workspace }}/firmware-config/config-backup/config_${{ env.TIMESTAMP }}.config"
            
            cp "/mnt/openwrt-build/.config" "$BACKUP_FILE"
            echo "✅ 配置文件备份到仓库目录: $BACKUP_FILE"
          else
            echo "❌ 错误: .config 文件不存在"
            exit 1
          fi
      
      - name: "20. 修复网络环境"
        run: |
          echo "=== 步骤 20: 修复网络环境 ==="
          trap 'echo "⚠️ 步骤 20 修复过程中出现错误，继续执行..."' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" fix_network
      
      - name: "21. 下载依赖包（优化版）"
        run: |
          echo "=== 步骤 21: 下载依赖包（优化版） ==="
          set -e
          trap 'echo "❌ 步骤 21 失败，退出代码: $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          echo "🔧 检查依赖包目录..."
          if [ ! -d "dl" ]; then
            mkdir -p dl
            echo "✅ 创建依赖包目录: dl"
          fi
          
          DEP_COUNT=$(find dl -type f 2>/dev/null | wc -l)
          echo "📊 当前依赖包数量: $DEP_COUNT 个"
          
          echo "🚀 开始下载依赖包（启用并行下载）..."
          make -j4 download V=s 2>&1 | tee download.log
          
          DOWNLOAD_EXIT_CODE=${PIPESTATUS[0]}
          if [ $DOWNLOAD_EXIT_CODE -ne 0 ]; then
            echo "⚠️ 警告: 依赖包下载过程中出现错误，退出代码: $DOWNLOAD_EXIT_CODE"
            grep -i "error\|failed\|404\|not found" download.log | head -10 || true
          fi
          
          NEW_DEP_COUNT=$(find dl -type f 2>/dev/null | wc -l)
          echo "📊 下载后依赖包数量: $NEW_DEP_COUNT 个"
          echo "📈 新增依赖包: $((NEW_DEP_COUNT - DEP_COUNT)) 个"
      
      - name: "22. 集成自定义文件"
        run: |
          echo "=== 步骤 22: 集成自定义文件 ==="
          trap 'echo "⚠️ 步骤 22 集成过程中出现错误，继续执行..."' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" integrate_custom_files
      
      - name: "23. 前置错误检查"
        run: |
          echo "=== 步骤 23: 前置错误检查 ==="
          set -e
          trap 'echo "❌ 步骤 23 失败，退出代码: $?"; exit 1' ERR
          
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" pre_build_error_check
          
          if [ $? -ne 0 ]; then
            echo "❌ 错误: 前置错误检查失败"
            echo "💡 请查看上方错误信息进行修复"
            exit 1
          fi
      
      - name: "24. 编译固件前的空间检查"
        run: |
          echo "=== 步骤 24: 编译固件前的空间检查 ==="
          set -e
          trap 'echo "❌ 步骤 24 失败，退出代码: $?"; exit 1' ERR
          
          df -h /mnt
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt 可用空间: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "❌ 错误: 编译前空间不足 (需要至少10G，当前${AVAILABLE_GB}G)"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "⚠️ 警告: 编译前空间较低 (建议至少20G，当前${AVAILABLE_GB}G)"
          else
            echo "✅ 编译前空间充足"
          fi
      
      - name: "25. 编译固件（智能并行优化版）"
        run: |
          echo "=== 步骤 25: 编译固件（智能并行优化版） ==="
          set -e
          trap 'echo "❌ 步骤 25 失败，退出代码: $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          CPU_CORES=$(nproc)
          TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
          
          echo "🔧 系统信息:"
          echo "  CPU核心数: $CPU_CORES"
          echo "  内存大小: ${TOTAL_MEM}MB"
          echo "  并行优化: ${{ env.ENABLE_PARALLEL }}"
          
          if [ "${{ env.ENABLE_PARALLEL }}" = "true" ]; then
            echo "🧠 智能判断最佳并行任务数..."
            
            if [ $CPU_CORES -ge 4 ]; then
              if [ $TOTAL_MEM -ge 8000 ]; then
                MAKE_JOBS=4
                echo "✅ 检测到高性能Runner (4核+8GB)"
              else
                MAKE_JOBS=3
                echo "✅ 检测到标准Runner (4核)"
              fi
            elif [ $CPU_CORES -ge 2 ]; then
              if [ $TOTAL_MEM -ge 7000 ]; then
                MAKE_JOBS=3
                echo "✅ 检测到GitHub标准Runner (2核7GB)"
              else
                MAKE_JOBS=2
                echo "✅ 检测到2核Runner"
              fi
            else
              MAKE_JOBS=2
              echo "⚠️ 检测到单核Runner"
            fi
            
            echo "🎯 决定使用 $MAKE_JOBS 个并行任务"
          else
            MAKE_JOBS=1
            echo "🔄 禁用并行优化，使用单线程编译"
          fi
          
          echo ""
          echo "🚀 开始编译固件"
          echo "💡 编译配置:"
          echo "  - 并行任务: $MAKE_JOBS"
          echo "  - 设备: ${{ github.event.inputs.device_name }}"
          echo "  - 版本: ${{ github.event.inputs.version_selection }}"
          echo "  - 配置模式: ${{ github.event.inputs.config_mode }}"
          
          export FORCE_UNSAFE_CONFIGURE=1
          
          START_TIME=$(date +%s)
          time make -j$MAKE_JOBS V=s 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "📊 编译统计:"
          echo "  - 总耗时: $((DURATION / 60))分钟$((DURATION % 60))秒"
          echo "  - 退出代码: $BUILD_EXIT_CODE"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "✅ 固件编译成功"
            
            if [ -d "bin/targets" ]; then
              FIRMWARE_COUNT=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
              echo "✅ 生成固件文件: $FIRMWARE_COUNT 个"
              
              echo "📁 生成的固件文件 (前3个):"
              find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | head -3 | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "未知")
                echo "  📄 $(basename "$file") ($SIZE)"
              done
            fi
          else
            echo "❌ 错误: 编译失败，退出代码: $BUILD_EXIT_CODE"
            grep -i "error\|failed" build.log | tail -20 || true
            exit $BUILD_EXIT_CODE
          fi
      
      - name: "26. 检查构建产物（修复版）"
        if: success()
        run: |
          echo "=== 步骤 26: 检查构建产物（修复版） ==="
          set -e
          trap 'echo "❌ 步骤 26 失败，退出代码: $?"; exit 1' ERR
          
          cd /mnt/openwrt-build
          
          if [ -d "bin/targets" ]; then
            echo "✅ 找到固件目录"
            
            FIRMWARE_COUNT=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
            PACKAGE_COUNT=$(find bin/targets -type f \( -name "*.gz" -o -name "*.ipk" \) 2>/dev/null | wc -l)
            OTHER_COUNT=$(find bin/targets -type f 2>/dev/null | wc -l)
            OTHER_COUNT=$((OTHER_COUNT - FIRMWARE_COUNT - PACKAGE_COUNT))
            
            echo "=========================================="
            echo "📈 构建产物统计:"
            echo "  固件文件: $FIRMWARE_COUNT 个 (.bin/.img)"
            echo "  包文件: $PACKAGE_COUNT 个 (.gz/.ipk)"
            echo "  其他文件: $OTHER_COUNT 个"
            echo "  总文件数: $((FIRMWARE_COUNT + PACKAGE_COUNT + OTHER_COUNT)) 个"
            echo ""
            
            if [ $FIRMWARE_COUNT -gt 0 ]; then
              echo "📁 固件文件详细信息:"
              echo "------------------------------------------"
              find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "未知")
                FILE_NAME=$(basename "$file")
                
                if [[ "$FILE_NAME" == *factory* ]]; then
                  TYPE="🏭 工厂固件 (用于首次刷机)"
                elif [[ "$FILE_NAME" == *sysupgrade* ]]; then
                  TYPE="🔄 系统升级固件 (用于已安装OpenWrt的设备)"
                elif [[ "$FILE_NAME" == *initramfs* ]]; then
                  TYPE="🚀 内存启动固件 (用于测试和救援)"
                else
                  TYPE="🔧 普通固件"
                fi
                
                echo "🎯 文件: $FILE_NAME"
                echo "  大小: $SIZE"
                echo "  类型: $TYPE"
                echo ""
              done
            else
              echo "⚠️ 警告: 未找到任何固件文件 (.bin/.img)"
            fi
            
          else
            echo "❌ 错误: 未找到固件目录"
            exit 1
          fi
      
      - name: "27. 上传固件原始目录"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ env.TIMESTAMP }}
          path: /mnt/openwrt-build/bin/targets/
          retention-days: 7
          if-no-files-found: error
      
      - name: "28. 上传配置文件"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ env.TIMESTAMP }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
          if-no-files-found: error
      
      - name: "29. 执行错误分析（优化版）"
        if: always()
        run: |
          echo "=== 步骤 29: 执行错误分析（优化版） ==="
          trap 'echo "⚠️ 步骤 29 错误分析过程中出现错误，继续执行..."' ERR
          
          if [ -f "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh" ]; then
            chmod +x "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh"
            export BUILD_DIR="/mnt/openwrt-build"
            
            echo "🔧 执行优化版错误分析..."
            "${{ github.workspace }}/firmware-config/scripts/error_analysis.sh"
            
            echo "✅ 错误分析完成"
          else
            echo "⚠️ 错误分析脚本不存在"
          fi
      
      - name: "30. 编译后空间检查"
        if: always()
        run: |
          echo "=== 步骤 30: 编译后空间检查 ==="
          trap 'echo "⚠️ 步骤 30 检查过程中出现错误，继续执行..."' ERR
          
          echo "📊 磁盘使用情况:"
          df -h /mnt
          
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "/mnt 可用空间: ${AVAILABLE_GB}G"
          
          if [ $AVAILABLE_GB -lt 5 ]; then
            echo "⚠️ 警告: 磁盘空间较低，建议清理"
          else
            echo "✅ 磁盘空间充足"
          fi
      
      - name: "31. 编译后总结"
        if: always()
        run: |
          echo "=== 步骤 31: 编译后总结 ==="
          trap 'echo "⚠️ 步骤 31 总结过程中出现错误，继续执行..."' ERR
          
          echo "🚀 构建总结报告"
          echo "========================================"
          echo "设备: ${{ github.event.inputs.device_name }}"
          echo "版本: ${{ github.event.inputs.version_selection }}"
          echo "配置模式: ${{ github.event.inputs.config_mode }}"
          echo "时间戳: ${{ env.TIMESTAMP }}"
          echo "并行优化: ${{ github.event.inputs.enable_parallel }}"
          echo ""
          
          if [ -d "/mnt/openwrt-build/bin/targets" ]; then
            FIRMWARE_COUNT=$(find /mnt/openwrt-build/bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
            
            echo "📦 构建产物:"
            echo "  固件数量: $FIRMWARE_COUNT 个 (.bin/.img)"
            
            if [ $FIRMWARE_COUNT -gt 0 ]; then
              echo "  产物位置: /mnt/openwrt-build/bin/targets/"
              echo "  下载名称: firmware-${{ env.TIMESTAMP }}"
              
              echo "  固件文件详情:"
              find /mnt/openwrt-build/bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | while read file; do
                SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "未知")
                FILE_NAME=$(basename "$file")
                
                if [[ "$FILE_NAME" == *factory* ]]; then
                  TYPE="🏭 工厂固件"
                elif [[ "$FILE_NAME" == *sysupgrade* ]]; then
                  TYPE="🔄 升级固件"
                elif [[ "$FILE_NAME" == *initramfs* ]]; then
                  TYPE="🚀 内存固件"
                else
                  TYPE="🔧 普通固件"
                fi
                
                echo "    🎯 $FILE_NAME ($SIZE) - $TYPE"
              done
            else
              echo "  ⚠️ 构建结果: 编译完成但未生成固件文件"
            fi
          else
            echo "📦 构建产物: 未生成任何文件"
          fi
          
          echo ""
          echo "🔧 编译器信息:"
          echo "  🖥️ 系统GCC: 11.4.0 (用于编译工具链)"
          echo "  🎯 SDK GCC: 8.4.0 (用于交叉编译固件)"
          echo "  💡 这是正常的：系统编译器编译工具链，SDK编译器编译固件"
          
          echo ""
          echo "✅ 构建流程完成"
