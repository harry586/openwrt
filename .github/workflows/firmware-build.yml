name: OpenWrt 智能固件构建工作流

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (ac42u/acrh17/ac58u/acrh13 等)'
        required: true
        default: 'ac42u'
        type: string
      old_device:
        description: '是否为老旧设备'
        required: true
        default: false
        type: boolean
      version_spec:
        description: '版本规格 (可选，如: openwrt-23.05 或 immortalwrt:master)'
        required: false
        type: string
        default: ''
      config_type:
        description: '配置类型'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - normal
          - custom
      extra_packages:
        description: '额外安装插件 (空格分隔)'
        required: false
        type: string

env:
  BUILD_DIR: /mnt/openwrt-build

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: 初始空间检查
      run: |
        echo "=== 初始磁盘空间检查 ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt 可用空间: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 50 ]; then
          echo "错误: /mnt 空间不足50G"
          exit 1
        fi

    - name: 检出配置仓库
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libssl-dev python3 unzip zlib1g-dev subversion gcc-multilib git curl file

    - name: 创建构建目录并设置权限
      run: |
        echo "=== 创建构建目录 ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR
        sudo chmod -R 755 $BUILD_DIR
        sudo chmod u+w $BUILD_DIR
        echo "✅ 构建目录创建完成"
        ls -ld $BUILD_DIR
        touch $BUILD_DIR/test_write.txt && echo "✅ 写入测试成功" && rm $BUILD_DIR/test_write.txt

    - name: 复制检测脚本到构建目录
      run: |
        cd $BUILD_DIR
        echo "=== 复制检测脚本到构建目录 ==="
        cd $GITHUB_WORKSPACE
        VERSION_SCRIPT=$(find . -name "complete_version_detector.sh" -type f | head -1)
        DEVICE_SCRIPT=$(find . -name "device_detection.sh" -type f | head -1)
        if [ -z "$VERSION_SCRIPT" ] || [ -z "$DEVICE_SCRIPT" ]; then
          echo "❌ 错误: 找不到检测脚本"
          exit 1
        fi
        echo "✅ 找到版本检测脚本: $VERSION_SCRIPT"
        echo "✅ 找到设备检测脚本: $DEVICE_SCRIPT"
        cp "$VERSION_SCRIPT" $BUILD_DIR/complete_version_detector.sh
        cp "$DEVICE_SCRIPT" $BUILD_DIR/device_detection.sh
        cd $BUILD_DIR
        chmod +x complete_version_detector.sh device_detection.sh
        echo "✅ 脚本复制完成"

    - name: 智能版本检测
      id: version-detection
      run: |
        cd $BUILD_DIR
        echo "=== 智能版本检测 ==="
        sudo chown -R $USER:$USER . 2>/dev/null || true
        chmod u+w . 2>/dev/null || true
        echo "=== 开始版本检测 ==="
        set +e
        OUTPUT=$(./complete_version_detector.sh "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_spec }}" "${{ github.event.inputs.old_device }}" 2>&1)
        SCRIPT_EXIT_CODE=$?
        set -e
        echo "脚本输出:"
        echo "$OUTPUT"
        echo "脚本退出代码: $SCRIPT_EXIT_CODE"
        SELECTED_REPO=$(echo "$OUTPUT" | grep "^SELECTED_REPO=" | head -1 | cut -d'=' -f2)
        SELECTED_BRANCH=$(echo "$OUTPUT" | grep "^SELECTED_BRANCH=" | head -1 | cut -d'=' -f2)
        SELECTED_REPO_URL=$(echo "$OUTPUT" | grep "^SELECTED_REPO_URL=" | head -1 | cut -d'=' -f2)
        if [ -n "$SELECTED_REPO" ] && [ -n "$SELECTED_BRANCH" ] && [ -n "$SELECTED_REPO_URL" ]; then
            echo "✅ 从脚本输出中成功提取版本信息"
            echo "SELECTED_REPO=$SELECTED_REPO" >> $GITHUB_ENV
            echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
            echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
            echo "✅ 环境变量已设置:"
            echo "SELECTED_REPO: $SELECTED_REPO"
            echo "SELECTED_BRANCH: $SELECTED_BRANCH"
            echo "SELECTED_REPO_URL: $SELECTED_REPO_URL"
        else
            echo "❌ 无法从脚本输出中提取版本信息"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "❌ 版本检测失败"
                exit 1
            else
                echo "⚠️ 脚本成功但无法提取版本信息，使用默认值"
                echo "SELECTED_REPO=immortalwrt" >> $GITHUB_ENV
                echo "SELECTED_BRANCH=master" >> $GITHUB_ENV
                echo "SELECTED_REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
            fi
        fi

    - name: 清理构建目录准备克隆
      run: |
        cd $BUILD_DIR
        echo "=== 清理构建目录准备克隆 ==="
        echo "当前目录内容:"
        ls -la
        sudo rm -rf ./* ./.git* 2>/dev/null || true
        sudo rm -rf .[!.]* 2>/dev/null || true
        echo "清理后目录内容:"
        ls -la
        echo "✅ 目录清理完成"

    - name: 克隆选定版本的源码
      run: |
        cd $BUILD_DIR
        echo "=== 克隆选定版本的源码 ==="
        echo "仓库: $SELECTED_REPO_URL"
        echo "分支: $SELECTED_BRANCH"
        if [ -z "$SELECTED_REPO_URL" ] || [ -z "$SELECTED_BRANCH" ]; then
          echo "❌ 错误: 环境变量未正确设置"
          exit 1
        fi
        echo "检查目录状态..."
        echo "当前目录内容:"
        ls -la
        FILE_COUNT=$(ls -A | wc -l)
        if [ $FILE_COUNT -ne 0 ]; then
          echo "❌ 错误: 目录非空，无法克隆"
          echo "当前文件列表:"
          ls -la
          exit 1
        fi
        echo "开始克隆仓库..."
        git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" .
        if [ $? -eq 0 ]; then
          echo "✅ 源码克隆完成"
        else
          echo "❌ 源码克隆失败"
          exit 1
        fi

    - name: 重新复制检测脚本
      run: |
        cd $BUILD_DIR
        echo "=== 重新复制检测脚本 ==="
        cd $GITHUB_WORKSPACE
        VERSION_SCRIPT=$(find . -name "complete_version_detector.sh" -type f | head -1)
        DEVICE_SCRIPT=$(find . -name "device_detection.sh" -type f | head -1)
        if [ -z "$VERSION_SCRIPT" ] || [ -z "$DEVICE_SCRIPT" ]; then
          echo "❌ 错误: 找不到检测脚本"
          exit 1
        fi
        cp "$VERSION_SCRIPT" $BUILD_DIR/complete_version_detector.sh
        cp "$DEVICE_SCRIPT" $BUILD_DIR/device_detection.sh
        cd $BUILD_DIR
        chmod +x complete_version_detector.sh device_detection.sh
        echo "✅ 检测脚本重新复制完成"

    - name: 智能设备检测
      id: device-detection
      run: |
        cd $BUILD_DIR
        echo "=== 智能设备检测 ==="
        if [ ! -f "device_detection.sh" ]; then
          echo "❌ 错误: 设备检测脚本不存在"
          exit 1
        fi
        chmod +x device_detection.sh
        
        # 运行脚本并捕获输出
        echo "=== 开始设备检测 ==="
        set +e
        OUTPUT=$(./device_detection.sh "${{ github.event.inputs.device_name }}" 2>&1)
        SCRIPT_EXIT_CODE=$?
        set -e
        
        echo "=== 脚本原始输出 ==="
        echo "$OUTPUT"
        echo "=== 脚本退出代码: $SCRIPT_EXIT_CODE ==="
        
        # 提取环境变量（只从以大写字母开头的行中提取）
        PLATFORM=$(echo "$OUTPUT" | grep "^PLATFORM=" | tail -1 | cut -d'=' -f2)
        DEVICE_SHORT_NAME=$(echo "$OUTPUT" | grep "^DEVICE_SHORT_NAME=" | tail -1 | cut -d'=' -f2)
        DEVICE_FULL_NAME=$(echo "$OUTPUT" | grep "^DEVICE_FULL_NAME=" | tail -1 | cut -d'=' -f2)
        
        echo "=== 提取的设备信息 ==="
        echo "PLATFORM: '$PLATFORM'"
        echo "DEVICE_SHORT_NAME: '$DEVICE_SHORT_NAME'"
        echo "DEVICE_FULL_NAME: '$DEVICE_FULL_NAME'"
        
        if [ -n "$PLATFORM" ] && [ -n "$DEVICE_SHORT_NAME" ] && [ -n "$DEVICE_FULL_NAME" ]; then
            echo "✅ 从脚本输出中成功提取设备信息"
            echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
            echo "DEVICE_SHORT_NAME=$DEVICE_SHORT_NAME" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=$DEVICE_FULL_NAME" >> $GITHUB_ENV
            echo "✅ 设备环境变量已设置"
        else
            echo "❌ 无法从脚本输出中提取设备信息"
            if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
                echo "❌ 设备检测失败"
                exit 1
            else
                echo "⚠️ 脚本成功但无法提取设备信息，使用备用设备映射"
                # 设置默认值
                DEVICE_NAME="${{ github.event.inputs.device_name }}"
                case "$DEVICE_NAME" in
                    "ac42u"|"acrh17"|"rt-acrh17")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac42u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$DEVICE_NAME" >> $GITHUB_ENV
                        ;;
                    "ac58u"|"rt-ac58u"|"acrh13"|"rt-acrh13")
                        echo "PLATFORM=ipq40xx" >> $GITHUB_ENV
                        echo "DEVICE_SHORT_NAME=asus_rt-ac58u" >> $GITHUB_ENV
                        echo "DEVICE_FULL_NAME=$DEVICE_NAME" >> $GITHUB_ENV
                        ;;
                    *)
                        echo "❌ 未知设备，无法设置默认值"
                        exit 1
                        ;;
                esac
                echo "✅ 已使用备用设备信息"
            fi
        fi

    - name: 验证设备定义
      run: |
        cd $BUILD_DIR
        echo "=== 验证设备定义 ==="
        echo "平台: $PLATFORM"
        echo "设备: $DEVICE_SHORT_NAME"
        
        # 完整列出所有设备定义
        echo "=== 完整的设备定义列表 ==="
        find "target/linux/$PLATFORM" -name "*.mk" -type f -exec grep -h "define Device/" {} \; | \
            sed 's/.*define Device\///' | sed 's/^[ \t]*//' | sed 's/).*//' | sort -u | while read device; do
            echo "设备: $device"
        done
        
        echo "=== 设备总数 ==="
        find "target/linux/$PLATFORM" -name "*.mk" -type f -exec grep -h "define Device/" {} \; | wc -l
        
        # 检查具体设备
        echo "=== 检查设备 $DEVICE_SHORT_NAME 的详细定义 ==="
        FOUND=0
        for mk_file in $(find "target/linux/$PLATFORM" -name "*.mk" -type f); do
            if grep -q "define Device/$DEVICE_SHORT_NAME" "$mk_file"; then
                echo "✅ 在文件 $mk_file 中找到设备定义:"
                # 显示完整的设备定义块
                awk "/define Device\/$DEVICE_SHORT_NAME/{flag=1} flag; /endef/{flag=0}" "$mk_file"
                FOUND=1
                break
            fi
        done
        
        if [ "$FOUND" -eq 0 ]; then
            echo "❌ 未找到设备 $DEVICE_SHORT_NAME"
            echo "=== 搜索相似设备 ==="
            find "target/linux/$PLATFORM" -name "*.mk" -type f -exec grep -l "${{ github.event.inputs.device_name }}" {} \; | head -5
            exit 1
        fi
        
        # 检查设备是否在 TARGET_DEVICES 中
        echo "=== 检查设备是否在 TARGET_DEVICES 中 ==="
        for mk_file in $(find "target/linux/$PLATFORM" -name "*.mk" -type f); do
            if grep -q "TARGET_DEVICES.*+=.*$DEVICE_SHORT_NAME" "$mk_file"; then
                echo "✅ 设备 $DEVICE_SHORT_NAME 在 TARGET_DEVICES 中"
                break
            fi
        done

    - name: 更新安装feeds
      run: |
        cd $BUILD_DIR
        echo "=== 更新和安装feeds ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成设备配置
      run: |
        cd $BUILD_DIR
        echo "=== 生成设备配置 ==="
        
        # 清理平台和设备名称，确保符合 OpenWrt 配置格式
        CLEAN_PLATFORM=$(echo "$PLATFORM" | tr '[:lower:]' '[:upper:]' | tr -cd '[:alnum:]_')
        CLEAN_DEVICE=$(echo "$DEVICE_SHORT_NAME" | tr '-' '_' | tr -cd '[:alnum:]_')
        
        echo "平台: $PLATFORM -> $CLEAN_PLATFORM"
        echo "设备: $DEVICE_SHORT_NAME -> $CLEAN_DEVICE"
        
        # 生成配置
        echo "# OpenWrt 自动生成配置" > .config
        echo "# 请不要手动编辑此文件" >> .config
        echo "" >> .config
        echo "# 版本: $SELECTED_REPO - $SELECTED_BRANCH" >> .config
        echo "# 设备: ${{ github.event.inputs.device_name }}" >> .config
        echo "# 平台: $PLATFORM" >> .config
        echo "# 设备标识: $DEVICE_SHORT_NAME" >> .config
        echo "# 生成时间: $(date)" >> .config
        echo "" >> .config
        
        # 基础目标配置
        echo "CONFIG_TARGET_${CLEAN_PLATFORM}=y" >> .config
        echo "CONFIG_TARGET_${CLEAN_PLATFORM}_GENERIC=y" >> .config
        echo "CONFIG_TARGET_${CLEAN_PLATFORM}_GENERIC_DEVICE_${CLEAN_DEVICE}=y" >> .config
        
        # 文件系统配置
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
        
        # 基础包配置
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipv6=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-core=y" >> .config
        
        # 根据配置类型添加包
        CONFIG_TYPE="${{ github.event.inputs.config_type }}"
        if [ "$CONFIG_TYPE" = "minimal" ]; then
            echo "CONFIG_PACKAGE_luci=n" >> .config
        elif [ "$CONFIG_TYPE" = "normal" ] || [ "$CONFIG_TYPE" = "custom" ]; then
            echo "CONFIG_PACKAGE_luci=y" >> .config
            echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
            echo "CONFIG_PACKAGE_luci-proto-ipv6=y" >> .config
            echo "CONFIG_PACKAGE_luci-proto-ppp=y" >> .config
        fi
        
        # 自定义包
        if [ "$CONFIG_TYPE" = "custom" ] && [ -n "${{ github.event.inputs.extra_packages }}" ]; then
            echo "# 额外包配置" >> .config
            for pkg in ${{ github.event.inputs.extra_packages }}; do
                pkg_clean=$(echo "$pkg" | tr '-' '_' | tr -cd '[:alnum:]_')
                echo "CONFIG_PACKAGE_${pkg_clean}=y" >> .config
            done
        fi
        
        echo "✅ 配置生成完成"
        echo "=== 验证 .config 文件 ==="
        echo "文件行数: $(wc -l < .config)"
        echo "文件大小: $(wc -c < .config) 字节"
        echo "=== 设备相关配置项 ==="
        grep "CONFIG_TARGET" .config

    - name: 快速配置验证
      run: |
        cd $BUILD_DIR
        echo "=== 快速配置验证 ==="
        
        # 清理名称用于检查
        CLEAN_PLATFORM=$(echo "$PLATFORM" | tr '[:lower:]' '[:upper:]' | tr -cd '[:alnum:]_')
        CLEAN_DEVICE=$(echo "$DEVICE_SHORT_NAME" | tr '-' '_' | tr -cd '[:alnum:]_')
        
        echo "清理后的平台: $CLEAN_PLATFORM"
        echo "清理后的设备: $CLEAN_DEVICE"
        
        # 显示当前配置中的设备相关项
        echo "=== 当前 .config 中的设备配置 ==="
        grep "CONFIG_TARGET" .config | head -20
        
        # 执行快速配置检查
        echo "执行 make defconfig..."
        if make defconfig; then
            echo "✅ 配置验证通过"
            
            # 检查最终配置
            echo "=== 最终 .config 中的设备配置 ==="
            grep "CONFIG_TARGET" .config | head -20
            
            # 检查设备是否启用 - 尝试多种可能的配置项格式
            DEVICE_ENABLED=0
            
            # 格式1: CONFIG_TARGET_IPQ40XX_GENERIC_DEVICE_ASUS_RT_AC42U
            if grep -q "CONFIG_TARGET_${CLEAN_PLATFORM}_GENERIC_DEVICE_${CLEAN_DEVICE}=y" .config; then
                echo "✅ 设备 $DEVICE_SHORT_NAME 在最终配置中正确启用 (格式1)"
                DEVICE_ENABLED=1
            fi
            
            # 格式2: CONFIG_TARGET_DEVICE_ipq40xx_generic_DEVICE_asus_rt-ac42u
            if grep -q "CONFIG_TARGET_DEVICE_${PLATFORM}_generic_DEVICE_${DEVICE_SHORT_NAME}=y" .config; then
                echo "✅ 设备 $DEVICE_SHORT_NAME 在最终配置中正确启用 (格式2)"
                DEVICE_ENABLED=1
            fi
            
            # 格式3: 小写格式
            CLEAN_PLATFORM_LOWER=$(echo "$PLATFORM" | tr '[:upper:]' '[:lower:]')
            CLEAN_DEVICE_LOWER=$(echo "$DEVICE_SHORT_NAME" | tr '[:upper:]' '[:lower:]')
            if grep -q "CONFIG_TARGET_DEVICE_${CLEAN_PLATFORM_LOWER}_generic_DEVICE_${CLEAN_DEVICE_LOWER}=y" .config; then
                echo "✅ 设备 $DEVICE_SHORT_NAME 在最终配置中正确启用 (格式3)"
                DEVICE_ENABLED=1
            fi
            
            if [ $DEVICE_ENABLED -eq 0 ]; then
                echo "❌ 设备 $DEVICE_SHORT_NAME 未在最终配置中启用"
                echo "=== 所有设备配置项 ==="
                grep "CONFIG_TARGET_DEVICE" .config
                echo "=== 尝试手动设置设备 ==="
                # 使用替代配置方法
                manual_device_setup
            else
                echo "✅ 设备验证成功"
            fi
        else
            echo "❌ 配置验证失败"
            exit 1
        fi

    - name: 手动设备设置（备用）
      if: failure()
      run: |
        cd $BUILD_DIR
        echo "=== 手动设备设置 ==="
        
        # 使用 OpenWrt 的 menuconfig 来选择合适的设备
        echo "尝试使用预设配置..."
        
        # 根据平台选择不同的预设
        case "$PLATFORM" in
            "ipq40xx")
                echo "应用 ipq40xx 通用配置..."
                # 使用 ipq40xx 的通用配置
                make target/linux/ipq40xx/config
                ;;
            "ar71xx")
                echo "应用 ar71xx 通用配置..."
                make target/linux/ar71xx/config
                ;;
            "ramips")
                echo "应用 ramips 通用配置..."
                make target/linux/ramips/config
                ;;
            "mediatek")
                echo "应用 mediatek 通用配置..."
                make target/linux/mediatek/config
                ;;
            *)
                echo "未知平台，使用默认配置"
                ;;
        esac
        
        # 重新运行 defconfig
        make defconfig
        
        echo "=== 手动设置后的设备配置 ==="
        grep "CONFIG_TARGET_DEVICE" .config | head -10

    - name: 应用配置并编译
      run: |
        cd $BUILD_DIR
        echo "=== 应用配置并编译 ==="
        echo "开始下载依赖..."
        make -j4 download
        echo "开始编译..."
        make -j$(nproc) V=s

    - name: 验证固件生成
      if: always()
      run: |
        cd $BUILD_DIR
        echo "=== 固件生成验证 ==="
        if [ -d "bin/targets" ]; then
          echo "✅ 构建成功！生成的固件:"
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) | sort
          echo "=== 固件详细信息 ==="
          for firmware in $(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null); do
            echo "固件: $firmware"
            echo "大小: $(du -h "$firmware" | cut -f1)"
            echo ""
          done
        else
          echo "❌ 构建失败，未找到目标文件"
          echo "=== 检查构建目录结构 ==="
          find . -name "bin" -type d | head -5
          echo "=== 检查日志文件 ==="
          find . -name "*.log" -type f | head -5
        fi

    - name: 上传编译产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7

    - name: 上传配置和日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.device_name }}
        path: |
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/version_info.txt
          ${{ env.BUILD_DIR }}/device_info.txt
        retention-days: 7

    - name: 清理构建目录
      if: always()
      run: |
        echo "=== 清理构建目录 ==="
        sudo rm -rf $BUILD_DIR
        echo "✅ 构建目录已清理"
