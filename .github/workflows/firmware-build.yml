name: OpenWrt æ™ºèƒ½å›ºä»¶æ„å»ºå·¥ä½œæµï¼ˆå®Œå…¨è‡ªåŠ¨åŒ–ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: "ğŸ“± è®¾å¤‡åç§° (å¦‚: ac42u, r3gç­‰)"
        required: true
        default: "ac42u"
        type: string
      version_selection:
        description: "ğŸ”„ ç‰ˆæœ¬é€‰æ‹©"
        required: true
        type: choice
        default: "21.02"
        options:
          - "23.05"
          - "21.02"
      config_mode:
        description: |
          âš™ï¸ é…ç½®æ¨¡å¼é€‰æ‹©
          
          ğŸŸ£ åŸºç¡€æ¨¡å¼ - æœ€å°åŒ–é…ç½®ï¼Œç”¨äºæµ‹è¯•ç¼–è¯‘
          ğŸŸ  æ­£å¸¸æ¨¡å¼ - å®Œæ•´åŠŸèƒ½é…ç½®
          
          ğŸ”§ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å¹³å°çš„å…³é”®USBé©±åŠ¨éƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼
        required: true
        type: choice
        default: "normal"
        options:
          - "base"
          - "normal"
      extra_packages:
        description: |
          é¢å¤–å®‰è£…æ’ä»¶
          æ ¼å¼ï¼šç”¨åˆ†å·;åˆ†éš”ã€‚å¯ç”¨æ’ä»¶ï¼š+æ’ä»¶åã€‚ç¦ç”¨æ’ä»¶ï¼š-æ’ä»¶åã€‚
        required: false
        type: string
        default: ""

env:
  BUILD_DIR: "/mnt/openwrt-build"
  GIT_LFS_SKIP_SMUDGE: 1
  ENABLE_CACHE: "true"
  COMMIT_TOOLCHAIN: "true"

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    
    steps:
      - name: ğŸ“¥ 1. ä¸‹è½½å®Œæ•´æºä»£ç ï¼ˆæ”¯æŒå·¥å…·é“¾æäº¤ï¼‰
        id: download_source
        run: |
          echo "========================================"
          echo "ğŸ“¥ æ­¥éª¤1ï¼šä¸‹è½½å®Œæ•´æºä»£ç ï¼ˆæ”¯æŒå·¥å…·é“¾æäº¤ï¼‰"
          echo "========================================"
          echo ""
          echo "ğŸ“Š ä»“åº“ä¿¡æ¯:"
          echo "  ä»“åº“: ${{ github.repository }}"
          echo "  åˆ†æ”¯: ${{ github.ref_name }}"
          echo "  å·¥ä½œåŒº: ${{ github.workspace }}"
          echo ""
          
          # æ¸…ç†å·¥ä½œåŒº
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œåŒº..."
          cd ${{ github.workspace }}
          ls -la
          echo "ç§»é™¤å·¥ä½œåŒºç°æœ‰æ–‡ä»¶..."
          find . -maxdepth 1 ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true
          echo "âœ… å·¥ä½œåŒºæ¸…ç†å®Œæˆ"
          echo ""
          
          # å…‹éš†å®Œæ•´ä»“åº“
          echo "ğŸ“¦ å…‹éš†å®Œæ•´ä»“åº“..."
          echo "å‘½ä»¤: git clone --depth 1 https://github.com/${{ github.repository }}.git ."
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          
          if [ ! -d ".git" ]; then
            echo "âŒ é”™è¯¯: ä»“åº“å…‹éš†å¤±è´¥ï¼Œ.gitç›®å½•ä¸å­˜åœ¨"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          echo "âœ… å®Œæ•´ä»“åº“å…‹éš†å®Œæˆ"
          echo "ğŸ“Š ä»“åº“å¤§å°: $(du -sh . | cut -f1)"
          echo "ğŸ“ Gitä¿¡æ¯:"
          git log --oneline -1
          echo ""
          
          # æ˜¾ç¤ºå…³é”®æ–‡ä»¶
          echo "ğŸ“„ å…³é”®æ–‡ä»¶æ£€æŸ¥:"
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            echo "âœ… ä¸»æ„å»ºè„šæœ¬: firmware-config/scripts/build_firmware_main.sh"
            echo "  æ–‡ä»¶å¤§å°: $(ls -lh firmware-config/scripts/build_firmware_main.sh | awk '{print $5}')"
            echo "  æƒé™: $(ls -la firmware-config/scripts/build_firmware_main.sh | awk '{print $1}')"
          else
            echo "âŒ é”™è¯¯: ä¸»æ„å»ºè„šæœ¬ä¸å­˜åœ¨"
            echo "å½“å‰ç›®å½•ç»“æ„:"
            find . -maxdepth 3 -type d | sort
            exit 1
          fi
          
          if [ -f "firmware-config/scripts/error_analysis.sh" ]; then
            echo "âœ… é”™è¯¯åˆ†æè„šæœ¬: firmware-config/scripts/error_analysis.sh"
          else
            echo "âš ï¸  è­¦å‘Š: é”™è¯¯åˆ†æè„šæœ¬ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "ğŸ”§ è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
          find . -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null || true
          echo "âœ… è„šæœ¬æƒé™è®¾ç½®å®Œæˆ"
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤1å®Œæˆï¼šæºä»£ç ä¸‹è½½å®Œæˆï¼Œå‡†å¤‡è¿›è¡Œæ„å»º"
          echo "========================================"
      
      - name: ğŸ“¤ 2. ç«‹å³ä¸Šä¼ æºä»£ç ï¼ˆæ’é™¤å·¥å…·é“¾ç›®å½•ï¼‰
        id: upload_source
        run: |
          echo "========================================"
          echo "ğŸ“¤ æ­¥éª¤2ï¼šç«‹å³ä¸Šä¼ æºä»£ç ï¼ˆæ’é™¤å·¥å…·é“¾ç›®å½•ï¼‰"
          echo "========================================"
          echo ""
          
          # åˆ›å»ºæºä»£ç å‹ç¼©åŒ…ï¼ˆæ’é™¤å·¥å…·é“¾ç›®å½•ï¼‰
          echo "ğŸ“¦ åˆ›å»ºæºä»£ç å‹ç¼©åŒ…..."
          echo "æ’é™¤ç›®å½•: firmware-config/Toolchain/"
          echo "æ’é™¤ç›®å½•: .git/"
          
          mkdir -p /tmp/source-upload
          cd ${{ github.workspace }}
          
          # åˆ›å»ºæ’é™¤åˆ—è¡¨
          echo "firmware-config/Toolchain" > /tmp/exclude-list.txt
          echo ".git" >> /tmp/exclude-list.txt
          
          # åˆ›å»ºå‹ç¼©åŒ…
          tar --exclude-from=/tmp/exclude-list.txt -czf /tmp/source-upload/source-code.tar.gz .
          
          echo "âœ… æºä»£ç å‹ç¼©åŒ…åˆ›å»ºå®Œæˆ"
          echo "ğŸ“Š å‹ç¼©åŒ…å¤§å°: $(ls -lh /tmp/source-upload/source-code.tar.gz | awk '{print $5}')"
          echo ""
          
          # æ˜¾ç¤ºå‹ç¼©åŒ…å†…å®¹
          echo "ğŸ“ å‹ç¼©åŒ…å†…å®¹é¢„è§ˆ:"
          tar -tzf /tmp/source-upload/source-code.tar.gz | head -20
          echo ""
          
          echo "ğŸ‰ æ­¥éª¤2å®Œæˆï¼šæºä»£ç å‡†å¤‡ä¸Šä¼ "
          echo "========================================"
      
      - name: ğŸ“¤ 3. ä¸Šä¼ æºä»£ç å‹ç¼©åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: source-code-${{ github.event.inputs.device_name }}-${{ github.run_id }}
          path: /tmp/source-upload/
          retention-days: 7
      
      - name: ğŸ”§ 4. å®‰è£…Git LFSå’Œé…ç½®
        run: |
          echo "========================================"
          echo "ğŸ”§ æ­¥éª¤4ï¼šå®‰è£…Git LFSå’Œé…ç½®"
          echo "========================================"
          echo ""
          
          echo "ğŸ“¦ å®‰è£…Git LFS..."
          sudo apt-get update
          sudo apt-get install -y git-lfs
          
          echo "ğŸ”§ é…ç½®Git..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global http.postBuffer 524288000
          
          echo "âš¡ åˆå§‹åŒ–Git LFS..."
          git lfs install --force
          
          echo "ğŸ“¥ æ‹‰å–Git LFSæ–‡ä»¶..."
          git lfs pull || echo "âš ï¸  Git LFSæ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ„å»º..."
          
          echo ""
          echo "ğŸ“Š Git LFSæ–‡ä»¶çŠ¶æ€:"
          git lfs ls-files 2>/dev/null | head -10 || echo "   æ— LFSæ–‡ä»¶æˆ–æœªè·Ÿè¸ª"
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤4å®Œæˆï¼šGit LFSå®‰è£…å’Œé…ç½®å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ“Š 5. æ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€
        run: |
          echo "========================================"
          echo "ğŸ“Š æ­¥éª¤5ï¼šæ£€æŸ¥å¤§æ–‡ä»¶çŠ¶æ€"
          echo "========================================"
          echo ""
          
          echo "ğŸ” æ£€æŸ¥å¤§æ–‡ä»¶..."
          firmware-config/scripts/build_firmware_main.sh check_large_files
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤5å®Œæˆï¼šå¤§æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ—‚ï¸ 6. æ£€æŸ¥å·¥å…·é“¾ç›®å½•çŠ¶æ€
        run: |
          echo "========================================"
          echo "ğŸ—‚ï¸ æ­¥éª¤6ï¼šæ£€æŸ¥å·¥å…·é“¾ç›®å½•çŠ¶æ€"
          echo "========================================"
          echo ""
          
          TOOLCHAIN_DIR="${{ github.workspace }}/firmware-config/Toolchain"
          
          echo "ğŸ” æ£€æŸ¥å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          
          if [ -d "$TOOLCHAIN_DIR" ]; then
            echo "âœ… å·¥å…·é“¾ç›®å½•å­˜åœ¨"
            echo ""
            echo "ğŸ“Š ç›®å½•ä¿¡æ¯:"
            echo "  è·¯å¾„: $TOOLCHAIN_DIR"
            echo "  å¤§å°: $(du -sh "$TOOLCHAIN_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            echo ""
            echo "ğŸ“ ç›®å½•ç»“æ„:"
            find "$TOOLCHAIN_DIR" -maxdepth 3 -type d 2>/dev/null | sort | head -20
            echo ""
            
            # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
            file_count=$(find "$TOOLCHAIN_DIR" -type f 2>/dev/null | wc -l)
            echo "ğŸ“ˆ æ–‡ä»¶ç»Ÿè®¡:"
            echo "  æ–‡ä»¶æ€»æ•°: $file_count ä¸ª"
            
            if [ $file_count -gt 0 ]; then
              echo "âœ… å·¥å…·é“¾ç›®å½•éç©º"
              echo ""
              echo "ğŸ”‘ å…³é”®æ–‡ä»¶åˆ—è¡¨:"
              find "$TOOLCHAIN_DIR" -type f \( -name "*gcc*" -o -name "*.info" \) 2>/dev/null | head -10
            else
              echo "âš ï¸  å·¥å…·é“¾ç›®å½•ä¸ºç©º"
            fi
          else
            echo "â„¹ï¸  å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨ï¼Œå°†è‡ªåŠ¨åˆ›å»º"
            mkdir -p "$TOOLCHAIN_DIR"
            echo "âœ… å·¥å…·é“¾ç›®å½•å·²åˆ›å»º: $TOOLCHAIN_DIR"
          fi
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤6å®Œæˆï¼šå·¥å…·é“¾ç›®å½•æ£€æŸ¥å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ’¾ 7. åˆå§‹åŒ–å·¥å…·é“¾ç›®å½•
        run: |
          echo "========================================"
          echo "ğŸ’¾ æ­¥éª¤7ï¼šåˆå§‹åŒ–å·¥å…·é“¾ç›®å½•"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh init_toolchain_dir
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤7å®Œæˆï¼šå·¥å…·é“¾ç›®å½•åˆå§‹åŒ–å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ› ï¸ 8. è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        run: |
          echo "========================================"
          echo "ğŸ› ï¸ æ­¥éª¤8ï¼šè®¾ç½®ç¼–è¯‘ç¯å¢ƒ"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh setup_environment
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤8å®Œæˆï¼šç¼–è¯‘ç¯å¢ƒè®¾ç½®å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ“ 9. åˆ›å»ºæ„å»ºç›®å½•
        run: |
          echo "========================================"
          echo "ğŸ“ æ­¥éª¤9ï¼šåˆ›å»ºæ„å»ºç›®å½•"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh create_build_dir
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤9å®Œæˆï¼šæ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"
          echo "========================================"
      
      - name: ğŸš€ 10. åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
        id: init_build_env
        run: |
          echo "========================================"
          echo "ğŸš€ æ­¥éª¤10ï¼šåˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
          echo "========================================"
          echo ""
          
          echo "ğŸ“± è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "ğŸ”„ ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
          echo "âš™ï¸ é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "ğŸ”Œ é¢å¤–æ’ä»¶: ${{ github.event.inputs.extra_packages }}"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}"
          
          echo ""
          echo "ğŸ“‹ ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ:"
          echo "  æ„å»ºç›®å½•: $BUILD_DIR"
          
          # åŠ è½½ç¯å¢ƒå˜é‡
          source /mnt/openwrt-build/build_env.sh
          
          echo "  åˆ†æ”¯: $SELECTED_BRANCH"
          echo "  ç›®æ ‡: $TARGET"
          echo "  å­ç›®æ ‡: $SUBTARGET"
          echo "  è®¾å¤‡: $DEVICE"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "DEVICE=$DEVICE" >> $GITHUB_ENV
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤10å®Œæˆï¼šæ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
          echo "========================================"
      
      - name: âš¡ 11. æ˜¾ç¤ºæ„å»ºé…ç½®
        run: |
          echo "========================================"
          echo "âš¡ æ­¥éª¤11ï¼šæ˜¾ç¤ºæ„å»ºé…ç½®"
          echo "========================================"
          echo ""
          
          echo "ğŸ“Š æ„å»ºé…ç½®æ‘˜è¦:"
          echo "  è®¾å¤‡: ${{ github.event.inputs.device_name }} ($DEVICE)"
          echo "  ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }} ($SELECTED_BRANCH)"
          echo "  é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          echo "  æ„å»ºç›®å½•: $BUILD_DIR"
          echo "  å¯ç”¨ç¼“å­˜: $ENABLE_CACHE"
          echo "  æäº¤å·¥å…·é“¾: $COMMIT_TOOLCHAIN"
          echo ""
          
          echo "ğŸ‰ æ­¥éª¤11å®Œæˆï¼šæ„å»ºé…ç½®æ˜¾ç¤ºå®Œæˆ"
          echo "========================================"
      
      - name: ğŸ”Œ 12. æ·»åŠ TurboACCæ”¯æŒ
        run: |
          echo "========================================"
          echo "ğŸ”Œ æ­¥éª¤12ï¼šæ·»åŠ TurboACCæ”¯æŒ"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh add_turboacc_support
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤12å®Œæˆï¼šTurboACCæ”¯æŒæ·»åŠ å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ“¦ 13. é…ç½®Feeds
        run: |
          echo "========================================"
          echo "ğŸ“¦ æ­¥éª¤13ï¼šé…ç½®Feeds"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh configure_feeds
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤13å®Œæˆï¼šFeedsé…ç½®å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ”§ 14. å®‰è£…TurboACCåŒ…
        if: env.SELECTED_BRANCH == 'openwrt-23.05' && github.event.inputs.config_mode == 'normal'
        run: |
          echo "========================================"
          echo "ğŸ”§ æ­¥éª¤14ï¼šå®‰è£…TurboACCåŒ…"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh install_turboacc_packages
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤14å®Œæˆï¼šTurboACCåŒ…å®‰è£…å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ’½ 15. ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
        run: |
          echo "========================================"
          echo "ğŸ’½ æ­¥éª¤15ï¼šç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh pre_build_space_check
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤15å®Œæˆï¼šç©ºé—´æ£€æŸ¥å®Œæˆ"
          echo "========================================"
      
      - name: âš™ï¸ 16. æ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰
        run: |
          echo "========================================"
          echo "âš™ï¸ æ­¥éª¤16ï¼šæ™ºèƒ½é…ç½®ç”Ÿæˆï¼ˆUSBå®Œå…¨ä¿®å¤åŠ å¼ºç‰ˆï¼‰"
          echo "========================================"
          echo ""
          echo "ğŸš¨ USB 3.0åŠ å¼ºï¼šæ‰€æœ‰å…³é”®USBé©±åŠ¨å¼ºåˆ¶å¯ç”¨"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh generate_config "${{ github.event.inputs.extra_packages }}"
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤16å®Œæˆï¼šæ™ºèƒ½é…ç½®ç”Ÿæˆå®Œæˆ"
          echo "========================================"
      
      - name: ğŸ” 17. éªŒè¯USBé…ç½®
        run: |
          echo "========================================"
          echo "ğŸ” æ­¥éª¤17ï¼šéªŒè¯USBé…ç½®"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh verify_usb_config
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤17å®Œæˆï¼šUSBé…ç½®éªŒè¯å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ›¡ï¸ 18. USBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥
        run: |
          echo "========================================"
          echo "ğŸ›¡ï¸ æ­¥éª¤18ï¼šUSBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh check_usb_drivers_integrity
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤18å®Œæˆï¼šUSBé©±åŠ¨å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ"
          echo "========================================"
      
      - name: âœ… 19. åº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…
        run: |
          echo "========================================"
          echo "âœ… æ­¥éª¤19ï¼šåº”ç”¨é…ç½®å¹¶æ˜¾ç¤ºè¯¦æƒ…"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh apply_config
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤19å®Œæˆï¼šé…ç½®åº”ç”¨å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ’¾ 20. æ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶
        run: |
          echo "========================================"
          echo "ğŸ’¾ æ­¥éª¤20ï¼šæ£€æŸ¥å¹¶å¤‡ä»½é…ç½®æ–‡ä»¶"
          echo "========================================"
          echo ""
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
            echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
            mkdir -p firmware-config/config-backup
            
            # å¤‡ä»½åˆ°ä»“åº“ç›®å½•
            backup_file="firmware-config/config-backup/config_${{ github.event.inputs.device_name }}_${{ env.SELECTED_BRANCH }}_${{ github.event.inputs.config_mode }}_$(date +%Y%m%d_%H%M%S).config"
            
            cp "${{ env.BUILD_DIR }}/.config" "$backup_file"
            echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½åˆ°ä»“åº“ç›®å½•: $backup_file"
            
            # æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶ä¿¡æ¯
            echo "ğŸ“Š å¤‡ä»½æ–‡ä»¶ä¿¡æ¯:"
            echo "  å¤§å°: $(ls -lh $backup_file | awk '{print $5}')"
            echo "  è¡Œæ•°: $(wc -l < $backup_file)"
          else
            echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤20å®Œæˆï¼šé…ç½®æ–‡ä»¶å¤‡ä»½å®Œæˆ"
          echo "========================================"
      
      - name: ğŸŒ 21. ä¿®å¤ç½‘ç»œç¯å¢ƒ
        run: |
          echo "========================================"
          echo "ğŸŒ æ­¥éª¤21ï¼šä¿®å¤ç½‘ç»œç¯å¢ƒ"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh fix_network
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤21å®Œæˆï¼šç½‘ç»œç¯å¢ƒä¿®å¤å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ”§ 22. åŠ è½½å·¥å…·é“¾
        run: |
          echo "========================================"
          echo "ğŸ”§ æ­¥éª¤22ï¼šåŠ è½½å·¥å…·é“¾"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh load_toolchain
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤22å®Œæˆï¼šå·¥å…·é“¾åŠ è½½å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ“Š 23. æ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€
        run: |
          echo "========================================"
          echo "ğŸ“Š æ­¥éª¤23ï¼šæ£€æŸ¥å·¥å…·é“¾åŠ è½½çŠ¶æ€"
          echo "========================================"
          echo ""
          
          cd ${{ env.BUILD_DIR }}
          
          echo "ğŸ” æ£€æŸ¥æ„å»ºç›®å½•å·¥å…·é“¾çŠ¶æ€..."
          if [ -d "staging_dir" ]; then
            echo "âœ… staging_dir ç›®å½•å­˜åœ¨"
            
            local toolchain_dirs=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | wc -l)
            echo "ğŸ“Š æ‰¾åˆ° $toolchain_dirs ä¸ªå·¥å…·é“¾ç›®å½•"
            
            if [ $toolchain_dirs -gt 0 ]; then
              echo "ğŸ‰ å·¥å…·é“¾å·²æˆåŠŸåŠ è½½åˆ°æ„å»ºç›®å½•"
              find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | while read dir; do
                echo "  å·¥å…·é“¾: $(basename $dir)"
                echo "    å¤§å°: $(du -sh "$dir" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
                
                # æ£€æŸ¥ç¼–è¯‘å™¨
                if [ -d "$dir/bin" ]; then
                  local compiler_count=$(find "$dir/bin" -name "*gcc*" 2>/dev/null | wc -l)
                  echo "    ç¼–è¯‘å™¨æ–‡ä»¶: $compiler_count ä¸ª"
                  if [ $compiler_count -gt 0 ]; then
                    find "$dir/bin" -name "*gcc*" 2>/dev/null | head -3 | while read compiler; do
                      echo "      - $(basename $compiler)"
                    done
                  fi
                fi
              done
            else
              echo "âš ï¸  æ„å»ºç›®å½•ä¸­æ²¡æœ‰å·¥å…·é“¾ï¼Œå°†è‡ªåŠ¨ä¸‹è½½"
            fi
          else
            echo "âŒ staging_dir ç›®å½•ä¸å­˜åœ¨ï¼Œå°†è‡ªåŠ¨åˆ›å»ºå¹¶ä¸‹è½½å·¥å…·é“¾"
          fi
          
          echo ""
          echo "ğŸ”§ éªŒè¯å·¥å…·é“¾å®Œæ•´æ€§..."
          firmware-config/scripts/build_firmware_main.sh check_toolchain_completeness || echo "âš ï¸  å·¥å…·é“¾å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥"
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤23å®Œæˆï¼šå·¥å…·é“¾åŠ è½½çŠ¶æ€æ£€æŸ¥å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ“¥ 24. ä¸‹è½½ä¾èµ–åŒ…
        run: |
          echo "========================================"
          echo "ğŸ“¥ æ­¥éª¤24ï¼šä¸‹è½½ä¾èµ–åŒ…"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh download_dependencies
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤24å®Œæˆï¼šä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ”Œ 25. é›†æˆè‡ªå®šä¹‰æ–‡ä»¶
        run: |
          echo "========================================"
          echo "ğŸ”Œ æ­¥éª¤25ï¼šé›†æˆè‡ªå®šä¹‰æ–‡ä»¶"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh integrate_custom_files
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤25å®Œæˆï¼šè‡ªå®šä¹‰æ–‡ä»¶é›†æˆå®Œæˆ"
          echo "========================================"
      
      - name: ğŸš¨ 26. å‰ç½®é”™è¯¯æ£€æŸ¥
        run: |
          echo "========================================"
          echo "ğŸš¨ æ­¥éª¤26ï¼šå‰ç½®é”™è¯¯æ£€æŸ¥"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh pre_build_error_check
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤26å®Œæˆï¼šå‰ç½®é”™è¯¯æ£€æŸ¥å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ’½ 27. ç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥
        run: |
          echo "========================================"
          echo "ğŸ’½ æ­¥éª¤27ï¼šç¼–è¯‘å›ºä»¶å‰çš„ç©ºé—´æ£€æŸ¥"
          echo "========================================"
          echo ""
          
          df -h
          AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo ""
          echo "ğŸ“Š ç©ºé—´æ£€æŸ¥ç»“æœ:"
          echo "  /mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
          
          # æ£€æŸ¥ç¼–è¯‘æ‰€éœ€ç©ºé—´
          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å‰ç©ºé—´ä¸è¶³ (éœ€è¦è‡³å°‘10Gï¼Œå½“å‰${AVAILABLE_GB}G)"
            exit 1
          elif [ $AVAILABLE_GB -lt 20 ]; then
            echo "âš ï¸  è­¦å‘Š: ç¼–è¯‘å‰ç©ºé—´è¾ƒä½ (å»ºè®®è‡³å°‘20Gï¼Œå½“å‰${AVAILABLE_GB}G)"
          else
            echo "âœ… ç¼–è¯‘å‰ç©ºé—´å……è¶³"
          fi
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤27å®Œæˆï¼šç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ”¨ 28. ç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰
        run: |
          echo "========================================"
          echo "ğŸ”¨ æ­¥éª¤28ï¼šç¼–è¯‘å›ºä»¶ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰"
          echo "========================================"
          echo ""
          
          echo "âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜: $ENABLE_CACHE"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh build_firmware "true"
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤28å®Œæˆï¼šå›ºä»¶ç¼–è¯‘å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ’¾ 29. ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰
        if: success()
        run: |
          echo "========================================"
          echo "ğŸ’¾ æ­¥éª¤29ï¼šä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ç›®å½•ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰"
          echo "========================================"
          echo ""
          
          echo "ğŸ“¤ è‡ªåŠ¨ä¿å­˜å·¥å…·é“¾..."
          firmware-config/scripts/build_firmware_main.sh save_toolchain
          
          echo ""
          echo "ğŸ“Š ä¿å­˜ç»“æœ:"
          if [ -d "firmware-config/Toolchain" ]; then
            echo "âœ… å·¥å…·é“¾å·²ä¿å­˜åˆ°ä»“åº“ç›®å½•"
            echo "  ç›®å½•å¤§å°: $(du -sh firmware-config/Toolchain 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            echo "  ç›®å½•ç»“æ„:"
            find firmware-config/Toolchain -type d 2>/dev/null | head -10
          else
            echo "âŒ å·¥å…·é“¾ä¿å­˜å¤±è´¥"
          fi
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤29å®Œæˆï¼šå·¥å…·é“¾ä¿å­˜å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ“¤ 30. æäº¤å·¥å…·é“¾åˆ°ä»“åº“ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰
        if: success()
        run: |
          echo "========================================"
          echo "ğŸ“¤ æ­¥éª¤30ï¼šæäº¤å·¥å…·é“¾åˆ°ä»“åº“ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰"
          echo "========================================"
          echo ""
          
          echo "ğŸ”§ è‡ªåŠ¨æäº¤å·¥å…·é“¾åˆ°Git LFS..."
          
          # æ£€æŸ¥å½“å‰ç›®å½•æ˜¯å¦æ˜¯Gitä»“åº“
          if [ ! -d ".git" ]; then
            echo "âŒ å½“å‰ç›®å½•ä¸æ˜¯Gitä»“åº“ï¼Œæ— æ³•æäº¤å·¥å…·é“¾"
            exit 0
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·é“¾æ–‡ä»¶
          if [ -d "firmware-config/Toolchain" ] && [ -n "$(ls -A firmware-config/Toolchain 2>/dev/null)" ]; then
            echo "ğŸ“¦ æœ‰å·¥å…·é“¾æ–‡ä»¶éœ€è¦æäº¤"
            
            # é…ç½®gitç”¨æˆ·
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            
            # æ·»åŠ .gitattributesæ–‡ä»¶ç¡®ä¿LFSé…ç½®
            echo "ğŸ”§ ç¡®ä¿.gitattributesæ–‡ä»¶å­˜åœ¨å¹¶é…ç½®æ­£ç¡®"
            if [ ! -f ".gitattributes" ]; then
              echo "# Git LFS é…ç½®" > .gitattributes
              echo "firmware-config/Toolchain/** filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
              echo "*.tar.gz filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
              echo "*.tar.xz filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
              echo "*.bin filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
              echo "*.img filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
              echo "âœ… åˆ›å»º.gitattributesæ–‡ä»¶"
            fi
            
            # ç¡®ä¿Git LFSå·²æ­£ç¡®è®¾ç½®
            git lfs install --force
            
            # æ·»åŠ æ‰€æœ‰å·¥å…·é“¾æ–‡ä»¶åˆ°LFSè·Ÿè¸ª
            echo "ğŸ”§ æ·»åŠ å·¥å…·é“¾æ–‡ä»¶åˆ°Git LFSè·Ÿè¸ª..."
            git add .gitattributes
            git add firmware-config/Toolchain/
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
            if git status --porcelain | grep -q "firmware-config/Toolchain" || git status --porcelain | grep -q ".gitattributes"; then
              echo "ğŸ“¦ æäº¤å·¥å…·é“¾æ–‡ä»¶..."
              
              # ä½¿ç”¨å•è¡Œæäº¤æ¶ˆæ¯
              COMMIT_MSG="chore: è‡ªåŠ¨æ›´æ–°å·¥å…·é“¾ [æ„å»ºè‡ªåŠ¨åŒ–] ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }} ç›®æ ‡: ${{ env.TARGET }}/${{ env.SUBTARGET }} è®¾å¤‡: ${{ env.DEVICE }} æ¨¡å¼: ${{ github.event.inputs.config_mode }} æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
              
              git commit -m "$COMMIT_MSG"
              
              echo "ğŸš€ æ¨é€å·¥å…·é“¾åˆ°è¿œç¨‹ä»“åº“..."
              
              # å°è¯•æ¨é€
              for i in {1..3}; do
                echo "å°è¯•æ¨é€ #$i..."
                if git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}; then
                  echo "âœ… å·¥å…·é“¾å·²æˆåŠŸæäº¤å¹¶æ¨é€åˆ°ä»“åº“"
                  break
                else
                  echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
                  sleep 10
                  if [ $i -eq 3 ]; then
                    echo "âŒ æ¨é€å¤±è´¥3æ¬¡ï¼Œè·³è¿‡å·¥å…·é“¾æäº¤"
                  fi
                fi
              done
            else
              echo "â„¹ï¸  æ²¡æœ‰æ–°çš„å·¥å…·é“¾æ–‡ä»¶éœ€è¦æäº¤"
            fi
          else
            echo "â„¹ï¸  æ²¡æœ‰å·¥å…·é“¾æ–‡ä»¶éœ€è¦æäº¤"
          fi
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤30å®Œæˆï¼šå·¥å…·é“¾æäº¤å®Œæˆ"
          echo "========================================"
      
      - name: âš ï¸ 31. é”™è¯¯åˆ†æï¼ˆå¦‚æœå¤±è´¥ï¼‰
        if: failure()
        run: |
          echo "========================================"
          echo "âš ï¸ æ­¥éª¤31ï¼šé”™è¯¯åˆ†æï¼ˆæ„å»ºå¤±è´¥ï¼‰"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/error_analysis.sh
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤31å®Œæˆï¼šé”™è¯¯åˆ†æå®Œæˆ"
          echo "========================================"
      
      - name: ğŸ“Š 32. ç¼–è¯‘åç©ºé—´æ£€æŸ¥
        run: |
          echo "========================================"
          echo "ğŸ“Š æ­¥éª¤32ï¼šç¼–è¯‘åç©ºé—´æ£€æŸ¥"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh post_build_space_check
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤32å®Œæˆï¼šç¼–è¯‘åç©ºé—´æ£€æŸ¥å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ“¦ 33. å›ºä»¶æ–‡ä»¶æ£€æŸ¥
        if: success()
        run: |
          echo "========================================"
          echo "ğŸ“¦ æ­¥éª¤33ï¼šå›ºä»¶æ–‡ä»¶æ£€æŸ¥"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh check_firmware_files
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤33å®Œæˆï¼šå›ºä»¶æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
          echo "========================================"
      
      - name: â¬†ï¸ 34. ä¸Šä¼ å›ºä»¶
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/bin/targets/
          retention-days: 7
      
      - name: â¬†ï¸ 35. ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ env.BUILD_DIR }}/build.log
          retention-days: 7
      
      - name: â¬†ï¸ 36. ä¸Šä¼ é…ç½®æ–‡ä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}
          path: ${{ github.workspace }}/firmware-config/config-backup/
          retention-days: 7
      
      - name: ğŸ§¹ 37. æ¸…ç†ç›®å½•
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ§¹ æ­¥éª¤37ï¼šæ¸…ç†ç›®å½•"
          echo "========================================"
          echo ""
          
          firmware-config/scripts/build_firmware_main.sh cleanup
          
          echo ""
          echo "ğŸ‰ æ­¥éª¤37å®Œæˆï¼šç›®å½•æ¸…ç†å®Œæˆ"
          echo "========================================"
      
      - name: ğŸ“ˆ 38. æœ€ç»ˆæ„å»ºæ€»ç»“
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“ˆ æ­¥éª¤38ï¼šæœ€ç»ˆæ„å»ºæ€»ç»“"
          echo "========================================"
          echo ""
          
          echo "ğŸ¯ æ„å»ºé…ç½®æ‘˜è¦:"
          echo "  è®¾å¤‡: ${{ github.event.inputs.device_name }}"
          echo "  ç‰ˆæœ¬: ${{ env.SELECTED_BRANCH }}"
          echo "  é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
          echo "  ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo ""
          
          echo "âš™ï¸ è‡ªåŠ¨åŒ–åŠŸèƒ½çŠ¶æ€:"
          echo "  âœ… è‡ªåŠ¨ä¸‹è½½æºä»£ç ï¼ˆæ”¯æŒå·¥å…·é“¾æäº¤ï¼‰"
          echo "  âœ… è‡ªåŠ¨ä¸Šä¼ æºä»£ç å‹ç¼©åŒ…ï¼ˆæ­¥éª¤3ï¼‰"
          echo "  âœ… è‡ªåŠ¨å¯ç”¨ç¼–è¯‘ç¼“å­˜ ($ENABLE_CACHE)"
          echo "  âœ… è‡ªåŠ¨æäº¤å·¥å…·é“¾åˆ°ä»“åº“ ($COMMIT_TOOLCHAIN)"
          echo ""
          
          echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
          echo "  1. æºä»£ç å‹ç¼©åŒ… (æ­¥éª¤3ä¸Šä¼ )"
          echo "  2. å›ºä»¶æ–‡ä»¶: firmware-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          echo "  3. ç¼–è¯‘æ—¥å¿—: build-log-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          echo "  4. é…ç½®æ–‡ä»¶: config-${{ github.event.inputs.device_name }}-${{ env.SELECTED_BRANCH }}-${{ github.event.inputs.config_mode }}"
          echo ""
          
          echo "ğŸ“Š å·¥å…·é“¾çŠ¶æ€:"
          if [ -d "firmware-config/Toolchain" ]; then
            toolchain_size=$(du -sh firmware-config/Toolchain 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            echo "  âœ… å·¥å…·é“¾å·²ä¿å­˜ (å¤§å°: $toolchain_size)"
            echo "  ğŸ’¡ ä¸‹æ¬¡æ„å»ºå°†è‡ªåŠ¨åŠ è½½å·¥å…·é“¾ï¼Œç¼–è¯‘é€Ÿåº¦æ›´å¿«"
          else
            echo "  âš ï¸  å·¥å…·é“¾æœªä¿å­˜"
          fi
          
          echo ""
          echo "ğŸ“ˆ æ„å»ºçŠ¶æ€: ${{ job.status }}"
          echo ""
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
            echo "ğŸ“¥ æ‰€æœ‰æ„å»ºäº§ç‰©å·²ä¸Šä¼ ï¼Œå¯åœ¨Artifactsä¸­ä¸‹è½½"
            echo "ğŸš€ ä¸‹æ¬¡æ„å»ºå°†ä½¿ç”¨å·²ä¿å­˜çš„å·¥å…·é“¾ï¼Œç¼–è¯‘é€Ÿåº¦æ›´å¿«"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
            echo "ğŸ” è¯·æŸ¥çœ‹é”™è¯¯åˆ†ææ—¥å¿—å’Œæ„å»ºæ—¥å¿—"
          fi
          
          echo ""
          echo "========================================"
          echo "          ğŸ æ„å»ºæµç¨‹å…¨éƒ¨å®Œæˆ          "
          echo "========================================"
