# ã€readme-autoup.yml-01ã€‘
# æ›´æ–°é¢‘ç‡ï¼šå¯æ‰‹åŠ¨è§¦å‘æˆ–æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è‡ªåŠ¨è¿è¡Œ
# è¯´æ˜ï¼šè‡ªåŠ¨æ›´æ–° README.md ä¸­çš„é¡¹ç›®ç»“æ„è¡¨ï¼ŒåŸºäºå®é™…ä»“åº“ç›®å½•
# readme-autoup.yml-01-end

name: è‡ªåŠ¨æ›´æ–° README ç›®å½•ç»“æ„

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8:00 è¿è¡Œï¼ˆUTC+8 å¯¹åº” UTC 0:00ï¼‰
    - cron: '0 0 * * 1'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'firmware-config/**'
      - '.github/workflows/readme-autoup.yml'
      - 'README.md'

jobs:
  update-readme:
    name: æ›´æ–° README ç›®å½•è¡¨
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write

    steps:
      # ã€readme-autoup.yml-02ã€‘æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # readme-autoup.yml-02-end

      # ã€readme-autoup.yml-03ã€‘ç”Ÿæˆç›®å½•ç»“æ„æ ‘
      - name: ç”Ÿæˆé¡¹ç›®ç›®å½•ç»“æ„
        id: tree
        run: |
          # ä½¿ç”¨ tree å‘½ä»¤ç”Ÿæˆç›®å½•ç»“æ„ï¼ˆæ’é™¤ .git ç›®å½•ï¼‰
          sudo apt-get install -y tree
          
          # ç”Ÿæˆç›®å½•æ ‘ï¼Œæ’é™¤ .git å’Œå¤šä½™æ–‡ä»¶
          TREE_OUTPUT=$(tree -I '.git|__pycache__|*.pyc' --dirsfirst -F)
          
          # å°†å¤šè¡Œå†…å®¹ä¿å­˜ä¸ºç¯å¢ƒå˜é‡
          {
            echo 'TREE_CONTENT<<EOF'
            echo "$TREE_OUTPUT"
            echo 'EOF'
          } >> $GITHUB_ENV
          
          # åŒæ—¶ä¿å­˜åˆ°æ–‡ä»¶å¤‡ç”¨
          echo "$TREE_OUTPUT" > project_tree.txt
      # readme-autoup.yml-03-end

      # ã€readme-autoup.yml-04ã€‘æ›´æ–° README.md ä¸­çš„ç›®å½•è¡¨
      - name: æ›´æ–° README ç›®å½•è¡¨
        run: |
          # å®šä¹‰æ ‡è®°
          START_MARK="## ğŸ“ é¡¹ç›®ç»“æ„"
          END_MARK="æ³¨æ„ï¼Œè‡ªå®šä¹‰æ–‡ä»¶åæ˜¯è‹±æ–‡çš„ï¼Œæ–¹ä¾¿å¤åˆ¶ã€è¿è¡Œ"
          
          # è¯»å–å½“å‰ README
          cp README.md README.md.bak
          
          # æ„å»ºæ–°çš„ç›®å½•è¡¨å†…å®¹
          cat > new_tree_section.md << 'EOF'
          ## ğŸ“ é¡¹ç›®ç»“æ„

          ```
          $TREE_CONTENT
          ```
          EOF
          
          # æ›¿æ¢æ ‡è®°ä¹‹é—´çš„å†…å®¹
          # ä½¿ç”¨ awk è¿›è¡Œæ›¿æ¢
          awk -v start="$START_MARK" -v end="$END_MARK" -v newfile="new_tree_section.md" '
          BEGIN { printing = 1; found = 0; }
          {
            if ($0 ~ start && !found) {
              print $0;
              found = 1;
              printing = 0;
              while ((getline line < newfile) > 0) {
                print line;
              }
              close(newfile);
              next;
            }
            if ($0 ~ end && found) {
              printing = 1;
              found = 0;
            }
            if (printing) print $0;
          }' README.md.bak > README.md
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f README.md.bak new_tree_section.md
      # readme-autoup.yml-04-end

      # ã€readme-autoup.yml-05ã€‘æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      - name: æ£€æŸ¥ README å˜æ›´
        id: git-check
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      # readme-autoup.yml-05-end

      # ã€readme-autoup.yml-06ã€‘æäº¤å˜æ›´
      - name: æäº¤ README æ›´æ–°
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "docs: è‡ªåŠ¨æ›´æ–°é¡¹ç›®ç›®å½•ç»“æ„ [skip ci]"
          git push
      # readme-autoup.yml-06-end

      # ã€readme-autoup.yml-07ã€‘åˆ›å»º PRï¼ˆå¯é€‰ï¼Œå¦‚æœ main åˆ†æ”¯å—ä¿æŠ¤ï¼‰
      - name: åˆ›å»º Pull Request
        if: steps.git-check.outputs.changed == 'true' && github.ref == 'refs/heads/main'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: è‡ªåŠ¨æ›´æ–°é¡¹ç›®ç›®å½•ç»“æ„"
          title: "è‡ªåŠ¨æ›´æ–° README ç›®å½•ç»“æ„"
          body: "æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºæ›´æ–° README.md ä¸­çš„é¡¹ç›®ç›®å½•ç»“æ„ã€‚"
          branch: "auto-update-readme"
          base: "main"
          labels: "automated pr, documentation"
      # readme-autoup.yml-07-end
