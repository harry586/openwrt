# ã€readme-autoup.yml-01ã€‘
# æ›´æ–°é¢‘ç‡ï¼šå¯æ‰‹åŠ¨è§¦å‘æˆ–æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è‡ªåŠ¨è¿è¡Œ
# è¯´æ˜ï¼šè‡ªåŠ¨æ›´æ–° README.md ä¸­çš„é¡¹ç›®ç»“æ„è¡¨
# readme-autoup.yml-01-end

name: è‡ªåŠ¨æ›´æ–° README ç›®å½•ç»“æ„

on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹ï¼ˆUTC+8ï¼‰
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  update-readme:
    name: æ›´æ–° README ç›®å½•è¡¨
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      # ã€readme-autoup.yml-02ã€‘æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      # readme-autoup.yml-02-end

      # ã€readme-autoup.yml-03ã€‘å®‰è£… tree å‘½ä»¤
      - name: å®‰è£… tree
        run: sudo apt-get install -y tree
      # readme-autoup.yml-03-end

      # ã€readme-autoup.yml-04ã€‘ç”Ÿæˆç›®å½•æ ‘å¹¶æ›´æ–° README
      - name: æ›´æ–° README ä¸­çš„é¡¹ç›®ç»“æ„
        run: |
          # ç”Ÿæˆç›®å½•æ ‘
          TREE_OUTPUT=$(tree -I '.git|.github|__pycache__|*.pyc' --dirsfirst -F)
          
          # ä½¿ç”¨ sed ç›´æ¥æ›¿æ¢ README.md ä¸­é¡¹ç›®ç»“æ„éƒ¨åˆ†çš„å†…å®¹
          sed -i '/^## ğŸ“ é¡¹ç›®ç»“æ„/,/^æ³¨æ„ï¼Œè‡ªå®šä¹‰æ–‡ä»¶åæ˜¯è‹±æ–‡çš„ï¼Œæ–¹ä¾¿å¤åˆ¶ã€è¿è¡Œ/ {
            /^## ğŸ“ é¡¹ç›®ç»“æ„/! { /^æ³¨æ„ï¼Œè‡ªå®šä¹‰æ–‡ä»¶åæ˜¯è‹±æ–‡çš„ï¼Œæ–¹ä¾¿å¤åˆ¶ã€è¿è¡Œ/! d }
            /^## ğŸ“ é¡¹ç›®ç»“æ„/ a \
          \`\`\`\
          '"$TREE_OUTPUT"'\
          \`\`\`
          }' README.md
      # readme-autoup.yml-04-end

      # ã€readme-autoup.yml-05ã€‘æäº¤æ›´æ”¹ï¼ˆå¦‚æœæœ‰ï¼‰
      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || git commit -m "docs: è‡ªåŠ¨æ›´æ–°é¡¹ç›®ç›®å½•ç»“æ„ [skip ci]"
          git push
      # readme-autoup.yml-05-end
