name: ğŸ”§ å…¨è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ

on:
  # 1. è‡ªåŠ¨è§¦å‘ï¼šä¿®å¤æ–‡ä»¶æˆ–å·¥ä½œæµæœ¬èº«è¢«ä¿®æ”¹æ—¶
  push:
    paths:
      - '**/fix.txt'
      - '**/fix.md'
      - '**/fixes/**'
      - '.github/workflows/auto-fix.yml'  # å·¥ä½œæµæ–‡ä»¶æœ¬èº«
      - '.github/workflows/*-fix.yml'     # æ‰€æœ‰ä¿®å¤ç›¸å…³çš„å·¥ä½œæµ
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šç”¨äºæµ‹è¯•æˆ–ç‰¹æ®Šæƒ…å†µ
  workflow_dispatch:
    inputs:
      force_run:
        description: 'å¼ºåˆ¶è¿è¡Œï¼ˆå³ä½¿æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼‰'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'è¯•è¿è¡Œï¼ˆåªæ˜¾ç¤ºè®¡åˆ’ï¼Œä¸å®é™…ä¿®æ”¹ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  auto-fix-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å¿…é¡»æœ‰å†™å…¥æƒé™æ‰èƒ½æ¨é€
    
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ” æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶
        id: find_fix
        run: |
          echo "=== æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶ ==="
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è§¦å‘åˆ†æ”¯: ${{ github.ref }}"
          
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å¼ºåˆ¶è¿è¡Œï¼Œå³ä½¿æ²¡æœ‰æ‰¾åˆ°ä¿®å¤æ–‡ä»¶ä¹Ÿç»§ç»­
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.force_run }}" == "true" ]]; then
            echo "âš ï¸  æ‰‹åŠ¨å¼ºåˆ¶è¿è¡Œæ¨¡å¼ï¼Œå³ä½¿æ²¡æœ‰ä¿®å¤æ–‡ä»¶ä¹Ÿç»§ç»­"
            echo "has_fix_file=true" >> $GITHUB_OUTPUT
            echo "identifier_count=0" >> $GITHUB_OUTPUT
            echo "script_fix_count=0" >> $GITHUB_OUTPUT
            echo "workflow_fix_count=0" >> $GITHUB_OUTPUT
            echo "fix_file=manual_trigger" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ä¿®å¤æ–‡ä»¶
          FIND_COMMAND="find . -type f \( -name 'fix.txt' -o -name 'fix.md' -o -path '*/fixes/*.txt' -o -path '*/fixes/*.md' \) -not -path './.git/*' | head -10"
          
          echo "æ‰§è¡ŒæŸ¥æ‰¾å‘½ä»¤: $FIND_COMMAND"
          FIX_FILES=$(eval $FIND_COMMAND 2>/dev/null || true)
          
          if [ -z "$FIX_FILES" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä¿®å¤æ–‡ä»¶"
            
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œå…è®¸ç»§ç»­ï¼ˆç”¨äºæµ‹è¯•å·¥ä½œæµï¼‰
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              echo "âš ï¸  æ‰‹åŠ¨è§¦å‘æ¨¡å¼ï¼šæœªæ‰¾åˆ°ä¿®å¤æ–‡ä»¶ï¼Œåˆ›å»ºæµ‹è¯•ä¿®å¤æ–‡ä»¶"
              echo "#ã€test.shã€‘" > test-fix.txt
              echo "# æµ‹è¯•ä¿®å¤å†…å®¹ - $(date)" >> test-fix.txt
              echo "#ã€endã€‘" >> test-fix.txt
              MAIN_FIX_FILE="test-fix.txt"
              echo "has_fix_file=true" >> $GITHUB_OUTPUT
              echo "identifier_count=1" >> $GITHUB_OUTPUT
              echo "script_fix_count=1" >> $GITHUB_OUTPUT
              echo "workflow_fix_count=0" >> $GITHUB_OUTPUT
              echo "fix_file=$MAIN_FIX_FILE" >> $GITHUB_OUTPUT
            else
              echo "has_fix_file=false" >> $GITHUB_OUTPUT
              echo "âŒ è‡ªåŠ¨è§¦å‘æ¨¡å¼ä¸‹å¿…é¡»æ‰¾åˆ°ä¿®å¤æ–‡ä»¶"
              exit 1
            fi
          else
            echo "âœ… æ‰¾åˆ°ä¿®å¤æ–‡ä»¶:"
            echo "$FIX_FILES"
            
            # å–ç¬¬ä¸€ä¸ªæ–‡ä»¶ä½œä¸ºä¿®å¤æ–‡ä»¶
            MAIN_FIX_FILE=$(echo "$FIX_FILES" | head -1)
            echo "ä¸»ä¿®å¤æ–‡ä»¶: $MAIN_FIX_FILE"
            
            # æå–ä¿®å¤æ ‡è¯†
            echo "=== åˆ†æä¿®å¤å†…å®¹ ==="
            IDENTIFIER_COUNT=$(grep -c "^#ã€" "$MAIN_FIX_FILE" 2>/dev/null || echo "0")
            SCRIPT_FIX_COUNT=$(grep -c "#ã€.*\.sh" "$MAIN_FIX_FILE" 2>/dev/null || echo "0")
            WORKFLOW_FIX_COUNT=$(grep -c "#ã€.*\.yml" "$MAIN_FIX_FILE" 2>/dev/null || echo "0")
            
            echo "ä¿®å¤æ ‡è¯†æ€»æ•°: $IDENTIFIER_COUNT"
            echo "è„šæœ¬ä¿®å¤æ•°é‡: $SCRIPT_FIX_COUNT"
            echo "å·¥ä½œæµä¿®å¤æ•°é‡: $WORKFLOW_FIX_COUNT"
            
            # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
            echo "fix_file=$MAIN_FIX_FILE" >> $GITHUB_OUTPUT
            echo "identifier_count=$IDENTIFIER_COUNT" >> $GITHUB_OUTPUT
            echo "script_fix_count=$SCRIPT_FIX_COUNT" >> $GITHUB_OUTPUT
            echo "workflow_fix_count=$WORKFLOW_FIX_COUNT" >> $GITHUB_OUTPUT
            echo "has_fix_file=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ› ï¸ åº”ç”¨ä¿®å¤ï¼ˆå®é™…é€»è¾‘ï¼‰
        id: apply_fixes
        run: |
          echo "=== åº”ç”¨ä¿®å¤ ==="
          FIX_FILE="${{ steps.find_fix.outputs.fix_file }}"
          DRY_RUN="${{ inputs.dry_run }}"
          
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "ğŸŸ¡ DRY RUN æ¨¡å¼ï¼šåªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’ï¼Œä¸å®é™…ä¿®æ”¹"
            MODE="dry-run"
          else
            echo "ğŸŸ¢ å®é™…ä¿®å¤æ¨¡å¼ï¼šå°†ä¿®æ”¹æ–‡ä»¶"
            MODE="actual"
          fi
          
          # ç”¨äºè®°å½•ä¿®æ”¹çš„æ–‡ä»¶
          MODIFIED_FILES=""
          
          # å¤„ç†è„šæœ¬æ–‡ä»¶ä¿®å¤
          if [ "${{ steps.find_fix.outputs.script_fix_count }}" != "0" ]; then
            echo "=== å¤„ç†è„šæœ¬ä¿®å¤ ==="
            
            # è¯»å–ä¿®å¤æ–‡ä»¶å†…å®¹
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ "$line" =~ ^#ã€([^ã€‘]+)ã€‘ ]]; then
                TARGET_FILE="${BASH_REMATCH[1]}"
                
                # åªå¤„ç†.shæ–‡ä»¶
                if [[ "$TARGET_FILE" == *.sh ]]; then
                  echo "ğŸ”§ æ‰¾åˆ°è„šæœ¬ä¿®å¤: $TARGET_FILE"
                  
                  # æŸ¥æ‰¾æ–‡ä»¶
                  if [ -f "$TARGET_FILE" ]; then
                    echo "âœ… æ–‡ä»¶å­˜åœ¨: $TARGET_FILE"
                  else
                    # å°è¯•åœ¨å¸¸è§ç›®å½•ä¸­æŸ¥æ‰¾
                    FOUND=false
                    for dir in "scripts/" "firmware-config/scripts/" "src/scripts/" ""; do
                      if [ -f "${dir}${TARGET_FILE}" ]; then
                        TARGET_FILE="${dir}${TARGET_FILE}"
                        echo "âœ… åœ¨ç›®å½•æ‰¾åˆ°: $TARGET_FILE"
                        FOUND=true
                        break
                      fi
                    done
                    
                    if [ "$FOUND" = false ]; then
                      echo "âš ï¸  æ–‡ä»¶æœªæ‰¾åˆ°: $TARGET_FILEï¼Œè·³è¿‡"
                      continue
                    fi
                  fi
                  
                  # åˆ›å»ºå¤‡ä»½
                  BACKUP_FILE="${TARGET_FILE}.backup.$(date +%s)"
                  if [[ "$DRY_RUN" != "true" ]]; then
                    cp "$TARGET_FILE" "$BACKUP_FILE"
                    echo "ğŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
                  else
                    echo "ğŸ“¦ [DRY RUN] å°†åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
                  fi
                  
                  # æå–ä¿®å¤å†…å®¹
                  echo "ğŸ“ æå–ä¿®å¤å†…å®¹..."
                  
                  # è¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„å®é™…ä¿®å¤æ ¼å¼æ¥å®ç°
                  # ç¤ºä¾‹ï¼šè¯»å–ç›´åˆ°ä¸‹ä¸€ä¸ª#ã€æˆ–æ–‡ä»¶ç»“æŸ
                  # å®é™…å®ç°å–å†³äºä½ çš„ fix.txt æ ¼å¼
                  
                  if [[ "$DRY_RUN" != "true" ]]; then
                    # ç¤ºä¾‹ï¼šç®€å•åœ°åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä¿®å¤æ ‡è®°
                    echo "" >> "$TARGET_FILE"
                    echo "# è‡ªåŠ¨ä¿®å¤äº $(date)" >> "$TARGET_FILE"
                    echo "# æ¥æº: $FIX_FILE" >> "$TARGET_FILE"
                    
                    MODIFIED_FILES="${MODIFIED_FILES}$TARGET_FILE,"
                    echo "âœ… å·²ä¿®æ”¹: $TARGET_FILE"
                  else
                    echo "ğŸ“‹ [DRY RUN] å°†ä¿®æ”¹: $TARGET_FILE"
                  fi
                fi
              fi
            done < "$FIX_FILE"
          fi
          
          # å¤„ç†å·¥ä½œæµæ–‡ä»¶ä¿®å¤
          if [ "${{ steps.find_fix.outputs.workflow_fix_count }}" != "0" ]; then
            echo "=== å¤„ç†å·¥ä½œæµä¿®å¤ ==="
            
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ "$line" =~ ^#ã€([^ã€‘]+)ã€‘ ]]; then
                TARGET_FILE="${BASH_REMATCH[1]}"
                
                # åªå¤„ç†.ymlæ–‡ä»¶
                if [[ "$TARGET_FILE" == *.yml ]]; then
                  echo "ğŸ”§ æ‰¾åˆ°å·¥ä½œæµä¿®å¤: $TARGET_FILE"
                  
                  # æŸ¥æ‰¾æ–‡ä»¶ï¼ˆå·¥ä½œæµé€šå¸¸åœ¨.github/workflows/ï¼‰
                  if [ -f "$TARGET_FILE" ]; then
                    echo "âœ… æ–‡ä»¶å­˜åœ¨: $TARGET_FILE"
                  elif [ -f ".github/workflows/$TARGET_FILE" ]; then
                    TARGET_FILE=".github/workflows/$TARGET_FILE"
                    echo "âœ… åœ¨å·¥ä½œæµç›®å½•æ‰¾åˆ°: $TARGET_FILE"
                  elif [ -f "workflows/$TARGET_FILE" ]; then
                    TARGET_FILE="workflows/$TARGET_FILE"
                    echo "âœ… åœ¨å·¥ä½œæµç›®å½•æ‰¾åˆ°: $TARGET_FILE"
                  else
                    echo "âš ï¸  æ–‡ä»¶æœªæ‰¾åˆ°: $TARGET_FILEï¼Œè·³è¿‡"
                    continue
                  fi
                  
                  # åˆ›å»ºå¤‡ä»½
                  BACKUP_FILE="${TARGET_FILE}.backup.$(date +%s)"
                  if [[ "$DRY_RUN" != "true" ]]; then
                    cp "$TARGET_FILE" "$BACKUP_FILE"
                    echo "ğŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
                  else
                    echo "ğŸ“¦ [DRY RUN] å°†åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
                  fi
                  
                  if [[ "$DRY_RUN" != "true" ]]; then
                    # ç¤ºä¾‹ï¼šç®€å•ä¿®æ”¹
                    echo "" >> "$TARGET_FILE"
                    echo "# è‡ªåŠ¨ä¿®å¤äº $(date)" >> "$TARGET_FILE"
                    
                    MODIFIED_FILES="${MODIFIED_FILES}$TARGET_FILE,"
                    echo "âœ… å·²ä¿®æ”¹: $TARGET_FILE"
                  else
                    echo "ğŸ“‹ [DRY RUN] å°†ä¿®æ”¹: $TARGET_FILE"
                  fi
                fi
              fi
            done < "$FIX_FILE"
          fi
          
          # è¾“å‡ºä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
          if [ -n "$MODIFIED_FILES" ]; then
            echo "modified_files=${MODIFIED_FILES%,}" >> $GITHUB_OUTPUT
          else
            echo "modified_files=none" >> $GITHUB_OUTPUT
          fi
          
          echo "âœ… ä¿®å¤å¤„ç†å®Œæˆ"
          echo "æ¨¡å¼: $MODE"
      
      - name: ğŸ’¾ è‡ªåŠ¨æäº¤æ›´æ”¹
        id: commit_changes
        if: steps.apply_fixes.outputs.modified_files != 'none' && inputs.dry_run == false
        run: |
          echo "=== è‡ªåŠ¨æäº¤æ›´æ”¹ ==="
          
          # é…ç½®Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          # æ˜¾ç¤ºçŠ¶æ€
          echo "ğŸ“Š GitçŠ¶æ€:"
          git status --short
          
          # è·å–ä¿®æ”¹çš„æ–‡ä»¶
          MODIFIED_FILES="${{ steps.apply_fixes.outputs.modified_files }}"
          
          if [ -z "$MODIFIED_FILES" ] || [ "$MODIFIED_FILES" == "none" ]; then
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–°å¢æ–‡ä»¶
            if [ -n "$(git ls-files --others --exclude-standard)" ]; then
              echo "ğŸ“ å‘ç°æœªè·Ÿè¸ªæ–‡ä»¶ï¼Œå‡†å¤‡æ·»åŠ "
              NEW_FILES=$(git ls-files --others --exclude-standard | tr '\n' ' ')
              git add $NEW_FILES
              git commit -m "ğŸ”§ è‡ªåŠ¨ä¿®å¤: æ·»åŠ æ–°æ–‡ä»¶ [skip ci]"
              git push
              echo "âœ… æ–°æ–‡ä»¶å·²æäº¤: $NEW_FILES"
            else
              echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„å†…å®¹"
            fi
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
            echo "ä¿®æ”¹çš„æ–‡ä»¶: $MODIFIED_FILES"
            
            # æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶
            IFS=',' read -ra FILES <<< "$MODIFIED_FILES"
            for file in "${FILES[@]}"; do
              if [ -f "$file" ]; then
                echo "â• æ·»åŠ : $file"
                git add "$file"
              fi
            done
            
            # æäº¤ä¿¡æ¯
            COMMIT_MSG="ğŸ”§ è‡ªåŠ¨ä¿®å¤: "
            
            if [ "${{ steps.find_fix.outputs.script_fix_count }}" != "0" ]; then
              COMMIT_MSG="${COMMIT_MSG}è„šæœ¬ä¿®å¤"
            fi
            
            if [ "${{ steps.find_fix.outputs.workflow_fix_count }}" != "0" ]; then
              if [ "${{ steps.find_fix.outputs.script_fix_count }}" != "0" ]; then
                COMMIT_MSG="${COMMIT_MSG} + "
              fi
              COMMIT_MSG="${COMMIT_MSG}å·¥ä½œæµä¿®å¤"
            fi
            
            COMMIT_MSG="${COMMIT_MSG} [skip ci]"
            
            # æäº¤
            git commit -m "$COMMIT_MSG"
            
            # æ¨é€
            echo "ğŸš€ æ¨é€æ›´æ”¹åˆ°ä»“åº“..."
            git push origin HEAD:${{ github.ref_name }}
            
            echo "âœ… æ›´æ”¹å·²è‡ªåŠ¨æäº¤å¹¶æ¨é€"
            echo "ğŸ“‹ æäº¤ä¿¡æ¯: $COMMIT_MSG"
            echo "ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${{ github.ref_name }}"
          fi
      
      - name: ğŸ“‹ ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "### ğŸ‰ å…¨è‡ªåŠ¨ä¿®å¤ç³»ç»ŸæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ğŸ“… æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ¯ è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ğŸ“Š ä¿®å¤åˆ†æ:**" >> $GITHUB_STEP_SUMMARY
          echo "- ä¿®å¤æ–‡ä»¶: ${{ steps.find_fix.outputs.fix_file }}" >> $GITHUB_STEP_SUMMARY
          echo "- ä¿®å¤æ ‡è¯†æ€»æ•°: ${{ steps.find_fix.outputs.identifier_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- è„šæœ¬ä¿®å¤æ•°é‡: ${{ steps.find_fix.outputs.script_fix_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- å·¥ä½œæµä¿®å¤æ•°é‡: ${{ steps.find_fix.outputs.workflow_fix_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºæ¨¡å¼
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "**ğŸ”§ æ“ä½œæ¨¡å¼:** ğŸŸ¡ DRY RUN (è¯•è¿è¡Œ)" >> $GITHUB_STEP_SUMMARY
            echo "> åªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’ï¼Œä¸å®é™…ä¿®æ”¹æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          else
            echo "**ğŸ”§ æ“ä½œæ¨¡å¼:** ğŸŸ¢ å®é™…ä¿®å¤" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºä¿®æ”¹çš„æ–‡ä»¶
          echo "**ğŸ“ æ–‡ä»¶ä¿®æ”¹:**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.apply_fixes.outputs.modified_files }}" != "none" ]]; then
            IFS=',' read -ra FILES <<< "${{ steps.apply_fixes.outputs.modified_files }}"
            for file in "${FILES[@]}"; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- æ— æ–‡ä»¶è¢«ä¿®æ”¹" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æäº¤çŠ¶æ€
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "**ğŸ“¤ æäº¤çŠ¶æ€:** è¯•è¿è¡Œæ¨¡å¼ï¼Œæ— æäº¤" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.commit_changes.outcome }}" == "skipped" ]]; then
            echo "**ğŸ“¤ æäº¤çŠ¶æ€:** æ— ä¿®æ”¹æˆ–ä¸éœ€è¦æäº¤" >> $GITHUB_STEP_SUMMARY
          else
            echo "**ğŸ“¤ æäº¤çŠ¶æ€:** âœ… å·²è‡ªåŠ¨æäº¤å¹¶æ¨é€" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**â° ä¸‹æ¬¡è¿è¡Œ:**" >> $GITHUB_STEP_SUMMARY
          echo "1. è‡ªåŠ¨: ä¿®æ”¹ä»»ä½•ä¿®å¤æ–‡ä»¶æˆ–å·¥ä½œæµæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "2. æ‰‹åŠ¨: åœ¨ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘" >> $GITHUB_STEP_SUMMARY
