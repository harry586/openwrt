# firmware-build-fix.yml
name: ğŸ”§ è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ

on:
  push:
    paths:
      - 'fix.txt'
  
  workflow_dispatch:

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ” æ£€æŸ¥ä¿®å¤æ–‡ä»¶
        run: |
          echo "=== æ£€æŸ¥ä¿®å¤æ–‡ä»¶ ==="
          
          if [ ! -f "fix.txt" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä¿®å¤æ–‡ä»¶ fix.txt"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°ä¿®å¤æ–‡ä»¶ fix.txt"
          echo "ä¿®å¤æ–‡ä»¶å¤§å°: $(wc -l < fix.txt) è¡Œ"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç³»ç»Ÿæ€§æ ‡è¯†
          if grep -q "#ã€" fix.txt; then
            echo "ğŸ”§ æ£€æµ‹åˆ°ç³»ç»Ÿæ€§æ ‡è¯†"
            echo "æ‰¾åˆ°çš„æ ‡è¯†:"
            grep -o "#ã€[^ã€‘]*ã€‘" fix.txt
          else
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°ç³»ç»Ÿæ€§æ ‡è¯†"
          fi
      
      - name: ğŸ“ è§£æå¹¶åº”ç”¨ä¿®å¤
        run: |
          echo "=== è§£æå¹¶åº”ç”¨ä¿®å¤ ==="
          
          # 1. æŸ¥æ‰¾ç›®æ ‡æ–‡ä»¶
          TARGET_FILE=""
          
          # é¦–å…ˆå°è¯•åœ¨å¸¸è§ä½ç½®æŸ¥æ‰¾ build_firmware_main.sh
          if [ -f "firmware-config/scripts/build_firmware_main.sh" ]; then
            TARGET_FILE="firmware-config/scripts/build_firmware_main.sh"
          elif [ -f "scripts/build_firmware_main.sh" ]; then
            TARGET_FILE="scripts/build_firmware_main.sh"
          elif [ -f "build_firmware_main.sh" ]; then
            TARGET_FILE="build_firmware_main.sh"
          else
            # ä½¿ç”¨findå‘½ä»¤æœç´¢
            echo "ğŸ” å¼€å§‹å…¨ç›®å½•æœç´¢ build_firmware_main.sh..."
            TARGET_FILE=$(find . -name "build_firmware_main.sh" -type f ! -path "./.git/*" | head -1)
          fi
          
          if [ -z "$TARGET_FILE" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° build_firmware_main.sh æ–‡ä»¶"
            echo "è¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨äºä»¥ä¸‹ä½ç½®ä¹‹ä¸€:"
            echo "- firmware-config/scripts/build_firmware_main.sh"
            echo "- scripts/build_firmware_main.sh" 
            echo "- build_firmware_main.sh"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
          
          # 2. å¤‡ä»½åŸæ–‡ä»¶ï¼ˆä»…ä¿ç•™åœ¨ä¸´æ—¶ç›®å½•ï¼Œä¸æäº¤ï¼‰
          BACKUP_FILE="/tmp/$(basename "$TARGET_FILE").backup.$(date +%Y%m%d_%H%M%S)"
          cp "$TARGET_FILE" "$BACKUP_FILE"
          echo "âœ… å·²åœ¨ä¸´æ—¶ç›®å½•å¤‡ä»½åŸæ–‡ä»¶: $BACKUP_FILE"
          
          # 3. è¯»å–ä¿®å¤å†…å®¹
          echo "ğŸ“– è¯»å–ä¿®å¤å†…å®¹..."
          FIX_CONTENT=$(cat fix.txt)
          
          # 4. æå–æ‰€æœ‰ç³»ç»Ÿæ€§æ ‡è¯†åŠå…¶å¯¹åº”çš„å†…å®¹å—
          echo "ğŸ”§ å¼€å§‹è§£æç³»ç»Ÿæ€§æ ‡è¯†..."
          
          # æŸ¥æ‰¾æ‰€æœ‰ç³»ç»Ÿæ€§æ ‡è¯†è¡Œå·
          IDENTIFIER_LINES=$(grep -n "#ã€" fix.txt || true)
          
          if [ -z "$IDENTIFIER_LINES" ]; then
            echo "âš ï¸ ä¿®å¤æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ç³»ç»Ÿæ€§æ ‡è¯†"
            echo "ğŸ’¡ å°è¯•å°†æ•´ä¸ªæ–‡ä»¶è¿½åŠ åˆ°ç›®æ ‡æ–‡ä»¶æœ«å°¾"
            echo "" >> "$TARGET_FILE"
            echo "# ============ è‡ªåŠ¨ä¿®å¤å†…å®¹ ============" >> "$TARGET_FILE"
            echo "# ä¿®å¤æ—¶é—´: $(date)" >> "$TARGET_FILE"
            echo "# æ¥æº: fix.txt" >> "$TARGET_FILE"
            cat fix.txt >> "$TARGET_FILE"
            echo "# ============ ä¿®å¤ç»“æŸ ============" >> "$TARGET_FILE"
            echo "âœ… å·²å°†æ•´ä¸ªä¿®å¤æ–‡ä»¶è¿½åŠ åˆ°ç›®æ ‡æ–‡ä»¶"
            exit 0
          fi
          
          echo "ğŸ“‹ æ‰¾åˆ°çš„ç³»ç»Ÿæ€§æ ‡è¯†:"
          echo "$IDENTIFIER_LINES"
          
          # å¤„ç†æ¯ä¸ªç³»ç»Ÿæ€§æ ‡è¯†
          TOTAL_FIX_LINES=$(wc -l < fix.txt)
          
          # å°†æ ‡è¯†è¡Œå·è½¬æ¢ä¸ºæ•°ç»„
          IFS=$'\n' read -d '' -r -a IDENTIFIER_ARRAY <<< "$IDENTIFIER_LINES"
          
          for i in "${!IDENTIFIER_ARRAY[@]}"; do
            CURRENT_LINE_INFO="${IDENTIFIER_ARRAY[$i]}"
            LINE_NUM=$(echo "$CURRENT_LINE_INFO" | cut -d: -f1)
            IDENTIFIER=$(echo "$CURRENT_LINE_INFO" | cut -d: -f2- | sed 's/^[[:space:]]*//')
            
            echo "ğŸ”¨ å¤„ç†æ ‡è¯†: $IDENTIFIER (ç¬¬ $LINE_NUM è¡Œ)"
            
            # æå–æ ‡è¯†åç§°ï¼ˆå»æ‰ #ã€ã€‘ï¼‰
            ID_NAME=$(echo "$IDENTIFIER" | sed 's/#ã€//' | sed 's/ã€‘//')
            
            # æå–è¯¥æ ‡è¯†å¯¹åº”çš„å†…å®¹å—èŒƒå›´
            BLOCK_START=$LINE_NUM
            
            # ç¡®å®šå†…å®¹å—ç»“æŸä½ç½®ï¼ˆä¸‹ä¸€ä¸ªæ ‡è¯†çš„å¼€å§‹ï¼Œæˆ–è€…æ–‡ä»¶ç»“æŸï¼‰
            if [ $((i + 1)) -lt ${#IDENTIFIER_ARRAY[@]} ]; then
              # æœ‰ä¸‹ä¸€ä¸ªæ ‡è¯†
              NEXT_LINE_INFO="${IDENTIFIER_ARRAY[$((i + 1))]}"
              NEXT_LINE_NUM=$(echo "$NEXT_LINE_INFO" | cut -d: -f1)
              BLOCK_END=$((NEXT_LINE_NUM - 1))
            else
              # æœ€åä¸€ä¸ªæ ‡è¯†ï¼Œåˆ°æ–‡ä»¶ç»“æŸ
              BLOCK_END=$TOTAL_FIX_LINES
            fi
            
            echo "ğŸ“Œ å†…å®¹å—èŒƒå›´: ç¬¬ $BLOCK_START è¡Œåˆ°ç¬¬ $BLOCK_END è¡Œ"
            
            # æå–æ•´ä¸ªå†…å®¹å—ï¼ˆåŒ…å«æ ‡è¯†è¡Œï¼‰
            BLOCK_CONTENT=$(sed -n "${BLOCK_START},${BLOCK_END}p" fix.txt)
            
            # åœ¨ç›®æ ‡æ–‡ä»¶ä¸­æŸ¥æ‰¾è¯¥æ ‡è¯†
            echo "ğŸ” åœ¨ç›®æ ‡æ–‡ä»¶ä¸­æŸ¥æ‰¾æ ‡è¯†: $IDENTIFIER"
            
            # æœç´¢æ ‡è¯†ï¼Œæ”¯æŒæ ‡è¯†è¡Œå‰åå¯èƒ½æœ‰ç©ºæ ¼çš„æƒ…å†µ
            TARGET_LINE_NUM=$(grep -n "^\s*${IDENTIFIER}" "$TARGET_FILE" | head -1 | cut -d: -f1)
            
            if [ -n "$TARGET_LINE_NUM" ]; then
              echo "âœ… åœ¨ç›®æ ‡æ–‡ä»¶ç¬¬ $TARGET_LINE_NUM è¡Œæ‰¾åˆ°æ ‡è¯†"
              
              # åœ¨ç›®æ ‡æ–‡ä»¶ä¸­æ‰¾åˆ°æ ‡è¯†å¯¹åº”çš„å†…å®¹å—èŒƒå›´
              TARGET_TOTAL_LINES=$(wc -l < "$TARGET_FILE")
              TARGET_BLOCK_START=$TARGET_LINE_NUM
              TARGET_BLOCK_END=""
              
              # ä»æ ‡è¯†è¡Œå¼€å§‹æŸ¥æ‰¾ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªæ ‡è¯†æˆ–æ–‡ä»¶ç»“æŸ
              CURRENT_SEARCH=$((TARGET_LINE_NUM + 1))
              
              while [ $CURRENT_SEARCH -le $TARGET_TOTAL_LINES ]; do
                LINE_CONTENT=$(sed -n "${CURRENT_SEARCH}p" "$TARGET_FILE")
                
                # å¦‚æœé‡åˆ°ä¸‹ä¸€ä¸ªç³»ç»Ÿæ€§æ ‡è¯†ï¼ˆä»¥ #ã€ å¼€å¤´ï¼‰
                if [[ "$LINE_CONTENT" =~ ^[[:space:]]*#ã€ ]]; then
                  TARGET_BLOCK_END=$((CURRENT_SEARCH - 1))
                  break
                fi
                
                # å¦‚æœåˆ°è¾¾æ–‡ä»¶æœ«å°¾
                if [ $CURRENT_SEARCH -eq $TARGET_TOTAL_LINES ]; then
                  TARGET_BLOCK_END=$CURRENT_SEARCH
                  break
                fi
                
                ((CURRENT_SEARCH++))
              done
              
              if [ -z "$TARGET_BLOCK_END" ]; then
                TARGET_BLOCK_END=$TARGET_TOTAL_LINES
              fi
              
              echo "ğŸ“Œ ç›®æ ‡æ–‡ä»¶ä¸­åŸå†…å®¹å—èŒƒå›´: ç¬¬ $TARGET_BLOCK_START è¡Œåˆ°ç¬¬ $TARGET_BLOCK_END è¡Œ"
              
              # åˆ›å»ºä¸´æ—¶æ–‡ä»¶è¿›è¡Œæ›¿æ¢
              TEMP_FILE="/tmp/$(basename "$TARGET_FILE").temp.$$"
              
              # æ›¿æ¢å†…å®¹å—ï¼šåŸæ–‡ä»¶å‰éƒ¨åˆ† + æ–°å†…å®¹å— + åŸæ–‡ä»¶åéƒ¨åˆ†
              head -n $((TARGET_BLOCK_START - 1)) "$TARGET_FILE" > "$TEMP_FILE"
              echo "$BLOCK_CONTENT" >> "$TEMP_FILE"
              tail -n +$((TARGET_BLOCK_END + 1)) "$TARGET_FILE" >> "$TEMP_FILE"
              
              # éªŒè¯æ›¿æ¢ç»“æœ
              if [ $(wc -l < "$TEMP_FILE") -gt 10 ]; then
                mv "$TEMP_FILE" "$TARGET_FILE"
                echo "âœ… å†…å®¹å—æ›¿æ¢æˆåŠŸ (æ ‡è¯†: $ID_NAME)"
              else
                echo "âš ï¸ æ›¿æ¢åæ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æœ‰é”™è¯¯ï¼Œè·³è¿‡æ­¤å†…å®¹å—"
                rm -f "$TEMP_FILE"
              fi
              
            else
              echo "âš ï¸ åœ¨ç›®æ ‡æ–‡ä»¶ä¸­æœªæ‰¾åˆ°æ ‡è¯† $IDENTIFIER"
              echo "ğŸ’¡ å°è¯•è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾"
              
              # æ£€æŸ¥æ˜¯å¦æ•´ä¸ªæ–‡ä»¶è¿½åŠ è¿‡
              if ! tail -n 5 "$TARGET_FILE" | grep -q "# ============ è‡ªåŠ¨ä¿®å¤å†…å®¹ ============"; then
                echo "" >> "$TARGET_FILE"
                echo "# ============ è‡ªåŠ¨ä¿®å¤å†…å®¹ ============" >> "$TARGET_FILE"
                echo "# ä¿®å¤æ—¶é—´: $(date)" >> "$TARGET_FILE"
                echo "# æ¥æº: fix.txt" >> "$TARGET_FILE"
              fi
              
              echo "$BLOCK_CONTENT" >> "$TARGET_FILE"
              echo "âœ… å†…å®¹å—å·²è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ (æ ‡è¯†: $ID_NAME)"
            fi
            
            echo "---"
          done
          
          # å¦‚æœæ–‡ä»¶æœ«å°¾æœ‰è‡ªåŠ¨ä¿®å¤æ ‡è®°ï¼Œæ·»åŠ ç»“æŸæ ‡è®°
          if tail -n 1 "$TARGET_FILE" | grep -q "#ã€"; then
            echo "" >> "$TARGET_FILE"
            echo "# ============ ä¿®å¤ç»“æŸ ============" >> "$TARGET_FILE"
          fi
          
          echo "âœ… æ‰€æœ‰ä¿®å¤å¤„ç†å®Œæˆ"
      
      - name: ğŸ“¤ æäº¤å¹¶æ¨é€ä¿®æ”¹
        run: |
          echo "=== æäº¤å¹¶æ¨é€ä¿®æ”¹ ==="
          
          # é…ç½®Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet; then
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹"
            echo "ğŸ’¡ å·²åº”ç”¨ä¿®å¤ä½†æ–‡ä»¶å†…å®¹æ— å˜åŒ–ï¼Œä»…æ¸…ç†ä¿®å¤æ–‡ä»¶"
          else
            echo "ğŸ’¾ æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹ï¼Œå‡†å¤‡æäº¤..."
            
            # æ˜¾ç¤ºæ›´æ”¹çš„æ–‡ä»¶
            echo "ğŸ“‹ æ›´æ”¹çš„æ–‡ä»¶:"
            git status --short
            
            # æ·»åŠ æ›´æ”¹
            git add -A
          fi
          
          # æäº¤
          COMMIT_MSG="ğŸ”§ è‡ªåŠ¨ä¿®å¤"
          COMMIT_MSG+="\n\næ¥æº: fix.txt"
          COMMIT_MSG+="\næ—¶é—´: $(date)"
          COMMIT_MSG+="\näº‹ä»¶: ${{ github.event_name }}"
          
          # æ·»åŠ ä¿®å¤çš„æ ‡è¯†åˆ—è¡¨
          if [ -f "fix.txt" ] && grep -q "#ã€" fix.txt; then
            COMMIT_MSG+="\n\nä¿®å¤çš„å†…å®¹å—:"
            grep "#ã€" fix.txt | while IFS= read -r identifier; do
              ID_NAME=$(echo "$identifier" | sed 's/#ã€//' | sed 's/ã€‘//')
              COMMIT_MSG+="\n- $ID_NAME"
            done
          fi
          
          echo -e "$COMMIT_MSG" | git commit -F - || echo "âš ï¸ æäº¤å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰æ›´æ”¹"
          
          # æ¨é€
          echo "ğŸš€ æ¨é€åˆ°ä¸»åˆ†æ”¯..."
          git push origin HEAD:main
          
          echo "âœ… ä¿®å¤å·²åº”ç”¨å¹¶æ¨é€åˆ°ä¸»åˆ†æ”¯"
          
          # æ¸…ç†fix.txtæ–‡ä»¶ï¼ˆæ— è®ºæ˜¯å¦æœ‰æ›´æ”¹éƒ½æ‰§è¡Œï¼‰
          echo "ğŸ§¹ æ¸…ç†fix.txtæ–‡ä»¶..."
          > fix.txt
          git add fix.txt
          git commit -m "ğŸ§¹ æ¸…ç†ä¿®å¤æ–‡ä»¶ [skip ci]" || true
          git push origin HEAD:main
      
      - name: ğŸ“‹ ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "### ğŸ”§ è‡ªåŠ¨ä¿®å¤å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "**çŠ¶æ€:** âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "**çŠ¶æ€:** âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**æ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºä¿®å¤çš„æ ‡è¯†ä¿¡æ¯
          if [ -f "fix.txt" ] && grep -q "#ã€" fix.txt; then
            echo "**ä¿®å¤çš„å†…å®¹å—:**" >> $GITHUB_STEP_SUMMARY
            grep "#ã€" fix.txt | while IFS= read -r identifier; do
              ID_NAME=$(echo "$identifier" | sed 's/#ã€//' | sed 's/ã€‘//')
              echo "- $ID_NAME" >> $GITHUB_STEP_SUMMARY
            done
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å¤„ç†æµç¨‹:**" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… æ£€æŸ¥ä¿®å¤æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… è§£æç³»ç»Ÿæ€§æ ‡è¯†" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… æŸ¥æ‰¾å¹¶æ›¿æ¢å†…å®¹å—" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… æäº¤å¹¶æ¨é€æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
          echo "5. âœ… æ¸…ç†ä¿®å¤æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
