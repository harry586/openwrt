# firmware-build-fix.yml
name: ðŸ”§ è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ

on:
  push:
    paths:
      - '**/fix.txt'  # åŒ¹é…ä»»æ„ä½ç½®çš„fix.txt
      - 'fix.txt'     # æ ¹ç›®å½•çš„fix.txt
  
  workflow_dispatch:
    inputs:
      fix_file_path:
        description: 'ä¿®å¤æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤æœç´¢fix.txtï¼‰'
        required: false
        default: ''

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ðŸ›Žï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ” æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶
        run: |
          echo "=== æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶ ==="
          
          # ç¡®å®šè¦æŸ¥æ‰¾çš„æ–‡ä»¶è·¯å¾„
          if [ -n "${{ github.event.inputs.fix_file_path }}" ]; then
            # ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„è·¯å¾„
            FIX_FILE="${{ github.event.inputs.fix_file_path }}"
            echo "ðŸ“ ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          else
            # æœç´¢æ‰€æœ‰fix.txtæ–‡ä»¶
            echo "ðŸ” æœç´¢ä¿®å¤æ–‡ä»¶..."
            FIX_FILES=$(find . -name "fix.txt" -type f | grep -v ".git" | head -5)
            
            if [ -z "$FIX_FILES" ]; then
              echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•fix.txtæ–‡ä»¶"
              exit 1
            fi
            
            # é€‰æ‹©ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶ï¼ˆå¯ä»¥æŒ‰éœ€è°ƒæ•´ç­–ç•¥ï¼‰
            FIX_FILE=$(echo "$FIX_FILES" | head -1)
            echo "ðŸ“ æ‰¾åˆ°ä¿®å¤æ–‡ä»¶: $FIX_FILE"
            
            if [ $(echo "$FIX_FILES" | wc -l) -gt 1 ]; then
              echo "âš ï¸  æ‰¾åˆ°å¤šä¸ªä¿®å¤æ–‡ä»¶ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª: $FIX_FILE"
              echo "å…¶ä»–æ–‡ä»¶:"
              echo "$FIX_FILES" | tail -n +2 | while IFS= read -r file; do
                echo "  - $file"
              done
            fi
          fi
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$FIX_FILE" ]; then
            echo "âŒ ä¿®å¤æ–‡ä»¶ä¸å­˜åœ¨: $FIX_FILE"
            exit 1
          fi
          
          echo "âœ… ä½¿ç”¨ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          echo "æ–‡ä»¶è·¯å¾„: $(realpath "$FIX_FILE")"
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "FIX_FILE_PATH=$FIX_FILE" >> $GITHUB_ENV
      
      - name: ðŸ“ åº”ç”¨ä¿®å¤å¹¶æŽ¨é€
        env:
          FIX_FILE: ${{ env.FIX_FILE_PATH }}
        run: |
          echo "=== åº”ç”¨ä¿®å¤å¹¶æŽ¨é€ ==="
          echo "ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          
          # 1. è¯»å–ä¿®å¤æŒ‡ä»¤
          echo "ðŸ“– è¯»å–ä¿®å¤æŒ‡ä»¤..."
          FIX_CONTENT=$(cat "$FIX_FILE")
          
          if [ -z "$FIX_CONTENT" ]; then
            echo "âš ï¸ ä¿®å¤æ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡ä¿®å¤"
            
            # é…ç½®Git
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "GitHub Actions"
            
            # æ¸…ç©ºä¿®å¤æ–‡ä»¶
            > "$FIX_FILE"
            git add "$FIX_FILE"
            git commit -m "ðŸ§¹ æ¸…ç†ç©ºä¿®å¤æ–‡ä»¶ [skip ci]" || true
            git push origin HEAD:main
            exit 0
          fi
          
          # 2. è§£æžä¿®å¤æŒ‡ä»¤ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
          echo "ðŸ”§ è§£æžä¿®å¤æŒ‡ä»¤..."
          
          # å­˜å‚¨ä¿®æ”¹è¿‡çš„æ–‡ä»¶åˆ—è¡¨
          MODIFIED_FILES=""
          
          # é€è¡Œå¤„ç†ä¿®å¤æŒ‡ä»¤
          LINE_NUM=0
          while IFS= read -r LINE || [ -n "$LINE" ]; do
            ((LINE_NUM++))
            
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            [[ -z "$LINE" ]] && continue
            [[ "$LINE" =~ ^[[:space:]]*# ]] && continue
            
            echo "  æŒ‡ä»¤ $LINE_NUM: $LINE"
            
            # æ”¯æŒçš„å‘½ä»¤æ ¼å¼:
            # file:path/to/file => è¦ä¿®æ”¹çš„æ–‡ä»¶
            # replace:pattern=>replacement => æ–‡æœ¬æ›¿æ¢
            # append:path/to/file => è¿½åŠ å†…å®¹
            # delete:path/to/file => åˆ é™¤æ–‡ä»¶
            # create:path/to/file content... => åˆ›å»ºæ–‡ä»¶
            
            if [[ "$LINE" =~ ^file:[[:space:]]*(.+) ]]; then
              # è®¾ç½®å½“å‰æ“ä½œçš„æ–‡ä»¶
              CURRENT_FILE="${BASH_REMATCH[1]}"
              echo "    ç›®æ ‡æ–‡ä»¶: $CURRENT_FILE"
              
            elif [[ "$LINE" =~ ^replace:[[:space:]]*(.+)[[:space:]]*=>[[:space:]]*(.+) ]] && [ -n "$CURRENT_FILE" ]; then
              # æ–‡æœ¬æ›¿æ¢
              PATTERN="${BASH_REMATCH[1]}"
              REPLACEMENT="${BASH_REMATCH[2]}"
              
              if [ -f "$CURRENT_FILE" ]; then
                echo "    æ›¿æ¢: '$PATTERN' => '$REPLACEMENT'"
                # ç›´æŽ¥æ›¿æ¢ï¼Œä¸ç”Ÿæˆä¸´æ—¶æ–‡ä»¶
                sed -i "s|$PATTERN|$REPLACEMENT|g" "$CURRENT_FILE"
                
                # è®°å½•ä¿®æ”¹
                if [[ ! " $MODIFIED_FILES " =~ " $CURRENT_FILE " ]]; then
                  MODIFIED_FILES="$MODIFIED_FILES $CURRENT_FILE"
                fi
              else
                echo "    âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $CURRENT_FILE"
              fi
              
            elif [[ "$LINE" =~ ^append:[[:space:]]*(.+) ]] && [ -n "$CURRENT_FILE" ]; then
              # è¿½åŠ å†…å®¹ï¼ˆä¸‹ä¸€è¡Œå¼€å§‹çš„å†…å®¹ï¼‰
              if [ -f "$CURRENT_FILE" ]; then
                echo "    è¿½åŠ å†…å®¹åˆ°: $CURRENT_FILE"
                # è¯»å–åŽç»­è¡Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªå‘½ä»¤
                APPEND_CONTENT=""
                while IFS= read -r NEXT_LINE || [ -n "$NEXT_LINE" ]; do
                  [[ "$NEXT_LINE" =~ ^[a-z]+: ]] && break
                  APPEND_CONTENT="${APPEND_CONTENT}${NEXT_LINE}"$'\n'
                done
                
                echo "$APPEND_CONTENT" >> "$CURRENT_FILE"
                
                if [[ ! " $MODIFIED_FILES " =~ " $CURRENT_FILE " ]]; then
                  MODIFIED_FILES="$MODIFIED_FILES $CURRENT_FILE"
                fi
              fi
              
            elif [[ "$LINE" =~ ^create:[[:space:]]*(.+) ]]; then
              # åˆ›å»ºæ–‡ä»¶
              CREATE_FILE="${BASH_REMATCH[1]}"
              echo "    åˆ›å»ºæ–‡ä»¶: $CREATE_FILE"
              
              # è¯»å–æ–‡ä»¶å†…å®¹ï¼ˆç›´åˆ°ä¸‹ä¸€ä¸ªå‘½ä»¤ï¼‰
              FILE_CONTENT=""
              while IFS= read -r NEXT_LINE || [ -n "$NEXT_LINE" ]; do
                [[ "$NEXT_LINE" =~ ^[a-z]+: ]] && break
                FILE_CONTENT="${FILE_CONTENT}${NEXT_LINE}"$'\n'
              done
              
              # åˆ›å»ºç›®å½•
              mkdir -p "$(dirname "$CREATE_FILE")"
              echo -n "$FILE_CONTENT" > "$CREATE_FILE"
              
              if [[ ! " $MODIFIED_FILES " =~ " $CREATE_FILE " ]]; then
                MODIFIED_FILES="$MODIFIED_FILES $CREATE_FILE"
              fi
              
            elif [[ "$LINE" =~ ^delete:[[:space:]]*(.+) ]]; then
              # åˆ é™¤æ–‡ä»¶
              DELETE_FILE="${BASH_REMATCH[1]}"
              echo "    åˆ é™¤æ–‡ä»¶: $DELETE_FILE"
              
              if [ -f "$DELETE_FILE" ]; then
                rm -f "$DELETE_FILE"
                MODIFIED_FILES="$MODIFIED_FILES $DELETE_FILE"
              fi
            fi
            
          done < "$FIX_FILE"
          
          # 3. å¦‚æžœæœ‰ä¿®æ”¹ï¼Œæäº¤å¹¶æŽ¨é€
          if [ -n "$MODIFIED_FILES" ]; then
            echo "ðŸ’¾ æ£€æµ‹åˆ°ä¿®æ”¹ï¼Œå‡†å¤‡æäº¤..."
            echo "ä¿®æ”¹çš„æ–‡ä»¶:"
            for file in $MODIFIED_FILES; do
              echo "  - $file"
            done
            
            # é…ç½®Git
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "GitHub Actions"
            
            # æž„å»ºæäº¤ä¿¡æ¯
            COMMIT_MSG="ðŸ”§ è‡ªåŠ¨ä¿®å¤"
            COMMIT_MSG+="\n\næ¥æº: $FIX_FILE"
            COMMIT_MSG+="\næ—¶é—´: $(date)"
            COMMIT_MSG+="\nè§¦å‘: ${{ github.event_name }}"
            
            # æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
            if [ -n "$MODIFIED_FILES" ]; then
              COMMIT_MSG+="\n\nä¿®æ”¹çš„æ–‡ä»¶:"
              for file in $MODIFIED_FILES; do
                COMMIT_MSG+="\n- $file"
              done
            fi
            
            # æ·»åŠ ä¿®å¤æ–‡ä»¶å†…å®¹é¢„è§ˆ
            COMMIT_MSG+="\n\nä¿®å¤æŒ‡ä»¤é¢„è§ˆ:"
            head -10 "$FIX_FILE" | while IFS= read -r line; do
              COMMIT_MSG+="\n  $line"
            done
            if [ $(wc -l < "$FIX_FILE") -gt 10 ]; then
              COMMIT_MSG+="\n  ...ï¼ˆè¿˜æœ‰æ›´å¤šï¼‰"
            fi
            
            # æäº¤æ‰€æœ‰ä¿®æ”¹
            echo -e "$COMMIT_MSG" | git commit -a -F -
            
            # 4. æŽ¨é€æ›´æ”¹
            echo "ðŸš€ æŽ¨é€åˆ°ä¸»åˆ†æ”¯..."
            git push origin HEAD:main
            
            echo "âœ… ä¿®å¤å·²åº”ç”¨å¹¶æŽ¨é€"
          else
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æœ‰æ•ˆçš„ä¿®æ”¹"
          fi
          
          # 5. æ¸…ç†ä¿®å¤æ–‡ä»¶
          echo "ðŸ§¹ æ¸…ç†ä¿®å¤æ–‡ä»¶..."
          > "$FIX_FILE"
          git add "$FIX_FILE"
          git commit -m "ðŸ§¹ æ¸…ç†ä¿®å¤æ–‡ä»¶: $(basename "$FIX_FILE") [skip ci]" || true
          git push origin HEAD:main
      
      - name: ðŸ“‹ ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸ”§ è‡ªåŠ¨ä¿®å¤å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "**çŠ¶æ€:** âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "**çŠ¶æ€:** âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**æ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**ä¿®å¤æ–‡ä»¶:** ${{ env.FIX_FILE_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºæœ€åŽçš„çŠ¶æ€
          if [ -n "${{ env.FIX_FILE_PATH }}" ]; then
            echo "### ðŸ“Š æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶: ${{ env.FIX_FILE_PATH }}" >> $GITHUB_STEP_SUMMARY
            echo "2. âœ… è§£æžä¿®å¤æŒ‡ä»¤: å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "3. âœ… åº”ç”¨ä¿®å¤: å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "4. âœ… æäº¤æ›´æ”¹: å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "5. âœ… æ¸…ç†å·¥ä½œ: å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # æ˜¾ç¤ºä¿®å¤æ–‡ä»¶ä½ç½®ä¿¡æ¯
            echo "### ðŸ“ æ–‡ä»¶ä½ç½®" >> $GITHUB_STEP_SUMMARY
            echo "- **ä¿®å¤æ–‡ä»¶:** \`${{ env.FIX_FILE_PATH }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **ä»“åº“æ ¹ç›®å½•:** \`$(pwd)\`" >> $GITHUB_STEP_SUMMARY
            echo "- **ç›¸å¯¹è·¯å¾„:** \`${{ env.FIX_FILE_PATH }}\`" >> $GITHUB_STEP_SUMMARY
          fi
