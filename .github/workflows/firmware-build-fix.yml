name: ðŸ”§ è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿï¼ˆPR + è‡ªåŠ¨åˆå¹¶ï¼‰

on:
  push:
    paths:
      - 'firmware-config/fix.txt'
      - 'fix.txt'
      - '.github/workflows/auto-fix.yml'
  
  workflow_dispatch:
    inputs:
      auto_merge:
        description: 'è‡ªåŠ¨åˆå¹¶PR'
        required: false
        default: true
        type: boolean

jobs:
  analyze-fixes:
    runs-on: ubuntu-latest
    outputs:
      has_fixes: ${{ steps.analyze.outputs.has_fixes }}
      total_fixes: ${{ steps.analyze.outputs.total_fixes }}
      script_fixes: ${{ steps.analyze.outputs.script_fixes }}
      workflow_fixes: ${{ steps.analyze.outputs.workflow_fixes }}
      fix_file: ${{ steps.analyze.outputs.fix_file }}
    
    steps:
      - name: ðŸ›Žï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ” åˆ†æžä¿®å¤æ–‡ä»¶
        id: analyze
        run: |
          echo "=== åˆ†æžä¿®å¤æ–‡ä»¶ ==="
          
          # æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶
          if [ -f "firmware-config/fix.txt" ]; then
            FIX_FILE="firmware-config/fix.txt"
          elif [ -f "fix.txt" ]; then
            FIX_FILE="fix.txt"
          else
            echo "âŒ æœªæ‰¾åˆ°ä¿®å¤æ–‡ä»¶"
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          
          # ç»Ÿè®¡å„ç§ä¿®å¤
          TOTAL_FIXES=$(grep -c "^#ã€" "$FIX_FILE" 2>/dev/null || echo "0")
          SCRIPT_FIXES=$(grep -c "^#ã€build_firmware_main.sh" "$FIX_FILE" 2>/dev/null || echo "0")
          WORKFLOW_FIXES=$(grep -c "^#ã€firmware-build.yml" "$FIX_FILE" 2>/dev/null || echo "0")
          
          echo "ðŸ“Š ä¿®å¤ç»Ÿè®¡:"
          echo "- æ€»ä¿®å¤æ ‡è¯†: $TOTAL_FIXES"
          echo "- è„šæœ¬ä¿®å¤: $SCRIPT_FIXES"
          echo "- å·¥ä½œæµä¿®å¤: $WORKFLOW_FIXES"
          
          if [ "$TOTAL_FIXES" -eq "0" ]; then
            echo "âš ï¸ ä¿®å¤æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ä¿®å¤æ ‡è¯†"
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_fixes=true" >> $GITHUB_OUTPUT
          echo "total_fixes=$TOTAL_FIXES" >> $GITHUB_OUTPUT
          echo "script_fixes=$SCRIPT_FIXES" >> $GITHUB_OUTPUT
          echo "workflow_fixes=$WORKFLOW_FIXES" >> $GITHUB_OUTPUT
          echo "fix_file=$FIX_FILE" >> $GITHUB_OUTPUT

  apply-fixes-and-pr:
    runs-on: ubuntu-latest
    needs: analyze-fixes
    if: needs.analyze-fixes.outputs.has_fixes == 'true'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ðŸ›Žï¸ æ£€å‡ºä»£ç åˆ°æ–°åˆ†æ”¯
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
      
      - name: ðŸŒ¿ åˆ›å»ºä¿®å¤åˆ†æ”¯
        run: |
          echo "=== åˆ›å»ºä¿®å¤åˆ†æ”¯ ==="
          
          # ç”Ÿæˆå”¯ä¸€åˆ†æ”¯å
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="auto-fix/$TIMESTAMP"
          
          echo "åˆ›å»ºåˆ†æ”¯: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
          echo "âœ… å·²åˆ‡æ¢åˆ°åˆ†æ”¯: $BRANCH_NAME"
      
      - name: ðŸ”§ åº”ç”¨è„šæœ¬ä¿®å¤
        if: needs.analyze-fixes.outputs.script_fixes != '0'
        run: |
          echo "=== åº”ç”¨è„šæœ¬ä¿®å¤ ==="
          
          SCRIPT_FILE="firmware-config/scripts/build_firmware_main.sh"
          FIX_FILE="${{ needs.analyze-fixes.outputs.fix_file }}"
          
          if [ ! -f "$SCRIPT_FILE" ]; then
            echo "âŒ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $SCRIPT_FILE"
            exit 1
          fi
          
          echo "ðŸ“„ ä¿®æ”¹è„šæœ¬æ–‡ä»¶: $SCRIPT_FILE"
          
          # åˆ›å»ºå¤‡ä»½
          BACKUP_FILE="${SCRIPT_FILE}.backup.$(date +%s)"
          cp "$SCRIPT_FILE" "$BACKUP_FILE"
          echo "ðŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
          
          # æå–è„šæœ¬ä¿®å¤å†…å®¹å¹¶åº”ç”¨
          echo "ðŸ” æå–ä¿®å¤å†…å®¹..."
          
          # æŸ¥æ‰¾æ‰€æœ‰è„šæœ¬ä¿®å¤å—
          LINE_NUMBER=0
          IN_SCRIPT_BLOCK=false
          SCRIPT_FIX_CONTENT=""
          SCRIPT_BLOCK_COUNT=0
          
          while IFS= read -r line; do
            LINE_NUMBER=$((LINE_NUMBER + 1))
            
            if [[ "$line" =~ ^#ã€build_firmware_main.sh ]]; then
              IN_SCRIPT_BLOCK=true
              SCRIPT_FIX_CONTENT=""
              echo "ðŸŽ¯ æ‰¾åˆ°è„šæœ¬ä¿®å¤å— (ç¬¬ $LINE_NUMBER è¡Œ)"
              SCRIPT_BLOCK_COUNT=$((SCRIPT_BLOCK_COUNT + 1))
              
            elif [[ "$line" =~ ^#ã€endã€‘ ]] || [[ "$line" =~ ^#ã€ç»“æŸã€‘ ]]; then
              if [ "$IN_SCRIPT_BLOCK" = true ]; then
                # åº”ç”¨è¿™ä¸ªä¿®å¤å—
                echo "ðŸ”„ åº”ç”¨è„šæœ¬ä¿®å¤å— #$SCRIPT_BLOCK_COUNT"
                
                # åœ¨è„šæœ¬æ–‡ä»¶æœ«å°¾æ·»åŠ ä¿®å¤å†…å®¹
                echo "" >> "$SCRIPT_FILE"
                echo "# ===== è‡ªåŠ¨ä¿®å¤å— #$SCRIPT_BLOCK_COUNT =====" >> "$SCRIPT_FILE"
                echo "# æ¥æº: $FIX_FILE (ç¬¬ $LINE_NUMBER è¡Œé™„è¿‘)" >> "$SCRIPT_FILE"
                echo "# æ—¶é—´: $(date)" >> "$SCRIPT_FILE"
                echo "$SCRIPT_FIX_CONTENT" >> "$SCRIPT_FILE"
                
                IN_SCRIPT_BLOCK=false
              fi
              
            elif [ "$IN_SCRIPT_BLOCK" = true ]; then
              SCRIPT_FIX_CONTENT="${SCRIPT_FIX_CONTENT}${line}"$'\n'
            fi
          done < "$FIX_FILE"
          
          # å¤„ç†æœ€åŽä¸€ä¸ªæœªç»“æŸçš„å—
          if [ "$IN_SCRIPT_BLOCK" = true ] && [ -n "$SCRIPT_FIX_CONTENT" ]; then
            echo "ðŸ”„ åº”ç”¨æœ€åŽä¸€ä¸ªè„šæœ¬ä¿®å¤å—"
            echo "" >> "$SCRIPT_FILE"
            echo "# ===== è‡ªåŠ¨ä¿®å¤å— #$((SCRIPT_BLOCK_COUNT + 1)) =====" >> "$SCRIPT_FILE"
            echo "# æ¥æº: $FIX_FILE" >> "$SCRIPT_FILE"
            echo "# æ—¶é—´: $(date)" >> "$SCRIPT_FILE"
            echo "$SCRIPT_FIX_CONTENT" >> "$SCRIPT_FILE"
          fi
          
          echo "âœ… åº”ç”¨äº† $SCRIPT_BLOCK_COUNT ä¸ªè„šæœ¬ä¿®å¤å—"
          echo "script_modified=true" >> $GITHUB_ENV
      
      - name: ðŸ”§ åˆ›å»ºå·¥ä½œæµä¿®å¤æ–‡ä»¶ï¼ˆæ–°æ–‡ä»¶ï¼Œä¸ä¿®æ”¹åŽŸæ–‡ä»¶ï¼‰
        if: needs.analyze-fixes.outputs.workflow_fixes != '0'
        run: |
          echo "=== åˆ›å»ºå·¥ä½œæµä¿®å¤æ–‡ä»¶ ==="
          
          FIX_FILE="${{ needs.analyze-fixes.outputs.fix_file }}"
          TIMESTAMP=$(date +%s)
          
          # åˆ›å»ºæ–°çš„å·¥ä½œæµä¿®å¤æ–‡ä»¶
          WORKFLOW_FIX_FILE="workflow-fixes-${TIMESTAMP}.yml"
          
          echo "# ðŸ”§ å·¥ä½œæµä¿®å¤æ–‡ä»¶" > "$WORKFLOW_FIX_FILE"
          echo "# ç”Ÿæˆæ—¶é—´: $(date)" >> "$WORKFLOW_FIX_FILE"
          echo "# æ¥æº: $FIX_FILE" >> "$WORKFLOW_FIX_FILE"
          echo "# ä¿®å¤æ ‡è¯†æ•°: ${{ needs.analyze-fixes.outputs.workflow_fixes }}" >> "$WORKFLOW_FIX_FILE"
          echo "" >> "$WORKFLOW_FIX_FILE"
          
          # æå–å·¥ä½œæµä¿®å¤å†…å®¹
          echo "# æå–çš„å·¥ä½œæµä¿®å¤å†…å®¹:" >> "$WORKFLOW_FIX_FILE"
          grep -A 50 "^#ã€firmware-build.yml" "$FIX_FILE" | head -100 >> "$WORKFLOW_FIX_FILE"
          
          echo "âœ… åˆ›å»ºå·¥ä½œæµä¿®å¤æ–‡ä»¶: $WORKFLOW_FIX_FILE"
          echo "workflow_fix_file=$WORKFLOW_FIX_FILE" >> $GITHUB_ENV
      
      - name: ðŸ’¾ æäº¤æ›´æ”¹
        run: |
          echo "=== æäº¤æ›´æ”¹ ==="
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          echo "ðŸ“Š GitçŠ¶æ€:"
          git status --short
          echo ""
          
          echo "âž• æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶..."
          
          # æ·»åŠ è„šæœ¬æ–‡ä»¶
          if [ -n "${{ env.script_modified }}" ]; then
            git add "firmware-config/scripts/build_firmware_main.sh"
            echo "âœ… æ·»åŠ è„šæœ¬æ–‡ä»¶"
          fi
          
          # æ·»åŠ å·¥ä½œæµä¿®å¤æ–‡ä»¶
          if [ -n "${{ env.workflow_fix_file }}" ]; then
            git add "${{ env.workflow_fix_file }}"
            echo "âœ… æ·»åŠ å·¥ä½œæµä¿®å¤æ–‡ä»¶"
          fi
          
          # æ·»åŠ å¤‡ä»½æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          git add "*.backup.*" 2>/dev/null || true
          
          echo ""
          echo "ðŸ’¾ æäº¤æ›´æ”¹..."
          
          COMMIT_MSG="ðŸ”§ è‡ªåŠ¨ä¿®å¤"
          
          if [ "${{ needs.analyze-fixes.outputs.script_fixes }}" != "0" ]; then
            COMMIT_MSG="${COMMIT_MSG} - è„šæœ¬(${{ needs.analyze-fixes.outputs.script_fixes }})"
          fi
          
          if [ "${{ needs.analyze-fixes.outputs.workflow_fixes }}" != "0" ]; then
            COMMIT_MSG="${COMMIT_MSG} - å·¥ä½œæµ(${{ needs.analyze-fixes.outputs.workflow_fixes }})"
          fi
          
          COMMIT_MSG="${COMMIT_MSG}"
          
          git commit -m "$COMMIT_MSG" || echo "âš ï¸ æ²¡æœ‰æ›´æ”¹å¯æäº¤"
          
          echo "ðŸš€ æŽ¨é€åˆ†æ”¯..."
          git push origin "${{ env.branch_name }}"
          
          echo "âœ… åˆ†æ”¯å·²æŽ¨é€: ${{ env.branch_name }}"
      
      - name: ðŸ“¨ åˆ›å»ºPull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.branch_name }}
          base: main
          title: "ðŸ”§ è‡ªåŠ¨ä¿®å¤"
          body: |
            ## è‡ªåŠ¨ä¿®å¤æäº¤
            
            **ä¿®å¤ç»Ÿè®¡:**
            - æ€»ä¿®å¤æ ‡è¯†: ${{ needs.analyze-fixes.outputs.total_fixes }} ä¸ª
            - è„šæœ¬ä¿®å¤: ${{ needs.analyze-fixes.outputs.script_fixes }} ä¸ª
            - å·¥ä½œæµä¿®å¤: ${{ needs.analyze-fixes.outputs.workflow_fixes }} ä¸ª
            
            **ä¿®å¤æ–‡ä»¶:** `${{ needs.analyze-fixes.outputs.fix_file }}`
            
            **ä¿®æ”¹çš„æ–‡ä»¶:**
            ${{ needs.analyze-fixes.outputs.script_fixes != '0' && '- `firmware-config/scripts/build_firmware_main.sh`' || '' }}
            ${{ needs.analyze-fixes.outputs.workflow_fixes != '0' && '- `workflow-fixes-*.yml` (æ–°æ–‡ä»¶)' || '' }}
            
            ---
            
            > ðŸ¤– æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º
            > ðŸ“… åˆ›å»ºæ—¶é—´: $(date)
            
            <!-- è‡ªåŠ¨åˆå¹¶æ ‡è®° -->
            ${{ github.event.inputs.auto_merge == 'true' && 'automerge' || '' }}
          labels: |
            automated-pr
            fix
            ${{ github.event.inputs.auto_merge == 'true' && 'automerge' || '' }}
          delete-branch: true
      
      - name: ðŸ”„ è‡ªåŠ¨åˆå¹¶PR
        if: github.event.inputs.auto_merge == 'true' && steps.create-pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== è‡ªåŠ¨åˆå¹¶PR ==="
          
          PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
          echo "PRå·: $PR_NUMBER"
          
          # ç­‰å¾…å‡ ç§’è®©GitHubæ›´æ–°çŠ¶æ€
          sleep 5
          
          # æ£€æŸ¥PRçŠ¶æ€
          echo "ðŸ” æ£€æŸ¥PRçŠ¶æ€..."
          PR_STATUS=$(gh pr view $PR_NUMBER --json mergeable,state --jq '.mergeable + ":" + .state' 2>/dev/null || echo "unknown:unknown")
          
          echo "PRçŠ¶æ€: $PR_STATUS"
          
          # å¦‚æžœPRå¯åˆå¹¶ä¸”æ˜¯æ‰“å¼€çš„ï¼Œå°è¯•åˆå¹¶
          if [[ "$PR_STATUS" == *"MERGEABLE:OPEN"* ]]; then
            echo "ðŸ”„ å¼€å§‹è‡ªåŠ¨åˆå¹¶..."
            
            # å°è¯•åˆå¹¶
            if gh pr merge $PR_NUMBER --squash --delete-branch; then
              echo "âœ… PRå·²è‡ªåŠ¨åˆå¹¶"
            else
              echo "âŒ è‡ªåŠ¨åˆå¹¶å¤±è´¥"
            fi
          else
            echo "âš ï¸ PRä¸å¯åˆå¹¶æˆ–å·²å…³é—­ï¼Œè·³è¿‡åˆå¹¶"
            echo "çŠ¶æ€è¯¦æƒ…: $PR_STATUS"
          fi
      
      - name: ðŸ“‹ ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸ”§ è‡ªåŠ¨ä¿®å¤ç³»ç»ŸæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“… åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿®å¤æ–‡ä»¶:** \`${{ needs.analyze-fixes.outputs.fix_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“Š ä¿®å¤ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»ä¿®å¤æ ‡è¯†:** ${{ needs.analyze-fixes.outputs.total_fixes }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **è„šæœ¬ä¿®å¤:** ${{ needs.analyze-fixes.outputs.script_fixes }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµä¿®å¤:** ${{ needs.analyze-fixes.outputs.workflow_fixes }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸŒ¿ åˆ†æ”¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿®å¤åˆ†æ”¯:** \`${{ env.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“ ä¿®æ”¹å†…å®¹" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ env.script_modified }}" ]; then
            echo "- âœ… **è„šæœ¬æ–‡ä»¶å·²ä¿®æ”¹:** \`firmware-config/scripts/build_firmware_main.sh\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ env.workflow_fix_file }}" ]; then
            echo "- ðŸ“„ **åˆ›å»ºå·¥ä½œæµä¿®å¤æ–‡ä»¶:** \`${{ env.workflow_fix_file }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“¨ PRçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.create-pr.outputs.pull-request-number }}" != "" ]]; then
            echo "âœ… **Pull Requestå·²åˆ›å»º**" >> $GITHUB_STEP_SUMMARY
            echo "- **PRå·:** #${{ steps.create-pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PRé“¾æŽ¥:** [${{ env.branch_name }} â†’ main](${{ steps.create-pr.outputs.pull-request-url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ github.event.inputs.auto_merge }}" == "true" ]]; then
              echo "ðŸ”„ **è‡ªåŠ¨åˆå¹¶å·²å¯ç”¨**" >> $GITHUB_STEP_SUMMARY
              if [[ "${{ job.status }}" == "success" ]]; then
                echo "âœ… **PRå·²è‡ªåŠ¨åˆå¹¶**" >> $GITHUB_STEP_SUMMARY
              else
                echo "â³ **ç­‰å¾…åˆå¹¶æˆ–åˆå¹¶å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "ðŸ‘ï¸ **éœ€è¦æ‰‹åŠ¨åˆå¹¶**" >> $GITHUB_STEP_SUMMARY
              echo "> è¯·å‰å¾€PRé¡µé¢æŸ¥çœ‹å¹¶åˆå¹¶æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **PRåˆ›å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          fi
