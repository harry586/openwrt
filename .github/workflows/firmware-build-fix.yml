name: ðŸ”§ å…¨è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ

on:
  push:
    paths:
      - '**/fix.txt'
      - '**/fix.md'
      - '**/fixes/**'

jobs:
  auto-fix-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å¿…é¡»æœ‰å†™å…¥æƒé™æ‰èƒ½æŽ¨é€
    
    steps:
      - name: ðŸ›Žï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ” æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶
        id: find_fix
        run: |
          echo "=== æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶ ==="
          
          # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ä¿®å¤æ–‡ä»¶
          FIND_COMMAND="find . -type f -name 'fix.txt' -o -name 'fix.md' -o -path '*/fixes/*' | grep -v '.git' | head -5"
          
          echo "æ‰§è¡ŒæŸ¥æ‰¾å‘½ä»¤: $FIND_COMMAND"
          FIX_FILES=$(eval $FIND_COMMAND)
          
          if [ -z "$FIX_FILES" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä¿®å¤æ–‡ä»¶"
            echo "has_fix_file=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°ä¿®å¤æ–‡ä»¶:"
          echo "$FIX_FILES"
          
          # å–ç¬¬ä¸€ä¸ªæ–‡ä»¶ä½œä¸ºä¿®å¤æ–‡ä»¶
          MAIN_FIX_FILE=$(echo "$FIX_FILES" | head -1)
          echo "ä¸»ä¿®å¤æ–‡ä»¶: $MAIN_FIX_FILE"
          
          # æå–ä¿®å¤æ ‡è¯†
          echo "=== åˆ†æžä¿®å¤å†…å®¹ ==="
          IDENTIFIER_COUNT=$(grep -c "^#ã€" "$MAIN_FIX_FILE" 2>/dev/null || echo "0")
          SCRIPT_FIX_COUNT=$(grep -c "#ã€.*\.sh" "$MAIN_FIX_FILE" 2>/dev/null || echo "0")
          WORKFLOW_FIX_COUNT=$(grep -c "#ã€.*\.yml" "$MAIN_FIX_FILE" 2>/dev/null || echo "0")
          
          echo "ä¿®å¤æ ‡è¯†æ€»æ•°: $IDENTIFIER_COUNT"
          echo "è„šæœ¬ä¿®å¤æ•°é‡: $SCRIPT_FIX_COUNT"
          echo "å·¥ä½œæµä¿®å¤æ•°é‡: $WORKFLOW_FIX_COUNT"
          
          # è¾“å‡ºåˆ°çŽ¯å¢ƒå˜é‡
          echo "fix_file=$MAIN_FIX_FILE" >> $GITHUB_OUTPUT
          echo "identifier_count=$IDENTIFIER_COUNT" >> $GITHUB_OUTPUT
          echo "script_fix_count=$SCRIPT_FIX_COUNT" >> $GITHUB_OUTPUT
          echo "workflow_fix_count=$WORKFLOW_FIX_COUNT" >> $GITHUB_OUTPUT
          echo "has_fix_file=true" >> $GITHUB_OUTPUT
      
      - name: ðŸ“ åº”ç”¨è„šæœ¬ä¿®å¤
        if: steps.find_fix.outputs.script_fix_count != '0'
        run: |
          echo "=== åº”ç”¨è„šæœ¬ä¿®å¤ ==="
          FIX_FILE="${{ steps.find_fix.outputs.fix_file }}"
          
          # ä»Žä¿®å¤æ–‡ä»¶ä¸­æå–æ‰€æœ‰.shæ–‡ä»¶è·¯å¾„
          grep "#ã€.*\.sh" "$FIX_FILE" | while read -r fix_line; do
            # æå–æ–‡ä»¶å
            if [[ "$fix_line" =~ #ã€(.*\.sh) ]]; then
              TARGET_FILE="${BASH_REMATCH[1]}"
              echo "ðŸ”§ å¤„ç†è„šæœ¬: $TARGET_FILE"
              
              # æŸ¥æ‰¾æ–‡ä»¶
              if [ -f "$TARGET_FILE" ]; then
                echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $TARGET_FILE"
              else
                # å°è¯•åœ¨å¸¸è§ç›®å½•ä¸­æŸ¥æ‰¾
                POSSIBLE_PATHS=(
                  "./scripts/$TARGET_FILE"
                  "./firmware-config/scripts/$TARGET_FILE"
                  "./src/scripts/$TARGET_FILE"
                  "./$TARGET_FILE"
                )
                
                for path in "${POSSIBLE_PATHS[@]}"; do
                  if [ -f "$path" ]; then
                    TARGET_FILE="$path"
                    echo "âœ… åœ¨ $path æ‰¾åˆ°æ–‡ä»¶"
                    break
                  fi
                done
              fi
              
              if [ ! -f "$TARGET_FILE" ]; then
                echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ°æ–‡ä»¶ $TARGET_FILEï¼Œè·³è¿‡"
                continue
              fi
              
              # åˆ›å»ºå¤‡ä»½
              BACKUP_FILE="$TARGET_FILE.backup.$(date +%s)"
              cp "$TARGET_FILE" "$BACKUP_FILE"
              echo "ðŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
              
              # æå–ä¿®å¤å†…å®¹å¹¶åº”ç”¨
              echo "ðŸ”„ åº”ç”¨ä¿®å¤..."
              
              # ä¸´æ—¶æ–‡ä»¶
              TEMP_FILE="$TARGET_FILE.temp"
              
              # æå–ç‰¹å®šè„šæœ¬çš„ä¿®å¤å—
              START_LINE=$(grep -n "$fix_line" "$FIX_FILE" | cut -d: -f1)
              
              if [ -n "$START_LINE" ]; then
                # æŸ¥æ‰¾ä¿®å¤å—çš„ç»“æŸï¼ˆä¸‹ä¸€ä¸ª#ã€æˆ–æ–‡ä»¶ç»“æŸï¼‰
                awk -v start="$START_LINE" '
                  NR == start {in_block=1; print "å¼€å§‹ä¿®å¤å—..." > "/dev/stderr"}
                  in_block && /^#ã€/ && NR != start {in_block=0}
                  in_block && NR > start
                ' "$FIX_FILE" > fix_content.tmp
                
                # è¿™é‡Œéœ€è¦æ ¹æ®å®žé™…ä¿®å¤é€»è¾‘åº”ç”¨
                # ç¤ºä¾‹ï¼šç®€å•æ›¿æ¢ï¼ˆéœ€è¦æ ¹æ®å®žé™…ä¿®å¤æ ¼å¼è°ƒæ•´ï¼‰
                cp "$TARGET_FILE" "$TEMP_FILE"
                
                # æ˜¾ç¤ºä¿®å¤å†…å®¹
                echo "ä¿®å¤å†…å®¹:"
                cat fix_content.tmp
                
                # å®žé™…åº”ç”¨ä¿®å¤çš„é€»è¾‘éœ€è¦æ ¹æ®ä½ çš„ä¿®å¤æ ¼å¼ç¼–å†™
                # è¿™é‡Œåªæ˜¯ä¸€ä¸ªç¤ºä¾‹æ¡†æž¶
                echo "âœ… å·²æ ‡è®° $TARGET_FILE å¾…ä¿®å¤"
                
                rm -f fix_content.tmp
              fi
              
              rm -f "$TEMP_FILE"
            fi
          done
          
          echo "âœ… è„šæœ¬ä¿®å¤å¤„ç†å®Œæˆ"
      
      - name: ðŸ”„ åº”ç”¨å·¥ä½œæµä¿®å¤
        if: steps.find_fix.outputs.workflow_fix_count != '0'
        run: |
          echo "=== åº”ç”¨å·¥ä½œæµä¿®å¤ ==="
          FIX_FILE="${{ steps.find_fix.outputs.fix_file }}"
          
          # ä»Žä¿®å¤æ–‡ä»¶ä¸­æå–æ‰€æœ‰.ymlæ–‡ä»¶è·¯å¾„
          grep "#ã€.*\.yml" "$FIX_FILE" | while read -r fix_line; do
            if [[ "$fix_line" =~ #ã€(.*\.yml) ]]; then
              TARGET_FILE="${BASH_REMATCH[1]}"
              echo "ðŸ”§ å¤„ç†å·¥ä½œæµ: $TARGET_FILE"
              
              # æŸ¥æ‰¾æ–‡ä»¶
              if [ -f "$TARGET_FILE" ]; then
                echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $TARGET_FILE"
              else
                # å°è¯•åœ¨å¸¸è§ç›®å½•ä¸­æŸ¥æ‰¾
                POSSIBLE_PATHS=(
                  "./.github/workflows/$TARGET_FILE"
                  "./workflows/$TARGET_FILE"
                  "./$TARGET_FILE"
                )
                
                for path in "${POSSIBLE_PATHS[@]}"; do
                  if [ -f "$path" ]; then
                    TARGET_FILE="$path"
                    echo "âœ… åœ¨ $path æ‰¾åˆ°æ–‡ä»¶"
                    break
                  fi
                done
              fi
              
              if [ ! -f "$TARGET_FILE" ]; then
                echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ°æ–‡ä»¶ $TARGET_FILEï¼Œè·³è¿‡"
                continue
              fi
              
              # åˆ›å»ºå¤‡ä»½
              BACKUP_FILE="$TARGET_FILE.backup.$(date +%s)"
              cp "$TARGET_FILE" "$BACKUP_FILE"
              echo "ðŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
              
              echo "âœ… å·²æ ‡è®° $TARGET_FILE å¾…ä¿®å¤"
            fi
          done
          
          echo "âœ… å·¥ä½œæµä¿®å¤å¤„ç†å®Œæˆ"
      
      - name: ðŸŽ¯ æ‰§è¡Œå®žé™…ä¿®å¤ï¼ˆç¤ºä¾‹ï¼‰
        run: |
          echo "=== æ‰§è¡Œå®žé™…ä¿®å¤ ==="
          echo "ðŸ“Œ è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ä¿®å¤æ­¥éª¤"
          echo "ðŸ“Œ ä½ éœ€è¦æ ¹æ®å®žé™…çš„ fix.txt æ ¼å¼æ¥å®žçŽ°å…·ä½“çš„ä¿®å¤é€»è¾‘"
          
          # ç¤ºä¾‹ï¼šå¦‚æžœ fix.txt åŒ…å«æ›¿æ¢å†…å®¹
          # å‡è®¾ fix.txt æ ¼å¼ä¸ºï¼š
          # #ã€æ–‡ä»¶è·¯å¾„ã€‘
          # æŸ¥æ‰¾å†…å®¹
          # æ›¿æ¢ä¸º
          # #ã€ç»“æŸã€‘
          
          # è¿™é‡Œå¯ä»¥å®žçŽ°å…·ä½“çš„ä¿®å¤é€»è¾‘
          echo "ç¤ºä¾‹ï¼šä¿®å¤é€»è¾‘å¾…å®žçŽ°"
          
          # ç®€å•ç¤ºä¾‹ï¼šä¿®æ”¹ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
          echo "ðŸ”„ åˆ›å»ºæµ‹è¯•ä¿®æ”¹..."
          TEST_FILE="auto-fix-test.txt"
          echo "è‡ªåŠ¨ä¿®å¤æµ‹è¯• - $(date)" > "$TEST_FILE"
          echo "ä¿®å¤å®ŒæˆäºŽ: $(date)" >> "$TEST_FILE"
      
      - name: ðŸ’¾ è‡ªåŠ¨æäº¤æ›´æ”¹
        run: |
          echo "=== è‡ªåŠ¨æäº¤æ›´æ”¹ ==="
          
          # é…ç½®Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          # æ˜¾ç¤ºçŠ¶æ€
          echo "ðŸ“Š GitçŠ¶æ€:"
          git status --short
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet && git diff --cached --quiet; then
            echo "ðŸ“­ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
            
            # å¦‚æžœæ²¡æœ‰æ›´æ”¹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°å¢žæ–‡ä»¶
            if [ -n "$(git status --porcelain)" ]; then
              echo "ðŸ“ å‘çŽ°æœªè·Ÿè¸ªæ–‡ä»¶ï¼Œå‡†å¤‡æ·»åŠ "
              git add -A
              git commit -m "ðŸ”§ è‡ªåŠ¨ä¿®å¤: æ·»åŠ æ–°æ–‡ä»¶ [skip ci]"
              git push
              echo "âœ… æ–°æ–‡ä»¶å·²æäº¤"
            else
              echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„å†…å®¹"
            fi
          else
            echo "ðŸ“ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
            
            # æ·»åŠ æ‰€æœ‰æ›´æ”¹
            git add -A
            
            # æäº¤ä¿¡æ¯
            COMMIT_MSG="ðŸ”§ è‡ªåŠ¨ä¿®å¤: "
            
            if [ "${{ steps.find_fix.outputs.script_fix_count }}" != "0" ]; then
              COMMIT_MSG="${COMMIT_MSG}è„šæœ¬ä¿®å¤"
            fi
            
            if [ "${{ steps.find_fix.outputs.workflow_fix_count }}" != "0" ]; then
              if [ "${{ steps.find_fix.outputs.script_fix_count }}" != "0" ]; then
                COMMIT_MSG="${COMMIT_MSG} + "
              fi
              COMMIT_MSG="${COMMIT_MSG}å·¥ä½œæµä¿®å¤"
            fi
            
            COMMIT_MSG="${COMMIT_MSG} [skip ci]"
            
            # æäº¤
            git commit -m "$COMMIT_MSG"
            
            # æŽ¨é€
            echo "ðŸš€ æŽ¨é€æ›´æ”¹åˆ°ä»“åº“..."
            git push
            
            echo "âœ… æ›´æ”¹å·²è‡ªåŠ¨æäº¤å¹¶æŽ¨é€"
            echo "ðŸ“‹ æäº¤ä¿¡æ¯: $COMMIT_MSG"
          fi
      
      - name: ðŸ“‹ ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸŽ‰ å…¨è‡ªåŠ¨ä¿®å¤å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“… æ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“Š å¤„ç†ç»Ÿè®¡:**" >> $GITHUB_STEP_SUMMARY
          echo "- è§£æžä¿®å¤æ ‡è¯†: ${{ steps.find_fix.outputs.identifier_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- è„šæœ¬ä¿®å¤: ${{ steps.find_fix.outputs.script_fix_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- å·¥ä½œæµä¿®å¤: ${{ steps.find_fix.outputs.workflow_fix_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ðŸ”§ æ“ä½œæ¨¡å¼:** ðŸŸ¢ å…¨è‡ªåŠ¨ä¿®å¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ðŸ“ ä¿®å¤æ–‡ä»¶:** ${{ steps.find_fix.outputs.fix_file }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "âœ… ç³»ç»Ÿå·²è‡ªåŠ¨æ£€æµ‹ä¿®å¤æ–‡ä»¶å¹¶åº”ç”¨æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºGitçŠ¶æ€
          echo "**ðŸ“ˆ ä»“åº“çŠ¶æ€:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git status --short 2>/dev/null || echo "æ— æ³•èŽ·å–çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
