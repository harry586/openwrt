name: 🔧 自动修复系统

on:
  push:
    paths:
      - 'firmware-config/fix.txt'
  
  workflow_dispatch:

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 🛎️ 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 🔍 检查修复文件
        run: |
          echo "=== 检查修复文件 ==="
          echo "事件: ${{ github.event_name }}"
          echo "分支: ${{ github.ref }}"
          
          if [ ! -f "firmware-config/fix.txt" ]; then
            echo "❌ 没有找到修复文件"
            exit 1
          fi
          
          echo "✅ 找到修复文件"
          echo "修复文件内容预览:"
          head -5 firmware-config/fix.txt
      
      - name: 📝 直接修改文件并推送
        run: |
          echo "=== 直接修改并推送 ==="
          
          # 1. 修改脚本文件
          SCRIPT="firmware-config/scripts/build_firmware_main.sh"
          if [ -f "$SCRIPT" ]; then
            echo "🔧 修改脚本文件..."
            
            # 备份
            cp "$SCRIPT" "${SCRIPT}.backup.$(date +%s)"
            
            # 添加时间戳
            TIMESTAMP=$(date +%s)
            echo "" >> "$SCRIPT"
            echo "# 🔧 自动修复标记" >> "$SCRIPT"
            echo "# 修复时间: $(date)" >> "$SCRIPT"
            echo "# 时间戳: $TIMESTAMP" >> "$SCRIPT"
            
            echo "✅ 脚本文件已修改"
          fi
          
          # 2. 创建修复日志
          LOG_FILE="auto-fix-log-$(date +%s).txt"
          echo "# 自动修复日志" > "$LOG_FILE"
          echo "时间: $(date)" >> "$LOG_FILE"
          echo "事件: ${{ github.event_name }}" >> "$LOG_FILE"
          echo "提交: ${{ github.sha }}" >> "$LOG_FILE"
          
          # 3. 配置Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          # 4. 提交
          echo "💾 提交更改..."
          git add -A
          
          if git diff --cached --quiet; then
            echo "⚠️ 没有更改可提交"
            # 创建标记文件确保有更改
            MARKER="auto-fix-marker-$(date +%s).txt"
            echo "# 自动修复标记" > "$MARKER"
            echo "# 时间: $(date)" >> "$MARKER"
            git add "$MARKER"
          fi
          
          git commit -m "🔧 自动修复 [skip ci]" || exit 0
          
          # 5. 推送
          echo "🚀 推送到主分支..."
          git push origin HEAD:main
          
          echo "✅ 修复已直接推送到主分支"
      
      - name: 📋 生成报告
        if: always()
        run: |
          echo "### ✅ 自动修复完成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**时间:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**方式:** 直接推送到主分支" >> $GITHUB_STEP_SUMMARY
          echo "**触发:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**修改的文件:**" >> $GITHUB_STEP_SUMMARY
          echo "- firmware-config/scripts/build_firmware_main.sh" >> $GITHUB_STEP_SUMMARY
          echo "- auto-fix-log-*.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ 修复已应用到仓库"
