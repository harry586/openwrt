name: Auto Fix Firmware Build Files

on:
  push:
    paths:
      - 'firmware-config/fix.txt'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (åªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’ï¼Œä¸å®é™…ä¿®æ”¹)'
        required: false
        default: 'false'
        type: boolean

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup environment
        run: |
          echo "=== è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿåˆå§‹åŒ– ==="
          echo "ğŸ“… å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p tmp_fixes
          mkdir -p backup_files
          
          # æ˜¾ç¤ºå½“å‰æ–‡ä»¶çŠ¶æ€
          echo "ğŸ“‚ ä»“åº“å†…å®¹:"
          ls -la
          echo ""
          
      - name: Parse fix.txt file
        id: parse_fixes
        run: |
          echo "=== è§£æä¿®å¤æ–¹æ¡ˆæ–‡ä»¶ ==="
          
          FIX_FILE="firmware-config/fix.txt"
          
          if [ ! -f "$FIX_FILE" ]; then
            echo "âŒ é”™è¯¯: ä¿®å¤æ–‡ä»¶ä¸å­˜åœ¨: $FIX_FILE"
            exit 1
          fi
          
          echo "ğŸ“„ ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(wc -l < "$FIX_FILE") è¡Œ"
          
          # æå–æ‰€æœ‰ç³»ç»Ÿæ€§æ ‡è¯†
          echo "ğŸ” æå–ç³»ç»Ÿæ€§æ ‡è¯†..."
          grep -n "^#ã€" "$FIX_FILE" | while read line; do
            line_num=$(echo "$line" | cut -d: -f1)
            identifier=$(echo "$line" | cut -d: -f2- | sed 's/^#ã€\(.*\)ã€‘/\1/')
            echo "ğŸ“Œ æ ‡è¯† [$line_num]: $identifier"
          done
          
          # ç»Ÿè®¡ä¸åŒç±»å‹çš„ä¿®å¤
          echo ""
          echo "ğŸ“ˆ ä¿®å¤å†…å®¹ç»Ÿè®¡:"
          echo "  - è„šæœ¬å‡½æ•°ä¿®å¤: $(grep -c "^#ã€build_firmware_main.sh-" "$FIX_FILE") ä¸ª"
          echo "  - å·¥ä½œæµæ­¥éª¤ä¿®å¤: $(grep -c "^#ã€firmware-build.yml-" "$FIX_FILE") ä¸ª"
          echo "  - æ–°å‡½æ•°/æ­¥éª¤: $(grep -c "^#ã€.*-æ–°å‡½æ•°ã€‘\|^#ã€.*-æ–°æ­¥éª¤ã€‘" "$FIX_FILE") ä¸ª"
          
          # ä¿å­˜è§£æç»“æœä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "IDENTIFIERS_COUNT=$(grep -c "^#ã€" "$FIX_FILE")" >> $GITHUB_OUTPUT
          echo "SCRIPT_FIXES_COUNT=$(grep -c "^#ã€build_firmware_main.sh-" "$FIX_FILE")" >> $GITHUB_OUTPUT
          echo "WORKFLOW_FIXES_COUNT=$(grep -c "^#ã€firmware-build.yml-" "$FIX_FILE")" >> $GITHUB_OUTPUT
          
      - name: Process script file fixes (build_firmware_main.sh)
        if: steps.parse_fixes.outputs.SCRIPT_FIXES_COUNT != '0'
        run: |
          echo "=== å¤„ç†è„šæœ¬æ–‡ä»¶ä¿®å¤ ==="
          
          FIX_FILE="firmware-config/fix.txt"
          TARGET_SCRIPT="firmware-config/scripts/build_firmware_main.sh"
          BACKUP_FILE="backup_files/build_firmware_main.sh.backup.$(date +%Y%m%d_%H%M%S)"
          
          if [ ! -f "$TARGET_SCRIPT" ]; then
            echo "âŒ ç›®æ ‡è„šæœ¬ä¸å­˜åœ¨: $TARGET_SCRIPT"
            exit 1
          fi
          
          # å¤‡ä»½åŸæ–‡ä»¶
          cp "$TARGET_SCRIPT" "$BACKUP_FILE"
          echo "âœ… å·²å¤‡ä»½åŸæ–‡ä»¶åˆ°: $BACKUP_FILE"
          
          # åˆ›å»ºä¸´æ—¶å·¥ä½œæ–‡ä»¶
          TEMP_SCRIPT="tmp_fixes/build_firmware_main.sh.tmp"
          cp "$TARGET_SCRIPT" "$TEMP_SCRIPT"
          
          # å¤„ç†æ‰€æœ‰è„šæœ¬ç›¸å…³çš„ä¿®å¤
          echo "ğŸ”§ å¤„ç†è„šæœ¬ä¿®å¤..."
          
          # è·å–æ‰€æœ‰è„šæœ¬ç›¸å…³çš„æ ‡è¯†
          grep -n "^#ã€build_firmware_main.sh-" "$FIX_FILE" | while read fix_line; do
            line_num=$(echo "$fix_line" | cut -d: -f1)
            identifier=$(echo "$fix_line" | cut -d: -f2- | sed 's/^#ã€\(.*\)ã€‘/\1/')
            name_part=$(echo "$identifier" | cut -d'-' -f2-)
            
            echo "ğŸ“Œ å¤„ç†ä¿®å¤: $identifier"
            
            # æå–ä¿®å¤å†…å®¹ï¼ˆä»å½“å‰è¡Œåˆ°ä¸‹ä¸€ä¸ªæ ‡è¯†æˆ–æ–‡ä»¶ç»“æŸï¼‰
            awk -v start_line="$line_num" '
              NR == start_line {in_fix=1}
              in_fix && /^#ã€/ && NR != start_line {exit}
              in_fix {print}
            ' "$FIX_FILE" > "tmp_fixes/current_fix.txt"
            
            # æå–å‡½æ•°åæˆ–ä¿®å¤æè¿°
            if echo "$identifier" | grep -q "å‡½æ•°"; then
              # å‡½æ•°ä¿®å¤
              func_name=$(echo "$name_part" | sed 's/ã€‘.*//')
              echo "  ğŸ¯ ç›®æ ‡å‡½æ•°: $func_name"
              
              # åœ¨ç›®æ ‡è„šæœ¬ä¸­æŸ¥æ‰¾å‡½æ•°
              if grep -n "^${func_name}()" "$TEMP_SCRIPT"; then
                echo "  âœ… æ‰¾åˆ°ç°æœ‰å‡½æ•°ï¼Œå°†è¿›è¡Œæ›¿æ¢"
                # è¿™é‡Œéœ€è¦å®ç°å®é™…çš„æ›¿æ¢é€»è¾‘
              else
                echo "  â• æœªæ‰¾åˆ°å‡½æ•°ï¼Œå°†ä½œä¸ºæ–°å‡½æ•°æ·»åŠ "
                # è¿™é‡Œéœ€è¦å®ç°æ·»åŠ æ–°å‡½æ•°çš„é€»è¾‘
              fi
            else
              # å…¶ä»–ä¿®å¤
              echo "  ğŸ”¨ ä¿®å¤ç±»å‹: $name_part"
            fi
            
            # æ˜¾ç¤ºä¿®å¤å†…å®¹é¢„è§ˆ
            echo "  ğŸ“‹ ä¿®å¤å†…å®¹é¢„è§ˆ:"
            head -10 "tmp_fixes/current_fix.txt" | sed 's/^/    /'
            echo ""
          done
          
          # å¦‚æœæ˜¯dry runï¼Œä¸å®é™…ä¿®æ”¹
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ” Dry runæ¨¡å¼ - æ˜¾ç¤ºä¿®æ”¹è®¡åˆ’"
            echo "ğŸ“Š å°†ä¿®æ”¹ä»¥ä¸‹å†…å®¹:"
            diff -u "$TARGET_SCRIPT" "$TEMP_SCRIPT" | head -50 || true
          else
            # å®é™…åº”ç”¨ä¿®æ”¹
            mv "$TEMP_SCRIPT" "$TARGET_SCRIPT"
            echo "âœ… å·²åº”ç”¨ä¿®å¤åˆ°: $TARGET_SCRIPT"
          fi
          
      - name: Process workflow file fixes (firmware-build.yml)
        if: steps.parse_fixes.outputs.WORKFLOW_FIXES_COUNT != '0'
        run: |
          echo "=== å¤„ç†å·¥ä½œæµæ–‡ä»¶ä¿®å¤ ==="
          
          FIX_FILE="firmware-config/fix.txt"
          TARGET_WORKFLOW=".github/workflows/firmware-build.yml"
          BACKUP_FILE="backup_files/firmware-build.yml.backup.$(date +%Y%m%d_%H%M%S)"
          
          if [ ! -f "$TARGET_WORKFLOW" ]; then
            echo "âŒ ç›®æ ‡å·¥ä½œæµä¸å­˜åœ¨: $TARGET_WORKFLOW"
            exit 1
          fi
          
          # å¤‡ä»½åŸæ–‡ä»¶
          cp "$TARGET_WORKFLOW" "$BACKUP_FILE"
          echo "âœ… å·²å¤‡ä»½åŸæ–‡ä»¶åˆ°: $BACKUP_FILE"
          
          # åˆ›å»ºä¸´æ—¶å·¥ä½œæ–‡ä»¶
          TEMP_WORKFLOW="tmp_fixes/firmware-build.yml.tmp"
          cp "$TARGET_WORKFLOW" "$TEMP_WORKFLOW"
          
          echo "ğŸ”§ å¤„ç†å·¥ä½œæµæ­¥éª¤ä¿®å¤..."
          
          # è·å–æ‰€æœ‰å·¥ä½œæµç›¸å…³çš„æ ‡è¯†å¹¶æ’åº
          grep -n "^#ã€firmware-build.yml-" "$FIX_FILE" | sort -t'-' -k3 -n | while read fix_line; do
            line_num=$(echo "$fix_line" | cut -d: -f1)
            identifier=$(echo "$fix_line" | cut -d: -f2- | sed 's/^#ã€\(.*\)ã€‘/\1/')
            step_num=$(echo "$identifier" | grep -o '[0-9]\+')
            
            echo "ğŸ“Œ å¤„ç†ä¿®å¤: $identifier (æ­¥éª¤ $step_num)"
            
            # æå–ä¿®å¤å†…å®¹
            awk -v start_line="$line_num" '
              NR == start_line {in_fix=1}
              in_fix && /^#ã€/ && NR != start_line {exit}
              in_fix {print}
            ' "$FIX_FILE" > "tmp_fixes/workflow_fix.txt"
            
            # ç§»é™¤æ ‡è¯†è¡Œ
            sed -i '1d' "tmp_fixes/workflow_fix.txt"
            
            # ç¡®å®šæ­¥éª¤ä½ç½®
            if [[ "$step_num" =~ ^[0-9]+$ ]]; then
              echo "  ğŸ” æŸ¥æ‰¾æ­¥éª¤ $step_num..."
              
              # åœ¨å·¥ä½œæµä¸­æŸ¥æ‰¾æ­¥éª¤
              step_pattern="- name: \"$step_num\\. "
              if grep -n "$step_pattern" "$TEMP_WORKFLOW"; then
                echo "  âœ… æ‰¾åˆ°ç°æœ‰æ­¥éª¤ï¼Œå°†è¿›è¡Œæ›¿æ¢"
                # è¿™é‡Œéœ€è¦å®ç°æ›¿æ¢é€»è¾‘
              else
                echo "  ğŸ” æœªæ‰¾åˆ°æ­¥éª¤ $step_numï¼Œå°è¯•æŸ¥æ‰¾è¿‘ä¼¼ä½ç½®"
                
                # å°è¯•æ’å…¥åˆ°åˆé€‚ä½ç½®
                if [[ $step_num -lt 22 ]]; then
                  echo "  â• å°†åœ¨æ­¥éª¤21ä¹‹åæ’å…¥æ–°æ­¥éª¤"
                  # è¿™é‡Œéœ€è¦å®ç°æ’å…¥é€»è¾‘
                elif [[ $step_num -gt 22 ]]; then
                  echo "  â• å°†åœ¨æ­¥éª¤22ä¹‹åæ’å…¥æ–°æ­¥éª¤"
                  # è¿™é‡Œéœ€è¦å®ç°æ’å…¥é€»è¾‘
                fi
              fi
            elif echo "$identifier" | grep -q "æ–°æ­¥éª¤"; then
              echo "  â• æ–°æ­¥éª¤æ·»åŠ "
              # è¿™é‡Œéœ€è¦å®ç°æ–°æ­¥éª¤æ·»åŠ é€»è¾‘
            fi
            
            # æ˜¾ç¤ºä¿®å¤å†…å®¹é¢„è§ˆ
            echo "  ğŸ“‹ ä¿®å¤å†…å®¹é¢„è§ˆ:"
            head -5 "tmp_fixes/workflow_fix.txt" | sed 's/^/    /'
            echo ""
          done
          
          # å¦‚æœæ˜¯dry runï¼Œä¸å®é™…ä¿®æ”¹
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ” Dry runæ¨¡å¼ - æ˜¾ç¤ºä¿®æ”¹è®¡åˆ’"
            echo "ğŸ“Š å°†ä¿®æ”¹ä»¥ä¸‹å†…å®¹:"
            diff -u "$TARGET_WORKFLOW" "$TEMP_WORKFLOW" | head -50 || true
          else
            # å®é™…åº”ç”¨ä¿®æ”¹
            mv "$TEMP_WORKFLOW" "$TARGET_WORKFLOW"
            echo "âœ… å·²åº”ç”¨ä¿®å¤åˆ°: $TARGET_WORKFLOW"
          fi
          
      - name: Generate fix report
        run: |
          echo "=== ä¿®å¤æŠ¥å‘Š ==="
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          
          echo "ğŸ“Š ä¿®å¤å¤„ç†æ‘˜è¦:"
          echo "  - è§£æçš„æ ‡è¯†æ•°é‡: ${{ steps.parse_fixes.outputs.IDENTIFIERS_COUNT }}"
          echo "  - è„šæœ¬ä¿®å¤æ•°é‡: ${{ steps.parse_fixes.outputs.SCRIPT_FIXES_COUNT }}"
          echo "  - å·¥ä½œæµä¿®å¤æ•°é‡: ${{ steps.parse_fixes.outputs.WORKFLOW_FIXES_COUNT }}"
          echo ""
          
          # æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶
          echo "ğŸ“ å¤‡ä»½æ–‡ä»¶:"
          ls -la backup_files/ 2>/dev/null || echo "  æ— å¤‡ä»½æ–‡ä»¶"
          echo ""
          
          # æ˜¾ç¤ºä¸´æ—¶æ–‡ä»¶
          echo "ğŸ“ ä¸´æ—¶æ–‡ä»¶:"
          ls -la tmp_fixes/ 2>/dev/null || echo "  æ— ä¸´æ—¶æ–‡ä»¶"
          
      - name: Cleanup temporary files
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf tmp_fixes
          
      - name: Create summary
        if: always()
        run: |
          echo "### è‡ªåŠ¨ä¿®å¤å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**çŠ¶æ€:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å¤„ç†æ‘˜è¦:**" >> $GITHUB_STEP_SUMMARY
          echo "- è§£æä¿®å¤æ ‡è¯†: ${{ steps.parse_fixes.outputs.IDENTIFIERS_COUNT }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- è„šæœ¬ä¿®å¤: ${{ steps.parse_fixes.outputs.SCRIPT_FIXES_COUNT }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- å·¥ä½œæµä¿®å¤: ${{ steps.parse_fixes.outputs.WORKFLOW_FIXES_COUNT }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "**æ¨¡å¼:** ğŸŸ¡ Dry Run (åªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ­¤è¿è¡Œä»…æ˜¾ç¤ºä¿®æ”¹è®¡åˆ’ï¼Œæœªå®é™…ä¿®æ”¹æ–‡ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "**æ¨¡å¼:** ğŸŸ¢ å®é™…ä¿®å¤" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ–‡ä»¶å·²æ ¹æ®ä¿®å¤æ–¹æ¡ˆè¿›è¡Œæ›´æ–°ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Commit changes (if not dry run)
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == false
        run: |
          echo "=== æäº¤æ›´æ”¹ ==="
          
          # é…ç½®git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet; then
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
            
            # æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶
            git add firmware-config/scripts/build_firmware_main.sh .github/workflows/firmware-build.yml
            
            # æäº¤
            git commit -m "ğŸ”§ è‡ªåŠ¨ä¿®å¤: æ ¹æ® fix.txt æ›´æ–°æ–‡ä»¶ [skip ci]"
            
            # æ¨é€
            git push
            echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
          fi
