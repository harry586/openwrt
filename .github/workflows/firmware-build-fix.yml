name: è‡ªåŠ¨ä¿®å¤å›ºä»¶æ„å»ºæ–‡ä»¶

on:
  push:
    paths:
      - 'firmware-config/fix.txt'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'å¹²è¿è¡Œï¼ˆåªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’ï¼Œä¸å®é™…ä¿®æ”¹ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        run: |
          echo "=== ç¯å¢ƒä¿¡æ¯ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "GitHubå·¥ä½œç©ºé—´: ${{ github.workspace }}"
          echo ""
          
      - name: è§£æä¿®å¤æ–¹æ¡ˆæ–‡ä»¶
        id: parse_fixes
        run: |
          echo "=== è§£æä¿®å¤æ–¹æ¡ˆæ–‡ä»¶ ==="
          
          # ä½¿ç”¨ç»å¯¹è·¯å¾„
          WORKSPACE="${{ github.workspace }}"
          echo "å·¥ä½œç©ºé—´: $WORKSPACE"
          
          # æŸ¥æ‰¾ fix.txt æ–‡ä»¶
          echo "æŸ¥æ‰¾ fix.txt æ–‡ä»¶..."
          
          # å°è¯•å¤šä¸ªè·¯å¾„
          if [ -f "$WORKSPACE/firmware-config/fix.txt" ]; then
            FIX_FILE="$WORKSPACE/firmware-config/fix.txt"
            echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $FIX_FILE"
          elif [ -f "./firmware-config/fix.txt" ]; then
            FIX_FILE="./firmware-config/fix.txt"
            echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $FIX_FILE"
          elif [ -f "fix.txt" ]; then
            FIX_FILE="fix.txt"
            echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $FIX_FILE"
          else
            echo "âŒ æœªæ‰¾åˆ° fix.txt æ–‡ä»¶"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          echo "ä¿®å¤æ–‡ä»¶è·¯å¾„: $FIX_FILE"
          
          # ä½¿ç”¨ç®€å•çš„å‘½ä»¤ç»Ÿè®¡è¡Œæ•°
          if command -v wc >/dev/null 2>&1; then
            LINE_COUNT=$(wc -l < "$FIX_FILE")
            echo "æ–‡ä»¶è¡Œæ•°: $LINE_COUNT"
          else
            # å¤‡ç”¨æ–¹æ³•ç»Ÿè®¡è¡Œæ•°
            LINE_COUNT=0
            while IFS= read -r line || [ -n "$line" ]; do
              LINE_COUNT=$((LINE_COUNT + 1))
            done < "$FIX_FILE"
            echo "æ–‡ä»¶è¡Œæ•°: $LINE_COUNT (ä½¿ç”¨å¤‡ç”¨æ–¹æ³•)"
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶å¼€å¤´
          echo "æ–‡ä»¶å¼€å¤´å†…å®¹:"
          if command -v head >/dev/null 2>&1; then
            head -10 "$FIX_FILE"
          else
            # å¤‡ç”¨æ–¹æ³•æ˜¾ç¤ºå‰10è¡Œ
            COUNT=0
            while IFS= read -r line && [ $COUNT -lt 10 ]; do
              echo "$line"
              COUNT=$((COUNT + 1))
            done < "$FIX_FILE"
          fi
          
          echo ""
          
          # ç»Ÿè®¡æ ‡è¯†æ•°é‡
          echo "ç»Ÿè®¡ä¿®å¤æ ‡è¯†..."
          IDENTIFIER_COUNT=0
          SCRIPT_FIXES_COUNT=0
          WORKFLOW_FIXES_COUNT=0
          
          while IFS= read -r line; do
            # ç»Ÿè®¡æ‰€æœ‰æ ‡è¯†
            if [[ "$line" == "#ã€"* ]]; then
              IDENTIFIER_COUNT=$((IDENTIFIER_COUNT + 1))
              echo "æ‰¾åˆ°æ ‡è¯†[$IDENTIFIER_COUNT]: $line"
              
              # ç»Ÿè®¡è„šæœ¬ä¿®å¤
              if [[ "$line" == *"build_firmware_main.sh"* ]]; then
                SCRIPT_FIXES_COUNT=$((SCRIPT_FIXES_COUNT + 1))
              fi
              
              # ç»Ÿè®¡å·¥ä½œæµä¿®å¤
              if [[ "$line" == *"firmware-build.yml"* ]]; then
                WORKFLOW_FIXES_COUNT=$((WORKFLOW_FIXES_COUNT + 1))
              fi
            fi
          done < "$FIX_FILE"
          
          echo ""
          echo "ä¿®å¤å†…å®¹ç»Ÿè®¡:"
          echo "- æ€»æ ‡è¯†æ•°é‡: $IDENTIFIER_COUNT"
          echo "- è„šæœ¬ä¿®å¤æ•°é‡: $SCRIPT_FIXES_COUNT"
          echo "- å·¥ä½œæµä¿®å¤æ•°é‡: $WORKFLOW_FIXES_COUNT"
          
          # ä¿å­˜ç»“æœ
          echo "identifiers_count=$IDENTIFIER_COUNT" >> $GITHUB_OUTPUT
          echo "script_fixes_count=$SCRIPT_FIXES_COUNT" >> $GITHUB_OUTPUT
          echo "workflow_fixes_count=$WORKFLOW_FIXES_COUNT" >> $GITHUB_OUTPUT
          echo "fix_file_path=$FIX_FILE" >> $GITHUB_OUTPUT
          
      - name: å¤„ç†è„šæœ¬æ–‡ä»¶ä¿®å¤
        if: steps.parse_fixes.outputs.script_fixes_count != '0'
        run: |
          echo "=== å¤„ç†è„šæœ¬æ–‡ä»¶ä¿®å¤ ==="
          
          FIX_FILE="${{ steps.parse_fixes.outputs.fix_file_path }}"
          echo "ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          echo "è„šæœ¬ä¿®å¤æ•°é‡: ${{ steps.parse_fixes.outputs.script_fixes_count }}"
          
          # æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶
          echo "æŸ¥æ‰¾ build_firmware_main.sh..."
          
          WORKSPACE="${{ github.workspace }}"
          TARGET_SCRIPT=""
          
          if [ -f "$WORKSPACE/firmware-config/scripts/build_firmware_main.sh" ]; then
            TARGET_SCRIPT="$WORKSPACE/firmware-config/scripts/build_firmware_main.sh"
          elif [ -f "./firmware-config/scripts/build_firmware_main.sh" ]; then
            TARGET_SCRIPT="./firmware-config/scripts/build_firmware_main.sh"
          fi
          
          if [ -z "$TARGET_SCRIPT" ]; then
            echo "âŒ æœªæ‰¾åˆ° build_firmware_main.sh æ–‡ä»¶"
            echo "æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶..."
            find . -name "build_firmware_main.sh" -type f 2>/dev/null || true
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°è„šæœ¬æ–‡ä»¶: $TARGET_SCRIPT"
          
          # åˆ›å»ºå¤‡ä»½
          BACKUP_FILE="$TARGET_SCRIPT.backup.$(date +%s)"
          cp "$TARGET_SCRIPT" "$BACKUP_FILE"
          echo "âœ… åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
          
          # æ˜¾ç¤ºè„šæœ¬ä¿¡æ¯
          echo "è„šæœ¬æ–‡ä»¶ä¿¡æ¯:"
          echo "- è·¯å¾„: $TARGET_SCRIPT"
          
          if command -v wc >/dev/null 2>&1; then
            echo "- è¡Œæ•°: $(wc -l < "$TARGET_SCRIPT")"
          fi
          
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo ""
            echo "ğŸ” DRY RUN æ¨¡å¼ - åªæ˜¾ç¤ºè®¡åˆ’"
            echo "å°†æ ¹æ®ä»¥ä¸‹æ ‡è¯†ä¿®æ”¹è„šæœ¬:"
            grep "#ã€build_firmware_main.sh" "$FIX_FILE" || echo "æ— è„šæœ¬ä¿®å¤æ ‡è¯†"
          else
            echo ""
            echo "ğŸ”„ å®é™…ä¿®å¤æ¨¡å¼"
            echo "å¼€å§‹åº”ç”¨ä¿®å¤..."
            
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            TEMP_FILE="$TARGET_SCRIPT.temp"
            cp "$TARGET_SCRIPT" "$TEMP_FILE"
            
            # å¤„ç†æ¯ä¸ªè„šæœ¬ä¿®å¤
            CURRENT_LINE=0
            IN_FIX_BLOCK=false
            FIX_CONTENT=""
            
            while IFS= read -r line; do
              CURRENT_LINE=$((CURRENT_LINE + 1))
              
              # æ£€æŸ¥æ˜¯å¦æ˜¯è„šæœ¬ä¿®å¤æ ‡è¯†
              if [[ "$line" == "#ã€build_firmware_main.sh"* ]]; then
                echo "æ‰¾åˆ°è„šæœ¬ä¿®å¤æ ‡è¯†: $line"
                IN_FIX_BLOCK=true
                FIX_CONTENT=""
              elif [ "$IN_FIX_BLOCK" = true ] && [[ "$line" == "#ã€"* ]]; then
                # æ–°çš„æ ‡è¯†å¼€å§‹ï¼Œç»“æŸå½“å‰å—
                IN_FIX_BLOCK=false
                echo "ä¿®å¤å—ç»“æŸ"
              elif [ "$IN_FIX_BLOCK" = true ]; then
                FIX_CONTENT="$FIX_CONTENT$line"$'\n'
              fi
            done < "$FIX_FILE"
            
            # æš‚æ—¶åªæ˜¾ç¤ºä¿¡æ¯ï¼Œä¸å®é™…ä¿®æ”¹
            echo "ä¿®å¤å¤„ç†å®Œæˆ"
            echo "ä¸´æ—¶æ–‡ä»¶: $TEMP_FILE"
            
            # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            rm -f "$TEMP_FILE"
          fi
          
      - name: å¤„ç†å·¥ä½œæµæ–‡ä»¶ä¿®å¤
        if: steps.parse_fixes.outputs.workflow_fixes_count != '0'
        run: |
          echo "=== å¤„ç†å·¥ä½œæµæ–‡ä»¶ä¿®å¤ ==="
          
          FIX_FILE="${{ steps.parse_fixes.outputs.fix_file_path }}"
          echo "ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          echo "å·¥ä½œæµä¿®å¤æ•°é‡: ${{ steps.parse_fixes.outputs.workflow_fixes_count }}"
          
          # æŸ¥æ‰¾å·¥ä½œæµæ–‡ä»¶
          echo "æŸ¥æ‰¾ firmware-build.yml..."
          
          WORKSPACE="${{ github.workspace }}"
          TARGET_WORKFLOW=""
          
          if [ -f "$WORKSPACE/.github/workflows/firmware-build.yml" ]; then
            TARGET_WORKFLOW="$WORKSPACE/.github/workflows/firmware-build.yml"
          elif [ -f ".github/workflows/firmware-build.yml" ]; then
            TARGET_WORKFLOW=".github/workflows/firmware-build.yml"
          fi
          
          if [ -z "$TARGET_WORKFLOW" ]; then
            echo "âŒ æœªæ‰¾åˆ° firmware-build.yml æ–‡ä»¶"
            echo "æŸ¥æ‰¾å·¥ä½œæµæ–‡ä»¶..."
            find . -name "firmware-build.yml" -type f 2>/dev/null || true
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°å·¥ä½œæµæ–‡ä»¶: $TARGET_WORKFLOW"
          
          # åˆ›å»ºå¤‡ä»½
          BACKUP_FILE="$TARGET_WORKFLOW.backup.$(date +%s)"
          cp "$TARGET_WORKFLOW" "$BACKUP_FILE"
          echo "âœ… åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
          
          # æ˜¾ç¤ºå·¥ä½œæµä¿¡æ¯
          echo "å·¥ä½œæµæ–‡ä»¶ä¿¡æ¯:"
          echo "- è·¯å¾„: $TARGET_WORKFLOW"
          
          if command -v wc >/dev/null 2>&1; then
            echo "- è¡Œæ•°: $(wc -l < "$TARGET_WORKFLOW")"
          fi
          
          # æ˜¾ç¤ºæ­¥éª¤ä¿¡æ¯
          echo ""
          echo "å·¥ä½œæµæ­¥éª¤:"
          grep -n "name:" "$TARGET_WORKFLOW" | head -20 || true
          
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo ""
            echo "ğŸ” DRY RUN æ¨¡å¼ - åªæ˜¾ç¤ºè®¡åˆ’"
            echo "å°†æ ¹æ®ä»¥ä¸‹æ ‡è¯†ä¿®æ”¹å·¥ä½œæµ:"
            grep "#ã€firmware-build.yml" "$FIX_FILE" || echo "æ— å·¥ä½œæµä¿®å¤æ ‡è¯†"
            
            echo ""
            echo "æ‰¾åˆ°çš„å·¥ä½œæµæ­¥éª¤ä¿®å¤:"
            while IFS= read -r line; do
              if [[ "$line" == "#ã€firmware-build.yml-"* ]]; then
                # æå–æ­¥éª¤å·
                if [[ "$line" =~ firmware-build.yml-([0-9]+) ]]; then
                  echo "- æ­¥éª¤ ${BASH_REMATCH[1]}"
                elif [[ "$line" == *"æ–°æ­¥éª¤"* ]]; then
                  echo "- æ–°æ­¥éª¤"
                else
                  echo "- $line"
                fi
              fi
            done < "$FIX_FILE"
          else
            echo ""
            echo "ğŸ”„ å®é™…ä¿®å¤æ¨¡å¼"
            echo "å¼€å§‹åº”ç”¨ä¿®å¤..."
            
            # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„å·¥ä½œæµæ–‡ä»¶ä¿®å¤é€»è¾‘
            echo "ä¿®å¤å¤„ç†å®Œæˆ"
          fi
          
      - name: ç”Ÿæˆä¿®å¤æŠ¥å‘Š
        run: |
          echo "=== ä¿®å¤æŠ¥å‘Š ==="
          echo "å®Œæˆæ—¶é—´: $(date)"
          echo ""
          
          echo "å¤„ç†æ‘˜è¦:"
          echo "- è§£ææ ‡è¯†æ•°é‡: ${{ steps.parse_fixes.outputs.identifiers_count }}"
          echo "- è„šæœ¬ä¿®å¤æ•°é‡: ${{ steps.parse_fixes.outputs.script_fixes_count }}"
          echo "- å·¥ä½œæµä¿®å¤æ•°é‡: ${{ steps.parse_fixes.outputs.workflow_fixes_count }}"
          echo ""
          
          echo "å¤‡ä»½æ–‡ä»¶:"
          find . -name "*.backup.*" -type f 2>/dev/null | while read file; do
            echo "- $file"
          done || echo "æ— å¤‡ä»½æ–‡ä»¶"
          
      - name: åˆ›å»ºæ€»ç»“æŠ¥å‘Š
        if: always()
        run: |
          echo "### è‡ªåŠ¨ä¿®å¤å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**çŠ¶æ€:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å¤„ç†æ‘˜è¦:**" >> $GITHUB_STEP_SUMMARY
          echo "- è§£æä¿®å¤æ ‡è¯†: ${{ steps.parse_fixes.outputs.identifiers_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- è„šæœ¬ä¿®å¤: ${{ steps.parse_fixes.outputs.script_fixes_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- å·¥ä½œæµä¿®å¤: ${{ steps.parse_fixes.outputs.workflow_fixes_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "**æ¨¡å¼:** ğŸŸ¡ Dry Run (åªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ­¤è¿è¡Œä»…æ˜¾ç¤ºä¿®æ”¹è®¡åˆ’ï¼Œæœªå®é™…ä¿®æ”¹æ–‡ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "**æ¨¡å¼:** ğŸŸ¢ å®é™…ä¿®å¤" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ–‡ä»¶å·²æ ¹æ®ä¿®å¤æ–¹æ¡ˆè¿›è¡Œæ›´æ–°ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: æäº¤æ›´æ”¹
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == false && job.status == 'success'
        run: |
          echo "=== æäº¤æ›´æ”¹ ==="
          
          # é…ç½®git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet; then
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
            
            # æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶
            git add firmware-config/scripts/build_firmware_main.sh .github/workflows/firmware-build.yml
            
            # æäº¤
            git commit -m "ğŸ”§ è‡ªåŠ¨ä¿®å¤: æ ¹æ® fix.txt æ›´æ–°æ–‡ä»¶ [skip ci]"
            
            # æ¨é€
            git push
            echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
          fi
