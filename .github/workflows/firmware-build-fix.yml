# .github/workflows/firmware-build-fix.yml
name: è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿæ€§æ ‡è¯†å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      target_files:
        description: "è¦ä¿®å¤çš„ç›®æ ‡æ–‡ä»¶ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰"
        required: false
        default: "all"
        type: string
      dry_run:
        description: "ä»…é¢„è§ˆä¸æ‰§è¡Œä¿®æ”¹"
        required: false
        default: "false"
        type: choice
        options: ["true", "false"]

jobs:
  fix-systematic-ids:
    runs-on: ubuntu-22.04
    steps:
      - name: "1. æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        
      - name: "2. å®‰è£…ä¾èµ–å·¥å…·"
        run: |
          sudo apt-get update
          sudo apt-get install -y tree grep sed awk findutils
          
      - name: "3. è¿è¡Œä¿®æ”¹æ„è§è„šæœ¬"
        run: |
          echo "=== è¿è¡Œä¿®æ”¹æ„è§è„šæœ¬ ==="
          echo "ç›®æ ‡æ–‡ä»¶: ${{ github.event.inputs.target_files }}"
          echo "é¢„è§ˆæ¨¡å¼: ${{ github.event.inputs.dry_run }}"
          
          # åˆ›å»ºä¿®æ”¹æ„è§è„šæœ¬æ–‡ä»¶
          SCRIPT_PATH="/tmp/modification_script.sh"
          echo '#!/bin/bash' > "$SCRIPT_PATH"
          echo '# ä¿®æ”¹æ„è§è„šæœ¬ - è‡ªåŠ¨æ ¹æ®ç³»ç»Ÿæ€§æ ‡è¯†ä¿®å¤æ–‡ä»¶' >> "$SCRIPT_PATH"
          echo '#ã€modification-script-01ã€‘è„šæœ¬å¼€å§‹' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo 'set -e' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo 'TARGET_FILES="$1"' >> "$SCRIPT_PATH"
          echo 'DRY_RUN="$2"' >> "$SCRIPT_PATH"
          echo 'REPO_ROOT="$GITHUB_WORKSPACE"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo 'echo "å½“å‰ç›®å½•: $(pwd)"' >> "$SCRIPT_PATH"
          echo 'echo "ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '#ã€modification-script-02ã€‘å‡½æ•°å®šä¹‰å¼€å§‹' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '# æ¨¡ç³Šæœç´¢æ–‡ä»¶' >> "$SCRIPT_PATH"
          echo 'fuzzy_find_file() {' >> "$SCRIPT_PATH"
          echo '  local pattern="$1"' >> "$SCRIPT_PATH"
          echo '  local search_dir="${2:-.}"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local found_files=""' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  if [ -f "$pattern" ]; then' >> "$SCRIPT_PATH"
          echo '    echo "$pattern"' >> "$SCRIPT_PATH"
          echo '    return 0' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  found_files=$(find "$search_dir" -type f -name "*$(basename "$pattern")*" 2>/dev/null | head -5)' >> "$SCRIPT_PATH"
          echo '  if [ -n "$found_files" ]; then' >> "$SCRIPT_PATH"
          echo '    echo "$found_files" | head -1' >> "$SCRIPT_PATH"
          echo '    return 0' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  found_files=$(find "$search_dir" -type f -exec grep -l "#ã€$pattern" {} \; 2>/dev/null | head -5)' >> "$SCRIPT_PATH"
          echo '  if [ -n "$found_files" ]; then' >> "$SCRIPT_PATH"
          echo '    echo "$found_files" | head -1' >> "$SCRIPT_PATH"
          echo '    return 0' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  found_files=$(find "$search_dir" -type f -exec grep -l "$(echo "$pattern" | sed '"'"'s/\./\\./g'"'"')" {} \; 2>/dev/null | head -5)' >> "$SCRIPT_PATH"
          echo '  if [ -n "$found_files" ]; then' >> "$SCRIPT_PATH"
          echo '    echo "$found_files" | head -1' >> "$SCRIPT_PATH"
          echo '    return 0' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  echo ""' >> "$SCRIPT_PATH"
          echo '  return 1' >> "$SCRIPT_PATH"
          echo '}' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '# æå–æ–‡ä»¶åå‰ç¼€' >> "$SCRIPT_PATH"
          echo 'extract_file_prefix() {' >> "$SCRIPT_PATH"
          echo '  local file_path="$1"' >> "$SCRIPT_PATH"
          echo '  local filename=$(basename "$file_path")' >> "$SCRIPT_PATH"
          echo '  echo "${filename%.*}" | sed '"'"'s/[^a-zA-Z0-9_-]//g'"'"'' >> "$SCRIPT_PATH"
          echo '}' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '# ä¿®å¤å•ä¸ªæ–‡ä»¶çš„ç³»ç»Ÿæ€§æ ‡è¯†' >> "$SCRIPT_PATH"
          echo 'fix_systematic_ids_in_file() {' >> "$SCRIPT_PATH"
          echo '  local file_path="$1"' >> "$SCRIPT_PATH"
          echo '  local dry_run="$2"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  echo ""' >> "$SCRIPT_PATH"
          echo '  echo "=== å¤„ç†æ–‡ä»¶: $file_path ==="' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  if [ ! -f "$file_path" ]; then' >> "$SCRIPT_PATH"
          echo '    echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file_path"' >> "$SCRIPT_PATH"
          echo '    return 1' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local file_prefix=$(extract_file_prefix "$file_path")' >> "$SCRIPT_PATH"
          echo '  echo "æ–‡ä»¶å‰ç¼€: $file_prefix"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local backup_file="${file_path}.backup_$(date +%Y%m%d_%H%M%S)"' >> "$SCRIPT_PATH"
          echo '  cp "$file_path" "$backup_file"' >> "$SCRIPT_PATH"
          echo '  echo "âœ… å¤‡ä»½æ–‡ä»¶: $backup_file"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local total_lines=$(wc -l < "$file_path")' >> "$SCRIPT_PATH"
          echo '  echo "æ–‡ä»¶è¡Œæ•°: $total_lines"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local existing_ids=$(grep -n "#ã€" "$file_path" | head -10)' >> "$SCRIPT_PATH"
          echo '  if [ -n "$existing_ids" ]; then' >> "$SCRIPT_PATH"
          echo '    echo "ğŸ“‹ ç°æœ‰æ ‡è¯†:"' >> "$SCRIPT_PATH"
          echo '    echo "$existing_ids" | while read line; do' >> "$SCRIPT_PATH"
          echo '      echo "  $line"' >> "$SCRIPT_PATH"
          echo '    done' >> "$SCRIPT_PATH"
          echo '  else' >> "$SCRIPT_PATH"
          echo '    echo "â„¹ï¸ æœªæ‰¾åˆ°ç°æœ‰ç³»ç»Ÿæ€§æ ‡è¯†"' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local needs_fix=false' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  if [[ "$file_path" == *workflow* ]] || [[ "$file_path" == *yml ]] || [[ "$file_path" == *yaml ]]; then' >> "$SCRIPT_PATH"
          echo '    local step_count=$(grep -c "^[[:space:]]*- name:" "$file_path")' >> "$SCRIPT_PATH"
          echo '    local id_count=$(grep -c "#ã€${file_prefix}-" "$file_path")' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '    if [ $step_count -gt 0 ] && [ $id_count -lt $step_count ]; then' >> "$SCRIPT_PATH"
          echo '      needs_fix=true' >> "$SCRIPT_PATH"
          echo '      echo "ğŸ”§ éœ€è¦ä¿®å¤: æœ‰ $step_count ä¸ªæ­¥éª¤ä½†åªæœ‰ $id_count ä¸ªæ ‡è¯†"' >> "$SCRIPT_PATH"
          echo '    fi' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  if [[ "$file_path" == *.sh ]]; then' >> "$SCRIPT_PATH"
          echo '    local section_count=$(grep -c "^# ==" "$file_path")' >> "$SCRIPT_PATH"
          echo '    local id_count=$(grep -c "#ã€${file_prefix}-" "$file_path")' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '    if [ $section_count -gt 0 ] && [ $id_count -lt $section_count ]; then' >> "$SCRIPT_PATH"
          echo '      needs_fix=true' >> "$SCRIPT_PATH"
          echo '      echo "ğŸ”§ éœ€è¦ä¿®å¤: æœ‰ $section_count ä¸ªéƒ¨åˆ†ä½†åªæœ‰ $id_count ä¸ªæ ‡è¯†"' >> "$SCRIPT_PATH"
          echo '    fi' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  if [ "$needs_fix" = "false" ]; then' >> "$SCRIPT_PATH"
          echo '    echo "âœ… æ–‡ä»¶æ ‡è¯†å®Œæ•´ï¼Œæ— éœ€ä¿®å¤"' >> "$SCRIPT_PATH"
          echo '    return 0' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  if [ "$dry_run" = "true" ]; then' >> "$SCRIPT_PATH"
          echo '    echo "ğŸ” é¢„è§ˆæ¨¡å¼ - æ˜¾ç¤ºå»ºè®®çš„ä¿®æ”¹:"' >> "$SCRIPT_PATH"
          echo '    return 0' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  echo "ğŸš€ å¼€å§‹ä¿®å¤ç³»ç»Ÿæ€§æ ‡è¯†..."' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  if [[ "$file_path" == *workflow* ]] || [[ "$file_path" == *yml ]] || [[ "$file_path" == *yaml ]]; then' >> "$SCRIPT_PATH"
          echo '    fix_yaml_file "$file_path" "$file_prefix"' >> "$SCRIPT_PATH"
          echo '  elif [[ "$file_path" == *.sh ]]; then' >> "$SCRIPT_PATH"
          echo '    fix_shell_file "$file_path" "$file_prefix"' >> "$SCRIPT_PATH"
          echo '  else' >> "$SCRIPT_PATH"
          echo '    echo "âš ï¸ æœªçŸ¥æ–‡ä»¶ç±»å‹ï¼Œä½¿ç”¨é€šç”¨ä¿®å¤"' >> "$SCRIPT_PATH"
          echo '    fix_generic_file "$file_path" "$file_prefix"' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local new_id_count=$(grep -c "#ã€${file_prefix}-" "$file_path")' >> "$SCRIPT_PATH"
          echo '  echo "âœ… ä¿®å¤å®Œæˆï¼Œç°æœ‰æ ‡è¯†æ•°: $new_id_count"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  echo "ğŸ“Š æ–‡ä»¶å·®å¼‚æ‘˜è¦:"' >> "$SCRIPT_PATH"
          echo '  diff -u "$backup_file" "$file_path" | head -20 || true' >> "$SCRIPT_PATH"
          echo '}' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '# ä¿®å¤YAMLæ–‡ä»¶' >> "$SCRIPT_PATH"
          echo 'fix_yaml_file() {' >> "$SCRIPT_PATH"
          echo '  local file_path="$1"' >> "$SCRIPT_PATH"
          echo '  local prefix="$2"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local temp_file="${file_path}.tmp"' >> "$SCRIPT_PATH"
          echo '  cp "$file_path" "$temp_file"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local step_number=0' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  while IFS= read -r line; do' >> "$SCRIPT_PATH"
          echo '    if [[ "$line" =~ ^[[:space:]]*-[[:space:]]*name:[[:space:]]*[\"'"'"'0-9] ]]; then' >> "$SCRIPT_PATH"
          echo '      step_number=$((step_number + 1))' >> "$SCRIPT_PATH"
          echo '      printf "      #ã€%s-%02dã€‘\n" "$prefix" "$step_number" >> "$file_path.new"' >> "$SCRIPT_PATH"
          echo '    fi' >> "$SCRIPT_PATH"
          echo '    echo "$line" >> "$file_path.new"' >> "$SCRIPT_PATH"
          echo '  done < "$temp_file"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  mv "$file_path.new" "$file_path"' >> "$SCRIPT_PATH"
          echo '  rm -f "$temp_file"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  echo "âœ… æ·»åŠ äº† $step_number ä¸ªæ­¥éª¤æ ‡è¯†"' >> "$SCRIPT_PATH"
          echo '}' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '# ä¿®å¤Shellæ–‡ä»¶' >> "$SCRIPT_PATH"
          echo 'fix_shell_file() {' >> "$SCRIPT_PATH"
          echo '  local file_path="$1"' >> "$SCRIPT_PATH"
          echo '  local prefix="$2"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local temp_file="${file_path}.tmp"' >> "$SCRIPT_PATH"
          echo '  cp "$file_path" "$temp_file"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local section_number=0' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  while IFS= read -r line; do' >> "$SCRIPT_PATH"
          echo '    if [[ "$line" =~ ^#[[:space:]]*={10,} ]] || [[ "$line" =~ ^#[[:space:]]*-{10,} ]]; then' >> "$SCRIPT_PATH"
          echo '      section_number=$((section_number + 1))' >> "$SCRIPT_PATH"
          echo '      printf "#ã€%s-%02dã€‘%s\n" "$prefix" "$section_number" "${line#\#}" >> "$file_path.new"' >> "$SCRIPT_PATH"
          echo '      continue' >> "$SCRIPT_PATH"
          echo '    fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '    if [[ "$line" =~ ^[a-zA-Z_][a-zA-Z0-9_]*\(\)[[:space:]]*\{?$ ]] || [[ "$line" =~ ^function[[:space:]]+[a-zA-Z_][a-zA-Z0-9_]* ]]; then' >> "$SCRIPT_PATH"
          echo '      section_number=$((section_number + 1))' >> "$SCRIPT_PATH"
          echo '      printf "#ã€%s-%02dã€‘%s\n" "$prefix" "$section_number" "$line" >> "$file_path.new"' >> "$SCRIPT_PATH"
          echo '      echo "$line" >> "$file_path.new"' >> "$SCRIPT_PATH"
          echo '      continue' >> "$SCRIPT_PATH"
          echo '    fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '    echo "$line" >> "$file_path.new"' >> "$SCRIPT_PATH"
          echo '  done < "$temp_file"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  mv "$file_path.new" "$file_path"' >> "$SCRIPT_PATH"
          echo '  rm -f "$temp_file"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  echo "âœ… æ·»åŠ äº† $section_number ä¸ªç« èŠ‚æ ‡è¯†"' >> "$SCRIPT_PATH"
          echo '}' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '# é€šç”¨æ–‡ä»¶ä¿®å¤' >> "$SCRIPT_PATH"
          echo 'fix_generic_file() {' >> "$SCRIPT_PATH"
          echo '  local file_path="$1"' >> "$SCRIPT_PATH"
          echo '  local prefix="$2"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  echo "âš ï¸ é€šç”¨ä¿®å¤æœªå®ç°"' >> "$SCRIPT_PATH"
          echo '}' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '#ã€modification-script-03ã€‘ä¸»é€»è¾‘å¼€å§‹' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo 'main() {' >> "$SCRIPT_PATH"
          echo '  echo "=== å¼€å§‹å¤„ç†æ–‡ä»¶ ==="' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local files_to_process=""' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  if [ "$TARGET_FILES" = "all" ] || [ -z "$TARGET_FILES" ]; then' >> "$SCRIPT_PATH"
          echo '    echo "ğŸ” æœç´¢æ‰€æœ‰åŒ…å«ç³»ç»Ÿæ€§æ ‡è¯†çš„æ–‡ä»¶..."' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '    files_to_process=$(find "$REPO_ROOT" -type f \( -name "*.yml" -o -name "*.yaml" -o -name "*.sh" -o -name "*.md" \) -exec grep -l "#ã€" {} \; 2>/dev/null | sort | uniq)' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '    known_files=".github/workflows/firmware-build.yml firmware-config/scripts/build_firmware_main.sh firmware-config/support.sh"' >> "$SCRIPT_PATH"
          echo '    for known_file in $known_files; do' >> "$SCRIPT_PATH"
          echo '      if [ -f "$REPO_ROOT/$known_file" ] && ! echo "$files_to_process" | grep -q "$known_file"; then' >> "$SCRIPT_PATH"
          echo '        files_to_process="$files_to_process' >> "$SCRIPT_PATH"
          echo '$REPO_ROOT/$known_file"' >> "$SCRIPT_PATH"
          echo '      fi' >> "$SCRIPT_PATH"
          echo '    done' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  else' >> "$SCRIPT_PATH"
          echo '    IFS=','"'"' read -ra file_list <<< "$TARGET_FILES"' >> "$SCRIPT_PATH"
          echo '    for file_pattern in "${file_list[@]}"; do' >> "$SCRIPT_PATH"
          echo '      found_file=$(fuzzy_find_file "$file_pattern" "$REPO_ROOT")' >> "$SCRIPT_PATH"
          echo '      if [ -n "$found_file" ]; then' >> "$SCRIPT_PATH"
          echo '        files_to_process="$files_to_process' >> "$SCRIPT_PATH"
          echo '$found_file"' >> "$SCRIPT_PATH"
          echo '      else' >> "$SCRIPT_PATH"
          echo '        echo "âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶: $file_pattern"' >> "$SCRIPT_PATH"
          echo '      fi' >> "$SCRIPT_PATH"
          echo '    done' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  files_to_process=$(echo "$files_to_process" | sed '"'"'/^$/d'"'"' | sort | uniq)' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local file_count=$(echo "$files_to_process" | wc -l)' >> "$SCRIPT_PATH"
          echo '  echo "ğŸ“Š æ‰¾åˆ° $file_count ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  if [ $file_count -eq 0 ]; then' >> "$SCRIPT_PATH"
          echo '    echo "âœ… æ²¡æœ‰æ‰¾åˆ°éœ€è¦å¤„ç†çš„æ–‡ä»¶"' >> "$SCRIPT_PATH"
          echo '    return 0' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  local processed=0' >> "$SCRIPT_PATH"
          echo '  local skipped=0' >> "$SCRIPT_PATH"
          echo '  local failed=0' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  echo "$files_to_process" | while read file_path; do' >> "$SCRIPT_PATH"
          echo '    if [ -n "$file_path" ] && [ -f "$file_path" ]; then' >> "$SCRIPT_PATH"
          echo '      if fix_systematic_ids_in_file "$file_path" "$DRY_RUN"; then' >> "$SCRIPT_PATH"
          echo '        processed=$((processed + 1))' >> "$SCRIPT_PATH"
          echo '      else' >> "$SCRIPT_PATH"
          echo '        failed=$((failed + 1))' >> "$SCRIPT_PATH"
          echo '      fi' >> "$SCRIPT_PATH"
          echo '    else' >> "$SCRIPT_PATH"
          echo '      skipped=$((skipped + 1))' >> "$SCRIPT_PATH"
          echo '    fi' >> "$SCRIPT_PATH"
          echo '  done' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  echo ""' >> "$SCRIPT_PATH"
          echo '  echo "=== å¤„ç†ç»“æœ ==="' >> "$SCRIPT_PATH"
          echo '  echo "âœ… æˆåŠŸå¤„ç†: $processed ä¸ªæ–‡ä»¶"' >> "$SCRIPT_PATH"
          echo '  echo "âš ï¸ è·³è¿‡å¤„ç†: $skipped ä¸ªæ–‡ä»¶"' >> "$SCRIPT_PATH"
          echo '  echo "âŒ å¤„ç†å¤±è´¥: $failed ä¸ªæ–‡ä»¶"' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  if [ "$DRY_RUN" = "true" ]; then' >> "$SCRIPT_PATH"
          echo '    echo ""' >> "$SCRIPT_PATH"
          echo '    echo "ğŸ’¡ è¿™æ˜¯é¢„è§ˆæ¨¡å¼ï¼Œæ²¡æœ‰å®é™…ä¿®æ”¹æ–‡ä»¶"' >> "$SCRIPT_PATH"
          echo '    echo "   è¦å®é™…ä¿®æ”¹ï¼Œè¯·è®¾ç½® dry_run=false"' >> "$SCRIPT_PATH"
          echo '  fi' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '  return $((failed > 0))' >> "$SCRIPT_PATH"
          echo '}' >> "$SCRIPT_PATH"
          echo '' >> "$SCRIPT_PATH"
          echo '# è¿è¡Œä¸»å‡½æ•°' >> "$SCRIPT_PATH"
          echo 'main' >> "$SCRIPT_PATH"
          
          # ç»™è„šæœ¬æ‰§è¡Œæƒé™
          chmod +x "$SCRIPT_PATH"
          
          # æ‰§è¡Œè„šæœ¬
          "$SCRIPT_PATH" "${{ github.event.inputs.target_files }}" "${{ github.event.inputs.dry_run }}"
          
      - name: "4. ç”Ÿæˆä¿®æ”¹æŠ¥å‘Š"
        if: always()
        run: |
          echo "=== ä¿®æ”¹æŠ¥å‘Š ==="
          echo "ç”Ÿæˆæ—¶é—´: $(date)"
          echo "ä»“åº“: ${{ github.repository }}"
          echo "è§¦å‘è€…: ${{ github.actor }}"
          echo ""
          echo "ğŸ“ ä¿®æ”¹è¿‡çš„æ–‡ä»¶:"
          find . -name "*.backup_*" -type f | while read backup; do
            original_file="${backup%.backup_*}"
            echo "  ğŸ“„ $original_file"
            echo "    å¤‡ä»½: $(basename "$backup")"
          done
          echo ""
          echo "ğŸ” åŒ…å«ç³»ç»Ÿæ€§æ ‡è¯†çš„æ–‡ä»¶ç»Ÿè®¡:"
          find . -type f -exec grep -l "#ã€" {} \; 2>/dev/null | while read file; do
            id_count=$(grep -c "#ã€" "$file")
            echo "  ğŸ“Š $file: $id_count ä¸ªæ ‡è¯†"
          done
          
      - name: "5. æäº¤ä¿®æ”¹"
        if: github.event.inputs.dry_run == 'false' && success()
        run: |
          echo "=== æäº¤ä¿®æ”¹ ==="
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          if git diff --quiet; then
            echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„ä¿®æ”¹"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°ä¿®æ”¹ï¼Œå‡†å¤‡æäº¤..."
            git add -A
            git commit -m "fix: è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿæ€§æ ‡è¯†" -m "è·³è¿‡CIæ£€æŸ¥" -m "ç”±GitHub Actionsè‡ªåŠ¨æ‰§è¡Œ"
            git push
            echo "âœ… ä¿®æ”¹å·²æäº¤å¹¶æ¨é€"
          fi
