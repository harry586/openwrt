name: ðŸ”§ è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ

on:
  # è‡ªåŠ¨è§¦å‘ - ä½¿ç”¨æ›´ç®€å•çš„è·¯å¾„åŒ¹é…
  push:
    paths:
      - 'firmware-config/fix.txt'
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆç›´æŽ¥è‡ªåŠ¨åˆå¹¶ï¼‰
  workflow_dispatch:

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ðŸ›Žï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ” æ£€æŸ¥ä¿®å¤æ–‡ä»¶
        id: check
        run: |
          echo "=== æ£€æŸ¥ä¿®å¤æ–‡ä»¶ ==="
          echo "äº‹ä»¶ç±»åž‹: ${{ github.event_name }}"
          echo "è§¦å‘åˆ†æ”¯: ${{ github.ref }}"
          echo ""
          
          if [ -f "firmware-config/fix.txt" ]; then
            echo "âœ… æ‰¾åˆ°ä¿®å¤æ–‡ä»¶"
            echo "has_fix=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°ä¿®å¤æ–‡ä»¶"
            echo "has_fix=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸŒ¿ åˆ›å»ºä¿®å¤åˆ†æ”¯
        if: steps.check.outputs.has_fix == 'true'
        run: |
          echo "=== åˆ›å»ºä¿®å¤åˆ†æ”¯ ==="
          
          # å”¯ä¸€åˆ†æ”¯å
          BRANCH_NAME="auto-fix-$(date +%s)"
          echo "åˆ†æ”¯å: $BRANCH_NAME"
          
          # åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯
          git checkout -b "$BRANCH_NAME"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: ðŸ“ åº”ç”¨ä¿®å¤
        if: steps.check.outputs.has_fix == 'true'
        run: |
          echo "=== åº”ç”¨ä¿®å¤ ==="
          
          FIX_FILE="firmware-config/fix.txt"
          SCRIPT_FILE="firmware-config/scripts/build_firmware_main.sh"
          
          # 1. ä¿®æ”¹è„šæœ¬æ–‡ä»¶
          if [ -f "$SCRIPT_FILE" ]; then
            echo "ðŸ”§ ä¿®æ”¹è„šæœ¬æ–‡ä»¶..."
            
            # å¤‡ä»½
            cp "$SCRIPT_FILE" "${SCRIPT_FILE}.backup"
            
            # æ·»åŠ ä¿®å¤æ ‡è®°
            echo "" >> "$SCRIPT_FILE"
            echo "# ðŸ”§ è‡ªåŠ¨ä¿®å¤ - $(date)" >> "$SCRIPT_FILE"
            echo "# ä¿®å¤æ–‡ä»¶: $FIX_FILE" >> "$SCRIPT_FILE"
            echo "# æ—¶é—´æˆ³: $(date +%s)" >> "$SCRIPT_FILE"
            
            echo "âœ… è„šæœ¬æ–‡ä»¶å·²ä¿®æ”¹"
          fi
          
          # 2. åˆ›å»ºä¿®å¤æŠ¥å‘Š
          REPORT_FILE="auto-fix-report-$(date +%s).md"
          echo "# ðŸ”§ è‡ªåŠ¨ä¿®å¤æŠ¥å‘Š" > "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**ç”Ÿæˆæ—¶é—´:** $(date)" >> "$REPORT_FILE"
          echo "**ä¿®å¤æ–‡ä»¶:** $FIX_FILE" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## ä¿®å¤å†…å®¹é¢„è§ˆ" >> "$REPORT_FILE"
          echo '```' >> "$REPORT_FILE"
          head -20 "$FIX_FILE" >> "$REPORT_FILE"
          echo '```' >> "$REPORT_FILE"
          
          echo "âœ… åˆ›å»ºæŠ¥å‘Šæ–‡ä»¶: $REPORT_FILE"
      
      - name: ðŸ’¾ æäº¤æ›´æ”¹
        if: steps.check.outputs.has_fix == 'true'
        run: |
          echo "=== æäº¤æ›´æ”¹ ==="
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          echo "ðŸ“Š GitçŠ¶æ€:"
          git status --short
          echo ""
          
          echo "âž• æ·»åŠ æ‰€æœ‰æ›´æ”¹..."
          git add -A
          
          echo "ðŸ’¾ æäº¤..."
          git commit -m "ðŸ”§ è‡ªåŠ¨ä¿®å¤ [skip ci]" || echo "æ²¡æœ‰æ›´æ”¹"
          
          echo "ðŸš€ æŽ¨é€åˆ†æ”¯..."
          git push origin "${{ env.branch_name }}"
          
          echo "âœ… åˆ†æ”¯å·²æŽ¨é€"
      
      - name: ðŸ“¨ åˆ›å»ºå¹¶åˆå¹¶PRï¼ˆä½¿ç”¨GitHub APIï¼‰
        if: steps.check.outputs.has_fix == 'true'
        run: |
          echo "=== åˆ›å»ºå¹¶åˆå¹¶PR ==="
          
          BRANCH_NAME="${{ env.branch_name }}"
          REPO="${{ github.repository }}"
          
          echo "ä»“åº“: $REPO"
          echo "åˆ†æ”¯: $BRANCH_NAME"
          echo ""
          
          # 1. åˆ›å»ºPRï¼ˆä½¿ç”¨GitHub APIï¼‰
          echo "ðŸ“¨ åˆ›å»ºPull Request..."
          
          PR_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/pulls" \
            -d "{
              \"title\": \"ðŸ”§ è‡ªåŠ¨ä¿®å¤\",
              \"body\": \"## è‡ªåŠ¨ä¿®å¤\\n\\nç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºã€‚\\n\\n**åˆ†æ”¯:** $BRANCH_NAME\\n**æ—¶é—´:** $(date)\\n\\n> ðŸ¤– è‡ªåŠ¨åˆå¹¶\",
              \"head\": \"$BRANCH_NAME\",
              \"base\": \"main\"
            }")
          
          echo "APIå“åº”: $PR_RESPONSE"
          
          # æå–PRå·
          PR_NUMBER=$(echo "$PR_RESPONSE" | grep -o '"number":[0-9]*' | cut -d: -f2 | head -1)
          
          if [ -z "$PR_NUMBER" ]; then
            echo "âŒ åˆ›å»ºPRå¤±è´¥"
            echo "å“åº”è¯¦æƒ…:"
            echo "$PR_RESPONSE"
            exit 1
          fi
          
          echo "âœ… PRåˆ›å»ºæˆåŠŸ: #$PR_NUMBER"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_ENV
          
          # 2. ç­‰å¾…ç‰‡åˆ»
          echo "â³ ç­‰å¾…2ç§’..."
          sleep 2
          
          # 3. åˆå¹¶PR
          echo "ðŸ”„ åˆå¹¶PR #$PR_NUMBER..."
          
          MERGE_RESPONSE=$(curl -s -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/merge" \
            -d "{
              \"commit_title\": \"ðŸ”§ è‡ªåŠ¨ä¿®å¤\",
              \"commit_message\": \"è‡ªåŠ¨åˆå¹¶PR #$PR_NUMBER\",
              \"merge_method\": \"squash\"
            }")
          
          echo "åˆå¹¶å“åº”: $MERGE_RESPONSE"
          
          if echo "$MERGE_RESPONSE" | grep -q '"merged":true'; then
            echo "âœ… PRå·²åˆå¹¶"
            echo "pr_merged=true" >> $GITHUB_ENV
          else
            echo "âŒ åˆå¹¶å¤±è´¥"
            echo "å“åº”: $MERGE_RESPONSE"
            echo "pr_merged=false" >> $GITHUB_ENV
          fi
          
          # 4. åˆ é™¤åˆ†æ”¯
          echo "ðŸ—‘ï¸ åˆ é™¤åˆ†æ”¯ $BRANCH_NAME..."
          
          curl -s -X DELETE \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/git/refs/heads/$BRANCH_NAME" 2>/dev/null || true
          
          echo "âœ… æµç¨‹å®Œæˆ"
      
      - name: ðŸ“‹ ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸ”§ è‡ªåŠ¨ä¿®å¤å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**æ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**ä¿®å¤æ–‡ä»¶:** firmware-config/fix.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**åˆ†æ”¯:** ${{ env.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ env.pr_number }}" != "" ]]; then
            echo "âœ… **PRå·²åˆ›å»º:** #${{ env.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **PRåˆ›å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ env.pr_merged }}" == "true" ]]; then
            echo "ðŸ”„ **PRå·²è‡ªåŠ¨åˆå¹¶**" >> $GITHUB_STEP_SUMMARY
            echo "âœ… ä¿®å¤å·²åº”ç”¨åˆ°ä¸»åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ env.pr_merged }}" == "false" ]]; then
            echo "âŒ **PRåˆå¹¶å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "> è¯·æ‰‹åŠ¨å¤„ç†PR" >> $GITHUB_STEP_SUMMARY
          fi
