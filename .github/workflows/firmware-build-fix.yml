name: ğŸ”§ å…¨è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ

on:
  push:
    paths:
      - '**/fix.txt'
      - '**/fix.md'
      - '**/fixes/**'
      - '.github/workflows/auto-fix.yml'
      - '.github/workflows/*-fix.yml'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'å¼ºåˆ¶è¿è¡Œï¼ˆå³ä½¿æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼‰'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'è¯•è¿è¡Œï¼ˆåªæ˜¾ç¤ºè®¡åˆ’ï¼Œä¸å®é™…ä¿®æ”¹ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  auto-fix-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ” æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶ï¼ˆè¯¦ç»†ï¼‰
        id: find_fix
        run: |
          echo "=== ğŸ” æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶ï¼ˆè¯¦ç»†ï¼‰==="
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è§¦å‘åˆ†æ”¯: ${{ github.ref_name }}"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å½“å‰å†…å®¹:"
          ls -la
          
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å¼ºåˆ¶è¿è¡Œ
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.force_run }}" == "true" ]]; then
            echo "âš ï¸  æ‰‹åŠ¨å¼ºåˆ¶è¿è¡Œæ¨¡å¼"
            echo "has_fix_file=true" >> $GITHUB_OUTPUT
            echo "identifier_count=0" >> $GITHUB_OUTPUT
            echo "script_fix_count=0" >> $GITHUB_OUTPUT
            echo "workflow_fix_count=0" >> $GITHUB_OUTPUT
            echo "fix_file=manual_trigger_force" >> $GITHUB_OUTPUT
            echo "âœ… è®¾ç½®å¼ºåˆ¶è¿è¡Œå‚æ•°"
            exit 0
          fi
          
          # æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶
          echo "ğŸ“ æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶..."
          FIND_CMD="find . -type f \( -name 'fix.txt' -o -name 'fix.md' \) -not -path './.git/*' 2>/dev/null | head -5"
          echo "æ‰§è¡Œ: $FIND_CMD"
          FIX_FILES=$(eval $FIND_CMD)
          
          if [ -n "$FIX_FILES" ]; then
            echo "âœ… æ‰¾åˆ°ä¿®å¤æ–‡ä»¶:"
            echo "$FIX_FILES"
            
            # æ˜¾ç¤ºæ¯ä¸ªæ–‡ä»¶å†…å®¹
            for file in $FIX_FILES; do
              echo ""
              echo "ğŸ“„ æ–‡ä»¶: $file"
              echo "å†…å®¹é¢„è§ˆ:"
              head -20 "$file"
              echo "..."
            done
            
            MAIN_FIX_FILE=$(echo "$FIX_FILES" | head -1)
            echo ""
            echo "ğŸ¯ ä¸»ä¿®å¤æ–‡ä»¶: $MAIN_FIX_FILE"
            
            # è¯¦ç»†åˆ†æå†…å®¹
            echo "ğŸ“Š è¯¦ç»†åˆ†æä¿®å¤å†…å®¹..."
            
            # ä½¿ç”¨grepæŸ¥æ‰¾æ‰€æœ‰æ ‡è¯†
            echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰ä¿®å¤æ ‡è¯†:"
            grep -n "^#ã€" "$MAIN_FIX_FILE" || echo "æœªæ‰¾åˆ°ä¿®å¤æ ‡è¯†"
            
            IDENTIFIER_COUNT=$(grep -c "^#ã€" "$MAIN_FIX_FILE" 2>/dev/null || echo "0")
            SCRIPT_FIX_COUNT=$(grep -c "#ã€.*\.sh" "$MAIN_FIX_FILE" 2>/dev/null || echo "0")
            WORKFLOW_FIX_COUNT=$(grep -c "#ã€.*\.yml" "$MAIN_FIX_FILE" 2>/dev/null || echo "0")
            
            echo ""
            echo "ğŸ“ˆ ç»Ÿè®¡ç»“æœ:"
            echo "- ä¿®å¤æ ‡è¯†æ€»æ•°: $IDENTIFIER_COUNT"
            echo "- è„šæœ¬ä¿®å¤æ•°é‡: $SCRIPT_FIX_COUNT"
            echo "- å·¥ä½œæµä¿®å¤æ•°é‡: $WORKFLOW_FIX_COUNT"
            
            # è¾“å‡ºå…·ä½“æ ‡è¯†
            if [ "$IDENTIFIER_COUNT" -gt 0 ]; then
              echo ""
              echo "ğŸ“‹ å…·ä½“æ ‡è¯†åˆ—è¡¨:"
              grep "^#ã€" "$MAIN_FIX_FILE"
            fi
            
            # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
            echo "fix_file=$MAIN_FIX_FILE" >> $GITHUB_OUTPUT
            echo "identifier_count=$IDENTIFIER_COUNT" >> $GITHUB_OUTPUT
            echo "script_fix_count=$SCRIPT_FIX_COUNT" >> $GITHUB_OUTPUT
            echo "workflow_fix_count=$WORKFLOW_FIX_COUNT" >> $GITHUB_OUTPUT
            echo "has_fix_file=true" >> $GITHUB_OUTPUT
            
          else
            echo "âŒ æœªæ‰¾åˆ°ä¿®å¤æ–‡ä»¶"
            
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œåˆ›å»ºæµ‹è¯•æ–‡ä»¶
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              echo "âš ï¸  æ‰‹åŠ¨è§¦å‘ï¼šåˆ›å»ºæµ‹è¯•ä¿®å¤æ–‡ä»¶"
              echo "#ã€test.shã€‘" > test-fix.txt
              echo "echo 'æµ‹è¯•ä¿®å¤ - æ·»åŠ æ­¤è¡Œ'" >> test-fix.txt
              echo "#ã€endã€‘" >> test-fix.txt
              echo "#ã€.github/workflows/test.ymlã€‘" >> test-fix.txt
              echo "# æµ‹è¯•å·¥ä½œæµä¿®å¤" >> test-fix.txt
              echo "#ã€endã€‘" >> test-fix.txt
              
              MAIN_FIX_FILE="test-fix.txt"
              echo "âœ… åˆ›å»ºæµ‹è¯•æ–‡ä»¶: $MAIN_FIX_FILE"
              echo "å†…å®¹:"
              cat "$MAIN_FIX_FILE"
              
              echo "fix_file=$MAIN_FIX_FILE" >> $GITHUB_OUTPUT
              echo "identifier_count=2" >> $GITHUB_OUTPUT
              echo "script_fix_count=1" >> $GITHUB_OUTPUT
              echo "workflow_fix_count=1" >> $GITHUB_OUTPUT
              echo "has_fix_file=true" >> $GITHUB_OUTPUT
            else
              echo "has_fix_file=false" >> $GITHUB_OUTPUT
              echo "âŒ è‡ªåŠ¨è§¦å‘æ¨¡å¼ä¸‹å¿…é¡»æ‰¾åˆ°ä¿®å¤æ–‡ä»¶"
              exit 1
            fi
          fi
      
      - name: ğŸ› ï¸ åº”ç”¨ä¿®å¤ï¼ˆè¯¦ç»†å®ç°ï¼‰
        id: apply_fixes
        run: |
          echo "=== ğŸ› ï¸ åº”ç”¨ä¿®å¤ï¼ˆè¯¦ç»†å®ç°ï¼‰==="
          FIX_FILE="${{ steps.find_fix.outputs.fix_file }}"
          DRY_RUN="${{ inputs.dry_run }}"
          
          echo "ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          echo "DRY RUN æ¨¡å¼: $DRY_RUN"
          echo "è„šæœ¬ä¿®å¤æ•°: ${{ steps.find_fix.outputs.script_fix_count }}"
          echo "å·¥ä½œæµä¿®å¤æ•°: ${{ steps.find_fix.outputs.workflow_fix_count }}"
          
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "ğŸŸ¡ DRY RUN æ¨¡å¼ï¼šåªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’"
            MODE_ICON="ğŸŸ¡"
            MODE_TEXT="DRY RUN"
          else
            echo "ğŸŸ¢ å®é™…ä¿®å¤æ¨¡å¼ï¼šå°†ä¿®æ”¹æ–‡ä»¶"
            MODE_ICON="ğŸŸ¢"
            MODE_TEXT="å®é™…ä¿®å¤"
          fi
          
          # ç”¨äºè®°å½•ä¿®æ”¹çš„æ–‡ä»¶
          MODIFIED_FILES=""
          BACKUP_FILES=""
          
          # å¦‚æœæ˜¯å¼ºåˆ¶è¿è¡Œä¸”æ²¡æœ‰ä¿®å¤æ–‡ä»¶ï¼Œåˆ›å»ºæµ‹è¯•ä¿®æ”¹
          if [[ "$FIX_FILE" == "manual_trigger_force" ]]; then
            echo "ğŸ”§ å¼ºåˆ¶è¿è¡Œæ¨¡å¼ï¼šåˆ›å»ºæµ‹è¯•ä¿®æ”¹"
            TEST_FILE="force-test-$(date +%s).txt"
            echo "å¼ºåˆ¶è¿è¡Œæµ‹è¯•æ–‡ä»¶ - $(date)" > "$TEST_FILE"
            
            if [[ "$DRY_RUN" != "true" ]]; then
              MODIFIED_FILES="$TEST_FILE"
              echo "âœ… åˆ›å»ºæµ‹è¯•æ–‡ä»¶: $TEST_FILE"
            else
              echo "ğŸ“‹ [DRY RUN] å°†åˆ›å»ºæµ‹è¯•æ–‡ä»¶: $TEST_FILE"
            fi
          else
            # æ­£å¸¸å¤„ç†ä¿®å¤æ–‡ä»¶
            if [ ! -f "$FIX_FILE" ]; then
              echo "âŒ ä¿®å¤æ–‡ä»¶ä¸å­˜åœ¨: $FIX_FILE"
              echo "modified_files=none" >> $GITHUB_OUTPUT
              exit 0
            fi
          
            # è¯»å–ä¿®å¤æ–‡ä»¶å¹¶åº”ç”¨ä¿®å¤
            echo "ğŸ“– è¯»å–ä¿®å¤æ–‡ä»¶å†…å®¹..."
            LINE_NUMBER=0
            CURRENT_TARGET=""
            IN_FIX_BLOCK=false
            FIX_CONTENT=""
            
            while IFS= read -r LINE || [[ -n "$LINE" ]]; do
              LINE_NUMBER=$((LINE_NUMBER + 1))
              
              # æ£€æµ‹ä¿®å¤æ ‡è¯†å¼€å§‹
              if [[ "$LINE" =~ ^#ã€([^ã€‘]+)ã€‘ ]]; then
                if [ "$IN_FIX_BLOCK" = true ] && [ -n "$CURRENT_TARGET" ]; then
                  # åº”ç”¨ä¸Šä¸€ä¸ªä¿®å¤å—
                  echo "ğŸ”„ åº”ç”¨ä¿®å¤åˆ°: $CURRENT_TARGET"
                  echo "ä¿®å¤å†…å®¹:"
                  echo "$FIX_CONTENT"
                  
                  if [[ "$DRY_RUN" != "true" ]]; then
                    if [ -f "$CURRENT_TARGET" ]; then
                      # åˆ›å»ºå¤‡ä»½
                      BACKUP_FILE="${CURRENT_TARGET}.backup.$(date +%s)"
                      cp "$CURRENT_TARGET" "$BACKUP_FILE"
                      BACKUP_FILES="${BACKUP_FILES}${BACKUP_FILE},"
                      echo "ğŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
                      
                      # å®é™…åº”ç”¨ä¿®å¤ï¼ˆç¤ºä¾‹ï¼šè¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼‰
                      echo "" >> "$CURRENT_TARGET"
                      echo "# ===== è‡ªåŠ¨ä¿®å¤å¼€å§‹ =====" >> "$CURRENT_TARGET"
                      echo "# ä¿®å¤æ—¶é—´: $(date)" >> "$CURRENT_TARGET"
                      echo "# æ¥æº: $FIX_FILE (ç¬¬ $LINE_NUMBER è¡Œ)" >> "$CURRENT_TARGET"
                      echo "$FIX_CONTENT" >> "$CURRENT_TARGET"
                      echo "# ===== è‡ªåŠ¨ä¿®å¤ç»“æŸ =====" >> "$CURRENT_TARGET"
                      
                      MODIFIED_FILES="${MODIFIED_FILES}${CURRENT_TARGET},"
                      echo "âœ… å·²ä¿®æ”¹: $CURRENT_TARGET"
                    else
                      echo "âš ï¸  ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $CURRENT_TARGET"
                    fi
                  else
                    echo "ğŸ“‹ [DRY RUN] å°†ä¿®æ”¹: $CURRENT_TARGET"
                  fi
                fi
                
                # å¼€å§‹æ–°çš„ä¿®å¤å—
                CURRENT_TARGET="${BASH_REMATCH[1]}"
                IN_FIX_BLOCK=true
                FIX_CONTENT=""
                echo "ğŸ¯ æ‰¾åˆ°ä¿®å¤æ ‡è¯†[$LINE_NUMBER]: $CURRENT_TARGET"
                
              elif [[ "$LINE" =~ ^#ã€endã€‘ ]] || [[ "$LINE" =~ ^#ã€ç»“æŸã€‘ ]]; then
                # ä¿®å¤å—ç»“æŸ
                echo "ğŸ”š ä¿®å¤å—ç»“æŸ[$LINE_NUMBER]"
                IN_FIX_BLOCK=false
                
              elif [ "$IN_FIX_BLOCK" = true ]; then
                # åœ¨ä¿®å¤å—å†…ï¼Œç´¯ç§¯å†…å®¹
                FIX_CONTENT="${FIX_CONTENT}${LINE}"$'\n'
              fi
              
            done < "$FIX_FILE"
            
            # å¤„ç†æœ€åä¸€ä¸ªä¿®å¤å—
            if [ "$IN_FIX_BLOCK" = true ] && [ -n "$CURRENT_TARGET" ] && [ -n "$FIX_CONTENT" ]; then
              echo "ğŸ”„ åº”ç”¨æœ€åä¸€ä¸ªä¿®å¤å—åˆ°: $CURRENT_TARGET"
              
              if [[ "$DRY_RUN" != "true" ]]; then
                if [ -f "$CURRENT_TARGET" ]; then
                  # åˆ›å»ºå¤‡ä»½
                  BACKUP_FILE="${CURRENT_TARGET}.backup.$(date +%s)"
                  cp "$CURRENT_TARGET" "$BACKUP_FILE"
                  BACKUP_FILES="${BACKUP_FILES}${BACKUP_FILE},"
                  echo "ğŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
                  
                  # å®é™…åº”ç”¨ä¿®å¤
                  echo "" >> "$CURRENT_TARGET"
                  echo "# ===== è‡ªåŠ¨ä¿®å¤å¼€å§‹ =====" >> "$CURRENT_TARGET"
                  echo "# ä¿®å¤æ—¶é—´: $(date)" >> "$CURRENT_TARGET"
                  echo "# æ¥æº: $FIX_FILE" >> "$CURRENT_TARGET"
                  echo "$FIX_CONTENT" >> "$CURRENT_TARGET"
                  echo "# ===== è‡ªåŠ¨ä¿®å¤ç»“æŸ =====" >> "$CURRENT_TARGET"
                  
                  MODIFIED_FILES="${MODIFIED_FILES}${CURRENT_TARGET},"
                  echo "âœ… å·²ä¿®æ”¹: $CURRENT_TARGET"
                else
                  echo "âš ï¸  ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $CURRENT_TARGET"
                  # å°è¯•åˆ›å»ºæ–‡ä»¶
                  echo "å°è¯•åˆ›å»ºæ–‡ä»¶: $CURRENT_TARGET"
                  mkdir -p "$(dirname "$CURRENT_TARGET")"
                  echo "# è‡ªåŠ¨åˆ›å»ºçš„æ–‡ä»¶ - $(date)" > "$CURRENT_TARGET"
                  echo "$FIX_CONTENT" >> "$CURRENT_TARGET"
                  MODIFIED_FILES="${MODIFIED_FILES}${CURRENT_TARGET},"
                  echo "âœ… å·²åˆ›å»ºå¹¶ä¿®æ”¹: $CURRENT_TARGET"
                fi
              else
                echo "ğŸ“‹ [DRY RUN] å°†ä¿®æ”¹: $CURRENT_TARGET"
              fi
            fi
          fi
          
          # è¾“å‡ºç»“æœ
          if [ -n "$MODIFIED_FILES" ]; then
            echo "modified_files=${MODIFIED_FILES%,}" >> $GITHUB_OUTPUT
            echo "backup_files=${BACKUP_FILES%,}" >> $GITHUB_OUTPUT
            echo "âœ… ä¿®å¤å®Œæˆï¼Œä¿®æ”¹çš„æ–‡ä»¶: ${MODIFIED_FILES%,}"
          else
            echo "modified_files=none" >> $GITHUB_OUTPUT
            echo "backup_files=none" >> $GITHUB_OUTPUT
            echo "ğŸ“­ æ²¡æœ‰æ–‡ä»¶è¢«ä¿®æ”¹"
          fi
          
          echo ""
          echo "=== ä¿®å¤ç»“æœæ±‡æ€» ==="
          echo "æ¨¡å¼: $MODE_ICON $MODE_TEXT"
          echo "ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          if [ -n "$MODIFIED_FILES" ]; then
            echo "ä¿®æ”¹çš„æ–‡ä»¶: ${MODIFIED_FILES%,}"
          else
            echo "ä¿®æ”¹çš„æ–‡ä»¶: æ— "
          fi
      
      - name: ğŸ“Š æ˜¾ç¤ºä¿®å¤ç»“æœ
        if: always()
        run: |
          echo "=== ğŸ“Š ä¿®å¤ç»“æœè¯¦æƒ… ==="
          
          echo "ä¿®å¤æ–‡ä»¶: ${{ steps.find_fix.outputs.fix_file }}"
          echo "ä¿®å¤æ ‡è¯†æ•°: ${{ steps.find_fix.outputs.identifier_count }}"
          echo "è„šæœ¬ä¿®å¤: ${{ steps.find_fix.outputs.script_fix_count }}"
          echo "å·¥ä½œæµä¿®å¤: ${{ steps.find_fix.outputs.workflow_fix_count }}"
          echo ""
          
          echo "ä¿®æ”¹çš„æ–‡ä»¶çŠ¶æ€: ${{ steps.apply_fixes.outputs.modified_files }}"
          echo "å¤‡ä»½æ–‡ä»¶: ${{ steps.apply_fixes.outputs.backup_files }}"
          echo ""
          
          echo "å½“å‰ç›®å½•çŠ¶æ€:"
          ls -la
          echo ""
          
          echo "Git çŠ¶æ€:"
          git status --short || echo "æ— æ³•è·å–GitçŠ¶æ€"
          echo ""
          
          echo "æ£€æµ‹åˆ°çš„æ›´æ”¹:"
          git diff --name-only || echo "æ— æ›´æ”¹"
      
      - name: ğŸ’¾ è‡ªåŠ¨æäº¤æ›´æ”¹ï¼ˆè¯¦ç»†ï¼‰
        id: commit_changes
        if: steps.apply_fixes.outputs.modified_files != 'none' && inputs.dry_run == false
        run: |
          echo "=== ğŸ’¾ è‡ªåŠ¨æäº¤æ›´æ”¹ï¼ˆè¯¦ç»†ï¼‰==="
          
          # é…ç½®Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          echo "ğŸ¯ Gité…ç½®å®Œæˆ"
          echo "ç”¨æˆ·: $(git config user.name)"
          echo "é‚®ç®±: $(git config user.email)"
          echo ""
          
          # æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€
          echo "ğŸ“Š Gitè¯¦ç»†çŠ¶æ€:"
          git status
          echo ""
          
          # æ˜¾ç¤ºå…·ä½“æ›´æ”¹
          echo "ğŸ“ å…·ä½“æ›´æ”¹å†…å®¹:"
          git diff || echo "æ— å·®å¼‚"
          echo ""
          
          # è·å–ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
          MODIFIED_FILES="${{ steps.apply_fixes.outputs.modified_files }}"
          
          if [ -z "$MODIFIED_FILES" ] || [ "$MODIFIED_FILES" == "none" ]; then
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
            
            # æ£€æŸ¥æœªè·Ÿè¸ªæ–‡ä»¶
            UNTRACKED=$(git ls-files --others --exclude-standard)
            if [ -n "$UNTRACKED" ]; then
              echo "ğŸ“¦ å‘ç°æœªè·Ÿè¸ªæ–‡ä»¶:"
              echo "$UNTRACKED"
              echo ""
              echo "â• æ·»åŠ æœªè·Ÿè¸ªæ–‡ä»¶..."
              git add -A
              
              echo "ğŸ“‹ æäº¤ä¿¡æ¯..."
              git commit -m "ğŸ”§ è‡ªåŠ¨ä¿®å¤: æ·»åŠ æ–°æ–‡ä»¶ [skip ci]"
              
              echo "ğŸš€ æ¨é€åˆ°ä»“åº“..."
              git push origin HEAD:${{ github.ref_name }}
              
              echo "âœ… æ–°æ–‡ä»¶å·²æäº¤å¹¶æ¨é€"
              echo "æäº¤å“ˆå¸Œ: $(git rev-parse HEAD)"
            else
              echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„å†…å®¹"
            fi
          else
            echo "ğŸ“ æ£€æµ‹åˆ°ä¿®æ”¹çš„æ–‡ä»¶: $MODIFIED_FILES"
            echo ""
            
            # æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶
            echo "â• æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº..."
            IFS=',' read -ra FILES <<< "$MODIFIED_FILES"
            ADDED_COUNT=0
            for file in "${FILES[@]}"; do
              if [ -f "$file" ]; then
                git add "$file"
                echo "  âœ“ æ·»åŠ : $file"
                ADDED_COUNT=$((ADDED_COUNT + 1))
              else
                echo "  âœ— æ–‡ä»¶ä¸å­˜åœ¨: $file"
              fi
            done
            
            if [ $ADDED_COUNT -eq 0 ]; then
              echo "âš ï¸  æ²¡æœ‰æˆåŠŸæ·»åŠ ä»»ä½•æ–‡ä»¶"
              exit 1
            fi
            
            echo ""
            echo "âœ… æˆåŠŸæ·»åŠ  $ADDED_COUNT ä¸ªæ–‡ä»¶"
            
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            COMMIT_MSG="ğŸ”§ è‡ªåŠ¨ä¿®å¤: "
            
            SCRIPT_COUNT="${{ steps.find_fix.outputs.script_fix_count }}"
            WORKFLOW_COUNT="${{ steps.find_fix.outputs.workflow_fix_count }}"
            
            if [ "$SCRIPT_COUNT" -gt 0 ]; then
              COMMIT_MSG="${COMMIT_MSG}è„šæœ¬($SCRIPT_COUNT)"
            fi
            
            if [ "$WORKFLOW_COUNT" -gt 0 ]; then
              if [ "$SCRIPT_COUNT" -gt 0 ]; then
                COMMIT_MSG="${COMMIT_MSG} + "
              fi
              COMMIT_MSG="${COMMIT_MSG}å·¥ä½œæµ($WORKFLOW_COUNT)"
            fi
            
            COMMIT_MSG="${COMMIT_MSG} [skip ci]"
            
            echo "ğŸ“‹ æäº¤ä¿¡æ¯: $COMMIT_MSG"
            echo ""
            
            # æäº¤
            echo "ğŸ’¾ æäº¤æ›´æ”¹..."
            git commit -m "$COMMIT_MSG"
            
            # æ˜¾ç¤ºæäº¤ä¿¡æ¯
            echo "ğŸ“„ æäº¤è¯¦æƒ…:"
            git log -1 --pretty=fuller
            echo ""
            
            # æ¨é€
            echo "ğŸš€ æ¨é€åˆ°åˆ†æ”¯: ${{ github.ref_name }}"
            git push origin HEAD:${{ github.ref_name }}
            
            echo ""
            echo "ğŸ‰ æäº¤å®Œæˆ!"
            echo "âœ… æ›´æ”¹å·²è‡ªåŠ¨æäº¤å¹¶æ¨é€"
            echo "ğŸ“ æäº¤å“ˆå¸Œ: $(git rev-parse HEAD)"
            echo "ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${{ github.ref_name }}"
          fi
      
      - name: ğŸ“‹ ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
        if: always()
        run: |
          echo "### ğŸ“‹ å…¨è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿè¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åŸºæœ¬ä¿¡æ¯
          echo "#### ğŸ“… åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ä¿®å¤åˆ†æ
          echo "#### ğŸ“Š ä¿®å¤åˆ†æ" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿®å¤æ–‡ä»¶:** \`${{ steps.find_fix.outputs.fix_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿®å¤æ ‡è¯†æ€»æ•°:** ${{ steps.find_fix.outputs.identifier_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **è„šæœ¬ä¿®å¤æ•°é‡:** ${{ steps.find_fix.outputs.script_fix_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµä¿®å¤æ•°é‡:** ${{ steps.find_fix.outputs.workflow_fix_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ“ä½œæ¨¡å¼
          echo "#### ğŸ”§ æ“ä½œæ¨¡å¼" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ğŸŸ¡ **DRY RUN (è¯•è¿è¡Œ)**" >> $GITHUB_STEP_SUMMARY
            echo "> åªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’ï¼Œä¸å®é™…ä¿®æ”¹æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸŸ¢ **å®é™…ä¿®å¤**" >> $GITHUB_STEP_SUMMARY
            echo "> æ–‡ä»¶å·²è¢«å®é™…ä¿®æ”¹" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ–‡ä»¶ä¿®æ”¹è¯¦æƒ…
          echo "#### ğŸ“ æ–‡ä»¶ä¿®æ”¹è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          MODIFIED_FILES="${{ steps.apply_fixes.outputs.modified_files }}"
          
          if [ -n "$MODIFIED_FILES" ] && [ "$MODIFIED_FILES" != "none" ]; then
            echo "âœ… **ä»¥ä¸‹æ–‡ä»¶å·²è¢«ä¿®æ”¹:**" >> $GITHUB_STEP_SUMMARY
            IFS=',' read -ra FILES <<< "$MODIFIED_FILES"
            for file in "${FILES[@]}"; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "ğŸ“­ **æ— æ–‡ä»¶è¢«ä¿®æ”¹**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å¤‡ä»½æ–‡ä»¶
          BACKUP_FILES="${{ steps.apply_fixes.outputs.backup_files }}"
          if [ -n "$BACKUP_FILES" ] && [ "$BACKUP_FILES" != "none" ]; then
            echo "#### ğŸ“¦ å¤‡ä»½æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "ä»¥ä¸‹æ–‡ä»¶å·²å¤‡ä»½:" >> $GITHUB_STEP_SUMMARY
            IFS=',' read -ra FILES <<< "$BACKUP_FILES"
            for file in "${FILES[@]}"; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æäº¤çŠ¶æ€
          echo "#### ğŸ“¤ æäº¤çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ğŸŸ¡ **è¯•è¿è¡Œæ¨¡å¼ï¼Œæ— æäº¤**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.commit_changes.outcome }}" == "skipped" ]]; then
            echo "ğŸ“­ **æ— ä¿®æ”¹æˆ–ä¸éœ€è¦æäº¤**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **å·²è‡ªåŠ¨æäº¤å¹¶æ¨é€**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æäº¤ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”§ è‡ªåŠ¨ä¿®å¤: " >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.find_fix.outputs.script_fix_count }}" != "0" ]; then
              echo "è„šæœ¬(${{ steps.find_fix.outputs.script_fix_count }})" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "${{ steps.find_fix.outputs.workflow_fix_count }}" != "0" ]; then
              if [ "${{ steps.find_fix.outputs.script_fix_count }}" != "0" ]; then
                echo " + " >> $GITHUB_STEP_SUMMARY
              fi
              echo "å·¥ä½œæµ(${{ steps.find_fix.outputs.workflow_fix_count }})" >> $GITHUB_STEP_SUMMARY
            fi
            echo " [skip ci]" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # è¯¦ç»†æ—¥å¿—é“¾æ¥
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ”— è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "æŸ¥çœ‹å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- [å·¥ä½œæµè¿è¡Œè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
