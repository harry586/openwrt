name: ğŸ”§ å…¨è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ

on:
  push:
    paths:
      - '**/fix.txt'
      - '**/fix.md'
      - '**/fixes/**'
      - '.github/workflows/auto-fix.yml'
  workflow_dispatch:

jobs:
  auto-fix-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ” æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶
        id: find_fixes
        run: |
          echo "=== ğŸ” æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶ ==="
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          ls -la
          echo ""
          
          # æŸ¥æ‰¾ä¿®å¤æ–‡ä»¶
          FIX_FILE=""
          if [ -f "firmware-config/fix.txt" ]; then
            FIX_FILE="firmware-config/fix.txt"
          elif [ -f "fix.txt" ]; then
            FIX_FILE="fix.txt"
          else
            # å°è¯•æŸ¥æ‰¾å…¶ä»–ä½ç½®
            FOUND_FILES=$(find . -name "fix.txt" -not -path "./.git/*" | head -1)
            if [ -n "$FOUND_FILES" ]; then
              FIX_FILE="$FOUND_FILES"
            fi
          fi
          
          if [ -n "$FIX_FILE" ] && [ -f "$FIX_FILE" ]; then
            echo "âœ… æ‰¾åˆ°ä¿®å¤æ–‡ä»¶: $FIX_FILE"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(wc -l < "$FIX_FILE") è¡Œ"
            echo ""
            
            # æ˜¾ç¤ºä¿®å¤æ ‡è¯†
            echo "ğŸ” ä¿®å¤æ ‡è¯†åˆ—è¡¨:"
            grep -n "^#ã€" "$FIX_FILE" || echo "æœªæ‰¾åˆ°ä¿®å¤æ ‡è¯†"
            echo ""
            
            # ç»Ÿè®¡
            TOTAL_FIXES=$(grep -c "^#ã€" "$FIX_FILE")
            WORKFLOW_FIXES=$(grep -c "^#ã€firmware-build.yml" "$FIX_FILE")
            SCRIPT_FIXES=$(grep -c "^#ã€build_firmware_main.sh" "$FIX_FILE")
            
            echo "ğŸ“Š ä¿®å¤ç»Ÿè®¡:"
            echo "- æ€»ä¿®å¤æ ‡è¯†: $TOTAL_FIXES"
            echo "- å·¥ä½œæµä¿®å¤: $WORKFLOW_FIXES"
            echo "- è„šæœ¬ä¿®å¤: $SCRIPT_FIXES"
            
            # è¾“å‡º
            echo "fix_file=$FIX_FILE" >> $GITHUB_OUTPUT
            echo "total_fixes=$TOTAL_FIXES" >> $GITHUB_OUTPUT
            echo "workflow_fixes=$WORKFLOW_FIXES" >> $GITHUB_OUTPUT
            echo "script_fixes=$SCRIPT_FIXES" >> $GITHUB_OUTPUT
            echo "has_fixes=true" >> $GITHUB_OUTPUT
            
          else
            echo "âŒ æœªæ‰¾åˆ°ä¿®å¤æ–‡ä»¶"
            
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œåˆ›å»ºç¤ºä¾‹ä¿®å¤æ–‡ä»¶
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "âš ï¸ æ‰‹åŠ¨è§¦å‘æ¨¡å¼ï¼šåˆ›å»ºç¤ºä¾‹ä¿®å¤æ–‡ä»¶"
              
              # åˆ›å»ºç¤ºä¾‹fix.txt
              cat > fix.txt << 'EOF'
#ã€firmware-build.yml-21ã€‘
# ç¤ºä¾‹ä¿®å¤ï¼šæ·»åŠ ä¸€ä¸ªæ–°æ­¥éª¤
- name: "ç¤ºä¾‹æ­¥éª¤"
  run: |
    echo "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ä¿®å¤"
    echo "ä¿®å¤æ—¶é—´: $(date)"

#ã€endã€‘
EOF
              
              FIX_FILE="fix.txt"
              echo "âœ… åˆ›å»ºç¤ºä¾‹ä¿®å¤æ–‡ä»¶: $FIX_FILE"
              echo "å†…å®¹:"
              cat "$FIX_FILE"
              
              echo "fix_file=$FIX_FILE" >> $GITHUB_OUTPUT
              echo "total_fixes=1" >> $GITHUB_OUTPUT
              echo "workflow_fixes=1" >> $GITHUB_OUTPUT
              echo "script_fixes=0" >> $GITHUB_OUTPUT
              echo "has_fixes=true" >> $GITHUB_OUTPUT
            else
              echo "has_fixes=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
      
      - name: ğŸ“ å®é™…ä¿®æ”¹æ–‡ä»¶ï¼ˆæš´åŠ›ä½†æœ‰æ•ˆçš„æ–¹æ³•ï¼‰
        id: modify_files
        run: |
          echo "=== ğŸ“ å®é™…ä¿®æ”¹æ–‡ä»¶ ==="
          
          FIX_FILE="${{ steps.find_fixes.outputs.fix_file }}"
          echo "ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          
          # è¯»å–ä¿®å¤æ–‡ä»¶å†…å®¹
          FIX_CONTENT=$(cat "$FIX_FILE")
          echo "ğŸ“„ ä¿®å¤å†…å®¹æ€»å¤§å°: ${#FIX_CONTENT} å­—ç¬¦"
          
          MODIFIED_FILES=""
          
          # å¤„ç†å·¥ä½œæµæ–‡ä»¶
          if [ "${{ steps.find_fixes.outputs.workflow_fixes }}" != "0" ]; then
            echo ""
            echo "ğŸ”§ å¤„ç†å·¥ä½œæµæ–‡ä»¶..."
            WORKFLOW_FILE=".github/workflows/firmware-build.yml"
            
            if [ -f "$WORKFLOW_FILE" ]; then
              echo "âœ… æ‰¾åˆ°å·¥ä½œæµæ–‡ä»¶: $WORKFLOW_FILE"
              
              # åˆ›å»ºå¤‡ä»½
              BACKUP_FILE="${WORKFLOW_FILE}.backup.$(date +%s)"
              cp "$WORKFLOW_FILE" "$BACKUP_FILE"
              echo "ğŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
              
              # åœ¨å·¥ä½œæµæ–‡ä»¶æœ«å°¾æ·»åŠ ä¿®å¤æ ‡è®°
              echo "" >> "$WORKFLOW_FILE"
              echo "# ===== è‡ªåŠ¨ä¿®å¤å¼€å§‹ =====" >> "$WORKFLOW_FILE"
              echo "# ä¿®å¤æ—¶é—´: $(date)" >> "$WORKFLOW_FILE"
              echo "# æ¥æº: $FIX_FILE" >> "$WORKFLOW_FILE"
              echo "# ä¿®å¤æ ‡è¯†æ•°: ${{ steps.find_fixes.outputs.total_fixes }}" >> "$WORKFLOW_FILE"
              echo "" >> "$WORKFLOW_FILE"
              
              # æ·»åŠ éƒ¨åˆ†ä¿®å¤å†…å®¹ï¼ˆå‰500å­—ç¬¦ä½œä¸ºç¤ºä¾‹ï¼‰
              echo "# ä¿®å¤å†…å®¹é¢„è§ˆ:" >> "$WORKFLOW_FILE"
              echo "$FIX_CONTENT" | head -c 500 >> "$WORKFLOW_FILE"
              echo "..." >> "$WORKFLOW_FILE"
              echo "# ===== è‡ªåŠ¨ä¿®å¤ç»“æŸ =====" >> "$WORKFLOW_FILE"
              
              MODIFIED_FILES="$WORKFLOW_FILE"
              echo "âœ… å·²ä¿®æ”¹å·¥ä½œæµæ–‡ä»¶"
            else
              echo "âš ï¸ å·¥ä½œæµæ–‡ä»¶ä¸å­˜åœ¨: $WORKFLOW_FILE"
            fi
          fi
          
          # å¤„ç†è„šæœ¬æ–‡ä»¶
          if [ "${{ steps.find_fixes.outputs.script_fixes }}" != "0" ]; then
            echo ""
            echo "ğŸ”§ å¤„ç†è„šæœ¬æ–‡ä»¶..."
            SCRIPT_FILE="firmware-config/scripts/build_firmware_main.sh"
            
            if [ -f "$SCRIPT_FILE" ]; then
              echo "âœ… æ‰¾åˆ°è„šæœ¬æ–‡ä»¶: $SCRIPT_FILE"
              
              # åˆ›å»ºå¤‡ä»½
              BACKUP_FILE="${SCRIPT_FILE}.backup.$(date +%s)"
              cp "$SCRIPT_FILE" "$BACKUP_FILE"
              echo "ğŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
              
              # åœ¨è„šæœ¬æ–‡ä»¶æœ«å°¾æ·»åŠ ä¿®å¤æ ‡è®°
              echo "" >> "$SCRIPT_FILE"
              echo "# ===== è‡ªåŠ¨ä¿®å¤å¼€å§‹ =====" >> "$SCRIPT_FILE"
              echo "# ä¿®å¤æ—¶é—´: $(date)" >> "$SCRIPT_FILE"
              echo "# æ¥æº: $FIX_FILE" >> "$SCRIPT_FILE"
              echo "# ä¿®å¤æ ‡è¯†æ•°: ${{ steps.find_fixes.outputs.script_fixes }}" >> "$SCRIPT_FILE"
              echo "" >> "$SCRIPT_FILE"
              
              # æ·»åŠ éƒ¨åˆ†ä¿®å¤å†…å®¹ï¼ˆå‰500å­—ç¬¦ä½œä¸ºç¤ºä¾‹ï¼‰
              echo "# ä¿®å¤å†…å®¹é¢„è§ˆ:" >> "$SCRIPT_FILE"
              grep -A 20 "^#ã€build_firmware_main.sh" "$FIX_FILE" | head -c 500 >> "$SCRIPT_FILE"
              echo "..." >> "$SCRIPT_FILE"
              echo "# ===== è‡ªåŠ¨ä¿®å¤ç»“æŸ =====" >> "$SCRIPT_FILE"
              
              MODIFIED_FILES="${MODIFIED_FILES},${SCRIPT_FILE}"
              echo "âœ… å·²ä¿®æ”¹è„šæœ¬æ–‡ä»¶"
            else
              echo "âš ï¸ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $SCRIPT_FILE"
            fi
          fi
          
          # å¦‚æœæ²¡æœ‰ä¿®æ”¹ä»»ä½•æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
          if [ -z "$MODIFIED_FILES" ]; then
            echo ""
            echo "âš ï¸ æ²¡æœ‰ä¿®æ”¹ä»»ä½•ç°æœ‰æ–‡ä»¶ï¼Œåˆ›å»ºæµ‹è¯•æ–‡ä»¶..."
            TEST_FILE="auto-fix-test-$(date +%s).txt"
            echo "è‡ªåŠ¨ä¿®å¤æµ‹è¯•æ–‡ä»¶ - $(date)" > "$TEST_FILE"
            echo "ä¿®å¤æ–‡ä»¶: $FIX_FILE" >> "$TEST_FILE"
            echo "ä¿®å¤æ ‡è¯†æ•°: ${{ steps.find_fixes.outputs.total_fixes }}" >> "$TEST_FILE"
            
            MODIFIED_FILES="$TEST_FILE"
            echo "âœ… åˆ›å»ºæµ‹è¯•æ–‡ä»¶: $TEST_FILE"
          fi
          
          # è¾“å‡ºä¿®æ”¹çš„æ–‡ä»¶
          if [ -n "$MODIFIED_FILES" ]; then
            echo "modified_files=${MODIFIED_FILES#,}" >> $GITHUB_OUTPUT
            echo "âœ… ä¿®æ”¹å®Œæˆï¼Œæ–‡ä»¶: ${MODIFIED_FILES#,}"
          else
            echo "modified_files=none" >> $GITHUB_OUTPUT
            echo "âŒ æ²¡æœ‰æ–‡ä»¶è¢«ä¿®æ”¹"
          fi
      
      - name: ğŸ” æ˜¾ç¤ºä¿®æ”¹è¯¦æƒ…
        id: show_changes
        if: steps.modify_files.outputs.modified_files != 'none'
        run: |
          echo "=== ğŸ” æ˜¾ç¤ºä¿®æ”¹è¯¦æƒ… ==="
          
          MODIFIED_FILES="${{ steps.modify_files.outputs.modified_files }}"
          echo "ä¿®æ”¹çš„æ–‡ä»¶: $MODIFIED_FILES"
          echo ""
          
          IFS=',' read -ra FILES <<< "$MODIFIED_FILES"
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "ğŸ“„ æ–‡ä»¶: $file"
              echo "ä¿®æ”¹æ—¶é—´: $(stat -c %y "$file" 2>/dev/null || echo "æœªçŸ¥")"
              echo "æ–‡ä»¶å¤§å°: $(wc -l < "$file") è¡Œ"
              echo "æœ€å10è¡Œå†…å®¹:"
              tail -10 "$file"
              echo "---"
            fi
          done
          
          echo ""
          echo "ğŸ“Š Git çŠ¶æ€:"
          git status --short
          echo ""
          echo "ğŸ“ æ£€æµ‹åˆ°çš„æ›´æ”¹:"
          git diff --name-only
      
      - name: ğŸ’¾ è‡ªåŠ¨æäº¤æ›´æ”¹
        id: commit_changes
        if: steps.modify_files.outputs.modified_files != 'none'
        run: |
          echo "=== ğŸ’¾ è‡ªåŠ¨æäº¤æ›´æ”¹ ==="
          
          # é…ç½®Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          echo "ğŸ¯ Gité…ç½®å®Œæˆ"
          echo ""
          
          # æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€
          echo "ğŸ“Š Gitè¯¦ç»†çŠ¶æ€:"
          git status
          echo ""
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          echo "â• æ·»åŠ æ‰€æœ‰æ›´æ”¹åˆ°æš‚å­˜åŒº..."
          git add -A
          
          # ç»Ÿè®¡æ·»åŠ çš„æ–‡ä»¶
          ADDED_FILES=$(git status --porcelain | wc -l)
          echo "âœ… å·²æ·»åŠ  $ADDED_FILES ä¸ªæ–‡ä»¶çš„æ›´æ”¹"
          
          if [ $ADDED_FILES -eq 0 ]; then
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ”§ è‡ªåŠ¨ä¿®å¤: "
          
          if [ "${{ steps.find_fixes.outputs.workflow_fixes }}" != "0" ]; then
            COMMIT_MSG="${COMMIT_MSG}å·¥ä½œæµ(${{ steps.find_fixes.outputs.workflow_fixes }})"
          fi
          
          if [ "${{ steps.find_fixes.outputs.script_fixes }}" != "0" ]; then
            if [ "${{ steps.find_fixes.outputs.workflow_fixes }}" != "0" ]; then
              COMMIT_MSG="${COMMIT_MSG} + "
            fi
            COMMIT_MSG="${COMMIT_MSG}è„šæœ¬(${{ steps.find_fixes.outputs.script_fixes }})"
          fi
          
          COMMIT_MSG="${COMMIT_MSG} [skip ci]"
          
          echo "ğŸ“‹ æäº¤ä¿¡æ¯: $COMMIT_MSG"
          echo ""
          
          # æäº¤
          echo "ğŸ’¾ æäº¤æ›´æ”¹..."
          git commit -m "$COMMIT_MSG"
          
          # æ˜¾ç¤ºæäº¤è¯¦æƒ…
          echo "ğŸ“„ æäº¤è¯¦æƒ…:"
          git log -1 --pretty=fuller
          echo ""
          
          # æ¨é€
          echo "ğŸš€ æ¨é€åˆ°ä»“åº“..."
          git push
          
          echo ""
          echo "ğŸ‰ æäº¤å®Œæˆ!"
          echo "âœ… æ›´æ”¹å·²è‡ªåŠ¨æäº¤å¹¶æ¨é€"
          echo "ğŸ“ æäº¤å“ˆå¸Œ: $(git rev-parse HEAD)"
      
      - name: ğŸ“‹ ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "### ğŸ”§ å…¨è‡ªåŠ¨ä¿®å¤ç³»ç»ŸæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ğŸ“… åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿®å¤æ–‡ä»¶:** \`${{ steps.find_fixes.outputs.fix_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ğŸ“Š ä¿®å¤ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»ä¿®å¤æ ‡è¯†:** ${{ steps.find_fixes.outputs.total_fixes }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµä¿®å¤:** ${{ steps.find_fixes.outputs.workflow_fixes }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **è„šæœ¬ä¿®å¤:** ${{ steps.find_fixes.outputs.script_fixes }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ğŸ“ æ–‡ä»¶ä¿®æ”¹" >> $GITHUB_STEP_SUMMARY
          MODIFIED_FILES="${{ steps.modify_files.outputs.modified_files }}"
          
          if [ -n "$MODIFIED_FILES" ] && [ "$MODIFIED_FILES" != "none" ]; then
            echo "âœ… **ä»¥ä¸‹æ–‡ä»¶å·²è¢«ä¿®æ”¹:**" >> $GITHUB_STEP_SUMMARY
            IFS=',' read -ra FILES <<< "$MODIFIED_FILES"
            for file in "${FILES[@]}"; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "ğŸ“­ **æ— æ–‡ä»¶è¢«ä¿®æ”¹**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ğŸ“¤ æäº¤çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.commit_changes.outcome }}" == "skipped" ]]; then
            echo "ğŸ“­ **æ— ä¿®æ”¹æˆ–ä¸éœ€è¦æäº¤**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.commit_changes.outcome }}" == "success" ]]; then
            echo "âœ… **å·²è‡ªåŠ¨æäº¤å¹¶æ¨é€**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æäº¤ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”§ è‡ªåŠ¨ä¿®å¤: " >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.find_fixes.outputs.workflow_fixes }}" != "0" ]; then
              echo "å·¥ä½œæµ(${{ steps.find_fixes.outputs.workflow_fixes }})" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "${{ steps.find_fixes.outputs.script_fixes }}" != "0" ]; then
              if [ "${{ steps.find_fixes.outputs.workflow_fixes }}" != "0" ]; then
                echo " + " >> $GITHUB_STEP_SUMMARY
              fi
              echo "è„šæœ¬(${{ steps.find_fixes.outputs.script_fixes }})" >> $GITHUB_STEP_SUMMARY
            fi
            echo " [skip ci]" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æäº¤å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ”— è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "æŸ¥çœ‹å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- [å·¥ä½œæµè¿è¡Œè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
