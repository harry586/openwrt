name: è‡ªåŠ¨ä¿®å¤å›ºä»¶æ„å»ºæ–‡ä»¶

on:
  push:
    paths:
      - 'firmware-config/fix.txt'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'å¹²è¿è¡Œï¼ˆåªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’ï¼Œä¸å®é™…ä¿®æ”¹ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: æ˜¾ç¤ºè¯¦ç»†ç¯å¢ƒä¿¡æ¯
        run: |
          echo "=== è¯¦ç»†ç¯å¢ƒä¿¡æ¯ ==="
          echo "ğŸ“… å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ğŸ“‚ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“‚ GitHub å·¥ä½œç©ºé—´: ${{ github.workspace }}"
          echo ""
          echo "ğŸ” æ£€æŸ¥ /mnt ç›®å½•å†…å®¹:"
          ls -la /mnt/ 2>/dev/null || echo "  /mnt ç›®å½•ä¸å­˜åœ¨æˆ–ä¸å¯è®¿é—®"
          echo ""
          echo "ğŸ” æ£€æŸ¥ /mnt/openwrt-build ç›®å½•å†…å®¹:"
          ls -la /mnt/openwrt-build/ 2>/dev/null || echo "  /mnt/openwrt-build ç›®å½•ä¸å­˜åœ¨æˆ–ä¸å¯è®¿é—®"
          echo ""
          echo "ğŸ” æ£€æŸ¥ firmware-config ç›®å½•å†…å®¹:"
          ls -la firmware-config/ 2>/dev/null || echo "  firmware-config ç›®å½•ä¸å­˜åœ¨"
          echo ""
          
      - name: è§£æä¿®å¤æ–¹æ¡ˆæ–‡ä»¶
        id: parse_fixes
        run: |
          echo "=== è§£æä¿®å¤æ–¹æ¡ˆæ–‡ä»¶ ==="
          echo "ğŸ“‚ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“‚ GitHub å·¥ä½œç©ºé—´: ${{ github.workspace }}"
          echo ""
          
          # é¦–å…ˆæ£€æŸ¥ /mnt/openwrt-build ç›®å½•
          echo "ğŸ” æ£€æŸ¥ /mnt/openwrt-build ç›®å½•:"
          if [ -d "/mnt/openwrt-build" ]; then
            echo "âœ… /mnt/openwrt-build ç›®å½•å­˜åœ¨"
            echo "ğŸ“‚ /mnt/openwrt-build ç›®å½•å†…å®¹:"
            ls -la /mnt/openwrt-build/
            echo ""
          else
            echo "âŒ /mnt/openwrt-build ç›®å½•ä¸å­˜åœ¨"
            echo ""
          fi
          
          # æŸ¥æ‰¾ fix.txt æ–‡ä»¶
          echo "ğŸ” æŸ¥æ‰¾ fix.txt æ–‡ä»¶..."
          FOUND_FIX_FILE=""
          
          # æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„ä½ç½®
          POSSIBLE_PATHS=(
            "/mnt/openwrt-build/firmware-config/fix.txt"
            "/mnt/openwrt-build/fix.txt"
            "${{ github.workspace }}/firmware-config/fix.txt"
            "${{ github.workspace }}/fix.txt"
            "./firmware-config/fix.txt"
            "./fix.txt"
          )
          
          for PATH in "${POSSIBLE_PATHS[@]}"; do
            if [ -f "$PATH" ]; then
              FOUND_FIX_FILE="$PATH"
              echo "âœ… æ‰¾åˆ°ä¿®å¤æ–‡ä»¶: $PATH"
              echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(wc -l < "$PATH") è¡Œ"
              break
            else
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $PATH"
            fi
          done
          
          if [ -z "$FOUND_FIX_FILE" ]; then
            echo "âŒ é”™è¯¯: åœ¨æ‰€æœ‰å¯èƒ½ä½ç½®å‡æœªæ‰¾åˆ° fix.txt æ–‡ä»¶"
            echo "ğŸ’¡ å¯èƒ½çš„åŸå› :"
            echo "  1. æ–‡ä»¶ä¸åœ¨é¢„æœŸçš„ä½ç½®"
            echo "  2. ä»“åº“ç»“æ„ä¸åŒ"
            echo "  3. éœ€è¦å…ˆè¿è¡Œå…¶ä»–å·¥ä½œæµæ­¥éª¤"
            exit 1
          fi
          
          FIX_FILE="$FOUND_FIX_FILE"
          echo ""
          echo "ğŸ“„ ä½¿ç”¨ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          
          # æ˜¾ç¤ºæ–‡ä»¶å‰å‡ è¡Œ
          echo "ğŸ“‹ æ–‡ä»¶å‰15è¡Œ:"
          head -15 "$FIX_FILE"
          echo ""
          
          # æå–æ‰€æœ‰ç³»ç»Ÿæ€§æ ‡è¯†
          echo "ğŸ” æå–ç³»ç»Ÿæ€§æ ‡è¯†..."
          LINE_NUM=1
          IDENTIFIER_COUNT=0
          while IFS= read -r LINE; do
            if [[ "$LINE" =~ ^#ã€([^ã€‘]+)ã€‘ ]]; then
              IDENTIFIER="${BASH_REMATCH[1]}"
              echo "ğŸ“Œ æ ‡è¯† [$LINE_NUM]: $IDENTIFIER"
              IDENTIFIER_COUNT=$((IDENTIFIER_COUNT + 1))
            fi
            LINE_NUM=$((LINE_NUM + 1))
          done < "$FIX_FILE"
          
          # ç»Ÿè®¡ä¸åŒç±»å‹çš„ä¿®å¤
          echo ""
          echo "ğŸ“ˆ ä¿®å¤å†…å®¹ç»Ÿè®¡:"
          SCRIPT_FIXES=$(grep -c "^#ã€build_firmware_main.sh-" "$FIX_FILE")
          WORKFLOW_FIXES=$(grep -c "^#ã€firmware-build.yml-" "$FIX_FILE")
          NEW_FUNCTIONS=$(grep -c "^#ã€.*-æ–°å‡½æ•°ã€‘" "$FIX_FILE")
          NEW_STEPS=$(grep -c "^#ã€.*-æ–°æ­¥éª¤ã€‘" "$FIX_FILE")
          
          echo "  - è„šæœ¬å‡½æ•°ä¿®å¤: $SCRIPT_FIXES ä¸ª"
          echo "  - å·¥ä½œæµæ­¥éª¤ä¿®å¤: $WORKFLOW_FIXES ä¸ª"
          echo "  - æ–°å‡½æ•°: $NEW_FUNCTIONS ä¸ª"
          echo "  - æ–°æ­¥éª¤: $NEW_STEPS ä¸ª"
          echo "  - æ€»æ ‡è¯†æ•°é‡: $IDENTIFIER_COUNT ä¸ª"
          
          # ä¿å­˜è§£æç»“æœä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "identifiers_count=$IDENTIFIER_COUNT" >> $GITHUB_OUTPUT
          echo "script_fixes_count=$SCRIPT_FIXES" >> $GITHUB_OUTPUT
          echo "workflow_fixes_count=$WORKFLOW_FIXES" >> $GITHUB_OUTPUT
          echo "new_functions_count=$NEW_FUNCTIONS" >> $GITHUB_OUTPUT
          echo "new_steps_count=$NEW_STEPS" >> $GITHUB_OUTPUT
          echo "fix_file_path=$FIX_FILE" >> $GITHUB_OUTPUT
          
      - name: å¤„ç†è„šæœ¬æ–‡ä»¶ä¿®å¤ (build_firmware_main.sh)
        if: steps.parse_fixes.outputs.script_fixes_count != '0'
        run: |
          echo "=== å¤„ç†è„šæœ¬æ–‡ä»¶ä¿®å¤ ==="
          echo "ğŸ“‚ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo ""
          
          FIX_FILE="${{ steps.parse_fixes.outputs.fix_file_path }}"
          echo "ğŸ“„ ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          
          # æŸ¥æ‰¾ç›®æ ‡è„šæœ¬æ–‡ä»¶
          echo "ğŸ” æŸ¥æ‰¾ build_firmware_main.sh æ–‡ä»¶..."
          TARGET_SCRIPT=""
          
          # æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„ä½ç½®
          POSSIBLE_SCRIPT_PATHS=(
            "/mnt/openwrt-build/firmware-config/scripts/build_firmware_main.sh"
            "/mnt/openwrt-build/scripts/build_firmware_main.sh"
            "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh"
            "${{ github.workspace }}/scripts/build_firmware_main.sh"
          )
          
          for PATH in "${POSSIBLE_SCRIPT_PATHS[@]}"; do
            if [ -f "$PATH" ]; then
              TARGET_SCRIPT="$PATH"
              echo "âœ… æ‰¾åˆ°è„šæœ¬æ–‡ä»¶: $PATH"
              break
            else
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $PATH"
            fi
          done
          
          if [ -z "$TARGET_SCRIPT" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° build_firmware_main.sh æ–‡ä»¶"
            echo "ğŸ” å°è¯•æŸ¥æ‰¾æ‰€æœ‰ build_firmware_main.sh æ–‡ä»¶:"
            find /mnt/openwrt-build/ -name "build_firmware_main.sh" -type f 2>/dev/null || true
            find ${{ github.workspace }} -name "build_firmware_main.sh" -type f 2>/dev/null || true
            exit 1
          fi
          
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          BACKUP_DIR="/mnt/openwrt-build/å¤‡ä»½æ–‡ä»¶"
          mkdir -p "$BACKUP_DIR"
          
          BACKUP_FILE="$BACKUP_DIR/build_firmware_main.sh.å¤‡ä»½.$(date +%Y%m%d_%H%M%S)"
          
          # å¤‡ä»½åŸæ–‡ä»¶
          cp "$TARGET_SCRIPT" "$BACKUP_FILE"
          echo "âœ… å·²å¤‡ä»½åŸæ–‡ä»¶åˆ°: $BACKUP_FILE"
          echo "ğŸ“Š å¤‡ä»½æ–‡ä»¶å¤§å°: $(wc -l < "$BACKUP_FILE") è¡Œ"
          
          # åˆ›å»ºä¸´æ—¶å·¥ä½œæ–‡ä»¶
          TEMP_DIR="/mnt/openwrt-build/ä¸´æ—¶ä¿®å¤æ–‡ä»¶"
          mkdir -p "$TEMP_DIR"
          
          TEMP_SCRIPT="$TEMP_DIR/build_firmware_main.sh.ä¸´æ—¶"
          cp "$TARGET_SCRIPT" "$TEMP_SCRIPT"
          echo "âœ… åˆ›å»ºä¸´æ—¶å·¥ä½œæ–‡ä»¶: $TEMP_SCRIPT"
          
          # å¤„ç†æ‰€æœ‰è„šæœ¬ç›¸å…³çš„ä¿®å¤
          echo ""
          echo "ğŸ”§ å¼€å§‹å¤„ç†è„šæœ¬ä¿®å¤..."
          echo "ğŸ“Š éœ€è¦å¤„ç†çš„è„šæœ¬ä¿®å¤æ•°é‡: ${{ steps.parse_fixes.outputs.script_fixes_count }}"
          
          # å¦‚æœæ˜¯dry runï¼Œåªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo ""
            echo "ğŸ” Dry runæ¨¡å¼ - æ˜¾ç¤ºä¿®æ”¹è®¡åˆ’"
            echo "ğŸ“‹ å°†æ ¹æ®ä»¥ä¸‹æ ‡è¯†è¿›è¡Œä¿®æ”¹:"
            grep "^#ã€build_firmware_main.sh-" "$FIX_FILE" || echo "  æœªæ‰¾åˆ°è„šæœ¬ä¿®å¤æ ‡è¯†"
            
            echo ""
            echo "ğŸ“Š åŸæ–‡ä»¶å†…å®¹é¢„è§ˆ (æœ€å20è¡Œ):"
            tail -20 "$TARGET_SCRIPT"
          else
            echo "ğŸ”„ å®é™…åº”ç”¨ä¿®å¤..."
            # è¿™é‡Œå®ç°å®é™…çš„ä¿®å¤é€»è¾‘
            echo "ğŸ“ ä¿®å¤é€»è¾‘å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°"
            
            # ä¸´æ—¶ï¼šæ˜¾ç¤ºå·®å¼‚
            echo ""
            echo "ğŸ“Š ä¸´æ—¶æ˜¾ç¤ºæ–‡ä»¶å·®å¼‚ (ç¤ºä¾‹):"
            echo "åŸæ–‡ä»¶: $TARGET_SCRIPT"
            echo "ä¸´æ—¶æ–‡ä»¶: $TEMP_SCRIPT"
          fi
          
      - name: å¤„ç†å·¥ä½œæµæ–‡ä»¶ä¿®å¤ (firmware-build.yml)
        if: steps.parse_fixes.outputs.workflow_fixes_count != '0'
        run: |
          echo "=== å¤„ç†å·¥ä½œæµæ–‡ä»¶ä¿®å¤ ==="
          echo "ğŸ“‚ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo ""
          
          FIX_FILE="${{ steps.parse_fixes.outputs.fix_file_path }}"
          echo "ğŸ“„ ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          
          # æŸ¥æ‰¾ç›®æ ‡å·¥ä½œæµæ–‡ä»¶
          echo "ğŸ” æŸ¥æ‰¾ firmware-build.yml æ–‡ä»¶..."
          TARGET_WORKFLOW=""
          
          # æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„ä½ç½®
          POSSIBLE_WORKFLOW_PATHS=(
            "${{ github.workspace }}/.github/workflows/firmware-build.yml"
            "/mnt/openwrt-build/.github/workflows/firmware-build.yml"
            "${{ github.workspace }}/firmware-build.yml"
          )
          
          for PATH in "${POSSIBLE_WORKFLOW_PATHS[@]}"; do
            if [ -f "$PATH" ]; then
              TARGET_WORKFLOW="$PATH"
              echo "âœ… æ‰¾åˆ°å·¥ä½œæµæ–‡ä»¶: $PATH"
              break
            else
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $PATH"
            fi
          done
          
          if [ -z "$TARGET_WORKFLOW" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° firmware-build.yml æ–‡ä»¶"
            echo "ğŸ” å°è¯•æŸ¥æ‰¾æ‰€æœ‰ firmware-build.yml æ–‡ä»¶:"
            find ${{ github.workspace }} -name "firmware-build.yml" -type f 2>/dev/null || true
            exit 1
          fi
          
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          BACKUP_DIR="/mnt/openwrt-build/å¤‡ä»½æ–‡ä»¶"
          mkdir -p "$BACKUP_DIR"
          
          BACKUP_FILE="$BACKUP_DIR/firmware-build.yml.å¤‡ä»½.$(date +%Y%m%d_%H%M%S)"
          
          # å¤‡ä»½åŸæ–‡ä»¶
          cp "$TARGET_WORKFLOW" "$BACKUP_FILE"
          echo "âœ… å·²å¤‡ä»½åŸæ–‡ä»¶åˆ°: $BACKUP_FILE"
          echo "ğŸ“Š å¤‡ä»½æ–‡ä»¶å¤§å°: $(wc -l < "$BACKUP_FILE") è¡Œ"
          
          # åˆ›å»ºä¸´æ—¶å·¥ä½œæ–‡ä»¶
          TEMP_DIR="/mnt/openwrt-build/ä¸´æ—¶ä¿®å¤æ–‡ä»¶"
          mkdir -p "$TEMP_DIR"
          
          TEMP_WORKFLOW="$TEMP_DIR/firmware-build.yml.ä¸´æ—¶"
          cp "$TARGET_WORKFLOW" "$TEMP_WORKFLOW"
          echo "âœ… åˆ›å»ºä¸´æ—¶å·¥ä½œæ–‡ä»¶: $TEMP_WORKFLOW"
          
          # å¤„ç†å·¥ä½œæµæ­¥éª¤ä¿®å¤
          echo ""
          echo "ğŸ”§ å¼€å§‹å¤„ç†å·¥ä½œæµä¿®å¤..."
          echo "ğŸ“Š éœ€è¦å¤„ç†çš„å·¥ä½œæµä¿®å¤æ•°é‡: ${{ steps.parse_fixes.outputs.workflow_fixes_count }}"
          
          # æ˜¾ç¤ºæ‰¾åˆ°çš„ä¿®å¤æ ‡è¯†
          echo ""
          echo "ğŸ“‹ æ‰¾åˆ°çš„å·¥ä½œæµä¿®å¤æ ‡è¯†:"
          grep "^#ã€firmware-build.yml-" "$FIX_FILE" || echo "  æœªæ‰¾åˆ°å·¥ä½œæµä¿®å¤æ ‡è¯†"
          
          # å¦‚æœæ˜¯dry runï¼Œåªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo ""
            echo "ğŸ” Dry runæ¨¡å¼ - æ˜¾ç¤ºä¿®æ”¹è®¡åˆ’"
            echo "ğŸ“‹ å°†ä¿®æ”¹ä»¥ä¸‹æ­¥éª¤:"
            
            # æå–æ­¥éª¤å·
            grep "^#ã€firmware-build.yml-" "$FIX_FILE" | while read LINE; do
              if [[ "$LINE" =~ firmware-build.yml-([0-9]+) ]]; then
                STEP_NUM="${BASH_REMATCH[1]}"
                echo "  - æ­¥éª¤ $STEP_NUM"
              elif [[ "$LINE" =~ æ–°æ­¥éª¤ ]]; then
                echo "  - æ–°æ­¥éª¤"
              fi
            done
            
            echo ""
            echo "ğŸ“Š åŸå·¥ä½œæµæ–‡ä»¶å†…å®¹é¢„è§ˆ (æ­¥éª¤åŒºåŸŸ):"
            grep -n "name:" "$TARGET_WORKFLOW" | head -30
          else
            echo "ğŸ”„ å®é™…åº”ç”¨ä¿®å¤..."
            # è¿™é‡Œå®ç°å®é™…çš„ä¿®å¤é€»è¾‘
            echo "ğŸ“ ä¿®å¤é€»è¾‘å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°"
          fi
          
      - name: ç”Ÿæˆä¿®å¤æŠ¥å‘Š
        run: |
          echo "=== ä¿®å¤æŠ¥å‘Š ==="
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          
          echo "ğŸ“Š ä¿®å¤å¤„ç†æ‘˜è¦:"
          echo "  - è§£æçš„æ ‡è¯†æ•°é‡: ${{ steps.parse_fixes.outputs.identifiers_count }}"
          echo "  - è„šæœ¬ä¿®å¤æ•°é‡: ${{ steps.parse_fixes.outputs.script_fixes_count }}"
          echo "  - å·¥ä½œæµä¿®å¤æ•°é‡: ${{ steps.parse_fixes.outputs.workflow_fixes_count }}"
          echo "  - æ–°å‡½æ•°æ•°é‡: ${{ steps.parse_fixes.outputs.new_functions_count }}"
          echo "  - æ–°æ­¥éª¤æ•°é‡: ${{ steps.parse_fixes.outputs.new_steps_count }}"
          echo ""
          
          # æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶
          BACKUP_DIR="/mnt/openwrt-build/å¤‡ä»½æ–‡ä»¶"
          echo "ğŸ“ å¤‡ä»½æ–‡ä»¶ç›®å½•: $BACKUP_DIR"
          if [ -d "$BACKUP_DIR" ]; then
            echo "ğŸ“‚ å¤‡ä»½æ–‡ä»¶åˆ—è¡¨:"
            ls -la "$BACKUP_DIR/" 2>/dev/null || echo "  å¤‡ä»½ç›®å½•ä¸ºç©º"
          else
            echo "âŒ å¤‡ä»½ç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo ""
          
          # æ˜¾ç¤ºä¸´æ—¶æ–‡ä»¶
          TEMP_DIR="/mnt/openwrt-build/ä¸´æ—¶ä¿®å¤æ–‡ä»¶"
          echo "ğŸ“ ä¸´æ—¶æ–‡ä»¶ç›®å½•: $TEMP_DIR"
          if [ -d "$TEMP_DIR" ]; then
            echo "ğŸ“‚ ä¸´æ—¶æ–‡ä»¶åˆ—è¡¨:"
            ls -la "$TEMP_DIR/" 2>/dev/null || echo "  ä¸´æ—¶ç›®å½•ä¸ºç©º"
          else
            echo "âŒ ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨"
          fi
          
      - name: åˆ›å»ºæ€»ç»“æŠ¥å‘Š
        if: always()
        run: |
          echo "### è‡ªåŠ¨ä¿®å¤å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**çŠ¶æ€:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å¤„ç†æ‘˜è¦:**" >> $GITHUB_STEP_SUMMARY
          echo "- è§£æä¿®å¤æ ‡è¯†: ${{ steps.parse_fixes.outputs.identifiers_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- è„šæœ¬ä¿®å¤: ${{ steps.parse_fixes.outputs.script_fixes_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- å·¥ä½œæµä¿®å¤: ${{ steps.parse_fixes.outputs.workflow_fixes_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- æ–°å‡½æ•°: ${{ steps.parse_fixes.outputs.new_functions_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- æ–°æ­¥éª¤: ${{ steps.parse_fixes.outputs.new_steps_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "**æ¨¡å¼:** ğŸŸ¡ Dry Run (åªæ˜¾ç¤ºä¿®æ”¹è®¡åˆ’)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ­¤è¿è¡Œä»…æ˜¾ç¤ºä¿®æ”¹è®¡åˆ’ï¼Œæœªå®é™…ä¿®æ”¹æ–‡ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "**æ¨¡å¼:** ğŸŸ¢ å®é™…ä¿®å¤" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ–‡ä»¶å·²æ ¹æ®ä¿®å¤æ–¹æ¡ˆè¿›è¡Œæ›´æ–°ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¯¦ç»†ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- ä¿®å¤æ–‡ä»¶: ${{ steps.parse_fixes.outputs.fix_file_path }}" >> $GITHUB_STEP_SUMMARY
          echo "- å¤‡ä»½ç›®å½•: /mnt/openwrt-build/å¤‡ä»½æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- ä¸´æ—¶ç›®å½•: /mnt/openwrt-build/ä¸´æ—¶ä¿®å¤æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          
      - name: æäº¤æ›´æ”¹ (å¦‚æœä¸æ˜¯å¹²è¿è¡Œ)
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == false && job.status == 'success'
        run: |
          echo "=== æäº¤æ›´æ”¹ ==="
          
          # é…ç½®git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet; then
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
            
            # æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶
            git add firmware-config/scripts/build_firmware_main.sh .github/workflows/firmware-build.yml
            
            # æäº¤
            git commit -m "ğŸ”§ è‡ªåŠ¨ä¿®å¤: æ ¹æ® fix.txt æ›´æ–°æ–‡ä»¶ [skip ci]"
            
            # æ¨é€
            git push
            echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
          fi
