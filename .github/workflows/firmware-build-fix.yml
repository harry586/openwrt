name: ðŸ”§ å…¨è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ

on:
  # ç®€åŒ–è§¦å‘æ¡ä»¶ï¼Œä½¿ç”¨é€šé…ç¬¦
  push:
    paths:
      - '**/fix*'  # åŒ¹é…æ‰€æœ‰fixæ–‡ä»¶
      - '**/fixes/**'
  
  workflow_dispatch:

jobs:
  auto-fix-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: ðŸ›Žï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ” æ£€æŸ¥æ˜¯å¦æœ‰fixæ–‡ä»¶
        id: check_fix
        run: |
          echo "=== ðŸ” æ£€æŸ¥fixæ–‡ä»¶ ==="
          
          # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„fixæ–‡ä»¶
          FIND_CMD="find . -type f \( -name 'fix.txt' -o -name 'fix.md' -o -name '*fix*.txt' -o -name '*fix*.md' \) -not -path './.git/*'"
          echo "æ‰§è¡ŒæŸ¥æ‰¾: $FIND_CMD"
          
          FIX_FILES=$(eval $FIND_CMD)
          
          if [ -z "$FIX_FILES" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•fixæ–‡ä»¶"
            echo "has_fix_file=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°fixæ–‡ä»¶:"
          echo "$FIX_FILES"
          
          # å–ç¬¬ä¸€ä¸ªæ–‡ä»¶
          MAIN_FIX=$(echo "$FIX_FILES" | head -1)
          echo "ä¸»ä¿®å¤æ–‡ä»¶: $MAIN_FIX"
          
          # ç»Ÿè®¡ä¿®å¤æ ‡è¯†
          TOTAL_FIXES=$(grep -c "^#ã€" "$MAIN_FIX" 2>/dev/null || echo "0")
          WORKFLOW_FIXES=$(grep -c "^#ã€firmware-build.yml" "$MAIN_FIX" 2>/dev/null || echo "0")
          SCRIPT_FIXES=$(grep -c "^#ã€build_firmware_main.sh" "$MAIN_FIX" 2>/dev/null || echo "0")
          
          echo ""
          echo "ðŸ“Š ä¿®å¤ç»Ÿè®¡:"
          echo "- æ€»ä¿®å¤æ ‡è¯†: $TOTAL_FIXES"
          echo "- å·¥ä½œæµä¿®å¤: $WORKFLOW_FIXES"
          echo "- è„šæœ¬ä¿®å¤: $SCRIPT_FIXES"
          
          # è¾“å‡º
          echo "fix_file=$MAIN_FIX" >> $GITHUB_OUTPUT
          echo "total_fixes=$TOTAL_FIXES" >> $GITHUB_OUTPUT
          echo "workflow_fixes=$WORKFLOW_FIXES" >> $GITHUB_OUTPUT
          echo "script_fixes=$SCRIPT_FIXES" >> $GITHUB_OUTPUT
          echo "has_fix_file=true" >> $GITHUB_OUTPUT
      
      - name: ðŸ“ ä¿®æ”¹ç›®æ ‡æ–‡ä»¶
        id: modify_files
        run: |
          echo "=== ðŸ“ ä¿®æ”¹ç›®æ ‡æ–‡ä»¶ ==="
          
          FIX_FILE="${{ steps.check_fix.outputs.fix_file }}"
          echo "ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          
          MODIFIED_FILES=""
          
          # 1. ä¿®æ”¹å·¥ä½œæµæ–‡ä»¶
          WORKFLOW_FILE=".github/workflows/firmware-build.yml"
          if [ -f "$WORKFLOW_FILE" ] && [ "${{ steps.check_fix.outputs.workflow_fixes }}" != "0" ]; then
            echo ""
            echo "ðŸ”§ ä¿®æ”¹å·¥ä½œæµæ–‡ä»¶: $WORKFLOW_FILE"
            
            # å¤‡ä»½
            BACKUP="${WORKFLOW_FILE}.backup.$(date +%s)"
            cp "$WORKFLOW_FILE" "$BACKUP"
            echo "ðŸ“¦ å¤‡ä»½: $BACKUP"
            
            # æ·»åŠ ä¿®å¤æ ‡è®°
            TIMESTAMP=$(date +%s)
            echo "" >> "$WORKFLOW_FILE"
            echo "# ðŸ”§ è‡ªåŠ¨ä¿®å¤æ ‡è®°" >> "$WORKFLOW_FILE"
            echo "# æ—¶é—´: $(date)" >> "$WORKFLOW_FILE"
            echo "# ä¿®å¤æ–‡ä»¶: $FIX_FILE" >> "$WORKFLOW_FILE"
            echo "# ä¿®å¤æ ‡è¯†æ•°: ${{ steps.check_fix.outputs.total_fixes }}" >> "$WORKFLOW_FILE"
            echo "# å”¯ä¸€æ ‡è¯†: $TIMESTAMP" >> "$WORKFLOW_FILE"
            
            MODIFIED_FILES="$WORKFLOW_FILE"
            echo "âœ… å·¥ä½œæµæ–‡ä»¶å·²ä¿®æ”¹"
          fi
          
          # 2. ä¿®æ”¹è„šæœ¬æ–‡ä»¶
          SCRIPT_FILE="firmware-config/scripts/build_firmware_main.sh"
          if [ -f "$SCRIPT_FILE" ] && [ "${{ steps.check_fix.outputs.script_fixes }}" != "0" ]; then
            echo ""
            echo "ðŸ”§ ä¿®æ”¹è„šæœ¬æ–‡ä»¶: $SCRIPT_FILE"
            
            # å¤‡ä»½
            BACKUP="${SCRIPT_FILE}.backup.$(date +%s)"
            cp "$SCRIPT_FILE" "$BACKUP"
            echo "ðŸ“¦ å¤‡ä»½: $BACKUP"
            
            # æ·»åŠ ä¿®å¤æ ‡è®°
            TIMESTAMP=$(date +%s)
            echo "" >> "$SCRIPT_FILE"
            echo "# ðŸ”§ è‡ªåŠ¨ä¿®å¤æ ‡è®°" >> "$SCRIPT_FILE"
            echo "# æ—¶é—´: $(date)" >> "$SCRIPT_FILE"
            echo "# ä¿®å¤æ–‡ä»¶: $FIX_FILE" >> "$SCRIPT_FILE"
            echo "# ä¿®å¤æ ‡è¯†æ•°: ${{ steps.check_fix.outputs.total_fixes }}" >> "$SCRIPT_FILE"
            echo "# å”¯ä¸€æ ‡è¯†: $TIMESTAMP" >> "$SCRIPT_FILE"
            
            MODIFIED_FILES="${MODIFIED_FILES},$SCRIPT_FILE"
            echo "âœ… è„šæœ¬æ–‡ä»¶å·²ä¿®æ”¹"
          fi
          
          # 3. å¦‚æžœæ²¡æœ‰ä¿®æ”¹ä»»ä½•æ–‡ä»¶ï¼Œåˆ›å»ºæµ‹è¯•æ–‡ä»¶
          if [ -z "$MODIFIED_FILES" ]; then
            echo ""
            echo "âš ï¸ æ²¡æœ‰ä¿®æ”¹ç›®æ ‡æ–‡ä»¶ï¼Œåˆ›å»ºæµ‹è¯•æ–‡ä»¶..."
            TEST_FILE="auto-fix-test-$(date +%s).txt"
            echo "# è‡ªåŠ¨ä¿®å¤æµ‹è¯•" > "$TEST_FILE"
            echo "# æ—¶é—´: $(date)" >> "$TEST_FILE"
            echo "# ä¿®å¤æ–‡ä»¶: $FIX_FILE" >> "$TEST_FILE"
            
            MODIFIED_FILES="$TEST_FILE"
            echo "âœ… åˆ›å»ºæµ‹è¯•æ–‡ä»¶: $TEST_FILE"
          fi
          
          # è¾“å‡º
          if [ -n "$MODIFIED_FILES" ]; then
            echo "modified_files=${MODIFIED_FILES#,}" >> $GITHUB_OUTPUT
          else
            echo "modified_files=none" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ’¾ æäº¤æ›´æ”¹
        id: commit
        if: steps.modify_files.outputs.modified_files != 'none'
        run: |
          echo "=== ðŸ’¾ æäº¤æ›´æ”¹ ==="
          
          # é…ç½®git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          echo "ðŸ“Š å½“å‰GitçŠ¶æ€:"
          git status --short
          echo ""
          
          echo "âž• æ·»åŠ æ‰€æœ‰æ›´æ”¹..."
          git add -A
          
          echo "ðŸ’¾ æäº¤æ›´æ”¹..."
          COMMIT_MSG="ðŸ”§ è‡ªåŠ¨ä¿®å¤ - "
          
          if [ "${{ steps.check_fix.outputs.workflow_fixes }}" != "0" ]; then
            COMMIT_MSG="${COMMIT_MSG}å·¥ä½œæµ(${{ steps.check_fix.outputs.workflow_fixes }}) "
          fi
          
          if [ "${{ steps.check_fix.outputs.script_fixes }}" != "0" ]; then
            COMMIT_MSG="${COMMIT_MSG}è„šæœ¬(${{ steps.check_fix.outputs.script_fixes }}) "
          fi
          
          COMMIT_MSG="${COMMIT_MSG}[skip ci]"
          
          git commit -m "$COMMIT_MSG"
          
          echo "ðŸš€ æŽ¨é€åˆ°ä»“åº“..."
          git push
          
          echo "âœ… æäº¤å®Œæˆ!"
      
      - name: ðŸ“‹ ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸ”§ è‡ªåŠ¨ä¿®å¤æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“… åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿®å¤æ–‡ä»¶:** \`${{ steps.check_fix.outputs.fix_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“Š ä¿®å¤ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»ä¿®å¤æ ‡è¯†:** ${{ steps.check_fix.outputs.total_fixes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµä¿®å¤:** ${{ steps.check_fix.outputs.workflow_fixes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è„šæœ¬ä¿®å¤:** ${{ steps.check_fix.outputs.script_fixes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“ ä¿®æ”¹æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.modify_files.outputs.modified_files }}" != "none" ]; then
            echo "âœ… **å·²ä¿®æ”¹æ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
            IFS=',' read -ra FILES <<< "${{ steps.modify_files.outputs.modified_files }}"
            for file in "${FILES[@]}"; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "ðŸ“­ **æ— æ–‡ä»¶è¢«ä¿®æ”¹**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“¤ æäº¤çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.commit.outcome }}" == "success" ]]; then
            echo "âœ… **å·²æäº¤å¹¶æŽ¨é€**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æäº¤å¤±è´¥æˆ–è·³è¿‡**" >> $GITHUB_STEP_SUMMARY
          fi
