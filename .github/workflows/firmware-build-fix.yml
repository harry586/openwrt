name: ðŸ”§ è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿï¼ˆPR + è‡ªåŠ¨åˆå¹¶ï¼‰

on:
  push:
    paths:
      - 'firmware-config/fix.txt'
      - 'fix.txt'
      - '.github/workflows/auto-fix.yml'
  
  workflow_dispatch:
    inputs:
      auto_merge:
        description: 'è‡ªåŠ¨åˆå¹¶PR'
        required: false
        default: true
        type: boolean

jobs:
  analyze-fixes:
    runs-on: ubuntu-latest
    outputs:
      has_fixes: ${{ steps.analyze.outputs.has_fixes }}
      total_fixes: ${{ steps.analyze.outputs.total_fixes }}
      script_fixes: ${{ steps.analyze.outputs.script_fixes }}
      workflow_fixes: ${{ steps.analyze.outputs.workflow_fixes }}
      fix_file: ${{ steps.analyze.outputs.fix_file }}
    
    steps:
      - name: ðŸ›Žï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ” åˆ†æžä¿®å¤æ–‡ä»¶
        id: analyze
        run: |
          echo "=== åˆ†æžä¿®å¤æ–‡ä»¶ ==="
          
          if [ -f "firmware-config/fix.txt" ]; then
            FIX_FILE="firmware-config/fix.txt"
          elif [ -f "fix.txt" ]; then
            FIX_FILE="fix.txt"
          else
            echo "âŒ æœªæ‰¾åˆ°ä¿®å¤æ–‡ä»¶"
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… ä¿®å¤æ–‡ä»¶: $FIX_FILE"
          
          TOTAL_FIXES=$(grep -c "^#ã€" "$FIX_FILE" 2>/dev/null || echo "0")
          SCRIPT_FIXES=$(grep -c "^#ã€build_firmware_main.sh" "$FIX_FILE" 2>/dev/null || echo "0")
          WORKFLOW_FIXES=$(grep -c "^#ã€firmware-build.yml" "$FIX_FILE" 2>/dev/null || echo "0")
          
          echo "ðŸ“Š ä¿®å¤ç»Ÿè®¡:"
          echo "- æ€»ä¿®å¤æ ‡è¯†: $TOTAL_FIXES"
          echo "- è„šæœ¬ä¿®å¤: $SCRIPT_FIXES"
          echo "- å·¥ä½œæµä¿®å¤: $WORKFLOW_FIXES"
          
          if [ "$TOTAL_FIXES" -eq "0" ]; then
            echo "âš ï¸ ä¿®å¤æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ä¿®å¤æ ‡è¯†"
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_fixes=true" >> $GITHUB_OUTPUT
          echo "total_fixes=$TOTAL_FIXES" >> $GITHUB_OUTPUT
          echo "script_fixes=$SCRIPT_FIXES" >> $GITHUB_OUTPUT
          echo "workflow_fixes=$WORKFLOW_FIXES" >> $GITHUB_OUTPUT
          echo "fix_file=$FIX_FILE" >> $GITHUB_OUTPUT

  apply-fixes-and-pr:
    runs-on: ubuntu-latest
    needs: analyze-fixes
    if: needs.analyze-fixes.outputs.has_fixes == 'true'
    # å…³é”®ï¼šéœ€è¦pull-requestsæƒé™
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ðŸ›Žï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸŒ¿ åˆ›å»ºä¿®å¤åˆ†æ”¯
        run: |
          echo "=== åˆ›å»ºä¿®å¤åˆ†æ”¯ ==="
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="auto-fix/$TIMESTAMP"
          
          echo "åˆ›å»ºåˆ†æ”¯: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
          echo "âœ… å·²åˆ‡æ¢åˆ°åˆ†æ”¯: $BRANCH_NAME"
      
      - name: ðŸ”§ åº”ç”¨è„šæœ¬ä¿®å¤
        if: needs.analyze-fixes.outputs.script_fixes != '0'
        run: |
          echo "=== åº”ç”¨è„šæœ¬ä¿®å¤ ==="
          
          SCRIPT_FILE="firmware-config/scripts/build_firmware_main.sh"
          FIX_FILE="${{ needs.analyze-fixes.outputs.fix_file }}"
          
          if [ ! -f "$SCRIPT_FILE" ]; then
            echo "âŒ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $SCRIPT_FILE"
            exit 1
          fi
          
          echo "ðŸ“„ ä¿®æ”¹è„šæœ¬æ–‡ä»¶: $SCRIPT_FILE"
          
          # å¤‡ä»½
          BACKUP_FILE="${SCRIPT_FILE}.backup.$(date +%s)"
          cp "$SCRIPT_FILE" "$BACKUP_FILE"
          echo "ðŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_FILE"
          
          # æå–å¹¶åº”ç”¨ä¿®å¤
          LINE_NUMBER=0
          IN_SCRIPT_BLOCK=false
          SCRIPT_FIX_CONTENT=""
          SCRIPT_BLOCK_COUNT=0
          
          while IFS= read -r line; do
            LINE_NUMBER=$((LINE_NUMBER + 1))
            
            if [[ "$line" =~ ^#ã€build_firmware_main.sh ]]; then
              IN_SCRIPT_BLOCK=true
              SCRIPT_FIX_CONTENT=""
              echo "ðŸŽ¯ æ‰¾åˆ°è„šæœ¬ä¿®å¤å—"
              SCRIPT_BLOCK_COUNT=$((SCRIPT_BLOCK_COUNT + 1))
              
            elif [[ "$line" =~ ^#ã€endã€‘ ]] || [[ "$line" =~ ^#ã€ç»“æŸã€‘ ]]; then
              if [ "$IN_SCRIPT_BLOCK" = true ]; then
                echo "ðŸ”„ åº”ç”¨è„šæœ¬ä¿®å¤å— #$SCRIPT_BLOCK_COUNT"
                
                echo "" >> "$SCRIPT_FILE"
                echo "# ===== è‡ªåŠ¨ä¿®å¤å— #$SCRIPT_BLOCK_COUNT =====" >> "$SCRIPT_FILE"
                echo "# æ¥æº: $FIX_FILE" >> "$SCRIPT_FILE"
                echo "# æ—¶é—´: $(date)" >> "$SCRIPT_FILE"
                echo "$SCRIPT_FIX_CONTENT" >> "$SCRIPT_FILE"
                
                IN_SCRIPT_BLOCK=false
              fi
              
            elif [ "$IN_SCRIPT_BLOCK" = true ]; then
              SCRIPT_FIX_CONTENT="${SCRIPT_FIX_CONTENT}${line}"$'\n'
            fi
          done < "$FIX_FILE"
          
          # å¤„ç†æœ€åŽä¸€ä¸ªå—
          if [ "$IN_SCRIPT_BLOCK" = true ] && [ -n "$SCRIPT_FIX_CONTENT" ]; then
            echo "ðŸ”„ åº”ç”¨æœ€åŽä¸€ä¸ªè„šæœ¬ä¿®å¤å—"
            echo "" >> "$SCRIPT_FILE"
            echo "# ===== è‡ªåŠ¨ä¿®å¤å— #$SCRIPT_BLOCK_COUNT =====" >> "$SCRIPT_FILE"
            echo "# æ¥æº: $FIX_FILE" >> "$SCRIPT_FILE"
            echo "# æ—¶é—´: $(date)" >> "$SCRIPT_FILE"
            echo "$SCRIPT_FIX_CONTENT" >> "$SCRIPT_FILE"
          fi
          
          echo "âœ… åº”ç”¨äº† $SCRIPT_BLOCK_COUNT ä¸ªè„šæœ¬ä¿®å¤å—"
          echo "script_modified=true" >> $GITHUB_ENV
      
      - name: ðŸ”§ åˆ›å»ºå·¥ä½œæµä¿®å¤æ–‡ä»¶
        if: needs.analyze-fixes.outputs.workflow_fixes != '0'
        run: |
          echo "=== åˆ›å»ºå·¥ä½œæµä¿®å¤æ–‡ä»¶ ==="
          
          FIX_FILE="${{ needs.analyze-fixes.outputs.fix_file }}"
          TIMESTAMP=$(date +%s)
          
          WORKFLOW_FIX_FILE="workflow-fixes-${TIMESTAMP}.yml"
          
          echo "# ðŸ”§ å·¥ä½œæµä¿®å¤æ–‡ä»¶" > "$WORKFLOW_FIX_FILE"
          echo "# ç”Ÿæˆæ—¶é—´: $(date)" >> "$WORKFLOW_FIX_FILE"
          echo "# æ¥æº: $FIX_FILE" >> "$WORKFLOW_FIX_FILE"
          echo "" >> "$WORKFLOW_FIX_FILE"
          
          # æå–å·¥ä½œæµä¿®å¤å†…å®¹
          grep -A 100 "^#ã€firmware-build.yml" "$FIX_FILE" | head -150 >> "$WORKFLOW_FIX_FILE"
          
          echo "âœ… åˆ›å»ºå·¥ä½œæµä¿®å¤æ–‡ä»¶: $WORKFLOW_FIX_FILE"
          echo "workflow_fix_file=$WORKFLOW_FIX_FILE" >> $GITHUB_ENV
      
      - name: ðŸ’¾ æäº¤æ›´æ”¹
        run: |
          echo "=== æäº¤æ›´æ”¹ ==="
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          echo "ðŸ“Š GitçŠ¶æ€:"
          git status --short
          echo ""
          
          echo "âž• æ·»åŠ æ›´æ”¹..."
          
          # ç¡®ä¿æœ‰æ–‡ä»¶å¯æäº¤
          if [ -n "${{ env.script_modified }}" ]; then
            git add "firmware-config/scripts/build_firmware_main.sh"
            echo "âœ… æ·»åŠ è„šæœ¬æ–‡ä»¶"
          fi
          
          if [ -n "${{ env.workflow_fix_file }}" ]; then
            git add "${{ env.workflow_fix_file }}"
            echo "âœ… æ·»åŠ å·¥ä½œæµä¿®å¤æ–‡ä»¶"
          fi
          
          # å¦‚æžœæ²¡æœ‰æ–‡ä»¶å¯æ·»åŠ ï¼Œåˆ›å»ºæ ‡è®°æ–‡ä»¶
          if [ -z "${{ env.script_modified }}" ] && [ -z "${{ env.workflow_fix_file }}" ]; then
            echo "âš ï¸ æ²¡æœ‰æ–‡ä»¶ä¿®æ”¹ï¼Œåˆ›å»ºæ ‡è®°æ–‡ä»¶"
            MARKER_FILE="auto-fix-marker-$(date +%s).txt"
            echo "# è‡ªåŠ¨ä¿®å¤æ ‡è®°" > "$MARKER_FILE"
            echo "# æ—¶é—´: $(date)" >> "$MARKER_FILE"
            git add "$MARKER_FILE"
          fi
          
          echo ""
          echo "ðŸ’¾ æäº¤æ›´æ”¹..."
          
          COMMIT_MSG="ðŸ”§ è‡ªåŠ¨ä¿®å¤"
          
          if [ "${{ needs.analyze-fixes.outputs.script_fixes }}" != "0" ]; then
            COMMIT_MSG="${COMMIT_MSG} - è„šæœ¬(${{ needs.analyze-fixes.outputs.script_fixes }})"
          fi
          
          if [ "${{ needs.analyze-fixes.outputs.workflow_fixes }}" != "0" ]; then
            COMMIT_MSG="${COMMIT_MSG} - å·¥ä½œæµ(${{ needs.analyze-fixes.outputs.workflow_fixes }})"
          fi
          
          git commit -m "$COMMIT_MSG" || exit 0
          
          echo "ðŸš€ æŽ¨é€åˆ†æ”¯..."
          git push origin "${{ env.branch_name }}"
          
          echo "âœ… åˆ†æ”¯å·²æŽ¨é€: ${{ env.branch_name }}"
      
      - name: ðŸ“¨ åˆ›å»ºPull Requestï¼ˆç®€åŒ–ç‰ˆï¼‰
        id: create-pr
        run: |
          echo "=== åˆ›å»ºPull Request ==="
          
          # ä½¿ç”¨GitHub CLIåˆ›å»ºPR
          PR_TITLE="ðŸ”§ è‡ªåŠ¨ä¿®å¤"
          PR_BODY="## è‡ªåŠ¨ä¿®å¤
          
          **ä¿®å¤ç»Ÿè®¡:**
          - æ€»ä¿®å¤æ ‡è¯†: ${{ needs.analyze-fixes.outputs.total_fixes }} ä¸ª
          - è„šæœ¬ä¿®å¤: ${{ needs.analyze-fixes.outputs.script_fixes }} ä¸ª
          - å·¥ä½œæµä¿®å¤: ${{ needs.analyze-fixes.outputs.workflow_fixes }} ä¸ª
          
          **ä¿®å¤æ–‡ä»¶:** \`${{ needs.analyze-fixes.outputs.fix_file }}\`
          
          > è‡ªåŠ¨åˆ›å»ºäºŽ $(date)"
          
          echo "åˆ›å»ºPR: $PR_TITLE"
          echo "ä»Žåˆ†æ”¯: ${{ env.branch_name }} åˆ° main"
          
          # åˆ›å»ºPR
          PR_RESULT=$(gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "${{ env.branch_name }}" \
            --label "automated-pr,fix" 2>&1)
          
          echo "PRåˆ›å»ºç»“æžœ: $PR_RESULT"
          
          # æå–PRå·
          if [[ "$PR_RESULT" =~ pull\/([0-9]+) ]]; then
            PR_NUMBER="${BASH_REMATCH[1]}"
            echo "âœ… PRåˆ›å»ºæˆåŠŸ: #$PR_NUMBER"
            echo "pr_number=$PR_NUMBER" >> $GITHUB_ENV
            echo "pr_url=https://github.com/${{ github.repository }}/pull/$PR_NUMBER" >> $GITHUB_ENV
          else
            echo "âŒ PRåˆ›å»ºå¤±è´¥"
            echo "é”™è¯¯è¯¦æƒ…: $PR_RESULT"
            echo "pr_number=0" >> $GITHUB_ENV
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ”„ è‡ªåŠ¨åˆå¹¶PR
        if: |
          (github.event.inputs.auto_merge == 'true' || github.event_name == 'push') &&
          env.pr_number != '0'
        run: |
          echo "=== è‡ªåŠ¨åˆå¹¶PR ==="
          
          echo "PRå·: ${{ env.pr_number }}"
          echo "ç­‰å¾…3ç§’..."
          sleep 3
          
          echo "ðŸ”„ åˆå¹¶PR..."
          
          # åˆå¹¶PR
          MERGE_RESULT=$(gh pr merge "${{ env.pr_number }}" \
            --squash \
            --delete-branch \
            --body "âœ… è‡ªåŠ¨åˆå¹¶å®Œæˆ" 2>&1)
          
          echo "åˆå¹¶ç»“æžœ: $MERGE_RESULT"
          
          if [[ "$MERGE_RESULT" == *"Merged pull request"* ]] || [[ "$MERGE_RESULT" == *"already merged"* ]]; then
            echo "âœ… PRå·²åˆå¹¶"
            echo "pr_merged=true" >> $GITHUB_ENV
          else
            echo "âŒ åˆå¹¶å¤±è´¥"
            echo "é”™è¯¯: $MERGE_RESULT"
            echo "pr_merged=false" >> $GITHUB_ENV
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“‹ ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸ”§ è‡ªåŠ¨ä¿®å¤ç³»ç»ŸæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“… åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿®å¤æ–‡ä»¶:** \`${{ needs.analyze-fixes.outputs.fix_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“Š ä¿®å¤ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»ä¿®å¤æ ‡è¯†:** ${{ needs.analyze-fixes.outputs.total_fixes }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **è„šæœ¬ä¿®å¤:** ${{ needs.analyze-fixes.outputs.script_fixes }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµä¿®å¤:** ${{ needs.analyze-fixes.outputs.workflow_fixes }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸŒ¿ åˆ†æ”¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿®å¤åˆ†æ”¯:** \`${{ env.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“ ä¿®æ”¹å†…å®¹" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ env.script_modified }}" ]; then
            echo "- âœ… **è„šæœ¬æ–‡ä»¶å·²ä¿®æ”¹:** \`firmware-config/scripts/build_firmware_main.sh\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ env.workflow_fix_file }}" ]; then
            echo "- ðŸ“„ **åˆ›å»ºå·¥ä½œæµä¿®å¤æ–‡ä»¶:** \`${{ env.workflow_fix_file }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“¨ PRçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ env.pr_number }}" != "0" ]]; then
            echo "âœ… **Pull Requestå·²åˆ›å»º**" >> $GITHUB_STEP_SUMMARY
            echo "- **PRå·:** #${{ env.pr_number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PRé“¾æŽ¥:** [${{ env.branch_name }} â†’ main](${{ env.pr_url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ env.pr_merged }}" == "true" ]]; then
              echo "ðŸ”„ **PRå·²è‡ªåŠ¨åˆå¹¶**" >> $GITHUB_STEP_SUMMARY
              echo "âœ… ä¿®å¤å·²åº”ç”¨åˆ°ä¸»åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ github.event.inputs.auto_merge }}" == "true" ]]; then
              echo "â³ **ç­‰å¾…åˆå¹¶ä¸­...**" >> $GITHUB_STEP_SUMMARY
              echo "> è¯·æ£€æŸ¥PRçŠ¶æ€æˆ–ç¨åŽæŸ¥çœ‹" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ‘ï¸ **éœ€è¦æ‰‹åŠ¨åˆå¹¶**" >> $GITHUB_STEP_SUMMARY
              echo "> è¯·å‰å¾€PRé¡µé¢æŸ¥çœ‹å¹¶åˆå¹¶æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **PRåˆ›å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "> å¯èƒ½åŽŸå› ï¼šæƒé™ä¸è¶³æˆ–åˆ†æ”¯å·²å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          fi
