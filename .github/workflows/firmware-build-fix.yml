# .github/workflows/firmware-build-fix.yml
name: è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿæ€§æ ‡è¯†å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      target_files:
        description: "è¦ä¿®å¤çš„ç›®æ ‡æ–‡ä»¶ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰"
        required: false
        default: "all"
        type: string
      dry_run:
        description: "ä»…é¢„è§ˆä¸æ‰§è¡Œä¿®æ”¹"
        required: false
        default: "false"
        type: choice
        options: ["true", "false"]

jobs:
  fix-systematic-ids:
    runs-on: ubuntu-22.04
    steps:
      - name: "1. æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        
      - name: "2. å®‰è£…ä¾èµ–å·¥å…·"
        run: |
          echo "å®‰è£…æ–‡æœ¬å¤„ç†å·¥å…·..."
          sudo apt-get update
          sudo apt-get install -y tree grep sed awk findutils
          
      - name: "3. è¿è¡Œä¿®æ”¹æ„è§è„šæœ¬"
        run: |
          echo "=== è¿è¡Œä¿®æ”¹æ„è§è„šæœ¬ ==="
          echo "ç›®æ ‡æ–‡ä»¶: ${{ github.event.inputs.target_files }}"
          echo "é¢„è§ˆæ¨¡å¼: ${{ github.event.inputs.dry_run }}"
          
          # åˆ›å»ºä¿®æ”¹æ„è§è„šæœ¬
          cat > /tmp/modification_script.sh << 'EOF'
          #!/bin/bash
          # ä¿®æ”¹æ„è§è„šæœ¬ - è‡ªåŠ¨æ ¹æ®ç³»ç»Ÿæ€§æ ‡è¯†ä¿®å¤æ–‡ä»¶
          #ã€modification-script-01ã€‘è„šæœ¬å¼€å§‹
          
          set -e
          
          TARGET_FILES="$1"
          DRY_RUN="$2"
          REPO_ROOT="$GITHUB_WORKSPACE"
          
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
          
          #ã€modification-script-02ã€‘å‡½æ•°å®šä¹‰å¼€å§‹
          
          # æ¨¡ç³Šæœç´¢æ–‡ä»¶
          fuzzy_find_file() {
            local pattern="$1"
            local search_dir="${2:-.}"
            
            # å¤šç§æœç´¢ç­–ç•¥
            local found_files=""
            
            # 1. ç›´æ¥æŸ¥æ‰¾
            if [ -f "$pattern" ]; then
              echo "$pattern"
              return 0
            fi
            
            # 2. ä½¿ç”¨findæŸ¥æ‰¾
            found_files=$(find "$search_dir" -type f -name "*$(basename "$pattern")*" 2>/dev/null | head -5)
            if [ -n "$found_files" ]; then
              echo "$found_files" | head -1
              return 0
            fi
            
            # 3. æŸ¥æ‰¾åŒ…å«æ ‡è¯†çš„æ–‡ä»¶
            found_files=$(find "$search_dir" -type f -exec grep -l "#ã€$pattern" {} \; 2>/dev/null | head -5)
            if [ -n "$found_files" ]; then
              echo "$found_files" | head -1
              return 0
            fi
            
            # 4. é€’å½’æŸ¥æ‰¾
            found_files=$(find "$search_dir" -type f -exec grep -l "$(echo "$pattern" | sed 's/\./\\./g')" {} \; 2>/dev/null | head -5)
            if [ -n "$found_files" ]; then
              echo "$found_files" | head -1
              return 0
            fi
            
            echo ""
            return 1
          }
          
          # æå–æ–‡ä»¶åå‰ç¼€
          extract_file_prefix() {
            local file_path="$1"
            local filename=$(basename "$file_path")
            echo "${filename%.*}" | sed 's/[^a-zA-Z0-9_-]//g'
          }
          
          # ä¿®å¤å•ä¸ªæ–‡ä»¶çš„ç³»ç»Ÿæ€§æ ‡è¯†
          fix_systematic_ids_in_file() {
            local file_path="$1"
            local dry_run="$2"
            
            echo ""
            echo "=== å¤„ç†æ–‡ä»¶: $file_path ==="
            
            if [ ! -f "$file_path" ]; then
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file_path"
              return 1
            fi
            
            local file_prefix=$(extract_file_prefix "$file_path")
            echo "æ–‡ä»¶å‰ç¼€: $file_prefix"
            
            # å¤‡ä»½åŸæ–‡ä»¶
            local backup_file="${file_path}.backup_$(date +%Y%m%d_%H%M%S)"
            cp "$file_path" "$backup_file"
            echo "âœ… å¤‡ä»½æ–‡ä»¶: $backup_file"
            
            # åˆ†ææ–‡ä»¶å†…å®¹
            local total_lines=$(wc -l < "$file_path")
            echo "æ–‡ä»¶è¡Œæ•°: $total_lines"
            
            # æŸ¥æ‰¾ç°æœ‰çš„ç³»ç»Ÿæ€§æ ‡è¯†
            local existing_ids=$(grep -n "#ã€" "$file_path" | head -10)
            if [ -n "$existing_ids" ]; then
              echo "ğŸ“‹ ç°æœ‰æ ‡è¯†:"
              echo "$existing_ids" | while read line; do
                echo "  $line"
              done
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°ç°æœ‰ç³»ç»Ÿæ€§æ ‡è¯†"
            fi
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®å¤
            local needs_fix=false
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å·¥ä½œæµæ­¥éª¤ä½†æ²¡æœ‰æ ‡è¯†
            if [[ "$file_path" == *workflow* ]] || [[ "$file_path" == *yml ]] || [[ "$file_path" == *yaml ]]; then
              local step_count=$(grep -c "^[[:space:]]*- name:" "$file_path")
              local id_count=$(grep -c "#ã€${file_prefix}-" "$file_path")
              
              if [ $step_count -gt 0 ] && [ $id_count -lt $step_count ]; then
                needs_fix=true
                echo "ğŸ”§ éœ€è¦ä¿®å¤: æœ‰ $step_count ä¸ªæ­¥éª¤ä½†åªæœ‰ $id_count ä¸ªæ ‡è¯†"
              fi
            fi
            
            # æ£€æŸ¥shellè„šæœ¬
            if [[ "$file_path" == *.sh ]]; then
              local section_count=$(grep -c "^# ==" "$file_path")
              local id_count=$(grep -c "#ã€${file_prefix}-" "$file_path")
              
              if [ $section_count -gt 0 ] && [ $id_count -lt $section_count ]; then
                needs_fix=true
                echo "ğŸ”§ éœ€è¦ä¿®å¤: æœ‰ $section_count ä¸ªéƒ¨åˆ†ä½†åªæœ‰ $id_count ä¸ªæ ‡è¯†"
              fi
            fi
            
            if [ "$needs_fix" = "false" ]; then
              echo "âœ… æ–‡ä»¶æ ‡è¯†å®Œæ•´ï¼Œæ— éœ€ä¿®å¤"
              return 0
            fi
            
            # æ‰§è¡Œä¿®å¤
            if [ "$dry_run" = "true" ]; then
              echo "ğŸ” é¢„è§ˆæ¨¡å¼ - æ˜¾ç¤ºå»ºè®®çš„ä¿®æ”¹:"
              # è¿™é‡Œå¯ä»¥æ˜¾ç¤ºå»ºè®®çš„ä¿®æ”¹
              return 0
            fi
            
            echo "ğŸš€ å¼€å§‹ä¿®å¤ç³»ç»Ÿæ€§æ ‡è¯†..."
            
            # æ ¹æ®æ–‡ä»¶ç±»å‹ä½¿ç”¨ä¸åŒçš„ä¿®å¤ç­–ç•¥
            if [[ "$file_path" == *workflow* ]] || [[ "$file_path" == *yml ]] || [[ "$file_path" == *yaml ]]; then
              fix_yaml_file "$file_path" "$file_prefix"
            elif [[ "$file_path" == *.sh ]]; then
              fix_shell_file "$file_path" "$file_prefix"
            else
              echo "âš ï¸ æœªçŸ¥æ–‡ä»¶ç±»å‹ï¼Œä½¿ç”¨é€šç”¨ä¿®å¤"
              fix_generic_file "$file_path" "$file_prefix"
            fi
            
            # éªŒè¯ä¿®å¤ç»“æœ
            local new_id_count=$(grep -c "#ã€${file_prefix}-" "$file_path")
            echo "âœ… ä¿®å¤å®Œæˆï¼Œç°æœ‰æ ‡è¯†æ•°: $new_id_count"
            
            # æ˜¾ç¤ºå·®å¼‚
            echo "ğŸ“Š æ–‡ä»¶å·®å¼‚æ‘˜è¦:"
            diff -u "$backup_file" "$file_path" | head -20 || true
          }
          
          # ä¿®å¤YAMLæ–‡ä»¶
          fix_yaml_file() {
            local file_path="$1"
            local prefix="$2"
            
            local temp_file="${file_path}.tmp"
            cp "$file_path" "$temp_file"
            
            local step_number=0
            
            # è¯»å–æ–‡ä»¶å¹¶æ·»åŠ æ ‡è¯†
            while IFS= read -r line; do
              # æ£€æµ‹æ­¥éª¤å¼€å§‹
              if [[ "$line" =~ ^[[:space:]]*-[[:space:]]*name:[[:space:]]*[\"\'0-9] ]]; then
                step_number=$((step_number + 1))
                printf "      #ã€%s-%02dã€‘\n" "$prefix" "$step_number" >> "$file_path.new"
              fi
              
              echo "$line" >> "$file_path.new"
            done < "$temp_file"
            
            mv "$file_path.new" "$file_path"
            rm -f "$temp_file"
            
            echo "âœ… æ·»åŠ äº† $step_number ä¸ªæ­¥éª¤æ ‡è¯†"
          }
          
          # ä¿®å¤Shellæ–‡ä»¶
          fix_shell_file() {
            local file_path="$1"
            local prefix="$2"
            
            local temp_file="${file_path}.tmp"
            cp "$file_path" "$temp_file"
            
            local section_number=0
            
            # è¯»å–æ–‡ä»¶å¹¶æ·»åŠ æ ‡è¯†
            while IFS= read -r line; do
              # æ£€æµ‹ä¸»è¦ç« èŠ‚å¼€å§‹
              if [[ "$line" =~ ^#[[:space:]]*={10,} ]] || [[ "$line" =~ ^#[[:space:]]*-{10,} ]]; then
                section_number=$((section_number + 1))
                printf "#ã€%s-%02dã€‘%s\n" "$prefix" "$section_number" "${line#\#}" >> "$file_path.new"
                continue
              fi
              
              # æ£€æµ‹å‡½æ•°å®šä¹‰
              if [[ "$line" =~ ^[a-zA-Z_][a-zA-Z0-9_]*\(\)[[:space:]]*\{?$ ]] || [[ "$line" =~ ^function[[:space:]]+[a-zA-Z_][a-zA-Z0-9_]* ]]; then
                section_number=$((section_number + 1))
                printf "#ã€%s-%02dã€‘%s\n" "$prefix" "$section_number" "$line" >> "$file_path.new"
                echo "$line" >> "$file_path.new"
                continue
              fi
              
              echo "$line" >> "$file_path.new"
            done < "$temp_file"
            
            mv "$file_path.new" "$file_path"
            rm -f "$temp_file"
            
            echo "âœ… æ·»åŠ äº† $section_number ä¸ªç« èŠ‚æ ‡è¯†"
          }
          
          # é€šç”¨æ–‡ä»¶ä¿®å¤
          fix_generic_file() {
            local file_path="$1"
            local prefix="$2"
            
            echo "âš ï¸ é€šç”¨ä¿®å¤æœªå®ç°"
          }
          
          #ã€modification-script-03ã€‘ä¸»é€»è¾‘å¼€å§‹
          
          main() {
            echo "=== å¼€å§‹å¤„ç†æ–‡ä»¶ ==="
            
            # ç¡®å®šè¦å¤„ç†çš„æ–‡ä»¶
            local files_to_process=""
            
            if [ "$TARGET_FILES" = "all" ] || [ -z "$TARGET_FILES" ]; then
              echo "ğŸ” æœç´¢æ‰€æœ‰åŒ…å«ç³»ç»Ÿæ€§æ ‡è¯†çš„æ–‡ä»¶..."
              
              # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½åŒ…å«ç³»ç»Ÿæ€§æ ‡è¯†çš„æ–‡ä»¶
              files_to_process=$(find "$REPO_ROOT" -type f \( \
                -name "*.yml" -o \
                -name "*.yaml" -o \
                -name "*.sh" -o \
                -name "*.md" \) \
                -exec grep -l "#ã€" {} \; 2>/dev/null | sort | uniq)
              
              # æ·»åŠ å·²çŸ¥æ–‡ä»¶
              known_files=".github/workflows/firmware-build.yml firmware-config/scripts/build_firmware_main.sh firmware-config/support.sh"
              for known_file in $known_files; do
                if [ -f "$REPO_ROOT/$known_file" ] && ! echo "$files_to_process" | grep -q "$known_file"; then
                  files_to_process="$files_to_process
$REPO_ROOT/$known_file"
                fi
              done
              
            else
              # å¤„ç†æŒ‡å®šçš„æ–‡ä»¶
              IFS=',' read -ra file_list <<< "$TARGET_FILES"
              for file_pattern in "${file_list[@]}"; do
                found_file=$(fuzzy_find_file "$file_pattern" "$REPO_ROOT")
                if [ -n "$found_file" ]; then
                  files_to_process="$files_to_process
$found_file"
                else
                  echo "âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶: $file_pattern"
                fi
              done
            fi
            
            # å»é‡å’Œæ’åº
            files_to_process=$(echo "$files_to_process" | sed '/^$/d' | sort | uniq)
            
            local file_count=$(echo "$files_to_process" | wc -l)
            echo "ğŸ“Š æ‰¾åˆ° $file_count ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†"
            
            if [ $file_count -eq 0 ]; then
              echo "âœ… æ²¡æœ‰æ‰¾åˆ°éœ€è¦å¤„ç†çš„æ–‡ä»¶"
              return 0
            fi
            
            # å¤„ç†æ¯ä¸ªæ–‡ä»¶
            local processed=0
            local skipped=0
            local failed=0
            
            echo "$files_to_process" | while read file_path; do
              if [ -n "$file_path" ] && [ -f "$file_path" ]; then
                if fix_systematic_ids_in_file "$file_path" "$DRY_RUN"; then
                  processed=$((processed + 1))
                else
                  failed=$((failed + 1))
                fi
              else
                skipped=$((skipped + 1))
              fi
            done
            
            echo ""
            echo "=== å¤„ç†ç»“æœ ==="
            echo "âœ… æˆåŠŸå¤„ç†: $processed ä¸ªæ–‡ä»¶"
            echo "âš ï¸ è·³è¿‡å¤„ç†: $skipped ä¸ªæ–‡ä»¶"
            echo "âŒ å¤„ç†å¤±è´¥: $failed ä¸ªæ–‡ä»¶"
            
            if [ "$DRY_RUN" = "true" ]; then
              echo ""
              echo "ğŸ’¡ è¿™æ˜¯é¢„è§ˆæ¨¡å¼ï¼Œæ²¡æœ‰å®é™…ä¿®æ”¹æ–‡ä»¶"
              echo "   è¦å®é™…ä¿®æ”¹ï¼Œè¯·è®¾ç½® dry_run=false"
            fi
            
            return $((failed > 0))
          }
          
          # è¿è¡Œä¸»å‡½æ•°
          main
          EOF
          
          # ç»™è„šæœ¬æ‰§è¡Œæƒé™
          chmod +x /tmp/modification_script.sh
          
          # æ‰§è¡Œè„šæœ¬
          /tmp/modification_script.sh "${{ github.event.inputs.target_files }}" "${{ github.event.inputs.dry_run }}"
          
      - name: "4. ç”Ÿæˆä¿®æ”¹æŠ¥å‘Š"
        if: always()
        run: |
          echo "=== ä¿®æ”¹æŠ¥å‘Š ==="
          echo "ç”Ÿæˆæ—¶é—´: $(date)"
          echo "ä»“åº“: ${{ github.repository }}"
          echo "è§¦å‘è€…: ${{ github.actor }}"
          echo ""
          
          # æŸ¥æ‰¾ä¿®æ”¹è¿‡çš„æ–‡ä»¶
          echo "ğŸ“ ä¿®æ”¹è¿‡çš„æ–‡ä»¶:"
          find . -name "*.backup_*" -type f | while read backup; do
            original_file="${backup%.backup_*}"
            echo "  ğŸ“„ $original_file"
            echo "    å¤‡ä»½: $(basename "$backup")"
          done
          
          echo ""
          echo "ğŸ” åŒ…å«ç³»ç»Ÿæ€§æ ‡è¯†çš„æ–‡ä»¶ç»Ÿè®¡:"
          find . -type f -exec grep -l "#ã€" {} \; 2>/dev/null | while read file; do
            id_count=$(grep -c "#ã€" "$file")
            echo "  ğŸ“Š $file: $id_count ä¸ªæ ‡è¯†"
          done
          
      - name: "5. æäº¤ä¿®æ”¹"
        if: github.event.inputs.dry_run == 'false' && success()
        run: |
          echo "=== æäº¤ä¿®æ”¹ ==="
          
          # é…ç½®Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          if git diff --quiet; then
            echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„ä¿®æ”¹"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°ä¿®æ”¹ï¼Œå‡†å¤‡æäº¤..."
            
            # æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶
            git add -A
            
            # æäº¤ä¿®æ”¹
            git commit -m "fix: è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿæ€§æ ‡è¯† [skip ci]"
            
            # æ¨é€ä¿®æ”¹
            git push
            echo "âœ… ä¿®æ”¹å·²æäº¤å¹¶æ¨é€"
          fi
