# .github/workflows/compiler-matrix-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'ç›®æ ‡æ¶æ„ï¼ˆIPQ40xxé€‰æ‹©arm_cortex-a7ï¼‰'
        required: true
        default: 'arm_cortex-a7'
        type: choice
        options: ['aarch64', 'x86_64', 'mips', 'mipsel', 'arm_cortex-a7', 'arm_cortex-a53', 'riscv64']
      libc:
        description: 'Cåº“ç±»å‹ï¼ˆåµŒå…¥å¼æ¨èmuslï¼‰'
        required: true
        default: 'musl'
        type: choice
        options: ['musl', 'glibc']
      gcc_version:
        description: 'GCCç‰ˆæœ¬ï¼ˆOpenWrt 23.05æ”¯æŒ12.3.0ï¼Œè¾“å…¥autoè‡ªåŠ¨é€‰æ‹©ï¼‰'
        required: true
        default: 'auto'
        type: string
      clean_build:
        description: 'æ¸…ç†ä¹‹å‰çš„æ„å»ºç¼“å­˜'
        required: true
        default: false
        type: boolean
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºï¼ˆå³ä½¿å·²å­˜åœ¨ï¼‰'
        required: true
        default: false
        type: boolean

env:
  OPENWRT_VERSION: "23.05.2"
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers"

jobs:
  show-device-info:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“± æ˜¾ç¤ºæ¶æ„å¯¹åº”è®¾å¤‡
        run: |
          echo "========================================"
          echo "          ğŸ¯ ç›®æ ‡æ¶æ„è®¾å¤‡å¯¹åº”è¡¨           "
          echo "========================================"
          echo "arm_cortex-a7 (ä½ çš„è®¾å¤‡ï¼)"
          echo "  é«˜é€šIPQ40xxç³»åˆ—: å°ç±³è·¯ç”±å™¨4Aåƒå…†ç‰ˆç­‰"
          echo "aarch64: æ ‘è“æ´¾4Bã€ç”µè§†ç›’å­"
          echo "x86_64: PCã€æœåŠ¡å™¨"
          echo "mips/mipsel: è·¯ç”±å™¨"
          echo "arm_cortex-a53: WiFi6è·¯ç”±å™¨"
          echo "riscv64: å¼€å‘æ¿"
          echo "========================================"

  setup:
    runs-on: ubuntu-22.04
    outputs:
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      glibc_version: ${{ steps.version-detection.outputs.glibc_version }}
      need_build: ${{ steps.check-existing.outputs.need_build }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“ï¼ˆç”¨äºæ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: firmware-config/build-Compiler-file/compilers
          sparse-checkout-cone-mode: false

      - name: ğŸ—ï¸ åˆå§‹åŒ–
        run: |
          echo "=== äº¤å‰ç¼–è¯‘å™¨æ„å»ºç³»ç»Ÿ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          echo "åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ” åŠ¨æ€æ£€æµ‹GCCç‰ˆæœ¬
        id: version-detection
        run: |
          USER_VERSION="${{ github.event.inputs.gcc_version }}"
          if [ "$USER_VERSION" = "auto" ] || [ "$USER_VERSION" = "" ]; then
            GCC_VERSION="12.3.0"
            echo "é€‰æ‹©GCCç‰ˆæœ¬: $GCC_VERSION"
          else
            GCC_VERSION="$USER_VERSION"
            echo "ä½¿ç”¨æŒ‡å®šGCCç‰ˆæœ¬: $GCC_VERSION"
          fi
          BINUTILS_VERSION="2.40"
          LINUX_VERSION="5.15.133"
          MUSL_VERSION="1.2.4"
          GLIBC_VERSION="2.37"
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨
        id: check-existing
        run: |
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          GCC_VERSION='${{ steps.version-detection.outputs.gcc_version }}'
          if [ "$LIBC" = "musl" ]; then
            LIBC_DIR="musl"
          else
            LIBC_DIR="glibc"
          fi
          OUTPUT_DIR="${{ github.workspace }}/firmware-config/build-Compiler-file/compilers/${ARCH}/${LIBC_DIR}/gcc-${GCC_VERSION}"
          if [ -d "$OUTPUT_DIR" ] && [ -d "$OUTPUT_DIR/bin" ]; then
            GCC_FILES=$(find "$OUTPUT_DIR/bin" -name "*gcc*" 2>/dev/null | wc -l)
            if [ $GCC_FILES -gt 0 ]; then
              NEED_BUILD="false"
            else
              NEED_BUILD="true"
            fi
          else
            NEED_BUILD="true"
          fi
          if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            NEED_BUILD="true"
          fi
          echo "need_build=$NEED_BUILD" >> $GITHUB_OUTPUT

  build-compiler:
    needs: [show-device-info, setup]
    if: needs.setup.outputs.need_build == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æ¶æ„: ${{ github.event.inputs.target_arch }}"
          echo "Cåº“ç±»å‹: ${{ github.event.inputs.libc }}"
          echo "GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "æ¸…ç†æ„å»º: ${{ github.event.inputs.clean_build }}"
          echo "å¼ºåˆ¶é‡å»º: ${{ github.event.inputs.force_rebuild }}"
          echo "========================================"

      - name: ğŸ—ï¸ è®¾ç½®ç¯å¢ƒ
        run: |
          echo "=== è®¾ç½®æ„å»ºç¯å¢ƒ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="armvirt"
              SUBTARGET="armv7"
              ARCH_NAME="arm"
              ARCH_DIR="arm_cortex-a7"
              PREFIX="arm-openwrt-linux"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              FLOAT_ABI="hard"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              ARCH_DIR="aarch64"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              FLOAT_ABI=""
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              ARCH_DIR="x86_64"
              PREFIX="x86_64-openwrt-linux"
              CPU_TYPE="x86-64"
              TUNE="generic"
              FLOAT_ABI=""
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              ARCH_DIR="mips"
              PREFIX="mips-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              FLOAT_ABI="softfloat"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              ARCH_DIR="mipsel"
              PREFIX="mipsel-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              FLOAT_ABI="softfloat"
              ;;
            arm_cortex-a53)
              TARGET="rockchip"
              SUBTARGET="armv8"
              ARCH_NAME="aarch64"
              ARCH_DIR="arm_cortex-a53"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              FLOAT_ABI=""
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              ARCH_DIR="riscv64"
              PREFIX="riscv64-openwrt-linux"
              CPU_TYPE="generic"
              TUNE="generic"
              FLOAT_ABI="hard"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
              exit 1
              ;;
          esac
          if [ "$LIBC" = "musl" ]; then
            PREFIX="${PREFIX}-musl"
            LIBC_DIR="musl"
          else
            PREFIX="${PREFIX}-gnu"
            LIBC_DIR="glibc"
          fi
          GCC_VERSION='${{ needs.setup.outputs.gcc_version }}'
          BUILD_ID="${ARCH_DIR}_${LIBC_DIR}_gcc-${GCC_VERSION}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="/home/runner/compiler-build-${BUILD_ID}"
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH_DIR}/${LIBC_DIR}/gcc-${GCC_VERSION}"
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "ARCH_DIR=$ARCH_DIR" >> $GITHUB_ENV
          echo "LIBC_DIR=$LIBC_DIR" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "TUNE=$TUNE" >> $GITHUB_ENV
          echo "FLOAT_ABI=$FLOAT_ABI" >> $GITHUB_ENV
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "ğŸš¨ ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ"
          echo "æ„å»ºç›®å½•: $BUILD_DIR"
          echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"

      - name: ğŸ” éªŒè¯ç¯å¢ƒå˜é‡
        run: |
          echo "=== éªŒè¯ç¯å¢ƒå˜é‡ ==="
          echo "æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡:"
          REQUIRED_VARS="BUILD_DIR OUTPUT_DIR TARGET SUBTARGET ARCH_NAME ARCH_DIR LIBC_DIR PREFIX CPU_TYPE TUNE FLOAT_ABI GCC_VERSION BUILD_ID"
          ALL_VALID=true
          for var in $REQUIRED_VARS; do
            value=$(eval echo \$$var)
            if [ -z "$value" ]; then
              echo "âŒ ç¯å¢ƒå˜é‡ $var æœªè®¾ç½®"
              ALL_VALID=false
            else
              echo "âœ… $var=$value"
            fi
          done
          if [ "$ALL_VALID" = false ]; then
            echo "âŒ ç¯å¢ƒå˜é‡éªŒè¯å¤±è´¥"
            exit 1
          fi
          echo "æ£€æŸ¥æ¶æ„é…ç½®:"
          if [ "$ARCH_NAME" = "arm" ]; then
            if [ "$TARGET" != "armvirt" ] || [ "$SUBTARGET" != "armv7" ]; then
              echo "âŒ ARMæ¶æ„é…ç½®é”™è¯¯: TARGETåº”ä¸ºarmvirt, SUBTARGETåº”ä¸ºarmv7"
              echo "å½“å‰: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
              exit 1
            else
              echo "âœ… ARMæ¶æ„é…ç½®æ­£ç¡®"
            fi
          else
            echo "â„¹ï¸ éARMæ¶æ„ï¼Œè·³è¿‡ç‰¹å®šæ£€æŸ¥"
          fi
          echo "æ£€æŸ¥Cåº“é…ç½®:"
          if [ "$LIBC_DIR" = "musl" ]; then
            if [[ "$PREFIX" == *"musl" ]]; then
              echo "âœ… Muslé…ç½®æ­£ç¡®: PREFIXåŒ…å«musl"
            else
              echo "âŒ Muslé…ç½®é”™è¯¯: PREFIXåº”åŒ…å«musl"
              echo "å½“å‰: PREFIX=$PREFIX"
              exit 1
            fi
          else
            if [[ "$PREFIX" == *"gnu" ]]; then
              echo "âœ… Glibcé…ç½®æ­£ç¡®: PREFIXåŒ…å«gnu"
            else
              echo "âŒ Glibcé…ç½®é”™è¯¯: PREFIXåº”åŒ…å«gnu"
              echo "å½“å‰: PREFIX=$PREFIX"
              exit 1
            fi
          fi
          echo "æ£€æŸ¥è·¯å¾„é…ç½®:"
          if [[ "$OUTPUT_DIR" == *"firmware-config/build-Compiler-file/compilers"* ]]; then
            echo "âœ… è¾“å‡ºç›®å½•è·¯å¾„æ­£ç¡®"
          else
            echo "âš ï¸ è­¦å‘Š: è¾“å‡ºç›®å½•è·¯å¾„å¯èƒ½ä¸æ­£ç¡®"
            echo "å½“å‰: $OUTPUT_DIR"
          fi
          if [[ "$BUILD_DIR" == "/home/runner/compiler-build-"* ]]; then
            echo "âœ… æ„å»ºç›®å½•è·¯å¾„æ­£ç¡®"
          else
            echo "âš ï¸ è­¦å‘Š: æ„å»ºç›®å½•è·¯å¾„å¯èƒ½ä¸æ­£ç¡®"
          fi
          echo "âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡"

      - name: ğŸ”§ å®‰è£…å®Œæ•´ä¾èµ–ï¼ˆä¿®å¤ç»ˆç«¯é—®é¢˜ï¼‰
        run: |
          echo "=== å®‰è£…å®Œæ•´çš„æ„å»ºä¾èµ–ï¼ˆä¿®å¤ç»ˆç«¯é—®é¢˜ï¼‰==="
          sudo apt-get update -y
          
          # ä¿®å¤ç»ˆç«¯é—®é¢˜çš„å…³é”®åŒ…
          echo "å®‰è£…ç»ˆç«¯æ”¯æŒåŒ…..."
          sudo apt-get install -y ncurses-term ncurses-base ncurses-bin
          sudo apt-get install -y libncursesw5 libncursesw5-dev libtinfo5 libtinfo-dev
          sudo apt-get install -y terminfo dialog
          
          # è®¾ç½®ç»ˆç«¯ç¯å¢ƒ
          echo "è®¾ç½®ç»ˆç«¯ç¯å¢ƒ..."
          export TERM=xterm-256color
          export TERMINFO=/usr/share/terminfo
          echo "TERM=$TERM"
          echo "TERMINFO=$TERMINFO"
          
          # åˆ›å»ºå¿…è¦çš„terminfoæ–‡ä»¶
          sudo mkdir -p /usr/share/terminfo/x
          sudo ln -sf /lib/terminfo/x/xterm-256color /usr/share/terminfo/x/xterm-256color 2>/dev/null || true
          
          # æ ¸å¿ƒç¼–è¯‘å·¥å…·
          echo "å®‰è£…æ ¸å¿ƒç¼–è¯‘å·¥å…·..."
          sudo apt-get install -y build-essential gcc g++ make flex bison
          sudo apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev
          sudo apt-get install -y python3 python3-dev python3-pip python3-distutils
          sudo apt-get install -y git wget curl rsync unzip patchutils bc bzip2 xz-utils
          sudo apt-get install -y zlib1g-dev liblzma-dev libssl-dev libexpat-dev
          sudo apt-get install -y libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev
          sudo apt-get install -y libelf-dev libdw-dev lzma-dev zstd libzstd-dev
          sudo apt-get install -y autoconf automake libtool pkg-config texinfo gperf
          sudo apt-get install -y cmake ninja-build help2man jq file gawk gettext
          sudo apt-get install -y man-db locales locales-all
          
          # è®¾ç½®è¯­è¨€ç¯å¢ƒ
          sudo locale-gen en_US.UTF-8
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ—‘ï¸ æ¸…ç†æ„å»ºç¼“å­˜
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          echo "æ¸…ç†ä¹‹å‰çš„æ„å»ºç¼“å­˜..."
          rm -rf /home/runner/compiler-build-* 2>/dev/null || true
          echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        timeout-minutes: 10
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          echo "å…‹éš†OpenWrt ${{ env.OPENWRT_VERSION }}..."
          git clone --depth 1 --branch v${{ env.OPENWRT_VERSION }} https://github.com/openwrt/openwrt.git . || {
            echo "Gitå…‹éš†å¤±è´¥ï¼Œå°è¯•taråŒ…..."
            wget -q -O openwrt.tar.gz "https://github.com/openwrt/openwrt/archive/refs/tags/v${{ env.OPENWRT_VERSION }}.tar.gz"
            tar -xzf openwrt.tar.gz --strip-components=1
            rm -f openwrt.tar.gz
          }
          if [ -f "README.md" ]; then
            echo "âœ… OpenWrtæºç å‡†å¤‡å®Œæˆ"
          else
            echo "âŒ ä¸‹è½½å¤±è´¥"
            exit 1
          fi

      - name: ğŸ”§ ä¿®å¤ç¯å¢ƒï¼ˆç¦ç”¨äº¤äº’å¼èœå•ï¼‰
        run: |
          echo "=== ä¿®å¤æ„å»ºç¯å¢ƒï¼ˆç¦ç”¨äº¤äº’å¼èœå•ï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          
          # å…³é”®ï¼šç¦ç”¨æ‰€æœ‰äº¤äº’å¼èœå•
          export TERM=dumb
          export TERMINFO=/usr/share/terminfo
          export FORCE_UNSAFE_CONFIGURE=1
          export DEBIAN_FRONTEND=noninteractive
          export MAKE="make -j$(nproc) V=sc"
          
          # ç¦ç”¨menuconfig
          echo "ç¦ç”¨menuconfig..."
          sed -i 's/menuconfig //g' include/toplevel.mk 2>/dev/null || true
          sed -i 's/.*menuconfig.*//g' include/toplevel.mk 2>/dev/null || true
          
          # åˆ›å»ºå‡çš„menuconfigè„šæœ¬
          cat > scripts/config/mconf
          chmod +x scripts/config/mconf
          echo "#!/bin/sh" > scripts/config/mconf
          echo 'echo "menuconfigè¢«ç¦ç”¨ï¼Œä½¿ç”¨å·²æœ‰é…ç½®"' >> scripts/config/mconf
          echo "exit 0" >> scripts/config/mconf
          
          # åˆ›å»ºå‡çš„confè„šæœ¬
          cat > scripts/config/conf
          chmod +x scripts/config/conf
          echo "#!/bin/sh" > scripts/config/conf
          echo 'echo "é…ç½®å·¥å…·è¢«ç¦ç”¨ï¼Œä½¿ç”¨å·²æœ‰é…ç½®"' >> scripts/config/conf
          echo "exit 0" >> scripts/config/conf
          
          git config --global http.postBuffer 524288000
          export GIT_SSL_NO_VERIFY=1
          export CURL_SSL_NO_VERIFY=1
          
          mkdir -p include/site tmp dl
          echo "âœ… ç¯å¢ƒä¿®å¤å®Œæˆ"

      - name: ğŸ› ï¸ åˆ›å»ºé…ç½®ï¼ˆéäº¤äº’å¼ï¼‰
        run: |
          echo "=== åˆ›å»ºæ„å»ºé…ç½®ï¼ˆéäº¤äº’å¼ï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          
          # åˆ›å»ºå®Œæ•´çš„.configæ–‡ä»¶ï¼Œé¿å…ä»»ä½•äº¤äº’
          cat > .config
          echo "CONFIG_TARGET_armvirt=y" >> .config
          echo "CONFIG_TARGET_armvirt_armv7=y" >> .config
          echo 'CONFIG_TARGET_BOARD="armvirt"' >> .config
          echo 'CONFIG_TARGET_SUBTARGET="armv7"' >> .config
          echo 'CONFIG_TARGET_ARCH_PACKAGES="arm_cortex-a7"' >> .config
          echo 'CONFIG_TARGET_ARCH="arm"' >> .config
          echo 'CONFIG_TARGET_PREFIX="arm-openwrt-linux-musl-"' >> .config
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "CONFIG_TOOLCHAINOPTS=y" >> .config
          echo 'CONFIG_GCC_VERSION="12.3.0"' >> .config
          echo 'CONFIG_BINUTILS_VERSION="2.40"' >> .config
          echo 'CONFIG_LINUX_VERSION="5.15.133"' >> .config
          echo 'CONFIG_LIBC="musl"' >> .config
          echo 'CONFIG_CPU_TYPE="cortex-a7"' >> .config
          echo 'CONFIG_CPU_TUNE="cortex-a7"' >> .config
          echo 'CONFIG_FPU="hard"' >> .config
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_BUILD_PATENTED=y" >> .config
          echo "CONFIG_CCACHE=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          echo "CONFIG_BASE_FILES=y" >> .config
          echo "CONFIG_BUSYBOX_DEFAULT_FEATURE_EDITING=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config
          echo "CONFIG_EXTERNAL_TOOLCHAIN=n" >> .config
          echo "CONFIG_BUILD_TOOLS=y" >> .config
          echo "CONFIG_TOOLCHAIN_BUILD=y" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> .config
          echo "CONFIG_USE_MUSL=y" >> .config
          echo "CONFIG_USE_GLIBC=n" >> .config
          echo 'CONFIG_TARGET_OPTIMIZATION="-Os -pipe -mcpu=cortex-a7"' >> .config
          echo 'CONFIG_TARGET_SUFFIX="musl"' >> .config
          echo 'CONFIG_KERNEL_BUILD_USER="OpenWrt"' >> .config
          echo 'CONFIG_KERNEL_BUILD_DOMAIN="openwrt.org"' >> .config
          echo 'CONFIG_DOWNLOAD_FOLDER=""' >> .config
          echo 'CONFIG_LOCALMIRROR=""' >> .config
          echo "CONFIG_AUTOREBUILD=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          
          echo "âœ… é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
          echo "é…ç½®è¡Œæ•°: $(wc -l < .config)"

      - name: ğŸ“¥ é¢„ä¸‹è½½å…³é”®æºç åŒ…
        timeout-minutes: 30
        run: |
          echo "=== é¢„ä¸‹è½½å…³é”®æºç åŒ… ==="
          cd "${{ env.BUILD_DIR }}"
          
          # åˆ›å»ºä¸‹è½½ç›®å½•
          mkdir -p dl
          
          echo "ä¸‹è½½å…³é”®å·¥å…·é“¾ç»„ä»¶ï¼ˆä½¿ç”¨å¤šä¸ªé•œåƒæºï¼‰..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # ä¸‹è½½åŒ…åˆ—è¡¨ï¼ˆæ”¹ä¸ºé€ä¸ªä¸‹è½½ï¼‰
          wget --timeout=60 --tries=3 -q -O "dl/gcc-12.3.0.tar.xz" "https://mirrors.tuna.tsinghua.edu.cn/gnu/gcc/gcc-12.3.0/gcc-12.3.0.tar.xz" && echo "âœ… ä¸‹è½½æˆåŠŸ: gcc-12.3.0.tar.xz" || echo "âš ï¸ ä¸‹è½½å¤±è´¥: gcc-12.3.0.tar.xz"
          wget --timeout=60 --tries=3 -q -O "dl/binutils-2.40.tar.xz" "https://mirrors.tuna.tsinghua.edu.cn/gnu/binutils/binutils-2.40.tar.xz" && echo "âœ… ä¸‹è½½æˆåŠŸ: binutils-2.40.tar.xz" || echo "âš ï¸ ä¸‹è½½å¤±è´¥: binutils-2.40.tar.xz"
          wget --timeout=60 --tries=3 -q -O "dl/linux-5.15.133.tar.xz" "https://mirrors.tuna.tsinghua.edu.cn/kernel/v5.x/linux-5.15.133.tar.xz" && echo "âœ… ä¸‹è½½æˆåŠŸ: linux-5.15.133.tar.xz" || echo "âš ï¸ ä¸‹è½½å¤±è´¥: linux-5.15.133.tar.xz"
          wget --timeout=60 --tries=3 -q -O "dl/musl-1.2.4.tar.gz" "https://musl.libc.org/releases/musl-1.2.4.tar.gz" && echo "âœ… ä¸‹è½½æˆåŠŸ: musl-1.2.4.tar.gz" || echo "âš ï¸ ä¸‹è½½å¤±è´¥: musl-1.2.4.tar.gz"
          wget --timeout=60 --tries=3 -q -O "dl/mpc-1.3.1.tar.gz" "https://mirrors.tuna.tsinghua.edu.cn/gnu/mpc/mpc-1.3.1.tar.gz" && echo "âœ… ä¸‹è½½æˆåŠŸ: mpc-1.3.1.tar.gz" || echo "âš ï¸ ä¸‹è½½å¤±è´¥: mpc-1.3.1.tar.gz"
          wget --timeout=60 --tries=3 -q -O "dl/mpfr-4.2.0.tar.xz" "https://mirrors.tuna.tsinghua.edu.cn/gnu/mpfr/mpfr-4.2.0.tar.xz" && echo "âœ… ä¸‹è½½æˆåŠŸ: mpfr-4.2.0.tar.xz" || echo "âš ï¸ ä¸‹è½½å¤±è´¥: mpfr-4.2.0.tar.xz"
          wget --timeout=60 --tries=3 -q -O "dl/gmp-6.2.1.tar.xz" "https://mirrors.tuna.tsinghua.edu.cn/gnu/gmp/gmp-6.2.1.tar.xz" && echo "âœ… ä¸‹è½½æˆåŠŸ: gmp-6.2.1.tar.xz" || echo "âš ï¸ ä¸‹è½½å¤±è´¥: gmp-6.2.1.tar.xz"
          wget --timeout=60 --tries=3 -q -O "dl/isl-0.26.tar.xz" "https://libisl.sourceforge.io/isl-0.26.tar.xz" && echo "âœ… ä¸‹è½½æˆåŠŸ: isl-0.26.tar.xz" || echo "âš ï¸ ä¸‹è½½å¤±è´¥: isl-0.26.tar.xz"
          
          echo "ç»“æŸæ—¶é—´: $(date)"
          echo "ä¸‹è½½å®Œæˆï¼Œæ£€æŸ¥æ–‡ä»¶..."
          ls -lh dl/ 2>/dev/null | head -20 || echo "ä¸‹è½½ç›®å½•ä¸ºç©º"
          echo "æ€»æ–‡ä»¶æ•°: $(ls -1 dl/ 2>/dev/null | wc -l)"
          echo "æ€»å¤§å°: $(du -sh dl/ 2>/dev/null | cut -f1 || echo "æœªçŸ¥")"
          
          if [ $(ls -1 dl/ 2>/dev/null | wc -l) -lt 5 ]; then
            echo "âš ï¸ è­¦å‘Š: ä¸‹è½½çš„æ–‡ä»¶æ•°é‡è¾ƒå°‘"
          else
            echo "âœ… å…³é”®æºç åŒ…ä¸‹è½½å®Œæˆ"
          fi

      - name: ğŸ”¨ ç¼–è¯‘å·¥å…·é“¾ï¼ˆç›´æ¥ç¼–è¯‘ï¼‰
        timeout-minutes: 90
        run: |
          echo "=== ç¼–è¯‘å·¥å…·é“¾ï¼ˆç›´æ¥ç¼–è¯‘ï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=dumb
          export DEBIAN_FRONTEND=noninteractive
          
          # å®Œå…¨ç¦ç”¨äº¤äº’å¼é…ç½®
          echo "å®Œå…¨ç¦ç”¨äº¤äº’å¼é…ç½®..."
          touch .config.ready
          
          CPU_CORES=$(nproc)
          echo "CPUæ ¸å¿ƒæ•°: $CPU_CORES"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # åˆ›å»ºç¼–è¯‘æ—¥å¿—
          COMPILE_LOG="compile.log"
          
          echo "=== å¼€å§‹ç¼–è¯‘å·¥å…·é“¾ ===" > "$COMPILE_LOG"
          echo "æ­¥éª¤1: ç¼–è¯‘å·¥å…·é“¾æ ¸å¿ƒ..." >> "$COMPILE_LOG"
          
          # ä½¿ç”¨æ›´å°‘çš„å¹¶è¡Œä»»åŠ¡é¿å…å†…å­˜ä¸è¶³
          MAKE_JOBS=$((CPU_CORES > 4 ? 4 : CPU_CORES))
          echo "ä½¿ç”¨ $MAKE_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡" >> "$COMPILE_LOG"
          
          # ç›´æ¥è°ƒç”¨ç¼–è¯‘ï¼Œè·³è¿‡é…ç½®æ£€æŸ¥
          timeout 5400 make toolchain/compile -j$MAKE_JOBS V=sc 2>&1 | tee -a "$COMPILE_LOG"
          COMPILE_STATUS=${PIPESTATUS[0]}
          
          echo "ç»“æŸæ—¶é—´: $(date)" >> "$COMPILE_LOG"
          echo "ç¼–è¯‘é€€å‡ºçŠ¶æ€: $COMPILE_STATUS" >> "$COMPILE_LOG"
          
          # åˆ†æç¼–è¯‘ç»“æœ
          if [ $COMPILE_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ" >> "$COMPILE_LOG"
          elif [ $COMPILE_STATUS -eq 124 ]; then
            echo "âš ï¸ ç¼–è¯‘è¶…æ—¶ï¼Œä½†å¯èƒ½å·²éƒ¨åˆ†å®Œæˆ" >> "$COMPILE_LOG"
            echo "æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†å·¥å…·é“¾..." >> "$COMPILE_LOG"
            
            if find staging_dir -name "*gcc*" -type f 2>/dev/null | head -1; then
              echo "âœ… æ‰¾åˆ°äº†ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œç»§ç»­å®‰è£…" >> "$COMPILE_LOG"
            else
              echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶" >> "$COMPILE_LOG"
              exit 1
            fi
          else
            echo "âš ï¸ ç¼–è¯‘æœ‰é”™è¯¯" >> "$COMPILE_LOG"
            echo "æ£€æŸ¥é”™è¯¯ç±»å‹..." >> "$COMPILE_LOG"
            
            if grep -q "No rule to make target" "$COMPILE_LOG"; then
              echo "âŒ é”™è¯¯: ç¼ºå°‘æºç åŒ…" >> "$COMPILE_LOG"
              echo "ç¼ºå¤±çš„åŒ…:" >> "$COMPILE_LOG"
              grep -o "No rule to make target.*\.tar\.[xg]z" "$COMPILE_LOG" | sed 's/.*target //' | sort -u >> "$COMPILE_LOG"
              exit 1
            elif grep -q "menuconfig" "$COMPILE_LOG"; then
              echo "âŒ é”™è¯¯: menuconfigè¢«è°ƒç”¨" >> "$COMPILE_LOG"
              echo "éœ€è¦å®Œå…¨ç¦ç”¨äº¤äº’å¼èœå•" >> "$COMPILE_LOG"
              exit 1
            else
              echo "âš ï¸ å…¶ä»–ç¼–è¯‘é”™è¯¯ï¼Œå°è¯•ç»§ç»­..." >> "$COMPILE_LOG"
            fi
          fi

      - name: ğŸ“¦ å®‰è£…å·¥å…·é“¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        timeout-minutes: 30
        run: |
          echo "=== å®‰è£…å·¥å…·é“¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          export TERM=dumb
          
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "æ‰§è¡Œ: make toolchain/install V=sc"
          
          # ä½¿ç”¨æ›´å°‘çš„å¹¶è¡Œä»»åŠ¡
          CPU_CORES=$(nproc)
          MAKE_JOBS=$((CPU_CORES > 2 ? 2 : CPU_CORES))
          
          make toolchain/install -j$MAKE_JOBS V=sc 2>&1 | tee install.log
          INSTALL_STATUS=${PIPESTATUS[0]}
          
          echo "ç»“æŸæ—¶é—´: $(date)"
          echo "å®‰è£…çŠ¶æ€: $INSTALL_STATUS"
          
          if [ $INSTALL_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ å®‰è£…æœ‰é”™è¯¯ï¼Œæ£€æŸ¥æ˜¯å¦éƒ¨åˆ†æˆåŠŸ"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·é“¾ç”Ÿæˆ
            if find staging_dir -name "*gcc*" -type f 2>/dev/null | head -1; then
              echo "âœ… æ‰¾åˆ°äº†ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œç»§ç»­éªŒè¯"
            else
              echo "âŒ æœªæ‰¾åˆ°ä»»ä½•ç¼–è¯‘å™¨æ–‡ä»¶"
              echo "æœ€å10è¡Œå®‰è£…æ—¥å¿—:"
              tail -10 install.log
              exit 1
            fi
          fi

      - name: ğŸ› ï¸ é”™è¯¯åˆ†æä¸è¯Šæ–­
        if: failure()
        timeout-minutes: 10
        run: |
          echo "========================================"
          echo "          ğŸ” é”™è¯¯åˆ†æä¸è¯Šæ–­              "
          echo "========================================"
          echo "æ„å»ºå¤±è´¥ï¼Œå¼€å§‹è¯Šæ–­..."
          echo ""
          echo "1. ç³»ç»Ÿèµ„æºçŠ¶æ€:"
          echo "ç£ç›˜ç©ºé—´:"
          df -h
          echo ""
          echo "å†…å­˜ä½¿ç”¨:"
          free -h
          echo ""
          echo "2. ç»ˆç«¯ç¯å¢ƒæ£€æŸ¥:"
          echo "TERM: $TERM"
          echo "TERMINFO: $TERMINFO"
          echo "æ£€æŸ¥terminfoæ–‡ä»¶:"
          ls -la /usr/share/terminfo/x/xterm* 2>/dev/null || echo "terminfoæ–‡ä»¶ä¸å­˜åœ¨"
          echo ""
          echo "3. æ„å»ºç›®å½•çŠ¶æ€:"
          if [ -d "${{ env.BUILD_DIR }}" ]; then
            echo "æ„å»ºç›®å½•å¤§å°: $(du -sh "${{ env.BUILD_DIR }}" 2>/dev/null || echo "æœªçŸ¥")"
            echo ""
            echo "4. é…ç½®æ£€æŸ¥:"
            if [ -f "${{ env.BUILD_DIR }}/.config" ]; then
              echo "é…ç½®æ–‡ä»¶è¡Œæ•°: $(wc -l < "${{ env.BUILD_DIR }}/.config")"
              echo "å…³é”®é…ç½®:"
              grep -E "TARGET_|ARCH_|GCC|LIBC|TOOLCHAIN" "${{ env.BUILD_DIR }}/.config" | head -10
            fi
            echo ""
            echo "5. æ—¥å¿—æ–‡ä»¶åˆ†æ:"
            for log in "${{ env.BUILD_DIR }}"/*.log; do
              if [ -f "$log" ]; then
                echo "æ—¥å¿—æ–‡ä»¶: $(basename "$log")"
                echo "æœ€åé”™è¯¯è¡Œ:"
                tail -5 "$log"
                echo ""
              fi
            done
          fi
          echo ""
          echo "6. å¸¸è§é—®é¢˜è§£å†³å»ºè®®:"
          echo "   - menuconfigé”™è¯¯:"
          echo "     å®Œå…¨ç¦ç”¨äº¤äº’å¼èœå•é…ç½®"
          echo "     ä¿®æ”¹ include/toplevel.mk æ–‡ä»¶"
          echo "     åˆ›å»ºå‡çš„é…ç½®è„šæœ¬"
          echo "   - ç»ˆç«¯é”™è¯¯:"
          echo "     å®‰è£…å®Œæ•´çš„ncursesåŒ…"
          echo "     è®¾ç½®æ­£ç¡®çš„TERMå’ŒTERMINFO"
          echo "     ä½¿ç”¨ export TERM=dumb"
          echo "   - ç¼–è¯‘å¤±è´¥:"
          echo "     å‡å°‘å¹¶è¡Œä»»åŠ¡æ•°: make -j2"
          echo "     æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæ•´"
          echo "     æŸ¥çœ‹å…·ä½“çš„é”™è¯¯æ—¥å¿—"
          echo "   - è¶…æ—¶é—®é¢˜:"
          echo "     å¢åŠ è¶…æ—¶æ—¶é—´"
          echo "     åˆ†æ­¥éª¤æ„å»º"
          echo "========================================"

      - name: âœ… éªŒè¯æ„å»ºç»“æœ
        run: |
          echo "=== éªŒè¯æ„å»ºç»“æœ ==="
          cd "${{ env.BUILD_DIR }}"
          TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            exit 1
          fi
          echo "âœ… å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          GCC_FILE=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
          if [ -z "$GCC_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘å™¨"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $(basename "$GCC_FILE")"
          echo "ç¼–è¯‘å™¨ç‰ˆæœ¬:"
          "$GCC_FILE" --version 2>&1 | head -3
          COMPILER_NAME=$(basename "$GCC_FILE")
          TOOL_PREFIX=$(echo "$COMPILER_NAME" | sed 's/gcc$//')
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "COMPILER_PATH=$GCC_FILE" >> $GITHUB_ENV
          echo "TOOL_PREFIX=$TOOL_PREFIX" >> $GITHUB_ENV

      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨ ==="
          mkdir -p "${{ env.OUTPUT_DIR }}"
          if [ -d "${{ env.OUTPUT_DIR }}" ] && [ "$(ls -A "${{ env.OUTPUT_DIR }}" 2>/dev/null)" ]; then
            rm -rf "${{ env.OUTPUT_DIR }}"/*
          fi
          cp -r "$TOOLCHAIN_DIR"/* "${{ env.OUTPUT_DIR }}/" 2>/dev/null || true
          if [ -d "${{ env.OUTPUT_DIR }}/bin" ]; then
            file_count=$(find "${{ env.OUTPUT_DIR }}" -type f 2>/dev/null | wc -l)
            TOTAL_SIZE=$(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1)
            echo "FILE_COUNT=$file_count" >> $GITHUB_ENV
            echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
            echo "âœ… å·¥å…·é“¾ä¿å­˜å®Œæˆ"
            echo "æ–‡ä»¶æ•°: $file_count"
            echo "å¤§å°: $TOTAL_SIZE"
            echo '{"architecture": "'${{ env.ARCH_DIR }}'", "libc": "'${{ env.LIBC_DIR }}'", "gcc_version": "'${{ env.GCC_VERSION }}'", "build_date": "'$(date -Iseconds)'", "file_count": "'$file_count'", "total_size": "'$TOTAL_SIZE'", "prefix": "'${{ env.PREFIX }}'-"}' > "${{ env.OUTPUT_DIR }}/metadata.json"
          else
            echo "âŒ å·¥å…·é“¾ä¿å­˜å¤±è´¥"
            exit 1
          fi

      - name: ğŸ“¤ æäº¤åˆ°Gitä»“åº“
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°Gitä»“åº“ ==="
          cd "${{ github.workspace }}"
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git pull origin main --no-edit || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­..."
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          if ! git diff --cached --quiet; then
            git commit -m "build(compiler): æ·»åŠ  ${{ env.ARCH_DIR }}-${{ env.LIBC_DIR }} äº¤å‰ç¼–è¯‘å™¨" -m "GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}" -m "å¤§å°: ${{ env.TOTAL_SIZE }}" -m "å·¥ä½œæµ: #${{ github.run_id }}"
            git push origin main
            echo "âœ… ç¼–è¯‘å™¨å·²æäº¤åˆ°ä»“åº“"
          else
            echo "â„¹ï¸ æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi

      - name: ğŸ“Š æ˜¾ç¤ºæœ€ç»ˆæˆæœ
        run: |
          echo "========================================"
          echo "          ğŸ‰ æ„å»ºå®ŒæˆæŠ¥å‘Š              "
          echo "========================================"
          echo "âœ… äº¤å‰ç¼–è¯‘å™¨æ„å»ºæˆåŠŸ!"
          echo ""
          echo "ğŸ“Š æ„å»ºä¿¡æ¯:"
          echo "  æ¶æ„: ${{ env.ARCH_DIR }}"
          echo "  Cåº“: ${{ env.LIBC_DIR }}"
          echo "  GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "  ç¼–è¯‘å™¨å‰ç¼€: ${{ env.PREFIX }}-"
          echo ""
          echo "ğŸ“¦ æˆæœç»Ÿè®¡:"
          echo "  æ€»å¤§å°: ${{ env.TOTAL_SIZE }}"
          echo "  æ–‡ä»¶æ•°é‡: ${{ env.FILE_COUNT }}"
          echo "  è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          echo ""
          echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
          echo "cd ${{ env.OUTPUT_DIR }}"
          echo 'export PATH="$(pwd)/bin:$PATH"'
          echo "${{ env.PREFIX }}-gcc --version"
          echo ""
          echo "å®Œæˆæ—¶é—´: $(date)"
          echo "========================================"

      - name: ğŸ“„ ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.BUILD_ID }}
          path: ${{ env.BUILD_DIR }}/compile.log,${{ env.BUILD_DIR }}/install.log
          retention-days: 7

  skip-build:
    needs: setup
    if: needs.setup.outputs.need_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: â­ï¸ è·³è¿‡æ„å»º
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æ„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ä¸”å®Œæ•´ï¼Œè·³è¿‡æ„å»º"
          echo "ğŸ’¡ å¦‚éœ€é‡æ–°æ„å»ºï¼Œè¯·å¯ç”¨'å¼ºåˆ¶é‡æ–°æ„å»º'é€‰é¡¹"
          echo "========================================"
