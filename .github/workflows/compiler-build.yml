# .github/workflows/compiler-build.yml
name: ğŸ” ç¼–è¯‘å™¨æ„å»ºï¼ˆç®€åŒ–ç‰ˆï¼‰

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

env:
  BUILD_DIR: "/mnt/compiler-build-$(date +%s)"
  COMPILER_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compiled"

jobs:
  build-compiler:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
      # 1. æ£€å‡º
      - uses: actions/checkout@v4
      
      # 2. ç®€åŒ–çš„ç‰ˆæœ¬è·å–
      - name: ğŸ” è·å–ç‰ˆæœ¬ä¿¡æ¯
        run: |
          echo "=== è®¾ç½®ç¼–è¯‘å™¨ç‰ˆæœ¬ ==="
          
          # ä½¿ç”¨å·²çŸ¥ç¨³å®šçš„ç‰ˆæœ¬ï¼ˆé¿å…ç½‘ç»œé—®é¢˜ï¼‰
          # è¿™äº›ç‰ˆæœ¬ä¸OpenWrt 23.05å…¼å®¹
          GCC_VERSION="11.3.0"
          BINUTILS_VERSION="2.38"
          LINUX_VERSION="5.15.133"
          MUSL_VERSION="1.2.4"
          
          echo "ğŸ“¦ ç¼–è¯‘å™¨ç‰ˆæœ¬é…ç½®:"
          echo "â”œâ”€ GCC: $GCC_VERSION"
          echo "â”œâ”€ Binutils: $BINUTILS_VERSION"
          echo "â”œâ”€ Linux Kernel: $LINUX_VERSION"
          echo "â””â”€ Musl: $MUSL_VERSION"
          
          # å†™å…¥ç¯å¢ƒæ–‡ä»¶
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV
          echo "LINUX_VERSION=$LINUX_VERSION" >> $GITHUB_ENV
          echo "MUSL_VERSION=$MUSL_VERSION" >> $GITHUB_ENV
      
      # 3. æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        run: |
          echo "=== æ„å»ºé…ç½®ä¿¡æ¯ ==="
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          echo "ç¼–è¯‘å™¨è¾“å‡º: ${{ env.COMPILER_DIR }}"
          echo ""
          echo "ç‰ˆæœ¬ä¿¡æ¯:"
          echo "  GCC: ${{ env.GCC_VERSION }}"
          echo "  Binutils: ${{ env.BINUTILS_VERSION }}"
          echo "  Linux: ${{ env.LINUX_VERSION }}"
          echo "  Musl: ${{ env.MUSL_VERSION }}"
          echo ""
          echo "ğŸ–¥ï¸ ç³»ç»Ÿèµ„æº:"
          echo "CPU: $(nproc) cores"
          echo "å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "ç£ç›˜ä½¿ç”¨:"
          df -h /mnt
          echo ""
          echo "ğŸ“… å¼€å§‹æ—¶é—´: $(date)"
      
      # 4. å‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: ğŸ—ï¸ å‡†å¤‡ç¯å¢ƒ
        run: |
          echo "=== å‡†å¤‡æ„å»ºç¯å¢ƒ ==="
          
          # å®‰è£…ä¾èµ–
          echo "[1/3] å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo apt-get update
          
          # å®‰è£…å¿…éœ€çš„å·¥å…·
          sudo apt-get install -y \
            build-essential \
            gcc g++ make \
            flex bison \
            libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
            texinfo \
            ncurses-dev libncursesw5-dev \
            python3 python3-dev \
            git wget curl \
            zlib1g-dev \
            file pkg-config \
            gawk 2>&1 | tee /tmp/deps.log
          
          echo "[2/3] éªŒè¯å·¥å…·..."
          echo "å…³é”®å·¥å…·ç‰ˆæœ¬:"
          for tool in gcc g++ make flex bison python3; do
            if command -v $tool >/dev/null; then
              version=$($tool --version 2>&1 | head -1)
              echo "  âœ… $tool: $version"
            else
              echo "  âŒ $tool: æœªæ‰¾åˆ°"
            fi
          done
          
          echo "[3/3] åˆ›å»ºæ„å»ºç›®å½•..."
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          
          echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
      
      # 5. è·å–OpenWrtæºç 
      - name: ğŸ“¥ è·å–æºç 
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "[1/3] å…‹éš†æºç ..."
          # ä½¿ç”¨å·²çŸ¥çš„ç¨³å®šåˆ†æ”¯
          git clone --depth 1 --branch v23.05.2 https://github.com/openwrt/openwrt.git . 2>&1 | tee /tmp/clone.log
          
          echo "[2/3] æ˜¾ç¤ºæºç ä¿¡æ¯..."
          echo "åˆ†æ”¯: $(git branch --show-current)"
          echo "æäº¤: $(git log -1 --format='%h - %s')"
          echo "ç‰ˆæœ¬: $(cat version.txt 2>/dev/null || echo 'æœªçŸ¥')"
          
          echo "[3/3] åˆ›å»ºç¼–è¯‘å™¨æ„å»ºé…ç½®..."
          # åˆ›å»ºæœ€å°åŒ–é…ç½®ï¼Œåªæ„å»ºå·¥å…·é“¾
          cat > .config << 'EOF'
          # æœ€å°åŒ–å·¥å…·é“¾æ„å»ºé…ç½®
          CONFIG_TARGET_armsr=y
          CONFIG_TARGET_armsr_armv8=y
          CONFIG_TARGET_ROOTFS_INITRAMFS=y
          CONFIG_EXTERNAL_TOOLCHAIN=n
          CONFIG_USE_MUSL=y
          CONFIG_BUILD_TOOLCHAIN=y
          
          # ç‰ˆæœ¬é…ç½®
          CONFIG_GCC_VERSION="${{ env.GCC_VERSION }}"
          CONFIG_BINUTILS_VERSION="${{ env.BINUTILS_VERSION }}"
          CONFIG_LINUX_VERSION="${{ env.LINUX_VERSION }}"
          CONFIG_MUSL_VERSION="${{ env.MUSL_VERSION }}"
          
          # ç¦ç”¨æ‰€æœ‰åŒ…ï¼Œåªæ„å»ºå·¥å…·é“¾
          CONFIG_PACKAGE_busybox=n
          CONFIG_PACKAGE_dnsmasq=n
          CONFIG_PACKAGE_firewall=n
          CONFIG_PACKAGE_luci=n
          CONFIG_PACKAGE_wpad=n
          CONFIG_PACKAGE_opkg=n
          EOF
          
          echo "âœ… æºç å‡†å¤‡å®Œæˆ"
          echo "é…ç½®æ–‡ä»¶æ‘˜è¦:"
          grep -E "CONFIG_(TARGET|GCC|BINUTILS|LINUX|MUSL|PACKAGE)" .config | head -15
      
      # 6. åˆ†æ­¥ç¼–è¯‘ï¼ˆæœ€è¯¦ç»†çš„è¾“å‡ºï¼‰
      - name: ğŸ”¨ è¯¦ç»†ç¼–è¯‘è¿‡ç¨‹
        timeout-minutes: 180
        run: |
          echo "=== å¼€å§‹è¯¦ç»†ç¼–è¯‘è¿‡ç¨‹ ==="
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          cd "${{ env.BUILD_DIR }}"
          
          # è®¾ç½®æœ€å¤§è¯¦ç»†åº¦
          export V=99
          export TERM=dumb
          export TERMINFO=/usr/share/terminfo
          export FORCE_UNSAFE_CONFIGURE=1
          
          # å¯åŠ¨ç›‘æ§
          echo "[ç›‘æ§] å¯åŠ¨èµ„æºç›‘æ§..."
          (
            counter=0
            while true; do
              echo ""
              echo "ğŸ“Š ç›‘æ§å¿«ç…§ #$counter - $(date '+%H:%M:%S')"
              echo "----------------------------------------"
              
              # å†…å­˜ä½¿ç”¨
              echo "å†…å­˜:"
              free -m | grep -E "^Mem:|^Swap:" | awk '{print "  "$1": "$3"/"$2"MB ("int($3*100/$2)"%)"}'
              
              # CPUä½¿ç”¨
              echo "CPUè´Ÿè½½: $(uptime | awk -F'load average:' '{print $2}')"
              
              # ç£ç›˜ä½¿ç”¨
              echo "ç£ç›˜:"
              df -h /mnt | tail -1 | awk '{print "  /mnt: "$4" å¯ç”¨ / "$2" æ€»"}'
              
              # ç¼–è¯‘è¿›ç¨‹
              echo "ç¼–è¯‘è¿›ç¨‹:"
              ps aux | grep -E "(gcc|g\+\+|make|ld|as|ar|strip)" | grep -v grep | awk '{print "  "$11}' | sort | uniq -c
              
              # æ„å»ºè¿›åº¦
              if [ -d "build_dir" ]; then
                echo "æ„å»ºæ–‡ä»¶ç»Ÿè®¡:"
                echo "  *.oæ–‡ä»¶: $(find build_dir -name "*.o" 2>/dev/null | wc -l)"
                echo "  *.aæ–‡ä»¶: $(find build_dir -name "*.a" 2>/dev/null | wc -l)"
              fi
              
              counter=$((counter + 1))
              sleep 30
            done
          ) &
          MONITOR_PID=$!
          
          # å‡½æ•°ï¼šè¿è¡Œæ­¥éª¤å¹¶æ£€æŸ¥ç»“æœ
          run_step() {
            local step_num=$1
            local step_name=$2
            local command=$3
            local log_file="/tmp/step${step_num}.log"
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "æ­¥éª¤ ${step_num}: ${step_name}"
            echo "å¼€å§‹æ—¶é—´: $(date)"
            echo "å‘½ä»¤: ${command}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # æ‰§è¡Œå‘½ä»¤
            eval "$command" 2>&1 | tee "$log_file"
            local status=${PIPESTATUS[0]}
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "æ­¥éª¤ ${step_num} å®Œæˆ"
            echo "çŠ¶æ€: $status"
            echo "ç»“æŸæ—¶é—´: $(date)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            if [ $status -eq 0 ]; then
              echo "âœ… ${step_name} æˆåŠŸ"
              
              # æ˜¾ç¤ºæ‘˜è¦ä¿¡æ¯
              case $step_num in
                1)
                  echo "ä¸‹è½½ç»Ÿè®¡:"
                  echo "  - æ–‡ä»¶æ•°: $(find dl -type f 2>/dev/null | wc -l)"
                  echo "  - æ€»å¤§å°: $(du -sh dl 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
                  ;;
                2)
                  echo "é…ç½®æ‘˜è¦:"
                  grep -E "CONFIG_(GCC|BINUTILS|LINUX|MUSL)" .config
                  ;;
                3)
                  echo "binutils æ–‡ä»¶:"
                  find build_dir -path "*binutils*" -name "*.a" 2>/dev/null | head -3
                  ;;
              esac
              
              return 0
            else
              echo "âŒ ${step_name} å¤±è´¥ (é€€å‡ºç : $status)"
              echo "é”™è¯¯æ—¥å¿—æœ€å50è¡Œ:"
              tail -50 "$log_file"
              
              # åœæ­¢ç›‘æ§
              kill $MONITOR_PID 2>/dev/null || true
              return 1
            fi
          }
          
          # æ­¥éª¤1: ä¸‹è½½
          run_step 1 "ä¸‹è½½ä¾èµ–åŒ…" "make -j$(nproc) download V=sc"
          [ $? -ne 0 ] && exit 1
          
          # æ­¥éª¤2: é…ç½®
          run_step 2 "é…ç½®ç¯å¢ƒ" "make defconfig V=sc"
          [ $? -ne 0 ] && exit 1
          
          # æ­¥éª¤3: ç¼–è¯‘binutils
          run_step 3 "ç¼–è¯‘binutils" "timeout 60m make toolchain/binutils/compile -j1 V=sc"
          [ $? -ne 0 ] && exit 1
          
          # æ­¥éª¤4: ç¼–è¯‘gccåˆå§‹é˜¶æ®µ
          run_step 4 "ç¼–è¯‘gccåˆå§‹é˜¶æ®µ" "timeout 60m make toolchain/gcc/compile -j1 V=sc"
          [ $? -ne 0 ] && exit 1
          
          # æ­¥éª¤5: ç¼–è¯‘musl
          run_step 5 "ç¼–è¯‘musl" "timeout 45m make toolchain/musl/compile -j1 V=sc"
          [ $? -ne 0 ] && exit 1
          
          # æ­¥éª¤6: ç¼–è¯‘å®Œæ•´gcc
          run_step 6 "ç¼–è¯‘å®Œæ•´gcc" "timeout 90m make toolchain/gcc/compile -j1 V=sc"
          [ $? -ne 0 ] && exit 1
          
          # æ­¥éª¤7: å®‰è£…å·¥å…·é“¾
          run_step 7 "å®‰è£…å·¥å…·é“¾" "timeout 30m make toolchain/install -j1 V=sc"
          [ $? -ne 0 ] && exit 1
          
          # åœæ­¢ç›‘æ§
          kill $MONITOR_PID 2>/dev/null || true
          
          echo ""
          echo "ğŸ‰ ğŸ‰ ğŸ‰ æ‰€æœ‰ç¼–è¯‘æ­¥éª¤æˆåŠŸå®Œæˆï¼"
          echo "æ€»å¼€å§‹æ—¶é—´: $(grep 'å¼€å§‹æ—¶é—´' /tmp/step1.log | head -1 | cut -d: -f2-)"
          echo "æ€»ç»“æŸæ—¶é—´: $(date)"
      
      # 7. éªŒè¯å¹¶ä¿å­˜å·¥å…·é“¾
      - name: âœ… éªŒè¯å·¥å…·é“¾
        run: |
          echo "=== éªŒè¯ç¼–è¯‘ç»“æœ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # æŸ¥æ‰¾å·¥å…·é“¾
          echo "[1/3] æŸ¥æ‰¾å·¥å…·é“¾..."
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            echo "staging_dir å†…å®¹:"
            ls -la staging_dir/ 2>/dev/null || echo "staging_dir ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°å·¥å…·é“¾: $(basename "$TOOLCHAIN_DIR")"
          echo "è·¯å¾„: $TOOLCHAIN_DIR"
          
          # æµ‹è¯•ç¼–è¯‘å™¨
          echo "[2/3] æµ‹è¯•ç¼–è¯‘å™¨..."
          GCC_FILE="$TOOLCHAIN_DIR/bin/"*"-gcc"
          
          if [ -f $GCC_FILE ]; then
            echo "âœ… æ‰¾åˆ°GCCç¼–è¯‘å™¨: $(basename "$GCC_FILE")"
            echo "ç‰ˆæœ¬ä¿¡æ¯:"
            $GCC_FILE --version 2>&1 | head -3
            
            # ç®€å•ç¼–è¯‘æµ‹è¯•
            echo "ç¼–è¯‘æµ‹è¯•..."
            cat > /tmp/test.c << 'EOF'
            #include <stdio.h>
            int main() {
                printf("Compiler test OK!\n");
                return 0;
            }
            EOF
            
            if $GCC_FILE /tmp/test.c -o /tmp/test.out 2>/dev/null; then
              echo "âœ… ç¼–è¯‘æµ‹è¯•é€šè¿‡"
              /tmp/test.out
            else
              echo "âš ï¸ ç¼–è¯‘æµ‹è¯•å¤±è´¥"
            fi
            
            rm -f /tmp/test.c /tmp/test.out 2>/dev/null
          else
            echo "âŒ æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨"
            echo "binç›®å½•å†…å®¹:"
            ls -la "$TOOLCHAIN_DIR/bin/" 2>/dev/null | head -10
          fi
          
          # æ£€æŸ¥å…¶ä»–å…³é”®æ–‡ä»¶
          echo "[3/3] æ£€æŸ¥å…³é”®æ–‡ä»¶..."
          for file in "bin/*-g++" "bin/*-ld" "bin/*-ar" "bin/*-strip"; do
            if find "$TOOLCHAIN_DIR" -name "$(basename "$file")" -type f 2>/dev/null | head -1 | grep -q .; then
              echo "âœ… $(basename "$file")"
            else
              echo "âš ï¸ $(basename "$file") - æœªæ‰¾åˆ°"
            fi
          done
          
          echo "å·¥å…·é“¾å¤§å°: $(du -sh "$TOOLCHAIN_DIR" | cut -f1)"
      
      # 8. ä¿å­˜åˆ°ä»“åº“
      - name: ğŸ’¾ ä¿å­˜åˆ°ä»“åº“
        run: |
          echo "=== ä¿å­˜å·¥å…·é“¾åˆ°ä»“åº“ ==="
          
          cd "${{ env.BUILD_DIR }}"
          
          # æŸ¥æ‰¾å·¥å…·é“¾
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ°å·¥å…·é“¾"
            exit 1
          fi
          
          echo "[1/4] æ¸…ç†æ—§ç¼–è¯‘å™¨..."
          rm -rf "${{ env.COMPILER_DIR }}"
          mkdir -p "${{ env.COMPILER_DIR }}"
          
          echo "[2/4] å¤åˆ¶å·¥å…·é“¾..."
          # å¤åˆ¶æ•´ä¸ªå·¥å…·é“¾
          cp -r "$TOOLCHAIN_DIR"/* "${{ env.COMPILER_DIR }}/"
          
          echo "[3/4] åˆ›å»ºä¿¡æ¯æ–‡ä»¶..."
          # åˆ›å»ºè¯¦ç»†çš„README
          cat > "${{ env.COMPILER_DIR }}/README.md" << EOF
          # OpenWrt äº¤å‰ç¼–è¯‘å™¨
          
          ## æ„å»ºä¿¡æ¯
          - **æ„å»ºæ—¶é—´**: $(date)
          - **OpenWrtç‰ˆæœ¬**: $(cat version.txt 2>/dev/null || echo '23.05.2')
          - **å·¥ä½œæµè¿è¡Œ**: ${{ github.run_id }}
          
          ## ç‰ˆæœ¬ä¿¡æ¯
          | ç»„ä»¶ | ç‰ˆæœ¬ |
          |------|------|
          | GCC | ${{ env.GCC_VERSION }} |
          | Binutils | ${{ env.BINUTILS_VERSION }} |
          | Linuxå†…æ ¸ | ${{ env.LINUX_VERSION }} |
          | Musl | ${{ env.MUSL_VERSION }} |
          
          ## æ¶æ„ä¿¡æ¯
          - **ç›®æ ‡**: arm-openwrt-linux-muslgnueabi
          - **Cåº“**: musl
          - **å­—èŠ‚åº**: å°ç«¯
          
          ## ä½¿ç”¨æ–¹æ³•
          åœ¨OpenWrtæ„å»ºä¸­ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ï¼š
          \`\`\`bash
          export STAGING_DIR=/path/to/this/compiler
          \`\`\`
          
          æˆ–è€…åœ¨makeå‘½ä»¤ä¸­æŒ‡å®šï¼š
          \`\`\`bash
          make STAGING_DIR=/path/to/this/compiler
          \`\`\`
          
          ## æ–‡ä»¶åˆ—è¡¨
          ä¸»è¦æ–‡ä»¶ï¼š
          \`\`\`
          bin/arm-openwrt-linux-muslgnueabi-gcc    # Cç¼–è¯‘å™¨
          bin/arm-openwrt-linux-muslgnueabi-g++    # C++ç¼–è¯‘å™¨
          bin/arm-openwrt-linux-muslgnueabi-ld     # é“¾æ¥å™¨
          bin/arm-openwrt-linux-muslgnueabi-ar     # å½’æ¡£å·¥å…·
          bin/arm-openwrt-linux-muslgnueabi-strip  # ç¬¦å·å‰¥ç¦»å·¥å…·
          \`\`\`
          EOF
          
          echo "[4/4] æ˜¾ç¤ºç»“æœ..."
          echo "âœ… å·¥å…·é“¾å·²ä¿å­˜åˆ°: ${{ env.COMPILER_DIR }}"
          echo "ğŸ“¦ å¤§å°: $(du -sh "${{ env.COMPILER_DIR }}" | cut -f1)"
          echo "ğŸ“ æ–‡ä»¶æ•°: $(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)"
          
          # æ˜¾ç¤ºä¸€äº›å…³é”®æ–‡ä»¶
          echo "å…³é”®æ–‡ä»¶ç¤ºä¾‹:"
          find "${{ env.COMPILER_DIR }}/bin" -type f -name "*gcc" -o -name "*g++" 2>/dev/null | head -5
      
      # 9. æäº¤æ›´æ–°
      - name: ğŸ“¤ æäº¤åˆ°ä»“åº“
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°ä»“åº“ ==="
          
          cd "${{ github.workspace }}"
          
          # é…ç½®Git
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          
          echo "[1/3] æ£€æŸ¥å˜æ›´..."
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
          if [ -d "${{ env.COMPILER_DIR }}" ]; then
            # è®¡ç®—ç›®å½•å¤§å°
            SIZE=$(du -sh "${{ env.COMPILER_DIR }}" | cut -f1)
            
            # æ£€æŸ¥æ˜¯å¦çœŸçš„æœ‰æ–°æ–‡ä»¶
            if [ "$(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)" -gt 0 ]; then
              echo "æ£€æµ‹åˆ°æ–°ç¼–è¯‘å™¨ï¼Œå¤§å°: $SIZE"
              
              echo "[2/3] æ·»åŠ åˆ°Git..."
              git add "firmware-config/build-Compiler-file/compiled"
              
              echo "[3/3] æäº¤å¹¶æ¨é€..."
              git commit -m "build(compiler): æ›´æ–°äº¤å‰ç¼–è¯‘å™¨ v${{ env.GCC_VERSION }}
              
              ç‰ˆæœ¬ä¿¡æ¯:
              â€¢ GCC: ${{ env.GCC_VERSION }}
              â€¢ Binutils: ${{ env.BINUTILS_VERSION }}
              â€¢ Linuxå†…æ ¸: ${{ env.LINUX_VERSION }}
              â€¢ Musl: ${{ env.MUSL_VERSION }}
              
              æ„å»ºè¯¦æƒ…:
              â€¢ å¤§å°: $SIZE
              â€¢ æ—¶é—´: $(date '+%Y-%m-%d %H:%M')
              â€¢ å·¥ä½œæµ: ${{ github.workflow }}
              
              ç”¨äºOpenWrt/ImmortalWrtå›ºä»¶æ„å»ºã€‚"
              
              # å°è¯•æ¨é€
              if git push; then
                echo "ğŸ‰ ç¼–è¯‘å™¨å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œä½†æäº¤å·²ä¿å­˜åœ¨æœ¬åœ°"
              fi
            else
              echo "âœ… ç¼–è¯‘å™¨ç›®å½•ä¸ºç©ºï¼Œæ— éœ€æäº¤"
            fi
          else
            echo "âœ… ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€æäº¤"
          fi
      
      # 10. ä¸Šä¼ æ—¥å¿—ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
      - name: ğŸ“„ ä¸Šä¼ æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compiler-debug-logs
          path: |
            /tmp/*.log
            /tmp/step*.log
            ${{ env.BUILD_DIR }}/.config
            ${{ env.BUILD_DIR }}/build.log
          retention-days: 7
