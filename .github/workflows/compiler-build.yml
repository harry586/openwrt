# .github/workflows/compiler-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      arch_type:
        description: 'æ¶æ„ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options: ['all', 'arm', 'mips', 'x86', 'riscv', 'aarch64']
      gcc_version:
        description: 'GCCç‰ˆæœ¬'
        required: true
        default: '10.3.0'
        type: choice
        options: ['10.3.0', '11.3.0', '12.3.0', '13.2.0']

env:
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"
  BUILD_BASE_DIR: "/mnt/compiler-build"

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      arch_list: ${{ steps.setup-arch.outputs.arch_list }}
      openwrt_version: ${{ steps.version-detection.outputs.openwrt_version }}
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      glibc_version: ${{ steps.version-detection.outputs.glibc_version }}
      start_time: ${{ steps.get-time.outputs.start_time }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: â° è·å–å¼€å§‹æ—¶é—´
        id: get-time
        run: |
          echo "start_time=$(date)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ è®¾ç½®æ„å»ºç›®å½•æƒé™
        run: |
          echo "=== è®¾ç½®æ„å»ºç›®å½•æƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $USER:$USER /mnt/compiler-build 2>/dev/null || true
          ls -ld /mnt/compiler-build

      - name: ğŸ—ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          mkdir -p "${{ env.BUILD_BASE_DIR }}"
          echo "ç¼–è¯‘å™¨åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "æ„å»ºåŸºç¡€ç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„åˆ—è¡¨
        id: setup-arch
        run: |
          echo "=== è®¾ç½®ç›®æ ‡æ¶æ„åˆ—è¡¨ ==="
          ARCH_TYPE="${{ github.event.inputs.arch_type }}"
          
          case "$ARCH_TYPE" in
            'all')
              ARCH_LIST='["aarch64","x86_64","mips","mipsel","arm_cortex-a7","arm_cortex-a53","riscv64"]'
              echo "âœ… é€‰æ‹©æ‰€æœ‰æ¶æ„ç±»å‹"
              ;;
            'arm')
              ARCH_LIST='["arm_cortex-a7","arm_cortex-a53"]'
              echo "âœ… é€‰æ‹©ARMæ¶æ„"
              ;;
            'mips')
              ARCH_LIST='["mips","mipsel"]'
              echo "âœ… é€‰æ‹©MIPSæ¶æ„"
              ;;
            'x86')
              ARCH_LIST='["x86_64"]'
              echo "âœ… é€‰æ‹©x86æ¶æ„"
              ;;
            'riscv')
              ARCH_LIST='["riscv64"]'
              echo "âœ… é€‰æ‹©RISC-Væ¶æ„"
              ;;
            'aarch64')
              ARCH_LIST='["aarch64"]'
              echo "âœ… é€‰æ‹©AArch64æ¶æ„"
              ;;
            *)
              ARCH_LIST='["aarch64"]'
              echo "âš ï¸ æœªçŸ¥ç±»å‹ï¼Œé»˜è®¤é€‰æ‹©AArch64"
              ;;
          esac
          
          echo "ç›®æ ‡æ¶æ„åˆ—è¡¨: $ARCH_LIST"
          echo "arch_list=$ARCH_LIST" >> $GITHUB_OUTPUT

      - name: ğŸ” æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸é€‰æ‹©
        id: version-detection
        run: |
          echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸é€‰æ‹© ==="
          GCC_VERSION="${{ github.event.inputs.gcc_version }}"
          
          echo "ç”¨æˆ·é€‰æ‹©çš„GCCç‰ˆæœ¬: $GCC_VERSION"
          
          case "$GCC_VERSION" in
            '10.3.0')
              OPENWRT_VERSION="21.02.5"
              BINUTILS_VERSION="2.36.1"
              LINUX_VERSION="5.4.188"
              MUSL_VERSION="1.2.2"
              GLIBC_VERSION="2.33"
              ;;
            '11.3.0')
              OPENWRT_VERSION="22.03.5"
              BINUTILS_VERSION="2.38"
              LINUX_VERSION="5.10.179"
              MUSL_VERSION="1.2.3"
              GLIBC_VERSION="2.35"
              ;;
            '12.3.0')
              OPENWRT_VERSION="23.05.2"
              BINUTILS_VERSION="2.40"
              LINUX_VERSION="5.15.133"
              MUSL_VERSION="1.2.4"
              GLIBC_VERSION="2.37"
              ;;
            '13.2.0')
              OPENWRT_VERSION="snapshot"
              BINUTILS_VERSION="2.41"
              LINUX_VERSION="6.1.69"
              MUSL_VERSION="1.2.5"
              GLIBC_VERSION="2.38"
              ;;
            *)
              OPENWRT_VERSION="23.05.2"
              BINUTILS_VERSION="2.40"
              LINUX_VERSION="5.15.133"
              MUSL_VERSION="1.2.4"
              GLIBC_VERSION="2.37"
              echo "âš ï¸ æœªçŸ¥GCCç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
              ;;
          esac
          
          echo "ğŸ¯ æœ€ç»ˆç‰ˆæœ¬é€‰æ‹©:"
          echo "- OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          echo "- GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "- Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "- Linuxå†…æ ¸: $LINUX_VERSION"
          echo "- Muslç‰ˆæœ¬: $MUSL_VERSION"
          echo "- Glibcç‰ˆæœ¬: $GLIBC_VERSION"
          
          echo "openwrt_version=$OPENWRT_VERSION" >> $GITHUB_OUTPUT
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT

  build-matrix:
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJSON(needs.setup.outputs.arch_list) }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”§ è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™
        run: |
          echo "=== è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $(whoami):$(whoami) /mnt/compiler-build 2>/dev/null || true
          ls -ld /mnt/compiler-build

      - name: ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨
        run: |
          echo "=== æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ ==="
          ARCH="${{ matrix.arch }}"
          GCC_VERSION='${{ needs.setup.outputs.gcc_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH}/musl/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "æ£€æŸ¥ç›®å½•: $OUTPUT_DIR"
          
          if [ -d "$OUTPUT_DIR/bin" ]; then
            COMPILER_FILES=$(find "$OUTPUT_DIR/bin" -name "*gcc" -type f 2>/dev/null)
            if [ -n "$COMPILER_FILES" ]; then
              COMPILER_VERSION=$("$COMPILER_FILES" --version 2>&1 | head -1 | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" || echo "")
              if [ -n "$COMPILER_VERSION" ] && [ "$COMPILER_VERSION" = "$GCC_VERSION" ]; then
                echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ä¸”ç‰ˆæœ¬æ­£ç¡®ï¼Œè·³è¿‡æ„å»º"
                echo "SKIP_BUILD=true" >> $GITHUB_ENV
              else
                echo "âš ï¸ æœ‰ç¼–è¯‘å™¨ä½†ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œéœ€è¦é‡æ–°æ„å»º"
                echo "SKIP_BUILD=false" >> $GITHUB_ENV
              fi
            else
              echo "âš ï¸ æœ‰ç›®å½•ä½†æ— ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œéœ€è¦æ„å»º"
              echo "SKIP_BUILD=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: â­ï¸ è·³è¿‡æ„å»º
        if: env.SKIP_BUILD == 'true'
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æ„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ä¸”å®Œæ•´ï¼Œè·³è¿‡æ„å»º"
          echo "- æ¶æ„: ${{ matrix.arch }}"
          echo "- GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "- è¾“å‡ºç›®å½•: ${{ env.COMPILER_BASE_DIR }}/compilers/${{ matrix.arch }}/musl/gcc-${{ needs.setup.outputs.gcc_version }}_binutils-${{ needs.setup.outputs.binutils_version }}"
          echo "========================================"

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æ¶æ„: ${{ matrix.arch }}"
          echo "Cåº“ç±»å‹: musl"
          echo "GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„ç¯å¢ƒ
        id: setup-env
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è®¾ç½®æ¶æ„ç¯å¢ƒ ==="
          ARCH="${{ matrix.arch }}"
          
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="ipq40xx"
              SUBTARGET="generic"
              ARCH_NAME="arm"
              PREFIX="arm-openwrt-linux-musl"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              PREFIX="aarch64-openwrt-linux-musl"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              PREFIX="x86_64-openwrt-linux-musl"
              CPU_TYPE="x86_64"
              TUNE="generic"
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              PREFIX="mips-openwrt-linux-musl"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              PREFIX="mipsel-openwrt-linux-musl"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ;;
            arm_cortex-a53)
              TARGET="rockchip"
              SUBTARGET="armv8"
              ARCH_NAME="aarch64"
              PREFIX="aarch64-openwrt-linux-musl"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              PREFIX="riscv64-openwrt-linux-musl"
              CPU_TYPE="generic"
              TUNE="generic"
              ;;
          esac
          
          BUILD_ID="${ARCH}_musl_gcc-${{ needs.setup.outputs.gcc_version }}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="${{ env.BUILD_BASE_DIR }}/${BUILD_ID}"
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH}/musl/gcc-${{ needs.setup.outputs.gcc_version }}_binutils-${{ needs.setup.outputs.binutils_version }}"
          
          echo "ğŸ“Š ç¯å¢ƒé…ç½®æ±‡æ€»:"
          echo "  æ„å»ºID: $BUILD_ID"
          echo "  æ„å»ºç›®å½•: $BUILD_DIR"
          echo "  è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          echo "  æ¶æ„åç§°: $ARCH_NAME"
          echo "  ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== å®‰è£…æ„å»ºä¾èµ– ==="
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison git wget curl file gawk gettext rsync unzip autoconf automake libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev libelf-dev libdw-dev libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev python3 python3-dev libncurses5-dev libssl-dev liblzma-dev zlib1g-dev

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          
          OPENWRT_VERSION="${{ needs.setup.outputs.openwrt_version }}"
          
          if [ "$OPENWRT_VERSION" = "snapshot" ]; then
            echo "ä½¿ç”¨ä¸»åˆ†æ”¯å¿«ç…§..."
            git clone --depth 1 https://github.com/openwrt/openwrt.git .
          else
            echo "ä½¿ç”¨ç‰ˆæœ¬æ ‡ç­¾ v$OPENWRT_VERSION"
            git clone --depth 1 --branch "v$OPENWRT_VERSION" https://github.com/openwrt/openwrt.git .
          fi
          
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"

      - name: ğŸ› ï¸ ä¿®æ”¹é…ç½®å¼ºåˆ¶ç‰¹å®šGCCç‰ˆæœ¬
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== ä¿®æ”¹é…ç½®å¼ºåˆ¶GCCç‰ˆæœ¬ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          
          echo "æ­¥éª¤1: æ¸…ç†ç°æœ‰çš„é…ç½®..."
          if [ -f ".config" ]; then
            rm -f .config
          fi
          
          echo "æ­¥éª¤2: ä¸‹è½½feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo "æ­¥éª¤3: åˆ›å»ºåŸºç¡€é…ç½®..."
          
          # é€‰æ‹©ç›®æ ‡å¹³å°
          case "${{ env.ARCH_NAME }}" in
            arm)
              echo "CONFIG_TARGET_ipq40xx=y" > .config
              echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
              ;;
            aarch64)
              echo "CONFIG_TARGET_armvirt=y" > .config
              echo "CONFIG_TARGET_armvirt_64=y" >> .config
              ;;
            x86_64)
              echo "CONFIG_TARGET_x86=y" > .config
              echo "CONFIG_TARGET_x86_64=y" >> .config
              ;;
            mips)
              echo "CONFIG_TARGET_ramips=y" > .config
              echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
              ;;
            mipsel)
              echo "CONFIG_TARGET_ramips=y" > .config
              echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
              ;;
            riscv64)
              echo "CONFIG_TARGET_virt=y" > .config
              echo "CONFIG_TARGET_virt_rv64=y" >> .config
              ;;
          esac
          
          # å·¥å…·é“¾é…ç½® - å¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬
          echo "# å·¥å…·é“¾é…ç½®" >> .config
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "CONFIG_TOOLCHAINOPTS=y" >> .config
          echo "CONFIG_GCC_VERSION=\"${{ needs.setup.outputs.gcc_version }}\"" >> .config
          echo "CONFIG_BINUTILS_VERSION=\"${{ needs.setup.outputs.binutils_version }}\"" >> .config
          echo "CONFIG_LIBC=\"musl\"" >> .config
          echo "CONFIG_MUSL_VERSION=\"${{ needs.setup.outputs.musl_version }}\"" >> .config
          echo "CONFIG_LINUX_VERSION=\"${{ needs.setup.outputs.linux_version }}\"" >> .config
          echo "CONFIG_USE_MUSL=y" >> .config
          echo "CONFIG_GCC_USE_VERSION_CONTROL=n" >> .config
          echo "CONFIG_TOOLCHAIN_LIBC_MUSL=y" >> .config
          
          # SDKç›¸å…³é…ç½®
          echo "# SDKé…ç½®" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          
          # ç¦ç”¨ä¸éœ€è¦çš„åŒ…
          echo "# ç¦ç”¨ä¸éœ€è¦çš„åŒ…" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          
          echo "æ­¥éª¤4: ç”Ÿæˆé…ç½®..."
          yes "" | make oldconfig 2>&1 | tail -20
          
          echo "æ­¥éª¤5: æ£€æŸ¥GCCé…ç½®..."
          grep "CONFIG_GCC" .config || echo "æœªæ‰¾åˆ°GCCé…ç½®"
          grep "GCC_VERSION" .config || echo "æœªæ‰¾åˆ°GCC_VERSION"
          
          echo "âœ… é…ç½®åˆ›å»ºå®Œæˆ"

      - name: âš™ï¸ æ„å»ºå·¥å…·é“¾
        if: env.SKIP_BUILD != 'true'
        timeout-minutes: 240
        run: |
          echo "=== æ„å»ºå·¥å…·é“¾ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "æ­¥éª¤1: ä¸‹è½½æºç ..."
          make download -j$(nproc) 2>&1 | tail -100
          
          echo "æ­¥éª¤2: æ£€æŸ¥ä¸‹è½½çš„GCCæºç ..."
          ls -lh dl/gcc-*.tar.* 2>/dev/null || echo "æœªæ‰¾åˆ°GCCæºç "
          
          echo "æ­¥éª¤3: æ„å»ºå·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # åªæ„å»ºå·¥å…·é“¾ç›¸å…³éƒ¨åˆ†
          echo "æ„å»ºtoolchain..."
          make toolchain/compile -j$(nproc) 2>&1 | tee /tmp/toolchain-compile.log
          COMPILE_STATUS=${PIPESTATUS[0]}
          
          if [ $COMPILE_STATUS -eq 0 ]; then
            echo "âœ… toolchainç¼–è¯‘æˆåŠŸ"
          else
            echo "âš ï¸ toolchainç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ç»§ç»­æ„å»ºå…¶ä»–éƒ¨åˆ†"
            echo "é”™è¯¯æ‘˜è¦:"
            grep -E "Error:|error:|failed:" /tmp/toolchain-compile.log | tail -20
          fi
          
          echo "æ­¥éª¤4: å®‰è£…å·¥å…·é“¾..."
          make toolchain/install -j$(nproc) 2>&1 | tee /tmp/toolchain-install.log
          
          echo "æ­¥éª¤5: æ„å»ºç›®æ ‡SDK..."
          make target/compile -j$(nproc) 2>&1 | tee /tmp/target-compile.log
          
          echo "æ„å»ºå®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ” æŸ¥æ‰¾å¹¶éªŒè¯å·¥å…·é“¾
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== æŸ¥æ‰¾å¹¶éªŒè¯å·¥å…·é“¾ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "æŸ¥æ‰¾æ‰€æœ‰å·¥å…·é“¾ç›®å½•..."
          TOOLCHAINS=$(find staging_dir -type d -name "toolchain-*" 2>/dev/null | sort)
          
          if [ -z "$TOOLCHAINS" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            echo "å°è¯•æŸ¥æ‰¾binç›®å½•..."
            BIN_DIRS=$(find staging_dir -type d -name "bin" 2>/dev/null)
            for dir in $BIN_DIRS; do
              echo "æ‰¾åˆ°binç›®å½•: $dir"
              PARENT_DIR=$(dirname "$dir")
              TOOLCHAINS="$PARENT_DIR"
              break
            done
          fi
          
          echo "æ‰¾åˆ°çš„å·¥å…·é“¾:"
          for dir in $TOOLCHAINS; do
            SIZE=$(du -sh "$dir" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            echo "- $dir (å¤§å°: $SIZE)"
            
            if [ -d "$dir/bin" ]; then
              COMPILER=$(find "$dir/bin" -name "*gcc" -type f 2>/dev/null | head -1)
              if [ -n "$COMPILER" ] && [ -x "$COMPILER" ]; then
                VERSION=$("$COMPILER" --version 2>&1 | head -1 | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" || echo "æœªçŸ¥")
                echo "  ç¼–è¯‘å™¨: $(basename $COMPILER), ç‰ˆæœ¬: $VERSION"
                
                if echo "$VERSION" | grep -q "^${{ needs.setup.outputs.gcc_version }}"; then
                  echo "  âœ… åŒ¹é…æœŸæœ›çš„GCCç‰ˆæœ¬"
                  SELECTED_TOOLCHAIN="$dir"
                  SELECTED_COMPILER="$COMPILER"
                else
                  echo "  âš ï¸ ç‰ˆæœ¬ä¸åŒ¹é…: $VERSION (æœŸæœ›: ${{ needs.setup.outputs.gcc_version }})"
                fi
              fi
            fi
          done
          
          if [ -n "$SELECTED_TOOLCHAIN" ]; then
            echo "âœ… é€‰æ‹©å·¥å…·é“¾ç›®å½•: $SELECTED_TOOLCHAIN"
            echo "TOOLCHAIN_DIR=$SELECTED_TOOLCHAIN" >> $GITHUB_ENV
            
            if [ -n "$SELECTED_COMPILER" ]; then
              echo "COMPILER_PATH=$SELECTED_COMPILER" >> $GITHUB_ENV
              
              echo "ç¼–è¯‘å™¨è¯¦ç»†ä¿¡æ¯:"
              "$SELECTED_COMPILER" --version 2>&1 | head -5
              
              echo "ç›®æ ‡æ¶æ„:"
              "$SELECTED_COMPILER" -dumpmachine 2>&1 || echo "æ— æ³•è·å–"
            fi
            
            TOOLCHAIN_SIZE=$(du -sh "$SELECTED_TOOLCHAIN" 2>/dev/null | cut -f1 || echo "0")
            echo "å·¥å…·é“¾å¤§å°: $TOOLCHAIN_SIZE"
            echo "TOOLCHAIN_SIZE=$TOOLCHAIN_SIZE" >> $GITHUB_ENV
          else
            echo "âš ï¸ æœªæ‰¾åˆ°åŒ¹é…ç‰ˆæœ¬çš„å·¥å…·é“¾ï¼Œå°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ª"
            if [ -n "$TOOLCHAINS" ]; then
              FIRST_TOOLCHAIN=$(echo "$TOOLCHAINS" | head -1)
              echo "TOOLCHAIN_DIR=$FIRST_TOOLCHAIN" >> $GITHUB_ENV
              echo "âš ï¸ ä½¿ç”¨å·¥å…·é“¾ç›®å½•: $FIRST_TOOLCHAIN"
              
              # å°è¯•æ‰¾åˆ°ç¼–è¯‘å™¨
              COMPILER=$(find "$FIRST_TOOLCHAIN/bin" -name "*gcc" -type f 2>/dev/null | head -1)
              if [ -n "$COMPILER" ]; then
                echo "COMPILER_PATH=$COMPILER" >> $GITHUB_ENV
              fi
              
              TOOLCHAIN_SIZE=$(du -sh "$FIRST_TOOLCHAIN" 2>/dev/null | cut -f1 || echo "0")
              echo "TOOLCHAIN_SIZE=$TOOLCHAIN_SIZE" >> $GITHUB_ENV
            else
              echo "âŒ æœªæ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„å·¥å…·é“¾"
            fi
          fi

      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        if: env.SKIP_BUILD != 'true' && env.TOOLCHAIN_DIR != ''
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨ ==="
          
          echo "å‡†å¤‡è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          rm -rf "${{ env.OUTPUT_DIR }}" 2>/dev/null || true
          mkdir -p "${{ env.OUTPUT_DIR }}"
          
          if [ -d "${{ env.TOOLCHAIN_DIR }}" ]; then
            echo "å¤åˆ¶å·¥å…·é“¾..."
            cp -r "${{ env.TOOLCHAIN_DIR }}"/* "${{ env.OUTPUT_DIR }}"/ 2>&1 | tail -20
            
            echo "éªŒè¯å¤åˆ¶..."
            if [ -d "${{ env.OUTPUT_DIR }}/bin" ]; then
              echo "âœ… binç›®å½•å­˜åœ¨"
              echo "ç¼–è¯‘å™¨æ–‡ä»¶:"
              find "${{ env.OUTPUT_DIR }}/bin" -name "*gcc" -type f 2>/dev/null | head -5
              
              COMPILER=$(find "${{ env.OUTPUT_DIR }}/bin" -name "*gcc" -type f 2>/dev/null | head -1)
              if [ -n "$COMPILER" ] && [ -x "$COMPILER" ]; then
                echo "ç¼–è¯‘å™¨æµ‹è¯•:"
                "$COMPILER" --version 2>&1 | head -3
                
                echo "ç¼–è¯‘æµ‹è¯•..."
                echo 'int main(){return 0;}' > /tmp/test.c
                "$COMPILER" /tmp/test.c -o /tmp/test.out 2>&1 && echo "âœ… ç¼–è¯‘æµ‹è¯•é€šè¿‡" || echo "âš ï¸ ç¼–è¯‘æµ‹è¯•å¤±è´¥"
                rm -f /tmp/test.c /tmp/test.out 2>/dev/null || true
              fi
            else
              echo "âš ï¸ binç›®å½•ä¸å­˜åœ¨"
            fi
            
            TOTAL_SIZE=$(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1 || echo "0K")
            FILE_COUNT=$(find "${{ env.OUTPUT_DIR }}" -type f 2>/dev/null | wc -l || echo 0)
            
            echo "ğŸ“Š ä¿å­˜ç»“æœ:"
            echo "- æ€»å¤§å°: $TOTAL_SIZE"
            echo "- æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            
            echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
            echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          else
            echo "âŒ å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨: ${{ env.TOOLCHAIN_DIR }}"
            echo "TOTAL_SIZE=0K" >> $GITHUB_ENV
            echo "FILE_COUNT=0" >> $GITHUB_ENV
          fi

      - name: ğŸ“ åˆ›å»ºå…ƒæ•°æ®
        if: env.SKIP_BUILD != 'true' && env.TOTAL_SIZE != '0K'
        run: |
          echo "=== åˆ›å»ºå…ƒæ•°æ® ==="
          
          ACTUAL_GCC="æœªçŸ¥"
          if [ -n "${{ env.COMPILER_PATH }}" ] && [ -x "${{ env.COMPILER_PATH }}" ]; then
            ACTUAL_GCC=$("${{ env.COMPILER_PATH }}" --version 2>&1 | head -1 | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" || echo "æœªçŸ¥")
          fi
          
          echo "åˆ›å»ºmetadata.json..."
          echo "{" > "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"architecture\": \"${{ matrix.arch }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"arch_name\": \"${{ env.ARCH_NAME }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"libc\": \"musl\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"libc_version\": \"${{ needs.setup.outputs.musl_version }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"target_gcc_version\": \"${{ needs.setup.outputs.gcc_version }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"actual_gcc_version\": \"$ACTUAL_GCC\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"binutils_version\": \"${{ needs.setup.outputs.binutils_version }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"linux_version\": \"${{ needs.setup.outputs.linux_version }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"openwrt_version\": \"${{ needs.setup.outputs.openwrt_version }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"target\": \"${{ env.TARGET }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"subtarget\": \"${{ env.SUBTARGET }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"compiler_prefix\": \"${{ env.PREFIX }}-\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"build_date\": \"$(date -Iseconds)\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"build_id\": \"${{ env.BUILD_ID }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"size\": \"${{ env.TOTAL_SIZE }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"file_count\": ${{ env.FILE_COUNT }}" >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "}" >> "${{ env.OUTPUT_DIR }}/metadata.json"
          
          echo "å…ƒæ•°æ®å†…å®¹:"
          cat "${{ env.OUTPUT_DIR }}/metadata.json"

      - name: ğŸ“¤ æäº¤åˆ°Gitä»“åº“
        if: env.SKIP_BUILD != 'true' && env.TOTAL_SIZE != '' && env.TOTAL_SIZE != '0K' && env.TOTAL_SIZE != '8.0K'
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°Gitä»“åº“ ==="
          cd "${{ github.workspace }}"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          
          git pull origin main --no-edit
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          
          if ! git diff --cached --quiet; then
            ACTUAL_GCC_VERSION=$(grep -o '"actual_gcc_version": "[^"]*' "${{ env.OUTPUT_DIR }}/metadata.json" 2>/dev/null | cut -d'"' -f4 || echo "æœªçŸ¥")
            
            git commit -m "build(compiler): æ·»åŠ  ${{ matrix.arch }} äº¤å‰ç¼–è¯‘å™¨" \
              -m "æ¶æ„: ${{ matrix.arch }}" \
              -m "ç›®æ ‡GCC: ${{ needs.setup.outputs.gcc_version }}" \
              -m "å®é™…GCC: $ACTUAL_GCC_VERSION" \
              -m "å¤§å°: ${{ env.TOTAL_SIZE }}" \
              -m "æ–‡ä»¶æ•°: ${{ env.FILE_COUNT }}"
            
            git push origin main
            echo "âœ… å·²æäº¤åˆ°ä»“åº“"
          else
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi

      - name: ğŸ“Š æ„å»ºæŠ¥å‘Š
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "========================================"
          echo "          ğŸ‰ æ„å»ºå®ŒæˆæŠ¥å‘Š              "
          echo "========================================"
          
          if [ "${{ env.TOTAL_SIZE }}" ] && [ "${{ env.TOTAL_SIZE }}" != "0K" ] && [ "${{ env.TOTAL_SIZE }}" != "8.0K" ]; then
            echo "âœ… äº¤å‰ç¼–è¯‘å™¨æ„å»ºå®Œæˆ!"
          else
            echo "âš ï¸ äº¤å‰ç¼–è¯‘å™¨æ„å»ºå¯èƒ½æœ‰é—®é¢˜"
          fi
          
          echo ""
          echo "ğŸ“Š æ„å»ºä¿¡æ¯:"
          echo "- æ¶æ„: ${{ matrix.arch }} (${{ env.ARCH_NAME }})"
          echo "- ç›®æ ‡GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          ACTUAL_GCC_VERSION="æœªçŸ¥"
          if [ -f "${{ env.OUTPUT_DIR }}/metadata.json" ]; then
            ACTUAL_GCC_VERSION=$(grep -o '"actual_gcc_version": "[^"]*' "${{ env.OUTPUT_DIR }}/metadata.json" 2>/dev/null | cut -d'"' -f4 || echo "æœªçŸ¥")
          fi
          echo "- å®é™…GCCç‰ˆæœ¬: $ACTUAL_GCC_VERSION"
          echo "- Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "- Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "- è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          echo "- æ€»å¤§å°: ${{ env.TOTAL_SIZE }}"
          
          if [ "${{ env.TOTAL_SIZE }}" ] && [ "${{ env.TOTAL_SIZE }}" != "0K" ] && [ "${{ env.TOTAL_SIZE }}" != "8.0K" ]; then
            echo ""
            echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
            echo "cd ${{ env.OUTPUT_DIR }}"
            echo 'export PATH="$PWD/bin:$PATH"'
            echo "${{ env.PREFIX }}-gcc --version"
          fi
          
          echo ""
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "========================================"

  summary:
    needs: build-matrix
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“Š æ„å»ºæ€»ç»“
        run: |
          echo "========================================"
          echo "           ğŸ¯ æ„å»ºä»»åŠ¡æ€»ç»“              "
          echo "========================================"
          echo "æ¶æ„ç±»å‹: ${{ github.event.inputs.arch_type }}"
          echo "GCCç‰ˆæœ¬: ${{ github.event.inputs.gcc_version }}"
          echo "å¼€å§‹æ—¶é—´: ${{ needs.setup.outputs.start_time }}"
          echo "å®Œæˆæ—¶é—´: $(date)"
          echo "========================================"
          echo "æ‰€æœ‰æ„å»ºä»»åŠ¡å·²å®Œæˆ"
          echo "========================================"
