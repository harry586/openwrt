# .github/workflows/compiler-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      arch_type:
        description: 'æ¶æ„ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options: ['all', 'arm', 'mips', 'x86', 'riscv', 'aarch64']
      gcc_version:
        description: 'GCCç‰ˆæœ¬'
        required: true
        default: '10.3.0'
        type: choice
        options: ['10.3.0', '11.3.0', '12.3.0', '13.2.0']

env:
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"
  BUILD_BASE_DIR: "/mnt/compiler-build"

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      arch_list: ${{ steps.setup-arch.outputs.arch_list }}
      openwrt_version: ${{ steps.version-detection.outputs.openwrt_version }}
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      glibc_version: ${{ steps.version-detection.outputs.glibc_version }}
      start_time: ${{ steps.get-time.outputs.start_time }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: â° è·å–å¼€å§‹æ—¶é—´
        id: get-time
        run: |
          echo "start_time=$(date)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ è®¾ç½®æ„å»ºç›®å½•æƒé™
        run: |
          echo "=== è®¾ç½®æ„å»ºç›®å½•æƒé™ ==="
          echo "åˆ›å»ºå¹¶è®¾ç½®/mnt/compiler-buildç›®å½•æƒé™..."
          
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $USER:$USER /mnt/compiler-build 2>/dev/null || true
          
          echo "éªŒè¯ç›®å½•æƒé™..."
          ls -ld /mnt/compiler-build

      - name: ğŸ—ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          mkdir -p "${{ env.BUILD_BASE_DIR }}"
          echo "ç¼–è¯‘å™¨åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "æ„å»ºåŸºç¡€ç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„åˆ—è¡¨
        id: setup-arch
        run: |
          echo "=== è®¾ç½®ç›®æ ‡æ¶æ„åˆ—è¡¨ ==="
          ARCH_TYPE="${{ github.event.inputs.arch_type }}"
          
          case "$ARCH_TYPE" in
            'all')
              ARCH_LIST='["aarch64", "x86_64", "mips", "mipsel", "arm_cortex-a7", "arm_cortex-a53", "riscv64"]'
              echo "âœ… é€‰æ‹©æ‰€æœ‰æ¶æ„ç±»å‹"
              ;;
            'arm')
              ARCH_LIST='["arm_cortex-a7", "arm_cortex-a53"]'
              echo "âœ… é€‰æ‹©ARMæ¶æ„"
              ;;
            'mips')
              ARCH_LIST='["mips", "mipsel"]'
              echo "âœ… é€‰æ‹©MIPSæ¶æ„"
              ;;
            'x86')
              ARCH_LIST='["x86_64"]'
              echo "âœ… é€‰æ‹©x86æ¶æ„"
              ;;
            'riscv')
              ARCH_LIST='["riscv64"]'
              echo "âœ… é€‰æ‹©RISC-Væ¶æ„"
              ;;
            'aarch64')
              ARCH_LIST='["aarch64"]'
              echo "âœ… é€‰æ‹©AArch64æ¶æ„"
              ;;
            *)
              ARCH_LIST='["aarch64"]'
              echo "âš ï¸ æœªçŸ¥ç±»å‹ï¼Œé»˜è®¤é€‰æ‹©AArch64"
              ;;
          esac
          
          echo "ç›®æ ‡æ¶æ„åˆ—è¡¨: $ARCH_LIST"
          echo "arch_list=$ARCH_LIST" >> $GITHUB_OUTPUT

      - name: ğŸ” æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸é€‰æ‹©
        id: version-detection
        run: |
          echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸é€‰æ‹© ==="
          GCC_VERSION="${{ github.event.inputs.gcc_version }}"
          
          echo "ç”¨æˆ·é€‰æ‹©çš„GCCç‰ˆæœ¬: $GCC_VERSION"
          
          case "$GCC_VERSION" in
            '10.3.0')
              OPENWRT_VERSION="21.02.5"
              BINUTILS_VERSION="2.36.1"
              LINUX_VERSION="5.4.188"
              MUSL_VERSION="1.2.2"
              GLIBC_VERSION="2.33"
              ;;
            '11.3.0')
              OPENWRT_VERSION="22.03.5"
              BINUTILS_VERSION="2.38"
              LINUX_VERSION="5.10.179"
              MUSL_VERSION="1.2.3"
              GLIBC_VERSION="2.35"
              ;;
            '12.3.0')
              OPENWRT_VERSION="23.05.2"
              BINUTILS_VERSION="2.40"
              LINUX_VERSION="5.15.133"
              MUSL_VERSION="1.2.4"
              GLIBC_VERSION="2.37"
              ;;
            '13.2.0')
              OPENWRT_VERSION="snapshot"
              BINUTILS_VERSION="2.41"
              LINUX_VERSION="6.1.69"
              MUSL_VERSION="1.2.5"
              GLIBC_VERSION="2.38"
              ;;
            *)
              OPENWRT_VERSION="23.05.2"
              BINUTILS_VERSION="2.40"
              LINUX_VERSION="5.15.133"
              MUSL_VERSION="1.2.4"
              GLIBC_VERSION="2.37"
              echo "âš ï¸ æœªçŸ¥GCCç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
              ;;
          esac
          
          echo "ğŸ¯ æœ€ç»ˆç‰ˆæœ¬é€‰æ‹©:"
          echo "- OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          echo "- GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "- Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "- Linuxå†…æ ¸: $LINUX_VERSION"
          echo "- Muslç‰ˆæœ¬: $MUSL_VERSION"
          echo "- Glibcç‰ˆæœ¬: $GLIBC_VERSION"
          
          echo "openwrt_version=$OPENWRT_VERSION" >> $GITHUB_OUTPUT
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT

  build-matrix:
    needs: setup
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: ${{ fromJSON(needs.setup.outputs.arch_list) }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”§ è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™
        run: |
          echo "=== è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™ ==="
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $(whoami):$(whoami) /mnt/compiler-build 2>/dev/null || true
          
          echo "éªŒè¯æƒé™..."
          ls -ld /mnt/compiler-build

      - name: ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨
        run: |
          echo "=== æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ ==="
          ARCH="${{ matrix.arch }}"
          GCC_VERSION='${{ needs.setup.outputs.gcc_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          
          echo "æ£€æŸ¥æ¶æ„: $ARCH"
          echo "GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH}/musl/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "æ£€æŸ¥ç›®å½•: $OUTPUT_DIR"
          
          if [ -d "$OUTPUT_DIR" ] && [ -d "$OUTPUT_DIR/bin" ]; then
            echo "âœ… ç¼–è¯‘å™¨ç›®å½•å·²å­˜åœ¨"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰çœŸæ­£çš„ç¼–è¯‘å™¨æ–‡ä»¶
            COMPILER_FILES=$(find "$OUTPUT_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -5)
            if [ -n "$COMPILER_FILES" ]; then
              echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œè·³è¿‡æ„å»º"
              echo "SKIP_BUILD=true" >> $GITHUB_ENV
            else
              echo "âš ï¸ æœ‰ç›®å½•ä½†æ— ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œéœ€è¦æ„å»º"
              echo "SKIP_BUILD=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: â­ï¸ è·³è¿‡æ„å»º
        if: env.SKIP_BUILD == 'true'
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æ„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ä¸”å®Œæ•´ï¼Œè·³è¿‡æ„å»º"
          echo ""
          echo "ğŸ”§ ç°æœ‰ç¼–è¯‘å™¨ä¿¡æ¯:"
          echo "- æ¶æ„: ${{ matrix.arch }}"
          echo "- GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "- è¾“å‡ºç›®å½•: ${{ env.COMPILER_BASE_DIR }}/compilers/${{ matrix.arch }}/musl/gcc-${{ needs.setup.outputs.gcc_version }}_binutils-${{ needs.setup.outputs.binutils_version }}"
          echo "========================================"

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æ¶æ„: ${{ matrix.arch }}"
          echo "Cåº“ç±»å‹: musl"
          echo "GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "è¾“å‡ºç›®å½•: ${{ env.COMPILER_BASE_DIR }}/compilers"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„ç¯å¢ƒ
        id: setup-env
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è®¾ç½®æ¶æ„ç¯å¢ƒ ==="
          ARCH="${{ matrix.arch }}"
          
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="ipq40xx"
              SUBTARGET="generic"
              ARCH_NAME="arm"
              PREFIX="arm-openwrt-linux-musl"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              ABI="32"
              FLOAT_ABI="hard"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              PREFIX="aarch64-openwrt-linux-musl"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              PREFIX="x86_64-openwrt-linux-musl"
              CPU_TYPE="x86_64"
              TUNE="generic"
              ABI="64"
              FLOAT_ABI=""
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              PREFIX="mips-openwrt-linux-musl"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              PREFIX="mipsel-openwrt-linux-musl"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            arm_cortex-a53)
              TARGET="rockchip"
              SUBTARGET="armv8"
              ARCH_NAME="aarch64"
              PREFIX="aarch64-openwrt-linux-musl"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              PREFIX="riscv64-openwrt-linux-musl"
              CPU_TYPE="generic"
              TUNE="generic"
              ABI="lp64d"
              FLOAT_ABI="hard"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
              exit 1
              ;;
          esac
          
          BUILD_ID="${ARCH}_musl_gcc-${{ needs.setup.outputs.gcc_version }}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="${{ env.BUILD_BASE_DIR }}/${BUILD_ID}"
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH}/musl/gcc-${{ needs.setup.outputs.gcc_version }}_binutils-${{ needs.setup.outputs.binutils_version }}"
          
          echo "ğŸ“Š ç¯å¢ƒé…ç½®æ±‡æ€»:"
          echo "  æ„å»ºID: $BUILD_ID"
          echo "  æ„å»ºç›®å½•: $BUILD_DIR"
          echo "  è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          echo "  æ¶æ„åç§°: $ARCH_NAME"
          echo "  ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
          echo "  CPUç±»å‹: $CPU_TYPE"
          echo "  è°ƒä¼˜: $TUNE"
          echo "  ABI: $ABI"
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "TUNE=$TUNE" >> $GITHUB_ENV
          echo "ABI=$ABI" >> $GITHUB_ENV
          echo "FLOAT_ABI=$FLOAT_ABI" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          
          # å°†å…³é”®å˜é‡ä¹Ÿä¿å­˜åˆ°outputsä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "env_target=$TARGET" >> $GITHUB_OUTPUT
          echo "env_subtarget=$SUBTARGET" >> $GITHUB_OUTPUT
          echo "env_arch_name=$ARCH_NAME" >> $GITHUB_OUTPUT
          echo "env_prefix=$PREFIX" >> $GITHUB_OUTPUT

      - name: ğŸ”§ å®‰è£…ä¾èµ–ï¼ˆæ ¹æ®ç‰ˆæœ¬è°ƒæ•´ï¼‰
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== å®‰è£…æ„å»ºä¾èµ– ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          GCC_MAJOR=$(echo "${{ needs.setup.outputs.gcc_version }}" | cut -d. -f1)
          
          echo "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          sudo apt-get update
          
          echo "å®‰è£…åŸºç¡€æ„å»ºå·¥å…·..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison git wget curl file gawk gettext rsync unzip autoconf automake autopoint libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq info install-info liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev libelf-dev libdw-dev libcap-dev libattr1-dev libaudit-dev libiberty-dev
          
          echo "å®‰è£…ç‰ˆæœ¬ç‰¹å®šçš„ä¾èµ–..."
          if [ $GCC_MAJOR -ge 13 ]; then
            echo "GCC 13+ ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev python3-distutils libncurses5-dev libssl-dev gnutls-bin liblzma-dev zlib1g-dev
          elif [ $GCC_MAJOR -ge 11 ]; then
            echo "GCC 11-12 ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev python3-distutils libncurses5-dev libssl-dev gnutls-bin liblzma-dev zlib1g-dev
          else
            echo "GCC 10åŠä»¥ä¸‹ç‰ˆæœ¬ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev python3 python3-dev libncurses5-dev libssl-dev liblzma-dev zlib1g-dev
          fi
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          echo "å®‰è£…çš„åŒ…ç‰ˆæœ¬:"
          gcc --version | head -1
          make --version | head -1
          python3 --version
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "å…‹éš†OpenWrt ${{ needs.setup.outputs.openwrt_version }}..."
          
          OPENWRT_VERSION="${{ needs.setup.outputs.openwrt_version }}"
          
          if [ "$OPENWRT_VERSION" = "snapshot" ]; then
            echo "ä½¿ç”¨ä¸»åˆ†æ”¯å¿«ç…§..."
            git clone --depth 1 https://github.com/openwrt/openwrt.git .
          else
            echo "ä½¿ç”¨ç‰ˆæœ¬æ ‡ç­¾ v$OPENWRT_VERSION"
            if git clone --depth 1 --branch "v$OPENWRT_VERSION" https://github.com/openwrt/openwrt.git .; then
              echo "âœ… Git cloneæˆåŠŸ"
            else
              echo "å°è¯•ä½¿ç”¨taråŒ…..."
              wget --tries=3 --timeout=60 -O openwrt.tar.gz "https://github.com/openwrt/openwrt/archive/refs/tags/v$OPENWRT_VERSION.tar.gz"
              if [ $? -eq 0 ]; then
                tar -xzf openwrt.tar.gz --strip-components=1
                rm -f openwrt.tar.gz
                echo "âœ… ä½¿ç”¨taråŒ…ä¸‹è½½æˆåŠŸ"
              else
                echo "âŒ ä¸‹è½½å¤±è´¥"
                exit 1
              fi
            fi
          fi
          
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ› ï¸ å¼ºåˆ¶é…ç½®OpenWrt
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== å¼ºåˆ¶é…ç½®OpenWrt ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          
          echo "æ­¥éª¤1: æ›´æ–°feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo "æ­¥éª¤2: å¼ºåˆ¶åˆ›å»ºå®Œæ•´çš„.configæ–‡ä»¶..."
          # å®Œå…¨æ¸…ç©ºé…ç½®
          rm -f .config .config.old
          
          # åˆ›å»ºå®Œæ•´çš„é…ç½®
          {
            echo "# Targeté…ç½®"
            echo "CONFIG_TARGET_${{ env.TARGET }}=y"
            echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y"
            echo "CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\""
            echo "CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}-\""
            echo ""
            echo "# å·¥å…·é“¾é…ç½®ï¼ˆå¼ºåˆ¶ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬ï¼‰"
            echo "CONFIG_BUILD_TOOLCHAIN=y"
            echo "CONFIG_GCC_VERSION=\"${{ needs.setup.outputs.gcc_version }}\""
            echo "CONFIG_BINUTILS_VERSION=\"${{ needs.setup.outputs.binutils_version }}\""
            echo "CONFIG_LINUX_VERSION=\"${{ needs.setup.outputs.linux_version }}\""
            echo "CONFIG_USE_MUSL=y"
            echo "CONFIG_MUSL_VERSION=\"${{ needs.setup.outputs.musl_version }}\""
            echo ""
            echo "# ç¦ç”¨æ‰€æœ‰å…¶ä»–ç›®æ ‡"
            echo "CONFIG_TARGET_ath79=n"
            echo "CONFIG_TARGET_ath79_generic=n"
            echo "CONFIG_TARGET_bcm27xx=n"
            echo "CONFIG_TARGET_bcm53xx=n"
            echo "CONFIG_TARGET_ipq806x=n"
            echo "CONFIG_TARGET_lantiq=n"
            echo "CONFIG_TARGET_layerscape=n"
            echo "CONFIG_TARGET_mediatek=n"
            echo "CONFIG_TARGET_mpc85xx=n"
            echo "CONFIG_TARGET_mvebu=n"
            echo "CONFIG_TARGET_octeon=n"
            echo "CONFIG_TARGET_ramips=n"
            echo "CONFIG_TARGET_rockchip=n"
            echo "CONFIG_TARGET_sunxi=n"
            echo "CONFIG_TARGET_x86=n"
            echo ""
            echo "# åŸºç¡€é…ç½®"
            echo "CONFIG_ALL=n"
            echo "CONFIG_ALL_KMODS=n"
            echo "CONFIG_ALL_NONSHARED=n"
            echo "CONFIG_DEVEL=y"
            echo "CONFIG_SDK=y"
            echo "CONFIG_BUILD_LOG=y"
            echo ""
            echo "# ç¡®è®¤æˆ‘ä»¬çš„ç›®æ ‡"
            echo "CONFIG_TARGET_${{ env.TARGET }}=y"
            echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y"
          } > .config
          
          echo "æ­¥éª¤3: åº”ç”¨é…ç½®..."
          yes "" | make defconfig
          
          echo "æ­¥éª¤4: éªŒè¯é…ç½®..."
          echo "å½“å‰é…ç½®å…³é”®é¡¹:"
          grep -E "CONFIG_TARGET_|CONFIG_GCC|CONFIG_BINUTILS|CONFIG_MUSL|CONFIG_LINUX" .config | grep -v "=n"
          
          echo "æ£€æŸ¥GCCç‰ˆæœ¬:"
          grep "CONFIG_GCC_VERSION" .config
          echo "æœŸæœ›: ${{ needs.setup.outputs.gcc_version }}"
          
          echo "æ£€æŸ¥ç›®æ ‡æ¶æ„:"
          grep "CONFIG_TARGET_ARCH" .config
          echo "æœŸæœ›: ${{ env.ARCH_NAME }}"
          
          echo "âœ… é…ç½®å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ› ï¸ åˆ†æ­¥æ„å»ºå·¥å…·é“¾
        if: env.SKIP_BUILD != 'true'
        timeout-minutes: 180
        run: |
          echo "=== åˆ†æ­¥æ„å»ºå·¥å…·é“¾ ==="
          cd "${{ env.BUILD_DIR }}"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          export FORCE_UNSAFE_CONFIGURE=1
          export MAKEFLAGS="-j$(nproc)"
          
          echo "ç³»ç»Ÿä¿¡æ¯:"
          echo "- CPUæ ¸å¿ƒ: $(nproc)"
          echo "- å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "- ç£ç›˜ç©ºé—´:"
          df -h .
          
          echo "æ­¥éª¤1: ä¸‹è½½æºç åŒ…..."
          echo "ä¸‹è½½ç›®å½•å†…å®¹:"
          ls -lh dl/ 2>/dev/null || echo "ä¸‹è½½ç›®å½•ä¸ºç©º"
          
          make download -j$(nproc) V=s 2>&1 | tail -50
          
          echo "æ­¥éª¤2: æ£€æŸ¥ä¸‹è½½çš„GCCç‰ˆæœ¬..."
          if [ -d "dl" ]; then
            echo "ä¸‹è½½çš„GCCåŒ…:"
            ls -lh dl/gcc-*.tar.* 2>/dev/null || echo "æœªæ‰¾åˆ°GCCåŒ…"
            echo "æœŸæœ›ç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          fi
          
          echo "æ­¥éª¤3: æ„å»ºå·¥å…·é“¾..."
          echo "å¼€å§‹æ„å»ºå·¥å…·é“¾ï¼Œè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´..."
          
          # åˆ†ç¦»æ„å»ºæ—¥å¿—
          {
            make toolchain/compile -j$(nproc) V=s 2>&1 | tee /tmp/compile.log
          } &
          COMPILE_PID=$!
          
          echo "ç¼–è¯‘è¿›ç¨‹PID: $COMPILE_PID"
          echo "ç­‰å¾…å®Œæˆï¼Œæ¯30ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦..."
          
          for i in {1..60}; do
            if kill -0 $COMPILE_PID 2>/dev/null; then
              echo "è¿›åº¦: ç¬¬ $i/60 åˆ†é’Ÿ ($(date))"
              tail -5 /tmp/compile.log 2>/dev/null | grep -E "Building|Compiling|Configuring|Installing" || echo "æ„å»ºä¸­..."
              sleep 30
            else
              break
            fi
          done
          
          if kill -0 $COMPILE_PID 2>/dev/null; then
            echo "âš ï¸ æ„å»ºè¶…æ—¶ï¼Œå¼ºåˆ¶ç»ˆæ­¢..."
            kill -9 $COMPILE_PID 2>/dev/null
            echo "æŸ¥çœ‹é”™è¯¯ä¿¡æ¯..."
            grep -E "Error:|error:|failed:" /tmp/compile.log | tail -20
          else
            wait $COMPILE_PID
            COMPILE_STATUS=$?
            if [ $COMPILE_STATUS -eq 0 ]; then
              echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            else
              echo "âš ï¸ ç¼–è¯‘æœ‰è­¦å‘Šï¼ŒçŠ¶æ€ç : $COMPILE_STATUS"
            fi
          fi
          
          echo "æ­¥éª¤4: å®‰è£…å·¥å…·é“¾..."
          make toolchain/install -j$(nproc) V=s 2>&1 | tail -50
          
          echo "âœ… å·¥å…·é“¾æ„å»ºå®Œæˆ"
          echo "æ€»æ„å»ºæ—¶é—´: $(date)"
          echo "æ„å»ºç›®å½•å¤§å°: $(du -sh . | cut -f1)"

      - name: ğŸ” æŸ¥æ‰¾æ„å»ºçš„å·¥å…·é“¾
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== æŸ¥æ‰¾æ„å»ºçš„å·¥å…·é“¾ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          
          echo "æŸ¥æ‰¾æ‰€æœ‰å·¥å…·é“¾ç›®å½•..."
          echo "staging_dir å†…å®¹:"
          ls -la staging_dir/ 2>/dev/null || echo "staging_dir ä¸å­˜åœ¨"
          
          echo "æŸ¥æ‰¾å·¥å…·é“¾ç›®å½•..."
          ALL_TOOLCHAINS=$(find staging_dir -type d -name "toolchain-*" 2>/dev/null)
          
          if [ -n "$ALL_TOOLCHAINS" ]; then
            echo "æ‰¾åˆ°çš„å·¥å…·é“¾ç›®å½•:"
            for dir in $ALL_TOOLCHAINS; do
              echo "- $dir"
              echo "  å¤§å°: $(du -sh $dir 2>/dev/null | cut -f1)"
              echo "  GCCç‰ˆæœ¬: $(grep -o "gcc-[0-9]\+\.[0-9]\+\.[0-9]\+" <<< "$dir" || echo "æœªçŸ¥")"
            done
            
            # é€‰æ‹©æœ€æ–°çš„æˆ–åˆé€‚çš„å·¥å…·é“¾
            TOOLCHAIN_DIR=$(echo "$ALL_TOOLCHAINS" | head -1)
            echo "é€‰æ‹©å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            echo "å°è¯•æŸ¥æ‰¾binç›®å½•..."
            BIN_DIRS=$(find staging_dir -type d -name "bin" 2>/dev/null)
            if [ -n "$BIN_DIRS" ]; then
              for dir in $BIN_DIRS; do
                echo "æ‰¾åˆ°binç›®å½•: $dir"
                PARENT_DIR=$(dirname "$dir")
                TOOLCHAIN_DIR="$PARENT_DIR"
                break
              done
            fi
          fi
          
          if [ -n "$TOOLCHAIN_DIR" ] && [ -d "$TOOLCHAIN_DIR" ]; then
            echo "âœ… ç¡®å®šä½¿ç”¨å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
            echo "ç›®å½•å†…å®¹é¢„è§ˆ:"
            ls -la "$TOOLCHAIN_DIR/" 2>/dev/null | head -10
            
            echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
            
            # æŸ¥æ‰¾ç¼–è¯‘å™¨
            if [ -d "$TOOLCHAIN_DIR/bin" ]; then
              echo "åœ¨binç›®å½•ä¸­æŸ¥æ‰¾ç¼–è¯‘å™¨..."
              COMPILER_FILE=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
              if [ -n "$COMPILER_FILE" ]; then
                echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $COMPILER_FILE"
                echo "ç¼–è¯‘å™¨ç‰ˆæœ¬:"
                "$COMPILER_FILE" --version 2>&1 | head -3 || echo "æ— æ³•è·å–ç‰ˆæœ¬"
                echo "COMPILER_FILE=$COMPILER_FILE" >> $GITHUB_ENV
              fi
            fi
            
            # è®¡ç®—å¤§å°
            TOOLCHAIN_SIZE=$(du -sh "$TOOLCHAIN_DIR" | cut -f1)
            echo "å·¥å…·é“¾å¤§å°: $TOOLCHAIN_SIZE"
            echo "TOOLCHAIN_SIZE=$TOOLCHAIN_SIZE" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„å·¥å…·é“¾ç›®å½•"
          fi
          
          echo "âœ… æŸ¥æ‰¾å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ’¾ å¤åˆ¶å·¥å…·é“¾åˆ°è¾“å‡ºç›®å½•
        if: env.SKIP_BUILD != 'true' && env.TOOLCHAIN_DIR != ''
        run: |
          echo "=== å¤åˆ¶å·¥å…·é“¾åˆ°è¾“å‡ºç›®å½• ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          echo "æºç›®å½•: ${{ env.TOOLCHAIN_DIR }}"
          echo "ç›®æ ‡ç›®å½•: ${{ env.OUTPUT_DIR }}"
          
          # æ¸…ç†å¹¶åˆ›å»ºç›®æ ‡ç›®å½•
          rm -rf "${{ env.OUTPUT_DIR }}" 2>/dev/null || true
          mkdir -p "${{ env.OUTPUT_DIR }}"
          
          echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
          # ä½¿ç”¨rsyncä¿æŒæƒé™å’Œé“¾æ¥
          if command -v rsync >/dev/null 2>&1; then
            rsync -av "${{ env.TOOLCHAIN_DIR }}"/ "${{ env.OUTPUT_DIR }}"/ 2>&1 | tail -20
          else
            cp -r "${{ env.TOOLCHAIN_DIR }}"/* "${{ env.OUTPUT_DIR }}"/ 2>&1 | tail -20
          fi
          
          echo "éªŒè¯å¤åˆ¶ç»“æœ..."
          if [ -d "${{ env.OUTPUT_DIR }}/bin" ]; then
            echo "âœ… binç›®å½•å¤åˆ¶æˆåŠŸ"
            echo "binç›®å½•å†…å®¹ï¼ˆå‰10ä¸ªï¼‰:"
            ls -la "${{ env.OUTPUT_DIR }}/bin/" | head -10
            
            # æ£€æŸ¥ç¼–è¯‘å™¨
            COMPILER_FILES=$(find "${{ env.OUTPUT_DIR }}/bin" -name "*gcc" -type f 2>/dev/null)
            if [ -n "$COMPILER_FILES" ]; then
              echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶:"
              for file in $COMPILER_FILES; do
                echo "- $(basename $file)"
              done
            else
              echo "âš ï¸ æœªæ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶"
            fi
          else
            echo "âŒ binç›®å½•æœªå¤åˆ¶æˆåŠŸ"
          fi
          
          echo "è®¡ç®—è¾“å‡ºç›®å½•å¤§å°..."
          TOTAL_SIZE=$(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1)
          FILE_COUNT=$(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)
          
          echo "ğŸ“Š å¤åˆ¶ç»“æœ:"
          echo "- æ€»å¤§å°: $TOTAL_SIZE"
          echo "- æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          
          echo "âœ… å¤åˆ¶å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ“ åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶
        if: env.SKIP_BUILD != 'true' && env.TOTAL_SIZE != ''
        run: |
          echo "=== åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # è·å–å®é™…ç¼–è¯‘å™¨ä¿¡æ¯
          ACTUAL_GCC_VERSION=""
          if [ -n "${{ env.COMPILER_FILE }}" ] && [ -x "${{ env.COMPILER_FILE }}" ]; then
            ACTUAL_GCC_VERSION=$("${{ env.COMPILER_FILE }}" --version 2>&1 | head -1 | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" || echo "")
          fi
          
          if [ -z "$ACTUAL_GCC_VERSION" ]; then
            ACTUAL_GCC_VERSION="${{ needs.setup.outputs.gcc_version }}"
          fi
          
          echo "å®é™…GCCç‰ˆæœ¬: $ACTUAL_GCC_VERSION"
          
          echo "åˆ›å»ºmetadata.json..."
          echo "{" > "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"architecture\": \"${{ matrix.arch }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"arch_name\": \"${{ env.ARCH_NAME }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"libc\": \"musl\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"libc_version\": \"${{ needs.setup.outputs.musl_version }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"target_gcc_version\": \"${{ needs.setup.outputs.gcc_version }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"actual_gcc_version\": \"$ACTUAL_GCC_VERSION\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"binutils_version\": \"${{ needs.setup.outputs.binutils_version }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"linux_version\": \"${{ needs.setup.outputs.linux_version }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"openwrt_version\": \"${{ needs.setup.outputs.openwrt_version }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"target\": \"${{ env.TARGET }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"subtarget\": \"${{ env.SUBTARGET }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"compiler_prefix\": \"${{ env.PREFIX }}-\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"cpu_type\": \"${{ env.CPU_TYPE }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"build_date\": \"$(date -Iseconds)\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"build_id\": \"${{ env.BUILD_ID }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"size\": \"${{ env.TOTAL_SIZE }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"file_count\": ${{ env.FILE_COUNT }}" >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "}" >> "${{ env.OUTPUT_DIR }}/metadata.json"
          
          echo "å…ƒæ•°æ®å†…å®¹:"
          cat "${{ env.OUTPUT_DIR }}/metadata.json"
          
          echo "âœ… å…ƒæ•°æ®åˆ›å»ºå®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: âœ… éªŒè¯è¾“å‡ºç¼–è¯‘å™¨
        if: env.SKIP_BUILD != 'true' && env.TOTAL_SIZE != ''
        run: |
          echo "=== éªŒè¯è¾“å‡ºç¼–è¯‘å™¨ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          OUTPUT_DIR="${{ env.OUTPUT_DIR }}"
          
          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "âŒ è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "è¾“å‡ºç›®å½•å¤§å°: $(du -sh "$OUTPUT_DIR" | cut -f1)"
          echo "æ–‡ä»¶æ•°é‡: $(find "$OUTPUT_DIR" -type f | wc -l)"
          
          echo "æ£€æŸ¥ç›®å½•ç»“æ„..."
          echo "ä¸»è¦ç›®å½•:"
          ls -la "$OUTPUT_DIR/"
          
          if [ -d "$OUTPUT_DIR/bin" ]; then
            echo "âœ… binç›®å½•å­˜åœ¨"
            echo "binç›®å½•æ–‡ä»¶æ•°: $(find "$OUTPUT_DIR/bin" -type f | wc -l)"
            echo "é‡è¦æ–‡ä»¶:"
            ls -la "$OUTPUT_DIR/bin/" | grep -E "gcc|g\+\+|ld|ar|as|strip"
            
            # æŸ¥æ‰¾ç¼–è¯‘å™¨
            COMPILER_PATH=""
            PREFIX="${{ env.PREFIX }}"
            
            # å°è¯•ç²¾ç¡®åŒ¹é…
            if [ -f "$OUTPUT_DIR/bin/${PREFIX}-gcc" ]; then
              COMPILER_PATH="$OUTPUT_DIR/bin/${PREFIX}-gcc"
            else
              # æ¨¡ç³ŠåŒ¹é…
              COMPILER_PATH=$(find "$OUTPUT_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
            fi
            
            if [ -n "$COMPILER_PATH" ] && [ -x "$COMPILER_PATH" ]; then
              echo "âœ… æ‰¾åˆ°å¯æ‰§è¡Œç¼–è¯‘å™¨: $COMPILER_PATH"
              echo "ç¼–è¯‘å™¨ä¿¡æ¯:"
              "$COMPILER_PATH" --version 2>&1 | head -3
              
              echo "ç›®æ ‡æ¶æ„:"
              "$COMPILER_PATH" -dumpmachine 2>&1 || echo "æ— æ³•è·å–ç›®æ ‡æ¶æ„"
              
              echo "ç¼–è¯‘æµ‹è¯•..."
              TEST_DIR="/tmp/compiler_test_${{ env.BUILD_ID }}"
              mkdir -p "$TEST_DIR"
              cd "$TEST_DIR"
              
              echo '#include <stdio.h>' > test.c
              echo 'int main() { printf("Compiler test passed!\\n"); return 0; }' >> test.c
              
              if "$COMPILER_PATH" test.c -o test_program 2>&1; then
                echo "âœ… ç¼–è¯‘æµ‹è¯•é€šè¿‡"
                echo "ç”Ÿæˆæ–‡ä»¶ä¿¡æ¯:"
                file test_program
                
                # å¦‚æœæ˜¯äº¤å‰ç¼–è¯‘å™¨ï¼Œå°è¯•è¿è¡Œï¼ˆå¯èƒ½å¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰
                if echo "$COMPILER_PATH" | grep -q "openwrt-linux"; then
                  echo "âš ï¸ è¿™æ˜¯äº¤å‰ç¼–è¯‘å™¨ï¼Œæ— æ³•åœ¨æœ¬åœ°è¿è¡Œ"
                else
                  echo "å°è¯•è¿è¡Œ..."
                  ./test_program 2>&1 || echo "è¿è¡Œå¤±è´¥ï¼ˆå¯¹äºäº¤å‰ç¼–è¯‘å™¨æ˜¯æ­£å¸¸çš„ï¼‰"
                fi
              else
                echo "âš ï¸ ç¼–è¯‘æµ‹è¯•å¤±è´¥"
              fi
              
              rm -rf "$TEST_DIR"
            else
              echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œç¼–è¯‘å™¨"
            fi
          else
            echo "âŒ binç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo "âœ… éªŒè¯å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ“Š æ„å»ºå®ŒæˆæŠ¥å‘Š
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "========================================"
          echo "          ğŸ‰ æ„å»ºå®ŒæˆæŠ¥å‘Š              "
          echo "========================================"
          
          if [ "${{ env.TOTAL_SIZE }}" ] && [ "${{ env.TOTAL_SIZE }}" != "0" ]; then
            if [ "${{ env.TOTAL_SIZE }}" != "8.0K" ]; then
              echo "âœ… äº¤å‰ç¼–è¯‘å™¨æ„å»ºæˆåŠŸ!"
              BUILD_STATUS="æˆåŠŸ"
            else
              echo "âš ï¸ äº¤å‰ç¼–è¯‘å™¨æ„å»ºå¯èƒ½æœ‰é—®é¢˜ï¼ˆæ–‡ä»¶è¿‡å°ï¼‰"
              BUILD_STATUS="å¯èƒ½æœ‰é—®é¢˜"
            fi
          else
            echo "âŒ äº¤å‰ç¼–è¯‘å™¨æ„å»ºå¤±è´¥"
            BUILD_STATUS="å¤±è´¥"
          fi
          
          echo ""
          echo "ğŸ“Š æ„å»ºä¿¡æ¯:"
          echo "- æ¶æ„: ${{ matrix.arch }} (${{ env.ARCH_NAME }})"
          echo "- Cåº“: musl ${{ needs.setup.outputs.musl_version }}"
          echo "- ç›®æ ‡GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "- Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "- OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "- ç¼–è¯‘å™¨å‰ç¼€: ${{ env.PREFIX }}-"
          echo "- ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "- CPUç±»å‹: ${{ env.CPU_TYPE }}"
          echo "- æ„å»ºçŠ¶æ€: $BUILD_STATUS"
          echo ""
          echo "ğŸ“¦ æˆæœç»Ÿè®¡:"
          echo "- æ€»å¤§å°: ${{ env.TOTAL_SIZE }}"
          echo "- æ–‡ä»¶æ•°é‡: ${{ env.FILE_COUNT }}"
          echo "- è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          echo "- å·¥å…·é“¾å¤§å°: ${{ env.TOOLCHAIN_SIZE }}"
          echo ""
          
          if [ "$BUILD_STATUS" = "æˆåŠŸ" ]; then
            echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
            echo "cd ${{ env.OUTPUT_DIR }}"
            echo 'export PATH="$PWD/bin:$PATH"'
            echo "${{ env.PREFIX }}-gcc --version"
          else
            echo "âš ï¸ æ³¨æ„: ç¼–è¯‘å™¨å¯èƒ½ä¸å®Œæ•´"
            echo "å»ºè®®æ£€æŸ¥æ„å»ºæ—¥å¿—"
          fi
          
          echo ""
          echo "â° æ„å»ºæ—¶é—´: $(date)"
          echo "========================================"

      - name: ğŸ“¤ æäº¤åˆ°Gitä»“åº“
        if: env.SKIP_BUILD != 'true' && env.TOTAL_SIZE != '' && env.TOTAL_SIZE != '8.0K'
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°Gitä»“åº“ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ github.workspace }}"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git config pull.rebase false
          
          echo "æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main --no-edit
          
          echo "æ·»åŠ ç¼–è¯‘å™¨æ–‡ä»¶..."
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          
          if ! git diff --cached --quiet; then
            echo "æ£€æµ‹åˆ°å˜æ›´ï¼Œåˆ›å»ºæäº¤..."
            
            git commit -m "build(compiler): æ·»åŠ  ${{ matrix.arch }} äº¤å‰ç¼–è¯‘å™¨" \
              -m "æ¶æ„: ${{ matrix.arch }} (${{ env.ARCH_NAME }})" \
              -m "GCC: ${{ needs.setup.outputs.gcc_version }}" \
              -m "Binutils: ${{ needs.setup.outputs.binutils_version }}" \
              -m "Musl: ${{ needs.setup.outputs.musl_version }}" \
              -m "å¤§å°: ${{ env.TOTAL_SIZE }}" \
              -m "æ–‡ä»¶æ•°: ${{ env.FILE_COUNT }}" \
              -m "ç›®æ ‡: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
            
            echo "æ¨é€åˆ°ä»“åº“..."
            git push origin main
            echo "âœ… ç¼–è¯‘å™¨å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
          else
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi
          
          echo "ç»“æŸæ—¶é—´: $(date)"

  summary:
    needs: build-matrix
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“Š æ„å»ºæ€»ç»“
        run: |
          echo "========================================"
          echo "           ğŸ¯ æ„å»ºä»»åŠ¡å®Œæˆ              "
          echo "========================================"
          echo "æ¶æ„ç±»å‹: ${{ github.event.inputs.arch_type }}"
          echo "GCCç‰ˆæœ¬: ${{ github.event.inputs.gcc_version }}"
          echo "å¼€å§‹æ—¶é—´: ${{ needs.setup.outputs.start_time }}"
          echo "å®Œæˆæ—¶é—´: $(date)"
          echo "========================================"
          echo "æ‰€æœ‰æ„å»ºä»»åŠ¡å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹è¯¦ç»†æŠ¥å‘Š"
          echo "========================================"
