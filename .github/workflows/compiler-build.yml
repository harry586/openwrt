# .github/workflows/compiler-matrix-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'ç›®æ ‡æ¶æ„ï¼ˆIPQ40xxé€‰æ‹©arm_cortex-a7ï¼‰'
        required: true
        default: 'arm_cortex-a7'
        type: choice
        options: ['aarch64', 'x86_64', 'mips', 'mipsel', 'arm_cortex-a7', 'arm_cortex-a53', 'riscv64']
      libc:
        description: 'Cåº“ç±»å‹ï¼ˆåµŒå…¥å¼æ¨èmuslï¼‰'
        required: true
        default: 'musl'
        type: choice
        options: ['musl', 'glibc']
      gcc_version:
        description: 'GCCç‰ˆæœ¬ï¼ˆOpenWrt 23.05æ”¯æŒ12.3.0ï¼Œè¾“å…¥autoè‡ªåŠ¨é€‰æ‹©ï¼‰'
        required: true
        default: 'auto'
        type: string
      clean_build:
        description: 'æ¸…ç†ä¹‹å‰çš„æ„å»ºç¼“å­˜'
        required: true
        default: false
        type: boolean
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºï¼ˆå³ä½¿å·²å­˜åœ¨ï¼‰'
        required: true
        default: false
        type: boolean

env:
  OPENWRT_VERSION: "23.05.2"
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers"

jobs:
  show-device-info:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“± æ˜¾ç¤ºæ¶æ„å¯¹åº”è®¾å¤‡
        run: |
          echo "================================================"
          echo "          ğŸ¯ ç›®æ ‡æ¶æ„è®¾å¤‡å¯¹åº”è¡¨                 "
          echo "================================================"
          echo ""
          echo "1ï¸âƒ£ aarch64 (ARM 64ä½)"
          echo "   â”œâ”€ ğŸ“± æ ‘è“æ´¾ç³»åˆ—"
          echo "   â”‚  â”œâ”€ æ ‘è“æ´¾ 4B (Raspberry Pi 4)"
          echo "   â”‚  â”œâ”€ æ ‘è“æ´¾ CM4 (Compute Module 4)"
          echo "   â”‚  â””â”€ æ ‘è“æ´¾ 400"
          echo "   â”œâ”€ ğŸ–¥ï¸ ç‘èŠ¯å¾®ç³»åˆ—"
          echo "   â”‚  â”œâ”€ RK3399 (ROCK Pi 4/NanoPi M4)"
          echo "   â”‚  â”œâ”€ RK3568 (FriendlyELEC NanoPi R5S)"
          echo "   â”‚  â””â”€ RK3588 (é«˜ç«¯å¼€å‘æ¿)"
          echo "   â”œâ”€ ğŸ“º ç”µè§†ç›’å­"
          echo "   â”‚  â”œâ”€ æ™¶æ™¨ S905 (X96 Max/Beelink GT King)"
          echo "   â”‚  â”œâ”€ æ™¶æ™¨ S912 (H96 Pro/Beelink GT1)"
          echo "   â”‚  â””â”€ æ™¶æ™¨ S922X (Odroid N2+)"
          echo "   â”œâ”€ ğŸ–¥ï¸ å…¶ä»–ARM64è®¾å¤‡"
          echo "      â”œâ”€ Orange Pi 5"
          echo "      â”œâ”€ Banana Pi BPI-M5"
          echo "      â””â”€ å„ç§ARMæœåŠ¡å™¨"
          echo ""
          echo "2ï¸âƒ£ x86_64 (x86 64ä½)"
          echo "   â”œâ”€ ğŸ’» ä¸ªäººç”µè„‘"
          echo "   â”‚  â”œâ”€ Intel Core i3/i5/i7/i9"
          echo "   â”‚  â”œâ”€ AMD Ryzen 3/5/7/9"
          echo "   â”‚  â””â”€ å„ç§x86ç¬”è®°æœ¬"
          echo "   â”œâ”€ ğŸ–¥ï¸ æœåŠ¡å™¨"
          echo "   â”‚  â”œâ”€ æˆ´å°”PowerEdge"
          echo "   â”‚  â”œâ”€ æƒ æ™®ProLiant"
          echo "   â”‚  â””â”€ è¶…å¾®æœåŠ¡å™¨"
          echo "   â””â”€ â˜ï¸ è™šæ‹Ÿæœº/å®¹å™¨"
          echo "      â”œâ”€ VMware/VirtualBoxè™šæ‹Ÿæœº"
          echo "      â”œâ”€ Dockerå®¹å™¨"
          echo "      â””â”€ äº‘æœåŠ¡å™¨å®ä¾‹"
          echo ""
          echo "3ï¸âƒ£ mips (MIPS 32ä½å¤§ç«¯)"
          echo "   â”œâ”€ ğŸ›œ åç¡•è·¯ç”±å™¨"
          echo "   â”‚  â”œâ”€ RT-ACRH17"
          echo "   â”‚  â”œâ”€ RT-AC85P"
          echo "   â”‚  â””â”€ RT-N56U"
          echo "   â”œâ”€ ğŸ›œ ç½‘ä»¶è·¯ç”±å™¨"
          echo "   â”‚  â”œâ”€ R7800"
          echo "   â”‚  â”œâ”€ R9000"
          echo "   â”‚  â””â”€ XR500"
          echo "   â””â”€ ğŸ›œ å…¶ä»–MIPSè®¾å¤‡"
          echo "      â”œâ”€ ä¸­å…´è·¯ç”±å™¨"
          echo "      â”œâ”€ åä¸ºæ—§æ¬¾è·¯ç”±å™¨"
          echo "      â””â”€ æ—©æœŸæ™ºèƒ½å®¶å±…è®¾å¤‡"
          echo ""
          echo "4ï¸âƒ£ mipsel (MIPS 32ä½å°ç«¯)"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7621"
          echo "   â”‚  â”œâ”€ æ–è®¯ K2P (Phicomm K2P)"
          echo "   â”‚  â”œâ”€ Newifi 3 (æ–°è·¯ç”±3)"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 3G"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AC2100"
          echo "   â”‚  â””â”€ æè·¯ç”± B70"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7620"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ Mini"
          echo "   â”‚  â”œâ”€ æè·¯ç”± 1S"
          echo "   â”‚  â”œâ”€ æ–è®¯ K1/K2"
          echo "   â”‚  â””â”€ è”æƒ³ Newifi Mini"
          echo "   â””â”€ ğŸ›œ å…¶ä»–MTKè®¾å¤‡"
          echo "      â”œâ”€ MT7628 (ä½ç«¯è·¯ç”±)"
          echo "      â”œâ”€ MT7688 (ç‰©è”ç½‘è®¾å¤‡)"
          echo "      â””â”€ å„ç§WiFiæ¨¡å—"
          echo ""
          echo "5ï¸âƒ£ arm_cortex-a7 (ARM Cortex-A7)"
          echo "   â”œâ”€ ğŸ›œ é«˜é€šIPQ40xxç³»åˆ— (ä½ çš„è®¾å¤‡ï¼)"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 4Aåƒå…†ç‰ˆ"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AC2100 (éƒ¨åˆ†ç‰ˆæœ¬)"
          echo "   â”‚  â”œâ”€ GL.iNet MT1300"
          echo "   â”‚  â”œâ”€ 360å®¶åº­é˜²ç«å¢™ 5Pro"
          echo "   â”‚  â”œâ”€ Linksys EA6350 v3"
          echo "   â”‚  â””â”€ Netgear R6900P"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7623/MT7629"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 3G (éƒ¨åˆ†ç‰ˆæœ¬)"
          echo "   â”‚  â”œâ”€ æ–è®¯ K3C"
          echo "   â”‚  â””â”€ éƒ¨åˆ†ä¼ä¸šè·¯ç”±å™¨"
          echo "   â”œâ”€ ğŸŠ å…¨å¿—H3/H2+ç³»åˆ—"
          echo "   â”‚  â”œâ”€ Orange Pi PC (é¦™æ©™æ´¾PC)"
          echo "   â”‚  â”œâ”€ Orange Pi Plus"
          echo "   â”‚  â”œâ”€ Banana Pi M2+"
          echo "   â”‚  â””â”€ NanoPi NEO"
          echo "   â””â”€ ğŸ”§ å…¶ä»–Cortex-A7è®¾å¤‡"
          echo "      â”œâ”€ æŸäº›æ™ºèƒ½æ‘„åƒå¤´"
          echo "      â”œâ”€ å·¥ä¸šæ§åˆ¶è®¾å¤‡"
          echo "      â””â”€ ä½åŠŸè€—åµŒå…¥å¼è®¾å¤‡"
          echo ""
          echo "6ï¸âƒ£ arm_cortex-a53 (ARM Cortex-A53)"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7622"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ AX3600"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AX6"
          echo "   â”‚  â””â”€ éƒ¨åˆ†WiFi6è·¯ç”±å™¨"
          echo "   â”œâ”€ ğŸ“± 64ä½è®¾å¤‡32ä½æ¨¡å¼"
          echo "   â”‚  â”œâ”€ æ ‘è“æ´¾ 3 (32ä½æ¨¡å¼)"
          echo "   â”‚  â”œâ”€ æŸäº›ç”µè§†ç›’å­"
          echo "   â”‚  â””â”€ ä½ç«¯å¹³æ¿ç”µè„‘"
          echo "   â””â”€ ğŸ”§ å…¶ä»–A53è®¾å¤‡"
          echo "      â”œâ”€ æŸäº›æ™ºèƒ½éŸ³ç®±"
          echo "      â”œâ”€ ç‰©è”ç½‘ç½‘å…³"
          echo "      â””â”€ è¾¹ç¼˜è®¡ç®—è®¾å¤‡"
          echo ""
          echo "7ï¸âƒ£ riscv64 (RISC-V 64ä½)"
          echo "   â”œâ”€ ğŸ”¬ å¼€å‘æ¿"
          echo "   â”‚  â”œâ”€ HiFive Unmatched"
          echo "   â”‚  â”œâ”€ VisionFive 2"
          echo "   â”‚  â”œâ”€ BeagleV"
          echo "   â”‚  â””â”€ SiFiveå¼€å‘æ¿"
          echo "   â”œâ”€ ğŸ–¥ï¸ æ–°å…´è®¾å¤‡"
          echo "   â”‚  â”œâ”€ æŸäº›AIåŠ é€Ÿå™¨"
          echo "   â”‚  â”œâ”€ å®šåˆ¶èŠ¯ç‰‡è®¾å¤‡"
          echo "   â”‚  â””â”€ å­¦æœ¯ç ”ç©¶è®¾å¤‡"
          echo "   â””â”€ ğŸš€ æœªæ¥è®¾å¤‡"
          echo "      â”œâ”€ RISC-Vç¬”è®°æœ¬ç”µè„‘"
          echo "      â”œâ”€ RISC-VæœåŠ¡å™¨"
          echo "      â””â”€ å„ç§åˆ›æ–°ç¡¬ä»¶"
          echo ""
          echo "================================================"
          echo "é€‰æ‹©å»ºè®®ï¼š"
          echo "1. è·¯ç”±å™¨è®¾å¤‡ â†’ æ ¹æ®èŠ¯ç‰‡å‹å·é€‰æ‹©"
          echo "2. å¼€å‘æ¿ â†’ æ ¹æ®CPUæ¶æ„é€‰æ‹©"
          echo "3. PC/æœåŠ¡å™¨ â†’ é€‰æ‹©x86_64"
          echo "4. ä¸ç¡®å®š â†’ æŸ¥çœ‹è®¾å¤‡è§„æ ¼ä¹¦æˆ–CPUä¿¡æ¯"
          echo "================================================"

  setup:
    runs-on: ubuntu-22.04
    outputs:
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      glibc_version: ${{ steps.version-detection.outputs.glibc_version }}
      need_build: ${{ steps.check-existing.outputs.need_build }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“ï¼ˆç”¨äºæ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            firmware-config/build-Compiler-file/compilers
          sparse-checkout-cone-mode: false

      - name: ğŸ—ï¸ åˆå§‹åŒ–
        run: |
          echo "=== äº¤å‰ç¼–è¯‘å™¨æ„å»ºç³»ç»Ÿ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          echo "åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "å½“å‰å·¥ä½œåŒºå†…å®¹:"
          ls -la "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers" 2>/dev/null || echo "ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨"

      - name: ğŸ” åŠ¨æ€æ£€æµ‹GCCç‰ˆæœ¬ï¼ˆä¿®å¤ç‰ˆï¼‰
        id: version-detection
        run: |
          echo "=== åŠ¨æ€æ£€æµ‹å·¥å…·é“¾ç‰ˆæœ¬ ==="
          USER_VERSION="${{ github.event.inputs.gcc_version }}"
          
          # OpenWrt 23.05æ”¯æŒçš„GCCç‰ˆæœ¬ï¼ˆæ ¹æ®å®é™…æ”¯æŒè°ƒæ•´ï¼‰
          OPENWRT_2305_SUPPORTED_GCC="12.3.0 12.2.0 11.3.0 11.2.0 10.4.0"
          
          if [ "$USER_VERSION" = "auto" ] || [ "$USER_VERSION" = "" ]; then
            echo "æ­£åœ¨ä¸ºOpenWrt 23.05é€‰æ‹©æ”¯æŒçš„GCCç‰ˆæœ¬..."
            # ä½¿ç”¨OpenWrt 23.05æ”¯æŒçš„ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯æœ€æ–°ç‰ˆæœ¬
            GCC_VERSION="12.3.0"
            echo "âœ… é€‰æ‹©OpenWrt 23.05æ”¯æŒçš„GCCç‰ˆæœ¬: $GCC_VERSION"
            echo "ğŸ’¡ æ”¯æŒçš„ç‰ˆæœ¬: $OPENWRT_2305_SUPPORTED_GCC"
          else
            GCC_VERSION="$USER_VERSION"
            echo "ä½¿ç”¨æŒ‡å®šGCCç‰ˆæœ¬: $GCC_VERSION"
            
            # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦åœ¨æ”¯æŒåˆ—è¡¨ä¸­
            if [[ ! " $OPENWRT_2305_SUPPORTED_GCC " =~ " $GCC_VERSION " ]]; then
              echo "âš ï¸ è­¦å‘Š: GCC $GCC_VERSION å¯èƒ½ä¸è¢«OpenWrt 23.05å®Œå…¨æ”¯æŒ"
              echo "ğŸ’¡ å»ºè®®ä½¿ç”¨: $OPENWRT_2305_SUPPORTED_GCC"
            fi
          fi
          
          # Binutilsç‰ˆæœ¬ä¹Ÿéœ€è¦å…¼å®¹
          echo "æ£€æµ‹Binutilsç‰ˆæœ¬..."
          BINUTILS_VERSION="2.40"  # OpenWrt 23.05ä½¿ç”¨2.40
          echo "âœ… ä½¿ç”¨Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          
          # å…¶ä»–ç‰ˆæœ¬
          LINUX_VERSION="5.15.133"
          MUSL_VERSION="1.2.4"
          GLIBC_VERSION="2.37"
          
          echo "æœ€ç»ˆç‰ˆæœ¬é…ç½®:"
          echo "- GCC: $GCC_VERSION (OpenWrt 23.05å…¼å®¹)"
          echo "- Binutils: $BINUTILS_VERSION"
          echo "- Linuxå†…æ ¸: $LINUX_VERSION"
          echo "- Musl: $MUSL_VERSION"
          echo "- Glibc: $GLIBC_VERSION"
          
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ï¼ˆä¿®å¤ç‰ˆï¼‰
        id: check-existing
        run: |
          echo "=== æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ï¼ˆä¿®å¤ç‰ˆï¼‰==="
          echo "========================================"
          echo "         ğŸ”§ ç¼–è¯‘å™¨å®Œæ•´æ€§æ£€æŸ¥            "
          echo "========================================"
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          GCC_VERSION='${{ steps.version-detection.outputs.gcc_version }}'
          
          if [ "$LIBC" = "musl" ]; then
            LIBC_DIR="musl"
          else
            LIBC_DIR="glibc"
          fi
          
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH}/${LIBC_DIR}/gcc-${GCC_VERSION}"
          echo "æ£€æŸ¥ç›®å½•: $OUTPUT_DIR"
          echo "å®Œæ•´è·¯å¾„: $(realpath "$OUTPUT_DIR" 2>/dev/null || echo "æ— æ³•è§£æè·¯å¾„")"
          echo ""
          
          # ä¿®å¤ï¼šä½¿ç”¨æ›´å¯é çš„æ£€æŸ¥æ–¹æ³•
          if [ -d "$OUTPUT_DIR" ]; then
            echo "âœ… ç¼–è¯‘å™¨ç›®å½•å­˜åœ¨"
            echo "ç›®å½•å†…å®¹:"
            ls -la "$OUTPUT_DIR/" 2>/dev/null || echo "æ— æ³•åˆ—å‡ºç›®å½•å†…å®¹"
            echo ""
            
            # æ£€æŸ¥å…³é”®ç›®å½•
            echo "ğŸ“ å¿…éœ€ç›®å½•æ£€æŸ¥:"
            REQUIRED_DIRS=("bin" "lib" "include")
            DIR_EXISTS=true
            for dir in "${REQUIRED_DIRS[@]}"; do
              if [ -d "$OUTPUT_DIR/$dir" ]; then
                echo "  âœ… ç›®å½• $dir"
              else
                echo "  âŒ ç›®å½• $dir: ç¼ºå¤±"
                DIR_EXISTS=false
              fi
            done
            
            if [ "$DIR_EXISTS" = "true" ]; then
              echo "âœ… å…³é”®ç›®å½•éƒ½å­˜åœ¨"
              NEED_BUILD="false"
            else
              echo "âš ï¸ å…³é”®ç›®å½•ç¼ºå¤±ï¼Œéœ€è¦æ„å»º"
              NEED_BUILD="true"
            fi
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º"
            NEED_BUILD="true"
          fi
          
          echo ""
          echo "æ„å»ºå†³ç­–: $NEED_BUILD"
          echo "========================================"
          echo "need_build=$NEED_BUILD" >> $GITHUB_OUTPUT

  build-compiler:
    needs: [show-device-info, setup]
    if: needs.setup.outputs.need_build == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ğŸš¨ ç”¨æˆ·è¾“å…¥å‚æ•°:"
          echo "  ç›®æ ‡æ¶æ„: ${{ github.event.inputs.target_arch }}"
          echo "  Cåº“ç±»å‹: ${{ github.event.inputs.libc }}"
          echo "  GCCç‰ˆæœ¬: ${{ github.event.inputs.gcc_version }}"
          echo "  æ¸…ç†æ„å»º: ${{ github.event.inputs.clean_build }}"
          echo "  å¼ºåˆ¶é‡å»º: ${{ github.event.inputs.force_rebuild }}"
          echo "ğŸš¨ æ£€æµ‹åˆ°çš„ç‰ˆæœ¬:"
          echo "  GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "  Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "  Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "  Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "  Glibcç‰ˆæœ¬: ${{ needs.setup.outputs.glibc_version }}"
          echo "ğŸš¨ æ„å»ºéœ€æ±‚:"
          echo "  æ˜¯å¦éœ€è¦æ„å»º: ${{ needs.setup.outputs.need_build }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "è¿è¡Œåºå·: ${{ github.run_number }}"

      - name: ğŸ—ï¸ è®¾ç½®ç¯å¢ƒï¼ˆä¿®å¤ç‰ˆï¼‰
        run: |
          echo "=== è®¾ç½®æ„å»ºç¯å¢ƒ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          echo "ğŸš¨ å¤„ç†æ¶æ„: $ARCH"
          echo "ğŸš¨ å¤„ç†Cåº“: $LIBC"
          
          # ä¿®å¤ï¼šæ ¹æ®æ¶æ„æ­£ç¡®è®¾ç½®ç›®æ ‡å¹³å°
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="armvirt"
              SUBTARGET="armv7"
              ARCH_NAME="arm"
              ARCH_DIR="arm_cortex-a7"
              PREFIX="arm-openwrt-linux"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              ABI="32"
              FLOAT_ABI="hard"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              ARCH_DIR="aarch64"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              ARCH_DIR="x86_64"
              PREFIX="x86_64-openwrt-linux"
              CPU_TYPE="x86-64"
              TUNE="generic"
              ABI="64"
              FLOAT_ABI=""
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              ARCH_DIR="mips"
              PREFIX="mips-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              ARCH_DIR="mipsel"
              PREFIX="mipsel-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            arm_cortex-a53)
              TARGET="rockchip"
              SUBTARGET="armv8"
              ARCH_NAME="aarch64"
              ARCH_DIR="arm_cortex-a53"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              ARCH_DIR="riscv64"
              PREFIX="riscv64-openwrt-linux"
              CPU_TYPE="generic"
              TUNE="generic"
              ABI="lp64d"
              FLOAT_ABI="hard"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
              exit 1
              ;;
          esac
          
          if [ "$LIBC" = "musl" ]; then
            PREFIX="${PREFIX}-musl"
            LIBC_SUFFIX="musl"
            LIBC_DIR="musl"
            USE_MUSL="y"
            USE_GLIBC="n"
          else
            PREFIX="${PREFIX}-gnu"
            LIBC_SUFFIX="glibc"
            LIBC_DIR="glibc"
            USE_MUSL="n"
            USE_GLIBC="y"
          fi
          
          GCC_VERSION='${{ needs.setup.outputs.gcc_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          LINUX_VERSION='${{ needs.setup.outputs.linux_version }}'
          BUILD_ID="${ARCH_DIR}_${LIBC_DIR}_gcc-${GCC_VERSION}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="/tmp/compiler-build-${BUILD_ID}"
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH_DIR}/${LIBC_DIR}/gcc-${GCC_VERSION}"
          
          echo "ğŸš¨ ç¯å¢ƒé…ç½®æ±‡æ€»:"
          echo "  æ„å»ºID: $BUILD_ID"
          echo "  æ„å»ºç›®å½•: $BUILD_DIR"
          echo "  è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          echo "  æ¶æ„åç§°: $ARCH_NAME"
          echo "  æ¶æ„ç›®å½•: $ARCH_DIR"
          echo "  Cåº“ç›®å½•: $LIBC_DIR"
          echo "  ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
          echo "  CPUç±»å‹: $CPU_TYPE"
          echo "  è°ƒä¼˜: $TUNE"
          echo "  ABI: $ABI"
          echo "  æµ®ç‚¹ABI: $FLOAT_ABI"
          echo "  GCCç‰ˆæœ¬: $GCC_VERSION (OpenWrt 23.05å…¼å®¹)"
          echo "  ä½¿ç”¨Musl: $USE_MUSL"
          echo "  ä½¿ç”¨Glibc: $USE_GLIBC"
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "ARCH_DIR=$ARCH_DIR" >> $GITHUB_ENV
          echo "LIBC_DIR=$LIBC_DIR" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "TUNE=$TUNE" >> $GITHUB_ENV
          echo "ABI=$ABI" >> $GITHUB_ENV
          echo "FLOAT_ABI=$FLOAT_ABI" >> $GITHUB_ENV
          echo "USE_MUSL=$USE_MUSL" >> $GITHUB_ENV
          echo "USE_GLIBC=$USE_GLIBC" >> $GITHUB_ENV
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV
          echo "LINUX_VERSION=$LINUX_VERSION" >> $GITHUB_ENV
          echo "LIBC_SUFFIX=$LIBC_SUFFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          echo "=== å®‰è£…æ„å»ºä¾èµ– ==="
          echo "ğŸš¨ å¼€å§‹å®‰è£…æ„å»ºå·¥å…·é“¾æ‰€éœ€ä¾èµ–..."
          sudo apt-get update -y
          echo "ğŸš¨ å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison libgmp-dev libmpfr-dev libmpc-dev libisl-dev python3 python3-dev python3-pip git wget curl zlib1g-dev liblzma-dev file gawk gettext libncurses5-dev libssl-dev python3-distutils rsync unzip ncurses-term autoconf automake libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev lzma-dev zstd libzstd-dev libelf-dev libdw-dev jq texlive texlive-latex-extra texlive-fonts-extra doxygen graphviz locales locales-all sudo apt-utils dialog man-db manpages manpages-dev
          
          echo "ğŸš¨ å®‰è£…ç»ˆç«¯æ”¯æŒåŒ…..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y ncurses-term ncurses-base ncurses-bin libncursesw5 libncursesw5-dev libtinfo5 libtinfo-dev terminfo
          
          echo "ğŸš¨ è®¾ç½®ç»ˆç«¯ç¯å¢ƒ..."
          export TERM=xterm-256color
          export TERMINFO=/usr/share/terminfo
          echo "export TERM=xterm-256color" >> ~/.bashrc
          echo "export TERMINFO=/usr/share/terminfo" >> ~/.bashrc
          
          echo "ğŸš¨ è®¾ç½®è¯­è¨€ç¯å¢ƒ..."
          sudo locale-gen en_US.UTF-8
          sudo update-locale LANG=en_US.UTF-8
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          export LANGUAGE=en_US:en
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          echo "å·²å®‰è£…åŒ…æ•°é‡: $(dpkg -l | wc -l)"
          echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h /

      - name: ğŸ—‘ï¸ æ¸…ç†æ„å»ºç¼“å­˜
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          echo "=== æ¸…ç†æ„å»ºç¼“å­˜ ==="
          echo "ğŸš¨ æ¸…ç†ä¹‹å‰çš„æ„å»ºç¼“å­˜..."
          sudo rm -rf /tmp/compiler-build-* 2>/dev/null || true
          echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          echo "ğŸš¨ å½“å‰ç›®å½•: $(pwd)"
          echo "ğŸš¨ å…‹éš†OpenWrt ${{ env.OPENWRT_VERSION }} åˆ†æ”¯..."
          
          # å°è¯•ä½¿ç”¨ git clone
          if git clone --depth 1 --branch v${{ env.OPENWRT_VERSION }} https://github.com/openwrt/openwrt.git . 2>&1 | tee /tmp/clone.log; then
            echo "âœ… Git clone æˆåŠŸ"
          else
            echo "âš ï¸ Git cloneå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨taråŒ…..."
            CLONE_ERROR=$(tail -20 /tmp/clone.log)
            echo "å…‹éš†é”™è¯¯: $CLONE_ERROR"
            
            wget -q -O openwrt.tar.xz https://github.com/openwrt/openwrt/archive/refs/tags/v${{ env.OPENWRT_VERSION }}.tar.gz
            if [ $? -eq 0 ]; then
              echo "âœ… ä¸‹è½½taråŒ…æˆåŠŸ"
              tar -xzf openwrt.tar.xz --strip-components=1
              rm -f openwrt.tar.xz
              echo "âœ… è§£å‹å®Œæˆ"
            else
              echo "âŒ ä¸‹è½½taråŒ…å¤±è´¥"
              exit 1
            fi
          fi
          
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"
          echo "æ–‡ä»¶æ•°é‡: $(find . -type f | wc -l)"
          echo "ç›®å½•ç»“æ„:"
          ls -la

      - name: ğŸ“ ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼ˆä¿®å¤éªŒè¯ç‰ˆï¼‰
        run: |
          echo "=== ç”ŸæˆOpenWrté…ç½®ï¼ˆä¿®å¤éªŒè¯ç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "ğŸš¨ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          
          # æ¸…ç©ºå¹¶é‡æ–°åˆ›å»ºé…ç½®
          > .config
          
          echo "ğŸš¨ å†™å…¥é…ç½®..."
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
          echo "CONFIG_TARGET_BOARD=\"${{ env.TARGET }}\"" >> .config
          echo "CONFIG_TARGET_SUBTARGET=\"${{ env.SUBTARGET }}\"" >> .config
          echo "CONFIG_TARGET_ARCH_PACKAGES=\"${{ env.ARCH_NAME }}\"" >> .config
          echo "CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"" >> .config
          echo "CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}-\"" >> .config
          
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "CONFIG_TOOLCHAINOPTS=y" >> .config
          echo "CONFIG_GCC_VERSION=\"${{ env.GCC_VERSION }}\"" >> .config
          echo "CONFIG_BINUTILS_VERSION=\"${{ env.BINUTILS_VERSION }}\"" >> .config
          echo "CONFIG_LINUX_VERSION=\"${{ env.LINUX_VERSION }}\"" >> .config
          echo "CONFIG_LIBC=\"${{ env.LIBC_SUFFIX }}\"" >> .config
          
          echo "CONFIG_ARCH_${{ env.ARCH_NAME }}=y" >> .config
          
          if [ "${{ env.ARCH_NAME }}" = "arm" ]; then
            echo "CONFIG_arm=y" >> .config
            echo "CONFIG_CPU_TYPE=\"${{ env.CPU_TYPE }}\"" >> .config
            echo "CONFIG_CPU_TUNE=\"${{ env.TUNE }}\"" >> .config
            if [ "${{ env.FLOAT_ABI }}" != "" ]; then
              echo "CONFIG_FPU=\"${{ env.FLOAT_ABI }}\"" >> .config
            fi
          fi
          
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_BUILD_PATENTED=y" >> .config
          echo "CONFIG_CCACHE=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          echo "CONFIG_BASE_FILES=y" >> .config
          echo "CONFIG_BUSYBOX_DEFAULT_FEATURE_EDITING=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config
          echo "CONFIG_EXTERNAL_TOOLCHAIN=n" >> .config
          echo "CONFIG_BUILD_TOOLS=y" >> .config
          echo "CONFIG_TOOLCHAIN_BUILD=y" >> .config
          
          echo "ğŸš¨ é…ç½®æ–‡ä»¶å†…å®¹:"
          echo "========================================"
          cat .config
          echo "========================================"
          CONFIG_LINES=$(wc -l < .config)
          echo "é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼Œå…± $CONFIG_LINES è¡Œ"
          
          echo "ğŸš¨ éªŒè¯é…ç½®å…³é”®è¯:"
          grep -n -E "TARGET_${{ env.TARGET }}|TARGET_ARCH|CPU_TYPE|PREFIX" .config
          
          echo "ğŸš¨ é…ç½®éªŒè¯æ£€æŸ¥:"
          # ä¿®å¤éªŒè¯é€»è¾‘ - æ­£ç¡®åŒ¹é…å¸¦å¼•å·çš„å€¼
          TARGET_CHECK=$(grep -c "^CONFIG_TARGET_${{ env.TARGET }}=y$" .config)
          SUBTARGET_CHECK=$(grep -c "^CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y$" .config)
          ARCH_CHECK=$(grep -c "^CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"$" .config)
          # ä¿®å¤PREFIX_CHECK - åŒ¹é…å¸¦å¼•å·å’Œç ´æŠ˜å·çš„å€¼
          PREFIX_CHECK=$(grep -c "^CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}-\"$" .config)
          
          echo "  - CONFIG_TARGET_${{ env.TARGET }}=y: $TARGET_CHECK"
          echo "  - CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y: $SUBTARGET_CHECK"
          echo "  - CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\": $ARCH_CHECK"
          echo "  - CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}-\": $PREFIX_CHECK"
          
          # æ˜¾ç¤ºå®é™…æ‰¾åˆ°çš„é…ç½®è¡Œ
          echo ""
          echo "ğŸš¨ å®é™…é…ç½®è¡Œ:"
          grep "^CONFIG_TARGET_PREFIX=" .config
          
          if [ $TARGET_CHECK -eq 0 ]; then
            echo "âŒ é”™è¯¯: CONFIG_TARGET_${{ env.TARGET }}=y æœªæ‰¾åˆ°"
            exit 1
          fi
          
          if [ $SUBTARGET_CHECK -eq 0 ]; then
            echo "âŒ é”™è¯¯: CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y æœªæ‰¾åˆ°"
            exit 1
          fi
          
          if [ $ARCH_CHECK -eq 0 ]; then
            echo "âŒ é”™è¯¯: CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\" æœªæ‰¾åˆ°"
            exit 1
          fi
          
          if [ $PREFIX_CHECK -eq 0 ]; then
            echo "âŒ é”™è¯¯: CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}-\" æœªæ‰¾åˆ°"
            echo "æœŸæœ›çš„PREFIX: ${{ env.PREFIX }}-"
            echo "å®é™…æ‰¾åˆ°çš„è¡Œ: $(grep '^CONFIG_TARGET_PREFIX=' .config || echo 'æœªæ‰¾åˆ°')"
            exit 1
          fi
          
          echo "âœ… é…ç½®éªŒè¯é€šè¿‡"

      - name: ğŸ”§ ä¿®å¤ç½‘ç»œå’Œç»ˆç«¯ç¯å¢ƒ
        run: |
          echo "=== ä¿®å¤ç½‘ç»œå’Œç»ˆç«¯ç¯å¢ƒ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "ğŸš¨ è®¾ç½®Gité…ç½®..."
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global core.compression 0
          git config --global core.looseCompression 0
          
          echo "ğŸš¨ è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡..."
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=dumb
          export DEBIAN_FRONTEND=noninteractive
          export GIT_SSL_NO_VERIFY=1
          export PYTHONHTTPSVERIFY=0
          export CURL_SSL_NO_VERIFY=1
          
          echo "ğŸš¨ åˆ›å»ºå¿…è¦çš„ç›®å½•..."
          mkdir -p include/site
          mkdir -p tmp
          mkdir -p dl
          
          echo "ğŸš¨ è®¾ç½®è¯­è¨€ç¯å¢ƒ..."
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          export LANGUAGE=en_US:en
          
          echo "âœ… ç½‘ç»œå’Œç»ˆç«¯ç¯å¢ƒä¿®å¤å®Œæˆ"

      - name: ğŸ” æ£€æŸ¥ç¯å¢ƒå˜é‡
        run: |
          echo "=== æ£€æŸ¥ç¯å¢ƒå˜é‡ ==="
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç¯å¢ƒå˜é‡:"
          echo "TARGET: ${{ env.TARGET }}"
          echo "SUBTARGET: ${{ env.SUBTARGET }}"
          echo "ARCH_NAME: ${{ env.ARCH_NAME }}"
          echo "PREFIX: ${{ env.PREFIX }}"
          echo ""
          echo "æ£€æŸ¥.configæ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
          ls -la .config 2>/dev/null || echo ".configä¸å­˜åœ¨"
          echo ""
          echo "å¦‚æœ.configå­˜åœ¨ï¼Œæ˜¾ç¤ºå‰20è¡Œ:"
          head -20 .config 2>/dev/null || echo "æ— æ³•è¯»å–.config"

      - name: ğŸ› ï¸ åº”ç”¨é…ç½®ï¼ˆå¼ºåˆ¶éªŒè¯ç‰ˆï¼‰
        run: |
          echo "=== åº”ç”¨é…ç½®ï¼ˆå¼ºåˆ¶éªŒè¯ç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "ğŸš¨ å½“å‰ç›®å½•: $(pwd)"
          
          # å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶
          if [ -f ".config" ]; then
            cp .config .config.original
            echo "âœ… å·²å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶"
          fi
          
          echo "ğŸš¨ è¿è¡Œ make defconfig..."
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=dumb
          export DEBIAN_FRONTEND=noninteractive
          
          make defconfig V=s 2>&1 | tee /tmp/defconfig.log
          DEFCONFIG_EXIT=$?
          
          echo "ğŸš¨ defconfig é€€å‡ºä»£ç : $DEFCONFIG_EXIT"
          echo "ğŸš¨ defconfig æ—¥å¿—æ‘˜è¦:"
          tail -50 /tmp/defconfig.log
          
          if [ ! -f ".config" ]; then
            echo "âŒ é”™è¯¯: .config æ–‡ä»¶æœªç”Ÿæˆ"
            echo "defconfig è¾“å‡º:"
            cat /tmp/defconfig.log
            exit 1
          fi
          
          CONFIG_LINES=$(wc -l < .config)
          echo "æœ€ç»ˆé…ç½®æ–‡ä»¶è¡Œæ•°: $CONFIG_LINES"
          
          echo "ğŸš¨ å…³é”®é…ç½®æ£€æŸ¥:"
          echo "=== .config å…³é”®å†…å®¹ ==="
          grep -E "CONFIG_TARGET_${{ env.TARGET }}|CONFIG_TARGET_ARCH|CONFIG_TARGET_PREFIX" .config || echo "æœªæ‰¾åˆ°ç›¸å…³é…ç½®"
          
          echo ""
          echo "ğŸš¨ ç›®æ ‡å¹³å°é…ç½®éªŒè¯:"
          TARGET_CHECK=$(grep -c "^CONFIG_TARGET_${{ env.TARGET }}=y$" .config)
          SUBTARGET_CHECK=$(grep -c "^CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y$" .config)
          ARCH_CHECK=$(grep -c "^CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"$" .config)
          PREFIX_CHECK=$(grep -c "^CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}\"$" .config)
          
          echo "  - CONFIG_TARGET_${{ env.TARGET }}=y: $TARGET_CHECK $(if [ $TARGET_CHECK -gt 0 ]; then echo "âœ…"; else echo "âŒ"; fi)"
          echo "  - CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y: $SUBTARGET_CHECK $(if [ $SUBTARGET_CHECK -gt 0 ]; then echo "âœ…"; else echo "âŒ"; fi)"
          echo "  - CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\": $ARCH_CHECK $(if [ $ARCH_CHECK -gt 0 ]; then echo "âœ…"; else echo "âŒ"; fi)"
          echo "  - CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}\": $PREFIX_CHECK $(if [ $PREFIX_CHECK -gt 0 ]; then echo "âœ…"; else echo "âŒ"; fi)"
          
          # æ˜¾ç¤ºå®é™…æ‰¾åˆ°çš„è¡Œ
          echo ""
          echo "ğŸš¨ å®é™…é…ç½®è¡Œ:"
          echo "CONFIG_TARGET_${{ env.TARGET }}=y å®é™…è¡Œ: $(grep "^CONFIG_TARGET_${{ env.TARGET }}=y$" .config || echo 'æœªæ‰¾åˆ°')"
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y å®é™…è¡Œ: $(grep "^CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y$" .config || echo 'æœªæ‰¾åˆ°')"
          echo "CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\" å®é™…è¡Œ: $(grep "^CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"$" .config || echo 'æœªæ‰¾åˆ°')"
          echo "CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}\" å®é™…è¡Œ: $(grep "^CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}\"$" .config || echo 'æœªæ‰¾åˆ°')"
          
          # å¼ºåˆ¶éªŒè¯ï¼Œå¤±è´¥åˆ™é€€å‡º
          if [ $TARGET_CHECK -eq 0 ]; then
            echo "âŒ è‡´å‘½é”™è¯¯: CONFIG_TARGET_${{ env.TARGET }}=y æœªæ‰¾åˆ°"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "é…ç½®æ–‡ä»¶å‰50è¡Œ:"
            head -50 .config
            exit 1
          fi
          
          if [ $SUBTARGET_CHECK -eq 0 ]; then
            echo "âŒ è‡´å‘½é”™è¯¯: CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y æœªæ‰¾åˆ°"
            exit 1
          fi
          
          if [ $ARCH_CHECK -eq 0 ]; then
            echo "âŒ è‡´å‘½é”™è¯¯: CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\" æœªæ‰¾åˆ°"
            exit 1
          fi
          
          if [ $PREFIX_CHECK -eq 0 ]; then
            echo "âŒ è‡´å‘½é”™è¯¯: CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}\" æœªæ‰¾åˆ°"
            echo "æœŸæœ›çš„PREFIX: ${{ env.PREFIX }}"
            echo "é…ç½®æ–‡ä»¶ä¸­çš„PREFIXç›¸å…³è¡Œ:"
            grep "CONFIG_TARGET_PREFIX" .config
            exit 1
          fi
          
          echo "âœ… é…ç½®éªŒè¯é€šè¿‡"

      - name: ğŸ”¨ ç¼–è¯‘å·¥å…·é“¾ï¼ˆå¢åŠ è°ƒè¯•ä¿¡æ¯ï¼‰
        timeout-minutes: 150
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å·¥å…·é“¾ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "ğŸš¨ è®¾ç½®æ„å»ºç¯å¢ƒ..."
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=dumb
          export DEBIAN_FRONTEND=noninteractive
          
          echo "ğŸš¨ ç³»ç»Ÿä¿¡æ¯:"
          echo "- CPUæ ¸å¿ƒ: $(nproc)"
          echo "- å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "- ç£ç›˜ç©ºé—´:"
          df -h /
          
          echo "ğŸš¨ å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          
          echo "ğŸš¨ é…ç½®æ–‡ä»¶çŠ¶æ€:"
          if [ -f ".config" ]; then
            echo "é…ç½®æ–‡ä»¶å­˜åœ¨ï¼Œå¤§å°: $(wc -l < .config) è¡Œ"
            echo "å…³é”®é…ç½®:"
            grep -E "TARGET|ARCH|CPU|LIBC|GCC" .config | head -20
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ğŸš¨ ç¬¬ä¸€æ­¥: ä¸‹è½½æ‰€æœ‰æºç åŒ…..."
          echo "åˆ›å»ºä¸‹è½½ç›®å½•..."
          mkdir -p dl
          
          # å…ˆä¸‹è½½æ‰€æœ‰ä¾èµ–
          echo "å¼€å§‹ä¸‹è½½æºç åŒ…..."
          make -j1 download V=s 2>&1 | tee /tmp/download.log | tail -100
          DOWNLOAD_STATUS=${PIPESTATUS[0]}
          
          if [ $DOWNLOAD_STATUS -eq 0 ]; then
            echo "âœ… æºç åŒ…ä¸‹è½½æˆåŠŸ"
          else
            echo "âš ï¸ æºç åŒ…ä¸‹è½½æœ‰è­¦å‘Šï¼Œæ£€æŸ¥æ—¥å¿—..."
            grep -E "Error|error|failed" /tmp/download.log | tail -20
            echo "ç»§ç»­æ„å»º..."
          fi
          
          echo "ğŸš¨ ä¸‹è½½ç›®å½•å†…å®¹:"
          ls -la dl/ | head -20
          echo "ä¸‹è½½æ–‡ä»¶æ•°é‡: $(ls -1 dl/ 2>/dev/null | wc -l)"
          
          echo "ğŸš¨ ç¬¬äºŒæ­¥: ç¼–è¯‘å·¥å…·é“¾..."
          CPU_CORES=$(nproc)
          MAKE_JOBS=$CPU_CORES
          
          # å¦‚æœå†…å­˜å°äº4GBï¼Œå‡å°‘å¹¶è¡Œä»»åŠ¡
          TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
          if [ $TOTAL_MEM -lt 4096 ]; then
            MAKE_JOBS=$((CPU_CORES / 2))
            if [ $MAKE_JOBS -lt 1 ]; then
              MAKE_JOBS=1
            fi
            echo "âš ï¸ å†…å­˜è¾ƒä½(${TOTAL_MEM}MB)ï¼Œå‡å°‘å¹¶è¡Œä»»åŠ¡åˆ° $MAKE_JOBS"
          fi
          
          echo "ğŸš¨ ä½¿ç”¨ $MAKE_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡è¿›è¡Œç¼–è¯‘..."
          echo "ğŸš¨ å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
          
          # ç¼–è¯‘å·¥å…·é“¾ï¼Œå¢åŠ è¯¦ç»†è¾“å‡º
          echo "=== ç¼–è¯‘æ—¥å¿—å¼€å§‹ ==="
          make toolchain/compile -j$MAKE_JOBS V=s 2>&1 | tee /tmp/compile.log
          COMPILE_STATUS=${PIPESTATUS[0]}
          echo "=== ç¼–è¯‘æ—¥å¿—ç»“æŸ ==="
          
          if [ $COMPILE_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            echo "ğŸš¨ é”™è¯¯æ‘˜è¦:"
            grep -E "Error:|error:|failed:|configure: error|recipe for target" /tmp/compile.log | tail -50
            echo ""
            echo "ğŸš¨ æœ€å100è¡Œè¯¦ç»†é”™è¯¯æ—¥å¿—:"
            tail -100 /tmp/compile.log
            echo ""
            echo "ğŸš¨ å…³é”®ç›®å½•æ£€æŸ¥:"
            echo "staging_dir æ˜¯å¦å­˜åœ¨: $(ls -d staging_dir/toolchain-* 2>/dev/null | head -1 || echo 'ä¸å­˜åœ¨')"
            echo "build_dir æ˜¯å¦å­˜åœ¨: $(ls -d build_dir/target-* 2>/dev/null | head -1 || echo 'ä¸å­˜åœ¨')"
            exit 1
          fi
          
          echo "ğŸš¨ ç¬¬ä¸‰æ­¥: å®‰è£…å·¥å…·é“¾..."
          make toolchain/install -j$MAKE_JOBS V=s 2>&1 | tee /tmp/install.log
          INSTALL_STATUS=${PIPESTATUS[0]}
          
          if [ $INSTALL_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ å®‰è£…æœ‰è­¦å‘Š"
            grep -E "Warning:|warning:" /tmp/install.log | tail -20
          fi
          
          echo "âœ… å·¥å…·é“¾æ„å»ºå®Œæˆ"
          echo "æ„å»ºæ—¶é—´: $(date)"

      - name: âœ… éªŒè¯æ„å»ºç»“æœ
        run: |
          echo "=== éªŒè¯æ„å»ºç»“æœ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "ğŸš¨ æŸ¥æ‰¾å·¥å…·é“¾ç›®å½•..."
          TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            echo "staging_dirå†…å®¹:"
            ls -la staging_dir/ 2>/dev/null || echo "staging_dirç›®å½•ä¸å­˜åœ¨"
            echo "å¯èƒ½çš„ç›®å½•:"
            find . -type d -name "*toolchain*" 2>/dev/null | head -10
            exit 1
          fi
          
          echo "âœ… å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          echo "å·¥å…·é“¾ç›®å½•å†…å®¹:"
          ls -la "$TOOLCHAIN_DIR/"
          
          # æŸ¥æ‰¾ç¼–è¯‘å™¨
          echo "ğŸš¨ æŸ¥æ‰¾ç¼–è¯‘å™¨..."
          COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
          if [ -z "$COMPILER_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘å™¨"
            echo "binç›®å½•å†…å®¹:"
            ls -la "$TOOLCHAIN_DIR/bin/" 2>/dev/null || echo "binç›®å½•ä¸å­˜åœ¨"
            echo "æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶:"
            find "$TOOLCHAIN_DIR" -type f -executable 2>/dev/null | head -20
            exit 1
          fi
          
          echo "âœ… ç¼–è¯‘å™¨: $(basename "$COMPILER_PATH")"
          echo "ğŸš¨ ç¼–è¯‘å™¨ä¿¡æ¯:"
          "$COMPILER_PATH" --version 2>&1 | head -5
          
          echo "ğŸš¨ ç›®æ ‡ä¸‰å…ƒç»„:"
          "$COMPILER_PATH" -dumpmachine 2>&1
          
          echo "ğŸš¨ äº¤å‰ç¼–è¯‘æµ‹è¯•..."
          echo '#include <stdio.h>' > test.c
          echo 'int main() { printf("OpenWrtäº¤å‰ç¼–è¯‘å™¨æµ‹è¯•OK\\n"); return 0; }' >> test.c
          
          echo "ç¼–è¯‘æµ‹è¯•ç¨‹åº..."
          "$COMPILER_PATH" test.c -o test_program 2>&1
          if [ $? -eq 0 ] && [ -f "test_program" ]; then
            echo "âœ… ç¼–è¯‘æµ‹è¯•é€šè¿‡"
            echo "æ–‡ä»¶ç±»å‹:"
            file test_program
            echo "ç¨‹åºè¾“å‡º:"
            ./test_program 2>&1 || echo "æ— æ³•åœ¨å½“å‰æ¶æ„è¿è¡Œï¼ˆæ­£å¸¸ï¼‰"
            rm -f test.c test_program
          else
            echo "âŒ ç¼–è¯‘æµ‹è¯•å¤±è´¥"
            echo "ç¼–è¯‘é”™è¯¯:"
            "$COMPILER_PATH" test.c -o test_program 2>&1
            exit 1
          fi
          
          COMPILER_NAME=$(basename "$COMPILER_PATH")
          TOOL_PREFIX=$(echo "$COMPILER_NAME" | sed 's/gcc$//')
          
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV
          echo "TOOL_PREFIX=$TOOL_PREFIX" >> $GITHUB_ENV
          
          echo "âœ… éªŒè¯å®Œæˆ"

      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "ğŸš¨ å‡†å¤‡è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          mkdir -p "${{ env.OUTPUT_DIR }}"
          
          if [ -d "${{ env.OUTPUT_DIR }}" ] && [ "$(ls -A "${{ env.OUTPUT_DIR }}" 2>/dev/null)" ]; then
            echo "æ¸…ç†è¾“å‡ºç›®å½•..."
            rm -rf "${{ env.OUTPUT_DIR }}"/*
            echo "âœ… æ¸…ç†è¾“å‡ºç›®å½•å®Œæˆ"
          fi
          
          echo "ğŸš¨ å¤åˆ¶å·¥å…·é“¾..."
          if [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨: $TOOLCHAIN_DIR"
            exit 1
          fi
          
          echo "æºç›®å½•å¤§å°: $(du -sh "$TOOLCHAIN_DIR" | cut -f1)"
          echo "æºæ–‡ä»¶æ•°é‡: $(find "$TOOLCHAIN_DIR" -type f | wc -l)"
          
          echo "å¼€å§‹å¤åˆ¶..."
          rsync -av "$TOOLCHAIN_DIR"/ "${{ env.OUTPUT_DIR }}/" 2>&1 | tail -20
          
          if [ -d "${{ env.OUTPUT_DIR }}/bin" ]; then
            echo "âœ… å·¥å…·é“¾å¤åˆ¶æˆåŠŸ"
            file_count=$(find "${{ env.OUTPUT_DIR }}" -type f 2>/dev/null | wc -l)
            dir_count=$(find "${{ env.OUTPUT_DIR }}" -type d 2>/dev/null | wc -l)
            echo "ğŸ“Š å¤åˆ¶ç»Ÿè®¡:"
            echo "  - æ–‡ä»¶æ•°: $file_count"
            echo "  - ç›®å½•æ•°: $dir_count"
          else
            echo "âŒ å·¥å…·é“¾å¤åˆ¶å¤±è´¥ï¼Œbinç›®å½•ä¸å­˜åœ¨"
            ls -la "${{ env.OUTPUT_DIR }}/"
            exit 1
          fi
          
          echo "ğŸš¨ åˆ›å»ºå…ƒæ•°æ®..."
          echo '{' > "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "architecture": "'${{ env.ARCH_DIR }}'",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "libc": "'${{ env.LIBC_DIR }}'",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "target": "'${{ env.TARGET }}'",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "subtarget": "'${{ env.SUBTARGET }}'",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "compiler_prefix": "'${{ env.PREFIX }}'-",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "gcc_version": "'${{ env.GCC_VERSION }}'",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "binutils_version": "'${{ env.BINUTILS_VERSION }}'",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "linux_version": "'${{ env.LINUX_VERSION }}'",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "openwrt_version": "'${{ env.OPENWRT_VERSION }}'",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "build_date": "'$(date -Iseconds)'",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "workflow_run": "'${{ github.run_id }}'",' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '  "build_id": "'${{ env.BUILD_ID }}'"' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo '}' >> "${{ env.OUTPUT_DIR }}/metadata.json"
          
          TOTAL_SIZE=$(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1)
          FILE_COUNT=$(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)
          
          echo "âœ… ä¿å­˜å®Œæˆ:"
          echo "  - æ€»å¤§å°: $TOTAL_SIZE"
          echo "  - æ–‡ä»¶æ•°: $FILE_COUNT"
          echo "  - è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV

      - name: ğŸ“¤ æäº¤åˆ°Gitä»“åº“
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°Gitä»“åº“ ==="
          cd "${{ github.workspace }}"
          
          echo "ğŸš¨ é…ç½®Gitç”¨æˆ·..."
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          
          echo "ğŸš¨ æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main --no-edit || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­..."
          
          echo "ğŸš¨ æ·»åŠ æ–‡ä»¶..."
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          
          if ! git diff --cached --quiet; then
            echo "ğŸš¨ æäº¤å˜æ›´..."
            git commit -m "build(compiler): æ·»åŠ  ${{ env.ARCH_DIR }}-${{ env.LIBC_DIR }} äº¤å‰ç¼–è¯‘å™¨" \
              -m "ç‰ˆæœ¬: GCC ${{ env.GCC_VERSION }}" \
              -m "å¤§å°: ${{ env.TOTAL_SIZE }}" \
              -m "æ–‡ä»¶æ•°: ${{ env.FILE_COUNT }}" \
              -m "å·¥ä½œæµ: #${{ github.run_id }}"
            
            echo "ğŸš¨ æ¨é€å˜æ›´..."
            git push origin main
            echo "âœ… ç¼–è¯‘å™¨å·²æäº¤åˆ°ä»“åº“"
          else
            echo "â„¹ï¸ æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi

      - name: ğŸ“Š æ˜¾ç¤ºæœ€ç»ˆæˆæœ
        run: |
          echo "========================================"
          echo "          ğŸ‰ æ„å»ºå®ŒæˆæŠ¥å‘Š              "
          echo "========================================"
          echo "âœ… äº¤å‰ç¼–è¯‘å™¨æ„å»ºæˆåŠŸ!"
          echo ""
          echo "ğŸ“Š æ„å»ºä¿¡æ¯:"
          echo "  - æ¶æ„: ${{ env.ARCH_DIR }}"
          echo "  - Cåº“: ${{ env.LIBC_DIR }}"
          echo "  - GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "  - ç¼–è¯‘å™¨å‰ç¼€: ${{ env.PREFIX }}-"
          echo "  - ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "  - CPUç±»å‹: ${{ env.CPU_TYPE }}"
          echo "  - æµ®ç‚¹ABI: ${{ env.FLOAT_ABI }}"
          echo ""
          echo "ğŸ“¦ æˆæœç»Ÿè®¡:"
          echo "  - æ€»å¤§å°: ${{ env.TOTAL_SIZE }}"
          echo "  - æ–‡ä»¶æ•°é‡: ${{ env.FILE_COUNT }}"
          echo "  - è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          echo ""
          echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
          echo "cd ${{ env.OUTPUT_DIR }}"
          echo "export STAGING_DIR=\$(pwd)"
          echo 'export PATH="\$STAGING_DIR/bin:\$PATH"'
          echo "${{ env.PREFIX }}-gcc --version"
          echo ""
          echo "ğŸ’¾ å…ƒæ•°æ®ä½ç½®:"
          echo "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "========================================"
          echo "æ„å»ºå®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ“„ ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.BUILD_ID }}
          path: /tmp/*.log
          retention-days: 30

  skip-build:
    needs: setup
    if: needs.setup.outputs.need_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: â­ï¸ è·³è¿‡æ„å»º
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æ„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ä¸”å®Œæ•´ï¼Œè·³è¿‡æ„å»º"
          echo "ğŸ“‹ è·³è¿‡åŸå› :"
          echo "- ç¼–è¯‘å™¨ç›®å½•å·²å­˜åœ¨ä¸”å®Œæ•´"
          echo "- æœªå¯ç”¨å¼ºåˆ¶é‡æ–°æ„å»º"
          echo "ğŸ”§ ç°æœ‰ç¼–è¯‘å™¨ä¿¡æ¯:"
          echo "- æ¶æ„: ${{ github.event.inputs.target_arch }}"
          echo "- Cåº“: ${{ github.event.inputs.libc }}"
          echo "- GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "ğŸ’¡ å¦‚éœ€é‡æ–°æ„å»ºï¼Œè¯·å¯ç”¨'å¼ºåˆ¶é‡æ–°æ„å»º'é€‰é¡¹"
          echo "========================================"
