# .github/workflows/compiler-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»ºï¼ˆå¹¶è¡Œ+è¯¦ç»†æŠ¥å‘Šï¼‰

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '21.02.5'
        type: choice
        options: ['21.02.5','22.03.5','23.05.2']
      arch_type:
        description: 'æ¶æ„ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options: ['all','arm','mips','x86','riscv','aarch64']

env:
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"
  BUILD_BASE_DIR: "/mnt/compiler-build"

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      arch_list: ${{ steps.setup-arch.outputs.arch_list }}
      openwrt_version: ${{ steps.version-detection.outputs.openwrt_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      start_time: ${{ steps.get-time.outputs.start_time }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: â° è·å–å¼€å§‹æ—¶é—´
        id: get-time
        run: |
          echo "start_time=$(date)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ è®¾ç½®æ„å»ºç›®å½•æƒé™
        run: |
          echo "=== è®¾ç½®æ„å»ºç›®å½•æƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $USER:$USER /mnt/compiler-build 2>/dev/null || true
          ls -ld /mnt/compiler-build

      - name: ğŸ—ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          mkdir -p "${{ env.BUILD_BASE_DIR }}"
          echo "ç¼–è¯‘å™¨åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "æ„å»ºåŸºç¡€ç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„åˆ—è¡¨
        id: setup-arch
        run: |
          echo "=== è®¾ç½®ç›®æ ‡æ¶æ„åˆ—è¡¨ ==="
          ARCH_TYPE="${{ github.event.inputs.arch_type }}"
          case "$ARCH_TYPE" in
            'all')
              ARCH_LIST='["arm_cortex-a7","arm_cortex-a53","aarch64","x86_64","mips","mipsel","riscv64"]'
              echo "âœ… é€‰æ‹©æ‰€æœ‰æ¶æ„ç±»å‹"
              ;;
            'arm')
              ARCH_LIST='["arm_cortex-a7","arm_cortex-a53"]'
              echo "âœ… é€‰æ‹©ARMæ¶æ„"
              ;;
            'mips')
              ARCH_LIST='["mips","mipsel"]'
              echo "âœ… é€‰æ‹©MIPSæ¶æ„"
              ;;
            'x86')
              ARCH_LIST='["x86_64"]'
              echo "âœ… é€‰æ‹©x86æ¶æ„"
              ;;
            'riscv')
              ARCH_LIST='["riscv64"]'
              echo "âœ… é€‰æ‹©RISC-Væ¶æ„"
              ;;
            'aarch64')
              ARCH_LIST='["aarch64"]'
              echo "âœ… é€‰æ‹©AArch64æ¶æ„"
              ;;
            *)
              ARCH_LIST='["aarch64"]'
              echo "âš ï¸ æœªçŸ¥ç±»å‹ï¼Œé»˜è®¤é€‰æ‹©AArch64"
              ;;
          esac
          echo "ç›®æ ‡æ¶æ„åˆ—è¡¨: $ARCH_LIST"
          echo "arch_list=$ARCH_LIST" >> $GITHUB_OUTPUT

      - name: ğŸ” ç‰ˆæœ¬æ£€æµ‹
        id: version-detection
        run: |
          echo "=== ç‰ˆæœ¬æ£€æµ‹ ==="
          OPENWRT_VERSION="${{ github.event.inputs.openwrt_version }}"
          echo "ç”¨æˆ·é€‰æ‹©çš„OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          case "$OPENWRT_VERSION" in
            '21.02.5')
              BINUTILS_VERSION="2.36.1"
              LINUX_VERSION="5.4.188"
              MUSL_VERSION="1.2.2"
              echo "â„¹ï¸ OpenWrt 21.02.5"
              ;;
            '22.03.5')
              BINUTILS_VERSION="2.38"
              LINUX_VERSION="5.10.179"
              MUSL_VERSION="1.2.3"
              echo "âœ… OpenWrt 22.03.5"
              ;;
            '23.05.2')
              BINUTILS_VERSION="2.40"
              LINUX_VERSION="5.15.133"
              MUSL_VERSION="1.2.4"
              echo "âœ… OpenWrt 23.05.2"
              ;;
          esac
          echo "openwrt_version=$OPENWRT_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT

  build-matrix:
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJSON(needs.setup.outputs.arch_list) }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”§ è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™
        run: |
          echo "=== è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $(whoami):$(whoami) /mnt/compiler-build 2>/dev/null || true
          ls -ld /mnt/compiler-build

      - name: ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨
        run: |
          echo "=== æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ ==="
          ARCH="${{ matrix.arch }}"
          OPENWRT_VERSION='${{ needs.setup.outputs.openwrt_version }}'
          OUTPUT_BASE_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH}/musl/openwrt-${OPENWRT_VERSION}"
          echo "æ£€æŸ¥ç›®å½•: $OUTPUT_BASE_DIR"
          if [ -d "$OUTPUT_BASE_DIR" ]; then
            SUBDIRS=$(find "$OUTPUT_BASE_DIR" -maxdepth 1 -type d -name "gcc-*" 2>/dev/null | wc -l)
            if [ "$SUBDIRS" -gt 0 ]; then
              echo "âœ… å·²æœ‰æ­¤OpenWrtç‰ˆæœ¬çš„ç¼–è¯‘å™¨ï¼Œè·³è¿‡æ„å»º"
              echo "SKIP_BUILD=true" >> $GITHUB_ENV
              echo "JOB_STATUS=skipped" >> $GITHUB_ENV
            else
              echo "âš ï¸ æœ‰ç›®å½•ä½†æ— ç¼–è¯‘å™¨ï¼Œéœ€è¦æ„å»º"
              echo "SKIP_BUILD=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: â­ï¸ è·³è¿‡æ„å»º
        if: env.SKIP_BUILD == 'true'
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æ„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
          echo "- æ¶æ„: ${{ matrix.arch }}"
          echo "- OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "========================================"

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æ¶æ„: ${{ matrix.arch }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "Cåº“ç±»å‹: musl"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„ç¯å¢ƒ
        id: setup-env
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è®¾ç½®æ¶æ„ç¯å¢ƒ ==="
          ARCH="${{ matrix.arch }}"
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="ipq40xx"
              SUBTARGET="generic"
              ARCH_NAME="arm"
              PREFIX="arm-openwrt-linux-musl"
              CPU_TYPE="cortex-a7"
              TARGET_CPU="arm_cortex-a7"
              EXPECTED_COMPILER="arm-openwrt-linux-musl-gcc"
              ARCH_TYPE_TITLE="ARM Cortex-A7 (32ä½)"
              ;;
            arm_cortex-a53)
              TARGET="sunxi"
              SUBTARGET="cortexa53"
              ARCH_NAME="arm"
              PREFIX="arm-openwrt-linux-musl"
              CPU_TYPE="cortex-a53"
              TARGET_CPU="arm_cortex-a53"
              EXPECTED_COMPILER="arm-openwrt-linux-musl-gcc"
              ARCH_TYPE_TITLE="ARM Cortex-A53 (32ä½)"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              PREFIX="aarch64-openwrt-linux-musl"
              CPU_TYPE="cortex-a53"
              TARGET_CPU="aarch64_cortex-a53"
              EXPECTED_COMPILER="aarch64-openwrt-linux-musl-gcc"
              ARCH_TYPE_TITLE="AArch64 (64ä½)"
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              PREFIX="x86_64-openwrt-linux-musl"
              CPU_TYPE=""
              TARGET_CPU="x86_64"
              EXPECTED_COMPILER="x86_64-openwrt-linux-musl-gcc"
              ARCH_TYPE_TITLE="x86_64 (64ä½)"
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              PREFIX="mips-openwrt-linux-musl"
              CPU_TYPE="24kc"
              TARGET_CPU="mips_24kc"
              EXPECTED_COMPILER="mips-openwrt-linux-musl-gcc"
              ARCH_TYPE_TITLE="MIPS (å¤§ç«¯)"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              PREFIX="mipsel-openwrt-linux-musl"
              CPU_TYPE="24kc"
              TARGET_CPU="mipsel_24kc"
              EXPECTED_COMPILER="mipsel-openwrt-linux-musl-gcc"
              ARCH_TYPE_TITLE="MIPSel (å°ç«¯)"
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              PREFIX="riscv64-openwrt-linux-musl"
              CPU_TYPE=""
              TARGET_CPU="riscv64"
              EXPECTED_COMPILER="riscv64-openwrt-linux-musl-gcc"
              ARCH_TYPE_TITLE="RISC-V 64ä½"
              ;;
          esac
          BUILD_ID="${ARCH}_musl_openwrt-${{ needs.setup.outputs.openwrt_version }}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="${{ env.BUILD_BASE_DIR }}/${BUILD_ID}"
          echo "ğŸ“Š ç¯å¢ƒé…ç½®æ±‡æ€»:"
          echo "  æ„å»ºID: $BUILD_ID"
          echo "  æ„å»ºç›®å½•: $BUILD_DIR"
          echo "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          echo "  æ¶æ„åç§°: $ARCH_NAME"
          echo "  ç›®æ ‡CPU: $TARGET_CPU"
          echo "  ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "TARGET_CPU=$TARGET_CPU" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "EXPECTED_COMPILER=$EXPECTED_COMPILER" >> $GITHUB_ENV
          echo "ARCH_TYPE_TITLE=$ARCH_TYPE_TITLE" >> $GITHUB_ENV

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== å®‰è£…æ„å»ºä¾èµ– ==="
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison git wget curl file gawk gettext rsync unzip autoconf automake libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev libelf-dev libdw-dev libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev python3 python3-dev libncurses5-dev libssl-dev liblzma-dev zlib1g-dev

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          OPENWRT_VERSION="${{ needs.setup.outputs.openwrt_version }}"
          echo "å…‹éš†OpenWrt $OPENWRT_VERSION æºç ..."
          git clone --depth 1 --branch "v$OPENWRT_VERSION" https://github.com/openwrt/openwrt.git .
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"

      - name: âš™ï¸ é…ç½®å¹¶æ„å»ºSDK
        if: env.SKIP_BUILD != 'true'
        timeout-minutes: 240
        run: |
          echo "=== é…ç½®å¹¶æ„å»ºSDK ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "æ­¥éª¤1: æ›´æ–°feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo "æ­¥éª¤2: é…ç½®ç›®æ ‡å¹³å°..."
          rm -f .config
          
          case "${{ matrix.arch }}" in
            arm_cortex-a7)
              echo "CONFIG_TARGET_ipq40xx=y" > .config
              echo "CONFIG_TARGET_ipq40xx_generic=y" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv7-a -mtune=cortex-a7\"" >> .config
              ;;
            arm_cortex-a53)
              echo "CONFIG_TARGET_sunxi=y" > .config
              echo "CONFIG_TARGET_sunxi_cortexa53=y" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv8-a -mtune=cortex-a53\"" >> .config
              ;;
            aarch64)
              echo "CONFIG_TARGET_armvirt=y" > .config
              echo "CONFIG_TARGET_armvirt_64=y" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv8-a -mtune=cortex-a53\"" >> .config
              ;;
            x86_64)
              echo "CONFIG_TARGET_x86=y" > .config
              echo "CONFIG_TARGET_x86_64=y" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=x86-64 -mtune=generic\"" >> .config
              ;;
            mips|mipsel)
              echo "CONFIG_TARGET_ramips=y" > .config
              echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=24kc -mtune=24kc\"" >> .config
              ;;
            riscv64)
              echo "CONFIG_TARGET_virt=y" > .config
              echo "CONFIG_TARGET_virt_rv64=y" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=rv64gc -mtune=generic\"" >> .config
              ;;
          esac
          
          echo "CONFIG_SDK=y" >> .config
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "CONFIG_TOOLCHAINOPTS=y" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_LIBC=\"musl\"" >> .config
          echo "CONFIG_USE_MUSL=y" >> .config
          
          echo "æ­¥éª¤3: åº”ç”¨é…ç½®..."
          yes "" | make oldconfig 2>&1 | tail -30
          
          echo "æ­¥éª¤4: ä¸‹è½½æºç ..."
          make download -j$(nproc) 2>&1 | tee /tmp/download.log
          DOWNLOAD_STATUS=${PIPESTATUS[0]}
          if [ $DOWNLOAD_STATUS -eq 0 ]; then
            echo "âœ… æºç ä¸‹è½½æˆåŠŸ"
          else
            echo "âš ï¸ æºç ä¸‹è½½æœ‰é—®é¢˜ï¼Œä½†ç»§ç»­æ„å»º..."
          fi
          
          echo "æ­¥éª¤5: æ„å»ºå·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          make toolchain/clean 2>&1 | tail -20
          
          make toolchain/compile -j$(nproc) 2>&1 | tee /tmp/toolchain.log
          TOOLCHAIN_STATUS=${PIPESTATUS[0]}
          
          if [ $TOOLCHAIN_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            echo "å®‰è£…å·¥å…·é“¾..."
            make toolchain/install -j$(nproc) 2>&1 | tail -50
            echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
            echo "BUILD_ERROR=" >> $GITHUB_ENV
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
            ERROR_MSG=$(grep -E "Error:|error:|failed:" /tmp/toolchain.log | tail -3 | tr '\n' ' ')
            echo "BUILD_ERROR=$ERROR_MSG" >> $GITHUB_ENV
          fi
          
          echo "æ„å»ºå®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ” éªŒè¯æ„å»ºç»“æœ
        id: validate-build
        if: env.SKIP_BUILD != 'true' && env.BUILD_SUCCESS == 'true'
        run: |
          echo "=== éªŒè¯æ„å»ºç»“æœ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # æŸ¥æ‰¾å·¥å…·é“¾ç›®å½•
          TOOLCHAIN_DIR=$(find staging_dir -type d -name "*toolchain*" 2>/dev/null | head -1)
          
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
            echo "VALIDATION_ERROR=\"æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•\"" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          
          # æŸ¥æ‰¾ç¼–è¯‘å™¨
          COMPILER=$(find "$TOOLCHAIN_DIR" -name "*gcc" -type f -executable 2>/dev/null | head -1)
          
          if [ -z "$COMPILER" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ç¼–è¯‘å™¨"
            echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
            echo "VALIDATION_ERROR=\"æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨\"" >> $GITHUB_ENV
            exit 1
          fi
          
          COMPILER_NAME=$(basename "$COMPILER")
          echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $COMPILER_NAME"
          
          # è·å–ç¼–è¯‘å™¨è¯¦ç»†ä¿¡æ¯
          COMPILER_VERSION=$("$COMPILER" --version 2>&1 | head -1 | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1 || echo "unknown")
          COMPILER_TARGET=$("$COMPILER" -dumpmachine 2>/dev/null || echo "unknown")
          
          echo "ç¼–è¯‘å™¨ç‰ˆæœ¬: $COMPILER_VERSION"
          echo "ç¼–è¯‘å™¨ç›®æ ‡: $COMPILER_TARGET"
          
          # éªŒè¯ç¼–è¯‘å™¨åç§°
          if [[ ! "$COMPILER_NAME" =~ ^${{ env.EXPECTED_COMPILER }}$ ]]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å™¨åç§°ä¸ç¬¦åˆé¢„æœŸ"
            echo "é¢„æœŸ: ${{ env.EXPECTED_COMPILER }}"
            echo "å®é™…: $COMPILER_NAME"
            echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
            echo "VALIDATION_ERROR=\"ç¼–è¯‘å™¨åç§°é”™è¯¯: é¢„æœŸ ${{ env.EXPECTED_COMPILER }}, å®é™… $COMPILER_NAME\"" >> $GITHUB_ENV
            exit 1
          fi
          
          # æµ‹è¯•ç¼–è¯‘å™¨åŠŸèƒ½
          TEST_FILE="/tmp/test_$$.c"
          echo '#include <stdio.h>' > "$TEST_FILE"
          echo 'int main() { return 0; }' >> "$TEST_FILE"
          
          if "$COMPILER" "$TEST_FILE" -o "/tmp/test_$$.out" 2>/dev/null; then
            echo "âœ… ç¼–è¯‘å™¨åŠŸèƒ½æµ‹è¯•é€šè¿‡"
            rm -f "$TEST_FILE" "/tmp/test_$$.out"
          else
            echo "âŒ é”™è¯¯: ç¼–è¯‘å™¨åŠŸèƒ½æµ‹è¯•å¤±è´¥"
            echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
            echo "VALIDATION_ERROR=\"ç¼–è¯‘å™¨æ— æ³•ç¼–è¯‘æµ‹è¯•ç¨‹åº\"" >> $GITHUB_ENV
            rm -f "$TEST_FILE"
            exit 1
          fi
          
          echo "âœ… éªŒè¯é€šè¿‡"
          echo "VALIDATION_SUCCESS=true" >> $GITHUB_ENV
          echo "VALIDATION_ERROR=" >> $GITHUB_ENV
          echo "COMPILER_NAME=$COMPILER_NAME" >> $GITHUB_ENV
          echo "COMPILER_VERSION=$COMPILER_VERSION" >> $GITHUB_ENV
          echo "COMPILER_TARGET=$COMPILER_TARGET" >> $GITHUB_ENV

      - name: ğŸ’¾ ä¿å­˜æ„å»ºç»“æœ
        if: env.SKIP_BUILD != 'true' && env.BUILD_SUCCESS == 'true' && env.VALIDATION_SUCCESS == 'true'
        run: |
          echo "=== ä¿å­˜æ„å»ºç»“æœ ==="
          cd "${{ env.BUILD_DIR }}"
          
          CLEAN_GCC_VERSION=$(echo "${{ env.COMPILER_VERSION }}" | tr -d '\n\r' | xargs echo -n)
          if [ -z "$CLEAN_GCC_VERSION" ] || [ "$CLEAN_GCC_VERSION" = "unknown" ]; then
            CLEAN_GCC_VERSION="unknown"
          fi
          
          # ç”Ÿæˆç›®å½•å
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${{ matrix.arch }}/musl/openwrt-${{ needs.setup.outputs.openwrt_version }}/gcc-${CLEAN_GCC_VERSION}_binutils-${{ needs.setup.outputs.binutils_version }}"
          
          echo "å‡†å¤‡è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          rm -rf "$OUTPUT_DIR" 2>/dev/null || true
          mkdir -p "$OUTPUT_DIR"
          
          echo "å¤åˆ¶å·¥å…·é“¾..."
          cp -r "${{ env.TOOLCHAIN_DIR }}"/* "$OUTPUT_DIR"/ 2>&1 | tail -10
          
          # æ£€æŸ¥å¤§æ–‡ä»¶
          LARGE_FILES=$(find "$OUTPUT_DIR" -type f -size +90M 2>/dev/null | head -5 || true)
          if [ -n "$LARGE_FILES" ]; then
            echo "å‘ç°å¤§æ–‡ä»¶ï¼Œè¿›è¡Œå‹ç¼©..."
            for file in $LARGE_FILES; do
              echo "å‹ç¼©: $file"
              gzip -9 -c "$file" > "${file}.gz" && rm -f "$file" && echo "âœ… å‹ç¼©æˆåŠŸ" || echo "âš ï¸ å‹ç¼©å¤±è´¥"
            done
          fi
          
          # åˆ›å»ºå…ƒæ•°æ®
          echo '{' > "$OUTPUT_DIR/metadata.json"
          echo '  "architecture": "'${{ matrix.arch }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "arch_name": "'${{ env.ARCH_NAME }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "libc": "musl",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "libc_version": "'${{ needs.setup.outputs.musl_version }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "gcc_version": "'$CLEAN_GCC_VERSION'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "binutils_version": "'${{ needs.setup.outputs.binutils_version }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "linux_version": "'${{ needs.setup.outputs.linux_version }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "openwrt_version": "'${{ needs.setup.outputs.openwrt_version }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "target": "'${{ env.TARGET }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "subtarget": "'${{ env.SUBTARGET }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "compiler_prefix": "'${{ env.PREFIX }}'-",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "compiler_name": "'${{ env.COMPILER_NAME }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "compiler_target": "'${{ env.COMPILER_TARGET }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "build_date": "'$(date -Iseconds)'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "build_id": "'${{ env.BUILD_ID }}'",' >> "$OUTPUT_DIR/metadata.json"
          echo '  "note": "å¤§æ–‡ä»¶å·²ä½¿ç”¨gzipå‹ç¼©"' >> "$OUTPUT_DIR/metadata.json"
          echo '}' >> "$OUTPUT_DIR/metadata.json"
          
          TOTAL_SIZE=$(du -sh "$OUTPUT_DIR" 2>/dev/null | cut -f1 || echo "0K")
          FILE_COUNT=$(find "$OUTPUT_DIR" -type f 2>/dev/null | wc -l || echo 0)
          
          echo "âœ… æ„å»ºç»“æœå·²ä¿å­˜"
          echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "ç¼–è¯‘å™¨æ–‡ä»¶: ${{ env.COMPILER_NAME }}"
          echo "ç¼–è¯‘å™¨ç‰ˆæœ¬: $CLEAN_GCC_VERSION"
          echo "æ€»å¤§å°: $TOTAL_SIZE"
          echo "æ–‡ä»¶æ•°: $FILE_COUNT"
          
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
          echo "GCC_VERSION=$CLEAN_GCC_VERSION" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV

      - name: ğŸ“ è®°å½•jobè¯¦ç»†ç»“æœ
        if: always()
        run: |
          echo "=== è®°å½•jobè¯¦ç»†ç»“æœ ==="
          
          # å‡†å¤‡ç»“æœä¿¡æ¯
          ARCH_TITLE="${{ env.ARCH_TYPE_TITLE || matrix.arch }}"
          STATUS_ICON=""
          STATUS_TEXT=""
          DETAILS=""
          
          if [ "${{ env.SKIP_BUILD }}" = "true" ]; then
            STATUS_ICON="â­ï¸"
            STATUS_TEXT="å·²å­˜åœ¨ï¼Œè·³è¿‡"
            DETAILS="å·²å­˜åœ¨æ­¤OpenWrtç‰ˆæœ¬çš„ç¼–è¯‘å™¨"
          elif [ "${{ env.BUILD_SUCCESS }}" = "false" ]; then
            STATUS_ICON="âŒ"
            STATUS_TEXT="æ„å»ºå¤±è´¥"
            DETAILS="${{ env.BUILD_ERROR || 'æœªçŸ¥æ„å»ºé”™è¯¯' }}"
          elif [ "${{ env.VALIDATION_SUCCESS }}" = "true" ]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="æ„å»ºæˆåŠŸ"
            DETAILS="ç¼–è¯‘å™¨: ${{ env.COMPILER_NAME || 'unknown' }} v${{ env.GCC_VERSION || 'unknown' }}, å¤§å°: ${{ env.TOTAL_SIZE || 'unknown' }}, æ–‡ä»¶æ•°: ${{ env.FILE_COUNT || 'unknown' }}"
          elif [ "${{ env.VALIDATION_SUCCESS }}" = "false" ]; then
            STATUS_ICON="âŒ"
            STATUS_TEXT="éªŒè¯å¤±è´¥"
            DETAILS="${{ env.VALIDATION_ERROR || 'éªŒè¯é”™è¯¯' }}"
          else
            STATUS_ICON="âš ï¸"
            STATUS_TEXT="æœªçŸ¥çŠ¶æ€"
            DETAILS="æ— æ³•ç¡®å®šæ„å»ºçŠ¶æ€"
          fi
          
          echo "æ¶æ„æ ‡é¢˜: $ARCH_TITLE"
          echo "çŠ¶æ€å›¾æ ‡: $STATUS_ICON"
          echo "çŠ¶æ€æ–‡æœ¬: $STATUS_TEXT"
          echo "è¯¦ç»†ä¿¡æ¯: $DETAILS"
          
          # ä¿å­˜è¯¦ç»†ç»“æœåˆ°æ–‡ä»¶
          RESULT_DIR="${{ github.workspace }}/.job-results"
          mkdir -p "$RESULT_DIR"
          
          RESULT_FILE="$RESULT_DIR/${{ matrix.arch }}.json"
          echo '{' > "$RESULT_FILE"
          echo '  "architecture": "'${{ matrix.arch }}'",' >> "$RESULT_FILE"
          echo '  "arch_title": "'$ARCH_TITLE'",' >> "$RESULT_FILE"
          echo '  "status_icon": "'$STATUS_ICON'",' >> "$RESULT_FILE"
          echo '  "status_text": "'$STATUS_TEXT'",' >> "$RESULT_FILE"
          echo '  "details": "'$DETAILS'",' >> "$RESULT_FILE"
          echo '  "openwrt_version": "'${{ needs.setup.outputs.openwrt_version }}'",' >> "$RESULT_FILE"
          echo '  "gcc_version": "'${{ env.GCC_VERSION || 'unknown' }}'",' >> "$RESULT_FILE"
          echo '  "compiler_name": "'${{ env.COMPILER_NAME || 'unknown' }}'",' >> "$RESULT_FILE"
          echo '  "output_dir": "'${{ env.OUTPUT_DIR || 'none' }}'",' >> "$RESULT_FILE"
          echo '  "total_size": "'${{ env.TOTAL_SIZE || 'unknown' }}'",' >> "$RESULT_FILE"
          echo '  "file_count": "'${{ env.FILE_COUNT || 'unknown' }}'"' >> "$RESULT_FILE"
          echo '}' >> "$RESULT_FILE"
          
          echo "ç»“æœå·²ä¿å­˜åˆ°: $RESULT_FILE"

      - name: ğŸ“Š æ˜¾ç¤ºjobæœ€ç»ˆç»“æœ
        if: always()
        run: |
          echo "========================================"
          echo "           JOBæœ€ç»ˆç»“æœæŠ¥å‘Š              "
          echo "========================================"
          
          ARCH_TITLE="${{ env.ARCH_TYPE_TITLE || matrix.arch }}"
          
          if [ "${{ env.SKIP_BUILD }}" = "true" ]; then
            echo "â­ï¸ $ARCH_TITLE"
            echo "   ç»“æœ: å·²å­˜åœ¨ï¼Œè·³è¿‡"
          elif [ "${{ env.BUILD_SUCCESS }}" = "false" ]; then
            echo "âŒ $ARCH_TITLE"
            echo "   ç»“æœ: æ„å»ºå¤±è´¥"
            echo "   é”™è¯¯: ${{ env.BUILD_ERROR || 'æœªçŸ¥é”™è¯¯' }}"
          elif [ "${{ env.VALIDATION_SUCCESS }}" = "true" ]; then
            echo "âœ… $ARCH_TITLE"
            echo "   ç»“æœ: æ„å»ºæˆåŠŸ"
            echo "   ç¼–è¯‘å™¨: ${{ env.COMPILER_NAME || 'unknown' }} v${{ env.GCC_VERSION || 'unknown' }}"
            echo "   è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR || 'unknown' }}"
            echo "   å¤§å°: ${{ env.TOTAL_SIZE || 'unknown' }}, æ–‡ä»¶æ•°: ${{ env.FILE_COUNT || 'unknown' }}"
          elif [ "${{ env.VALIDATION_SUCCESS }}" = "false" ]; then
            echo "âŒ $ARCH_TITLE"
            echo "   ç»“æœ: éªŒè¯å¤±è´¥"
            echo "   é”™è¯¯: ${{ env.VALIDATION_ERROR || 'éªŒè¯é”™è¯¯' }}"
          else
            echo "âš ï¸ $ARCH_TITLE"
            echo "   ç»“æœ: æœªçŸ¥çŠ¶æ€"
          fi
          
          echo "========================================"

  # æ±‡æ€»æ‰€æœ‰jobç»“æœå¹¶æ™ºèƒ½æ¨é€
  aggregate-and-push:
    needs: 
      - setup
      - build-matrix
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç 
        run: |
          echo "=== æ‹‰å–æœ€æ–°ä»£ç  ==="
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git pull origin main --rebase --autostash || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­..."

      - name: ğŸ“Š ç”Ÿæˆè¯¦ç»†æ±‡æ€»æŠ¥å‘Š
        run: |
          echo "========================================"
          echo "           ğŸ“‹ è¯¦ç»†æ„å»ºç»“æœæ±‡æ€»          "
          echo "========================================"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "æ¶æ„ç±»å‹: ${{ github.event.inputs.arch_type }}"
          echo "å¼€å§‹æ—¶é—´: ${{ needs.setup.outputs.start_time }}"
          echo "æ±‡æ€»æ—¶é—´: $(date)"
          echo ""
          echo "ğŸ”§ ç‰ˆæœ¬ä¿¡æ¯:"
          echo "- Binutils: ${{ needs.setup.outputs.binutils_version }}"
          echo "- Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "- Musl: ${{ needs.setup.outputs.musl_version }}"
          echo ""
          echo "ğŸ“Š å„æ¶æ„æ„å»ºç»“æœè¯¦æƒ…:"
          echo ""
          
          RESULT_DIR="${{ github.workspace }}/.job-results"
          TOTAL_JOBS=0
          SUCCESS_COUNT=0
          SKIPPED_COUNT=0
          FAILED_COUNT=0
          VALIDATION_FAILED_COUNT=0
          
          if [ ! -d "$RESULT_DIR" ]; then
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°jobç»“æœç›®å½•"
            echo "NO_RESULTS=true" >> $GITHUB_ENV
            exit 0
          fi
          
          # æŒ‰çŠ¶æ€åˆ†ç»„æ˜¾ç¤º
          echo "âœ… æˆåŠŸæ„å»º:"
          for result_file in "$RESULT_DIR"/*.json; do
            if [ -f "$result_file" ]; then
              TOTAL_JOBS=$((TOTAL_JOBS + 1))
              
              ARCH=$(jq -r '.architecture' "$result_file")
              ARCH_TITLE=$(jq -r '.arch_title' "$result_file")
              STATUS_ICON=$(jq -r '.status_icon' "$result_file")
              STATUS_TEXT=$(jq -r '.status_text' "$result_file")
              DETAILS=$(jq -r '.details' "$result_file")
              GCC_VERSION=$(jq -r '.gcc_version' "$result_file")
              COMPILER_NAME=$(jq -r '.compiler_name' "$result_file")
              OUTPUT_DIR=$(jq -r '.output_dir' "$result_file")
              
              if [ "$STATUS_ICON" = "âœ…" ]; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                echo "  $STATUS_ICON $ARCH_TITLE"
                echo "     ç¼–è¯‘å™¨æ–‡ä»¶: $COMPILER_NAME"
                echo "     GCCç‰ˆæœ¬: $GCC_VERSION"
                echo "     è¾“å‡ºç›®å½•: $(basename "$OUTPUT_DIR")"
                echo "     è¯¦æƒ…: $DETAILS"
                echo ""
              fi
            fi
          done
          
          echo "â­ï¸ è·³è¿‡æ„å»º:"
          for result_file in "$RESULT_DIR"/*.json; do
            if [ -f "$result_file" ]; then
              ARCH_TITLE=$(jq -r '.arch_title' "$result_file")
              STATUS_ICON=$(jq -r '.status_icon' "$result_file")
              DETAILS=$(jq -r '.details' "$result_file")
              
              if [ "$STATUS_ICON" = "â­ï¸" ]; then
                SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                echo "  $STATUS_ICON $ARCH_TITLE"
                echo "     è¯¦æƒ…: $DETAILS"
                echo ""
              fi
            fi
          done
          
          echo "âŒ å¤±è´¥æ„å»º:"
          for result_file in "$RESULT_DIR"/*.json; do
            if [ -f "$result_file" ]; then
              ARCH_TITLE=$(jq -r '.arch_title' "$result_file")
              STATUS_ICON=$(jq -r '.status_icon' "$result_file")
              STATUS_TEXT=$(jq -r '.status_text' "$result_file")
              DETAILS=$(jq -r '.details' "$result_file")
              
              if [ "$STATUS_ICON" = "âŒ" ]; then
                if [ "$STATUS_TEXT" = "æ„å»ºå¤±è´¥" ]; then
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                else
                  VALIDATION_FAILED_COUNT=$((VALIDATION_FAILED_COUNT + 1))
                fi
                echo "  $STATUS_ICON $ARCH_TITLE - $STATUS_TEXT"
                echo "     é”™è¯¯: $DETAILS"
                echo ""
              fi
            fi
          done
          
          echo "========================================"
          echo "ğŸ“ˆ æ„å»ºç»Ÿè®¡æ‘˜è¦:"
          echo "- æ€»ä»»åŠ¡æ•°: $TOTAL_JOBS"
          echo "- âœ… æˆåŠŸæ„å»º: $SUCCESS_COUNT"
          echo "- â­ï¸ è·³è¿‡: $SKIPPED_COUNT"
          echo "- âŒ æ„å»ºå¤±è´¥: $FAILED_COUNT"
          echo "- âŒ éªŒè¯å¤±è´¥: $VALIDATION_FAILED_COUNT"
          echo ""
          
          TOTAL_FAILED=$((FAILED_COUNT + VALIDATION_FAILED_COUNT))
          if [ $TOTAL_FAILED -gt 0 ]; then
            echo "âš ï¸ æ³¨æ„: æœ‰ $TOTAL_FAILED ä¸ªæ¶æ„æ„å»ºå¤±è´¥"
          fi
          
          if [ $SUCCESS_COUNT -eq 0 ]; then
            echo "âŒ æœ¬æ¬¡æ„å»ºæ²¡æœ‰æˆåŠŸçš„ç»“æœ"
            echo "NO_SUCCESSFUL_BUILDS=true" >> $GITHUB_ENV
          else
            echo "âœ… æœ‰ $SUCCESS_COUNT ä¸ªæ¶æ„æ„å»ºæˆåŠŸ"
            echo "NO_SUCCESSFUL_BUILDS=false" >> $GITHUB_ENV
          fi
          
          # ä¿å­˜ç»Ÿè®¡ç»“æœ
          echo "TOTAL_JOBS=$TOTAL_JOBS" >> $GITHUB_ENV
          echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
          echo "SKIPPED_COUNT=$SKIPPED_COUNT" >> $GITHUB_ENV
          echo "FAILED_COUNT=$FAILED_COUNT" >> $GITHUB_ENV
          echo "VALIDATION_FAILED_COUNT=$VALIDATION_FAILED_COUNT" >> $GITHUB_ENV
          echo "TOTAL_FAILED=$TOTAL_FAILED" >> $GITHUB_ENV

      - name: ğŸ“¤ æ¨é€æˆåŠŸçš„æ„å»ºç»“æœ
        if: env.NO_SUCCESSFUL_BUILDS == 'false'
        run: |
          echo "=== æ¨é€æˆåŠŸçš„æ„å»ºç»“æœ ==="
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          
          if ! git diff --cached --quiet; then
            echo "æ£€æµ‹åˆ°æ–°æ–‡ä»¶ï¼Œå‡†å¤‡æäº¤..."
            
            # ç”Ÿæˆè¯¦ç»†çš„æäº¤ä¿¡æ¯
            COMMIT_TITLE="build(compiler): æ·»åŠ äº¤å‰ç¼–è¯‘å™¨"
            
            # æ”¶é›†æˆåŠŸæ„å»ºçš„è¯¦ç»†ä¿¡æ¯
            DETAILS="æˆåŠŸæ„å»ºçš„æ¶æ„:\n"
            RESULT_DIR="${{ github.workspace }}/.job-results"
            
            for result_file in "$RESULT_DIR"/*.json; do
              if [ -f "$result_file" ]; then
                ARCH_TITLE=$(jq -r '.arch_title' "$result_file")
                STATUS_ICON=$(jq -r '.status_icon' "$result_file")
                GCC_VERSION=$(jq -r '.gcc_version' "$result_file")
                COMPILER_NAME=$(jq -r '.compiler_name' "$result_file")
                
                if [ "$STATUS_ICON" = "âœ…" ]; then
                  DETAILS="${DETAILS}- $ARCH_TITLE: $COMPILER_NAME v$GCC_VERSION\n"
                fi
              fi
            done
            
            # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            STATS="æ„å»ºç»Ÿè®¡:\n"
            STATS="${STATS}- æˆåŠŸ: ${{ env.SUCCESS_COUNT }}\n"
            STATS="${STATS}- è·³è¿‡: ${{ env.SKIPPED_COUNT }}\n"
            STATS="${STATS}- å¤±è´¥: ${{ env.TOTAL_FAILED }}\n"
            
            # æäº¤
            git commit -m "$COMMIT_TITLE" \
                       -m "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}" \
                       -m "$DETAILS" \
                       -m "$STATS" \
                       -m "Binutils: ${{ needs.setup.outputs.binutils_version }}" \
                       -m "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}" \
                       -m "Musl: ${{ needs.setup.outputs.musl_version }}"
            
            # æ¨é€
            echo "æ¨é€æ„å»ºç»“æœåˆ°ä»“åº“..."
            git push origin main
            echo "âœ… æˆåŠŸæ¨é€ ${{ env.SUCCESS_COUNT }} ä¸ªæ¶æ„çš„æ„å»ºç»“æœ"
          else
            echo "âš ï¸ æ²¡æœ‰æ–°çš„æ„å»ºç»“æœéœ€è¦æäº¤"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "${{ github.workspace }}/.job-results" 2>/dev/null || true

      - name: ğŸ“ ç”Ÿæˆæœ€ç»ˆæ€»ç»“æŠ¥å‘Š
        if: always()
        run: |
          echo "========================================"
          echo "           ğŸ¯ æ„å»ºä»»åŠ¡æœ€ç»ˆæ€»ç»“          "
          echo "========================================"
          echo "ğŸ“… ä»»åŠ¡ä¿¡æ¯:"
          echo "- OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "- æ¶æ„ç±»å‹: ${{ github.event.inputs.arch_type }}"
          echo "- å¼€å§‹æ—¶é—´: ${{ needs.setup.outputs.start_time }}"
          echo "- ç»“æŸæ—¶é—´: $(date)"
          
          DURATION=$(( ($(date +%s) - $(date -d "${{ needs.setup.outputs.start_time }}" +%s)) / 60 ))
          echo "- æ„å»ºæ—¶é•¿: ${DURATION}åˆ†é’Ÿ"
          echo ""
          
          echo "ğŸ“Š æœ€ç»ˆç»Ÿè®¡ç»“æœ:"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚          æ„å»ºç»Ÿè®¡            â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          printf "â”‚ æ€»ä»»åŠ¡æ•°: %-16s â”‚\n" "${{ env.TOTAL_JOBS || 0 }}"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          printf "â”‚ âœ… æˆåŠŸ: %-17s â”‚\n" "${{ env.SUCCESS_COUNT || 0 }}"
          printf "â”‚ â­ï¸ è·³è¿‡: %-17s â”‚\n" "${{ env.SKIPPED_COUNT || 0 }}"
          printf "â”‚ âŒ å¤±è´¥: %-17s â”‚\n" "${{ env.TOTAL_FAILED || 0 }}"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          if [ "${{ env.NO_SUCCESSFUL_BUILDS }}" = "true" ]; then
            echo "âŒ æœ¬æ¬¡æ„å»ºç»“æœ:"
            echo "- æ²¡æœ‰æˆåŠŸçš„æ„å»ºç»“æœ"
            echo "- æ„å»ºç»“æœæœªæ¨é€åˆ°ä»“åº“"
            echo "- è¯·æ£€æŸ¥å¤±è´¥åŸå› å¹¶é‡æ–°æ„å»º"
          elif [ "${{ env.NO_SUCCESSFUL_BUILDS }}" = "false" ]; then
            echo "âœ… æœ¬æ¬¡æ„å»ºç»“æœ:"
            echo "- æˆåŠŸæ„å»º ${{ env.SUCCESS_COUNT || 0 }} ä¸ªæ¶æ„"
            echo "- æ„å»ºç»“æœå·²æ¨é€åˆ°ä»“åº“"
            echo "- å¤±è´¥çš„æ¶æ„: ${{ env.TOTAL_FAILED || 0 }} ä¸ª"
            
            if [ "${{ env.TOTAL_FAILED || 0 }}" -gt 0 ]; then
              echo "- å»ºè®®æ£€æŸ¥å¤±è´¥æ¶æ„å¹¶å•ç‹¬é‡æ–°æ„å»º"
            fi
          fi
          
          echo ""
          echo "ğŸ”§ æ„å»ºçš„ç¼–è¯‘å™¨ä¿¡æ¯:"
          echo "- Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "- Linuxå†…æ ¸ç‰ˆæœ¬: ${{ needs.setup.outputs.linux_version }}"
          echo "- Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "- Cåº“ç±»å‹: musl"
          
          echo "========================================"
