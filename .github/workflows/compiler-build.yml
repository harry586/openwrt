# .github/workflows/compiler-build.yml
name: ğŸ” ç¼–è¯‘å™¨æ„å»ºï¼ˆARM64ç‰ˆæœ¬ï¼‰

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

env:
  COMPILER_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compiled"

jobs:
  build-compiler:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # å¢åŠ åˆ°3å°æ—¶
    
    steps:
      # 1. æ£€å‡ºä»“åº“
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
      
      # 2. è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯å’Œæ„å»ºç›®å½•
      - name: ğŸ” è®¾ç½®ç‰ˆæœ¬å’Œç›®å½•
        run: |
          echo "=== ç¼–è¯‘å™¨ç‰ˆæœ¬é…ç½® ==="
          echo "GCC_VERSION=11.3.0" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=2.38" >> $GITHUB_ENV
          echo "LINUX_VERSION=5.15.133" >> $GITHUB_ENV
          echo "MUSL_VERSION=1.2.4" >> $GITHUB_ENV
          BUILD_TIMESTAMP=$(date +%s)
          BUILD_DIR="/mnt/compiler-build-${BUILD_TIMESTAMP}"
          echo "BUILD_DIR=${BUILD_DIR}" >> $GITHUB_ENV
          echo "ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯:"
          echo "â”œâ”€ GCC: 11.3.0"
          echo "â”œâ”€ Binutils: 2.38"
          echo "â”œâ”€ Linux Kernel: 5.15.133"
          echo "â””â”€ Musl: 1.2.4"
          echo "ğŸ“ æ„å»ºç›®å½•: ${BUILD_DIR}"
          echo "ğŸ¯ ç›®æ ‡æ¶æ„: ARM64 (aarch64)"
      
      # 3. æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºä¿¡æ¯
        run: |
          echo "=== æ„å»ºé…ç½®ä¿¡æ¯ ==="
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          echo "ç¼–è¯‘å™¨è¾“å‡º: ${{ env.COMPILER_DIR }}"
          echo ""
          echo "ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯:"
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "ç”¨æˆ·ID: $(id -u)"
          echo "ç»„ID: $(id -g)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "CPU: $(nproc) æ ¸å¿ƒ"
          echo "å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "/mnt ç£ç›˜ä¿¡æ¯:"
          df -h /mnt || echo "æ— æ³•è®¿é—® /mnt"
          echo ""
          echo "ğŸ“… å¼€å§‹æ—¶é—´: $(date)"
      
      # 4. å‡†å¤‡ç¯å¢ƒï¼ˆä¿®å¤ç½‘ç»œå’Œç»ˆç«¯é—®é¢˜ï¼‰
      - name: ğŸ—ï¸ å‡†å¤‡ç¯å¢ƒ
        run: |
          echo "=== å‡†å¤‡æ„å»ºç¯å¢ƒ ==="
          echo "[1/10] æ£€æŸ¥ /mnt çŠ¶æ€..."
          if [ ! -d "/mnt" ]; then
            echo "åˆ›å»º /mnt ç›®å½•..."
            sudo mkdir -p /mnt
            sudo chmod 755 /mnt
          fi
          echo "[2/10] åˆ›å»ºæ„å»ºç›®å½•..."
          echo "åˆ›å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          sudo mkdir -p "${{ env.BUILD_DIR }}"
          sudo chown -R $USER:$USER "${{ env.BUILD_DIR }}"
          sudo chmod 755 "${{ env.BUILD_DIR }}"
          echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"
          ls -ld "${{ env.BUILD_DIR }}"
          echo "[3/10] å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential gcc g++ make flex bison libgmp-dev libmpfr-dev libmpc-dev \
            libisl-dev python3 python3-dev git wget curl zlib1g-dev liblzma-dev \
            file gawk gettext libncurses5-dev libssl-dev python3-distutils \
            rsync unzip ncurses-term ncurses-base libncursesw5 libtinfo5 \
            terminfo gnutls-bin libgnutls28-dev 2>&1 | tee /tmp/deps-install.log
          echo "[4/10] ä¿®å¤ç½‘ç»œå’ŒGité…ç½®..."
          # ä¿®å¤Gitç½‘ç»œé—®é¢˜
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global core.compression 0
          git config --global core.looseCompression 0
          git config --global http.sslVerify false
          git config --global http.sslBackend "openssl"
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export GIT_SSL_NO_VERIFY=1
          export CURL_SSL_NO_VERIFY=1
          export PYTHONHTTPSVERIFY=0
          echo "GIT_SSL_NO_VERIFY=1" >> $GITHUB_ENV
          echo "CURL_SSL_NO_VERIFY=1" >> $GITHUB_ENV
          echo "PYTHONHTTPSVERIFY=0" >> $GITHUB_ENV
          echo "[5/10] ä¿®å¤ç»ˆç«¯ç¯å¢ƒ..."
          sudo apt-get install -y ncurses-term ncurses-base libncursesw5 libtinfo5 terminfo
          export TERM=xterm-256color
          export TERMINFO=/usr/share/terminfo
          # åˆ›å»ºterminfoé“¾æ¥
          sudo mkdir -p /usr/share/terminfo/x
          if [ -f "/lib/terminfo/x/xterm" ]; then
            sudo ln -sf /lib/terminfo/x/xterm /usr/share/terminfo/x/xterm-256color 2>/dev/null || true
          fi
          echo "TERM=$TERM" >> $GITHUB_ENV
          echo "TERMINFO=$TERMINFO" >> $GITHUB_ENV
          echo "[6/10] è®¾ç½®å®‰å…¨é…ç½®..."
          export FORCE_UNSAFE_CONFIGURE=1
          echo "FORCE_UNSAFE_CONFIGURE=1" >> $GITHUB_ENV
          echo "[7/10] éªŒè¯å·¥å…·..."
          echo "å…³é”®å·¥å…·æ£€æŸ¥:"
          for tool in gcc g++ make flex bison python3 git wget curl; do
            if command -v $tool >/dev/null; then
              echo "  âœ… $tool"
            else
              echo "  âŒ $tool: æœªæ‰¾åˆ°"
            fi
          done
          echo "[8/10] è®¾ç½®ä»£ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰..."
          # å°è¯•ä½¿ç”¨åŠ é€Ÿé•œåƒ
          echo "ä½¿ç”¨GitHubåŠ é€Ÿé•œåƒ..."
          echo "[9/10] æ¸…ç†å¯èƒ½çš„ç¼“å­˜..."
          sudo rm -rf /tmp/*openwrt* /tmp/*compiler* 2>/dev/null || true
          echo "[10/10] ç¯å¢ƒæ£€æŸ¥å®Œæˆ..."
          echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
      
      # 5. è·å–æºç å’Œé…ç½®ï¼ˆä¿®å¤æ¶æ„é—®é¢˜ï¼‰
      - name: ğŸ“¥ è·å–æºç 
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          if [ ! -d "${{ env.BUILD_DIR }}" ]; then
            echo "âŒ é”™è¯¯: æ„å»ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "[1/5] å…‹éš†OpenWrtæºç ï¼ˆä½¿ç”¨æµ…å…‹éš†é¿å…ç½‘ç»œé—®é¢˜ï¼‰..."
          git init
          git remote add origin https://github.com/openwrt/openwrt.git
          git fetch --depth 1 origin v23.05.2
          git checkout FETCH_HEAD
          echo "[2/5] ç®€åŒ–feedsé…ç½®..."
          # ç®€åŒ–feedsé…ç½®ï¼Œåªä¿ç•™å¿…è¦çš„
          echo "src-git packages https://github.com/openwrt/packages.git;v23.05.2" > feeds.conf.default
          echo "# æ³¨é‡Šæ‰å¯èƒ½å‡ºé—®é¢˜çš„feeds" >> feeds.conf.default
          echo "# src-git luci https://github.com/openwrt/luci.git;v23.05.2" >> feeds.conf.default
          echo "[3/5] åˆ›å»ºARM64æ¶æ„é…ç½®..."
          cat > .config << 'EOF'
# OpenWrt ARM64 äº¤å‰ç¼–è¯‘å™¨æ„å»ºé…ç½®
# ç”Ÿæˆæ—¶é—´: $(date)

# ç›®æ ‡å¹³å°: ARM64 (aarch64)
CONFIG_TARGET_armvirt=y
CONFIG_TARGET_armvirt_64=y
CONFIG_TARGET_armvirt_64_Default=y

# æ–‡ä»¶ç³»ç»Ÿ
CONFIG_TARGET_ROOTFS_INITRAMFS=y
CONFIG_TARGET_ROOTFS_SQUASHFS=n

# å·¥å…·é“¾é…ç½®
CONFIG_EXTERNAL_TOOLCHAIN=n
CONFIG_USE_MUSL=y
CONFIG_BUILD_TOOLCHAIN=y

# ç‰ˆæœ¬é…ç½®
CONFIG_GCC_VERSION="11.3.0"
CONFIG_BINUTILS_VERSION="2.38"
CONFIG_LINUX_VERSION="5.15.133"
CONFIG_MUSL_VERSION="1.2.4"

# ç®€åŒ–é…ç½®ï¼Œåªæ„å»ºå·¥å…·é“¾
CONFIG_ALL_NONSHARED=n
CONFIG_ALL_KMODS=n
CONFIG_ALL=n

# è·³è¿‡æŸäº›æ£€æŸ¥
CONFIG_DEVEL=y
CONFIG_CCACHE=n
CONFIG_SIGNED_PACKAGES=n

# ç¡®ä¿å·¥å…·é“¾æ„å»º
CONFIG_TOOLCHAIN=y
CONFIG_TOOLCHAIN_BUILD=y

# ç¦ç”¨æ‰€æœ‰åŒ…
CONFIG_PACKAGE_busybox=n
CONFIG_PACKAGE_dnsmasq=n
CONFIG_PACKAGE_firewall=n
CONFIG_PACKAGE_dropbear=n
CONFIG_PACKAGE_iptables=n
EOF
          echo "[4/5] é…ç½®éªŒè¯..."
          echo "é…ç½®æ‘˜è¦:"
          echo "ç›®æ ‡æ¶æ„: ARM64 (aarch64)"
          echo "Cåº“: musl"
          echo "GCCç‰ˆæœ¬: 11.3.0"
          echo "é…ç½®æ–‡ä»¶å¤§å°: $(wc -l < .config) è¡Œ"
          echo "[5/5] æ˜¾ç¤ºå…³é”®é…ç½®..."
          grep -E "CONFIG_TARGET|CONFIG_GCC|CONFIG_USE_MUSL" .config
          echo "âœ… æºç é…ç½®å®Œæˆ"
      
      # 6. ç¼–è¯‘å·¥å…·é“¾ï¼ˆç®€åŒ–æµç¨‹ï¼Œé¿å…feedsé—®é¢˜ï¼‰
      - name: ğŸ”¨ ç¼–è¯‘å·¥å…·é“¾
        timeout-minutes: 180
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å·¥å…·é“¾ ==="
          if [ ! -d "${{ env.BUILD_DIR }}" ]; then
            echo "âŒ é”™è¯¯: æ„å»ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          cd "${{ env.BUILD_DIR }}"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          export TERMINFO=/usr/share/terminfo
          
          echo "=== æ­¥éª¤1: è·³è¿‡feedsæ›´æ–° ==="
          echo "æ—¶é—´: $(date)"
          # åˆ›å»ºå‡çš„feedsç›®å½•é¿å…é”™è¯¯
          mkdir -p feeds/luci feeds/packages
          echo "âœ… è·³è¿‡feedsæ›´æ–°"
          
          echo "=== æ­¥éª¤2: åº”ç”¨é…ç½® ==="
          echo "æ—¶é—´: $(date)"
          make defconfig 2>&1 | tee /tmp/defconfig.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âš ï¸ defconfigæœ‰è­¦å‘Šï¼Œç»§ç»­..."
          fi
          
          # å¼ºåˆ¶è®¾ç½®ARM64æ¶æ„
          echo "CONFIG_TARGET_armvirt=y" >> .config
          echo "CONFIG_TARGET_armvirt_64=y" >> .config
          echo "CONFIG_TARGET_armvirt_64_Default=y" >> .config
          echo "CONFIG_ARCH=\"arm64\"" >> .config
          
          echo "=== æ­¥éª¤3: ä¸‹è½½æºç åŒ… ==="
          echo "æ—¶é—´: $(date)"
          mkdir -p dl
          
          # ç›´æ¥ä¸‹è½½å…³é”®åŒ…ï¼Œé¿å…ç½‘ç»œé—®é¢˜
          echo "ä¸‹è½½å…³é”®æºç åŒ…..."
          make -j1 download V=s 2>&1 | tee /tmp/download.log
          DOWNLOAD_STATUS=${PIPESTATUS[0]}
          
          if [ $DOWNLOAD_STATUS -ne 0 ]; then
            echo "âš ï¸ ä¸‹è½½æœ‰è­¦å‘Šï¼Œæ£€æŸ¥å…³é”®åŒ…..."
            # æ£€æŸ¥å…³é”®åŒ…æ˜¯å¦å­˜åœ¨
            if [ ! -f "dl/gcc-11.3.0.tar.xz" ]; then
              echo "æ‰‹åŠ¨ä¸‹è½½gcc..."
              wget --no-check-certificate -O dl/gcc-11.3.0.tar.xz https://ftp.gnu.org/gnu/gcc/gcc-11.3.0/gcc-11.3.0.tar.xz || true
            fi
            if [ ! -f "dl/binutils-2.38.tar.xz" ]; then
              echo "æ‰‹åŠ¨ä¸‹è½½binutils..."
              wget --no-check-certificate -O dl/binutils-2.38.tar.xz https://ftp.gnu.org/gnu/binutils/binutils-2.38.tar.xz || true
            fi
          fi
          
          echo "=== æ­¥éª¤4: æ„å»ºå·¥å…·é“¾ï¼ˆç®€åŒ–æ­¥éª¤ï¼‰ ==="
          echo "æ—¶é—´: $(date)"
          
          # ç›´æ¥ä½¿ç”¨ç®€åŒ–å‘½ä»¤æ„å»ºå·¥å…·é“¾
          echo "æ„å»ºå·¥å…·é“¾..."
          make toolchain/compile -j$(nproc) V=s 2>&1 | tee /tmp/toolchain-compile.log
          TOOLCHAIN_STATUS=${PIPESTATUS[0]}
          
          if [ $TOOLCHAIN_STATUS -ne 0 ]; then
            echo "âŒ å·¥å…·é“¾æ„å»ºå¤±è´¥"
            echo "é”™è¯¯æ‘˜è¦:"
            grep -E "Error|ERROR|Failed|undefined|No such file" /tmp/toolchain-compile.log | head -30
            echo "å°è¯•åˆ†æ­¥éª¤æ„å»º..."
            
            # åˆ†æ­¥éª¤æ„å»º
            echo "æ­¥éª¤4.1: æ„å»ºbinutils..."
            make toolchain/binutils/compile -j$(nproc) V=s 2>&1 | tee /tmp/binutils.log
            
            echo "æ­¥éª¤4.2: æ„å»ºgccåˆå§‹é˜¶æ®µ..."
            make toolchain/gcc/initial/compile -j$(nproc) V=s 2>&1 | tee /tmp/gcc-initial.log
            
            echo "æ­¥éª¤4.3: æ„å»ºmusl..."
            make toolchain/musl/compile -j$(nproc) V=s 2>&1 | tee /tmp/musl.log
            
            echo "æ­¥éª¤4.4: æ„å»ºå®Œæ•´gcc..."
            make toolchain/gcc/final/compile -j$(nproc) V=s 2>&1 | tee /tmp/gcc-final.log
          fi
          
          echo "=== æ­¥éª¤5: å®‰è£…å·¥å…·é“¾ ==="
          echo "æ—¶é—´: $(date)"
          make toolchain/install -j$(nproc) V=s 2>&1 | tee /tmp/install.log
          
          echo ""
          echo "ğŸ‰ å·¥å…·é“¾æ„å»ºå®Œæˆï¼"
          echo "å®Œæˆæ—¶é—´: $(date)"
          echo "æ„å»ºç›®å½•å¤§å°: $(du -sh . | cut -f1)"
      
      # 7. éªŒè¯ç»“æœï¼ˆä¿®å¤ARM64æ£€æŸ¥ï¼‰
      - name: âœ… éªŒè¯ç»“æœ
        run: |
          echo "=== éªŒè¯ç¼–è¯‘ç»“æœ ==="
          if [ ! -d "${{ env.BUILD_DIR }}" ]; then
            echo "âŒ é”™è¯¯: æ„å»ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          cd "${{ env.BUILD_DIR }}"
          echo "[1/6] æŸ¥æ‰¾å·¥å…·é“¾ç›®å½•..."
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | head -1)
          if [ -z "$TOOLCHAIN_DIR" ] || [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            echo "staging_dirå†…å®¹:"
            ls -la staging_dir/ 2>/dev/null || echo "staging_dirä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          echo "ç›®å½•å¤§å°: $(du -sh "$TOOLCHAIN_DIR" 2>/dev/null | cut -f1)"
          echo "[2/6] æ£€æŸ¥ç›®æ ‡æ¶æ„..."
          # æ£€æŸ¥ç›®å½•åç¡®å®šæ¶æ„
          if [[ "$TOOLCHAIN_DIR" == *"aarch64"* ]] || [[ "$TOOLCHAIN_DIR" == *"arm64"* ]]; then
            echo "âœ… æ£€æµ‹åˆ°ARM64æ¶æ„"
            TARGET_ARCH="aarch64"
          elif [[ "$TOOLCHAIN_DIR" == *"mips"* ]]; then
            echo "âš ï¸ æ£€æµ‹åˆ°MIPSæ¶æ„ï¼Œé…ç½®é”™è¯¯"
            TARGET_ARCH="mips"
            # å°è¯•æŸ¥æ‰¾ARM64ç¼–è¯‘å™¨
            echo "å°è¯•æŸ¥æ‰¾ARM64ç¼–è¯‘å™¨..."
          else
            echo "âš ï¸ æœªçŸ¥æ¶æ„: $TOOLCHAIN_DIR"
            TARGET_ARCH="unknown"
          fi
          echo "[3/6] æ£€æŸ¥ç¼–è¯‘å™¨..."
          echo "æŸ¥æ‰¾æ‰€æœ‰gccç¼–è¯‘å™¨..."
          find "$TOOLCHAIN_DIR/bin" -name "*gcc" -type f 2>/dev/null | while read f; do
            echo "  - $(basename "$f")"
          done
          
          # ä¼˜å…ˆæŸ¥æ‰¾ARM64ç¼–è¯‘å™¨
          GCC_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "*aarch64*gcc" -type f 2>/dev/null | head -1)
          if [ -z "$GCC_PATH" ]; then
            echo "æœªæ‰¾åˆ°aarch64-gccï¼ŒæŸ¥æ‰¾å…¶ä»–ARMç¼–è¯‘å™¨..."
            GCC_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "*arm*gcc" -type f 2>/dev/null | head -1)
          fi
          
          if [ -n "$GCC_PATH" ] && [ -x "$GCC_PATH" ]; then
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $(basename "$GCC_PATH")"
            echo "å®Œæ•´è·¯å¾„: $GCC_PATH"
            echo "ç‰ˆæœ¬ä¿¡æ¯:"
            $GCC_PATH --version 2>&1 | head -1
            # ç¡®å®šç›®æ ‡ä¸‰å…ƒç»„
            TARGET_TRIPLET=$($GCC_PATH -dumpmachine 2>/dev/null || basename "$GCC_PATH" | sed 's/-gcc//')
            echo "ç›®æ ‡ä¸‰å…ƒç»„: $TARGET_TRIPLET"
          else
            echo "âŒ æœªæ‰¾åˆ°å¯ç”¨çš„ç¼–è¯‘å™¨"
            echo "å°è¯•æŸ¥æ‰¾ç¬¬ä¸€ä¸ªgcc..."
            GCC_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
            if [ -n "$GCC_PATH" ] && [ -x "$GCC_PATH" ]; then
              echo "æ‰¾åˆ°å¤‡ç”¨ç¼–è¯‘å™¨: $(basename "$GCC_PATH")"
              $GCC_PATH --version 2>&1 | head -1
              TARGET_TRIPLET=$($GCC_PATH -dumpmachine 2>/dev/null || basename "$GCC_PATH" | sed 's/-gcc//')
              echo "ç›®æ ‡ä¸‰å…ƒç»„: $TARGET_TRIPLET"
            else
              echo "âŒ æ²¡æœ‰å¯ç”¨çš„ç¼–è¯‘å™¨"
              exit 1
            fi
          fi
          echo "[4/6] æ£€æŸ¥å…³é”®å·¥å…·..."
          TOOL_PREFIX=$(basename "$GCC_PATH" | sed 's/gcc$//')
          for tool in gcc g++ ld ar strip; do
            file="$TOOLCHAIN_DIR/bin/${TOOL_PREFIX}${tool}"
            if [ -x "$file" ]; then
              echo "  âœ… $tool: $(basename "$file")"
            else
              echo "  âš ï¸ $tool: æœªæ‰¾åˆ°æˆ–ä¸å¯æ‰§è¡Œ"
            fi
          done
          echo "[5/6] æµ‹è¯•äº¤å‰ç¼–è¯‘..."
          echo '#include <stdio.h>' > test-cross.c
          echo 'int main() {' >> test-cross.c
          echo '    printf("Cross-compiler test OK\\n");' >> test-cross.c
          echo '    return 0;' >> test-cross.c
          echo '}' >> test-cross.c
          if $GCC_PATH test-cross.c -o test-cross 2>/tmp/compile-test.log; then
            echo "âœ… äº¤å‰ç¼–è¯‘æµ‹è¯•é€šè¿‡"
            echo "ç”Ÿæˆæ–‡ä»¶ç±»å‹:"
            file test-cross 2>/dev/null || echo "æ— æ³•è¯†åˆ«æ–‡ä»¶"
            rm -f test-cross test-cross.c
          else
            echo "âš ï¸ äº¤å‰ç¼–è¯‘æµ‹è¯•å¤±è´¥"
            cat /tmp/compile-test.log
          fi
          echo "[6/6] ä¿å­˜æ¶æ„ä¿¡æ¯..."
          echo "TARGET_ARCH=$TARGET_ARCH" >> $GITHUB_ENV
          echo "TARGET_TRIPLET=$TARGET_TRIPLET" >> $GITHUB_ENV
          echo "GCC_PATH=$GCC_PATH" >> $GITHUB_ENV
          echo "âœ… éªŒè¯å®Œæˆ"
      
      # 8. ä¿å­˜åˆ°ä»“åº“
      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨åˆ°ä»“åº“ ==="
          if [ ! -d "${{ env.BUILD_DIR }}" ]; then
            echo "âŒ é”™è¯¯: æ„å»ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          cd "${{ env.BUILD_DIR }}"
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | head -1)
          if [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ é”™è¯¯: å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          echo "[1/6] å‡†å¤‡è¾“å‡ºç›®å½•..."
          mkdir -p "${{ env.COMPILER_DIR }}"
          if [ -d "${{ env.COMPILER_DIR }}" ]; then
            echo "æ¸…ç©ºè¾“å‡ºç›®å½•..."
            rm -rf "${{ env.COMPILER_DIR }}"/* 2>/dev/null || true
          fi
          echo "[2/6] å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
          echo "ä»: $TOOLCHAIN_DIR"
          echo "åˆ°: ${{ env.COMPILER_DIR }}"
          cp -r "$TOOLCHAIN_DIR"/* "${{ env.COMPILER_DIR }}/" 2>&1 | tail -20
          echo "[3/6] åˆ›å»ºæ„å»ºä¿¡æ¯..."
          cat > "${{ env.COMPILER_DIR }}/BUILD-INFO.txt" << EOF
========================================
OpenWrt äº¤å‰ç¼–è¯‘å™¨ - è‡ªåŠ¨æ„å»º
========================================

æ„å»ºæ—¶é—´: $(date)
å·¥ä½œæµ: ${{ github.workflow }}
è¿è¡ŒID: ${{ github.run_id }}
æäº¤: ${{ github.sha }}

=========== ç‰ˆæœ¬ä¿¡æ¯ ===========
GCC: ${{ env.GCC_VERSION }}
Binutils: ${{ env.BINUTILS_VERSION }}
Linuxå†…æ ¸: ${{ env.LINUX_VERSION }}
Musl: ${{ env.MUSL_VERSION }}
ç›®æ ‡æ¶æ„: ${{ env.TARGET_ARCH }}
ç›®æ ‡ä¸‰å…ƒç»„: ${{ env.TARGET_TRIPLET }}

=========== æ–‡ä»¶ç»Ÿè®¡ ===========
æ€»æ–‡ä»¶æ•°: $(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)
æ€»å¤§å°: $(du -sh "${{ env.COMPILER_DIR }}" 2>/dev/null | cut -f1)

=========== ä½¿ç”¨æ–¹æ³• ===========
åœ¨OpenWrtæ„å»ºç¯å¢ƒä¸­:
1. è®¾ç½®ç¯å¢ƒå˜é‡:
   export STAGING_DIR=/path/to/this/compiler
   make

2. æˆ–è€…åœ¨makeå‘½ä»¤ä¸­ç›´æ¥æŒ‡å®š:
   make STAGING_DIR=/path/to/this/compiler

=========== ä¸»è¦å·¥å…· ===========
EOF
          # æ·»åŠ ä¸»è¦å·¥å…·åˆ—è¡¨
          if [ -d "${{ env.COMPILER_DIR }}/bin" ]; then
            for tool in gcc g++ ld ar strip; do
              tool_path=$(find "${{ env.COMPILER_DIR }}/bin" -name "*$tool" -type f 2>/dev/null | head -1)
              if [ -n "$tool_path" ]; then
                echo "bin/$(basename "$tool_path")      # $tool" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
              fi
            done
          fi
          echo "" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "========================================" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "æ­¤æ–‡ä»¶ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "========================================" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "[4/6] åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶..."
          cat > "${{ env.COMPILER_DIR }}/VERSION" << EOF
COMPILER_VERSION=${{ env.GCC_VERSION }}
BUILD_DATE=$(date '+%Y-%m-%d')
TARGET_ARCH=${{ env.TARGET_ARCH }}
TARGET_TRIPLET=${{ env.TARGET_TRIPLET }}
LIBC=musl
EOF
          echo "[5/6] éªŒè¯å¤åˆ¶ç»“æœ..."
          echo "è¾“å‡ºç›®å½•: ${{ env.COMPILER_DIR }}"
          echo "å¤§å°: $(du -sh "${{ env.COMPILER_DIR }}" 2>/dev/null | cut -f1)"
          echo "æ–‡ä»¶æ•°: $(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)"
          echo "[6/6] æœ€ç»ˆæµ‹è¯•..."
          if [ -n "${{ env.GCC_PATH }}" ] && [ -f "${{ env.GCC_PATH }}" ]; then
            echo "âœ… ç¼–è¯‘å™¨æµ‹è¯•:"
            "${{ env.GCC_PATH }}" --version 2>&1 | head -1
          else
            echo "âš ï¸  è­¦å‘Š: ç¼–è¯‘å™¨è·¯å¾„æœªè®¾ç½®"
          fi
          echo "âœ… ä¿å­˜å®Œæˆ"
      
      # 9. æäº¤åˆ°ä»“åº“
      - name: ğŸ“¤ æäº¤æ›´æ–°
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°ä»“åº“ ==="
          cd "${{ github.workspace }}"
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          echo "[1/4] æ£€æŸ¥å˜æ›´..."
          if [ -d "${{ env.COMPILER_DIR }}" ] && [ "$(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)" -gt 10 ]; then
            echo "æ£€æµ‹åˆ°æ–°çš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œå‡†å¤‡æäº¤..."
            SIZE=$(du -sh "${{ env.COMPILER_DIR }}" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            FILE_COUNT=$(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)
            DATE_TAG=$(date +%Y%m%d)
            ARCH="${{ env.TARGET_ARCH }}"
            echo "[2/4] æ·»åŠ åˆ°Git..."
            git add -f "firmware-config/build-Compiler-file/compiled"
            echo "[3/4] æäº¤..."
            git commit -m "build(compiler): è‡ªåŠ¨æ„å»º${ARCH}äº¤å‰ç¼–è¯‘å™¨ v${{ env.GCC_VERSION }} [$DATE_TAG]
            
            ğŸ”§ ç‰ˆæœ¬ä¿¡æ¯:
            â€¢ GCC: ${{ env.GCC_VERSION }}
            â€¢ Binutils: ${{ env.BINUTILS_VERSION }}
            â€¢ Linuxå†…æ ¸: ${{ env.LINUX_VERSION }}
            â€¢ Musl: ${{ env.MUSL_VERSION }}
            â€¢ ç›®æ ‡: ${ARCH} (${{ env.TARGET_TRIPLET }})
            
            ğŸ“Š æ„å»ºè¯¦æƒ…:
            â€¢ å¤§å°: $SIZE
            â€¢ æ–‡ä»¶æ•°: $FILE_COUNT
            â€¢ æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
            â€¢ å·¥ä½œæµ: ${{ github.workflow }}
            â€¢ è¿è¡ŒID: #${{ github.run_id }}
            
            ğŸ¯ ç”¨é€”: OpenWrt/ImmortalWrtå›ºä»¶æ„å»º
            ğŸ“ ä½ç½®: firmware-config/build-Compiler-file/compiled/
            
            Signed-off-by: GitHub Actions <actions@github.com>"
            echo "[4/4] æ¨é€åˆ°ä»“åº“..."
            if git push; then
              echo "ğŸ‰ ${ARCH}ç¼–è¯‘å™¨å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
            else
              echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œä½†æäº¤å·²ä¿å­˜åœ¨æœ¬åœ°"
            fi
          else
            echo "âœ… æ²¡æœ‰è¶³å¤Ÿçš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œè·³è¿‡æäº¤"
          fi
      
      # 10. ä¸Šä¼ æ—¥å¿—
      - name: ğŸ“„ ä¸Šä¼ æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compiler-build-logs-$(date +%Y%m%d-%H%M%S)
          path: |
            /tmp/*.log
            /tmp/deps-install.log
            ${{ env.BUILD_DIR }}/.config
            ${{ env.BUILD_DIR }}/download.log
            ${{ env.BUILD_DIR }}/toolchain-compile.log
          retention-days: 7
