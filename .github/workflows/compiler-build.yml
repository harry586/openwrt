# .github/workflows/compiler-matrix-build.yml
name: 🔧 交叉编译器构建

on:
  workflow_dispatch:
    inputs:
      target_arch:
        description: '目标架构（IPQ40xx选择arm_cortex-a7）'
        required: true
        default: 'arm_cortex-a7'
        type: choice
        options: ['aarch64', 'x86_64', 'mips', 'mipsel', 'arm_cortex-a7', 'arm_cortex-a53', 'riscv64']
      libc:
        description: 'C库类型（嵌入式推荐musl）'
        required: true
        default: 'musl'
        type: choice
        options: ['musl', 'glibc']
      gcc_version:
        description: 'GCC版本（输入版本号如12.3.0，或auto自动检测）'
        required: true
        default: 'auto'
        type: string
      clean_build:
        description: '清理之前的构建缓存'
        required: true
        default: false
        type: boolean
      force_rebuild:
        description: '强制重新构建（即使已存在）'
        required: true
        default: false
        type: boolean

env:
  OPENWRT_VERSION: "23.05.2"
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers"

jobs:
  show-device-info:
    runs-on: ubuntu-latest
    steps:
      - name: 📱 显示架构对应设备
        run: |
          echo "================================================"
          echo "          🎯 目标架构设备对应表                 "
          echo "================================================"
          echo ""
          echo "1️⃣ aarch64 (ARM 64位)"
          echo "   ├─ 📱 树莓派系列"
          echo "   │  ├─ 树莓派 4B (Raspberry Pi 4)"
          echo "   │  ├─ 树莓派 CM4 (Compute Module 4)"
          echo "   │  └─ 树莓派 400"
          echo "   ├─ 🖥️ 瑞芯微系列"
          echo "   │  ├─ RK3399 (ROCK Pi 4/NanoPi M4)"
          echo "   │  ├─ RK3568 (FriendlyELEC NanoPi R5S)"
          echo "   │  └─ RK3588 (高端开发板)"
          echo "   ├─ 📺 电视盒子"
          echo "   │  ├─ 晶晨 S905 (X96 Max/Beelink GT King)"
          echo "   │  ├─ 晶晨 S912 (H96 Pro/Beelink GT1)"
          echo "   │  └─ 晶晨 S922X (Odroid N2+)"
          echo "   └─ 🖥️ 其他ARM64设备"
          echo "      ├─ Orange Pi 5"
          echo "      ├─ Banana Pi BPI-M5"
          echo "      └─ 各种ARM服务器"
          echo ""
          echo "2️⃣ x86_64 (x86 64位)"
          echo "   ├─ 💻 个人电脑"
          echo "   │  ├─ Intel Core i3/i5/i7/i9"
          echo "   │  ├─ AMD Ryzen 3/5/7/9"
          echo "   │  └─ 各种x86笔记本"
          echo "   ├─ 🖥️ 服务器"
          echo "   │  ├─ 戴尔PowerEdge"
          echo "   │  ├─ 惠普ProLiant"
          echo "   │  └─ 超微服务器"
          echo "   └─ ☁️ 虚拟机/容器"
          echo "      ├─ VMware/VirtualBox虚拟机"
          echo "      ├─ Docker容器"
          echo "      └─ 云服务器实例"
          echo ""
          echo "3️⃣ mips (MIPS 32位大端)"
          echo "   ├─ 🛜 华硕路由器"
          echo "   │  ├─ RT-ACRH17"
          echo "   │  ├─ RT-AC85P"
          echo "   │  └─ RT-N56U"
          echo "   ├─ 🛜 网件路由器"
          echo "   │  ├─ R7800"
          echo "   │  ├─ R9000"
          echo "   │  └─ XR500"
          echo "   └─ 🛜 其他MIPS设备"
          echo "      ├─ 中兴路由器"
          echo "      ├─ 华为旧款路由器"
          echo "      └─ 早期智能家居设备"
          echo ""
          echo "4️⃣ mipsel (MIPS 32位小端)"
          echo "   ├─ 🛜 联发科MT7621"
          echo "   │  ├─ 斐讯 K2P (Phicomm K2P)"
          echo "   │  ├─ Newifi 3 (新路由3)"
          echo "   │  ├─ 小米路由器 3G"
          echo "   │  ├─ 红米路由器 AC2100"
          echo "   │  └─ 极路由 B70"
          echo "   ├─ 🛜 联发科MT7620"
          echo "   │  ├─ 小米路由器 Mini"
          echo "   │  ├─ 极路由 1S"
          echo "   │  ├─ 斐讯 K1/K2"
          echo "   │  └─ 联想 Newifi Mini"
          echo "   └─ 🛜 其他MTK设备"
          echo "      ├─ MT7628 (低端路由)"
          echo "      ├─ MT7688 (物联网设备)"
          echo "      └─ 各种WiFi模块"
          echo ""
          echo "5️⃣ arm_cortex-a7 (ARM Cortex-A7)"
          echo "   ├─ 🛜 高通IPQ40xx系列 (你的设备！)"
          echo "   │  ├─ 小米路由器 4A千兆版"
          echo "   │  ├─ 红米路由器 AC2100 (部分版本)"
          echo "   │  ├─ GL.iNet MT1300"
          echo "   │  ├─ 360家庭防火墙 5Pro"
          echo "   │  ├─ Linksys EA6350 v3"
          echo "   │  └─ Netgear R6900P"
          echo "   ├─ 🛜 联发科MT7623/MT7629"
          echo "   │  ├─ 小米路由器 3G (部分版本)"
          echo "   │  ├─ 斐讯 K3C"
          echo "   │  └─ 部分企业路由器"
          echo "   ├─ 🍊 全志H3/H2+系列"
          echo "   │  ├─ Orange Pi PC (香橙派PC)"
          echo "   │  ├─ Orange Pi Plus"
          echo "   │  ├─ Banana Pi M2+"
          echo "   │  └─ NanoPi NEO"
          echo "   └─ 🔧 其他Cortex-A7设备"
          echo "      ├─ 某些智能摄像头"
          echo "      ├─ 工业控制设备"
          echo "      └─ 低功耗嵌入式设备"
          echo ""
          echo "6️⃣ arm_cortex-a53 (ARM Cortex-A53)"
          echo "   ├─ 🛜 联发科MT7622"
          echo "   │  ├─ 小米路由器 AX3600"
          echo "   │  ├─ 红米路由器 AX6"
          echo "   │  └─ 部分WiFi6路由器"
          echo "   ├─ 📱 64位设备32位模式"
          echo "   │  ├─ 树莓派 3 (32位模式)"
          echo "   │  ├─ 某些电视盒子"
          echo "   │  └─ 低端平板电脑"
          echo "   └─ 🔧 其他A53设备"
          echo "      ├─ 某些智能音箱"
          echo "      ├─ 物联网网关"
          echo "      ├─ 边缘计算设备"
          echo ""
          echo "7️⃣ riscv64 (RISC-V 64位)"
          echo "   ├─ 🔬 开发板"
          echo "   │  ├─ HiFive Unmatched"
          echo "   │  ├─ VisionFive 2"
          echo "   │  ├─ BeagleV"
          echo "   │  └─ SiFive开发板"
          echo "   ├─ 🖥️ 新兴设备"
          echo "   │  ├─ 某些AI加速器"
          echo "   │  ├─ 定制芯片设备"
          echo "   │  └─ 学术研究设备"
          echo "   └─ 🚀 未来设备"
          echo "      ├─ RISC-V笔记本电脑"
          echo "      ├─ RISC-V服务器"
          echo "      ├─ 各种创新硬件"
          echo ""
          echo "================================================"
          echo "选择建议："
          echo "1. 路由器设备 → 根据芯片型号选择"
          echo "2. 开发板 → 根据CPU架构选择"
          echo "3. PC/服务器 → 选择x86_64"
          echo "4. 不确定 → 查看设备规格书或CPU信息"
          echo "================================================"

  setup:
    runs-on: ubuntu-22.04
    outputs:
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      glibc_version: ${{ steps.version-detection.outputs.glibc_version }}
      need_build: ${{ steps.check-existing.outputs.need_build }}
      verified_gcc_version: ${{ steps.version-detection.outputs.verified_gcc_version }}
    steps:
      - name: 📥 检出仓库（用于检查现有编译器）
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: firmware-config/build-Compiler-file/compilers
          sparse-checkout-cone-mode: false

      - name: 🏗️ 初始化
        run: |
          echo "=== 交叉编译器构建系统 ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          echo "基础目录: ${{ env.COMPILER_BASE_DIR }}"
          echo "开始时间: $(date)"
          echo "当前工作区内容:"
          ls -la "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers" 2>/dev/null || echo "编译器目录不存在"

      - name: 🔍 智能版本检测与选择（修复版）
        id: version-detection
        run: |
          echo "=== 智能版本检测与选择（修复版）==="
          USER_VERSION="${{ github.event.inputs.gcc_version }}"
          TARGET_ARCH="${{ github.event.inputs.target_arch }}"
          LIBC_TYPE="${{ github.event.inputs.libc }}"
          OPENWRT_VERSION="${{ env.OPENWRT_VERSION }}"
          
          echo "输入参数:"
          echo "- 目标架构: $TARGET_ARCH"
          echo "- C库类型: $LIBC_TYPE"
          echo "- 用户指定GCC版本: $USER_VERSION"
          echo "OpenWrt版本: $OPENWRT_VERSION"
          
          case "$OPENWRT_VERSION" in
            "23.05.2"|"23.05.*")
              DEFAULT_GCC="12.3.0"
              DEFAULT_BINUTILS="2.40"
              DEFAULT_LINUX="5.15.133"
              DEFAULT_MUSL="1.2.4"
              DEFAULT_GLIBC="2.37"
              ;;
            "22.03.*")
              DEFAULT_GCC="11.3.0"
              DEFAULT_BINUTILS="2.38"
              DEFAULT_LINUX="5.10.179"
              DEFAULT_MUSL="1.2.3"
              DEFAULT_GLIBC="2.35"
              ;;
            "21.02.*")
              DEFAULT_GCC="10.3.0"
              DEFAULT_BINUTILS="2.36.1"
              DEFAULT_LINUX="5.4.188"
              DEFAULT_MUSL="1.2.2"
              DEFAULT_GLIBC="2.33"
              ;;
            *)
              DEFAULT_GCC="12.3.0"
              DEFAULT_BINUTILS="2.40"
              DEFAULT_LINUX="5.15.133"
              DEFAULT_MUSL="1.2.4"
              DEFAULT_GLIBC="2.37"
              ;;
          esac
          
          case "$TARGET_ARCH" in
            "riscv64")
              ARCH_GCC="13.2.0"
              ARCH_BINUTILS="2.41"
              echo "RISC-V架构，使用较新工具链版本"
              ;;
            "aarch64"|"arm_cortex-a53")
              ARCH_GCC="12.3.0"
              ARCH_BINUTILS="2.40"
              ;;
            "arm_cortex-a7")
              ARCH_GCC="11.3.0"
              ARCH_BINUTILS="2.38"
              echo "ARM Cortex-A7架构，使用兼容性更好的GCC 11.3.0"
              ;;
            "mips"|"mipsel")
              ARCH_GCC="10.3.0"
              ARCH_BINUTILS="2.36.1"
              echo "MIPS架构，使用较老工具链版本以保证兼容性"
              ;;
            *)
              ARCH_GCC="$DEFAULT_GCC"
              ARCH_BINUTILS="$DEFAULT_BINUTILS"
              ;;
          esac
          
          verify_gcc_version() {
            local version="$1"
            echo "验证GCC版本 $version 是否存在..."
            MIRRORS=("https://ftp.gnu.org/gnu/gcc/gcc-$version/gcc-$version.tar.xz" "https://mirrors.kernel.org/gnu/gcc/gcc-$version/gcc-$version.tar.xz" "https://mirror.rackspace.com/gnu/gcc/gcc-$version/gcc-$version.tar.xz")
            
            for mirror in "${MIRRORS[@]}"; do
              if curl -s --head "$mirror" --connect-timeout 10 | grep -q "200 OK"; then
                echo "✅ GCC $version 在镜像 $mirror 上可用"
                return 0
              fi
            done
            
            echo "❌ GCC $version 在所有镜像上都不可用"
            return 1
          }
          
          if [ "$USER_VERSION" = "auto" ] || [ -z "$USER_VERSION" ]; then
            echo "使用智能版本选择..."
            GCC_VERSION="$ARCH_GCC"
            
            if ! verify_gcc_version "$GCC_VERSION"; then
              echo "⚠️ 智能选择版本 $GCC_VERSION 不可用，尝试查找可用版本..."
              AVAILABLE_VERSIONS=$(curl -s --connect-timeout 20 "https://ftp.gnu.org/gnu/gcc/" | grep -o 'gcc-[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -Vr | cut -d- -f2 | uniq)
              
              echo "可用版本列表:"
              echo "$AVAILABLE_VERSIONS" | head -10
              
              case "$TARGET_ARCH" in
                "riscv64")
                  GCC_VERSION=$(echo "$AVAILABLE_VERSIONS" | head -1)
                  ;;
                "arm_cortex-a7")
                  GCC_VERSION=$(echo "$AVAILABLE_VERSIONS" | grep -E '^1[1-2]\.[0-9]+\.[0-9]+' | head -1)
                  ;;
                *)
                  GCC_VERSION=$(echo "$AVAILABLE_VERSIONS" | grep -v "rc" | grep -v "snapshot" | head -1)
                  ;;
              esac
              
              if [ -z "$GCC_VERSION" ]; then
                GCC_VERSION="$DEFAULT_GCC"
                echo "⚠️ 无法检测可用版本，使用默认: $GCC_VERSION"
              else
                echo "✅ 选择可用版本: $GCC_VERSION"
              fi
            fi
          else
            GCC_VERSION="$USER_VERSION"
            echo "使用用户指定版本: $GCC_VERSION"
            
            if ! verify_gcc_version "$GCC_VERSION"; then
              echo "❌ 用户指定的GCC版本 $GCC_VERSION 不可用"
              MAJOR_VERSION=$(echo "$GCC_VERSION" | cut -d. -f1)
              echo "查找主版本 $MAJOR_VERSION 的可用版本..."
              AVAILABLE_VERSIONS=$(curl -s --connect-timeout 20 "https://ftp.gnu.org/gnu/gcc/" | grep -o "gcc-$MAJOR_VERSION\.[0-9]\+\.[0-9]\+" | sort -Vr | cut -d- -f2 | uniq)
              
              if [ -n "$AVAILABLE_VERSIONS" ]; then
                NEW_VERSION=$(echo "$AVAILABLE_VERSIONS" | head -1)
                echo "找到可用版本: $NEW_VERSION"
                GCC_VERSION="$NEW_VERSION"
              else
                echo "使用架构推荐版本: $ARCH_GCC"
                GCC_VERSION="$ARCH_GCC"
              fi
            fi
          fi
          
          VERIFIED_GCC_VERSION="$GCC_VERSION"
          echo "✅ 最终确认的GCC版本: $VERIFIED_GCC_VERSION"
          
          echo "根据GCC $GCC_VERSION 选择Binutils版本..."
          GCC_MAJOR=$(echo "$GCC_VERSION" | cut -d. -f1)
          
          case $GCC_MAJOR in
            13|14)
              BINUTILS_VERSION="2.41"
              ;;
            12)
              BINUTILS_VERSION="2.40"
              ;;
            11)
              BINUTILS_VERSION="2.38"
              ;;
            10)
              BINUTILS_VERSION="2.36.1"
              ;;
            9)
              BINUTILS_VERSION="2.34"
              ;;
            8)
              BINUTILS_VERSION="2.32"
              ;;
            *)
              BINUTILS_VERSION="$DEFAULT_BINUTILS"
              ;;
          esac
          
          echo "验证Binutils版本 $BINUTILS_VERSION..."
          BINUTILS_URL="https://ftp.gnu.org/gnu/binutils/binutils-$BINUTILS_VERSION.tar.xz"
          if ! curl -s --head "$BINUTILS_URL" | grep -q "200 OK"; then
            echo "⚠️ Binutils $BINUTILS_VERSION 不可用，尝试检测最新版本"
            BINUTILS_VERSION=$(curl -s https://ftp.gnu.org/gnu/binutils/ | grep -o 'binutils-[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -Vr | head -1 | cut -d- -f2)
          fi
          
          LINUX_VERSION="$DEFAULT_LINUX"
          MUSL_VERSION="$DEFAULT_MUSL"
          GLIBC_VERSION="$DEFAULT_GLIBC"
          
          echo "🎯 最终版本选择:"
          echo "- 目标架构: $TARGET_ARCH"
          echo "- C库类型: $LIBC_TYPE"
          echo "- GCC版本: $GCC_VERSION (主版本: $GCC_MAJOR)"
          echo "- Binutils版本: $BINUTILS_VERSION"
          echo "- Linux内核: $LINUX_VERSION"
          echo "- Musl版本: $MUSL_VERSION"
          echo "- Glibc版本: $GLIBC_VERSION"
          echo ""
          echo "📊 版本选择说明:"
          echo "1. OpenWrt $OPENWRT_VERSION 基础版本 → GCC $DEFAULT_GCC"
          echo "2. 架构 $TARGET_ARCH 优化 → GCC $ARCH_GCC"
          echo "3. 最终选择 → GCC $GCC_VERSION (已验证可用)"
          
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "verified_gcc_version=$VERIFIED_GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT
          echo "DEBUG_GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "DEBUG_BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV

      - name: 🔎 检查现有编译器
        id: check-existing
        run: |
          echo "=== 检查现有编译器 ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          GCC_VERSION='${{ steps.version-detection.outputs.verified_gcc_version }}'
          BINUTILS_VERSION='${{ steps.version-detection.outputs.binutils_version }}'
          
          echo "检查版本变量:"
          echo "- GCC_VERSION: '$GCC_VERSION'"
          echo "- BINUTILS_VERSION: '$BINUTILS_VERSION'"
          
          if [ "$LIBC" = "musl" ]; then
            LIBC_DIR="musl"
          else
            LIBC_DIR="glibc"
          fi
          
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH}/${LIBC_DIR}/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "检查目录: $OUTPUT_DIR"
          
          if [ -d "$OUTPUT_DIR" ]; then
            echo "✅ 编译器目录已存在"
            echo "目录内容:"
            ls -la "$OUTPUT_DIR/" 2>/dev/null | head -10
            
            GCC_FILES=$(find "$OUTPUT_DIR" -name "*gcc" -type f 2>/dev/null || true)
            if [ -n "$GCC_FILES" ]; then
              echo "✅ 找到GCC编译器文件"
              FIRST_GCC=$(echo "$GCC_FILES" | head -1)
              echo "检查编译器实际版本:"
              "$FIRST_GCC" --version 2>&1 | head -3 || echo "无法获取版本信息"
            else
              echo "❌ 未找到GCC编译器文件"
              NEED_BUILD="true"
            fi
            
            if [ -f "$OUTPUT_DIR/metadata.json" ]; then
              echo "找到元数据文件"
              STORED_GCC=$(jq -r '.gcc_version' "$OUTPUT_DIR/metadata.json" 2>/dev/null || echo "")
              STORED_BINUTILS=$(jq -r '.binutils_version' "$OUTPUT_DIR/metadata.json" 2>/dev/null || echo "")
              
              echo "存储的版本: GCC $STORED_GCC, Binutils $STORED_BINUTILS"
              echo "请求的版本: GCC $GCC_VERSION, Binutils $BINUTILS_VERSION"
              
              if [ "$STORED_GCC" = "$GCC_VERSION" ] && [ "$STORED_BINUTILS" = "$BINUTILS_VERSION" ]; then
                echo "✅ 版本匹配"
              else
                echo "⚠️ 版本不匹配"
                NEED_BUILD="true"
              fi
            else
              echo "⚠️ 未找到元数据文件"
              NEED_BUILD="true"
            fi
            
            if [ -z "$NEED_BUILD" ]; then
              if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
                echo "⚠️ 强制重新构建已启用"
                NEED_BUILD="true"
              else
                echo "✅ 编译器完整，跳过构建"
                NEED_BUILD="false"
              fi
            fi
          else
            echo "❌ 编译器目录不存在，需要构建"
            NEED_BUILD="true"
          fi
          
          echo "构建决策: $NEED_BUILD"
          echo "need_build=$NEED_BUILD" >> $GITHUB_OUTPUT

  build-compiler:
    needs: [show-device-info, setup]
    if: needs.setup.outputs.need_build == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    
    steps:
      - name: 📥 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 📋 显示构建信息
        run: |
          echo "========================================"
          echo "        交叉编译器构建信息              "
          echo "========================================"
          echo "目标架构: ${{ github.event.inputs.target_arch }}"
          echo "C库类型: ${{ github.event.inputs.libc }}"
          echo "GCC版本: ${{ needs.setup.outputs.gcc_version }}"
          echo "已验证GCC版本: ${{ needs.setup.outputs.verified_gcc_version }}"
          echo "Binutils版本: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linux内核: ${{ needs.setup.outputs.linux_version }}"
          echo "Musl版本: ${{ needs.setup.outputs.musl_version }}"
          echo "Glibc版本: ${{ needs.setup.outputs.glibc_version }}"
          echo "OpenWrt版本: ${{ env.OPENWRT_VERSION }}"
          echo "强制重建: ${{ github.event.inputs.force_rebuild }}"
          echo "清理构建: ${{ github.event.inputs.clean_build }}"
          echo "构建需求: ${{ needs.setup.outputs.need_build }}"
          echo "========================================"
          echo "开始时间: $(date)"
          echo "运行ID: ${{ github.run_id }}"
          echo "运行序号: ${{ github.run_number }}"
          echo "========================================"

      - name: 🏗️ 设置环境
        run: |
          echo "=== 设置构建环境 ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          echo "处理架构: $ARCH"
          echo "处理C库: $LIBC"
          
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="ipq40xx"
              SUBTARGET="generic"
              ARCH_NAME="arm"
              ARCH_DIR="arm_cortex-a7"
              PREFIX="arm-openwrt-linux"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              ABI="32"
              FLOAT_ABI="hard"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              ARCH_DIR="aarch64"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              ARCH_DIR="x86_64"
              PREFIX="x86_64-openwrt-linux"
              CPU_TYPE="x86_64"
              TUNE="generic"
              ABI="64"
              FLOAT_ABI=""
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              ARCH_DIR="mips"
              PREFIX="mips-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              ARCH_DIR="mipsel"
              PREFIX="mipsel-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            arm_cortex-a53)
              TARGET="rockchip"
              SUBTARGET="armv8"
              ARCH_NAME="aarch64"
              ARCH_DIR="arm_cortex-a53"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              ARCH_DIR="riscv64"
              PREFIX="riscv64-openwrt-linux"
              CPU_TYPE="generic"
              TUNE="generic"
              ABI="lp64d"
              FLOAT_ABI="hard"
              ;;
            *)
              echo "❌ 不支持的架构: $ARCH"
              exit 1
              ;;
          esac
          
          if [ "$LIBC" = "musl" ]; then
            PREFIX="${PREFIX}-musl"
            LIBC_SUFFIX="musl"
            LIBC_DIR="musl"
            USE_MUSL="y"
            USE_GLIBC="n"
            LIBC_VERSION='${{ needs.setup.outputs.musl_version }}'
          else
            PREFIX="${PREFIX}-gnu"
            LIBC_SUFFIX="glibc"
            LIBC_DIR="glibc"
            USE_MUSL="n"
            USE_GLIBC="y"
            LIBC_VERSION='${{ needs.setup.outputs.glibc_version }}'
          fi
          
          GCC_VERSION='${{ needs.setup.outputs.verified_gcc_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          LINUX_VERSION='${{ needs.setup.outputs.linux_version }}'
          
          BUILD_ID="${ARCH_DIR}_${LIBC_DIR}_gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="/tmp/compiler-build-${BUILD_ID}"
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH_DIR}/${LIBC_DIR}/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "📊 环境配置汇总:"
          echo "  构建ID: $BUILD_ID"
          echo "  构建目录: $BUILD_DIR"
          echo "  输出目录: $OUTPUT_DIR"
          echo "  目标平台: $TARGET/$SUBTARGET"
          echo "  架构名称: $ARCH_NAME"
          echo "  架构目录: $ARCH_DIR"
          echo "  C库目录: $LIBC_DIR"
          echo "  C库版本: $LIBC_VERSION"
          echo "  编译器前缀: $PREFIX-"
          echo "  CPU类型: $CPU_TYPE"
          echo "  调优: $TUNE"
          echo "  ABI: $ABI"
          echo "  浮点ABI: $FLOAT_ABI"
          echo "  GCC版本: $GCC_VERSION"
          echo "  Binutils版本: $BINUTILS_VERSION"
          echo "  Linux内核版本: $LINUX_VERSION"
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "ARCH_DIR=$ARCH_DIR" >> $GITHUB_ENV
          echo "LIBC_DIR=$LIBC_DIR" >> $GITHUB_ENV
          echo "LIBC_VERSION=$LIBC_VERSION" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "TUNE=$TUNE" >> $GITHUB_ENV
          echo "ABI=$ABI" >> $GITHUB_ENV
          echo "FLOAT_ABI=$FLOAT_ABI" >> $GITHUB_ENV
          echo "USE_MUSL=$USE_MUSL" >> $GITHUB_ENV
          echo "USE_GLIBC=$USE_GLIBC" >> $GITHUB_ENV
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV
          echo "LINUX_VERSION=$LINUX_VERSION" >> $GITHUB_ENV
          echo "LIBC_SUFFIX=$LIBC_SUFFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

      - name: 🔧 安装依赖
        run: |
          echo "=== 安装构建依赖 ==="
          echo "开始时间: $(date)"
          echo "GCC版本: ${{ env.GCC_VERSION }}"
          GCC_MAJOR=$(echo "${{ env.GCC_VERSION }}" | cut -d. -f1)
          
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison git wget curl file gawk gettext rsync unzip autoconf automake autopoint libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq info install-info liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev libelf-dev libdw-dev libcap-dev libattr1-dev libaudit-dev libiberty-dev libssl-dev
          
          if [ $GCC_MAJOR -ge 13 ]; then
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev python3-distutils libncurses5-dev libssl-dev gnutls-bin liblzma-dev zlib1g-dev libstdc++-12-dev
          elif [ $GCC_MAJOR -ge 11 ]; then
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev python3-distutils libncurses5-dev libssl-dev gnutls-bin liblzma-dev zlib1g-dev libstdc++-11-dev
          else
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev python3 python3-dev libncurses5-dev libssl-dev liblzma-dev zlib1g-dev
          fi
          
          ARCH="${{ github.event.inputs.target_arch }}"
          case "$ARCH" in
            "riscv64")
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y device-tree-compiler qemu-system-riscv64 libfdt-dev
              ;;
            "aarch64"|"arm_cortex-a7"|"arm_cortex-a53")
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
              ;;
          esac
          
          echo "✅ 依赖安装完成"
          echo "结束时间: $(date)"

      - name: 🔧 预构建GMP修复
        run: |
          echo "=== 预构建GMP修复 ==="
          echo "开始时间: $(date)"
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libgmp10 libgmp3-dev libgmp10-doc
          echo "✅ GMP修复完成"
          echo "结束时间: $(date)"

      - name: 🗑️ 清理构建缓存
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          echo "=== 清理构建缓存 ==="
          sudo rm -rf /tmp/compiler-build-* 2>/dev/null || true
          echo "✅ 缓存清理完成"

      - name: 📥 下载OpenWrt源码
        run: |
          echo "=== 获取OpenWrt源码 ==="
          echo "开始时间: $(date)"
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          
          echo "克隆OpenWrt ${{ env.OPENWRT_VERSION }} 分支..."
          if git clone --depth 1 --branch "v${{ env.OPENWRT_VERSION }}" https://github.com/openwrt/openwrt.git .; then
            echo "✅ Git clone成功"
          else
            git clone --depth 1 https://github.com/openwrt/openwrt.git .
            if git checkout "v${{ env.OPENWRT_VERSION }}"; then
              echo "✅ 切换版本成功"
            else
              wget --tries=3 --timeout=60 --show-progress -O openwrt.tar.gz "https://github.com/openwrt/openwrt/archive/refs/tags/v${{ env.OPENWRT_VERSION }}.tar.gz"
              if [ $? -eq 0 ]; then
                tar -xzf openwrt.tar.gz --strip-components=1
                rm -f openwrt.tar.gz
                echo "✅ 使用tar包下载成功"
              else
                echo "❌ 所有下载方法都失败"
                exit 1
              fi
            fi
          fi
          
          echo "源码大小: $(du -sh . | cut -f1)"
          echo "结束时间: $(date)"

      - name: 📥 预下载源码包
        timeout-minutes: 60
        run: |
          echo "=== 预下载源码包 ==="
          cd "${{ env.BUILD_DIR }}"
          echo "开始时间: $(date)"
          
          mkdir -p dl
          
          echo "步骤1: 下载核心工具链包..."
          
          download_gcc() {
            local version="$1"
            local filename="dl/gcc-$version.tar.xz"
            echo "下载GCC $version..."
            MIRRORS=("https://ftp.gnu.org/gnu/gcc/gcc-$version/gcc-$version.tar.xz" "https://mirrors.kernel.org/gnu/gcc/gcc-$version/gcc-$version.tar.xz" "https://mirror.rackspace.com/gnu/gcc/gcc-$version/gcc-$version.tar.xz")
            
            for mirror in "${MIRRORS[@]}"; do
              echo "尝试镜像: $mirror"
              if wget --tries=3 --timeout=120 --show-progress -O "$filename" "$mirror"; then
                echo "✅ GCC $version 下载成功"
                return 0
              fi
              rm -f "$filename" 2>/dev/null
            done
            
            echo "❌ GCC $version 所有镜像下载失败"
            return 1
          }
          
          download_binutils() {
            local version="$1"
            local filename="dl/binutils-$version.tar.xz"
            echo "下载Binutils $version..."
            MIRRORS=("https://ftp.gnu.org/gnu/binutils/binutils-$version.tar.xz" "https://mirrors.kernel.org/gnu/binutils/binutils-$version.tar.xz" "https://mirror.rackspace.com/gnu/binutils/binutils-$version.tar.xz")
            
            for mirror in "${MIRRORS[@]}"; do
              echo "尝试镜像: $mirror"
              if wget --tries=3 --timeout=120 --show-progress -O "$filename" "$mirror"; then
                echo "✅ Binutils $version 下载成功"
                return 0
              fi
              rm -f "$filename" 2>/dev/null
            done
            
            echo "❌ Binutils $version 所有镜像下载失败"
            return 1
          }
          
          if ! download_gcc "${{ env.GCC_VERSION }}"; then
            echo "❌ GCC下载失败"
            exit 1
          fi
          
          if ! download_binutils "${{ env.BINUTILS_VERSION }}"; then
            echo "❌ Binutils下载失败"
            exit 1
          fi
          
          echo "✅ 预下载完成"
          echo "结束时间: $(date)"

      - name: 🔐 强制锁定配置（方案1）
        run: |
          echo "=== 强制锁定配置（方案1）==="
          echo "开始时间: $(date)"
          cd "${{ env.BUILD_DIR }}"
          
          rm -f .config .config.old .config.cmd 2>/dev/null || true
          rm -f include/target.mk include/kernel-version.mk include/openssl-engine.mk 2>/dev/null || true
          
          echo "# 基础配置" > .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_CCACHE=n" >> .config
          echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> .config
          echo "CONFIG_BUILD_PATENTED=y" >> .config
          echo "CONFIG_BUILD_NLS=y" >> .config
          echo "CONFIG_USE_LIBSTDCXX=y" >> .config
          echo "" >> .config
          echo "# 工具链配置" >> .config
          echo "CONFIG_EXTERNAL_TOOLCHAIN=n" >> .config
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "CONFIG_GCC_VERSION=\"${{ env.GCC_VERSION }}\"" >> .config
          echo "CONFIG_BINUTILS_VERSION=\"${{ env.BINUTILS_VERSION }}\"" >> .config
          echo "CONFIG_LINUX_VERSION=\"${{ env.LINUX_VERSION }}\"" >> .config
          echo "CONFIG_USE_MUSL=${{ env.USE_MUSL }}" >> .config
          echo "" >> .config
          echo "# 目标配置" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
          echo "CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"" >> .config
          echo "CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}\"" >> .config
          echo "" >> .config
          echo "# C库配置" >> .config
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "CONFIG_MUSL_VERSION=\"${{ env.LIBC_VERSION }}\"" >> .config
            echo "CONFIG_GLIBC_VERSION=\"\"" >> .config
          else
            echo "CONFIG_GLIBC_VERSION=\"${{ env.LIBC_VERSION }}\"" >> .config
            echo "CONFIG_MUSL_VERSION=\"\"" >> .config
          fi
          
          echo "" >> .config
          echo "# 禁用所有其他目标" >> .config
          echo "# 重要：这防止OpenWrt使用默认配置" >> .config
          
          echo "CONFIG_STRIP_ARGS=\"--strip-all\"" >> .config
          echo "CONFIG_TARGET_SUFFIX=\"generic\"" >> .config
          echo "CONFIG_TARGET_OPTIMIZATION=\"-Os -pipe\"" >> .config
          echo "CONFIG_TARGET_DEBUG=y" >> .config
          echo "CONFIG_GCC_DEFAULT_PIE=n" >> .config
          echo "CONFIG_GCC_DEFAULT_SSP=n" >> .config
          echo "CONFIG_GCC_DEFAULT_RELRO=n" >> .config
          echo "CONFIG_SJLJ_EXCEPTIONS=n" >> .config
          echo "CONFIG_INSTALL_GFORTRAN=n" >> .config
          echo "CONFIG_GDB=n" >> .config
          
          mkdir -p include
          echo "# 强制使用指定版本" > include/version-override.mk
          echo "GCC_VERSION_OVERRIDE := ${{ env.GCC_VERSION }}" >> include/version-override.mk
          echo "BINUTILS_VERSION_OVERRIDE := ${{ env.BINUTILS_VERSION }}" >> include/version-override.mk
          echo "LINUX_VERSION_OVERRIDE := ${{ env.LINUX_VERSION }}" >> include/version-override.mk
          echo "" >> include/version-override.mk
          echo "ifeq (\$(CONFIG_USE_MUSL),y)" >> include/version-override.mk
          echo "LIBC_VERSION_OVERRIDE := ${{ env.LIBC_VERSION }}" >> include/version-override.mk
          echo "endif" >> include/version-override.mk
          echo "" >> include/version-override.mk
          echo "# 覆盖默认版本" >> include/version-override.mk
          echo "ifdef GCC_VERSION_OVERRIDE" >> include/version-override.mk
          echo "  GCC_VERSION := \$(GCC_VERSION_OVERRIDE)" >> include/version-override.mk
          echo "endif" >> include/version-override.mk
          echo "ifdef BINUTILS_VERSION_OVERRIDE" >> include/version-override.mk
          echo "  BINUTILS_VERSION := \$(BINUTILS_VERSION_OVERRIDE)" >> include/version-override.mk
          echo "endif" >> include/version-override.mk
          echo "ifdef LINUX_VERSION_OVERRIDE" >> include/version-override.mk
          echo "  LINUX_VERSION := \$(LINUX_VERSION_OVERRIDE)" >> include/version-override.mk
          echo "endif" >> include/version-override.mk
          echo "ifdef LIBC_VERSION_OVERRIDE" >> include/version-override.mk
          echo "  MUSL_VERSION := \$(LIBC_VERSION_OVERRIDE)" >> include/version-override.mk
          echo "  GLIBC_VERSION := \$(LIBC_VERSION_OVERRIDE)" >> include/version-override.mk
          echo "endif" >> include/version-override.mk
          
          if [ -f "rules.mk" ]; then
            sed -i 's/GCC_VERSION :=.*/GCC_VERSION := ${{ env.GCC_VERSION }}/' rules.mk
            sed -i 's/BINUTILS_VERSION :=.*/BINUTILS_VERSION := ${{ env.BINUTILS_VERSION }}/' rules.mk
          fi
          
          if [ -f "Config.in" ]; then
            sed -i "s/default \"12.3.0\"/default \"${{ env.GCC_VERSION }}\"/g" Config.in 2>/dev/null || true
            sed -i "s/default \"2.40\"/default \"${{ env.BINUTILS_VERSION }}\"/g" Config.in 2>/dev/null || true
          fi
          
          echo "✅ 配置强制锁定完成"
          echo "结束时间: $(date)"

      - name: 🔧 修复GMP构建问题
        run: |
          echo "=== 修复GMP构建问题 ==="
          cd "${{ env.BUILD_DIR }}"
          
          if [ -d "tools/gmp" ]; then
            if [ -f "tools/gmp/Makefile" ]; then
              cp tools/gmp/Makefile tools/gmp/Makefile.backup
              sed -i '/define Host\/Configure/a \\t\tABI=64 \\' tools/gmp/Makefile
              sed -i '/define Host\/Configure/a \\t\t--enable-cxx \\' tools/gmp/Makefile
              echo "✅ GMP构建修复完成"
            else
              echo "⚠️ GMP Makefile不存在"
            fi
          else
            echo "⚠️ tools/gmp目录不存在"
          fi

      - name: 🛠️ 分步构建工具链
        timeout-minutes: 240
        run: |
          echo "=== 分步构建工具链 ==="
          cd "${{ env.BUILD_DIR }}"
          echo "开始时间: $(date)"
          
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          export MAKEFLAGS="-j$(nproc)"
          export CPPFLAGS="-I/usr/include"
          export LDFLAGS="-L/usr/lib/x86_64-linux-gnu"
          export ABI=64
          
          echo "步骤1: 显示最终配置..."
          grep -E "CONFIG_TARGET_|CONFIG_GCC|CONFIG_BINUTILS|CONFIG_.*LIBC" .config | grep -v "=n"
          
          if ! grep -q "CONFIG_TARGET_${{ env.TARGET }}=y" .config; then
            echo "❌ 配置错误：目标不是 ${{ env.TARGET }}"
            exit 1
          fi
          
          echo "步骤2: 准备构建..."
          touch .config
          yes "" | make oldconfig 2>&1 | tail -20
          
          echo "步骤3: 构建GMP..."
          if [ -d "build_dir/host/gmp-*" ]; then
            rm -rf build_dir/host/gmp-* 2>/dev/null || true
          fi
          
          make tools/gmp/compile V=s 2>&1 | tee /tmp/gmp-build.log
          GMP_STATUS=${PIPESTATUS[0]}
          
          if [ $GMP_STATUS -eq 0 ]; then
            echo "✅ GMP构建成功"
          else
            echo "⚠️ GMP构建失败，尝试使用系统GMP..."
          fi
          
          echo "步骤4: 构建host工具..."
          make tools/install -j$(nproc) V=s 2>&1 | tee /tmp/tools-install.log | grep -E "Installing|Building|ERROR|Error" | tail -50
          
          echo "步骤5: 准备工具链..."
          make toolchain/prepare -j$(nproc) V=s 2>&1 | tee /tmp/prepare.log &
          PREPARE_PID=$!
          
          for i in {1..60}; do
            if kill -0 $PREPARE_PID 2>/dev/null; then
              echo "进度: 第 $i/60 分钟"
              sleep 30
            else
              break
            fi
          done
          
          if kill -0 $PREPARE_PID 2>/dev/null; then
            kill -9 $PREPARE_PID 2>/dev/null
            echo "⚠️ 工具链准备超时"
          fi
          
          echo "步骤6: 编译工具链..."
          make toolchain/compile -j$(nproc) V=s 2>&1 | tee /tmp/compile.log &
          COMPILE_PID=$!
          
          for i in {1..90}; do
            if kill -0 $COMPILE_PID 2>/dev/null; then
              echo "进度: 第 $i/90 分钟"
              sleep 30
            else
              break
            fi
          done
          
          if kill -0 $COMPILE_PID 2>/dev/null; then
            kill -9 $COMPILE_PID 2>/dev/null
            echo "尝试单线程编译..."
            make toolchain/compile -j1 V=s 2>&1 | tee /tmp/compile-single.log | tail -100
          fi
          
          echo "步骤7: 安装工具链..."
          make toolchain/install -j$(nproc) V=s 2>&1 | tee /tmp/install.log | tail -100
          
          echo "✅ 工具链构建完成"
          echo "总构建时间: $(date)"
          
          TOOLCHAIN_DIR=""
          for dir in $(find staging_dir -name "toolchain-*" -type d 2>/dev/null | sort); do
            if [ -d "$dir/bin" ]; then
              TOOLCHAIN_DIR="$dir"
              echo "✅ 找到工具链目录: $TOOLCHAIN_DIR"
              break
            fi
          done
          
          if [ -z "$TOOLCHAIN_DIR" ]; then
            TOOLCHAIN_DIR=$(find staging_dir -name "*toolchain*" -type d 2>/dev/null | head -1)
          fi
          
          COMPILER_PATH=""
          if [ -n "$TOOLCHAIN_DIR" ] && [ -d "$TOOLCHAIN_DIR/bin" ]; then
            case "${{ env.ARCH_NAME }}" in
              "arm")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "arm-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              "aarch64")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "aarch64-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              "x86_64")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "x86_64-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              "mips"|"mipsel")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "mips*-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              *)
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
                ;;
            esac
          fi
          
          if [ -z "$COMPILER_PATH" ]; then
            COMPILER_PATH=$(find staging_dir -name "*gcc" -type f -executable 2>/dev/null | grep -v "host/share" | grep -v "makefile" | head -1)
          fi
          
          if [ -n "$COMPILER_PATH" ] && [ -x "$COMPILER_PATH" ]; then
            echo "✅ 找到编译器文件"
            echo "编译器位置: $COMPILER_PATH"
          else
            echo "⚠️ 未找到编译器文件"
            COMPILER_PATH="/tmp/virtual-gcc"
            echo '#!/bin/bash' > "$COMPILER_PATH"
            echo 'echo "Virtual GCC - Toolchain build may be incomplete"' >> "$COMPILER_PATH"
            echo 'echo "Target: ${{ env.PREFIX }}-"' >> "$COMPILER_PATH"
            echo 'exit 1' >> "$COMPILER_PATH"
            chmod +x "$COMPILER_PATH"
          fi
          
          echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV
          if [ -n "$TOOLCHAIN_DIR" ]; then
            echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          fi

      - name: 🔍 验证实际编译器版本
        run: |
          echo "=== 验证实际编译器版本 ==="
          echo "开始时间: $(date)"
          cd "${{ env.BUILD_DIR }}"
          
          if [ -n "${{ env.COMPILER_PATH }}" ] && [ -x "${{ env.COMPILER_PATH }}" ]; then
            COMPILER_PATH="${{ env.COMPILER_PATH }}"
            echo "使用环境变量中的编译器路径: $COMPILER_PATH"
          else
            SEARCH_PATTERNS=("staging_dir/toolchain-*/bin/*gcc" "staging_dir/host/bin/*gcc" "staging_dir/bin/*gcc")
            for pattern in "${SEARCH_PATTERNS[@]}"; do
              found_file=$(find . -path "./$pattern" -type f -executable 2>/dev/null | head -1)
              if [ -n "$found_file" ]; then
                COMPILER_PATH="$found_file"
                echo "✅ 找到编译器: $COMPILER_PATH"
                break
              fi
            done
          fi
          
          if [ -z "$COMPILER_PATH" ]; then
            echo "❌ 未找到编译器文件"
            COMPILER_PATH="/tmp/virtual-compiler"
            echo '#!/bin/bash' > "$COMPILER_PATH"
            echo 'echo "Compiler not found - build may have failed"' >> "$COMPILER_PATH"
            chmod +x "$COMPILER_PATH"
          fi
          
          COMPILER_NAME=$(basename "$COMPILER_PATH")
          echo "✅ 编译器: $COMPILER_NAME"
          echo "路径: $COMPILER_PATH"
          
          if [ "$COMPILER_PATH" != "/tmp/virtual-compiler" ]; then
            if file "$COMPILER_PATH" | grep -q "ELF"; then
              echo "GCC版本信息:"
              "$COMPILER_PATH" --version 2>&1 | head -5
              
              ACTUAL_GCC_VERSION=$("$COMPILER_PATH" --version 2>&1 | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
              if [ -n "$ACTUAL_GCC_VERSION" ]; then
                echo "✅ 实际GCC版本: $ACTUAL_GCC_VERSION"
                echo "配置GCC版本: ${{ env.GCC_VERSION }}"
                
                if [ "$ACTUAL_GCC_VERSION" = "${{ env.GCC_VERSION }}" ]; then
                  echo "✅ 版本匹配正确！"
                  echo "ACTUAL_GCC_VERSION=$ACTUAL_GCC_VERSION" >> $GITHUB_ENV
                  echo "VERSION_MATCH=true" >> $GITHUB_ENV
                else
                  echo "⚠️ 版本不匹配！"
                  echo "实际: $ACTUAL_GCC_VERSION"
                  echo "配置: ${{ env.GCC_VERSION }}"
                  echo "ACTUAL_GCC_VERSION=$ACTUAL_GCC_VERSION" >> $GITHUB_ENV
                  echo "VERSION_MATCH=false" >> $GITHUB_ENV
                fi
              else
                echo "⚠️ 无法提取GCC版本"
                echo "VERSION_MATCH=unknown" >> $GITHUB_ENV
              fi
            else
              echo "⚠️ 文件不是可执行ELF文件"
            fi
          else
            echo "虚拟编译器 - 无版本信息"
            echo "VERSION_MATCH=false" >> $GITHUB_ENV
          fi
          
          echo "目标三元组:"
          if [ "$COMPILER_PATH" != "/tmp/virtual-compiler" ] && file "$COMPILER_PATH" | grep -q "ELF"; then
            TARGET_TRIPLET=$("$COMPILER_PATH" -dumpmachine 2>&1) || {
              TARGET_TRIPLET=$(echo "$COMPILER_NAME" | sed 's/-gcc.*//')
            }
          else
            TARGET_TRIPLET="${{ env.PREFIX }}"
          fi
          echo "$TARGET_TRIPLET"
          
          echo "快速测试交叉编译..."
          echo '#include <stdio.h>' > test.c
          echo 'int main() { printf("Cross-compile test\\n"); return 0; }' >> test.c
          
          if [ "$COMPILER_PATH" != "/tmp/virtual-compiler" ] && file "$COMPILER_PATH" | grep -q "ELF"; then
            if "$COMPILER_PATH" test.c -o test_program 2>&1; then
              echo "✅ 交叉编译测试通过"
              if file test_program 2>/dev/null | grep -q "${{ env.ARCH_NAME }}"; then
                echo "✅ 生成了正确的目标架构文件"
                rm -f test.c test_program
                echo "BUILD_COMPLETE=true" >> $GITHUB_ENV
              else
                echo "⚠️ 文件架构不匹配"
                rm -f test.c test_program
                echo "BUILD_COMPLETE=false" >> $GITHUB_ENV
              fi
            else
              echo "⚠️ 交叉编译测试失败"
              rm -f test.c test_program
              echo "BUILD_COMPLETE=false" >> $GITHUB_ENV
            fi
          else
            echo "⚠️ 使用虚拟编译器，跳过编译测试"
            rm -f test.c
            echo "BUILD_COMPLETE=false" >> $GITHUB_ENV
          fi
          
          echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV
          echo "COMPILER_NAME=$COMPILER_NAME" >> $GITHUB_ENV
          echo "TARGET_TRIPLET=$TARGET_TRIPLET" >> $GITHUB_ENV
          
          echo "✅ 验证完成"
          echo "结束时间: $(date)"

      - name: 🛠️ 构建后版本修复（方案3）
        run: |
          echo "=== 构建后版本修复（方案3）==="
          echo "开始时间: $(date)"
          cd "${{ env.BUILD_DIR }}"
          
          GCC_FILES=$(find staging_dir -name "*gcc" -type f -executable 2>/dev/null | head -5)
          echo "找到的GCC文件:"
          for gcc_file in $GCC_FILES; do
            echo "- $gcc_file"
            "$gcc_file" --version 2>&1 | head -1
          done
          
          ACTUAL_GCC_VERSION=$(find staging_dir -name "*gcc" -type f -executable 2>/dev/null | head -1 | xargs --version 2>&1 | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          
          if [ -z "$ACTUAL_GCC_VERSION" ]; then
            TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d | head -1)
            ACTUAL_GCC_VERSION=$(echo "$TOOLCHAIN_DIR" | grep -Eo 'gcc-[0-9]+\.[0-9]+\.[0-9]+' | cut -d- -f2)
          fi
          
          echo "实际构建的GCC版本: $ACTUAL_GCC_VERSION"
          echo "配置的GCC版本: ${{ env.GCC_VERSION }}"
          
          if [ -n "$ACTUAL_GCC_VERSION" ] && [ "$ACTUAL_GCC_VERSION" != "${{ env.GCC_VERSION }}" ]; then
            echo "⚠️ 版本不匹配！更新环境变量..."
            NEW_OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${{ env.ARCH_DIR }}/${{ env.LIBC_DIR }}/gcc-${ACTUAL_GCC_VERSION}_binutils-${{ env.BINUTILS_VERSION }}"
            
            echo "ACTUAL_GCC_VERSION=$ACTUAL_GCC_VERSION" >> $GITHUB_ENV
            echo "FINAL_GCC_VERSION=$ACTUAL_GCC_VERSION" >> $GITHUB_ENV
            echo "REAL_OUTPUT_DIR=$NEW_OUTPUT_DIR" >> $GITHUB_ENV
            echo "VERSION_MISMATCH=true" >> $GITHUB_ENV
            echo "DIR_RENAMED=true" >> $GITHUB_ENV
          else
            echo "✅ 版本匹配正确"
            echo "VERSION_MISMATCH=false" >> $GITHUB_ENV
            echo "DIR_RENAMED=false" >> $GITHUB_ENV
            if [ -n "$ACTUAL_GCC_VERSION" ]; then
              echo "FINAL_GCC_VERSION=$ACTUAL_GCC_VERSION" >> $GITHUB_ENV
            else
              echo "FINAL_GCC_VERSION=${{ env.GCC_VERSION }}" >> $GITHUB_ENV
            fi
          fi
          
          echo "结束时间: $(date)"

      - name: 💾 保存编译器
        if: env.TOOLCHAIN_DIR != ''
        run: |
          echo "=== 保存编译器 ==="
          echo "开始时间: $(date)"
          cd "${{ env.BUILD_DIR }}"
          
          if [ -n "${{ env.REAL_OUTPUT_DIR }}" ]; then
            FINAL_OUTPUT_DIR="${{ env.REAL_OUTPUT_DIR }}"
          else
            FINAL_OUTPUT_DIR="${{ env.OUTPUT_DIR }}"
          fi
          
          echo "准备输出目录: $FINAL_OUTPUT_DIR"
          mkdir -p "$FINAL_OUTPUT_DIR"
          
          if [ -d "$FINAL_OUTPUT_DIR" ] && [ "$(ls -A "$FINAL_OUTPUT_DIR" 2>/dev/null)" ]; then
            rm -rf "$FINAL_OUTPUT_DIR"/*
          fi
          
          if [ -d "${{ env.TOOLCHAIN_DIR }}" ] && [ "${{ env.TOOLCHAIN_DIR }}" != "/tmp/temp-toolchain" ]; then
            echo "复制工具链文件..."
            cp -r "${{ env.TOOLCHAIN_DIR }}"/* "$FINAL_OUTPUT_DIR/" 2>/dev/null || true
            echo "✅ 复制完成"
          else
            echo "⚠️ 工具链目录不存在，创建基本结构..."
            mkdir -p "$FINAL_OUTPUT_DIR/bin"
            mkdir -p "$FINAL_OUTPUT_DIR/lib"
            mkdir -p "$FINAL_OUTPUT_DIR/include"
            
            echo "警告：编译器构建可能不完整" > "$FINAL_OUTPUT_DIR/README.txt"
            echo "=======================================" >> "$FINAL_OUTPUT_DIR/README.txt"
            echo "此编译器构建过程中可能出现了问题。" >> "$FINAL_OUTPUT_DIR/README.txt"
            echo "建议检查构建日志或重新运行构建。" >> "$FINAL_OUTPUT_DIR/README.txt"
            echo "=======================================" >> "$FINAL_OUTPUT_DIR/README.txt"
          fi
          
          if [ -n "${{ env.FINAL_GCC_VERSION }}" ]; then
            FINAL_GCC_VERSION="${{ env.FINAL_GCC_VERSION }}"
          else
            FINAL_GCC_VERSION="${{ env.GCC_VERSION }}"
          fi
          
          echo "创建元数据文件..."
          echo "{" > "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"architecture\": \"${{ env.ARCH_DIR }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"arch_name\": \"${{ env.ARCH_NAME }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"libc\": \"${{ env.LIBC_DIR }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"libc_version\": \"${{ env.LIBC_VERSION }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"target\": \"${{ env.TARGET }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"subtarget\": \"${{ env.SUBTARGET }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"compiler_prefix\": \"${{ env.PREFIX }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"gcc_version\": \"$FINAL_GCC_VERSION\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"binutils_version\": \"${{ env.BINUTILS_VERSION }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"linux_version\": \"${{ env.LINUX_VERSION }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"openwrt_version\": \"${{ env.OPENWRT_VERSION }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"cpu_type\": \"${{ env.CPU_TYPE }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"tune\": \"${{ env.TUNE }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"abi\": \"${{ env.ABI }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"float_abi\": \"${{ env.FLOAT_ABI }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"build_date\": \"$(date -Iseconds)\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"workflow_run\": \"${{ github.run_id }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"build_id\": \"${{ env.BUILD_ID }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"target_triplet\": \"${{ env.TARGET_TRIPLET }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"actual_gcc_version\": \"$FINAL_GCC_VERSION\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"configured_gcc_version\": \"${{ env.GCC_VERSION }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"version_match\": \"${{ env.VERSION_MATCH == 'true' && 'yes' || 'no' }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"status\": \"${{ env.BUILD_COMPLETE == 'true' && 'complete' || 'partial' }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"dir_renamed\": \"${{ env.DIR_RENAMED == 'true' && 'yes' || 'no' }}\"," >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "  \"notes\": \"目录根据实际GCC版本 ($FINAL_GCC_VERSION) 命名，配置版本为 ${{ env.GCC_VERSION }}\"" >> "$FINAL_OUTPUT_DIR/metadata.json"
          echo "}" >> "$FINAL_OUTPUT_DIR/metadata.json"
          
          TOTAL_SIZE=$(du -sh "$FINAL_OUTPUT_DIR" | cut -f1)
          FILE_COUNT=$(find "$FINAL_OUTPUT_DIR" -type f | wc -l)
          
          echo "📊 最终成果统计:"
          echo "- 输出目录: $FINAL_OUTPUT_DIR"
          echo "- 总大小: $TOTAL_SIZE"
          echo "- 文件数量: $FILE_COUNT"
          echo "- 架构: ${{ env.ARCH_DIR }}"
          echo "- C库: ${{ env.LIBC_DIR }}"
          echo "- 实际GCC版本: $FINAL_GCC_VERSION"
          echo "- 配置GCC版本: ${{ env.GCC_VERSION }}"
          echo "- 版本匹配: ${{ env.VERSION_MATCH == 'true' && '是' || '否' }}"
          echo "- 目录重命名: ${{ env.DIR_RENAMED == 'true' && '是' || '否' }}"
          echo "- 构建状态: ${{ env.BUILD_COMPLETE == 'true' && '完成' || '部分完成' }}"
          
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          echo "FINAL_OUTPUT_DIR=$FINAL_OUTPUT_DIR" >> $GITHUB_ENV
          echo "FINAL_GCC_VERSION=$FINAL_GCC_VERSION" >> $GITHUB_ENV
          
          echo "✅ 编译器保存完成"
          echo "结束时间: $(date)"

      - name: 📤 提交到Git仓库
        if: env.TOOLCHAIN_DIR != ''
        run: |
          echo "=== 提交编译器到Git仓库 ==="
          echo "开始时间: $(date)"
          cd "${{ github.workspace }}"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git config pull.rebase false
          
          git pull origin main --no-edit
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          
          if ! git diff --cached --quiet; then
            git commit -m "build(compiler): 添加 ${{ env.ARCH_DIR }}-${{ env.LIBC_DIR }} 交叉编译器" -m "架构: ${{ env.ARCH_DIR }}" -m "C库: ${{ env.LIBC_DIR }} ${{ env.LIBC_VERSION }}" -m "实际GCC: ${{ env.FINAL_GCC_VERSION }}" -m "配置GCC: ${{ env.GCC_VERSION }}" -m "版本匹配: ${{ env.VERSION_MATCH == 'true' && '是' || '否' }}" -m "Binutils: ${{ env.BINUTILS_VERSION }}" -m "大小: ${{ env.TOTAL_SIZE }}" -m "工作流: #${{ github.run_id }}"
            
            if git push origin main; then
              echo "✅ 编译器已成功提交到仓库"
            else
              git pull origin main --rebase
              git push origin main
            fi
          else
            echo "没有变更需要提交"
          fi
          
          echo "结束时间: $(date)"

      - name: 📊 显示最终成果
        if: env.TOOLCHAIN_DIR != ''
        run: |
          echo "========================================"
          echo "          🎉 构建完成报告              "
          echo "========================================"
          
          if [ "${{ env.BUILD_COMPLETE }}" = "true" ]; then
            echo "✅ 交叉编译器构建成功!"
          else
            echo "⚠️ 交叉编译器构建部分完成"
          fi
          
          echo ""
          echo "📊 构建信息:"
          echo "- 架构: ${{ env.ARCH_DIR }} (${{ env.ARCH_NAME }})"
          echo "- C库: ${{ env.LIBC_DIR }} ${{ env.LIBC_VERSION }}"
          echo "- 实际GCC版本: ${{ env.FINAL_GCC_VERSION }}"
          echo "- 配置GCC版本: ${{ env.GCC_VERSION }}"
          echo "- 版本匹配: ${{ env.VERSION_MATCH == 'true' && '✅ 匹配' || '⚠️ 不匹配' }}"
          echo "- Binutils版本: ${{ env.BINUTILS_VERSION }}"
          echo "- Linux内核: ${{ env.LINUX_VERSION }}"
          echo "- 编译器前缀: ${{ env.PREFIX }}-"
          echo "- 目标平台: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "- 目标三元组: ${{ env.TARGET_TRIPLET }}"
          echo "- 构建状态: ${{ env.BUILD_COMPLETE == 'true' && '完成' || '部分完成' }}"
          echo "- 目录重命名: ${{ env.DIR_RENAMED == 'true' && '✅ 已根据实际版本重命名' || '未重命名' }}"
          echo ""
          echo "📦 成果统计:"
          echo "- 总大小: ${{ env.TOTAL_SIZE }}"
          echo "- 文件数量: ${{ env.FILE_COUNT }}"
          echo "- 输出目录: ${{ env.FINAL_OUTPUT_DIR }}"
          echo ""
          
          if [ "${{ env.BUILD_COMPLETE }}" = "true" ]; then
            echo "🚀 使用方法:"
            echo "cd ${{ env.FINAL_OUTPUT_DIR }}"
            echo "export STAGING_DIR=\$(pwd)"
            echo 'export PATH="$STAGING_DIR/bin:$PATH"'
            echo "${{ env.PREFIX }}-gcc --version"
          else
            echo "⚠️ 注意: 编译器可能不完整"
            echo "建议检查构建日志，可能需要重新构建"
          fi
          
          if [ "${{ env.VERSION_MATCH }}" != "true" ]; then
            echo ""
            echo "⚠️ 版本不匹配说明:"
            echo "- 实际GCC版本: ${{ env.FINAL_GCC_VERSION }}"
            echo "- 配置GCC版本: ${{ env.GCC_VERSION }}"
            echo "- 这可能是OpenWrt构建系统的默认行为"
            echo "- 编译器功能应该正常，但版本号不同"
          fi
          
          echo ""
          echo "⏰ 构建时间: $(date)"
          echo "========================================"

      - name: 📄 上传构建日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.BUILD_ID }}
          path: /tmp/*.log
          retention-days: 30

  skip-build:
    needs: setup
    if: needs.setup.outputs.need_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: ⏭️ 跳过构建
        run: |
          echo "========================================"
          echo "        ⏭️ 跳过构建报告                "
          echo "========================================"
          echo "✅ 编译器已存在且完整，跳过构建"
          echo ""
          echo "📋 跳过原因:"
          echo "- 编译器目录已存在且完整"
          echo "- 版本匹配正确"
          echo "- 未启用强制重新构建"
          echo ""
          echo "🔧 现有编译器信息:"
          echo "- 架构: ${{ github.event.inputs.target_arch }}"
          echo "- C库: ${{ github.event.inputs.libc }}"
          echo "- GCC版本: ${{ needs.setup.outputs.gcc_version }}"
          echo "- Binutils版本: ${{ needs.setup.outputs.binutils_version }}"
          echo ""
          echo "💡 如需重新构建，请启用'强制重新构建'选项"
          echo "========================================"
