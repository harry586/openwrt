# .github/workflows/compiler-build.yml
name: ğŸ” ç¼–è¯‘å™¨æ„å»ºï¼ˆ/mntç‰ˆæœ¬ï¼‰

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

env:
  # ä½¿ç”¨ /mnt ä½œä¸ºæ„å»ºç›®å½•
  BUILD_DIR: "/mnt/compiler-build-$(date +%s)"
  COMPILER_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compiled"

jobs:
  build-compiler:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
      # 1. æ£€å‡ºä»“åº“
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
      
      # 2. è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
      - name: ğŸ” è®¾ç½®ç‰ˆæœ¬
        run: |
          echo "=== ç¼–è¯‘å™¨ç‰ˆæœ¬é…ç½® ==="
          
          # ä½¿ç”¨OpenWrt 23.05å…¼å®¹çš„ç¨³å®šç‰ˆæœ¬
          echo "GCC_VERSION=11.3.0" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=2.38" >> $GITHUB_ENV
          echo "LINUX_VERSION=5.15.133" >> $GITHUB_ENV
          echo "MUSL_VERSION=1.2.4" >> $GITHUB_ENV
          
          echo "ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯:"
          echo "â”œâ”€ GCC: 11.3.0"
          echo "â”œâ”€ Binutils: 2.38"
          echo "â”œâ”€ Linux Kernel: 5.15.133"
          echo "â””â”€ Musl: 1.2.4"
      
      # 3. æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºä¿¡æ¯
        run: |
          echo "=== æ„å»ºé…ç½®ä¿¡æ¯ ==="
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          echo "ç¼–è¯‘å™¨è¾“å‡º: ${{ env.COMPILER_DIR }}"
          echo ""
          echo "ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯:"
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "ç”¨æˆ·ID: $(id -u)"
          echo "ç»„ID: $(id -g)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "CPU: $(nproc) æ ¸å¿ƒ"
          echo "å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "/mnt ç£ç›˜ä¿¡æ¯:"
          df -h /mnt || echo "æ— æ³•è®¿é—® /mnt"
          echo ""
          echo "ğŸ“… å¼€å§‹æ—¶é—´: $(date)"
      
      # 4. å‡†å¤‡ç¯å¢ƒï¼ˆä½¿ç”¨ /mntï¼‰
      - name: ğŸ—ï¸ å‡†å¤‡ç¯å¢ƒ
        run: |
          echo "=== å‡†å¤‡æ„å»ºç¯å¢ƒï¼ˆä½¿ç”¨ /mntï¼‰ ==="
          
          echo "[1/7] æ£€æŸ¥ /mnt çŠ¶æ€..."
          # æ£€æŸ¥ /mnt æ˜¯å¦å­˜åœ¨
          if [ ! -d "/mnt" ]; then
            echo "âš ï¸  /mnt ç›®å½•ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º..."
            sudo mkdir -p /mnt
            sudo chmod 755 /mnt
          fi
          
          echo "/mnt æƒé™:"
          ls -ld /mnt || echo "æ— æ³•è®¿é—® /mnt"
          
          echo "[2/7] æ£€æŸ¥ /mnt å¯ç”¨ç©ºé—´..."
          df -h /mnt 2>/dev/null || echo "æ— æ³•è·å– /mnt ç£ç›˜ä¿¡æ¯"
          
          echo "[3/7] åˆ›å»ºæ„å»ºç›®å½•..."
          # åˆ›å»ºæ„å»ºç›®å½•å¹¶è®¾ç½®æƒé™
          echo "åˆ›å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          sudo mkdir -p "${{ env.BUILD_DIR }}"
          
          echo "[4/7] è®¾ç½®ç›®å½•æƒé™..."
          # è®¾ç½®æ­£ç¡®çš„æ‰€æœ‰æƒå’Œæƒé™
          sudo chown -R $USER:$USER "${{ env.BUILD_DIR }}"
          sudo chmod 755 "${{ env.BUILD_DIR }}"
          
          echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ: ${{ env.BUILD_DIR }}"
          echo "ç›®å½•æƒé™:"
          ls -ld "${{ env.BUILD_DIR }}"
          
          echo "[5/7] è¿›å…¥æ„å»ºç›®å½•..."
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          echo "[6/7] å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo apt-get update
          
          # å®‰è£…å¿…éœ€çš„å·¥å…·
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            gcc g++ make \
            flex bison \
            libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
            texinfo texlive \
            ncurses-dev libncursesw5-dev \
            python3 python3-dev \
            git wget curl ca-certificates \
            zlib1g-dev liblzma-dev \
            file pkg-config \
            gawk gettext automake autoconf libtool 2>&1 | tee /tmp/deps-install.log
          
          echo "[7/7] éªŒè¯å·¥å…·å’Œæƒé™..."
          echo "å…³é”®å·¥å…·æ£€æŸ¥:"
          for tool in gcc g++ make flex bison python3 git wget; do
            if command -v $tool >/dev/null; then
              version=$($tool --version 2>&1 | head -1)
              echo "  âœ… $tool: $(echo $version | cut -c1-40)"
            else
              echo "  âŒ $tool: æœªæ‰¾åˆ°"
            fi
          done
          
          echo "ç›®å½•æƒé™éªŒè¯:"
          touch test-write.txt && echo "âœ… å¯å†™å…¥" && rm test-write.txt
          mkdir test-dir && echo "âœ… å¯åˆ›å»ºç›®å½•" && rmdir test-dir
          
          echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
      
      # 5. è·å–æºç 
      - name: ğŸ“¥ è·å–æºç 
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          
          echo "[1/4] æ¸…ç†æ—§å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰..."
          # ç¡®ä¿ç›®å½•æ˜¯å¹²å‡€çš„
          rm -rf ./* ./.git* 2>/dev/null || true
          echo "æ¸…ç†åç›®å½•:"
          ls -la
          
          echo "[2/4] å…‹éš†OpenWrtæºç ..."
          # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
          git clone --depth 1 --branch v23.05.2 https://github.com/openwrt/openwrt.git . 2>&1 | tee /tmp/clone.log
          
          echo "[3/4] æ˜¾ç¤ºæºç ä¿¡æ¯..."
          echo "åˆ†æ”¯: $(git branch --show-current 2>/dev/null || echo 'æœªçŸ¥')"
          echo "æäº¤: $(git log -1 --format='%h - %s' 2>/dev/null || echo 'æœªçŸ¥')"
          
          if [ -f "version.txt" ]; then
            echo "ç‰ˆæœ¬: $(cat version.txt)"
          else
            echo "ç‰ˆæœ¬: æœªçŸ¥ (ä½¿ç”¨é»˜è®¤é…ç½®)"
          fi
          
          echo "[4/4] åˆ›å»ºç¼–è¯‘å™¨é…ç½®..."
          # åˆ›å»ºæœ€å°åŒ–é…ç½®ï¼Œåªæ„å»ºç¼–è¯‘å™¨
          cat > .config << 'EOF'
          # OpenWrt äº¤å‰ç¼–è¯‘å™¨æ„å»ºé…ç½®
          # ç”Ÿæˆæ—¶é—´: $(date)
          
          # ç›®æ ‡å¹³å°ï¼ˆä½¿ç”¨é€šç”¨çš„ARM64ï¼‰
          CONFIG_TARGET_armsr=y
          CONFIG_TARGET_armsr_armv8=y
          CONFIG_TARGET_ROOTFS_INITRAMFS=y
          
          # ç¼–è¯‘å™¨é…ç½®
          CONFIG_EXTERNAL_TOOLCHAIN=n
          CONFIG_USE_MUSL=y
          CONFIG_BUILD_TOOLCHAIN=y
          
          # ç‰ˆæœ¬é…ç½®
          CONFIG_GCC_VERSION="11.3.0"
          CONFIG_BINUTILS_VERSION="2.38"
          CONFIG_LINUX_VERSION="5.15.133"
          CONFIG_MUSL_VERSION="1.2.4"
          
          # ç¦ç”¨æ‰€æœ‰åŒ…ï¼Œåªæ„å»ºç¼–è¯‘å™¨
          CONFIG_PACKAGE_busybox=n
          CONFIG_PACKAGE_dnsmasq=n
          CONFIG_PACKAGE_firewall=n
          CONFIG_PACKAGE_luci=n
          CONFIG_PACKAGE_wpad=n
          CONFIG_PACKAGE_opkg=n
          CONFIG_PACKAGE_procd=n
          CONFIG_PACKAGE_ubus=n
          CONFIG_PACKAGE_uci=n
          EOF
          
          echo "âœ… æºç é…ç½®å®Œæˆ"
          echo "é…ç½®æ‘˜è¦:"
          grep -E "CONFIG_(TARGET|GCC|BINUTILS|LINUX|MUSL)" .config | head -10
          echo "é…ç½®æ–‡ä»¶å¤§å°: $(wc -l < .config) è¡Œ"
      
      # 6. è¯¦ç»†ç¼–è¯‘è¿‡ç¨‹
      - name: ğŸ”¨ è¯¦ç»†ç¼–è¯‘
        timeout-minutes: 180
        run: |
          echo "=== å¼€å§‹è¯¦ç»†ç¼–è¯‘è¿‡ç¨‹ ==="
          cd "${{ env.BUILD_DIR }}"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "ç£ç›˜ä¿¡æ¯:"
          df -h .
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # è®¾ç½®è¯¦ç»†è¾“å‡º
          export V=sc
          export TERM=dumb
          export TERMINFO=/usr/share/terminfo
          export FORCE_UNSAFE_CONFIGURE=1
          
          # å¯åŠ¨å®æ—¶è¿›åº¦ç›‘æ§
          echo "[ç›‘æ§] å¯åŠ¨å®æ—¶ç¼–è¯‘ç›‘æ§..."
          (
            interval=15  # ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰
            echo "æ—¶é—´æˆ³,æ­¥éª¤,å†…å­˜ä½¿ç”¨(MB),CPUè´Ÿè½½(%),ç£ç›˜å¯ç”¨(GB),ç¼–è¯‘è¿›ç¨‹æ•°,å½“å‰æ–‡ä»¶" > /tmp/compile-monitor.csv
            
            step_count=0
            while true; do
              # è·å–ç³»ç»ŸçŠ¶æ€
              timestamp=$(date '+%H:%M:%S')
              mem_used=$(free -m | grep Mem | awk '{print $3}')
              cpu_load=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
              disk_free_gb=$(df -BG . | tail -1 | awk '{print $4}' | sed 's/G//')
              process_count=$(ps aux | grep -E "(gcc|g\+\+|make|ld|as|ar|strip|objcopy)" | grep -v grep | wc -l)
              
              # å°è¯•è·å–å½“å‰ç¼–è¯‘çš„æ–‡ä»¶
              current_file=""
              if [ -d "build_dir" ]; then
                current_file=$(find build_dir -name "*.c" -o -name "*.cc" -o -name "*.cpp" 2>/dev/null | tail -1)
                if [ -n "$current_file" ]; then
                  current_file=$(basename "$current_file")
                fi
              fi
              
              # ç¡®å®šå½“å‰æ­¥éª¤
              current_step="æœªçŸ¥"
              if [ $process_count -eq 0 ]; then
                current_step="ç©ºé—²"
              elif ps aux | grep -q "binutils"; then
                current_step="ç¼–è¯‘binutils"
              elif ps aux | grep -q "gcc.*stage1"; then
                current_step="gccåˆå§‹é˜¶æ®µ"
              elif ps aux | grep -q "musl"; then
                current_step="ç¼–è¯‘musl"
              elif ps aux | grep -q "gcc"; then
                current_step="ç¼–è¯‘gcc"
              else
                current_step="ç¼–è¯‘ä¸­"
              fi
              
              # è®°å½•åˆ°CSV
              echo "$timestamp,$current_step,$mem_used,$cpu_load,$disk_free_gb,$process_count,$current_file" >> /tmp/compile-monitor.csv
              
              # æ¯5æ¬¡è¾“å‡ºä¸€æ¬¡çŠ¶æ€åˆ°æ§åˆ¶å°
              if [ $((step_count % 5)) -eq 0 ]; then
                echo ""
                echo "ğŸ“ˆ å®æ—¶ç›‘æ§ - $timestamp"
                echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                echo "å½“å‰æ­¥éª¤: $current_step"
                echo "å†…å­˜ä½¿ç”¨: ${mem_used}MB"
                echo "CPUè´Ÿè½½: ${cpu_load}%"
                echo "ç£ç›˜å¯ç”¨: ${disk_free_gb}GB"
                echo "ç¼–è¯‘è¿›ç¨‹: ${process_count} ä¸ª"
                if [ -n "$current_file" ]; then
                  echo "å½“å‰æ–‡ä»¶: $current_file"
                fi
                
                # æ˜¾ç¤ºå‰3ä¸ªç¼–è¯‘è¿›ç¨‹
                if [ $process_count -gt 0 ]; then
                  echo "è¿è¡Œè¿›ç¨‹:"
                  ps aux | grep -E "(gcc|g\+\+|make)" | grep -v grep | awk '{print $11}' | sort | uniq -c | head -3
                fi
                
                # æ˜¾ç¤ºæ„å»ºè¿›åº¦
                if [ -d "build_dir" ]; then
                  echo "æ„å»ºç»Ÿè®¡:"
                  echo "  .oæ–‡ä»¶: $(find build_dir -name "*.o" 2>/dev/null | wc -l)"
                  echo "  .aæ–‡ä»¶: $(find build_dir -name "*.a" 2>/dev/null | wc -l)"
                fi
              fi
              
              step_count=$((step_count + 1))
              sleep $interval
            done
          ) &
          MONITOR_PID=$!
          
          # å‡½æ•°ï¼šè¿è¡Œç¼–è¯‘æ­¥éª¤å¹¶è¯¦ç»†è®°å½•
          run_compile_step() {
            local step_num=$1
            local step_name=$2
            local make_cmd=$3
            local timeout_min=$4
            
            local log_file="/tmp/step-${step_num}-${step_name// /-}.log"
            local start_time=$(date +%s)
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸš€ æ­¥éª¤ $step_num: $step_name"
            echo "å¼€å§‹æ—¶é—´: $(date)"
            echo "å‘½ä»¤: $make_cmd"
            echo "è¶…æ—¶: ${timeout_min}åˆ†é’Ÿ"
            echo "æ—¥å¿—æ–‡ä»¶: $log_file"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # æ‰§è¡Œç¼–è¯‘
            timeout ${timeout_min}m bash -c "$make_cmd" 2>&1 | tee "$log_file"
            local exit_code=${PIPESTATUS[0]}
            
            local end_time=$(date +%s)
            local duration=$((end_time - start_time))
            local duration_min=$((duration / 60))
            local duration_sec=$((duration % 60))
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“Š æ­¥éª¤ $step_num å®Œæˆ"
            echo "ç»“æŸæ—¶é—´: $(date)"
            echo "è€—æ—¶: ${duration_min}åˆ†${duration_sec}ç§’"
            echo "é€€å‡ºç : $exit_code"
            
            if [ $exit_code -eq 0 ]; then
              echo "âœ… $step_name - æˆåŠŸ"
              
              # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
              echo "æ—¥å¿—å¤§å°: $(wc -l < "$log_file") è¡Œ"
              echo "æœ€åè¾“å‡º:"
              tail -5 "$log_file" | sed 's/^/  /'
              
              # ç‰¹å®šæ­¥éª¤çš„é¢å¤–ä¿¡æ¯
              case $step_name in
                *ä¸‹è½½*)
                  echo "ä¸‹è½½ç»Ÿè®¡:"
                  echo "  dlç›®å½•: $(find dl -type f 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶"
                  echo "  æ€»å¤§å°: $(du -sh dl 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
                  ;;
                *binutils*)
                  echo "binutilsæ–‡ä»¶:"
                  find build_dir -path "*binutils*" -name "*.a" 2>/dev/null | head -3 | xargs -I{} echo "  - {}"
                  ;;
                *gcc*)
                  echo "gccæ–‡ä»¶:"
                  find build_dir -path "*gcc*" -name "*.o" 2>/dev/null | head -3 | wc -l | xargs echo "  .oæ–‡ä»¶æ•°: "
                  ;;
              esac
              
              return 0
              
            elif [ $exit_code -eq 124 ]; then
              echo "â±ï¸  $step_name - è¶…æ—¶ (${timeout_min}åˆ†é’Ÿ)"
              echo "æœ€å50è¡Œæ—¥å¿—:"
              tail -50 "$log_file" | sed 's/^/  /'
              
              # åœæ­¢ç›‘æ§
              kill $MONITOR_PID 2>/dev/null || true
              return 1
              
            else
              echo "âŒ $step_name - å¤±è´¥ (é€€å‡ºç : $exit_code)"
              echo "é”™è¯¯æ‘˜è¦:"
              grep -i "error\|failed\|undefined\|missing" "$log_file" | tail -20 | sed 's/^/  /'
              echo ""
              echo "æœ€å50è¡Œå®Œæ•´æ—¥å¿—:"
              tail -50 "$log_file" | sed 's/^/  /'
              
              # åœæ­¢ç›‘æ§
              kill $MONITOR_PID 2>/dev/null || true
              return 1
            fi
          }
          
          # æ­¥éª¤1: ä¸‹è½½ä¾èµ–
          run_compile_step 1 "ä¸‹è½½ä¾èµ–åŒ…" "make -j$(nproc) download V=sc" 30 || exit 1
          
          # æ­¥éª¤2: é…ç½®
          run_compile_step 2 "é…ç½®ç¯å¢ƒ" "make defconfig V=sc" 5 || exit 1
          
          # æ˜¾ç¤ºé…ç½®ç»“æœ
          echo "é…ç½®ç»“æœæ‘˜è¦:"
          echo "å¯ç”¨çš„é€‰é¡¹:"
          grep "^CONFIG_[A-Z]" .config | head -15
          echo "é…ç½®æ–‡ä»¶æ€»æ•°: $(grep "^CONFIG_" .config | wc -l) ä¸ª"
          
          # æ­¥éª¤3: ç¼–è¯‘binutils
          run_compile_step 3 "ç¼–è¯‘binutils" "make toolchain/binutils/compile -j1 V=sc" 60 || exit 1
          
          # æ­¥éª¤4: ç¼–è¯‘gccåˆå§‹é˜¶æ®µ
          run_compile_step 4 "ç¼–è¯‘gccåˆå§‹é˜¶æ®µ" "make toolchain/gcc/compile -j1 V=sc" 60 || exit 1
          
          # æ­¥éª¤5: ç¼–è¯‘musl
          run_compile_step 5 "ç¼–è¯‘musl" "make toolchain/musl/compile -j1 V=sc" 45 || exit 1
          
          # æ­¥éª¤6: ç¼–è¯‘å®Œæ•´gcc
          run_compile_step 6 "ç¼–è¯‘å®Œæ•´gcc" "make toolchain/gcc/compile -j1 V=sc" 90 || exit 1
          
          # æ­¥éª¤7: å®‰è£…ç¼–è¯‘å™¨
          run_compile_step 7 "å®‰è£…ç¼–è¯‘å™¨" "make toolchain/install -j1 V=sc" 30 || exit 1
          
          # åœæ­¢ç›‘æ§
          kill $MONITOR_PID 2>/dev/null || true
          
          echo ""
          echo "ğŸ‰ ğŸ‰ ğŸ‰ æ‰€æœ‰ç¼–è¯‘æ­¥éª¤æˆåŠŸå®Œæˆï¼"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "æ€»ç»Ÿè®¡ä¿¡æ¯:"
          echo "å¼€å§‹æ—¶é—´: $(grep 'å¼€å§‹æ—¶é—´' /tmp/step-1-*.log | head -1 | cut -d: -f2-)"
          echo "ç»“æŸæ—¶é—´: $(date)"
          echo "æ€»æ–‡ä»¶æ•°: $(find . -type f 2>/dev/null | wc -l)"
          echo "æ€»ç›®å½•å¤§å°: $(du -sh . | cut -f1)"
          
          # æ˜¾ç¤ºç›‘æ§æ‘˜è¦
          if [ -f "/tmp/compile-monitor.csv" ]; then
            echo "ç›‘æ§è®°å½•: $(wc -l < /tmp/compile-monitor.csv) æ¡"
            echo "æœ€å5æ¡ç›‘æ§è®°å½•:"
            tail -5 /tmp/compile-monitor.csv | while read line; do
              echo "  $line"
            done
          fi
      
      # 7. éªŒè¯ç¼–è¯‘ç»“æœ
      - name: âœ… éªŒè¯ç»“æœ
        run: |
          echo "=== éªŒè¯ç¼–è¯‘ç»“æœ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "[1/5] æŸ¥æ‰¾ç¼–è¯‘å™¨ç›®å½•..."
          # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ç¼–è¯‘å™¨ç›®å½•
          find staging_dir -type d -name "toolchain-*" 2>/dev/null | while read dir; do
            echo "æ‰¾åˆ°: $dir ($(du -sh "$dir" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥'))"
          done
          
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | head -1)
          
          if [ -z "$TOOLCHAIN_DIR" ] || [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ç¼–è¯‘å™¨ç›®å½•"
            echo "æœç´¢è·¯å¾„: staging_dir/toolchain-*"
            echo "staging_dir å†…å®¹:"
            ls -la staging_dir/ 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
            echo "å°è¯•æŸ¥æ‰¾æ‰€æœ‰åŒ…å«ç¼–è¯‘å™¨çš„ç›®å½•:"
            find . -name "*gcc*" -type f 2>/dev/null | head -10
            exit 1
          fi
          
          echo "âœ… ç¼–è¯‘å™¨ç›®å½•: $TOOLCHAIN_DIR"
          echo "ç›®å½•å¤§å°: $(du -sh "$TOOLCHAIN_DIR" 2>/dev/null | cut -f1)"
          
          echo "[2/5] æ£€æŸ¥å…³é”®æ–‡ä»¶..."
          # æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶
          declare -A REQUIRED_FILES=(
            ["ç¼–è¯‘å™¨"]="*-gcc"
            ["C++ç¼–è¯‘å™¨"]="*-g++"
            ["é“¾æ¥å™¨"]="*-ld"
            ["å½’æ¡£å·¥å…·"]="*-ar"
            ["ç¬¦å·å‰¥ç¦»"]="*-strip"
            ["ç›®æ ‡å¤åˆ¶"]="*-objcopy"
            ["å¤§å°æŸ¥çœ‹"]="*-size"
          )
          
          missing_files=()
          for desc in "${!REQUIRED_FILES[@]}"; do
            pattern="${REQUIRED_FILES[$desc]}"
            file=$(find "$TOOLCHAIN_DIR" -name "$pattern" -type f 2>/dev/null | head -1)
            
            if [ -n "$file" ]; then
              size=$(stat -c%s "$file" 2>/dev/null | numfmt --to=iec || echo '?')
              if [ -x "$file" ]; then
                echo "âœ… $desc: $(basename "$file") (${size}B, å¯æ‰§è¡Œ)"
              else
                echo "âš ï¸  $desc: $(basename "$file") (${size}B, ä¸å¯æ‰§è¡Œ)"
              fi
            else
              echo "âŒ $desc: æœªæ‰¾åˆ°"
              missing_files+=("$desc")
            fi
          done
          
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "âš ï¸  è­¦å‘Š: ç¼ºå¤± ${#missing_files[@]} ä¸ªå…³é”®æ–‡ä»¶: ${missing_files[*]}"
          else
            echo "ğŸ‰ æ‰€æœ‰å…³é”®æ–‡ä»¶éƒ½å­˜åœ¨"
          fi
          
          echo "[3/5] æµ‹è¯•ç¼–è¯‘å™¨..."
          GCC_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
          
          if [ -n "$GCC_PATH" ] && [ -x "$GCC_PATH" ]; then
            echo "ğŸ”§ æµ‹è¯•ç¼–è¯‘å™¨: $GCC_PATH"
            echo "ç‰ˆæœ¬ä¿¡æ¯:"
            $GCC_PATH --version 2>&1 | head -3 | sed 's/^/  /'
            
            # ç®€å•ç¼–è¯‘æµ‹è¯•
            echo "ç¼–è¯‘æµ‹è¯•ç¨‹åº..."
            cat > /tmp/cross-test.c << 'EOF'
            #include <stdio.h>
            #include <stdlib.h>
            
            int main() {
                printf("Cross-compiler test successful!\n");
                printf("Compiler: %s\n", __VERSION__);
                return EXIT_SUCCESS;
            }
            EOF
            
            if $GCC_PATH /tmp/cross-test.c -o /tmp/cross-test-output 2>/tmp/compile-test.log; then
              echo "âœ… ç¼–è¯‘æµ‹è¯•é€šè¿‡"
              echo "è¾“å‡ºæ–‡ä»¶ä¿¡æ¯:"
              file /tmp/cross-test-output 2>/dev/null || echo "æ— æ³•è¯†åˆ«æ–‡ä»¶ç±»å‹"
            else
              echo "âš ï¸ ç¼–è¯‘æµ‹è¯•å¤±è´¥"
              echo "é”™è¯¯ä¿¡æ¯:"
              cat /tmp/compile-test.log
            fi
            
            rm -f /tmp/cross-test.c /tmp/cross-test-output /tmp/compile-test.log 2>/dev/null
          else
            echo "âŒ æ— æ³•æ‰¾åˆ°å¯ç”¨çš„GCCç¼–è¯‘å™¨"
            echo "binç›®å½•å†…å®¹:"
            ls -la "$TOOLCHAIN_DIR/bin/" 2>/dev/null | head -10
          fi
          
          echo "[4/5] ç»Ÿè®¡ç¼–è¯‘å™¨ä¿¡æ¯..."
          echo "ç¼–è¯‘å™¨ç»Ÿè®¡:"
          echo "æ€»æ–‡ä»¶æ•°: $(find "$TOOLCHAIN_DIR" -type f 2>/dev/null | wc -l)"
          echo "æ€»ç›®å½•æ•°: $(find "$TOOLCHAIN_DIR" -type d 2>/dev/null | wc -l)"
          echo "binç›®å½•: $(find "$TOOLCHAIN_DIR/bin" -type f 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶"
          echo "libç›®å½•: $(find "$TOOLCHAIN_DIR/lib" -type f 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶"
          echo "includeç›®å½•: $(find "$TOOLCHAIN_DIR/include" -type f 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶"
          
          echo "[5/5] æ˜¾ç¤ºç¼–è¯‘å™¨ç»“æ„..."
          echo "ç¼–è¯‘å™¨é¡¶å±‚ç»“æ„:"
          ls -la "$TOOLCHAIN_DIR/" | head -10
          
          echo "âœ… éªŒè¯å®Œæˆ"
      
      # 8. ä¿å­˜åˆ°ä»“åº“
      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨åˆ°ä»“åº“ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # æŸ¥æ‰¾ç¼–è¯‘å™¨
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | head -1)
          
          if [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ é”™è¯¯: ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "[1/5] å‡†å¤‡è¾“å‡ºç›®å½•..."
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p "${{ env.COMPILER_DIR }}"
          
          # æ¸…ç©ºè¾“å‡ºç›®å½•
          if [ -d "${{ env.COMPILER_DIR }}" ]; then
            echo "æ¸…ç©ºè¾“å‡ºç›®å½•..."
            rm -rf "${{ env.COMPILER_DIR }}"/* 2>/dev/null || true
          fi
          
          echo "[2/5] å¤åˆ¶ç¼–è¯‘å™¨æ–‡ä»¶..."
          # å¤åˆ¶æ•´ä¸ªç¼–è¯‘å™¨
          cp -r "$TOOLCHAIN_DIR"/* "${{ env.COMPILER_DIR }}/" 2>&1 | tee /tmp/copy.log
          
          echo "[3/5] åˆ›å»ºæ„å»ºä¿¡æ¯..."
          # åˆ›å»ºè¯¦ç»†çš„æ„å»ºä¿¡æ¯æ–‡ä»¶
          cat > "${{ env.COMPILER_DIR }}/BUILD-INFO.txt" << EOF
          ========================================
          OpenWrt äº¤å‰ç¼–è¯‘å™¨ - è‡ªåŠ¨æ„å»º
          ========================================
          
          æ„å»ºæ—¶é—´: $(date)
          å·¥ä½œæµ: ${{ github.workflow }}
          è¿è¡ŒID: ${{ github.run_id }}
          æäº¤: ${{ github.sha }}
          
          =========== ç‰ˆæœ¬ä¿¡æ¯ ===========
          GCC: 11.3.0
          Binutils: 2.38
          Linuxå†…æ ¸: 5.15.133
          Musl: 1.2.4
          
          =========== ç¼–è¯‘å™¨ä¿¡æ¯ ===========
          ç›®æ ‡æ¶æ„: arm-openwrt-linux-muslgnueabi
          Cåº“: musl
          å­—èŠ‚åº: å°ç«¯ (little-endian)
          ABI: EABI
          æµ®ç‚¹: hard-float (å¦‚æœæ”¯æŒ)
          
          =========== æ–‡ä»¶ç»Ÿè®¡ ===========
          æ€»æ–‡ä»¶æ•°: $(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)
          æ€»å¤§å°: $(du -sh "${{ env.COMPILER_DIR }}" 2>/dev/null | cut -f1)
          
          =========== ä½¿ç”¨æ–¹æ³• ===========
          åœ¨OpenWrtæ„å»ºç¯å¢ƒä¸­:
          
          1. è®¾ç½®ç¯å¢ƒå˜é‡:
             export STAGING_DIR=/path/to/this/compiler
             make
          
          2. æˆ–è€…åœ¨makeå‘½ä»¤ä¸­ç›´æ¥æŒ‡å®š:
             make STAGING_DIR=/path/to/this/compiler
          
          =========== ä¸»è¦å·¥å…· ===========
          bin/arm-openwrt-linux-muslgnueabi-gcc      # Cç¼–è¯‘å™¨
          bin/arm-openwrt-linux-muslgnueabi-g++      # C++ç¼–è¯‘å™¨
          bin/arm-openwrt-linux-muslgnueabi-ld       # é“¾æ¥å™¨
          bin/arm-openwrt-linux-muslgnueabi-ar       # é™æ€åº“å·¥å…·
          bin/arm-openwrt-linux-muslgnueabi-strip    # ç¬¦å·å‰¥ç¦»
          bin/arm-openwrt-linux-muslgnueabi-objcopy  # ç›®æ ‡æ–‡ä»¶å¤åˆ¶
          bin/arm-openwrt-linux-muslgnueabi-size     # æ®µå¤§å°æŸ¥çœ‹
          bin/arm-openwrt-linux-muslgnueabi-readelf  # ELFæ–‡ä»¶æŸ¥çœ‹
          bin/arm-openwrt-linux-muslgnueabi-nm       # ç¬¦å·è¡¨æŸ¥çœ‹
          
          ========================================
          æ­¤æ–‡ä»¶ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ
          ========================================
          EOF
          
          echo "[4/5] éªŒè¯å¤åˆ¶ç»“æœ..."
          echo "è¾“å‡ºç›®å½•: ${{ env.COMPILER_DIR }}"
          echo "å¤§å°: $(du -sh "${{ env.COMPILER_DIR }}" 2>/dev/null | cut -f1)"
          echo "æ–‡ä»¶æ•°: $(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)"
          
          # æ˜¾ç¤ºä¸€äº›å…³é”®æ–‡ä»¶
          echo "å…³é”®æ–‡ä»¶ç¤ºä¾‹:"
          find "${{ env.COMPILER_DIR }}/bin" -type f -name "*gcc" -o -name "*g++" -o -name "*ld" 2>/dev/null | head -5 | while read file; do
            echo "  - $(basename "$file") ($(stat -c%s "$file" 2>/dev/null | numfmt --to=iec)B)"
          done
          
          echo "[5/5] æœ€ç»ˆæµ‹è¯•..."
          # æµ‹è¯•ç¼–è¯‘å™¨æ˜¯å¦å¯æ‰§è¡Œ
          TEST_GCC=$(find "${{ env.COMPILER_DIR }}/bin" -name "*gcc" -type f 2>/dev/null | head -1)
          if [ -n "$TEST_GCC" ] && [ -x "$TEST_GCC" ]; then
            echo "âœ… ç¼–è¯‘å™¨æµ‹è¯•:"
            $TEST_GCC --version 2>&1 | head -1
          else
            echo "âš ï¸  è­¦å‘Š: ç¼–è¯‘å™¨ä¸å¯æ‰§è¡Œ"
          fi
          
          echo "âœ… ä¿å­˜å®Œæˆ"
      
      # 9. æäº¤åˆ°ä»“åº“
      - name: ğŸ“¤ æäº¤æ›´æ–°
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°ä»“åº“ ==="
          
          cd "${{ github.workspace }}"
          
          # é…ç½®Git
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          
          echo "[1/4] æ£€æŸ¥å˜æ›´..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ç¼–è¯‘å™¨æ–‡ä»¶
          if [ -d "${{ env.COMPILER_DIR }}" ] && [ "$(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)" -gt 10 ]; then
            echo "æ£€æµ‹åˆ°æ–°çš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œå‡†å¤‡æäº¤..."
            
            # è·å–ç»Ÿè®¡ä¿¡æ¯
            SIZE=$(du -sh "${{ env.COMPILER_DIR }}" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            FILE_COUNT=$(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)
            DATE_TAG=$(date +%Y%m%d)
            
            echo "[2/4] æ·»åŠ åˆ°Git..."
            # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰æ–‡ä»¶
            git add -f "firmware-config/build-Compiler-file/compiled"
            
            echo "[3/4] æäº¤..."
            git commit -m "build(compiler): è‡ªåŠ¨æ„å»ºäº¤å‰ç¼–è¯‘å™¨ v11.3.0 [$DATE_TAG]

            ğŸ”§ ç‰ˆæœ¬ä¿¡æ¯:
            â€¢ GCC: 11.3.0
            â€¢ Binutils: 2.38
            â€¢ Linuxå†…æ ¸: 5.15.133
            â€¢ Musl: 1.2.4
            
            ğŸ“Š æ„å»ºè¯¦æƒ…:
            â€¢ å¤§å°: $SIZE
            â€¢ æ–‡ä»¶æ•°: $FILE_COUNT
            â€¢ æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
            â€¢ å·¥ä½œæµ: ${{ github.workflow }}
            â€¢ è¿è¡ŒID: #${{ github.run_id }}
            
            ğŸ¯ ç”¨é€”: OpenWrt/ImmortalWrtå›ºä»¶æ„å»º
            ğŸ“ ä½ç½®: firmware-config/build-Compiler-file/compiled/
            
            Signed-off-by: GitHub Actions <actions@github.com>"
            
            echo "[4/4] æ¨é€åˆ°ä»“åº“..."
            if git push; then
              echo "ğŸ‰ ç¼–è¯‘å™¨å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
            else
              echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œä½†æäº¤å·²ä¿å­˜åœ¨æœ¬åœ°"
              echo "å¯ä»¥åœ¨åç»­æ“ä½œä¸­æ‰‹åŠ¨æ¨é€: git push"
            fi
            
          else
            echo "âœ… æ²¡æœ‰è¶³å¤Ÿçš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œè·³è¿‡æäº¤"
            echo "æ–‡ä»¶æ•°: $(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l) ä¸ª"
          fi
      
      # 10. ä¸Šä¼ æ—¥å¿—
      - name: ğŸ“„ ä¸Šä¼ æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compiler-build-data-$(date +%Y%m%d-%H%M%S)
          path: |
            /tmp/*.log
            /tmp/*.csv
            /tmp/step-*.log
            /tmp/compile-*.log
            ${{ env.BUILD_DIR }}/.config
            ${{ env.BUILD_DIR }}/version.txt
            ${{ env.BUILD_DIR }}/build.log
          retention-days: 7
