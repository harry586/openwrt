# .github/workflows/compiler-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      arch_type:
        description: 'æ¶æ„ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options: ['all', 'arm', 'mips', 'x86', 'riscv', 'aarch64']

env:
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"
  BUILD_BASE_DIR: "/mnt/compiler-build"

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      arch_list: ${{ steps.setup-arch.outputs.arch_list }}
      openwrt_version: ${{ steps.version-detection.outputs.openwrt_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      start_time: ${{ steps.get-time.outputs.start_time }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: â° è·å–å¼€å§‹æ—¶é—´
        id: get-time
        run: |
          echo "start_time=$(date)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ è®¾ç½®æ„å»ºç›®å½•æƒé™
        run: |
          echo "=== è®¾ç½®æ„å»ºç›®å½•æƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $USER:$USER /mnt/compiler-build 2>/dev/null || true
          ls -ld /mnt/compiler-build

      - name: ğŸ—ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          mkdir -p "${{ env.BUILD_BASE_DIR }}"
          echo "ç¼–è¯‘å™¨åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "æ„å»ºåŸºç¡€ç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„åˆ—è¡¨
        id: setup-arch
        run: |
          echo "=== è®¾ç½®ç›®æ ‡æ¶æ„åˆ—è¡¨ ==="
          ARCH_TYPE="${{ github.event.inputs.arch_type }}"
          
          case "$ARCH_TYPE" in
            'all')
              ARCH_LIST='["aarch64","x86_64","mips","mipsel","arm_cortex-a7","arm_cortex-a53","riscv64"]'
              echo "âœ… é€‰æ‹©æ‰€æœ‰æ¶æ„ç±»å‹"
              ;;
            'arm')
              ARCH_LIST='["arm_cortex-a7","arm_cortex-a53"]'
              echo "âœ… é€‰æ‹©ARMæ¶æ„"
              ;;
            'mips')
              ARCH_LIST='["mips","mipsel"]'
              echo "âœ… é€‰æ‹©MIPSæ¶æ„"
              ;;
            'x86')
              ARCH_LIST='["x86_64"]'
              echo "âœ… é€‰æ‹©x86æ¶æ„"
              ;;
            'riscv')
              ARCH_LIST='["riscv64"]'
              echo "âœ… é€‰æ‹©RISC-Væ¶æ„"
              ;;
            'aarch64')
              ARCH_LIST='["aarch64"]'
              echo "âœ… é€‰æ‹©AArch64æ¶æ„"
              ;;
            *)
              ARCH_LIST='["aarch64"]'
              echo "âš ï¸ æœªçŸ¥ç±»å‹ï¼Œé»˜è®¤é€‰æ‹©AArch64"
              ;;
          esac
          
          echo "ç›®æ ‡æ¶æ„åˆ—è¡¨: $ARCH_LIST"
          echo "arch_list=$ARCH_LIST" >> $GITHUB_OUTPUT

      - name: ğŸ” ç‰ˆæœ¬æ£€æµ‹
        id: version-detection
        run: |
          echo "=== ç‰ˆæœ¬æ£€æµ‹ ==="
          
          # å›ºå®šä½¿ç”¨OpenWrt 21.02.5
          OPENWRT_VERSION="21.02.5"
          BINUTILS_VERSION="2.36.1"
          LINUX_VERSION="5.4.188"
          MUSL_VERSION="1.2.2"
          
          echo "ğŸ¯ ä½¿ç”¨OpenWrt 21.02.5ç‰ˆæœ¬:"
          echo "- OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          echo "- Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "- Linuxå†…æ ¸: $LINUX_VERSION"
          echo "- Muslç‰ˆæœ¬: $MUSL_VERSION"
          echo "â„¹ï¸ GCCç‰ˆæœ¬å°†ç”±OpenWrtæ ¹æ®æ¶æ„è‡ªåŠ¨é€‰æ‹©"
          
          echo "openwrt_version=$OPENWRT_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT

  build-matrix:
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJSON(needs.setup.outputs.arch_list) }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”§ è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™
        run: |
          echo "=== è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $(whoami):$(whoami) /mnt/compiler-build 2>/dev/null || true
          ls -ld /mnt/compiler-build

      - name: ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨
        run: |
          echo "=== æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ ==="
          ARCH="${{ matrix.arch }}"
          OPENWRT_VERSION='${{ needs.setup.outputs.openwrt_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          
          # æ„å»ºå‰ä¸çŸ¥é“å…·ä½“GCCç‰ˆæœ¬ï¼Œæ£€æŸ¥åŸºç¡€ç›®å½•
          OUTPUT_BASE_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH}/musl/openwrt-${OPENWRT_VERSION}"
          
          echo "æ£€æŸ¥ç›®å½•: $OUTPUT_BASE_DIR"
          
          if [ -d "$OUTPUT_BASE_DIR" ]; then
            # æ£€æŸ¥æ˜¯å¦æœ‰å­ç›®å½•ï¼ˆå®é™…GCCç‰ˆæœ¬ç›®å½•ï¼‰
            SUBDIRS=$(find "$OUTPUT_BASE_DIR" -maxdepth 1 -type d -name "gcc-*" 2>/dev/null | wc -l)
            if [ "$SUBDIRS" -gt 0 ]; then
              echo "âœ… å·²æœ‰æ­¤OpenWrtç‰ˆæœ¬çš„ç¼–è¯‘å™¨ï¼Œè·³è¿‡æ„å»º"
              echo "SKIP_BUILD=true" >> $GITHUB_ENV
            else
              echo "âš ï¸ æœ‰ç›®å½•ä½†æ— ç¼–è¯‘å™¨ï¼Œéœ€è¦æ„å»º"
              echo "SKIP_BUILD=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: â­ï¸ è·³è¿‡æ„å»º
        if: env.SKIP_BUILD == 'true'
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æ„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
          echo "- æ¶æ„: ${{ matrix.arch }}"
          echo "- OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "- åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}/compilers/${{ matrix.arch }}/musl/openwrt-${{ needs.setup.outputs.openwrt_version }}"
          echo "========================================"

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æ¶æ„: ${{ matrix.arch }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "Cåº“ç±»å‹: musl"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„ç¯å¢ƒ
        id: setup-env
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è®¾ç½®æ¶æ„ç¯å¢ƒ ==="
          ARCH="${{ matrix.arch }}"
          
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="ipq40xx"
              SUBTARGET="generic"
              ARCH_NAME="arm"
              PREFIX="arm-openwrt-linux-musl"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              PREFIX="aarch64-openwrt-linux-musl"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64
