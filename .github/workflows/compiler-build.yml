# .github/workflows/compiler-build.yml
name: ðŸ› ï¸ æ™ºèƒ½ç¼–è¯‘å™¨æž„å»ºï¼ˆè‡ªåŠ¨ç‰ˆæœ¬+ä»…æäº¤ç¼–è¯‘å™¨ï¼‰

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥è‡ªåŠ¨æ£€æŸ¥æ›´æ–°

env:
  # åœ¨/mntä¸‹æž„å»º
  BUILD_DIR: "/mnt/compiler-build"
  # ä»“åº“ä¸­çš„ç¼–è¯‘å™¨ç›®å½•
  COMPILER_OUTPUT_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compiled"
  
  # è‡ªåŠ¨èŽ·å–æœ€æ–°ç‰ˆæœ¬çš„URLï¼ˆä¸è¦é€‰æ‹©ï¼Œè‡ªåŠ¨èŽ·å–ï¼‰
  GCC_MIRROR: "https://ftp.gnu.org/gnu/gcc"
  BINUTILS_MIRROR: "https://ftp.gnu.org/gnu/binutils"
  LINUX_MIRROR: "https://cdn.kernel.org/pub/linux/kernel"
  MUSL_MIRROR: "https://musl.libc.org/releases"

jobs:
  build-compiler:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # 3å°æ—¶è¶…æ—¶ï¼ˆç¼–è¯‘æ—¶é—´ï¼‰
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: "1. ðŸ“¥ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥éª¤2: è‡ªåŠ¨èŽ·å–æœ€æ–°ç‰ˆæœ¬å·
      - name: "2. ðŸ” è‡ªåŠ¨èŽ·å–æœ€æ–°ç‰ˆæœ¬"
        run: |
          echo "=== è‡ªåŠ¨èŽ·å–æœ€æ–°ç‰ˆæœ¬ ==="
          
          # 1. èŽ·å–æœ€æ–°çš„GCCç‰ˆæœ¬ï¼ˆèŽ·å–ç¨³å®šç‰ˆæœ¬ï¼‰
          echo "èŽ·å–GCCç‰ˆæœ¬..."
          GCC_LATEST=$(curl -s ${{ env.GCC_MIRROR }} | grep -oP 'gcc-\K[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -1)
          if [ -z "$GCC_LATEST" ]; then
            # å¦‚æžœèŽ·å–å¤±è´¥ï¼Œä½¿ç”¨å·²çŸ¥ç¨³å®šçš„ç‰ˆæœ¬
            GCC_LATEST="11.3.0"
            echo "âš ï¸ æ— æ³•èŽ·å–æœ€æ–°GCCç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤: $GCC_LATEST"
          else
            echo "âœ… èŽ·å–åˆ°æœ€æ–°GCCç‰ˆæœ¬: $GCC_LATEST"
          fi
          
          # 2. èŽ·å–æœ€æ–°çš„Binutilsç‰ˆæœ¬
          echo "èŽ·å–Binutilsç‰ˆæœ¬..."
          BINUTILS_LATEST=$(curl -s ${{ env.BINUTILS_MIRROR }} | grep -oP 'binutils-\K[0-9]+\.[0-9]+(\.[0-9]+)?' | sort -V | tail -1)
          if [ -z "$BINUTILS_LATEST" ]; then
            BINUTILS_LATEST="2.38"
            echo "âš ï¸ æ— æ³•èŽ·å–æœ€æ–°Binutilsç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤: $BINUTILS_LATEST"
          else
            echo "âœ… èŽ·å–åˆ°æœ€æ–°Binutilsç‰ˆæœ¬: $BINUTILS_LATEST"
          fi
          
          # 3. èŽ·å–Linuxå†…æ ¸ç‰ˆæœ¬ï¼ˆä½¿ç”¨5.15 LTSç³»åˆ—çš„æœ€æ–°ç‰ˆï¼‰
          echo "èŽ·å–Linuxå†…æ ¸ç‰ˆæœ¬..."
          LINUX_LATEST=$(curl -s ${{ env.LINUX_MIRROR }}/v5.x/ | grep -oP 'linux-\K5\.15\.[0-9]+' | sort -V | tail -1)
          if [ -z "$LINUX_LATEST" ]; then
            LINUX_LATEST="5.15.133"
            echo "âš ï¸ æ— æ³•èŽ·å–æœ€æ–°Linuxå†…æ ¸ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤: $LINUX_LATEST"
          else
            echo "âœ… èŽ·å–åˆ°æœ€æ–°Linuxå†…æ ¸ç‰ˆæœ¬: $LINUX_LATEST"
          fi
          
          # 4. èŽ·å–Muslç‰ˆæœ¬
          echo "èŽ·å–Muslç‰ˆæœ¬..."
          MUSL_LATEST=$(curl -s ${{ env.MUSL_MIRROR }} | grep -oP 'musl-\K[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -1)
          if [ -z "$MUSL_LATEST" ]; then
            MUSL_LATEST="1.2.4"
            echo "âš ï¸ æ— æ³•èŽ·å–æœ€æ–°Muslç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤: $MUSL_LATEST"
          else
            echo "âœ… èŽ·å–åˆ°æœ€æ–°Muslç‰ˆæœ¬: $MUSL_LATEST"
          fi
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          echo "GCC_VERSION=$GCC_LATEST" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=$BINUTILS_LATEST" >> $GITHUB_ENV
          echo "LINUX_VERSION=$LINUX_LATEST" >> $GITHUB_ENV
          echo "MUSL_VERSION=$MUSL_LATEST" >> $GITHUB_ENV
          
          echo ""
          echo "ðŸ“¦ æœ€ç»ˆé€‰æ‹©çš„ç‰ˆæœ¬:"
          echo "â”œâ”€ GCC: $GCC_LATEST"
          echo "â”œâ”€ Binutils: $BINUTILS_LATEST"
          echo "â”œâ”€ Linux Kernel: $LINUX_LATEST"
          echo "â””â”€ Musl: $MUSL_LATEST"
      
      # æ­¥éª¤3: æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç¼–è¯‘
      - name: "3. ðŸ¤” æ£€æŸ¥æ˜¯å¦éœ€è¦ç¼–è¯‘"
        run: |
          echo "=== æ£€æŸ¥æ˜¯å¦éœ€è¦ç¼–è¯‘ ==="
          
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç¼–è¯‘å™¨
          if [ -d "${{ env.COMPILER_OUTPUT_DIR }}" ]; then
            echo "æ‰¾åˆ°å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨ç›®å½•"
            
            # æ£€æŸ¥ç¼–è¯‘å™¨ç‰ˆæœ¬
            GCC_FILE=$(find "${{ env.COMPILER_OUTPUT_DIR }}" -name "*gcc" -type f 2>/dev/null | head -1)
            if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
              CURRENT_VERSION=$("$GCC_FILE" --version 2>&1 | head -1 | grep -oP '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
              echo "å½“å‰ç¼–è¯‘å™¨ç‰ˆæœ¬: $CURRENT_VERSION"
              echo "æœ€æ–°GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
              
              # æ¯”è¾ƒç‰ˆæœ¬ï¼ˆç®€å•çš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼‰
              if [ "$CURRENT_VERSION" = "${{ env.GCC_VERSION }}" ]; then
                echo "âœ… ç¼–è¯‘å™¨ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ï¼Œè·³è¿‡ç¼–è¯‘"
                echo "NEED_COMPILE=false" >> $GITHUB_ENV
              else
                echo "ðŸ”„ å‘çŽ°æ–°ç‰ˆæœ¬ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
                echo "NEED_COMPILE=true" >> $GITHUB_ENV
              fi
            else
              echo "âš ï¸ å·²å­˜åœ¨çš„ç¼–è¯‘å™¨æ— æ•ˆï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
              echo "NEED_COMPILE=true" >> $GITHUB_ENV
            fi
          else
            echo "ðŸ“¥ æœªæ‰¾åˆ°å·²ç¼–è¯‘çš„ç¼–è¯‘å™¨ï¼Œéœ€è¦ç¼–è¯‘"
            echo "NEED_COMPILE=true" >> $GITHUB_ENV
          fi
      
      # æ­¥éª¤4: å‡†å¤‡æž„å»ºçŽ¯å¢ƒï¼ˆä»…åœ¨éœ€è¦ç¼–è¯‘æ—¶è¿è¡Œï¼‰
      - name: "4. ðŸ”§ å‡†å¤‡æž„å»ºçŽ¯å¢ƒ"
        if: env.NEED_COMPILE == 'true'
        run: |
          echo "=== å‡†å¤‡æž„å»ºçŽ¯å¢ƒ ==="
          
          # å®‰è£…å¿…è¦çš„ä¾èµ–
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc g++ make \
            flex bison \
            libgmp-dev libmpfr-dev libmpc-dev \
            texinfo \
            ncurses-dev \
            git wget curl \
            python3 python3-distutils
          
          # éªŒè¯å®‰è£…
          gcc --version
          make --version
          
          echo "âœ… æž„å»ºçŽ¯å¢ƒå‡†å¤‡å®Œæˆ"
      
      # æ­¥éª¤5: åœ¨/mntä¸‹ç¼–è¯‘ç¼–è¯‘å™¨
      - name: "5. ðŸ› ï¸ åœ¨/mntä¸‹ç¼–è¯‘ç¼–è¯‘å™¨"
        if: env.NEED_COMPILE == 'true'
        timeout-minutes: 150  # 2.5å°æ—¶ç¼–è¯‘æ—¶é—´
        run: |
          echo "=== åœ¨/mntä¸‹ç¼–è¯‘ç¼–è¯‘å™¨ ==="
          
          # åˆ›å»ºæž„å»ºç›®å½•
          sudo mkdir -p "${{ env.BUILD_DIR }}"
          sudo chown -R $USER:$USER "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          
          echo "ðŸ”„ æ­¥éª¤5.1: å…‹éš†OpenWrtæºç "
          
          # å…‹éš†æœ€æ–°çš„OpenWrtæºç ï¼ˆç”¨äºŽæž„å»ºç¼–è¯‘å™¨ï¼‰
          git clone --depth 1 https://git.openwrt.org/openwrt/openwrt.git .
          
          echo "ðŸ”„ æ­¥éª¤5.2: åˆ›å»ºæœ€å°åŒ–é…ç½®"
          
          # åˆ›å»ºæœ€å°åŒ–é…ç½®ï¼Œåªæž„å»ºå·¥å…·é“¾
          cat > .config << EOF
          # æœ€å°åŒ–é…ç½® - åªæž„å»ºå·¥å…·é“¾
          CONFIG_TARGET_armsr=y
          CONFIG_TARGET_armsr_armv8=y
          CONFIG_TARGET_ROOTFS_INITRAMFS=y
          CONFIG_EXTERNAL_TOOLCHAIN=n
          CONFIG_USE_MUSL=y
          CONFIG_BUILD_TOOLCHAIN=y
          
          # ç¦ç”¨æ‰€æœ‰åŒ…ï¼Œåªæž„å»ºå·¥å…·é“¾
          CONFIG_PACKAGE_busybox=n
          CONFIG_PACKAGE_luci=n
          CONFIG_PACKAGE_wpad=n
          CONFIG_PACKAGE_dnsmasq=n
          
          # ç¼–è¯‘å™¨ä¼˜åŒ–é€‰é¡¹
          CONFIG_GCC_VERSION="${{ env.GCC_VERSION }}"
          CONFIG_BINUTILS_VERSION="${{ env.BINUTILS_VERSION }}"
          CONFIG_LINUX_VERSION="${{ env.LINUX_VERSION }}"
          CONFIG_MUSL_VERSION="${{ env.MUSL_VERSION }}"
          EOF
          
          echo "ðŸ”„ æ­¥éª¤5.3: ä¸‹è½½ä¾èµ–åŒ…"
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡é¿å…äº¤äº’
          export TERM=dumb
          export TERMINFO=/usr/share/terminfo
          export DEBIAN_FRONTEND=noninteractive
          
          # ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¹¶è¡Œä¸‹è½½ï¼‰
          make -j$(nproc) download 2>&1 | tee download.log
          
          echo "ðŸ”„ æ­¥éª¤5.4: åˆ†æ­¥ç¼–è¯‘å·¥å…·é“¾"
          
          # ä½¿ç”¨æ›´å°‘çš„å¹¶è¡Œä»»åŠ¡ç¼–è¯‘å·¥å…·é“¾ï¼ˆé¿å…å†…å­˜ä¸è¶³ï¼‰
          MAKE_JOBS=$(( $(nproc) / 2 ))
          [ $MAKE_JOBS -lt 2 ] && MAKE_JOBS=2
          
          echo "ä½¿ç”¨ $MAKE_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡ç¼–è¯‘å·¥å…·é“¾"
          
          # ç¼–è¯‘æ—¥å¿—æ–‡ä»¶
          BUILD_LOG="${{ env.BUILD_DIR }}/toolchain_build.log"
          
          # åˆ†æ­¥ç¼–è¯‘ï¼Œæ›´å®¹æ˜“ç›‘æŽ§
          echo "[1/4] ç¼–è¯‘binutils..." | tee -a "$BUILD_LOG"
          timeout 45m make toolchain/binutils/compile -j$MAKE_JOBS V=s 2>&1 | tee -a "$BUILD_LOG.binutils"
          
          echo "[2/4] ç¼–è¯‘gccåˆå§‹é˜¶æ®µ..." | tee -a "$BUILD_LOG"
          timeout 45m make toolchain/gcc/compile -j$MAKE_JOBS V=s 2>&1 | tee -a "$BUILD_LOG.gcc_initial"
          
          echo "[3/4] ç¼–è¯‘musl..." | tee -a "$BUILD_LOG"
          timeout 30m make toolchain/musl/compile -j$MAKE_JOBS V=s 2>&1 | tee -a "$BUILD_LOG.musl"
          
          echo "[4/4] ç¼–è¯‘å®Œæ•´gcc..." | tee -a "$BUILD_LOG"
          timeout 60m make toolchain/gcc/compile -j$MAKE_JOBS V=s 2>&1 | tee -a "$BUILD_LOG.gcc_final"
          
          echo "ðŸ”„ æ­¥éª¤5.5: æ£€æŸ¥ç¼–è¯‘ç»“æžœ"
          
          # æŸ¥æ‰¾ç”Ÿæˆçš„å·¥å…·é“¾
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ -d "$TOOLCHAIN_DIR" ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            echo "å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
            
            # æµ‹è¯•ç¼–è¯‘å™¨
            GCC_PATH="$TOOLCHAIN_DIR/bin/"*"-gcc"
            if [ -f $GCC_PATH ]; then
              echo "ðŸ”§ æ‰¾åˆ°ç¼–è¯‘å™¨: $GCC_PATH"
              $GCC_PATH --version 2>&1 | head -1
              
              # è®¾ç½®æˆåŠŸæ ‡å¿—
              echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
            else
              echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶"
              exit 1
            fi
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            echo "æœ€åŽé”™è¯¯:"
            tail -50 "$BUILD_LOG"
            exit 1
          fi
      
      # æ­¥éª¤6: ä¿å­˜ç¼–è¯‘å¥½çš„ç¼–è¯‘å™¨åˆ°ä»“åº“ï¼ˆä»…ä¿å­˜ç¼–è¯‘å™¨ï¼‰
      - name: "6. ðŸ’¾ ä¿å­˜ç¼–è¯‘å™¨åˆ°ä»“åº“"
        if: env.BUILD_SUCCESS == 'true'
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨åˆ°ä»“åº“ ==="
          
          cd "${{ github.workspace }}"
          
          # é…ç½®Git
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          echo "ðŸ”„ æŸ¥æ‰¾ç¼–è¯‘å¥½çš„å·¥å…·é“¾..."
          
          TOOLCHAIN_DIR=$(find "${{ env.BUILD_DIR }}/staging_dir" -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ -d "$TOOLCHAIN_DIR" ]; then
            echo "æ‰¾åˆ°å·¥å…·é“¾: $TOOLCHAIN_DIR"
            
            # æ¸…ç†æ—§çš„ç¼–è¯‘å™¨ç›®å½•
            rm -rf "${{ env.COMPILER_OUTPUT_DIR }}"
            mkdir -p "${{ env.COMPILER_OUTPUT_DIR }}"
            
            # å¤åˆ¶å·¥å…·é“¾ï¼ˆä»…å¤åˆ¶å¿…è¦çš„æ–‡ä»¶ï¼‰
            echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
            
            # å¤åˆ¶æ•´ä¸ªå·¥å…·é“¾ç›®å½•
            cp -r "$TOOLCHAIN_DIR"/* "${{ env.COMPILER_OUTPUT_DIR }}/"
            
            # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
            cat > "${{ env.COMPILER_OUTPUT_DIR }}/version.info" << EOF
            # OpenWrt äº¤å‰ç¼–è¯‘å™¨
            ç¼–è¯‘æ—¶é—´: $(date)
            GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}
            Binutilsç‰ˆæœ¬: ${{ env.BINUTILS_VERSION }}
            Linuxå†…æ ¸ç‰ˆæœ¬: ${{ env.LINUX_VERSION }}
            Muslç‰ˆæœ¬: ${{ env.MUSL_VERSION }}
            æž¶æž„: arm-openwrt-linux-muslgnueabi
            ç”¨é€”: OpenWrt/ImmortalWrtå›ºä»¶æž„å»º
            EOF
            
            echo "âœ… ç¼–è¯‘å™¨å·²ä¿å­˜åˆ°ä»“åº“"
            echo "ðŸ“¦ ç¼–è¯‘å™¨å¤§å°: $(du -sh "${{ env.COMPILER_OUTPUT_DIR }}" | cut -f1)"
            
          else
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘å¥½çš„å·¥å…·é“¾"
            exit 1
          fi
      
      # æ­¥éª¤7: æäº¤æ›´æ–°çš„ç¼–è¯‘å™¨
      - name: "7. ðŸ“¤ æäº¤æ›´æ–°çš„ç¼–è¯‘å™¨"
        if: env.BUILD_SUCCESS == 'true'
        run: |
          echo "=== æäº¤æ›´æ–°çš„ç¼–è¯‘å™¨ ==="
          
          cd "${{ github.workspace }}"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git status --porcelain "firmware-config/build-Compiler-file/compiled" | grep -q .; then
            echo "ðŸ”„ æ£€æµ‹åˆ°ç¼–è¯‘å™¨æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."
            
            # æ·»åŠ æ–‡ä»¶
            git add "firmware-config/build-Compiler-file/compiled"
            
            # åˆ›å»ºæäº¤ä¿¡æ¯
            COMPILER_SIZE=$(du -sh "firmware-config/build-Compiler-file/compiled" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            
            cat > /tmp/commit-msg << EOF
          build(compiler): æ›´æ–°äº¤å‰ç¼–è¯‘å™¨ [$(date +%Y%m%d)]

          ç‰ˆæœ¬ä¿¡æ¯:
          - GCC: ${{ env.GCC_VERSION }}
          - Binutils: ${{ env.BINUTILS_VERSION }}
          - Linux: ${{ env.LINUX_VERSION }}
          - Musl: ${{ env.MUSL_VERSION }}
          - å¤§å°: $COMPILER_SIZE

          è‡ªåŠ¨æž„å»ºäºŽ: $(date '+%Y-%m-%d %H:%M:%S')
          ç”¨äºŽOpenWrt/ImmortalWrtå›ºä»¶ç¼–è¯‘
          EOF
            
            # æäº¤
            git commit -F /tmp/commit-msg
            
            # æŽ¨é€
            echo "ðŸš€ æŽ¨é€åˆ°ä»“åº“..."
            git push origin "${{ github.ref }}"
            
            echo "ðŸŽ‰ ç¼–è¯‘å™¨æ›´æ–°å·²æäº¤åˆ°ä»“åº“"
          else
            echo "âœ… ç¼–è¯‘å™¨æ²¡æœ‰æ›´æ–°ï¼Œæ— éœ€æäº¤"
          fi
      
      # æ­¥éª¤8: ä¸Šä¼ æž„å»ºæ—¥å¿—ï¼ˆå¯é€‰ï¼‰
      - name: "8. ðŸ“„ ä¸Šä¼ æž„å»ºæ—¥å¿—"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compiler-build-logs-$(date +%Y%m%d)
          path: |
            ${{ env.BUILD_DIR }}/*.log
            /tmp/commit-msg
          retention-days: 7
