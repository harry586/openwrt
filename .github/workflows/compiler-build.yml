# .github/workflows/compiler-build-auto.yml
name: ğŸ” ç¼–è¯‘å™¨æ„å»ºï¼ˆè‡ªåŠ¨ç‰ˆæœ¬+è¯¦ç»†ç›‘æ§ï¼‰

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

env:
  BUILD_DIR: "/mnt/compiler-build-$(date +%s)"
  COMPILER_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compiled"

jobs:
  build-with-auto-version:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
      # 1. æ£€å‡º
      - uses: actions/checkout@v4
      
      # 2. è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆæœ¬ï¼ˆæ”¹è¿›ç‰ˆï¼‰
      - name: ğŸ” è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆæœ¬
        id: get_versions
        run: |
          echo "=== è‡ªåŠ¨è·å–æœ€æ–°ç¨³å®šç‰ˆæœ¬ ==="
          
          # æ”¹è¿›çš„ç‰ˆæœ¬è·å–å‡½æ•°
          get_latest_version() {
            local mirror_url=$1
            local pattern=$2
            local fallback=$3
            
            echo "å°è¯•ä» $mirror_url è·å–ç‰ˆæœ¬..."
            
            # ä½¿ç”¨curlè·å–ï¼Œå¸¦è¶…æ—¶å’Œé‡è¯•
            for i in {1..3}; do
              echo "å°è¯• $i/3..."
              html_content=$(curl -s --max-time 30 --retry 2 "$mirror_url" 2>/dev/null)
              
              if [ -n "$html_content" ]; then
                # ä½¿ç”¨æ›´ç²¾ç¡®çš„æ¨¡å¼åŒ¹é…
                version=$(echo "$html_content" | grep -oP "$pattern" | sort -V | tail -1)
                
                if [ -n "$version" ]; then
                  echo "âœ… è·å–æˆåŠŸ: $version"
                  echo "$version"
                  return 0
                fi
              fi
              
              sleep 2
            done
            
            echo "âš ï¸ è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $fallback"
            echo "$fallback"
            return 1
          }
          
          # 1. è·å–GCCç‰ˆæœ¬ï¼ˆè·å–æ‰€æœ‰ç‰ˆæœ¬ï¼Œç„¶åè¿‡æ»¤å‡ºç¨³å®šç‰ˆï¼‰
          echo "è·å–GCCç‰ˆæœ¬..."
          GCC_VERSION=$(get_latest_version "https://ftp.gnu.org/gnu/gcc/" 'gcc-\K[0-9]+\.[0-9]+\.[0-9]+' "11.3.0")
          
          # 2. è·å–Binutilsç‰ˆæœ¬
          echo "è·å–Binutilsç‰ˆæœ¬..."
          BINUTILS_VERSION=$(get_latest_version "https://ftp.gnu.org/gnu/binutils/" 'binutils-\K[0-9]+\.[0-9]+(\.[0-9]+)?' "2.38")
          
          # 3. è·å–Linuxå†…æ ¸ç‰ˆæœ¬ï¼ˆ5.15 LTSç³»åˆ—ï¼‰
          echo "è·å–Linuxå†…æ ¸ç‰ˆæœ¬..."
          LINUX_VERSION=$(get_latest_version "https://cdn.kernel.org/pub/linux/kernel/v5.x/" 'linux-\K5\.15\.[0-9]+' "5.15.133")
          
          # 4. è·å–Muslç‰ˆæœ¬
          echo "è·å–Muslç‰ˆæœ¬..."
          MUSL_VERSION=$(get_latest_version "https://musl.libc.org/releases/" 'musl-\K[0-9]+\.[0-9]+\.[0-9]+' "1.2.4")
          
          # è¾“å‡ºç»“æœ
          echo ""
          echo "ğŸ“¦ è·å–åˆ°çš„ç‰ˆæœ¬:"
          echo "â”œâ”€ GCC: $GCC_VERSION"
          echo "â”œâ”€ Binutils: $BINUTILS_VERSION"
          echo "â”œâ”€ Linux Kernel: $LINUX_VERSION"
          echo "â””â”€ Musl: $MUSL_VERSION"
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          
      # 3. æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç¼–è¯‘
      - name: ğŸ¤” æ£€æŸ¥ç‰ˆæœ¬
        id: check_version
        run: |
          echo "=== æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ç‰ˆæœ¬ ==="
          
          NEED_BUILD="true"
          CURRENT_VERSION=""
          
          if [ -d "${{ env.COMPILER_DIR }}" ]; then
            echo "æ‰¾åˆ°ç°æœ‰ç¼–è¯‘å™¨ç›®å½•"
            
            # æŸ¥æ‰¾gccæ–‡ä»¶
            GCC_FILE=$(find "${{ env.COMPILER_DIR }}" -name "*gcc" -type f 2>/dev/null | head -1)
            
            if [ -n "$GCC_FILE" ] && [ -x "$GCC_FILE" ]; then
              CURRENT_VERSION=$("$GCC_FILE" --version 2>&1 | head -1 | grep -oP '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
              
              if [ -n "$CURRENT_VERSION" ]; then
                echo "å½“å‰ç¼–è¯‘å™¨ç‰ˆæœ¬: $CURRENT_VERSION"
                echo "æœ€æ–°GCCç‰ˆæœ¬: ${{ steps.get_versions.outputs.gcc_version }}"
                
                # ç®€å•ç‰ˆæœ¬æ¯”è¾ƒ
                if [ "$CURRENT_VERSION" = "${{ steps.get_versions.outputs.gcc_version }}" ]; then
                  echo "âœ… ç‰ˆæœ¬ç›¸åŒï¼Œè·³è¿‡ç¼–è¯‘"
                  NEED_BUILD="false"
                else
                  echo "ğŸ”„ ç‰ˆæœ¬ä¸åŒï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
                fi
              fi
            else
              echo "âš ï¸ ç°æœ‰ç¼–è¯‘å™¨æ— æ•ˆ"
            fi
          else
            echo "ğŸ“¥ æœªæ‰¾åˆ°ç¼–è¯‘å™¨ç›®å½•"
          fi
          
          echo "need_build=$NEED_BUILD" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
      
      # 4. æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      - name: ğŸ“‹ æ„å»ºä¿¡æ¯
        if: steps.check_version.outputs.need_build == 'true'
        run: |
          echo "=== æ„å»ºä¿¡æ¯ ==="
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          echo "è¾“å‡ºç›®å½•: ${{ env.COMPILER_DIR }}"
          echo ""
          echo "ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯:"
          echo "å½“å‰ç‰ˆæœ¬: ${{ steps.check_version.outputs.current_version }}"
          echo "ç›®æ ‡ç‰ˆæœ¬:"
          echo "  - GCC: ${{ steps.get_versions.outputs.gcc_version }}"
          echo "  - Binutils: ${{ steps.get_versions.outputs.binutils_version }}"
          echo "  - Linux: ${{ steps.get_versions.outputs.linux_version }}"
          echo "  - Musl: ${{ steps.get_versions.outputs.musl_version }}"
          echo ""
          echo "ğŸ–¥ï¸ ç³»ç»Ÿèµ„æº:"
          echo "CPUæ ¸å¿ƒ: $(nproc)"
          echo "å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "ç£ç›˜ç©ºé—´:"
          df -h /mnt
          
      # 5. å‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: ğŸ—ï¸ å‡†å¤‡ç¯å¢ƒ
        if: steps.check_version.outputs.need_build == 'true'
        run: |
          echo "=== å‡†å¤‡æ„å»ºç¯å¢ƒ ==="
          
          # å®‰è£…ä¾èµ–
          echo "[1/4] å®‰è£…ä¾èµ–..."
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc g++ make \
            flex bison \
            libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
            texinfo texlive \
            ncurses-dev libncursesw5-dev \
            python3 python3-dev \
            git wget curl ca-certificates \
            zlib1g-dev liblzma-dev 2>&1 | tee /tmp/deps-install.log
          
          # åˆ›å»ºæ„å»ºç›®å½•
          echo "[2/4] åˆ›å»ºæ„å»ºç›®å½•..."
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          
          # å…‹éš†OpenWrt
          echo "[3/4] å…‹éš†OpenWrtæºç ..."
          git clone --depth 1 https://github.com/openwrt/openwrt.git . 2>&1 | tee /tmp/clone.log
          
          # é…ç½®
          echo "[4/4] åˆ›å»ºé…ç½®..."
          cat > .config << EOF
          # è‡ªåŠ¨ç”Ÿæˆçš„ç¼–è¯‘å™¨æ„å»ºé…ç½®
          # ç‰ˆæœ¬: ${{ steps.get_versions.outputs.gcc_version }}
          
          CONFIG_TARGET_armsr=y
          CONFIG_TARGET_armsr_armv8=y
          CONFIG_TARGET_ROOTFS_INITRAMFS=y
          CONFIG_EXTERNAL_TOOLCHAIN=n
          CONFIG_USE_MUSL=y
          CONFIG_BUILD_TOOLCHAIN=y
          
          # ç¦ç”¨æ‰€æœ‰åŒ…
          CONFIG_PACKAGE_busybox=n
          CONFIG_PACKAGE_dnsmasq=n
          CONFIG_PACKAGE_firewall=n
          CONFIG_PACKAGE_luci=n
          CONFIG_PACKAGE_wpad=n
          
          # ç‰ˆæœ¬é…ç½®
          CONFIG_GCC_VERSION="${{ steps.get_versions.outputs.gcc_version }}"
          CONFIG_BINUTILS_VERSION="${{ steps.get_versions.outputs.binutils_version }}"
          CONFIG_LINUX_VERSION="${{ steps.get_versions.outputs.linux_version }}"
          CONFIG_MUSL_VERSION="${{ steps.get_versions.outputs.musl_version }}"
          EOF
          
          echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
          
      # 6. åˆ†æ­¥ç¼–è¯‘ï¼ˆå¸¦è¯¦ç»†è¿›åº¦æ˜¾ç¤ºï¼‰
      - name: ğŸ”¨ è¯¦ç»†ç¼–è¯‘è¿‡ç¨‹
        if: steps.check_version.outputs.need_build == 'true'
        timeout-minutes: 180
        run: |
          echo "=== å¼€å§‹è¯¦ç»†ç¼–è¯‘è¿‡ç¨‹ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä»¥è·å¾—æ›´å¤šè¾“å‡º
          export V=sc
          export TERM=dumb
          export TERMINFO=/usr/share/terminfo
          
          # å¯åŠ¨è¿›åº¦ç›‘æ§
          echo "[ç›‘æ§] å¯åŠ¨ç¼–è¯‘è¿›åº¦ç›‘æ§..."
          (
            while true; do
              echo "[$(date '+%H:%M:%S')] === ç¼–è¯‘è¿›åº¦å¿«ç…§ ==="
              
              # æ˜¾ç¤ºå½“å‰è¿›ç¨‹
              echo "å½“å‰ç¼–è¯‘è¿›ç¨‹:"
              ps aux | grep -E "(gcc|g\+\+|make|ld|as)" | grep -v grep | head -5
              
              # æ˜¾ç¤ºæ„å»ºç›®å½•çŠ¶æ€
              echo "æ„å»ºç›®å½•çŠ¶æ€:"
              if [ -d "build_dir" ]; then
                echo "- build_dir: $(find build_dir -type d 2>/dev/null | wc -l) ä¸ªç›®å½•"
                echo "- æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶:"
                find build_dir -type f -name "*.o" -o -name "*.a" 2>/dev/null | xargs ls -lt 2>/dev/null | head -3 2>/dev/null || true
              fi
              
              # æ˜¾ç¤ºå·¥å…·é“¾çŠ¶æ€
              if [ -d "staging_dir" ]; then
                echo "- staging_dir: $(find staging_dir -type f 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶"
              fi
              
              # å†…å­˜ä½¿ç”¨
              echo "å†…å­˜ä½¿ç”¨: $(free -m | grep Mem | awk '{print $3"/"$2"MB ("int($3*100/$2)"%)"}')"
              
              echo "---"
              sleep 60
            done
          ) &
          MONITOR_PID=$!
          
          # æ­¥éª¤1: ä¸‹è½½ï¼ˆå¸¦è¯¦ç»†è¾“å‡ºï¼‰
          echo "[1/6] ğŸš€ å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…..."
          echo "å¼€å§‹æ—¶é—´: $(date)" | tee /tmp/step1-download.log
          
          make -j$(nproc) download V=sc 2>&1 | tee -a /tmp/step1-download.log
          DOWNLOAD_STATUS=${PIPESTATUS[0]}
          
          echo "ç»“æŸæ—¶é—´: $(date)" | tee -a /tmp/step1-download.log
          
          if [ $DOWNLOAD_STATUS -eq 0 ]; then
            echo "âœ… ä¸‹è½½å®Œæˆ"
            echo "ä¸‹è½½æ–‡ä»¶ç»Ÿè®¡:"
            find dl -type f 2>/dev/null | wc -l | xargs echo "- æ€»æ•°: "
            ls -lh dl/*.tar.* dl/*.gz 2>/dev/null | head -10 || true
          else
            echo "âŒ ä¸‹è½½å¤±è´¥"
            echo "æœ€åé”™è¯¯:"
            tail -50 /tmp/step1-download.log
            kill $MONITOR_PID 2>/dev/null
            exit 1
          fi
          
          # æ­¥éª¤2: ç¼–è¯‘binutils
          echo ""
          echo "[2/6] ğŸ”§ ç¼–è¯‘binutils..."
          echo "å¼€å§‹æ—¶é—´: $(date)" | tee /tmp/step2-binutils.log
          echo "ä½¿ç”¨ç‰ˆæœ¬: ${{ steps.get_versions.outputs.binutils_version }}" | tee -a /tmp/step2-binutils.log
          
          timeout 60m make toolchain/binutils/compile -j1 V=sc 2>&1 | tee -a /tmp/step2-binutils.log
          BINUTILS_STATUS=${PIPESTATUS[0]}
          
          echo "ç»“æŸæ—¶é—´: $(date)" | tee -a /tmp/step2-binutils.log
          
          if [ $BINUTILS_STATUS -eq 0 ]; then
            echo "âœ… binutilsç¼–è¯‘æˆåŠŸ"
            # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
            echo "ç”Ÿæˆçš„æ–‡ä»¶:"
            find build_dir -path "*binutils*" -name "*.a" -o -name "*.o" 2>/dev/null | head -5 | xargs -I{} echo "- {}"
          else
            echo "âŒ binutilsç¼–è¯‘å¤±è´¥"
            echo "é”™è¯¯æ‘˜è¦:"
            grep -i "error\|failed\|undefined" /tmp/step2-binutils.log | tail -20
            kill $MONITOR_PID 2>/dev/null
            exit 1
          fi
          
          # æ­¥éª¤3: ç¼–è¯‘gccåˆå§‹é˜¶æ®µ
          echo ""
          echo "[3/6] ğŸ”§ ç¼–è¯‘gccåˆå§‹é˜¶æ®µ..."
          echo "å¼€å§‹æ—¶é—´: $(date)" | tee /tmp/step3-gcc-stage1.log
          echo "GCCç‰ˆæœ¬: ${{ steps.get_versions.outputs.gcc_version }}" | tee -a /tmp/step3-gcc-stage1.log
          
          timeout 60m make toolchain/gcc/compile -j1 V=sc 2>&1 | tee -a /tmp/step3-gcc-stage1.log
          GCC_STAGE1_STATUS=${PIPESTATUS[0]}
          
          echo "ç»“æŸæ—¶é—´: $(date)" | tee -a /tmp/step3-gcc-stage1.log
          
          if [ $GCC_STAGE1_STATUS -eq 0 ]; then
            echo "âœ… gccåˆå§‹é˜¶æ®µæˆåŠŸ"
          else
            echo "âŒ gccåˆå§‹é˜¶æ®µå¤±è´¥"
            echo "é”™è¯¯:"
            tail -50 /tmp/step3-gcc-stage1.log
            kill $MONITOR_PID 2>/dev/null
            exit 1
          fi
          
          # æ­¥éª¤4: ç¼–è¯‘musl
          echo ""
          echo "[4/6] ğŸ”§ ç¼–è¯‘musl..."
          echo "å¼€å§‹æ—¶é—´: $(date)" | tee /tmp/step4-musl.log
          echo "Muslç‰ˆæœ¬: ${{ steps.get_versions.outputs.musl_version }}" | tee -a /tmp/step4-musl.log
          
          timeout 45m make toolchain/musl/compile -j1 V=sc 2>&1 | tee -a /tmp/step4-musl.log
          MUSL_STATUS=${PIPESTATUS[0]}
          
          echo "ç»“æŸæ—¶é—´: $(date)" | tee -a /tmp/step4-musl.log
          
          if [ $MUSL_STATUS -eq 0 ]; then
            echo "âœ… muslç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ muslç¼–è¯‘å¤±è´¥"
            tail -50 /tmp/step4-musl.log
            kill $MONITOR_PID 2>/dev/null
            exit 1
          fi
          
          # æ­¥éª¤5: ç¼–è¯‘å®Œæ•´gcc
          echo ""
          echo "[5/6] ğŸ”§ ç¼–è¯‘å®Œæ•´gcc..."
          echo "å¼€å§‹æ—¶é—´: $(date)" | tee /tmp/step5-gcc-final.log
          
          timeout 90m make toolchain/gcc/compile -j1 V=sc 2>&1 | tee -a /tmp/step5-gcc-final.log
          GCC_FINAL_STATUS=${PIPESTATUS[0]}
          
          echo "ç»“æŸæ—¶é—´: $(date)" | tee -a /tmp/step5-gcc-final.log
          
          if [ $GCC_FINAL_STATUS -eq 0 ]; then
            echo "âœ… gccå®Œæ•´ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ gccå®Œæ•´ç¼–è¯‘å¤±è´¥"
            echo "é”™è¯¯æ‘˜è¦:"
            grep -i "error\|failed" /tmp/step5-gcc-final.log | tail -20
            kill $MONITOR_PID 2>/dev/null
            exit 1
          fi
          
          # æ­¥éª¤6: å®‰è£…å·¥å…·é“¾
          echo ""
          echo "[6/6] ğŸ“¦ å®‰è£…å·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)" | tee /tmp/step6-install.log
          
          timeout 30m make toolchain/install -j1 V=sc 2>&1 | tee -a /tmp/step6-install.log
          INSTALL_STATUS=${PIPESTATUS[0]}
          
          echo "ç»“æŸæ—¶é—´: $(date)" | tee -a /tmp/step6-install.log
          
          if [ $INSTALL_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾å®‰è£…æˆåŠŸ"
          else
            echo "âŒ å·¥å…·é“¾å®‰è£…å¤±è´¥"
            tail -50 /tmp/step6-install.log
            kill $MONITOR_PID 2>/dev/null
            exit 1
          fi
          
          # åœæ­¢ç›‘æ§
          kill $MONITOR_PID 2>/dev/null || true
          
          echo ""
          echo "ğŸ‰ ğŸ‰ ğŸ‰ æ‰€æœ‰ç¼–è¯‘æ­¥éª¤æˆåŠŸå®Œæˆï¼"
          echo "æ€»ç”¨æ—¶: ä» $(grep "å¼€å§‹æ—¶é—´" /tmp/step1-download.log | head -1) åˆ° $(date)"
          
      # 7. ä¿å­˜ç¼–è¯‘ç»“æœ
      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        if: steps.check_version.outputs.need_build == 'true'
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘ç»“æœ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # æŸ¥æ‰¾å·¥å…·é“¾
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ -d "$TOOLCHAIN_DIR" ]; then
            echo "âœ… æ‰¾åˆ°å·¥å…·é“¾ç›®å½•: $(basename "$TOOLCHAIN_DIR")"
            
            # æ¸…ç†æ—§çš„ç¼–è¯‘å™¨
            rm -rf "${{ env.COMPILER_DIR }}"
            mkdir -p "${{ env.COMPILER_DIR }}"
            
            # å¤åˆ¶å·¥å…·é“¾
            echo "å¤åˆ¶å·¥å…·é“¾..."
            cp -r "$TOOLCHAIN_DIR"/* "${{ env.COMPILER_DIR }}/"
            
            # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
            cat > "${{ env.COMPILER_DIR }}/BUILD_INFO.txt" << EOF
            OpenWrt äº¤å‰ç¼–è¯‘å™¨ - è‡ªåŠ¨æ„å»º
            =================================
            
            æ„å»ºä¿¡æ¯:
            - æ„å»ºæ—¶é—´: $(date)
            - å·¥ä½œæµ: ${{ github.workflow }}
            - è¿è¡ŒID: ${{ github.run_id }}
            
            ç‰ˆæœ¬ä¿¡æ¯:
            - GCC: ${{ steps.get_versions.outputs.gcc_version }}
            - Binutils: ${{ steps.get_versions.outputs.binutils_version }}
            - Linuxå†…æ ¸: ${{ steps.get_versions.outputs.linux_version }}
            - Musl: ${{ steps.get_versions.outputs.musl_version }}
            
            å·¥å…·é“¾ä¿¡æ¯:
            - æ¶æ„: arm-openwrt-linux-muslgnueabi
            - Cåº“: musl
            - ç›®æ ‡: OpenWrt/ImmortalWrt
            
            ç›®å½•ç»“æ„:
            - bin/: ç¼–è¯‘å™¨å¯æ‰§è¡Œæ–‡ä»¶
            - lib/: è¿è¡Œæ—¶åº“
            - include/: å¤´æ–‡ä»¶
            - libexec/: è¾…åŠ©å·¥å…·
            
            ä½¿ç”¨æ–¹æ³•:
            åœ¨OpenWrtæ„å»ºç¯å¢ƒä¸­ï¼Œè®¾ç½®:
            export STAGING_DIR=/path/to/this/compiler
            
            æˆ–è€…åœ¨ç¼–è¯‘å‘½ä»¤ä¸­æŒ‡å®š:
            make STAGING_DIR=/path/to/this/compiler
            EOF
            
            # æ˜¾ç¤ºç¼–è¯‘å™¨ä¿¡æ¯
            echo "ğŸ”§ ç¼–è¯‘å™¨æµ‹è¯•:"
            GCC_PATH="${{ env.COMPILER_DIR }}/bin/"*"-gcc"
            if [ -f $GCC_PATH ]; then
              $GCC_PATH --version 2>&1 | head -1
              echo "ç¼–è¯‘å™¨è·¯å¾„: $GCC_PATH"
            fi
            
            echo "ğŸ“¦ ç¼–è¯‘å™¨å¤§å°: $(du -sh "${{ env.COMPILER_DIR }}" | cut -f1)"
            echo "ğŸ“ æ–‡ä»¶æ•°é‡: $(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)"
            
          else
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            exit 1
          fi
      
      # 8. æäº¤åˆ°ä»“åº“
      - name: ğŸ“¤ æäº¤æ›´æ–°
        if: steps.check_version.outputs.need_build == 'true'
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°ä»“åº“ ==="
          
          cd "${{ github.workspace }}"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          
          # æ£€æŸ¥å˜æ›´
          if git status --porcelain "firmware-config/build-Compiler-file/compiled" | grep -q .; then
            echo "ğŸ”„ æ£€æµ‹åˆ°ç¼–è¯‘å™¨æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."
            
            git add "firmware-config/build-Compiler-file/compiled"
            
            # æäº¤ä¿¡æ¯
            SIZE=$(du -sh "firmware-config/build-Compiler-file/compiled" | cut -f1)
            GCC_VER="${{ steps.get_versions.outputs.gcc_version }}"
            
            git commit -m "build(compiler): è‡ªåŠ¨æ›´æ–°äº¤å‰ç¼–è¯‘å™¨ v$GCC_VER [$(date +%Y%m%d)]

            ğŸ”§ ç‰ˆæœ¬ä¿¡æ¯:
            â€¢ GCC: $GCC_VER
            â€¢ Binutils: ${{ steps.get_versions.outputs.binutils_version }}
            â€¢ Linux: ${{ steps.get_versions.outputs.linux_version }}
            â€¢ Musl: ${{ steps.get_versions.outputs.musl_version }}
            
            ğŸ“¦ æ„å»ºè¯¦æƒ…:
            â€¢ å¤§å°: $SIZE
            â€¢ æ—¶é—´: $(date '+%Y-%m-%d %H:%M')
            â€¢ å·¥ä½œæµ: ${{ github.workflow }} #${{ github.run_id }}
            
            ğŸ¯ ç”¨é€”: OpenWrt/ImmortalWrtå›ºä»¶æ„å»º
            
            Signed-off-by: GitHub Actions <actions@github.com>"
            
            # æ¨é€
            echo "ğŸš€ æ¨é€åˆ°ä»“åº“..."
            git push
            
            echo "ğŸ‰ ç¼–è¯‘å™¨å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
          else
            echo "âœ… æ²¡æœ‰å˜æ›´ï¼Œæ— éœ€æäº¤"
          fi
      
      # 9. ä¸Šä¼ è¯¦ç»†æ—¥å¿—
      - name: ğŸ“„ ä¸Šä¼ æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compiler-build-logs-$(date +%Y%m%d-%H%M%S)
          path: |
            /tmp/step*.log
            /tmp/*.log
            ${{ env.BUILD_DIR }}/.config
          retention-days: 7
