# .github/workflows/compiler-build.yml
name: ğŸ” ç¼–è¯‘å™¨æ„å»ºï¼ˆARMç‰ˆæœ¬ï¼‰

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

env:
  COMPILER_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compiled"

jobs:
  build-compiler:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
      # 1. æ£€å‡ºä»“åº“
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
      
      # 2. è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯å’Œæ„å»ºç›®å½•
      - name: ğŸ” è®¾ç½®ç‰ˆæœ¬å’Œç›®å½•
        run: |
          echo "=== ç¼–è¯‘å™¨ç‰ˆæœ¬é…ç½® ==="
          echo "GCC_VERSION=11.3.0" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=2.38" >> $GITHUB_ENV
          echo "LINUX_VERSION=5.15.133" >> $GITHUB_ENV
          echo "MUSL_VERSION=1.2.4" >> $GITHUB_ENV
          BUILD_TIMESTAMP=$(date +%s)
          BUILD_DIR="/mnt/compiler-build-${BUILD_TIMESTAMP}"
          echo "BUILD_DIR=${BUILD_DIR}" >> $GITHUB_ENV
          echo "ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯:"
          echo "â”œâ”€ GCC: 11.3.0"
          echo "â”œâ”€ Binutils: 2.38"
          echo "â”œâ”€ Linux Kernel: 5.15.133"
          echo "â””â”€ Musl: 1.2.4"
          echo "ğŸ“ æ„å»ºç›®å½•: ${BUILD_DIR}"
          echo "ğŸ¯ ç›®æ ‡æ¶æ„: ARM (aarch64)"
      
      # 3. æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºä¿¡æ¯
        run: |
          echo "=== æ„å»ºé…ç½®ä¿¡æ¯ ==="
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          echo "ç¼–è¯‘å™¨è¾“å‡º: ${{ env.COMPILER_DIR }}"
          echo ""
          echo "ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯:"
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "ç”¨æˆ·ID: $(id -u)"
          echo "ç»„ID: $(id -g)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "CPU: $(nproc) æ ¸å¿ƒ"
          echo "å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "/mnt ç£ç›˜ä¿¡æ¯:"
          df -h /mnt || echo "æ— æ³•è®¿é—® /mnt"
          echo ""
          echo "ğŸ“… å¼€å§‹æ—¶é—´: $(date)"
      
      # 4. å‡†å¤‡ç¯å¢ƒï¼ˆä¿®å¤ç»ˆç«¯é—®é¢˜ï¼‰
      - name: ğŸ—ï¸ å‡†å¤‡ç¯å¢ƒ
        run: |
          echo "=== å‡†å¤‡æ„å»ºç¯å¢ƒ ==="
          echo "[1/8] æ£€æŸ¥ /mnt çŠ¶æ€..."
          if [ ! -d "/mnt" ]; then
            echo "åˆ›å»º /mnt ç›®å½•..."
            sudo mkdir -p /mnt
            sudo chmod 755 /mnt
          fi
          echo "[2/8] åˆ›å»ºæ„å»ºç›®å½•..."
          echo "åˆ›å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          sudo mkdir -p "${{ env.BUILD_DIR }}"
          sudo chown -R $USER:$USER "${{ env.BUILD_DIR }}"
          sudo chmod 755 "${{ env.BUILD_DIR }}"
          echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"
          ls -ld "${{ env.BUILD_DIR }}"
          echo "[3/8] å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential gcc g++ make flex bison libgmp-dev libmpfr-dev libmpc-dev \
            libisl-dev python3 python3-dev git wget curl zlib1g-dev liblzma-dev \
            file gawk gettext libncurses5-dev libssl-dev python3-distutils \
            rsync unzip ncurses-term ncurses-base libncursesw5 libtinfo5 \
            terminfo 2>&1 | tee /tmp/deps-install.log
          echo "[4/8] ä¿®å¤ç»ˆç«¯ç¯å¢ƒï¼ˆå…³é”®ä¿®å¤ï¼‰..."
          # ä¿®å¤ "Error opening terminal: unknown" é—®é¢˜
          sudo apt-get install -y ncurses-term ncurses-base libncursesw5 libtinfo5 terminfo
          export TERM=xterm-256color
          export TERMINFO=/usr/share/terminfo
          # åˆ›å»ºå¿…è¦çš„terminfoæ–‡ä»¶
          sudo mkdir -p /usr/share/terminfo/x
          if [ -f "/lib/terminfo/x/xterm" ]; then
            sudo ln -sf /lib/terminfo/x/xterm /usr/share/terminfo/x/xterm-256color 2>/dev/null || true
          fi
          echo "TERM=$TERM" >> $GITHUB_ENV
          echo "TERMINFO=$TERMINFO" >> $GITHUB_ENV
          echo "[5/8] è®¾ç½®ç¯å¢ƒå˜é‡..."
          echo "export TERM=xterm-256color" >> ~/.bashrc
          echo "export TERMINFO=/usr/share/terminfo" >> ~/.bashrc
          echo "[6/8] è®¾ç½®Gité…ç½®..."
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global core.compression 0
          git config --global core.looseCompression 0
          echo "[7/8] éªŒè¯å·¥å…·..."
          echo "å…³é”®å·¥å…·æ£€æŸ¥:"
          for tool in gcc g++ make flex bison python3 git wget; do
            if command -v $tool >/dev/null; then
              echo "  âœ… $tool"
            else
              echo "  âŒ $tool: æœªæ‰¾åˆ°"
            fi
          done
          echo "[8/8] è®¾ç½®å®‰å…¨é…ç½®..."
          export FORCE_UNSAFE_CONFIGURE=1
          echo "FORCE_UNSAFE_CONFIGURE=1" >> $GITHUB_ENV
          echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
      
      # 5. è·å–æºç å’Œé…ç½®ï¼ˆä½¿ç”¨æ­£ç¡®çš„æ¶æ„ï¼‰
      - name: ğŸ“¥ è·å–æºç 
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          if [ ! -d "${{ env.BUILD_DIR }}" ]; then
            echo "âŒ é”™è¯¯: æ„å»ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "[1/4] å…‹éš†OpenWrtæºç ..."
          git clone --depth 1 --branch v23.05.2 https://github.com/openwrt/openwrt.git . 2>&1 | tee /tmp/clone.log
          echo "[2/4] æ›´æ–°feeds..."
          ./scripts/feeds update -a 2>&1 | tee /tmp/feeds-update.log
          ./scripts/feeds install -a 2>&1 | tee /tmp/feeds-install.log
          echo "[3/4] åˆ›å»ºARMæ¶æ„é…ç½®..."
          # å‚è€ƒbuild_firmware_main.shä¸­çš„é…ç½®æ–¹æ³•
          echo "# OpenWrt ARM64 äº¤å‰ç¼–è¯‘å™¨æ„å»ºé…ç½®" > .config
          echo "# ç”Ÿæˆæ—¶é—´: $(date)" >> .config
          echo "" >> .config
          echo "# ç›®æ ‡å¹³å°: ARM64 (aarch64)" >> .config
          echo "CONFIG_TARGET_armvirt=y" >> .config
          echo "CONFIG_TARGET_armvirt_64=y" >> .config
          echo "CONFIG_TARGET_armvirt_64_Default=y" >> .config
          echo "" >> .config
          echo "# æ–‡ä»¶ç³»ç»Ÿ" >> .config
          echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=n" >> .config
          echo "" >> .config
          echo "# å·¥å…·é“¾é…ç½®" >> .config
          echo "CONFIG_EXTERNAL_TOOLCHAIN=n" >> .config
          echo "CONFIG_USE_MUSL=y" >> .config
          echo "# CONFIG_USE_GLIBC is not set" >> .config
          echo "# CONFIG_USE_UCLIBC is not set" >> .config
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "" >> .config
          echo "# ç‰ˆæœ¬é…ç½®" >> .config
          echo 'CONFIG_GCC_VERSION="11.3.0"' >> .config
          echo 'CONFIG_BINUTILS_VERSION="2.38"' >> .config
          echo 'CONFIG_LINUX_VERSION="5.15.133"' >> .config
          echo 'CONFIG_MUSL_VERSION="1.2.4"' >> .config
          echo "" >> .config
          echo "# ç¦ç”¨æ‰€æœ‰è½¯ä»¶åŒ…ï¼Œåªæ„å»ºå·¥å…·é“¾" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "" >> .config
          echo "# è·³è¿‡æŸäº›æ£€æŸ¥" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_CCACHE=n" >> .config
          echo "CONFIG_SIGNED_PACKAGES=n" >> .config
          echo "" >> .config
          echo "# ç¡®ä¿å·¥å…·é“¾æ„å»º" >> .config
          echo "CONFIG_TOOLCHAIN=y" >> .config
          echo "CONFIG_TOOLCHAIN_BUILD=y" >> .config
          echo "[4/4] é…ç½®éªŒè¯..."
          echo "é…ç½®æ‘˜è¦:"
          echo "ç›®æ ‡æ¶æ„: ARM64 (aarch64)"
          echo "Cåº“: musl"
          echo "GCCç‰ˆæœ¬: 11.3.0"
          echo "é…ç½®æ–‡ä»¶å¤§å°: $(wc -l < .config) è¡Œ"
          echo "âœ… æºç é…ç½®å®Œæˆ"
      
      # 6. ç¼–è¯‘å·¥å…·é“¾ï¼ˆä¼˜åŒ–ç‰ˆï¼Œå€Ÿé‰´build_firmware_main.shçš„ç»éªŒï¼‰
      - name: ğŸ”¨ ç¼–è¯‘å·¥å…·é“¾
        timeout-minutes: 150
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å·¥å…·é“¾ ==="
          if [ ! -d "${{ env.BUILD_DIR }}" ]; then
            echo "âŒ é”™è¯¯: æ„å»ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          cd "${{ env.BUILD_DIR }}"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒï¼ˆä¿®å¤ç»ˆç«¯é—®é¢˜ï¼‰
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          export TERMINFO=/usr/share/terminfo
          export TERMCAP=/etc/termcap
          
          echo "=== æ­¥éª¤1: åº”ç”¨é…ç½®ï¼ˆé¿å…menuconfigï¼‰ ==="
          echo "æ—¶é—´: $(date)"
          
          # å¤‡ä»½é…ç½®æ–‡ä»¶
          cp .config .config.bak
          
          # ä½¿ç”¨defconfigç›´æ¥åº”ç”¨é…ç½®ï¼Œé¿å…menuconfig
          echo "è¿è¡Œ make defconfig..."
          make defconfig 2>&1 | tee /tmp/defconfig.log
          
          # æ£€æŸ¥defconfigæ˜¯å¦æˆåŠŸ
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âš ï¸ defconfigå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é…ç½®"
            cp .config.bak .config
            # ç›´æ¥æ‰‹åŠ¨è®¾ç½®å¿…è¦çš„é…ç½®
            sed -i 's/^CONFIG_TARGET_armvirt_64_Default=y$/# CONFIG_TARGET_armvirt_64_Default is not set/' .config
            sed -i 's/^CONFIG_TARGET_armvirt_64=y$/CONFIG_TARGET_armvirt_64=y/' .config
          fi
          
          echo "=== æ­¥éª¤2: ä¸‹è½½æºç åŒ… ==="
          echo "æ—¶é—´: $(date)"
          
          # åˆ›å»ºdlç›®å½•
          mkdir -p dl
          
          # å…ˆå°è¯•ä¸‹è½½å…³é”®åŒ…
          echo "ä¸‹è½½ç¼–è¯‘å™¨æºç åŒ…..."
          make -j1 download V=s 2>&1 | tee /tmp/download.log
          DOWNLOAD_STATUS=${PIPESTATUS[0]}
          
          if [ $DOWNLOAD_STATUS -ne 0 ]; then
            echo "âš ï¸ ä¸‹è½½å‡ºç°è­¦å‘Šï¼Œæ£€æŸ¥æ—¥å¿—..."
            if grep -q "Error\|ERROR\|Failed" /tmp/download.log; then
              echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œæœ‰ä¸¥é‡é”™è¯¯"
              echo "é”™è¯¯æ‘˜è¦:"
              grep -E "Error|ERROR|Failed" /tmp/download.log | head -10
              exit 1
            else
              echo "âœ… ä¸‹è½½å®Œæˆï¼Œåªæœ‰è­¦å‘Šä¿¡æ¯"
            fi
          else
            echo "âœ… ä¸‹è½½æˆåŠŸ"
          fi
          
          echo "=== æ­¥éª¤3: æ„å»ºbinutils ==="
          echo "æ—¶é—´: $(date)"
          
          # ä½¿ç”¨build_firmware_main.shä¸­çš„æ–¹æ³•
          make toolchain/binutils/compile -j$(nproc) V=s 2>&1 | tee /tmp/binutils.log
          BINUTILS_STATUS=${PIPESTATUS[0]}
          
          if [ $BINUTILS_STATUS -ne 0 ]; then
            echo "âŒ binutilsç¼–è¯‘å¤±è´¥"
            echo "é”™è¯¯æ‘˜è¦:"
            grep -E "Error|ERROR|Failed|undefined" /tmp/binutils.log | head -20
            exit 1
          fi
          echo "âœ… binutilsç¼–è¯‘å®Œæˆ"
          
          echo "=== æ­¥éª¤4: æ„å»ºgccåˆå§‹é˜¶æ®µ ==="
          echo "æ—¶é—´: $(date)"
          
          make toolchain/gcc/initial/compile -j$(nproc) V=s 2>&1 | tee /tmp/gcc-initial.log
          GCC_INITIAL_STATUS=${PIPESTATUS[0]}
          
          if [ $GCC_INITIAL_STATUS -ne 0 ]; then
            echo "âŒ gccåˆå§‹é˜¶æ®µå¤±è´¥"
            echo "é”™è¯¯æ‘˜è¦:"
            grep -E "Error|ERROR|Failed|undefined" /tmp/gcc-initial.log | head -20
            exit 1
          fi
          echo "âœ… gccåˆå§‹é˜¶æ®µå®Œæˆ"
          
          echo "=== æ­¥éª¤5: æ„å»ºmusl Cåº“ ==="
          echo "æ—¶é—´: $(date)"
          
          make toolchain/musl/compile -j$(nproc) V=s 2>&1 | tee /tmp/musl.log
          MUSL_STATUS=${PIPESTATUS[0]}
          
          if [ $MUSL_STATUS -ne 0 ]; then
            echo "âŒ muslç¼–è¯‘å¤±è´¥"
            echo "é”™è¯¯æ‘˜è¦:"
            grep -E "Error|ERROR|Failed|undefined" /tmp/musl.log | head -20
            exit 1
          fi
          echo "âœ… muslç¼–è¯‘å®Œæˆ"
          
          echo "=== æ­¥éª¤6: æ„å»ºå®Œæ•´gcc ==="
          echo "æ—¶é—´: $(date)"
          
          make toolchain/gcc/final/compile -j$(nproc) V=s 2>&1 | tee /tmp/gcc-final.log
          GCC_FINAL_STATUS=${PIPESTATUS[0]}
          
          if [ $GCC_FINAL_STATUS -ne 0 ]; then
            echo "âŒ å®Œæ•´gccç¼–è¯‘å¤±è´¥"
            echo "é”™è¯¯æ‘˜è¦:"
            grep -E "Error|ERROR|Failed|undefined" /tmp/gcc-final.log | head -20
            exit 1
          fi
          echo "âœ… å®Œæ•´gccç¼–è¯‘å®Œæˆ"
          
          echo "=== æ­¥éª¤7: å®‰è£…å·¥å…·é“¾ ==="
          echo "æ—¶é—´: $(date)"
          
          make toolchain/install -j$(nproc) V=s 2>&1 | tee /tmp/install.log
          INSTALL_STATUS=${PIPESTATUS[0]}
          
          if [ $INSTALL_STATUS -ne 0 ]; then
            echo "âŒ å®‰è£…å¤±è´¥"
            echo "é”™è¯¯æ‘˜è¦:"
            grep -E "Error|ERROR|Failed|undefined" /tmp/install.log | head -20
            exit 1
          fi
          echo "âœ… å®‰è£…å®Œæˆ"
          
          echo ""
          echo "ğŸ‰ ğŸ‰ ğŸ‰ ARM64äº¤å‰ç¼–è¯‘å™¨æ„å»ºæˆåŠŸï¼"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "å®Œæˆæ—¶é—´: $(date)"
          echo "æ„å»ºç›®å½•å¤§å°: $(du -sh . | cut -f1)"
          echo "staging_dirå¤§å°: $(du -sh staging_dir 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
      
      # 7. éªŒè¯ç»“æœ
      - name: âœ… éªŒè¯ç»“æœ
        run: |
          echo "=== éªŒè¯ç¼–è¯‘ç»“æœ ==="
          if [ ! -d "${{ env.BUILD_DIR }}" ]; then
            echo "âŒ é”™è¯¯: æ„å»ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          cd "${{ env.BUILD_DIR }}"
          echo "[1/5] æŸ¥æ‰¾å·¥å…·é“¾ç›®å½•..."
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | head -1)
          if [ -z "$TOOLCHAIN_DIR" ] || [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            echo "staging_dirå†…å®¹:"
            ls -la staging_dir/ 2>/dev/null || echo "staging_dirä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          echo "ç›®å½•å¤§å°: $(du -sh "$TOOLCHAIN_DIR" 2>/dev/null | cut -f1)"
          echo "[2/5] æ£€æŸ¥ARM64ç¼–è¯‘å™¨..."
          GCC_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "aarch64-*gcc" -type f 2>/dev/null | head -1)
          if [ -n "$GCC_PATH" ] && [ -x "$GCC_PATH" ]; then
            echo "âœ… æ‰¾åˆ°ARM64ç¼–è¯‘å™¨: $(basename "$GCC_PATH")"
            echo "ç‰ˆæœ¬ä¿¡æ¯:"
            $GCC_PATH --version 2>&1 | head -1
          else
            echo "âŒ æœªæ‰¾åˆ°ARM64ç¼–è¯‘å™¨"
            echo "å¯ç”¨ç¼–è¯‘å™¨:"
            find "$TOOLCHAIN_DIR/bin" -name "*gcc" -type f 2>/dev/null | while read f; do
              echo "  - $(basename "$f")"
            done
            exit 1
          fi
          echo "[3/5] æ£€æŸ¥å…³é”®å·¥å…·..."
          for tool in gcc g++ ld ar strip; do
            file=$(find "$TOOLCHAIN_DIR/bin" -name "aarch64-*$tool" -type f 2>/dev/null | head -1)
            if [ -n "$file" ] && [ -x "$file" ]; then
              echo "  âœ… $tool: $(basename "$file")"
            else
              echo "  âŒ $tool: æœªæ‰¾åˆ°"
            fi
          done
          echo "[4/5] æµ‹è¯•äº¤å‰ç¼–è¯‘..."
          echo '#include <stdio.h>' > test-arm.c
          echo 'int main() {' >> test-arm.c
          echo '    printf("ARM64 cross-compiler test OK\\n");' >> test-arm.c
          echo '    return 0;' >> test-arm.c
          echo '}' >> test-arm.c
          if $GCC_PATH test-arm.c -o test-arm 2>/tmp/compile-test.log; then
            echo "âœ… äº¤å‰ç¼–è¯‘æµ‹è¯•é€šè¿‡"
            echo "ç”Ÿæˆæ–‡ä»¶ç±»å‹:"
            file test-arm 2>/dev/null || echo "æ— æ³•è¯†åˆ«æ–‡ä»¶"
            rm -f test-arm test-arm.c
          else
            echo "âš ï¸ äº¤å‰ç¼–è¯‘æµ‹è¯•å¤±è´¥"
            cat /tmp/compile-test.log
          fi
          echo "[5/5] æ£€æŸ¥åº“æ–‡ä»¶..."
          LIBGCC_PATH=$(find "$TOOLCHAIN_DIR" -name "libgcc.a" -type f 2>/dev/null | head -1)
          if [ -f "$LIBGCC_PATH" ]; then
            echo "âœ… æ‰¾åˆ°libgcc.a: $LIBGCC_PATH"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°libgcc.a"
          fi
          echo "âœ… éªŒè¯å®Œæˆ"
      
      # 8. ä¿å­˜åˆ°ä»“åº“
      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        run: |
          echo "=== ä¿å­˜ARM64ç¼–è¯‘å™¨åˆ°ä»“åº“ ==="
          if [ ! -d "${{ env.BUILD_DIR }}" ]; then
            echo "âŒ é”™è¯¯: æ„å»ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          cd "${{ env.BUILD_DIR }}"
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | head -1)
          if [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ é”™è¯¯: å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          echo "[1/6] å‡†å¤‡è¾“å‡ºç›®å½•..."
          mkdir -p "${{ env.COMPILER_DIR }}"
          if [ -d "${{ env.COMPILER_DIR }}" ]; then
            echo "æ¸…ç©ºè¾“å‡ºç›®å½•..."
            rm -rf "${{ env.COMPILER_DIR }}"/* 2>/dev/null || true
          fi
          echo "[2/6] å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
          cp -r "$TOOLCHAIN_DIR"/* "${{ env.COMPILER_DIR }}/" 2>&1 | tee /tmp/copy.log | head -20
          echo "[3/6] åˆ›å»ºæ„å»ºä¿¡æ¯..."
          echo "========================================" > "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "OpenWrt ARM64 äº¤å‰ç¼–è¯‘å™¨ - è‡ªåŠ¨æ„å»º" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "========================================" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "æ„å»ºæ—¶é—´: $(date)" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "å·¥ä½œæµ: ${{ github.workflow }}" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "è¿è¡ŒID: ${{ github.run_id }}" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "æäº¤: ${{ github.sha }}" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "=========== ç‰ˆæœ¬ä¿¡æ¯ ===========" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "GCC: 11.3.0" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "Binutils: 2.38" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "Linuxå†…æ ¸: 5.15.133" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "Musl: 1.2.4" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "ç›®æ ‡æ¶æ„: aarch64 (ARM64)" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "=========== å·¥å…·é“¾ä¿¡æ¯ ===========" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "ç›®æ ‡ä¸‰å…ƒç»„: aarch64-openwrt-linux-musl" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "Cåº“: musl" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "å­—èŠ‚åº: å°ç«¯ (little-endian)" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "ABI: LP64" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "=========== æ–‡ä»¶ç»Ÿè®¡ ===========" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "æ€»æ–‡ä»¶æ•°: $(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "æ€»å¤§å°: $(du -sh "${{ env.COMPILER_DIR }}" 2>/dev/null | cut -f1)" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "=========== ä½¿ç”¨æ–¹æ³• ===========" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "åœ¨OpenWrtæ„å»ºç¯å¢ƒä¸­:" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "1. è®¾ç½®ç¯å¢ƒå˜é‡:" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "   export STAGING_DIR=/path/to/this/compiler" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "   make" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "2. æˆ–è€…åœ¨makeå‘½ä»¤ä¸­ç›´æ¥æŒ‡å®š:" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "   make STAGING_DIR=/path/to/this/compiler" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "=========== ä¸»è¦å·¥å…· ===========" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "bin/aarch64-openwrt-linux-musl-gcc      # Cç¼–è¯‘å™¨" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "bin/aarch64-openwrt-linux-musl-g++      # C++ç¼–è¯‘å™¨" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "bin/aarch64-openwrt-linux-musl-ld       # é“¾æ¥å™¨" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "bin/aarch64-openwrt-linux-musl-ar       # é™æ€åº“å·¥å…·" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "bin/aarch64-openwrt-linux-musl-strip    # ç¬¦å·å‰¥ç¦»" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "========================================" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "æ­¤æ–‡ä»¶ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "========================================" >> "${{ env.COMPILER_DIR }}/BUILD-INFO.txt"
          echo "[4/6] éªŒè¯å¤åˆ¶ç»“æœ..."
          echo "è¾“å‡ºç›®å½•: ${{ env.COMPILER_DIR }}"
          echo "å¤§å°: $(du -sh "${{ env.COMPILER_DIR }}" 2>/dev/null | cut -f1)"
          echo "æ–‡ä»¶æ•°: $(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)"
          echo "[5/6] åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶..."
          echo "ARM64_CROSS_COMPILER_VERSION=11.3.0" > "${{ env.COMPILER_DIR }}/VERSION"
          echo "BUILD_DATE=$(date '+%Y-%m-%d')" >> "${{ env.COMPILER_DIR }}/VERSION"
          echo "TARGET_ARCH=aarch64" >> "${{ env.COMPILER_DIR }}/VERSION"
          echo "LIBC=musl" >> "${{ env.COMPILER_DIR }}/VERSION"
          echo "[6/6] æœ€ç»ˆæµ‹è¯•..."
          TEST_GCC=$(find "${{ env.COMPILER_DIR }}/bin" -name "aarch64-*gcc" -type f 2>/dev/null | head -1)
          if [ -n "$TEST_GCC" ] && [ -x "$TEST_GCC" ]; then
            echo "âœ… ARM64ç¼–è¯‘å™¨æµ‹è¯•:"
            $TEST_GCC --version 2>&1 | head -1
          else
            echo "âš ï¸  è­¦å‘Š: ç¼–è¯‘å™¨ä¸å¯æ‰§è¡Œ"
          fi
          echo "âœ… ä¿å­˜å®Œæˆ"
      
      # 9. æäº¤åˆ°ä»“åº“
      - name: ğŸ“¤ æäº¤æ›´æ–°
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°ä»“åº“ ==="
          cd "${{ github.workspace }}"
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          echo "[1/4] æ£€æŸ¥å˜æ›´..."
          if [ -d "${{ env.COMPILER_DIR }}" ] && [ "$(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)" -gt 10 ]; then
            echo "æ£€æµ‹åˆ°æ–°çš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œå‡†å¤‡æäº¤..."
            SIZE=$(du -sh "${{ env.COMPILER_DIR }}" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            FILE_COUNT=$(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)
            DATE_TAG=$(date +%Y%m%d)
            echo "[2/4] æ·»åŠ åˆ°Git..."
            git add -f "firmware-config/build-Compiler-file/compiled"
            echo "[3/4] æäº¤..."
            git commit -m "build(compiler): è‡ªåŠ¨æ„å»ºARM64äº¤å‰ç¼–è¯‘å™¨ v11.3.0 [$DATE_TAG]
            
            ğŸ”§ ç‰ˆæœ¬ä¿¡æ¯:
            â€¢ GCC: 11.3.0
            â€¢ Binutils: 2.38
            â€¢ Linuxå†…æ ¸: 5.15.133
            â€¢ Musl: 1.2.4
            â€¢ ç›®æ ‡: aarch64 (ARM64)
            
            ğŸ“Š æ„å»ºè¯¦æƒ…:
            â€¢ å¤§å°: $SIZE
            â€¢ æ–‡ä»¶æ•°: $FILE_COUNT
            â€¢ æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
            â€¢ å·¥ä½œæµ: ${{ github.workflow }}
            â€¢ è¿è¡ŒID: #${{ github.run_id }}
            
            ğŸ¯ ç”¨é€”: OpenWrt/ImmortalWrtå›ºä»¶æ„å»º
            ğŸ“ ä½ç½®: firmware-config/build-Compiler-file/compiled/
            
            Signed-off-by: GitHub Actions <actions@github.com>"
            echo "[4/4] æ¨é€åˆ°ä»“åº“..."
            if git push; then
              echo "ğŸ‰ ARM64ç¼–è¯‘å™¨å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
            else
              echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œä½†æäº¤å·²ä¿å­˜åœ¨æœ¬åœ°"
            fi
          else
            echo "âœ… æ²¡æœ‰è¶³å¤Ÿçš„ç¼–è¯‘å™¨æ–‡ä»¶ï¼Œè·³è¿‡æäº¤"
          fi
      
      # 10. ä¸Šä¼ æ—¥å¿—
      - name: ğŸ“„ ä¸Šä¼ æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compiler-build-logs-$(date +%Y%m%d-%H%M%S)
          path: |
            /tmp/*.log
            /tmp/deps-install.log
            ${{ env.BUILD_DIR }}/.config
            ${{ env.BUILD_DIR }}/download.log
          retention-days: 7
