# .github/workflows/compiler-build.yml
name: ğŸ” ç¼–è¯‘å™¨æ„å»ºï¼ˆç¨³å®šç‰ˆï¼‰

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

env:
  BUILD_DIR: "/mnt/compiler-build-$(date +%s)"
  COMPILER_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compiled"

jobs:
  build-compiler:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
      # 1. æ£€å‡º
      - uses: actions/checkout@v4
      
      # 2. ç¨³å®šè·å–ç‰ˆæœ¬ï¼ˆä¿®å¤ç‰ˆï¼‰
      - name: ğŸ” è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: get_versions
        run: |
          echo "=== è·å–ç¼–è¯‘å™¨ç‰ˆæœ¬ä¿¡æ¯ ==="
          
          # å®‰å…¨çš„ç‰ˆæœ¬è·å–å‡½æ•°
          get_version_safe() {
            local name=$1
            local url=$2
            local pattern=$3
            local default=$4
            
            echo "è·å– $name ç‰ˆæœ¬..."
            
            # å°è¯•è·å–ï¼Œæœ€å¤š3æ¬¡
            for i in {1..3}; do
              echo "  å°è¯• $i/3..."
              
              # ä½¿ç”¨curlï¼Œå¸¦è¶…æ—¶å’Œé‡è¯•
              if html=$(curl -s --max-time 15 --retry 1 "$url" 2>/dev/null); then
                if [ -n "$html" ]; then
                  # ä½¿ç”¨æ›´å®½æ¾çš„æ­£åˆ™è¡¨è¾¾å¼
                  version=$(echo "$html" | grep -o "$pattern" | sort -V | tail -1)
                  if [ -n "$version" ]; then
                    echo "  âœ… æˆåŠŸ: $version"
                    echo "$version"
                    return 0
                  fi
                fi
              fi
              
              sleep 1
            done
            
            echo "  âš ï¸ ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $default"
            echo "$default"
            return 1
          }
          
          # 1. GCCç‰ˆæœ¬ï¼ˆä½¿ç”¨å·²çŸ¥çš„OpenWrtå…¼å®¹ç‰ˆæœ¬ï¼‰
          echo "è·å–GCCç‰ˆæœ¬..."
          GCC_VERSION="11.3.0"  # OpenWrt 23.05ä½¿ç”¨çš„ç‰ˆæœ¬
          echo "ä½¿ç”¨OpenWrtå…¼å®¹ç‰ˆæœ¬: $GCC_VERSION"
          
          # 2. Binutilsç‰ˆæœ¬
          BINUTILS_VERSION="2.38"
          echo "Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          
          # 3. Linuxå†…æ ¸ç‰ˆæœ¬ï¼ˆè·å–5.15 LTSæœ€æ–°ç‰ˆï¼‰
          echo "è·å–Linuxå†…æ ¸ç‰ˆæœ¬..."
          LINUX_VERSION=$(get_version_safe "Linuxå†…æ ¸" \
            "https://cdn.kernel.org/pub/linux/kernel/v5.x/" \
            "5\\.15\\.[0-9]+" \
            "5.15.133")
          
          # 4. Muslç‰ˆæœ¬
          echo "è·å–Muslç‰ˆæœ¬..."
          MUSL_VERSION=$(get_version_safe "Musl" \
            "https://musl.libc.org/releases/" \
            "1\\.[0-9]+\\.[0-9]+" \
            "1.2.4")
          
          echo ""
          echo "ğŸ“¦ æœ€ç»ˆç‰ˆæœ¬é…ç½®:"
          echo "â”œâ”€ GCC: $GCC_VERSION"
          echo "â”œâ”€ Binutils: $BINUTILS_VERSION"
          echo "â”œâ”€ Linux Kernel: $LINUX_VERSION"
          echo "â””â”€ Musl: $MUSL_VERSION"
          
          # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
      
      # 3. æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        run: |
          echo "=== æ„å»ºé…ç½®ä¿¡æ¯ ==="
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          echo "ç¼–è¯‘å™¨è¾“å‡º: ${{ env.COMPILER_DIR }}"
          echo ""
          echo "ç‰ˆæœ¬ä¿¡æ¯:"
          echo "  GCC: ${{ steps.get_versions.outputs.gcc_version }}"
          echo "  Binutils: ${{ steps.get_versions.outputs.binutils_version }}"
          echo "  Linux: ${{ steps.get_versions.outputs.linux_version }}"
          echo "  Musl: ${{ steps.get_versions.outputs.musl_version }}"
          echo ""
          echo "ç³»ç»Ÿä¿¡æ¯:"
          echo "  CPU: $(nproc) cores"
          echo "  å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "  ç£ç›˜:"
          df -h /mnt
      
      # 4. å‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: ğŸ—ï¸ å‡†å¤‡ç¯å¢ƒ
        run: |
          echo "=== å‡†å¤‡æ„å»ºç¯å¢ƒ ==="
          
          # å®‰è£…ä¾èµ–
          echo "[1/4] æ›´æ–°åŒ…åˆ—è¡¨..."
          sudo apt-get update
          
          echo "[2/4] å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            gcc g++ make \
            flex bison \
            libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
            texinfo texlive \
            ncurses-dev libncursesw5-dev \
            python3 python3-dev \
            git wget curl ca-certificates \
            zlib1g-dev liblzma-dev \
            file pkg-config 2>&1 | tee /tmp/deps.log
          
          echo "[3/4] éªŒè¯å·¥å…·..."
          for tool in gcc g++ make flex bison; do
            if command -v $tool >/dev/null; then
              echo "  âœ… $tool: $($tool --version 2>&1 | head -1)"
            else
              echo "  âŒ $tool: æœªå®‰è£…"
            fi
          done
          
          echo "[4/4] åˆ›å»ºæ„å»ºç›®å½•..."
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          
          echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
      
      # 5. è·å–OpenWrtæºç å¹¶é…ç½®
      - name: ğŸ“¥ è·å–æºç 
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "[1/3] å…‹éš†æºç ..."
          git clone --depth 1 https://github.com/openwrt/openwrt.git . 2>&1 | tee /tmp/clone.log
          
          echo "[2/3] æ˜¾ç¤ºç‰ˆæœ¬..."
          echo "OpenWrtç‰ˆæœ¬: $(cat version.txt 2>/dev/null || echo 'æœªçŸ¥')"
          echo "å‘å¸ƒæ—¥æœŸ: $(cat release.txt 2>/dev/null || echo 'æœªçŸ¥')"
          
          echo "[3/3] åˆ›å»ºé…ç½®..."
          cat > .config << 'EOF'
          # äº¤å‰ç¼–è¯‘å™¨æ„å»ºé…ç½®
          # è‡ªåŠ¨ç”Ÿæˆäº $(date)
          
          # ç›®æ ‡å¹³å°ï¼ˆä½¿ç”¨é€šç”¨çš„ARM64å¹³å°ï¼‰
          CONFIG_TARGET_armsr=y
          CONFIG_TARGET_armsr_armv8=y
          
          # å·¥å…·é“¾é…ç½®
          CONFIG_TARGET_ROOTFS_INITRAMFS=y
          CONFIG_EXTERNAL_TOOLCHAIN=n
          CONFIG_USE_MUSL=y
          CONFIG_BUILD_TOOLCHAIN=y
          
          # ç‰ˆæœ¬é…ç½®
          CONFIG_GCC_VERSION="${{ steps.get_versions.outputs.gcc_version }}"
          CONFIG_BINUTILS_VERSION="${{ steps.get_versions.outputs.binutils_version }}"
          CONFIG_LINUX_VERSION="${{ steps.get_versions.outputs.linux_version }}"
          CONFIG_MUSL_VERSION="${{ steps.get_versions.outputs.musl_version }}"
          
          # ç¦ç”¨ä¸éœ€è¦çš„åŒ…
          CONFIG_PACKAGE_busybox=n
          CONFIG_PACKAGE_dnsmasq=n
          CONFIG_PACKAGE_firewall=n
          CONFIG_PACKAGE_luci=n
          CONFIG_PACKAGE_wpad=n
          EOF
          
          echo "âœ… æºç å‡†å¤‡å®Œæˆ"
          echo "é…ç½®æ–‡ä»¶å‰20è¡Œ:"
          head -20 .config
      
      # 6. åˆ†æ­¥ç¼–è¯‘ï¼ˆå¸¦è¯¦ç»†è¿›åº¦æ˜¾ç¤ºï¼‰
      - name: ğŸ”¨ ç¼–è¯‘è¿‡ç¨‹
        timeout-minutes: 180
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘è¿‡ç¨‹ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "æ„å»ºç›®å½•: $(pwd)"
          
          cd "${{ env.BUILD_DIR }}"
          
          # è®¾ç½®è¯¦ç»†è¾“å‡º
          export V=s
          export TERM=dumb
          export TERMINFO=/usr/share/terminfo
          export FORCE_UNSAFE_CONFIGURE=1
          
          # æ­¥éª¤è®¡æ•°å™¨
          STEP=1
          TOTAL_STEPS=6
          
          # å‡½æ•°ï¼šæ˜¾ç¤ºæ­¥éª¤ä¿¡æ¯
          show_step() {
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "æ­¥éª¤ $STEP/$TOTAL_STEPS: $1"
            echo "å¼€å§‹æ—¶é—´: $(date)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            STEP=$((STEP + 1))
          }
          
          # å‡½æ•°ï¼šæ£€æŸ¥æ­¥éª¤ç»“æœ
          check_result() {
            local status=$1
            local step_name=$2
            
            if [ $status -eq 0 ]; then
              echo "âœ… $step_name æˆåŠŸ"
              echo "ç»“æŸæ—¶é—´: $(date)"
              return 0
            else
              echo "âŒ $step_name å¤±è´¥ (é€€å‡ºç : $status)"
              echo "ç»“æŸæ—¶é—´: $(date)"
              return 1
            fi
          }
          
          # æ­¥éª¤1: ä¸‹è½½
          show_step "ä¸‹è½½ä¾èµ–åŒ…"
          make -j$(nproc) download V=s 2>&1 | tee /tmp/step1-download.log
          DOWNLOAD_STATUS=${PIPESTATUS[0]}
          
          if check_result $DOWNLOAD_STATUS "ä¸‹è½½"; then
            echo "ä¸‹è½½ç»Ÿè®¡:"
            echo "  - æ–‡ä»¶æ•°: $(find dl -type f 2>/dev/null | wc -l)"
            echo "  - æ€»å¤§å°: $(du -sh dl 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
          else
            echo "ä¸‹è½½å¤±è´¥æ—¥å¿—æœ€å50è¡Œ:"
            tail -50 /tmp/step1-download.log
            exit 1
          fi
          
          # æ­¥éª¤2: é…ç½®
          show_step "é…ç½®ç¼–è¯‘ç¯å¢ƒ"
          make defconfig V=s 2>&1 | tee /tmp/step2-defconfig.log
          DEFCONFIG_STATUS=${PIPESTATUS[0]}
          
          check_result $DEFCONFIG_STATUS "é…ç½®"
          
          # æ˜¾ç¤ºæœ€ç»ˆé…ç½®
          echo "æœ€ç»ˆé…ç½®æ‘˜è¦:"
          grep -E "CONFIG_(TARGET|GCC|BINUTILS|LINUX|MUSL)" .config | head -10
          
          # æ­¥éª¤3: ç¼–è¯‘binutils
          show_step "ç¼–è¯‘binutils (${{ steps.get_versions.outputs.binutils_version }})"
          timeout 45m make toolchain/binutils/compile -j1 V=s 2>&1 | tee /tmp/step3-binutils.log
          BINUTILS_STATUS=${PIPESTATUS[0]}
          
          if check_result $BINUTILS_STATUS "binutilsç¼–è¯‘"; then
            echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶:"
            find build_dir -path "*binutils*" \( -name "*.o" -o -name "*.a" \) 2>/dev/null | head -3 | while read file; do
              echo "  - $(basename "$file") ($(stat -c%s "$file" 2>/dev/null | numfmt --to=iec || echo '?' ))"
            done
          else
            echo "binutilsç¼–è¯‘é”™è¯¯:"
            grep -i "error\|failed" /tmp/step3-binutils.log | tail -20
            exit 1
          fi
          
          # æ­¥éª¤4: ç¼–è¯‘gccåˆå§‹é˜¶æ®µ
          show_step "ç¼–è¯‘gccåˆå§‹é˜¶æ®µ (${{ steps.get_versions.outputs.gcc_version }})"
          timeout 45m make toolchain/gcc/compile -j1 V=s 2>&1 | tee /tmp/step4-gcc-stage1.log
          GCC_STAGE1_STATUS=${PIPESTATUS[0]}
          
          check_result $GCC_STAGE1_STATUS "gccåˆå§‹é˜¶æ®µç¼–è¯‘"
          
          # æ­¥éª¤5: ç¼–è¯‘musl
          show_step "ç¼–è¯‘musl (${{ steps.get_versions.outputs.musl_version }})"
          timeout 30m make toolchain/musl/compile -j1 V=s 2>&1 | tee /tmp/step5-musl.log
          MUSL_STATUS=${PIPESTATUS[0]}
          
          check_result $MUSL_STATUS "muslç¼–è¯‘"
          
          # æ­¥éª¤6: ç¼–è¯‘å®Œæ•´gcc
          show_step "ç¼–è¯‘å®Œæ•´gcc"
          timeout 60m make toolchain/gcc/compile -j1 V=s 2>&1 | tee /tmp/step6-gcc-final.log
          GCC_FINAL_STATUS=${PIPESTATUS[0]}
          
          if check_result $GCC_FINAL_STATUS "å®Œæ•´gccç¼–è¯‘"; then
            echo "ğŸ‰ gccç¼–è¯‘æˆåŠŸï¼"
          else
            echo "gccç¼–è¯‘é”™è¯¯:"
            tail -30 /tmp/step6-gcc-final.log
            exit 1
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ æ‰€æœ‰ç¼–è¯‘æ­¥éª¤å®Œæˆï¼"
          echo "æ€»å¼€å§‹æ—¶é—´: $(grep 'å¼€å§‹æ—¶é—´' /tmp/step1-download.log | head -1 | cut -d: -f2-)"
          echo "æ€»ç»“æŸæ—¶é—´: $(date)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # 7. å®‰è£…å¹¶ä¿å­˜å·¥å…·é“¾
      - name: ğŸ“¦ ä¿å­˜å·¥å…·é“¾
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å¥½çš„å·¥å…·é“¾ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # å®‰è£…å·¥å…·é“¾
          echo "[1/3] å®‰è£…å·¥å…·é“¾..."
          make toolchain/install -j1 V=s 2>&1 | tee /tmp/install.log
          
          # æŸ¥æ‰¾å·¥å…·é“¾
          echo "[2/3] æŸ¥æ‰¾å·¥å…·é“¾..."
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            echo "å¯èƒ½çš„ç›®å½•:"
            find staging_dir -type d -name "toolchain*" 2>/dev/null
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°å·¥å…·é“¾: $(basename "$TOOLCHAIN_DIR")"
          
          # å¤åˆ¶åˆ°ä»“åº“
          echo "[3/3] å¤åˆ¶åˆ°ä»“åº“..."
          rm -rf "${{ env.COMPILER_DIR }}"
          mkdir -p "${{ env.COMPILER_DIR }}"
          
          cp -r "$TOOLCHAIN_DIR"/* "${{ env.COMPILER_DIR }}/"
          
          # åˆ›å»ºä¿¡æ¯æ–‡ä»¶
          cat > "${{ env.COMPILER_DIR }}/README.md" << EOF
          # OpenWrt äº¤å‰ç¼–è¯‘å™¨
          
          è‡ªåŠ¨æ„å»ºçš„äº¤å‰ç¼–è¯‘å™¨ï¼Œç”¨äºOpenWrt/ImmortalWrtå›ºä»¶ç¼–è¯‘ã€‚
          
          ## æ„å»ºä¿¡æ¯
          - **æ„å»ºæ—¶é—´**: $(date)
          - **å·¥ä½œæµ**: ${{ github.workflow }}
          - **è¿è¡ŒID**: ${{ github.run_id }}
          
          ## ç‰ˆæœ¬ä¿¡æ¯
          | ç»„ä»¶ | ç‰ˆæœ¬ |
          |------|------|
          | GCC | ${{ steps.get_versions.outputs.gcc_version }} |
          | Binutils | ${{ steps.get_versions.outputs.binutils_version }} |
          | Linuxå†…æ ¸ | ${{ steps.get_versions.outputs.linux_version }} |
          | Musl | ${{ steps.get_versions.outputs.musl_version }} |
          
          ## ç›®å½•ç»“æ„
          \`\`\`
          compiled/
          â”œâ”€â”€ bin/          # ç¼–è¯‘å™¨å¯æ‰§è¡Œæ–‡ä»¶
          â”œâ”€â”€ include/      # å¤´æ–‡ä»¶
          â”œâ”€â”€ lib/         # åº“æ–‡ä»¶
          â””â”€â”€ README.md    # æœ¬æ–‡æ¡£
          \`\`\`
          
          ## ä½¿ç”¨æ–¹æ³•
          åœ¨OpenWrtæ„å»ºä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
          \`\`\`bash
          export STAGING_DIR=/path/to/this/compiler
          \`\`\`
          
          æˆ–ç›´æ¥åœ¨makeå‘½ä»¤ä¸­æŒ‡å®šï¼š
          \`\`\`bash
          make STAGING_DIR=/path/to/this/compiler
          \`\`\`
          EOF
          
          # æµ‹è¯•ç¼–è¯‘å™¨
          echo "ğŸ”§ æµ‹è¯•ç¼–è¯‘å™¨åŠŸèƒ½..."
          GCC_PATH=$(find "${{ env.COMPILER_DIR }}" -name "*gcc" -type f | head -1)
          if [ -n "$GCC_PATH" ]; then
            echo "ç¼–è¯‘å™¨è·¯å¾„: $GCC_PATH"
            $GCC_PATH --version 2>&1 | head -1
          fi
          
          echo "ğŸ“¦ å·¥å…·é“¾å¤§å°: $(du -sh "${{ env.COMPILER_DIR }}" | cut -f1)"
          echo "ğŸ“ æ–‡ä»¶æ•°é‡: $(find "${{ env.COMPILER_DIR }}" -type f 2>/dev/null | wc -l)"
      
      # 8. æäº¤åˆ°ä»“åº“
      - name: ğŸ“¤ æäº¤æ›´æ–°
        run: |
          echo "=== æäº¤åˆ°ä»“åº“ ==="
          
          cd "${{ github.workspace }}"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          
          # æ£€æŸ¥å˜æ›´
          if git diff --quiet "firmware-config/build-Compiler-file/compiled" 2>/dev/null; then
            echo "âœ… ç¼–è¯‘å™¨æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            echo "ğŸ”„ æ£€æµ‹åˆ°ç¼–è¯‘å™¨æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."
            
            git add "firmware-config/build-Compiler-file/compiled"
            
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            SIZE=$(du -sh "firmware-config/build-Compiler-file/compiled" | cut -f1)
            
            git commit -m "build(compiler): æ›´æ–°äº¤å‰ç¼–è¯‘å™¨

            ç‰ˆæœ¬ä¿¡æ¯:
            - GCC: ${{ steps.get_versions.outputs.gcc_version }}
            - Binutils: ${{ steps.get_versions.outputs.binutils_version }}
            - Linuxå†…æ ¸: ${{ steps.get_versions.outputs.linux_version }}
            - Musl: ${{ steps.get_versions.outputs.musl_version }}
            
            æ„å»ºè¯¦æƒ…:
            - å¤§å°: $SIZE
            - æ—¶é—´: $(date '+%Y-%m-%d %H:%M')
            - å·¥ä½œæµ: ${{ github.workflow }}
            
            ç”¨äºOpenWrtå›ºä»¶æ„å»ºã€‚"
            
            # æ¨é€
            echo "ğŸš€ æ¨é€åˆ°ä»“åº“..."
            git push
            
            echo "ğŸ‰ ç¼–è¯‘å™¨å·²æäº¤åˆ°ä»“åº“"
          fi
      
      # 9. ä¸Šä¼ æ—¥å¿—
      - name: ğŸ“„ ä¸Šä¼ æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compiler-logs-$(date +%Y%m%d-%H%M%S)
          path: |
            /tmp/*.log
            ${{ env.BUILD_DIR }}/.config
          retention-days: 7
