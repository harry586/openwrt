# .github/workflows/compiler-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '21.02.5'
        type: choice
        options: ['21.02.5', '22.03.5', '23.05.2']
      arch_type:
        description: 'æ¶æ„ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options: ['all', 'arm', 'mips', 'x86', 'riscv', 'aarch64']

env:
  COMPILER_BASE_DIR: "./firmware-config/build-Compiler-file"
  BUILD_BASE_DIR: "/mnt/compiler-build"

jobs:
  build-and-push:
    runs-on: ubuntu-22.04
    timeout-minutes: 420
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: â° è·å–å¼€å§‹æ—¶é—´
        id: get-time
        run: |
          echo "start_time=$(date)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ è®¾ç½®æ„å»ºç›®å½•æƒé™
        run: |
          echo "=== è®¾ç½®æ„å»ºç›®å½•æƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $USER:$USER /mnt/compiler-build 2>/dev/null || true

      - name: ğŸ—ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          mkdir -p "${{ env.BUILD_BASE_DIR }}"
          echo "ç¼–è¯‘å™¨åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "æ„å»ºåŸºç¡€ç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„åˆ—è¡¨
        id: setup-arch
        run: |
          echo "=== è®¾ç½®ç›®æ ‡æ¶æ„åˆ—è¡¨ ==="
          ARCH_TYPE="${{ github.event.inputs.arch_type }}"
          
          if [ "$ARCH_TYPE" = "all" ]; then
            ARCH_LIST='["arm_cortex-a7","arm_cortex-a9","arm_cortex-a15","aarch64","x86_64","mips","mipsel","riscv64"]'
            echo "âœ… é€‰æ‹©æ‰€æœ‰æ¶æ„ç±»å‹"
          elif [ "$ARCH_TYPE" = "arm" ]; then
            ARCH_LIST='["arm_cortex-a7","arm_cortex-a9","arm_cortex-a15"]'
            echo "âœ… é€‰æ‹©32ä½ARMæ¶æ„"
          elif [ "$ARCH_TYPE" = "mips" ]; then
            ARCH_LIST='["mips","mipsel"]'
            echo "âœ… é€‰æ‹©MIPSæ¶æ„"
          elif [ "$ARCH_TYPE" = "x86" ]; then
            ARCH_LIST='["x86_64"]'
            echo "âœ… é€‰æ‹©x86æ¶æ„"
          elif [ "$ARCH_TYPE" = "riscv" ]; then
            ARCH_LIST='["riscv64"]'
            echo "âœ… é€‰æ‹©RISC-Væ¶æ„"
          elif [ "$ARCH_TYPE" = "aarch64" ]; then
            ARCH_LIST='["aarch64"]'
            echo "âœ… é€‰æ‹©AArch64æ¶æ„"
          else
            ARCH_LIST='["aarch64"]'
            echo "âš ï¸ æœªçŸ¥ç±»å‹ï¼Œé»˜è®¤é€‰æ‹©AArch64"
          fi
          echo "ç›®æ ‡æ¶æ„åˆ—è¡¨: $ARCH_LIST"
          echo "arch_list=$ARCH_LIST" >> $GITHUB_OUTPUT

      - name: ğŸ” ç‰ˆæœ¬æ£€æµ‹
        id: version-detection
        run: |
          echo "=== ç‰ˆæœ¬æ£€æµ‹ ==="
          OPENWRT_VERSION="${{ github.event.inputs.openwrt_version }}"
          echo "ç”¨æˆ·é€‰æ‹©çš„OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          if [ "$OPENWRT_VERSION" = "21.02.5" ]; then
            BINUTILS_VERSION="2.36.1"
            LINUX_VERSION="5.4.188"
            MUSL_VERSION="1.2.2"
            echo "â„¹ï¸ OpenWrt 21.02.5"
          elif [ "$OPENWRT_VERSION" = "22.03.5" ]; then
            BINUTILS_VERSION="2.38"
            LINUX_VERSION="5.10.179"
            MUSL_VERSION="1.2.3"
            echo "âœ… OpenWrt 22.03.5"
          elif [ "$OPENWRT_VERSION" = "23.05.2" ]; then
            BINUTILS_VERSION="2.40"
            LINUX_VERSION="5.15.133"
            MUSL_VERSION="1.2.4"
            echo "âœ… OpenWrt 23.05.2"
          fi
          echo "openwrt_version=$OPENWRT_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          echo "=== å®‰è£…æ„å»ºä¾èµ– ==="
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison git wget curl file gawk gettext rsync unzip autoconf automake libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev libelf-dev libdw-dev libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev python3 python3-dev libncurses5-dev libssl-dev liblzma-dev zlib1g-dev

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "OpenWrtç‰ˆæœ¬: ${{ steps.version-detection.outputs.openwrt_version }}"
          echo "æ¶æ„ç±»å‹: ${{ github.event.inputs.arch_type }}"
          echo "ç›®æ ‡æ¶æ„: ${{ steps.setup-arch.outputs.arch_list }}"
          echo "Cåº“ç±»å‹: musl"
          echo "Binutilsç‰ˆæœ¬: ${{ steps.version-detection.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ steps.version-detection.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ steps.version-detection.outputs.musl_version }}"
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "è¾“å‡ºç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "========================================"

      - name: ğŸ—ï¸ æ„å»ºæ‰€æœ‰ç¼–è¯‘å™¨
        id: build-compilers
        run: |
          echo "=== æ„å»ºæ‰€æœ‰ç¼–è¯‘å™¨ ==="
          
          # è·å–æ¶æ„åˆ—è¡¨
          ARCH_LIST='${{ steps.setup-arch.outputs.arch_list }}'
          echo "æ¶æ„åˆ—è¡¨: $ARCH_LIST"
          
          # å°†JSONæ•°ç»„è½¬æ¢ä¸ºbashæ•°ç»„
          eval "ARCH_ARRAY=($ARCH_LIST)"
          
          BUILD_RESULTS=""
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          for ARCH in "${ARCH_ARRAY[@]}"; do
            echo ""
            echo "========================================"
            echo "æ„å»ºæ¶æ„: $ARCH"
            echo "========================================"
            
            # è®¾ç½®æ¶æ„å‚æ•°
            if [ "$ARCH" = "arm_cortex-a7" ]; then
              TARGET="sunxi"
              SUBTARGET="cortexa7"
              PREFIX="arm-openwrt-linux-muslgnueabi"
              CPU_TYPE="cortex-a7"
              ARCH_TYPE_TITLE="ARM Cortex-A7 (32ä½)"
            elif [ "$ARCH" = "arm_cortex-a9" ]; then
              TARGET="mediatek"
              SUBTARGET="mt7623"
              PREFIX="arm-openwrt-linux-muslgnueabi"
              CPU_TYPE="cortex-a9"
              ARCH_TYPE_TITLE="ARM Cortex-A9 (32ä½)"
            elif [ "$ARCH" = "arm_cortex-a15" ]; then
              TARGET="ipq806x"
              SUBTARGET="generic"
              PREFIX="arm-openwrt-linux-muslgnueabi"
              CPU_TYPE="cortex-a15"
              ARCH_TYPE_TITLE="ARM Cortex-A15 (32ä½)"
            elif [ "$ARCH" = "aarch64" ]; then
              TARGET="armvirt"
              SUBTARGET="64"
              PREFIX="aarch64-openwrt-linux-musl"
              CPU_TYPE="cortex-a53"
              ARCH_TYPE_TITLE="AArch64 (64ä½)"
            elif [ "$ARCH" = "x86_64" ]; then
              TARGET="x86"
              SUBTARGET="64"
              PREFIX="x86_64-openwrt-linux-musl"
              CPU_TYPE=""
              ARCH_TYPE_TITLE="x86_64 (64ä½)"
            elif [ "$ARCH" = "mips" ]; then
              TARGET="ath79"
              SUBTARGET="generic"
              PREFIX="mips-openwrt-linux-musl"
              CPU_TYPE="24kc"
              ARCH_TYPE_TITLE="MIPS (å¤§ç«¯)"
            elif [ "$ARCH" = "mipsel" ]; then
              TARGET="ramips"
              SUBTARGET="mt7621"
              PREFIX="mipsel-openwrt-linux-musl"
              CPU_TYPE="24kc"
              ARCH_TYPE_TITLE="MIPSel (å°ç«¯)"
            elif [ "$ARCH" = "riscv64" ]; then
              TARGET="virt"
              SUBTARGET="rv64"
              PREFIX="riscv64-openwrt-linux-musl"
              CPU_TYPE=""
              ARCH_TYPE_TITLE="RISC-V 64ä½"
            fi
            
            echo "ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
            echo "ç¼–è¯‘å™¨å‰ç¼€: $PREFIX"
            
            # åˆ›å»ºæ„å»ºç›®å½•
            BUILD_ID="${ARCH}_musl_openwrt-${{ steps.version-detection.outputs.openwrt_version }}_$(date +%Y%m%d_%H%M%S)"
            BUILD_DIR="${{ env.BUILD_BASE_DIR }}/${BUILD_ID}"
            mkdir -p "$BUILD_DIR"
            
            echo "æ„å»ºç›®å½•: $BUILD_DIR"
            cd "$BUILD_DIR"
            
            # ä¸‹è½½OpenWrtæºç 
            echo "ä¸‹è½½OpenWrtæºç ..."
            git clone --depth 1 --branch "v${{ steps.version-detection.outputs.openwrt_version }}" https://github.com/openwrt/openwrt.git .
            
            # æ›´æ–°feeds
            echo "æ›´æ–°feeds..."
            ./scripts/feeds update -a
            ./scripts/feeds install -a
            
            # é…ç½®
            echo "é…ç½®ç›®æ ‡å¹³å°..."
            rm -f .config
            
            if [ "$ARCH" = "arm_cortex-a7" ]; then
              echo "CONFIG_TARGET_sunxi=y" > .config
              echo "CONFIG_TARGET_sunxi_cortexa7=y" >> .config
              echo "CONFIG_TARGET_ARCH_PACKAGES=\"arm_cortex-a7_neon-vfpv4\"" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv7-a -mtune=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard\"" >> .config
            elif [ "$ARCH" = "arm_cortex-a9" ]; then
              echo "CONFIG_TARGET_mediatek=y" > .config
              echo "CONFIG_TARGET_mediatek_mt7623=y" >> .config
              echo "CONFIG_TARGET_ARCH_PACKAGES=\"arm_cortex-a9_neon-vfpv4-d16\"" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv7-a -mtune=cortex-a9 -mfpu=neon-vfpv4-d16 -mfloat-abi=hard\"" >> .config
            elif [ "$ARCH" = "arm_cortex-a15" ]; then
              echo "CONFIG_TARGET_ipq806x=y" > .config
              echo "CONFIG_TARGET_ipq806x_generic=y" >> .config
              echo "CONFIG_TARGET_ARCH_PACKAGES=\"arm_cortex-a15_neon-vfpv4\"" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv7-a -mtune=cortex-a15 -mfpu=neon-vfpv4 -mfloat-abi=hard\"" >> .config
            elif [ "$ARCH" = "aarch64" ]; then
              echo "CONFIG_TARGET_armvirt=y" > .config
              echo "CONFIG_TARGET_armvirt_64=y" >> .config
              echo "CONFIG_TARGET_ARCH_PACKAGES=\"aarch64_generic\"" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv8-a -mtune=cortex-a53\"" >> .config
            elif [ "$ARCH" = "x86_64" ]; then
              echo "CONFIG_TARGET_x86=y" > .config
              echo "CONFIG_TARGET_x86_64=y" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=x86-64 -mtune=generic\"" >> .config
            elif [ "$ARCH" = "mips" ]; then
              echo "CONFIG_TARGET_ath79=y" > .config
              echo "CONFIG_TARGET_ath79_generic=y" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=74kc -mtune=74kc\"" >> .config
            elif [ "$ARCH" = "mipsel" ]; then
              echo "CONFIG_TARGET_ramips=y" > .config
              echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=24kc -mtune=24kc\"" >> .config
            elif [ "$ARCH" = "riscv64" ]; then
              echo "CONFIG_TARGET_virt=y" > .config
              echo "CONFIG_TARGET_virt_rv64=y" >> .config
              echo "CONFIG_TARGET_OPTIMIZATION=\"-march=rv64gc -mtune=generic\"" >> .config
            fi
            
            # é€šç”¨é…ç½®
            echo "CONFIG_SDK=y" >> .config
            echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
            echo "CONFIG_TOOLCHAINOPTS=y" >> .config
            echo "CONFIG_DEVEL=y" >> .config
            echo "CONFIG_LIBC=\"musl\"" >> .config
            echo "CONFIG_USE_MUSL=y" >> .config
            echo "CONFIG_TARGET_ROOTFS_INITRAMFS=n" >> .config
            echo "CONFIG_TARGET_ROOTFS_EXT4FS=n" >> .config
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=n" >> .config
            echo "CONFIG_TARGET_PREINITOPT=y" >> .config
            
            # åº”ç”¨é…ç½®
            yes "" | make defconfig
            
            # ä¸‹è½½æºç 
            echo "ä¸‹è½½æºç ..."
            make -j$(nproc) download
            
            # æ„å»ºå·¥å…·é“¾
            echo "æ„å»ºå·¥å…·é“¾..."
            START_TIME=$(date +%s)
            make toolchain/clean
            make toolchain/compile -j$(nproc)
            make toolchain/install -j$(nproc)
            END_TIME=$(date +%s)
            BUILD_TIME=$((END_TIME - START_TIME))
            
            # æŸ¥æ‰¾ç¼–è¯‘å™¨
            COMPILER=$(find staging_dir -name "*gcc" -type f -executable 2>/dev/null | head -1)
            if [ -n "$COMPILER" ]; then
              COMPILER_NAME=$(basename "$COMPILER")
              COMPILER_VERSION=$("$COMPILER" --version 2>&1 | head -1)
              GCC_VERSION=$(echo "$COMPILER_VERSION" | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1 || echo "unknown")
              
              echo "âœ… ç¼–è¯‘å™¨æ„å»ºæˆåŠŸ: $COMPILER_NAME v$GCC_VERSION"
              echo "æ„å»ºæ—¶é—´: ${BUILD_TIME}ç§’"
              
              # ä¿å­˜æ„å»ºç»“æœ
              OUTPUT_BASE_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH}/musl/openwrt-${{ steps.version-detection.outputs.openwrt_version }}"
              mkdir -p "$OUTPUT_BASE_DIR"
              
              OUTPUT_DIR="${OUTPUT_BASE_DIR}/gcc-${GCC_VERSION}_$(date +%Y%m%d_%H%M%S)"
              mkdir -p "$OUTPUT_DIR"
              
              echo "ä¿å­˜åˆ°: $OUTPUT_DIR"
              
              # å¤åˆ¶å·¥å…·é“¾
              if [ -d "staging_dir" ]; then
                echo "å¤åˆ¶å·¥å…·é“¾..."
                cp -r staging_dir/* "$OUTPUT_DIR/" 2>&1 | tail -5 || echo "å¤åˆ¶é‡åˆ°é—®é¢˜ï¼Œç»§ç»­..."
                
                # åˆ›å»ºå…ƒæ•°æ®
                METADATA_FILE="$OUTPUT_DIR/metadata.txt"
                echo "æ¶æ„: $ARCH" > "$METADATA_FILE"
                echo "å¹³å°: $TARGET/$SUBTARGET" >> "$METADATA_FILE"
                echo "OpenWrtç‰ˆæœ¬: ${{ steps.version-detection.outputs.openwrt_version }}" >> "$METADATA_FILE"
                echo "ç¼–è¯‘å™¨: $COMPILER_NAME" >> "$METADATA_FILE"
                echo "ç¼–è¯‘å™¨ç‰ˆæœ¬: $GCC_VERSION" >> "$METADATA_FILE"
                echo "Cåº“: musl ${{ steps.version-detection.outputs.musl_version }}" >> "$METADATA_FILE"
                echo "æ„å»ºæ—¶é—´: $(date)" >> "$METADATA_FILE"
                echo "æ„å»ºè€—æ—¶: ${BUILD_TIME}ç§’" >> "$METADATA_FILE"
                echo "å‰ç¼€: $PREFIX" >> "$METADATA_FILE"
                
                TOTAL_SIZE=$(du -sh "$OUTPUT_DIR" 2>/dev/null | cut -f1 || echo "0K")
                FILE_COUNT=$(find "$OUTPUT_DIR" -type f 2>/dev/null | wc -l || echo 0)
                
                echo "âœ… ä¿å­˜æˆåŠŸ - å¤§å°: $TOTAL_SIZE, æ–‡ä»¶æ•°: $FILE_COUNT"
                
                BUILD_RESULTS="${BUILD_RESULTS}âœ… $ARCH_TYPE_TITLE: $COMPILER_NAME v$GCC_VERSION\n"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              fi
            else
              echo "âŒ ç¼–è¯‘å™¨æ„å»ºå¤±è´¥"
              BUILD_RESULTS="${BUILD_RESULTS}âŒ $ARCH_TYPE_TITLE: æ„å»ºå¤±è´¥\n"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
            
            # æ¸…ç†æ„å»ºç›®å½•
            cd /
            rm -rf "$BUILD_DIR"
            echo "æ¸…ç†æ„å»ºç›®å½•å®Œæˆ"
          done
          
          echo ""
          echo "========================================"
          echo "æ‰€æœ‰æ¶æ„æ„å»ºå®Œæˆ"
          echo "========================================"
          echo "æ„å»ºç»“æœ:"
          echo -e "$BUILD_RESULTS"
          echo "æˆåŠŸ: $SUCCESS_COUNT, å¤±è´¥: $FAIL_COUNT"
          
          # ä¿å­˜ç»“æœåˆ°ç¯å¢ƒå˜é‡
          echo "BUILD_RESULTS<<EOF" >> $GITHUB_OUTPUT
          echo -e "$BUILD_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "FAIL_COUNT=$FAIL_COUNT" >> $GITHUB_OUTPUT

      - name: ğŸ“Š æ£€æŸ¥æœ€ç»ˆç»“æœ
        run: |
          echo "=== æ£€æŸ¥æœ€ç»ˆç»“æœ ==="
          COMPILER_DIR="${{ env.COMPILER_BASE_DIR }}"
          
          echo "ç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
          ls -la "$COMPILER_DIR" 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
          
          if [ -d "$COMPILER_DIR" ]; then
            echo "æ–‡ä»¶ç»Ÿè®¡:"
            find "$COMPILER_DIR" -type f 2>/dev/null | wc -l | xargs echo "æ–‡ä»¶æ€»æ•°:"
            find "$COMPILER_DIR" -type d 2>/dev/null | wc -l | xargs echo "ç›®å½•æ€»æ•°:"
            
            echo "ç›®å½•ç»“æ„:"
            find "$COMPILER_DIR" -type d 2>/dev/null | head -30 || true
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨"
          fi

      - name: ğŸ“¤ æ¨é€æ–‡ä»¶åˆ°ä»“åº“
        run: |
          echo "=== æ¨é€ç¼–è¯‘å™¨æ–‡ä»¶åˆ°ä»“åº“ ==="
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          FILE_COUNT=$(find "${{ env.COMPILER_BASE_DIR }}" -type f 2>/dev/null | wc -l)
          echo "æ‰¾åˆ° $FILE_COUNT ä¸ªæ–‡ä»¶"
          
          if [ $FILE_COUNT -eq 0 ]; then
            echo "âš ï¸ æ²¡æœ‰æ–‡ä»¶å¯æ¨é€"
            echo "SKIP_PUSH=true" >> $GITHUB_ENV
          else
            echo "âœ… æœ‰æ–‡ä»¶å¯æ¨é€"
            echo "SKIP_PUSH=false" >> $GITHUB_ENV
          fi

      - name: ğŸ”„ æäº¤å’Œæ¨é€
        if: env.SKIP_PUSH == 'false'
        run: |
          echo "=== æäº¤å’Œæ¨é€ ==="
          
          # æ·»åŠ æ–‡ä»¶
          git add -f "${{ env.COMPILER_BASE_DIR }}"
          
          # æ£€æŸ¥æ·»åŠ çš„æ–‡ä»¶
          ADDED_FILES=$(git status --porcelain | wc -l)
          echo "æ·»åŠ äº† $ADDED_FILES ä¸ªæ–‡ä»¶"
          
          if [ $ADDED_FILES -eq 0 ]; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œåˆ›å»ºç©ºæäº¤"
            git commit --allow-empty -m "build(compiler): äº¤å‰ç¼–è¯‘å™¨æ„å»º" -m "OpenWrt: ${{ steps.version-detection.outputs.openwrt_version }}" -m "æ¶æ„: ${{ github.event.inputs.arch_type }}" -m "çŠ¶æ€: æ— æ–°æ–‡ä»¶" -m "æ—¶é—´: $(date)"
          else
            echo "æäº¤æ–‡ä»¶..."
            # è·å–æ„å»ºç»“æœ
            BUILD_RESULTS="${{ steps.build-compilers.outputs.BUILD_RESULTS }}"
            SUCCESS_COUNT="${{ steps.build-compilers.outputs.SUCCESS_COUNT }}"
            FAIL_COUNT="${{ steps.build-compilers.outputs.FAIL_COUNT }}"
            
            git commit -m "build(compiler): æ·»åŠ äº¤å‰ç¼–è¯‘å™¨" \
              -m "OpenWrt: ${{ steps.version-detection.outputs.openwrt_version }}" \
              -m "æ¶æ„: ${{ github.event.inputs.arch_type }}" \
              -m "æˆåŠŸ: $SUCCESS_COUNT, å¤±è´¥: $FAIL_COUNT" \
              -m "æ„å»ºç»“æœ:" \
              -m "$BUILD_RESULTS" \
              -m "æ—¶é—´: $(date)"
          fi
          
          echo "æ¨é€æ›´æ”¹..."
          git push origin main --force-with-lease
          echo "âœ… æ¨é€å®Œæˆ"

      - name: ğŸ“ æœ€ç»ˆæŠ¥å‘Š
        if: always()
        run: |
          echo "========================================"
          echo "           ğŸ¯ æ„å»ºä»»åŠ¡æ€»ç»“              "
          echo "========================================"
          echo "ä»»åŠ¡ä¿¡æ¯:"
          echo "- OpenWrtç‰ˆæœ¬: ${{ steps.version-detection.outputs.openwrt_version }}"
          echo "- æ¶æ„ç±»å‹: ${{ github.event.inputs.arch_type }}"
          echo "- å¼€å§‹æ—¶é—´: ${{ steps.get-time.outputs.start_time }}"
          echo "- ç»“æŸæ—¶é—´: $(date)"
          
          DURATION=$(( ($(date +%s) - $(date -d "${{ steps.get-time.outputs.start_time }}" +%s)) / 60 ))
          echo "- æ„å»ºæ—¶é•¿: ${DURATION}åˆ†é’Ÿ"
          
          echo ""
          echo "æ„å»ºç»“æœ:"
          echo "${{ steps.build-compilers.outputs.BUILD_RESULTS }}"
          
          echo ""
          echo "æ„å»ºç»Ÿè®¡:"
          echo "- æˆåŠŸ: ${{ steps.build-compilers.outputs.SUCCESS_COUNT }}"
          echo "- å¤±è´¥: ${{ steps.build-compilers.outputs.FAIL_COUNT }}"
          
          echo ""
          echo "è¾“å‡ºä½ç½®: ${{ env.COMPILER_BASE_DIR }}"
          echo "========================================"
