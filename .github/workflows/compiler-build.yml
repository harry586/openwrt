# .github/workflows/compiler-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '21.02.5'
        type: choice
        options: ['21.02.5', '22.03.5', '23.05.2']
      arch_type:
        description: 'æ¶æ„ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options: ['all', 'arm', 'mips', 'x86', 'riscv', 'aarch64']

env:
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"
  BUILD_BASE_DIR: "/mnt/compiler-build"

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      arch_list: ${{ steps.setup-arch.outputs.arch_list }}
      openwrt_version: ${{ steps.version-detection.outputs.openwrt_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      start_time: ${{ steps.get-time.outputs.start_time }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: â° è·å–å¼€å§‹æ—¶é—´
        id: get-time
        run: |
          echo "start_time=$(date)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ è®¾ç½®æ„å»ºç›®å½•æƒé™
        run: |
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $USER:$USER /mnt/compiler-build 2>/dev/null || true

      - name: ğŸ—ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          mkdir -p "${{ env.BUILD_BASE_DIR }}"
          echo "ç¼–è¯‘å™¨åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "æ„å»ºåŸºç¡€ç›®å½•: ${{ env.BUILD_BASE_DIR }}"

      - name: ğŸ”§ è®¾ç½®æ¶æ„åˆ—è¡¨
        id: setup-arch
        run: |
          ARCH_TYPE="${{ github.event.inputs.arch_type }}"
          case "$ARCH_TYPE" in
            'all')
              ARCH_LIST='["aarch64","x86_64","mips","mipsel","arm_cortex-a7","arm_cortex-a53","riscv64"]'
              echo "âœ… é€‰æ‹©æ‰€æœ‰æ¶æ„ç±»å‹"
              ;;
            'arm')
              ARCH_LIST='["arm_cortex-a7","arm_cortex-a53"]'
              echo "âœ… é€‰æ‹©ARMæ¶æ„"
              ;;
            'mips')
              ARCH_LIST='["mips","mipsel"]'
              echo "âœ… é€‰æ‹©MIPSæ¶æ„"
              ;;
            'x86')
              ARCH_LIST='["x86_64"]'
              echo "âœ… é€‰æ‹©x86æ¶æ„"
              ;;
            'riscv')
              ARCH_LIST='["riscv64"]'
              echo "âœ… é€‰æ‹©RISC-Væ¶æ„"
              ;;
            'aarch64')
              ARCH_LIST='["aarch64"]'
              echo "âœ… é€‰æ‹©AArch64æ¶æ„"
              ;;
            *)
              ARCH_LIST='["aarch64"]'
              echo "âš ï¸ æœªçŸ¥ç±»å‹ï¼Œé»˜è®¤é€‰æ‹©AArch64"
              ;;
          esac
          echo "ç›®æ ‡æ¶æ„åˆ—è¡¨: $ARCH_LIST"
          echo "arch_list=$ARCH_LIST" >> $GITHUB_OUTPUT

      - name: ğŸ” ç‰ˆæœ¬æ£€æµ‹
        id: version-detection
        run: |
          OPENWRT_VERSION="${{ github.event.inputs.openwrt_version }}"
          case "$OPENWRT_VERSION" in
            '21.02.5')
              BINUTILS_VERSION="2.36.1"
              LINUX_VERSION="5.4.188"
              MUSL_VERSION="1.2.2"
              ;;
            '22.03.5')
              BINUTILS_VERSION="2.38"
              LINUX_VERSION="5.10.179"
              MUSL_VERSION="1.2.3"
              ;;
            '23.05.2')
              BINUTILS_VERSION="2.40"
              LINUX_VERSION="5.15.133"
              MUSL_VERSION="1.2.4"
              ;;
            *)
              OPENWRT_VERSION="21.02.5"
              BINUTILS_VERSION="2.36.1"
              LINUX_VERSION="5.4.188"
              MUSL_VERSION="1.2.2"
              ;;
          esac
          echo "openwrt_version=$OPENWRT_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT

  build-matrix:
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJSON(needs.setup.outputs.arch_list) }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”§ è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™
        run: |
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $(whoami):$(whoami) /mnt/compiler-build 2>/dev/null || true

      - name: ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨
        run: |
          ARCH="${{ matrix.arch }}"
          OPENWRT_VERSION='${{ needs.setup.outputs.openwrt_version }}'
          OUTPUT_BASE_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH}/musl/openwrt-${OPENWRT_VERSION}"
          if [ -d "$OUTPUT_BASE_DIR" ]; then
            SUBDIRS=$(find "$OUTPUT_BASE_DIR" -maxdepth 1 -type d -name "gcc-*" 2>/dev/null | wc -l)
            if [ "$SUBDIRS" -gt 0 ]; then
              echo "SKIP_BUILD=true" >> $GITHUB_ENV
            else
              echo "SKIP_BUILD=false" >> $GITHUB_ENV
            fi
          else
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: â­ï¸ è·³è¿‡æ„å»º
        if: env.SKIP_BUILD == 'true'
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æ„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
          echo "- æ¶æ„: ${{ matrix.arch }}"
          echo "- OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "========================================"

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æ¶æ„: ${{ matrix.arch }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "Cåº“ç±»å‹: musl"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ› è°ƒè¯•ä¿¡æ¯
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "æ¶æ„: ${{ matrix.arch }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
          uname -a
          lsb_release -a 2>/dev/null || cat /etc/os-release
          echo "=== ç£ç›˜ç©ºé—´ ==="
          df -h
          echo "=== å†…å­˜ä¿¡æ¯ ==="
          free -h

      - name: ğŸ”§ è®¾ç½®æ¶æ„ç¯å¢ƒ
        id: setup-env
        if: env.SKIP_BUILD != 'true'
        run: |
          ARCH="${{ matrix.arch }}"
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="ipq40xx"
              SUBTARGET="generic"
              ARCH_NAME="arm"
              PREFIX="arm-openwrt-linux-musl"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              PREFIX="aarch64-openwrt-linux-musl"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              PREFIX="x86_64-openwrt-linux-musl"
              CPU_TYPE="x86-64"
              TUNE="generic"
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              PREFIX="mips-openwrt-linux-musl"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              PREFIX="mipsel-openwrt-linux-musl"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ;;
            arm_cortex-a53)
              TARGET="rockchip"
              SUBTARGET="armv8"
              ARCH_NAME="aarch64"
              PREFIX="aarch64-openwrt-linux-musl"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              PREFIX="riscv64-openwrt-linux-musl"
              CPU_TYPE="generic"
              TUNE="generic"
              ;;
          esac
          BUILD_ID="${ARCH}_musl_openwrt-${{ needs.setup.outputs.openwrt_version }}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="${{ env.BUILD_BASE_DIR }}/${BUILD_ID}"
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "MATRIX_ARCH=$ARCH" >> $GITHUB_ENV

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        if: env.SKIP_BUILD != 'true'
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential gcc g++ make flex bison git wget curl file gawk \
            gettext rsync unzip autoconf automake libtool pkg-config texinfo \
            gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq \
            liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev \
            libsqlite3-dev libffi-dev libelf-dev libdw-dev libgmp-dev libmpfr-dev \
            libmpc-dev libisl-dev libgnutls28-dev python3 python3-dev \
            libncurses5-dev libssl-dev liblzma-dev zlib1g-dev

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        if: env.SKIP_BUILD != 'true'
        run: |
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          git clone --depth 1 --branch "v${{ needs.setup.outputs.openwrt_version }}" https://github.com/openwrt/openwrt.git .
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"

      - name: âš™ï¸ é…ç½®OpenWrtæ„å»ºç¯å¢ƒ
        if: env.SKIP_BUILD != 'true'
        run: |
          cd "$BUILD_DIR"
          echo "=== é…ç½®OpenWrtæ„å»ºç¯å¢ƒ ==="
          echo "æ­¥éª¤1: æ›´æ–°feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo "æ­¥éª¤2: é…ç½®ç›®æ ‡å¹³å°..."
          rm -f .config
          
          # æ ¹æ®æ¶æ„é…ç½®
          case "$ARCH_NAME" in
            arm)
              echo "CONFIG_TARGET_arm=y" > .config
              if [ "$MATRIX_ARCH" = "arm_cortex-a7" ]; then
                # arm_cortex-a7 éœ€è¦ç‰¹å®šçš„é…ç½®
                echo "CONFIG_TARGET_arm_cortex-a7=y" >> .config
                echo "CONFIG_TARGET_arm_cortex-a7_neon-vfpv4=y" >> .config
              else
                echo "CONFIG_TARGET_arm_cortex-a53=y" >> .config
              fi
              ;;
            aarch64)
              echo "CONFIG_TARGET_armvirt=y" > .config
              echo "CONFIG_TARGET_armvirt_64=y" >> .config
              ;;
            x86_64)
              echo "CONFIG_TARGET_x86=y" > .config
              echo "CONFIG_TARGET_x86_64=y" >> .config
              ;;
            mips)
              echo "CONFIG_TARGET_ramips=y" > .config
              echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
              ;;
            mipsel)
              echo "CONFIG_TARGET_ramips=y" > .config
              echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
              ;;
            riscv64)
              echo "CONFIG_TARGET_virt=y" > .config
              echo "CONFIG_TARGET_virt_rv64=y" >> .config
              ;;
          esac
          
          # å…¬å…±é…ç½®
          echo "CONFIG_SDK=y" >> .config
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "CONFIG_TOOLCHAINOPTS=y" >> .config
          
          echo "é…ç½®å®Œæˆ"

      - name: âš™ï¸ åº”ç”¨é…ç½®å¹¶æ„å»ºå·¥å…·é“¾
        if: env.SKIP_BUILD != 'true'
        timeout-minutes: 240
        continue-on-error: true
        run: |
          cd "$BUILD_DIR"
          echo "=== åº”ç”¨é…ç½®å¹¶æ„å»ºå·¥å…·é“¾ ==="
          
          echo "æ­¥éª¤3: åº”ç”¨é…ç½®..."
          yes "" | make oldconfig 2>&1 | tail -30
          
          echo "æ­¥éª¤4: æ˜¾ç¤ºé…ç½®..."
          echo "=== é‡è¦é…ç½®é¡¹ ==="
          grep -E "CONFIG_TARGET|CONFIG_SDK|CONFIG_TOOLCHAIN" .config | grep -v "=n" || true
          
          echo "æ­¥éª¤5: ä¸‹è½½æºç ..."
          make download -j$(nproc) 2>&1 | tee /tmp/download.log
          DOWNLOAD_STATUS=${PIPESTATUS[0]}
          if [ $DOWNLOAD_STATUS -eq 0 ]; then
            echo "âœ… æºç ä¸‹è½½æˆåŠŸ"
          else
            echo "âš ï¸ æºç ä¸‹è½½æœ‰é—®é¢˜ï¼Œç»§ç»­æ„å»º..."
          fi
          
          echo "æ­¥éª¤6: æ„å»ºå·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          make toolchain/clean 2>&1 | tail -10
          make toolchain/compile -j$(nproc) 2>&1 | tee /tmp/toolchain.log
          TOOLCHAIN_STATUS=${PIPESTATUS[0]}
          
          if [ $TOOLCHAIN_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            echo "å®‰è£…å·¥å…·é“¾..."
            make toolchain/install -j$(nproc) 2>&1 | tail -30
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            echo "å°è¯•ç®€åŒ–æ„å»º..."
            make toolchain/compile -j1 V=s 2>&1 | tail -100
          fi
          echo "æ„å»ºå®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ” æŸ¥æ‰¾å¹¶éªŒè¯å·¥å…·é“¾
        if: env.SKIP_BUILD != 'true'
        continue-on-error: true
        run: |
          cd "$BUILD_DIR"
          echo "=== æŸ¥æ‰¾å¹¶éªŒè¯å·¥å…·é“¾ ==="
          
          # æ¸…ç†ä¹‹å‰çš„è¾“å‡ºæ–‡ä»¶
          rm -f /tmp/toolchain_info.txt
          
          echo "æŸ¥æ‰¾ staging_dir ç›®å½•ç»“æ„..."
          find staging_dir -maxdepth 2 -type d 2>/dev/null | sort
          
          echo "æ­£åœ¨æŸ¥æ‰¾å·¥å…·é“¾..."
          TOOLCHAINS_FOUND=0
          
          # æ–¹æ³•1: ç›´æ¥æŸ¥æ‰¾åŒ…å«æ¶æ„åçš„å·¥å…·é“¾ç›®å½•
          echo "æ–¹æ³•1: æŸ¥æ‰¾åŒ…å«æ¶æ„åçš„å·¥å…·é“¾ç›®å½•..."
          ARCH_PATTERN=$(echo "$MATRIX_ARCH" | sed 's/_/-/g')
          POSSIBLE_DIRS=$(find staging_dir -type d -name "*$ARCH_PATTERN*" 2>/dev/null | grep -v "initial")
          
          if [ -n "$POSSIBLE_DIRS" ]; then
            echo "æ‰¾åˆ°å¯èƒ½çš„ç›®å½•:"
            echo "$POSSIBLE_DIRS"
            
            for DIR in $POSSIBLE_DIRS; do
              if [ -d "$DIR/bin" ]; then
                COMPILER=$(find "$DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
                if [ -n "$COMPILER" ] && [ -x "$COMPILER" ]; then
                  echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $COMPILER"
                  VERSION=$("$COMPILER" --version 2>&1 | head -1 | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1 | tr -d '\n' || echo "æœªçŸ¥")
                  echo "ç‰ˆæœ¬: $VERSION"
                  echo "ç›®å½•: $DIR"
                  
                  # ä¿å­˜ç»å¯¹è·¯å¾„
                  ABS_DIR=$(realpath "$DIR")
                  echo "TOOLCHAIN_DIR=$ABS_DIR" > /tmp/toolchain_info.txt
                  echo "COMPILER_PATH=$COMPILER" >> /tmp/toolchain_info.txt
                  echo "ACTUAL_GCC_VERSION=$VERSION" >> /tmp/toolchain_info.txt
                  TOOLCHAINS_FOUND=1
                  break
                fi
              fi
            done
          fi
          
          # æ–¹æ³•2: æŸ¥æ‰¾æ‰€æœ‰å·¥å…·é“¾-* ç›®å½•
          if [ $TOOLCHAINS_FOUND -eq 0 ]; then
            echo "æ–¹æ³•2: æŸ¥æ‰¾æ‰€æœ‰ toolchain-* ç›®å½•..."
            ALL_TOOLCHAINS=$(find staging_dir -type d -name "toolchain-*" 2>/dev/null | grep -v "initial")
            
            for TC_DIR in $ALL_TOOLCHAINS; do
              echo "æ£€æŸ¥ç›®å½•: $TC_DIR"
              if [ -d "$TC_DIR/bin" ]; then
                COMPILER=$(find "$TC_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
                if [ -n "$COMPILER" ] && [ -x "$COMPILER" ]; then
                  # æ£€æŸ¥ç¼–è¯‘å™¨åç§°æ˜¯å¦åŒ¹é…å‰ç¼€
                  COMPILER_NAME=$(basename "$COMPILER")
                  if echo "$COMPILER_NAME" | grep -q "^$PREFIX"; then
                    echo "âœ… æ‰¾åˆ°åŒ¹é…çš„ç¼–è¯‘å™¨: $COMPILER"
                    VERSION=$("$COMPILER" --version 2>&1 | head -1 | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1 | tr -d '\n' || echo "æœªçŸ¥")
                    echo "ç‰ˆæœ¬: $VERSION"
                    
                    ABS_DIR=$(realpath "$TC_DIR")
                    echo "TOOLCHAIN_DIR=$ABS_DIR" > /tmp/toolchain_info.txt
                    echo "COMPILER_PATH=$COMPILER" >> /tmp/toolchain_info.txt
                    echo "ACTUAL_GCC_VERSION=$VERSION" >> /tmp/toolchain_info.txt
                    TOOLCHAINS_FOUND=1
                    break
                  fi
                fi
              fi
            done
          fi
          
          # æ–¹æ³•3: æŸ¥æ‰¾æ‰€æœ‰ç¼–è¯‘å™¨ï¼Œç„¶åç­›é€‰
          if [ $TOOLCHAINS_FOUND -eq 0 ]; then
            echo "æ–¹æ³•3: æŸ¥æ‰¾æ‰€æœ‰ç¼–è¯‘å™¨..."
            ALL_COMPILERS=$(find staging_dir -name "*gcc" -type f 2>/dev/null | grep -v "initial")
            
            for COMPILER in $ALL_COMPILERS; do
              if [ -x "$COMPILER" ]; then
                COMPILER_NAME=$(basename "$COMPILER")
                # æ£€æŸ¥æ˜¯å¦åŒ¹é…æ¶æ„
                if echo "$COMPILER_NAME" | grep -q "$PREFIX\|$ARCH_NAME"; then
                  echo "âœ… æ‰¾åˆ°å¯èƒ½çš„ç¼–è¯‘å™¨: $COMPILER"
                  VERSION=$("$COMPILER" --version 2>&1 | head -1 | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1 | tr -d '\n' || echo "æœªçŸ¥")
                  TC_DIR=$(dirname $(dirname "$COMPILER"))
                  
                  ABS_DIR=$(realpath "$TC_DIR")
                  echo "TOOLCHAIN_DIR=$ABS_DIR" > /tmp/toolchain_info.txt
                  echo "COMPILER_PATH=$COMPILER" >> /tmp/toolchain_info.txt
                  echo "ACTUAL_GCC_VERSION=$VERSION" >> /tmp/toolchain_info.txt
                  TOOLCHAINS_FOUND=1
                  break
                fi
              fi
            done
          fi
          
          if [ $TOOLCHAINS_FOUND -eq 0 ]; then
            echo "âŒ æœªæ‰¾åˆ°åˆé€‚çš„å·¥å…·é“¾"
            echo "åˆ—å‡ºæ‰€æœ‰ staging_dir å†…å®¹:"
            ls -la staging_dir/ 2>/dev/null || echo "staging_dir ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ğŸ“ å‡†å¤‡è¾“å‡ºç›®å½•
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== å‡†å¤‡è¾“å‡ºç›®å½• ==="
          # è¯»å–å·¥å…·é“¾ä¿¡æ¯
          if [ -f /tmp/toolchain_info.txt ]; then
            source /tmp/toolchain_info.txt
          else
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ä¿¡æ¯"
            echo "TOOLCHAIN_DIR=" > /tmp/toolchain_info.txt
            echo "COMPILER_PATH=" >> /tmp/toolchain_info.txt
            echo "ACTUAL_GCC_VERSION=" >> /tmp/toolchain_info.txt
          fi
          
          # æ¸…ç†GCCç‰ˆæœ¬
          if [ -n "$ACTUAL_GCC_VERSION" ]; then
            CLEAN_GCC_VERSION=$(echo "$ACTUAL_GCC_VERSION" | tr -d '\n\r' | xargs echo -n)
          else
            CLEAN_GCC_VERSION="unknown"
          fi
          
          # ç”Ÿæˆè¾“å‡ºç›®å½•
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/$MATRIX_ARCH/musl/openwrt-${{ needs.setup.outputs.openwrt_version }}/gcc-${CLEAN_GCC_VERSION}_binutils-${{ needs.setup.outputs.binutils_version }}"
          echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "OUTPUT_DIR=$OUTPUT_DIR" > /tmp/build_info.txt
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> /tmp/build_info.txt
          echo "ACTUAL_GCC_VERSION=$ACTUAL_GCC_VERSION" >> /tmp/build_info.txt
          echo "PREFIX=$PREFIX" >> /tmp/build_info.txt
          echo "MATRIX_ARCH=$MATRIX_ARCH" >> /tmp/build_info.txt
          echo "ARCH_NAME=$ARCH_NAME" >> /tmp/build_info.txt

      - name: ğŸ’¾ å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶ ==="
          # è¯»å–ä¿¡æ¯
          source /tmp/build_info.txt
          
          echo "æºç›®å½•: $TOOLCHAIN_DIR"
          echo "ç›®æ ‡ç›®å½•: $OUTPUT_DIR"
          
          # æ£€æŸ¥æºç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -z "$TOOLCHAIN_DIR" ] || [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æºç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            echo "TOTAL_SIZE=0K" >> /tmp/build_info.txt
            echo "FILE_COUNT=0" >> /tmp/build_info.txt
            exit 1
          fi
          
          echo "æºç›®å½•å­˜åœ¨ï¼Œå¤§å°: $(du -sh "$TOOLCHAIN_DIR" 2>/dev/null | cut -f1 || echo "æœªçŸ¥")"
          
          # æ¸…ç†å¹¶åˆ›å»ºç›®æ ‡ç›®å½•
          rm -rf "$OUTPUT_DIR" 2>/dev/null || true
          mkdir -p "$OUTPUT_DIR"
          
          echo "æ­£åœ¨å¤åˆ¶æ–‡ä»¶..."
          # ä½¿ç”¨cpå‘½ä»¤å¤åˆ¶
          cp -r "$TOOLCHAIN_DIR"/* "$OUTPUT_DIR"/ 2>&1 | tail -20
          
          # éªŒè¯å¤åˆ¶
          if [ -d "$OUTPUT_DIR/bin" ]; then
            echo "âœ… binç›®å½•å¤åˆ¶æˆåŠŸ"
            COMPILER_COUNT=$(find "$OUTPUT_DIR/bin" -name "*gcc" -type f 2>/dev/null | wc -l)
            echo "æ‰¾åˆ° $COMPILER_COUNT ä¸ªç¼–è¯‘å™¨"
            
            # æµ‹è¯•ç¼–è¯‘å™¨
            COMPILER=$(find "$OUTPUT_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
            if [ -n "$COMPILER" ] && [ -x "$COMPILER" ]; then
              echo "ç¼–è¯‘å™¨æµ‹è¯•:"
              "$COMPILER" --version 2>&1 | head -1
            fi
          else
            echo "âš ï¸ binç›®å½•æœªæ‰¾åˆ°"
            echo "ç›®æ ‡ç›®å½•å†…å®¹:"
            ls -la "$OUTPUT_DIR" 2>/dev/null || echo "æ— æ³•åˆ—å‡ºç›®å½•"
          fi
          
          # è®¡ç®—å¤§å°
          TOTAL_SIZE=$(du -sh "$OUTPUT_DIR" 2>/dev/null | cut -f1 || echo "0K")
          FILE_COUNT=$(find "$OUTPUT_DIR" -type f 2>/dev/null | wc -l || echo 0)
          
          echo "å¤åˆ¶å®Œæˆ:"
          echo "å¤§å°: $TOTAL_SIZE"
          echo "æ–‡ä»¶æ•°: $FILE_COUNT"
          
          # ä¿å­˜ç»“æœ
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> /tmp/build_info.txt
          echo "FILE_COUNT=$FILE_COUNT" >> /tmp/build_info.txt

      - name: ğŸ“ è¯»å–æ„å»ºç»“æœ
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è¯»å–æ„å»ºç»“æœ ==="
          if [ -f /tmp/build_info.txt ]; then
            source /tmp/build_info.txt
            echo "æ„å»ºç»“æœ:"
            echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR"
            echo "æ€»å¤§å°: $TOTAL_SIZE"
            echo "æ–‡ä»¶æ•°: $FILE_COUNT"
            echo "GCCç‰ˆæœ¬: $ACTUAL_GCC_VERSION"
            
            # è®¾ç½®ç¯å¢ƒå˜é‡
            echo "FINAL_OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
            echo "FINAL_TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
            echo "FINAL_FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
            echo "FINAL_GCC_VERSION=$ACTUAL_GCC_VERSION" >> $GITHUB_ENV
            echo "FINAL_PREFIX=$PREFIX" >> $GITHUB_ENV
            echo "FINAL_ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°æ„å»ºä¿¡æ¯æ–‡ä»¶"
            echo "FINAL_TOTAL_SIZE=0K" >> $GITHUB_ENV
            echo "FINAL_FILE_COUNT=0" >> $GITHUB_ENV
          fi

      - name: ğŸ“ åˆ›å»ºå…ƒæ•°æ®
        if: env.SKIP_BUILD != 'true' && env.FINAL_TOTAL_SIZE != '0K'
        run: |
          echo "=== åˆ›å»ºå…ƒæ•°æ® ==="
          ACTUAL_GCC="$FINAL_GCC_VERSION"
          ACTUAL_GCC=$(echo "$ACTUAL_GCC" | tr -d '\n\r' | xargs echo -n)
          if [ -z "$ACTUAL_GCC" ]; then
            ACTUAL_GCC="unknown"
          fi
          
          echo "åˆ›å»º metadata.json..."
          METADATA_FILE="$FINAL_OUTPUT_DIR/metadata.json"
          
          echo "{" > "$METADATA_FILE"
          echo "  \"architecture\": \"$MATRIX_ARCH\"," >> "$METADATA_FILE"
          echo "  \"arch_name\": \"$FINAL_ARCH_NAME\"," >> "$METADATA_FILE"
          echo "  \"libc\": \"musl\"," >> "$METADATA_FILE"
          echo "  \"libc_version\": \"${{ needs.setup.outputs.musl_version }}\"," >> "$METADATA_FILE"
          echo "  \"gcc_version\": \"$ACTUAL_GCC\"," >> "$METADATA_FILE"
          echo "  \"binutils_version\": \"${{ needs.setup.outputs.binutils_version }}\"," >> "$METADATA_FILE"
          echo "  \"linux_version\": \"${{ needs.setup.outputs.linux_version }}\"," >> "$METADATA_FILE"
          echo "  \"openwrt_version\": \"${{ needs.setup.outputs.openwrt_version }}\"," >> "$METADATA_FILE"
          echo "  \"target\": \"$TARGET\"," >> "$METADATA_FILE"
          echo "  \"subtarget\": \"$SUBTARGET\"," >> "$METADATA_FILE"
          echo "  \"compiler_prefix\": \"$FINAL_PREFIX-\"," >> "$METADATA_FILE"
          echo "  \"build_date\": \"$(date -Iseconds)\"," >> "$METADATA_FILE"
          echo "  \"build_id\": \"$BUILD_ID\"," >> "$METADATA_FILE"
          echo "  \"size\": \"$FINAL_TOTAL_SIZE\"," >> "$METADATA_FILE"
          echo "  \"file_count\": $FINAL_FILE_COUNT" >> "$METADATA_FILE"
          echo "}" >> "$METADATA_FILE"
          
          echo "å…ƒæ•°æ®å†…å®¹:"
          cat "$METADATA_FILE"

      - name: ğŸ“¤ æäº¤åˆ°ä»“åº“
        if: env.SKIP_BUILD != 'true' && env.FINAL_TOTAL_SIZE != '' && env.FINAL_TOTAL_SIZE != '0K' && env.FINAL_TOTAL_SIZE != '8.0K'
        run: |
          echo "=== æäº¤åˆ°ä»“åº“ ==="
          cd "${{ github.workspace }}"
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git pull origin main --no-edit
          
          # æ·»åŠ ç¼–è¯‘å™¨æ–‡ä»¶
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          
          if ! git diff --cached --quiet; then
            git commit \
              -m "build(compiler): æ·»åŠ  $MATRIX_ARCH äº¤å‰ç¼–è¯‘å™¨" \
              -m "æ¶æ„: $MATRIX_ARCH" \
              -m "OpenWrt: ${{ needs.setup.outputs.openwrt_version }}" \
              -m "GCC: $FINAL_GCC_VERSION" \
              -m "Binutils: ${{ needs.setup.outputs.binutils_version }}" \
              -m "å¤§å°: $FINAL_TOTAL_SIZE" \
              -m "æ–‡ä»¶æ•°: $FINAL_FILE_COUNT"
            git push origin main
            echo "âœ… å·²æäº¤åˆ°ä»“åº“"
          else
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi

      - name: ğŸ“Š æœ€ç»ˆæŠ¥å‘Š
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "========================================"
          echo "          ğŸ‰ æ„å»ºå®ŒæˆæŠ¥å‘Š              "
          echo "========================================"
          if [ "$FINAL_TOTAL_SIZE" ] && [ "$FINAL_TOTAL_SIZE" != "0K" ] && [ "$FINAL_TOTAL_SIZE" != "8.0K" ]; then
            echo "âœ… äº¤å‰ç¼–è¯‘å™¨æ„å»ºæˆåŠŸ!"
            SUCCESS=true
          else
            echo "âš ï¸ äº¤å‰ç¼–è¯‘å™¨æ„å»ºå¯èƒ½æœ‰é—®é¢˜"
            SUCCESS=false
          fi
          echo ""
          echo "ğŸ“Š æ„å»ºä¿¡æ¯:"
          echo "- æ¶æ„: $MATRIX_ARCH ($FINAL_ARCH_NAME)"
          echo "- OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "- å®é™…GCCç‰ˆæœ¬: $FINAL_GCC_VERSION"
          echo "- Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "- Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "- è¾“å‡ºç›®å½•: $FINAL_OUTPUT_DIR"
          echo "- æ€»å¤§å°: $FINAL_TOTAL_SIZE"
          echo "- æ–‡ä»¶æ•°é‡: $FINAL_FILE_COUNT"
          
          if [ "$SUCCESS" = "true" ]; then
            echo ""
            echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
            echo "cd $FINAL_OUTPUT_DIR"
            echo 'export PATH="$PWD/bin:$PATH"'
            echo "$FINAL_PREFIX-gcc --version"
          fi
          echo ""
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "========================================"

  summary:
    needs: build-matrix
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“Š æ„å»ºæ€»ç»“
        run: |
          echo "========================================"
          echo "           ğŸ¯ æ„å»ºä»»åŠ¡æ€»ç»“              "
          echo "========================================"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "æ¶æ„ç±»å‹: ${{ github.event.inputs.arch_type }}"
          echo "å¼€å§‹æ—¶é—´: ${{ needs.setup.outputs.start_time }}"
          echo "å®Œæˆæ—¶é—´: $(date)"
          echo "========================================"
          echo "æ‰€æœ‰æ„å»ºä»»åŠ¡å·²å®Œæˆ"
          echo "========================================"
