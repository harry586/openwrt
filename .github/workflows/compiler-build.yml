# .github/workflows/compiler-matrix-build.yml
name: ðŸ”§ äº¤å‰ç¼–è¯‘å™¨æž„å»º

on:
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'ç›®æ ‡æž¶æž„ï¼ˆIPQ40xxé€‰æ‹©arm_cortex-a7ï¼‰'
        required: true
        default: 'arm_cortex-a7'
        type: choice
        options: ['aarch64', 'x86_64', 'mips', 'mipsel', 'arm_cortex-a7', 'arm_cortex-a53', 'riscv64']
      libc:
        description: 'Cåº“ç±»åž‹ï¼ˆåµŒå…¥å¼æŽ¨èmuslï¼‰'
        required: true
        default: 'musl'
        type: choice
        options: ['musl', 'glibc']
      gcc_version:
        description: 'GCCç‰ˆæœ¬ï¼ˆè¾“å…¥ç‰ˆæœ¬å·å¦‚12.3.0ï¼Œæˆ–autoè‡ªåŠ¨æ£€æµ‹ï¼‰'
        required: true
        default: 'auto'
        type: string
      clean_build:
        description: 'æ¸…ç†ä¹‹å‰çš„æž„å»ºç¼“å­˜'
        required: true
        default: false
        type: boolean
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æž„å»ºï¼ˆå³ä½¿å·²å­˜åœ¨ï¼‰'
        required: true
        default: false
        type: boolean

env:
  OPENWRT_VERSION: "23.05.2"
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers"

jobs:
  show-device-info:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“± æ˜¾ç¤ºæž¶æž„å¯¹åº”è®¾å¤‡
        run: |
          echo "================================================"
          echo "          ðŸŽ¯ ç›®æ ‡æž¶æž„è®¾å¤‡å¯¹åº”è¡¨                 "
          echo "================================================"
          echo ""
          echo "1ï¸âƒ£ aarch64 (ARM 64ä½)"
          echo "   â”œâ”€ ðŸ“± æ ‘èŽ“æ´¾ç³»åˆ—"
          echo "   â”‚  â”œâ”€ æ ‘èŽ“æ´¾ 4B (Raspberry Pi 4)"
          echo "   â”‚  â”œâ”€ æ ‘èŽ“æ´¾ CM4 (Compute Module 4)"
          echo "   â”‚  â””â”€ æ ‘èŽ“æ´¾ 400"
          echo "   â”œâ”€ ðŸ–¥ï¸ ç‘žèŠ¯å¾®ç³»åˆ—"
          echo "   â”‚  â”œâ”€ RK3399 (ROCK Pi 4/NanoPi M4)"
          echo "   â”‚  â”œâ”€ RK3568 (FriendlyELEC NanoPi R5S)"
          echo "   â”‚  â””â”€ RK3588 (é«˜ç«¯å¼€å‘æ¿)"
          echo "   â”œâ”€ ðŸ“º ç”µè§†ç›’å­"
          echo "   â”‚  â”œâ”€ æ™¶æ™¨ S905 (X96 Max/Beelink GT King)"
          echo "   â”‚  â”œâ”€ æ™¶æ™¨ S912 (H96 Pro/Beelink GT1)"
          echo "   â”‚  â””â”€ æ™¶æ™¨ S922X (Odroid N2+)"
          echo "   â””â”€ ðŸ–¥ï¸ å…¶ä»–ARM64è®¾å¤‡"
          echo "      â”œâ”€ Orange Pi 5"
          echo "      â”œâ”€ Banana Pi BPI-M5"
          echo "      â””â”€ å„ç§ARMæœåŠ¡å™¨"
          echo ""
          echo "2ï¸âƒ£ x86_64 (x86 64ä½)"
          echo "   â”œâ”€ ðŸ’» ä¸ªäººç”µè„‘"
          echo "   â”‚  â”œâ”€ Intel Core i3/i5/i7/i9"
          echo "   â”‚  â”œâ”€ AMD Ryzen 3/5/7/9"
          echo "   â”‚  â””â”€ å„ç§x86ç¬”è®°æœ¬"
          echo "   â”œâ”€ ðŸ–¥ï¸ æœåŠ¡å™¨"
          echo "   â”‚  â”œâ”€ æˆ´å°”PowerEdge"
          echo "   â”‚  â”œâ”€ æƒ æ™®ProLiant"
          echo "   â”‚  â””â”€ è¶…å¾®æœåŠ¡å™¨"
          echo "   â””â”€ â˜ï¸ è™šæ‹Ÿæœº/å®¹å™¨"
          echo "      â”œâ”€ VMware/VirtualBoxè™šæ‹Ÿæœº"
          echo "      â”œâ”€ Dockerå®¹å™¨"
          echo "      â””â”€ äº‘æœåŠ¡å™¨å®žä¾‹"
          echo ""
          echo "3ï¸âƒ£ mips (MIPS 32ä½å¤§ç«¯)"
          echo "   â”œâ”€ ðŸ›œ åŽç¡•è·¯ç”±å™¨"
          echo "   â”‚  â”œâ”€ RT-ACRH17"
          echo "   â”‚  â”œâ”€ RT-AC85P"
          echo "   â”‚  â””â”€ RT-N56U"
          echo "   â”œâ”€ ðŸ›œ ç½‘ä»¶è·¯ç”±å™¨"
          echo "   â”‚  â”œâ”€ R7800"
          echo "   â”‚  â”œâ”€ R9000"
          echo "   â”‚  â””â”€ XR500"
          echo "   â””â”€ ðŸ›œ å…¶ä»–MIPSè®¾å¤‡"
          echo "      â”œâ”€ ä¸­å…´è·¯ç”±å™¨"
          echo "      â”œâ”€ åŽä¸ºæ—§æ¬¾è·¯ç”±å™¨"
          echo "      â””â”€ æ—©æœŸæ™ºèƒ½å®¶å±…è®¾å¤‡"
          echo ""
          echo "4ï¸âƒ£ mipsel (MIPS 32ä½å°ç«¯)"
          echo "   â”œâ”€ ðŸ›œ è”å‘ç§‘MT7621"
          echo "   â”‚  â”œâ”€ æ–è®¯ K2P (Phicomm K2P)"
          echo "   â”‚  â”œâ”€ Newifi 3 (æ–°è·¯ç”±3)"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 3G"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AC2100"
          echo "   â”‚  â””â”€ æžè·¯ç”± B70"
          echo "   â”œâ”€ ðŸ›œ è”å‘ç§‘MT7620"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ Mini"
          echo "   â”‚  â”œâ”€ æžè·¯ç”± 1S"
          echo "   â”‚  â”œâ”€ æ–è®¯ K1/K2"
          echo "   â”‚  â””â”€ è”æƒ³ Newifi Mini"
          echo "   â””â”€ ðŸ›œ å…¶ä»–MTKè®¾å¤‡"
          echo "      â”œâ”€ MT7628 (ä½Žç«¯è·¯ç”±)"
          echo "      â”œâ”€ MT7688 (ç‰©è”ç½‘è®¾å¤‡)"
          echo "      â””â”€ å„ç§WiFiæ¨¡å—"
          echo ""
          echo "5ï¸âƒ£ arm_cortex-a7 (ARM Cortex-A7)"
          echo "   â”œâ”€ ðŸ›œ é«˜é€šIPQ40xxç³»åˆ— (ä½ çš„è®¾å¤‡ï¼)"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 4Aåƒå…†ç‰ˆ"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AC2100 (éƒ¨åˆ†ç‰ˆæœ¬)"
          echo "   â”‚  â”œâ”€ GL.iNet MT1300"
          echo "   â”‚  â”œâ”€ 360å®¶åº­é˜²ç«å¢™ 5Pro"
          echo "   â”‚  â”œâ”€ Linksys EA6350 v3"
          echo "   â”‚  â””â”€ Netgear R6900P"
          echo "   â”œâ”€ ðŸ›œ è”å‘ç§‘MT7623/MT7629"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 3G (éƒ¨åˆ†ç‰ˆæœ¬)"
          echo "   â”‚  â”œâ”€ æ–è®¯ K3C"
          echo "   â”‚  â””â”€ éƒ¨åˆ†ä¼ä¸šè·¯ç”±å™¨"
          echo "   â”œâ”€ ðŸŠ å…¨å¿—H3/H2+ç³»åˆ—"
          echo "   â”‚  â”œâ”€ Orange Pi PC (é¦™æ©™æ´¾PC)"
          echo "   â”‚  â”œâ”€ Orange Pi Plus"
          echo "   â”‚  â”œâ”€ Banana Pi M2+"
          echo "   â”‚  â””â”€ NanoPi NEO"
          echo "   â””â”€ ðŸ”§ å…¶ä»–Cortex-A7è®¾å¤‡"
          echo "      â”œâ”€ æŸäº›æ™ºèƒ½æ‘„åƒå¤´"
          echo "      â”œâ”€ å·¥ä¸šæŽ§åˆ¶è®¾å¤‡"
          echo "      â””â”€ ä½ŽåŠŸè€—åµŒå…¥å¼è®¾å¤‡"
          echo ""
          echo "6ï¸âƒ£ arm_cortex-a53 (ARM Cortex-A53)"
          echo "   â”œâ”€ ðŸ›œ è”å‘ç§‘MT7622"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ AX3600"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AX6"
          echo "   â”‚  â””â”€ éƒ¨åˆ†WiFi6è·¯ç”±å™¨"
          echo "   â”œâ”€ ðŸ“± 64ä½è®¾å¤‡32ä½æ¨¡å¼"
          echo "   â”‚  â”œâ”€ æ ‘èŽ“æ´¾ 3 (32ä½æ¨¡å¼)"
          echo "   â”‚  â”œâ”€ æŸäº›ç”µè§†ç›’å­"
          echo "   â”‚  â””â”€ ä½Žç«¯å¹³æ¿ç”µè„‘"
          echo "   â””â”€ ðŸ”§ å…¶ä»–A53è®¾å¤‡"
          echo "      â”œâ”€ æŸäº›æ™ºèƒ½éŸ³ç®±"
          echo "      â”œâ”€ ç‰©è”ç½‘ç½‘å…³"
          echo "      â”œâ”€ è¾¹ç¼˜è®¡ç®—è®¾å¤‡"
          echo ""
          echo "7ï¸âƒ£ riscv64 (RISC-V 64ä½)"
          echo "   â”œâ”€ ðŸ”¬ å¼€å‘æ¿"
          echo "   â”‚  â”œâ”€ HiFive Unmatched"
          echo "   â”‚  â”œâ”€ VisionFive 2"
          echo "   â”‚  â”œâ”€ BeagleV"
          echo "   â”‚  â””â”€ SiFiveå¼€å‘æ¿"
          echo "   â”œâ”€ ðŸ–¥ï¸ æ–°å…´è®¾å¤‡"
          echo "   â”‚  â”œâ”€ æŸäº›AIåŠ é€Ÿå™¨"
          echo "   â”‚  â”œâ”€ å®šåˆ¶èŠ¯ç‰‡è®¾å¤‡"
          echo "   â”‚  â””â”€ å­¦æœ¯ç ”ç©¶è®¾å¤‡"
          echo "   â””â”€ ðŸš€ æœªæ¥è®¾å¤‡"
          echo "      â”œâ”€ RISC-Vç¬”è®°æœ¬ç”µè„‘"
          echo "      â”œâ”€ RISC-VæœåŠ¡å™¨"
          echo "      â”œâ”€ å„ç§åˆ›æ–°ç¡¬ä»¶"
          echo ""
          echo "================================================"
          echo "é€‰æ‹©å»ºè®®ï¼š"
          echo "1. è·¯ç”±å™¨è®¾å¤‡ â†’ æ ¹æ®èŠ¯ç‰‡åž‹å·é€‰æ‹©"
          echo "2. å¼€å‘æ¿ â†’ æ ¹æ®CPUæž¶æž„é€‰æ‹©"
          echo "3. PC/æœåŠ¡å™¨ â†’ é€‰æ‹©x86_64"
          echo "4. ä¸ç¡®å®š â†’ æŸ¥çœ‹è®¾å¤‡è§„æ ¼ä¹¦æˆ–CPUä¿¡æ¯"
          echo "================================================"

  setup:
    runs-on: ubuntu-22.04
    outputs:
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      glibc_version: ${{ steps.version-detection.outputs.glibc_version }}
      need_build: ${{ steps.check-existing.outputs.need_build }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»“åº“ï¼ˆç”¨äºŽæ£€æŸ¥çŽ°æœ‰ç¼–è¯‘å™¨ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: firmware-config/build-Compiler-file/compilers
          sparse-checkout-cone-mode: false

      - name: ðŸ—ï¸ åˆå§‹åŒ–
        run: |
          echo "=== äº¤å‰ç¼–è¯‘å™¨æž„å»ºç³»ç»Ÿ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          echo "åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "å½“å‰å·¥ä½œåŒºå†…å®¹:"
          ls -la "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers" 2>/dev/null || echo "ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨"

      - name: ðŸ” æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸Žé€‰æ‹©
        id: version-detection
        run: |
          echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸Žé€‰æ‹© ==="
          USER_VERSION="${{ github.event.inputs.gcc_version }}"
          TARGET_ARCH="${{ github.event.inputs.target_arch }}"
          LIBC_TYPE="${{ github.event.inputs.libc }}"
          OPENWRT_VERSION="${{ env.OPENWRT_VERSION }}"
          
          echo "è¾“å…¥å‚æ•°:"
          echo "- ç›®æ ‡æž¶æž„: $TARGET_ARCH"
          echo "- Cåº“ç±»åž‹: $LIBC_TYPE"
          echo "- ç”¨æˆ·æŒ‡å®šGCCç‰ˆæœ¬: $USER_VERSION"
          echo "OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          
          case "$OPENWRT_VERSION" in
            "23.05.2"|"23.05.*")
              DEFAULT_GCC="12.3.0"
              DEFAULT_BINUTILS="2.40"
              DEFAULT_LINUX="5.15.133"
              DEFAULT_MUSL="1.2.4"
              DEFAULT_GLIBC="2.37"
              ;;
            "22.03.*")
              DEFAULT_GCC="11.3.0"
              DEFAULT_BINUTILS="2.38"
              DEFAULT_LINUX="5.10.179"
              DEFAULT_MUSL="1.2.3"
              DEFAULT_GLIBC="2.35"
              ;;
            "21.02.*")
              DEFAULT_GCC="10.3.0"
              DEFAULT_BINUTILS="2.36.1"
              DEFAULT_LINUX="5.4.188"
              DEFAULT_MUSL="1.2.2"
              DEFAULT_GLIBC="2.33"
              ;;
            *)
              DEFAULT_GCC="12.3.0"
              DEFAULT_BINUTILS="2.40"
              DEFAULT_LINUX="5.15.133"
              DEFAULT_MUSL="1.2.4"
              DEFAULT_GLIBC="2.37"
              ;;
          esac
          
          case "$TARGET_ARCH" in
            "riscv64")
              ARCH_GCC="13.2.0"
              ARCH_BINUTILS="2.41"
              echo "RISC-Væž¶æž„ï¼Œä½¿ç”¨è¾ƒæ–°å·¥å…·é“¾ç‰ˆæœ¬"
              ;;
            "aarch64"|"arm_cortex-a53")
              ARCH_GCC="12.3.0"
              ARCH_BINUTILS="2.40"
              ;;
            "arm_cortex-a7")
              ARCH_GCC="11.3.0"
              ARCH_BINUTILS="2.38"
              echo "ARM Cortex-A7æž¶æž„ï¼Œä½¿ç”¨å…¼å®¹æ€§æ›´å¥½çš„GCC 11.3.0"
              ;;
            "mips"|"mipsel")
              ARCH_GCC="10.3.0"
              ARCH_BINUTILS="2.36.1"
              echo "MIPSæž¶æž„ï¼Œä½¿ç”¨è¾ƒè€å·¥å…·é“¾ç‰ˆæœ¬ä»¥ä¿è¯å…¼å®¹æ€§"
              ;;
            *)
              ARCH_GCC="$DEFAULT_GCC"
              ARCH_BINUTILS="$DEFAULT_BINUTILS"
              ;;
          esac
          
          if [ "$USER_VERSION" = "auto" ] || [ -z "$USER_VERSION" ]; then
            echo "ä½¿ç”¨æ™ºèƒ½ç‰ˆæœ¬é€‰æ‹©..."
            GCC_VERSION="$ARCH_GCC"
            
            echo "éªŒè¯GCCç‰ˆæœ¬ $GCC_VERSION æ˜¯å¦å­˜åœ¨..."
            if curl -s --head "https://ftp.gnu.org/gnu/gcc/gcc-$GCC_VERSION/gcc-$GCC_VERSION.tar.xz" | grep -q "200 OK"; then
              echo "âœ… GCC $GCC_VERSION å¯ç”¨"
            else
              echo "âš ï¸ GCC $GCC_VERSION ä¸å¯ç”¨ï¼Œå°è¯•å¤‡ç”¨ç‰ˆæœ¬"
              GCC_VERSION=$(curl -s https://ftp.gnu.org/gnu/gcc/ | grep -o 'gcc-[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -Vr | head -1 | cut -d- -f2)
              if [ -z "$GCC_VERSION" ]; then
                GCC_VERSION="12.3.0"
                echo "âš ï¸ æ— æ³•æ£€æµ‹æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤: $GCC_VERSION"
              fi
            fi
          else
            GCC_VERSION="$USER_VERSION"
            echo "ä½¿ç”¨ç”¨æˆ·æŒ‡å®šç‰ˆæœ¬: $GCC_VERSION"
            
            echo "éªŒè¯ç”¨æˆ·æŒ‡å®šçš„GCCç‰ˆæœ¬ $GCC_VERSION æ˜¯å¦å­˜åœ¨..."
            if ! curl -s --head "https://ftp.gnu.org/gnu/gcc/gcc-$GCC_VERSION/gcc-$GCC_VERSION.tar.xz" | grep -q "200 OK"; then
              echo "âŒ ç”¨æˆ·æŒ‡å®šçš„GCCç‰ˆæœ¬ $GCC_VERSION ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®"
              echo "å°è¯•æŸ¥æ‰¾å¯ç”¨çš„ç›¸è¿‘ç‰ˆæœ¬..."
              
              AVAILABLE_VERSIONS=$(curl -s https://ftp.gnu.org/gnu/gcc/ | grep -o 'gcc-[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -Vr | cut -d- -f2)
              MAJOR_VERSION=$(echo "$GCC_VERSION" | cut -d. -f1)
              SIMILAR_VERSIONS=$(echo "$AVAILABLE_VERSIONS" | grep "^$MAJOR_VERSION\.")
              
              if [ -n "$SIMILAR_VERSIONS" ]; then
                NEW_VERSION=$(echo "$SIMILAR_VERSIONS" | head -1)
                echo "æ‰¾åˆ°ç›¸è¿‘ç‰ˆæœ¬: $NEW_VERSION"
                GCC_VERSION="$NEW_VERSION"
              else
                echo "ä½¿ç”¨æž¶æž„æŽ¨èç‰ˆæœ¬: $ARCH_GCC"
                GCC_VERSION="$ARCH_GCC"
              fi
            fi
          fi
          
          echo "æ ¹æ®GCC $GCC_VERSION é€‰æ‹©Binutilsç‰ˆæœ¬..."
          GCC_MAJOR=$(echo "$GCC_VERSION" | cut -d. -f1)
          
          case $GCC_MAJOR in
            13|14)
              BINUTILS_VERSION="2.41"
              ;;
            12)
              BINUTILS_VERSION="2.40"
              ;;
            11)
              BINUTILS_VERSION="2.38"
              ;;
            10)
              BINUTILS_VERSION="2.36.1"
              ;;
            9)
              BINUTILS_VERSION="2.34"
              ;;
            8)
              BINUTILS_VERSION="2.32"
              ;;
            *)
              BINUTILS_VERSION="$DEFAULT_BINUTILS"
              ;;
          esac
          
          echo "éªŒè¯Binutilsç‰ˆæœ¬ $BINUTILS_VERSION..."
          if ! curl -s --head "https://ftp.gnu.org/gnu/binutils/binutils-$BINUTILS_VERSION.tar.xz" | grep -q "200 OK"; then
            echo "âš ï¸ Binutils $BINUTILS_VERSION ä¸å¯ç”¨ï¼Œå°è¯•æ£€æµ‹æœ€æ–°ç‰ˆæœ¬"
            BINUTILS_VERSION=$(curl -s https://ftp.gnu.org/gnu/binutils/ | grep -o 'binutils-[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -Vr | head -1 | cut -d- -f2)
          fi
          
          LINUX_VERSION="$DEFAULT_LINUX"
          MUSL_VERSION="$DEFAULT_MUSL"
          GLIBC_VERSION="$DEFAULT_GLIBC"
          
          echo "ðŸŽ¯ æœ€ç»ˆç‰ˆæœ¬é€‰æ‹©:"
          echo "- ç›®æ ‡æž¶æž„: $TARGET_ARCH"
          echo "- Cåº“ç±»åž‹: $LIBC_TYPE"
          echo "- GCCç‰ˆæœ¬: $GCC_VERSION (ä¸»ç‰ˆæœ¬: $GCC_MAJOR)"
          echo "- Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "- Linuxå†…æ ¸: $LINUX_VERSION"
          echo "- Muslç‰ˆæœ¬: $MUSL_VERSION"
          echo "- Glibcç‰ˆæœ¬: $GLIBC_VERSION"
          echo ""
          echo "ðŸ“Š ç‰ˆæœ¬é€‰æ‹©è¯´æ˜Ž:"
          echo "1. OpenWrt $OPENWrt_VERSION åŸºç¡€ç‰ˆæœ¬ â†’ GCC $DEFAULT_GCC"
          echo "2. æž¶æž„ $TARGET_ARCH ä¼˜åŒ– â†’ GCC $ARCH_GCC"
          echo "3. æœ€ç»ˆé€‰æ‹© â†’ GCC $GCC_VERSION"
          echo "4. ç‰ˆæœ¬éªŒè¯ â†’ ç¡®ä¿å¯ç”¨æ€§"
          
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT
          echo "DEBUG_GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "DEBUG_BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV

      - name: ðŸ”Ž æ£€æŸ¥çŽ°æœ‰ç¼–è¯‘å™¨
        id: check-existing
        run: |
          echo "=== æ£€æŸ¥çŽ°æœ‰ç¼–è¯‘å™¨ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          GCC_VERSION='${{ steps.version-detection.outputs.gcc_version }}'
          BINUTILS_VERSION='${{ steps.version-detection.outputs.binutils_version }}'
          
          echo "æ£€æŸ¥ç‰ˆæœ¬å˜é‡:"
          echo "- GCC_VERSION: '$GCC_VERSION'"
          echo "- BINUTILS_VERSION: '$BINUTILS_VERSION'"
          
          if [ "$LIBC" = "musl" ]; then
            LIBC_DIR="musl"
          else
            LIBC_DIR="glibc"
          fi
          
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH}/${LIBC_DIR}/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "æ£€æŸ¥ç›®å½•: $OUTPUT_DIR"
          echo "å®Œæ•´è·¯å¾„: $(realpath "$OUTPUT_DIR" 2>/dev/null || echo "$OUTPUT_DIR")"
          
          if [ -d "$OUTPUT_DIR" ]; then
            echo "âœ… ç¼–è¯‘å™¨ç›®å½•å·²å­˜åœ¨"
            echo "ç›®å½•å†…å®¹:"
            ls -la "$OUTPUT_DIR/" 2>/dev/null | head -10
            
            REQUIRED_DIRS=("bin" "lib" "include" "libexec")
            REQUIRED_FILES=("*-gcc" "*-g++" "*-ld" "*-ar")
            MISSING_ITEMS=()
            
            for dir in "${REQUIRED_DIRS[@]}"; do
              if [ ! -d "$OUTPUT_DIR/$dir" ]; then
                MISSING_ITEMS+=("ç›®å½• $dir")
                echo "  âŒ ç¼ºå°‘ç›®å½•: $dir"
              else
                echo "  âœ… ç›®å½•å­˜åœ¨: $dir (æ–‡ä»¶æ•°: $(find "$OUTPUT_DIR/$dir" -type f 2>/dev/null | wc -l))"
              fi
            done
            
            for file_pattern in "${REQUIRED_FILES[@]}"; do
              found_file=$(find "$OUTPUT_DIR" -name "$file_pattern" -type f 2>/dev/null | head -1)
              if [ -n "$found_file" ]; then
                echo "  âœ… æ‰¾åˆ°æ–‡ä»¶: $(basename "$found_file")"
              else
                MISSING_ITEMS+=("æ–‡ä»¶ $file_pattern")
                echo "  âŒ ç¼ºå°‘æ–‡ä»¶: $file_pattern"
              fi
            done
            
            echo "æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯..."
            if [ -f "$OUTPUT_DIR/metadata.json" ]; then
              echo "æ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶"
              STORED_GCC=$(jq -r '.gcc_version' "$OUTPUT_DIR/metadata.json" 2>/dev/null)
              STORED_BINUTILS=$(jq -r '.binutils_version' "$OUTPUT_DIR/metadata.json" 2>/dev/null)
              
              if [ "$STORED_GCC" = "$GCC_VERSION" ] && [ "$STORED_BINUTILS" = "$BINUTILS_VERSION" ]; then
                echo "  âœ… ç‰ˆæœ¬åŒ¹é…: GCC $STORED_GCC, Binutils $STORED_BINUTILS"
              else
                echo "  âš ï¸ ç‰ˆæœ¬ä¸åŒ¹é…"
                echo "    å­˜å‚¨: GCC $STORED_GCC, Binutils $STORED_BINUTILS"
                echo "    è¯·æ±‚: GCC $GCC_VERSION, Binutils $BINUTILS_VERSION"
                MISSING_ITEMS+=("ç‰ˆæœ¬ä¸åŒ¹é…")
              fi
            else
              echo "  âš ï¸ æœªæ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶"
            fi
            
            if [ ${#MISSING_ITEMS[@]} -eq 0 ]; then
              echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶å®Œæ•´"
              if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
                echo "âš ï¸ å¼ºåˆ¶é‡æ–°æž„å»ºå·²å¯ç”¨"
                NEED_BUILD="true"
              else
                echo "âœ… è·³è¿‡æž„å»ºï¼Œä½¿ç”¨çŽ°æœ‰ç¼–è¯‘å™¨"
                NEED_BUILD="false"
              fi
            else
              echo "âš ï¸ ç¼–è¯‘å™¨ä¸å®Œæ•´ï¼Œç¼ºå°‘:"
              for item in "${MISSING_ITEMS[@]}"; do
                echo "  - $item"
              done
              NEED_BUILD="true"
            fi
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦æž„å»º"
            echo "å°è¯•åˆ—å‡ºçˆ¶ç›®å½•å†…å®¹:"
            ls -la "$(dirname "$OUTPUT_DIR")" 2>/dev/null || echo "çˆ¶ç›®å½•ä¸å­˜åœ¨"
            NEED_BUILD="true"
          fi
          
          echo "æž„å»ºå†³ç­–: $NEED_BUILD"
          echo "need_build=$NEED_BUILD" >> $GITHUB_OUTPUT

  build-compiler:
    needs: [show-device-info, setup]
    if: needs.setup.outputs.need_build == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 300  # å¢žåŠ æ€»è¶…æ—¶åˆ°300åˆ†é’Ÿ
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ“‹ æ˜¾ç¤ºæž„å»ºä¿¡æ¯
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æž„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æž¶æž„: ${{ github.event.inputs.target_arch }}"
          echo "Cåº“ç±»åž‹: ${{ github.event.inputs.libc }}"
          echo "GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "Glibcç‰ˆæœ¬: ${{ needs.setup.outputs.glibc_version }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ env.OPENWRT_VERSION }}"
          echo "å¼ºåˆ¶é‡å»º: ${{ github.event.inputs.force_rebuild }}"
          echo "æ¸…ç†æž„å»º: ${{ github.event.inputs.clean_build }}"
          echo "æž„å»ºéœ€æ±‚: ${{ needs.setup.outputs.need_build }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "è¿è¡Œåºå·: ${{ github.run_number }}"
          echo "ç‰ˆæœ¬é€‰æ‹©ç­–ç•¥:"
          echo "- æ ¹æ®OpenWrtç‰ˆæœ¬é€‰æ‹©åŸºç¡€ç‰ˆæœ¬"
          echo "- æ ¹æ®ç›®æ ‡æž¶æž„è°ƒæ•´ç‰ˆæœ¬"
          echo "- éªŒè¯ç‰ˆæœ¬å¯ç”¨æ€§"
          echo "========================================"

      - name: ðŸ—ï¸ è®¾ç½®çŽ¯å¢ƒ
        run: |
          echo "=== è®¾ç½®æž„å»ºçŽ¯å¢ƒ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          echo "å¤„ç†æž¶æž„: $ARCH"
          echo "å¤„ç†Cåº“: $LIBC"
          
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="armvirt"
              SUBTARGET="armv7"
              ARCH_NAME="arm"
              ARCH_DIR="arm_cortex-a7"
              PREFIX="arm-openwrt-linux"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              ABI="32"
              FLOAT_ABI="hard"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              ARCH_DIR="aarch64"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              ARCH_DIR="x86_64"
              PREFIX="x86_64-openwrt-linux"
              CPU_TYPE="x86_64"
              TUNE="generic"
              ABI="64"
              FLOAT_ABI=""
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              ARCH_DIR="mips"
              PREFIX="mips-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              ARCH_DIR="mipsel"
              PREFIX="mipsel-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            arm_cortex-a53)
              TARGET="rockchip"
              SUBTARGET="armv8"
              ARCH_NAME="aarch64"
              ARCH_DIR="arm_cortex-a53"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              ARCH_DIR="riscv64"
              PREFIX="riscv64-openwrt-linux"
              CPU_TYPE="generic"
              TUNE="generic"
              ABI="lp64d"
              FLOAT_ABI="hard"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æž¶æž„: $ARCH"
              exit 1
              ;;
          esac
          
          if [ "$LIBC" = "musl" ]; then
            PREFIX="${PREFIX}-musl"
            LIBC_SUFFIX="musl"
            LIBC_DIR="musl"
            USE_MUSL="y"
            USE_GLIBC="n"
            LIBC_VERSION='${{ needs.setup.outputs.musl_version }}'
          else
            PREFIX="${PREFIX}-gnu"
            LIBC_SUFFIX="glibc"
            LIBC_DIR="glibc"
            USE_MUSL="n"
            USE_GLIBC="y"
            LIBC_VERSION='${{ needs.setup.outputs.glibc_version }}'
          fi
          
          GCC_VERSION='${{ needs.setup.outputs.gcc_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          LINUX_VERSION='${{ needs.setup.outputs.linux_version }}'
          
          BUILD_ID="${ARCH_DIR}_${LIBC_DIR}_gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="/tmp/compiler-build-${BUILD_ID}"
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH_DIR}/${LIBC_DIR}/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "ðŸ“Š çŽ¯å¢ƒé…ç½®æ±‡æ€»:"
          echo "  æž„å»ºID: $BUILD_ID"
          echo "  æž„å»ºç›®å½•: $BUILD_DIR"
          echo "  è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          echo "  æž¶æž„åç§°: $ARCH_NAME"
          echo "  æž¶æž„ç›®å½•: $ARCH_DIR"
          echo "  Cåº“ç›®å½•: $LIBC_DIR"
          echo "  Cåº“ç‰ˆæœ¬: $LIBC_VERSION"
          echo "  ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
          echo "  CPUç±»åž‹: $CPU_TYPE"
          echo "  è°ƒä¼˜: $TUNE"
          echo "  ABI: $ABI"
          echo "  æµ®ç‚¹ABI: $FLOAT_ABI"
          echo "  GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "  Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "  Linuxå†…æ ¸ç‰ˆæœ¬: $LINUX_VERSION"
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "ARCH_DIR=$ARCH_DIR" >> $GITHUB_ENV
          echo "LIBC_DIR=$LIBC_DIR" >> $GITHUB_ENV
          echo "LIBC_VERSION=$LIBC_VERSION" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "TUNE=$TUNE" >> $GITHUB_ENV
          echo "ABI=$ABI" >> $GITHUB_ENV
          echo "FLOAT_ABI=$FLOAT_ABI" >> $GITHUB_ENV
          echo "USE_MUSL=$USE_MUSL" >> $GITHUB_ENV
          echo "USE_GLIBC=$USE_GLIBC" >> $GITHUB_ENV
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV
          echo "LINUX_VERSION=$LINUX_VERSION" >> $GITHUB_ENV
          echo "LIBC_SUFFIX=$LIBC_SUFFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

      - name: ðŸ”§ å®‰è£…ä¾èµ–ï¼ˆæ ¹æ®ç‰ˆæœ¬è°ƒæ•´ï¼‰
        run: |
          echo "=== å®‰è£…æž„å»ºä¾èµ– ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          GCC_MAJOR=$(echo "${{ env.GCC_VERSION }}" | cut -d. -f1)
          
          echo "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          sudo apt-get update
          
          echo "å®‰è£…åŸºç¡€æž„å»ºå·¥å…·..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison git wget curl file gawk gettext rsync unzip autoconf automake autopoint libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq info install-info liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev libelf-dev libdw-dev libcap-dev libattr1-dev libaudit-dev libiberty-dev
          
          echo "å®‰è£…ç‰ˆæœ¬ç‰¹å®šçš„ä¾èµ–..."
          if [ $GCC_MAJOR -ge 13 ]; then
            echo "GCC 13+ éœ€è¦è¾ƒæ–°çš„ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev python3-distutils libncurses5-dev libssl-dev gnutls-bin liblzma-dev zlib1g-dev
          elif [ $GCC_MAJOR -ge 11 ]; then
            echo "GCC 11-12 ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev python3-distutils libncurses5-dev libssl-dev gnutls-bin liblzma-dev zlib1g-dev
          else
            echo "GCC 10åŠä»¥ä¸‹ç‰ˆæœ¬ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev python3 python3-dev libncurses5-dev libssl-dev liblzma-dev zlib1g-dev
          fi
          
          ARCH="${{ github.event.inputs.target_arch }}"
          case "$ARCH" in
            "riscv64")
              echo "RISC-Væž¶æž„éœ€è¦é¢å¤–çš„ä¾èµ–..."
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y device-tree-compiler qemu-system-riscv64 libfdt-dev
              ;;
            "aarch64"|"arm_cortex-a7"|"arm_cortex-a53")
              echo "ARMæž¶æž„ä¾èµ–..."
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
              ;;
          esac
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          echo "å®‰è£…çš„åŒ…ç‰ˆæœ¬:"
          gcc --version | head -1
          make --version | head -1
          python3 --version
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ—‘ï¸ æ¸…ç†æž„å»ºç¼“å­˜
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          echo "=== æ¸…ç†æž„å»ºç¼“å­˜ ==="
          echo "å¼€å§‹æ¸…ç†ç¼“å­˜..."
          sudo rm -rf /tmp/compiler-build-* 2>/dev/null || true
          echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"

      - name: ðŸ“¥ ä¸‹è½½OpenWrtæºç 
        run: |
          echo "=== èŽ·å–OpenWrtæºç  ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "å…‹éš†OpenWrt ${{ env.OPENWRT_VERSION }} åˆ†æ”¯..."
          
          echo "å°è¯•æ–¹æ³•1: å…‹éš†æŒ‡å®šåˆ†æ”¯..."
          if git clone --depth 1 --branch "v${{ env.OPENWRT_VERSION }}" https://github.com/openwrt/openwrt.git .; then
            echo "âœ… Git cloneæˆåŠŸ"
          else
            echo "æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2: å…‹éš†ä¸»åˆ†æ”¯ç„¶åŽåˆ‡æ¢..."
            git clone --depth 1 https://github.com/openwrt/openwrt.git .
            if git checkout "v${{ env.OPENWRT_VERSION }}"; then
              echo "âœ… åˆ‡æ¢ç‰ˆæœ¬æˆåŠŸ"
            else
              echo "æ–¹æ³•2å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3: ä½¿ç”¨taråŒ…..."
              wget --tries=3 --timeout=60 --show-progress -O openwrt.tar.gz "https://github.com/openwrt/openwrt/archive/refs/tags/v${{ env.OPENWRT_VERSION }}.tar.gz"
              if [ $? -eq 0 ]; then
                tar -xzf openwrt.tar.gz --strip-components=1
                rm -f openwrt.tar.gz
                echo "âœ… ä½¿ç”¨taråŒ…ä¸‹è½½æˆåŠŸ"
              else
                echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹æ³•éƒ½å¤±è´¥"
                exit 1
              fi
            fi
          fi
          
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"
          echo "OpenWrtç‰ˆæœ¬ç¡®è®¤:"
          grep "VERSION_NUMBER" include/version.mk 2>/dev/null || echo "ç‰ˆæœ¬æ–‡ä»¶æœªæ‰¾åˆ°"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ“¥ é¢„ä¸‹è½½æºç åŒ…
        timeout-minutes: 60
        run: |
          echo "=== é¢„ä¸‹è½½æºç åŒ… ==="
          cd "${{ env.BUILD_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          
          echo "åˆ›å»ºä¸‹è½½ç›®å½•..."
          mkdir -p dl
          
          echo "æ˜¾ç¤ºå½“å‰é…ç½®çš„å…³é”®ç‰ˆæœ¬ä¿¡æ¯..."
          echo "GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "Binutilsç‰ˆæœ¬: ${{ env.BINUTILS_VERSION }}"
          echo "Linuxç‰ˆæœ¬: ${{ env.LINUX_VERSION }}"
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "Muslç‰ˆæœ¬: ${{ env.LIBC_VERSION }}"
          else
            echo "Glibcç‰ˆæœ¬: ${{ env.LIBC_VERSION }}"
          fi
          
          echo "æ­¥éª¤1: ä¸‹è½½æ ¸å¿ƒå·¥å…·é“¾åŒ…..."
          
          # ä¸‹è½½GCC
          echo "ä¸‹è½½GCC ${{ env.GCC_VERSION }}..."
          GCC_URL="https://ftp.gnu.org/gnu/gcc/gcc-${{ env.GCC_VERSION }}/gcc-${{ env.GCC_VERSION }}.tar.xz"
          echo "URL: $GCC_URL"
          
          if wget --tries=3 --timeout=120 --show-progress -O "dl/gcc-${{ env.GCC_VERSION }}.tar.xz" "$GCC_URL"; then
            echo "âœ… GCCä¸‹è½½æˆåŠŸ"
          else
            echo "âš ï¸ GCCä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨é•œåƒ..."
            wget --tries=3 --timeout=120 --show-progress -O "dl/gcc-${{ env.GCC_VERSION }}.tar.xz" "https://mirrors.kernel.org/gnu/gcc/gcc-${{ env.GCC_VERSION }}/gcc-${{ env.GCC_VERSION }}.tar.xz" || true
          fi
          
          # ä¸‹è½½Binutils
          echo "ä¸‹è½½Binutils ${{ env.BINUTILS_VERSION }}..."
          BINUTILS_URL="https://ftp.gnu.org/gnu/binutils/binutils-${{ env.BINUTILS_VERSION }}.tar.xz"
          echo "URL: $BINUTILS_URL"
          
          if wget --tries=3 --timeout=120 --show-progress -O "dl/binutils-${{ env.BINUTILS_VERSION }}.tar.xz" "$BINUTILS_URL"; then
            echo "âœ… Binutilsä¸‹è½½æˆåŠŸ"
          else
            echo "âš ï¸ Binutilsä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨é•œåƒ..."
            wget --tries=3 --timeout=120 --show-progress -O "dl/binutils-${{ env.BINUTILS_VERSION }}.tar.xz" "https://mirrors.kernel.org/gnu/binutils/binutils-${{ env.BINUTILS_VERSION }}.tar.xz" || true
          fi
          
          # ä¸‹è½½Linuxå†…æ ¸
          echo "ä¸‹è½½Linux ${{ env.LINUX_VERSION }}..."
          LINUX_URL="https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-${{ env.LINUX_VERSION }}.tar.xz"
          echo "URL: $LINUX_URL"
          
          if wget --tries=3 --timeout=120 --show-progress -O "dl/linux-${{ env.LINUX_VERSION }}.tar.xz" "$LINUX_URL"; then
            echo "âœ… Linuxä¸‹è½½æˆåŠŸ"
          else
            echo "âš ï¸ Linuxä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº..."
            wget --tries=3 --timeout=120 --show-progress -O "dl/linux-${{ env.LINUX_VERSION }}.tar.xz" "https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-${{ env.LINUX_VERSION }}.tar.xz" || true
          fi
          
          # ä¸‹è½½Cåº“
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "ä¸‹è½½Musl ${{ env.LIBC_VERSION }}..."
            MUSL_URL="https://musl.libc.org/releases/musl-${{ env.LIBC_VERSION }}.tar.gz"
            echo "URL: $MUSL_URL"
            
            if wget --tries=3 --timeout=120 --show-progress -O "dl/musl-${{ env.LIBC_VERSION }}.tar.gz" "$MUSL_URL"; then
              echo "âœ… Muslä¸‹è½½æˆåŠŸ"
            else
              echo "âš ï¸ Muslä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº..."
              wget --tries=3 --timeout=120 --show-progress -O "dl/musl-${{ env.LIBC_VERSION }}.tar.gz" "https://github.com/ifduyue/musl/archive/refs/tags/v${{ env.LIBC_VERSION }}.tar.gz" || true
            fi
          else
            echo "ä¸‹è½½Glibc ${{ env.LIBC_VERSION }}..."
            GLIBC_URL="https://ftp.gnu.org/gnu/glibc/glibc-${{ env.LIBC_VERSION }}.tar.xz"
            echo "URL: $GLIBC_URL"
            
            if wget --tries=3 --timeout=120 --show-progress -O "dl/glibc-${{ env.LIBC_VERSION }}.tar.xz" "$GLIBC_URL"; then
              echo "âœ… Glibcä¸‹è½½æˆåŠŸ"
            else
              echo "âš ï¸ Glibcä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨é•œåƒ..."
              wget --tries=3 --timeout=120 --show-progress -O "dl/glibc-${{ env.LIBC_VERSION }}.tar.xz" "https://mirrors.kernel.org/gnu/glibc/glibc-${{ env.LIBC_VERSION }}.tar.xz" || true
            fi
          fi
          
          echo "æ­¥éª¤2: éªŒè¯ä¸‹è½½çš„æ–‡ä»¶..."
          echo "ä¸‹è½½ç›®å½•å†…å®¹:"
          ls -lh dl/ 2>/dev/null || echo "ä¸‹è½½ç›®å½•ä¸ºç©º"
          
          echo "âœ… é¢„ä¸‹è½½å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ” å¼ºåˆ¶é”å®šé…ç½®ï¼ˆå…³é”®ä¿®å¤ï¼‰
        run: |
          echo "=== å¼ºåˆ¶é”å®šé…ç½®ï¼ˆå…³é”®ä¿®å¤ï¼‰==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          echo "âš ï¸ é‡è¦ï¼šé˜²æ­¢OpenWrté»˜è®¤é…ç½®è¦†ç›–æˆ‘ä»¬çš„é…ç½®"
          echo "æ­¥éª¤1: åˆ é™¤æ‰€æœ‰å¯èƒ½å¹²æ‰°é…ç½®çš„æ–‡ä»¶..."
          rm -f .config .config.old .config.cmd 2>/dev/null || true
          
          echo "æ­¥éª¤2: åˆ›å»ºå®Œæ•´çš„.configæ–‡ä»¶..."
          # ä½¿ç”¨echoé€è¡Œå†™å…¥
          echo "# åŸºç¡€é…ç½®" > .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_CCACHE=n" >> .config
          echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> .config
          echo "CONFIG_BUILD_PATENTED=y" >> .config
          echo "CONFIG_BUILD_NLS=y" >> .config
          echo "CONFIG_USE_LIBSTDCXX=y" >> .config
          echo "" >> .config
          echo "# å·¥å…·é“¾é…ç½®" >> .config
          echo "CONFIG_EXTERNAL_TOOLCHAIN=n" >> .config
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "CONFIG_GCC_VERSION=\"${{ env.GCC_VERSION }}\"" >> .config
          echo "CONFIG_BINUTILS_VERSION=\"${{ env.BINUTILS_VERSION }}\"" >> .config
          echo "CONFIG_LINUX_VERSION=\"${{ env.LINUX_VERSION }}\"" >> .config
          echo "CONFIG_USE_MUSL=${{ env.USE_MUSL }}" >> .config
          echo "" >> .config
          echo "# ç›®æ ‡é…ç½®" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
          echo "CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"" >> .config
          echo "CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}-\"" >> .config
          echo "" >> .config
          echo "# Cåº“é…ç½®" >> .config
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "CONFIG_MUSL_VERSION=\"${{ env.LIBC_VERSION }}\"" >> .config
          else
            echo "CONFIG_GLIBC_VERSION=\"${{ env.LIBC_VERSION }}\"" >> .config
          fi
          
          echo "" >> .config
          echo "# ç¦ç”¨æ‰€æœ‰å…¶ä»–ç›®æ ‡ï¼ˆé˜²æ­¢é…ç½®è¦†ç›–ï¼‰" >> .config
          
          # åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„TARGETé…ç½®å¹¶ç¦ç”¨å®ƒä»¬
          TARGETS="ath79 ath79_generic bcm27xx bcm53xx ipq40xx ipq806x lantiq layerscape mediatek mpc85xx mvebu octeon octeontx oxnas pistachio ramips rockchip sunxi tegra x86 arc arm64 armsr bcm47xx bcm4908 bmips brcm2708 brcm47xx brcm63xx cns3xxx gemini imx6 kirkwood malta mxs omap orion pxa samsung sifiveu socfpga uml zynq"
          
          for target in $TARGETS; do
            echo "CONFIG_TARGET_${target}=n" >> .config
          done
          
          echo "" >> .config
          echo "# ç¡®è®¤å¯ç”¨æˆ‘ä»¬çš„ç›®æ ‡" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
          
          echo "æ­¥éª¤3: åˆ›å»ºsiteé…ç½®..."
          mkdir -p include/site
          echo "ac_cv_sys_file_offset_bits=64" > include/site/${{ env.ARCH_NAME }}
          echo "ac_cv_sys_large_files=yes" >> include/site/${{ env.ARCH_NAME }}
          
          if [ "${{ env.ARCH_NAME }}" = "mips" ]; then
            echo "ac_cv_c_bigendian=yes" >> include/site/${{ env.ARCH_NAME }}
          else
            echo "ac_cv_c_bigendian=no" >> include/site/${{ env.ARCH_NAME }}
          fi
          
          echo "æ­¥éª¤4: æ˜¾ç¤ºç”Ÿæˆçš„é…ç½®..."
          echo "å½“å‰é…ç½®æ‘˜è¦:"
          echo "------------------------------"
          grep -E "CONFIG_TARGET_|CONFIG_GCC|CONFIG_BINUTILS|CONFIG_.*LIBC|CONFIG_USE_MUSL|CONFIG_BUILD_TOOLCHAIN|CONFIG_TARGET_ARCH" .config
          echo "------------------------------"
          
          echo "æ­¥éª¤5: éªŒè¯é…ç½®å®Œæ•´æ€§..."
          ALL_CORRECT=true
          
          if grep -q "CONFIG_GCC_VERSION=\"${{ env.GCC_VERSION }}\"" .config; then
            echo "âœ… GCCç‰ˆæœ¬éªŒè¯é€šè¿‡"
          else
            echo "âŒ GCCç‰ˆæœ¬éªŒè¯å¤±è´¥"
            ALL_CORRECT=false
          fi
          
          if grep -q "CONFIG_TARGET_${{ env.TARGET }}=y" .config; then
            echo "âœ… ç›®æ ‡éªŒè¯é€šè¿‡: ${{ env.TARGET }}"
          else
            echo "âŒ ç›®æ ‡éªŒè¯å¤±è´¥"
            ALL_CORRECT=false
          fi
          
          if grep -q "CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"" .config; then
            echo "âœ… æž¶æž„éªŒè¯é€šè¿‡: ${{ env.ARCH_NAME }}"
          else
            echo "âŒ æž¶æž„éªŒè¯å¤±è´¥"
            ALL_CORRECT=false
          fi
          
          if [ "$ALL_CORRECT" = true ]; then
            echo "âœ… æ‰€æœ‰é…ç½®éªŒè¯é€šè¿‡"
          else
            echo "âŒ é…ç½®éªŒè¯å¤±è´¥ï¼Œæ˜¾ç¤ºå½“å‰é…ç½®..."
            cat .config
            exit 1
          fi
          
          echo "âœ… é…ç½®å¼ºåˆ¶é”å®šå®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ› ï¸ åˆ†æ­¥æž„å»ºå·¥å…·é“¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        timeout-minutes: 240
        run: |
          echo "=== åˆ†æ­¥æž„å»ºå·¥å…·é“¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          export MAKEFLAGS="-j$(nproc)"
          
          echo "ç³»ç»Ÿä¿¡æ¯:"
          echo "- CPUæ ¸å¿ƒ: $(nproc)"
          echo "- å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "- ç£ç›˜ç©ºé—´:"
          df -h .
          
          echo "æ­¥éª¤1: æ˜¾ç¤ºæœ€ç»ˆé…ç½®..."
          echo "ç›®æ ‡é…ç½®:"
          grep -E "CONFIG_TARGET_|CONFIG_GCC|CONFIG_BINUTILS|CONFIG_.*LIBC" .config | grep -v "=n"
          
          echo "æ­¥éª¤2: å¼ºåˆ¶ä½¿ç”¨æˆ‘ä»¬çš„é…ç½®..."
          if ! grep -q "CONFIG_TARGET_${{ env.TARGET }}=y" .config; then
            echo "âŒ é…ç½®é”™è¯¯ï¼šç›®æ ‡ä¸æ˜¯ ${{ env.TARGET }}"
            echo "å½“å‰é…ç½®:"
            grep "CONFIG_TARGET_" .config | grep "=y"
            exit 1
          fi
          
          echo "æ­¥éª¤3: è·³è¿‡defconfigï¼Œç›´æŽ¥å‡†å¤‡..."
          # è·³è¿‡defconfigï¼Œç›´æŽ¥ä½¿ç”¨æˆ‘ä»¬çš„é…ç½®
          touch .config
          
          echo "æ­¥éª¤4: åˆ†æ­¥æž„å»ºå·¥å…·é“¾..."
          
          echo "å­æ­¥éª¤4.1: æ£€æŸ¥ä¸‹è½½æ–‡ä»¶..."
          echo "ä¸‹è½½ç›®å½•å†…å®¹:"
          ls -lh dl/ 2>/dev/null || echo "ä¸‹è½½ç›®å½•ä¸ºç©º"
          
          echo "å­æ­¥éª¤4.2: è¿è¡Œmake oldconfigï¼ˆå¿«é€Ÿæ£€æŸ¥ï¼‰..."
          make oldconfig 2>&1 | tail -20
          
          echo "å­æ­¥éª¤4.3: å‡†å¤‡hostå·¥å…·ï¼ˆåˆ†ç¦»æ­¥éª¤ï¼‰..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          make -j$(nproc) tools/install 2>&1 | tee /tmp/tools-install.log | grep -E "Installing|Building|ERROR|Error" | tail -50
          TOOLS_STATUS=${PIPESTATUS[0]}
          
          if [ $TOOLS_STATUS -eq 0 ]; then
            echo "âœ… Hostå·¥å…·å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ Hostå·¥å…·å®‰è£…æœ‰è­¦å‘Šï¼Œå°è¯•ç»§ç»­..."
          fi
          
          echo "å­æ­¥éª¤4.4: å‡†å¤‡å·¥å…·é“¾ï¼ˆå…³é”®æ­¥éª¤ï¼‰..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "æ³¨æ„ï¼šè¿™ä¸€æ­¥å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."
          
          # ä½¿ç”¨åˆ†ç¦»çš„æ—¥å¿—å’Œè¿›åº¦æŒ‡ç¤º
          {
            make toolchain/prepare -j$(nproc) V=s 2>&1 | tee /tmp/prepare.log
          } &
          PREPARE_PID=$!
          
          # æ˜¾ç¤ºè¿›åº¦
          echo "å·¥å…·é“¾å‡†å¤‡è¿›ç¨‹PID: $PREPARE_PID"
          echo "ç­‰å¾…å®Œæˆï¼Œæ¯30ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦..."
          
          for i in {1..60}; do
            if kill -0 $PREPARE_PID 2>/dev/null; then
              echo "è¿›åº¦: ç¬¬ $i/60 åˆ†é’Ÿ ($(date))"
              # æ˜¾ç¤ºæœ€åŽå‡ è¡Œæ—¥å¿—
              tail -10 /tmp/prepare.log 2>/dev/null | grep -E "Building|Compiling|Configuring|Installing|ERROR|Error" || echo "ç­‰å¾…ä¸­..."
              sleep 30
            else
              break
            fi
          done
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
          if kill -0 $PREPARE_PID 2>/dev/null; then
            echo "âš ï¸ å·¥å…·é“¾å‡†å¤‡è¶…æ—¶ï¼Œå¼ºåˆ¶ç»ˆæ­¢..."
            kill -9 $PREPARE_PID 2>/dev/null
            echo "æŸ¥çœ‹å‡†å¤‡æ—¥å¿—æ‘˜è¦:"
            grep -E "Error:|error:|failed:|ERROR" /tmp/prepare.log | tail -20
            echo "å°è¯•è·³è¿‡å‡†å¤‡æ­¥éª¤ï¼Œç›´æŽ¥ç¼–è¯‘..."
          else
            wait $PREPARE_PID
            PREPARE_STATUS=$?
            if [ $PREPARE_STATUS -eq 0 ]; then
              echo "âœ… å·¥å…·é“¾å‡†å¤‡æˆåŠŸ"
            else
              echo "âš ï¸ å·¥å…·é“¾å‡†å¤‡æœ‰è­¦å‘Šï¼ŒçŠ¶æ€ç : $PREPARE_STATUS"
              echo "æŸ¥çœ‹é”™è¯¯ä¿¡æ¯..."
              grep -E "Error:|error:|failed:" /tmp/prepare.log | tail -20 || true
              echo "å°è¯•ç»§ç»­..."
            fi
          fi
          
          echo "å­æ­¥éª¤4.5: ç¼–è¯‘å·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "ç¼–è¯‘å·¥å…·é“¾ï¼Œä½¿ç”¨ $(nproc) ä¸ªæ ¸å¿ƒ..."
          
          # ä½¿ç”¨åˆ†ç¦»çš„æ—¥å¿—å’Œè¿›åº¦æŒ‡ç¤º
          {
            make toolchain/compile -j$(nproc) V=s 2>&1 | tee /tmp/compile.log
          } &
          COMPILE_PID=$!
          
          echo "ç¼–è¯‘è¿›ç¨‹PID: $COMPILE_PID"
          echo "ç­‰å¾…å®Œæˆï¼Œæ¯30ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦..."
          
          for i in {1..90}; do
            if kill -0 $COMPILE_PID 2>/dev/null; then
              echo "è¿›åº¦: ç¬¬ $i/90 åˆ†é’Ÿ ($(date))"
              # æ˜¾ç¤ºæœ€åŽå‡ è¡Œæ—¥å¿—
              tail -10 /tmp/compile.log 2>/dev/null | grep -E "Building|Compiling|Linking|Installing|ERROR|Error" || echo "ç¼–è¯‘ä¸­..."
              sleep 30
            else
              break
            fi
          done
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
          if kill -0 $COMPILE_PID 2>/dev/null; then
            echo "âš ï¸ å·¥å…·é“¾ç¼–è¯‘è¶…æ—¶ï¼Œå¼ºåˆ¶ç»ˆæ­¢..."
            kill -9 $COMPILE_PID 2>/dev/null
            echo "æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—æ‘˜è¦:"
            grep -E "Error:|error:|failed:|ERROR" /tmp/compile.log | tail -20
            echo "å°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            
            echo "å¼€å§‹å•çº¿ç¨‹ç¼–è¯‘..."
            make toolchain/compile -j1 V=s 2>&1 | tee /tmp/compile-single.log | tail -100
            COMPILE_SINGLE_STATUS=${PIPESTATUS[0]}
            
            if [ $COMPILE_SINGLE_STATUS -eq 0 ]; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ å•çº¿ç¨‹ç¼–è¯‘å¤±è´¥"
              echo "æœ€åŽçš„é”™è¯¯:"
              tail -50 /tmp/compile-single.log
              exit 1
            fi
          else
            wait $COMPILE_PID
            COMPILE_STATUS=$?
            if [ $COMPILE_STATUS -eq 0 ]; then
              echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼ŒçŠ¶æ€ç : $COMPILE_STATUS"
              echo "é”™è¯¯æ‘˜è¦:"
              grep -E "Error:|error:|failed:|Failed" /tmp/compile.log | tail -30
              echo "å°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
              
              echo "å¼€å§‹å•çº¿ç¨‹ç¼–è¯‘..."
              make toolchain/compile -j1 V=s 2>&1 | tee /tmp/compile-single2.log | tail -100
              COMPILE_SINGLE2_STATUS=${PIPESTATUS[0]}
              
              if [ $COMPILE_SINGLE2_STATUS -eq 0 ]; then
                echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
              else
                echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•éƒ½å¤±è´¥"
                exit 1
              fi
            fi
          fi
          
          echo "å­æ­¥éª¤4.6: å®‰è£…å·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          make toolchain/install -j$(nproc) V=s 2>&1 | tee /tmp/install.log | tail -100
          INSTALL_STATUS=${PIPESTATUS[0]}
          
          if [ $INSTALL_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ å®‰è£…æœ‰è­¦å‘Šï¼ŒçŠ¶æ€ç : $INSTALL_STATUS"
            echo "è­¦å‘Šæ‘˜è¦:"
            grep -E "Warning:|warning:" /tmp/install.log | tail -10 || true
          fi
          
          echo "âœ… å·¥å…·é“¾æž„å»ºå®Œæˆ"
          echo "æ€»æž„å»ºæ—¶é—´: $(date)"
          echo "æž„å»ºç›®å½•å¤§å°: $(du -sh . | cut -f1)"
          
          echo "æ­¥éª¤5: æ£€æŸ¥æž„å»ºç»“æžœ..."
          if find staging_dir -name "*gcc" -type f 2>/dev/null | head -1 > /dev/null; then
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶"
            COMPILER_PATH=$(find staging_dir -name "*gcc" -type f 2>/dev/null | head -1)
            echo "ç¼–è¯‘å™¨ä½ç½®: $COMPILER_PATH"
            echo "ç¼–è¯‘å™¨ç‰ˆæœ¬:"
            "$COMPILER_PATH" --version 2>&1 | head -3
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶"
            echo "staging_dirå†…å®¹:"
            ls -la staging_dir/ 2>/dev/null | head -20
            exit 1
          fi
          
          echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV

      - name: âœ… å¿«é€ŸéªŒè¯æž„å»ºç»“æžœ
        run: |
          echo "=== å¿«é€ŸéªŒè¯æž„å»ºç»“æžœ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          echo "æŸ¥æ‰¾å·¥å…·é“¾ç›®å½•..."
          TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
          
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            find staging_dir -type d -name "*toolchain*" 2>/dev/null
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          
          echo "æŸ¥æ‰¾ç¼–è¯‘å™¨..."
          COMPILER_PATH="${{ env.COMPILER_PATH }}"
          
          if [ -z "$COMPILER_PATH" ]; then
            COMPILER_PATH=$(find "$TOOLCHAIN_DIR" -name "*gcc" -type f 2>/dev/null | head -1)
          fi
          
          if [ -z "$COMPILER_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘å™¨"
            exit 1
          fi
          
          COMPILER_NAME=$(basename "$COMPILER_PATH")
          echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $COMPILER_NAME"
          
          echo "ç¼–è¯‘å™¨ä¿¡æ¯:"
          "$COMPILER_PATH" --version 2>&1 | head -3
          
          echo "ç›®æ ‡ä¸‰å…ƒç»„:"
          TARGET_TRIPLET=$("$COMPILER_PATH" -dumpmachine 2>&1)
          echo "$TARGET_TRIPLET"
          
          echo "å¿«é€Ÿæµ‹è¯•äº¤å‰ç¼–è¯‘..."
          echo '#include <stdio.h>' > test.c
          echo 'int main() { printf("Test OK\\n"); return 0; }' >> test.c
          
          "$COMPILER_PATH" test.c -o test_program 2>&1
          COMPILE_TEST_STATUS=$?
          
          if [ $COMPILE_TEST_STATUS -eq 0 ] && [ -f "test_program" ]; then
            echo "âœ… äº¤å‰ç¼–è¯‘æµ‹è¯•é€šè¿‡"
            rm -f test.c test_program
            echo "BUILD_COMPLETE=true" >> $GITHUB_ENV
          else
            echo "âŒ äº¤å‰ç¼–è¯‘æµ‹è¯•å¤±è´¥"
            exit 1
          fi
          
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV
          echo "COMPILER_NAME=$COMPILER_NAME" >> $GITHUB_ENV
          echo "TARGET_TRIPLET=$TARGET_TRIPLET" >> $GITHUB_ENV
          
          echo "âœ… éªŒè¯å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        if: env.BUILD_COMPLETE == 'true'
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          
          echo "å‡†å¤‡è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          mkdir -p "${{ env.OUTPUT_DIR }}"
          
          if [ -d "${{ env.OUTPUT_DIR }}" ] && [ "$(ls -A "${{ env.OUTPUT_DIR }}" 2>/dev/null)" ]; then
            echo "æ¸…ç†çŽ°æœ‰è¾“å‡ºç›®å½•..."
            rm -rf "${{ env.OUTPUT_DIR }}"/*
          fi
          
          echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
          if [ -d "$TOOLCHAIN_DIR" ]; then
            echo "ä»Ž: $TOOLCHAIN_DIR"
            echo "åˆ°: ${{ env.OUTPUT_DIR }}"
            cp -r "$TOOLCHAIN_DIR"/* "${{ env.OUTPUT_DIR }}/" 2>&1 | tail -20
            echo "âœ… å¤åˆ¶å®Œæˆ"
          else
            echo "âŒ å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶..."
          echo "{" > "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"architecture\": \"${{ env.ARCH_DIR }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"arch_name\": \"${{ env.ARCH_NAME }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"libc\": \"${{ env.LIBC_DIR }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"libc_version\": \"${{ env.LIBC_VERSION }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"target\": \"${{ env.TARGET }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"subtarget\": \"${{ env.SUBTARGET }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"compiler_prefix\": \"${{ env.PREFIX }}-\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"gcc_version\": \"${{ env.GCC_VERSION }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"binutils_version\": \"${{ env.BINUTILS_VERSION }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"linux_version\": \"${{ env.LINUX_VERSION }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"openwrt_version\": \"${{ env.OPENWRT_VERSION }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"cpu_type\": \"${{ env.CPU_TYPE }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"tune\": \"${{ env.TUNE }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"abi\": \"${{ env.ABI }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"float_abi\": \"${{ env.FLOAT_ABI }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"build_date\": \"$(date -Iseconds)\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"workflow_run\": \"${{ github.run_id }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"build_id\": \"${{ env.BUILD_ID }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"target_triplet\": \"${{ env.TARGET_TRIPLET }}\"" >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "}" >> "${{ env.OUTPUT_DIR }}/metadata.json"
          
          echo "è®¡ç®—æˆæžœå¤§å°..."
          TOTAL_SIZE=$(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1)
          FILE_COUNT=$(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)
          
          echo "ðŸ“Š æœ€ç»ˆæˆæžœç»Ÿè®¡:"
          echo "- è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          echo "- æ€»å¤§å°: $TOTAL_SIZE"
          echo "- æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          echo "- æž¶æž„: ${{ env.ARCH_DIR }}"
          echo "- Cåº“: ${{ env.LIBC_DIR }}"
          echo "- GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          
          echo "âœ… ç¼–è¯‘å™¨ä¿å­˜å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ“¤ æäº¤åˆ°Gitä»“åº“
        if: env.BUILD_COMPLETE == 'true'
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°Gitä»“åº“ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ github.workspace }}"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git config pull.rebase false
          
          echo "æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main --no-edit
          
          echo "æ·»åŠ ç¼–è¯‘å™¨æ–‡ä»¶..."
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          
          if ! git diff --cached --quiet; then
            echo "æ£€æµ‹åˆ°å˜æ›´ï¼Œåˆ›å»ºæäº¤..."
            git commit -m "build(compiler): æ·»åŠ  ${{ env.ARCH_DIR }}-${{ env.LIBC_DIR }} äº¤å‰ç¼–è¯‘å™¨" -m "æž¶æž„: ${{ env.ARCH_DIR }}" -m "Cåº“: ${{ env.LIBC_DIR }} ${{ env.LIBC_VERSION }}" -m "GCC: ${{ env.GCC_VERSION }}" -m "Binutils: ${{ env.BINUTILS_VERSION }}" -m "å¤§å°: ${{ env.TOTAL_SIZE }}" -m "å·¥ä½œæµ: #${{ github.run_id }}"
            
            echo "æŽ¨é€åˆ°ä»“åº“..."
            if git push origin main; then
              echo "âœ… ç¼–è¯‘å™¨å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
            else
              echo "âš ï¸ æŽ¨é€å¤±è´¥ï¼Œé‡æ–°å°è¯•..."
              git pull origin main --rebase
              git push origin main
            fi
          else
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi
          
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ“Š æ˜¾ç¤ºæœ€ç»ˆæˆæžœ
        if: env.BUILD_COMPLETE == 'true'
        run: |
          echo "========================================"
          echo "          ðŸŽ‰ æž„å»ºå®ŒæˆæŠ¥å‘Š              "
          echo "========================================"
          echo "âœ… äº¤å‰ç¼–è¯‘å™¨æž„å»ºæˆåŠŸ!"
          echo ""
          echo "ðŸ“Š æž„å»ºä¿¡æ¯:"
          echo "- æž¶æž„: ${{ env.ARCH_DIR }} (${{ env.ARCH_NAME }})"
          echo "- Cåº“: ${{ env.LIBC_DIR }} ${{ env.LIBC_VERSION }}"
          echo "- GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ env.BINUTILS_VERSION }}"
          echo "- Linuxå†…æ ¸: ${{ env.LINUX_VERSION }}"
          echo "- ç¼–è¯‘å™¨å‰ç¼€: ${{ env.PREFIX }}-"
          echo "- ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "- ç›®æ ‡ä¸‰å…ƒç»„: ${{ env.TARGET_TRIPLET }}"
          echo ""
          echo "ðŸ“¦ æˆæžœç»Ÿè®¡:"
          echo "- æ€»å¤§å°: ${{ env.TOTAL_SIZE }}"
          echo "- æ–‡ä»¶æ•°é‡: ${{ env.FILE_COUNT }}"
          echo "- è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          echo ""
          echo "ðŸš€ ä½¿ç”¨æ–¹æ³•:"
          echo "cd ${{ env.OUTPUT_DIR }}"
          echo "export STAGING_DIR=\$(pwd)"
          echo 'export PATH="$STAGING_DIR/bin:$PATH"'
          echo "${{ env.PREFIX }}-gcc --version"
          echo ""
          echo "â° æž„å»ºæ—¶é—´: $(date)"
          echo "========================================"

      - name: ðŸ“„ ä¸Šä¼ æž„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.BUILD_ID }}
          path: /tmp/*.log
          retention-days: 30

  skip-build:
    needs: setup
    if: needs.setup.outputs.need_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: â­ï¸ è·³è¿‡æž„å»º
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æž„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ä¸”å®Œæ•´ï¼Œè·³è¿‡æž„å»º"
          echo ""
          echo "ðŸ“‹ è·³è¿‡åŽŸå› :"
          echo "- ç¼–è¯‘å™¨ç›®å½•å·²å­˜åœ¨ä¸”å®Œæ•´"
          echo "- ç‰ˆæœ¬åŒ¹é…æ­£ç¡®"
          echo "- æœªå¯ç”¨å¼ºåˆ¶é‡æ–°æž„å»º"
          echo ""
          echo "ðŸ”§ çŽ°æœ‰ç¼–è¯‘å™¨ä¿¡æ¯:"
          echo "- æž¶æž„: ${{ github.event.inputs.target_arch }}"
          echo "- Cåº“: ${{ github.event.inputs.libc }}"
          echo "- GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo ""
          echo "ðŸ’¡ å¦‚éœ€é‡æ–°æž„å»ºï¼Œè¯·å¯ç”¨'å¼ºåˆ¶é‡æ–°æž„å»º'é€‰é¡¹"
          echo "========================================"
