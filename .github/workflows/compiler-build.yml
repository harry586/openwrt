# .github/workflows/compiler-matrix-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨çŸ©é˜µæ„å»º

on:
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'ç›®æ ‡æ¶æ„ï¼ˆIPQ40xxé€‰æ‹©arm_cortex-a7ï¼‰'
        required: true
        default: 'arm_cortex-a7'
        type: choice
        options:
          - aarch64
          - x86_64
          - mips
          - mipsel
          - arm_cortex-a7
          - arm_cortex-a53
          - riscv64
      libc:
        description: 'Cåº“ç±»å‹ï¼ˆåµŒå…¥å¼æ¨èmuslï¼‰'
        required: true
        default: 'musl'
        type: choice
        options:
          - musl
          - glibc
      gcc_version:
        description: 'GCCç‰ˆæœ¬ï¼ˆæ¨è12.3.0ï¼‰'
        required: true
        default: '12.3.0'
        type: string
      clean_build:
        description: 'æ¸…ç†ä¹‹å‰çš„æ„å»ºç¼“å­˜'
        required: true
        default: false
        type: boolean

  schedule:
    - cron: '0 2 * * 0'

env:
  OPENWRT_VERSION: "23.05.2"
  COMPILER_BASE_DIR: "${{ github.workspace }}/compilers"

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ needs.setup.outputs.musl_version }}
      glibc_version: ${{ needs.setup.outputs.glibc_version }}
    steps:
      - name: ğŸ—ï¸ åˆå§‹åŒ–
        run: |
          echo "=== äº¤å‰ç¼–è¯‘å™¨æ„å»ºç³»ç»Ÿ ==="
          echo "ğŸ“Œ æ¶æ„é€‰æ‹©è¯´æ˜ï¼š"
          echo "  aarch64         - ARM 64ä½å¤„ç†å™¨ï¼ˆæ ‘è“æ´¾4ã€RK3399ç­‰ï¼‰"
          echo "  x86_64          - æ ‡å‡†PC/æœåŠ¡å™¨"
          echo "  mips            - MIPS 32ä½å¤§ç«¯ï¼ˆè€è·¯ç”±å™¨ï¼‰"
          echo "  mipsel          - MIPS 32ä½å°ç«¯ï¼ˆMT7621ç­‰ï¼‰"
          echo "  arm_cortex-a7   - ARM Cortex-A7ï¼ˆIPQ40xxã€MT7623ç­‰ï¼‰â† ä½ çš„è®¾å¤‡"
          echo "  arm_cortex-a53  - ARM Cortex-A53ï¼ˆMT7622ã€éƒ¨åˆ†ç”µè§†ç›’å­ï¼‰"
          echo "  riscv64         - RISC-V 64ä½ï¼ˆæ–°æ¶æ„ï¼‰"
          
          ARCH="${{ github.event.inputs.target_arch }}"
          case "$ARCH" in
            arm_cortex-a7)
              echo "âœ… é€‰æ‹©æ­£ç¡®ï¼šIPQ40xxç³»åˆ—ä½¿ç”¨arm_cortex-a7"
              echo "   å¯¹åº”é«˜é€šIPQ4018/IPQ4019/IPQ4028ç­‰èŠ¯ç‰‡"
              ;;
            aarch64)
              echo "âš ï¸ æ³¨æ„ï¼šIPQ40xxæ˜¯32ä½ARMï¼Œä¸æ˜¯64ä½aarch64"
              ;;
          esac
          
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"

      - name: ğŸ” ç‰ˆæœ¬æ£€æµ‹
        id: version-detection
        run: |
          echo "=== æ£€æµ‹å·¥å…·é“¾ç‰ˆæœ¬ ==="
          
          # ä¸ºä¸åŒæ¶æ„è®¾ç½®æ¨èçš„GCCç‰ˆæœ¬
          ARCH="${{ github.event.inputs.target_arch }}"
          USER_VERSION="${{ github.event.inputs.gcc_version }}"
          
          if [ "$USER_VERSION" = "12.3.0" ] || [ "$USER_VERSION" = "" ]; then
            GCC_VERSION="12.3.0"
          else
            GCC_VERSION="$USER_VERSION"
          fi
          
          # ARMæ¶æ„æ¨èä½¿ç”¨è¾ƒæ–°GCCä»¥è·å¾—æ›´å¥½ä¼˜åŒ–
          if [[ "$ARCH" == arm_* ]] && [ "$USER_VERSION" = "12.3.0" ]; then
            echo "â„¹ï¸  ARMæ¶æ„æ¨èä½¿ç”¨GCC 12.3.0ï¼Œå¯¹Cortex-A7æœ‰æ›´å¥½ä¼˜åŒ–"
          fi
          
          BINUTILS_VERSION="2.40"
          LINUX_VERSION="5.15.133"
          MUSL_VERSION="1.2.4"
          GLIBC_VERSION="2.37"
          
          echo "GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "Linuxå†…æ ¸ç‰ˆæœ¬: $LINUX_VERSION"
          
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT

  build-compiler:
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“‹ æ˜¾ç¤ºæ¶æ„ä¿¡æ¯
        run: |
          echo "=== æ¶æ„è¯¦ç»†ä¿¡æ¯ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          
          echo "ğŸ“± è®¾å¤‡å¯¹åº”è¡¨ï¼š"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ æ¶æ„é€‰æ‹©        â”‚ å¯¹åº”è®¾å¤‡                           â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ arm_cortex-a7   â”‚ IPQ4018/IPQ4019/IPQ4028            â”‚"
          echo "â”‚                 â”‚ MT7623/MT7629                      â”‚"
          echo "â”‚                 â”‚ å…¨å¿—H3/H2+                         â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ arm_cortex-a53  â”‚ MT7622                             â”‚"
          echo "â”‚                 â”‚ æ ‘è“æ´¾3ï¼ˆ32ä½æ¨¡å¼ï¼‰                â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ aarch64         â”‚ æ ‘è“æ´¾4/CM4                        â”‚"
          echo "â”‚                 â”‚ RK3399/RK3568                      â”‚"
          echo "â”‚                 â”‚ æ™¶æ™¨S905/S912                     â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ mips            â”‚ åç¡•RT-ACRH17                      â”‚"
          echo "â”‚                 â”‚ ç½‘ä»¶R7800                          â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ mipsel          â”‚ MT7621ï¼ˆK2Pã€Newifi3ï¼‰             â”‚"
          echo "â”‚                 â”‚ MT7620ï¼ˆæè·¯ç”±ï¼‰                   â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          
          echo ""
          echo "ğŸ”§ ä½ çš„é€‰æ‹©ï¼š"
          echo "  æ¶æ„: $ARCH"
          echo "  Cåº“: $LIBC"
          echo "  GCC: ${{ needs.setup.outputs.gcc_version }}"
          
          if [ "$ARCH" = "arm_cortex-a7" ]; then
            echo ""
            echo "âœ… IPQ40xxè®¾å¤‡é…ç½®ï¼š"
            echo "  - CPU: ARM Cortex-A7 32ä½"
            echo "  - æ¶æ„: armv7l (ARMv7)"
            echo "  - æµ®ç‚¹: VFPv4 (ç¡¬æµ®ç‚¹)"
            echo "  - æ¨è: musl + GCC 12.3.0"
          fi

      - name: ğŸ—ï¸ è®¾ç½®ç¯å¢ƒ
        run: |
          echo "=== è®¾ç½®æ„å»ºç¯å¢ƒ ==="
          
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          
          # IPQ40xxç‰¹æ®Šé…ç½®
          if [ "$ARCH" = "arm_cortex-a7" ]; then
            echo "ğŸ”§ é…ç½®IPQ40xxï¼ˆARM Cortex-A7ï¼‰..."
            TARGET="ipq40xx"
            SUBTARGET="generic"
            ARCH_NAME="arm"
            PREFIX="arm-openwrt-linux"
            CPU_TYPE="cortex-a7"
            TUNE="cortex-a7"
            ABI="eabi"
            FLOAT_ABI="hard"
            FPU="vfpv4"
          else
            # å…¶ä»–æ¶æ„é…ç½®
            case "$ARCH" in
              aarch64)
                TARGET="armvirt"
                SUBTARGET="64"
                ARCH_NAME="aarch64"
                PREFIX="aarch64-openwrt-linux"
                CPU_TYPE="cortex-a53"
                TUNE="cortex-a53"
                ABI="lp64"
                FLOAT_ABI=""
                FPU=""
                ;;
              x86_64)
                TARGET="x86"
                SUBTARGET="64"
                ARCH_NAME="x86_64"
                PREFIX="x86_64-openwrt-linux"
                CPU_TYPE="x86_64"
                TUNE="generic"
                ABI="64"
                FLOAT_ABI=""
                FPU=""
                ;;
              mips)
                TARGET="ramips"
                SUBTARGET="mt7621"
                ARCH_NAME="mips"
                PREFIX="mips-openwrt-linux"
                CPU_TYPE="24kc"
                TUNE="24kc"
                ABI="32"
                FLOAT_ABI="softfloat"
                FPU=""
                ;;
              mipsel)
                TARGET="ramips"
                SUBTARGET="mt7621"
                ARCH_NAME="mipsel"
                PREFIX="mipsel-openwrt-linux"
                CPU_TYPE="24kc"
                TUNE="24kc"
                ABI="32"
                FLOAT_ABI="softfloat"
                FPU=""
                ;;
              arm_cortex-a53)
                TARGET="rockchip"
                SUBTARGET="armv8"
                ARCH_NAME="aarch64"
                PREFIX="aarch64-openwrt-linux"
                CPU_TYPE="cortex-a53"
                TUNE="cortex-a53"
                ABI="lp64"
                FLOAT_ABI=""
                FPU=""
                ;;
              riscv64)
                TARGET="virt"
                SUBTARGET="rv64"
                ARCH_NAME="riscv64"
                PREFIX="riscv64-openwrt-linux"
                CPU_TYPE="generic"
                TUNE="generic"
                ABI="lp64d"
                FLOAT_ABI="hard"
                FPU=""
                ;;
              *)
                echo "ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
                exit 1
                ;;
            esac
          fi
          
          # Cåº“é…ç½®
          if [ "$LIBC" = "musl" ]; then
            PREFIX="${PREFIX}-musl"
            LIBC_SUFFIX="musl"
            USE_MUSL="y"
            USE_GLIBC="n"
          else
            PREFIX="${PREFIX}-gnu"
            LIBC_SUFFIX="glibc"
            USE_MUSL="n"
            USE_GLIBC="y"
          fi
          
          GCC_VERSION='${{ needs.setup.outputs.gcc_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          LINUX_VERSION='${{ needs.setup.outputs.linux_version }}'
          
          BUILD_ID="${ARCH_NAME}_${LIBC_SUFFIX}_gcc-${GCC_VERSION}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="/tmp/compiler-build-${BUILD_ID}"
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH_NAME}/${LIBC_SUFFIX}/gcc-${GCC_VERSION}"
          
          echo "ğŸ“Š æ„å»ºé…ç½®ï¼š"
          echo "  ç›®æ ‡æ¶æ„: $ARCH_NAME"
          echo "  Cåº“ç±»å‹: $LIBC_SUFFIX"
          echo "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          echo "  ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
          echo "  CPUç±»å‹: $CPU_TYPE"
          echo "  ABI: $ABI"
          if [ -n "$FLOAT_ABI" ]; then
            echo "  æµ®ç‚¹ABI: $FLOAT_ABI"
          fi
          if [ -n "$FPU" ]; then
            echo "  FPU: $FPU"
          fi
          echo "  GCCç‰ˆæœ¬: $GCC_VERSION"
          
          # ä¿å­˜ç¯å¢ƒå˜é‡
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "TUNE=$TUNE" >> $GITHUB_ENV
          echo "ABI=$ABI" >> $GITHUB_ENV
          echo "FLOAT_ABI=$FLOAT_ABI" >> $GITHUB_ENV
          echo "FPU=$FPU" >> $GITHUB_ENV
          echo "USE_MUSL=$USE_MUSL" >> $GITHUB_ENV
          echo "USE_GLIBC=$USE_GLIBC" >> $GITHUB_ENV
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV
          echo "LINUX_VERSION=$LINUX_VERSION" >> $GITHUB_ENV
          echo "LIBC_SUFFIX=$LIBC_SUFFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          echo "=== å®‰è£…æ„å»ºä¾èµ– ==="
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison libgmp-dev libmpfr-dev libmpc-dev libisl-dev python3 python3-dev git wget curl zlib1g-dev liblzma-dev file gawk gettext libncurses5-dev libssl-dev python3-distutils rsync unzip ncurses-term ncurses-base libncursesw5 libtinfo5 terminfo gnutls-bin libgnutls28-dev libcurl4-gnutls-dev autoconf automake autopoint libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev lzma-dev zstd libzstd-dev libelf-dev libdw-dev libcap-dev libattr1-dev libaudit-dev libiberty-dev jq

      - name: ğŸ—‘ï¸ æ¸…ç†æ„å»ºç¼“å­˜
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          echo "=== æ¸…ç†æ„å»ºç¼“å­˜ ==="
          sudo rm -rf /tmp/compiler-build-* 2>/dev/null || true
          echo "æ¸…ç†å®Œæˆ"

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          
          echo "å…‹éš†OpenWrt ${{ env.OPENWRT_VERSION }} åˆ†æ”¯..."
          git clone --depth 1 --branch v${{ env.OPENWRT_VERSION }} https://github.com/openwrt/openwrt.git . 2>&1 | tee /tmp/clone.log
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "Git cloneå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨taråŒ…..."
            wget -q --show-progress -O openwrt.tar.xz https://github.com/openwrt/openwrt/archive/refs/tags/v${{ env.OPENWRT_VERSION }}.tar.gz
            tar -xzf openwrt.tar.xz --strip-components=1
            rm -f openwrt.tar.xz
            echo "ä½¿ç”¨taråŒ…ä¸‹è½½æˆåŠŸ"
          fi
          
          echo "æºç ç›®å½•: $(pwd)"

      - name: ğŸ“ ç”Ÿæˆé…ç½®æ–‡ä»¶
        run: |
          echo "=== ç”ŸæˆOpenWrté…ç½® ==="
          cd "${{ env.BUILD_DIR }}"
          
          # åˆ›å»ºsiteé…ç½®
          mkdir -p include/site
          echo "ac_cv_sys_file_offset_bits=64" > include/site/${{ env.ARCH_NAME }}
          echo "ac_cv_sys_large_files=yes" >> include/site/${{ env.ARCH_NAME }}
          echo "ac_cv_c_bigendian=no" >> include/site/${{ env.ARCH_NAME }}
          
          # ç”Ÿæˆé…ç½®
          CONFIG_FILE=".config"
          echo "# ç›®æ ‡é…ç½®" > $CONFIG_FILE
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_Default=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_SUBTARGET=\"${{ env.SUBTARGET }}\"" >> $CONFIG_FILE
          echo "CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"" >> $CONFIG_FILE
          echo "CONFIG_ARCH=\"${{ env.ARCH_NAME }}\"" >> $CONFIG_FILE
          echo "CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}-\"" >> $CONFIG_FILE
          echo "CONFIG_TARGET_OPTIMIZATION=\"-Os -pipe\"" >> $CONFIG_FILE
          echo "CONFIG_CPU_TYPE=\"${{ env.CPU_TYPE }}\"" >> $CONFIG_FILE
          echo "CONFIG_TARGET_OPTIONS=\"${{ env.TUNE }}\"" >> $CONFIG_FILE
          
          if [ -n "${{ env.FLOAT_ABI }}" ]; then
            echo "CONFIG_SOFT_FLOAT=\"$(if [ \"${{ env.FLOAT_ABI }}\" = \"softfloat\" ]; then echo y; else echo n; fi)\"" >> $CONFIG_FILE
            echo "CONFIG_HARD_FLOAT=\"$(if [ \"${{ env.FLOAT_ABI }}\" = \"hard\" ]; then echo y; else echo n; fi)\"" >> $CONFIG_FILE
          fi
          
          if [ -n "${{ env.FPU }}" ]; then
            echo "CONFIG_FPU=\"${{ env.FPU }}\"" >> $CONFIG_FILE
          fi
          
          echo "" >> $CONFIG_FILE
          echo "# å·¥å…·é“¾é…ç½®" >> $CONFIG_FILE
          echo "CONFIG_EXTERNAL_TOOLCHAIN=n" >> $CONFIG_FILE
          echo "CONFIG_USE_MUSL=${{ env.USE_MUSL }}" >> $CONFIG_FILE
          echo "CONFIG_USE_GLIBC=${{ env.USE_GLIBC }}" >> $CONFIG_FILE
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> $CONFIG_FILE
          echo "CONFIG_TOOLCHAIN_BUILD=y" >> $CONFIG_FILE
          echo "CONFIG_TOOLCHAINOPTS=y" >> $CONFIG_FILE
          echo "" >> $CONFIG_FILE
          
          echo "# ç‰ˆæœ¬é…ç½®" >> $CONFIG_FILE
          echo "CONFIG_GCC_VERSION=\"${{ env.GCC_VERSION }}\"" >> $CONFIG_FILE
          echo "CONFIG_BINUTILS_VERSION=\"${{ env.BINUTILS_VERSION }}\"" >> $CONFIG_FILE
          echo "CONFIG_LINUX_VERSION=\"${{ env.LINUX_VERSION }}\"" >> $CONFIG_FILE
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "CONFIG_MUSL_VERSION=\"${{ needs.setup.outputs.musl_version }}\"" >> $CONFIG_FILE
          else
            echo "CONFIG_GLIBC_VERSION=\"${{ needs.setup.outputs.glibc_version }}\"" >> $CONFIG_FILE
          fi
          
          echo "" >> $CONFIG_FILE
          echo "# ä¼˜åŒ–é…ç½®" >> $CONFIG_FILE
          echo "CONFIG_ALL=n" >> $CONFIG_FILE
          echo "CONFIG_ALL_KMODS=n" >> $CONFIG_FILE
          echo "CONFIG_ALL_NONSHARED=n" >> $CONFIG_FILE
          echo "CONFIG_BUILD_PACKAGES=n" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_busybox=n" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_dnsmasq=n" >> $CONFIG_FILE
          echo "CONFIG_DEVEL=y" >> $CONFIG_FILE
          echo "CONFIG_CCACHE=n" >> $CONFIG_FILE
          echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_ROOTFS_CPIOGZ=y" >> $CONFIG_FILE
          echo "CONFIG_GCC_DEFAULT_PIE=n" >> $CONFIG_FILE
          echo "CONFIG_GCC_DEFAULT_SSP=n" >> $CONFIG_FILE
          
          echo "é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
          echo "ç›®æ ‡: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "æ¶æ„: ${{ env.ARCH_NAME }}"

      - name: ğŸ”¨ ç¼–è¯‘å·¥å…·é“¾
        timeout-minutes: 150
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å·¥å…·é“¾ ==="
          cd "${{ env.BUILD_DIR }}"
          
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
          
          echo "æ­¥éª¤1: åº”ç”¨é…ç½®..."
          make defconfig 2>&1 | tee /tmp/defconfig.log
          
          echo "æ­¥éª¤2: ä¸‹è½½æºç åŒ…..."
          mkdir -p dl
          make -j1 download V=s 2>&1 | tee /tmp/download.log
          
          echo "æ­¥éª¤3: ç¼–è¯‘binutils..."
          make toolchain/binutils/compile -j$(nproc) V=s 2>&1 | tee /tmp/binutils.log
          
          echo "æ­¥éª¤4: ç¼–è¯‘gccåˆå§‹é˜¶æ®µ..."
          make toolchain/gcc/initial/compile -j$(nproc) V=s 2>&1 | tee /tmp/gcc-initial.log
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "æ­¥éª¤5: ç¼–è¯‘musl Cåº“..."
            make toolchain/musl/compile -j$(nproc) V=s 2>&1 | tee /tmp/musl.log
          else
            echo "æ­¥éª¤5: ç¼–è¯‘glibc Cåº“..."
            make toolchain/glibc/compile -j$(nproc) V=s 2>&1 | tee /tmp/glibc.log
          fi
          
          echo "æ­¥éª¤6: ç¼–è¯‘å®Œæ•´gcc..."
          make toolchain/gcc/final/compile -j$(nproc) V=s 2>&1 | tee /tmp/gcc-final.log
          
          echo "æ­¥éª¤7: å®‰è£…å·¥å…·é“¾..."
          make toolchain/install -j$(nproc) V=s 2>&1 | tee /tmp/install.log
          
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: âœ… éªŒè¯ç¼–è¯‘ç»“æœ
        run: |
          echo "=== éªŒè¯ç¼–è¯‘ç»“æœ ==="
          cd "${{ env.BUILD_DIR }}"
          
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            exit 1
          fi
          
          echo "å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          
          COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" | head -1)
          
          if [ -z "$COMPILER_PATH" ]; then
            echo "æœªæ‰¾åˆ°ç¼–è¯‘å™¨"
            exit 1
          fi
          
          COMPILER_NAME=$(basename "$COMPILER_PATH")
          echo "ç¼–è¯‘å™¨: $COMPILER_NAME"
          
          echo "ç¼–è¯‘å™¨ä¿¡æ¯:"
          "$COMPILER_PATH" --version 2>&1 | head -2
          echo "ç›®æ ‡æœºå™¨:"
          "$COMPILER_PATH" -dumpmachine 2>&1
          
          echo "æµ‹è¯•ç¼–è¯‘..."
          echo '#include <stdio.h>' > test.c
          echo 'int main() { printf("Test OK\\n"); return 0; }' >> test.c
          
          "$COMPILER_PATH" test.c -o test_program
          
          if [ $? -eq 0 ] && [ -f "test_program" ]; then
            echo "âœ… äº¤å‰ç¼–è¯‘æµ‹è¯•é€šè¿‡"
            file test_program
            rm -f test.c test_program
          else
            echo "âŒ äº¤å‰ç¼–è¯‘æµ‹è¯•å¤±è´¥"
            exit 1
          fi
          
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV

      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨ ==="
          cd "${{ env.BUILD_DIR }}"
          
          mkdir -p "${{ env.OUTPUT_DIR }}"
          
          echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
          cp -r "$TOOLCHAIN_DIR"/* "${{ env.OUTPUT_DIR }}/" 2>/dev/null || true
          
          echo "åˆ›å»ºè¯¦ç»†è¯´æ˜æ–‡ä»¶..."
          echo "# ${{ env.ARCH_NAME }} ${{ env.LIBC_SUFFIX }} äº¤å‰ç¼–è¯‘å™¨" > "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "## ğŸ“± è®¾å¤‡æ”¯æŒ" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          
          # æ ¹æ®æ¶æ„æ·»åŠ è®¾å¤‡åˆ—è¡¨
          case "${{ env.ARCH_NAME }}" in
            arm)
              echo "### ğŸ¯ ARM Cortex-A7 è®¾å¤‡" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "- **é«˜é€š IPQ40xx ç³»åˆ—**ï¼š" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "  - å°ç±³è·¯ç”±å™¨4Aåƒå…†ç‰ˆ" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "  - çº¢ç±³è·¯ç”±å™¨AC2100" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "  - 360å®¶åº­é˜²ç«å¢™5Pro" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "  - GL.iNet MT1300" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "- **è”å‘ç§‘ MT7623/MT7629**ï¼š" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "  - å°ç±³è·¯ç”±å™¨3G" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "  - æ–è®¯K3C" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "- **å…¨å¿— H3/H2+**ï¼š" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "  - é¦™æ©™æ´¾ Orange Pi PC" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "  - é¦™è•‰æ´¾ Banana Pi M2+" >> "${{ env.OUTPUT_DIR }}/README.md"
              ;;
            aarch64)
              echo "### ğŸ¯ ARM64 è®¾å¤‡" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "- **æ ‘è“æ´¾**ï¼šæ ‘è“æ´¾4Bã€CM4" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "- **ç‘èŠ¯å¾®**ï¼šRK3399ã€RK3568å¼€å‘æ¿" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "- **æ™¶æ™¨**ï¼šS905ç”µè§†ç›’å­" >> "${{ env.OUTPUT_DIR }}/README.md"
              ;;
            mips|mipsel)
              echo "### ğŸ¯ MIPS è®¾å¤‡" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "- **è”å‘ç§‘ MT7621**ï¼šK2Pã€Newifi3ã€å°ç±³è·¯ç”±å™¨3G" >> "${{ env.OUTPUT_DIR }}/README.md"
              echo "- **MT7620**ï¼šæè·¯ç”±1Sã€å°ç±³è·¯ç”±å™¨Mini" >> "${{ env.OUTPUT_DIR }}/README.md"
              ;;
          esac
          
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "## ğŸ”§ æŠ€æœ¯è§„æ ¼" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- **æ¶æ„**: ${{ env.ARCH_NAME }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- **Cåº“**: ${{ env.LIBC_SUFFIX }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- **CPUç±»å‹**: ${{ env.CPU_TYPE }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          if [ -n "${{ env.ABI }}" ]; then
            echo "- **ABI**: ${{ env.ABI }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          fi
          if [ -n "${{ env.FLOAT_ABI }}" ]; then
            echo "- **æµ®ç‚¹ABI**: ${{ env.FLOAT_ABI }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          fi
          if [ -n "${{ env.FPU }}" ]; then
            echo "- **FPU**: ${{ env.FPU }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          fi
          echo "- **GCCç‰ˆæœ¬**: ${{ env.GCC_VERSION }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- **Linuxå†…æ ¸**: ${{ env.LINUX_VERSION }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- **OpenWrtç‰ˆæœ¬**: ${{ env.OPENWRT_VERSION }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          
          echo "## ğŸš€ ä½¿ç”¨æ–¹æ³•" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo '```bash' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "# 1. è®¾ç½®ç¯å¢ƒå˜é‡" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "export STAGING_DIR=\"$(pwd)\"" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo 'export PATH="$STAGING_DIR/bin:$PATH"' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "# 2. éªŒè¯ç¼–è¯‘å™¨" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "${{ env.PREFIX }}-gcc --version" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "${{ env.PREFIX }}-gcc -dumpmachine" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPATH }}/README.md"
          echo "# 3. ç¼–è¯‘ç¤ºä¾‹ç¨‹åº" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo 'cat > hello.c << "EOF"' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo '#include <stdio.h>' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo 'int main() {' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo '    printf("Hello from ${{ env.ARCH_NAME }}!\\n");' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo '    return 0;' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo '}' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo 'EOF' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "${{ env.PREFIX }}-gcc hello.c -o hello" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo 'file hello' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo '```' >> "${{ env.OUTPUT_DIR }}/README.md"
          
          echo "ç¼–è¯‘å™¨ä¿å­˜å®Œæˆ"

      - name: ğŸ“¤ æäº¤åˆ°Gitä»“åº“
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°Gitä»“åº“ ==="
          cd "${{ github.workspace }}"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          
          git add -f "${{ env.COMPILER_BASE_DIR }}"/*
          
          if ! git diff --cached --quiet; then
            echo "æ£€æµ‹åˆ°å˜æ›´ï¼Œåˆ›å»ºæäº¤..."
            
            ARCH_NAME="${{ env.ARCH_NAME }}"
            LIBC_SUFFIX="${{ env.LIBC_SUFFIX }}"
            GCC_VERSION="${{ env.GCC_VERSION }}"
            
            git commit -m "build: æ·»åŠ  $ARCH_NAME-$LIBC_SUFFIX ç¼–è¯‘å™¨" \
              -m "è®¾å¤‡: ${{ env.TARGET }}/${{ env.SUBTARGET }}" \
              -m "GCC: $GCC_VERSION" \
              -m "å·¥ä½œæµ: #${{ github.run_id }}" \
              -m "æ„å»ºID: ${{ env.BUILD_ID }}"
            
            if git push; then
              echo "âœ… ç¼–è¯‘å™¨å·²æäº¤åˆ°ä»“åº“"
            else
              echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå°è¯•æ‹‰å–åé‡è¯•"
              git pull origin main
              git push
            fi
          else
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi

      - name: ğŸ“„ ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.BUILD_ID }}
          path: /tmp/*.log
          retention-days: 30
