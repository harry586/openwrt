# .github/workflows/compiler-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '21.02.5'
        type: choice
        options: ['21.02.5', '22.03.5', '23.05.2']
      arch_type:
        description: 'æ¶æ„ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options: ['all', 'arm', 'mips', 'x86', 'riscv', 'aarch64']

env:
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"
  BUILD_BASE_DIR: "/mnt/compiler-build"

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      arch_list: ${{ steps.setup-arch.outputs.arch_list }}
      openwrt_version: ${{ steps.version-detection.outputs.openwrt_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      start_time: ${{ steps.get-time.outputs.start_time }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: â° è·å–å¼€å§‹æ—¶é—´
        id: get-time
        run: |
          echo "start_time=$(date)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ è®¾ç½®æ„å»ºç›®å½•æƒé™
        run: |
          echo "=== è®¾ç½®æ„å»ºç›®å½•æƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $USER:$USER /mnt/compiler-build 2>/dev/null || true
          ls -ld /mnt/compiler-build

      - name: ğŸ—ï¸ åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          mkdir -p "${{ env.BUILD_BASE_DIR }}"
          echo "ç¼–è¯‘å™¨åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "æ„å»ºåŸºç¡€ç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„åˆ—è¡¨
        id: setup-arch
        run: |
          echo "=== è®¾ç½®ç›®æ ‡æ¶æ„åˆ—è¡¨ ==="
          ARCH_TYPE="${{ github.event.inputs.arch_type }}"
          if [ "$ARCH_TYPE" = "all" ]; then
            ARCH_LIST='["arm_cortex-a7","arm_cortex-a53","aarch64","x86_64","mips","mipsel","riscv64"]'
            echo "âœ… é€‰æ‹©æ‰€æœ‰æ¶æ„ç±»å‹"
          elif [ "$ARCH_TYPE" = "arm" ]; then
            ARCH_LIST='["arm_cortex-a7","arm_cortex-a53"]'
            echo "âœ… é€‰æ‹©ARMæ¶æ„"
          elif [ "$ARCH_TYPE" = "mips" ]; then
            ARCH_LIST='["mips","mipsel"]'
            echo "âœ… é€‰æ‹©MIPSæ¶æ„"
          elif [ "$ARCH_TYPE" = "x86" ]; then
            ARCH_LIST='["x86_64"]'
            echo "âœ… é€‰æ‹©x86æ¶æ„"
          elif [ "$ARCH_TYPE" = "riscv" ]; then
            ARCH_LIST='["riscv64"]'
            echo "âœ… é€‰æ‹©RISC-Væ¶æ„"
          elif [ "$ARCH_TYPE" = "aarch64" ]; then
            ARCH_LIST='["aarch64"]'
            echo "âœ… é€‰æ‹©AArch64æ¶æ„"
          else
            ARCH_LIST='["aarch64"]'
            echo "âš ï¸ æœªçŸ¥ç±»å‹ï¼Œé»˜è®¤é€‰æ‹©AArch64"
          fi
          echo "ç›®æ ‡æ¶æ„åˆ—è¡¨: $ARCH_LIST"
          echo "arch_list=$ARCH_LIST" >> $GITHUB_OUTPUT

      - name: ğŸ” ç‰ˆæœ¬æ£€æµ‹
        id: version-detection
        run: |
          echo "=== ç‰ˆæœ¬æ£€æµ‹ ==="
          OPENWRT_VERSION="${{ github.event.inputs.openwrt_version }}"
          echo "ç”¨æˆ·é€‰æ‹©çš„OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          if [ "$OPENWRT_VERSION" = "21.02.5" ]; then
            BINUTILS_VERSION="2.36.1"
            LINUX_VERSION="5.4.188"
            MUSL_VERSION="1.2.2"
            echo "â„¹ï¸ OpenWrt 21.02.5"
          elif [ "$OPENWRT_VERSION" = "22.03.5" ]; then
            BINUTILS_VERSION="2.38"
            LINUX_VERSION="5.10.179"
            MUSL_VERSION="1.2.3"
            echo "âœ… OpenWrt 22.03.5"
          elif [ "$OPENWRT_VERSION" = "23.05.2" ]; then
            BINUTILS_VERSION="2.40"
            LINUX_VERSION="5.15.133"
            MUSL_VERSION="1.2.4"
            echo "âœ… OpenWrt 23.05.2"
          fi
          echo "openwrt_version=$OPENWRT_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT

  build-matrix:
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJSON(needs.setup.outputs.arch_list) }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”§ è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™
        run: |
          echo "=== è®¾ç½®è¿è¡Œç¯å¢ƒæƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $(whoami):$(whoami) /mnt/compiler-build 2>/dev/null || true
          ls -ld /mnt/compiler-build

      - name: ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨
        run: |
          echo "=== æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ ==="
          ARCH="${{ matrix.arch }}"
          OPENWRT_VERSION='${{ needs.setup.outputs.openwrt_version }}'
          OUTPUT_BASE_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH}/musl/openwrt-${OPENWRT_VERSION}"
          echo "æ£€æŸ¥ç›®å½•: $OUTPUT_BASE_DIR"
          if [ -d "$OUTPUT_BASE_DIR" ]; then
            SUBDIRS=$(find "$OUTPUT_BASE_DIR" -maxdepth 1 -type d -name "gcc-*" 2>/dev/null | wc -l)
            if [ "$SUBDIRS" -gt 0 ]; then
              echo "âœ… å·²æœ‰æ­¤OpenWrtç‰ˆæœ¬çš„ç¼–è¯‘å™¨ï¼Œè·³è¿‡æ„å»º"
              echo "SKIP_BUILD=true" >> $GITHUB_ENV
              echo "JOB_STATUS=skipped" >> $GITHUB_ENV
            else
              echo "âš ï¸ æœ‰ç›®å½•ä½†æ— ç¼–è¯‘å™¨ï¼Œéœ€è¦æ„å»º"
              echo "SKIP_BUILD=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: â­ï¸ è·³è¿‡æ„å»º
        if: env.SKIP_BUILD == 'true'
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æ„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
          echo "- æ¶æ„: ${{ matrix.arch }}"
          echo "- OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "========================================"

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æ¶æ„: ${{ matrix.arch }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "Cåº“ç±»å‹: musl"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ğŸ”§ è®¾ç½®æ¶æ„ç¯å¢ƒ
        id: setup-env
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è®¾ç½®æ¶æ„ç¯å¢ƒ ==="
          ARCH="${{ matrix.arch }}"
          if [ "$ARCH" = "arm_cortex-a7" ]; then
            TARGET="sunxi"
            SUBTARGET="cortexa7"
            ARCH_NAME="arm"
            PREFIX="arm-openwrt-linux-muslgnueabi"
            CPU_TYPE="cortex-a7"
            TARGET_CPU="arm_cortex-a7"
            ARCH_TYPE_TITLE="ARM Cortex-A7 (32ä½)"
            EXPECTED_ARCH="arm"
            EXPECTED_COMPILER_PREFIX="arm-"
            FORCE_32BIT="true"
          elif [ "$ARCH" = "arm_cortex-a53" ]; then
            # ä¿®å¤ï¼šä½¿ç”¨sunxiå¹³å°ï¼Œç¡®ä¿32ä½ARMæ„å»º
            TARGET="sunxi"
            SUBTARGET="cortexa53"
            ARCH_NAME="arm"
            PREFIX="arm-openwrt-linux-muslgnueabi"
            CPU_TYPE="cortex-a53"
            TARGET_CPU="arm_cortex-a53"
            ARCH_TYPE_TITLE="ARM Cortex-A53 (32ä½)"
            EXPECTED_ARCH="arm"
            EXPECTED_COMPILER_PREFIX="arm-"
            FORCE_32BIT="true"
            echo "âœ… ä½¿ç”¨ Sunxi Cortex-A53 å¹³å°ï¼Œç¡®ä¿32ä½ARMæ„å»º"
          elif [ "$ARCH" = "aarch64" ]; then
            TARGET="armvirt"
            SUBTARGET="64"
            ARCH_NAME="aarch64"
            PREFIX="aarch64-openwrt-linux-musl"
            CPU_TYPE="cortex-a53"
            TARGET_CPU="aarch64_cortex-a53"
            ARCH_TYPE_TITLE="AArch64 (64ä½)"
            EXPECTED_ARCH="aarch64"
            EXPECTED_COMPILER_PREFIX="aarch64-"
            FORCE_32BIT="false"
          elif [ "$ARCH" = "x86_64" ]; then
            TARGET="x86"
            SUBTARGET="64"
            ARCH_NAME="x86_64"
            PREFIX="x86_64-openwrt-linux-musl"
            CPU_TYPE=""
            TARGET_CPU="x86_64"
            ARCH_TYPE_TITLE="x86_64 (64ä½)"
            EXPECTED_ARCH="x86_64"
            EXPECTED_COMPILER_PREFIX="x86_64-"
            FORCE_32BIT="false"
          elif [ "$ARCH" = "mips" ]; then
            TARGET="ramips"
            SUBTARGET="mt7621"
            ARCH_NAME="mips"
            PREFIX="mips-openwrt-linux-musl"
            CPU_TYPE="24kc"
            TARGET_CPU="mips_24kc"
            ARCH_TYPE_TITLE="MIPS (å¤§ç«¯)"
            EXPECTED_ARCH="mips"
            EXPECTED_COMPILER_PREFIX="mips-"
            FORCE_32BIT="false"
          elif [ "$ARCH" = "mipsel" ]; then
            TARGET="ramips"
            SUBTARGET="mt7621"
            ARCH_NAME="mipsel"
            PREFIX="mipsel-openwrt-linux-musl"
            CPU_TYPE="24kc"
            TARGET_CPU="mipsel_24kc"
            ARCH_TYPE_TITLE="MIPSel (å°ç«¯)"
            EXPECTED_ARCH="mipsel"
            EXPECTED_COMPILER_PREFIX="mipsel-"
            FORCE_32BIT="false"
          elif [ "$ARCH" = "riscv64" ]; then
            TARGET="virt"
            SUBTARGET="rv64"
            ARCH_NAME="riscv64"
            PREFIX="riscv64-openwrt-linux-musl"
            CPU_TYPE=""
            TARGET_CPU="riscv64"
            ARCH_TYPE_TITLE="RISC-V 64ä½"
            EXPECTED_ARCH="riscv64"
            EXPECTED_COMPILER_PREFIX="riscv64-"
            FORCE_32BIT="false"
          fi
          BUILD_ID="${ARCH}_musl_openwrt-${{ needs.setup.outputs.openwrt_version }}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="${{ env.BUILD_BASE_DIR }}/${BUILD_ID}"
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "TARGET_CPU=$TARGET_CPU" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "ARCH_TYPE_TITLE=$ARCH_TYPE_TITLE" >> $GITHUB_ENV
          echo "EXPECTED_ARCH=$EXPECTED_ARCH" >> $GITHUB_ENV
          echo "EXPECTED_COMPILER_PREFIX=$EXPECTED_COMPILER_PREFIX" >> $GITHUB_ENV
          echo "FORCE_32BIT=$FORCE_32BIT" >> $GITHUB_ENV

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== å®‰è£…æ„å»ºä¾èµ– ==="
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison git wget curl file gawk gettext rsync unzip autoconf automake libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev libelf-dev libdw-dev libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev python3 python3-dev libncurses5-dev libssl-dev liblzma-dev zlib1g-dev

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        if: env.SKIP_BUILD != 'true'
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          OPENWRT_VERSION="${{ needs.setup.outputs.openwrt_version }}"
          echo "å…‹éš†OpenWrt $OPENWRT_VERSION æºç ..."
          git clone --depth 1 --branch "v$OPENWRT_VERSION" https://github.com/openwrt/openwrt.git .
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"

      - name: âš™ï¸ ä¿®å¤ARMé…ç½®å¹¶æ„å»ºå·¥å…·é“¾
        if: env.SKIP_BUILD != 'true'
        timeout-minutes: 300
        run: |
          echo "=== ä¿®å¤ARMé…ç½®å¹¶æ„å»ºå·¥å…·é“¾ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "æ­¥éª¤1: æ›´æ–°feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo "æ­¥éª¤2: é…ç½®ç›®æ ‡å¹³å°..."
          rm -f .config
          
          # ä¿®å¤ARMé…ç½®
          if [ "${{ matrix.arch }}" = "arm_cortex-a7" ]; then
            echo "CONFIG_TARGET_sunxi=y" > .config
            echo "CONFIG_TARGET_sunxi_cortexa7=y" >> .config
            echo "CONFIG_TARGET_ARCH_PACKAGES=\"arm_cortex-a7_neon-vfpv4\"" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv7-a -mtune=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard\"" >> .config
            echo "CONFIG_arm=y" >> .config
            echo "CONFIG_ARCH=\"arm\"" >> .config
            echo "CONFIG_CPU_TYPE=\"cortex-a7\"" >> .config
            echo "CONFIG_FPU=\"neon-vfpv4\"" >> .config
            echo "CONFIG_FLOAT=\"hard\"" >> .config
            # æ˜ç¡®ç¦ç”¨64ä½
            echo "CONFIG_arm64=n" >> .config
            echo "CONFIG_AARCH64=n" >> .config
            echo "CONFIG_ARCH_64BIT=n" >> .config
          elif [ "${{ matrix.arch }}" = "arm_cortex-a53" ]; then
            # å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ˜ç¡®çš„sunxi cortexa53é…ç½®ï¼Œç¡®ä¿32ä½ARM
            echo "CONFIG_TARGET_sunxi=y" > .config
            echo "CONFIG_TARGET_sunxi_cortexa53=y" >> .config
            echo "CONFIG_TARGET_ARCH_PACKAGES=\"arm_cortex-a53_neon-vfpv4\"" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv8-a -mtune=cortex-a53 -mfpu=neon-vfpv4 -mfloat-abi=hard -mabi=aapcs-linux\"" >> .config
            echo "CONFIG_arm=y" >> .config
            echo "CONFIG_ARCH=\"arm\"" >> .config
            echo "CONFIG_CPU_TYPE=\"cortex-a53\"" >> .config
            echo "CONFIG_FPU=\"neon-vfpv4\"" >> .config
            echo "CONFIG_FLOAT=\"hard\"" >> .config
            # å¼ºåˆ¶32ä½ARM
            echo "CONFIG_arm64=n" >> .config
            echo "CONFIG_AARCH64=n" >> .config
            echo "CONFIG_ARCH_64BIT=n" >> .config
            # æ˜ç¡®ç¦ç”¨å…¶ä»–å¯èƒ½å¼•èµ·æ··æ·†çš„é…ç½®
            echo "CONFIG_TARGET_armvirt=n" >> .config
            echo "CONFIG_TARGET_armvirt_64=n" >> .config
            echo "CONFIG_TARGET_ARCH=\"arm\"" >> .config
            echo "CONFIG_TARGET_SUBTARGET=\"sunxi\"" >> .config
            echo "CONFIG_TARGET_BOARD=\"sunxi\"" >> .config
          elif [ "${{ matrix.arch }}" = "aarch64" ]; then
            echo "CONFIG_TARGET_armvirt=y" > .config
            echo "CONFIG_TARGET_armvirt_64=y" >> .config
            echo "CONFIG_TARGET_ARCH_PACKAGES=\"aarch64_generic\"" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv8-a -mtune=cortex-a53\"" >> .config
            echo "CONFIG_arm64=y" >> .config
            echo "CONFIG_ARCH=\"arm64\"" >> .config
            echo "CONFIG_CPU_TYPE=\"cortex-a53\"" >> .config
            echo "CONFIG_ARCH_64BIT=y" >> .config
            # æ˜ç¡®ç¦ç”¨32ä½
            echo "CONFIG_arm=n" >> .config
            echo "CONFIG_TARGET_sunxi=n" >> .config
          elif [ "${{ matrix.arch }}" = "x86_64" ]; then
            echo "CONFIG_TARGET_x86=y" > .config
            echo "CONFIG_TARGET_x86_64=y" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=x86-64 -mtune=generic\"" >> .config
            echo "CONFIG_x86_64=y" >> .config
          elif [ "${{ matrix.arch }}" = "mips" ]; then
            echo "CONFIG_TARGET_ramips=y" > .config
            echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=24kc -mtune=24kc\"" >> .config
            echo "CONFIG_mips=y" >> .config
            echo "CONFIG_CPU_TYPE=\"24kc\"" >> .config
            echo "CONFIG_BIG_ENDIAN=y" >> .config
            echo "CONFIG_LITTLE_ENDIAN=n" >> .config
          elif [ "${{ matrix.arch }}" = "mipsel" ]; then
            echo "CONFIG_TARGET_ramips=y" > .config
            echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"  -march=24kc -mtune=24kc\"" >> .config
            echo "CONFIG_mips=y" >> .config
            echo "CONFIG_CPU_TYPE=\"24kc\"" >> .config
            echo "CONFIG_BIG_ENDIAN=n" >> .config
            echo "CONFIG_LITTLE_ENDIAN=y" >> .config
          elif [ "${{ matrix.arch }}" = "riscv64" ]; then
            echo "CONFIG_TARGET_virt=y" > .config
            echo "CONFIG_TARGET_virt_rv64=y" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=rv64gc -mtune=generic\"" >> .config
            echo "CONFIG_riscv=y" >> .config
          fi
          
          # é€šç”¨é…ç½®
          echo "CONFIG_SDK=y" >> .config
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "CONFIG_TOOLCHAINOPTS=y" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_LIBC=\"musl\"" >> .config
          echo "CONFIG_USE_MUSL=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_INITRAMFS=n" >> .config
          echo "CONFIG_TARGET_ROOTFS_EXT4FS=n" >> .config
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=n" >> .config
          echo "CONFIG_TARGET_PREINITOPT=y" >> .config
          # å…³é”®ï¼šç¡®ä¿ç”ŸæˆSDK
          echo "CONFIG_IB=y" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "CONFIG_BUILD_PATENTED=y" >> .config
          
          echo "æ­¥éª¤3: åº”ç”¨é…ç½®å¹¶éªŒè¯..."
          yes "" | make defconfig 2>&1 | tail -30
          
          echo "éªŒè¯é…ç½®:"
          echo "æ¶æ„ç›¸å…³é…ç½®:"
          grep -E "CONFIG_(TARGET|arm|arm64|ARCH|CPU)" .config | grep -v "=n" || true
          
          echo "æ­¥éª¤4: ä¸‹è½½æºç ..."
          make -j$(nproc) download 2>&1 | tee /tmp/download.log
          
          echo "æ­¥éª¤5: æ„å»ºå·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          make toolchain/clean 2>&1 | tail -10
          
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          make toolchain/compile -j$(nproc) 2>&1 | tee /tmp/toolchain_compile.log | tail -100
          
          echo "å®‰è£…å·¥å…·é“¾..."
          make toolchain/install -j$(nproc) 2>&1 | tee /tmp/toolchain_install.log | tail -50
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" 2>/dev/null | head -1)
          if [ -n "$TOOLCHAIN_DIR" ] && [ -d "$TOOLCHAIN_DIR" ]; then
            echo "âœ… å·¥å…·é“¾æ„å»ºæˆåŠŸï¼Œç›®å½•: $TOOLCHAIN_DIR"
            echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
            echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
            echo "BUILD_ERROR=" >> $GITHUB_ENV
            
            # ç«‹å³æ£€æŸ¥ç¼–è¯‘å™¨ç±»å‹
            COMPILER=$(find "$TOOLCHAIN_DIR" -name "*gcc" -type f -executable 2>/dev/null | head -1)
            if [ -n "$COMPILER" ]; then
              COMPILER_NAME=$(basename "$COMPILER")
              echo "ç«‹å³æ£€æŸ¥ç¼–è¯‘å™¨: $COMPILER_NAME"
              if [ "${{ env.FORCE_32BIT }}" = "true" ] && echo "$COMPILER_NAME" | grep -q "aarch64"; then
                echo "âŒ ä¸¥é‡é”™è¯¯: æœŸæœ›32ä½ARMä½†æ„å»ºäº†aarch64ç¼–è¯‘å™¨!"
                echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
                echo "BUILD_ERROR=\"é…ç½®é”™è¯¯: æ„å»ºäº†é”™è¯¯çš„ç¼–è¯‘å™¨æ¶æ„\"" >> $GITHUB_ENV
              fi
            fi
          else
            echo "âŒ å·¥å…·é“¾æ„å»ºå¤±è´¥"
            echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
            ERROR_MSG=$(grep -E "Error:|error:|failed:" /tmp/toolchain_compile.log | tail -3 | tr '\n' ' ')
            echo "BUILD_ERROR=\"å·¥å…·é“¾æ„å»ºå¤±è´¥: $ERROR_MSG\"" >> $GITHUB_ENV
          fi
          
          echo "æ„å»ºå®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ” éªŒè¯ç¼–è¯‘å™¨
        id: validate-compiler
        if: env.SKIP_BUILD != 'true' && env.BUILD_SUCCESS == 'true'
        run: |
          echo "=== éªŒè¯ç¼–è¯‘å™¨ ==="
          cd "${{ env.BUILD_DIR }}"
          
          TOOLCHAIN_DIR="${{ env.TOOLCHAIN_DIR }}"
          echo "å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          
          echo "æœç´¢ç¼–è¯‘å™¨..."
          COMPILER=$(find "$TOOLCHAIN_DIR" -name "*gcc" -type f -executable 2>/dev/null | head -1)
          
          if [ -z "$COMPILER" ]; then
            COMPILER=$(find staging_dir -name "*gcc" -type f -executable 2>/dev/null | head -1)
          fi
          
          if [ -z "$COMPILER" ] || [ ! -x "$COMPILER" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°å¯æ‰§è¡Œçš„ç¼–è¯‘å™¨"
            echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
            echo "VALIDATION_ERROR=\"æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨\"" >> $GITHUB_ENV
            exit 1
          fi
          
          COMPILER_NAME=$(basename "$COMPILER")
          echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $COMPILER"
          echo "ç¼–è¯‘å™¨åç§°: $COMPILER_NAME"
          
          COMPILER_VERSION=$("$COMPILER" --version 2>&1 | head -1)
          echo "ç¼–è¯‘å™¨ä¿¡æ¯: $COMPILER_VERSION"
          
          GCC_VERSION=$(echo "$COMPILER_VERSION" | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1 || echo "unknown")
          if [ "$GCC_VERSION" = "unknown" ]; then
            GCC_VERSION=$(echo "$COMPILER_VERSION" | grep -o "[0-9]\+\.[0-9]\+" | head -1 || echo "unknown")
          fi
          
          COMPILER_TARGET=$("$COMPILER" -dumpmachine 2>/dev/null || echo "unknown")
          
          echo "ç¼–è¯‘å™¨ç‰ˆæœ¬: $GCC_VERSION"
          echo "ç¼–è¯‘å™¨ç›®æ ‡: $COMPILER_TARGET"
          
          EXPECTED_ARCH="${{ env.EXPECTED_ARCH }}"
          FORCE_32BIT="${{ env.FORCE_32BIT }}"
          
          echo "éªŒè¯æ¶æ„: æœŸæœ›=$EXPECTED_ARCH, å¼ºåˆ¶32ä½=$FORCE_32BIT"
          echo "å®é™…ç¼–è¯‘å™¨: $COMPILER_NAME, ç›®æ ‡=$COMPILER_TARGET"
          
          # æ¶æ„éªŒè¯
          if [ "$EXPECTED_ARCH" = "arm" ]; then
            if echo "$COMPILER_NAME" | grep -q "^arm" && ! echo "$COMPILER_NAME" | grep -q "aarch64"; then
              if echo "$COMPILER_TARGET" | grep -q "arm" && ! echo "$COMPILER_TARGET" | grep -q "aarch64"; then
                echo "âœ… ARMæ¶æ„éªŒè¯é€šè¿‡: $COMPILER_NAME"
                echo "VALIDATION_SUCCESS=true" >> $GITHUB_ENV
                echo "VALIDATION_ERROR=" >> $GITHUB_ENV
              else
                echo "âŒ ç¼–è¯‘å™¨ç›®æ ‡ä¸åŒ¹é…: $COMPILER_TARGET"
                echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
                echo "VALIDATION_ERROR=\"ç¼–è¯‘å™¨ç›®æ ‡ä¸åŒ¹é…ARMæ¶æ„: $COMPILER_TARGET\"" >> $GITHUB_ENV
                exit 1
              fi
            else
              echo "âŒ ç¼–è¯‘å™¨åç§°ä¸åŒ¹é…ARMæ¶æ„: $COMPILER_NAME"
              echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
              echo "VALIDATION_ERROR=\"ç¼–è¯‘å™¨åç§°ä¸åŒ¹é…ARMæ¶æ„: $COMPILER_NAME\"" >> $GITHUB_ENV
              exit 1
            fi
          elif [ "$EXPECTED_ARCH" = "aarch64" ]; then
            if echo "$COMPILER_NAME" | grep -q "aarch64" || echo "$COMPILER_TARGET" | grep -q "aarch64"; then
              echo "âœ… AArch64æ¶æ„éªŒè¯é€šè¿‡: $COMPILER_NAME"
              echo "VALIDATION_SUCCESS=true" >> $GITHUB_ENV
              echo "VALIDATION_ERROR=" >> $GITHUB_ENV
            else
              echo "âŒ ç¼–è¯‘å™¨ä¸åŒ¹é…AArch64æ¶æ„"
              echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
              echo "VALIDATION_ERROR=\"ç¼–è¯‘å™¨ä¸åŒ¹é…AArch64æ¶æ„: $COMPILER_NAME\"" >> $GITHUB_ENV
              exit 1
            fi
          else
            echo "âœ… å…¶ä»–æ¶æ„éªŒè¯é€šè¿‡: $COMPILER_NAME"
            echo "VALIDATION_SUCCESS=true" >> $GITHUB_ENV
            echo "VALIDATION_ERROR=" >> $GITHUB_ENV
          fi
          
          echo "æµ‹è¯•ç¼–è¯‘å™¨åŠŸèƒ½..."
          TEST_FILE="/tmp/test_$$.c"
          echo 'int main() { return 0; }' > "$TEST_FILE"
          
          OUTPUT_FILE="/tmp/test_$$.out"
          COMPILE_OUTPUT=$("$COMPILER" "$TEST_FILE" -o "$OUTPUT_FILE" 2>&1)
          COMPILE_STATUS=$?
          
          if [ $COMPILE_STATUS -eq 0 ]; then
            echo "âœ… ç¼–è¯‘å™¨åŠŸèƒ½æµ‹è¯•é€šè¿‡"
            rm -f "$TEST_FILE" "$OUTPUT_FILE"
          else
            echo "âŒ é”™è¯¯: ç¼–è¯‘å™¨åŠŸèƒ½æµ‹è¯•å¤±è´¥"
            echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
            echo "VALIDATION_ERROR=\"ç¼–è¯‘å™¨åŠŸèƒ½æµ‹è¯•å¤±è´¥\"" >> $GITHUB_ENV
            rm -f "$TEST_FILE"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡"
          echo "COMPILER_NAME=$COMPILER_NAME" >> $GITHUB_ENV
          echo "COMPILER_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "COMPILER_TARGET=$COMPILER_TARGET" >> $GITHUB_ENV
          echo "COMPILER_PATH=$COMPILER" >> $GITHUB_ENV

      - name: ğŸ’¾ ä¿®å¤ä¿å­˜æ„å»ºç»“æœ
        if: env.SKIP_BUILD != 'true' && env.BUILD_SUCCESS == 'true' && env.VALIDATION_SUCCESS == 'true'
        run: |
          echo "=== ä¿®å¤ä¿å­˜æ„å»ºç»“æœ ==="
          cd "${{ env.BUILD_DIR }}"
          
          CLEAN_GCC_VERSION=$(echo "${{ env.COMPILER_VERSION }}" | tr -d '\n\r' | xargs echo -n)
          if [ -z "$CLEAN_GCC_VERSION" ] || [ "$CLEAN_GCC_VERSION" = "unknown" ]; then
            # å°è¯•ä»ç¼–è¯‘å™¨è·å–ç‰ˆæœ¬
            COMPILER="${{ env.COMPILER_PATH }}"
            if [ -x "$COMPILER" ]; then
              CLEAN_GCC_VERSION=$("$COMPILER" -dumpversion 2>/dev/null || echo "unknown")
            else
              CLEAN_GCC_VERSION="unknown"
            fi
          fi
          
          ARCH_DIR="${{ matrix.arch }}"
          OUTPUT_BASE_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH_DIR}/musl/openwrt-${{ needs.setup.outputs.openwrt_version }}"
          echo "åˆ›å»ºè¾“å‡ºç›®å½•: $OUTPUT_BASE_DIR"
          mkdir -p "$OUTPUT_BASE_DIR"
          
          OUTPUT_DIR="${OUTPUT_BASE_DIR}/gcc-${CLEAN_GCC_VERSION}_binutils-${{ needs.setup.outputs.binutils_version }}"
          echo "å‡†å¤‡è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          
          # æ¸…ç†æ—§ç›®å½•
          rm -rf "$OUTPUT_DIR" 2>/dev/null || true
          mkdir -p "$OUTPUT_DIR"
          
          # å…³é”®ä¿®å¤ï¼šç›´æ¥å¤åˆ¶æ•´ä¸ªbuild_diråˆ°è¾“å‡ºç›®å½•
          echo "å¤åˆ¶æ•´ä¸ªæ„å»ºç›®å½•..."
          BUILD_CONTENTS=$(find . -maxdepth 1 -type f -name "*.config" -o -name "*.mk" -o -name "Makefile" | wc -l)
          if [ $BUILD_CONTENTS -gt 0 ]; then
            # ä½¿ç”¨tarç¡®ä¿æƒé™å’Œç¬¦å·é“¾æ¥æ­£ç¡®
            tar -czf /tmp/build_contents.tar.gz \
              staging_dir \
              .config \
              Config.in \
              Makefile \
              feeds.conf \
              feeds 2>/dev/null || true
            if [ -f "/tmp/build_contents.tar.gz" ]; then
              tar -xzf /tmp/build_contents.tar.gz -C "$OUTPUT_DIR"
              rm -f /tmp/build_contents.tar.gz
              echo "âœ… æ„å»ºç›®å½•å¤åˆ¶å®Œæˆ"
            else
              echo "âš ï¸ taræ‰“åŒ…å¤±è´¥ï¼Œå°è¯•ç›´æ¥å¤åˆ¶"
              cp -r staging_dir "$OUTPUT_DIR/" 2>/dev/null || true
            fi
          fi
          
          # å…³é”®ï¼šå°è¯•æ„å»ºSDKåŒ…
          echo "å°è¯•æ„å»ºSDKåŒ…..."
          if [ -f "include/image.mk" ]; then
            echo "æ„å»ºSDK..."
            make package/sdk 2>&1 | tail -50 || echo "SDKæ„å»ºå¤±è´¥ï¼Œç»§ç»­..."
            
            # æŸ¥æ‰¾SDKåŒ…
            SDK_FILE=$(find bin -name "*sdk*.tar.xz" -o -name "*sdk*.tar.gz" 2>/dev/null | head -1)
            if [ -n "$SDK_FILE" ] && [ -f "$SDK_FILE" ]; then
              echo "âœ… æ‰¾åˆ°SDKåŒ…: $SDK_FILE"
              cp "$SDK_FILE" "$OUTPUT_DIR/"
              echo "SDKåŒ…å·²å¤åˆ¶åˆ°: $OUTPUT_DIR/$(basename "$SDK_FILE")"
            fi
          fi
          
          # éªŒè¯æ–‡ä»¶ç¡®å®è¢«å¤åˆ¶
          echo "éªŒè¯å¤åˆ¶ç»“æœ..."
          if [ -d "$OUTPUT_DIR/staging_dir" ] || [ -f "$OUTPUT_DIR/.config" ]; then
            echo "âœ… æ–‡ä»¶å¤åˆ¶æˆåŠŸ"
            echo "è¾“å‡ºç›®å½•å†…å®¹:"
            ls -la "$OUTPUT_DIR" || true
          else
            echo "âŒ æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼Œå°è¯•æœ€åæ‰‹æ®µ..."
            # æœ€åæ‰‹æ®µï¼šå¤åˆ¶æ•´ä¸ªç›®å½•
            cp -r ./* "$OUTPUT_DIR/" 2>&1 | tail -10 || true
          fi
          
          echo "åˆ›å»ºå…ƒæ•°æ®..."
          METADATA_FILE="$OUTPUT_DIR/metadata.json"
          echo "{\"architecture\": \"${{ matrix.arch }}\",\"arch_name\": \"${{ env.ARCH_NAME }}\",\"libc\": \"musl\",\"libc_version\": \"${{ needs.setup.outputs.musl_version }}\",\"gcc_version\": \"$CLEAN_GCC_VERSION\",\"binutils_version\": \"${{ needs.setup.outputs.binutils_version }}\",\"linux_version\": \"${{ needs.setup.outputs.linux_version }}\",\"openwrt_version\": \"${{ needs.setup.outputs.openwrt_version }}\",\"target\": \"${{ env.TARGET }}\",\"subtarget\": \"${{ env.SUBTARGET }}\",\"compiler_prefix\": \"${{ env.PREFIX }}-\",\"compiler_name\": \"${{ env.COMPILER_NAME }}\",\"compiler_target\": \"${{ env.COMPILER_TARGET }}\",\"build_date\": \"$(date -Iseconds)\",\"build_id\": \"${{ env.BUILD_ID }}\"}" > "$METADATA_FILE"
          
          TOTAL_SIZE=$(du -sh "$OUTPUT_DIR" 2>/dev/null | cut -f1 || echo "0K")
          FILE_COUNT=$(find "$OUTPUT_DIR" -type f 2>/dev/null | wc -l || echo 0)
          
          echo "âœ… æ„å»ºç»“æœå·²ä¿å­˜"
          echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "ç¼–è¯‘å™¨æ–‡ä»¶: ${{ env.COMPILER_NAME }}"
          echo "ç¼–è¯‘å™¨ç‰ˆæœ¬: $CLEAN_GCC_VERSION"
          echo "æ€»å¤§å°: $TOTAL_SIZE"
          echo "æ–‡ä»¶æ•°: $FILE_COUNT"
          
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
          echo "GCC_VERSION=$CLEAN_GCC_VERSION" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          
          # éªŒè¯æ–‡ä»¶ç¡®å®å­˜åœ¨
          echo "éªŒè¯è¾“å‡ºæ–‡ä»¶..."
          if [ -f "$METADATA_FILE" ]; then
            echo "âœ… å…ƒæ•°æ®æ–‡ä»¶åˆ›å»ºæˆåŠŸ"
          else
            echo "âŒ å…ƒæ•°æ®æ–‡ä»¶åˆ›å»ºå¤±è´¥"
          fi
          
          echo "å®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ“ è®°å½•jobè¯¦ç»†ç»“æœ
        if: always()
        run: |
          echo "=== è®°å½•jobè¯¦ç»†ç»“æœ ==="
          
          ARCH_TITLE="${{ env.ARCH_TYPE_TITLE || matrix.arch }}"
          STATUS_ICON=""
          STATUS_TEXT=""
          DETAILS=""
          
          if [ "$SKIP_BUILD" = "true" ]; then
            STATUS_ICON="â­ï¸"
            STATUS_TEXT="å·²å­˜åœ¨ï¼Œè·³è¿‡"
            DETAILS="å·²å­˜åœ¨æ­¤OpenWrtç‰ˆæœ¬çš„ç¼–è¯‘å™¨"
          elif [ "$BUILD_SUCCESS" = "false" ]; then
            STATUS_ICON="âŒ"
            STATUS_TEXT="æ„å»ºå¤±è´¥"
            DETAILS="${BUILD_ERROR:-æœªçŸ¥æ„å»ºé”™è¯¯}"
          elif [ "$VALIDATION_SUCCESS" = "true" ]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="æ„å»ºæˆåŠŸ"
            DETAILS="ç¼–è¯‘å™¨: ${COMPILER_NAME:-unknown} v${GCC_VERSION:-unknown}, å¤§å°: ${TOTAL_SIZE:-unknown}, æ–‡ä»¶æ•°: ${FILE_COUNT:-unknown}"
          elif [ "$VALIDATION_SUCCESS" = "false" ]; then
            STATUS_ICON="âŒ"
            STATUS_TEXT="éªŒè¯å¤±è´¥"
            DETAILS="${VALIDATION_ERROR:-éªŒè¯é”™è¯¯}"
          else
            STATUS_ICON="âš ï¸"
            STATUS_TEXT="æœªçŸ¥çŠ¶æ€"
            DETAILS="æ— æ³•ç¡®å®šæ„å»ºçŠ¶æ€"
          fi
          
          RESULT_DIR="${{ github.workspace }}/.job-results"
          mkdir -p "$RESULT_DIR"
          
          RESULT_FILE="$RESULT_DIR/${{ matrix.arch }}.json"
          echo "{\"architecture\": \"${{ matrix.arch }}\",\"arch_title\": \"$ARCH_TITLE\",\"status_icon\": \"$STATUS_ICON\",\"status_text\": \"$STATUS_TEXT\",\"details\": \"$DETAILS\",\"openwrt_version\": \"${{ needs.setup.outputs.openwrt_version }}\",\"gcc_version\": \"${GCC_VERSION:-unknown}\",\"compiler_name\": \"${COMPILER_NAME:-unknown}\",\"output_dir\": \"${OUTPUT_DIR:-none}\",\"total_size\": \"${TOTAL_SIZE:-unknown}\",\"file_count\": \"${FILE_COUNT:-unknown}\"}" > "$RESULT_FILE"
          
          echo "ç»“æœå·²ä¿å­˜åˆ°: $RESULT_FILE"

      - name: ğŸ“Š æ˜¾ç¤ºjobæœ€ç»ˆç»“æœ
        if: always()
        run: |
          echo "========================================"
          echo "           JOBæœ€ç»ˆç»“æœæŠ¥å‘Š              "
          echo "========================================"
          
          ARCH_TITLE="${{ env.ARCH_TYPE_TITLE || matrix.arch }}"
          
          if [ "$SKIP_BUILD" = "true" ]; then
            echo "â­ï¸ $ARCH_TITLE"
            echo "   ç»“æœ: å·²å­˜åœ¨ï¼Œè·³è¿‡"
          elif [ "$BUILD_SUCCESS" = "false" ]; then
            echo "âŒ $ARCH_TITLE"
            echo "   ç»“æœ: æ„å»ºå¤±è´¥"
            echo "   é”™è¯¯: ${BUILD_ERROR:-æœªçŸ¥é”™è¯¯}"
          elif [ "$VALIDATION_SUCCESS" = "true" ]; then
            echo "âœ… $ARCH_TITLE"
            echo "   ç»“æœ: æ„å»ºæˆåŠŸ"
            echo "   ç¼–è¯‘å™¨: ${COMPILER_NAME:-unknown} v${GCC_VERSION:-unknown}"
            echo "   è¾“å‡ºç›®å½•: ${OUTPUT_DIR:-unknown}"
            echo "   å¤§å°: ${TOTAL_SIZE:-unknown}, æ–‡ä»¶æ•°: ${FILE_COUNT:-unknown}"
          elif [ "$VALIDATION_SUCCESS" = "false" ]; then
            echo "âŒ $ARCH_TITLE"
            echo "   ç»“æœ: éªŒè¯å¤±è´¥"
            echo "   é”™è¯¯: ${VALIDATION_ERROR:-éªŒè¯é”™è¯¯}"
          else
            echo "âš ï¸ $ARCH_TITLE"
            echo "   ç»“æœ: æœªçŸ¥çŠ¶æ€"
          fi
          
          echo "========================================"

  aggregate-and-push:
    needs: 
      - setup
      - build-matrix
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç 
        run: |
          echo "=== æ‹‰å–æœ€æ–°ä»£ç  ==="
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git config pull.rebase true
          git pull origin main || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­..."

      - name: ğŸ“Š è¯¦ç»†æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶
        id: check-compilers
        run: |
          echo "=== è¯¦ç»†æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ ==="
          COMPILER_DIR="${{ github.workspace }}/firmware-config/build-Compiler-file"
          
          echo "æ£€æŸ¥ç›®å½•: $COMPILER_DIR"
          mkdir -p "$COMPILER_DIR" 2>/dev/null || true
          ls -la "$COMPILER_DIR" 2>/dev/null || echo "ç›®å½•æ— æ³•è®¿é—®"
          
          # é€’å½’æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶
          if [ -d "$COMPILER_DIR" ]; then
            echo "é€’å½’æŸ¥æ‰¾æ–‡ä»¶:"
            find "$COMPILER_DIR" -type f 2>/dev/null | head -20 || echo "æ— æ–‡ä»¶"
            FILE_COUNT=$(find "$COMPILER_DIR" -type f 2>/dev/null | wc -l)
            echo "ç¼–è¯‘å™¨æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          else
            echo "âš ï¸ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œå·²åˆ›å»º"
            FILE_COUNT=0
          fi
          
          if [ $FILE_COUNT -eq 0 ]; then
            echo "âš ï¸ ç¼–è¯‘å™¨ç›®å½•ä¸ºç©º"
            echo "HAS_COMPILERS=false" >> $GITHUB_ENV
          else
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶"
            echo "HAS_COMPILERS=true" >> $GITHUB_ENV
          fi

      - name: ğŸ“¤ å¼ºåˆ¶æ¨é€ç¼–è¯‘å™¨æ–‡ä»¶
        if: always()
        run: |
          echo "=== å¼ºåˆ¶æ¨é€ç¼–è¯‘å™¨æ–‡ä»¶ ==="
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p "${{ github.workspace }}/firmware-config/build-Compiler-file"
          
          # æ˜¾ç¤ºè¦æ¨é€çš„å†…å®¹
          echo "è¦æ¨é€çš„æ–‡ä»¶ç»“æ„:"
          find "${{ github.workspace }}/firmware-config/build-Compiler-file" -type f 2>/dev/null | head -20 || echo "æ— æ–‡ä»¶"
          echo ""
          echo "ç›®å½•ç»“æ„:"
          ls -la "${{ github.workspace }}/firmware-config/build-Compiler-file" 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add -f "firmware-config/build-Compiler-file"
          
          # æ£€æŸ¥çŠ¶æ€
          echo "GitçŠ¶æ€:"
          CHANGES=$(git status --porcelain | wc -l)
          echo "å˜æ›´æ–‡ä»¶æ•°: $CHANGES"
          git status --porcelain | head -20 || echo "æ— å˜æ›´"
          
          if [ "$CHANGES" -eq 0 ]; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œåˆ›å»ºç©ºæäº¤..."
            git commit --allow-empty -m "build(compiler): äº¤å‰ç¼–è¯‘å™¨æ„å»ºå®Œæˆ" \
              -m "OpenWrt: ${{ needs.setup.outputs.openwrt_version }}" \
              -m "æ¶æ„ç±»å‹: ${{ github.event.inputs.arch_type }}" \
              -m "æ„å»ºæ—¶é—´: $(date)" \
              -m "çŠ¶æ€: æ— æ–°ç¼–è¯‘å™¨æ–‡ä»¶"
          else
            echo "æœ‰ $CHANGES ä¸ªæ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
            DETAILS=""
            RESULT_DIR="${{ github.workspace }}/.job-results"
            if [ -d "$RESULT_DIR" ]; then
              for result_file in "$RESULT_DIR"/*.json; do
                if [ -f "$result_file" ]; then
                  ARCH_TITLE=$(jq -r '.arch_title' "$result_file" 2>/dev/null || echo "")
                  STATUS_ICON=$(jq -r '.status_icon' "$result_file" 2>/dev/null || echo "")
                  COMPILER_NAME=$(jq -r '.compiler_name' "$result_file" 2>/dev/null || echo "")
                  DETAILS="${DETAILS}$STATUS_ICON $ARCH_TITLE: $COMPILER_NAME\n"
                fi
              done
            fi
            
            git commit -m "build(compiler): æ·»åŠ /æ›´æ–°äº¤å‰ç¼–è¯‘å™¨" \
              -m "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}" \
              -m "æ¶æ„ç±»å‹: ${{ github.event.inputs.arch_type }}" \
              -m "æ„å»ºæ—¶é—´: $(date)" \
              -m "æ„å»ºç»“æœ:" \
              -m "$DETAILS"
          fi
          
          echo "å¼ºåˆ¶æ¨é€æ›´æ”¹..."
          git push origin main --force-with-lease
          echo "âœ… æ¨é€å®Œæˆ"

      - name: ğŸ“ ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
        if: always()
        run: |
          echo "========================================"
          echo "           ğŸ¯ æ„å»ºä»»åŠ¡æœ€ç»ˆæ€»ç»“          "
          echo "========================================"
          echo "ğŸ“… ä»»åŠ¡ä¿¡æ¯:"
          echo "- OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "- æ¶æ„ç±»å‹: ${{ github.event.inputs.arch_type }}"
          echo "- å¼€å§‹æ—¶é—´: ${{ needs.setup.outputs.start_time }}"
          echo "- ç»“æŸæ—¶é—´: $(date)"
          
          DURATION=$(( ($(date +%s) - $(date -d "${{ needs.setup.outputs.start_time }}" +%s)) / 60 ))
          echo "- æ„å»ºæ—¶é•¿: ${DURATION}åˆ†é’Ÿ"
          echo ""
          
          echo "ğŸ“Š æ„å»ºç»“æœ:"
          
          RESULT_DIR="${{ github.workspace }}/.job-results"
          if [ -d "$RESULT_DIR" ]; then
            SUCCESS_COUNT=0
            SKIP_COUNT=0
            FAIL_COUNT=0
            
            for result_file in "$RESULT_DIR"/*.json; do
              if [ -f "$result_file" ]; then
                ARCH_TITLE=$(jq -r '.arch_title' "$result_file" 2>/dev/null || echo "")
                STATUS_ICON=$(jq -r '.status_icon' "$result_file" 2>/dev/null || echo "")
                
                case "$STATUS_ICON" in
                  "âœ…") 
                    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                    echo "âœ… $ARCH_TITLE: æˆåŠŸ"
                    ;;
                  "â­ï¸") 
                    SKIP_COUNT=$((SKIP_COUNT + 1))
                    echo "â­ï¸ $ARCH_TITLE: è·³è¿‡"
                    ;;
                  "âŒ") 
                    FAIL_COUNT=$((FAIL_COUNT + 1))
                    echo "âŒ $ARCH_TITLE: å¤±è´¥"
                    ;;
                esac
              fi
            done
            
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚          æ„å»ºç»Ÿè®¡            â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            printf "â”‚ æ€»ä»»åŠ¡æ•°: %-16s â”‚\n" "$((SUCCESS_COUNT + SKIP_COUNT + FAIL_COUNT))"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            printf "â”‚ âœ… æˆåŠŸ: %-17s â”‚\n" "$SUCCESS_COUNT"
            printf "â”‚ â­ï¸ è·³è¿‡: %-17s â”‚\n" "$SKIP_COUNT"
            printf "â”‚ âŒ å¤±è´¥: %-17s â”‚\n" "$FAIL_COUNT"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ„å»ºç»“æœæ–‡ä»¶"
          fi
          
          echo ""
          echo "ğŸ”§ ç‰ˆæœ¬ä¿¡æ¯:"
          echo "- Binutils: ${{ needs.setup.outputs.binutils_version }}"
          echo "- Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "- Musl: ${{ needs.setup.outputs.musl_version }}"
          
          echo "========================================"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "$RESULT_DIR" 2>/dev/null || true
          echo "ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
