# .github/workflows/compiler-matrix-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨çŸ©é˜µæ„å»º

on:
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'ç›®æ ‡æ¶æ„'
        required: true
        default: 'aarch64'
        type: choice
        options:
          - aarch64
          - x86_64
          - mips
          - mipsel
          - arm_cortex-a7
          - arm_cortex-a53
          - riscv64
      libc:
        description: 'Cåº“ç±»å‹'
        required: true
        default: 'musl'
        type: choice
        options:
          - musl
          - glibc
      gcc_version:
        description: 'GCCç‰ˆæœ¬ (auto=è‡ªåŠ¨æ£€æµ‹æœ€æ–°)'
        required: true
        default: 'auto'
        type: string
      clean_build:
        description: 'æ¸…ç†ä¹‹å‰çš„æ„å»ºç¼“å­˜'
        required: true
        default: false
        type: boolean
      upload_release:
        description: 'åˆ›å»ºGitHub Release'
        required: true
        default: false
        type: boolean

  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ„å»º

env:
  OPENWRT_VERSION: "23.05.2"
  COMPILER_BASE_DIR: "${{ github.workspace }}/compilers"

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      glibc_version: ${{ steps.version-detection.outputs.glibc_version }}
      arch_config: ${{ steps.arch-config.outputs.config }}
    steps:
      - name: ğŸ—ï¸ åˆå§‹åŒ–
        run: |
          echo "=== äº¤å‰ç¼–è¯‘å™¨æ„å»ºç³»ç»Ÿ ==="
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "æ—¶é—´: $(date)"
          echo ""
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          
          # ä¿å­˜è¿è¡Œä¿¡æ¯
          echo "RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
          echo "RUN_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
          echo "RUN_ATTEMPT=${{ github.run_attempt }}" >> $GITHUB_ENV

      - name: ğŸ” ç‰ˆæœ¬æ£€æµ‹
        id: version-detection
        run: |
          echo "=== æ£€æµ‹æœ€æ–°å·¥å…·é“¾ç‰ˆæœ¬ ==="
          
          # è®¾ç½®é»˜è®¤å€¼
          GCC_VERSION="12.3.0"
          BINUTILS_VERSION="2.40"
          LINUX_VERSION="5.15.133"
          MUSL_VERSION="1.2.4"
          GLIBC_VERSION="2.37"
          
          # å¦‚æœç”¨æˆ·æŒ‡å®šäº†autoï¼Œå°è¯•æ£€æµ‹æœ€æ–°ç‰ˆæœ¬
          if [ "${{ github.event.inputs.gcc_version }}" = "auto" ] || [ "${{ github.event.inputs.gcc_version }}" = "" ]; then
            echo "ä½¿ç”¨é¢„å®šä¹‰çš„GCCç‰ˆæœ¬: $GCC_VERSION"
          else
            GCC_VERSION="${{ github.event.inputs.gcc_version }}"
            echo "ä½¿ç”¨æŒ‡å®šçš„GCCç‰ˆæœ¬: $GCC_VERSION"
          fi
          
          echo "GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "Linuxå†…æ ¸ç‰ˆæœ¬: $LINUX_VERSION"
          echo "Muslç‰ˆæœ¬: $MUSL_VERSION"
          echo "Glibcç‰ˆæœ¬: $GLIBC_VERSION"
          
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT

      - name: âš™ï¸ æ¶æ„é…ç½®
        id: arch-config
        run: |
          echo "=== æ¶æ„é…ç½®ç”Ÿæˆ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          
          case "$ARCH" in
            aarch64)
              CONFIG=$(cat <<EOF
{
  "target": "armvirt",
  "subtarget": "64",
  "arch": "aarch64",
  "prefix": "aarch64-openwrt-linux",
  "cpu_type": "cortex-a53",
  "tune": "cortex-a53",
  "abi": "lp64",
  "float_abi": ""
}
EOF
              )
              ;;
            x86_64)
              CONFIG=$(cat <<EOF
{
  "target": "x86",
  "subtarget": "64",
  "arch": "x86_64",
  "prefix": "x86_64-openwrt-linux",
  "cpu_type": "x86_64",
  "tune": "generic",
  "abi": "64",
  "float_abi": ""
}
EOF
              )
              ;;
            mips)
              CONFIG=$(cat <<EOF
{
  "target": "ramips",
  "subtarget": "mt7621",
  "arch": "mips",
  "prefix": "mips-openwrt-linux",
  "cpu_type": "24kc",
  "tune": "24kc",
  "abi": "32",
  "float_abi": "softfloat"
}
EOF
              )
              ;;
            mipsel)
              CONFIG=$(cat <<EOF
{
  "target": "ramips",
  "subtarget": "mt7621",
  "arch": "mipsel",
  "prefix": "mipsel-openwrt-linux",
  "cpu_type": "24kc",
  "tune": "24kc",
  "abi": "32",
  "float_abi": "softfloat"
}
EOF
              )
              ;;
            arm_cortex-a7)
              CONFIG=$(cat <<EOF
{
  "target": "sunxi",
  "subtarget": "cortexa7",
  "arch": "arm",
  "prefix": "arm-openwrt-linux",
  "cpu_type": "cortex-a7",
  "tune": "cortex-a7",
  "abi": "eabi",
  "float_abi": "hard"
}
EOF
              )
              ;;
            arm_cortex-a53)
              CONFIG=$(cat <<EOF
{
  "target": "rockchip",
  "subtarget": "armv8",
  "arch": "aarch64",
  "prefix": "aarch64-openwrt-linux",
  "cpu_type": "cortex-a53",
  "tune": "cortex-a53",
  "abi": "lp64",
  "float_abi": ""
}
EOF
              )
              ;;
            riscv64)
              CONFIG=$(cat <<EOF
{
  "target": "virt",
  "subtarget": "rv64",
  "arch": "riscv64",
  "prefix": "riscv64-openwrt-linux",
  "cpu_type": "generic",
  "tune": "generic",
  "abi": "lp64d",
  "float_abi": "hard"
}
EOF
              )
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
              exit 1
              ;;
          esac
          
          echo "æ¶æ„é…ç½®:"
          echo "$CONFIG" | jq .
          echo "config=$CONFIG" >> $GITHUB_OUTPUT

  build-compiler:
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ—ï¸ è®¾ç½®ç¯å¢ƒ
        run: |
          echo "=== è®¾ç½®æ„å»ºç¯å¢ƒ ==="
          
          # è§£ææ¶æ„é…ç½®
          ARCH_CONFIG='${{ needs.setup.outputs.arch_config }}'
          TARGET=$(echo "$ARCH_CONFIG" | jq -r '.target')
          SUBTARGET=$(echo "$ARCH_CONFIG" | jq -r '.subtarget')
          ARCH=$(echo "$ARCH_CONFIG" | jq -r '.arch')
          PREFIX=$(echo "$ARCH_CONFIG" | jq -r '.prefix')
          CPU_TYPE=$(echo "$ARCH_CONFIG" | jq -r '.cpu_type')
          
          # æ ¹æ®Cåº“ç±»å‹è°ƒæ•´å‰ç¼€
          if [ "${{ github.event.inputs.libc }}" = "musl" ]; then
            PREFIX="${PREFIX}-musl"
            LIBC_SUFFIX="musl"
            USE_MUSL="y"
            USE_GLIBC="n"
          else
            PREFIX="${PREFIX}-gnu"
            LIBC_SUFFIX="glibc"
            USE_MUSL="n"
            USE_GLIBC="y"
          fi
          
          # è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
          GCC_VERSION='${{ needs.setup.outputs.gcc_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          LINUX_VERSION='${{ needs.setup.outputs.linux_version }}'
          
          # ç”Ÿæˆå”¯ä¸€æ„å»ºID
          BUILD_ID="${ARCH}_${LIBC_SUFFIX}_gcc-${GCC_VERSION}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="/tmp/compiler-build-${BUILD_ID}"
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH}/${LIBC_SUFFIX}/gcc-${GCC_VERSION}"
          
          echo "ç›®æ ‡æ¶æ„: $ARCH"
          echo "Cåº“ç±»å‹: ${{ github.event.inputs.libc }} ($LIBC_SUFFIX)"
          echo "ç›®æ ‡: $TARGET"
          echo "å­ç›®æ ‡: $SUBTARGET"
          echo "ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
          echo "GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "æ„å»ºç›®å½•: $BUILD_DIR"
          echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH=$ARCH" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "USE_MUSL=$USE_MUSL" >> $GITHUB_ENV
          echo "USE_GLIBC=$USE_GLIBC" >> $GITHUB_ENV
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV
          echo "LINUX_VERSION=$LINUX_VERSION" >> $GITHUB_ENV
          echo "LIBC_SUFFIX=$LIBC_SUFFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          echo "=== å®‰è£…æ„å»ºä¾èµ– ==="
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential gcc g++ make flex bison libgmp-dev libmpfr-dev \
            libmpc-dev libisl-dev python3 python3-dev git wget curl \
            zlib1g-dev liblzma-dev file gawk gettext libncurses5-dev \
            libssl-dev python3-distutils rsync unzip ncurses-term \
            ncurses-base libncursesw5 libtinfo5 terminfo gnutls-bin \
            libgnutls28-dev libcurl4-gnutls-dev \
            autoconf automake autopoint libtool pkg-config texinfo \
            gperf cmake ninja-build patchutils bc bzip2 xz-utils \
            help2man libexpat-dev libgdbm-dev libreadline-dev \
            libsqlite3-dev libffi-dev lzma-dev zstd libzstd-dev \
            libelf-dev libdw-dev libcap-dev libattr1-dev libaudit-dev \
            libiberty-dev jq

      - name: ğŸ—‘ï¸ æ¸…ç†æ„å»ºç¼“å­˜
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          echo "=== æ¸…ç†æ„å»ºç¼“å­˜ ==="
          sudo rm -rf /tmp/compiler-build-* 2>/dev/null || true
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          
          echo "å…‹éš†OpenWrt ${{ env.OPENWRT_VERSION }} åˆ†æ”¯..."
          git clone --depth 1 --branch v${{ env.OPENWRT_VERSION }} \
            https://github.com/openwrt/openwrt.git . 2>&1 | tee /tmp/clone.log
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "Git cloneå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨taråŒ…..."
            wget -q --show-progress -O openwrt.tar.xz \
              https://github.com/openwrt/openwrt/archive/refs/tags/v${{ env.OPENWRT_VERSION }}.tar.gz
            tar -xzf openwrt.tar.xz --strip-components=1
            rm -f openwrt.tar.xz
            echo "âœ… ä½¿ç”¨taråŒ…ä¸‹è½½æˆåŠŸ"
          fi
          
          echo "æºç ç›®å½•: $(pwd)"
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"

      - name: ğŸ“ ç”Ÿæˆé…ç½®æ–‡ä»¶
        run: |
          echo "=== ç”ŸæˆOpenWrté…ç½® ==="
          cd "${{ env.BUILD_DIR }}"
          
          # åˆ›å»ºsiteé…ç½®ç›®å½•
          mkdir -p include/site
          
          # æ ¹æ®æ¶æ„åˆ›å»ºsiteé…ç½®
          cat > include/site/${{ env.ARCH }} << 'EOF'
ac_cv_sys_file_offset_bits=64
ac_cv_sys_large_files=yes
ac_cv_c_bigendian=no
ac_cv_func_malloc_0_nonnull=yes
ac_cv_func_realloc_0_nonnull=yes
EOF
          
          # åˆ›å»ºåŸºç¡€é…ç½®
          cat > .config << EOF
CONFIG_TARGET_${{ env.TARGET }}=y
CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y
CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_Default=y
CONFIG_TARGET_SUBTARGET="${{ env.SUBTARGET }}"
CONFIG_TARGET_ARCH="${{ env.ARCH }}"
CONFIG_ARCH="${{ env.ARCH }}"
CONFIG_TARGET_PREFIX="${{ env.PREFIX }}-"
CONFIG_TARGET_OPTIMIZATION="-Os -pipe"
CONFIG_CPU_TYPE="${{ env.CPU_TYPE }}"

# å·¥å…·é“¾é…ç½®
CONFIG_EXTERNAL_TOOLCHAIN=n
CONFIG_USE_MUSL=${{ env.USE_MUSL }}
CONFIG_USE_GLIBC=${{ env.USE_GLIBC }}
CONFIG_BUILD_TOOLCHAIN=y
CONFIG_TOOLCHAIN_BUILD=y
CONFIG_TOOLCHAINOPTS=y

# ç‰ˆæœ¬é…ç½®
CONFIG_GCC_VERSION="${{ env.GCC_VERSION }}"
CONFIG_BINUTILS_VERSION="${{ env.BINUTILS_VERSION }}"
CONFIG_LINUX_VERSION="${{ env.LINUX_VERSION }}"
EOF
          
          # æ ¹æ®Cåº“ç±»å‹æ·»åŠ é…ç½®
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            MUSL_VERSION='${{ needs.setup.outputs.musl_version }}'
            echo "CONFIG_MUSL_VERSION=\"$MUSL_VERSION\"" >> .config
          else
            GLIBC_VERSION='${{ needs.setup.outputs.glibc_version }}'
            echo "CONFIG_GLIBC_VERSION=\"$GLIBC_VERSION\"" >> .config
          fi
          
          # ä¼˜åŒ–é…ç½®
          cat >> .config << 'EOF'

# åªæ„å»ºå·¥å…·é“¾ï¼Œä¸æ„å»ºåŒ…
CONFIG_ALL=n
CONFIG_ALL_KMODS=n
CONFIG_ALL_NONSHARED=n
CONFIG_BUILD_PACKAGES=n

# å…³é—­æ‰€æœ‰é»˜è®¤åŒ…
CONFIG_PACKAGE_busybox=n
CONFIG_PACKAGE_dnsmasq=n
CONFIG_PACKAGE_firewall=n
CONFIG_PACKAGE_dropbear=n
CONFIG_PACKAGE_iptables=n
CONFIG_PACKAGE_kmod=n

# å¼€å‘é€‰é¡¹
CONFIG_DEVEL=y
CONFIG_CCACHE=n
CONFIG_SIGNED_PACKAGES=n
CONFIG_STRIP_ARGS="--strip-all"

# ç›®æ ‡ç³»ç»Ÿé…ç½®
CONFIG_TARGET_ROOTFS_INITRAMFS=y
CONFIG_TARGET_ROOTFS_CPIOGZ=y
CONFIG_TARGET_ROOTFS_TARGZ=n
CONFIG_TARGET_ROOTFS_SQUASHFS=n

# ä¼˜åŒ–é€‰é¡¹
CONFIG_GCC_DEFAULT_PIE=n
CONFIG_GCC_DEFAULT_SSP=n
CONFIG_GCC_DEFAULT_RELAX=n
CONFIG_SJLJ_EXCEPTIONS=n
CONFIG_USE_MKLIBS=n
CONFIG_USE_LIBSTDCXX=n
CONFIG_STRIP_KERNEL_EXPORTS=n
CONFIG_USE_UCLIBC=n

# å†…æ ¸é…ç½®
CONFIG_KERNEL_KALLSYMS=n
CONFIG_KERNEL_DEBUG_KERNEL=n
CONFIG_KERNEL_DEBUG_INFO=n
CONFIG_KERNEL_PERF_EVENTS=n
CONFIG_KERNEL_PROFILING=n
EOF
          
          echo "é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
          echo "é…ç½®è¡Œæ•°: $(wc -l < .config)"
          echo "é…ç½®æ‘˜è¦:"
          grep -E "CONFIG_TARGET|CONFIG_ARCH|CONFIG_GCC|CONFIG_USE_" .config

      - name: ğŸ”¨ ç¼–è¯‘å·¥å…·é“¾
        timeout-minutes: 150
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å·¥å…·é“¾ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          export TERMINFO=/usr/share/terminfo
          
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
          echo "å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          
          # 1. åº”ç”¨é…ç½®
          echo "æ­¥éª¤1: åº”ç”¨é…ç½®..."
          make defconfig 2>&1 | tee /tmp/defconfig.log
          
          # 2. ä¸‹è½½æºç 
          echo "æ­¥éª¤2: ä¸‹è½½æºç åŒ…..."
          mkdir -p dl
          make -j1 download V=s 2>&1 | tee /tmp/download.log
          
          # æ£€æŸ¥å…³é”®åŒ…
          echo "æ£€æŸ¥å…³é”®åŒ…:"
          for pkg in gcc binutils linux; do
            if ls dl/${pkg}-*.tar.* 2>/dev/null | grep -q .; then
              echo "  âœ… $pkg"
            else
              echo "  âŒ $pkg: æœªæ‰¾åˆ°"
            fi
          done
          
          # 3. ç¼–è¯‘binutils
          echo "æ­¥éª¤3: ç¼–è¯‘binutils..."
          make toolchain/binutils/compile -j$(nproc) V=s 2>&1 | tee /tmp/binutils.log
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ binutilsç¼–è¯‘å¤±è´¥"
            grep -E "Error:|error:|failed:" /tmp/binutils.log | tail -20
            exit 1
          fi
          
          # 4. ç¼–è¯‘gccåˆå§‹é˜¶æ®µ
          echo "æ­¥éª¤4: ç¼–è¯‘gccåˆå§‹é˜¶æ®µ..."
          make toolchain/gcc/initial/compile -j$(nproc) V=s 2>&1 | tee /tmp/gcc-initial.log
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ gccåˆå§‹é˜¶æ®µç¼–è¯‘å¤±è´¥"
            grep -E "Error:|error:|failed:" /tmp/gcc-initial.log | tail -20
            exit 1
          fi
          
          # 5. ç¼–è¯‘Cåº“
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "æ­¥éª¤5: ç¼–è¯‘musl Cåº“..."
            make toolchain/musl/compile -j$(nproc) V=s 2>&1 | tee /tmp/musl.log
          else
            echo "æ­¥éª¤5: ç¼–è¯‘glibc Cåº“..."
            make toolchain/glibc/compile -j$(nproc) V=s 2>&1 | tee /tmp/glibc.log
          fi
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ Cåº“ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
          
          # 6. ç¼–è¯‘å®Œæ•´gcc
          echo "æ­¥éª¤6: ç¼–è¯‘å®Œæ•´gcc..."
          make toolchain/gcc/final/compile -j$(nproc) V=s 2>&1 | tee /tmp/gcc-final.log
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ gccæœ€ç»ˆç¼–è¯‘å¤±è´¥"
            grep -E "Error:|error:|failed:" /tmp/gcc-final.log | tail -20
            exit 1
          fi
          
          # 7. å®‰è£…å·¥å…·é“¾
          echo "æ­¥éª¤7: å®‰è£…å·¥å…·é“¾..."
          make toolchain/install -j$(nproc) V=s 2>&1 | tee /tmp/install.log
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âš ï¸ å®‰è£…è¿‡ç¨‹æœ‰è­¦å‘Šï¼Œç»§ç»­..."
          fi
          
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"
          echo "æ„å»ºç›®å½•å¤§å°: $(du -sh . | cut -f1)"

      - name: âœ… éªŒè¯ç¼–è¯‘ç»“æœ
        run: |
          echo "=== éªŒè¯ç¼–è¯‘ç»“æœ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # æŸ¥æ‰¾å·¥å…·é“¾ç›®å½•
          TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -type d -name "toolchain-*" | head -1)
          
          if [ -z "$TOOLCHAIN_DIR" ] || [ ! -d "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            echo "staging_dirå†…å®¹:"
            ls -la staging_dir/ 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          echo "ç›®å½•å¤§å°: $(du -sh "$TOOLCHAIN_DIR" | cut -f1)"
          
          # æŸ¥æ‰¾ç¼–è¯‘å™¨
          COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" | head -1)
          
          if [ -z "$COMPILER_PATH" ] || [ ! -x "$COMPILER_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œçš„ç¼–è¯‘å™¨"
            echo "binç›®å½•å†…å®¹:"
            ls -la "$TOOLCHAIN_DIR/bin/" 2>/dev/null | head -20
            exit 1
          fi
          
          COMPILER_NAME=$(basename "$COMPILER_PATH")
          echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $COMPILER_NAME"
          
          # éªŒè¯ç¼–è¯‘å™¨
          echo "ç¼–è¯‘å™¨ä¿¡æ¯:"
          "$COMPILER_PATH" --version 2>&1 | head -3
          
          # æµ‹è¯•ç¼–è¯‘
          echo "æµ‹è¯•äº¤å‰ç¼–è¯‘..."
          cat > test.c << 'EOF'
#include <stdio.h>
#include <stdlib.h>

int main() {
    printf("Cross-compiler test successful!\n");
    printf("Architecture: ${{ env.ARCH }}\n");
    printf("C Library: ${{ env.LIBC_SUFFIX }}\n");
    printf("GCC Version: ${{ env.GCC_VERSION }}\n");
    return 0;
}
EOF
          
          "$COMPILER_PATH" test.c -o test_program 2>&1 | tee /tmp/compile-test.log
          
          if [ ${PIPESTATUS[0]} -eq 0 ] && [ -f "test_program" ]; then
            echo "âœ… äº¤å‰ç¼–è¯‘æµ‹è¯•é€šè¿‡"
            echo "ç”Ÿæˆæ–‡ä»¶ä¿¡æ¯:"
            file test_program
            rm -f test.c test_program
          else
            echo "âŒ äº¤å‰ç¼–è¯‘æµ‹è¯•å¤±è´¥"
            cat /tmp/compile-test.log
            exit 1
          fi
          
          # ä¿å­˜éªŒè¯ä¿¡æ¯
          echo "VALIDATION_PASSED=true" >> $GITHUB_ENV
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV
          echo "COMPILER_NAME=$COMPILER_NAME" >> $GITHUB_ENV

      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨ ==="
          cd "${{ env.BUILD_DIR }}"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p "${{ env.OUTPUT_DIR }}"
          
          # å¤åˆ¶å·¥å…·é“¾
          echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
          rsync -av --progress "$TOOLCHAIN_DIR/" "${{ env.OUTPUT_DIR }}/" 2>&1 | tail -20
          
          # åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶
          echo "åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶..."
          cat > "${{ env.OUTPUT_DIR }}/metadata.json" << EOF
{
  "architecture": "${{ env.ARCH }}",
  "libc": "${{ env.LIBC_SUFFIX }}",
  "target": "${{ env.TARGET }}",
  "subtarget": "${{ env.SUBTARGET }}",
  "compiler_prefix": "${{ env.PREFIX }}-",
  "cpu_type": "${{ env.CPU_TYPE }}",
  "versions": {
    "gcc": "${{ env.GCC_VERSION }}",
    "binutils": "${{ env.BINUTILS_VERSION }}",
    "linux": "${{ env.LINUX_VERSION }}",
    "openwrt": "${{ env.OPENWRT_VERSION }}"
  },
  "build_info": {
    "date": "$(date -Iseconds)",
    "workflow_run": "${{ github.run_id }}",
    "workflow_number": "${{ github.run_number }}",
    "build_id": "${{ env.BUILD_ID }}"
  },
  "validation": {
    "compiler": "$COMPILER_NAME",
    "test_passed": true,
    "toolchain_size": "$(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1)",
    "file_count": "$(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)"
  }
}
EOF
          
          # åˆ›å»ºä½¿ç”¨è¯´æ˜
          cat > "${{ env.OUTPUT_DIR }}/README.md" << EOF
# ${{ env.ARCH }} ${{ env.LIBC_SUFFIX }} äº¤å‰ç¼–è¯‘å™¨

## ğŸ“‹ åŸºæœ¬ä¿¡æ¯

- **æ¶æ„**: ${{ env.ARCH }}
- **Cåº“**: ${{ env.LIBC_SUFFIX }}
- **ç›®æ ‡å¹³å°**: ${{ env.TARGET }}/${{ env.SUBTARGET }}
- **ç¼–è¯‘å™¨å‰ç¼€**: \`${{ env.PREFIX }}-\`
- **GCCç‰ˆæœ¬**: ${{ env.GCC_VERSION }}
- **æ„å»ºæ—¥æœŸ**: $(date)
- **OpenWrtç‰ˆæœ¬**: ${{ env.OPENWRT_VERSION }}

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### æ–¹æ³•1: è®¾ç½®ç¯å¢ƒå˜é‡
\`\`\`bash
export STAGING_DIR="$(pwd)"
export PATH="\$STAGING_DIR/bin:\$PATH"
\`\`\`

### æ–¹æ³•2: ç›´æ¥è°ƒç”¨
\`\`\`bash
# Cç¼–è¯‘å™¨
./bin/${{ env.PREFIX }}-gcc -o program program.c

# C++ç¼–è¯‘å™¨
./bin/${{ env.PREFIX }}-g++ -o program program.cpp

# æŸ¥çœ‹ç‰ˆæœ¬
./bin/${{ env.PREFIX }}-gcc --version
\`\`\`

### æ–¹æ³•3: åœ¨OpenWrtæ„å»ºä¸­ä½¿ç”¨
\`\`\`bash
make STAGING_DIR="$(pwd)"
\`\`\`

## ğŸ“ æ–‡ä»¶ç»“æ„

\`\`\`
./
â”œâ”€â”€ bin/                    # å·¥å…·é“¾ç¨‹åº
â”‚   â”œâ”€â”€ ${{ env.PREFIX }}-gcc          # Cç¼–è¯‘å™¨
â”‚   â”œâ”€â”€ ${{ env.PREFIX }}-g++          # C++ç¼–è¯‘å™¨
â”‚   â”œâ”€â”€ ${{ env.PREFIX }}-ld           # é“¾æ¥å™¨
â”‚   â”œâ”€â”€ ${{ env.PREFIX }}-ar           # å½’æ¡£å·¥å…·
â”‚   â””â”€â”€ ${{ env.PREFIX }}-strip        # å‰¥ç¦»å·¥å…·
â”œâ”€â”€ include/                # å¤´æ–‡ä»¶
â”œâ”€â”€ lib/                    # åº“æ–‡ä»¶
â”œâ”€â”€ libexec/                # GCCå†…éƒ¨å·¥å…·
â”œâ”€â”€ share/                  # å…±äº«æ•°æ®
â”œâ”€â”€ metadata.json          # æ„å»ºå…ƒæ•°æ®
â””â”€â”€ README.md              # æœ¬æ–‡æ¡£
\`\`\`

## ğŸ”§ å¯ç”¨å·¥å…·

| å·¥å…· | å‘½ä»¤ | ç”¨é€” |
|------|------|------|
| Cç¼–è¯‘å™¨ | \`${{ env.PREFIX }}-gcc\` | ç¼–è¯‘Cç¨‹åº |
| C++ç¼–è¯‘å™¨ | \`${{ env.PREFIX }}-g++\` | ç¼–è¯‘C++ç¨‹åº |
| é“¾æ¥å™¨ | \`${{ env.PREFIX }}-ld\` | é“¾æ¥ç›®æ ‡æ–‡ä»¶ |
| å½’æ¡£å·¥å…· | \`${{ env.PREFIX }}-ar\` | åˆ›å»ºé™æ€åº“ |
| å‰¥ç¦»å·¥å…· | \`${{ env.PREFIX }}-strip\` | å‰¥ç¦»è°ƒè¯•ä¿¡æ¯ |
| æ±‡ç¼–å™¨ | \`${{ env.PREFIX }}-as\` | æ±‡ç¼–æ±‡ç¼–ä»£ç  |
| å¯¹è±¡æ‹·è´ | \`${{ env.PREFIX }}-objcopy\` | å¤åˆ¶å¯¹è±¡æ–‡ä»¶ |
| å¯¹è±¡è½¬å‚¨ | \`${{ env.PREFIX }}-objdump\` | æ˜¾ç¤ºå¯¹è±¡ä¿¡æ¯ |

## ğŸ“Š æ„å»ºä¿¡æ¯

- **æ–‡ä»¶æ€»æ•°**: $(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)
- **ç›®å½•å¤§å°**: $(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1)
- **æ„å»ºID**: ${{ env.BUILD_ID }}
- **å·¥ä½œæµè¿è¡Œ**: #${{ github.run_id }}

## â“ å¸¸è§é—®é¢˜

### 1. å¦‚ä½•éªŒè¯ç¼–è¯‘å™¨å·¥ä½œæ­£å¸¸ï¼Ÿ
\`\`\`bash
./bin/${{ env.PREFIX }}-gcc --version
echo 'int main(){return 0;}' | ./bin/${{ env.PREFIX }}-gcc -x c -o /dev/null -
\`\`\`

### 2. ç¼–è¯‘æ—¶å‡ºç°"æ‰¾ä¸åˆ°å¤´æ–‡ä»¶"é”™è¯¯ï¼Ÿ
ç¡®ä¿è®¾ç½®äº†æ­£ç¡®çš„ç¯å¢ƒå˜é‡ï¼š
\`\`\`bash
export STAGING_DIR="$(pwd)"
\`\`\`

### 3. å¦‚ä½•åœ¨CMakeä¸­ä½¿ç”¨ï¼Ÿ
\`\`\`cmake
set(CMAKE_C_COMPILER "\${STAGING_DIR}/bin/${{ env.PREFIX }}-gcc")
set(CMAKE_CXX_COMPILER "\${STAGING_DIR}/bin/${{ env.PREFIX }}-g++")
\`\`\`

## ğŸ“„ è®¸å¯è¯

æœ¬ç¼–è¯‘å™¨åŸºäº OpenWrt é¡¹ç›®æ„å»ºï¼Œéµå¾ªç›¸åº”çš„å¼€æºè®¸å¯è¯ã€‚

---
*æœ€åæ›´æ–°: $(date)*
EOF
          
          echo "âœ… ç¼–è¯‘å™¨ä¿å­˜å®Œæˆ"
          echo "è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          echo "æ–‡ä»¶æ•°é‡: $(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)"
          echo "ç›®å½•å¤§å°: $(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1)"

      - name: ğŸ“Š æ›´æ–°ç´¢å¼•
        run: |
          echo "=== æ›´æ–°ç¼–è¯‘å™¨ç´¢å¼• ==="
          
          # åˆ›å»ºä¸»ç´¢å¼•æ–‡ä»¶
          INDEX_FILE="${{ env.COMPILER_BASE_DIR }}/INDEX.md"
          
          cat > "$INDEX_FILE" << EOF
# ğŸ“š äº¤å‰ç¼–è¯‘å™¨åº“

## ğŸ“‹ æ¦‚è§ˆ

æœ¬ä»“åº“æä¾›é¢„ç¼–è¯‘çš„ OpenWrt äº¤å‰ç¼–è¯‘å™¨ï¼Œæ”¯æŒå¤šç§æ¶æ„å’ŒCåº“ç±»å‹ã€‚

| æ¶æ„ | æè¿° | æ”¯æŒçŠ¶æ€ |
|------|------|----------|
| aarch64 | ARM 64ä½ | âœ… æ”¯æŒ |
| x86_64 | x86 64ä½ | âœ… æ”¯æŒ |
| mips | MIPS 32ä½å¤§ç«¯ | âœ… æ”¯æŒ |
| mipsel | MIPS 32ä½å°ç«¯ | âœ… æ”¯æŒ |
| arm_cortex-a7 | ARM Cortex-A7 | âœ… æ”¯æŒ |
| arm_cortex-a53 | ARM Cortex-A53 | âœ… æ”¯æŒ |
| riscv64 | RISC-V 64ä½ | âœ… æ”¯æŒ |

## ğŸ“ ç›®å½•ç»“æ„

\`\`\`
compilers/
â”œâ”€â”€ aarch64/                    # ARM64æ¶æ„
â”‚   â”œâ”€â”€ musl/                  # musl Cåº“
â”‚   â”‚   â””â”€â”€ gcc-12.3.0/       # GCC 12.3.0ç‰ˆæœ¬
â”‚   â”‚       â”œâ”€â”€ bin/          # å·¥å…·é“¾ç¨‹åº
â”‚   â”‚       â”œâ”€â”€ include/      # å¤´æ–‡ä»¶
â”‚   â”‚       â”œâ”€â”€ lib/          # åº“æ–‡ä»¶
â”‚   â”‚       â”œâ”€â”€ metadata.json # å…ƒæ•°æ®
â”‚   â”‚       â””â”€â”€ README.md     # ä½¿ç”¨è¯´æ˜
â”‚   â””â”€â”€ glibc/                 # glibc Cåº“
â”œâ”€â”€ x86_64/                    # x86_64æ¶æ„
â”œâ”€â”€ mips/                      # MIPSæ¶æ„
â”œâ”€â”€ mipsel/                    # MIPSå°ç«¯æ¶æ„
â”œâ”€â”€ arm_cortex-a7/             # ARM Cortex-A7
â”œâ”€â”€ arm_cortex-a53/            # ARM Cortex-A53
â””â”€â”€ riscv64/                   # RISC-V 64ä½
\`\`\`

## ğŸ”„ æœ€è¿‘æ„å»º

| æ¶æ„ | Cåº“ | GCCç‰ˆæœ¬ | æ„å»ºæ—¶é—´ | çŠ¶æ€ |
|------|-----|---------|----------|------|
EOF
          
          # æ‰«ææ‰€æœ‰ç¼–è¯‘å™¨å¹¶æ·»åŠ åˆ°ç´¢å¼•
          find "${{ env.COMPILER_BASE_DIR }}" -name "metadata.json" | while read meta; do
            ARCH=$(jq -r '.architecture' "$meta")
            LIBC=$(jq -r '.libc' "$meta")
            GCC_VER=$(jq -r '.versions.gcc' "$meta")
            BUILD_DATE=$(jq -r '.build_info.date' "$meta" | cut -d'T' -f1)
            COMPILER_DIR=$(dirname "$meta")
            RELATIVE_DIR="${COMPILER_DIR#${{ env.COMPILER_BASE_DIR }}/}"
            
            echo "| $ARCH | $LIBC | $GCC_VER | $BUILD_DATE | âœ… å¯ç”¨ |" >> "$INDEX_FILE"
          done
          
          cat >> "$INDEX_FILE" << 'EOF'

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. é€‰æ‹©ç¼–è¯‘å™¨
æ ¹æ®ç›®æ ‡æ¶æ„å’ŒCåº“éœ€æ±‚ï¼Œè¿›å…¥å¯¹åº”ç›®å½•ï¼š
\`\`\`bash
cd compilers/aarch64/musl/gcc-12.3.0
\`\`\`

### 2. è®¾ç½®ç¯å¢ƒ
\`\`\`bash
export STAGING_DIR="$(pwd)"
export PATH="\$STAGING_DIR/bin:\$PATH"
\`\`\`

### 3. éªŒè¯ç¼–è¯‘å™¨
\`\`\`bash
aarch64-openwrt-linux-musl-gcc --version
\`\`\`

## âš™ï¸ æ„å»ºæ–°ç¼–è¯‘å™¨

### è‡ªåŠ¨æ„å»º
æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ£€æµ‹æœ€æ–°ç‰ˆæœ¬å¹¶æ„å»ºã€‚

### æ‰‹åŠ¨æ„å»º
1. è¿›å…¥ GitHub Actions é¡µé¢
2. é€‰æ‹© **ğŸ”§ äº¤å‰ç¼–è¯‘å™¨çŸ©é˜µæ„å»º**
3. ç‚¹å‡» **Run workflow**
4. é€‰æ‹©æ¶æ„ã€Cåº“ç±»å‹å’Œç‰ˆæœ¬
5. å¼€å§‹æ„å»º

## ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯

- **æ€»ç¼–è¯‘å™¨æ•°é‡**: $(find "${{ env.COMPILER_BASE_DIR }}" -name "metadata.json" | wc -l)
- **æœ€åæ›´æ–°**: $(date)
- **å·¥ä½œæµçŠ¶æ€**: [![æ„å»ºçŠ¶æ€](https://github.com/${{ github.repository }}/actions/workflows/compiler-matrix-build.yml/badge.svg)](https://github.com/${{ github.repository }}/actions)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥ï¼š
- æ·»åŠ æ–°çš„æ¶æ„æ”¯æŒ
- æ”¹è¿›æ„å»ºè„šæœ¬
- ä¿®å¤é—®é¢˜
- æ›´æ–°æ–‡æ¡£

## ğŸ“„ è®¸å¯è¯

åŸºäº OpenWrt é¡¹ç›®æ„å»ºï¼Œéµå¾ªç›¸åº”çš„å¼€æºè®¸å¯è¯ã€‚

---
*ç´¢å¼•ç”Ÿæˆæ—¶é—´: $(date)*
EOF
          
          echo "âœ… ç´¢å¼•æ›´æ–°å®Œæˆ"
          echo "ç´¢å¼•æ–‡ä»¶: $INDEX_FILE"

      - name: ğŸ“¤ æäº¤åˆ°Gitä»“åº“
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°Gitä»“åº“ ==="
          cd "${{ github.workspace }}"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git config pull.rebase false
          
          # æ·»åŠ ç¼–è¯‘å™¨æ–‡ä»¶
          git add -f "${{ env.COMPILER_BASE_DIR }}"/*
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if ! git diff --cached --quiet; then
            echo "æ£€æµ‹åˆ°å˜æ›´ï¼Œåˆ›å»ºæäº¤..."
            
            # åˆ›å»ºæäº¤ä¿¡æ¯
            COMMIT_MSG="build(compiler): æ·»åŠ  ${{ env.ARCH }}-${{ env.LIBC_SUFFIX }} äº¤å‰ç¼–è¯‘å™¨"
            COMMIT_MSG="$COMMIT_MSG\n\næ¶æ„: ${{ env.ARCH }}"
            COMMIT_MSG="$COMMIT_MSG\nCåº“: ${{ env.LIBC_SUFFIX }}"
            COMMIT_MSG="$COMMIT_MSG\nGCC: ${{ env.GCC_VERSION }}"
            COMMIT_MSG="$COMMIT_MSG\nç›®æ ‡: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
            COMMIT_MSG="$COMMIT_MSG\nå·¥ä½œæµ: #${{ github.run_id }}"
            COMMIT_MSG="$COMMIT_MSG\næ„å»ºID: ${{ env.BUILD_ID }}"
            
            echo -e "$COMMIT_MSG" | git commit -F -
            
            # å°è¯•æ¨é€
            if git push; then
              echo "âœ… ç¼–è¯‘å™¨å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
            else
              echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå°è¯•æ‹‰å–æœ€æ–°å˜æ›´åé‡è¯•..."
              git pull origin main --no-edit
              git push
              echo "âœ… æ¨é€æˆåŠŸ"
            fi
          else
            echo "âœ… æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi

      - name: ğŸ·ï¸ åˆ›å»ºGitHub Release
        if: ${{ github.event.inputs.upload_release == 'true' && github.event_name == 'workflow_dispatch' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "compiler-${{ env.ARCH }}-${{ env.LIBC_SUFFIX }}-${{ env.GCC_VERSION }}-$(date +%Y%m%d)"
          name: "${{ env.ARCH }} ${{ env.LIBC_SUFFIX }} äº¤å‰ç¼–è¯‘å™¨ v${{ env.GCC_VERSION }}"
          body: |
            ## ğŸ—ï¸ ç¼–è¯‘å™¨ä¿¡æ¯
            
            ### åŸºæœ¬ä¿¡æ¯
            - **æ¶æ„**: ${{ env.ARCH }}
            - **Cåº“**: ${{ env.LIBC_SUFFIX }}
            - **GCCç‰ˆæœ¬**: ${{ env.GCC_VERSION }}
            - **Binutilsç‰ˆæœ¬**: ${{ env.BINUTILS_VERSION }}
            - **Linuxå†…æ ¸ç‰ˆæœ¬**: ${{ env.LINUX_VERSION }}
            - **OpenWrtç‰ˆæœ¬**: ${{ env.OPENWRT_VERSION }}
            - **æ„å»ºæ—¥æœŸ**: $(date)
            
            ### ç›®æ ‡å¹³å°
            - **ç›®æ ‡**: ${{ env.TARGET }}
            - **å­ç›®æ ‡**: ${{ env.SUBTARGET }}
            - **CPUç±»å‹**: ${{ env.CPU_TYPE }}
            - **ç¼–è¯‘å™¨å‰ç¼€**: `${{ env.PREFIX }}-`
            
            ### æ„å»ºä¿¡æ¯
            - **å·¥ä½œæµè¿è¡Œ**: #${{ github.run_id }}
            - **æ„å»ºID**: ${{ env.BUILD_ID }}
            - **æ–‡ä»¶æ•°é‡**: $(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)
            - **ç›®å½•å¤§å°**: $(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1)
            
            ## ğŸš€ å¿«é€Ÿä½¿ç”¨
            
            1. **ä¸‹è½½å¹¶è§£å‹**
            ```bash
            tar -xzf compiler-${{ env.ARCH }}-${{ env.LIBC_SUFFIX }}.tar.gz
            cd compiler-${{ env.ARCH }}-${{ env.LIBC_SUFFIX }}
            ```
            
            2. **è®¾ç½®ç¯å¢ƒå˜é‡**
            ```bash
            export STAGING_DIR="$(pwd)"
            export PATH="\$STAGING_DIR/bin:\$PATH"
            ```
            
            3. **éªŒè¯ç¼–è¯‘å™¨**
            ```bash
            ${{ env.PREFIX }}-gcc --version
            ```
            
            ## ğŸ“ åŒ…å«å†…å®¹
            
            - å®Œæ•´çš„äº¤å‰ç¼–è¯‘å·¥å…·é“¾
            - å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶
            - ä½¿ç”¨è¯´æ˜æ–‡æ¡£
            - æ„å»ºå…ƒæ•°æ®
            
            ## ğŸ”§ æ”¯æŒçš„å·¥å…·
            
            | å·¥å…· | å‘½ä»¤ |
            |------|------|
            | Cç¼–è¯‘å™¨ | `${{ env.PREFIX }}-gcc` |
            | C++ç¼–è¯‘å™¨ | `${{ env.PREFIX }}-g++` |
            | é“¾æ¥å™¨ | `${{ env.PREFIX }}-ld` |
            | å½’æ¡£å·¥å…· | `${{ env.PREFIX }}-ar` |
            | å‰¥ç¦»å·¥å…· | `${{ env.PREFIX }}-strip` |
            
            ## ğŸ“„ è¯¦ç»†æ–‡æ¡£
            
            æŸ¥çœ‹è§£å‹åçš„ `README.md` è·å–å®Œæ•´ä½¿ç”¨è¯´æ˜ã€‚
            
            ---
            *è‡ªåŠ¨æ„å»ºäº GitHub Actions*
          draft: false
          prerelease: false
          files: |
            ${{ env.OUTPUT_DIR }}/**/*

      - name: ğŸ“‹ ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        if: always()
        run: |
          echo "=== æ„å»ºæŠ¥å‘Š ==="
          echo "æ„å»ºID: ${{ env.BUILD_ID }}"
          echo "æ¶æ„: ${{ env.ARCH }}"
          echo "Cåº“: ${{ env.LIBC_SUFFIX }}"
          echo "GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "æ„å»ºç›®å½•: ${{ env.BUILD_DIR }}"
          echo "è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          
          if [ -d "${{ env.OUTPUT_DIR }}" ]; then
            echo "è¾“å‡ºæ–‡ä»¶æ•°: $(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)"
            echo "è¾“å‡ºç›®å½•å¤§å°: $(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1)"
          fi
          
          echo "æ„å»ºçŠ¶æ€: ${{ job.status }}"
          echo "æŠ¥å‘Šæ—¶é—´: $(date)"

      - name: ğŸ“„ ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.BUILD_ID }}
          path: |
            /tmp/*.log
            ${{ env.BUILD_DIR }}/.config
          retention-days: 30

  post-build:
    needs: build-compiler
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
      
      - name: ğŸ“Š æ›´æ–°çŠ¶æ€å¾½ç« 
        run: |
          echo "=== æ›´æ–°çŠ¶æ€ ==="
          echo "æ„å»ºå®Œæˆæ—¶é—´: $(date)"
          echo "å·¥ä½œæµçŠ¶æ€: ${{ needs.build-compiler.result }}"
          
          # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ çŠ¶æ€å¾½ç« æ›´æ–°é€»è¾‘
          # ä¾‹å¦‚æ›´æ–°READMEä¸­çš„æ„å»ºçŠ¶æ€

      - name: ğŸ“§ å‘é€é€šçŸ¥
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "æ„å»ºå®Œæˆé€šçŸ¥"
          echo "å·¥ä½œæµ: ${{ github.workflow }}"
          echo "è¿è¡ŒID: #${{ github.run_id }}"
          echo "çŠ¶æ€: ${{ needs.build-compiler.result }}"
          echo "æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
