name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'ç›®æ ‡æ¶æ„ï¼ˆIPQ40xxé€‰æ‹©arm_cortex-a7ï¼‰'
        required: true
        default: 'arm_cortex-a7'
        type: choice
        options: ['aarch64', 'x86_64', 'mips', 'mipsel', 'arm_cortex-a7', 'arm_cortex-a53', 'riscv64']
      libc:
        description: 'Cåº“ç±»å‹ï¼ˆåµŒå…¥å¼æ¨èmuslï¼‰'
        required: true
        default: 'musl'
        type: choice
        options: ['musl', 'glibc']
      gcc_version:
        description: 'GCCç‰ˆæœ¬ï¼ˆè¾“å…¥ç‰ˆæœ¬å·å¦‚12.3.0ï¼Œæˆ–autoè‡ªåŠ¨æ£€æµ‹ï¼‰'
        required: true
        default: 'auto'
        type: string
      clean_build:
        description: 'æ¸…ç†ä¹‹å‰çš„æ„å»ºç¼“å­˜'
        required: true
        default: false
        type: boolean
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºï¼ˆå³ä½¿å·²å­˜åœ¨ï¼‰'
        required: true
        default: false
        type: boolean

env:
  OPENWRT_VERSION: "23.05.2"
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers"

jobs:
  show-device-info:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“± æ˜¾ç¤ºæ¶æ„å¯¹åº”è®¾å¤‡
        run: |
          echo "================================================"
          echo "          ğŸ¯ ç›®æ ‡æ¶æ„è®¾å¤‡å¯¹åº”è¡¨                 "
          echo "================================================"
          echo ""
          echo "1ï¸âƒ£ aarch64 (ARM 64ä½)"
          echo "   â”œâ”€ ğŸ“± æ ‘è“æ´¾ç³»åˆ—"
          echo "   â”‚  â”œâ”€ æ ‘è“æ´¾ 4B (Raspberry Pi 4)"
          echo "   â”‚  â”œâ”€ æ ‘è“æ´¾ CM4 (Compute Module 4)"
          echo "   â”‚  â””â”€ æ ‘è“æ´¾ 400"
          echo "   â”œâ”€ ğŸ–¥ï¸ ç‘èŠ¯å¾®ç³»åˆ—"
          echo "   â”‚  â”œâ”€ RK3399 (ROCK Pi 4/NanoPi M4)"
          echo "   â”‚  â”œâ”€ RK3568 (FriendlyELEC NanoPi R5S)"
          echo "   â”‚  â””â”€ RK3588 (é«˜ç«¯å¼€å‘æ¿)"
          echo "   â”œâ”€ ğŸ“º ç”µè§†ç›’å­"
          echo "   â”‚  â”œâ”€ æ™¶æ™¨ S905 (X96 Max/Beelink GT King)"
          echo "   â”‚  â”œâ”€ æ™¶æ™¨ S912 (H96 Pro/Beelink GT1)"
          echo "   â”‚  â””â”€ æ™¶æ™¨ S922X (Odroid N2+)"
          echo "   â””â”€ ğŸ–¥ï¸ å…¶ä»–ARM64è®¾å¤‡"
          echo "      â”œâ”€ Orange Pi 5"
          echo "      â”œâ”€ Banana Pi BPI-M5"
          echo "      â””â”€ å„ç§ARMæœåŠ¡å™¨"
          echo ""
          echo "2ï¸âƒ£ x86_64 (x86 64ä½)"
          echo "   â”œâ”€ ğŸ’» ä¸ªäººç”µè„‘"
          echo "   â”‚  â”œâ”€ Intel Core i3/i5/i7/i9"
          echo "   â”‚  â”œâ”€ AMD Ryzen 3/5/7/9"
          echo "   â”‚  â””â”€ å„ç§x86ç¬”è®°æœ¬"
          echo "   â”œâ”€ ğŸ–¥ï¸ æœåŠ¡å™¨"
          echo "   â”‚  â”œâ”€ æˆ´å°”PowerEdge"
          echo "   â”‚  â”œâ”€ æƒ æ™®ProLiant"
          echo "   â”‚  â””â”€ è¶…å¾®æœåŠ¡å™¨"
          echo "   â””â”€ â˜ï¸ è™šæ‹Ÿæœº/å®¹å™¨"
          echo "      â”œâ”€ VMware/VirtualBoxè™šæ‹Ÿæœº"
          echo "      â”œâ”€ Dockerå®¹å™¨"
          echo "      â””â”€ äº‘æœåŠ¡å™¨å®ä¾‹"
          echo ""
          echo "3ï¸âƒ£ mips (MIPS 32ä½å¤§ç«¯)"
          echo "   â”œâ”€ ğŸ›œ åç¡•è·¯ç”±å™¨"
          echo "   â”‚  â”œâ”€ RT-ACRH17"
          echo "   â”‚  â”œâ”€ RT-AC85P"
          echo "   â”‚  â””â”€ RT-N56U"
          echo "   â”œâ”€ ğŸ›œ ç½‘ä»¶è·¯ç”±å™¨"
          echo "   â”‚  â”œâ”€ R7800"
          echo "   â”‚  â”œâ”€ R9000"
          echo "   â”‚  â””â”€ XR500"
          echo "   â””â”€ ğŸ›œ å…¶ä»–MIPSè®¾å¤‡"
          echo "      â”œâ”€ ä¸­å…´è·¯ç”±å™¨"
          echo "      â”œâ”€ åä¸ºæ—§æ¬¾è·¯ç”±å™¨"
          echo "      â””â”€ æ—©æœŸæ™ºèƒ½å®¶å±…è®¾å¤‡"
          echo ""
          echo "4ï¸âƒ£ mipsel (MIPS 32ä½å°ç«¯)"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7621"
          echo "   â”‚  â”œâ”€ æ–è®¯ K2P (Phicomm K2P)"
          echo "   â”‚  â”œâ”€ Newifi 3 (æ–°è·¯ç”±3)"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 3G"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AC2100"
          echo "   â”‚  â””â”€ æè·¯ç”± B70"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7620"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ Mini"
          echo "   â”‚  â”œâ”€ æè·¯ç”± 1S"
          echo "   â”‚  â”œâ”€ æ–è®¯ K1/K2"
          echo "   â”‚  â””â”€ è”æƒ³ Newifi Mini"
          echo "   â””â”€ ğŸ›œ å…¶ä»–MTKè®¾å¤‡"
          echo "      â”œâ”€ MT7628 (ä½ç«¯è·¯ç”±)"
          echo "      â”œâ”€ MT7688 (ç‰©è”ç½‘è®¾å¤‡)"
          echo "      â””â”€ å„ç§WiFiæ¨¡å—"
          echo ""
          echo "5ï¸âƒ£ arm_cortex-a7 (ARM Cortex-A7)"
          echo "   â”œâ”€ ğŸ›œ é«˜é€šIPQ40xxç³»åˆ— (ä½ çš„è®¾å¤‡ï¼)"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 4Aåƒå…†ç‰ˆ"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AC2100 (éƒ¨åˆ†ç‰ˆæœ¬)"
          echo "   â”‚  â”œâ”€ GL.iNet MT1300"
          echo "   â”‚  â”œâ”€ 360å®¶åº­é˜²ç«å¢™ 5Pro"
          echo "   â”‚  â”œâ”€ Linksys EA6350 v3"
          echo "   â”‚  â”œâ”€ Netgear R6900P"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7623/MT7629"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 3G (éƒ¨åˆ†ç‰ˆæœ¬)"
          echo "   â”‚  â”œâ”€ æ–è®¯ K3C"
          echo "   â”‚  â””â”€ éƒ¨åˆ†ä¼ä¸šè·¯ç”±å™¨"
          echo "   â”œâ”€ ğŸŠ å…¨å¿—H3/H2+ç³»åˆ—"
          echo "   â”‚  â”œâ”€ Orange Pi PC (é¦™æ©™æ´¾PC)"
          echo "   â”‚  â”œâ”€ Orange Pi Plus"
          echo "   â”‚  â”œâ”€ Banana Pi M2+"
          echo "   â”‚  â””â”€ NanoPi NEO"
          echo "   â””â”€ ğŸ”§ å…¶ä»–Cortex-A7è®¾å¤‡"
          echo "      â”œâ”€ æŸäº›æ™ºèƒ½æ‘„åƒå¤´"
          echo "      â”œâ”€ å·¥ä¸šæ§åˆ¶è®¾å¤‡"
          echo "      â””â”€ ä½åŠŸè€—åµŒå…¥å¼è®¾å¤‡"
          echo ""
          echo "6ï¸âƒ£ arm_cortex-a53 (ARM Cortex-A53)"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7622"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ AX3600"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AX6"
          echo "   â”‚  â””â”€ éƒ¨åˆ†WiFi6è·¯ç”±å™¨"
          echo "   â”œâ”€ ğŸ“± 64ä½è®¾å¤‡32ä½æ¨¡å¼"
          echo "   â”‚  â”œâ”€ æ ‘è“æ´¾ 3 (32ä½æ¨¡å¼)"
          echo "   â”‚  â”œâ”€ æŸäº›ç”µè§†ç›’å­"
          echo "   â”‚  â””â”€ ä½ç«¯å¹³æ¿ç”µè„‘"
          echo "   â””â”€ ğŸ”§ å…¶ä»–A53è®¾å¤‡"
          echo "      â”œâ”€ æŸäº›æ™ºèƒ½éŸ³ç®±"
          echo "      â”œâ”€ ç‰©è”ç½‘ç½‘å…³"
          echo "      â”œâ”€ è¾¹ç¼˜è®¡ç®—è®¾å¤‡"
          echo ""
          echo "7ï¸âƒ£ riscv64 (RISC-V 64ä½)"
          echo "   â”œâ”€ ğŸ”¬ å¼€å‘æ¿"
          echo "   â”‚  â”œâ”€ HiFive Unmatched"
          echo "   â”‚  â”œâ”€ VisionFive 2"
          echo "   â”‚  â”œâ”€ BeagleV"
          echo "   â”‚  â””â”€ SiFiveå¼€å‘æ¿"
          echo "   â”œâ”€ ğŸ–¥ï¸ æ–°å…´è®¾å¤‡"
          echo "   â”‚  â”œâ”€ æŸäº›AIåŠ é€Ÿå™¨"
          echo "   â”‚  â”œâ”€ å®šåˆ¶èŠ¯ç‰‡è®¾å¤‡"
          echo "   â”‚  â””â”€ å­¦æœ¯ç ”ç©¶è®¾å¤‡"
          echo "   â””â”€ ğŸš€ æœªæ¥è®¾å¤‡"
          echo "      â”œâ”€ RISC-Vç¬”è®°æœ¬ç”µè„‘"
          echo "      â”œâ”€ RISC-VæœåŠ¡å™¨"
          echo "      â”œâ”€ å„ç§åˆ›æ–°ç¡¬ä»¶"
          echo ""
          echo "================================================"
          echo "é€‰æ‹©å»ºè®®ï¼š"
          echo "1. è·¯ç”±å™¨è®¾å¤‡ â†’ æ ¹æ®èŠ¯ç‰‡å‹å·é€‰æ‹©"
          echo "2. å¼€å‘æ¿ â†’ æ ¹æ®CPUæ¶æ„é€‰æ‹©"
          echo "3. PC/æœåŠ¡å™¨ â†’ é€‰æ‹©x86_64"
          echo "4. ä¸ç¡®å®š â†’ æŸ¥çœ‹è®¾å¤‡è§„æ ¼ä¹¦æˆ–CPUä¿¡æ¯"
          echo "================================================"

  setup:
    runs-on: ubuntu-22.04
    outputs:
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      glibc_version: ${{ steps.version-detection.outputs.glibc_version }}
      need_build: ${{ steps.check-existing.outputs.need_build }}
      verified_gcc_version: ${{ steps.version-detection.outputs.verified_gcc_version }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“ï¼ˆç”¨äºæ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: firmware-config/build-Compiler-file/compilers
          sparse-checkout-cone-mode: false

      - name: ğŸ—ï¸ åˆå§‹åŒ–
        run: |
          echo "=== äº¤å‰ç¼–è¯‘å™¨æ„å»ºç³»ç»Ÿ ==="
          mkdir -p "$COMPILER_BASE_DIR"
          echo "åŸºç¡€ç›®å½•: $COMPILER_BASE_DIR"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          ls -la "$GITHUB_WORKSPACE/firmware-config/build-Compiler-file/compilers" 2>/dev/null || echo "ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨"

      - name: ğŸ” æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸é€‰æ‹©
        id: version-detection
        run: |
          echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸é€‰æ‹© ==="
          USER_VERSION="${{ github.event.inputs.gcc_version }}"
          TARGET_ARCH="${{ github.event.inputs.target_arch }}"
          LIBC_TYPE="${{ github.event.inputs.libc }}"
          OPENWRT_VERSION="$OPENWRT_VERSION"
          
          echo "è¾“å…¥å‚æ•°:"
          echo "- ç›®æ ‡æ¶æ„: $TARGET_ARCH"
          echo "- Cåº“ç±»å‹: $LIBC_TYPE"
          echo "- ç”¨æˆ·æŒ‡å®šGCCç‰ˆæœ¬: $USER_VERSION"
          echo "OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          
          case "$OPENWRT_VERSION" in
            "23.05.2"|"23.05.*")
              DEFAULT_GCC="12.3.0"
              DEFAULT_BINUTILS="2.40"
              DEFAULT_LINUX="5.15.133"
              DEFAULT_MUSL="1.2.4"
              DEFAULT_GLIBC="2.37"
              ;;
            "22.03.*")
              DEFAULT_GCC="11.3.0"
              DEFAULT_BINUTILS="2.38"
              DEFAULT_LINUX="5.10.179"
              DEFAULT_MUSL="1.2.3"
              DEFAULT_GLIBC="2.35"
              ;;
            "21.02.*")
              DEFAULT_GCC="10.3.0"
              DEFAULT_BINUTILS="2.36.1"
              DEFAULT_LINUX="5.4.188"
              DEFAULT_MUSL="1.2.2"
              DEFAULT_GLIBC="2.33"
              ;;
            *)
              DEFAULT_GCC="12.3.0"
              DEFAULT_BINUTILS="2.40"
              DEFAULT_LINUX="5.15.133"
              DEFAULT_MUSL="1.2.4"
              DEFAULT_GLIBC="2.37"
              ;;
          esac
          
          case "$TARGET_ARCH" in
            "riscv64")
              ARCH_GCC="13.2.0"
              ARCH_BINUTILS="2.41"
              ;;
            "aarch64"|"arm_cortex-a53")
              ARCH_GCC="12.3.0"
              ARCH_BINUTILS="2.40"
              ;;
            "arm_cortex-a7")
              ARCH_GCC="11.3.0"
              ARCH_BINUTILS="2.38"
              ;;
            "mips"|"mipsel")
              ARCH_GCC="10.3.0"
              ARCH_BINUTILS="2.36.1"
              ;;
            *)
              ARCH_GCC="$DEFAULT_GCC"
              ARCH_BINUTILS="$DEFAULT_BINUTILS"
              ;;
          esac
          
          verify_gcc_version() {
            local version="$1"
            echo "éªŒè¯GCCç‰ˆæœ¬ $version æ˜¯å¦å­˜åœ¨..."
            MIRRORS=("https://ftp.gnu.org/gnu/gcc/gcc-$version/gcc-$version.tar.xz" "https://mirrors.kernel.org/gnu/gcc/gcc-$version/gcc-$version.tar.xz" "https://mirror.rackspace.com/gnu/gcc/gcc-$version/gcc-$version.tar.xz")
            
            for mirror in "${MIRRORS[@]}"; do
              if curl -s --head "$mirror" --connect-timeout 10 | grep -q "200 OK"; then
                echo "âœ… GCC $version åœ¨é•œåƒ $mirror ä¸Šå¯ç”¨"
                return 0
              fi
            done
            
            echo "âŒ GCC $version åœ¨æ‰€æœ‰é•œåƒä¸Šéƒ½ä¸å¯ç”¨"
            return 1
          }
          
          if [ "$USER_VERSION" = "auto" ] || [ -z "$USER_VERSION" ]; then
            echo "ä½¿ç”¨æ™ºèƒ½ç‰ˆæœ¬é€‰æ‹©..."
            GCC_VERSION="$ARCH_GCC"
            
            if ! verify_gcc_version "$GCC_VERSION"; then
              echo "âš ï¸ æ™ºèƒ½é€‰æ‹©ç‰ˆæœ¬ $GCC_VERSION ä¸å¯ç”¨ï¼Œå°è¯•æŸ¥æ‰¾å¯ç”¨ç‰ˆæœ¬..."
              AVAILABLE_VERSIONS=$(curl -s --connect-timeout 20 "https://ftp.gnu.org/gnu/gcc/" | grep -o 'gcc-[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -Vr | cut -d- -f2 | uniq)
              
              echo "å¯ç”¨ç‰ˆæœ¬åˆ—è¡¨:"
              echo "$AVAILABLE_VERSIONS" | head -10
              
              case "$TARGET_ARCH" in
                "riscv64")
                  GCC_VERSION=$(echo "$AVAILABLE_VERSIONS" | head -1)
                  ;;
                "arm_cortex-a7")
                  GCC_VERSION=$(echo "$AVAILABLE_VERSIONS" | grep -E '^1[1-2]\.[0-9]+\.[0-9]+' | head -1)
                  ;;
                *)
                  GCC_VERSION=$(echo "$AVAILABLE_VERSIONS" | grep -v "rc" | grep -v "snapshot" | head -1)
                  ;;
              esac
              
              if [ -z "$GCC_VERSION" ]; then
                GCC_VERSION="$DEFAULT_GCC"
                echo "âš ï¸ æ— æ³•æ£€æµ‹å¯ç”¨ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤: $GCC_VERSION"
              else
                echo "âœ… é€‰æ‹©å¯ç”¨ç‰ˆæœ¬: $GCC_VERSION"
              fi
            fi
          else
            GCC_VERSION="$USER_VERSION"
            echo "ä½¿ç”¨ç”¨æˆ·æŒ‡å®šç‰ˆæœ¬: $GCC_VERSION"
            
            if ! verify_gcc_version "$GCC_VERSION"; then
              echo "âŒ ç”¨æˆ·æŒ‡å®šçš„GCCç‰ˆæœ¬ $GCC_VERSION ä¸å¯ç”¨"
              MAJOR_VERSION=$(echo "$GCC_VERSION" | cut -d. -f1)
              echo "æŸ¥æ‰¾ä¸»ç‰ˆæœ¬ $MAJOR_VERSION çš„å¯ç”¨ç‰ˆæœ¬..."
              AVAILABLE_VERSIONS=$(curl -s --connect-timeout 20 "https://ftp.gnu.org/gnu/gcc/" | grep -o "gcc-$MAJOR_VERSION\.[0-9]\+\.[0-9]\+" | sort -Vr | cut -d- -f2 | uniq)
              
              if [ -n "$AVAILABLE_VERSIONS" ]; then
                NEW_VERSION=$(echo "$AVAILABLE_VERSIONS" | head -1)
                echo "æ‰¾åˆ°å¯ç”¨ç‰ˆæœ¬: $NEW_VERSION"
                GCC_VERSION="$NEW_VERSION"
              else
                echo "ä½¿ç”¨æ¶æ„æ¨èç‰ˆæœ¬: $ARCH_GCC"
                GCC_VERSION="$ARCH_GCC"
              fi
            fi
          fi
          
          VERIFIED_GCC_VERSION="$GCC_VERSION"
          echo "âœ… æœ€ç»ˆç¡®è®¤çš„GCCç‰ˆæœ¬: $VERIFIED_GCC_VERSION"
          
          echo "æ ¹æ®GCC $GCC_VERSION é€‰æ‹©Binutilsç‰ˆæœ¬..."
          GCC_MAJOR=$(echo "$GCC_VERSION" | cut -d. -f1)
          
          case $GCC_MAJOR in
            13|14)
              BINUTILS_VERSION="2.41"
              ;;
            12)
              BINUTILS_VERSION="2.40"
              ;;
            11)
              BINUTILS_VERSION="2.38"
              ;;
            10)
              BINUTILS_VERSION="2.36.1"
              ;;
            9)
              BINUTILS_VERSION="2.34"
              ;;
            8)
              BINUTILS_VERSION="2.32"
              ;;
            *)
              BINUTILS_VERSION="$DEFAULT_BINUTILS"
              ;;
          esac
          
          echo "éªŒè¯Binutilsç‰ˆæœ¬ $BINUTILS_VERSION..."
          BINUTILS_URL="https://ftp.gnu.org/gnu/binutils/binutils-$BINUTILS_VERSION.tar.xz"
          if ! curl -s --head "$BINUTILS_URL" | grep -q "200 OK"; then
            echo "âš ï¸ Binutils $BINUTILS_VERSION ä¸å¯ç”¨ï¼Œå°è¯•æ£€æµ‹æœ€æ–°ç‰ˆæœ¬"
            BINUTILS_VERSION=$(curl -s https://ftp.gnu.org/gnu/binutils/ | grep -o 'binutils-[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -Vr | head -1 | cut -d- -f2)
          fi
          
          LINUX_VERSION="$DEFAULT_LINUX"
          MUSL_VERSION="$DEFAULT_MUSL"
          GLIBC_VERSION="$DEFAULT_GLIBC"
          
          echo "ğŸ¯ æœ€ç»ˆç‰ˆæœ¬é€‰æ‹©:"
          echo "- GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "- Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "- Linuxå†…æ ¸: $LINUX_VERSION"
          
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "verified_gcc_version=$VERIFIED_GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨
        id: check-existing
        run: |
          echo "=== æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          GCC_VERSION='${{ steps.version-detection.outputs.verified_gcc_version }}'
          BINUTILS_VERSION='${{ steps.version-detection.outputs.binutils_version }}'
          
          if [ "$LIBC" = "musl" ]; then
            LIBC_DIR="musl"
          else
            LIBC_DIR="glibc"
          fi
          
          OUTPUT_DIR="$COMPILER_BASE_DIR/${ARCH}/${LIBC_DIR}/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "æ£€æŸ¥ç›®å½•: $OUTPUT_DIR"
          
          if [ -d "$OUTPUT_DIR" ]; then
            echo "âœ… ç¼–è¯‘å™¨ç›®å½•å·²å­˜åœ¨"
            ls -la "$OUTPUT_DIR/" 2>/dev/null | head -10
            
            GCC_FILES=$(find "$OUTPUT_DIR" -name "*gcc" -type f 2>/dev/null || true)
            if [ -n "$GCC_FILES" ]; then
              echo "âœ… æ‰¾åˆ°GCCç¼–è¯‘å™¨æ–‡ä»¶"
              FIRST_GCC=$(echo "$GCC_FILES" | head -1)
              "$FIRST_GCC" --version 2>&1 | head -3 || echo "æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯"
            else
              echo "âŒ æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨æ–‡ä»¶"
              NEED_BUILD="true"
            fi
            
            if [ -f "$OUTPUT_DIR/metadata.json" ]; then
              echo "æ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶"
              STORED_GCC=$(jq -r '.gcc_version' "$OUTPUT_DIR/metadata.json" 2>/dev/null || echo "")
              STORED_BINUTILS=$(jq -r '.binutils_version' "$OUTPUT_DIR/metadata.json" 2>/dev/null || echo "")
              
              if [ "$STORED_GCC" = "$GCC_VERSION" ] && [ "$STORED_BINUTILS" = "$BINUTILS_VERSION" ]; then
                echo "âœ… ç‰ˆæœ¬åŒ¹é…"
              else
                echo "âš ï¸ ç‰ˆæœ¬ä¸åŒ¹é…"
                NEED_BUILD="true"
              fi
            else
              echo "âš ï¸ æœªæ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶"
              NEED_BUILD="true"
            fi
            
            if [ -z "$NEED_BUILD" ]; then
              if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
                echo "âš ï¸ å¼ºåˆ¶é‡æ–°æ„å»ºå·²å¯ç”¨"
                NEED_BUILD="true"
              else
                echo "âœ… ç¼–è¯‘å™¨å®Œæ•´ï¼Œè·³è¿‡æ„å»º"
                NEED_BUILD="false"
              fi
            fi
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º"
            NEED_BUILD="true"
          fi
          
          echo "æ„å»ºå†³ç­–: $NEED_BUILD"
          echo "need_build=$NEED_BUILD" >> $GITHUB_OUTPUT

  build-compiler:
    needs: [show-device-info, setup]
    if: needs.setup.outputs.need_build == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æ¶æ„: ${{ github.event.inputs.target_arch }}"
          echo "Cåº“ç±»å‹: ${{ github.event.inputs.libc }}"
          echo "GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "Glibcç‰ˆæœ¬: ${{ needs.setup.outputs.glibc_version }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ env.OPENWRT_VERSION }}"
          echo "æ„å»ºéœ€æ±‚: ${{ needs.setup.outputs.need_build }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "========================================"

      - name: ğŸ—ï¸ è®¾ç½®ç¯å¢ƒ
        run: |
          echo "=== è®¾ç½®æ„å»ºç¯å¢ƒ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="ipq40xx"
              SUBTARGET="generic"
              ARCH_NAME="arm"
              ARCH_DIR="arm_cortex-a7"
              PREFIX="arm-openwrt-linux"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              ABI="32"
              FLOAT_ABI="hard"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              ARCH_DIR="aarch64"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              ARCH_DIR="x86_64"
              PREFIX="x86_64-openwrt-linux"
              CPU_TYPE="x86_64"
              TUNE="generic"
              ABI="64"
              FLOAT_ABI=""
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              ARCH_DIR="mips"
              PREFIX="mips-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              ARCH_DIR="mipsel"
              PREFIX="mipsel-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            arm_cortex-a53)
              TARGET="rockchip"
              SUBTARGET="armv8"
              ARCH_NAME="aarch64"
              ARCH_DIR="arm_cortex-a53"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              ARCH_DIR="riscv64"
              PREFIX="riscv64-openwrt-linux"
              CPU_TYPE="generic"
              TUNE="generic"
              ABI="lp64d"
              FLOAT_ABI="hard"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
              exit 1
              ;;
          esac
          
          if [ "$LIBC" = "musl" ]; then
            PREFIX="${PREFIX}-musl"
            LIBC_SUFFIX="musl"
            LIBC_DIR="musl"
            USE_MUSL="y"
            USE_GLIBC="n"
            LIBC_VERSION='${{ needs.setup.outputs.musl_version }}'
          else
            PREFIX="${PREFIX}-gnu"
            LIBC_SUFFIX="glibc"
            LIBC_DIR="glibc"
            USE_MUSL="n"
            USE_GLIBC="y"
            LIBC_VERSION='${{ needs.setup.outputs.glibc_version }}'
          fi
          
          GCC_VERSION='${{ needs.setup.outputs.verified_gcc_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          LINUX_VERSION='${{ needs.setup.outputs.linux_version }}'
          
          BUILD_ID="${ARCH_DIR}_${LIBC_DIR}_gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="/tmp/compiler-build-${BUILD_ID}"
          OUTPUT_DIR="$COMPILER_BASE_DIR/${ARCH_DIR}/${LIBC_DIR}/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "ğŸ“Š ç¯å¢ƒé…ç½®æ±‡æ€»:"
          echo "  æ„å»ºID: $BUILD_ID"
          echo "  æ„å»ºç›®å½•: $BUILD_DIR"
          echo "  è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          echo "  æ¶æ„åç§°: $ARCH_NAME"
          echo "  GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "  Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "  ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "ARCH_DIR=$ARCH_DIR" >> $GITHUB_ENV
          echo "LIBC_DIR=$LIBC_DIR" >> $GITHUB_ENV
          echo "LIBC_VERSION=$LIBC_VERSION" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "TUNE=$TUNE" >> $GITHUB_ENV
          echo "ABI=$ABI" >> $GITHUB_ENV
          echo "FLOAT_ABI=$FLOAT_ABI" >> $GITHUB_ENV
          echo "USE_MUSL=$USE_MUSL" >> $GITHUB_ENV
          echo "USE_GLIBC=$USE_GLIBC" >> $GITHUB_ENV
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV
          echo "LINUX_VERSION=$LINUX_VERSION" >> $GITHUB_ENV
          echo "LIBC_SUFFIX=$LIBC_SUFFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          echo "=== å®‰è£…æ„å»ºä¾èµ– ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison git wget curl file gawk gettext rsync unzip autoconf automake autopoint libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq info install-info liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev libelf-dev libdw-dev libcap-dev libattr1-dev libaudit-dev libiberty-dev libssl-dev libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev python3-distutils libncurses5-dev gnutls-bin zlib1g-dev
          
          ARCH="${{ github.event.inputs.target_arch }}"
          case "$ARCH" in
            "riscv64")
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y device-tree-compiler qemu-system-riscv64 libfdt-dev
              ;;
            "aarch64"|"arm_cortex-a7"|"arm_cortex-a53")
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
              ;;
          esac
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ—‘ï¸ æ¸…ç†æ„å»ºç¼“å­˜
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          echo "=== æ¸…ç†æ„å»ºç¼“å­˜ ==="
          sudo rm -rf /tmp/compiler-build-* 2>/dev/null || true
          echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          
          echo "å…‹éš†OpenWrt $OPENWRT_VERSION åˆ†æ”¯..."
          if git clone --depth 1 --branch "v$OPENWRT_VERSION" https://github.com/openwrt/openwrt.git .; then
            echo "âœ… Git cloneæˆåŠŸ"
          else
            git clone --depth 1 https://github.com/openwrt/openwrt.git .
            if git checkout "v$OPENWRT_VERSION"; then
              echo "âœ… åˆ‡æ¢ç‰ˆæœ¬æˆåŠŸ"
            else
              wget --tries=3 --timeout=60 --show-progress -O openwrt.tar.gz "https://github.com/openwrt/openwrt/archive/refs/tags/v$OPENWRT_VERSION.tar.gz"
              tar -xzf openwrt.tar.gz --strip-components=1
              rm -f openwrt.tar.gz
              echo "âœ… ä½¿ç”¨taråŒ…ä¸‹è½½æˆåŠŸ"
            fi
          fi
          
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ”§ å…³é”®ä¿®å¤ï¼šåˆ›å»ºç¼ºå¤±çš„target.mkæ–‡ä»¶
        run: |
          echo "=== å…³é”®ä¿®å¤ï¼šåˆ›å»ºç¼ºå¤±çš„target.mkæ–‡ä»¶ ==="
          cd "$BUILD_DIR"
          
          echo "æ£€æŸ¥includeç›®å½•..."
          mkdir -p include
          
          echo "åˆ›å»ºtarget.mkæ–‡ä»¶..."
          echo "# Auto-generated target.mk" > include/target.mk
          echo "ARCH_PACKAGES:=" >> include/target.mk
          echo "DEVICE_TYPE:=" >> include/target.mk
          echo "DEFAULT_PACKAGES:=" >> include/target.mk
          echo "FEATURES:=" >> include/target.mk
          
          echo "åˆ›å»ºkernel-version.mkæ–‡ä»¶..."
          echo "# Auto-generated kernel-version.mk" > include/kernel-version.mk
          echo "LINUX_VERSION:=5.15.133" >> include/kernel-version.mk
          echo "LINUX_RELEASE:=1" >> include/kernel-version.mk
          
          echo "åˆ›å»ºå…¶ä»–å¿…è¦çš„é…ç½®æ–‡ä»¶..."
          echo "# Placeholder" > include/openssl-engine.mk
          
          echo "âœ… ç¼ºå¤±æ–‡ä»¶ä¿®å¤å®Œæˆ"

      - name: ğŸ“¥ é¢„ä¸‹è½½æºç åŒ…
        timeout-minutes: 60
        run: |
          echo "=== é¢„ä¸‹è½½æºç åŒ… ==="
          cd "$BUILD_DIR"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          mkdir -p dl
          
          echo "ä¸‹è½½GCC $GCC_VERSION..."
          MIRRORS=("https://ftp.gnu.org/gnu/gcc/gcc-$GCC_VERSION/gcc-$GCC_VERSION.tar.xz" "https://mirrors.kernel.org/gnu/gcc/gcc-$GCC_VERSION/gcc-$GCC_VERSION.tar.xz")
          
          for mirror in "${MIRRORS[@]}"; do
            echo "å°è¯•é•œåƒ: $mirror"
            if wget --tries=3 --timeout=120 --show-progress -O "dl/gcc-$GCC_VERSION.tar.xz" "$mirror"; then
              echo "âœ… GCC $GCC_VERSION ä¸‹è½½æˆåŠŸ"
              break
            fi
            rm -f "dl/gcc-$GCC_VERSION.tar.xz" 2>/dev/null
          done
          
          echo "ä¸‹è½½Binutils $BINUTILS_VERSION..."
          MIRRORS=("https://ftp.gnu.org/gnu/binutils/binutils-$BINUTILS_VERSION.tar.xz" "https://mirrors.kernel.org/gnu/binutils/binutils-$BINUTILS_VERSION.tar.xz")
          
          for mirror in "${MIRRORS[@]}"; do
            echo "å°è¯•é•œåƒ: $mirror"
            if wget --tries=3 --timeout=120 --show-progress -O "dl/binutils-$BINUTILS_VERSION.tar.xz" "$mirror"; then
              echo "âœ… Binutils $BINUTILS_VERSION ä¸‹è½½æˆåŠŸ"
              break
            fi
            rm -f "dl/binutils-$BINUTILS_VERSION.tar.xz" 2>/dev/null
          done
          
          echo "âœ… é¢„ä¸‹è½½å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ” å¼ºåˆ¶é”å®šé…ç½®
        run: |
          echo "=== å¼ºåˆ¶é”å®šé…ç½® ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "$BUILD_DIR"
          
          rm -f .config .config.old .config.cmd 2>/dev/null || true
          
          echo "# åŸºç¡€é…ç½®" > .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_CCACHE=n" >> .config
          echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "" >> .config
          echo "# å·¥å…·é“¾é…ç½®" >> .config
          echo "CONFIG_EXTERNAL_TOOLCHAIN=n" >> .config
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "CONFIG_GCC_VERSION=\"$GCC_VERSION\"" >> .config
          echo "CONFIG_BINUTILS_VERSION=\"$BINUTILS_VERSION\"" >> .config
          echo "CONFIG_LINUX_VERSION=\"$LINUX_VERSION\"" >> .config
          echo "CONFIG_USE_MUSL=$USE_MUSL" >> .config
          echo "" >> .config
          echo "# ç›®æ ‡é…ç½®" >> .config
          echo "CONFIG_TARGET_$TARGET=y" >> .config
          echo "CONFIG_TARGET_${TARGET}_$SUBTARGET=y" >> .config
          echo "CONFIG_TARGET_ARCH=\"$ARCH_NAME\"" >> .config
          echo "CONFIG_TARGET_PREFIX=\"$PREFIX\"" >> .config
          echo "" >> .config
          echo "# Cåº“é…ç½®" >> .config
          
          if [ "$USE_MUSL" = "y" ]; then
            echo "CONFIG_MUSL_VERSION=\"$LIBC_VERSION\"" >> .config
            echo "CONFIG_GLIBC_VERSION=\"\"" >> .config
          else
            echo "CONFIG_GLIBC_VERSION=\"$LIBC_VERSION\"" >> .config
            echo "CONFIG_MUSL_VERSION=\"\"" >> .config
          fi
          
          echo "" >> .config
          echo "# ç®€åŒ–é…ç½®" >> .config
          echo "CONFIG_TARGET_OPTIMIZATION=\"-Os -pipe\"" >> .config
          echo "CONFIG_TARGET_DEBUG=y" >> .config
          echo "CONFIG_GDB=n" >> .config
          
          echo "âœ… é…ç½®å¼ºåˆ¶é”å®šå®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ”§ ä¿®å¤GMPæ„å»ºé—®é¢˜
        run: |
          echo "=== ä¿®å¤GMPæ„å»ºé—®é¢˜ ==="
          cd "$BUILD_DIR"
          
          if [ -d "tools/gmp" ]; then
            if [ -f "tools/gmp/Makefile" ]; then
              cp tools/gmp/Makefile tools/gmp/Makefile.backup
              sed -i '/define Host\/Configure/a \\t\tABI=64 \\' tools/gmp/Makefile
              sed -i '/define Host\/Configure/a \\t\t--enable-cxx \\' tools/gmp/Makefile
              echo "âœ… GMPæ„å»ºä¿®å¤å®Œæˆ"
            else
              echo "âš ï¸ GMP Makefileä¸å­˜åœ¨"
            fi
          else
            echo "âš ï¸ tools/gmpç›®å½•ä¸å­˜åœ¨"
          fi

      - name: ğŸ› ï¸ æ„å»ºå·¥å…·é“¾ï¼ˆä¿®å¤ç‰ˆï¼‰
        timeout-minutes: 240
        run: |
          echo "=== æ„å»ºå·¥å…·é“¾ï¼ˆä¿®å¤ç‰ˆï¼‰ ==="
          cd "$BUILD_DIR"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          export FORCE_UNSAFE_CONFIGURE=1
          export MAKEFLAGS="-j$(nproc)"
          
          echo "æ­¥éª¤1: éªŒè¯é…ç½®..."
          grep -E "CONFIG_TARGET_|CONFIG_GCC|CONFIG_BINUTILS" .config | grep -v "=n"
          
          echo "æ­¥éª¤2: è¿è¡Œmake defconfig..."
          make defconfig
          
          echo "æ­¥éª¤3: ä¸‹è½½feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo "æ­¥éª¤4: æ„å»ºå·¥å…·é“¾..."
          echo "è¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."
          
          make toolchain/compile V=s 2>&1 | tee /tmp/compile.log &
          COMPILE_PID=$!
          
          for i in {1..120}; do
            if kill -0 $COMPILE_PID 2>/dev/null; then
              echo "è¿›åº¦: ç¬¬ $i/120 åˆ†é’Ÿ"
              sleep 30
            else
              break
            fi
          done
          
          if kill -0 $COMPILE_PID 2>/dev/null; then
            kill -9 $COMPILE_PID 2>/dev/null
            echo "âš ï¸ å·¥å…·é“¾ç¼–è¯‘è¶…æ—¶"
          fi
          
          echo "æ­¥éª¤5: å®‰è£…å·¥å…·é“¾..."
          make toolchain/install V=s 2>&1 | tee /tmp/install.log | tail -50
          
          echo "âœ… å·¥å…·é“¾æ„å»ºå®Œæˆ"
          echo "æ€»æ„å»ºæ—¶é—´: $(date)"
          
          TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
          if [ -n "$TOOLCHAIN_DIR" ]; then
            echo "âœ… æ‰¾åˆ°å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
            echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
          fi

      - name: ğŸ” éªŒè¯ç¼–è¯‘å™¨
        run: |
          echo "=== éªŒè¯ç¼–è¯‘å™¨ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "$BUILD_DIR"
          
          COMPILER_PATH=""
          if [ -n "$TOOLCHAIN_DIR" ] && [ -d "$TOOLCHAIN_DIR/bin" ]; then
            case "$ARCH_NAME" in
              "arm")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "arm-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              "aarch64")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "aarch64-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              "x86_64")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "x86_64-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              *)
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
                ;;
            esac
          fi
          
          if [ -n "$COMPILER_PATH" ] && [ -x "$COMPILER_PATH" ]; then
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶: $COMPILER_PATH"
            echo "ç¼–è¯‘å™¨ç‰ˆæœ¬:"
            "$COMPILER_PATH" --version 2>&1 | head -3
            echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV
            echo "BUILD_COMPLETE=true" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°å¯ç”¨çš„ç¼–è¯‘å™¨"
            echo "BUILD_COMPLETE=false" >> $GITHUB_ENV
          fi
          
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨
        if: env.BUILD_COMPLETE == 'true'
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          echo "å‡†å¤‡è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          mkdir -p "$OUTPUT_DIR"
          
          if [ -d "$OUTPUT_DIR" ] && [ "$(ls -A "$OUTPUT_DIR" 2>/dev/null)" ]; then
            rm -rf "$OUTPUT_DIR"/*
          fi
          
          if [ -d "$TOOLCHAIN_DIR" ]; then
            echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
            cp -r "$TOOLCHAIN_DIR"/* "$OUTPUT_DIR/" 2>/dev/null || true
            echo "âœ… å¤åˆ¶å®Œæˆ"
          fi
          
          echo "åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶..."
          echo "{" > "$OUTPUT_DIR/metadata.json"
          echo "  \"architecture\": \"$ARCH_DIR\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"arch_name\": \"$ARCH_NAME\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"libc\": \"$LIBC_DIR\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"libc_version\": \"$LIBC_VERSION\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"target\": \"$TARGET\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"subtarget\": \"$SUBTARGET\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"compiler_prefix\": \"$PREFIX\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"gcc_version\": \"$GCC_VERSION\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"binutils_version\": \"$BINUTILS_VERSION\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"linux_version\": \"$LINUX_VERSION\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"openwrt_version\": \"$OPENWRT_VERSION\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"build_date\": \"$(date -Iseconds)\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"workflow_run\": \"$GITHUB_RUN_ID\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"build_id\": \"$BUILD_ID\"," >> "$OUTPUT_DIR/metadata.json"
          echo "  \"status\": \"complete\"" >> "$OUTPUT_DIR/metadata.json"
          echo "}" >> "$OUTPUT_DIR/metadata.json"
          
          TOTAL_SIZE=$(du -sh "$OUTPUT_DIR" | cut -f1)
          FILE_COUNT=$(find "$OUTPUT_DIR" -type f | wc -l)
          
          echo "ğŸ“Š æœ€ç»ˆæˆæœç»Ÿè®¡:"
          echo "- è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "- æ€»å¤§å°: $TOTAL_SIZE"
          echo "- æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          echo "FINAL_OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          
          echo "âœ… ç¼–è¯‘å™¨ä¿å­˜å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ“¤ æäº¤åˆ°Gitä»“åº“
        if: env.BUILD_COMPLETE == 'true'
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°Gitä»“åº“ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "$GITHUB_WORKSPACE"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git config pull.rebase false
          
          git pull origin main --no-edit
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          
          if ! git diff --cached --quiet; then
            git commit -m "build(compiler): æ·»åŠ  $ARCH_DIR-$LIBC_DIR äº¤å‰ç¼–è¯‘å™¨" \
                       -m "æ¶æ„: $ARCH_DIR" \
                       -m "Cåº“: $LIBC_DIR $LIBC_VERSION" \
                       -m "GCC: $GCC_VERSION" \
                       -m "Binutils: $BINUTILS_VERSION" \
                       -m "å¤§å°: $TOTAL_SIZE" \
                       -m "å·¥ä½œæµ: #$GITHUB_RUN_ID"
            
            git push origin main
          else
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi
          
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ“Š æ˜¾ç¤ºæœ€ç»ˆæˆæœ
        run: |
          echo "========================================"
          echo "          ğŸ‰ æ„å»ºå®ŒæˆæŠ¥å‘Š              "
          echo "========================================"
          
          if [ "$BUILD_COMPLETE" = "true" ]; then
            echo "âœ… äº¤å‰ç¼–è¯‘å™¨æ„å»ºæˆåŠŸ!"
            echo ""
            echo "ğŸ“Š æ„å»ºä¿¡æ¯:"
            echo "- æ¶æ„: $ARCH_DIR ($ARCH_NAME)"
            echo "- Cåº“: $LIBC_DIR $LIBC_VERSION"
            echo "- GCCç‰ˆæœ¬: $GCC_VERSION"
            echo "- Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
            echo "- Linuxå†…æ ¸: $LINUX_VERSION"
            echo "- ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
            echo "- ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
            echo ""
            echo "ğŸ“¦ æˆæœç»Ÿè®¡:"
            echo "- æ€»å¤§å°: $TOTAL_SIZE"
            echo "- æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            echo "- è¾“å‡ºç›®å½•: $FINAL_OUTPUT_DIR"
            echo ""
            echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
            echo "cd $FINAL_OUTPUT_DIR"
            echo "export STAGING_DIR=\$(pwd)"
            echo 'export PATH="$STAGING_DIR/bin:$PATH"'
            echo "$PREFIX-gcc --version"
          else
            echo "âŒ äº¤å‰ç¼–è¯‘å™¨æ„å»ºå¤±è´¥"
            echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—"
          fi
          
          echo ""
          echo "â° æ„å»ºæ—¶é—´: $(date)"
          echo "========================================"

      - name: ğŸ“„ ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.BUILD_ID }}
          path: /tmp/*.log
          retention-days: 30

  skip-build:
    needs: setup
    if: needs.setup.outputs.need_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: â­ï¸ è·³è¿‡æ„å»º
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æ„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ä¸”å®Œæ•´ï¼Œè·³è¿‡æ„å»º"
          echo ""
          echo "ğŸ“‹ è·³è¿‡åŸå› :"
          echo "- ç¼–è¯‘å™¨ç›®å½•å·²å­˜åœ¨ä¸”å®Œæ•´"
          echo "- ç‰ˆæœ¬åŒ¹é…æ­£ç¡®"
          echo "- æœªå¯ç”¨å¼ºåˆ¶é‡æ–°æ„å»º"
          echo ""
          echo "ğŸ”§ ç°æœ‰ç¼–è¯‘å™¨ä¿¡æ¯:"
          echo "- æ¶æ„: ${{ github.event.inputs.target_arch }}"
          echo "- Cåº“: ${{ github.event.inputs.libc }}"
          echo "- GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo ""
          echo "ğŸ’¡ å¦‚éœ€é‡æ–°æ„å»ºï¼Œè¯·å¯ç”¨'å¼ºåˆ¶é‡æ–°æ„å»º'é€‰é¡¹"
          echo "========================================"
