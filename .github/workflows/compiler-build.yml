# .github/workflows/compiler-matrix-build.yml
name: ðŸ”§ äº¤å‰ç¼–è¯‘å™¨æž„å»º

on:
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'ç›®æ ‡æž¶æž„ï¼ˆIPQ40xxé€‰æ‹©arm_cortex-a7ï¼‰'
        required: true
        default: 'arm_cortex-a7'
        type: choice
        options: ['aarch64', 'x86_64', 'mips', 'mipsel', 'arm_cortex-a7', 'arm_cortex-a53', 'riscv64']
      libc:
        description: 'Cåº“ç±»åž‹ï¼ˆåµŒå…¥å¼æŽ¨èmuslï¼‰'
        required: true
        default: 'musl'
        type: choice
        options: ['musl', 'glibc']
      gcc_version:
        description: 'GCCç‰ˆæœ¬ï¼ˆè¾“å…¥ç‰ˆæœ¬å·å¦‚12.3.0ï¼Œæˆ–autoè‡ªåŠ¨æ£€æµ‹ï¼‰'
        required: true
        default: 'auto'
        type: string
      clean_build:
        description: 'æ¸…ç†ä¹‹å‰çš„æž„å»ºç¼“å­˜'
        required: true
        default: false
        type: boolean
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æž„å»ºï¼ˆå³ä½¿å·²å­˜åœ¨ï¼‰'
        required: true
        default: false
        type: boolean

env:
  OPENWRT_VERSION: "23.05.2"
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers"

jobs:
  show-device-info:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“± æ˜¾ç¤ºæž¶æž„å¯¹åº”è®¾å¤‡
        run: |
          echo "================================================"
          echo "          ðŸŽ¯ ç›®æ ‡æž¶æž„è®¾å¤‡å¯¹åº”è¡¨                 "
          echo "================================================"
          echo ""
          echo "1ï¸âƒ£ aarch64 (ARM 64ä½)"
          echo "   â”œâ”€ ðŸ“± æ ‘èŽ“æ´¾ç³»åˆ—"
          echo "   â”‚  â”œâ”€ æ ‘èŽ“æ´¾ 4B (Raspberry Pi 4)"
          echo "   â”‚  â”œâ”€ æ ‘èŽ“æ´¾ CM4 (Compute Module 4)"
          echo "   â”‚  â””â”€ æ ‘èŽ“æ´¾ 400"
          echo "   â”œâ”€ ðŸ–¥ï¸ ç‘žèŠ¯å¾®ç³»åˆ—"
          echo "   â”‚  â”œâ”€ RK3399 (ROCK Pi 4/NanoPi M4)"
          echo "   â”‚  â”œâ”€ RK3568 (FriendlyELEC NanoPi R5S)"
          echo "   â”‚  â””â”€ RK3588 (é«˜ç«¯å¼€å‘æ¿)"
          echo "   â”œâ”€ ðŸ“º ç”µè§†ç›’å­"
          echo "   â”‚  â”œâ”€ æ™¶æ™¨ S905 (X96 Max/Beelink GT King)"
          echo "   â”‚  â”œâ”€ æ™¶æ™¨ S912 (H96 Pro/Beelink GT1)"
          echo "   â”‚  â””â”€ æ™¶æ™¨ S922X (Odroid N2+)"
          echo "   â””â”€ ðŸ–¥ï¸ å…¶ä»–ARM64è®¾å¤‡"
          echo "      â”œâ”€ Orange Pi 5"
          echo "      â”œâ”€ Banana Pi BPI-M5"
          echo "      â””â”€ å„ç§ARMæœåŠ¡å™¨"
          echo ""
          echo "2ï¸âƒ£ x86_64 (x86 64ä½)"
          echo "   â”œâ”€ ðŸ’» ä¸ªäººç”µè„‘"
          echo "   â”‚  â”œâ”€ Intel Core i3/i5/i7/i9"
          echo "   â”‚  â”œâ”€ AMD Ryzen 3/5/7/9"
          echo "   â”‚  â””â”€ å„ç§x86ç¬”è®°æœ¬"
          echo "   â”œâ”€ ðŸ–¥ï¸ æœåŠ¡å™¨"
          echo "   â”‚  â”œâ”€ æˆ´å°”PowerEdge"
          echo "   â”‚  â”œâ”€ æƒ æ™®ProLiant"
          echo "   â”‚  â””â”€ è¶…å¾®æœåŠ¡å™¨"
          echo "   â””â”€ â˜ï¸ è™šæ‹Ÿæœº/å®¹å™¨"
          echo "      â”œâ”€ VMware/VirtualBoxè™šæ‹Ÿæœº"
          echo "      â”œâ”€ Dockerå®¹å™¨"
          echo "      â””â”€ äº‘æœåŠ¡å™¨å®žä¾‹"
          echo ""
          echo "3ï¸âƒ£ mips (MIPS 32ä½å¤§ç«¯)"
          echo "   â”œâ”€ ðŸ›œ åŽç¡•è·¯ç”±å™¨"
          echo "   â”‚  â”œâ”€ RT-ACRH17"
          echo "   â”‚  â”œâ”€ RT-AC85P"
          echo "   â”‚  â””â”€ RT-N56U"
          echo "   â”œâ”€ ðŸ›œ ç½‘ä»¶è·¯ç”±å™¨"
          echo "   â”‚  â”œâ”€ R7800"
          echo "   â”‚  â”œâ”€ R9000"
          echo "   â”‚  â””â”€ XR500"
          echo "   â””â”€ ðŸ›œ å…¶ä»–MIPSè®¾å¤‡"
          echo "      â”œâ”€ ä¸­å…´è·¯ç”±å™¨"
          echo "      â”œâ”€ åŽä¸ºæ—§æ¬¾è·¯ç”±å™¨"
          echo "      â””â”€ æ—©æœŸæ™ºèƒ½å®¶å±…è®¾å¤‡"
          echo ""
          echo "4ï¸âƒ£ mipsel (MIPS 32ä½å°ç«¯)"
          echo "   â”œâ”€ ðŸ›œ è”å‘ç§‘MT7621"
          echo "   â”‚  â”œâ”€ æ–è®¯ K2P (Phicomm K2P)"
          echo "   â”‚  â”œâ”€ Newifi 3 (æ–°è·¯ç”±3)"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 3G"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AC2100"
          echo "   â”‚  â””â”€ æžè·¯ç”± B70"
          echo "   â”œâ”€ ðŸ›œ è”å‘ç§‘MT7620"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ Mini"
          echo "   â”‚  â”œâ”€ æžè·¯ç”± 1S"
          echo "   â”‚  â”œâ”€ æ–è®¯ K1/K2"
          echo "   â”‚  â””â”€ è”æƒ³ Newifi Mini"
          echo "   â””â”€ ðŸ›œ å…¶ä»–MTKè®¾å¤‡"
          echo "      â”œâ”€ MT7628 (ä½Žç«¯è·¯ç”±)"
          echo "      â”œâ”€ MT7688 (ç‰©è”ç½‘è®¾å¤‡)"
          echo "      â””â”€ å„ç§WiFiæ¨¡å—"
          echo ""
          echo "5ï¸âƒ£ arm_cortex-a7 (ARM Cortex-A7)"
          echo "   â”œâ”€ ðŸ›œ é«˜é€šIPQ40xxç³»åˆ— (ä½ çš„è®¾å¤‡ï¼)"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 4Aåƒå…†ç‰ˆ"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AC2100 (éƒ¨åˆ†ç‰ˆæœ¬)"
          echo "   â”‚  â”œâ”€ GL.iNet MT1300"
          echo "   â”‚  â”œâ”€ 360å®¶åº­é˜²ç«å¢™ 5Pro"
          echo "   â”‚  â”œâ”€ Linksys EA6350 v3"
          echo "   â”‚  â””â”€ Netgear R6900P"
          echo "   â”œâ”€ ðŸ›œ è”å‘ç§‘MT7623/MT7629"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 3G (éƒ¨åˆ†ç‰ˆæœ¬)"
          echo "   â”‚  â”œâ”€ æ–è®¯ K3C"
          echo "   â”‚  â””â”€ éƒ¨åˆ†ä¼ä¸šè·¯ç”±å™¨"
          echo "   â”œâ”€ ðŸŠ å…¨å¿—H3/H2+ç³»åˆ—"
          echo "   â”‚  â”œâ”€ Orange Pi PC (é¦™æ©™æ´¾PC)"
          echo "   â”‚  â”œâ”€ Orange Pi Plus"
          echo "   â”‚  â”œâ”€ Banana Pi M2+"
          echo "   â”‚  â””â”€ NanoPi NEO"
          echo "   â””â”€ ðŸ”§ å…¶ä»–Cortex-A7è®¾å¤‡"
          echo "      â”œâ”€ æŸäº›æ™ºèƒ½æ‘„åƒå¤´"
          echo "      â”œâ”€ å·¥ä¸šæŽ§åˆ¶è®¾å¤‡"
          echo "      â””â”€ ä½ŽåŠŸè€—åµŒå…¥å¼è®¾å¤‡"
          echo ""
          echo "6ï¸âƒ£ arm_cortex-a53 (ARM Cortex-A53)"
          echo "   â”œâ”€ ðŸ›œ è”å‘ç§‘MT7622"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ AX3600"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AX6"
          echo "   â”‚  â””â”€ éƒ¨åˆ†WiFi6è·¯ç”±å™¨"
          echo "   â”œâ”€ ðŸ“± 64ä½è®¾å¤‡32ä½æ¨¡å¼"
          echo "   â”‚  â”œâ”€ æ ‘èŽ“æ´¾ 3 (32ä½æ¨¡å¼)"
          echo "   â”‚  â”œâ”€ æŸäº›ç”µè§†ç›’å­"
          echo "   â”‚  â””â”€ ä½Žç«¯å¹³æ¿ç”µè„‘"
          echo "   â””â”€ ðŸ”§ å…¶ä»–A53è®¾å¤‡"
          echo "      â”œâ”€ æŸäº›æ™ºèƒ½éŸ³ç®±"
          echo "      â”œâ”€ ç‰©è”ç½‘ç½‘å…³"
          echo "      â”œâ”€ è¾¹ç¼˜è®¡ç®—è®¾å¤‡"
          echo ""
          echo "7ï¸âƒ£ riscv64 (RISC-V 64ä½)"
          echo "   â”œâ”€ ðŸ”¬ å¼€å‘æ¿"
          echo "   â”‚  â”œâ”€ HiFive Unmatched"
          echo "   â”‚  â”œâ”€ VisionFive 2"
          echo "   â”‚  â”œâ”€ BeagleV"
          echo "   â”‚  â””â”€ SiFiveå¼€å‘æ¿"
          echo "   â”œâ”€ ðŸ–¥ï¸ æ–°å…´è®¾å¤‡"
          echo "   â”‚  â”œâ”€ æŸäº›AIåŠ é€Ÿå™¨"
          echo "   â”‚  â”œâ”€ å®šåˆ¶èŠ¯ç‰‡è®¾å¤‡"
          echo "   â”‚  â””â”€ å­¦æœ¯ç ”ç©¶è®¾å¤‡"
          echo "   â””â”€ ðŸš€ æœªæ¥è®¾å¤‡"
          echo "      â”œâ”€ RISC-Vç¬”è®°æœ¬ç”µè„‘"
          echo "      â”œâ”€ RISC-VæœåŠ¡å™¨"
          echo "      â”œâ”€ å„ç§åˆ›æ–°ç¡¬ä»¶"
          echo ""
          echo "================================================"
          echo "é€‰æ‹©å»ºè®®ï¼š"
          echo "1. è·¯ç”±å™¨è®¾å¤‡ â†’ æ ¹æ®èŠ¯ç‰‡åž‹å·é€‰æ‹©"
          echo "2. å¼€å‘æ¿ â†’ æ ¹æ®CPUæž¶æž„é€‰æ‹©"
          echo "3. PC/æœåŠ¡å™¨ â†’ é€‰æ‹©x86_64"
          echo "4. ä¸ç¡®å®š â†’ æŸ¥çœ‹è®¾å¤‡è§„æ ¼ä¹¦æˆ–CPUä¿¡æ¯"
          echo "================================================"

  setup:
    runs-on: ubuntu-22.04
    outputs:
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      glibc_version: ${{ steps.version-detection.outputs.glibc_version }}
      need_build: ${{ steps.check-existing.outputs.need_build }}
      verified_gcc_version: ${{ steps.version-detection.outputs.verified_gcc_version }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»“åº“ï¼ˆç”¨äºŽæ£€æŸ¥çŽ°æœ‰ç¼–è¯‘å™¨ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: firmware-config/build-Compiler-file/compilers
          sparse-checkout-cone-mode: false

      - name: ðŸ—ï¸ åˆå§‹åŒ–
        run: |
          echo "=== äº¤å‰ç¼–è¯‘å™¨æž„å»ºç³»ç»Ÿ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          echo "åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "å½“å‰å·¥ä½œåŒºå†…å®¹:"
          ls -la "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers" 2>/dev/null || echo "ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨"

      - name: ðŸ” æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸Žé€‰æ‹©ï¼ˆä¿®å¤ç‰ˆï¼‰
        id: version-detection
        run: |
          echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸Žé€‰æ‹©ï¼ˆä¿®å¤ç‰ˆï¼‰==="
          USER_VERSION="${{ github.event.inputs.gcc_version }}"
          TARGET_ARCH="${{ github.event.inputs.target_arch }}"
          LIBC_TYPE="${{ github.event.inputs.libc }}"
          OPENWRT_VERSION="${{ env.OPENWRT_VERSION }}"
          
          echo "è¾“å…¥å‚æ•°:"
          echo "- ç›®æ ‡æž¶æž„: $TARGET_ARCH"
          echo "- Cåº“ç±»åž‹: $LIBC_TYPE"
          echo "- ç”¨æˆ·æŒ‡å®šGCCç‰ˆæœ¬: $USER_VERSION"
          echo "OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          
          # OpenWrtç‰ˆæœ¬åŸºç¡€é…ç½®
          case "$OPENWRT_VERSION" in
            "23.05.2"|"23.05.*")
              DEFAULT_GCC="12.3.0"
              DEFAULT_BINUTILS="2.40"
              DEFAULT_LINUX="5.15.133"
              DEFAULT_MUSL="1.2.4"
              DEFAULT_GLIBC="2.37"
              ;;
            "22.03.*")
              DEFAULT_GCC="11.3.0"
              DEFAULT_BINUTILS="2.38"
              DEFAULT_LINUX="5.10.179"
              DEFAULT_MUSL="1.2.3"
              DEFAULT_GLIBC="2.35"
              ;;
            "21.02.*")
              DEFAULT_GCC="10.3.0"
              DEFAULT_BINUTILS="2.36.1"
              DEFAULT_LINUX="5.4.188"
              DEFAULT_MUSL="1.2.2"
              DEFAULT_GLIBC="2.33"
              ;;
            *)
              DEFAULT_GCC="12.3.0"
              DEFAULT_BINUTILS="2.40"
              DEFAULT_LINUX="5.15.133"
              DEFAULT_MUSL="1.2.4"
              DEFAULT_GLIBC="2.37"
              ;;
          esac
          
          # æž¶æž„ç‰¹å®šä¼˜åŒ–ç‰ˆæœ¬
          case "$TARGET_ARCH" in
            "riscv64")
              ARCH_GCC="13.2.0"
              ARCH_BINUTILS="2.41"
              echo "RISC-Væž¶æž„ï¼Œä½¿ç”¨è¾ƒæ–°å·¥å…·é“¾ç‰ˆæœ¬"
              ;;
            "aarch64"|"arm_cortex-a53")
              ARCH_GCC="12.3.0"
              ARCH_BINUTILS="2.40"
              ;;
            "arm_cortex-a7")
              ARCH_GCC="11.3.0"
              ARCH_BINUTILS="2.38"
              echo "ARM Cortex-A7æž¶æž„ï¼Œä½¿ç”¨å…¼å®¹æ€§æ›´å¥½çš„GCC 11.3.0"
              ;;
            "mips"|"mipsel")
              ARCH_GCC="10.3.0"
              ARCH_BINUTILS="2.36.1"
              echo "MIPSæž¶æž„ï¼Œä½¿ç”¨è¾ƒè€å·¥å…·é“¾ç‰ˆæœ¬ä»¥ä¿è¯å…¼å®¹æ€§"
              ;;
            *)
              ARCH_GCC="$DEFAULT_GCC"
              ARCH_BINUTILS="$DEFAULT_BINUTILS"
              ;;
          esac
          
          # éªŒè¯GCCç‰ˆæœ¬å¯ç”¨æ€§å‡½æ•°
          verify_gcc_version() {
            local version="$1"
            echo "éªŒè¯GCCç‰ˆæœ¬ $version æ˜¯å¦å­˜åœ¨..."
            
            # å°è¯•å¤šä¸ªé•œåƒæº
            MIRRORS=(
              "https://ftp.gnu.org/gnu/gcc/gcc-$version/gcc-$version.tar.xz"
              "https://mirrors.kernel.org/gnu/gcc/gcc-$version/gcc-$version.tar.xz"
              "https://mirror.rackspace.com/gnu/gcc/gcc-$version/gcc-$version.tar.xz"
            )
            
            for mirror in "${MIRRORS[@]}"; do
              if curl -s --head "$mirror" --connect-timeout 10 | grep -q "200 OK"; then
                echo "âœ… GCC $version åœ¨é•œåƒ $mirror ä¸Šå¯ç”¨"
                return 0
              fi
            done
            
            echo "âŒ GCC $version åœ¨æ‰€æœ‰é•œåƒä¸Šéƒ½ä¸å¯ç”¨"
            return 1
          }
          
          # GCCç‰ˆæœ¬é€‰æ‹©é€»è¾‘
          if [ "$USER_VERSION" = "auto" ] || [ -z "$USER_VERSION" ]; then
            echo "ä½¿ç”¨æ™ºèƒ½ç‰ˆæœ¬é€‰æ‹©..."
            GCC_VERSION="$ARCH_GCC"
            
            # éªŒè¯é€‰æ‹©çš„ç‰ˆæœ¬
            if ! verify_gcc_version "$GCC_VERSION"; then
              echo "âš ï¸ æ™ºèƒ½é€‰æ‹©ç‰ˆæœ¬ $GCC_VERSION ä¸å¯ç”¨ï¼Œå°è¯•æŸ¥æ‰¾å¯ç”¨ç‰ˆæœ¬..."
              
              # èŽ·å–æ‰€æœ‰å¯ç”¨ç‰ˆæœ¬
              echo "èŽ·å–GNUé•œåƒä¸Šçš„GCCç‰ˆæœ¬åˆ—è¡¨..."
              AVAILABLE_VERSIONS=$(curl -s --connect-timeout 20 "https://ftp.gnu.org/gnu/gcc/" | \
                grep -o 'gcc-[0-9]\+\.[0-9]\+\.[0-9]\+' | \
                sort -Vr | \
                cut -d- -f2 | \
                uniq)
              
              echo "å¯ç”¨ç‰ˆæœ¬åˆ—è¡¨:"
              echo "$AVAILABLE_VERSIONS" | head -10
              
              # æ ¹æ®æž¶æž„é€‰æ‹©æœ€åˆé€‚çš„ç‰ˆæœ¬
              case "$TARGET_ARCH" in
                "riscv64")
                  # æŸ¥æ‰¾æœ€æ–°ç‰ˆæœ¬
                  GCC_VERSION=$(echo "$AVAILABLE_VERSIONS" | head -1)
                  ;;
                "arm_cortex-a7")
                  # æŸ¥æ‰¾11.xæˆ–12.xç‰ˆæœ¬
                  GCC_VERSION=$(echo "$AVAILABLE_VERSIONS" | grep -E '^1[1-2]\.[0-9]+\.[0-9]+' | head -1)
                  ;;
                *)
                  # æŸ¥æ‰¾æœ€æ–°ç¨³å®šç‰ˆæœ¬
                  GCC_VERSION=$(echo "$AVAILABLE_VERSIONS" | grep -v "rc" | grep -v "snapshot" | head -1)
                  ;;
              esac
              
              if [ -z "$GCC_VERSION" ]; then
                GCC_VERSION="$DEFAULT_GCC"
                echo "âš ï¸ æ— æ³•æ£€æµ‹å¯ç”¨ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤: $GCC_VERSION"
              else
                echo "âœ… é€‰æ‹©å¯ç”¨ç‰ˆæœ¬: $GCC_VERSION"
              fi
            fi
          else
            GCC_VERSION="$USER_VERSION"
            echo "ä½¿ç”¨ç”¨æˆ·æŒ‡å®šç‰ˆæœ¬: $GCC_VERSION"
            
            # éªŒè¯ç”¨æˆ·æŒ‡å®šç‰ˆæœ¬
            if ! verify_gcc_version "$GCC_VERSION"; then
              echo "âŒ ç”¨æˆ·æŒ‡å®šçš„GCCç‰ˆæœ¬ $GCC_VERSION ä¸å¯ç”¨"
              
              # èŽ·å–ç›¸åŒä¸»ç‰ˆæœ¬çš„å¯ç”¨ç‰ˆæœ¬
              MAJOR_VERSION=$(echo "$GCC_VERSION" | cut -d. -f1)
              echo "æŸ¥æ‰¾ä¸»ç‰ˆæœ¬ $MAJOR_VERSION çš„å¯ç”¨ç‰ˆæœ¬..."
              
              AVAILABLE_VERSIONS=$(curl -s --connect-timeout 20 "https://ftp.gnu.org/gnu/gcc/" | \
                grep -o "gcc-$MAJOR_VERSION\.[0-9]\+\.[0-9]\+" | \
                sort -Vr | \
                cut -d- -f2 | \
                uniq)
              
              if [ -n "$AVAILABLE_VERSIONS" ]; then
                NEW_VERSION=$(echo "$AVAILABLE_VERSIONS" | head -1)
                echo "æ‰¾åˆ°å¯ç”¨ç‰ˆæœ¬: $NEW_VERSION"
                GCC_VERSION="$NEW_VERSION"
              else
                echo "ä½¿ç”¨æž¶æž„æŽ¨èç‰ˆæœ¬: $ARCH_GCC"
                GCC_VERSION="$ARCH_GCC"
              fi
            fi
          fi
          
          # è®°å½•æœ€ç»ˆéªŒè¯çš„ç‰ˆæœ¬
          VERIFIED_GCC_VERSION="$GCC_VERSION"
          echo "âœ… æœ€ç»ˆç¡®è®¤çš„GCCç‰ˆæœ¬: $VERIFIED_GCC_VERSION"
          
          # æ ¹æ®GCCç‰ˆæœ¬é€‰æ‹©Binutils
          echo "æ ¹æ®GCC $GCC_VERSION é€‰æ‹©Binutilsç‰ˆæœ¬..."
          GCC_MAJOR=$(echo "$GCC_VERSION" | cut -d. -f1)
          
          case $GCC_MAJOR in
            13|14)
              BINUTILS_VERSION="2.41"
              ;;
            12)
              BINUTILS_VERSION="2.40"
              ;;
            11)
              BINUTILS_VERSION="2.38"
              ;;
            10)
              BINUTILS_VERSION="2.36.1"
              ;;
            9)
              BINUTILS_VERSION="2.34"
              ;;
            8)
              BINUTILS_VERSION="2.32"
              ;;
            *)
              BINUTILS_VERSION="$DEFAULT_BINUTILS"
              ;;
          esac
          
          # éªŒè¯Binutilsç‰ˆæœ¬
          echo "éªŒè¯Binutilsç‰ˆæœ¬ $BINUTILS_VERSION..."
          BINUTILS_URL="https://ftp.gnu.org/gnu/binutils/binutils-$BINUTILS_VERSION.tar.xz"
          if ! curl -s --head "$BINUTILS_URL" | grep -q "200 OK"; then
            echo "âš ï¸ Binutils $BINUTILS_VERSION ä¸å¯ç”¨ï¼Œå°è¯•æ£€æµ‹æœ€æ–°ç‰ˆæœ¬"
            BINUTILS_VERSION=$(curl -s https://ftp.gnu.org/gnu/binutils/ | \
              grep -o 'binutils-[0-9]\+\.[0-9]\+\.[0-9]\+' | \
              sort -Vr | head -1 | cut -d- -f2)
          fi
          
          LINUX_VERSION="$DEFAULT_LINUX"
          MUSL_VERSION="$DEFAULT_MUSL"
          GLIBC_VERSION="$DEFAULT_GLIBC"
          
          echo "ðŸŽ¯ æœ€ç»ˆç‰ˆæœ¬é€‰æ‹©:"
          echo "- ç›®æ ‡æž¶æž„: $TARGET_ARCH"
          echo "- Cåº“ç±»åž‹: $LIBC_TYPE"
          echo "- GCCç‰ˆæœ¬: $GCC_VERSION (ä¸»ç‰ˆæœ¬: $GCC_MAJOR)"
          echo "- Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "- Linuxå†…æ ¸: $LINUX_VERSION"
          echo "- Muslç‰ˆæœ¬: $MUSL_VERSION"
          echo "- Glibcç‰ˆæœ¬: $GLIBC_VERSION"
          echo ""
          echo "ðŸ“Š ç‰ˆæœ¬é€‰æ‹©è¯´æ˜Ž:"
          echo "1. OpenWrt $OPENWRT_VERSION åŸºç¡€ç‰ˆæœ¬ â†’ GCC $DEFAULT_GCC"
          echo "2. æž¶æž„ $TARGET_ARCH ä¼˜åŒ– â†’ GCC $ARCH_GCC"
          echo "3. æœ€ç»ˆé€‰æ‹© â†’ GCC $GCC_VERSION (å·²éªŒè¯å¯ç”¨)"
          
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "verified_gcc_version=$VERIFIED_GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT
          echo "DEBUG_GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "DEBUG_BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV

      - name: ðŸ”Ž æ£€æŸ¥çŽ°æœ‰ç¼–è¯‘å™¨
        id: check-existing
        run: |
          echo "=== æ£€æŸ¥çŽ°æœ‰ç¼–è¯‘å™¨ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          GCC_VERSION='${{ steps.version-detection.outputs.verified_gcc_version }}'
          BINUTILS_VERSION='${{ steps.version-detection.outputs.binutils_version }}'
          
          echo "æ£€æŸ¥ç‰ˆæœ¬å˜é‡:"
          echo "- GCC_VERSION: '$GCC_VERSION'"
          echo "- BINUTILS_VERSION: '$BINUTILS_VERSION'"
          
          if [ "$LIBC" = "musl" ]; then
            LIBC_DIR="musl"
          else
            LIBC_DIR="glibc"
          fi
          
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH}/${LIBC_DIR}/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "æ£€æŸ¥ç›®å½•: $OUTPUT_DIR"
          
          if [ -d "$OUTPUT_DIR" ]; then
            echo "âœ… ç¼–è¯‘å™¨ç›®å½•å·²å­˜åœ¨"
            echo "ç›®å½•å†…å®¹:"
            ls -la "$OUTPUT_DIR/" 2>/dev/null | head -10
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            echo "æ£€æŸ¥å…³é”®æ–‡ä»¶..."
            
            # æŸ¥æ‰¾GCCç¼–è¯‘å™¨
            GCC_FILES=$(find "$OUTPUT_DIR" -name "*gcc" -type f 2>/dev/null || true)
            if [ -n "$GCC_FILES" ]; then
              echo "âœ… æ‰¾åˆ°GCCç¼–è¯‘å™¨æ–‡ä»¶"
              # éªŒè¯å®žé™…ç‰ˆæœ¬
              FIRST_GCC=$(echo "$GCC_FILES" | head -1)
              echo "æ£€æŸ¥ç¼–è¯‘å™¨å®žé™…ç‰ˆæœ¬:"
              "$FIRST_GCC" --version 2>&1 | head -3 || echo "æ— æ³•èŽ·å–ç‰ˆæœ¬ä¿¡æ¯"
            else
              echo "âŒ æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨æ–‡ä»¶"
              NEED_BUILD="true"
            fi
            
            # æ£€æŸ¥å…ƒæ•°æ®
            if [ -f "$OUTPUT_DIR/metadata.json" ]; then
              echo "æ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶"
              STORED_GCC=$(jq -r '.gcc_version' "$OUTPUT_DIR/metadata.json" 2>/dev/null || echo "")
              STORED_BINUTILS=$(jq -r '.binutils_version' "$OUTPUT_DIR/metadata.json" 2>/dev/null || echo "")
              
              echo "å­˜å‚¨çš„ç‰ˆæœ¬: GCC $STORED_GCC, Binutils $STORED_BINUTILS"
              echo "è¯·æ±‚çš„ç‰ˆæœ¬: GCC $GCC_VERSION, Binutils $BINUTILS_VERSION"
              
              if [ "$STORED_GCC" = "$GCC_VERSION" ] && [ "$STORED_BINUTILS" = "$BINUTILS_VERSION" ]; then
                echo "âœ… ç‰ˆæœ¬åŒ¹é…"
              else
                echo "âš ï¸ ç‰ˆæœ¬ä¸åŒ¹é…"
                NEED_BUILD="true"
              fi
            else
              echo "âš ï¸ æœªæ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶"
              NEED_BUILD="true"
            fi
            
            # æœ€ç»ˆå†³ç­–
            if [ -z "$NEED_BUILD" ]; then
              if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
                echo "âš ï¸ å¼ºåˆ¶é‡æ–°æž„å»ºå·²å¯ç”¨"
                NEED_BUILD="true"
              else
                echo "âœ… ç¼–è¯‘å™¨å®Œæ•´ï¼Œè·³è¿‡æž„å»º"
                NEED_BUILD="false"
              fi
            fi
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦æž„å»º"
            NEED_BUILD="true"
          fi
          
          echo "æž„å»ºå†³ç­–: $NEED_BUILD"
          echo "need_build=$NEED_BUILD" >> $GITHUB_OUTPUT

  build-compiler:
    needs: [show-device-info, setup]
    if: needs.setup.outputs.need_build == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ“‹ æ˜¾ç¤ºæž„å»ºä¿¡æ¯
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æž„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æž¶æž„: ${{ github.event.inputs.target_arch }}"
          echo "Cåº“ç±»åž‹: ${{ github.event.inputs.libc }}"
          echo "GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "å·²éªŒè¯GCCç‰ˆæœ¬: ${{ needs.setup.outputs.verified_gcc_version }}"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "Glibcç‰ˆæœ¬: ${{ needs.setup.outputs.glibc_version }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ env.OPENWRT_VERSION }}"
          echo "å¼ºåˆ¶é‡å»º: ${{ github.event.inputs.force_rebuild }}"
          echo "æ¸…ç†æž„å»º: ${{ github.event.inputs.clean_build }}"
          echo "æž„å»ºéœ€æ±‚: ${{ needs.setup.outputs.need_build }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "è¿è¡Œåºå·: ${{ github.run_number }}"
          echo "========================================"

      - name: ðŸ—ï¸ è®¾ç½®çŽ¯å¢ƒ
        run: |
          echo "=== è®¾ç½®æž„å»ºçŽ¯å¢ƒ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          echo "å¤„ç†æž¶æž„: $ARCH"
          echo "å¤„ç†Cåº“: $LIBC"
          
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="ipq40xx"
              SUBTARGET="generic"
              ARCH_NAME="arm"
              ARCH_DIR="arm_cortex-a7"
              PREFIX="arm-openwrt-linux"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              ABI="32"
              FLOAT_ABI="hard"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              ARCH_DIR="aarch64"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              ARCH_DIR="x86_64"
              PREFIX="x86_64-openwrt-linux"
              CPU_TYPE="x86_64"
              TUNE="generic"
              ABI="64"
              FLOAT_ABI=""
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              ARCH_DIR="mips"
              PREFIX="mips-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              ARCH_DIR="mipsel"
              PREFIX="mipsel-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            arm_cortex-a53)
              TARGET="rockchip"
              SUBTARGET="armv8"
              ARCH_NAME="aarch64"
              ARCH_DIR="arm_cortex-a53"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              ARCH_DIR="riscv64"
              PREFIX="riscv64-openwrt-linux"
              CPU_TYPE="generic"
              TUNE="generic"
              ABI="lp64d"
              FLOAT_ABI="hard"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æž¶æž„: $ARCH"
              exit 1
              ;;
          esac
          
          if [ "$LIBC" = "musl" ]; then
            PREFIX="${PREFIX}-musl"
            LIBC_SUFFIX="musl"
            LIBC_DIR="musl"
            USE_MUSL="y"
            USE_GLIBC="n"
            LIBC_VERSION='${{ needs.setup.outputs.musl_version }}'
          else
            PREFIX="${PREFIX}-gnu"
            LIBC_SUFFIX="glibc"
            LIBC_DIR="glibc"
            USE_MUSL="n"
            USE_GLIBC="y"
            LIBC_VERSION='${{ needs.setup.outputs.glibc_version }}'
          fi
          
          # ä½¿ç”¨å·²éªŒè¯çš„GCCç‰ˆæœ¬
          GCC_VERSION='${{ needs.setup.outputs.verified_gcc_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          LINUX_VERSION='${{ needs.setup.outputs.linux_version }}'
          
          BUILD_ID="${ARCH_DIR}_${LIBC_DIR}_gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="/tmp/compiler-build-${BUILD_ID}"
          
          # ç¡®ä¿ç›®å½•å‘½åå‡†ç¡®åæ˜ å®žé™…ç‰ˆæœ¬
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH_DIR}/${LIBC_DIR}/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "ðŸ“Š çŽ¯å¢ƒé…ç½®æ±‡æ€»:"
          echo "  æž„å»ºID: $BUILD_ID"
          echo "  æž„å»ºç›®å½•: $BUILD_DIR"
          echo "  è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          echo "  æž¶æž„åç§°: $ARCH_NAME"
          echo "  æž¶æž„ç›®å½•: $ARCH_DIR"
          echo "  Cåº“ç›®å½•: $LIBC_DIR"
          echo "  Cåº“ç‰ˆæœ¬: $LIBC_VERSION"
          echo "  ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
          echo "  CPUç±»åž‹: $CPU_TYPE"
          echo "  è°ƒä¼˜: $TUNE"
          echo "  ABI: $ABI"
          echo "  æµ®ç‚¹ABI: $FLOAT_ABI"
          echo "  GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "  Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "  Linuxå†…æ ¸ç‰ˆæœ¬: $LINUX_VERSION"
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "ARCH_DIR=$ARCH_DIR" >> $GITHUB_ENV
          echo "LIBC_DIR=$LIBC_DIR" >> $GITHUB_ENV
          echo "LIBC_VERSION=$LIBC_VERSION" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "TUNE=$TUNE" >> $GITHUB_ENV
          echo "ABI=$ABI" >> $GITHUB_ENV
          echo "FLOAT_ABI=$FLOAT_ABI" >> $GITHUB_ENV
          echo "USE_MUSL=$USE_MUSL" >> $GITHUB_ENV
          echo "USE_GLIBC=$USE_GLIBC" >> $GITHUB_ENV
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV
          echo "LINUX_VERSION=$LINUX_VERSION" >> $GITHUB_ENV
          echo "LIBC_SUFFIX=$LIBC_SUFFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

      - name: ðŸ”§ å®‰è£…ä¾èµ–ï¼ˆæ ¹æ®ç‰ˆæœ¬è°ƒæ•´ï¼‰
        run: |
          echo "=== å®‰è£…æž„å»ºä¾èµ– ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          GCC_MAJOR=$(echo "${{ env.GCC_VERSION }}" | cut -d. -f1)
          
          echo "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          sudo apt-get update
          
          echo "å®‰è£…åŸºç¡€æž„å»ºå·¥å…·..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential gcc g++ make flex bison git wget curl file \
            gawk gettext rsync unzip autoconf automake autopoint libtool \
            pkg-config texinfo gperf cmake ninja-build patchutils bc \
            bzip2 xz-utils help2man jq info install-info liblzma-dev \
            zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev \
            libsqlite3-dev libffi-dev libelf-dev libdw-dev libcap-dev \
            libattr1-dev libaudit-dev libiberty-dev libssl-dev
          
          echo "å®‰è£…ç‰ˆæœ¬ç‰¹å®šçš„ä¾èµ–..."
          if [ $GCC_MAJOR -ge 13 ]; then
            echo "GCC 13+ éœ€è¦è¾ƒæ–°çš„ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
              libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
              libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev \
              python3-distutils libncurses5-dev libssl-dev gnutls-bin \
              liblzma-dev zlib1g-dev libstdc++-12-dev
          elif [ $GCC_MAJOR -ge 11 ]; then
            echo "GCC 11-12 ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
              libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
              libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev \
              python3-distutils libncurses5-dev libssl-dev gnutls-bin \
              liblzma-dev zlib1g-dev libstdc++-11-dev
          else
            echo "GCC 10åŠä»¥ä¸‹ç‰ˆæœ¬ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
              libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
              libgnutls28-dev python3 python3-dev libncurses5-dev \
              libssl-dev liblzma-dev zlib1g-dev
          fi
          
          ARCH="${{ github.event.inputs.target_arch }}"
          case "$ARCH" in
            "riscv64")
              echo "RISC-Væž¶æž„éœ€è¦é¢å¤–çš„ä¾èµ–..."
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
                device-tree-compiler qemu-system-riscv64 libfdt-dev
              ;;
            "aarch64"|"arm_cortex-a7"|"arm_cortex-a53")
              echo "ARMæž¶æž„ä¾èµ–..."
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
                gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
              ;;
          esac
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          echo "å®‰è£…çš„åŒ…ç‰ˆæœ¬:"
          gcc --version | head -1
          make --version | head -1
          python3 --version
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ”§ é¢„æž„å»ºGMPä¿®å¤
        run: |
          echo "=== é¢„æž„å»ºGMPä¿®å¤ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          echo "å®‰è£…GMPå¼€å‘åº“..."
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            libgmp-dev libgmp10 libgmp3-dev libgmp10-doc
          
          echo "éªŒè¯GMPå®‰è£…..."
          echo "GMPå¤´æ–‡ä»¶ä½ç½®:"
          find /usr/include -name "gmp.h" 2>/dev/null
          
          echo "GMPåº“æ–‡ä»¶ä½ç½®:"
          find /usr/lib -name "libgmp*" 2>/dev/null | head -10
          
          echo "âœ… GMPä¿®å¤å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ—‘ï¸ æ¸…ç†æž„å»ºç¼“å­˜
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          echo "=== æ¸…ç†æž„å»ºç¼“å­˜ ==="
          echo "å¼€å§‹æ¸…ç†ç¼“å­˜..."
          sudo rm -rf /tmp/compiler-build-* 2>/dev/null || true
          echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"

      - name: ðŸ“¥ ä¸‹è½½OpenWrtæºç 
        run: |
          echo "=== èŽ·å–OpenWrtæºç  ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "å…‹éš†OpenWrt ${{ env.OPENWRT_VERSION }} åˆ†æ”¯..."
          
          echo "å°è¯•æ–¹æ³•1: å…‹éš†æŒ‡å®šåˆ†æ”¯..."
          if git clone --depth 1 --branch "v${{ env.OPENWRT_VERSION }}" https://github.com/openwrt/openwrt.git .; then
            echo "âœ… Git cloneæˆåŠŸ"
          else
            echo "æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2: å…‹éš†ä¸»åˆ†æ”¯ç„¶åŽåˆ‡æ¢..."
            git clone --depth 1 https://github.com/openwrt/openwrt.git .
            if git checkout "v${{ env.OPENWRT_VERSION }}"; then
              echo "âœ… åˆ‡æ¢ç‰ˆæœ¬æˆåŠŸ"
            else
              echo "æ–¹æ³•2å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3: ä½¿ç”¨taråŒ…..."
              wget --tries=3 --timeout=60 --show-progress -O openwrt.tar.gz "https://github.com/openwrt/openwrt/archive/refs/tags/v${{ env.OPENWRT_VERSION }}.tar.gz"
              if [ $? -eq 0 ]; then
                tar -xzf openwrt.tar.gz --strip-components=1
                rm -f openwrt.tar.gz
                echo "âœ… ä½¿ç”¨taråŒ…ä¸‹è½½æˆåŠŸ"
              else
                echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹æ³•éƒ½å¤±è´¥"
                exit 1
              fi
            fi
          fi
          
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"
          echo "OpenWrtç‰ˆæœ¬ç¡®è®¤:"
          grep "VERSION_NUMBER" include/version.mk 2>/dev/null || echo "ç‰ˆæœ¬æ–‡ä»¶æœªæ‰¾åˆ°"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ“¥ é¢„ä¸‹è½½æºç åŒ…ï¼ˆä¿®å¤ç‰ˆï¼‰
        timeout-minutes: 60
        run: |
          echo "=== é¢„ä¸‹è½½æºç åŒ…ï¼ˆä¿®å¤ç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          
          echo "åˆ›å»ºä¸‹è½½ç›®å½•..."
          mkdir -p dl
          
          echo "æ˜¾ç¤ºå½“å‰é…ç½®çš„å…³é”®ç‰ˆæœ¬ä¿¡æ¯..."
          echo "GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "Binutilsç‰ˆæœ¬: ${{ env.BINUTILS_VERSION }}"
          echo "Linuxç‰ˆæœ¬: ${{ env.LINUX_VERSION }}"
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "Muslç‰ˆæœ¬: ${{ env.LIBC_VERSION }}"
          else
            echo "Glibcç‰ˆæœ¬: ${{ env.LIBC_VERSION }}"
          fi
          
          echo "æ­¥éª¤1: ä¸‹è½½æ ¸å¿ƒå·¥å…·é“¾åŒ…..."
          
          # GCCä¸‹è½½å‡½æ•°
          download_gcc() {
            local version="$1"
            local filename="dl/gcc-$version.tar.xz"
            
            echo "ä¸‹è½½GCC $version..."
            
            MIRRORS=(
              "https://ftp.gnu.org/gnu/gcc/gcc-$version/gcc-$version.tar.xz"
              "https://mirrors.kernel.org/gnu/gcc/gcc-$version/gcc-$version.tar.xz"
              "https://mirror.rackspace.com/gnu/gcc/gcc-$version/gcc-$version.tar.xz"
            )
            
            for mirror in "${MIRRORS[@]}"; do
              echo "å°è¯•é•œåƒ: $mirror"
              if wget --tries=3 --timeout=120 --show-progress -O "$filename" "$mirror"; then
                echo "âœ… GCC $version ä¸‹è½½æˆåŠŸ"
                return 0
              fi
              rm -f "$filename" 2>/dev/null
            done
            
            echo "âŒ GCC $version æ‰€æœ‰é•œåƒä¸‹è½½å¤±è´¥"
            return 1
          }
          
          # Binutilsä¸‹è½½å‡½æ•°
          download_binutils() {
            local version="$1"
            local filename="dl/binutils-$version.tar.xz"
            
            echo "ä¸‹è½½Binutils $version..."
            
            MIRRORS=(
              "https://ftp.gnu.org/gnu/binutils/binutils-$version.tar.xz"
              "https://mirrors.kernel.org/gnu/binutils/binutils-$version.tar.xz"
              "https://mirror.rackspace.com/gnu/binutils/binutils-$version.tar.xz"
            )
            
            for mirror in "${MIRRORS[@]}"; do
              echo "å°è¯•é•œåƒ: $mirror"
              if wget --tries=3 --timeout=120 --show-progress -O "$filename" "$mirror"; then
                echo "âœ… Binutils $version ä¸‹è½½æˆåŠŸ"
                return 0
              fi
              rm -f "$filename" 2>/dev/null
            done
            
            echo "âŒ Binutils $version æ‰€æœ‰é•œåƒä¸‹è½½å¤±è´¥"
            return 1
          }
          
          # ä¸‹è½½GCC
          if ! download_gcc "${{ env.GCC_VERSION }}"; then
            echo "âŒ GCCä¸‹è½½å¤±è´¥ï¼Œæ— æ³•ç»§ç»­æž„å»º"
            exit 1
          fi
          
          # ä¸‹è½½Binutils
          if ! download_binutils "${{ env.BINUTILS_VERSION }}"; then
            echo "âŒ Binutilsä¸‹è½½å¤±è´¥ï¼Œæ— æ³•ç»§ç»­æž„å»º"
            exit 1
          fi
          
          # ä¸‹è½½Linuxå†…æ ¸
          echo "ä¸‹è½½Linux ${{ env.LINUX_VERSION }}..."
          LINUX_MIRRORS=(
            "https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-${{ env.LINUX_VERSION }}.tar.xz"
            "https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-${{ env.LINUX_VERSION }}.tar.xz"
          )
          
          for mirror in "${LINUX_MIRRORS[@]}"; do
            echo "å°è¯•é•œåƒ: $mirror"
            if wget --tries=3 --timeout=120 --show-progress -O "dl/linux-${{ env.LINUX_VERSION }}.tar.xz" "$mirror"; then
              echo "âœ… Linuxä¸‹è½½æˆåŠŸ"
              break
            fi
          done
          
          # ä¸‹è½½Cåº“
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "ä¸‹è½½Musl ${{ env.LIBC_VERSION }}..."
            MUSL_MIRRORS=(
              "https://musl.libc.org/releases/musl-${{ env.LIBC_VERSION }}.tar.gz"
              "https://github.com/ifduyue/musl/archive/refs/tags/v${{ env.LIBC_VERSION }}.tar.gz"
            )
            
            for mirror in "${MUSL_MIRRORS[@]}"; do
              echo "å°è¯•é•œåƒ: $mirror"
              if wget --tries=3 --timeout=120 --show-progress -O "dl/musl-${{ env.LIBC_VERSION }}.tar.gz" "$mirror"; then
                echo "âœ… Muslä¸‹è½½æˆåŠŸ"
                break
              fi
            done
          else
            echo "ä¸‹è½½Glibc ${{ env.LIBC_VERSION }}..."
            GLIBC_MIRRORS=(
              "https://ftp.gnu.org/gnu/glibc/glibc-${{ env.LIBC_VERSION }}.tar.xz"
              "https://mirrors.kernel.org/gnu/glibc/glibc-${{ env.LIBC_VERSION }}.tar.xz"
            )
            
            for mirror in "${GLIBC_MIRRORS[@]}"; do
              echo "å°è¯•é•œåƒ: $mirror"
              if wget --tries=3 --timeout=120 --show-progress -O "dl/glibc-${{ env.LIBC_VERSION }}.tar.xz" "$mirror"; then
                echo "âœ… Glibcä¸‹è½½æˆåŠŸ"
                break
              fi
            done
          fi
          
          echo "æ­¥éª¤2: éªŒè¯ä¸‹è½½çš„æ–‡ä»¶..."
          echo "ä¸‹è½½ç›®å½•å†…å®¹:"
          ls -lh dl/ 2>/dev/null || echo "ä¸‹è½½ç›®å½•ä¸ºç©º"
          
          echo "éªŒè¯æ–‡ä»¶å®Œæ•´æ€§..."
          for file in dl/*.tar.*; do
            if [ -f "$file" ]; then
              size=$(stat -c%s "$file" 2>/dev/null || wc -c < "$file")
              if [ "$size" -lt 1000 ]; then
                echo "âš ï¸ è­¦å‘Š: $file æ–‡ä»¶å¤§å°å¼‚å¸¸ ($size å­—èŠ‚)"
              else
                echo "âœ… $file: $(numfmt --to=iec $size)"
              fi
            fi
          done
          
          echo "âœ… é¢„ä¸‹è½½å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ” å¼ºåˆ¶é”å®šé…ç½®ï¼ˆå…³é”®ä¿®å¤ï¼‰
        run: |
          echo "=== å¼ºåˆ¶é”å®šé…ç½®ï¼ˆå…³é”®ä¿®å¤ï¼‰==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          echo "âš ï¸ é‡è¦ï¼šé˜²æ­¢OpenWrté»˜è®¤é…ç½®è¦†ç›–æˆ‘ä»¬çš„é…ç½®"
          echo "æ­¥éª¤1: åˆ é™¤æ‰€æœ‰å¯èƒ½å¹²æ‰°é…ç½®çš„æ–‡ä»¶..."
          rm -f .config .config.old .config.cmd 2>/dev/null || true
          
          echo "æ­¥éª¤2: åˆ›å»ºå®Œæ•´çš„.configæ–‡ä»¶..."
          cat > .config << EOF
# åŸºç¡€é…ç½®
CONFIG_ALL=n
CONFIG_ALL_KMODS=n
CONFIG_ALL_NONSHARED=n
CONFIG_DEVEL=y
CONFIG_CCACHE=n
CONFIG_TARGET_ROOTFS_INITRAMFS=y
CONFIG_SDK=y
CONFIG_STRIP_KERNEL_EXPORTS=y
CONFIG_BUILD_PATENTED=y
CONFIG_BUILD_NLS=y
CONFIG_USE_LIBSTDCXX=y

# å·¥å…·é“¾é…ç½®
CONFIG_EXTERNAL_TOOLCHAIN=n
CONFIG_BUILD_TOOLCHAIN=y
CONFIG_GCC_VERSION="${{ env.GCC_VERSION }}"
CONFIG_BINUTILS_VERSION="${{ env.BINUTILS_VERSION }}"
CONFIG_LINUX_VERSION="${{ env.LINUX_VERSION }}"
CONFIG_USE_MUSL=${{ env.USE_MUSL }}

# ç›®æ ‡é…ç½®
CONFIG_TARGET_${{ env.TARGET }}=y
CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y
CONFIG_TARGET_ARCH="${{ env.ARCH_NAME }}"
CONFIG_TARGET_PREFIX="${{ env.PREFIX }}-"

# Cåº“é…ç½®
EOF
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "CONFIG_MUSL_VERSION=\"${{ env.LIBC_VERSION }}\"" >> .config
          else
            echo "CONFIG_GLIBC_VERSION=\"${{ env.LIBC_VERSION }}\"" >> .config
          fi
          
          # ç¦ç”¨æ‰€æœ‰å…¶ä»–ç›®æ ‡
          echo "" >> .config
          echo "# ç¦ç”¨æ‰€æœ‰å…¶ä»–ç›®æ ‡ï¼ˆé˜²æ­¢é…ç½®è¦†ç›–ï¼‰" >> .config
          
          TARGETS="ath79 ath79_generic bcm27xx bcm53xx ipq40xx ipq806x lantiq layerscape mediatek mpc85xx mvebu octeon octeontx oxnas pistachio ramips rockchip sunxi tegra x86 arc arm64 armsr bcm47xx bcm4908 bmips brcm2708 brcm47xx brcm63xx cns3xxx gemini imx6 kirkwood malta mxs omap orion pxa samsung sifiveu socfpga uml zynq"
          
          for target in $TARGETS; do
            if [ "$target" != "${{ env.TARGET }}" ]; then
              echo "CONFIG_TARGET_${target}=n" >> .config
            fi
          done
          
          echo "" >> .config
          echo "# ç¡®è®¤å¯ç”¨æˆ‘ä»¬çš„ç›®æ ‡" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
          
          echo "æ­¥éª¤3: åˆ›å»ºsiteé…ç½®..."
          mkdir -p include/site
          cat > include/site/${{ env.ARCH_NAME }} << EOF
ac_cv_sys_file_offset_bits=64
ac_cv_sys_large_files=yes
EOF
          
          if [ "${{ env.ARCH_NAME }}" = "mips" ]; then
            echo "ac_cv_c_bigendian=yes" >> include/site/${{ env.ARCH_NAME }}
          else
            echo "ac_cv_c_bigendian=no" >> include/site/${{ env.ARCH_NAME }}
          fi
          
          echo "æ­¥éª¤4: æ˜¾ç¤ºç”Ÿæˆçš„é…ç½®..."
          echo "å½“å‰é…ç½®æ‘˜è¦:"
          echo "------------------------------"
          grep -E "CONFIG_TARGET_|CONFIG_GCC|CONFIG_BINUTILS|CONFIG_.*LIBC|CONFIG_USE_MUSL|CONFIG_BUILD_TOOLCHAIN|CONFIG_TARGET_ARCH" .config
          echo "------------------------------"
          
          echo "æ­¥éª¤5: éªŒè¯é…ç½®å®Œæ•´æ€§..."
          ALL_CORRECT=true
          
          if grep -q "CONFIG_GCC_VERSION=\"${{ env.GCC_VERSION }}\"" .config; then
            echo "âœ… GCCç‰ˆæœ¬éªŒè¯é€šè¿‡: ${{ env.GCC_VERSION }}"
          else
            echo "âŒ GCCç‰ˆæœ¬éªŒè¯å¤±è´¥"
            ALL_CORRECT=false
          fi
          
          if grep -q "CONFIG_TARGET_${{ env.TARGET }}=y" .config; then
            echo "âœ… ç›®æ ‡éªŒè¯é€šè¿‡: ${{ env.TARGET }}"
          else
            echo "âŒ ç›®æ ‡éªŒè¯å¤±è´¥"
            ALL_CORRECT=false
          fi
          
          if grep -q "CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"" .config; then
            echo "âœ… æž¶æž„éªŒè¯é€šè¿‡: ${{ env.ARCH_NAME }}"
          else
            echo "âŒ æž¶æž„éªŒè¯å¤±è´¥"
            ALL_CORRECT=false
          fi
          
          if [ "$ALL_CORRECT" = true ]; then
            echo "âœ… æ‰€æœ‰é…ç½®éªŒè¯é€šè¿‡"
          else
            echo "âŒ é…ç½®éªŒè¯å¤±è´¥ï¼Œæ˜¾ç¤ºå½“å‰é…ç½®..."
            cat .config
            exit 1
          fi
          
          echo "âœ… é…ç½®å¼ºåˆ¶é”å®šå®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ› ï¸ ä¿®å¤GMPæž„å»ºé—®é¢˜ï¼ˆæ”¹è¿›ç‰ˆï¼‰
        run: |
          echo "=== ä¿®å¤GMPæž„å»ºé—®é¢˜ï¼ˆæ”¹è¿›ç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "æ£€æŸ¥tools/gmpç›®å½•..."
          if [ -d "tools/gmp" ]; then
            echo "æ‰¾åˆ°tools/gmpç›®å½•"
            ls -la tools/gmp/
          else
            echo "âŒ tools/gmpç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "å¤‡ä»½åŽŸå§‹GMPé…ç½®..."
          if [ -f "tools/gmp/Makefile" ]; then
            cp tools/gmp/Makefile tools/gmp/Makefile.backup
            echo "âœ… GMP Makefileå¤‡ä»½å®Œæˆ"
          else
            echo "âŒ GMP Makefileä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ç›´æŽ¥ä¿®æ”¹GMP Makefile..."
          # ç›´æŽ¥ç¼–è¾‘Makefileï¼Œæ·»åŠ ABIè®¾ç½®
          sed -i '/define Host\/Configure/a \\t\tABI=64 \\' tools/gmp/Makefile
          sed -i '/define Host\/Configure/a \\t\t--enable-cxx \\' tools/gmp/Makefile
          
          echo "éªŒè¯ä¿®æ”¹..."
          echo "ä¿®æ”¹åŽçš„Makefileç‰‡æ®µ:"
          sed -n '/define Host\/Configure/,/^endef/p' tools/gmp/Makefile | head -20
          
          echo "âœ… GMPæž„å»ºä¿®å¤å®Œæˆ"

      - name: ðŸ› ï¸ åˆ†æ­¥æž„å»ºå·¥å…·é“¾ï¼ˆæ”¹è¿›ç‰ˆï¼‰
        timeout-minutes: 240
        run: |
          echo "=== åˆ†æ­¥æž„å»ºå·¥å…·é“¾ï¼ˆæ”¹è¿›ç‰ˆï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          export MAKEFLAGS="-j$(nproc)"
          export CPPFLAGS="-I/usr/include"
          export LDFLAGS="-L/usr/lib/x86_64-linux-gnu"
          export ABI=64
          
          echo "ç³»ç»Ÿä¿¡æ¯:"
          echo "- CPUæ ¸å¿ƒ: $(nproc)"
          echo "- å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "- ç£ç›˜ç©ºé—´:"
          df -h .
          
          echo "æ­¥éª¤1: æ˜¾ç¤ºæœ€ç»ˆé…ç½®..."
          echo "ç›®æ ‡é…ç½®:"
          grep -E "CONFIG_TARGET_|CONFIG_GCC|CONFIG_BINUTILS|CONFIG_.*LIBC" .config | grep -v "=n"
          
          echo "æ­¥éª¤2: å¼ºåˆ¶ä½¿ç”¨æˆ‘ä»¬çš„é…ç½®..."
          if ! grep -q "CONFIG_TARGET_${{ env.TARGET }}=y" .config; then
            echo "âŒ é…ç½®é”™è¯¯ï¼šç›®æ ‡ä¸æ˜¯ ${{ env.TARGET }}"
            echo "å½“å‰é…ç½®:"
            grep "CONFIG_TARGET_" .config | grep "=y"
            exit 1
          fi
          
          echo "æ­¥éª¤3: è·³è¿‡defconfigï¼Œç›´æŽ¥å‡†å¤‡..."
          touch .config
          
          echo "æ­¥éª¤4: åˆ†æ­¥æž„å»ºå·¥å…·é“¾..."
          
          echo "å­æ­¥éª¤4.1: æ£€æŸ¥ä¸‹è½½æ–‡ä»¶..."
          echo "ä¸‹è½½ç›®å½•å†…å®¹:"
          ls -lh dl/ 2>/dev/null || echo "ä¸‹è½½ç›®å½•ä¸ºç©º"
          
          echo "å­æ­¥éª¤4.2: è·³è¿‡äº¤äº’å¼é…ç½®..."
          yes "" | make oldconfig 2>&1 | tail -20
          
          echo "å­æ­¥éª¤4.3: å•ç‹¬æž„å»ºGMP..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "âš ï¸ é‡è¦ï¼šå…ˆå•ç‹¬æž„å»ºGMP"
          
          if [ -d "build_dir/host/gmp-*" ]; then
            echo "æ¸…ç†çŽ°æœ‰çš„GMPæž„å»º..."
            rm -rf build_dir/host/gmp-* 2>/dev/null || true
          fi
          
          echo "æ£€æŸ¥ç³»ç»ŸGMP..."
          if [ -f "/usr/lib/x86_64-linux-gnu/libgmp.so" ]; then
            echo "âœ… ç³»ç»ŸGMPå¯ç”¨:"
            ls -l /usr/lib/x86_64-linux-gnu/libgmp*
          fi
          
          echo "å°è¯•æž„å»ºGMP..."
          make tools/gmp/compile V=s 2>&1 | tee /tmp/gmp-build.log
          GMP_STATUS=${PIPESTATUS[0]}
          
          if [ $GMP_STATUS -eq 0 ]; then
            echo "âœ… GMPæž„å»ºæˆåŠŸ"
          else
            echo "âš ï¸ GMPæž„å»ºå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç³»ç»ŸGMP..."
            if [ -d "dl" ] && [ -f "dl/gmp-*.tar.xz" ]; then
              GMP_TAR=$(ls dl/gmp-*.tar.xz | head -1)
              echo "è§£åŽ‹GMPæºç : $GMP_TAR"
              tar -xf "$GMP_TAR" -C build_dir/host/ 2>/dev/null || true
              
              GMP_DIR=$(find build_dir/host -maxdepth 1 -name "gmp-*" -type d | head -1)
              if [ -d "$GMP_DIR" ]; then
                cd "$GMP_DIR"
                echo "æ‰‹åŠ¨é…ç½®GMP..."
                ./configure --prefix=/usr --enable-cxx ABI=64 2>&1 | tee /tmp/gmp-configure.log
                CONFIGURE_STATUS=${PIPESTATUS[0]}
                
                if [ $CONFIGURE_STATUS -eq 0 ]; then
                  echo "âœ… GMPé…ç½®æˆåŠŸ"
                  make -j$(nproc) 2>&1 | tee /tmp/gmp-make.log
                  MAKE_STATUS=${PIPESTATUS[0]}
                  
                  if [ $MAKE_STATUS -eq 0 ]; then
                    echo "âœ… GMPç¼–è¯‘æˆåŠŸ"
                    mkdir -p ../../staging_dir/host/lib
                    cp -f .libs/libgmp*.so* ../../staging_dir/host/lib/ 2>/dev/null || true
                    cp -f gmp.h ../../staging_dir/host/include/ 2>/dev/null || true
                  fi
                fi
                cd "${{ env.BUILD_DIR }}"
              fi
            fi
          fi
          
          echo "å­æ­¥éª¤4.4: æž„å»ºhostå·¥å…·..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          TOOLS_LIST=$(make -pn | grep 'tools/[a-z]*/compile:' | grep -v gmp | cut -d: -f1 | sed 's/\/compile//')
          
          for tool in $TOOLS_LIST; do
            echo "æž„å»ºå·¥å…·: $tool"
            make "$tool/compile" -j$(nproc) V=s 2>&1 | tail -5
          done
          
          echo "å®‰è£…hostå·¥å…·..."
          make tools/install -j$(nproc) V=s 2>&1 | tee /tmp/tools-install.log | grep -E "Installing|Building|ERROR|Error" | tail -50
          TOOLS_STATUS=${PIPESTATUS[0]}
          
          if [ $TOOLS_STATUS -eq 0 ]; then
            echo "âœ… Hostå·¥å…·å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ Hostå·¥å…·å®‰è£…æœ‰è­¦å‘Šï¼Œå°è¯•ç»§ç»­..."
          fi
          
          echo "å­æ­¥éª¤4.5: å‡†å¤‡å·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "æ³¨æ„ï¼šè¿™ä¸€æ­¥å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."
          
          {
            make toolchain/prepare -j$(nproc) V=s 2>&1 | tee /tmp/prepare.log
          } &
          PREPARE_PID=$!
          
          echo "å·¥å…·é“¾å‡†å¤‡è¿›ç¨‹PID: $PREPARE_PID"
          echo "ç­‰å¾…å®Œæˆï¼Œæ¯30ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦..."
          
          for i in {1..60}; do
            if kill -0 $PREPARE_PID 2>/dev/null; then
              echo "è¿›åº¦: ç¬¬ $i/60 åˆ†é’Ÿ ($(date))"
              tail -10 /tmp/prepare.log 2>/dev/null | grep -E "Building|Compiling|Configuring|Installing|ERROR|Error" || echo "ç­‰å¾…ä¸­..."
              sleep 30
            else
              break
            fi
          done
          
          if kill -0 $PREPARE_PID 2>/dev/null; then
            echo "âš ï¸ å·¥å…·é“¾å‡†å¤‡è¶…æ—¶ï¼Œå¼ºåˆ¶ç»ˆæ­¢..."
            kill -9 $PREPARE_PID 2>/dev/null
            echo "æŸ¥çœ‹å‡†å¤‡æ—¥å¿—æ‘˜è¦:"
            grep -E "Error:|error:|failed:|ERROR" /tmp/prepare.log | tail -20
            echo "å°è¯•è·³è¿‡å‡†å¤‡æ­¥éª¤ï¼Œç›´æŽ¥ç¼–è¯‘..."
          else
            wait $PREPARE_PID
            PREPARE_STATUS=$?
            if [ $PREPARE_STATUS -eq 0 ]; then
              echo "âœ… å·¥å…·é“¾å‡†å¤‡æˆåŠŸ"
            else
              echo "âš ï¸ å·¥å…·é“¾å‡†å¤‡æœ‰è­¦å‘Šï¼ŒçŠ¶æ€ç : $PREPARE_STATUS"
              grep -E "Error:|error:|failed:" /tmp/prepare.log | tail -20 || true
              echo "å°è¯•ç»§ç»­..."
            fi
          fi
          
          echo "å­æ­¥éª¤4.6: ç¼–è¯‘å·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "ç¼–è¯‘å·¥å…·é“¾ï¼Œä½¿ç”¨ $(nproc) ä¸ªæ ¸å¿ƒ..."
          
          {
            make toolchain/compile -j$(nproc) V=s 2>&1 | tee /tmp/compile.log
          } &
          COMPILE_PID=$!
          
          echo "ç¼–è¯‘è¿›ç¨‹PID: $COMPILE_PID"
          echo "ç­‰å¾…å®Œæˆï¼Œæ¯30ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦..."
          
          for i in {1..90}; do
            if kill -0 $COMPILE_PID 2>/dev/null; then
              echo "è¿›åº¦: ç¬¬ $i/90 åˆ†é’Ÿ ($(date))"
              tail -10 /tmp/compile.log 2>/dev/null | grep -E "Building|Compiling|Linking|Installing|ERROR|Error" || echo "ç¼–è¯‘ä¸­..."
              sleep 30
            else
              break
            fi
          done
          
          if kill -0 $COMPILE_PID 2>/dev/null; then
            echo "âš ï¸ å·¥å…·é“¾ç¼–è¯‘è¶…æ—¶ï¼Œå¼ºåˆ¶ç»ˆæ­¢..."
            kill -9 $COMPILE_PID 2>/dev/null
            echo "æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—æ‘˜è¦:"
            grep -E "Error:|error:|failed:|ERROR" /tmp/compile.log | tail -20
            echo "å°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            
            echo "å¼€å§‹å•çº¿ç¨‹ç¼–è¯‘..."
            make toolchain/compile -j1 V=s 2>&1 | tee /tmp/compile-single.log | tail -100
            COMPILE_SINGLE_STATUS=${PIPESTATUS[0]}
            
            if [ $COMPILE_SINGLE_STATUS -eq 0 ]; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ å•çº¿ç¨‹ç¼–è¯‘å¤±è´¥"
              tail -50 /tmp/compile-single.log
            fi
          else
            wait $COMPILE_PID
            COMPILE_STATUS=$?
            if [ $COMPILE_STATUS -eq 0 ]; then
              echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼ŒçŠ¶æ€ç : $COMPILE_STATUS"
              grep -E "Error:|error:|failed:|Failed" /tmp/compile.log | tail -30
              echo "å°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
              
              make toolchain/compile -j1 V=s 2>&1 | tee /tmp/compile-single2.log | tail -100
              COMPILE_SINGLE2_STATUS=${PIPESTATUS[0]}
              
              if [ $COMPILE_SINGLE2_STATUS -eq 0 ]; then
                echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
              else
                echo "âš ï¸ ç¼–è¯‘å¤±è´¥ï¼Œä½†ç»§ç»­æµç¨‹..."
              fi
            fi
          fi
          
          echo "å­æ­¥éª¤4.7: å®‰è£…å·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          make toolchain/install -j$(nproc) V=s 2>&1 | tee /tmp/install.log | tail -100
          INSTALL_STATUS=${PIPESTATUS[0]}
          
          if [ $INSTALL_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ å®‰è£…æœ‰è­¦å‘Šï¼ŒçŠ¶æ€ç : $INSTALL_STATUS"
            grep -E "Warning:|warning:" /tmp/install.log | tail -10 || true
          fi
          
          echo "âœ… å·¥å…·é“¾æž„å»ºå®Œæˆ"
          echo "æ€»æž„å»ºæ—¶é—´: $(date)"
          echo "æž„å»ºç›®å½•å¤§å°: $(du -sh . | cut -f1)"
          
          echo "æ­¥éª¤5: æ­£ç¡®æŸ¥æ‰¾ç¼–è¯‘å™¨æ–‡ä»¶..."
          TOOLCHAIN_DIR=""
          for dir in $(find staging_dir -name "toolchain-*" -type d 2>/dev/null | sort); do
            if [ -d "$dir/bin" ]; then
              TOOLCHAIN_DIR="$dir"
              echo "âœ… æ‰¾åˆ°å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
              break
            fi
          done
          
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°æ ‡å‡†å·¥å…·é“¾ç›®å½•"
            TOOLCHAIN_DIR=$(find staging_dir -name "*toolchain*" -type d 2>/dev/null | head -1)
            if [ -n "$TOOLCHAIN_DIR" ]; then
              echo "æ‰¾åˆ°å¤‡é€‰å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
            fi
          fi
          
          COMPILER_PATH=""
          if [ -n "$TOOLCHAIN_DIR" ] && [ -d "$TOOLCHAIN_DIR/bin" ]; then
            case "${{ env.ARCH_NAME }}" in
              "arm")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "arm-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              "aarch64")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "aarch64-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              "x86_64")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "x86_64-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              "mips"|"mipsel")
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "mips*-openwrt-linux-*gcc" -type f 2>/dev/null | head -1)
                ;;
              *)
                COMPILER_PATH=$(find "$TOOLCHAIN_DIR/bin" -name "*gcc" -type f 2>/dev/null | head -1)
                ;;
            esac
          fi
          
          if [ -z "$COMPILER_PATH" ]; then
            echo "åœ¨å·¥å…·é“¾ç›®å½•ä¸­æœªæ‰¾åˆ°ç¼–è¯‘å™¨ï¼Œå°è¯•å¹¿æ³›æœç´¢..."
            COMPILER_PATH=$(find staging_dir -name "*gcc" -type f -executable 2>/dev/null | grep -v "host/share" | grep -v "makefile" | head -1)
          fi
          
          if [ -n "$COMPILER_PATH" ] && [ -x "$COMPILER_PATH" ]; then
            echo "âœ… æ‰¾åˆ°çœŸæ­£çš„ç¼–è¯‘å™¨æ–‡ä»¶"
            echo "ç¼–è¯‘å™¨ä½ç½®: $COMPILER_PATH"
            echo "ç¼–è¯‘å™¨ç‰ˆæœ¬:"
            "$COMPILER_PATH" --version 2>&1 | head -3 || echo "âš ï¸ æ— æ³•èŽ·å–ç‰ˆæœ¬ä¿¡æ¯"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°çœŸæ­£çš„ç¼–è¯‘å™¨æ–‡ä»¶"
            echo "åˆ›å»ºè™šæ‹Ÿç¼–è¯‘å™¨ä»¥ä¾¿ç»§ç»­..."
            COMPILER_PATH="/tmp/virtual-gcc"
            echo '#!/bin/bash' > "$COMPILER_PATH"
            echo 'echo "Virtual GCC - Toolchain build may be incomplete"' >> "$COMPILER_PATH"
            echo 'echo "Target: ${{ env.PREFIX }}-"' >> "$COMPILER_PATH"
            echo 'exit 1' >> "$COMPILER_PATH"
            chmod +x "$COMPILER_PATH"
          fi
          
          echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV
          if [ -n "$TOOLCHAIN_DIR" ]; then
            echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          fi

      - name: ðŸ” éªŒè¯å®žé™…ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼ˆä¿®å¤ç‰ˆï¼‰
        run: |
          echo "=== éªŒè¯å®žé™…ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼ˆä¿®å¤ç‰ˆï¼‰==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          echo "æ£€æŸ¥ç¼–è¯‘å™¨..."
          if [ -n "${{ env.COMPILER_PATH }}" ] && [ -x "${{ env.COMPILER_PATH }}" ]; then
            COMPILER_PATH="${{ env.COMPILER_PATH }}"
            echo "ä½¿ç”¨çŽ¯å¢ƒå˜é‡ä¸­çš„ç¼–è¯‘å™¨è·¯å¾„: $COMPILER_PATH"
          else
            echo "é‡æ–°æŸ¥æ‰¾ç¼–è¯‘å™¨..."
            # ä¿®å¤æ•°ç»„å®šä¹‰
            SEARCH_PATTERNS=("staging_dir/toolchain-*/bin/*gcc" "staging_dir/host/bin/*gcc" "staging_dir/bin/*gcc")
            
            for pattern in "${SEARCH_PATTERNS[@]}"; do
              echo "æœç´¢æ¨¡å¼: $pattern"
              found_file=$(find . -path "./$pattern" -type f -executable 2>/dev/null | head -1)
              if [ -n "$found_file" ]; then
                COMPILER_PATH="$found_file"
                echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $COMPILER_PATH"
                break
              fi
            done
          fi
          
          if [ -z "$COMPILER_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶"
            COMPILER_PATH="/tmp/virtual-compiler"
            echo '#!/bin/bash' > "$COMPILER_PATH"
            echo 'echo "Compiler not found - build may have failed"' >> "$COMPILER_PATH"
            chmod +x "$COMPILER_PATH"
          fi
          
          COMPILER_NAME=$(basename "$COMPILER_PATH")
          echo "âœ… ç¼–è¯‘å™¨: $COMPILER_NAME"
          echo "è·¯å¾„: $COMPILER_PATH"
          
          echo "ç¼–è¯‘å™¨ä¿¡æ¯:"
          if [ "$COMPILER_PATH" != "/tmp/virtual-compiler" ]; then
            if file "$COMPILER_PATH" | grep -q "ELF"; then
              echo "GCCç‰ˆæœ¬ä¿¡æ¯:"
              "$COMPILER_PATH" --version 2>&1 | head -5
              
              # æå–å®žé™…GCCç‰ˆæœ¬
              ACTUAL_GCC_VERSION=$("$COMPILER_PATH" --version 2>&1 | grep -E "gcc \(GCC\)" | awk '{print $3}' | head -1)
              if [ -n "$ACTUAL_GCC_VERSION" ]; then
                echo "âœ… å®žé™…GCCç‰ˆæœ¬: $ACTUAL_GCC_VERSION"
                echo "é…ç½®GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
                
                # æ¯”è¾ƒç‰ˆæœ¬
                if [ "$ACTUAL_GCC_VERSION" = "${{ env.GCC_VERSION }}" ]; then
                  echo "âœ… ç‰ˆæœ¬åŒ¹é…æ­£ç¡®ï¼"
                  echo "ACTUAL_GCC_VERSION=$ACTUAL_GCC_VERSION" >> $GITHUB_ENV
                  echo "VERSION_MATCH=true" >> $GITHUB_ENV
                else
                  echo "âš ï¸ ç‰ˆæœ¬ä¸åŒ¹é…ï¼"
                  echo "å®žé™…: $ACTUAL_GCC_VERSION"
                  echo "é…ç½®: ${{ env.GCC_VERSION }}"
                  echo "ACTUAL_GCC_VERSION=$ACTUAL_GCC_VERSION" >> $GITHUB_ENV
                  echo "VERSION_MATCH=false" >> $GITHUB_ENV
                fi
              else
                echo "âš ï¸ æ— æ³•æå–GCCç‰ˆæœ¬"
                echo "VERSION_MATCH=unknown" >> $GITHUB_ENV
              fi
            else
              echo "âš ï¸ æ–‡ä»¶ä¸æ˜¯å¯æ‰§è¡ŒELFæ–‡ä»¶"
            fi
          else
            echo "è™šæ‹Ÿç¼–è¯‘å™¨ - æ— ç‰ˆæœ¬ä¿¡æ¯"
            echo "VERSION_MATCH=false" >> $GITHUB_ENV
          fi
          
          echo "ç›®æ ‡ä¸‰å…ƒç»„:"
          if [ "$COMPILER_PATH" != "/tmp/virtual-compiler" ] && file "$COMPILER_PATH" | grep -q "ELF"; then
            TARGET_TRIPLET=$("$COMPILER_PATH" -dumpmachine 2>&1) || {
              echo "âš ï¸ æ— æ³•èŽ·å–ç›®æ ‡ä¸‰å…ƒç»„"
              TARGET_TRIPLET=$(echo "$COMPILER_NAME" | sed 's/-gcc.*//')
            }
          else
            TARGET_TRIPLET="${{ env.PREFIX }}"
          fi
          echo "$TARGET_TRIPLET"
          
          echo "å¿«é€Ÿæµ‹è¯•äº¤å‰ç¼–è¯‘..."
          echo '#include <stdio.h>' > test.c
          echo 'int main() { printf("Cross-compile test\\n"); return 0; }' >> test.c
          
          if [ "$COMPILER_PATH" != "/tmp/virtual-compiler" ] && file "$COMPILER_PATH" | grep -q "ELF"; then
            if "$COMPILER_PATH" test.c -o test_program 2>&1; then
              echo "âœ… äº¤å‰ç¼–è¯‘æµ‹è¯•é€šè¿‡"
              if file test_program 2>/dev/null | grep -q "${{ env.ARCH_NAME }}"; then
                echo "âœ… ç”Ÿæˆäº†æ­£ç¡®çš„ç›®æ ‡æž¶æž„æ–‡ä»¶"
                rm -f test.c test_program
                echo "BUILD_COMPLETE=true" >> $GITHUB_ENV
              else
                echo "âš ï¸ æ–‡ä»¶æž¶æž„ä¸åŒ¹é…"
                file test_program 2>/dev/null || true
                rm -f test.c test_program
                echo "BUILD_COMPLETE=false" >> $GITHUB_ENV
              fi
            else
              echo "âš ï¸ äº¤å‰ç¼–è¯‘æµ‹è¯•å¤±è´¥"
              rm -f test.c test_program
              echo "BUILD_COMPLETE=false" >> $GITHUB_ENV
            fi
          else
            echo "âš ï¸ ä½¿ç”¨è™šæ‹Ÿç¼–è¯‘å™¨ï¼Œè·³è¿‡ç¼–è¯‘æµ‹è¯•"
            rm -f test.c
            echo "BUILD_COMPLETE=false" >> $GITHUB_ENV
          fi
          
          echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV
          echo "COMPILER_NAME=$COMPILER_NAME" >> $GITHUB_ENV
          echo "TARGET_TRIPLET=$TARGET_TRIPLET" >> $GITHUB_ENV
          
          echo "âœ… éªŒè¯å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸŽ¯ ä¿®å¤ç¼–è¯‘å™¨ç‰ˆæœ¬å‘½åï¼ˆæ–°å¢žï¼‰
        if: env.COMPILER_PATH != '' && env.COMPILER_PATH != '/tmp/virtual-compiler'
        run: |
          echo "=== ä¿®å¤ç¼–è¯‘å™¨ç‰ˆæœ¬å‘½å ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # èŽ·å–å®žé™…GCCç‰ˆæœ¬
          if [ -n "${{ env.ACTUAL_GCC_VERSION }}" ]; then
            ACTUAL_VERSION="${{ env.ACTUAL_GCC_VERSION }}"
          else
            # ä»Žç¼–è¯‘å™¨èŽ·å–ç‰ˆæœ¬
            ACTUAL_VERSION=$("${{ env.COMPILER_PATH }}" --version 2>&1 | grep -E "gcc \(GCC\)" | awk '{print $3}' | head -1)
          fi
          
          if [ -n "$ACTUAL_VERSION" ]; then
            echo "âœ… èŽ·å–åˆ°å®žé™…GCCç‰ˆæœ¬: $ACTUAL_VERSION"
            echo "é…ç½®GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
            
            # æ›´æ–°çŽ¯å¢ƒå˜é‡ä¸­çš„ç‰ˆæœ¬
            echo "ACTUAL_GCC_VERSION=$ACTUAL_VERSION" >> $GITHUB_ENV
            
            if [ "$ACTUAL_VERSION" != "${{ env.GCC_VERSION }}" ]; then
              echo "âš ï¸ æ³¨æ„ï¼šå®žé™…GCCç‰ˆæœ¬ ($ACTUAL_VERSION) ä¸Žé…ç½®ç‰ˆæœ¬ (${{ env.GCC_VERSION }}) ä¸åŒ"
              echo "è¿™å¯èƒ½æ˜¯OpenWrtæž„å»ºç³»ç»Ÿçš„é»˜è®¤è¡Œä¸º"
              
              # æ ¹æ®å®žé™…ç‰ˆæœ¬æ›´æ–°è¾“å‡ºç›®å½•
              NEW_OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${{ env.ARCH_DIR }}/${{ env.LIBC_DIR }}/gcc-${ACTUAL_VERSION}_binutils-${{ env.BINUTILS_VERSION }}"
              echo "æ›´æ–°è¾“å‡ºç›®å½•ä¸º: $NEW_OUTPUT_DIR"
              echo "NEW_OUTPUT_DIR=$NEW_OUTPUT_DIR" >> $GITHUB_ENV
            else
              echo "âœ… ç‰ˆæœ¬ä¸€è‡´ï¼Œä½¿ç”¨åŽŸè¾“å‡ºç›®å½•"
              echo "NEW_OUTPUT_DIR=${{ env.OUTPUT_DIR }}" >> $GITHUB_ENV
            fi
          else
            echo "âš ï¸ æ— æ³•èŽ·å–å®žé™…GCCç‰ˆæœ¬ï¼Œä½¿ç”¨é…ç½®ç‰ˆæœ¬"
            echo "NEW_OUTPUT_DIR=${{ env.OUTPUT_DIR }}" >> $GITHUB_ENV
          fi
          
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ’¾ ä¿å­˜ç¼–è¯‘å™¨ï¼ˆä¿®å¤ç‰ˆï¼‰
        if: env.TOOLCHAIN_DIR != ''
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨ï¼ˆä¿®å¤ç‰ˆï¼‰==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          
          # ç¡®å®šè¾“å‡ºç›®å½•
          if [ -n "${{ env.NEW_OUTPUT_DIR }}" ]; then
            FINAL_OUTPUT_DIR="${{ env.NEW_OUTPUT_DIR }}"
          else
            FINAL_OUTPUT_DIR="${{ env.OUTPUT_DIR }}"
          fi
          
          echo "å‡†å¤‡è¾“å‡ºç›®å½•: $FINAL_OUTPUT_DIR"
          mkdir -p "$FINAL_OUTPUT_DIR"
          
          if [ -d "$FINAL_OUTPUT_DIR" ] && [ "$(ls -A "$FINAL_OUTPUT_DIR" 2>/dev/null)" ]; then
            echo "æ¸…ç†çŽ°æœ‰è¾“å‡ºç›®å½•..."
            rm -rf "$FINAL_OUTPUT_DIR"/*
          fi
          
          echo "æŸ¥æ‰¾å·¥å…·é“¾å†…å®¹..."
          if [ -d "${{ env.TOOLCHAIN_DIR }}" ] && [ "${{ env.TOOLCHAIN_DIR }}" != "/tmp/temp-toolchain" ]; then
            echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
            echo "ä»Ž: ${{ env.TOOLCHAIN_DIR }}"
            echo "åˆ°: $FINAL_OUTPUT_DIR"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºŽæ•´ç†æ–‡ä»¶
            TEMP_DIR="/tmp/compiler-temp-$(date +%s)"
            mkdir -p "$TEMP_DIR"
            
            # å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶
            cp -r "${{ env.TOOLCHAIN_DIR }}"/* "$TEMP_DIR/" 2>/dev/null || true
            
            # æ£€æŸ¥å¹¶ä¿®å¤ç¼–è¯‘å™¨ç‰ˆæœ¬å‘½å
            if [ -d "$TEMP_DIR/bin" ]; then
              cd "$TEMP_DIR/bin"
              
              # æŸ¥æ‰¾æ‰€æœ‰ç¼–è¯‘å™¨æ–‡ä»¶
              for compiler in $(find . -maxdepth 1 -type f -name "*gcc" ! -name "*.*" 2>/dev/null); do
                if [ -x "$compiler" ]; then
                  # èŽ·å–å®žé™…ç‰ˆæœ¬
                  VERSION=$("./$compiler" --version 2>&1 | grep -E "gcc \(GCC\)" | awk '{print $3}' | head -1)
                  
                  if [ -n "$VERSION" ]; then
                    echo "ç¼–è¯‘å™¨ $compiler ç‰ˆæœ¬: $VERSION"
                    
                    # åˆ›å»ºç‰ˆæœ¬åŒ–é“¾æŽ¥
                    COMPILER_BASENAME=$(basename "$compiler")
                    VERSIONED_NAME="${COMPILER_BASENAME}-${VERSION}"
                    
                    if [ ! -e "$VERSIONED_NAME" ]; then
                      echo "åˆ›å»ºç‰ˆæœ¬åŒ–é“¾æŽ¥: $VERSIONED_NAME"
                      ln -sf "$compiler" "$VERSIONED_NAME"
                    fi
                  fi
                fi
              done
              cd "${{ env.BUILD_DIR }}"
            fi
            
            # å°†æ•´ç†å¥½çš„æ–‡ä»¶å¤åˆ¶åˆ°æœ€ç»ˆç›®å½•
            cp -r "$TEMP_DIR"/* "$FINAL_OUTPUT_DIR/" 2>/dev/null || true
            rm -rf "$TEMP_DIR"
            
            echo "âœ… å¤åˆ¶å®Œæˆ"
          else
            echo "âš ï¸ å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œåˆ›å»ºåŸºæœ¬ç»“æž„..."
            mkdir -p "$FINAL_OUTPUT_DIR/bin"
            mkdir -p "$FINAL_OUTPUT_DIR/lib"
            mkdir -p "$FINAL_OUTPUT_DIR/include"
            
            echo "åˆ›å»ºè¯´æ˜Žæ–‡ä»¶..."
            cat > "$FINAL_OUTPUT_DIR/README.txt" << EOF
è­¦å‘Šï¼šç¼–è¯‘å™¨æž„å»ºå¯èƒ½ä¸å®Œæ•´
=======================================
æ­¤ç¼–è¯‘å™¨æž„å»ºè¿‡ç¨‹ä¸­å¯èƒ½å‡ºçŽ°äº†é—®é¢˜ã€‚

å¯èƒ½çš„åŽŸå› ï¼š
1. GMPåº“æž„å»ºå¤±è´¥
2. å·¥å…·é“¾é…ç½®é—®é¢˜
3. æž„å»ºçŽ¯å¢ƒä¸å®Œæ•´

å»ºè®®ï¼š
1. æ£€æŸ¥æž„å»ºæ—¥å¿—
2. é‡æ–°è¿è¡Œæž„å»º
3. å°è¯•ä¸åŒçš„GCCç‰ˆæœ¬
=======================================
EOF
          fi
          
          # ç¡®å®šæœ€ç»ˆä½¿ç”¨çš„GCCç‰ˆæœ¬
          if [ -n "${{ env.ACTUAL_GCC_VERSION }}" ]; then
            FINAL_GCC_VERSION="${{ env.ACTUAL_GCC_VERSION }}"
          else
            FINAL_GCC_VERSION="${{ env.GCC_VERSION }}"
          fi
          
          echo "åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶..."
          cat > "$FINAL_OUTPUT_DIR/metadata.json" << EOF
{
  "architecture": "${{ env.ARCH_DIR }}",
  "arch_name": "${{ env.ARCH_NAME }}",
  "libc": "${{ env.LIBC_DIR }}",
  "libc_version": "${{ env.LIBC_VERSION }}",
  "target": "${{ env.TARGET }}",
  "subtarget": "${{ env.SUBTARGET }}",
  "compiler_prefix": "${{ env.PREFIX }}-",
  "gcc_version": "$FINAL_GCC_VERSION",
  "binutils_version": "${{ env.BINUTILS_VERSION }}",
  "linux_version": "${{ env.LINUX_VERSION }}",
  "openwrt_version": "${{ env.OPENWRT_VERSION }}",
  "cpu_type": "${{ env.CPU_TYPE }}",
  "tune": "${{ env.TUNE }}",
  "abi": "${{ env.ABI }}",
  "float_abi": "${{ env.FLOAT_ABI }}",
  "build_date": "$(date -Iseconds)",
  "workflow_run": "${{ github.run_id }}",
  "build_id": "${{ env.BUILD_ID }}",
  "target_triplet": "${{ env.TARGET_TRIPLET }}",
  "actual_gcc_version": "$FINAL_GCC_VERSION",
  "configured_gcc_version": "${{ env.GCC_VERSION }}",
  "version_match": "${{ env.VERSION_MATCH == 'true' && 'yes' || 'no' }}",
  "status": "${{ env.BUILD_COMPLETE == 'true' && 'complete' || 'partial' }}",
  "notes": "å®žé™…GCCç‰ˆæœ¬: $FINAL_GCC_VERSIONï¼Œé…ç½®GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
}
EOF
          
          echo "è®¡ç®—æˆæžœå¤§å°..."
          TOTAL_SIZE=$(du -sh "$FINAL_OUTPUT_DIR" | cut -f1)
          FILE_COUNT=$(find "$FINAL_OUTPUT_DIR" -type f | wc -l)
          
          echo "ðŸ“Š æœ€ç»ˆæˆæžœç»Ÿè®¡:"
          echo "- è¾“å‡ºç›®å½•: $FINAL_OUTPUT_DIR"
          echo "- æ€»å¤§å°: $TOTAL_SIZE"
          echo "- æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          echo "- æž¶æž„: ${{ env.ARCH_DIR }}"
          echo "- Cåº“: ${{ env.LIBC_DIR }}"
          echo "- å®žé™…GCCç‰ˆæœ¬: $FINAL_GCC_VERSION"
          echo "- é…ç½®GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "- ç‰ˆæœ¬åŒ¹é…: ${{ env.VERSION_MATCH == 'true' && 'æ˜¯' || 'å¦' }}"
          echo "- æž„å»ºçŠ¶æ€: ${{ env.BUILD_COMPLETE == 'true' && 'å®Œæˆ' || 'éƒ¨åˆ†å®Œæˆ' }}"
          
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          echo "FINAL_OUTPUT_DIR=$FINAL_OUTPUT_DIR" >> $GITHUB_ENV
          echo "FINAL_GCC_VERSION=$FINAL_GCC_VERSION" >> $GITHUB_ENV
          
          echo "âœ… ç¼–è¯‘å™¨ä¿å­˜å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ“¤ æäº¤åˆ°Gitä»“åº“
        if: env.TOOLCHAIN_DIR != ''
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°Gitä»“åº“ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ github.workspace }}"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git config pull.rebase false
          
          echo "æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main --no-edit
          
          echo "æ·»åŠ ç¼–è¯‘å™¨æ–‡ä»¶..."
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          
          if ! git diff --cached --quiet; then
            echo "æ£€æµ‹åˆ°å˜æ›´ï¼Œåˆ›å»ºæäº¤..."
            git commit -m "build(compiler): æ·»åŠ  ${{ env.ARCH_DIR }}-${{ env.LIBC_DIR }} äº¤å‰ç¼–è¯‘å™¨" \
                       -m "æž¶æž„: ${{ env.ARCH_DIR }}" \
                       -m "Cåº“: ${{ env.LIBC_DIR }} ${{ env.LIBC_VERSION }}" \
                       -m "å®žé™…GCC: ${{ env.FINAL_GCC_VERSION }}" \
                       -m "é…ç½®GCC: ${{ env.GCC_VERSION }}" \
                       -m "ç‰ˆæœ¬åŒ¹é…: ${{ env.VERSION_MATCH == 'true' && 'æ˜¯' || 'å¦' }}" \
                       -m "Binutils: ${{ env.BINUTILS_VERSION }}" \
                       -m "å¤§å°: ${{ env.TOTAL_SIZE }}" \
                       -m "çŠ¶æ€: ${{ env.BUILD_COMPLETE == 'true' && 'å®Œæˆ' || 'éƒ¨åˆ†å®Œæˆ' }}" \
                       -m "å·¥ä½œæµ: #${{ github.run_id }}"
            
            echo "æŽ¨é€åˆ°ä»“åº“..."
            if git push origin main; then
              echo "âœ… ç¼–è¯‘å™¨å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
            else
              echo "âš ï¸ æŽ¨é€å¤±è´¥ï¼Œé‡æ–°å°è¯•..."
              git pull origin main --rebase
              git push origin main
            fi
          else
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi
          
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ðŸ“Š æ˜¾ç¤ºæœ€ç»ˆæˆæžœï¼ˆä¿®å¤ç‰ˆï¼‰
        if: env.TOOLCHAIN_DIR != ''
        run: |
          echo "========================================"
          echo "          ðŸŽ‰ æž„å»ºå®ŒæˆæŠ¥å‘Š              "
          echo "========================================"
          
          if [ "${{ env.BUILD_COMPLETE }}" = "true" ]; then
            echo "âœ… äº¤å‰ç¼–è¯‘å™¨æž„å»ºæˆåŠŸ!"
          else
            echo "âš ï¸ äº¤å‰ç¼–è¯‘å™¨æž„å»ºéƒ¨åˆ†å®Œæˆ"
          fi
          
          echo ""
          echo "ðŸ“Š æž„å»ºä¿¡æ¯:"
          echo "- æž¶æž„: ${{ env.ARCH_DIR }} (${{ env.ARCH_NAME }})"
          echo "- Cåº“: ${{ env.LIBC_DIR }} ${{ env.LIBC_VERSION }}"
          echo "- å®žé™…GCCç‰ˆæœ¬: ${{ env.FINAL_GCC_VERSION }}"
          echo "- é…ç½®GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "- ç‰ˆæœ¬åŒ¹é…: ${{ env.VERSION_MATCH == 'true' && 'âœ… åŒ¹é…' || 'âš ï¸ ä¸åŒ¹é…' }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ env.BINUTILS_VERSION }}"
          echo "- Linuxå†…æ ¸: ${{ env.LINUX_VERSION }}"
          echo "- ç¼–è¯‘å™¨å‰ç¼€: ${{ env.PREFIX }}-"
          echo "- ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "- ç›®æ ‡ä¸‰å…ƒç»„: ${{ env.TARGET_TRIPLET }}"
          echo "- æž„å»ºçŠ¶æ€: ${{ env.BUILD_COMPLETE == 'true' && 'å®Œæˆ' || 'éƒ¨åˆ†å®Œæˆ' }}"
          echo ""
          echo "ðŸ“¦ æˆæžœç»Ÿè®¡:"
          echo "- æ€»å¤§å°: ${{ env.TOTAL_SIZE }}"
          echo "- æ–‡ä»¶æ•°é‡: ${{ env.FILE_COUNT }}"
          echo "- è¾“å‡ºç›®å½•: ${{ env.FINAL_OUTPUT_DIR }}"
          echo ""
          
          if [ "${{ env.BUILD_COMPLETE }}" = "true" ]; then
            echo "ðŸš€ ä½¿ç”¨æ–¹æ³•:"
            echo "cd ${{ env.FINAL_OUTPUT_DIR }}"
            echo "export STAGING_DIR=\$(pwd)"
            echo 'export PATH="$STAGING_DIR/bin:$PATH"'
            echo "${{ env.PREFIX }}-gcc --version"
          else
            echo "âš ï¸ æ³¨æ„: ç¼–è¯‘å™¨å¯èƒ½ä¸å®Œæ•´"
            echo "å»ºè®®æ£€æŸ¥æž„å»ºæ—¥å¿—ï¼Œå¯èƒ½éœ€è¦é‡æ–°æž„å»º"
          fi
          
          if [ "${{ env.VERSION_MATCH }}" != "true" ]; then
            echo ""
            echo "âš ï¸ ç‰ˆæœ¬ä¸åŒ¹é…è¯´æ˜Ž:"
            echo "- å®žé™…GCCç‰ˆæœ¬: ${{ env.FINAL_GCC_VERSION }}"
            echo "- é…ç½®GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
            echo "- è¿™å¯èƒ½æ˜¯OpenWrtæž„å»ºç³»ç»Ÿçš„é»˜è®¤è¡Œä¸º"
            echo "- ç¼–è¯‘å™¨åŠŸèƒ½åº”è¯¥æ­£å¸¸ï¼Œä½†ç‰ˆæœ¬å·ä¸åŒ"
          fi
          
          echo ""
          echo "â° æž„å»ºæ—¶é—´: $(date)"
          echo "========================================"

      - name: ðŸ“„ ä¸Šä¼ æž„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.BUILD_ID }}
          path: /tmp/*.log
          retention-days: 30

  skip-build:
    needs: setup
    if: needs.setup.outputs.need_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: â­ï¸ è·³è¿‡æž„å»º
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æž„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ä¸”å®Œæ•´ï¼Œè·³è¿‡æž„å»º"
          echo ""
          echo "ðŸ“‹ è·³è¿‡åŽŸå› :"
          echo "- ç¼–è¯‘å™¨ç›®å½•å·²å­˜åœ¨ä¸”å®Œæ•´"
          echo "- ç‰ˆæœ¬åŒ¹é…æ­£ç¡®"
          echo "- æœªå¯ç”¨å¼ºåˆ¶é‡æ–°æž„å»º"
          echo ""
          echo "ðŸ”§ çŽ°æœ‰ç¼–è¯‘å™¨ä¿¡æ¯:"
          echo "- æž¶æž„: ${{ github.event.inputs.target_arch }}"
          echo "- Cåº“: ${{ github.event.inputs.libc }}"
          echo "- GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo ""
          echo "ðŸ’¡ å¦‚éœ€é‡æ–°æž„å»ºï¼Œè¯·å¯ç”¨'å¼ºåˆ¶é‡æ–°æž„å»º'é€‰é¡¹"
          echo "========================================"
