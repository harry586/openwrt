# .github/workflows/compiler-matrix-build.yml
name: ğŸ”§ äº¤å‰ç¼–è¯‘å™¨æ„å»º

on:
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'ç›®æ ‡æ¶æ„ï¼ˆIPQ40xxé€‰æ‹©arm_cortex-a7ï¼‰'
        required: true
        default: 'arm_cortex-a7'
        type: choice
        options:
          - aarch64
          - x86_64
          - mips
          - mipsel
          - arm_cortex-a7
          - arm_cortex-a53
          - riscv64
      libc:
        description: 'Cåº“ç±»å‹ï¼ˆåµŒå…¥å¼æ¨èmuslï¼‰'
        required: true
        default: 'musl'
        type: choice
        options:
          - musl
          - glibc
      gcc_version:
        description: 'GCCç‰ˆæœ¬ï¼ˆè¾“å…¥ç‰ˆæœ¬å·å¦‚12.3.0ï¼Œæˆ–autoè‡ªåŠ¨æ£€æµ‹ï¼‰'
        required: true
        default: 'auto'
        type: string
      clean_build:
        description: 'æ¸…ç†ä¹‹å‰çš„æ„å»ºç¼“å­˜'
        required: true
        default: false
        type: boolean
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºï¼ˆå³ä½¿å·²å­˜åœ¨ï¼‰'
        required: true
        default: false
        type: boolean

env:
  OPENWRT_VERSION: "23.05.2"
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers"

jobs:
  show-device-info:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“± æ˜¾ç¤ºæ¶æ„å¯¹åº”è®¾å¤‡
        run: |
          echo "================================================"
          echo "          ğŸ¯ ç›®æ ‡æ¶æ„è®¾å¤‡å¯¹åº”è¡¨                 "
          echo "================================================"
          echo ""
          echo "1ï¸âƒ£ aarch64 (ARM 64ä½)"
          echo "   â”œâ”€ ğŸ“± æ ‘è“æ´¾ç³»åˆ—"
          echo "   â”‚  â”œâ”€ æ ‘è“æ´¾ 4B (Raspberry Pi 4)"
          echo "   â”‚  â”œâ”€ æ ‘è“æ´¾ CM4 (Compute Module 4)"
          echo "   â”‚  â””â”€ æ ‘è“æ´¾ 400"
          echo "   â”œâ”€ ğŸ–¥ï¸ ç‘èŠ¯å¾®ç³»åˆ—"
          echo "   â”‚  â”œâ”€ RK3399 (ROCK Pi 4/NanoPi M4)"
          echo "   â”‚  â”œâ”€ RK3568 (FriendlyELEC NanoPi R5S)"
          echo "   â”‚  â””â”€ RK3588 (é«˜ç«¯å¼€å‘æ¿)"
          echo "   â”œâ”€ ğŸ“º ç”µè§†ç›’å­"
          echo "   â”‚  â”œâ”€ æ™¶æ™¨ S905 (X96 Max/Beelink GT King)"
          echo "   â”‚  â”œâ”€ æ™¶æ™¨ S912 (H96 Pro/Beelink GT1)"
          echo "   â”‚  â””â”€ æ™¶æ™¨ S922X (Odroid N2+)"
          echo "   â””â”€ ğŸ–¥ï¸ å…¶ä»–ARM64è®¾å¤‡"
          echo "      â”œâ”€ Orange Pi 5"
          echo "      â”œâ”€ Banana Pi BPI-M5"
          echo "      â””â”€ å„ç§ARMæœåŠ¡å™¨"
          echo ""
          echo "2ï¸âƒ£ x86_64 (x86 64ä½)"
          echo "   â”œâ”€ ğŸ’» ä¸ªäººç”µè„‘"
          echo "   â”‚  â”œâ”€ Intel Core i3/i5/i7/i9"
          echo "   â”‚  â”œâ”€ AMD Ryzen 3/5/7/9"
          echo "   â”‚  â””â”€ å„ç§x86ç¬”è®°æœ¬"
          echo "   â”œâ”€ ğŸ–¥ï¸ æœåŠ¡å™¨"
          echo "   â”‚  â”œâ”€ æˆ´å°”PowerEdge"
          echo "   â”‚  â”œâ”€ æƒ æ™®ProLiant"
          echo "   â”‚  â””â”€ è¶…å¾®æœåŠ¡å™¨"
          echo "   â””â”€ â˜ï¸ è™šæ‹Ÿæœº/å®¹å™¨"
          echo "      â”œâ”€ VMware/VirtualBoxè™šæ‹Ÿæœº"
          echo "      â”œâ”€ Dockerå®¹å™¨"
          echo "      â””â”€ äº‘æœåŠ¡å™¨å®ä¾‹"
          echo ""
          echo "3ï¸âƒ£ mips (MIPS 32ä½å¤§ç«¯)"
          echo "   â”œâ”€ ğŸ›œ åç¡•è·¯ç”±å™¨"
          echo "   â”‚  â”œâ”€ RT-ACRH17"
          echo "   â”‚  â”œâ”€ RT-AC85P"
          echo "   â”‚  â””â”€ RT-N56U"
          echo "   â”œâ”€ ğŸ›œ ç½‘ä»¶è·¯ç”±å™¨"
          echo "   â”‚  â”œâ”€ R7800"
          echo "   â”‚  â”œâ”€ R9000"
          echo "   â”‚  â””â”€ XR500"
          echo "   â””â”€ ğŸ›œ å…¶ä»–MIPSè®¾å¤‡"
          echo "      â”œâ”€ ä¸­å…´è·¯ç”±å™¨"
          echo "      â”œâ”€ åä¸ºæ—§æ¬¾è·¯ç”±å™¨"
          echo "      â””â”€ æ—©æœŸæ™ºèƒ½å®¶å±…è®¾å¤‡"
          echo ""
          echo "4ï¸âƒ£ mipsel (MIPS 32ä½å°ç«¯)"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7621"
          echo "   â”‚  â”œâ”€ æ–è®¯ K2P (Phicomm K2P)"
          echo "   â”‚  â”œâ”€ Newifi 3 (æ–°è·¯ç”±3)"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 3G"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AC2100"
          echo "   â”‚  â””â”€ æè·¯ç”± B70"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7620"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ Mini"
          echo "   â”‚  â”œâ”€ æè·¯ç”± 1S"
          echo "   â”‚  â”œâ”€ æ–è®¯ K1/K2"
          echo "   â”‚  â””â”€ è”æƒ³ Newifi Mini"
          echo "   â””â”€ ğŸ›œ å…¶ä»–MTKè®¾å¤‡"
          echo "      â”œâ”€ MT7628 (ä½ç«¯è·¯ç”±)"
          echo "      â”œâ”€ MT7688 (ç‰©è”ç½‘è®¾å¤‡)"
          echo "      â””â”€ å„ç§WiFiæ¨¡å—"
          echo ""
          echo "5ï¸âƒ£ arm_cortex-a7 (ARM Cortex-A7)"
          echo "   â”œâ”€ ğŸ›œ é«˜é€šIPQ40xxç³»åˆ— (ä½ çš„è®¾å¤‡ï¼)"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 4Aåƒå…†ç‰ˆ"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AC2100 (éƒ¨åˆ†ç‰ˆæœ¬)"
          echo "   â”‚  â”œâ”€ GL.iNet MT1300"
          echo "   â”‚  â”œâ”€ 360å®¶åº­é˜²ç«å¢™ 5Pro"
          echo "   â”‚  â”œâ”€ Linksys EA6350 v3"
          echo "   â”‚  â””â”€ Netgear R6900P"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7623/MT7629"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ 3G (éƒ¨åˆ†ç‰ˆæœ¬)"
          echo "   â”‚  â”œâ”€ æ–è®¯ K3C"
          echo "   â”‚  â””â”€ éƒ¨åˆ†ä¼ä¸šè·¯ç”±å™¨"
          echo "   â”œâ”€ ğŸŠ å…¨å¿—H3/H2+ç³»åˆ—"
          echo "   â”‚  â”œâ”€ Orange Pi PC (é¦™æ©™æ´¾PC)"
          echo "   â”‚  â”œâ”€ Orange Pi Plus"
          echo "   â”‚  â”œâ”€ Banana Pi M2+"
          echo "   â”‚  â””â”€ NanoPi NEO"
          echo "   â””â”€ ğŸ”§ å…¶ä»–Cortex-A7è®¾å¤‡"
          echo "      â”œâ”€ æŸäº›æ™ºèƒ½æ‘„åƒå¤´"
          echo "      â”œâ”€ å·¥ä¸šæ§åˆ¶è®¾å¤‡"
          echo "      â””â”€ ä½åŠŸè€—åµŒå…¥å¼è®¾å¤‡"
          echo ""
          echo "6ï¸âƒ£ arm_cortex-a53 (ARM Cortex-A53)"
          echo "   â”œâ”€ ğŸ›œ è”å‘ç§‘MT7622"
          echo "   â”‚  â”œâ”€ å°ç±³è·¯ç”±å™¨ AX3600"
          echo "   â”‚  â”œâ”€ çº¢ç±³è·¯ç”±å™¨ AX6"
          echo "   â”‚  â””â”€ éƒ¨åˆ†WiFi6è·¯ç”±å™¨"
          echo "   â”œâ”€ ğŸ“± 64ä½è®¾å¤‡32ä½æ¨¡å¼"
          echo "   â”‚  â”œâ”€ æ ‘è“æ´¾ 3 (32ä½æ¨¡å¼)"
          echo "   â”‚  â”œâ”€ æŸäº›ç”µè§†ç›’å­"
          echo "   â”‚  â””â”€ ä½ç«¯å¹³æ¿ç”µè„‘"
          echo "   â””â”€ ğŸ”§ å…¶ä»–A53è®¾å¤‡"
          echo "      â”œâ”€ æŸäº›æ™ºèƒ½éŸ³ç®±"
          echo "      â”œâ”€ ç‰©è”ç½‘ç½‘å…³"
          echo "      â”œâ”€ è¾¹ç¼˜è®¡ç®—è®¾å¤‡"
          echo ""
          echo "7ï¸âƒ£ riscv64 (RISC-V 64ä½)"
          echo "   â”œâ”€ ğŸ”¬ å¼€å‘æ¿"
          echo "   â”‚  â”œâ”€ HiFive Unmatched"
          echo "   â”‚  â”œâ”€ VisionFive 2"
          echo "   â”‚  â”œâ”€ BeagleV"
          echo "   â”‚  â””â”€ SiFiveå¼€å‘æ¿"
          echo "   â”œâ”€ ğŸ–¥ï¸ æ–°å…´è®¾å¤‡"
          echo "   â”‚  â”œâ”€ æŸäº›AIåŠ é€Ÿå™¨"
          echo "   â”‚  â”œâ”€ å®šåˆ¶èŠ¯ç‰‡è®¾å¤‡"
          echo "   â”‚  â””â”€ å­¦æœ¯ç ”ç©¶è®¾å¤‡"
          echo "   â””â”€ ğŸš€ æœªæ¥è®¾å¤‡"
          echo "      â”œâ”€ RISC-Vç¬”è®°æœ¬ç”µè„‘"
          echo "      â”œâ”€ RISC-VæœåŠ¡å™¨"
          echo "      â””â”€ å„ç§åˆ›æ–°ç¡¬ä»¶"
          echo ""
          echo "================================================"
          echo "é€‰æ‹©å»ºè®®ï¼š"
          echo "1. è·¯ç”±å™¨è®¾å¤‡ â†’ æ ¹æ®èŠ¯ç‰‡å‹å·é€‰æ‹©"
          echo "2. å¼€å‘æ¿ â†’ æ ¹æ®CPUæ¶æ„é€‰æ‹©"
          echo "3. PC/æœåŠ¡å™¨ â†’ é€‰æ‹©x86_64"
          echo "4. ä¸ç¡®å®š â†’ æŸ¥çœ‹è®¾å¤‡è§„æ ¼ä¹¦æˆ–CPUä¿¡æ¯"
          echo "================================================"

  setup:
    runs-on: ubuntu-22.04
    outputs:
      gcc_version: ${{ steps.version-detection.outputs.gcc_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      glibc_version: ${{ steps.version-detection.outputs.glibc_version }}
      need_build: ${{ steps.check-existing.outputs.need_build }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“ï¼ˆç”¨äºæ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            firmware-config/build-Compiler-file/compilers
          sparse-checkout-cone-mode: false

      - name: ğŸ—ï¸ åˆå§‹åŒ–
        run: |
          echo "=== äº¤å‰ç¼–è¯‘å™¨æ„å»ºç³»ç»Ÿ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          echo "åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "å½“å‰å·¥ä½œåŒºå†…å®¹:"
          ls -la "${{ github.workspace }}/firmware-config/build-Compiler-file/compilers" 2>/dev/null || echo "ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨"

      - name: ğŸ” æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸é€‰æ‹©
        id: version-detection
        run: |
          echo "=== æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹ä¸é€‰æ‹© ==="
          USER_VERSION="${{ github.event.inputs.gcc_version }}"
          TARGET_ARCH="${{ github.event.inputs.target_arch }}"
          LIBC_TYPE="${{ github.event.inputs.libc }}"
          OPENWRT_VERSION="${{ env.OPENWRT_VERSION }}"
          
          echo "è¾“å…¥å‚æ•°:"
          echo "- ç›®æ ‡æ¶æ„: $TARGET_ARCH"
          echo "- Cåº“ç±»å‹: $LIBC_TYPE"
          echo "- ç”¨æˆ·æŒ‡å®šGCCç‰ˆæœ¬: $USER_VERSION"
          echo "OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          
          case "$OPENWRT_VERSION" in
            "23.05.2"|"23.05.*")
              DEFAULT_GCC="12.3.0"
              DEFAULT_BINUTILS="2.40"
              DEFAULT_LINUX="5.15.133"
              DEFAULT_MUSL="1.2.4"
              DEFAULT_GLIBC="2.37"
              ;;
            "22.03.*")
              DEFAULT_GCC="11.3.0"
              DEFAULT_BINUTILS="2.38"
              DEFAULT_LINUX="5.10.179"
              DEFAULT_MUSL="1.2.3"
              DEFAULT_GLIBC="2.35"
              ;;
            "21.02.*")
              DEFAULT_GCC="10.3.0"
              DEFAULT_BINUTILS="2.36.1"
              DEFAULT_LINUX="5.4.188"
              DEFAULT_MUSL="1.2.2"
              DEFAULT_GLIBC="2.33"
              ;;
            *)
              DEFAULT_GCC="12.3.0"
              DEFAULT_BINUTILS="2.40"
              DEFAULT_LINUX="5.15.133"
              DEFAULT_MUSL="1.2.4"
              DEFAULT_GLIBC="2.37"
              ;;
          esac
          
          case "$TARGET_ARCH" in
            "riscv64")
              ARCH_GCC="13.2.0"
              ARCH_BINUTILS="2.41"
              echo "RISC-Væ¶æ„ï¼Œä½¿ç”¨è¾ƒæ–°å·¥å…·é“¾ç‰ˆæœ¬"
              ;;
            "aarch64"|"arm_cortex-a53")
              ARCH_GCC="12.3.0"
              ARCH_BINUTILS="2.40"
              ;;
            "arm_cortex-a7")
              ARCH_GCC="11.3.0"
              ARCH_BINUTILS="2.38"
              ;;
            "mips"|"mipsel")
              ARCH_GCC="10.3.0"
              ARCH_BINUTILS="2.36.1"
              echo "MIPSæ¶æ„ï¼Œä½¿ç”¨è¾ƒè€å·¥å…·é“¾ç‰ˆæœ¬ä»¥ä¿è¯å…¼å®¹æ€§"
              ;;
            *)
              ARCH_GCC="$DEFAULT_GCC"
              ARCH_BINUTILS="$DEFAULT_BINUTILS"
              ;;
          esac
          
          if [ "$USER_VERSION" = "auto" ] || [ -z "$USER_VERSION" ]; then
            echo "ä½¿ç”¨æ™ºèƒ½ç‰ˆæœ¬é€‰æ‹©..."
            GCC_VERSION="$ARCH_GCC"
            
            echo "éªŒè¯GCCç‰ˆæœ¬ $GCC_VERSION æ˜¯å¦å­˜åœ¨..."
            if curl -s --head "https://ftp.gnu.org/gnu/gcc/gcc-$GCC_VERSION/gcc-$GCC_VERSION.tar.xz" | grep -q "200 OK"; then
              echo "âœ… GCC $GCC_VERSION å¯ç”¨"
            else
              echo "âš ï¸ GCC $GCC_VERSION ä¸å¯ç”¨ï¼Œå°è¯•å¤‡ç”¨ç‰ˆæœ¬"
              GCC_VERSION=$(curl -s https://ftp.gnu.org/gnu/gcc/ | grep -o 'gcc-[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -Vr | head -1 | cut -d- -f2)
              if [ -z "$GCC_VERSION" ]; then
                GCC_VERSION="12.3.0"
                echo "âš ï¸ æ— æ³•æ£€æµ‹æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤: $GCC_VERSION"
              fi
            fi
          else
            GCC_VERSION="$USER_VERSION"
            echo "ä½¿ç”¨ç”¨æˆ·æŒ‡å®šç‰ˆæœ¬: $GCC_VERSION"
            
            echo "éªŒè¯ç”¨æˆ·æŒ‡å®šçš„GCCç‰ˆæœ¬ $GCC_VERSION æ˜¯å¦å­˜åœ¨..."
            if ! curl -s --head "https://ftp.gnu.org/gnu/gcc/gcc-$GCC_VERSION/gcc-$GCC_VERSION.tar.xz" | grep -q "200 OK"; then
              echo "âŒ ç”¨æˆ·æŒ‡å®šçš„GCCç‰ˆæœ¬ $GCC_VERSION ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®"
              echo "å°è¯•æŸ¥æ‰¾å¯ç”¨çš„ç›¸è¿‘ç‰ˆæœ¬..."
              
              AVAILABLE_VERSIONS=$(curl -s https://ftp.gnu.org/gnu/gcc/ | grep -o 'gcc-[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -Vr | cut -d- -f2)
              MAJOR_VERSION=$(echo "$GCC_VERSION" | cut -d. -f1)
              SIMILAR_VERSIONS=$(echo "$AVAILABLE_VERSIONS" | grep "^$MAJOR_VERSION\.")
              
              if [ -n "$SIMILAR_VERSIONS" ]; then
                NEW_VERSION=$(echo "$SIMILAR_VERSIONS" | head -1)
                echo "æ‰¾åˆ°ç›¸è¿‘ç‰ˆæœ¬: $NEW_VERSION"
                GCC_VERSION="$NEW_VERSION"
              else
                echo "ä½¿ç”¨æ¶æ„æ¨èç‰ˆæœ¬: $ARCH_GCC"
                GCC_VERSION="$ARCH_GCC"
              fi
            fi
          fi
          
          echo "æ ¹æ®GCC $GCC_VERSION é€‰æ‹©Binutilsç‰ˆæœ¬..."
          GCC_MAJOR=$(echo "$GCC_VERSION" | cut -d. -f1)
          
          case $GCC_MAJOR in
            13|14)
              BINUTILS_VERSION="2.41"
              ;;
            12)
              BINUTILS_VERSION="2.40"
              ;;
            11)
              BINUTILS_VERSION="2.38"
              ;;
            10)
              BINUTILS_VERSION="2.36.1"
              ;;
            9)
              BINUTILS_VERSION="2.34"
              ;;
            8)
              BINUTILS_VERSION="2.32"
              ;;
            *)
              BINUTILS_VERSION="$DEFAULT_BINUTILS"
              ;;
          esac
          
          echo "éªŒè¯Binutilsç‰ˆæœ¬ $BINUTILS_VERSION..."
          if ! curl -s --head "https://ftp.gnu.org/gnu/binutils/binutils-$BINUTILS_VERSION.tar.xz" | grep -q "200 OK"; then
            echo "âš ï¸ Binutils $BINUTILS_VERSION ä¸å¯ç”¨ï¼Œå°è¯•æ£€æµ‹æœ€æ–°ç‰ˆæœ¬"
            BINUTILS_VERSION=$(curl -s https://ftp.gnu.org/gnu/binutils/ | grep -o 'binutils-[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -Vr | head -1 | cut -d- -f2)
          fi
          
          LINUX_VERSION="$DEFAULT_LINUX"
          MUSL_VERSION="$DEFAULT_MUSL"
          GLIBC_VERSION="$DEFAULT_GLIBC"
          
          echo "ğŸ¯ æœ€ç»ˆç‰ˆæœ¬é€‰æ‹©:"
          echo "- ç›®æ ‡æ¶æ„: $TARGET_ARCH"
          echo "- Cåº“ç±»å‹: $LIBC_TYPE"
          echo "- GCCç‰ˆæœ¬: $GCC_VERSION (ä¸»ç‰ˆæœ¬: $GCC_MAJOR)"
          echo "- Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "- Linuxå†…æ ¸: $LINUX_VERSION"
          echo "- Muslç‰ˆæœ¬: $MUSL_VERSION"
          echo "- Glibcç‰ˆæœ¬: $GLIBC_VERSION"
          echo ""
          echo "ğŸ“Š ç‰ˆæœ¬é€‰æ‹©è¯´æ˜:"
          echo "1. OpenWrt $OPENWRT_VERSION â†’ GCC $DEFAULT_GCC"
          echo "2. æ¶æ„ $TARGET_ARCH â†’ é€‚é…ç‰ˆæœ¬"
          echo "3. ç‰ˆæœ¬éªŒè¯ â†’ ç¡®ä¿å¯ç”¨æ€§"
          
          echo "gcc_version=$GCC_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT
          echo "glibc_version=$GLIBC_VERSION" >> $GITHUB_OUTPUT
          echo "DEBUG_GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "DEBUG_BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV

      - name: ğŸ” æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨
        id: check-existing
        run: |
          echo "=== æ£€æŸ¥ç°æœ‰ç¼–è¯‘å™¨ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          GCC_VERSION='${{ steps.version-detection.outputs.gcc_version }}'
          BINUTILS_VERSION='${{ steps.version-detection.outputs.binutils_version }}'
          
          echo "æ£€æŸ¥ç‰ˆæœ¬å˜é‡:"
          echo "- GCC_VERSION: '$GCC_VERSION'"
          echo "- BINUTILS_VERSION: '$BINUTILS_VERSION'"
          
          if [ "$LIBC" = "musl" ]; then
            LIBC_DIR="musl"
          else
            LIBC_DIR="glibc"
          fi
          
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH}/${LIBC_DIR}/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "æ£€æŸ¥ç›®å½•: $OUTPUT_DIR"
          echo "å®Œæ•´è·¯å¾„: $(realpath "$OUTPUT_DIR" 2>/dev/null || echo "$OUTPUT_DIR")"
          
          if [ -d "$OUTPUT_DIR" ]; then
            echo "âœ… ç¼–è¯‘å™¨ç›®å½•å·²å­˜åœ¨"
            echo "ç›®å½•å†…å®¹:"
            ls -la "$OUTPUT_DIR/" 2>/dev/null | head -10
            
            REQUIRED_DIRS=("bin" "lib" "include" "libexec")
            REQUIRED_FILES=("*-gcc" "*-g++" "*-ld" "*-ar")
            MISSING_ITEMS=()
            
            for dir in "${REQUIRED_DIRS[@]}"; do
              if [ ! -d "$OUTPUT_DIR/$dir" ]; then
                MISSING_ITEMS+=("ç›®å½• $dir")
                echo "  âŒ ç¼ºå°‘ç›®å½•: $dir"
              else
                echo "  âœ… ç›®å½•å­˜åœ¨: $dir (æ–‡ä»¶æ•°: $(find "$OUTPUT_DIR/$dir" -type f 2>/dev/null | wc -l))"
              fi
            done
            
            for file_pattern in "${REQUIRED_FILES[@]}"; do
              found_file=$(find "$OUTPUT_DIR" -name "$file_pattern" -type f 2>/dev/null | head -1)
              if [ -n "$found_file" ]; then
                echo "  âœ… æ‰¾åˆ°æ–‡ä»¶: $(basename "$found_file")"
              else
                MISSING_ITEMS+=("æ–‡ä»¶ $file_pattern")
                echo "  âŒ ç¼ºå°‘æ–‡ä»¶: $file_pattern"
              fi
            done
            
            echo "æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯..."
            if [ -f "$OUTPUT_DIR/metadata.json" ]; then
              echo "æ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶"
              STORED_GCC=$(jq -r '.gcc_version' "$OUTPUT_DIR/metadata.json" 2>/dev/null)
              STORED_BINUTILS=$(jq -r '.binutils_version' "$OUTPUT_DIR/metadata.json" 2>/dev/null)
              
              if [ "$STORED_GCC" = "$GCC_VERSION" ] && [ "$STORED_BINUTILS" = "$BINUTILS_VERSION" ]; then
                echo "  âœ… ç‰ˆæœ¬åŒ¹é…: GCC $STORED_GCC, Binutils $STORED_BINUTILS"
              else
                echo "  âš ï¸ ç‰ˆæœ¬ä¸åŒ¹é…"
                echo "    å­˜å‚¨: GCC $STORED_GCC, Binutils $STORED_BINUTILS"
                echo "    è¯·æ±‚: GCC $GCC_VERSION, Binutils $BINUTILS_VERSION"
                MISSING_ITEMS+=("ç‰ˆæœ¬ä¸åŒ¹é…")
              fi
            else
              echo "  âš ï¸ æœªæ‰¾åˆ°å…ƒæ•°æ®æ–‡ä»¶"
            fi
            
            if [ ${#MISSING_ITEMS[@]} -eq 0 ]; then
              echo "âœ… ç¼–è¯‘å™¨æ–‡ä»¶å®Œæ•´"
              if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
                echo "âš ï¸ å¼ºåˆ¶é‡æ–°æ„å»ºå·²å¯ç”¨"
                NEED_BUILD="true"
              else
                echo "âœ… è·³è¿‡æ„å»ºï¼Œä½¿ç”¨ç°æœ‰ç¼–è¯‘å™¨"
                NEED_BUILD="false"
              fi
            else
              echo "âš ï¸ ç¼–è¯‘å™¨ä¸å®Œæ•´ï¼Œç¼ºå°‘:"
              for item in "${MISSING_ITEMS[@]}"; do
                echo "  - $item"
              done
              NEED_BUILD="true"
            fi
          else
            echo "âŒ ç¼–è¯‘å™¨ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º"
            echo "å°è¯•åˆ—å‡ºçˆ¶ç›®å½•å†…å®¹:"
            ls -la "$(dirname "$OUTPUT_DIR")" 2>/dev/null || echo "çˆ¶ç›®å½•ä¸å­˜åœ¨"
            NEED_BUILD="true"
          fi
          
          echo "æ„å»ºå†³ç­–: $NEED_BUILD"
          echo "need_build=$NEED_BUILD" >> $GITHUB_OUTPUT

  build-compiler:
    needs: [show-device-info, setup]
    if: needs.setup.outputs.need_build == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æ„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æ¶æ„: ${{ github.event.inputs.target_arch }}"
          echo "Cåº“ç±»å‹: ${{ github.event.inputs.libc }}"
          echo "GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "Glibcç‰ˆæœ¬: ${{ needs.setup.outputs.glibc_version }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ env.OPENWRT_VERSION }}"
          echo "å¼ºåˆ¶é‡å»º: ${{ github.event.inputs.force_rebuild }}"
          echo "æ¸…ç†æ„å»º: ${{ github.event.inputs.clean_build }}"
          echo "æ„å»ºéœ€æ±‚: ${{ needs.setup.outputs.need_build }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "è¿è¡Œåºå·: ${{ github.run_number }}"
          echo "ç‰ˆæœ¬é€‰æ‹©ç­–ç•¥:"
          echo "- æ ¹æ®OpenWrtç‰ˆæœ¬é€‰æ‹©åŸºç¡€ç‰ˆæœ¬"
          echo "- æ ¹æ®ç›®æ ‡æ¶æ„è°ƒæ•´ç‰ˆæœ¬"
          echo "- éªŒè¯ç‰ˆæœ¬å¯ç”¨æ€§"
          echo "========================================"

      - name: ğŸ—ï¸ è®¾ç½®ç¯å¢ƒ
        run: |
          echo "=== è®¾ç½®æ„å»ºç¯å¢ƒ ==="
          ARCH="${{ github.event.inputs.target_arch }}"
          LIBC="${{ github.event.inputs.libc }}"
          echo "å¤„ç†æ¶æ„: $ARCH"
          echo "å¤„ç†Cåº“: $LIBC"
          
          case "$ARCH" in
            arm_cortex-a7)
              TARGET="armvirt"
              SUBTARGET="armv7"
              ARCH_NAME="arm"
              ARCH_DIR="arm_cortex-a7"
              PREFIX="arm-openwrt-linux"
              CPU_TYPE="cortex-a7"
              TUNE="cortex-a7"
              ABI="32"
              FLOAT_ABI="hard"
              ;;
            aarch64)
              TARGET="armvirt"
              SUBTARGET="64"
              ARCH_NAME="aarch64"
              ARCH_DIR="aarch64"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            x86_64)
              TARGET="x86"
              SUBTARGET="64"
              ARCH_NAME="x86_64"
              ARCH_DIR="x86_64"
              PREFIX="x86_64-openwrt-linux"
              CPU_TYPE="x86_64"
              TUNE="generic"
              ABI="64"
              FLOAT_ABI=""
              ;;
            mips)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mips"
              ARCH_DIR="mips"
              PREFIX="mips-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            mipsel)
              TARGET="ramips"
              SUBTARGET="mt7621"
              ARCH_NAME="mipsel"
              ARCH_DIR="mipsel"
              PREFIX="mipsel-openwrt-linux"
              CPU_TYPE="24kc"
              TUNE="24kc"
              ABI="32"
              FLOAT_ABI="softfloat"
              ;;
            arm_cortex-a53)
              TARGET="rockchip"
              SUBTARGET="armv8"
              ARCH_NAME="aarch64"
              ARCH_DIR="arm_cortex-a53"
              PREFIX="aarch64-openwrt-linux"
              CPU_TYPE="cortex-a53"
              TUNE="cortex-a53"
              ABI="64"
              FLOAT_ABI=""
              ;;
            riscv64)
              TARGET="virt"
              SUBTARGET="rv64"
              ARCH_NAME="riscv64"
              ARCH_DIR="riscv64"
              PREFIX="riscv64-openwrt-linux"
              CPU_TYPE="generic"
              TUNE="generic"
              ABI="lp64d"
              FLOAT_ABI="hard"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
              exit 1
              ;;
          esac
          
          if [ "$LIBC" = "musl" ]; then
            PREFIX="${PREFIX}-musl"
            LIBC_SUFFIX="musl"
            LIBC_DIR="musl"
            USE_MUSL="y"
            USE_GLIBC="n"
            LIBC_VERSION='${{ needs.setup.outputs.musl_version }}'
          else
            PREFIX="${PREFIX}-gnu"
            LIBC_SUFFIX="glibc"
            LIBC_DIR="glibc"
            USE_MUSL="n"
            USE_GLIBC="y"
            LIBC_VERSION='${{ needs.setup.outputs.glibc_version }}'
          fi
          
          GCC_VERSION='${{ needs.setup.outputs.gcc_version }}'
          BINUTILS_VERSION='${{ needs.setup.outputs.binutils_version }}'
          LINUX_VERSION='${{ needs.setup.outputs.linux_version }}'
          
          BUILD_ID="${ARCH_DIR}_${LIBC_DIR}_gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="/tmp/compiler-build-${BUILD_ID}"
          OUTPUT_DIR="${{ env.COMPILER_BASE_DIR }}/${ARCH_DIR}/${LIBC_DIR}/gcc-${GCC_VERSION}_binutils-${BINUTILS_VERSION}"
          
          echo "ğŸ“Š ç¯å¢ƒé…ç½®æ±‡æ€»:"
          echo "  æ„å»ºID: $BUILD_ID"
          echo "  æ„å»ºç›®å½•: $BUILD_DIR"
          echo "  è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "  ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          echo "  æ¶æ„åç§°: $ARCH_NAME"
          echo "  æ¶æ„ç›®å½•: $ARCH_DIR"
          echo "  Cåº“ç›®å½•: $LIBC_DIR"
          echo "  Cåº“ç‰ˆæœ¬: $LIBC_VERSION"
          echo "  ç¼–è¯‘å™¨å‰ç¼€: $PREFIX-"
          echo "  CPUç±»å‹: $CPU_TYPE"
          echo "  è°ƒä¼˜: $TUNE"
          echo "  ABI: $ABI"
          echo "  æµ®ç‚¹ABI: $FLOAT_ABI"
          echo "  GCCç‰ˆæœ¬: $GCC_VERSION"
          echo "  Binutilsç‰ˆæœ¬: $BINUTILS_VERSION"
          echo "  Linuxå†…æ ¸ç‰ˆæœ¬: $LINUX_VERSION"
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "ARCH_DIR=$ARCH_DIR" >> $GITHUB_ENV
          echo "LIBC_DIR=$LIBC_DIR" >> $GITHUB_ENV
          echo "LIBC_VERSION=$LIBC_VERSION" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "TUNE=$TUNE" >> $GITHUB_ENV
          echo "ABI=$ABI" >> $GITHUB_ENV
          echo "FLOAT_ABI=$FLOAT_ABI" >> $GITHUB_ENV
          echo "USE_MUSL=$USE_MUSL" >> $GITHUB_ENV
          echo "USE_GLIBC=$USE_GLIBC" >> $GITHUB_ENV
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "BINUTILS_VERSION=$BINUTILS_VERSION" >> $GITHUB_ENV
          echo "LINUX_VERSION=$LINUX_VERSION" >> $GITHUB_ENV
          echo "LIBC_SUFFIX=$LIBC_SUFFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

      - name: ğŸ”§ å®‰è£…ä¾èµ–ï¼ˆæ ¹æ®ç‰ˆæœ¬è°ƒæ•´ï¼‰
        run: |
          echo "=== å®‰è£…æ„å»ºä¾èµ– ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          echo "GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          GCC_MAJOR=$(echo "${{ env.GCC_VERSION }}" | cut -d. -f1)
          
          echo "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          sudo apt-get update
          
          echo "å®‰è£…åŸºç¡€æ„å»ºå·¥å…·..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison git wget curl file gawk gettext rsync unzip autoconf automake autopoint libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq info install-info liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev libelf-dev libdw-dev libcap-dev libattr1-dev libaudit-dev libiberty-dev
          
          echo "å®‰è£…ç‰ˆæœ¬ç‰¹å®šçš„ä¾èµ–..."
          if [ $GCC_MAJOR -ge 13 ]; then
            echo "GCC 13+ éœ€è¦è¾ƒæ–°çš„ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev python3-distutils libncurses5-dev libssl-dev gnutls-bin liblzma-dev zlib1g-dev
          elif [ $GCC_MAJOR -ge 11 ]; then
            echo "GCC 11-12 ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev libcurl4-gnutls-dev python3 python3-dev python3-distutils libncurses5-dev libssl-dev gnutls-bin liblzma-dev zlib1g-dev
          else
            echo "GCC 10åŠä»¥ä¸‹ç‰ˆæœ¬ä¾èµ–..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev python3 python3-dev libncurses5-dev libssl-dev liblzma-dev zlib1g-dev
          fi
          
          ARCH="${{ github.event.inputs.target_arch }}"
          case "$ARCH" in
            "riscv64")
              echo "RISC-Væ¶æ„éœ€è¦é¢å¤–çš„ä¾èµ–..."
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y device-tree-compiler qemu-system-riscv64 libfdt-dev
              ;;
            "aarch64"|"arm_cortex-a7"|"arm_cortex-a53")
              echo "ARMæ¶æ„ä¾èµ–..."
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
              ;;
          esac
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          echo "å®‰è£…çš„åŒ…ç‰ˆæœ¬:"
          gcc --version | head -1
          make --version | head -1
          python3 --version
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ—‘ï¸ æ¸…ç†æ„å»ºç¼“å­˜
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          echo "=== æ¸…ç†æ„å»ºç¼“å­˜ ==="
          echo "å¼€å§‹æ¸…ç†ç¼“å­˜..."
          sudo rm -rf /tmp/compiler-build-* 2>/dev/null || true
          echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"

      - name: ğŸ“¥ ä¸‹è½½OpenWrtæºç 
        run: |
          echo "=== è·å–OpenWrtæºç  ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "å…‹éš†OpenWrt ${{ env.OPENWRT_VERSION }} åˆ†æ”¯..."
          
          echo "å°è¯•æ–¹æ³•1: å…‹éš†æŒ‡å®šåˆ†æ”¯..."
          if git clone --depth 1 --branch "v${{ env.OPENWRT_VERSION }}" https://github.com/openwrt/openwrt.git .; then
            echo "âœ… Git cloneæˆåŠŸ"
          else
            echo "æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2: å…‹éš†ä¸»åˆ†æ”¯ç„¶ååˆ‡æ¢..."
            git clone --depth 1 https://github.com/openwrt/openwrt.git .
            if git checkout "v${{ env.OPENWRT_VERSION }}"; then
              echo "âœ… åˆ‡æ¢ç‰ˆæœ¬æˆåŠŸ"
            else
              echo "æ–¹æ³•2å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3: ä½¿ç”¨taråŒ…..."
              wget -q --show-progress -O openwrt.tar.xz "https://github.com/openwrt/openwrt/archive/refs/tags/v${{ env.OPENWRT_VERSION }}.tar.gz"
              if [ $? -eq 0 ]; then
                tar -xzf openwrt.tar.xz --strip-components=1
                rm -f openwrt.tar.xz
                echo "âœ… ä½¿ç”¨taråŒ…ä¸‹è½½æˆåŠŸ"
              else
                echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹æ³•éƒ½å¤±è´¥"
                exit 1
              fi
            fi
          fi
          
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"
          echo "OpenWrtç‰ˆæœ¬ç¡®è®¤:"
          grep "VERSION_NUMBER" include/version.mk 2>/dev/null || echo "ç‰ˆæœ¬æ–‡ä»¶æœªæ‰¾åˆ°"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ“ ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰
        run: |
          echo "=== ç”ŸæˆOpenWrté…ç½®ï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          echo "ä½¿ç”¨ç‰ˆæœ¬:"
          echo "- GCC: ${{ env.GCC_VERSION }}"
          echo "- Binutils: ${{ env.BINUTILS_VERSION }}"
          echo "- Linux: ${{ env.LINUX_VERSION }}"
          echo "- Cåº“ç‰ˆæœ¬: ${{ env.LIBC_VERSION }}"
          echo "- Cåº“ç±»å‹: ${{ env.LIBC_DIR }}"
          echo "- ç›®æ ‡: ${{ env.TARGET }}"
          echo "- å­ç›®æ ‡: ${{ env.SUBTARGET }}"
          echo "- æ¶æ„: ${{ env.ARCH_NAME }}"
          echo "- ç¼–è¯‘å™¨å‰ç¼€: ${{ env.PREFIX }}-"
          
          echo "æ­¥éª¤1: æ¸…ç†æ‰€æœ‰ç°æœ‰é…ç½®..."
          rm -f .config .config.old .config.cmd 2>/dev/null || true
          
          echo "æ­¥éª¤2: åˆ›å»ºsiteé…ç½®ç›®å½•..."
          mkdir -p include/site
          
          echo "æ­¥éª¤3: ç”Ÿæˆsiteé…ç½®..."
          echo "ac_cv_sys_file_offset_bits=64" > include/site/${{ env.ARCH_NAME }}
          echo "ac_cv_sys_large_files=yes" >> include/site/${{ env.ARCH_NAME }}
          
          case "${{ env.ARCH_NAME }}" in
            "mips")
              echo "ac_cv_c_bigendian=yes" >> include/site/${{ env.ARCH_NAME }}
              ;;
            *)
              echo "ac_cv_c_bigendian=no" >> include/site/${{ env.ARCH_NAME }}
              ;;
          esac
          
          CONFIG_FILE=".config"
          echo "æ­¥éª¤4: ç”Ÿæˆä¸»é…ç½®æ–‡ä»¶: $CONFIG_FILE"
          
          echo "# ç›®æ ‡é…ç½®" > $CONFIG_FILE
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"" >> $CONFIG_FILE
          echo "CONFIG_TARGET_PREFIX=\"${{ env.PREFIX }}-\"" >> $CONFIG_FILE
          echo "CONFIG_EXTERNAL_TOOLCHAIN=n" >> $CONFIG_FILE
          echo "CONFIG_USE_MUSL=${{ env.USE_MUSL }}" >> $CONFIG_FILE
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> $CONFIG_FILE
          echo "CONFIG_GCC_VERSION=\"${{ env.GCC_VERSION }}\"" >> $CONFIG_FILE
          echo "CONFIG_BINUTILS_VERSION=\"${{ env.BINUTILS_VERSION }}\"" >> $CONFIG_FILE
          echo "CONFIG_LINUX_VERSION=\"${{ env.LINUX_VERSION }}\"" >> $CONFIG_FILE
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "CONFIG_MUSL_VERSION=\"${{ env.LIBC_VERSION }}\"" >> $CONFIG_FILE
          else
            echo "CONFIG_GLIBC_VERSION=\"${{ env.LIBC_VERSION }}\"" >> $CONFIG_FILE
          fi
          
          echo "# ä¼˜åŒ–æ„å»ºé…ç½®" >> $CONFIG_FILE
          echo "CONFIG_ALL=n" >> $CONFIG_FILE
          echo "CONFIG_ALL_KMODS=n" >> $CONFIG_FILE
          echo "CONFIG_ALL_NONSHARED=n" >> $CONFIG_FILE
          echo "CONFIG_DEVEL=y" >> $CONFIG_FILE
          echo "CONFIG_CCACHE=n" >> $CONFIG_FILE
          echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> $CONFIG_FILE
          echo "CONFIG_SDK=y" >> $CONFIG_FILE
          echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> $CONFIG_FILE
          echo "CONFIG_BUILD_PATENTED=y" >> $CONFIG_FILE
          echo "CONFIG_BUILD_NLS=y" >> $CONFIG_FILE
          echo "CONFIG_USE_LIBSTDCXX=y" >> $CONFIG_FILE

          GCC_MAJOR=$(echo "${{ env.GCC_VERSION }}" | cut -d. -f1)
          if [ $GCC_MAJOR -ge 11 ]; then
            echo "# GCC 11+ ä¼˜åŒ–é€‰é¡¹" >> $CONFIG_FILE
            echo "CONFIG_GCC_USE_VERSION_${GCC_MAJOR}=y" >> $CONFIG_FILE
            echo "CONFIG_GCC_USE_GRAPHITE=y" >> $CONFIG_FILE
          fi
          
          echo "# ç¦ç”¨å…¶ä»–ç›®æ ‡ï¼ˆé˜²æ­¢é»˜è®¤é…ç½®è¦†ç›–ï¼‰" >> $CONFIG_FILE
          TARGETS_TO_DISABLE="ath79 ath79_generic bcm27xx bcm53xx ipq40xx ipq806x lantiq layerscape mediatek mpc85xx mvebu octeon octeontx oxnas pistachio ramips rockchip sunxi tegra x86 arc arm64 armsr bcm47xx bcm4908 bmips brcm2708 brcm47xx brcm63xx cns3xxx gemini imx6 kirkwood malta mxs omap orion pxa samsung sifiveu socfpga uml zynq"
          for target in $TARGETS_TO_DISABLE; do
            echo "CONFIG_TARGET_${target}=n" >> $CONFIG_FILE
          done

          echo "# ç¡®è®¤å¯ç”¨æˆ‘ä»¬çš„ç›®æ ‡" >> $CONFIG_FILE
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> $CONFIG_FILE
          
          echo "é…ç½®æ–‡ä»¶å¤§å°: $(wc -l < $CONFIG_FILE) è¡Œ"
          echo "é…ç½®æ‘˜è¦:"
          echo "------------------------------"
          cat $CONFIG_FILE | grep -E "CONFIG_TARGET_|CONFIG_GCC|CONFIG_BINUTILS|CONFIG_.*LIBC|CONFIG_USE_MUSL|CONFIG_BUILD_TOOLCHAIN|CONFIG_TARGET_ARCH"
          echo "------------------------------"
          
          echo "éªŒè¯é…ç½®..."
          if grep -q "CONFIG_GCC_VERSION=\"${{ env.GCC_VERSION }}\"" $CONFIG_FILE; then
            echo "âœ… GCCç‰ˆæœ¬æ­£ç¡®å†™å…¥: ${{ env.GCC_VERSION }}"
          else
            echo "âŒ GCCç‰ˆæœ¬æœªæ­£ç¡®å†™å…¥"
            exit 1
          fi
          
          if grep -q "CONFIG_TARGET_${{ env.TARGET }}=y" $CONFIG_FILE; then
            echo "âœ… ç›®æ ‡æ­£ç¡®è®¾ç½®: ${{ env.TARGET }}"
          else
            echo "âŒ ç›®æ ‡æœªæ­£ç¡®è®¾ç½®"
            exit 1
          fi
          
          if grep -q "CONFIG_TARGET_ARCH=\"${{ env.ARCH_NAME }}\"" $CONFIG_FILE; then
            echo "âœ… æ¶æ„æ­£ç¡®è®¾ç½®: ${{ env.ARCH_NAME }}"
          else
            echo "âŒ æ¶æ„æœªæ­£ç¡®è®¾ç½®"
            exit 1
          fi
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            if grep -q "CONFIG_MUSL_VERSION=\"${{ env.LIBC_VERSION }}\"" $CONFIG_FILE; then
              echo "âœ… Muslç‰ˆæœ¬æ­£ç¡®å†™å…¥: ${{ env.LIBC_VERSION }}"
            else
              echo "âŒ Muslç‰ˆæœ¬æœªæ­£ç¡®å†™å…¥"
              exit 1
            fi
          else
            if grep -q "CONFIG_GLIBC_VERSION=\"${{ env.LIBC_VERSION }}\"" $CONFIG_FILE; then
              echo "âœ… Glibcç‰ˆæœ¬æ­£ç¡®å†™å…¥: ${{ env.LIBC_VERSION }}"
            else
              echo "âŒ Glibcç‰ˆæœ¬æœªæ­£ç¡®å†™å…¥"
              exit 1
            fi
          fi
          
          echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ› ï¸ åº”ç”¨é…ç½®ï¼ˆå¼ºåˆ¶ï¼‰
        run: |
          echo "=== åº”ç”¨é…ç½®ï¼ˆå¼ºåˆ¶ï¼‰==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          
          echo "æ­¥éª¤1: æ˜¾ç¤ºå½“å‰.configæ–‡ä»¶..."
          echo "å‰30è¡Œå†…å®¹:"
          head -30 .config
          
          echo "æ­¥éª¤2: å¤‡ä»½å½“å‰é…ç½®..."
          cp .config .config.backup
          
          echo "æ­¥éª¤3: è¿è¡Œdefconfig..."
          make defconfig 2>&1 | tee /tmp/defconfig1.log
          DEFCONFIG_STATUS=${PIPESTATUS[0]}
          
          if [ $DEFCONFIG_STATUS -eq 0 ]; then
            echo "âœ… defconfigæˆåŠŸ"
          else
            echo "âš ï¸ defconfigæœ‰è­¦å‘Šï¼ŒçŠ¶æ€ç : $DEFCONFIG_STATUS"
          fi
          
          echo "æ­¥éª¤4: æ£€æŸ¥å¹¶ä¿®å¤é…ç½®..."
          echo "ğŸ”§ å·¥å…·é“¾é…ç½®æ£€æŸ¥:"
          
          if ! grep -q "CONFIG_BUILD_TOOLCHAIN=y" .config; then
            echo "âŒ æ„å»ºå·¥å…·é“¾æœªå¯ç”¨ï¼Œæ‰‹åŠ¨å¯ç”¨..."
            echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          else
            echo "âœ… æ„å»ºå·¥å…·é“¾å·²å¯ç”¨"
          fi
          
          GCC_CONF=$(grep 'CONFIG_GCC_VERSION=' .config | cut -d'"' -f2)
          EXPECTED_GCC="${{ env.GCC_VERSION }}"
          echo "GCCç‰ˆæœ¬: é…ç½®=$GCC_CONF, æœŸæœ›=$EXPECTED_GCC"
          if [ "$GCC_CONF" != "$EXPECTED_GCC" ]; then
            echo "âŒ GCCç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæ‰‹åŠ¨ä¿®å¤..."
            sed -i "/CONFIG_GCC_VERSION=/d" .config
            echo "CONFIG_GCC_VERSION=\"$EXPECTED_GCC\"" >> .config
            echo "âœ… GCCç‰ˆæœ¬ä¿®å¤ä¸º: $EXPECTED_GCC"
          else
            echo "âœ… GCCç‰ˆæœ¬åŒ¹é…"
          fi
          
          BINUTILS_CONF=$(grep 'CONFIG_BINUTILS_VERSION=' .config | cut -d'"' -f2)
          EXPECTED_BINUTILS="${{ env.BINUTILS_VERSION }}"
          echo "Binutilsç‰ˆæœ¬: é…ç½®=$BINUTILS_CONF, æœŸæœ›=$EXPECTED_BINUTILS"
          if [ "$BINUTILS_CONF" != "$EXPECTED_BINUTILS" ]; then
            echo "âŒ Binutilsç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæ‰‹åŠ¨ä¿®å¤..."
            sed -i "/CONFIG_BINUTILS_VERSION=/d" .config
            echo "CONFIG_BINUTILS_VERSION=\"$EXPECTED_BINUTILS\"" >> .config
            echo "âœ… Binutilsç‰ˆæœ¬ä¿®å¤ä¸º: $EXPECTED_BINUTILS"
          else
            echo "âœ… Binutilsç‰ˆæœ¬åŒ¹é…"
          fi
          
          LINUX_CONF=$(grep 'CONFIG_LINUX_VERSION=' .config | cut -d'"' -f2)
          EXPECTED_LINUX="${{ env.LINUX_VERSION }}"
          echo "Linuxå†…æ ¸ç‰ˆæœ¬: é…ç½®=$LINUX_CONF, æœŸæœ›=$EXPECTED_LINUX"
          if [ "$LINUX_CONF" != "$EXPECTED_LINUX" ]; then
            echo "âŒ Linuxå†…æ ¸ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæ‰‹åŠ¨ä¿®å¤..."
            sed -i "/CONFIG_LINUX_VERSION=/d" .config
            echo "CONFIG_LINUX_VERSION=\"$EXPECTED_LINUX\"" >> .config
            echo "âœ… Linuxå†…æ ¸ç‰ˆæœ¬ä¿®å¤ä¸º: $EXPECTED_LINUX"
          else
            echo "âœ… Linuxå†…æ ¸ç‰ˆæœ¬åŒ¹é…"
          fi
          
          echo "ğŸ“š Cåº“é…ç½®æ£€æŸ¥:"
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            if ! grep -q "CONFIG_USE_MUSL=y" .config; then
              echo "âŒ Muslæœªå¯ç”¨ï¼Œæ‰‹åŠ¨å¯ç”¨..."
              sed -i "/CONFIG_USE_MUSL=/d" .config
              echo "CONFIG_USE_MUSL=y" >> .config
            else
              echo "âœ… Muslå·²å¯ç”¨"
            fi
            
            MUSL_CONF=$(grep 'CONFIG_MUSL_VERSION=' .config | cut -d'"' -f2)
            EXPECTED_MUSL="${{ env.LIBC_VERSION }}"
            echo "Muslç‰ˆæœ¬: é…ç½®=$MUSL_CONF, æœŸæœ›=$EXPECTED_MUSL"
            if [ "$MUSL_CONF" != "$EXPECTED_MUSL" ]; then
              echo "âŒ Muslç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæ‰‹åŠ¨ä¿®å¤..."
              sed -i "/CONFIG_MUSL_VERSION=/d" .config
              echo "CONFIG_MUSL_VERSION=\"$EXPECTED_MUSL\"" >> .config
              echo "âœ… Muslç‰ˆæœ¬ä¿®å¤ä¸º: $EXPECTED_MUSL"
            else
              echo "âœ… Muslç‰ˆæœ¬åŒ¹é…"
            fi
          else
            if ! grep -q "CONFIG_USE_MUSL=n" .config; then
              echo "âŒ Glibcæœªæ­£ç¡®é…ç½®ï¼Œæ‰‹åŠ¨é…ç½®..."
              sed -i "/CONFIG_USE_MUSL=/d" .config
              echo "CONFIG_USE_MUSL=n" >> .config
            else
              echo "âœ… Glibcå·²å¯ç”¨"
            fi
            
            GLIBC_CONF=$(grep 'CONFIG_GLIBC_VERSION=' .config | cut -d'"' -f2)
            EXPECTED_GLIBC="${{ env.LIBC_VERSION }}"
            echo "Glibcç‰ˆæœ¬: é…ç½®=$GLIBC_CONF, æœŸæœ›=$EXPECTED_GLIBC"
            if [ "$GLIBC_CONF" != "$EXPECTED_GLIBC" ]; then
              echo "âŒ Glibcç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæ‰‹åŠ¨ä¿®å¤..."
              sed -i "/CONFIG_GLIBC_VERSION=/d" .config
              echo "CONFIG_GLIBC_VERSION=\"$EXPECTED_GLIBC\"" >> .config
              echo "âœ… Glibcç‰ˆæœ¬ä¿®å¤ä¸º: $EXPECTED_GLIBC"
            else
              echo "âœ… Glibcç‰ˆæœ¬åŒ¹é…"
            fi
          fi
          
          echo "ğŸ¯ ç›®æ ‡å¹³å°æ£€æŸ¥:"
          TARGET_CONF=$(grep 'CONFIG_TARGET_' .config | grep '=y' | head -1 | cut -d'=' -f1 | sed 's/CONFIG_TARGET_//')
          EXPECTED_TARGET="${{ env.TARGET }}"
          echo "ç›®æ ‡: é…ç½®=$TARGET_CONF, æœŸæœ›=$EXPECTED_TARGET"
          if [ "$TARGET_CONF" != "$EXPECTED_TARGET" ]; then
            echo "âŒ ç›®æ ‡ä¸åŒ¹é…ï¼Œæ‰‹åŠ¨ä¿®å¤..."
            sed -i '/CONFIG_TARGET_[a-zA-Z0-9]*=y/d' .config
            echo "CONFIG_TARGET_$EXPECTED_TARGET=y" >> .config
            echo "CONFIG_TARGET_${EXPECTED_TARGET}_${{ env.SUBTARGET }}=y" >> .config
            echo "âœ… ç›®æ ‡ä¿®å¤ä¸º: $EXPECTED_TARGET"
          else
            echo "âœ… ç›®æ ‡åŒ¹é…"
          fi
          
          ARCH_CONF=$(grep 'CONFIG_TARGET_ARCH=' .config | cut -d'"' -f2)
          EXPECTED_ARCH="${{ env.ARCH_NAME }}"
          echo "æ¶æ„: é…ç½®=$ARCH_CONF, æœŸæœ›=$EXPECTED_ARCH"
          if [ "$ARCH_CONF" != "$EXPECTED_ARCH" ]; then
            echo "âŒ æ¶æ„ä¸åŒ¹é…ï¼Œæ‰‹åŠ¨ä¿®å¤..."
            sed -i "/CONFIG_TARGET_ARCH=/d" .config
            echo "CONFIG_TARGET_ARCH=\"$EXPECTED_ARCH\"" >> .config
            echo "âœ… æ¶æ„ä¿®å¤ä¸º: $EXPECTED_ARCH"
          else
            echo "âœ… æ¶æ„åŒ¹é…"
          fi
          
          PREFIX_CONF=$(grep 'CONFIG_TARGET_PREFIX=' .config | cut -d'"' -f2)
          EXPECTED_PREFIX="${{ env.PREFIX }}-"
          echo "ç¼–è¯‘å™¨å‰ç¼€: é…ç½®=$PREFIX_CONF, æœŸæœ›=$EXPECTED_PREFIX"
          if [ "$PREFIX_CONF" != "$EXPECTED_PREFIX" ]; then
            echo "âŒ ç¼–è¯‘å™¨å‰ç¼€ä¸åŒ¹é…ï¼Œæ‰‹åŠ¨ä¿®å¤..."
            sed -i "/CONFIG_TARGET_PREFIX=/d" .config
            echo "CONFIG_TARGET_PREFIX=\"$EXPECTED_PREFIX\"" >> .config
            echo "âœ… ç¼–è¯‘å™¨å‰ç¼€ä¿®å¤ä¸º: $EXPECTED_PREFIX"
          else
            echo "âœ… ç¼–è¯‘å™¨å‰ç¼€åŒ¹é…"
          fi
          
          echo "æ­¥éª¤5: å†æ¬¡è¿è¡Œdefconfigç¡®ä¿é…ç½®ä¸€è‡´..."
          make defconfig 2>&1 | tee /tmp/defconfig2.log
          
          echo "æ­¥éª¤6: æ˜¾ç¤ºæœ€ç»ˆé…ç½®æ‘˜è¦..."
          echo "=============================="
          echo "        æœ€ç»ˆé…ç½®æ‘˜è¦          "
          echo "=============================="
          
          echo "ğŸ”§ å…³é”®é…ç½®:"
          echo "  ğŸ” GCCç‰ˆæœ¬: $(grep 'CONFIG_GCC_VERSION=' .config | cut -d'"' -f2)"
          echo "  ğŸ” Binutilsç‰ˆæœ¬: $(grep 'CONFIG_BINUTILS_VERSION=' .config | cut -d'"' -f2)"
          echo "  ğŸ” Linuxå†…æ ¸ç‰ˆæœ¬: $(grep 'CONFIG_LINUX_VERSION=' .config | cut -d'"' -f2)"
          echo "  ğŸ” ç›®æ ‡: $(grep 'CONFIG_TARGET_' .config | grep '=y' | head -1)"
          echo "  ğŸ” æ¶æ„: $(grep 'CONFIG_TARGET_ARCH=' .config | cut -d'"' -f2)"
          echo "  ğŸ” ç¼–è¯‘å™¨å‰ç¼€: $(grep 'CONFIG_TARGET_PREFIX=' .config | cut -d'"' -f2)"
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            echo "  ğŸ” Muslç‰ˆæœ¬: $(grep 'CONFIG_MUSL_VERSION=' .config | cut -d'"' -f2)"
          else
            echo "  ğŸ” Glibcç‰ˆæœ¬: $(grep 'CONFIG_GLIBC_VERSION=' .config | cut -d'"' -f2)"
          fi
          
          echo "æ­¥éª¤7: éªŒè¯é…ç½®å®Œæ•´æ€§..."
          ALL_CORRECT=true
          
          if grep -q "CONFIG_GCC_VERSION=\"${{ env.GCC_VERSION }}\"" .config; then
            echo "âœ… GCCç‰ˆæœ¬éªŒè¯é€šè¿‡"
          else
            echo "âŒ GCCç‰ˆæœ¬éªŒè¯å¤±è´¥"
            ALL_CORRECT=false
          fi
          
          if grep -q "CONFIG_TARGET_${{ env.TARGET }}=y" .config; then
            echo "âœ… ç›®æ ‡éªŒè¯é€šè¿‡"
          else
            echo "âŒ ç›®æ ‡éªŒè¯å¤±è´¥"
            ALL_CORRECT=false
          fi
          
          if grep -q "CONFIG_BUILD_TOOLCHAIN=y" .config; then
            echo "âœ… æ„å»ºå·¥å…·é“¾éªŒè¯é€šè¿‡"
          else
            echo "âŒ æ„å»ºå·¥å…·é“¾éªŒè¯å¤±è´¥"
            ALL_CORRECT=false
          fi
          
          if [ "$ALL_CORRECT" = true ]; then
            echo "âœ… æ‰€æœ‰é…ç½®éªŒè¯é€šè¿‡"
          else
            echo "âŒ é…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            exit 1
          fi
          
          echo "=============================="
          echo "âœ… é…ç½®å¼ºåˆ¶åº”ç”¨å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ”¨ ç¼–è¯‘å·¥å…·é“¾ï¼ˆç‰ˆæœ¬é€‚é…ï¼‰
        timeout-minutes: 150
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å·¥å…·é“¾ï¼ˆç‰ˆæœ¬é€‚é…ï¼‰==="
          cd "${{ env.BUILD_DIR }}"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          export ABI=64
          export CC="gcc"
          export CXX="g++"
          export MAKEFLAGS="-j$(nproc)"
          
          echo "ç³»ç»Ÿä¿¡æ¯:"
          echo "- CPUæ ¸å¿ƒ: $(nproc)"
          echo "- å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
          echo "- ç£ç›˜ç©ºé—´:"
          df -h .
          
          echo "æ„å»ºç¯å¢ƒä¿¡æ¯:"
          echo "- GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ env.BINUTILS_VERSION }}"
          echo "- Linuxå†…æ ¸ç‰ˆæœ¬: ${{ env.LINUX_VERSION }}"
          echo "- Cåº“ç‰ˆæœ¬: ${{ env.LIBC_VERSION }}"
          
          echo "æ­¥éª¤1: åˆ›å»ºhostå·¥å…·ç›®å½•..."
          mkdir -p staging_dir/host/bin
          mkdir -p staging_dir/host/lib
          mkdir -p staging_dir/host/include
          
          echo "æ­¥éª¤2: æœ€ç»ˆé…ç½®æ£€æŸ¥..."
          echo "å½“å‰é…ç½®:"
          grep -E "CONFIG_GCC_VERSION|CONFIG_BINUTILS_VERSION|CONFIG_TARGET_|CONFIG_BUILD_TOOLCHAIN" .config
          
          echo "æ­¥éª¤3: ä¸‹è½½æºç åŒ…..."
          mkdir -p dl
          echo "å¼€å§‹ä¸‹è½½å·¥å…·é“¾æºç ..."
          
          echo "ä¸‹è½½å…³é”®åŒ…..."
          for pkg in gcc binutils linux; do
            echo "ä¸‹è½½ $pkg..."
            make package/toolchain/$pkg/download V=s 2>&1 | tail -20
          done
          
          echo "ä¸‹è½½æ‰€æœ‰å¿…è¦çš„åŒ…..."
          make -j1 download V=s 2>&1 | tee /tmp/download.log
          DOWNLOAD_STATUS=${PIPESTATUS[0]}
          if [ $DOWNLOAD_STATUS -eq 0 ]; then
            echo "âœ… ä¸‹è½½æˆåŠŸ"
          else
            echo "âš ï¸ ä¸‹è½½æœ‰è­¦å‘Šï¼Œç»§ç»­å°è¯•..."
            echo "ä¸‹è½½çŠ¶æ€: $DOWNLOAD_STATUS"
          fi
          
          echo "æ£€æŸ¥å…³é”®åŒ…ä¸‹è½½æƒ…å†µ:"
          for pkg in gcc binutils linux; do
            pkg_files=$(find dl -name "${pkg}-*.tar.*" -o -name "${pkg}-*.tar.gz" -o -name "${pkg}-*.tar.bz2" 2>/dev/null | wc -l)
            if [ $pkg_files -gt 0 ]; then
              echo "  âœ… $pkg: æ‰¾åˆ° $pkg_files ä¸ªæ–‡ä»¶"
              find dl -name "${pkg}-*" -type f 2>/dev/null | head -2 | xargs -I {} basename {}
            else
              echo "  âŒ $pkg: æœªæ‰¾åˆ°"
            fi
          done
          
          if [ "${{ env.USE_MUSL }}" = "y" ]; then
            musl_files=$(find dl -name "musl-*.tar.*" 2>/dev/null | wc -l)
            if [ $musl_files -gt 0 ]; then
              echo "  âœ… musl: æ‰¾åˆ° $musl_files ä¸ªæ–‡ä»¶"
            else
              echo "  âŒ musl: æœªæ‰¾åˆ°"
            fi
          fi
          
          echo "æ­¥éª¤4: ç¼–è¯‘å·¥å…·é“¾..."
          echo "å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) ä¸ªæ ¸å¿ƒ..."
          
          echo "å­æ­¥éª¤4.1: å‡†å¤‡å·¥å…·é“¾..."
          make toolchain/prepare -j$(nproc) V=s 2>&1 | tee /tmp/prepare.log
          PREPARE_STATUS=${PIPESTATUS[0]}
          
          if [ $PREPARE_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾å‡†å¤‡æˆåŠŸ"
          else
            echo "âš ï¸ å·¥å…·é“¾å‡†å¤‡æœ‰è­¦å‘Š"
          fi
          
          echo "å­æ­¥éª¤4.2: ç¼–è¯‘å·¥å…·é“¾..."
          make toolchain/compile -j$(nproc) V=s 2>&1 | tee /tmp/compile.log
          COMPILE_STATUS=${PIPESTATUS[0]}
          
          if [ $COMPILE_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼ŒçŠ¶æ€ç : $COMPILE_STATUS"
            echo "é”™è¯¯æ‘˜è¦:"
            grep -E "Error:|error:|failed:" /tmp/compile.log | tail -30
            echo "å°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            make toolchain/compile -j1 V=s 2>&1 | tee /tmp/compile-single.log
            COMPILE_SINGLE_STATUS=${PIPESTATUS[0]}
            if [ $COMPILE_SINGLE_STATUS -eq 0 ]; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•éƒ½å¤±è´¥"
              exit 1
            fi
          fi
          
          echo "æ­¥éª¤5: å®‰è£…å·¥å…·é“¾..."
          make toolchain/install -j$(nproc) V=s 2>&1 | tee /tmp/install.log
          INSTALL_STATUS=${PIPESTATUS[0]}
          if [ $INSTALL_STATUS -eq 0 ]; then
            echo "âœ… å·¥å…·é“¾å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ å®‰è£…æœ‰è­¦å‘Šï¼ŒçŠ¶æ€ç : $INSTALL_STATUS"
            echo "è­¦å‘Šæ‘˜è¦:"
            grep -E "Warning:|warning:" /tmp/install.log | tail -10
          fi
          
          echo "âœ… å·¥å…·é“¾æ„å»ºå®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"
          echo "æ„å»ºç›®å½•å¤§å°: $(du -sh . | cut -f1)"

      - name: âœ… éªŒè¯æ„å»ºç»“æœï¼ˆå®Œæ•´å·¥å…·é“¾ï¼‰
        run: |
          echo "=== éªŒè¯æ„å»ºç»“æœï¼ˆå®Œæ•´å·¥å…·é“¾ï¼‰==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          echo "æŸ¥æ‰¾å·¥å…·é“¾ç›®å½•..."
          TOOLCHAIN_DIR=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null | head -1)
          
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°å·¥å…·é“¾ç›®å½•"
            echo "å°è¯•å…¶ä»–å¯èƒ½çš„ç›®å½•..."
            for path in staging_dir/toolchain staging_dir/host staging_dir/target-*; do
              if [ -d "$path" ]; then
                echo "æ£€æŸ¥: $path"
                find "$path" -name "*gcc" -type f 2>/dev/null | head -3
              fi
            done
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          echo "ç›®å½•å¤§å°: $(du -sh "$TOOLCHAIN_DIR" | cut -f1)"
          
          echo "æŸ¥æ‰¾ç¼–è¯‘å™¨..."
          COMPILER_PATH=""
          
          SEARCH_PATHS=("$TOOLCHAIN_DIR/bin" "$TOOLCHAIN_DIR/usr/bin" "$TOOLCHAIN_DIR/libexec/gcc/*/*" "$TOOLCHAIN_DIR")
          
          for search_path in "${SEARCH_PATHS[@]}"; do
            if [ -d "$(dirname "$search_path" 2>/dev/null)" ] || [ -d "$search_path" ]; then
              found=$(find $search_path -name "*gcc" -type f 2>/dev/null | head -1)
              if [ -n "$found" ]; then
                COMPILER_PATH="$found"
                echo "åœ¨ $search_path ä¸­æ‰¾åˆ°: $found"
                break
              fi
            fi
          done
          
          if [ -z "$COMPILER_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘å™¨"
            echo "å°è¯•æ›´å¹¿æ³›çš„æœç´¢..."
            find "$TOOLCHAIN_DIR" -type f -name "*gcc*" 2>/dev/null | head -20
            exit 1
          fi
          
          if [ ! -x "$COMPILER_PATH" ]; then
            echo "âŒ ç¼–è¯‘å™¨ä¸å¯æ‰§è¡Œ: $COMPILER_PATH"
            ls -la "$COMPILER_PATH"
            exit 1
          fi
          
          COMPILER_NAME=$(basename "$COMPILER_PATH")
          echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $COMPILER_NAME"
          echo "å®Œæ•´è·¯å¾„: $COMPILER_PATH"
          
          echo "ç¼–è¯‘å™¨ä¿¡æ¯:"
          "$COMPILER_PATH" --version 2>&1 | head -5
          
          echo "ç›®æ ‡ä¸‰å…ƒç»„:"
          TARGET_TRIPLET=$("$COMPILER_PATH" -dumpmachine 2>&1)
          echo "$TARGET_TRIPLET"
          
          echo "æµ‹è¯•äº¤å‰ç¼–è¯‘..."
          echo '#include <stdio.h>' > test.c
          echo '#include <stdlib.h>' >> test.c
          echo 'int main() {' >> test.c
          echo '    printf("Cross-compiler test OK\\n");' >> test.c
          echo '    return 0;' >> test.c
          echo '}' >> test.c
          
          "$COMPILER_PATH" test.c -o test_program 2>&1
          COMPILE_TEST_STATUS=$?
          
          if [ $COMPILE_TEST_STATUS -eq 0 ] && [ -f "test_program" ]; then
            echo "âœ… äº¤å‰ç¼–è¯‘æµ‹è¯•é€šè¿‡"
            echo "ç”Ÿæˆæ–‡ä»¶ç±»å‹:"
            file test_program
            rm -f test.c test_program
          else
            echo "âŒ äº¤å‰ç¼–è¯‘æµ‹è¯•å¤±è´¥"
            cat test.c
            exit 1
          fi
          
          echo "==================== å®Œæ•´å·¥å…·é“¾æ£€æŸ¥ ===================="
          
          if [[ "$COMPILER_NAME" == *"gcc" ]]; then
            TOOL_PREFIX="${COMPILER_NAME%gcc}"
          else
            TOOL_PREFIX="$TARGET_TRIPLET-"
          fi
          
          echo "å·¥å…·å‰ç¼€: $TOOL_PREFIX"
          
          TOOL_CATEGORIES_KEYS=("ç¼–è¯‘å™¨" "æ±‡ç¼–å™¨" "é“¾æ¥å™¨" "å½’æ¡£å™¨" "ç¬¦å·å·¥å…·" "è°ƒè¯•å·¥å…·" "é¢„å¤„ç†" "å…¶ä»–å·¥å…·" "è¿è¡Œæ—¶")
          TOOL_CATEGORIES_VALUES=("gcc g++ cpp gfortran gcov gcov-dump gcov-tool" "as gas" "ld ld.bfd ld.gold lld" "ar ranlib" "nm objdump objcopy strip strings size readelf addr2line" "gdb gdbserver" "cpp cpp0" "elfedit windres dlltool" "ldd ld.so")
          
          BIN_PATHS=("$TOOLCHAIN_DIR/bin" "$TOOLCHAIN_DIR/usr/bin" "$TOOLCHAIN_DIR/usr/sbin" "$TOOLCHAIN_DIR/sbin" "$TOOLCHAIN_DIR/libexec/gcc/*/*" "$TOOLCHAIN_DIR")
          
          echo "ğŸ” æœç´¢å·¥å…·é“¾ç›®å½•: $TOOLCHAIN_DIR"
          echo ""
          
          MISSING_CRITICAL=()
          MISSING_IMPORTANT=()
          ALL_FOUND=()
          
          for i in "${!TOOL_CATEGORIES_KEYS[@]}"; do
            category="${TOOL_CATEGORIES_KEYS[$i]}"
            tools_str="${TOOL_CATEGORIES_VALUES[$i]}"
            tools=($tools_str)
            
            echo "ğŸ“‹ $category:"
            category_missing=()
            
            for tool_base in "${tools[@]}"; do
              tool_name="${TOOL_PREFIX}${tool_base}"
              tool_found=""
              
              for bin_path in "${BIN_PATHS[@]}"; do
                if [ -d "$(dirname "$bin_path" 2>/dev/null)" ] || [ -d "$bin_path" ]; then
                  tool_path=$(find $bin_path -name "$tool_name" -type f 2>/dev/null | head -1)
                  
                  if [ -z "$tool_path" ]; then
                    tool_path=$(find $bin_path -name "$tool_base" -type f 2>/dev/null | head -1)
                  fi
                  
                  if [ -n "$tool_path" ] && [ -x "$tool_path" ]; then
                    tool_found="$tool_path"
                    break
                  fi
                fi
              done
              
              if [ -n "$tool_found" ]; then
                echo "  âœ… $tool_base: $(basename "$tool_found")"
                ALL_FOUND+=("$tool_base:$tool_found")
              else
                echo "  âš ï¸  $tool_base: æœªæ‰¾åˆ°"
                category_missing+=("$tool_base")
                
                case "$category" in
                  "ç¼–è¯‘å™¨"|"é“¾æ¥å™¨"|"æ±‡ç¼–å™¨")
                    MISSING_CRITICAL+=("$tool_base")
                    ;;
                  "å½’æ¡£å™¨"|"ç¬¦å·å·¥å…·")
                    MISSING_IMPORTANT+=("$tool_base")
                    ;;
                esac
              fi
            done
            
            if [ ${#category_missing[@]} -gt 0 ]; then
              echo "  ç¼ºå¤±: ${category_missing[*]}"
            fi
            echo ""
          done
          
          echo "ğŸ“‹ è¿è¡Œæ—¶åº“æ£€æŸ¥:"
          LIBC_PATHS=("$TOOLCHAIN_DIR/lib" "$TOOLCHAIN_DIR/usr/lib" "$TOOLCHAIN_DIR/lib64" "$TOOLCHAIN_DIR/usr/lib64")
          
          LIBC_FOUND=false
          for lib_path in "${LIBC_PATHS[@]}"; do
            if [ -d "$lib_path" ]; then
              libc_file=$(find "$lib_path" -name "libc.so.*" -o -name "libc.a" -o -name "libc.so" 2>/dev/null | head -1)
              if [ -n "$libc_file" ]; then
                echo "  âœ… æ‰¾åˆ°Cåº“: $(basename "$libc_file")"
                LIBC_FOUND=true
                break
              fi
            fi
          done
          
          if [ "$LIBC_FOUND" = false ]; then
            echo "  âš ï¸  æœªæ‰¾åˆ°Cåº“"
          fi
          
          HEADER_PATHS=("$TOOLCHAIN_DIR/include" "$TOOLCHAIN_DIR/usr/include" "$TOOLCHAIN_DIR/sysroot/include")
          
          HEADER_FOUND=false
          for header_path in "${HEADER_PATHS[@]}"; do
            if [ -f "$header_path/stdio.h" ] || [ -f "$header_path/stdlib.h" ]; then
              echo "  âœ… æ‰¾åˆ°å¤´æ–‡ä»¶ç›®å½•: $header_path"
              HEADER_FOUND=true
              break
            fi
          done
          
          if [ "$HEADER_FOUND" = false ]; then
            echo "  âš ï¸  æœªæ‰¾åˆ°æ ‡å‡†å¤´æ–‡ä»¶"
          fi
          
          echo ""
          echo "==================== æ£€æŸ¥æ€»ç»“ ===================="
          
          CORE_TOOLS=("gcc" "ld" "as" "ar")
          CORE_MISSING=()
          
          for core_tool in "${CORE_TOOLS[@]}"; do
            found=false
            for found_tool in "${ALL_FOUND[@]}"; do
              if [[ "$found_tool" == "$core_tool:"* ]]; then
                found=true
                break
              fi
            done
            
            if [ "$found" = false ]; then
              CORE_MISSING+=("$core_tool")
            fi
          done
          
          if [ ${#CORE_MISSING[@]} -eq 0 ]; then
            echo "âœ… æ ¸å¿ƒå·¥å…·å®Œæ•´: gcc, ld, as, ar"
            BUILD_STATUS="PASS"
          else
            echo "âŒ ç¼ºå°‘æ ¸å¿ƒå·¥å…·: ${CORE_MISSING[*]}"
            BUILD_STATUS="FAIL"
          fi
          
          IMPORTANT_TOOLS=("g++" "strip" "objcopy" "objdump" "nm" "ranlib" "cpp")
          IMPORTANT_MISSING=()
          
          for important_tool in "${IMPORTANT_TOOLS[@]}"; do
            found=false
            for found_tool in "${ALL_FOUND[@]}"; do
              if [[ "$found_tool" == "$important_tool:"* ]]; then
                found=true
                break
              fi
            done
            
            if [ "$found" = false ]; then
              IMPORTANT_MISSING+=("$important_tool")
            fi
          done
          
          if [ ${#IMPORTANT_MISSING[@]} -eq 0 ]; then
            echo "âœ… é‡è¦å·¥å…·å®Œæ•´"
          else
            echo "âš ï¸  ç¼ºå°‘é‡è¦å·¥å…·: ${IMPORTANT_MISSING[*]}"
            if [ "$BUILD_STATUS" = "PASS" ]; then
              BUILD_STATUS="WARNING"
            fi
          fi
          
          echo ""
          echo "ğŸ“Š å·¥å…·ç»Ÿè®¡:"
          echo "- æ‰¾åˆ°çš„å·¥å…·: ${#ALL_FOUND[@]}ä¸ª"
          echo "- ç¼ºå¤±æ ¸å¿ƒå·¥å…·: ${#CORE_MISSING[@]}ä¸ª"
          echo "- ç¼ºå¤±é‡è¦å·¥å…·: ${#IMPORTANT_MISSING[@]}ä¸ª"
          
          echo "åˆ›å»ºå·¥å…·æ˜ å°„æ–‡ä»¶..."
          echo "# å·¥å…·é“¾æ˜ å°„" > "$TOOLCHAIN_DIR/toolchain.map"
          echo "PREFIX=$TOOL_PREFIX" >> "$TOOLCHAIN_DIR/toolchain.map"
          echo "TARGET=$TARGET_TRIPLET" >> "$TOOLCHAIN_DIR/toolchain.map"
          echo "GCC_VERSION=${{ env.GCC_VERSION }}" >> "$TOOLCHAIN_DIR/toolchain.map"
          echo "BINUTILS_VERSION=${{ env.BINUTILS_VERSION }}" >> "$TOOLCHAIN_DIR/toolchain.map"
          echo "TOOLS_COUNT=${#ALL_FOUND[@]}" >> "$TOOLCHAIN_DIR/toolchain.map"
          echo "" >> "$TOOLCHAIN_DIR/toolchain.map"
          
          for tool_info in "${ALL_FOUND[@]}"; do
            IFS=':' read -r tool_name tool_path <<< "$tool_info"
            echo "$tool_name=$tool_path" >> "$TOOLCHAIN_DIR/toolchain.map"
          done
          
          echo "TOOL_PREFIX=$TOOL_PREFIX" >> $GITHUB_ENV
          echo "TARGET_TRIPLET=$TARGET_TRIPLET" >> $GITHUB_ENV
          echo "BUILD_STATUS=$BUILD_STATUS" >> $GITHUB_ENV
          
          if [ "$BUILD_STATUS" = "FAIL" ]; then
            echo "âŒ å·¥å…·é“¾ä¸å®Œæ•´ï¼Œæ„å»ºå¤±è´¥"
            exit 1
          elif [ "$BUILD_STATUS" = "WARNING" ]; then
            echo "âš ï¸  å·¥å…·é“¾åŸºæœ¬å®Œæ•´ï¼Œä½†æœ‰è­¦å‘Š"
            echo "BUILD_COMPLETE=true" >> $GITHUB_ENV
          else
            echo "âœ… å·¥å…·é“¾å®Œæ•´ï¼Œæ„å»ºæˆåŠŸ"
            echo "BUILD_COMPLETE=true" >> $GITHUB_ENV
          fi
          
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV
          echo "COMPILER_NAME=$COMPILER_NAME" >> $GITHUB_ENV
          echo "ALL_TOOLS_COUNT=${#ALL_FOUND[@]}" >> $GITHUB_ENV
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘å™¨ï¼ˆå¸¦ç‰ˆæœ¬ä¿¡æ¯ï¼‰
        if: env.BUILD_COMPLETE == 'true'
        run: |
          echo "=== ä¿å­˜ç¼–è¯‘å™¨ï¼ˆå¸¦ç‰ˆæœ¬ä¿¡æ¯ï¼‰==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ env.BUILD_DIR }}"
          
          echo "å‡†å¤‡è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          mkdir -p "${{ env.OUTPUT_DIR }}"
          
          if [ -d "${{ env.OUTPUT_DIR }}" ] && [ "$(ls -A "${{ env.OUTPUT_DIR }}" 2>/dev/null)" ]; then
            echo "æ¸…ç†ç°æœ‰è¾“å‡ºç›®å½•..."
            rm -rf "${{ env.OUTPUT_DIR }}"/*
          fi
          
          echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
          if [ -d "$TOOLCHAIN_DIR" ]; then
            echo "ä»: $TOOLCHAIN_DIR"
            echo "åˆ°: ${{ env.OUTPUT_DIR }}"
            rsync -av "$TOOLCHAIN_DIR/" "${{ env.OUTPUT_DIR }}/" 2>&1 | tail -20
            echo "âœ… å¤åˆ¶å®Œæˆ"
          else
            echo "âŒ å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "åˆ›å»ºè¯¦ç»†çš„å…ƒæ•°æ®æ–‡ä»¶..."
          echo "{" > "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"architecture\": \"${{ env.ARCH_DIR }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"arch_name\": \"${{ env.ARCH_NAME }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"libc\": \"${{ env.LIBC_DIR }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"libc_version\": \"${{ env.LIBC_VERSION }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"target\": \"${{ env.TARGET }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"subtarget\": \"${{ env.SUBTARGET }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"compiler_prefix\": \"${{ env.PREFIX }}-\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"gcc_version\": \"${{ env.GCC_VERSION }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"binutils_version\": \"${{ env.BINUTILS_VERSION }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"linux_version\": \"${{ env.LINUX_VERSION }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"openwrt_version\": \"${{ env.OPENWRT_VERSION }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"cpu_type\": \"${{ env.CPU_TYPE }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"tune\": \"${{ env.TUNE }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"abi\": \"${{ env.ABI }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"float_abi\": \"${{ env.FLOAT_ABI }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"build_date\": \"$(date -Iseconds)\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"workflow_run\": \"${{ github.run_id }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"build_id\": \"${{ env.BUILD_ID }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"tools_count\": \"${{ env.ALL_TOOLS_COUNT }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"target_triplet\": \"${{ env.TARGET_TRIPLET }}\"," >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "  \"tool_prefix\": \"${{ env.TOOL_PREFIX }}\"" >> "${{ env.OUTPUT_DIR }}/metadata.json"
          echo "}" >> "${{ env.OUTPUT_DIR }}/metadata.json"
          
          echo "åˆ›å»ºè¯´æ˜æ–‡ä»¶..."
          echo "# ${{ env.ARCH_DIR }} ${{ env.LIBC_DIR }} äº¤å‰ç¼–è¯‘å™¨" > "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "## åŸºæœ¬ä¿¡æ¯" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- æ¶æ„: ${{ env.ARCH_DIR }} (${{ env.ARCH_NAME }})" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- Cåº“: ${{ env.LIBC_DIR }} ${{ env.LIBC_VERSION }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- Binutilsç‰ˆæœ¬: ${{ env.BINUTILS_VERSION }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- Linuxå†…æ ¸: ${{ env.LINUX_VERSION }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- OpenWrtç‰ˆæœ¬: ${{ env.OPENWRT_VERSION }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- ç¼–è¯‘å™¨å‰ç¼€: ${{ env.PREFIX }}-" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- ç›®æ ‡ä¸‰å…ƒç»„: ${{ env.TARGET_TRIPLET }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- CPUç±»å‹: ${{ env.CPU_TYPE }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- è°ƒä¼˜: ${{ env.TUNE }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- ABI: ${{ env.ABI }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- æµ®ç‚¹ABI: ${{ env.FLOAT_ABI }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- å·¥å…·æ•°é‡: ${{ env.ALL_TOOLS_COUNT }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- æ„å»ºæ—¶é—´: $(date)" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "## ç‰ˆæœ¬å…¼å®¹æ€§" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "æ­¤ç¼–è¯‘å™¨ä¸“ä¸ºä»¥ä¸‹ç¯å¢ƒè®¾è®¡ï¼š" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- OpenWrt ${{ env.OPENWRT_VERSION }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- ${{ env.ARCH_DIR }} æ¶æ„è®¾å¤‡" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- ${{ env.LIBC_DIR }} Cåº“" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "## ä½¿ç”¨æ–¹æ³•" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo '```bash' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "# è®¾ç½®ç¯å¢ƒå˜é‡" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo 'export STAGING_DIR="$(pwd)"' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo 'export PATH="$STAGING_DIR/bin:$PATH"' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "# éªŒè¯ç¼–è¯‘å™¨" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "${{ env.PREFIX }}-gcc --version" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "# ç¼–è¯‘ç¤ºä¾‹ç¨‹åº" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "${{ env.PREFIX }}-gcc -o hello hello.c" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo '```' >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "## åŒ…å«çš„å·¥å…·" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- ç¼–è¯‘å™¨: gcc, g++, cpp" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- æ±‡ç¼–å™¨: as, gas" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- é“¾æ¥å™¨: ld, ld.bfd" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- äºŒè¿›åˆ¶å·¥å…·: objcopy, objdump, strip, nm" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- å½’æ¡£å·¥å…·: ar, ranlib" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- è°ƒè¯•å·¥å…·: gdb, gdbserver" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "## æ³¨æ„äº‹é¡¹" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "1. æ­¤å·¥å…·é“¾ä¸“ä¸ºäº¤å‰ç¼–è¯‘è®¾è®¡" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "2. éœ€è¦ç›¸åº”çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "3. å»ºè®®åœ¨OpenWrtæ„å»ºç³»ç»Ÿä¸­ä½¿ç”¨" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "4. ç‰ˆæœ¬å·²é’ˆå¯¹ç›®æ ‡æ¶æ„ä¼˜åŒ–" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "## æ„å»ºä¿¡æ¯" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- å·¥ä½œæµ: #${{ github.run_id }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- æ„å»ºID: ${{ env.BUILD_ID }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          echo "- ä¿å­˜è·¯å¾„: ${{ env.OUTPUT_DIR }}" >> "${{ env.OUTPUT_DIR }}/README.md"
          
          echo "è®¡ç®—æˆæœå¤§å°..."
          TOTAL_SIZE=$(du -sh "${{ env.OUTPUT_DIR }}" | cut -f1)
          FILE_COUNT=$(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)
          DIR_COUNT=$(find "${{ env.OUTPUT_DIR }}" -type d | wc -l)
          
          echo "ğŸ“Š æœ€ç»ˆæˆæœç»Ÿè®¡:"
          echo "- è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          echo "- æ€»å¤§å°: $TOTAL_SIZE"
          echo "- æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          echo "- ç›®å½•æ•°é‡: $DIR_COUNT"
          echo "- æ¶æ„: ${{ env.ARCH_DIR }}"
          echo "- Cåº“: ${{ env.LIBC_DIR }}"
          echo "- GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ env.BINUTILS_VERSION }}"
          
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          echo "DIR_COUNT=$DIR_COUNT" >> $GITHUB_ENV
          
          echo "âœ… ç¼–è¯‘å™¨ä¿å­˜å®Œæˆ"
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ“¤ æäº¤åˆ°Gitä»“åº“
        if: env.BUILD_COMPLETE == 'true'
        run: |
          echo "=== æäº¤ç¼–è¯‘å™¨åˆ°Gitä»“åº“ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          cd "${{ github.workspace }}"
          
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git config pull.rebase false
          
          echo "æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main --no-edit
          
          echo "æ·»åŠ ç¼–è¯‘å™¨æ–‡ä»¶..."
          git add -f "firmware-config/build-Compiler-file/compilers/*"
          
          if ! git diff --cached --quiet; then
            echo "æ£€æµ‹åˆ°å˜æ›´ï¼Œåˆ›å»ºæäº¤..."
            git commit -m "build(compiler): æ·»åŠ  ${{ env.ARCH_DIR }}-${{ env.LIBC_DIR }} äº¤å‰ç¼–è¯‘å™¨ v${{ env.GCC_VERSION }}" -m "æ¶æ„: ${{ env.ARCH_DIR }}" -m "Cåº“: ${{ env.LIBC_DIR }} ${{ env.LIBC_VERSION }}" -m "GCC: ${{ env.GCC_VERSION }}" -m "Binutils: ${{ env.BINUTILS_VERSION }}" -m "å¤§å°: ${{ env.TOTAL_SIZE }}" -m "å·¥å…·æ•°: ${{ env.ALL_TOOLS_COUNT }}" -m "å·¥ä½œæµ: #${{ github.run_id }}"
            
            echo "æ¨é€åˆ°ä»“åº“..."
            if git push origin main; then
              echo "âœ… ç¼–è¯‘å™¨å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
            else
              echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œé‡æ–°å°è¯•..."
              git pull origin main --rebase
              git push origin main
            fi
          else
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi
          
          echo "ç»“æŸæ—¶é—´: $(date)"

      - name: ğŸ“Š æ˜¾ç¤ºæœ€ç»ˆæˆæœ
        if: env.BUILD_COMPLETE == 'true'
        run: |
          echo "========================================"
          echo "          ğŸ‰ æ„å»ºå®ŒæˆæŠ¥å‘Š              "
          echo "========================================"
          echo "âœ… äº¤å‰ç¼–è¯‘å™¨æ„å»ºæˆåŠŸ!"
          echo ""
          echo "ğŸ“Š æ„å»ºä¿¡æ¯:"
          echo "- æ¶æ„: ${{ env.ARCH_DIR }} (${{ env.ARCH_NAME }})"
          echo "- Cåº“: ${{ env.LIBC_DIR }} ${{ env.LIBC_VERSION }}"
          echo "- GCCç‰ˆæœ¬: ${{ env.GCC_VERSION }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ env.BINUTILS_VERSION }}"
          echo "- Linuxå†…æ ¸: ${{ env.LINUX_VERSION }}"
          echo "- ç¼–è¯‘å™¨å‰ç¼€: ${{ env.PREFIX }}-"
          echo "- ç›®æ ‡å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "- ç›®æ ‡ä¸‰å…ƒç»„: ${{ env.TARGET_TRIPLET }}"
          echo ""
          echo "ğŸ“¦ æˆæœç»Ÿè®¡:"
          echo "- æ€»å¤§å°: ${{ env.TOTAL_SIZE }}"
          echo "- æ–‡ä»¶æ•°é‡: ${{ env.FILE_COUNT }}"
          echo "- ç›®å½•æ•°é‡: ${{ env.DIR_COUNT }}"
          echo "- å·¥å…·æ•°é‡: ${{ env.ALL_TOOLS_COUNT }}"
          echo "- è¾“å‡ºç›®å½•: ${{ env.OUTPUT_DIR }}"
          echo ""
          echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
          echo "cd ${{ env.OUTPUT_DIR }}"
          echo "export STAGING_DIR=\$(pwd)"
          echo 'export PATH="$STAGING_DIR/bin:$PATH"'
          echo "${{ env.PREFIX }}-gcc --version"
          echo ""
          echo "ğŸ”§ ç‰ˆæœ¬é€‚é…ç­–ç•¥:"
          echo "- OpenWrt ${{ env.OPENWRT_VERSION }} â†’ GCC ${{ env.GCC_VERSION }}"
          echo "- æ¶æ„ä¼˜åŒ– â†’ é’ˆå¯¹ ${{ env.ARCH_DIR }} è°ƒæ•´"
          echo "- ç‰ˆæœ¬éªŒè¯ â†’ ç¡®ä¿ç»„ä»¶å…¼å®¹æ€§"
          echo ""
          echo "â° æ„å»ºæ—¶é—´: $(date)"
          echo "========================================"

      - name: ğŸ“„ ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.BUILD_ID }}
          path: /tmp/*.log
          retention-days: 30

  skip-build:
    needs: setup
    if: needs.setup.outputs.need_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: â­ï¸ è·³è¿‡æ„å»º
        run: |
          echo "========================================"
          echo "        â­ï¸ è·³è¿‡æ„å»ºæŠ¥å‘Š                "
          echo "========================================"
          echo "âœ… ç¼–è¯‘å™¨å·²å­˜åœ¨ä¸”å®Œæ•´ï¼Œè·³è¿‡æ„å»º"
          echo ""
          echo "ğŸ“‹ è·³è¿‡åŸå› :"
          echo "- ç¼–è¯‘å™¨ç›®å½•å·²å­˜åœ¨ä¸”å®Œæ•´"
          echo "- ç‰ˆæœ¬åŒ¹é…æ­£ç¡®"
          echo "- æœªå¯ç”¨å¼ºåˆ¶é‡æ–°æ„å»º"
          echo ""
          echo "ğŸ”§ ç°æœ‰ç¼–è¯‘å™¨ä¿¡æ¯:"
          echo "- æ¶æ„: ${{ github.event.inputs.target_arch }}"
          echo "- Cåº“: ${{ github.event.inputs.libc }}"
          echo "- GCCç‰ˆæœ¬: ${{ needs.setup.outputs.gcc_version }}"
          echo "- Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo ""
          echo "ğŸ’¡ å¦‚éœ€é‡æ–°æ„å»ºï¼Œè¯·å¯ç”¨'å¼ºåˆ¶é‡æ–°æ„å»º'é€‰é¡¹"
          echo "========================================"
