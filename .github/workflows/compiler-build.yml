# .github/workflows/compiler-build.yml
name: ðŸ”§ äº¤å‰ç¼–è¯‘å™¨æž„å»º
description: |
  æž„å»ºOpenWrtäº¤å‰ç¼–è¯‘å·¥å…·é“¾
  æ”¯æŒå¤šç§æž¶æž„ï¼šARM (32ä½/64ä½)ã€x86_64ã€MIPSã€RISC-V
  ä½¿ç”¨Musl Cåº“ï¼Œé’ˆå¯¹ä¸åŒOpenWrtç‰ˆæœ¬

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrtç‰ˆæœ¬ (é€‰æ‹©è¦æž„å»ºçš„OpenWrtç‰ˆæœ¬)'
        required: true
        default: '21.02.5'
        type: choice
        options:
          - '21.02.5'
          - '22.03.5'
          - '23.05.2'
      arch_type:
        description: |
          æž¶æž„ç±»åž‹
          all: æ‰€æœ‰æ”¯æŒçš„æž¶æž„
          arm: ä»…32ä½ARMæž¶æž„ (ipq40xx, sunxi, mediatekç­‰è·¯ç”±å™¨)
          aarch64: ä»…64ä½ARMæž¶æž„ (armvirt, rockchipç­‰)
          mips: MIPSæž¶æž„ (ramipsç­‰è€è®¾å¤‡)
          x86: x86_64æž¶æž„
          riscv: RISC-V 64ä½æž¶æž„
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'arm'
          - 'mips'
          - 'x86'
          - 'riscv'
          - 'aarch64'

env:
  COMPILER_BASE_DIR: "${{ github.workspace }}/firmware-config/build-Compiler-file"
  BUILD_BASE_DIR: "/mnt/compiler-build"

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      arch_list: ${{ steps.setup-arch.outputs.arch_list }}
      openwrt_version: ${{ steps.version-detection.outputs.openwrt_version }}
      binutils_version: ${{ steps.version-detection.outputs.binutils_version }}
      linux_version: ${{ steps.version-detection.outputs.linux_version }}
      musl_version: ${{ steps.version-detection.outputs.musl_version }}
      start_time: ${{ steps.get-time.outputs.start_time }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: â° èŽ·å–å¼€å§‹æ—¶é—´
        id: get-time
        run: |
          echo "start_time=$(date)" >> $GITHUB_OUTPUT

      - name: ðŸ”§ è®¾ç½®æž„å»ºç›®å½•æƒé™
        run: |
          echo "=== è®¾ç½®æž„å»ºç›®å½•æƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $USER:$USER /mnt/compiler-build 2>/dev/null || true

      - name: ðŸ—ï¸ åˆå§‹åŒ–çŽ¯å¢ƒ
        run: |
          echo "=== åˆå§‹åŒ–æž„å»ºçŽ¯å¢ƒ ==="
          mkdir -p "${{ env.COMPILER_BASE_DIR }}"
          mkdir -p "${{ env.BUILD_BASE_DIR }}"
          echo "ç¼–è¯‘å™¨åŸºç¡€ç›®å½•: ${{ env.COMPILER_BASE_DIR }}"
          echo "æž„å»ºåŸºç¡€ç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ðŸ”§ è®¾ç½®æž¶æž„åˆ—è¡¨
        id: setup-arch
        run: |
          echo "=== è®¾ç½®ç›®æ ‡æž¶æž„åˆ—è¡¨ ==="
          ARCH_TYPE="${{ github.event.inputs.arch_type }}"
          
          # æž¶æž„è¯´æ˜Žï¼š
          # all: åŒ…å«æ‰€æœ‰æ”¯æŒçš„æž¶æž„
          # arm: ä»…32ä½ARMæž¶æž„ (ipq40xx, sunxi, mediatekç­‰)
          # aarch64: ä»…64ä½ARMæž¶æž„ (armvirt, rockchipç­‰)
          # mips: MIPSæž¶æž„ (å¤§ç«¯å’Œå°ç«¯)
          # x86: x86_64æž¶æž„
          # riscv: RISC-V 64ä½æž¶æž„
          
          if [ "$ARCH_TYPE" = "all" ]; then
            # åŒ…å«æ‰€æœ‰æ”¯æŒçš„æž¶æž„
            ARCH_LIST='["arm_cortex-a7","arm_cortex-a9","arm_cortex-a15","aarch64","x86_64","mips","mipsel","riscv64"]'
            echo "âœ… é€‰æ‹©æ‰€æœ‰æž¶æž„ç±»åž‹"
            echo "- 32ä½ARM: Cortex-A7, Cortex-A9, Cortex-A15"
            echo "- 64ä½ARM: AArch64"
            echo "- x86_64"
            echo "- MIPS (å¤§ç«¯å’Œå°ç«¯)"
            echo "- RISC-V 64ä½"
          elif [ "$ARCH_TYPE" = "arm" ]; then
            # ä»…32ä½ARMæž¶æž„ - å¸¸è§è·¯ç”±å™¨å¹³å°
            ARCH_LIST='["arm_cortex-a7","arm_cortex-a9","arm_cortex-a15"]'
            echo "âœ… é€‰æ‹©32ä½ARMæž¶æž„"
            echo "- Cortex-A7: ä½ŽåŠŸè€—è®¾å¤‡ (å¦‚: sunxi/Allwinner, ipq40xx)"
            echo "- Cortex-A9: ä¸­ç«¯è·¯ç”±å™¨ (å¦‚: mediatek mt7623, ipq806x)"
            echo "- Cortex-A15: é«˜æ€§èƒ½è·¯ç”±å™¨ (å¦‚: ipq806xé«˜ç«¯åž‹å·)"
          elif [ "$ARCH_TYPE" = "mips" ]; then
            ARCH_LIST='["mips","mipsel"]'
            echo "âœ… é€‰æ‹©MIPSæž¶æž„"
            echo "- mips: å¤§ç«¯MIPS (å¦‚: ar71xx, ath79è€è®¾å¤‡)"
            echo "- mipsel: å°ç«¯MIPS (å¦‚: ramips mt7621)"
          elif [ "$ARCH_TYPE" = "x86" ]; then
            ARCH_LIST='["x86_64"]'
            echo "âœ… é€‰æ‹©x86æž¶æž„"
            echo "- x86_64: 64ä½x86 (PC/æœåŠ¡å™¨)"
          elif [ "$ARCH_TYPE" = "riscv" ]; then
            ARCH_LIST='["riscv64"]'
            echo "âœ… é€‰æ‹©RISC-Væž¶æž„"
            echo "- riscv64: 64ä½RISC-V (æ–°å…´æž¶æž„)"
          elif [ "$ARCH_TYPE" = "aarch64" ]; then
            ARCH_LIST='["aarch64"]'
            echo "âœ… é€‰æ‹©AArch64æž¶æž„"
            echo "- aarch64: 64ä½ARM (å¦‚: armvirtè™šæ‹Ÿå¹³å°, rockchip RK3588ç­‰)"
          else
            ARCH_LIST='["aarch64"]'
            echo "âš ï¸ æœªçŸ¥ç±»åž‹ï¼Œé»˜è®¤é€‰æ‹©AArch64"
          fi
          echo "ç›®æ ‡æž¶æž„åˆ—è¡¨: $ARCH_LIST"
          echo "arch_list=$ARCH_LIST" >> $GITHUB_OUTPUT

      - name: ðŸ” ç‰ˆæœ¬æ£€æµ‹
        id: version-detection
        run: |
          echo "=== ç‰ˆæœ¬æ£€æµ‹ ==="
          OPENWRT_VERSION="${{ github.event.inputs.openwrt_version }}"
          echo "ç”¨æˆ·é€‰æ‹©çš„OpenWrtç‰ˆæœ¬: $OPENWRT_VERSION"
          if [ "$OPENWRT_VERSION" = "21.02.5" ]; then
            BINUTILS_VERSION="2.36.1"
            LINUX_VERSION="5.4.188"
            MUSL_VERSION="1.2.2"
            echo "â„¹ï¸ OpenWrt 21.02.5 - ç¨³å®šç‰ˆï¼Œé€‚åˆè€è®¾å¤‡"
          elif [ "$OPENWRT_VERSION" = "22.03.5" ]; then
            BINUTILS_VERSION="2.38"
            LINUX_VERSION="5.10.179"
            MUSL_VERSION="1.2.3"
            echo "âœ… OpenWrt 22.03.5 - LTSç‰ˆï¼ŒæŽ¨èä½¿ç”¨"
          elif [ "$OPENWRT_VERSION" = "23.05.2" ]; then
            BINUTILS_VERSION="2.40"
            LINUX_VERSION="5.15.133"
            MUSL_VERSION="1.2.4"
            echo "âœ… OpenWrt 23.05.2 - æ–°ç‰ˆï¼Œæ”¯æŒæ–°ç¡¬ä»¶"
          fi
          echo "openwrt_version=$OPENWRT_VERSION" >> $GITHUB_OUTPUT
          echo "binutils_version=$BINUTILS_VERSION" >> $GITHUB_OUTPUT
          echo "linux_version=$LINUX_VERSION" >> $GITHUB_OUTPUT
          echo "musl_version=$MUSL_VERSION" >> $GITHUB_OUTPUT

  build-matrix:
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJSON(needs.setup.outputs.arch_list) }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”§ è®¾ç½®è¿è¡ŒçŽ¯å¢ƒæƒé™
        run: |
          echo "=== è®¾ç½®è¿è¡ŒçŽ¯å¢ƒæƒé™ ==="
          sudo mkdir -p /mnt/compiler-build
          sudo chmod -R 777 /mnt/compiler-build
          sudo chown -R $(whoami):$(whoami) /mnt/compiler-build 2>/dev/null || true

      - name: ðŸ“‹ æ˜¾ç¤ºæž„å»ºä¿¡æ¯
        run: |
          echo "========================================"
          echo "        äº¤å‰ç¼–è¯‘å™¨æž„å»ºä¿¡æ¯              "
          echo "========================================"
          echo "ç›®æ ‡æž¶æž„: ${{ matrix.arch }}"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "Cåº“ç±»åž‹: musl"
          echo "Binutilsç‰ˆæœ¬: ${{ needs.setup.outputs.binutils_version }}"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}"
          echo "Muslç‰ˆæœ¬: ${{ needs.setup.outputs.musl_version }}"
          echo "æž„å»ºç›®å½•: ${{ env.BUILD_BASE_DIR }}"
          echo "========================================"
          echo "å¼€å§‹æ—¶é—´: $(date)"

      - name: ðŸ”§ è®¾ç½®æž¶æž„çŽ¯å¢ƒ
        id: setup-env
        run: |
          echo "=== è®¾ç½®æž¶æž„çŽ¯å¢ƒ ==="
          ARCH="${{ matrix.arch }}"
          
          # ARM 32ä½æž¶æž„é…ç½®
          if [ "$ARCH" = "arm_cortex-a7" ]; then
            # å¯¹åº”å¹³å°: sunxi (Allwinner), ipq40xx (é«˜é€š)
            TARGET="sunxi"
            SUBTARGET="cortexa7"
            ARCH_NAME="arm"
            PREFIX="arm-openwrt-linux-muslgnueabi"
            CPU_TYPE="cortex-a7"
            TARGET_CPU="arm_cortex-a7"
            ARCH_TYPE_TITLE="ARM Cortex-A7 (32ä½)"
            EXPECTED_ARCH="arm"
            EXPECTED_COMPILER_PREFIX="arm-"
            echo "âœ… é…ç½®: ARM Cortex-A7 (32ä½)"
            echo "  å¹³å°: sunxi/Allwinner, ipq40xx"
            echo "  å‰ç¼€: $PREFIX"
          elif [ "$ARCH" = "arm_cortex-a9" ]; then
            # å¯¹åº”å¹³å°: mediatek (mt7623), ipq806x (é«˜é€š)
            TARGET="mediatek"
            SUBTARGET="mt7623"
            ARCH_NAME="arm"
            PREFIX="arm-openwrt-linux-muslgnueabi"
            CPU_TYPE="cortex-a9"
            TARGET_CPU="arm_cortex-a9"
            ARCH_TYPE_TITLE="ARM Cortex-A9 (32ä½)"
            EXPECTED_ARCH="arm"
            EXPECTED_COMPILER_PREFIX="arm-"
            echo "âœ… é…ç½®: ARM Cortex-A9 (32ä½)"
            echo "  å¹³å°: mediatek mt7623, ipq806x"
            echo "  å‰ç¼€: $PREFIX"
          elif [ "$ARCH" = "arm_cortex-a15" ]; then
            # å¯¹åº”å¹³å°: ipq806xé«˜ç«¯åž‹å·
            TARGET="ipq806x"
            SUBTARGET="generic"
            ARCH_NAME="arm"
            PREFIX="arm-openwrt-linux-muslgnueabi"
            CPU_TYPE="cortex-a15"
            TARGET_CPU="arm_cortex-a15"
            ARCH_TYPE_TITLE="ARM Cortex-A15 (32ä½)"
            EXPECTED_ARCH="arm"
            EXPECTED_COMPILER_PREFIX="arm-"
            echo "âœ… é…ç½®: ARM Cortex-A15 (32ä½)"
            echo "  å¹³å°: ipq806xé«˜ç«¯è·¯ç”±å™¨"
            echo "  å‰ç¼€: $PREFIX"
          elif [ "$ARCH" = "aarch64" ]; then
            # 64ä½ARMæž¶æž„
            TARGET="armvirt"
            SUBTARGET="64"
            ARCH_NAME="aarch64"
            PREFIX="aarch64-openwrt-linux-musl"
            CPU_TYPE="cortex-a53"
            TARGET_CPU="aarch64_cortex-a53"
            ARCH_TYPE_TITLE="AArch64 (64ä½)"
            EXPECTED_ARCH="aarch64"
            EXPECTED_COMPILER_PREFIX="aarch64-"
            echo "âœ… é…ç½®: AArch64 (64ä½)"
            echo "  å¹³å°: armvirtè™šæ‹Ÿå¹³å°, rockchip"
            echo "  å‰ç¼€: $PREFIX"
          elif [ "$ARCH" = "x86_64" ]; then
            TARGET="x86"
            SUBTARGET="64"
            ARCH_NAME="x86_64"
            PREFIX="x86_64-openwrt-linux-musl"
            CPU_TYPE=""
            TARGET_CPU="x86_64"
            ARCH_TYPE_TITLE="x86_64 (64ä½)"
            EXPECTED_ARCH="x86_64"
            EXPECTED_COMPILER_PREFIX="x86_64-"
            echo "âœ… é…ç½®: x86_64 (64ä½)"
            echo "  å¹³å°: PC/æœåŠ¡å™¨"
            echo "  å‰ç¼€: $PREFIX"
          elif [ "$ARCH" = "mips" ]; then
            # å¤§ç«¯MIPS (è€è®¾å¤‡: ar71xx, ath79)
            TARGET="ath79"
            SUBTARGET="generic"
            ARCH_NAME="mips"
            PREFIX="mips-openwrt-linux-musl"
            CPU_TYPE="24kc"
            TARGET_CPU="mips_24kc"
            ARCH_TYPE_TITLE="MIPS (å¤§ç«¯)"
            EXPECTED_ARCH="mips"
            EXPECTED_COMPILER_PREFIX="mips-"
            echo "âœ… é…ç½®: MIPS (å¤§ç«¯)"
            echo "  å¹³å°: ath79è€è®¾å¤‡"
            echo "  å‰ç¼€: $PREFIX"
          elif [ "$ARCH" = "mipsel" ]; then
            # å°ç«¯MIPS (ramipså¹³å°)
            TARGET="ramips"
            SUBTARGET="mt7621"
            ARCH_NAME="mipsel"
            PREFIX="mipsel-openwrt-linux-musl"
            CPU_TYPE="24kc"
            TARGET_CPU="mipsel_24kc"
            ARCH_TYPE_TITLE="MIPSel (å°ç«¯)"
            EXPECTED_ARCH="mipsel"
            EXPECTED_COMPILER_PREFIX="mipsel-"
            echo "âœ… é…ç½®: MIPSel (å°ç«¯)"
            echo "  å¹³å°: ramips (mt7621ç­‰)"
            echo "  å‰ç¼€: $PREFIX"
          elif [ "$ARCH" = "riscv64" ]; then
            TARGET="virt"
            SUBTARGET="rv64"
            ARCH_NAME="riscv64"
            PREFIX="riscv64-openwrt-linux-musl"
            CPU_TYPE=""
            TARGET_CPU="riscv64"
            ARCH_TYPE_TITLE="RISC-V 64ä½"
            EXPECTED_ARCH="riscv64"
            EXPECTED_COMPILER_PREFIX="riscv64-"
            echo "âœ… é…ç½®: RISC-V 64ä½"
            echo "  å¹³å°: è™šæ‹Ÿå¹³å°"
            echo "  å‰ç¼€: $PREFIX"
          fi
          
          BUILD_ID="${ARCH}_musl_openwrt-${{ needs.setup.outputs.openwrt_version }}_$(date +%Y%m%d_%H%M%S)"
          BUILD_DIR="${{ env.BUILD_BASE_DIR }}/${BUILD_ID}"
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "TARGET_CPU=$TARGET_CPU" >> $GITHUB_ENV
          echo "CPU_TYPE=$CPU_TYPE" >> $GITHUB_ENV
          echo "ARCH_TYPE_TITLE=$ARCH_TYPE_TITLE" >> $GITHUB_ENV
          echo "EXPECTED_ARCH=$EXPECTED_ARCH" >> $GITHUB_ENV
          echo "EXPECTED_COMPILER_PREFIX=$EXPECTED_COMPILER_PREFIX" >> $GITHUB_ENV

      - name: ðŸ”§ å®‰è£…ä¾èµ–
        run: |
          echo "=== å®‰è£…æž„å»ºä¾èµ– ==="
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential gcc g++ make flex bison git wget curl file gawk gettext rsync unzip autoconf automake libtool pkg-config texinfo gperf cmake ninja-build patchutils bc bzip2 xz-utils help2man jq liblzma-dev zstd libzstd-dev libexpat-dev libgdbm-dev libreadline-dev libsqlite3-dev libffi-dev libelf-dev libdw-dev libgmp-dev libmpfr-dev libmpc-dev libisl-dev libgnutls28-dev python3 python3-dev libncurses5-dev libssl-dev liblzma-dev zlib1g-dev

      - name: ðŸ“¥ ä¸‹è½½OpenWrtæºç 
        run: |
          echo "=== èŽ·å–OpenWrtæºç  ==="
          mkdir -p "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          OPENWRT_VERSION="${{ needs.setup.outputs.openwrt_version }}"
          echo "å…‹éš†OpenWrt $OPENWRT_VERSION æºç ..."
          git clone --depth 1 --branch "v$OPENWRT_VERSION" https://github.com/openwrt/openwrt.git .
          echo "æºç å¤§å°: $(du -sh . | cut -f1)"

      - name: âš™ï¸ æž„å»ºå·¥å…·é“¾
        timeout-minutes: 180
        run: |
          echo "=== æž„å»ºå·¥å…·é“¾ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "æ­¥éª¤1: æ›´æ–°feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo "æ­¥éª¤2: é…ç½®ç›®æ ‡å¹³å°..."
          rm -f .config
          
          # æ ¹æ®æž¶æž„é…ç½®ç›®æ ‡å¹³å°
          if [ "${{ matrix.arch }}" = "arm_cortex-a7" ]; then
            echo "é…ç½®: sunxi cortexa7 (ipq40xxç±»ä¼¼å¹³å°)..."
            echo "CONFIG_TARGET_sunxi=y" > .config
            echo "CONFIG_TARGET_sunxi_cortexa7=y" >> .config
            echo "CONFIG_TARGET_ARCH_PACKAGES=\"arm_cortex-a7_neon-vfpv4\"" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv7-a -mtune=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard\"" >> .config
          elif [ "${{ matrix.arch }}" = "arm_cortex-a9" ]; then
            echo "é…ç½®: mediatek mt7623 (ipq806xç±»ä¼¼å¹³å°)..."
            echo "CONFIG_TARGET_mediatek=y" > .config
            echo "CONFIG_TARGET_mediatek_mt7623=y" >> .config
            echo "CONFIG_TARGET_ARCH_PACKAGES=\"arm_cortex-a9_neon-vfpv4-d16\"" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv7-a -mtune=cortex-a9 -mfpu=neon-vfpv4-d16 -mfloat-abi=hard\"" >> .config
          elif [ "${{ matrix.arch }}" = "arm_cortex-a15" ]; then
            echo "é…ç½®: ipq806x cortex-a15..."
            echo "CONFIG_TARGET_ipq806x=y" > .config
            echo "CONFIG_TARGET_ipq806x_generic=y" >> .config
            echo "CONFIG_TARGET_ARCH_PACKAGES=\"arm_cortex-a15_neon-vfpv4\"" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv7-a -mtune=cortex-a15 -mfpu=neon-vfpv4 -mfloat-abi=hard\"" >> .config
          elif [ "${{ matrix.arch }}" = "aarch64" ]; then
            echo "é…ç½®: armvirt 64ä½ARM..."
            echo "CONFIG_TARGET_armvirt=y" > .config
            echo "CONFIG_TARGET_armvirt_64=y" >> .config
            echo "CONFIG_TARGET_ARCH_PACKAGES=\"aarch64_generic\"" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=armv8-a -mtune=cortex-a53\"" >> .config
          elif [ "${{ matrix.arch }}" = "x86_64" ]; then
            echo "é…ç½®: x86 64ä½..."
            echo "CONFIG_TARGET_x86=y" > .config
            echo "CONFIG_TARGET_x86_64=y" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=x86-64 -mtune=generic\"" >> .config
          elif [ "${{ matrix.arch }}" = "mips" ]; then
            echo "é…ç½®: ath79 å¤§ç«¯MIPS..."
            echo "CONFIG_TARGET_ath79=y" > .config
            echo "CONFIG_TARGET_ath79_generic=y" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=74kc -mtune=74kc\"" >> .config
          elif [ "${{ matrix.arch }}" = "mipsel" ]; then
            echo "é…ç½®: ramips å°ç«¯MIPS..."
            echo "CONFIG_TARGET_ramips=y" > .config
            echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=24kc -mtune=24kc\"" >> .config
          elif [ "${{ matrix.arch }}" = "riscv64" ]; then
            echo "é…ç½®: virt RISC-V 64ä½..."
            echo "CONFIG_TARGET_virt=y" > .config
            echo "CONFIG_TARGET_virt_rv64=y" >> .config
            echo "CONFIG_TARGET_OPTIMIZATION=\"-march=rv64gc -mtune=generic\"" >> .config
          fi
          
          # é€šç”¨é…ç½®
          echo "CONFIG_SDK=y" >> .config
          echo "CONFIG_BUILD_TOOLCHAIN=y" >> .config
          echo "CONFIG_TOOLCHAINOPTS=y" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          echo "CONFIG_LIBC=\"musl\"" >> .config
          echo "CONFIG_USE_MUSL=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_INITRAMFS=n" >> .config
          echo "CONFIG_TARGET_ROOTFS_EXT4FS=n" >> .config
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=n" >> .config
          echo "CONFIG_TARGET_PREINITOPT=y" >> .config
          
          echo "æ­¥éª¤3: åº”ç”¨é…ç½®..."
          yes "" | make defconfig
          
          echo "æ­¥éª¤4: ä¸‹è½½æºç ..."
          make -j$(nproc) download
          
          echo "æ­¥éª¤5: æž„å»ºå·¥å…·é“¾..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          make toolchain/clean
          make toolchain/compile -j$(nproc)
          make toolchain/install -j$(nproc)
          
          echo "æž„å»ºå®Œæˆæ—¶é—´: $(date)"
          
          if [ -d "staging_dir" ]; then
            echo "âœ… å·¥å…·é“¾æž„å»ºæˆåŠŸ"
            echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ å·¥å…·é“¾æž„å»ºå¤±è´¥"
            echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: ðŸ” éªŒè¯ç¼–è¯‘å™¨
        if: env.BUILD_SUCCESS == 'true'
        run: |
          echo "=== éªŒè¯ç¼–è¯‘å™¨ ==="
          cd "${{ env.BUILD_DIR }}"
          
          echo "æœç´¢ç¼–è¯‘å™¨..."
          COMPILER=$(find staging_dir -name "*gcc" -type f -executable 2>/dev/null | head -1)
          
          if [ -z "$COMPILER" ] || [ ! -x "$COMPILER" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°å¯æ‰§è¡Œçš„ç¼–è¯‘å™¨"
            echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
            echo "VALIDATION_ERROR=æœªæ‰¾åˆ°GCCç¼–è¯‘å™¨" >> $GITHUB_ENV
            exit 1
          fi
          
          COMPILER_NAME=$(basename "$COMPILER")
          echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $COMPILER"
          echo "ç¼–è¯‘å™¨åç§°: $COMPILER_NAME"
          
          COMPILER_VERSION=$("$COMPILER" --version 2>&1 | head -1)
          echo "ç¼–è¯‘å™¨ä¿¡æ¯: $COMPILER_VERSION"
          
          GCC_VERSION=$(echo "$COMPILER_VERSION" | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1 || echo "unknown")
          echo "ç¼–è¯‘å™¨ç‰ˆæœ¬: $GCC_VERSION"
          
          TEST_FILE="/tmp/test.c"
          echo 'int main() { return 0; }' > "$TEST_FILE"
          
          if "$COMPILER" "$TEST_FILE" -o "/tmp/test.out" 2>/dev/null; then
            echo "âœ… ç¼–è¯‘å™¨åŠŸèƒ½æµ‹è¯•é€šè¿‡"
            rm -f "$TEST_FILE" "/tmp/test.out"
            echo "VALIDATION_SUCCESS=true" >> $GITHUB_ENV
            echo "COMPILER_NAME=$COMPILER_NAME" >> $GITHUB_ENV
            echo "COMPILER_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          else
            echo "âŒ ç¼–è¯‘å™¨åŠŸèƒ½æµ‹è¯•å¤±è´¥"
            echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV
            rm -f "$TEST_FILE"
          fi

      - name: ðŸ’¾ ä¿å­˜æž„å»ºç»“æžœ
        if: env.BUILD_SUCCESS == 'true' && env.VALIDATION_SUCCESS == 'true'
        run: |
          echo "=== ä¿å­˜æž„å»ºç»“æžœ ==="
          cd "${{ env.BUILD_DIR }}"
          
          ARCH_DIR="${{ matrix.arch }}"
          OUTPUT_BASE_DIR="${{ env.COMPILER_BASE_DIR }}/compilers/${ARCH_DIR}/musl/openwrt-${{ needs.setup.outputs.openwrt_version }}"
          mkdir -p "$OUTPUT_BASE_DIR"
          
          OUTPUT_DIR="${OUTPUT_BASE_DIR}/gcc-${COMPILER_VERSION}_$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$OUTPUT_DIR"
          
          echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          
          if [ -d "staging_dir" ]; then
            cp -r staging_dir/* "$OUTPUT_DIR/"
            echo "âœ… å·¥å…·é“¾å¤åˆ¶å®Œæˆ"
          fi
          
          METADATA_FILE="$OUTPUT_DIR/metadata.txt"
          echo "æž¶æž„: ${{ matrix.arch }}" > "$METADATA_FILE"
          echo "å¹³å°: ${{ env.TARGET }}/${{ env.SUBTARGET }}" >> "$METADATA_FILE"
          echo "OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}" >> "$METADATA_FILE"
          echo "ç¼–è¯‘å™¨: $COMPILER_NAME" >> "$METADATA_FILE"
          echo "ç¼–è¯‘å™¨ç‰ˆæœ¬: $COMPILER_VERSION" >> "$METADATA_FILE"
          echo "Cåº“: musl ${{ needs.setup.outputs.musl_version }}" >> "$METADATA_FILE"
          echo "Binutils: ${{ needs.setup.outputs.binutils_version }}" >> "$METADATA_FILE"
          echo "Linuxå†…æ ¸: ${{ needs.setup.outputs.linux_version }}" >> "$METADATA_FILE"
          echo "æž„å»ºæ—¶é—´: $(date)" >> "$METADATA_FILE"
          echo "ç›®æ ‡å¹³å°è¯´æ˜Ž:" >> "$METADATA_FILE"
          if [ "${{ matrix.arch }}" = "arm_cortex-a7" ]; then
            echo "- é€‚ç”¨: sunxi/Allwinner, ipq40xxç­‰Cortex-A7è®¾å¤‡" >> "$METADATA_FILE"
          elif [ "${{ matrix.arch }}" = "arm_cortex-a9" ]; then
            echo "- é€‚ç”¨: mediatek mt7623, ipq806xç­‰Cortex-A9è®¾å¤‡" >> "$METADATA_FILE"
          elif [ "${{ matrix.arch }}" = "arm_cortex-a15" ]; then
            echo "- é€‚ç”¨: ipq806xé«˜ç«¯è·¯ç”±å™¨ç­‰Cortex-A15è®¾å¤‡" >> "$METADATA_FILE"
          elif [ "${{ matrix.arch }}" = "aarch64" ]; then
            echo "- é€‚ç”¨: armvirtè™šæ‹Ÿå¹³å°, rockchipç­‰64ä½ARMè®¾å¤‡" >> "$METADATA_FILE"
          elif [ "${{ matrix.arch }}" = "mips" ]; then
            echo "- é€‚ç”¨: ath79ç­‰å¤§ç«¯MIPSè€è®¾å¤‡" >> "$METADATA_FILE"
          elif [ "${{ matrix.arch }}" = "mipsel" ]; then
            echo "- é€‚ç”¨: ramipsç­‰å°ç«¯MIPSè®¾å¤‡" >> "$METADATA_FILE"
          fi
          echo "å‰ç¼€: ${{ env.PREFIX }}" >> "$METADATA_FILE"
          
          TOTAL_SIZE=$(du -sh "$OUTPUT_DIR" 2>/dev/null | cut -f1 || echo "0K")
          FILE_COUNT=$(find "$OUTPUT_DIR" -type f 2>/dev/null | wc -l || echo 0)
          
          echo "âœ… æž„å»ºç»“æžœå·²ä¿å­˜"
          echo "æ€»å¤§å°: $TOTAL_SIZE"
          echo "æ–‡ä»¶æ•°: $FILE_COUNT"
          
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV

      - name: ðŸ“ è®°å½•ç»“æžœ
        if: always()
        run: |
          echo "=== è®°å½•æž„å»ºç»“æžœ ==="
          
          ARCH_TITLE="${{ env.ARCH_TYPE_TITLE || matrix.arch }}"
          
          if [ "$BUILD_SUCCESS" = "true" ] && [ "$VALIDATION_SUCCESS" = "true" ]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="æž„å»ºæˆåŠŸ"
            DETAILS="ç¼–è¯‘å™¨: ${COMPILER_NAME:-unknown} v${COMPILER_VERSION:-unknown}"
          elif [ "$BUILD_SUCCESS" = "false" ]; then
            STATUS_ICON="âŒ"
            STATUS_TEXT="æž„å»ºå¤±è´¥"
            DETAILS="${VALIDATION_ERROR:-æœªçŸ¥é”™è¯¯}"
          else
            STATUS_ICON="âš ï¸"
            STATUS_TEXT="éªŒè¯å¤±è´¥"
            DETAILS="${VALIDATION_ERROR:-éªŒè¯é”™è¯¯}"
          fi
          
          RESULT_DIR="${{ github.workspace }}/.job-results"
          mkdir -p "$RESULT_DIR"
          
          RESULT_FILE="$RESULT_DIR/${{ matrix.arch }}.txt"
          echo "æž¶æž„: $ARCH_TITLE" > "$RESULT_FILE"
          echo "çŠ¶æ€: $STATUS_ICON $STATUS_TEXT" >> "$RESULT_FILE"
          echo "è¯¦æƒ…: $DETAILS" >> "$RESULT_FILE"
          echo "è¾“å‡ºç›®å½•: ${OUTPUT_DIR:-æ— }" >> "$RESULT_FILE"

      - name: ðŸ“Š æ˜¾ç¤ºç»“æžœ
        if: always()
        run: |
          echo "========================================"
          echo "           JOBç»“æžœæŠ¥å‘Š                 "
          echo "========================================"
          echo "æž¶æž„: ${{ env.ARCH_TYPE_TITLE || matrix.arch }}"
          
          if [ "$BUILD_SUCCESS" = "true" ] && [ "$VALIDATION_SUCCESS" = "true" ]; then
            echo "âœ… æž„å»ºæˆåŠŸ"
            echo "ç¼–è¯‘å™¨: ${COMPILER_NAME:-unknown} v${COMPILER_VERSION:-unknown}"
            echo "è¾“å‡ºç›®å½•: ${OUTPUT_DIR:-unknown}"
          elif [ "$BUILD_SUCCESS" = "false" ]; then
            echo "âŒ æž„å»ºå¤±è´¥"
            echo "é”™è¯¯: ${VALIDATION_ERROR:-æœªçŸ¥é”™è¯¯}"
          else
            echo "âš ï¸ éªŒè¯å¤±è´¥"
            echo "é”™è¯¯: ${VALIDATION_ERROR:-éªŒè¯é”™è¯¯}"
          fi
          
          echo "========================================"

  aggregate-and-push:
    needs: 
      - setup
      - build-matrix
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”„ æ‹‰å–æœ€æ–°ä»£ç 
        run: |
          echo "=== æ‹‰å–æœ€æ–°ä»£ç  ==="
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git config pull.rebase true
          git pull origin main 2>&1 | tail -5

      - name: ðŸ”§ ç¡®ä¿ç›®å½•ç»“æž„
        run: |
          echo "=== ç¡®ä¿ç¼–è¯‘å™¨ç›®å½•ç»“æž„ ==="
          COMPILER_BASE="${{ github.workspace }}/firmware-config/build-Compiler-file"
          echo "åˆ›å»ºåŸºç¡€ç›®å½•: $COMPILER_BASE"
          mkdir -p "$COMPILER_BASE"
          
          echo "æ£€æŸ¥ç›®å½•ç»“æž„..."
          ls -la "$COMPILER_BASE" || echo "ç›®å½•åˆ›å»ºå¤±è´¥"

      - name: ðŸ“Š æ£€æŸ¥æ–‡ä»¶
        run: |
          echo "=== æ£€æŸ¥ç¼–è¯‘å™¨æ–‡ä»¶ ==="
          COMPILER_DIR="${{ github.workspace }}/firmware-config/build-Compiler-file"
          
          echo "æ£€æŸ¥ç›®å½•: $COMPILER_DIR"
          
          if [ -d "$COMPILER_DIR" ]; then
            echo "ç›®å½•å­˜åœ¨ï¼ŒæŸ¥æ‰¾ç¼–è¯‘å™¨æ–‡ä»¶..."
            echo "é€’å½’æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶:"
            find "$COMPILER_DIR" -type f 2>/dev/null | head -30 || echo "æ— æ–‡ä»¶"
            FILE_COUNT=$(find "$COMPILER_DIR" -type f 2>/dev/null | wc -l)
            echo "æ–‡ä»¶æ€»æ•°: $FILE_COUNT"
            
            if [ $FILE_COUNT -gt 0 ]; then
              echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨æ–‡ä»¶"
              echo "HAS_FILES=true" >> $GITHUB_ENV
            else
              echo "âš ï¸ ç›®å½•å­˜åœ¨ä½†ä¸ºç©º"
              echo "HAS_FILES=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ ç›®å½•ä¸å­˜åœ¨"
            echo "HAS_FILES=false" >> $GITHUB_ENV
          fi

      - name: ðŸ“¤ æŽ¨é€æ–‡ä»¶
        run: |
          echo "=== æŽ¨é€ç¼–è¯‘å™¨æ–‡ä»¶ ==="
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p "${{ github.workspace }}/firmware-config/build-Compiler-file"
          
          # æ·»åŠ æ–‡ä»¶
          git add -f "firmware-config/build-Compiler-file"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´"
            git commit --allow-empty -m "build(compiler): äº¤å‰ç¼–è¯‘å™¨æž„å»ºå®Œæˆ" -m "OpenWrt: ${{ needs.setup.outputs.openwrt_version }}" -m "æž¶æž„: ${{ github.event.inputs.arch_type }}" -m "çŠ¶æ€: æ— æ–°æ–‡ä»¶" -m "æ—¶é—´: $(date)"
          else
            echo "æœ‰æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            # æ”¶é›†ç»“æžœä¿¡æ¯
            RESULT_SUMMARY=""
            RESULT_DIR="${{ github.workspace }}/.job-results"
            if [ -d "$RESULT_DIR" ]; then
              for result_file in "$RESULT_DIR"/*.txt; do
                if [ -f "$result_file" ]; then
                  ARCH_LINE=$(grep "^æž¶æž„:" "$result_file" | head -1)
                  STATUS_LINE=$(grep "^çŠ¶æ€:" "$result_file" | head -1)
                  if [ -n "$ARCH_LINE" ] && [ -n "$STATUS_LINE" ]; then
                    RESULT_SUMMARY="${RESULT_SUMMARY}${ARCH_LINE} ${STATUS_LINE}\n"
                  fi
                fi
              done
            fi
            
            echo "æäº¤æž„å»ºç»“æžœ..."
            if [ -n "$RESULT_SUMMARY" ]; then
              git commit -m "build(compiler): æ·»åŠ äº¤å‰ç¼–è¯‘å™¨" -m "OpenWrt: ${{ needs.setup.outputs.openwrt_version }}" -m "æž¶æž„: ${{ github.event.inputs.arch_type }}" -m "ç»“æžœ:" -m "$RESULT_SUMMARY" -m "æ—¶é—´: $(date)"
            else
              git commit -m "build(compiler): æ·»åŠ äº¤å‰ç¼–è¯‘å™¨" -m "OpenWrt: ${{ needs.setup.outputs.openwrt_version }}" -m "æž¶æž„: ${{ github.event.inputs.arch_type }}" -m "æ—¶é—´: $(date)"
            fi
          fi
          
          echo "æŽ¨é€æ›´æ”¹..."
          git push origin main --force-with-lease
          echo "âœ… æŽ¨é€å®Œæˆ"

      - name: ðŸ“ æœ€ç»ˆæŠ¥å‘Š
        run: |
          echo "========================================"
          echo "           ðŸŽ¯ æž„å»ºä»»åŠ¡æ€»ç»“              "
          echo "========================================"
          echo "ä»»åŠ¡ä¿¡æ¯:"
          echo "- OpenWrtç‰ˆæœ¬: ${{ needs.setup.outputs.openwrt_version }}"
          echo "- æž¶æž„ç±»åž‹: ${{ github.event.inputs.arch_type }}"
          echo "- å¼€å§‹æ—¶é—´: ${{ needs.setup.outputs.start_time }}"
          echo "- ç»“æŸæ—¶é—´: $(date)"
          
          DURATION=$(( ($(date +%s) - $(date -d "${{ needs.setup.outputs.start_time }}" +%s)) / 60 ))
          echo "- æž„å»ºæ—¶é•¿: ${DURATION}åˆ†é’Ÿ"
          
          echo ""
          echo "å„æž¶æž„æž„å»ºç»“æžœ:"
          
          RESULT_DIR="${{ github.workspace }}/.job-results"
          if [ -d "$RESULT_DIR" ]; then
            SUCCESS_COUNT=0
            FAIL_COUNT=0
            
            for result_file in "$RESULT_DIR"/*.txt; do
              if [ -f "$result_file" ]; then
                echo ""
                cat "$result_file"
                if grep -q "âœ… æž„å»ºæˆåŠŸ" "$result_file"; then
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                else
                  FAIL_COUNT=$((FAIL_COUNT + 1))
                fi
              fi
            done
            
            echo ""
            echo "æž„å»ºç»Ÿè®¡:"
            echo "- æˆåŠŸ: $SUCCESS_COUNT"
            echo "- å¤±è´¥: $FAIL_COUNT"
            echo "- æ€»è®¡: $((SUCCESS_COUNT + FAIL_COUNT))"
          else
            echo "æœªæ‰¾åˆ°ç»“æžœæ–‡ä»¶"
          fi
          
          echo ""
          echo "è¾“å‡ºä½ç½®: firmware-config/build-Compiler-file/"
          echo "========================================"
          
          rm -rf "$RESULT_DIR" 2>/dev/null || true
