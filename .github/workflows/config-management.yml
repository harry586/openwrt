name: Firmware Config Management

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (例如: ac42u)'
        required: true
        default: 'ac42u'
        type: string

env:
  WORKSPACE: ${{ github.workspace }}
  CONFIG_DIR: ${{ github.workspace }}/firmware-config

jobs:
  config-management:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码仓库
      uses: actions/checkout@v4

    - name: 生成设备配置
      run: |
        cd ${{ github.workspace }}
        
        case "${{ github.event.inputs.device_name }}" in
          "ac42u")
            PLATFORM="ipq40xx"
            DEVICE_FULL_NAME="asus_rt-ac42u"
            ;;
          *)
            echo "未知设备: ${{ github.event.inputs.device_name }}"
            exit 1
            ;;
        esac
        
        echo "生成 ${{ github.event.inputs.device_name }} 配置..."
        
        # 创建配置目录
        mkdir -p $CONFIG_DIR/configs/
        
        # 生成配置
        echo "CONFIG_TARGET_${PLATFORM}=y" > config_temp
        echo "CONFIG_TARGET_${PLATFORM}_generic=y" >> config_temp
        echo "CONFIG_TARGET_${PLATFORM}_generic_DEVICE_${DEVICE_FULL_NAME}=y" >> config_temp
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> config_temp
        echo "CONFIG_PACKAGE_luci=y" >> config_temp
        echo "CONFIG_PACKAGE_luci-base=y" >> config_temp
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> config_temp
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> config_temp
        echo "# CONFIG_PACKAGE_luci-app-accesscontrol is not set" >> config_temp
        echo "# CONFIG_PACKAGE_luci-app-ddns is not set" >> config_temp
        echo "# CONFIG_PACKAGE_luci-app-bandwidthd is not set" >> config_temp
        echo "# CONFIG_PACKAGE_luci-app-wol is not set" >> config_temp
        
        mv config_temp $CONFIG_DIR/configs/${{ github.event.inputs.device_name }}_config
        echo "配置已保存到: $CONFIG_DIR/configs/${{ github.event.inputs.device_name }}_config"

    - name: 上传配置文件
      uses: actions/upload-artifact@v4
      with:
        name: config-${{ github.event.inputs.device_name }}
        path: ${{ env.CONFIG_DIR }}/configs/${{ github.event.inputs.device_name }}_config
        retention-days: 30

    - name: 提交配置变更
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add $CONFIG_DIR/configs/${{ github.event.inputs.device_name }}_config
        git diff --staged --quiet || git commit -m "添加 ${{ github.event.inputs.device_name }} 设备配置"
        git push
