name: ç¼–è¯‘æ–‡ä»¶ä¼ è¾“æ’ä»¶ IPK

on:
  workflow_dispatch:
    inputs:
      version_selection:
        description: 'ğŸ”„ ç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'

env:
  BUILD_DIR: /mnt/openwrt-build-filetransfer

jobs:
  build-filetransfer:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: è®¾ç½®è„šæœ¬æƒé™
      run: |
        chmod +x scripts/build_filetransfer_ipk.sh

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"

    - name: ç¼–è¯‘æ–‡ä»¶ä¼ è¾“æ’ä»¶
      run: |
        scripts/build_filetransfer_ipk.sh "${{ github.event.inputs.version_selection }}"

    - name: ä¸Šä¼ IPKæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: filetransfer-ipk-${{ github.event.inputs.version_selection }}
        path: ${{ env.BUILD_DIR }}/ipk_output/
        retention-days: 30

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: filetransfer-build-log-${{ github.event.inputs.version_selection }}
        path: ${{ env.BUILD_DIR }}/build_filetransfer.log
        retention-days: 30
