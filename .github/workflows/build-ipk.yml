name: ğŸ› ï¸ é€šç”¨IPKåŒ…ç¼–è¯‘å·¥ä½œæµï¼ˆå…¨å¹³å°æ”¯æŒï¼‰

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'ğŸ“¦ è¦ç¼–è¯‘çš„IPKåŒ…å (å¦‚: luci-app-filetransfer)'
        required: true
        default: 'luci-app-filetransfer'
        type: string
      version_selection:
        description: 'ğŸ”„ OpenWrtç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      extra_deps:
        description: 'ğŸ”§ é¢å¤–ä¾èµ–åŒ… (ç”¨é¡¿å·ã€åˆ†éš”ï¼Œå¦‚: luci-baseã€luci-compat)'
        required: false
        type: string
        default: ''
      clean_build:
        description: 'ğŸ§¹ å…¨æ–°ç¼–è¯‘ (æ¸…ç†ç¼“å­˜é‡æ–°ç¼–è¯‘)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build-ipk

jobs:
  build-ipk:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        find . -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
        echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 20 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³20G"
          exit 1
        fi

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        firmware-config/scripts/build_ipk_main.sh setup_environment

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        firmware-config/scripts/build_ipk_main.sh create_build_dir

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      run: |
        echo "=== åˆå§‹åŒ–æ„å»ºç¯å¢ƒ ==="
        firmware-config/scripts/build_ipk_main.sh initialize_build_env "${{ github.event.inputs.version_selection }}"

    - name: é…ç½®Feeds
      run: |
        echo "=== é…ç½®Feeds ==="
        firmware-config/scripts/build_ipk_main.sh configure_feeds

    - name: ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== ç¼–è¯‘å‰ç©ºé—´æ£€æŸ¥ ==="
        firmware-config/scripts/build_ipk_main.sh pre_build_space_check

    - name: ç”ŸæˆIPKé…ç½®
      run: |
        echo "=== ç”ŸæˆIPKé…ç½® ==="
        firmware-config/scripts/build_ipk_main.sh generate_config "${{ github.event.inputs.package_name }}" "${{ github.event.inputs.extra_deps }}"

    - name: åº”ç”¨é…ç½®
      run: |
        echo "=== åº”ç”¨é…ç½® ==="
        firmware-config/scripts/build_ipk_main.sh apply_config

    - name: ä¿®å¤ç½‘ç»œç¯å¢ƒ
      run: |
        echo "=== ä¿®å¤ç½‘ç»œç¯å¢ƒ ==="
        firmware-config/scripts/build_ipk_main.sh fix_network

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        echo "=== ä¸‹è½½ä¾èµ–åŒ… ==="
        firmware-config/scripts/build_ipk_main.sh download_dependencies

    - name: ç¼–è¯‘IPKåŒ…
      run: |
        echo "=== ç¼–è¯‘IPKåŒ… ==="
        firmware-config/scripts/build_ipk_main.sh build_ipk "${{ github.event.inputs.package_name }}" "${{ github.event.inputs.clean_build }}"

    - name: åˆ›å»ºå®‰è£…è„šæœ¬
      run: |
        echo "=== åˆ›å»ºå®‰è£…è„šæœ¬ ==="
        firmware-config/scripts/build_ipk_main.sh create_install_script

    - name: ä¸Šä¼ IPKæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ipk-${{ github.event.inputs.package_name }}-${{ github.event.inputs.version_selection }}
        path: ${{ env.BUILD_DIR }}/ipk_output/
        retention-days: 30

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ipk-build-log-${{ github.event.inputs.package_name }}-${{ github.event.inputs.version_selection }}
        path: ${{ env.BUILD_DIR }}/build_ipk.log
        retention-days: 30

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†IPKæ„å»ºç›®å½• ==="
        firmware-config/scripts/build_ipk_main.sh cleanup
