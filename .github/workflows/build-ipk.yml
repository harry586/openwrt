name: üõ†Ô∏è ÈÄöÁî®IPKÂåÖÁºñËØëÂ∑•‰ΩúÊµÅÔºàÂÖ®Âπ≥Âè∞ÊîØÊåÅÔºâ

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'üì¶ Ë¶ÅÁºñËØëÁöÑIPKÂåÖÂêç (Â¶Ç: luci-app-filetransfer)'
        required: true
        default: 'luci-app-filetransfer'
        type: string
      version_selection:
        description: 'üîÑ OpenWrtÁâàÊú¨ÈÄâÊã©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      extra_deps:
        description: 'üîß È¢ùÂ§ñ‰æùËµñÂåÖ (Áî®ÈÄóÂè∑ÂàÜÈöîÔºåÂ¶Ç: luci-base,luci-compat)'
        required: false
        type: string
        default: ''
      clean_build:
        description: 'üßπ ÂÖ®Êñ∞ÁºñËØë (Ê∏ÖÁêÜÁºìÂ≠òÈáçÊñ∞ÁºñËØë)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build-ipk

jobs:
  build-ipk:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Ê£ÄÂá∫‰ªìÂ∫ì
      uses: actions/checkout@v4

    - name: ÂàõÂª∫IPKÁºñËØëËÑöÊú¨
      run: |
        echo "=== ÂàõÂª∫ÈÄöÁî®IPKÁºñËØëËÑöÊú¨ ==="
        mkdir -p scripts
        cat > scripts/build_ipk.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # ÈÄöÁî®IPKÁºñËØëËÑöÊú¨ - ÊîØÊåÅÂÖ®Âπ≥Âè∞
        PACKAGE_NAME="$1"
        VERSION="$2"
        EXTRA_DEPS="$3"
        CLEAN_BUILD="$4"
        
        BUILD_DIR="/mnt/openwrt-build-ipk"
        LOG_FILE="$BUILD_DIR/build_ipk.log"
        
        # Êó•ÂøóÂáΩÊï∞
        log() {
            echo "„Äê$(date '+%Y-%m-%d %H:%M:%S')„Äë$1" | tee -a $LOG_FILE
        }
        
        # ÈîôËØØÂ§ÑÁêÜÂáΩÊï∞
        handle_error() {
            log "‚ùå ÈîôËØØÂèëÁîüÂú®: $1"
            exit 1
        }
        
        # ÂàùÂßãÂåñÊûÑÂª∫ÁéØÂ¢É
        init_build_env() {
            log "=== ÂàùÂßãÂåñIPKÁºñËØëÁéØÂ¢É ==="
            
            # Ê∏ÖÁêÜÊóßÁõÆÂΩïÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
            if [ "$CLEAN_BUILD" = "true" ]; then
                log "üßπ Ê∏ÖÁêÜÊóßÊûÑÂª∫ÁõÆÂΩï..."
                sudo rm -rf $BUILD_DIR 2>/dev/null || true
            fi
            
            # ÂàõÂª∫ÊûÑÂª∫ÁõÆÂΩï
            sudo mkdir -p $BUILD_DIR || handle_error "ÂàõÂª∫ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
            sudo chown -R $USER:$USER $BUILD_DIR || handle_error "‰øÆÊîπÁõÆÂΩïÊâÄÊúâËÄÖÂ§±Ë¥•"
            cd $BUILD_DIR || handle_error "ËøõÂÖ•ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
            
            # ÂÆâË£Ö‰æùËµñ
            log "ÂÆâË£ÖÁºñËØë‰æùËµñ..."
            sudo apt-get update || handle_error "apt-get updateÂ§±Ë¥•"
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
                gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip \
                zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath \
                libpython3-dev python3 python3-pip python3-setuptools \
                xsltproc zip subversion ninja-build automake autoconf \
                libtool pkg-config help2man texinfo aria2 liblz4-dev zstd \
                libcurl4-openssl-dev groff texlive texinfo cmake || handle_error "ÂÆâË£Ö‰æùËµñÂåÖÂ§±Ë¥•"
        }
        
        # ÂÖãÈöÜÊ∫êÁ†Å
        clone_source() {
            cd $BUILD_DIR || handle_error "ËøõÂÖ•ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
            
            log "=== ÂÖãÈöÜ $VERSION Ê∫êÁ†Å ==="
            
            if [ "$VERSION" = "23.05" ]; then
                REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
                BRANCH="openwrt-23.05"
                FEEDS_BRANCH="openwrt-23.05"
            else
                REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
                BRANCH="openwrt-21.02"
                FEEDS_BRANCH="openwrt-21.02"
            fi
            
            # Â¶ÇÊûúÁõÆÂΩïÂ∑≤Â≠òÂú®‰∏î‰∏çÊòØÂÖ®Êñ∞ÁºñËØëÔºåÂàôË∑≥ËøáÂÖãÈöÜ
            if [ ! -d ".git" ] || [ "$CLEAN_BUILD" = "true" ]; then
                git clone --depth 1 --branch "$BRANCH" "$REPO_URL" . || handle_error "ÂÖãÈöÜÊ∫êÁ†ÅÂ§±Ë¥•"
            else
                log "‚ÑπÔ∏è ‰ΩøÁî®Áé∞ÊúâÊ∫êÁ†ÅÁõÆÂΩï"
            fi
            
            # ÈÖçÁΩÆ feeds
            echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
            echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
            
            ./scripts/feeds update -a || handle_error "Êõ¥Êñ∞feedsÂ§±Ë¥•"
            ./scripts/feeds install -a || handle_error "ÂÆâË£ÖfeedsÂ§±Ë¥•"
            
            log "‚úÖ Ê∫êÁ†ÅÂáÜÂ§áÂÆåÊàê: $VERSION"
        }
        
        # ÂàõÂª∫ÊúÄÂ∞èÂåñÈÖçÁΩÆ
        create_minimal_config() {
            cd $BUILD_DIR || handle_error "ËøõÂÖ•ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
            
            log "=== ÂàõÂª∫ÊúÄÂ∞èÂåñÈÖçÁΩÆ ==="
            
            rm -f .config .config.old
            
            # Âü∫Á°ÄÈÖçÁΩÆ - ‰ΩøÁî®ÈÄöÁî®ÁöÑramips/mt76x8Âπ≥Âè∞
            cat > .config << 'EOCONFIG'
CONFIG_TARGET_ramips=y
CONFIG_TARGET_ramips_mt76x8=y
CONFIG_TARGET_ramips_mt76x8_DEVICE_xiaomi_mi-router-4a-gigabit=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y

# Âü∫Á°ÄÁ≥ªÁªü
CONFIG_PACKAGE_busybox=y
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_fstools=y
CONFIG_PACKAGE_libc=y
CONFIG_PACKAGE_libgcc=y
CONFIG_PACKAGE_mtd=y
CONFIG_PACKAGE_netifd=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_ubox=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubusd=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_uclient-fetch=y

# LuciÂü∫Á°Ä
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-lib-base=y
CONFIG_PACKAGE_luci-lib-ip=y
CONFIG_PACKAGE_luci-lib-jsonc=y
CONFIG_PACKAGE_luci-lib-nixio=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-compat=y

# ‰∏≠ÊñáÊîØÊåÅ
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
EOCONFIG

            # Ê∑ªÂä†Ë¶ÅÁºñËØëÁöÑÂåÖ
            echo "CONFIG_PACKAGE_${PACKAGE_NAME}=y" >> .config
            
            # Ê∑ªÂä†È¢ùÂ§ñ‰æùËµñ
            if [ -n "$EXTRA_DEPS" ]; then
                IFS=',' read -ra DEPS <<< "$EXTRA_DEPS"
                for dep in "${DEPS[@]}"; do
                    dep_clean=$(echo "$dep" | xargs)
                    if [ -n "$dep_clean" ]; then
                        echo "CONFIG_PACKAGE_${dep_clean}=y" >> .config
                        log "‚úÖ Ê∑ªÂä†‰æùËµñ: $dep_clean"
                    fi
                done
            fi
            
            make defconfig || handle_error "Â∫îÁî®ÈÖçÁΩÆÂ§±Ë¥•"
            log "‚úÖ ÊúÄÂ∞èÂåñÈÖçÁΩÆÂàõÂª∫ÂÆåÊàê"
        }
        
        # ÁºñËØëÊåáÂÆöÂåÖ
        build_package() {
            cd $BUILD_DIR || handle_error "ËøõÂÖ•ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
            
            log "=== ÂºÄÂßãÁºñËØëÂåÖ: $PACKAGE_NAME ($VERSION) ==="
            
            # ‰∏ãËΩΩ‰æùËµñ
            log "‰∏ãËΩΩÁºñËØë‰æùËµñ..."
            make -j1 download || handle_error "‰∏ãËΩΩ‰æùËµñÂ§±Ë¥•"
            
            # ÁºñËØëÊåáÂÆöÂåÖ
            log "ÁºñËØëÂåÖ: $PACKAGE_NAME"
            make -j$(nproc) package/${PACKAGE_NAME}/compile V=s 2>&1 | tee -a $LOG_FILE
            local build_exit_code=${PIPESTATUS[0]}
            
            if [ $build_exit_code -ne 0 ]; then
                log "‚ö†Ô∏è ÁºñËØëËøáÁ®ãÊúâÈîôËØØÔºå‰ΩÜÁªßÁª≠Â∞ùËØïÊèêÂèñIPK"
            fi
            
            # Êü•ÊâæÁîüÊàêÁöÑIPKÊñá‰ª∂
            log "=== Êü•ÊâæÁîüÊàêÁöÑIPKÊñá‰ª∂ ==="
            IPK_FOUND=0
            
            # ÊêúÁ¥¢ÊâÄÊúâÂèØËÉΩÁöÑIPKÊñá‰ª∂Ë∑ØÂæÑ
            SEARCH_PATHS=(
                "bin/packages/*/*/${PACKAGE_NAME}*.ipk"
                "bin/targets/*/*/packages/${PACKAGE_NAME}*.ipk"
                "build_dir/target-*/*/ipkg-*/${PACKAGE_NAME}*.ipk"
            )
            
            for search_path in "${SEARCH_PATHS[@]}"; do
                for ipk_file in $search_path; do
                    if [ -f "$ipk_file" ]; then
                        log "‚úÖ ÊâæÂà∞IPKÊñá‰ª∂: $ipk_file"
                        mkdir -p $BUILD_DIR/ipk_output
                        cp "$ipk_file" $BUILD_DIR/ipk_output/
                        IPK_FOUND=1
                    fi
                done
            done
            
            # Â¶ÇÊûúÊ≤°ÊâæÂà∞ÔºåÂ∞ùËØïÊ∑±Â∫¶ÊêúÁ¥¢
            if [ $IPK_FOUND -eq 0 ]; then
                log "üîç Ê∑±Â∫¶ÊêúÁ¥¢IPKÊñá‰ª∂..."
                find $BUILD_DIR -name "*${PACKAGE_NAME}*.ipk" -type f | while read ipk_file; do
                    log "‚úÖ ÊâæÂà∞IPKÊñá‰ª∂: $ipk_file"
                    mkdir -p $BUILD_DIR/ipk_output
                    cp "$ipk_file" $BUILD_DIR/ipk_output/
                    IPK_FOUND=1
                done
            fi
            
            # Ê£ÄÊü•ÁªìÊûú
            if [ $IPK_FOUND -eq 1 ]; then
                log "üéâ ÂåÖ $PACKAGE_NAME ÁºñËØëÊàêÂäüÔºÅ"
                log "üì¶ ÁîüÊàêÁöÑIPKÊñá‰ª∂:"
                ls -la $BUILD_DIR/ipk_output/
                
                # ÂàõÂª∫Êñá‰ª∂ÂàóË°®
                find $BUILD_DIR/ipk_output -name "*.ipk" -type f > $BUILD_DIR/ipk_output/file_list.txt
            else
                log "‚ùå Êú™ÊâæÂà∞ÁîüÊàêÁöÑIPKÊñá‰ª∂"
                log "üí° Â∞ùËØïÁºñËØëÊï¥‰∏™ÂåÖÁõÆÂΩï..."
                
                # Â∞ùËØïÁºñËØëÊï¥‰∏™ÂåÖÁõÆÂΩï
                make -j$(nproc) package/compile V=s 2>&1 | tee -a $LOG_FILE
                
                # ÂÜçÊ¨°ÊêúÁ¥¢
                find $BUILD_DIR -name "*${PACKAGE_NAME}*.ipk" -type f | while read ipk_file; do
                    log "‚úÖ ÊâæÂà∞IPKÊñá‰ª∂: $ipk_file"
                    mkdir -p $BUILD_DIR/ipk_output
                    cp "$ipk_file" $BUILD_DIR/ipk_output/
                    IPK_FOUND=1
                done
                
                if [ $IPK_FOUND -eq 0 ]; then
                    handle_error "IPKÊñá‰ª∂ÁîüÊàêÂ§±Ë¥• - ËØ∑Ê£ÄÊü•ÂåÖÂêçÊòØÂê¶Ê≠£Á°Æ"
                fi
            fi
        }
        
        # ÂàõÂª∫ÈÄöÁî®ÂÆâË£ÖËÑöÊú¨
        create_install_script() {
            cd $BUILD_DIR || handle_error "ËøõÂÖ•ÊûÑÂª∫ÁõÆÂΩïÂ§±Ë¥•"
            
            log "=== ÂàõÂª∫ÈÄöÁî®ÂÆâË£ÖËÑöÊú¨ ==="
            
            cat > $BUILD_DIR/ipk_output/install_package.sh << 'EOINSTALL'
#!/bin/bash
# ÈÄöÁî®IPKÂåÖÂÆâË£ÖËÑöÊú¨
# ÈÄÇÁî®‰∫éÂÖ®Âπ≥Âè∞OpenWrt

set -e

PACKAGE_NAME="$1"

if [ -z "$PACKAGE_NAME" ]; then
    echo "Áî®Ê≥ï: $0 <ÂåÖÂêç>"
    echo "Á§∫‰æã: $0 luci-app-filetransfer"
    exit 1
fi

echo "=== OpenWrt IPKÂåÖÂÆâË£ÖËÑöÊú¨ ==="
echo "Ë¶ÅÂÆâË£ÖÁöÑÂåÖ: $PACKAGE_NAME"

# Ê£ÄÊü•Á≥ªÁªü
if [ ! -f "/etc/openwrt_release" ]; then
    echo "‚ùå Ëøô‰∏çÊòØOpenWrtÁ≥ªÁªü"
    exit 1
fi

# Ëé∑ÂèñÊû∂ÊûÑ
ARCH=$(opkg print-architecture | awk '{print $2}')
echo "Á≥ªÁªüÊû∂ÊûÑ: $ARCH"

# Êü•ÊâæÂåπÈÖçÁöÑIPKÊñá‰ª∂
IPK_FILE=$(find . -name "*${PACKAGE_NAME}*.ipk" | head -1)

if [ -z "$IPK_FILE" ]; then
    echo "‚ùå Êú™ÊâæÂà∞ÂåÖ $PACKAGE_NAME ÁöÑIPKÊñá‰ª∂"
    echo "ÂΩìÂâçÁõÆÂΩï‰∏ãÁöÑIPKÊñá‰ª∂:"
    find . -name "*.ipk" | while read file; do
        echo "  - $(basename "$file")"
    done
    exit 1
fi

echo "ÊâæÂà∞IPKÊñá‰ª∂: $(basename "$IPK_FILE")"

# ÂÆâË£Ö‰æùËµñÔºàÂ∞ùËØïËá™Âä®Ëß£ÂÜ≥Ôºâ
echo "Ê£ÄÊü•‰æùËµñ..."
opkg update

# Â∞ùËØïÂÆâË£ÖIPKÔºà‰ºöËá™Âä®Ëß£ÂÜ≥‰æùËµñÔºâ
echo "ÂÆâË£ÖÂåÖ: $PACKAGE_NAME"
if opkg install "$IPK_FILE"; then
    echo "‚úÖ $PACKAGE_NAME ÂÆâË£ÖÊàêÂäüÔºÅ"
    
    # Ê£ÄÊü•ÊòØÂê¶ÁúüÁöÑÂÆâË£ÖÊàêÂäü
    if opkg list-installed | grep -q "$PACKAGE_NAME"; then
        echo "üéâ ÂåÖÂ∑≤ÊàêÂäüÂÆâË£ÖÂà∞Á≥ªÁªü"
        
        # Â¶ÇÊûúÊòØLuciÂ∫îÁî®ÔºåÊèêÁ§∫ÈáçÂêØÊúçÂä°
        if [[ "$PACKAGE_NAME" == luci-app-* ]]; then
            echo ""
            echo "üí° Â¶ÇÊûúÊòØLuciÂ∫îÁî®ÔºåËØ∑:"
            echo "1. Âà∑Êñ∞ÊµèËßàÂô®ÁºìÂ≠ò"
            echo "2. Âú®LuciÁïåÈù¢‰∏≠Êü•ÁúãÊñ∞ÂäüËÉΩ"
        fi
    else
        echo "‚ö†Ô∏è ÂåÖÂèØËÉΩÊú™Ê≠£Á°ÆÂÆâË£ÖÔºåËØ∑Ê£ÄÊü•‰ª•‰∏äËæìÂá∫"
    fi
else
    echo "‚ùå ÂÆâË£ÖÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•‰æùËµñÂÖ≥Á≥ª"
    echo "üí° ÂèØ‰ª•Â∞ùËØïÊâãÂä®ÂÆâË£Ö‰æùËµñÂêéÈáçËØï"
    exit 1
fi
EOINSTALL

            chmod +x $BUILD_DIR/ipk_output/install_package.sh
            
            # ÂàõÂª∫‰ΩøÁî®ËØ¥Êòé
            cat > $BUILD_DIR/ipk_output/README.md << 'EOREADME'
# IPKÂåÖ‰ΩøÁî®ËØ¥Êòé

## Êñá‰ª∂ËØ¥Êòé
- `*.ipk`: OpenWrtËΩØ‰ª∂ÂåÖÊñá‰ª∂
- `install_package.sh`: Ëá™Âä®ÂÆâË£ÖËÑöÊú¨
- `file_list.txt`: Êñá‰ª∂ÂàóË°®

## ÂÆâË£ÖÊñπÊ≥ï

### ÊñπÊ≥ï‰∏ÄÔºö‰ΩøÁî®ÂÆâË£ÖËÑöÊú¨ÔºàÊé®ËçêÔºâ
```bash
# ‰∏ä‰º†Êï¥‰∏™ipk_outputÁõÆÂΩïÂà∞Ë∑ØÁî±Âô®
scp -r ipk_output root@192.168.1.1:/tmp/

# Âú®Ë∑ØÁî±Âô®‰∏äÊâßË°å
ssh root@192.168.1.1
cd /tmp/ipk_output
./install_package.sh <ÂåÖÂêç>
