name: ğŸ› ï¸ é€šç”¨IPKåŒ…ç¼–è¯‘å·¥ä½œæµï¼ˆå…¨å¹³å°æ”¯æŒï¼‰

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'ğŸ“¦ è¦ç¼–è¯‘çš„IPKåŒ…å (å¦‚: luci-app-filetransfer)'
        required: true
        default: 'luci-app-filetransfer'
        type: string
      version_selection:
        description: 'ğŸ”„ OpenWrtç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '23.05'
        - '21.02'
      extra_deps:
        description: 'ğŸ”§ é¢å¤–ä¾èµ–åŒ… (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: luci-base,luci-compat)'
        required: false
        type: string
        default: ''
      clean_build:
        description: 'ğŸ§¹ å…¨æ–°ç¼–è¯‘ (æ¸…ç†ç¼“å­˜é‡æ–°ç¼–è¯‘)'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build-ipk

jobs:
  build-ipk:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: åˆ›å»ºIPKç¼–è¯‘è„šæœ¬
      run: |
        echo "=== åˆ›å»ºIPKç¼–è¯‘è„šæœ¬ ==="
        mkdir -p firmware-config/scripts
        cat > firmware-config/scripts/build_ipk.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # é€šç”¨IPKç¼–è¯‘è„šæœ¬ - æ”¯æŒå…¨å¹³å°
        PACKAGE_NAME="$1"
        VERSION="$2"
        EXTRA_DEPS="$3"
        CLEAN_BUILD="$4"
        
        BUILD_DIR="/mnt/openwrt-build-ipk"
        LOG_FILE="$BUILD_DIR/build_ipk.log"
        
        # æ—¥å¿—å‡½æ•°
        log() {
            echo "ã€$(date '+%Y-%m-%d %H:%M:%S')ã€‘$1" | tee -a $LOG_FILE
        }
        
        # é”™è¯¯å¤„ç†å‡½æ•°
        handle_error() {
            log "âŒ é”™è¯¯å‘ç”Ÿåœ¨: $1"
            exit 1
        }
        
        # åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
        init_build_env() {
            log "=== åˆå§‹åŒ–IPKç¼–è¯‘ç¯å¢ƒ ==="
            
            # æ¸…ç†æ—§ç›®å½•ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if [ "$CLEAN_BUILD" = "true" ]; then
                log "ğŸ§¹ æ¸…ç†æ—§æ„å»ºç›®å½•..."
                sudo rm -rf $BUILD_DIR 2>/dev/null || true
            fi
            
            # åˆ›å»ºæ„å»ºç›®å½•
            sudo mkdir -p $BUILD_DIR || handle_error "åˆ›å»ºæ„å»ºç›®å½•å¤±è´¥"
            sudo chown -R $USER:$USER $BUILD_DIR || handle_error "ä¿®æ”¹ç›®å½•æ‰€æœ‰è€…å¤±è´¥"
            cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
            
            # å®‰è£…ä¾èµ–
            log "å®‰è£…ç¼–è¯‘ä¾èµ–..."
            sudo apt-get update || handle_error "apt-get updateå¤±è´¥"
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libpython3-dev python3 python3-pip python3-setuptools xsltproc zip subversion ninja-build automake autoconf libtool pkg-config help2man texinfo aria2 liblz4-dev zstd libcurl4-openssl-dev groff texlive texinfo cmake || handle_error "å®‰è£…ä¾èµ–åŒ…å¤±è´¥"
        }
        
        # å…‹éš†æºç 
        clone_source() {
            cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
            
            log "=== å…‹éš† $VERSION æºç  ==="
            
            if [ "$VERSION" = "23.05" ]; then
                REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
                BRANCH="openwrt-23.05"
                FEEDS_BRANCH="openwrt-23.05"
            else
                REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
                BRANCH="openwrt-21.02"
                FEEDS_BRANCH="openwrt-21.02"
            fi
            
            # å¦‚æœç›®å½•å·²å­˜åœ¨ä¸”ä¸æ˜¯å…¨æ–°ç¼–è¯‘ï¼Œåˆ™è·³è¿‡å…‹éš†
            if [ ! -d ".git" ] || [ "$CLEAN_BUILD" = "true" ]; then
                git clone --depth 1 --branch "$BRANCH" "$REPO_URL" . || handle_error "å…‹éš†æºç å¤±è´¥"
            else
                log "â„¹ï¸ ä½¿ç”¨ç°æœ‰æºç ç›®å½•"
            fi
            
            # é…ç½® feeds
            echo "src-git packages https://github.com/immortalwrt/packages.git;$FEEDS_BRANCH" > feeds.conf.default
            echo "src-git luci https://github.com/immortalwrt/luci.git;$FEEDS_BRANCH" >> feeds.conf.default
            
            ./scripts/feeds update -a || handle_error "æ›´æ–°feedså¤±è´¥"
            ./scripts/feeds install -a || handle_error "å®‰è£…feedså¤±è´¥"
            
            log "âœ… æºç å‡†å¤‡å®Œæˆ: $VERSION"
        }
        
        # åˆ›å»ºæœ€å°åŒ–é…ç½®
        create_minimal_config() {
            cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
            
            log "=== åˆ›å»ºæœ€å°åŒ–é…ç½® ==="
            
            rm -f .config .config.old
            
            # åŸºç¡€é…ç½® - ä½¿ç”¨é€šç”¨çš„ramips/mt76x8å¹³å°
            echo "CONFIG_TARGET_ramips=y" > .config
            echo "CONFIG_TARGET_ramips_mt76x8=y" >> .config
            echo "CONFIG_TARGET_ramips_mt76x8_DEVICE_xiaomi_mi-router-4a-gigabit=y" >> .config
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
            echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
            
            # åŸºç¡€ç³»ç»Ÿ
            echo "CONFIG_PACKAGE_busybox=y" >> .config
            echo "CONFIG_PACKAGE_base-files=y" >> .config
            echo "CONFIG_PACKAGE_dropbear=y" >> .config
            echo "CONFIG_PACKAGE_firewall=y" >> .config
            echo "CONFIG_PACKAGE_fstools=y" >> .config
            echo "CONFIG_PACKAGE_libc=y" >> .config
            echo "CONFIG_PACKAGE_libgcc=y" >> .config
            echo "CONFIG_PACKAGE_mtd=y" >> .config
            echo "CONFIG_PACKAGE_netifd=y" >> .config
            echo "CONFIG_PACKAGE_opkg=y" >> .config
            echo "CONFIG_PACKAGE_procd=y" >> .config
            echo "CONFIG_PACKAGE_ubox=y" >> .config
            echo "CONFIG_PACKAGE_ubus=y" >> .config
            echo "CONFIG_PACKAGE_ubusd=y" >> .config
            echo "CONFIG_PACKAGE_uci=y" >> .config
            echo "CONFIG_PACKAGE_uclient-fetch=y" >> .config
            
            # LuciåŸºç¡€
            echo "CONFIG_PACKAGE_luci=y" >> .config
            echo "CONFIG_PACKAGE_luci-base=y" >> .config
            echo "CONFIG_PACKAGE_luci-lib-base=y" >> .config
            echo "CONFIG_PACKAGE_luci-lib-ip=y" >> .config
            echo "CONFIG_PACKAGE_luci-lib-jsonc=y" >> .config
            echo "CONFIG_PACKAGE_luci-lib-nixio=y" >> .config
            echo "CONFIG_PACKAGE_luci-mod-admin-full=y" >> .config
            echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
            echo "CONFIG_PACKAGE_luci-compat=y" >> .config
            
            # ä¸­æ–‡æ”¯æŒ
            echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config

            # æ·»åŠ è¦ç¼–è¯‘çš„åŒ…
            echo "CONFIG_PACKAGE_${PACKAGE_NAME}=y" >> .config
            
            # æ·»åŠ é¢å¤–ä¾èµ–
            if [ -n "$EXTRA_DEPS" ]; then
                IFS=',' read -ra DEPS <<< "$EXTRA_DEPS"
                for dep in "${DEPS[@]}"; do
                    dep_clean=$(echo "$dep" | xargs)
                    if [ -n "$dep_clean" ]; then
                        echo "CONFIG_PACKAGE_${dep_clean}=y" >> .config
                        log "âœ… æ·»åŠ ä¾èµ–: $dep_clean"
                    fi
                done
            fi
            
            make defconfig || handle_error "åº”ç”¨é…ç½®å¤±è´¥"
            log "âœ… æœ€å°åŒ–é…ç½®åˆ›å»ºå®Œæˆ"
        }
        
        # ç¼–è¯‘æŒ‡å®šåŒ…
        build_package() {
            cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
            
            log "=== å¼€å§‹ç¼–è¯‘åŒ…: $PACKAGE_NAME ($VERSION) ==="
            
            # ä¸‹è½½ä¾èµ–
            log "ä¸‹è½½ç¼–è¯‘ä¾èµ–..."
            make -j1 download || handle_error "ä¸‹è½½ä¾èµ–å¤±è´¥"
            
            # ç¼–è¯‘æŒ‡å®šåŒ…
            log "ç¼–è¯‘åŒ…: $PACKAGE_NAME"
            make -j$(nproc) package/${PACKAGE_NAME}/compile V=s 2>&1 | tee -a $LOG_FILE
            local build_exit_code=${PIPESTATUS[0]}
            
            if [ $build_exit_code -ne 0 ]; then
                log "âš ï¸ ç¼–è¯‘è¿‡ç¨‹æœ‰é”™è¯¯ï¼Œä½†ç»§ç»­å°è¯•æå–IPK"
            fi
            
            # æŸ¥æ‰¾ç”Ÿæˆçš„IPKæ–‡ä»¶
            log "=== æŸ¥æ‰¾ç”Ÿæˆçš„IPKæ–‡ä»¶ ==="
            IPK_FOUND=0
            
            # æœç´¢æ‰€æœ‰å¯èƒ½çš„IPKæ–‡ä»¶è·¯å¾„
            SEARCH_PATHS=("bin/packages/*/*/${PACKAGE_NAME}*.ipk" "bin/targets/*/*/packages/${PACKAGE_NAME}*.ipk" "build_dir/target-*/*/ipkg-*/${PACKAGE_NAME}*.ipk")
            
            for search_path in "${SEARCH_PATHS[@]}"; do
                for ipk_file in $search_path; do
                    if [ -f "$ipk_file" ]; then
                        log "âœ… æ‰¾åˆ°IPKæ–‡ä»¶: $ipk_file"
                        mkdir -p $BUILD_DIR/ipk_output
                        cp "$ipk_file" $BUILD_DIR/ipk_output/
                        IPK_FOUND=1
                    fi
                done
            done
            
            # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•æ·±åº¦æœç´¢
            if [ $IPK_FOUND -eq 0 ]; then
                log "ğŸ” æ·±åº¦æœç´¢IPKæ–‡ä»¶..."
                find $BUILD_DIR -name "*${PACKAGE_NAME}*.ipk" -type f | while read ipk_file; do
                    log "âœ… æ‰¾åˆ°IPKæ–‡ä»¶: $ipk_file"
                    mkdir -p $BUILD_DIR/ipk_output
                    cp "$ipk_file" $BUILD_DIR/ipk_output/
                    IPK_FOUND=1
                done
            fi
            
            # æ£€æŸ¥ç»“æœ
            if [ $IPK_FOUND -eq 1 ]; then
                log "ğŸ‰ åŒ… $PACKAGE_NAME ç¼–è¯‘æˆåŠŸï¼"
                log "ğŸ“¦ ç”Ÿæˆçš„IPKæ–‡ä»¶:"
                ls -la $BUILD_DIR/ipk_output/
                
                # åˆ›å»ºæ–‡ä»¶åˆ—è¡¨
                find $BUILD_DIR/ipk_output -name "*.ipk" -type f > $BUILD_DIR/ipk_output/file_list.txt
            else
                log "âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„IPKæ–‡ä»¶"
                log "ğŸ’¡ å°è¯•ç¼–è¯‘æ•´ä¸ªåŒ…ç›®å½•..."
                
                # å°è¯•ç¼–è¯‘æ•´ä¸ªåŒ…ç›®å½•
                make -j$(nproc) package/compile V=s 2>&1 | tee -a $LOG_FILE
                
                # å†æ¬¡æœç´¢
                find $BUILD_DIR -name "*${PACKAGE_NAME}*.ipk" -type f | while read ipk_file; do
                    log "âœ… æ‰¾åˆ°IPKæ–‡ä»¶: $ipk_file"
                    mkdir -p $BUILD_DIR/ipk_output
                    cp "$ipk_file" $BUILD_DIR/ipk_output/
                    IPK_FOUND=1
                done
                
                if [ $IPK_FOUND -eq 0 ]; then
                    handle_error "IPKæ–‡ä»¶ç”Ÿæˆå¤±è´¥ - è¯·æ£€æŸ¥åŒ…åæ˜¯å¦æ­£ç¡®"
                fi
            fi
        }
        
        # åˆ›å»ºé€šç”¨å®‰è£…è„šæœ¬
        create_install_script() {
            cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
            
            log "=== åˆ›å»ºé€šç”¨å®‰è£…è„šæœ¬ ==="
            
            # åˆ›å»ºå®‰è£…è„šæœ¬
            echo '#!/bin/bash' > $BUILD_DIR/ipk_output/install_package.sh
            echo '# é€šç”¨IPKåŒ…å®‰è£…è„šæœ¬' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '# é€‚ç”¨äºå…¨å¹³å°OpenWrt' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'set -e' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'PACKAGE_NAME="$1"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'if [ -z "$PACKAGE_NAME" ]; then' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    echo "ç”¨æ³•: $0 <åŒ…å>"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    echo "ç¤ºä¾‹: $0 luci-app-filetransfer"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    exit 1' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'fi' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'echo "=== OpenWrt IPKåŒ…å®‰è£…è„šæœ¬ ==="' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'echo "è¦å®‰è£…çš„åŒ…: $PACKAGE_NAME"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '# æ£€æŸ¥ç³»ç»Ÿ' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'if [ ! -f "/etc/openwrt_release" ]; then' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    echo "âŒ è¿™ä¸æ˜¯OpenWrtç³»ç»Ÿ"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    exit 1' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'fi' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '# è·å–æ¶æ„' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'ARCH=$(opkg print-architecture | awk '\''{print $2}'\'')' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'echo "ç³»ç»Ÿæ¶æ„: $ARCH"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '# æŸ¥æ‰¾åŒ¹é…çš„IPKæ–‡ä»¶' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'IPK_FILE=$(find . -name "*${PACKAGE_NAME}*.ipk" | head -1)' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'if [ -z "$IPK_FILE" ]; then' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    echo "âŒ æœªæ‰¾åˆ°åŒ… $PACKAGE_NAME çš„IPKæ–‡ä»¶"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    echo "å½“å‰ç›®å½•ä¸‹çš„IPKæ–‡ä»¶:"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    find . -name "*.ipk" | while read file; do' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '        echo "  - $(basename "$file")"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    done' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    exit 1' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'fi' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'echo "æ‰¾åˆ°IPKæ–‡ä»¶: $(basename "$IPK_FILE")"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '# å®‰è£…ä¾èµ–ï¼ˆå°è¯•è‡ªåŠ¨è§£å†³ï¼‰' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'echo "æ£€æŸ¥ä¾èµ–..."' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'opkg update' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '# å°è¯•å®‰è£…IPKï¼ˆä¼šè‡ªåŠ¨è§£å†³ä¾èµ–ï¼‰' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'echo "å®‰è£…åŒ…: $PACKAGE_NAME"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'if opkg install "$IPK_FILE"; then' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    echo "âœ… $PACKAGE_NAME å®‰è£…æˆåŠŸï¼"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    # æ£€æŸ¥æ˜¯å¦çœŸçš„å®‰è£…æˆåŠŸ' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    if opkg list-installed | grep -q "$PACKAGE_NAME"; then' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '        echo "ğŸ‰ åŒ…å·²æˆåŠŸå®‰è£…åˆ°ç³»ç»Ÿ"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '        # å¦‚æœæ˜¯Luciåº”ç”¨ï¼Œæç¤ºé‡å¯æœåŠ¡' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '        if [[ "$PACKAGE_NAME" == luci-app-* ]]; then' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '            echo ""' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '            echo "ğŸ’¡ å¦‚æœæ˜¯Luciåº”ç”¨ï¼Œè¯·:"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '            echo "1. åˆ·æ–°æµè§ˆå™¨ç¼“å­˜"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '            echo "2. åœ¨Luciç•Œé¢ä¸­æŸ¥çœ‹æ–°åŠŸèƒ½"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '        fi' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    else' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '        echo "âš ï¸ åŒ…å¯èƒ½æœªæ­£ç¡®å®‰è£…ï¼Œè¯·æ£€æŸ¥ä»¥ä¸Šè¾“å‡º"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    fi' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'else' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    echo "âŒ å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¾èµ–å…³ç³»"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    echo "ğŸ’¡ å¯ä»¥å°è¯•æ‰‹åŠ¨å®‰è£…ä¾èµ–åé‡è¯•"' >> $BUILD_DIR/ipk_output/install_package.sh
            echo '    exit 1' >> $BUILD_DIR/ipk_output/install_package.sh
            echo 'fi' >> $BUILD_DIR/ipk_output/install_package.sh

            chmod +x $BUILD_DIR/ipk_output/install_package.sh
            
            # åˆ›å»ºä½¿ç”¨è¯´æ˜
            echo '# IPKåŒ…ä½¿ç”¨è¯´æ˜' > $BUILD_DIR/ipk_output/README.md
            echo '' >> $BUILD_DIR/ipk_output/README.md
            echo '## æ–‡ä»¶è¯´æ˜' >> $BUILD_DIR/ipk_output/README.md
            echo '- `*.ipk`: OpenWrtè½¯ä»¶åŒ…æ–‡ä»¶' >> $BUILD_DIR/ipk_output/README.md
            echo '- `install_package.sh`: è‡ªåŠ¨å®‰è£…è„šæœ¬' >> $BUILD_DIR/ipk_output/README.md
            echo '- `file_list.txt`: æ–‡ä»¶åˆ—è¡¨' >> $BUILD_DIR/ipk_output/README.md
            echo '' >> $BUILD_DIR/ipk_output/README.md
            echo '## å®‰è£…æ–¹æ³•' >> $BUILD_DIR/ipk_output/README.md
            echo '' >> $BUILD_DIR/ipk_output/README.md
            echo '### æ–¹æ³•ä¸€ï¼šä½¿ç”¨å®‰è£…è„šæœ¬ï¼ˆæ¨èï¼‰' >> $BUILD_DIR/ipk_output/README.md
            echo '```bash' >> $BUILD_DIR/ipk_output/README.md
            echo '# ä¸Šä¼ æ•´ä¸ªipk_outputç›®å½•åˆ°è·¯ç”±å™¨' >> $BUILD_DIR/ipk_output/README.md
            echo 'scp -r ipk_output root@192.168.1.1:/tmp/' >> $BUILD_DIR/ipk_output/README.md
            echo '' >> $BUILD_DIR/ipk_output/README.md
            echo '# åœ¨è·¯ç”±å™¨ä¸Šæ‰§è¡Œ' >> $BUILD_DIR/ipk_output/README.md
            echo 'ssh root@192.168.1.1' >> $BUILD_DIR/ipk_output/README.md
            echo 'cd /tmp/ipk_output' >> $BUILD_DIR/ipk_output/README.md
            echo './install_package.sh <åŒ…å>' >> $BUILD_DIR/ipk_output/README.md
            echo '```' >> $BUILD_DIR/ipk_output/README.md
            echo '' >> $BUILD_DIR/ipk_output/README.md
            echo '### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨å®‰è£…' >> $BUILD_DIR/ipk_output/README.md
            echo '```bash' >> $BUILD_DIR/ipk_output/README.md
            echo '# ä¸Šä¼ IPKæ–‡ä»¶åˆ°è·¯ç”±å™¨' >> $BUILD_DIR/ipk_output/README.md
            echo 'scp *.ipk root@192.168.1.1:/tmp/' >> $BUILD_DIR/ipk_output/README.md
            echo '' >> $BUILD_DIR/ipk_output/README.md
            echo '# åœ¨è·¯ç”±å™¨ä¸Šå®‰è£…' >> $BUILD_DIR/ipk_output/README.md
            echo 'ssh root@192.168.1.1' >> $BUILD_DIR/ipk_output/README.md
            echo 'cd /tmp' >> $BUILD_DIR/ipk_output/README.md
            echo 'opkg update' >> $BUILD_DIR/ipk_output/README.md
            echo 'opkg install *.ipk' >> $BUILD_DIR/ipk_output/README.md
            echo '```' >> $BUILD_DIR/ipk_output/README.md
            echo '' >> $BUILD_DIR/ipk_output/README.md
            echo '## æ”¯æŒçš„å¹³å°' >> $BUILD_DIR/ipk_output/README.md
            echo '- æ‰€æœ‰OpenWrtå¹³å°ï¼ˆå…¨å¹³å°é€šç”¨ï¼‰' >> $BUILD_DIR/ipk_output/README.md
            echo '- OpenWrt 21.02 / 23.05' >> $BUILD_DIR/ipk_output/README.md
            echo '- ImmortalWrt' >> $BUILD_DIR/ipk_output/README.md
            echo '' >> $BUILD_DIR/ipk_output/README.md
            echo '## æ³¨æ„äº‹é¡¹' >> $BUILD_DIR/ipk_output/README.md
            echo '1. ç¡®ä¿è·¯ç”±å™¨æœ‰è¶³å¤Ÿçš„ç©ºé—´' >> $BUILD_DIR/ipk_output/README.md
            echo '2. å®‰è£…å‰å»ºè®®å¤‡ä»½é…ç½®' >> $BUILD_DIR/ipk_output/README.md
            echo '3. æŸäº›åŒ…å¯èƒ½éœ€è¦ç‰¹å®šä¾èµ–' >> $BUILD_DIR/ipk_output/README.md

            log "âœ… å®‰è£…è„šæœ¬å’Œè¯´æ˜æ–‡æ¡£åˆ›å»ºå®Œæˆ"
        }
        
        # ä¸»å‡½æ•°
        main() {
            log "=========================================="
            log "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘IPKåŒ…"
            log "ğŸ“¦ åŒ…å: $PACKAGE_NAME"
            log "ğŸ”„ ç‰ˆæœ¬: $VERSION"
            log "ğŸ”§ é¢å¤–ä¾èµ–: $EXTRA_DEPS"
            log "ğŸ§¹ å…¨æ–°ç¼–è¯‘: $CLEAN_BUILD"
            log "=========================================="
            
            # æ‰§è¡Œç¼–è¯‘æ­¥éª¤
            init_build_env
            clone_source
            create_minimal_config
            build_package
            create_install_script
            
            log "=========================================="
            log "ğŸ‰ IPKåŒ…ç¼–è¯‘å®Œæˆï¼"
            log "ğŸ“ IPKæ–‡ä»¶ä½ç½®: $BUILD_DIR/ipk_output/"
            log "ğŸ”„ å®‰è£…è„šæœ¬: $BUILD_DIR/ipk_output/install_package.sh"
            log "ğŸ“‹ æ–‡ä»¶åˆ—è¡¨: $BUILD_DIR/ipk_output/file_list.txt"
            log "=========================================="
            
            # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            echo "ç”Ÿæˆçš„æ–‡ä»¶:"
            find $BUILD_DIR/ipk_output -type f -exec ls -la {} \;
        }
        
        # æ‰§è¡Œä¸»å‡½æ•°
        main
        EOF
        
        echo "âœ… IPKç¼–è¯‘è„šæœ¬åˆ›å»ºå®Œæˆ"

    - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        echo "=== è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ ==="
        chmod +x firmware-config/scripts/build_ipk.sh
        echo "âœ… è„šæœ¬æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"

    - name: åˆå§‹ç©ºé—´æ£€æŸ¥
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        AVAILABLE_SPACE=$(df /mnt --output=avail | tail -1)
        AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
        echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}G"
        if [ $AVAILABLE_GB -lt 20 ]; then
          echo "é”™è¯¯: /mnt ç©ºé—´ä¸è¶³20G"
          exit 1
        fi

    - name: ç¼–è¯‘IPKåŒ…
      run: |
        echo "=== ç¼–è¯‘IPKåŒ… ==="
        firmware-config/scripts/build_ipk.sh \
          "${{ github.event.inputs.package_name }}" \
          "${{ github.event.inputs.version_selection }}" \
          "${{ github.event.inputs.extra_deps }}" \
          "${{ github.event.inputs.clean_build }}"

    - name: ä¸Šä¼ IPKæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ipk-${{ github.event.inputs.package_name }}-${{ github.event.inputs.version_selection }}
        path: ${{ env.BUILD_DIR }}/ipk_output/
        retention-days: 30

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ipk-build-log-${{ github.event.inputs.package_name }}-${{ github.event.inputs.version_selection }}
        path: ${{ env.BUILD_DIR }}/build_ipk.log
        retention-days: 30

    - name: æ¸…ç†ç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†IPKæ„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR || echo "âš ï¸ æ¸…ç†æ„å»ºç›®å½•å¤±è´¥"
        echo "âœ… æ„å»ºç›®å½•å·²æ¸…ç†"
