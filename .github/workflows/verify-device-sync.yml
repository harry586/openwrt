# .github/workflows/verify-device-sync.yml
name: éªŒè¯è®¾å¤‡åˆ—è¡¨åŒæ­¥

on:
  push:
    branches: [ main, master ]
    paths:
      - 'firmware-config/support.sh'
      - '.github/workflows/firmware-build.yml'
  pull_request:
    paths:
      - 'firmware-config/support.sh'
      - '.github/workflows/firmware-build.yml'
  workflow_dispatch:

jobs:
  verify-sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: éªŒè¯è®¾å¤‡åˆ—è¡¨åŒæ­¥
        run: |
          echo "ğŸ” éªŒè¯ support.sh å’Œ firmware-build.yml çš„è®¾å¤‡åˆ—è¡¨åŒæ­¥çŠ¶æ€..."
          echo ""
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "firmware-config/support.sh" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° firmware-config/support.sh"
            exit 1
          fi
          
          if [ ! -f ".github/workflows/firmware-build.yml" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° .github/workflows/firmware-build.yml"
            exit 1
          fi
          
          # ä» support.sh è¯»å–è®¾å¤‡
          echo "ğŸ“– ä» support.sh è¯»å–è®¾å¤‡åˆ—è¡¨..."
          source firmware-config/support.sh
          
          if ! command -v get_all_devices >/dev/null 2>&1; then
            echo "âŒ é”™è¯¯: support.sh ä¸­æ²¡æœ‰ get_all_devices å‡½æ•°"
            exit 1
          fi
          
          SUPPORT_DEVICES=$(get_all_devices)
          echo "âœ… support.sh ä¸­çš„è®¾å¤‡: $SUPPORT_DEVICES"
          echo ""
          
          # ä» workflow.yml è¯»å–è®¾å¤‡
          echo "ğŸ“– ä» workflow.yml è¯»å–è®¾å¤‡åˆ—è¡¨..."
          WORKFLOW_DEVICES=$(grep -A 50 "device_name:" .github/workflows/firmware-build.yml | 
                            grep -E '^\s*-\s*"' | 
                            sed 's/^\s*-\s*"\(.*\)"/\1/' | 
                            tr '\n' ' ' | 
                            sed 's/ $//')
          
          echo "âœ… workflow.yml ä¸­çš„è®¾å¤‡: $WORKFLOW_DEVICES"
          echo ""
          
          # æ ‡å‡†åŒ–æ¯”è¾ƒï¼ˆæ’åºåæ¯”è¾ƒï¼‰
          SUPPORT_SORTED=$(echo "$SUPPORT_DEVICES" | tr ' ' '\n' | sort | tr '\n' ' ')
          WORKFLOW_SORTED=$(echo "$WORKFLOW_DEVICES" | tr ' ' '\n' | sort | tr '\n' ' ')
          
          echo "ğŸ“Š æ ‡å‡†åŒ–æ¯”è¾ƒ:"
          echo "  support.sh (æ’åºå): $SUPPORT_SORTED"
          echo "  workflow.yml (æ’åºå): $WORKFLOW_SORTED"
          echo ""
          
          # æ¯”è¾ƒä¸¤ä¸ªåˆ—è¡¨
          if [ "$SUPPORT_SORTED" = "$WORKFLOW_SORTED" ]; then
            echo "ğŸ‰ è®¾å¤‡åˆ—è¡¨åŒæ­¥æˆåŠŸï¼"
            echo ""
            echo "âœ… éªŒè¯é€šè¿‡"
          else
            echo "âŒ é”™è¯¯: è®¾å¤‡åˆ—è¡¨ä¸åŒæ­¥ï¼"
            echo ""
            echo "ğŸ“Š å·®å¼‚åˆ†æ:"
            echo "  åªåœ¨ support.sh ä¸­:"
            for device in $SUPPORT_DEVICES; do
              if ! echo " $WORKFLOW_DEVICES " | grep -q " $device "; then
                echo "    - $device"
              fi
            done
            
            echo ""
            echo "  åªåœ¨ workflow.yml ä¸­:"
            for device in $WORKFLOW_DEVICES; do
              if ! echo " $SUPPORT_DEVICES " | grep -q " $device "; then
                echo "    - $device"
              fi
            done
            
            echo ""
            echo "ğŸ”§ ä¿®å¤æ–¹æ³•:"
            echo "  1. è¿è¡ŒåŒæ­¥è„šæœ¬è‡ªåŠ¨ä¿®å¤:"
            echo "     ./firmware-config/scripts/sync-device-list.sh"
            echo ""
            echo "  2. æˆ–è€…æ‰‹åŠ¨ç¼–è¾‘ .github/workflows/firmware-build.yml"
            echo "     åœ¨ device_name çš„ options éƒ¨åˆ†æ›´æ–°è®¾å¤‡åˆ—è¡¨"
            echo ""
            echo "  3. æäº¤ä¿®å¤åçš„æ–‡ä»¶"
            echo ""
            echo "âš ï¸ æ³¨æ„: å¦‚æœä¸ä¿®å¤ï¼Œå›ºä»¶æ„å»ºå·¥ä½œæµå¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ"
            exit 1
          fi
          
      - name: æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
        if: success()
        run: |
          echo "ğŸ“‹ åŒæ­¥çŠ¶æ€æŠ¥å‘Š"
          echo "================"
          echo "âœ… è®¾å¤‡åˆ—è¡¨åŒæ­¥éªŒè¯é€šè¿‡"
          echo ""
          echo "ğŸ”§ æ”¯æŒçš„è®¾å¤‡:"
          source firmware-config/support.sh
          DEVICES=$(get_all_devices)
          COUNT=$(echo $DEVICES | wc -w)
          echo "  è®¾å¤‡æ•°é‡: $COUNT ä¸ª"
          for device in $DEVICES; do
            DESC=$(get_device_description "$device" 2>/dev/null || echo "æ— æè¿°")
            echo "  - $device: $DESC"
          done
          
      - name: è‡ªåŠ¨ä¿®å¤ï¼ˆå¯é€‰ï¼‰
        if: failure()
        run: |
          echo "ğŸ”„ å°è¯•è‡ªåŠ¨ä¿®å¤..."
          if [ -x "firmware-config/scripts/sync-device-list.sh" ]; then
            ./firmware-config/scripts/sync-device-list.sh
            echo ""
            echo "âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆ"
            echo "ğŸ“‹ è¯·æäº¤æ›´æ–°åçš„ .github/workflows/firmware-build.yml æ–‡ä»¶"
          else
            echo "âŒ æ‰¾ä¸åˆ°åŒæ­¥è„šæœ¬: firmware-config/scripts/sync-device-list.sh"
          fi
