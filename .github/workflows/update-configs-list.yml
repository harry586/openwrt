name: "æ›´æ–°é…ç½®æ–‡ä»¶åˆ—è¡¨"

on:
  push:
    paths:
      - 'firmware-config/configs/**'
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  update-configs-list:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ æ£€å‡ºä»“åº“"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: "ğŸ“‹ ç”Ÿæˆé…ç½®æ–‡ä»¶åˆ—è¡¨"
        run: |
          echo "ç”Ÿæˆé…ç½®æ–‡ä»¶åˆ—è¡¨..."
          CONFIGS_DIR="firmware-config/configs"
          OUTPUT_FILE="firmware-config/configs-list.md"
          
          echo "# è®¾å¤‡é…ç½®æ–‡ä»¶åˆ—è¡¨" > $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE
          echo "> æœ€åæ›´æ–°: $(date)" >> $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE
          echo "## å¯ç”¨é…ç½®æ–‡ä»¶" >> $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE
          echo "| è®¾å¤‡åç§° | é…ç½®æ–‡ä»¶ | ç”Ÿæˆæ—¶é—´ | å¤§å° |" >> $OUTPUT_FILE
          echo "|---------|----------|----------|------|" >> $OUTPUT_FILE
          
          if [ -d "$CONFIGS_DIR" ]; then
            for config_file in $(find $CONFIGS_DIR -name "config_*" -type f | sort); do
              filename=$(basename "$config_file")
              device_name=$(echo "$filename" | sed 's/^config_//')
              file_size=$(du -h "$config_file" | cut -f1)
              mod_time=$(date -r "$config_file" "+%Y-%m-%d %H:%M:%S")
              
              # è·å–è®¾å¤‡ç›®æ ‡ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              target_info=$(grep "^CONFIG_TARGET" "$config_file" | head -2 | tr '\n' ' ' | sed 's/  */ /g')
              
              echo "| \`$device_name\` | \`$filename\` | $mod_time | $file_size |" >> $OUTPUT_FILE
            done
          else
            echo "| æ— é…ç½®æ–‡ä»¶ | - | - | - |" >> $OUTPUT_FILE
          fi
          
          echo "" >> $OUTPUT_FILE
          echo "## ä½¿ç”¨è¯´æ˜" >> $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE
          echo "1. åœ¨æ„å»ºå·¥ä½œæµä¸­è¾“å…¥è®¾å¤‡åç§°ï¼ˆå¦‚ï¼šrt-ac42uï¼‰" >> $OUTPUT_FILE
          echo "2. ç³»ç»Ÿä¼šè‡ªåŠ¨æŸ¥æ‰¾å¯¹åº”çš„é…ç½®æ–‡ä»¶" >> $OUTPUT_FILE
          echo "3. å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ¨¡æ¿" >> $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE
          echo "## æ·»åŠ æ–°è®¾å¤‡" >> $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE
          echo "è¦æ·»åŠ æ–°è®¾å¤‡æ”¯æŒï¼Œå¯ä»¥åœ¨ \`firmware-config/configs/\` ç›®å½•ä¸‹åˆ›å»º \`config_è®¾å¤‡åç§°\` æ–‡ä»¶ã€‚" >> $OUTPUT_FILE

      - name: "ğŸ“¤ æäº¤æ›´æ–°"
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add firmware-config/configs-list.md
          git diff --staged --quiet || git commit -m "ğŸ“‹ æ›´æ–°é…ç½®æ–‡ä»¶åˆ—è¡¨ [skip ci]"
          git push
