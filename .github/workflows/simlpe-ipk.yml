name: ğŸ› ï¸ ç®€åŒ–IPKåŒ…ç¼–è¯‘å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      package_names:
        description: 'ğŸ“¦ è¦ç¼–è¯‘çš„IPKåŒ…å (ç”¨é¡¿å·ã€åˆ†éš”ï¼Œå¦‚: luci-app-upnpã€luci-app-ddns)'
        required: true
        type: string
        default: 'luci-app-upnp'
      version_selection:
        description: 'ğŸ”„ OpenWrtç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '21.02'
        - '23.05'
      clean_build:
        description: 'ğŸ§¹ å…¨æ–°ç¼–è¯‘'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build-simple

jobs:
  build-ipk-simple:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        sudo apt-get update
        sudo apt-get install -y build-essential git wget unzip
        sudo apt-get install -y libncurses5-dev libssl-dev python3 python3-distutils
        sudo apt-get install -y gcc g++ flex bison gawk make curl
        sudo apt-get install -y rsync subversion tar gzip zstd

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR

    - name: å…‹éš†æºç 
      run: |
        echo "=== å…‹éš†æºç  ==="
        cd $BUILD_DIR
        
        if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
          echo "ä½¿ç”¨ ImmortalWrt 23.05"
          git clone --depth 1 --branch openwrt-23.05 https://github.com/immortalwrt/immortalwrt.git .
        else
          echo "ä½¿ç”¨ ImmortalWrt 21.02"
          git clone --depth 1 --branch openwrt-21.02 https://github.com/immortalwrt/immortalwrt.git .
        fi

    - name: æ›´æ–° feeds
      run: |
        echo "=== æ›´æ–° feeds ==="
        cd $BUILD_DIR
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åˆ›å»ºåŸºç¡€é…ç½®
      run: |
        echo "=== åˆ›å»ºåŸºç¡€é…ç½® ==="
        cd $BUILD_DIR
        
        # åˆ›å»ºåŸºç¡€é…ç½® - ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤
        echo "CONFIG_TARGET_x86_64=y" > .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config

    - name: æ·»åŠ åŒ…é…ç½®
      run: |
        echo "=== æ·»åŠ åŒ…é…ç½® ==="
        cd $BUILD_DIR
        
        # è·å–è¦ç¼–è¯‘çš„åŒ…å
        PACKAGE_NAMES="${{ github.event.inputs.package_names }}"
        echo "è¦ç¼–è¯‘çš„åŒ…: $PACKAGE_NAMES"
        
        # åˆ†å‰²åŒ…åå¹¶æ·»åŠ åˆ°é…ç½® - é¿å…å¤æ‚æ•°ç»„
        echo "$PACKAGE_NAMES" | tr 'ã€' '\n' | while read package; do
          if [ -n "$package" ]; then
            echo "CONFIG_PACKAGE_${package}=y" >> .config
            echo "âœ… æ·»åŠ åŒ…: $package"
          fi
        done

    - name: åº”ç”¨é…ç½®
      run: |
        echo "=== åº”ç”¨é…ç½® ==="
        cd $BUILD_DIR
        make defconfig
        echo "é…ç½®å®Œæˆ"

    - name: ä¸‹è½½ä¾èµ–
      run: |
        echo "=== ä¸‹è½½ä¾èµ– ==="
        cd $BUILD_DIR
        make download -j$(nproc) DOWNLOAD_RETRIES=3

    - name: ç¼–è¯‘æŒ‡å®šåŒ…
      run: |
        echo "=== ç¼–è¯‘æŒ‡å®šåŒ… ==="
        cd $BUILD_DIR
        
        # è·å–è¦ç¼–è¯‘çš„åŒ…å
        PACKAGE_NAMES="${{ github.event.inputs.package_names }}"
        CLEAN_BUILD="${{ github.event.inputs.clean_build }}"
        
        # ç¼–è¯‘æ¯ä¸ªåŒ… - ä½¿ç”¨ç®€å•å¾ªç¯
        echo "$PACKAGE_NAMES" | tr 'ã€' '\n' | while read package; do
          if [ -n "$package" ]; then
            echo "=== ç¼–è¯‘åŒ…: $package ==="
            
            # æ¸…ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if [ "$CLEAN_BUILD" = "true" ]; then
              echo "ğŸ§¹ æ¸…ç†åŒ…..."
              make package/$package/clean 2>/dev/null || echo "æ¸…ç†å¤±è´¥ï¼Œç»§ç»­ç¼–è¯‘"
            fi
            
            # ç¼–è¯‘
            echo "å¼€å§‹ç¼–è¯‘..."
            if make -j$(nproc) package/$package/compile; then
              echo "âœ… ç¼–è¯‘æˆåŠŸ: $package"
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥: $package"
              echo "å°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
              make -j1 package/$package/compile || echo "å•çº¿ç¨‹ç¼–è¯‘ä¹Ÿå¤±è´¥"
            fi
          fi
        done

    - name: æ”¶é›†IPKæ–‡ä»¶
      run: |
        echo "=== æ”¶é›†IPKæ–‡ä»¶ ==="
        cd $BUILD_DIR
        mkdir -p ipk_output
        
        # è·å–è¦ç¼–è¯‘çš„åŒ…å
        PACKAGE_NAMES="${{ github.event.inputs.package_names }}"
        
        # è®¡æ•°å˜é‡
        IPK_COUNT=0
        
        # æŸ¥æ‰¾å¯¹åº”çš„IPKæ–‡ä»¶
        echo "$PACKAGE_NAMES" | tr 'ã€' '\n' | while read package; do
          if [ -n "$package" ]; then
            echo "=== æŸ¥æ‰¾ $package çš„IPKæ–‡ä»¶ ==="
            
            # åœ¨å¤šä¸ªä½ç½®æŸ¥æ‰¾IPKæ–‡ä»¶ - ä½¿ç”¨ç®€å•æ•°ç»„
            for search_path in "bin/packages/*/*/${package}*.ipk" "bin/packages/*/*/${package/-/_}*.ipk" "bin/targets/*/*/packages/${package}*.ipk"; do
              for ipk_file in $search_path; do
                if [ -f "$ipk_file" ]; then
                  echo "âœ… æ‰¾åˆ°: $ipk_file"
                  cp "$ipk_file" ipk_output/ 2>/dev/null || true
                  IPK_COUNT=$((IPK_COUNT + 1))
                fi
              done
            done
          fi
        done
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•æ·±åº¦æœç´¢
        if [ $IPK_COUNT -eq 0 ]; then
          echo "ğŸ” æ·±åº¦æœç´¢æ‰€æœ‰IPKæ–‡ä»¶..."
          find bin -name "*.ipk" -type f 2>/dev/null | head -10 | while read ipk_file; do
            echo "ğŸ“¦ æ‰¾åˆ°: $ipk_file"
            cp "$ipk_file" ipk_output/ 2>/dev/null || true
            IPK_COUNT=$((IPK_COUNT + 1))
          done
        fi
        
        # æ˜¾ç¤ºç»“æœ
        echo "=== ç¼–è¯‘ç»“æœ ==="
        if [ $IPK_COUNT -gt 0 ]; then
          echo "ğŸ‰ æˆåŠŸç”Ÿæˆ $IPK_COUNT ä¸ªIPKæ–‡ä»¶"
          ls -la ipk_output/
          
          # åˆ›å»ºæ–‡ä»¶åˆ—è¡¨
          find ipk_output -name "*.ipk" -type f 2>/dev/null > ipk_output/file_list.txt 2>/dev/null || true
        else
          echo "âŒ æœªæ‰¾åˆ°IPKæ–‡ä»¶"
          
          # æ˜¾ç¤ºå¯èƒ½çš„é—®é¢˜
          echo "ğŸ’¡ è°ƒè¯•å»ºè®®:"
          echo "1. æ£€æŸ¥åŒ…åæ˜¯å¦æ­£ç¡®"
          echo "2. å°è¯•ç¼–è¯‘å•ä¸ªç®€å•åŒ…: luci-app-upnp"
          echo "3. æ£€æŸ¥ç¼–è¯‘æ—¥å¿—"
        fi

    - name: åˆ›å»ºå®‰è£…è„šæœ¬
      run: |
        echo "=== åˆ›å»ºå®‰è£…è„šæœ¬ ==="
        cd $BUILD_DIR/ipk_output 2>/dev/null || mkdir -p $BUILD_DIR/ipk_output && cd $BUILD_DIR/ipk_output
        
        # ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤åˆ›å»ºè„šæœ¬ï¼Œé¿å…heredoc
        echo '#!/bin/bash' > install.sh
        echo '# IPKåŒ…å®‰è£…è„šæœ¬' >> install.sh
        echo '' >> install.sh
        echo 'echo "=== IPKåŒ…å®‰è£…è„šæœ¬ ==="' >> install.sh
        echo '' >> install.sh
        echo '# æ£€æŸ¥æ˜¯å¦åœ¨OpenWrtç³»ç»Ÿ' >> install.sh
        echo 'if ! command -v opkg >/dev/null 2>&1; then' >> install.sh
        echo '  echo "âŒ è¿™ä¸æ˜¯OpenWrtç³»ç»Ÿ"' >> install.sh
        echo '  exit 1' >> install.sh
        echo 'fi' >> install.sh
        echo '' >> install.sh
        echo '# åˆ—å‡ºæ‰€æœ‰IPKæ–‡ä»¶' >> install.sh
        echo 'IPK_FILES=$(ls *.ipk 2>/dev/null)' >> install.sh
        echo 'if [ -z "$IPK_FILES" ]; then' >> install.sh
        echo '  echo "âŒ æœªæ‰¾åˆ°IPKæ–‡ä»¶"' >> install.sh
        echo '  exit 1' >> install.sh
        echo 'fi' >> install.sh
        echo '' >> install.sh
        echo 'echo "æ‰¾åˆ°ä»¥ä¸‹IPKæ–‡ä»¶:"' >> install.sh
        echo 'for file in *.ipk; do' >> install.sh
        echo '  echo "ğŸ“¦ $file"' >> install.sh
        echo 'done' >> install.sh
        echo '' >> install.sh
        echo 'echo ""' >> install.sh
        echo 'read -p "æ˜¯å¦å®‰è£…æ‰€æœ‰åŒ…? (y/N): " CONFIRM' >> install.sh
        echo 'if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then' >> install.sh
        echo '  echo "å®‰è£…å–æ¶ˆ"' >> install.sh
        echo '  exit 0' >> install.sh
        echo 'fi' >> install.sh
        echo '' >> install.sh
        echo '# æ›´æ–°åŒ…åˆ—è¡¨' >> install.sh
        echo 'echo "æ›´æ–°åŒ…åˆ—è¡¨..."' >> install.sh
        echo 'opkg update' >> install.sh
        echo '' >> install.sh
        echo '# å®‰è£…æ‰€æœ‰åŒ…' >> install.sh
        echo 'for file in *.ipk; do' >> install.sh
        echo '  echo ""' >> install.sh
        echo '  echo "å®‰è£…: $file"' >> install.sh
        echo '  opkg install "$file" --force-overwrite' >> install.sh
        echo 'done' >> install.sh
        echo '' >> install.sh
        echo 'echo ""' >> install.sh
        echo 'echo "âœ… å®‰è£…å®Œæˆ"' >> install.sh
        
        chmod +x install.sh
        echo "âœ… å®‰è£…è„šæœ¬åˆ›å»ºå®Œæˆ"

    - name: ä¸Šä¼ IPKæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ipk-packages-${{ github.event.inputs.version_selection }}
        path: ${{ env.BUILD_DIR }}/ipk_output/
        retention-days: 30

    - name: æ¸…ç†æ„å»ºç›®å½•
      if: always()
      run: |
        echo "=== æ¸…ç†æ„å»ºç›®å½• ==="
        sudo rm -rf $BUILD_DIR
