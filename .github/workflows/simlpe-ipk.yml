name: ğŸ› ï¸ ç®€åŒ–IPKåŒ…ç¼–è¯‘å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      package_names:
        description: 'ğŸ“¦ è¦ç¼–è¯‘çš„IPKåŒ…å (å•ä¸ªåŒ…ï¼Œå¦‚: luci-app-upnp)'
        required: true
        type: string
        default: 'luci-app-upnp'
      version_selection:
        description: 'ğŸ”„ OpenWrtç‰ˆæœ¬é€‰æ‹©'
        required: true
        type: choice
        default: '21.02'
        options:
        - '21.02'
        - '23.05'
      clean_build:
        description: 'ğŸ§¹ å…¨æ–°ç¼–è¯‘'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: /mnt/openwrt-build-simple

jobs:
  build-ipk-simple:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        sudo apt-get update
        sudo apt-get install -y build-essential git wget unzip \
          libncurses5-dev libssl-dev python3 python3-distutils \
          gcc g++ flex bison gawk make curl

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        echo "=== åˆ›å»ºæ„å»ºç›®å½• ==="
        sudo mkdir -p $BUILD_DIR
        sudo chown -R $USER:$USER $BUILD_DIR

    - name: å…‹éš†æºç 
      run: |
        echo "=== å…‹éš†æºç  ==="
        cd $BUILD_DIR
        
        if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
          echo "ä½¿ç”¨ OpenWrt 23.05"
          git clone --depth 1 --branch openwrt-23.05 https://github.com/openwrt/openwrt.git .
        else
          echo "ä½¿ç”¨ OpenWrt 21.02"
          git clone --depth 1 --branch openwrt-21.02 https://github.com/openwrt/openwrt.git .
        fi

    - name: æ›´æ–° feeds
      run: |
        echo "=== æ›´æ–° feeds ==="
        cd $BUILD_DIR
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: é…ç½®ç¼–è¯‘
      run: |
        echo "=== é…ç½®ç¼–è¯‘ ==="
        cd $BUILD_DIR
        
        # åˆ›å»ºæœ€å°é…ç½®
        cat > .config << EOF
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
EOF
        
        # æ·»åŠ è¦ç¼–è¯‘çš„åŒ…
        echo "è¦ç¼–è¯‘çš„åŒ…: ${{ github.event.inputs.package_names }}"
        
        # å°†åŒ…ååˆ†å‰²å¹¶æ·»åŠ åˆ°é…ç½®
        echo "${{ github.event.inputs.package_names }}" | tr 'ã€' '\n' | while read package; do
          if [ -n "$package" ]; then
            echo "CONFIG_PACKAGE_${package}=y" >> .config
            echo "âœ… æ·»åŠ åŒ…: $package"
          fi
        done
        
        make defconfig

    - name: ä¸‹è½½ä¾èµ–
      run: |
        echo "=== ä¸‹è½½ä¾èµ– ==="
        cd $BUILD_DIR
        make download -j$(nproc)

    - name: ç¼–è¯‘æŒ‡å®šåŒ…
      run: |
        echo "=== ç¼–è¯‘æŒ‡å®šåŒ… ==="
        cd $BUILD_DIR
        
        # ç¼–è¯‘æ¯ä¸ªåŒ…
        echo "${{ github.event.inputs.package_names }}" | tr 'ã€' '\n' | while read package; do
          if [ -n "$package" ]; then
            echo "=== ç¼–è¯‘åŒ…: $package ==="
            
            # æ¸…ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
              make package/$package/clean 2>/dev/null || echo "æ¸…ç†å¤±è´¥ï¼Œç»§ç»­"
            fi
            
            # ç¼–è¯‘
            make package/$package/compile -j$(nproc) V=s 2>&1 | tail -200
            
            # æŸ¥æ‰¾ç”Ÿæˆçš„IPK
            echo "=== æŸ¥æ‰¾ $package çš„IPKæ–‡ä»¶ ==="
            find bin -name "*${package}*.ipk" -type f 2>/dev/null | head -5
          fi
        done

    - name: æ”¶é›†IPKæ–‡ä»¶
      run: |
        echo "=== æ”¶é›†IPKæ–‡ä»¶ ==="
        cd $BUILD_DIR
        mkdir -p ipk_output
        
        # æŸ¥æ‰¾æ‰€æœ‰IPKæ–‡ä»¶
        find bin -name "*.ipk" -type f 2>/dev/null | while read ipk_file; do
          echo "ğŸ“¦ æ‰¾åˆ°: $ipk_file"
          cp "$ipk_file" ipk_output/ 2>/dev/null || true
        done
        
        # æ˜¾ç¤ºç»“æœ
        echo "=== ç¼–è¯‘ç»“æœ ==="
        ls -la ipk_output/ 2>/dev/null || echo "æœªæ‰¾åˆ°IPKæ–‡ä»¶"

    - name: ä¸Šä¼ IPKæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ipk-packages-${{ github.event.inputs.version_selection }}
        path: ${{ env.BUILD_DIR }}/ipk_output/
        retention-days: 30

    - name: æ¸…ç†
      if: always()
      run: |
        sudo rm -rf $BUILD_DIR
