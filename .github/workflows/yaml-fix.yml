name: YAML æ ¼å¼è‡ªåŠ¨ä¿®å¤

on:
  workflow_dispatch:
    inputs:
      target_file:
        description: 'è¦ä¿®å¤çš„ YAML æ–‡ä»¶è·¯å¾„'
        required: true
        default: '.github/workflows/build-openwrt.yml'
        type: string
      auto_commit:
        description: 'è‡ªåŠ¨æäº¤ä¿®å¤åçš„æ–‡ä»¶'
        required: false
        default: true
        type: boolean

env:
  TARGET_FILE: ${{ github.event.inputs.target_file }}

jobs:
  yaml-fix:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      id: check-file
      run: |
        echo "=== æ£€æŸ¥ç›®æ ‡æ–‡ä»¶ ==="
        if [ -f "$TARGET_FILE" ]; then
          echo "âœ… æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
          echo "file_exists=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $TARGET_FILE"
          echo "file_exists=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: éªŒè¯å½“å‰ YAML æ ¼å¼
      id: validate-yaml
      run: |
        echo "=== éªŒè¯ YAML æ ¼å¼ ==="
        if python3 -c "import yaml; yaml.safe_load(open('$TARGET_FILE'))"; then
          echo "âœ… YAML æ ¼å¼éªŒè¯é€šè¿‡"
          echo "yaml_valid=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ YAML æ ¼å¼éªŒè¯å¤±è´¥"
          echo "yaml_valid=false" >> $GITHUB_OUTPUT
        fi

    - name: å¤‡ä»½åŸæ–‡ä»¶
      run: |
        echo "=== å¤‡ä»½åŸæ–‡ä»¶ ==="
        cp "$TARGET_FILE" "$TARGET_FILE.backup"
        echo "âœ… æ–‡ä»¶å·²å¤‡ä»½åˆ°: $TARGET_FILE.backup"

    - name: å®‰è£… YAML å¤„ç†å·¥å…·
      run: |
        echo "=== å®‰è£… YAML å¤„ç†å·¥å…· ==="
        sudo apt-get update
        sudo apt-get install -y python3-pip
        pip3 install PyYAML
        echo "âœ… YAML å·¥å…·å®‰è£…å®Œæˆ"

    - name: è‡ªåŠ¨ä¿®å¤ YAML æ ¼å¼
      id: fix-yaml
      run: |
        echo "=== å¼€å§‹è‡ªåŠ¨ä¿®å¤ YAML æ ¼å¼ ==="
        
        # åˆ›å»º Python è„šæœ¬æ¥ä¿®å¤ YAML
        cat > fix_yaml.py << 'SCRIPT_EOF'
import yaml
import sys
import re

def fix_yaml_structure(data):
    """ä¿®å¤ YAML ç»“æ„é—®é¢˜"""
    if isinstance(data, dict):
        fixed = {}
        for key, value in data.items():
            # ä¿®å¤é”®åä¸­çš„ç‚¹å·é—®é¢˜
            if '.' in str(key):
                new_key = str(key).replace('.', '_')
                print(f"è­¦å‘Š: é”®ååŒ…å«ç‚¹å·ï¼Œå·²æ›¿æ¢: {key} -> {new_key}")
                key = new_key
            fixed[key] = fix_yaml_structure(value)
        return fixed
    elif isinstance(data, list):
        return [fix_yaml_structure(item) for item in data]
    else:
        return data

def load_and_fix_yaml(file_path):
    """åŠ è½½å¹¶ä¿®å¤ YAML æ–‡ä»¶"""
    try:
        with open(file_path, 'r', encoding='utf-8') as file:
            content = file.read()
        
        # ä¿®å¤å¸¸è§çš„ YAML æ ¼å¼é—®é¢˜
        fixes = [
            # ä¿®å¤æ•°ç»„æ ¼å¼ï¼ˆç¡®ä¿ä½¿ç”¨ç©ºæ ¼åˆ†éš”ï¼‰
            (r'\[([^\]]+)\]', lambda m: '[' + m.group(1).replace(',', ' ') + ']'),
            # ä¿®å¤ heredoc æ ·å¼çš„å¤šè¡Œå­—ç¬¦ä¸²
            (r'<<\s*[\'"]?([^\'"]+)[\'"]?', '<<'),
            # ä¿®å¤ä¸æ­£ç¡®çš„ç¼©è¿›
            (r'^\s+', lambda m: '  ' * (len(m.group(0)) // 2)),
        ]
        
        for pattern, replacement in fixes:
            content = re.sub(pattern, replacement, content, flags=re.MULTILINE)
        
        # è§£æ YAML
        data = yaml.safe_load(content)
        
        # ä¿®å¤ç»“æ„é—®é¢˜
        data = fix_yaml_structure(data)
        
        return data
        
    except Exception as e:
        print(f"YAML è§£æé”™è¯¯: {e}")
        return None

def save_yaml(data, file_path):
    """ä¿å­˜ä¿®å¤åçš„ YAML"""
    try:
        with open(file_path, 'w', encoding='utf-8') as file:
            yaml.dump(data, file, default_flow_style=False, allow_unicode=True, indent=2, sort_keys=False)
        return True
    except Exception as e:
        print(f"YAML ä¿å­˜é”™è¯¯: {e}")
        return False

# ä¸»ç¨‹åº
if __name__ == "__main__":
    file_path = sys.argv[1]
    print(f"å¤„ç†æ–‡ä»¶: {file_path}")
    
    data = load_and_fix_yaml(file_path)
    if data:
        if save_yaml(data, file_path):
            print("âœ… YAML æ–‡ä»¶ä¿®å¤æˆåŠŸ")
            sys.exit(0)
        else:
            print("âŒ YAML æ–‡ä»¶ä¿å­˜å¤±è´¥")
            sys.exit(1)
    else:
        print("âŒ YAML æ–‡ä»¶è§£æå¤±è´¥")
        sys.exit(1)
SCRIPT_EOF

        # è¿è¡Œä¿®å¤è„šæœ¬
        python3 fix_yaml.py "$TARGET_FILE"
        FIX_EXIT_CODE=$?
        
        if [ $FIX_EXIT_CODE -eq 0 ]; then
          echo "fix_success=true" >> $GITHUB_OUTPUT
        else
          echo "fix_success=false" >> $GITHUB_OUTPUT
        fi

    - name: éªŒè¯ä¿®å¤åçš„ YAML
      id: validate-fixed
      run: |
        echo "=== éªŒè¯ä¿®å¤åçš„ YAML ==="
        if python3 -c "import yaml; yaml.safe_load(open('$TARGET_FILE'))"; then
          echo "âœ… ä¿®å¤åçš„ YAML æ ¼å¼éªŒè¯é€šè¿‡"
          echo "fixed_valid=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ä¿®å¤åçš„ YAML æ ¼å¼éªŒè¯å¤±è´¥"
          echo "fixed_valid=false" >> $GITHUB_OUTPUT
        fi

    - name: æ˜¾ç¤ºä¿®å¤å·®å¼‚
      if: always()
      run: |
        echo "=== ä¿®å¤å‰åå·®å¼‚ ==="
        if command -v diff &> /dev/null; then
          if diff -u "$TARGET_FILE.backup" "$TARGET_FILE"; then
            echo "âš ï¸  æ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°ä»¥ä¸‹å˜æ›´:"
            diff -u "$TARGET_FILE.backup" "$TARGET_FILE" || true
          fi
        else
          echo "âš ï¸  diff å‘½ä»¤ä¸å¯ç”¨ï¼Œæ— æ³•æ˜¾ç¤ºå·®å¼‚"
        fi

    - name: è‡ªåŠ¨æäº¤ä¿®å¤
      if: github.event.inputs.auto_commit == 'true' && steps.validate-fixed.outputs.fixed_valid == 'true'
      run: |
        echo "=== è‡ªåŠ¨æäº¤ä¿®å¤ ==="
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add "$TARGET_FILE"
        if git diff --staged --quiet; then
          echo "âš ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          git commit -m "ğŸ”§ è‡ªåŠ¨ä¿®å¤ YAML æ ¼å¼ [$TARGET_FILE]"
          git push
          echo "âœ… ä¿®å¤å·²æäº¤åˆ°ä»“åº“"
        fi

    - name: ç”Ÿæˆä¿®å¤æŠ¥å‘Š
      if: always()
      run: |
        echo "=== YAML ä¿®å¤æŠ¥å‘Š ==="
        echo "ç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
        echo "ä¿®å¤å‰éªŒè¯: ${{ steps.validate-yaml.outputs.yaml_valid }}"
        echo "ä¿®å¤æ“ä½œ: ${{ steps.fix-yaml.outputs.fix_success }}"
        echo "ä¿®å¤åéªŒè¯: ${{ steps.validate-fixed.outputs.fixed_valid }}"
        echo "è‡ªåŠ¨æäº¤: ${{ github.event.inputs.auto_commit }}"
        
        if [ "${{ steps.validate-fixed.outputs.fixed_valid }}" = "true" ]; then
          echo "ğŸ‰ YAML æ ¼å¼ä¿®å¤æˆåŠŸï¼"
        else
          echo "âŒ YAML æ ¼å¼ä¿®å¤å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
        fi

    - name: æ¸…ç†å¤‡ä»½æ–‡ä»¶
      if: always()
      run: |
        echo "=== æ¸…ç†å¤‡ä»½æ–‡ä»¶ ==="
        if [ -f "$TARGET_FILE.backup" ]; then
          rm "$TARGET_FILE.backup"
          echo "âœ… å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†"
        fi

  manual-review:
    runs-on: ubuntu-latest
    needs: yaml-fix
    if: failure()
    
    steps:
    - name: é€šçŸ¥éœ€è¦æ‰‹åŠ¨æ£€æŸ¥
      run: |
        echo "âŒ è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨æ£€æŸ¥ YAML æ–‡ä»¶"
        echo "æ–‡ä»¶è·¯å¾„: ${{ env.TARGET_FILE }}"
        echo "è¯·æ£€æŸ¥ä»¥ä¸‹å¸¸è§é—®é¢˜:"
        echo "1. ç¼©è¿›ä¸ä¸€è‡´"
        echo "2. æ•°ç»„æ ¼å¼é”™è¯¯"
        echo "3. ç‰¹æ®Šå­—ç¬¦é—®é¢˜"
        echo "4. é”®ååŒ…å«éæ³•å­—ç¬¦"
