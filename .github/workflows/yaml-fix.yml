name: YAML æ ¼å¼è‡ªåŠ¨ä¿®å¤

on:
  workflow_dispatch:
    inputs:
      workflow_name:
        description: 'å·¥ä½œæµæ–‡ä»¶åç§° (å¦‚: firmware-build)'
        required: true
        default: 'firmware-build'
        type: string
      auto_commit:
        description: 'è‡ªåŠ¨æäº¤ä¿®å¤åçš„æ–‡ä»¶'
        required: false
        default: true
        type: boolean

env:
  TARGET_FILE: .github/workflows/${{ github.event.inputs.workflow_name }}.yml

jobs:
  yaml-fix:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: æ˜¾ç¤ºç›®æ ‡æ–‡ä»¶è·¯å¾„
      run: |
        echo "=== ç›®æ ‡æ–‡ä»¶ä¿¡æ¯ ==="
        echo "è¾“å…¥çš„å·¥ä½œæµåç§°: ${{ github.event.inputs.workflow_name }}"
        echo "å®Œæ•´æ–‡ä»¶è·¯å¾„: $TARGET_FILE"

    - name: æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      id: check-file
      run: |
        echo "=== æ£€æŸ¥ç›®æ ‡æ–‡ä»¶ ==="
        if [ -f "$TARGET_FILE" ]; then
          echo "âœ… æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
          echo "file_exists=true" >> $GITHUB_OUTPUT
          echo "æ–‡ä»¶å¤§å°: $(wc -l < "$TARGET_FILE") è¡Œ"
        else
          echo "âŒ ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $TARGET_FILE"
          echo "file_exists=false" >> $GITHUB_OUTPUT
          echo "=== å½“å‰å·¥ä½œæµç›®å½•å†…å®¹ ==="
          ls -la .github/workflows/ || echo "å·¥ä½œæµç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

    - name: åˆå§‹ YAML æ ¼å¼æ£€æŸ¥
      id: initial-check
      run: |
        echo "=== åˆå§‹ YAML æ ¼å¼æ£€æŸ¥ ==="
        sudo apt-get update
        sudo apt-get install -y python3-pip
        pip3 install PyYAML
        
        if python3 -c "import yaml; yaml.safe_load(open('$TARGET_FILE'))"; then
          echo "âœ… YAML æ ¼å¼å·²ç»æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤"
          echo "yaml_valid=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ YAML æ ¼å¼å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦ä¿®å¤"
          echo "yaml_valid=false" >> $GITHUB_OUTPUT
        fi

    - name: è·³è¿‡ä¿®å¤ï¼ˆæ ¼å¼å·²æ­£ç¡®ï¼‰
      if: steps.initial-check.outputs.yaml_valid == 'true'
      run: |
        echo "ğŸ‰ YAML æ ¼å¼å·²ç»æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤"
        echo "å·¥ä½œæµæ–‡ä»¶: $TARGET_FILE"
        echo "å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥å·¥ä½œæµ"

    - name: å®‰è£…å¿…è¦å·¥å…·ï¼ˆå¦‚éœ€ä¿®å¤ï¼‰
      if: steps.initial-check.outputs.yaml_valid == 'false'
      run: |
        echo "=== å®‰è£…å¿…è¦å·¥å…· ==="
        pip3 install PyYAML
        echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"

    - name: åˆ›å»ºç®€å•ä¿®å¤è„šæœ¬ï¼ˆå¦‚éœ€ä¿®å¤ï¼‰
      if: steps.initial-check.outputs.yaml_valid == 'false'
      run: |
        echo "=== åˆ›å»ºç®€å•ä¿®å¤è„šæœ¬ ==="
        
        echo "import sys" > simple_fix.py
        echo "import re" >> simple_fix.py
        echo "" >> simple_fix.py
        echo "def fix_yaml_file(file_path):" >> simple_fix.py
        echo "    with open(file_path, 'r', encoding='utf-8') as f:" >> simple_fix.py
        echo "        content = f.read()" >> simple_fix.py
        echo "" >> simple_fix.py
        echo "    fixes = [" >> simple_fix.py
        echo "        (r'(\\w+):(\\S)', r'\\1: \\2')," >> simple_fix.py
        echo "        (r'\\[([^\\]]+)\\]', lambda m: '[' + ' '.join(m.group(1).split(',')) + ']')," >> simple_fix.py
        echo "        (r'^    ', '  ')," >> simple_fix.py
        echo "        (r'\\t', '  ')," >> simple_fix.py
        echo "        (r'\\n\\n\\n+', '\\n\\n')," >> simple_fix.py
        echo "    ]" >> simple_fix.py
        echo "" >> simple_fix.py
        echo "    for pattern, replacement in fixes:" >> simple_fix.py
        echo "        content = re.sub(pattern, replacement, content, flags=re.MULTILINE)" >> simple_fix.py
        echo "" >> simple_fix.py
        echo "    with open(file_path, 'w', encoding='utf-8') as f:" >> simple_fix.py
        echo "        f.write(content)" >> simple_fix.py
        echo "" >> simple_fix.py
        echo "    return content" >> simple_fix.py
        echo "" >> simple_fix.py
        echo "if __name__ == '__main__':" >> simple_fix.py
        echo "    if len(sys.argv) != 2:" >> simple_fix.py
        echo "        print('ç”¨æ³•: python3 simple_fix.py <æ–‡ä»¶è·¯å¾„>')" >> simple_fix.py
        echo "        sys.exit(1)" >> simple_fix.py
        echo "    " >> simple_fix.py
        echo "    file_path = sys.argv[1]" >> simple_fix.py
        echo "    print(f'ä¿®å¤æ–‡ä»¶: {file_path}')" >> simple_fix.py
        echo "    fix_yaml_file(file_path)" >> simple_fix.py
        echo "    print('âœ… åŸºç¡€ä¿®å¤å®Œæˆ')" >> simple_fix.py

    - name: å¤‡ä»½åŸæ–‡ä»¶ï¼ˆå¦‚éœ€ä¿®å¤ï¼‰
      if: steps.initial-check.outputs.yaml_valid == 'false'
      run: |
        echo "=== å¤‡ä»½åŸæ–‡ä»¶ ==="
        cp "$TARGET_FILE" "$TARGET_FILE.backup"
        echo "âœ… æ–‡ä»¶å·²å¤‡ä»½åˆ°: $TARGET_FILE.backup"

    - name: åŸºç¡€ä¿®å¤ï¼ˆå¦‚éœ€ä¿®å¤ï¼‰
      if: steps.initial-check.outputs.yaml_valid == 'false'
      run: |
        echo "=== æ‰§è¡ŒåŸºç¡€ä¿®å¤ ==="
        python3 simple_fix.py "$TARGET_FILE"
        echo "âœ… åŸºç¡€ä¿®å¤å®Œæˆ"

    - name: æ‰‹åŠ¨ä¿®å¤å¸¸è§é”™è¯¯ï¼ˆå¦‚éœ€ä¿®å¤ï¼‰
      if: steps.initial-check.outputs.yaml_valid == 'false'
      run: |
        echo "=== æ‰‹åŠ¨ä¿®å¤å¸¸è§é”™è¯¯ ==="
        
        # ä¿®å¤å¸¸è§çš„ YAML ç»“æ„é—®é¢˜
        sed -i 's/^      - /    - /g' "$TARGET_FILE" || echo "ç¼©è¿›ä¿®å¤å¯èƒ½å¤±è´¥"
        sed -i 's/^        - /      - /g' "$TARGET_FILE" || echo "ç¼©è¿›ä¿®å¤å¯èƒ½å¤±è´¥"
        sed -i 's/:[^ ]/& /g' "$TARGET_FILE" || echo "å†’å·åç©ºæ ¼ä¿®å¤å¯èƒ½å¤±è´¥"
        
        echo "âœ… æ‰‹åŠ¨ä¿®å¤å®Œæˆ"

    - name: éªŒè¯ä¿®å¤ç»“æœï¼ˆå¦‚éœ€ä¿®å¤ï¼‰
      id: validate-fix
      if: steps.initial-check.outputs.yaml_valid == 'false'
      run: |
        echo "=== éªŒè¯ä¿®å¤ç»“æœ ==="
        if python3 -c "import yaml; yaml.safe_load(open('$TARGET_FILE'))"; then
          echo "âœ… YAML æ ¼å¼éªŒè¯é€šè¿‡"
          echo "fix_success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ YAML æ ¼å¼éªŒè¯å¤±è´¥"
          echo "fix_success=false" >> $GITHUB_OUTPUT
          echo "=== å°è¯•è¯Šæ–­é—®é¢˜ ==="
          # æ˜¾ç¤ºå‰å‡ è¡Œä»¥å¸®åŠ©è¯Šæ–­
          echo "æ–‡ä»¶å‰10è¡Œ:"
          head -10 "$TARGET_FILE" || echo "æ— æ³•è¯»å–æ–‡ä»¶"
        fi

    - name: æ˜¾ç¤ºä¿®å¤å·®å¼‚ï¼ˆå¦‚éœ€ä¿®å¤ï¼‰
      if: steps.initial-check.outputs.yaml_valid == 'false' && always()
      run: |
        echo "=== ä¿®å¤å‰åå·®å¼‚ ==="
        if command -v diff &> /dev/null; then
          if diff -u "$TARGET_FILE.backup" "$TARGET_FILE"; then
            echo "âš ï¸  æ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°ä»¥ä¸‹å˜æ›´:"
            diff -u "$TARGET_FILE.backup" "$TARGET_FILE" | head -30 || true
          fi
        else
          echo "âš ï¸  diff å‘½ä»¤ä¸å¯ç”¨"
        fi

    - name: è‡ªåŠ¨æäº¤ä¿®å¤ï¼ˆå¦‚éœ€ä¿®å¤ï¼‰
      if: steps.initial-check.outputs.yaml_valid == 'false' && github.event.inputs.auto_commit == 'true' && steps.validate-fix.outputs.fix_success == 'true'
      run: |
        echo "=== è‡ªåŠ¨æäº¤ä¿®å¤ ==="
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add "$TARGET_FILE"
        if git diff --staged --quiet; then
          echo "âš ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          git commit -m "ğŸ”§ è‡ªåŠ¨ä¿®å¤ YAML æ ¼å¼: ${{ github.event.inputs.workflow_name }}.yml"
          git push
          echo "âœ… ä¿®å¤å·²æäº¤åˆ°ä»“åº“"
        fi

    - name: åˆ›å»ºè¯¦ç»†æŠ¥å‘Š
      if: always()
      run: |
        echo "=== YAML ä¿®å¤è¯¦ç»†æŠ¥å‘Š ==="
        echo "å·¥ä½œæµåç§°: ${{ github.event.inputs.workflow_name }}"
        echo "ç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
        echo "åˆå§‹æ£€æŸ¥: ${{ steps.initial-check.outputs.yaml_valid }}"
        echo "ä¿®å¤çŠ¶æ€: ${{ steps.validate-fix.outputs.fix_success }}"
        echo "è‡ªåŠ¨æäº¤: ${{ github.event.inputs.auto_commit }}"
        
        if [ "${{ steps.initial-check.outputs.yaml_valid }}" = "true" ]; then
          echo "ğŸ‰ YAML æ ¼å¼å·²ç»æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤ï¼"
        elif [ "${{ steps.validate-fix.outputs.fix_success }}" = "true" ]; then
          echo "ğŸ‰ YAML æ ¼å¼ä¿®å¤æˆåŠŸï¼"
        else
          echo "âŒ YAML æ ¼å¼ä¿®å¤å¤±è´¥"
          echo ""
          echo "å»ºè®®æ‰‹åŠ¨æ£€æŸ¥ä»¥ä¸‹å†…å®¹:"
          echo "1. æ£€æŸ¥ç¼©è¿›æ˜¯å¦ä¸€è‡´ï¼ˆä½¿ç”¨2ä¸ªç©ºæ ¼ï¼‰"
          echo "2. ç¡®ä¿æ‰€æœ‰é”®å€¼å¯¹çš„å†’å·åæœ‰ç©ºæ ¼"
          echo "3. æ£€æŸ¥æ•°ç»„æ ¼å¼æ˜¯å¦æ­£ç¡®"
          echo "4. éªŒè¯æ²¡æœ‰ä½¿ç”¨åˆ¶è¡¨ç¬¦"
        fi

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "=== æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
        rm -f simple_fix.py
        if [ -f "$TARGET_FILE.backup" ]; then
          rm "$TARGET_FILE.backup"
          echo "âœ… å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†"
        fi

  manual-fallback:
    runs-on: ubuntu-latest
    needs: yaml-fix
    if: failure() && needs.yaml-fix.result == 'failure'
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æ‰‹åŠ¨ä¿®å¤æŒ‡å¯¼
      run: |
        echo "=== æ‰‹åŠ¨ä¿®å¤æŒ‡å¯¼ ==="
        echo "å·¥ä½œæµæ–‡ä»¶: $TARGET_FILE"
        echo ""
        echo "å¸¸è§ YAML é”™è¯¯å’Œä¿®å¤æ–¹æ³•:"
        echo "1. ç¼©è¿›é—®é¢˜ - ç¡®ä¿ä½¿ç”¨2ä¸ªç©ºæ ¼ï¼Œä¸è¦ä½¿ç”¨åˆ¶è¡¨ç¬¦"
        echo "2. å†’å·åç¼ºå°‘ç©ºæ ¼ - ç¡®ä¿æ‰€æœ‰é”®å€¼å¯¹çš„å†’å·åæœ‰ç©ºæ ¼"
        echo "3. æ•°ç»„æ ¼å¼é”™è¯¯ - ç¡®ä¿æ•°ç»„ä½¿ç”¨æ­£ç¡®çš„æ ¼å¼"
        echo ""
        echo "å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯ YAML:"
        echo "python3 -c \"import yaml; yaml.safe_load(open('$TARGET_FILE'))\""
        echo ""
        echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
        echo "================"
        head -20 "$TARGET_FILE" || echo "æ— æ³•è¯»å–æ–‡ä»¶"
        echo "================"
