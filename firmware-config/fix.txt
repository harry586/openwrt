#ã€build_firmware_main.sh-13ã€‘æ„å»ºç¯å¢ƒåˆå§‹åŒ–å‡½æ•° - ä¿®å¤ç‰ˆ
initialize_build_env() {
    local device_name=$1
    local version_selection=$2
    local config_mode=$3
    local source_repo=${4:-"immortalwrt"}  # æ·»åŠ ç¬¬å››ä¸ªå‚æ•°ï¼Œé»˜è®¤immortalwrt
    
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== ç‰ˆæœ¬é€‰æ‹© ==="
    log "æºä»£ç ä»“åº“: $source_repo"
    
    # æ ¹æ®ä»“åº“é€‰æ‹©ä¸åŒçš„URL - åªä¿ç•™immortalwrtå’Œlede
    case "$source_repo" in
        "immortalwrt")
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            ;;
        "lede")
            SELECTED_REPO_URL="https://github.com/coolsnowwolf/lede.git"
            SELECTED_BRANCH="master"  # LEDEä½¿ç”¨masteråˆ†æ”¯
            ;;
        *)
            SELECTED_REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
            source_repo="immortalwrt"
            ;;
    esac
    
    # æ ¹æ®ç‰ˆæœ¬é€‰æ‹©åˆ†æ”¯ï¼ˆLEDEé™¤å¤–ï¼‰
    if [ "$source_repo" != "lede" ]; then
        if [ "$version_selection" = "23.05" ]; then
            SELECTED_BRANCH="openwrt-23.05"
        else
            SELECTED_BRANCH="openwrt-21.02"
        fi
    fi
    
    # è®¾ç½®SOURCE_REPOç¯å¢ƒå˜é‡
    SOURCE_REPO="$source_repo"
    
    log "âœ… ç‰ˆæœ¬é€‰æ‹©å®Œæˆ: $SELECTED_BRANCH (ä»“åº“: $source_repo)"
    
    log "=== å…‹éš†æºç  ==="
    log "ä»“åº“: $SELECTED_REPO_URL"
    log "åˆ†æ”¯: $SELECTED_BRANCH"
    
    sudo rm -rf ./* ./.git* 2>/dev/null || true
    
    git clone --depth 1 --branch "$SELECTED_BRANCH" "$SELECTED_REPO_URL" . || handle_error "å…‹éš†æºç å¤±è´¥"
    log "âœ… æºç å…‹éš†å®Œæˆ"
    
    # æ£€æŸ¥å…‹éš†çš„æ–‡ä»¶
    local important_source_files=("Makefile" "feeds.conf.default" "rules.mk" "Config.in")
    for file in "${important_source_files[@]}"; do
        if [ -f "$file" ]; then
            log "âœ… æºç æ–‡ä»¶å­˜åœ¨: $file"
        else
            log "âŒ æºç æ–‡ä»¶ç¼ºå¤±: $file"
        fi
    done
    
    log "=== è®¾å¤‡é…ç½® ==="
    DEVICE_NAME="$device_name"
    
    # åŠ è½½è®¾å¤‡æ”¯æŒè„šæœ¬
    if load_device_support; then
        local device_config=$(get_device_config "$device_name")
        TARGET=$(echo $device_config | awk '{print $1}')
        SUBTARGET=$(echo $device_config | awk '{print $2}')
        DEVICE=$(echo $device_config | awk '{print $3}')
        PLATFORM=$(echo $device_config | awk '{print $4}')
        
        local device_desc=$(get_device_description "$device_name")
        log "ğŸ”§ è®¾å¤‡: $device_desc"
        log "ç›®æ ‡: $TARGET"
        log "å­ç›®æ ‡: $SUBTARGET"
        log "è®¾å¤‡: $DEVICE"
        log "å¹³å°: $PLATFORM"
    else
        # é»˜è®¤é…ç½®ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
        case "$device_name" in
            "ac42u"|"acrh17")
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="asus_rt-ac42u"
                PLATFORM="ipq40xx"
                ;;
            "mi_router_4a_gigabit"|"r4ag")
                TARGET="ramips"
                SUBTARGET="mt76x8"
                DEVICE="xiaomi_mi-router-4a-gigabit"
                PLATFORM="ramips"
                ;;
            "mi_router_3g"|"r3g")
                TARGET="ramips"
                SUBTARGET="mt7621"
                DEVICE="xiaomi_mi-router-3g"
                PLATFORM="ramips"
                ;;
            "netgear_3800")
                TARGET="ath79"
                SUBTARGET="generic"
                DEVICE="netgear_wndr3800"
                PLATFORM="ath79"
                ;;
            "cmcc_rax3000m")
                TARGET="mediatek"
                SUBTARGET="mt7981"
                DEVICE="cmcc_rax3000m"
                PLATFORM="mediatek"
                ;;
            *)
                log "âŒ é”™è¯¯: æœªçŸ¥è®¾å¤‡åç§°: $device_name"
                log "ğŸ’¡ æ”¯æŒçš„è®¾å¤‡: acrh17, mi_router_4a_gigabit, mi_router_3g, netgear_3800, cmcc_rax3000m"
                exit 1
                ;;
        esac
        log "ğŸ”§ æ£€æµ‹åˆ°è®¾å¤‡: $device_name"
        log "ç›®æ ‡: $TARGET"
        log "å­ç›®æ ‡: $SUBTARGET"
        log "è®¾å¤‡: $DEVICE"
        log "å¹³å°: $PLATFORM"
    fi
    
    CONFIG_MODE="$config_mode"
    
    # éªŒè¯å…³é”®ç¯å¢ƒå˜é‡ä¸ä¸ºç©º
    validate_environment_variables
    
    save_env
    
    echo "SELECTED_REPO_URL=$SELECTED_REPO_URL" >> $GITHUB_ENV
    echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
    echo "TARGET=$TARGET" >> $GITHUB_ENV
    echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
    echo "DEVICE=$DEVICE" >> $GITHUB_ENV
    echo "CONFIG_MODE=$CONFIG_MODE" >> $GITHUB_ENV
    echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
    echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
    echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
    
    log "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}

#ã€build_firmware_main.sh-æ–°å‡½æ•°ã€‘ç¯å¢ƒå˜é‡éªŒè¯å‡½æ•°
validate_environment_variables() {
    log "=== éªŒè¯ç¯å¢ƒå˜é‡ ==="
    
    local missing_vars=()
    
    # æ£€æŸ¥å…³é”®ç¯å¢ƒå˜é‡æ˜¯å¦ä¸ºç©º
    if [ -z "$TARGET" ]; then
        missing_vars+=("TARGET")
        log "âŒ é”™è¯¯: TARGET ç¯å¢ƒå˜é‡ä¸ºç©º"
    else
        log "âœ… TARGET: $TARGET"
    fi
    
    if [ -z "$SUBTARGET" ]; then
        missing_vars+=("SUBTARGET")
        log "âŒ é”™è¯¯: SUBTARGET ç¯å¢ƒå˜é‡ä¸ºç©º"
    else
        log "âœ… SUBTARGET: $SUBTARGET"
    fi
    
    if [ -z "$DEVICE" ]; then
        missing_vars+=("DEVICE")
        log "âŒ é”™è¯¯: DEVICE ç¯å¢ƒå˜é‡ä¸ºç©º"
    else
        log "âœ… DEVICE: $DEVICE"
    fi
    
    if [ -z "$DEVICE_NAME" ]; then
        missing_vars+=("DEVICE_NAME")
        log "âŒ é”™è¯¯: DEVICE_NAME ç¯å¢ƒå˜é‡ä¸ºç©º"
    else
        log "âœ… DEVICE_NAME: $DEVICE_NAME"
    fi
    
    if [ -z "$SELECTED_BRANCH" ]; then
        missing_vars+=("SELECTED_BRANCH")
        log "âŒ é”™è¯¯: SELECTED_BRANCH ç¯å¢ƒå˜é‡ä¸ºç©º"
    else
        log "âœ… SELECTED_BRANCH: $SELECTED_BRANCH"
    fi
    
    if [ -z "$SOURCE_REPO" ]; then
        missing_vars+=("SOURCE_REPO")
        log "âŒ é”™è¯¯: SOURCE_REPO ç¯å¢ƒå˜é‡ä¸ºç©º"
    else
        log "âœ… SOURCE_REPO: $SOURCE_REPO"
    fi
    
    # å¦‚æœæœ‰ç¼ºå¤±çš„å˜é‡ï¼Œå°è¯•ä¿®å¤
    if [ ${#missing_vars[@]} -gt 0 ]; then
        log "ğŸš¨ å‘ç° ${#missing_vars[@]} ä¸ªç¼ºå¤±çš„ç¯å¢ƒå˜é‡: ${missing_vars[*]}"
        
        # å°è¯•ä»support.shè·å–è®¾å¤‡é…ç½®
        if load_device_support; then
            log "ğŸ”„ å°è¯•ä»è®¾å¤‡æ”¯æŒè„šæœ¬è·å–é…ç½®..."
            local device_config=$(get_device_config "$DEVICE_NAME")
            
            if [ -n "$device_config" ]; then
                if [ -z "$TARGET" ]; then
                    TARGET=$(echo $device_config | awk '{print $1}')
                    log "âœ… ä»support.shè®¾ç½® TARGET: $TARGET"
                fi
                
                if [ -z "$SUBTARGET" ]; then
                    SUBTARGET=$(echo $device_config | awk '{print $2}')
                    log "âœ… ä»support.shè®¾ç½® SUBTARGET: $SUBTARGET"
                fi
                
                if [ -z "$DEVICE" ]; then
                    DEVICE=$(echo $device_config | awk '{print $3}')
                    log "âœ… ä»support.shè®¾ç½® DEVICE: $DEVICE"
                fi
                
                if [ -z "$PLATFORM" ]; then
                    PLATFORM=$(echo $device_config | awk '{print $4}')
                    log "âœ… ä»support.shè®¾ç½® PLATFORM: $PLATFORM"
                fi
            fi
        fi
        
        # é‡æ–°æ£€æŸ¥
        missing_vars=()
        [ -z "$TARGET" ] && missing_vars+=("TARGET")
        [ -z "$SUBTARGET" ] && missing_vars+=("SUBTARGET")
        [ -z "$DEVICE" ] && missing_vars+=("DEVICE")
        [ -z "$DEVICE_NAME" ] && missing_vars+=("DEVICE_NAME")
        [ -z "$SELECTED_BRANCH" ] && missing_vars+=("SELECTED_BRANCH")
        [ -z "$SOURCE_REPO" ] && missing_vars+=("SOURCE_REPO")
        
        if [ ${#missing_vars[@]} -gt 0 ]; then
            log "âŒ é”™è¯¯: æ— æ³•ä¿®å¤ç¯å¢ƒå˜é‡ï¼Œä»ç¼ºå¤±: ${missing_vars[*]}"
            log "ğŸ’¡ å¯èƒ½çš„åŸå› :"
            log "  1. è®¾å¤‡åç§°ä¸æ­£ç¡®: $DEVICE_NAME"
            log "  2. support.sh æ–‡ä»¶ä¸­æ²¡æœ‰è¯¥è®¾å¤‡çš„é…ç½®"
            log "  3. ç¯å¢ƒå˜é‡ä¼ é€’å¤±è´¥"
            exit 1
        fi
    fi
    
    log "âœ… æ‰€æœ‰å…³é”®ç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡"
}

#ã€build_firmware_main.sh-14ã€‘ç¼–è¯‘å™¨ç¯å¢ƒåˆå§‹åŒ–å‡½æ•° - ä¿®å¤ç‰ˆ
initialize_compiler_env() {
    local device_name="$1"
    log "=== åˆå§‹åŒ–ç¼–è¯‘å™¨ç¯å¢ƒï¼ˆä¸‹è½½OpenWrtå®˜æ–¹SDKï¼‰- ä¿®å¤ç‰ˆ ==="
    
    # é¦–å…ˆåŠ è½½ç¯å¢ƒå˜é‡ - ä¿®å¤æ£€æŸ¥é€»è¾‘
    log "ğŸ” æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        log "âœ… ä» $BUILD_DIR/build_env.sh åŠ è½½ç¯å¢ƒå˜é‡"
        
        # éªŒè¯å…³é”®ç¯å¢ƒå˜é‡
        validate_environment_variables
    else
        log "âš ï¸ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨: $BUILD_DIR/build_env.sh"
        log "ğŸ’¡ ç¯å¢ƒæ–‡ä»¶åº”è¯¥åœ¨æ­¥éª¤6.3ä¸­åˆ›å»ºï¼Œä½†æœªæ‰¾åˆ°"
        
        # è®¾ç½®é»˜è®¤å€¼
        if [ -z "$SELECTED_BRANCH" ]; then
            if [ "$version_selection" = "23.05" ]; then
                SELECTED_BRANCH="openwrt-23.05"
            else
                SELECTED_BRANCH="openwrt-21.02"
            fi
            log "âš ï¸ SELECTED_BRANCHæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $SELECTED_BRANCH"
        fi
        
        if [ -z "$SOURCE_REPO" ]; then
            SOURCE_REPO="immortalwrt"
            log "âš ï¸ SOURCE_REPOæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $SOURCE_REPO"
        fi
        
        if [ -z "$TARGET" ] || [ -z "$SUBTARGET" ] || [ -z "$DEVICE" ]; then
            # ä½¿ç”¨è®¾å¤‡æ”¯æŒè„šæœ¬è·å–é…ç½®
            if load_device_support; then
                local device_config=$(get_device_config "$device_name")
                TARGET=$(echo $device_config | awk '{print $1}')
                SUBTARGET=$(echo $device_config | awk '{print $2}')
                DEVICE=$(echo $device_config | awk '{print $3}')
                PLATFORM=$(echo $device_config | awk '{print $4}')
                log "âš ï¸ å¹³å°å˜é‡æœªè®¾ç½®ï¼Œä»è®¾å¤‡æ”¯æŒè„šæœ¬è·å–: TARGET=$TARGET, SUBTARGET=$SUBTARGET, DEVICE=$DEVICE, PLATFORM=$PLATFORM"
            else
                # é»˜è®¤é…ç½®
                case "$device_name" in
                    "ac42u"|"acrh17")
                        TARGET="ipq40xx"
                        SUBTARGET="generic"
                        DEVICE="asus_rt-ac42u"
                        PLATFORM="ipq40xx"
                        ;;
                    "mi_router_4a_gigabit"|"r4ag")
                        TARGET="ramips"
                        SUBTARGET="mt76x8"
                        DEVICE="xiaomi_mi-router-4a-gigabit"
                        PLATFORM="ramips"
                        ;;
                    "mi_router_3g"|"r3g")
                        TARGET="ramips"
                        SUBTARGET="mt7621"
                        DEVICE="xiaomi_mi-router-3g"
                        PLATFORM="ramips"
                        ;;
                    "netgear_3800")
                        TARGET="ath79"
                        SUBTARGET="generic"
                        DEVICE="netgear_wndr3800"
                        PLATFORM="ath79"
                        ;;
                    "cmcc_rax3000m")
                        TARGET="mediatek"
                        SUBTARGET="mt7981"
                        DEVICE="cmcc_rax3000m"
                        PLATFORM="mediatek"
                        ;;
                    *)
                        log "âŒ é”™è¯¯: æœªçŸ¥è®¾å¤‡åç§°: $device_name"
                        log "ğŸ’¡ æ”¯æŒçš„è®¾å¤‡: acrh17, mi_router_4a_gigabit, mi_router_3g, netgear_3800, cmcc_rax3000m"
                        exit 1
                        ;;
                esac
                log "âš ï¸ å¹³å°å˜é‡æœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: TARGET=$TARGET, SUBTARGET=$SUBTARGET, DEVICE=$DEVICE"
            fi
        fi
        
        if [ -z "$CONFIG_MODE" ]; then
            CONFIG_MODE="normal"
            log "âš ï¸ CONFIG_MODEæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $CONFIG_MODE"
        fi
        
        if [ -z "$DEVICE_NAME" ]; then
            DEVICE_NAME="$device_name"
            log "âš ï¸ DEVICE_NAMEæœªè®¾ç½®ï¼Œä½¿ç”¨: $DEVICE_NAME"
        fi
        
        if [ -z "$PLATFORM" ]; then
            PLATFORM="generic"
            log "âš ï¸ PLATFORMæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $PLATFORM"
        fi
        
        # éªŒè¯ç¯å¢ƒå˜é‡
        validate_environment_variables
        
        # ä¿å­˜åˆ°ç¯å¢ƒæ–‡ä»¶
        save_env
        log "âœ… å·²åˆ›å»ºç¯å¢ƒæ–‡ä»¶: $BUILD_DIR/build_env.sh"
    fi
    
    # æ£€æŸ¥ç¯å¢ƒå˜é‡ä¸­çš„COMPILER_DIR
    if [ -n "$COMPILER_DIR" ] && [ -d "$COMPILER_DIR" ]; then
        log "âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
        
        # éªŒè¯ç¼–è¯‘å™¨ç›®å½•æ˜¯å¦çœŸçš„åŒ…å«GCC
        log "ğŸ” éªŒè¯ç¼–è¯‘å™¨ç›®å½•æœ‰æ•ˆæ€§..."
        local gcc_files=$(find "$COMPILER_DIR" -type f -executable \
          -name "*gcc" \
          ! -name "*gcc-ar" \
          ! -name "*gcc-ranlib" \
          ! -name "*gcc-nm" \
          ! -path "*dummy-tools*" \
          ! -path "*scripts*" \
          2>/dev/null | head -3)
        
        if [ -n "$gcc_files" ]; then
            log "âœ… ç¡®è®¤ç¼–è¯‘å™¨ç›®å½•åŒ…å«çœŸæ­£çš„GCC"
            local first_gcc=$(echo "$gcc_files" | head -1)
            log "  ğŸ¯ GCCæ–‡ä»¶: $(basename "$first_gcc")"
            log "  ğŸ”§ GCCç‰ˆæœ¬: $("$first_gcc" --version 2>&1 | head -1)"
            
            # ä¿å­˜åˆ°ç¯å¢ƒæ–‡ä»¶
            save_env
            
            # éªŒè¯ç¼–è¯‘å™¨
            verify_compiler_files
            return 0
        else
            log "âš ï¸ ç¼–è¯‘å™¨ç›®å½•å­˜åœ¨ä½†ä¸åŒ…å«çœŸæ­£çš„GCCï¼Œå°†é‡æ–°ä¸‹è½½SDK"
        fi
    else
        log "ğŸ” COMPILER_DIRæœªè®¾ç½®æˆ–ç›®å½•ä¸å­˜åœ¨ï¼Œå°†ä¸‹è½½OpenWrtå®˜æ–¹SDK"
    fi
    
    # éªŒè¯ç¯å¢ƒå˜é‡
    validate_environment_variables
    
    # æ ¹æ®è®¾å¤‡ç¡®å®šå¹³å°ï¼ˆä½¿ç”¨å·²è®¾ç½®çš„å˜é‡ï¼‰
    log "ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    log "ç›®æ ‡è®¾å¤‡: $DEVICE"
    log "OpenWrtç‰ˆæœ¬: $SELECTED_BRANCH"
    log "å¹³å°ç±»å‹: $PLATFORM"
    log "æºä»£ç ä»“åº“: $SOURCE_REPO"
    
    # ç®€åŒ–ç‰ˆæœ¬å­—ç¬¦ä¸²ï¼ˆä»openwrt-23.05è½¬ä¸º23.05ï¼‰
    local version_for_sdk=""
    if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
        version_for_sdk="23.05"
    elif [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
        version_for_sdk="21.02"
    else
        # å°è¯•æå–ç‰ˆæœ¬å·
        version_for_sdk=$(echo "$SELECTED_BRANCH" | grep -o "[0-9][0-9]\.[0-9][0-9]" || echo "21.02")
        log "âš ï¸ æ— æ³•è¯†åˆ«çš„ç‰ˆæœ¬åˆ†æ”¯ï¼Œå°è¯•ä½¿ç”¨: $version_for_sdk"
    fi
    
    log "ğŸ“Œ SDKç‰ˆæœ¬: $version_for_sdk"
    log "ğŸ“Œ ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    
    # è¯¦ç»†æ˜¾ç¤ºSDKä¸‹è½½ä¿¡æ¯
    log "ğŸ” SDKä¸‹è½½è¯¦ç»†ä¿¡æ¯:"
    log "  è®¾å¤‡: $device_name"
    log "  OpenWrtç‰ˆæœ¬: $SELECTED_BRANCH"
    log "  SDKç‰ˆæœ¬: $version_for_sdk"
    log "  ç›®æ ‡: $TARGET"
    log "  å­ç›®æ ‡: $SUBTARGET"
    log "  å¹³å°: $PLATFORM"
    log "  æºä»£ç ä»“åº“: $SOURCE_REPO"
    
    # ä¸‹è½½OpenWrtå®˜æ–¹SDK
    log "ğŸš€ å¼€å§‹ä¸‹è½½OpenWrtå®˜æ–¹SDK..."
    if download_openwrt_sdk "$TARGET" "$SUBTARGET" "$version_for_sdk"; then
        log "ğŸ‰ OpenWrt SDKä¸‹è½½å¹¶è®¾ç½®æˆåŠŸ"
        log "ğŸ“Œ ç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
        
        # æ˜¾ç¤ºSDKç›®å½•ä¿¡æ¯
        if [ -d "$COMPILER_DIR" ]; then
            log "ğŸ“Š SDKç›®å½•ä¿¡æ¯:"
            log "  ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            log "  æ–‡ä»¶æ•°é‡: $(find "$COMPILER_DIR" -type f 2>/dev/null | wc -l)"
            
            # æŸ¥æ‰¾GCCç¼–è¯‘å™¨ï¼Œæ’é™¤è™šå‡ç¼–è¯‘å™¨
            local gcc_file=$(find "$COMPILER_DIR" -type f -executable \
              -name "*gcc" \
              ! -name "*gcc-ar" \
              ! -name "*gcc-ranlib" \
              ! -name "*gcc-nm" \
              ! -path "*dummy-tools*" \
              ! -path "*scripts*" \
              2>/dev/null | head -1)
            
            if [ -n "$gcc_file" ]; then
                log "âœ… æ‰¾åˆ°SDKä¸­çš„GCCç¼–è¯‘å™¨: $(basename "$gcc_file")"
                log "  ğŸ”§ å®Œæ•´è·¯å¾„: $gcc_file"
                log "  ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: $("$gcc_file" --version 2>&1 | head -1)"
            fi
        fi
        
        # ä¿å­˜åˆ°ç¯å¢ƒæ–‡ä»¶
        save_env
        
        return 0
    else
        log "âŒ OpenWrt SDKä¸‹è½½å¤±è´¥"
        log "ğŸ’¡ å°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨ä½œä¸ºåå¤‡"
        
        # è®¾ç½®ç©ºçš„ç¼–è¯‘å™¨ç›®å½•
        export COMPILER_DIR=""
        save_env
        
        # ä¸è¿”å›é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
        return 0
    fi
}

#ã€firmware-build.yml-21ã€‘å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤23.05 SDKéªŒè¯ï¼‰- å…³é”®ä¿®å¤
      - name: "21. å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤23.05 SDKéªŒè¯ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤23.05 SDKéªŒè¯ï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 21 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: SELECTED_BRANCH=$SELECTED_BRANCH, TARGET=$TARGET, SUBTARGET=$SUBTARGET, DEVICE=$DEVICE, PLATFORM=$PLATFORM, SOURCE_REPO=$SOURCE_REPO"
            
            # éªŒè¯å…³é”®ç¯å¢ƒå˜é‡ä¸ä¸ºç©º
            echo "ğŸ” éªŒè¯å…³é”®ç¯å¢ƒå˜é‡..."
            if [ -z "$TARGET" ] || [ -z "$SUBTARGET" ] || [ -z "$DEVICE" ]; then
              echo "âŒ é”™è¯¯: å…³é”®ç¯å¢ƒå˜é‡ä¸ºç©º"
              echo "  TARGET=$TARGET"
              echo "  SUBTARGET=$SUBTARGET"
              echo "  DEVICE=$DEVICE"
              
              # å°è¯•ä»support.shé‡æ–°è·å–
              echo "ğŸ”„ å°è¯•ä»è®¾å¤‡æ”¯æŒè„šæœ¬é‡æ–°è·å–é…ç½®..."
              SUPPORT_DIR="${{ github.workspace }}/firmware-config"
              if [ -f "$SUPPORT_DIR/support.sh" ]; then
                source "$SUPPORT_DIR/support.sh"
                DEVICE_CONFIG=$(get_device_config "${{ github.event.inputs.device_name }}")
                if [ -n "$DEVICE_CONFIG" ]; then
                  NEW_TARGET=$(echo $DEVICE_CONFIG | awk '{print $1}')
                  NEW_SUBTARGET=$(echo $DEVICE_CONFIG | awk '{print $2}')
                  NEW_DEVICE=$(echo $DEVICE_CONFIG | awk '{print $3}')
                  
                  echo "âœ… ä»support.shè·å–åˆ°æ–°é…ç½®:"
                  echo "  TARGET=$NEW_TARGET (ä¹‹å‰: $TARGET)"
                  echo "  SUBTARGET=$NEW_SUBTARGET (ä¹‹å‰: $SUBTARGET)"
                  echo "  DEVICE=$NEW_DEVICE (ä¹‹å‰: $DEVICE)"
                  
                  # æ›´æ–°ç¯å¢ƒå˜é‡
                  export TARGET="$NEW_TARGET"
                  export SUBTARGET="$NEW_SUBTARGET"
                  export DEVICE="$NEW_DEVICE"
                  
                  # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
                  sed -i "s/^export TARGET=.*/export TARGET=\"$NEW_TARGET\"/" /mnt/openwrt-build/build_env.sh
                  sed -i "s/^export SUBTARGET=.*/export SUBTARGET=\"$NEW_SUBTARGET\"/" /mnt/openwrt-build/build_env.sh
                  sed -i "s/^export DEVICE=.*/export DEVICE=\"$NEW_DEVICE\"/" /mnt/openwrt-build/build_env.sh
                  
                  # é‡æ–°åŠ è½½
                  source /mnt/openwrt-build/build_env.sh
                  echo "âœ… å·²æ›´æ–°ç¯å¢ƒå˜é‡"
                else
                  echo "âŒ æ— æ³•ä»support.shè·å–è®¾å¤‡é…ç½®"
                fi
              else
                echo "âŒ support.sh æ–‡ä»¶ä¸å­˜åœ¨"
              fi
            else
              echo "âœ… å…³é”®ç¯å¢ƒå˜é‡æ­£å¸¸"
            fi
          else
            echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨"
            echo "ğŸ’¡ å°è¯•é‡æ–°åˆ›å»ºç¯å¢ƒæ–‡ä»¶..."
            
            # é‡æ–°åˆ›å»ºç¯å¢ƒæ–‡ä»¶
            "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" initialize_build_env "${{ github.event.inputs.device_name }}" "${{ github.event.inputs.version_selection }}" "${{ github.event.inputs.config_mode }}" "${{ github.event.inputs.source_repo }}"
            
            if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
              source /mnt/openwrt-build/build_env.sh
              echo "âœ… é‡æ–°åˆ›å»ºç¯å¢ƒæ–‡ä»¶æˆåŠŸ"
            else
              echo "âŒ é‡æ–°åˆ›å»ºç¯å¢ƒæ–‡ä»¶å¤±è´¥"
              exit 1
            fi
          fi
          
          echo "ğŸš€ æ‰§è¡Œå‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆå·²ä¿®å¤23.05 SDKéªŒè¯é—®é¢˜ï¼‰..."
          "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" pre_build_error_check
          
          CHECK_EXIT_CODE=$?
          if [ $CHECK_EXIT_CODE -ne 0 ]; then
            echo "âŒ é”™è¯¯: å‰ç½®é”™è¯¯æ£€æŸ¥å¤±è´¥ï¼Œé€€å‡ºä»£ç : $CHECK_EXIT_CODE"
            echo "ğŸ’¡ è¯·æŸ¥çœ‹ä¸Šæ–¹é”™è¯¯ä¿¡æ¯è¿›è¡Œä¿®å¤"
            
            # å¦‚æœæ˜¯23.05ç‰ˆæœ¬ï¼Œæä¾›ç‰¹æ®Šæç¤º
            if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
              echo ""
              echo "ğŸš¨ 23.05ç‰ˆæœ¬SDKéªŒè¯é—®é¢˜ä¿®å¤æç¤º:"
              echo "ğŸ’¡ 23.05 SDKä½¿ç”¨GCC 12.3.0ï¼Œå·²æ”¾å®½éªŒè¯æ¡ä»¶"
              echo "ğŸ“Œ åªéœ€è¦æœ‰GCCç¼–è¯‘å™¨æ–‡ä»¶å³å¯ï¼Œä¸è¦æ±‚ç‰¹å®šç›®å½•ç»“æ„"
              echo "ğŸ”§ å·²æ’é™¤è™šå‡çš„dummy-toolsç¼–è¯‘å™¨æ£€æµ‹"
            fi
            
            exit 1
          fi
          
          echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŸ¢ æ­¥éª¤ 21 å®Œæˆ"

          #ã€build_firmware_main.sh-æ–°å‡½æ•°ã€‘æ„å»ºå‰ç¯å¢ƒéªŒè¯
pre_build_env_validation() {
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ„å»ºå‰ç¯å¢ƒéªŒè¯ï¼ˆä¿®å¤å†…æ ¸ç‰ˆæœ¬é”™è¯¯ï¼‰ ==="
    
    # éªŒè¯å…³é”®ç¯å¢ƒå˜é‡
    validate_environment_variables
    
    # æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†æ­£ç¡®çš„TARGETå’ŒSUBTARGET
    log "ğŸ” æ£€æŸ¥TARGETå’ŒSUBTARGETé…ç½®..."
    
    if [ -z "$TARGET" ] || [ -z "$SUBTARGET" ]; then
        log "âŒ é”™è¯¯: TARGETæˆ–SUBTARGETä¸ºç©º"
        log "  TARGET: $TARGET"
        log "  SUBTARGET: $SUBTARGET"
        
        # å°è¯•ä».configæ–‡ä»¶ä¸­æå–
        if [ -f ".config" ]; then
            log "ğŸ”„ å°è¯•ä».configæ–‡ä»¶ä¸­æå–..."
            local config_target=$(grep "^CONFIG_TARGET_" .config | grep "=y$" | head -1 | sed 's/CONFIG_TARGET_//' | sed 's/=y//')
            if [ -n "$config_target" ]; then
                log "âœ… ä».configæ‰¾åˆ°ç›®æ ‡é…ç½®: $config_target"
                
                # è§£æç›®æ ‡å’Œå­ç›®æ ‡
                if [[ "$config_target" == *_* ]]; then
                    TARGET=$(echo $config_target | cut -d'_' -f1)
                    SUBTARGET=$(echo $config_target | cut -d'_' -f2-)
                    log "âœ… è§£æç»“æœ: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
                    
                    # æ›´æ–°ç¯å¢ƒå˜é‡
                    export TARGET="$TARGET"
                    export SUBTARGET="$SUBTARGET"
                    save_env
                    
                    log "âœ… å·²æ›´æ–°ç¯å¢ƒå˜é‡"
                fi
            fi
        fi
        
        if [ -z "$TARGET" ] || [ -z "$SUBTARGET" ]; then
            log "âŒ æ— æ³•ç¡®å®šTARGETå’ŒSUBTARGETï¼Œæ„å»ºå°†å¤±è´¥"
            exit 1
        fi
    fi
    
    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    log "ğŸ” æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶..."
    local kernel_version_file="$BUILD_DIR/include/kernel-$TARGET-$SUBTARGET"
    
    if [ ! -f "$kernel_version_file" ]; then
        log "âš ï¸ å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $kernel_version_file"
        
        # å°è¯•åˆ›å»ºä¸´æ—¶å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
        log "ğŸ”„ å°è¯•åˆ›å»ºä¸´æ—¶å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶..."
        
        # è·å–é»˜è®¤å†…æ ¸ç‰ˆæœ¬ï¼ˆé€šå¸¸ä¸º5.xï¼‰
        local kernel_version="5.15"
        if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
            kernel_version="5.10"
        elif [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
            kernel_version="5.15"
        fi
        
        # åˆ›å»ºå†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
        mkdir -p "$(dirname "$kernel_version_file")"
        echo "$kernel_version" > "$kernel_version_file"
        echo "# Placeholder kernel version" >> "$kernel_version_file"
        echo "# This file was auto-generated to fix build errors" >> "$kernel_version_file"
        
        log "âœ… å·²åˆ›å»ºä¸´æ—¶å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶: $kernel_version_file"
        log "ğŸ’¡ ä¸´æ—¶å†…æ ¸ç‰ˆæœ¬: $kernel_version"
        
        # ä¹Ÿéœ€è¦åˆ›å»ºå¯¹åº”çš„hashæ–‡ä»¶
        local kernel_hash_file="$BUILD_DIR/include/kernel-$TARGET-$SUBTARGET.hash"
        if [ ! -f "$kernel_hash_file" ]; then
            echo "# Placeholder kernel hash" > "$kernel_hash_file"
            echo "# This file was auto-generated to fix build errors" >> "$kernel_hash_file"
            log "âœ… å·²åˆ›å»ºä¸´æ—¶å†…æ ¸hashæ–‡ä»¶: $kernel_hash_file"
        fi
    else
        log "âœ… å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨: $kernel_version_file"
    fi
    
    # æ£€æŸ¥Makefileä¸­çš„ç›®æ ‡é…ç½®
    log "ğŸ” æ£€æŸ¥ç›®æ ‡ç›®å½•ç»“æ„..."
    local target_dir="$BUILD_DIR/target/linux/$TARGET"
    if [ -d "$target_dir" ]; then
        log "âœ… ç›®æ ‡ç›®å½•å­˜åœ¨: $target_dir"
        
        # æ£€æŸ¥å­ç›®æ ‡ç›®å½•
        if [ -d "$target_dir/$SUBTARGET" ]; then
            log "âœ… å­ç›®æ ‡ç›®å½•å­˜åœ¨: $target_dir/$SUBTARGET"
        else
            log "âš ï¸ å­ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: $target_dir/$SUBTARGET"
            log "ğŸ’¡ å¯ç”¨å­ç›®æ ‡:"
            ls -d "$target_dir"/*/ 2>/dev/null | sed 's|/$||' | while read dir; do
                log "  - $(basename "$dir")"
            done
        fi
    else
        log "âš ï¸ ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: $target_dir"
        log "ğŸ’¡ å¯ç”¨ç›®æ ‡å¹³å°:"
        ls -d "$BUILD_DIR/target/linux"/*/ 2>/dev/null | sed 's|/$||' | while read dir; do
            log "  - $(basename "$dir")"
        done
    fi
    
    log "âœ… æ„å»ºå‰ç¯å¢ƒéªŒè¯å®Œæˆ"
}

#ã€firmware-build.yml-æ–°æ­¥éª¤ã€‘æ„å»ºå‰ç¯å¢ƒéªŒè¯
      - name: "22.5 æ„å»ºå‰ç¯å¢ƒéªŒè¯ï¼ˆé˜²æ­¢å†…æ ¸ç‰ˆæœ¬é”™è¯¯ï¼‰"
        run: |
          echo "=== æ­¥éª¤ 22.5: æ„å»ºå‰ç¯å¢ƒéªŒè¯ï¼ˆé˜²æ­¢å†…æ ¸ç‰ˆæœ¬é”™è¯¯ï¼‰ ==="
          echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e
          trap 'echo "âŒ æ­¥éª¤ 22.5 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
          
          # é¦–å…ˆç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®
          if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡"
            echo "  TARGET=$TARGET"
            echo "  SUBTARGET=$SUBTARGET"
            echo "  DEVICE=$DEVICE"
            echo "  SELECTED_BRANCH=$SELECTED_BRANCH"
            echo "  SOURCE_REPO=$SOURCE_REPO"
          fi
          
          # éªŒè¯å…³é”®ç¯å¢ƒå˜é‡
          echo "ğŸ” éªŒè¯å…³é”®ç¯å¢ƒå˜é‡..."
          if [ -z "$TARGET" ] || [ -z "$SUBTARGET" ]; then
            echo "âŒ é”™è¯¯: TARGETæˆ–SUBTARGETä¸ºç©º"
            
            # å°è¯•ä»è®¾å¤‡æ”¯æŒè„šæœ¬è·å–
            SUPPORT_DIR="${{ github.workspace }}/firmware-config"
            if [ -f "$SUPPORT_DIR/support.sh" ]; then
              source "$SUPPORT_DIR/support.sh"
              DEVICE_CONFIG=$(get_device_config "${{ github.event.inputs.device_name }}")
              if [ -n "$DEVICE_CONFIG" ]; then
                TARGET=$(echo $DEVICE_CONFIG | awk '{print $1}')
                SUBTARGET=$(echo $DEVICE_CONFIG | awk '{print $2}')
                DEVICE=$(echo $DEVICE_CONFIG | awk '{print $3}')
                PLATFORM=$(echo $device_config | awk '{print $4}')
                
                echo "âœ… ä»support.shè·å–é…ç½®:"
                echo "  TARGET=$TARGET"
                echo "  SUBTARGET=$SUBTARGET"
                echo "  DEVICE=$DEVICE"
                echo "  PLATFORM=$PLATFORM"
                
                # æ›´æ–°ç¯å¢ƒå˜é‡
                export TARGET="$TARGET"
                export SUBTARGET="$SUBTARGET"
                export DEVICE="$DEVICE"
                export PLATFORM="$PLATFORM"
                
                # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
                sed -i "s/^export TARGET=.*/export TARGET=\"$TARGET\"/" /mnt/openwrt-build/build_env.sh
                sed -i "s/^export SUBTARGET=.*/export SUBTARGET=\"$SUBTARGET\"/" /mnt/openwrt-build/build_env.sh
                sed -i "s/^export DEVICE=.*/export DEVICE=\"$DEVICE\"/" /mnt/openwrt-build/build_env.sh
                sed -i "s/^export PLATFORM=.*/export PLATFORM=\"$PLATFORM\"/" /mnt/openwrt-build/build_env.sh
                
                echo "âœ… å·²æ›´æ–°ç¯å¢ƒæ–‡ä»¶"
                
                # é‡æ–°åŠ è½½
                source /mnt/openwrt-build/build_env.sh
              else
                echo "âŒ æ— æ³•ä»support.shè·å–è®¾å¤‡é…ç½®"
                exit 1
              fi
            else
              echo "âŒ support.sh æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
          fi
          
          # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
          echo "ğŸ” æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶..."
          KERNEL_FILE="/mnt/openwrt-build/include/kernel-$TARGET-$SUBTARGET"
          
          if [ ! -f "$KERNEL_FILE" ]; then
            echo "âš ï¸ å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $KERNEL_FILE"
            echo "ğŸ”„ åˆ›å»ºä¸´æ—¶å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶..."
            
            mkdir -p "/mnt/openwrt-build/include"
            
            # æ ¹æ®OpenWrtç‰ˆæœ¬é€‰æ‹©å†…æ ¸ç‰ˆæœ¬
            if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
              KERNEL_VERSION="5.10"
            elif [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
              KERNEL_VERSION="5.15"
            else
              KERNEL_VERSION="5.15"
            fi
            
            # åˆ›å»ºå†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
            echo "$KERNEL_VERSION" > "$KERNEL_FILE"
            echo "# Auto-generated kernel version file" >> "$KERNEL_FILE"
            echo "# Target: $TARGET" >> "$KERNEL_FILE"
            echo "# Subtarget: $SUBTARGET" >> "$KERNEL_FILE"
            echo "# Created at: $(date)" >> "$KERNEL_FILE"
            
            echo "âœ… å·²åˆ›å»ºå†…æ ¸ç‰ˆæœ¬æ–‡ä»¶: $KERNEL_FILE"
            echo "ğŸ“‹ å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
            
            # åˆ›å»ºå¯¹åº”çš„hashæ–‡ä»¶
            HASH_FILE="/mnt/openwrt-build/include/kernel-$TARGET-$SUBTARGET.hash"
            echo "# Auto-generated kernel hash file" > "$HASH_FILE"
            echo "# Target: $TARGET" >> "$HASH_FILE"
            echo "# Subtarget: $SUBTARGET" >> "$HASH_FILE"
            echo "# Created at: $(date)" >> "$HASH_FILE"
            echo "sha256sum_placeholder placeholder_hash" >> "$HASH_FILE"
            
            echo "âœ… å·²åˆ›å»ºå†…æ ¸hashæ–‡ä»¶: $HASH_FILE"
          else
            echo "âœ… å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶å·²å­˜åœ¨: $KERNEL_FILE"
            echo "ğŸ“‹ æ–‡ä»¶å†…å®¹:"
            cat "$KERNEL_FILE"
          fi
          
          # æ£€æŸ¥ç›®æ ‡ç›®å½•
          echo "ğŸ” æ£€æŸ¥ç›®æ ‡ç›®å½•ç»“æ„..."
          TARGET_DIR="/mnt/openwrt-build/target/linux/$TARGET"
          if [ -d "$TARGET_DIR" ]; then
            echo "âœ… ç›®æ ‡ç›®å½•å­˜åœ¨: $TARGET_DIR"
            
            # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å­ç›®æ ‡ç›®å½•
            if [ -d "$TARGET_DIR/$SUBTARGET" ]; then
              echo "âœ… å­ç›®æ ‡ç›®å½•å­˜åœ¨: $TARGET_DIR/$SUBTARGET"
            else
              echo "âš ï¸ å­ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: $TARGET_DIR/$SUBTARGET"
              echo "ğŸ’¡ å¯ç”¨å­ç›®æ ‡:"
              ls -d "$TARGET_DIR"/*/ 2>/dev/null | sed 's|/$||' | while read dir; do
                echo "  - $(basename "$dir")"
              done
              
              # å°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„å­ç›®æ ‡
              FIRST_SUBTARGET=$(ls -d "$TARGET_DIR"/*/ 2>/dev/null | head -1 | sed 's|/$||' | xargs basename)
              if [ -n "$FIRST_SUBTARGET" ]; then
                echo "ğŸ”„ å°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„å­ç›®æ ‡: $FIRST_SUBTARGET"
                SUBTARGET="$FIRST_SUBTARGET"
                
                # æ›´æ–°ç¯å¢ƒå˜é‡
                export SUBTARGET="$SUBTARGET"
                sed -i "s/^export SUBTARGET=.*/export SUBTARGET=\"$SUBTARGET\"/" /mnt/openwrt-build/build_env.sh
                
                echo "âœ… å·²æ›´æ–°SUBTARGETä¸º: $SUBTARGET"
              fi
            fi
          else
            echo "âŒ ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: $TARGET_DIR"
            echo "ğŸ’¡ å¯èƒ½çš„åŸå› :"
            echo "  1. ç›®æ ‡å¹³å° '$TARGET' ä¸æ­£ç¡®"
            echo "  2. æºä»£ç ä»“åº“ '$SOURCE_REPO' ä¸æ”¯æŒè¯¥å¹³å°"
            echo "  3. å…‹éš†çš„æºä»£ç ä¸å®Œæ•´"
            
            # æ˜¾ç¤ºå¯ç”¨çš„ç›®æ ‡å¹³å°
            echo "ğŸ“‹ å¯ç”¨çš„ç›®æ ‡å¹³å°:"
            ls -d "/mnt/openwrt-build/target/linux"/*/ 2>/dev/null | sed 's|/$||' | while read dir; do
              echo "  - $(basename "$dir")"
            done
            
            exit 1
          fi
          
          echo "âœ… æ„å»ºå‰ç¯å¢ƒéªŒè¯å®Œæˆ"
          echo "ğŸŸ¢ æ­¥éª¤ 22.5 å®Œæˆ"

          
