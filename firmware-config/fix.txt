#ã€build_firmware_main.sh-18ã€‘æ™ºèƒ½é…ç½®ç”Ÿæˆå‡½æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰
generate_config() {
    local extra_packages=$1
    load_env
    cd $BUILD_DIR || handle_error "è¿›å…¥æ„å»ºç›®å½•å¤±è´¥"
    
    log "=== æ™ºèƒ½é…ç½®ç”Ÿæˆç³»ç»Ÿï¼ˆä¿®å¤ç‰ˆï¼‰==="
    log "è®¾å¤‡: $DEVICE_NAME"
    log "ç‰ˆæœ¬: $SELECTED_BRANCH"
    log "ç›®æ ‡: $TARGET"
    log "å­ç›®æ ‡: $SUBTARGET"
    log "è®¾å¤‡: $DEVICE"
    log "å¹³å°: $PLATFORM"
    log "é…ç½®æ¨¡å¼: $CONFIG_MODE"
    log "æºä»£ç ä»“åº“: $SOURCE_REPO"
    
    # éªŒè¯å…³é”®é…ç½®ä¸ä¸ºç©º
    if [ -z "$TARGET" ] || [ -z "$SUBTARGET" ] || [ -z "$DEVICE" ]; then
        log "âŒ é”™è¯¯: å…³é”®é…ç½®ä¸ºç©º!"
        log "  TARGET: '$TARGET'"
        log "  SUBTARGET: '$SUBTARGET'"
        log "  DEVICE: '$DEVICE'"
        log "ğŸ’¡ è¯·æ£€æŸ¥è®¾å¤‡æ”¯æŒè„šæœ¬æˆ–ç¯å¢ƒå˜é‡"
        return 1
    fi
    
    rm -f .config .config.old
    
    log "ğŸ“‹ å¼€å§‹ç”Ÿæˆé…ç½®æ–‡ä»¶..."
    
    # 1. åŸºæœ¬ç›®æ ‡é…ç½® - ä¿®å¤è¯­æ³•
    echo "# ============================================" > .config
    echo "# ç›®æ ‡å¹³å°é…ç½®" >> .config
    echo "# ============================================" >> .config
    
    # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å˜é‡
    log "ğŸ”§ è®¾ç½®ç›®æ ‡å¹³å°é…ç½®:"
    log "  CONFIG_TARGET_${TARGET}=y"
    log "  CONFIG_TARGET_${TARGET}_${SUBTARGET}=y"
    log "  CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y"
    
    echo "CONFIG_TARGET_${TARGET}=y" >> .config
    echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
    echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
    
    # å¯¹äºImmortalWrt/LEDEï¼Œå¯èƒ½éœ€è¦é¢å¤–çš„æ¶æ„é…ç½®
    if [ "$SOURCE_REPO" = "immortalwrt" ] || [ "$SOURCE_REPO" = "lede" ]; then
        log "ğŸ”§ æ·»åŠ ImmortalWrt/LEDEç‰¹å®šé…ç½®..."
        
        # æ ¹æ®å¹³å°è®¾ç½®æ¶æ„
        case "$PLATFORM" in
            "ipq40xx")
                echo "CONFIG_TARGET_ARCH_PACKAGES=\"arm_cortex-a7_neon-vfpv4\"" >> .config
                echo "CONFIG_TARGET_SUBTARGET=\"${SUBTARGET}\"" >> .config
                echo "CONFIG_TARGET_BOARD=\"${TARGET}\"" >> .config
                ;;
            "mediatek"|"ramips")
                echo "CONFIG_TARGET_ARCH_PACKAGES=\"mipsel_24kc\"" >> .config
                echo "CONFIG_TARGET_SUBTARGET=\"${SUBTARGET}\"" >> .config
                echo "CONFIG_TARGET_BOARD=\"${TARGET}\"" >> .config
                ;;
            "ath79")
                echo "CONFIG_TARGET_ARCH_PACKAGES=\"mips_24kc\"" >> .config
                echo "CONFIG_TARGET_SUBTARGET=\"${SUBTARGET}\"" >> .config
                echo "CONFIG_TARGET_BOARD=\"${TARGET}\"" >> .config
                ;;
        esac
    fi
    
    # 2. æ£€æŸ¥è®¾å¤‡ç‰¹å®šé…ç½®æ–‡ä»¶
    local device_config_file="$SUPPORT_DIR/config/${DEVICE_NAME}.config"
    local has_device_config=false
    
    if [ -f "$device_config_file" ]; then
        log "ğŸ¯ æ‰¾åˆ°è®¾å¤‡ç‰¹å®šé…ç½®: $DEVICE_NAME.config"
        has_device_config=true
        
        # ç»„åˆ1ï¼šè®¾å¤‡é…ç½® + base.config + usb-generic.config
        echo "" >> .config
        echo "# ============================================" >> .config
        echo "# è®¾å¤‡ç‰¹å®šé…ç½®: $DEVICE_NAME" >> .config
        echo "# ============================================" >> .config
        cat "$device_config_file" >> .config
        log "âœ… å·²åŠ è½½è®¾å¤‡ç‰¹å®šé…ç½®"
    else
        log "â„¹ï¸ æœªæ‰¾åˆ°è®¾å¤‡ç‰¹å®šé…ç½®: $DEVICE_NAME.config"
        log "ğŸ’¡ å°†ä½¿ç”¨é€šç”¨é…ç½®ç»„åˆ"
    fi
    
    # 3. åŠ è½½åŸºç¡€é…ç½®æ¨¡æ¿
    log "ğŸ“‹ åŠ è½½åŸºç¡€é…ç½®æ¨¡æ¿..."
    if load_config_template "base"; then
        log "âœ… åŸºç¡€é…ç½®åŠ è½½å®Œæˆ"
    else
        # å¦‚æœæ¨¡æ¿ä¸å­˜åœ¨ï¼Œä½¿ç”¨å†…ç½®é…ç½®
        log "âš ï¸ åŸºç¡€é…ç½®æ¨¡æ¿ä¸å­˜åœ¨ï¼Œä½¿ç”¨å†…ç½®é…ç½®"
        echo "" >> .config
        echo "# ============================================" >> .config
        echo "# åŸºç¡€é…ç½®" >> .config
        echo "# ============================================" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
    fi
    
    # 4. æ ¹æ®æ˜¯å¦æœ‰è®¾å¤‡ç‰¹å®šé…ç½®ï¼Œå†³å®šæ˜¯å¦åŠ è½½normal.config
    if [ "$has_device_config" = false ]; then
        # æ²¡æœ‰è®¾å¤‡ç‰¹å®šé…ç½®æ—¶ï¼ŒåŠ è½½normal.configï¼ˆä»…åŸºç¡€æ¨¡å¼ä¸åŠ è½½ï¼‰
        if [ "$CONFIG_MODE" = "normal" ]; then
            log "ğŸ“‹ åŠ è½½æ­£å¸¸æ¨¡å¼é…ç½®..."
            if load_config_template "normal"; then
                log "âœ… æ­£å¸¸æ¨¡å¼é…ç½®åŠ è½½å®Œæˆ"
            else
                log "âš ï¸ æ­£å¸¸æ¨¡å¼æ¨¡æ¿ä¸å­˜åœ¨"
            fi
        else
            log "ğŸ”§ åŸºç¡€æ¨¡å¼ï¼Œä¸åŠ è½½æ­£å¸¸æ¨¡å¼é…ç½®"
            echo "" >> .config
            echo "# ============================================" >> .config
            echo "# åŸºç¡€æ¨¡å¼é…ç½®" >> .config
            echo "# ============================================" >> .config
            echo "# CONFIG_PACKAGE_luci-app-turboacc is not set" >> .config
            echo "# CONFIG_PACKAGE_kmod-shortcut-fe is not set" >> .config
            echo "# CONFIG_PACKAGE_kmod-fast-classifier is not set" >> .config
        fi
    else
        log "ğŸ’¡ å·²æœ‰è®¾å¤‡ç‰¹å®šé…ç½®ï¼Œä¸åŠ è½½normal.config"
    fi
    
    # 5. åŠ è½½USBé…ç½®
    log "ğŸ”Œ åŠ è½½USBé…ç½®..."
    load_usb_config "$PLATFORM" "$SELECTED_BRANCH"
    
    # 6. å¤„ç†é¢å¤–æ’ä»¶
    if [ -n "$extra_packages" ]; then
        log "ğŸ”§ å¤„ç†é¢å¤–å®‰è£…æ’ä»¶: $extra_packages"
        echo "" >> .config
        echo "# ============================================" >> .config
        echo "# é¢å¤–æ’ä»¶é…ç½®" >> .config
        echo "# ============================================" >> .config
        
        IFS=';' read -ra EXTRA_PKGS <<< "$extra_packages"
        for pkg_cmd in "${EXTRA_PKGS[@]}"; do
            if [ -n "$pkg_cmd" ]; then
                pkg_cmd_clean=$(echo "$pkg_cmd" | xargs)
                if [[ "$pkg_cmd_clean" == +* ]]; then
                    pkg_name="${pkg_cmd_clean:1}"
                    log "å¯ç”¨æ’ä»¶: $pkg_name"
                    echo "CONFIG_PACKAGE_${pkg_name}=y" >> .config
                elif [[ "$pkg_cmd_clean" == -* ]]; then
                    pkg_name="${pkg_cmd_clean:1}"
                    log "ç¦ç”¨æ’ä»¶: $pkg_name"
                    echo "# CONFIG_PACKAGE_${pkg_name} is not set" >> .config
                else
                    log "å¯ç”¨æ’ä»¶: $pkg_cmd_clean"
                    echo "CONFIG_PACKAGE_${pkg_cmd_clean}=y" >> .config
                fi
            fi
        done
    fi
    
    # 7. æ·»åŠ ç‰ˆæœ¬ç‰¹å®šçš„é…ç½®
    echo "" >> .config
    echo "# ============================================" >> .config
    echo "# ç‰ˆæœ¬ç‰¹å®šé…ç½®: $SELECTED_BRANCH" >> .config
    echo "# ============================================" >> .config
    
    if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
        # 21.02ç‰ˆæœ¬çš„è¯­è¨€åŒ…
        if [ "$CONFIG_MODE" = "normal" ]; then
            echo "CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-vsftpd-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-arpbind-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-cpulimit-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-samba4-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-wechatpush-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-sqm-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-hd-idle-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-diskman-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-accesscontrol-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-vlmcsd-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y" >> .config
        fi
    fi
    
    # 8. éªŒè¯é…ç½®
    log "ğŸ” éªŒè¯é…ç½®å®Œæ•´æ€§..."
    if grep -q "CONFIG_TARGET_" .config; then
        log "âœ… ç›®æ ‡å¹³å°é…ç½®å­˜åœ¨"
        
        # æ˜¾ç¤ºç›®æ ‡é…ç½®
        log "ğŸ“‹ ç›®æ ‡é…ç½®è¯¦æƒ…:"
        grep "CONFIG_TARGET_" .config | head -5
        
        # éªŒè¯å…³é”®é…ç½®
        if ! grep -q "^CONFIG_TARGET_${TARGET}=y" .config; then
            log "âŒ é”™è¯¯: ç›®æ ‡å¹³å°é…ç½®ç¼ºå¤±: CONFIG_TARGET_${TARGET}=y"
            echo "CONFIG_TARGET_${TARGET}=y" >> .config
            log "âœ… å·²ä¿®å¤: æ·»åŠ ç›®æ ‡å¹³å°é…ç½®"
        fi
        
        if ! grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" .config; then
            log "âŒ é”™è¯¯: å­ç›®æ ‡é…ç½®ç¼ºå¤±: CONFIG_TARGET_${TARGET}_${SUBTARGET}=y"
            echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
            log "âœ… å·²ä¿®å¤: æ·»åŠ å­ç›®æ ‡é…ç½®"
        fi
        
        if ! grep -q "^CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" .config; then
            log "âŒ é”™è¯¯: è®¾å¤‡é…ç½®ç¼ºå¤±: CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y"
            echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
            log "âœ… å·²ä¿®å¤: æ·»åŠ è®¾å¤‡é…ç½®"
        fi
    else
        log "âŒ é”™è¯¯: ç›®æ ‡å¹³å°é…ç½®å®Œå…¨ç¼ºå¤±!"
        log "ğŸ’¡ é‡æ–°æ·»åŠ ç›®æ ‡å¹³å°é…ç½®..."
        
        # é‡æ–°æ·»åŠ åŸºç¡€é…ç½®
        echo "# ============================================" >> .config
        echo "# ä¿®å¤: ç›®æ ‡å¹³å°é…ç½®" >> .config
        echo "# ============================================" >> .config
        echo "CONFIG_TARGET_${TARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y" >> .config
        
        # æ·»åŠ æ¶æ„é…ç½®
        if [ "$SOURCE_REPO" = "immortalwrt" ] || [ "$SOURCE_REPO" = "lede" ]; then
            case "$PLATFORM" in
                "ipq40xx")
                    echo "CONFIG_TARGET_ARCH_PACKAGES=\"arm_cortex-a7_neon-vfpv4\"" >> .config
                    ;;
                "mediatek"|"ramips")
                    echo "CONFIG_TARGET_ARCH_PACKAGES=\"mipsel_24kc\"" >> .config
                    ;;
                "ath79")
                    echo "CONFIG_TARGET_ARCH_PACKAGES=\"mips_24kc\"" >> .config
                    ;;
            esac
            echo "CONFIG_TARGET_SUBTARGET=\"${SUBTARGET}\"" >> .config
            echo "CONFIG_TARGET_BOARD=\"${TARGET}\"" >> .config
        fi
    fi
    
    # 9. æ˜¾ç¤ºé…ç½®æ‘˜è¦
    log "ğŸ“Š é…ç½®ç”Ÿæˆæ‘˜è¦:"
    log "  ğŸ“ é…ç½®ç»„åˆ:"
    if [ "$has_device_config" = true ]; then
        log "    âœ… è®¾å¤‡ç‰¹å®šé…ç½® + base.config + usb-generic.config"
    else
        if [ "$CONFIG_MODE" = "normal" ]; then
            log "    âœ… base.config + normal.config + usb-generic.config"
        else
            log "    âœ… base.config + åŸºç¡€æ¨¡å¼é…ç½® + usb-generic.config"
        fi
    fi
    
    local config_size=$(ls -lh .config | awk '{print $5}')
    local config_lines=$(wc -l < .config)
    log "  ğŸ“ é…ç½®æ–‡ä»¶å¤§å°: $config_size"
    log "  ğŸ“ é…ç½®è¡Œæ•°: $config_lines"
    
    # éªŒè¯å…³é”®é…ç½®æ•°é‡
    local target_configs=$(grep -c "CONFIG_TARGET_" .config)
    local enabled_pkgs=$(grep -c "^CONFIG_PACKAGE_.*=y$" .config)
    log "  ğŸ¯ ç›®æ ‡é…ç½®æ•°é‡: $target_configs ä¸ª"
    log "  ğŸ“¦ å¯ç”¨æ’ä»¶æ•°é‡: $enabled_pkgs ä¸ª"
    
    # éªŒè¯é…ç½®æœ‰æ•ˆæ€§
    if [ $target_configs -lt 3 ]; then
        log "âš ï¸ è­¦å‘Š: ç›®æ ‡é…ç½®æ•°é‡è¾ƒå°‘ ($target_configs)ï¼Œå¯èƒ½é…ç½®ä¸å®Œæ•´"
        log "ğŸ’¡ ç¡®ä¿è‡³å°‘æœ‰ä»¥ä¸‹é…ç½®:"
        log "  CONFIG_TARGET_${TARGET}=y"
        log "  CONFIG_TARGET_${TARGET}_${SUBTARGET}=y"
        log "  CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${DEVICE}=y"
    fi
    
    log "âœ… æ™ºèƒ½é…ç½®ç”Ÿæˆå®Œæˆ"
}
