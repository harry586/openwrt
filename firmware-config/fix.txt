#ã€firmware-build.yml-23ã€‘
# æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶ï¼ˆæ·»åŠ å˜é‡éªŒè¯ï¼‰
- name: "23. ç¼–è¯‘å›ºä»¶ï¼ˆæ·»åŠ å˜é‡éªŒè¯ï¼‰"
  run: |
    echo "=== æ­¥éª¤ 23: ç¼–è¯‘å›ºä»¶ï¼ˆæ·»åŠ å˜é‡éªŒè¯ï¼‰ ==="
    echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    
    # è®¾ç½®é”™è¯¯å¤„ç†
    set -e
    trap 'echo "âŒ æ­¥éª¤ 23 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    cd /mnt/openwrt-build
    
    # é¦–å…ˆæ£€æŸ¥ç¯å¢ƒå˜é‡
    echo "ğŸ” ç¼–è¯‘å‰ç¯å¢ƒå˜é‡éªŒè¯:"
    if [ -f "build_env.sh" ]; then
      source build_env.sh
      echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡æˆåŠŸ"
    else
      echo "âŒ é”™è¯¯: build_env.sh æ–‡ä»¶ä¸å­˜åœ¨"
      exit 1
    fi
    
    # å…³é”®å˜é‡æ£€æŸ¥
    echo ""
    echo "ğŸ” å…³é”®å˜é‡æ£€æŸ¥:"
    echo "  TARGET: $TARGET"
    echo "  SUBTARGET: $SUBTARGET"
    echo "  DEVICE: $DEVICE"
    echo "  SELECTED_BRANCH: $SELECTED_BRANCH"
    echo "  PLATFORM: $PLATFORM"
    echo "  SOURCE_REPO: $SOURCE_REPO"
    
    if [ -z "$TARGET" ]; then
      echo "âŒ é”™è¯¯: TARGET å˜é‡ä¸ºç©ºï¼Œè¿™æ˜¯å¯¼è‡´ç¼–è¯‘å¤±è´¥çš„æ ¹æœ¬åŸå› "
      echo "ğŸ’¡ å°è¯•ä¿®å¤..."
      
      # å°è¯•ä»support.shè·å–
      SUPPORT_DIR="${{ github.workspace }}/firmware-config"
      if [ -f "$SUPPORT_DIR/support.sh" ]; then
        source "$SUPPORT_DIR/support.sh"
        
        if command -v get_device_config >/dev/null 2>&1; then
          DEVICE_CONFIG=$(get_device_config "${{ github.event.inputs.device_name }}")
          if [ -n "$DEVICE_CONFIG" ]; then
            TARGET=$(echo $DEVICE_CONFIG | awk '{print $1}')
            SUBTARGET=$(echo $DEVICE_CONFIG | awk '{print $2}')
            DEVICE=$(echo $DEVICE_CONFIG | awk '{print $3}')
            PLATFORM=$(echo $DEVICE_CONFIG | awk '{print $4}')
            
            echo "âœ… ä»support.shè·å–é…ç½®:"
            echo "  TARGET: $TARGET"
            echo "  SUBTARGET: $SUBTARGET"
            echo "  DEVICE: $DEVICE"
            echo "  PLATFORM: $PLATFORM"
            
            # æ›´æ–°ç¯å¢ƒå˜é‡
            export TARGET="$TARGET"
            export SUBTARGET="$SUBTARGET"
            export DEVICE="$DEVICE"
            export PLATFORM="$PLATFORM"
            
            # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
            echo "ğŸ”„ æ›´æ–°ç¯å¢ƒæ–‡ä»¶..."
            sed -i "s/export TARGET=\".*\"/export TARGET=\"$TARGET\"/" build_env.sh
            sed -i "s/export SUBTARGET=\".*\"/export SUBTARGET=\"$SUBTARGET\"/" build_env.sh
            sed -i "s/export DEVICE=\".*\"/export DEVICE=\"$DEVICE\"/" build_env.sh
            sed -i "s/export PLATFORM=\".*\"/export PLATFORM=\"$PLATFORM\"/" build_env.sh
            
            # é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡
            source build_env.sh
            echo "âœ… ç¯å¢ƒå˜é‡å·²ä¿®å¤"
          fi
        fi
      fi
    fi
    
    # å¦‚æœTARGETä»ç„¶ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
    if [ -z "$TARGET" ]; then
      echo "âš ï¸ TARGET ä»ç„¶ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼ ipq40xx"
      export TARGET="ipq40xx"
      export SUBTARGET="generic"
      export DEVICE="${{ github.event.inputs.device_name }}"
      export PLATFORM="generic"
      
      # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
      echo "ğŸ”„ è®¾ç½®é»˜è®¤å€¼åˆ°ç¯å¢ƒæ–‡ä»¶..."
      sed -i "s/export TARGET=\".*\"/export TARGET=\"ipq40xx\"/" build_env.sh
      sed -i "s/export SUBTARGET=\".*\"/export SUBTARGET=\"generic\"/" build_env.sh
      sed -i "s/export DEVICE=\".*\"/export DEVICE=\"${{ github.event.inputs.device_name }}\"/" build_env.sh
      sed -i "s/export PLATFORM=\".*\"/export PLATFORM=\"generic\"/" build_env.sh
      
      source build_env.sh
    fi
    
    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
    echo ""
    echo "ğŸ” æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶..."
    KERNEL_VERSION_FILE="include/kernel-${TARGET}.mk"
    if [ -f "$KERNEL_VERSION_FILE" ]; then
      echo "âœ… å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨: $KERNEL_VERSION_FILE"
      
      # æ£€æŸ¥æ–‡ä»¶å†…å®¹
      echo "ğŸ“„ æ–‡ä»¶å†…å®¹æ£€æŸ¥:"
      if grep -q "LINUX_VERSION" "$KERNEL_VERSION_FILE"; then
        LINUX_VERSION=$(grep "LINUX_VERSION" "$KERNEL_VERSION_FILE" | head -1)
        echo "  Linuxç‰ˆæœ¬: $LINUX_VERSION"
      else
        echo "  âš ï¸ æœªæ‰¾åˆ°LINUX_VERSIONå®šä¹‰"
      fi
      
      if grep -q "LINUX_KERNEL_HASH" "$KERNEL_VERSION_FILE"; then
        echo "  âœ… æ‰¾åˆ°LINUX_KERNEL_HASH"
      else
        echo "  âš ï¸ æœªæ‰¾åˆ°LINUX_KERNEL_HASH"
      fi
    else
      echo "âŒ é”™è¯¯: å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $KERNEL_VERSION_FILE"
      echo "ğŸ’¡ å°è¯•æŸ¥æ‰¾å…¶ä»–å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶..."
      
      # æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
      OTHER_KERNEL_FILES=$(find include -name "kernel-*.mk" 2>/dev/null | head -5)
      if [ -n "$OTHER_KERNEL_FILES" ]; then
        echo "ğŸ“ æ‰¾åˆ°çš„å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶:"
        echo "$OTHER_KERNEL_FILES"
        
        # å°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶
        FIRST_KERNEL_FILE=$(echo "$OTHER_KERNEL_FILES" | head -1)
        echo "ğŸ’¡ å°è¯•ä½¿ç”¨: $FIRST_KERNEL_FILE"
        
        # ä»æ–‡ä»¶åä¸­æå–TARGET
        KERNEL_TARGET=$(basename "$FIRST_KERNEL_FILE" .mk | sed 's/kernel-//')
        if [ -n "$KERNEL_TARGET" ] && [ "$KERNEL_TARGET" != "$TARGET" ]; then
          echo "âš ï¸ å½“å‰TARGET ($TARGET) ä¸å†…æ ¸æ–‡ä»¶ä¸åŒ¹é…ï¼Œå°è¯•ä½¿ç”¨ $KERNEL_TARGET"
          export TARGET="$KERNEL_TARGET"
          
          # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
          sed -i "s/export TARGET=\".*\"/export TARGET=\"$KERNEL_TARGET\"/" build_env.sh
          source build_env.sh
          echo "âœ… å·²æ›´æ–°TARGETä¸º: $KERNEL_TARGET"
        fi
      else
        echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶"
        echo "ğŸ’¡ è¿™é€šå¸¸æ„å‘³ç€æºä»£ç ä¸å®Œæ•´æˆ–ç›®æ ‡å¹³å°ä¸æ”¯æŒ"
        exit 1
      fi
    fi
    
    # è·å–ç³»ç»Ÿä¿¡æ¯
    CPU_CORES=$(nproc)
    TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
    
    echo "ğŸ”§ ç³»ç»Ÿä¿¡æ¯:"
    echo "  CPUæ ¸å¿ƒæ•°: $CPU_CORES"
    echo "  å†…å­˜å¤§å°: ${TOTAL_MEM}MB"
    echo "  å¹¶è¡Œä¼˜åŒ–: ${{ env.ENABLE_PARALLEL }}"
    echo "  æºä»£ç ä»“åº“: $SOURCE_REPO"
    
    # æ™ºèƒ½åˆ¤æ–­æœ€ä½³å¹¶è¡Œä»»åŠ¡æ•° - ä¼˜åŒ–ç‰ˆ
    if [ "${{ env.ENABLE_PARALLEL }}" = "true" ]; then
      echo "ğŸ§  æ™ºèƒ½åˆ¤æ–­æœ€ä½³å¹¶è¡Œä»»åŠ¡æ•°..."
      
      # GitHub Actions Runner ä¼˜åŒ–é…ç½®
      if [ $CPU_CORES -ge 4 ]; then
        if [ $TOTAL_MEM -ge 8000 ]; then
          MAKE_JOBS=4
          echo "âœ… æ£€æµ‹åˆ°é«˜æ€§èƒ½Runner (4æ ¸+8GB)"
        else
          MAKE_JOBS=3
          echo "âœ… æ£€æµ‹åˆ°æ ‡å‡†Runner (4æ ¸)"
        fi
      elif [ $CPU_CORES -ge 2 ]; then
        if [ $TOTAL_MEM -ge 7000 ]; then
          MAKE_JOBS=3
          echo "âœ… æ£€æµ‹åˆ°GitHubæ ‡å‡†Runner (2æ ¸7GB)"
        else
          MAKE_JOBS=2
          echo "âœ… æ£€æµ‹åˆ°2æ ¸Runner"
        fi
      else
        MAKE_JOBS=2
        echo "âš ï¸ æ£€æµ‹åˆ°å•æ ¸Runner"
      fi
      
      echo "ğŸ¯ å†³å®šä½¿ç”¨ $MAKE_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡"
    else
      MAKE_JOBS=1
      echo "ğŸ”„ ç¦ç”¨å¹¶è¡Œä¼˜åŒ–ï¼Œä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘"
    fi
    
    echo ""
    echo "ğŸš€ å¼€å§‹ç¼–è¯‘å›ºä»¶"
    echo "ğŸ’¡ ç¼–è¯‘é…ç½®:"
    echo "  - å¹¶è¡Œä»»åŠ¡: $MAKE_JOBS"
    echo "  - è®¾å¤‡: ${{ github.event.inputs.device_name }}"
    echo "  - ç‰ˆæœ¬: ${{ github.event.inputs.version_selection }}"
    echo "  - é…ç½®æ¨¡å¼: ${{ github.event.inputs.config_mode }}"
    echo "  - æºä»£ç ä»“åº“: ${{ github.event.inputs.source_repo }}"
    echo "  - å¹³å°ç±»å‹: $PLATFORM"
    echo "  - ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    echo "  - ç›®æ ‡è®¾å¤‡: $DEVICE"
    echo "  - å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    
    # è®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡
    export FORCE_UNSAFE_CONFIGURE=1
    
    # å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨stdbufé˜²æ­¢stdouté”™è¯¯
    START_TIME=$(date +%s)
    echo "ğŸ”¨ ç¼–è¯‘å‘½ä»¤: make -j$MAKE_JOBS V=s"
    
    # å…ˆå°è¯•è¿è¡Œmake defconfigç¡®ä¿é…ç½®æ­£ç¡®
    echo "ğŸ”§ è¿è¡Œ make defconfig ç¡®ä¿é…ç½®æ­£ç¡®..."
    if make defconfig 2>&1 | tee defconfig.log; then
      echo "âœ… make defconfig æˆåŠŸ"
    else
      echo "âš ï¸ make defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ"
      tail -20 defconfig.log
    fi
    
    # å¼€å§‹æ­£å¼ç¼–è¯‘
    echo "ğŸš€ å¼€å§‹æ­£å¼ç¼–è¯‘..."
    stdbuf -oL -eL time make -j$MAKE_JOBS V=s 2>&1 | tee build.log
    BUILD_EXIT_CODE=${PIPESTATUS[0]}
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
    
    echo ""
    echo "ğŸ“Š ç¼–è¯‘ç»Ÿè®¡:"
    echo "  - æ€»è€—æ—¶: $((DURATION / 60))åˆ†é’Ÿ$((DURATION % 60))ç§’"
    echo "  - é€€å‡ºä»£ç : $BUILD_EXIT_CODE"
    
    if [ $BUILD_EXIT_CODE -eq 0 ]; then
      echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
      
      if [ -d "bin/targets" ]; then
        FIRMWARE_COUNT=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | wc -l)
        echo "âœ… ç”Ÿæˆå›ºä»¶æ–‡ä»¶: $FIRMWARE_COUNT ä¸ª"
        
        # æ˜¾ç¤ºå‰3ä¸ªå›ºä»¶æ–‡ä»¶
        echo "ğŸ“ ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ (å‰3ä¸ª):"
        find bin/targets -type f \( -name "*.bin" -o -name "*.img" \) 2>/dev/null | head -3 | while read file; do
          SIZE=$(ls -lh "$file" 2>/dev/null | awk '{print $5}' || echo "æœªçŸ¥")
          echo "  ğŸ“„ $(basename "$file") ($SIZE)"
        done
      fi
    else
      echo "âŒ é”™è¯¯: ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
      echo "ğŸ” ç¼–è¯‘æ—¥å¿—ä¸­çš„é”™è¯¯æ‘˜è¦:"
      
      # æŸ¥æ‰¾å…·ä½“çš„é”™è¯¯ä¿¡æ¯
      if grep -q "Missing kernel version/hash file" build.log; then
        echo "ğŸš¨ å‘ç°å…³é”®é”™è¯¯: ç¼ºå°‘å†…æ ¸ç‰ˆæœ¬/å“ˆå¸Œæ–‡ä»¶"
        echo "ğŸ’¡ é”™è¯¯è¯¦æƒ…:"
        grep -A5 -B5 "Missing kernel version/hash file" build.log
        
        echo ""
        echo "ğŸ”§ é—®é¢˜åˆ†æ:"
        echo "  è¿™é€šå¸¸æ˜¯å› ä¸º TARGET å˜é‡ä¸æ­£ç¡®å¯¼è‡´çš„"
        echo "  å½“å‰ TARGET: $TARGET"
        echo "  å¯»æ‰¾çš„å†…æ ¸æ–‡ä»¶: include/kernel-${TARGET}.mk"
        
        # æ˜¾ç¤ºå®é™…çš„å†…æ ¸æ–‡ä»¶
        echo "ğŸ“ å®é™…å­˜åœ¨çš„å†…æ ¸æ–‡ä»¶:"
        find include -name "kernel-*.mk" 2>/dev/null
        
        echo ""
        echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆ:"
        echo "  1. æ£€æŸ¥è®¾å¤‡é…ç½®æ˜¯å¦æ­£ç¡®"
        echo "  2. æ£€æŸ¥support.shä¸­çš„get_device_configå‡½æ•°"
        echo "  3. ç¡®ä¿é€‰æ‹©çš„è®¾å¤‡åœ¨æ”¯æŒåˆ—è¡¨ä¸­"
      fi
      
      # æ˜¾ç¤ºå…¶ä»–é”™è¯¯
      grep -i "error\|failed\|stop" build.log | tail -20 || true
      exit $BUILD_EXIT_CODE
    fi
    
    echo "ğŸŸ¢ æ­¥éª¤ 23 å®Œæˆ"


#ã€firmware-build.yml-21ã€‘
# æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤TARGETå˜é‡é—®é¢˜ï¼‰
- name: "21. å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤TARGETå˜é‡é—®é¢˜ï¼‰"
  run: |
    echo "=== æ­¥éª¤ 21: å‰ç½®é”™è¯¯æ£€æŸ¥ï¼ˆä¿®å¤TARGETå˜é‡é—®é¢˜ï¼‰ ==="
    echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    
    # è®¾ç½®é”™è¯¯å¤„ç†
    set -e
    trap 'echo "âŒ æ­¥éª¤ 21 å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"; exit 1' ERR
    
    echo "ğŸ” æ£€æŸ¥å½“å‰ç¯å¢ƒ..."
    if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
      source /mnt/openwrt-build/build_env.sh
      echo "âœ… åŠ è½½ç¯å¢ƒå˜é‡: SELECTED_BRANCH=$SELECTED_BRANCH, TARGET=$TARGET, PLATFORM=$PLATFORM, SOURCE_REPO=$SOURCE_REPO"
    else
      echo "âŒ é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨"
      exit 1
    fi
    
    # å…³é”®æ£€æŸ¥ï¼šç¡®ä¿TARGETå˜é‡ä¸ä¸ºç©º
    echo ""
    echo "ğŸ” å…³é”®å˜é‡æ£€æŸ¥ï¼ˆä¿®å¤TARGETé—®é¢˜ï¼‰:"
    echo "  TARGET: $TARGET"
    echo "  SUBTARGET: $SUBTARGET"
    echo "  DEVICE: $DEVICE"
    echo "  SELECTED_BRANCH: $SELECTED_BRANCH"
    
    if [ -z "$TARGET" ]; then
      echo "âŒ é”™è¯¯: TARGET å˜é‡ä¸ºç©ºï¼Œè¿™æ˜¯å¯¼è‡´ç¼–è¯‘å¤±è´¥çš„æ ¹æœ¬åŸå› "
      echo "ğŸ’¡ å¯èƒ½çš„åŸå› :"
      echo "  1. è®¾å¤‡æ”¯æŒè„šæœ¬æœªæ­£ç¡®é…ç½®"
      echo "  2. ç¯å¢ƒå˜é‡æœªæ­£ç¡®ä¼ é€’"
      echo "  3. support.sh æ–‡ä»¶æœ‰é—®é¢˜"
      
      # å°è¯•ä»support.shè·å–
      SUPPORT_DIR="${{ github.workspace }}/firmware-config"
      if [ -f "$SUPPORT_DIR/support.sh" ]; then
        echo "ğŸ”§ å°è¯•ä»support.shè·å–è®¾å¤‡é…ç½®..."
        source "$SUPPORT_DIR/support.sh"
        
        if command -v get_device_config >/dev/null 2>&1; then
          DEVICE_CONFIG=$(get_device_config "${{ github.event.inputs.device_name }}")
          if [ -n "$DEVICE_CONFIG" ]; then
            TARGET=$(echo $DEVICE_CONFIG | awk '{print $1}')
            SUBTARGET=$(echo $DEVICE_CONFIG | awk '{print $2}')
            DEVICE=$(echo $DEVICE_CONFIG | awk '{print $3}')
            PLATFORM=$(echo $DEVICE_CONFIG | awk '{print $4}')
            
            echo "âœ… ä»support.shè·å–é…ç½®:"
            echo "  TARGET: $TARGET"
            echo "  SUBTARGET: $SUBTARGET"
            echo "  DEVICE: $DEVICE"
            echo "  PLATFORM: $PLATFORM"
            
            # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
            echo "ğŸ”„ æ›´æ–°ç¯å¢ƒæ–‡ä»¶..."
            sed -i "s/export TARGET=\".*\"/export TARGET=\"$TARGET\"/" /mnt/openwrt-build/build_env.sh
            sed -i "s/export SUBTARGET=\".*\"/export SUBTARGET=\"$SUBTARGET\"/" /mnt/openwrt-build/build_env.sh
            sed -i "s/export DEVICE=\".*\"/export DEVICE=\"$DEVICE\"/" /mnt/openwrt-build/build_env.sh
            sed -i "s/export PLATFORM=\".*\"/export PLATFORM=\"$PLATFORM\"/" /mnt/openwrt-build/build_env.sh
            
            # é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡
            source /mnt/openwrt-build/build_env.sh
            echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²æ›´æ–°"
          else
            echo "âŒ æ— æ³•ä»support.shè·å–è®¾å¤‡é…ç½®"
          fi
        else
          echo "âŒ support.shä¸­æ²¡æœ‰get_device_configå‡½æ•°"
        fi
      else
        echo "âŒ support.shæ–‡ä»¶ä¸å­˜åœ¨"
      fi
      
      exit 1
    fi
    
    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    echo ""
    echo "ğŸ” æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶..."
    KERNEL_VERSION_FILE="/mnt/openwrt-build/include/kernel-${TARGET}.mk"
    if [ -f "$KERNEL_VERSION_FILE" ]; then
      echo "âœ… å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨: $KERNEL_VERSION_FILE"
      echo "ğŸ“„ æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
      head -5 "$KERNEL_VERSION_FILE"
    else
      echo "âš ï¸ è­¦å‘Š: å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $KERNEL_VERSION_FILE"
      echo "ğŸ’¡ è¿™å¯èƒ½ä¼šå¯¼è‡´ç¼–è¯‘å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
    fi
    
    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶ä¸­çš„å˜é‡
    if [ -f "$KERNEL_VERSION_FILE" ]; then
      echo "ğŸ” æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶ä¸­çš„å˜é‡..."
      grep -i "kernel\|version\|hash" "$KERNEL_VERSION_FILE" | head -5
    fi
    
    echo "ğŸš€ æ‰§è¡Œå‰ç½®é”™è¯¯æ£€æŸ¥..."
    "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" pre_build_error_check
    
    CHECK_EXIT_CODE=$?
    if [ $CHECK_EXIT_CODE -ne 0 ]; then
      echo "âŒ é”™è¯¯: å‰ç½®é”™è¯¯æ£€æŸ¥å¤±è´¥ï¼Œé€€å‡ºä»£ç : $CHECK_EXIT_CODE"
      echo "ğŸ’¡ è¯·æŸ¥çœ‹ä¸Šæ–¹é”™è¯¯ä¿¡æ¯è¿›è¡Œä¿®å¤"
      
      # å¦‚æœæ˜¯23.05ç‰ˆæœ¬ï¼Œæä¾›ç‰¹æ®Šæç¤º
      if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
        echo ""
        echo "ğŸš¨ 23.05ç‰ˆæœ¬SDKéªŒè¯é—®é¢˜ä¿®å¤æç¤º:"
        echo "ğŸ’¡ 23.05 SDKä½¿ç”¨GCC 12.3.0ï¼Œå·²æ”¾å®½éªŒè¯æ¡ä»¶"
        echo "ğŸ“Œ åªéœ€è¦æœ‰GCCç¼–è¯‘å™¨æ–‡ä»¶å³å¯ï¼Œä¸è¦æ±‚ç‰¹å®šç›®å½•ç»“æ„"
        echo "ğŸ”§ å·²æ’é™¤è™šå‡çš„dummy-toolsç¼–è¯‘å™¨æ£€æµ‹"
      fi
      
      exit 1
    fi
    
    echo "âœ… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "ğŸŸ¢ æ­¥éª¤ 21 å®Œæˆ"

#ã€build_firmware_main.sh-03ã€‘ç¯å¢ƒå˜é‡å‡½æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰
save_env() {
    mkdir -p $BUILD_DIR
    echo "#!/bin/bash" > $ENV_FILE
    
    # ç¡®ä¿å˜é‡ä¸ä¸ºç©º
    SELECTED_REPO_URL="${SELECTED_REPO_URL:-https://github.com/immortalwrt/immortalwrt.git}"
    SELECTED_BRANCH="${SELECTED_BRANCH:-openwrt-21.02}"
    TARGET="${TARGET:-ipq40xx}"
    SUBTARGET="${SUBTARGET:-generic}"
    DEVICE="${DEVICE:-${DEVICE_NAME:-unknown}}"
    CONFIG_MODE="${CONFIG_MODE:-normal}"
    REPO_ROOT="${REPO_ROOT:-$(pwd)}"
    COMPILER_DIR="${COMPILER_DIR:-}"
    DEVICE_NAME="${DEVICE_NAME:-unknown}"
    PLATFORM="${PLATFORM:-${TARGET}}"
    SOURCE_REPO="${SOURCE_REPO:-immortalwrt}"
    
    echo "export SELECTED_REPO_URL=\"${SELECTED_REPO_URL}\"" >> $ENV_FILE
    echo "export SELECTED_BRANCH=\"${SELECTED_BRANCH}\"" >> $ENV_FILE
    echo "export TARGET=\"${TARGET}\"" >> $ENV_FILE
    echo "export SUBTARGET=\"${SUBTARGET}\"" >> $ENV_FILE
    echo "export DEVICE=\"${DEVICE}\"" >> $ENV_FILE
    echo "export CONFIG_MODE=\"${CONFIG_MODE}\"" >> $ENV_FILE
    echo "export REPO_ROOT=\"${REPO_ROOT}\"" >> $ENV_FILE
    echo "export COMPILER_DIR=\"${COMPILER_DIR}\"" >> $ENV_FILE
    echo "export DEVICE_NAME=\"${DEVICE_NAME}\"" >> $ENV_FILE
    echo "export PLATFORM=\"${PLATFORM}\"" >> $ENV_FILE
    echo "export SOURCE_REPO=\"${SOURCE_REPO}\"" >> $ENV_FILE
    
    # ç¡®ä¿ç¯å¢ƒå˜é‡å¯è¢«å…¶ä»–æ­¥éª¤è®¿é—®
    if [ -n "$GITHUB_ENV" ]; then
        # æ¸…é™¤å·²æœ‰çš„å˜é‡
        grep -v "SELECTED_REPO_URL\|SELECTED_BRANCH\|TARGET\|SUBTARGET\|DEVICE\|CONFIG_MODE\|COMPILER_DIR\|DEVICE_NAME\|PLATFORM\|SOURCE_REPO" "$GITHUB_ENV" > "$GITHUB_ENV.tmp" 2>/dev/null || true
        mv "$GITHUB_ENV.tmp" "$GITHUB_ENV" 2>/dev/null || true
        
        # æ·»åŠ æ–°çš„å˜é‡
        echo "SELECTED_REPO_URL=${SELECTED_REPO_URL}" >> $GITHUB_ENV
        echo "SELECTED_BRANCH=${SELECTED_BRANCH}" >> $GITHUB_ENV
        echo "TARGET=${TARGET}" >> $GITHUB_ENV
        echo "SUBTARGET=${SUBTARGET}" >> $GITHUB_ENV
        echo "DEVICE=${DEVICE}" >> $GITHUB_ENV
        echo "CONFIG_MODE=${CONFIG_MODE}" >> $GITHUB_ENV
        echo "COMPILER_DIR=${COMPILER_DIR}" >> $GITHUB_ENV
        echo "DEVICE_NAME=${DEVICE_NAME}" >> $GITHUB_ENV
        echo "PLATFORM=${PLATFORM}" >> $GITHUB_ENV
        echo "SOURCE_REPO=${SOURCE_REPO}" >> $GITHUB_ENV
        
        log "âœ… ç¯å¢ƒå˜é‡å·²å¯¼å‡ºåˆ° GitHub Actions ç¯å¢ƒ: $GITHUB_ENV"
    fi
    
    chmod +x $ENV_FILE
    log "âœ… ç¯å¢ƒå˜é‡å·²ä¿å­˜åˆ°: $ENV_FILE"
    log "ğŸ“‹ ä¿å­˜çš„ç¯å¢ƒå˜é‡:"
    log "  TARGET: $TARGET"
    log "  SUBTARGET: $SUBTARGET"
    log "  DEVICE: $DEVICE"
    log "  PLATFORM: $PLATFORM"
    log "  SELECTED_BRANCH: $SELECTED_BRANCH"
}

#ã€build_firmware_main.sh-14ã€‘ç¼–è¯‘å™¨ç¯å¢ƒåˆå§‹åŒ–å‡½æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰
initialize_compiler_env() {
    local device_name="$1"
    log "=== åˆå§‹åŒ–ç¼–è¯‘å™¨ç¯å¢ƒï¼ˆä¸‹è½½OpenWrtå®˜æ–¹SDKï¼‰- ä¿®å¤ç‰ˆ ==="
    
    # é¦–å…ˆåŠ è½½ç¯å¢ƒå˜é‡ - ä¿®å¤æ£€æŸ¥é€»è¾‘
    log "ğŸ” æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶..."
    if [ -f "$BUILD_DIR/build_env.sh" ]; then
        source "$BUILD_DIR/build_env.sh"
        log "âœ… ä» $BUILD_DIR/build_env.sh åŠ è½½ç¯å¢ƒå˜é‡"
        
        # æ˜¾ç¤ºå…³é”®ç¯å¢ƒå˜é‡
        log "ğŸ“‹ å½“å‰ç¯å¢ƒå˜é‡:"
        log "  SELECTED_BRANCH: $SELECTED_BRANCH"
        log "  TARGET: $TARGET"
        log "  SUBTARGET: $SUBTARGET"
        log "  DEVICE: $DEVICE"
        log "  CONFIG_MODE: $CONFIG_MODE"
        log "  REPO_ROOT: $REPO_ROOT"
        log "  COMPILER_DIR: $COMPILER_DIR"
        log "  DEVICE_NAME: $DEVICE_NAME"
        log "  PLATFORM: $PLATFORM"
        log "  SOURCE_REPO: $SOURCE_REPO"
    else
        log "âŒ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨: $BUILD_DIR/build_env.sh"
        log "ğŸ’¡ ç¯å¢ƒæ–‡ä»¶åº”è¯¥åœ¨æ­¥éª¤6.3ä¸­åˆ›å»ºï¼Œä½†æœªæ‰¾åˆ°"
        
        # æ£€æŸ¥æ˜¯å¦åœ¨Github Actionsç¯å¢ƒä¸­
        if [ -n "$GITHUB_ENV" ] && [ -f "$GITHUB_ENV" ]; then
            log "ğŸ” å°è¯•ä»GitHub Actionsç¯å¢ƒåŠ è½½..."
            # ä»GitHub Actionsç¯å¢ƒæ–‡ä»¶è¯»å–
            if grep -q "TARGET=" "$GITHUB_ENV"; then
                TARGET=$(grep "^TARGET=" "$GITHUB_ENV" | cut -d'=' -f2)
                log "âœ… ä»GITHUB_ENVåŠ è½½ TARGET: $TARGET"
            fi
            
            if grep -q "SUBTARGET=" "$GITHUB_ENV"; then
                SUBTARGET=$(grep "^SUBTARGET=" "$GITHUB_ENV" | cut -d'=' -f2)
                log "âœ… ä»GITHUB_ENVåŠ è½½ SUBTARGET: $SUBTARGET"
            fi
            
            if grep -q "DEVICE=" "$GITHUB_ENV"; then
                DEVICE=$(grep "^DEVICE=" "$GITHUB_ENV" | cut -d'=' -f2)
                log "âœ… ä»GITHUB_ENVåŠ è½½ DEVICE: $DEVICE"
            fi
        fi
        
        # è®¾ç½®é»˜è®¤å€¼
        if [ -z "$SELECTED_BRANCH" ]; then
            SELECTED_BRANCH="openwrt-21.02"
            log "âš ï¸ SELECTED_BRANCHæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $SELECTED_BRANCH"
        fi
        
        if [ -z "$SOURCE_REPO" ]; then
            SOURCE_REPO="immortalwrt"
            log "âš ï¸ SOURCE_REPOæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $SOURCE_REPO"
        fi
        
        if [ -z "$TARGET" ]; then
            # ä½¿ç”¨è®¾å¤‡æ”¯æŒè„šæœ¬è·å–é…ç½®
            if load_device_support; then
                local device_config=$(get_device_config "$device_name")
                if [ -n "$device_config" ]; then
                    TARGET=$(echo $device_config | awk '{print $1}')
                    SUBTARGET=$(echo $device_config | awk '{print $2}')
                    DEVICE=$(echo $device_config | awk '{print $3}')
                    PLATFORM=$(echo $device_config | awk '{print $4}')
                    log "âœ… ä»è®¾å¤‡æ”¯æŒè„šæœ¬è·å–: TARGET=$TARGET, SUBTARGET=$SUBTARGET, DEVICE=$DEVICE, PLATFORM=$PLATFORM"
                else
                    log "âŒ æ— æ³•è·å–è®¾å¤‡é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼"
                    TARGET="ipq40xx"
                    SUBTARGET="generic"
                    DEVICE="$device_name"
                    PLATFORM="generic"
                fi
            else
                # é»˜è®¤é…ç½®
                TARGET="ipq40xx"
                SUBTARGET="generic"
                DEVICE="$device_name"
                PLATFORM="generic"
                log "âš ï¸ å¹³å°å˜é‡æœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: TARGET=$TARGET, SUBTARGET=$SUBTARGET, DEVICE=$DEVICE"
            fi
        fi
        
        if [ -z "$CONFIG_MODE" ]; then
            CONFIG_MODE="normal"
            log "âš ï¸ CONFIG_MODEæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: $CONFIG_MODE"
        fi
        
        if [ -z "$DEVICE_NAME" ]; then
            DEVICE_NAME="$device_name"
            log "âš ï¸ DEVICE_NAMEæœªè®¾ç½®ï¼Œä½¿ç”¨: $DEVICE_NAME"
        fi
        
        if [ -z "$PLATFORM" ]; then
            PLATFORM="$TARGET"
            log "âš ï¸ PLATFORMæœªè®¾ç½®ï¼Œä½¿ç”¨: $PLATFORM"
        fi
        
        # ä¿å­˜åˆ°ç¯å¢ƒæ–‡ä»¶
        save_env
        log "âœ… å·²åˆ›å»ºç¯å¢ƒæ–‡ä»¶: $BUILD_DIR/build_env.sh"
    fi
    
    # å…³é”®æ£€æŸ¥ï¼šç¡®ä¿æ‰€æœ‰å¿…è¦çš„å˜é‡éƒ½ä¸ä¸ºç©º
    log "ğŸ” å…³é”®å˜é‡å®Œæ•´æ€§æ£€æŸ¥:"
    
    local missing_vars=()
    
    if [ -z "$TARGET" ]; then
        missing_vars+=("TARGET")
        log "âŒ TARGET ä¸ºç©º"
    else
        log "âœ… TARGET: $TARGET"
    fi
    
    if [ -z "$SUBTARGET" ]; then
        missing_vars+=("SUBTARGET")
        log "âŒ SUBTARGET ä¸ºç©º"
    else
        log "âœ… SUBTARGET: $SUBTARGET"
    fi
    
    if [ -z "$DEVICE" ]; then
        missing_vars+=("DEVICE")
        log "âŒ DEVICE ä¸ºç©º"
    else
        log "âœ… DEVICE: $DEVICE"
    fi
    
    if [ -z "$SELECTED_BRANCH" ]; then
        missing_vars+=("SELECTED_BRANCH")
        log "âŒ SELECTED_BRANCH ä¸ºç©º"
    else
        log "âœ… SELECTED_BRANCH: $SELECTED_BRANCH"
    fi
    
    # å¦‚æœæœ‰ç¼ºå¤±çš„å˜é‡ï¼Œå°è¯•ä¿®å¤
    if [ ${#missing_vars[@]} -gt 0 ]; then
        log "âš ï¸ å‘ç°ç¼ºå¤±çš„å˜é‡: ${missing_vars[*]}"
        
        # å°è¯•ä»è®¾å¤‡æ”¯æŒè„šæœ¬è·å–
        if load_device_support; then
            local device_config=$(get_device_config "$device_name")
            if [ -n "$device_config" ]; then
                if [ -z "$TARGET" ]; then
                    TARGET=$(echo $device_config | awk '{print $1}')
                    log "âœ… ä»è®¾å¤‡æ”¯æŒè®¾ç½® TARGET: $TARGET"
                fi
                
                if [ -z "$SUBTARGET" ]; then
                    SUBTARGET=$(echo $device_config | awk '{print $2}')
                    log "âœ… ä»è®¾å¤‡æ”¯æŒè®¾ç½® SUBTARGET: $SUBTARGET"
                fi
                
                if [ -z "$DEVICE" ]; then
                    DEVICE=$(echo $device_config | awk '{print $3}')
                    log "âœ… ä»è®¾å¤‡æ”¯æŒè®¾ç½® DEVICE: $DEVICE"
                fi
                
                if [ -z "$PLATFORM" ]; then
                    PLATFORM=$(echo $device_config | awk '{print $4}')
                    log "âœ… ä»è®¾å¤‡æ”¯æŒè®¾ç½® PLATFORM: $PLATFORM"
                fi
            fi
        fi
        
        # å¦‚æœä»ç„¶ç¼ºå¤±ï¼Œè®¾ç½®é»˜è®¤å€¼
        if [ -z "$TARGET" ]; then
            TARGET="ipq40xx"
            log "âš ï¸ TARGET ä»ç„¶ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼: $TARGET"
        fi
        
        if [ -z "$SUBTARGET" ]; then
            SUBTARGET="generic"
            log "âš ï¸ SUBTARGET ä»ç„¶ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼: $SUBTARGET"
        fi
        
        if [ -z "$DEVICE" ]; then
            DEVICE="$device_name"
            log "âš ï¸ DEVICE ä»ç„¶ä¸ºç©ºï¼Œä½¿ç”¨è®¾å¤‡åç§°: $DEVICE"
        fi
        
        if [ -z "$SELECTED_BRANCH" ]; then
            SELECTED_BRANCH="openwrt-21.02"
            log "âš ï¸ SELECTED_BRANCH ä»ç„¶ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼: $SELECTED_BRANCH"
        fi
        
        if [ -z "$PLATFORM" ]; then
            PLATFORM="$TARGET"
            log "âš ï¸ PLATFORM ä»ç„¶ä¸ºç©ºï¼Œä½¿ç”¨ TARGET ä½œä¸º PLATFORM: $PLATFORM"
        fi
        
        # é‡æ–°ä¿å­˜ç¯å¢ƒå˜é‡
        save_env
        log "âœ… å·²ä¿®å¤å¹¶ä¿å­˜ç¯å¢ƒå˜é‡"
    fi
    
    # æ ¹æ®è®¾å¤‡ç¡®å®šå¹³å°ï¼ˆä½¿ç”¨å·²è®¾ç½®çš„å˜é‡ï¼‰
    log "ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    log "ç›®æ ‡è®¾å¤‡: $DEVICE"
    log "OpenWrtç‰ˆæœ¬: $SELECTED_BRANCH"
    log "å¹³å°ç±»å‹: $PLATFORM"
    log "æºä»£ç ä»“åº“: $SOURCE_REPO"
    
    # ç®€åŒ–ç‰ˆæœ¬å­—ç¬¦ä¸²ï¼ˆä»openwrt-23.05è½¬ä¸º23.05ï¼‰
    local version_for_sdk=""
    if [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
        version_for_sdk="23.05"
    elif [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
        version_for_sdk="21.02"
    else
        # å°è¯•æå–ç‰ˆæœ¬å·
        version_for_sdk=$(echo "$SELECTED_BRANCH" | grep -o "[0-9][0-9]\.[0-9][0-9]" || echo "21.02")
        log "âš ï¸ æ— æ³•è¯†åˆ«çš„ç‰ˆæœ¬åˆ†æ”¯ï¼Œå°è¯•ä½¿ç”¨: $version_for_sdk"
    fi
    
    log "ğŸ“Œ SDKç‰ˆæœ¬: $version_for_sdk"
    log "ğŸ“Œ ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
    
    # è¯¦ç»†æ˜¾ç¤ºSDKä¸‹è½½ä¿¡æ¯
    log "ğŸ” SDKä¸‹è½½è¯¦ç»†ä¿¡æ¯:"
    log "  è®¾å¤‡: $device_name"
    log "  OpenWrtç‰ˆæœ¬: $SELECTED_BRANCH"
    log "  SDKç‰ˆæœ¬: $version_for_sdk"
    log "  ç›®æ ‡: $TARGET"
    log "  å­ç›®æ ‡: $SUBTARGET"
    log "  å¹³å°: $PLATFORM"
    log "  æºä»£ç ä»“åº“: $SOURCE_REPO"
    
    # å…³é”®æ£€æŸ¥ï¼šç¡®ä¿TARGETå’ŒSUBTARGETä¸ä¸ºç©º
    if [ -z "$TARGET" ] || [ -z "$SUBTARGET" ]; then
        log "âŒ é”™è¯¯: TARGET æˆ– SUBTARGET ä¸ºç©ºï¼Œæ— æ³•ä¸‹è½½SDK"
        log "ğŸ’¡ å½“å‰å€¼: TARGET=$TARGET, SUBTARGET=$SUBTARGET"
        log "ğŸ’¡ å°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨ä½œä¸ºåå¤‡"
        
        # è®¾ç½®ç©ºçš„ç¼–è¯‘å™¨ç›®å½•
        export COMPILER_DIR=""
        save_env
        
        return 0
    fi
    
    # ä¸‹è½½OpenWrtå®˜æ–¹SDK
    log "ğŸš€ å¼€å§‹ä¸‹è½½OpenWrtå®˜æ–¹SDK..."
    if download_openwrt_sdk "$TARGET" "$SUBTARGET" "$version_for_sdk"; then
        log "ğŸ‰ OpenWrt SDKä¸‹è½½å¹¶è®¾ç½®æˆåŠŸ"
        log "ğŸ“Œ ç¼–è¯‘å™¨ç›®å½•: $COMPILER_DIR"
        
        # æ˜¾ç¤ºSDKç›®å½•ä¿¡æ¯
        if [ -d "$COMPILER_DIR" ]; then
            log "ğŸ“Š SDKç›®å½•ä¿¡æ¯:"
            log "  ç›®å½•å¤§å°: $(du -sh "$COMPILER_DIR" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
            log "  æ–‡ä»¶æ•°é‡: $(find "$COMPILER_DIR" -type f 2>/dev/null | wc -l)"
            
            # æŸ¥æ‰¾GCCç¼–è¯‘å™¨ï¼Œæ’é™¤è™šå‡ç¼–è¯‘å™¨
            local gcc_file=$(find "$COMPILER_DIR" -type f -executable \
              -name "*gcc" \
              ! -name "*gcc-ar" \
              ! -name "*gcc-ranlib" \
              ! -name "*gcc-nm" \
              ! -path "*dummy-tools*" \
              ! -path "*scripts*" \
              2>/dev/null | head -1)
            
            if [ -n "$gcc_file" ]; then
                log "âœ… æ‰¾åˆ°SDKä¸­çš„GCCç¼–è¯‘å™¨: $(basename "$gcc_file")"
                log "  ğŸ”§ å®Œæ•´è·¯å¾„: $gcc_file"
                log "  ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: $("$gcc_file" --version 2>&1 | head -1)"
            fi
        fi
        
        # ä¿å­˜åˆ°ç¯å¢ƒæ–‡ä»¶
        save_env
        
        return 0
    else
        log "âŒ OpenWrt SDKä¸‹è½½å¤±è´¥"
        log "ğŸ’¡ å°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨ä½œä¸ºåå¤‡"
        
        # è®¾ç½®ç©ºçš„ç¼–è¯‘å™¨ç›®å½•
        export COMPILER_DIR=""
        save_env
        
        # ä¸è¿”å›é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
        return 0
    fi
}

#ã€firmware-build.yml-07ã€‘
# æ­¥éª¤ 7: ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆä¿®å¤ç‰ˆï¼‰- ç¯å¢ƒå˜é‡ä¿®å¤
- name: "7. ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆç¯å¢ƒå˜é‡ä¿®å¤ç‰ˆï¼‰"
  run: |
    echo "=== æ­¥éª¤ 7: ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆç¯å¢ƒå˜é‡ä¿®å¤ç‰ˆï¼‰ ==="
    echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    
    # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼ŒSDKä¸‹è½½å¤±è´¥å¯ä»¥ç»§ç»­
    trap 'echo "âš ï¸ SDKä¸‹è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨è‡ªåŠ¨æ„å»ºç¼–è¯‘å™¨ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
    
    echo "ğŸš€ å¼€å§‹ä¸‹è½½OpenWrtå®˜æ–¹SDKå·¥å…·é“¾..."
    
    # å…ˆæ£€æŸ¥ç¯å¢ƒæ–‡ä»¶æ˜¯å¦å·²ç»å­˜åœ¨
    echo "ğŸ” æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶..."
    if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
      echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²å­˜åœ¨ï¼ˆç”±æ­¥éª¤6.4åˆ›å»ºï¼‰"
      echo "ğŸ“Š ç¯å¢ƒæ–‡ä»¶å†…å®¹æ‘˜è¦:"
      head -20 /mnt/openwrt-build/build_env.sh
      
      # åŠ è½½ç°æœ‰ç¯å¢ƒå˜é‡
      source /mnt/openwrt-build/build_env.sh
      echo "âœ… ä»ç°æœ‰ç¯å¢ƒæ–‡ä»¶åŠ è½½å˜é‡:"
      echo "  SELECTED_BRANCH: $SELECTED_BRANCH"
      echo "  TARGET: $TARGET"
      echo "  SUBTARGET: $SUBTARGET"
      echo "  DEVICE: $DEVICE"
      echo "  CONFIG_MODE: $CONFIG_MODE"
      echo "  REPO_ROOT: $REPO_ROOT"
      echo "  COMPILER_DIR: $COMPILER_DIR"
      echo "  DEVICE_NAME: $DEVICE_NAME"
      echo "  PLATFORM: $PLATFORM"
      echo "  SOURCE_REPO: $SOURCE_REPO"
      echo ""
      
      echo "ğŸ’¡ ä½¿ç”¨æ­¥éª¤6.4å·²è®¾ç½®çš„ç¯å¢ƒå˜é‡è¿›è¡ŒSDKä¸‹è½½"
    else
      echo "âš ï¸ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯æ­¥éª¤6.4å¤±è´¥"
      echo "ğŸ“ é‡æ–°åˆ›å»ºç¯å¢ƒå˜é‡..."
      
      # ä½¿ç”¨è®¾å¤‡æ”¯æŒç³»ç»Ÿè·å–é…ç½®
      SUPPORT_DIR="${{ github.workspace }}/firmware-config"
      if [ -f "$SUPPORT_DIR/support.sh" ]; then
        source "$SUPPORT_DIR/support.sh"
        
        # è·å–è®¾å¤‡é…ç½®
        if command -v get_device_config >/dev/null 2>&1; then
          DEVICE_CONFIG=$(get_device_config "${{ github.event.inputs.device_name }}")
          if [ -n "$DEVICE_CONFIG" ]; then
            TARGET=$(echo $DEVICE_CONFIG | awk '{print $1}')
            SUBTARGET=$(echo $DEVICE_CONFIG | awk '{print $2}')
            DEVICE=$(echo $DEVICE_CONFIG | awk '{print $3}')
            PLATFORM=$(echo $DEVICE_CONFIG | awk '{print $4}')
            echo "âœ… ä»è®¾å¤‡æ”¯æŒç³»ç»Ÿè·å–é…ç½®: TARGET=$TARGET, SUBTARGET=$SUBTARGET, DEVICE=$DEVICE, PLATFORM=$PLATFORM"
          else
            echo "âŒ é”™è¯¯: æ— æ³•è·å–è®¾å¤‡é…ç½®"
            exit 1
          fi
        else
          echo "âŒ é”™è¯¯: get_device_config å‡½æ•°ä¸å­˜åœ¨"
          exit 1
        fi
      else
        echo "âŒ é”™è¯¯: è®¾å¤‡æ”¯æŒè„šæœ¬ä¸å­˜åœ¨"
        exit 1
      fi
      
      # è®¾ç½®ç‰ˆæœ¬åˆ†æ”¯
      if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
        SELECTED_BRANCH="openwrt-23.05"
      else
        SELECTED_BRANCH="openwrt-21.02"
      fi
      
      # è®¾ç½®æºä»£ç ä»“åº“
      SOURCE_REPO="${{ github.event.inputs.source_repo }}"
      
      # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
      ENV_FILE="/mnt/openwrt-build/build_env.sh"
      echo "#!/bin/bash" > "$ENV_FILE"
      echo "export SELECTED_REPO_URL=\"https://github.com/immortalwrt/immortalwrt.git\"" >> "$ENV_FILE"
      echo "export SELECTED_BRANCH=\"$SELECTED_BRANCH\"" >> "$ENV_FILE"
      echo "export TARGET=\"$TARGET\"" >> "$ENV_FILE"
      echo "export SUBTARGET=\"$SUBTARGET\"" >> "$ENV_FILE"
      echo "export DEVICE=\"$DEVICE\"" >> "$ENV_FILE"
      echo "export CONFIG_MODE=\"${{ github.event.inputs.config_mode }}\"" >> "$ENV_FILE"
      echo "export REPO_ROOT=\"${{ github.workspace }}\"" >> "$ENV_FILE"
      echo "export COMPILER_DIR=\"\"" >> "$ENV_FILE"
      echo "export DEVICE_NAME=\"${{ github.event.inputs.device_name }}\"" >> "$ENV_FILE"
      echo "export PLATFORM=\"$PLATFORM\"" >> "$ENV_FILE"
      echo "export SOURCE_REPO=\"$SOURCE_REPO\"" >> "$ENV_FILE"
      
      # å¦‚æœè®¾ç½®äº†GITHUB_ENVï¼Œä¹Ÿå¯¼å‡ºåˆ°GitHub Actionsç¯å¢ƒ
      if [ -n "$GITHUB_ENV" ]; then
        echo "TARGET=$TARGET" >> $GITHUB_ENV
        echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
        echo "DEVICE=$DEVICE" >> $GITHUB_ENV
        echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
        echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
      fi
      
      chmod +x "$ENV_FILE"
      echo "âœ… å·²åˆ›å»ºç¯å¢ƒæ–‡ä»¶"
      
      # é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡
      source "$ENV_FILE"
    fi
    
    # å…³é”®æ£€æŸ¥ï¼šç¡®ä¿TARGETå˜é‡ä¸ä¸ºç©º
    echo ""
    echo "ğŸ” å…³é”®å˜é‡æ£€æŸ¥:"
    echo "  TARGET: $TARGET"
    echo "  SUBTARGET: $SUBTARGET"
    echo "  DEVICE: $DEVICE"
    echo "  PLATFORM: $PLATFORM"
    
    if [ -z "$TARGET" ]; then
      echo "âŒ é”™è¯¯: TARGET å˜é‡ä¸ºç©ºï¼Œæ— æ³•ç»§ç»­"
      exit 1
    fi
    
    if [ -z "$SUBTARGET" ]; then
      echo "âš ï¸ è­¦å‘Š: SUBTARGET å˜é‡ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼ 'generic'"
      export SUBTARGET="generic"
    fi
    
    if [ -z "$DEVICE" ]; then
      echo "âš ï¸ è­¦å‘Š: DEVICE å˜é‡ä¸ºç©ºï¼Œä½¿ç”¨è®¾å¤‡åç§°ä½œä¸ºé»˜è®¤å€¼"
      export DEVICE="${{ github.event.inputs.device_name }}"
    fi
    
    if [ -z "$PLATFORM" ]; then
      echo "âš ï¸ è­¦å‘Š: PLATFORM å˜é‡ä¸ºç©ºï¼Œä½¿ç”¨TARGETä½œä¸ºé»˜è®¤å€¼"
      export PLATFORM="$TARGET"
    fi
    
    # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
    save_env() {
      local env_file="$1"
      echo "#!/bin/bash" > "$env_file"
      echo "export SELECTED_REPO_URL=\"$SELECTED_REPO_URL\"" >> "$env_file"
      echo "export SELECTED_BRANCH=\"$SELECTED_BRANCH\"" >> "$env_file"
      echo "export TARGET=\"$TARGET\"" >> "$env_file"
      echo "export SUBTARGET=\"$SUBTARGET\"" >> "$env_file"
      echo "export DEVICE=\"$DEVICE\"" >> "$env_file"
      echo "export CONFIG_MODE=\"$CONFIG_MODE\"" >> "$env_file"
      echo "export REPO_ROOT=\"$REPO_ROOT\"" >> "$env_file"
      echo "export COMPILER_DIR=\"$COMPILER_DIR\"" >> "$env_file"
      echo "export DEVICE_NAME=\"$DEVICE_NAME\"" >> "$env_file"
      echo "export PLATFORM=\"$PLATFORM\"" >> "$env_file"
      echo "export SOURCE_REPO=\"$SOURCE_REPO\"" >> "$env_file"
      chmod +x "$env_file"
    }
    
    # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
    save_env "/mnt/openwrt-build/build_env.sh"
    echo "âœ… æ›´æ–°ç¯å¢ƒæ–‡ä»¶å®Œæˆ"
    
    # æ‰§è¡ŒSDKä¸‹è½½ï¼Œå…è®¸å¤±è´¥
    echo "ğŸ”„ å¼€å§‹æ‰§è¡ŒSDKä¸‹è½½..."
    if "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" initialize_compiler_env "${{ github.event.inputs.device_name }}"; then
      echo "âœ… SDKä¸‹è½½æˆåŠŸæˆ–ä½¿ç”¨åå¤‡æ–¹æ¡ˆ"
    else
      echo "âš ï¸ SDKä¸‹è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
    fi
    
    echo "âœ… SDKä¸‹è½½æ­¥éª¤å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "ğŸŸ¢ æ­¥éª¤ 7 å®Œæˆ"

