#ã€build_firmware_main.sh-36ã€‘ä¿®å¤USB 3.0é©±åŠ¨ç¼ºå¤±é—®é¢˜
# åœ¨load_usb_configå‡½æ•°ä¸­æ·»åŠ 21.02ç‰ˆæœ¬çš„USB 3.0é©±åŠ¨

# ä¿®æ”¹load_usb_configå‡½æ•°ï¼Œæ·»åŠ ç‰ˆæœ¬ç‰¹å®šçš„USB 3.0é…ç½®ï¼š
load_usb_config() {
    local platform="$1"
    local version="$2"
    
    log "ğŸ”§ åŠ è½½USBé…ç½® - å¹³å°: $platform, ç‰ˆæœ¬: $version"
    
    # é¦–å…ˆåŠ è½½é€šç”¨USBé…ç½®
    load_config_template "usb-generic"
    
    # æ ¹æ®å¹³å°æ·»åŠ ä¸“ç”¨é©±åŠ¨
    echo "" >> .config
    echo "# ğŸŸ¡ å¹³å°ä¸“ç”¨USBæ§åˆ¶å™¨é©±åŠ¨" >> .config
    
    case "$platform" in
        "ipq40xx")
            echo "CONFIG_PACKAGE_kmod-usb-dwc3=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-dwc3-of-simple=y" >> .config
            echo "CONFIG_PACKAGE_kmod-usb-dwc3-qcom=y" >> .config
            echo "CONFIG_PACKAGE_kmod-phy-qcom-dwc3=y" >> .config
            log "âœ… æ·»åŠ é«˜é€šIPQ40xxå¹³å°ä¸“ç”¨USBé©±åŠ¨"
            ;;
        "ramips")
            echo "CONFIG_PACKAGE_kmod-usb-xhci-mtk=y" >> .config
            log "âœ… æ·»åŠ é›·å‡ŒMT76xxå¹³å°ä¸“ç”¨USBé©±åŠ¨"
            ;;
        "ath79")
            echo "CONFIG_PACKAGE_kmod-usb2-ath79=y" >> .config
            log "âœ… æ·»åŠ ath79å¹³å°ä¸“ç”¨USBé©±åŠ¨"
            ;;
    esac
    
    # ç‰ˆæœ¬ç‰¹å®šçš„USB 3.0é…ç½® - ä¿®å¤21.02ç‰ˆæœ¬USB 3.0ç¼ºå¤±é—®é¢˜
    echo "" >> .config
    echo "# ğŸ”§ USB 3.0é…ç½® - ç‰ˆæœ¬: $version" >> .config
    
    if [ "$version" = "openwrt-21.02" ] || [ "$version" = "21.02" ]; then
        # 21.02ç‰ˆæœ¬çš„USB 3.0é©±åŠ¨
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-xhci-pci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-ohci-pci=y" >> .config
        log "âœ… 21.02ç‰ˆæœ¬USB 3.0é…ç½®"
    else
        # 23.05ç‰ˆæœ¬çš„USB 3.0é©±åŠ¨
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-xhci-pci=y" >> .config
        log "âœ… 23.05ç‰ˆæœ¬USB 3.0é…ç½®"
    fi
    
    # ç‰ˆæœ¬ç‰¹å®šçš„NTFSé…ç½®
    echo "" >> .config
    echo "# ğŸ”§ NTFSé…ç½® - ç‰ˆæœ¬: $version" >> .config
    if [ "$version" = "openwrt-23.05" ] || [ "$version" = "23.05" ]; then
        echo "# CONFIG_PACKAGE_ntfs-3g is not set" >> .config
        echo "# CONFIG_PACKAGE_ntfs-3g-utils is not set" >> .config
        echo "# CONFIG_PACKAGE_ntfs3-mount is not set" >> .config
        log "âœ… 23.05ç‰ˆæœ¬NTFSé…ç½®ä¼˜åŒ–"
    else
        echo "CONFIG_PACKAGE_ntfs3-mount=y" >> .config
        log "âœ… 21.02ç‰ˆæœ¬NTFSé…ç½®"
    fi
}

#ã€build_firmware_main.sh-37ã€‘åœ¨apply_configä¸­å¼ºåˆ¶æ·»åŠ USB 3.0é©±åŠ¨
# ä¿®æ”¹apply_configå‡½æ•°ä¸­çš„å…³é”®USBé©±åŠ¨éƒ¨åˆ†

# åœ¨apply_configå‡½æ•°çš„æ­¥éª¤4ä¸­ï¼Œä¿®æ”¹critical_usb_driversæ•°ç»„ï¼š
# åŸä»£ç ï¼š
# local critical_usb_drivers=(
#     "CONFIG_PACKAGE_kmod-usb-core=y"
#     "CONFIG_PACKAGE_kmod-usb2=y"
#     "CONFIG_PACKAGE_kmod-usb3=y"
#     "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
#     ...
# )

# ä¿®å¤ä¸ºæ ¹æ®ç‰ˆæœ¬æ·»åŠ é€‚å½“çš„USB 3.0é©±åŠ¨ï¼š
local critical_usb_drivers=(
    "CONFIG_PACKAGE_kmod-usb-core=y"
    "CONFIG_PACKAGE_kmod-usb2=y"
    "CONFIG_PACKAGE_kmod-usb-storage=y"
    "CONFIG_PACKAGE_kmod-scsi-core=y"
)

# æ ¹æ®ç‰ˆæœ¬æ·»åŠ USB 3.0é©±åŠ¨
if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
    critical_usb_drivers+=(
        "CONFIG_PACKAGE_kmod-usb3=y"
        "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
        "CONFIG_PACKAGE_kmod-usb-xhci-pci=y"
        "CONFIG_PACKAGE_kmod-usb-xhci-plat-hcd=y"
        "CONFIG_PACKAGE_kmod-usb-ohci=y"
        "CONFIG_PACKAGE_kmod-usb-ohci-pci=y"
    )
    log "ğŸ”§ ä¸º21.02ç‰ˆæœ¬æ·»åŠ å®Œæ•´çš„USB 3.0é©±åŠ¨"
else
    # 23.05ç‰ˆæœ¬
    critical_usb_drivers+=(
        "CONFIG_PACKAGE_kmod-usb3=y"
        "CONFIG_PACKAGE_kmod-usb-xhci-hcd=y"
        "CONFIG_PACKAGE_kmod-usb-xhci-pci=y"
    )
    log "ğŸ”§ ä¸º23.05ç‰ˆæœ¬æ·»åŠ USB 3.0é©±åŠ¨"
fi

#ã€build_firmware_main.sh-38ã€‘ä¿®å¤generate_configä¸­ç‰ˆæœ¬ä¿¡æ¯ä¼ é€’
# ä¿®æ”¹generate_configå‡½æ•°è°ƒç”¨load_usb_configçš„åœ°æ–¹ï¼š

# åŸä»£ç ï¼š
# load_usb_config "$PLATFORM" "$SELECTED_BRANCH"

# ä¿®å¤ä¸ºä¼ é€’æ­£ç¡®çš„ç‰ˆæœ¬ä¿¡æ¯ï¼š
local version_for_usb="$SELECTED_BRANCH"
# å¦‚æœç‰ˆæœ¬æ˜¯openwrt-21.02æˆ–openwrt-23.05ï¼Œè½¬æ¢ä¸º21.02æˆ–23.05
if [ "$SELECTED_BRANCH" = "openwrt-21.02" ]; then
    version_for_usb="21.02"
elif [ "$SELECTED_BRANCH" = "openwrt-23.05" ]; then
    version_for_usb="23.05"
fi

log_usb_config "$PLATFORM" "$version_for_usb"

