# =============================================
# ASUS RT-AC42U 优化编译配置
# 设备平台: ipq40xx (Qualcomm IPQ4019)
# 设备树: qcom-ipq4019-rt-ac42u.dts
# 已修复所有软件包冲突和Samba编译问题
# 添加预下载验证支持
# =============================================

# ======================
# 目标架构配置
# ======================

# IPQ40xx 平台配置
CONFIG_TARGET_ipq40xx=y
CONFIG_TARGET_ipq40xx_generic=y
CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y

# ======================
# 工厂镜像生成配置
# ======================

# 启用工厂镜像生成
CONFIG_TARGET_IMAGES_PACKAGES=y
CONFIG_IMAGEOPT=y
CONFIG_COMBINED_IMAGES=y

# 确保设备支持工厂镜像
CONFIG_TARGET_ipq40xx_generic_DEVICE_asus_rt-ac42u=y

# 内核和根文件系统分区大小
CONFIG_TARGET_KERNEL_PARTSIZE=32
CONFIG_TARGET_ROOTFS_PARTSIZE=512

# 支持多种文件系统格式
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_EXT4FS=y
CONFIG_TARGET_ROOTFS_EXT4FS_ROOTDEV=y
CONFIG_TARGET_ROOTFS_INCLUDE_USB=y

# ======================
# 镜像文件设置
# ======================

# 使用 squashfs 文件系统（压缩只读）
CONFIG_TARGET_ROOTFS_SQUASHFS=y
# 生成压缩的镜像文件
CONFIG_TARGET_IMAGES_GZIP=y
# 根文件系统分区大小 128MB（优化平衡）
CONFIG_TARGET_ROOTFS_PARTSIZE=128

# ======================
# 内核配置 (IPQ4019 特定)
# ======================

CONFIG_OF=y
CONFIG_ARM=y
CONFIG_ARCH_MULTI_V7=y
CONFIG_ARCH_QCOM=y
CONFIG_ARCH_IPQ40XX=y

# ======================
# IPQ4019 硬件驱动
# ======================

CONFIG_PACKAGE_kmod-clk-ipq40xx=y
CONFIG_PACKAGE_kmod-gpio-ipq40xx=y
CONFIG_PACKAGE_kmod-pinctrl-ipq40xx=y
CONFIG_PACKAGE_kmod-serial-msm=y
CONFIG_PACKAGE_kmod-nand-ipq40xx=y

# ======================
# 无线网络驱动 (已修复冲突)
# ======================

# 使用社区优化版驱动，禁用标准版避免冲突
# CONFIG_PACKAGE_kmod-ath10k is not set
CONFIG_PACKAGE_kmod-ath10k-ct=y
CONFIG_PACKAGE_kmod-ath10k-ct-smallbuffers=y
CONFIG_PACKAGE_ath10k-firmware-qca9887=y
CONFIG_PACKAGE_ath10k-firmware-qca988x=y
CONFIG_PACKAGE_ath10k-firmware-qca4019=y
CONFIG_PACKAGE_kmod-cfg80211=y
CONFIG_PACKAGE_kmod-mac80211=y

# ======================
# 网络和以太网支持
# ======================

CONFIG_PACKAGE_kmod-qca-essedma=y
CONFIG_PACKAGE_kmod-ppp=y
CONFIG_PACKAGE_kmod-pppoe=y

# ======================
# USB 支持 (RT-AC42U 有 USB 3.0)
# ======================

CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-usb-storage-uas=y

# ======================
# 基础系统包 (必需)
# ======================

CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_PACKAGE_ca-bundle=y
# 使用完整版DNSMasq，禁用标准版避免冲突
# CONFIG_PACKAGE_dnsmasq is not set
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_fstools=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_libc=y
CONFIG_PACKAGE_libgcc=y
CONFIG_PACKAGE_libustream-wolfssl=y
CONFIG_PACKAGE_logd=y
CONFIG_PACKAGE_mtd=y
CONFIG_PACKAGE_netifd=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubusd=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_uclient-fetch=y
CONFIG_PACKAGE_urandom-seed=y
CONFIG_PACKAGE_usign=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y

# ======================
# 文件系统支持
# ======================

CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-exfat=y
CONFIG_PACKAGE_kmod-fs-ntfs=y
CONFIG_PACKAGE_kmod-fs-f2fs=y
CONFIG_PACKAGE_kmod-fs-vfat=y

# ======================
# 硬件加密加速
# ======================

CONFIG_PACKAGE_kmod-crypto-hw-ipq40xx=y
CONFIG_PACKAGE_kmod-crypto-aes=y
CONFIG_PACKAGE_kmod-crypto-arc4=y
CONFIG_PACKAGE_kmod-crypto-des=y
CONFIG_PACKAGE_kmod-crypto-ecb=y
CONFIG_PACKAGE_kmod-crypto-hash=y

# ======================
# NSS 驱动支持 (网络硬件加速)
# ======================

CONFIG_PACKAGE_kmod-qca-nss-drv=y
CONFIG_PACKAGE_kmod-qca-nss-ecm=y
CONFIG_PACKAGE_kmod-qca-nss-crypto=y
CONFIG_PACKAGE_kmod-qca-nss-cfi=y

# ======================
# IPv6 支持 (完整配置)
# ======================

CONFIG_PACKAGE_ip6tables=y
CONFIG_PACKAGE_ip6tables-extra=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_kmod-ip6tables=y
CONFIG_PACKAGE_kmod-nf-ipt6=y
CONFIG_PACKAGE_kmod-ipt-nat6=y

# ======================
# 防火墙和 NAT
# ======================

CONFIG_PACKAGE_kmod-ipt-conntrack=y
CONFIG_PACKAGE_kmod-ipt-core=y
CONFIG_PACKAGE_kmod-ipt-nat=y
CONFIG_PACKAGE_kmod-ipt-offload=y
CONFIG_PACKAGE_kmod-ipt-fullconenat=y

# ======================
# LuCI Web 管理界面 (基础)
# ======================

CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-mod-network=y
CONFIG_PACKAGE_luci-mod-status=y
CONFIG_PACKAGE_luci-mod-system=y
CONFIG_PACKAGE_luci-proto-ipv6=y
CONFIG_PACKAGE_luci-proto-ppp=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

# ======================
# UPnP 支持
# ======================

CONFIG_PACKAGE_miniupnpd=y
CONFIG_PACKAGE_luci-app-upnp=y

# ======================
# Samba4 文件共享 (优化配置)
# ======================

CONFIG_PACKAGE_luci-app-samba4=y
CONFIG_PACKAGE_samba4-server=y
CONFIG_PACKAGE_samba4-libs=y

# Samba依赖库
CONFIG_PACKAGE_libtalloc=y
CONFIG_PACKAGE_libtdb=y
CONFIG_PACKAGE_libtevent=y
CONFIG_PACKAGE_libldb=y
CONFIG_PACKAGE_libncurses=y
CONFIG_PACKAGE_libreadline=y

# 禁用不必要的Samba组件（减少体积和依赖）
# CONFIG_PACKAGE_samba4-server-avahi is not set
# CONFIG_PACKAGE_samba4-server-python is not set
# CONFIG_PACKAGE_samba4-server-dc is not set
# CONFIG_PACKAGE_samba4-client is not set
# CONFIG_PACKAGE_samba4-utils is not set

# 优化Samba编译选项
CONFIG_SAMBA4_OPTIMIZE_SIZE=y
CONFIG_SAMBA4_SMALL=y

# Samba基础配置
CONFIG_SAMBA4_ENABLE_SMBD=y
CONFIG_SAMBA4_ENABLE_NMBD=y
CONFIG_SAMBA4_ENABLE_WINBIND=y

# ======================
# 请求的 LuCI 应用程序
# ======================

# ARP绑定
CONFIG_PACKAGE_luci-app-arpbind=y

# CPU限制
CONFIG_PACKAGE_luci-app-cpulimit=y
CONFIG_PACKAGE_cpulimit-ng=y

# 磁盘管理
CONFIG_PACKAGE_luci-app-diskman=y
CONFIG_PACKAGE_blkid=y
CONFIG_PACKAGE_lsblk=y
CONFIG_PACKAGE_partx-utils=y

# 流量均衡(QoS增强)
CONFIG_PACKAGE_luci-app-eqosplus=y

# 硬盘休眠
CONFIG_PACKAGE_luci-app-hd-idle=y
CONFIG_PACKAGE_hd-idle=y

# 家长控制
CONFIG_PACKAGE_luci-app-parentcontrol=y

# 微信推送
CONFIG_PACKAGE_luci-app-wechatpush=y

# SmartDNS
CONFIG_PACKAGE_luci-app-smartdns=y
CONFIG_PACKAGE_smartdns=y

# TurboACC 网络加速
CONFIG_PACKAGE_luci-app-turboacc=y
CONFIG_PACKAGE_kmod-fast-classifier=y

# KMS 激活服务器
CONFIG_PACKAGE_luci-app-vlmcsd=y
CONFIG_PACKAGE_vlmcsd=y

# FTP 服务器
CONFIG_PACKAGE_luci-app-vsftpd=y
CONFIG_PACKAGE_vsftpd-alt=y

# 自动挂载
CONFIG_PACKAGE_automount=y
CONFIG_PACKAGE_block-mount=y

# Web 终端
CONFIG_PACKAGE_luci-app-ttyd=y
CONFIG_PACKAGE_ttyd=y

# SQM 智能队列管理
CONFIG_PACKAGE_luci-app-sqm-autorate=y
CONFIG_PACKAGE_sqm-scripts=y

# ======================
# 系统控制工具
# ======================

CONFIG_PACKAGE_htop=y
CONFIG_PACKAGE_nano=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_wget=y
CONFIG_PACKAGE_iperf3=y

# ======================
# 分区扩容支持
# ======================

CONFIG_PACKAGE_fdisk=y
CONFIG_PACKAGE_lsblk=y
CONFIG_PACKAGE_blkid=y
CONFIG_PACKAGE_e2fsprogs=y
CONFIG_PACKAGE_resize2fs=y

# ======================
# 编译优化设置
# ======================

# CONFIG_DEBUG_INFO is not set
CONFIG_STRIP_KERNEL_EXPORTS=y
CONFIG_KERNEL_LZ4=y
# CONFIG_USE_MKLIBS is not set
CONFIG_REMOVE_SUID=y
CONFIG_CCACHE=y

# ======================
# 内核配置优化
# ======================

CONFIG_SMP=y
CONFIG_CPU_IDLE=y
CONFIG_ARM_CPUIDLE=y
CONFIG_THERMAL=y
CONFIG_CPU_THERMAL=y
CONFIG_DEVFREQ_THERMAL=y
CONFIG_ARM_ARCH_TIMER=y

# ======================
# Samba编译优化配置
# ======================

# 确保Samba依赖库正确配置
CONFIG_PACKAGE_libtalloc=y
CONFIG_PACKAGE_libtdb=y  
CONFIG_PACKAGE_libtevent=y
CONFIG_PACKAGE_libldb=y

# Samba编译优化
CONFIG_SAMBA4_SMALL=y
CONFIG_SAMBA4_OPTIMIZE_SIZE=y

# 禁用不必要的Samba组件减小体积
# CONFIG_SAMBA4_SERVER_AVAHI is not set
# CONFIG_SAMBA4_SERVER_DC is not set
# CONFIG_SAMBA4_UTILS is not set
# CONFIG_SAMBA4_CLIENT is not set

# 启用必要的Samba组件
CONFIG_SAMBA4_ENABLE_SMBD=y
CONFIG_SAMBA4_ENABLE_NMBD=y
# CONFIG_SAMBA4_ENABLE_WINBIND is not set  # 禁用winbind减少依赖

# 编译优化
CONFIG_SAMBA4_EMBEDDED=y
CONFIG_SAMBA4_NO_LDAP=y
CONFIG_SAMBA4_NO_ADS=y

# ======================
# 预下载优化配置
# ======================

# 启用并行下载
CONFIG_DOWNLOAD_PARALLEL=y
CONFIG_DOWNLOAD_TIMEOUT=60

# 启用源码完整性检查
CONFIG_CHECK_SIGNATURE=y

# ======================
# 明确禁用的功能 (减小体积，避免冲突)
# ======================

# 禁用 KMS 媒体服务 (减小固件体积)
# CONFIG_PACKAGE_minidlna is not set
# CONFIG_PACKAGE_ffmpeg is not set
# CONFIG_PACKAGE_ffprobe is not set

# 禁用动态DNS相关
# CONFIG_PACKAGE_luci-app-ddns is not set
# CONFIG_PACKAGE_ddns-scripts is not set
# CONFIG_PACKAGE_ddns-scripts-cloudflare is not set
# CONFIG_PACKAGE_ddns-scripts-freedns is not set
# CONFIG_PACKAGE_ddns-scripts-godaddy is not set
# CONFIG_PACKAGE_ddns-scripts-noip is not set
# CONFIG_PACKAGE_ddns-scripts-nsupdate is not set
# CONFIG_PACKAGE_ddns-scripts-route53 is not set

# 禁用带宽监控相关
# CONFIG_PACKAGE_luci-app-statistics is not set
# CONFIG_PACKAGE_collectd is not set
# CONFIG_PACKAGE_collectd-mod-cpu is not set
# CONFIG_PACKAGE_collectd-mod-interface is not set
# CONFIG_PACKAGE_collectd-mod-memory is not set
# CONFIG_PACKAGE_collectd-mod-network is not set
# CONFIG_PACKAGE_collectd-mod-ping is set
# CONFIG_PACKAGE_collectd-mod-rrdtool is not set

# 禁用网络唤醒
# CONFIG_PACKAGE_luci-app-wol is not set
# CONFIG_PACKAGE_etherwake is not set

# 禁用其他不必要的包
# CONFIG_PACKAGE_luci-app-adblock is not set
# CONFIG_PACKAGE_luci-app-vpnbypass is not set

# ======================
# 可选功能 (按需启用)
# ======================

# 如果需要更多存储功能，可以启用以下
# CONFIG_PACKAGE_luci-app-usb-printer is not set
# CONFIG_PACKAGE_p910nd is not set

# 如果需要更多网络工具，可以启用以下  
# CONFIG_PACKAGE_tcpdump is not set
# CONFIG_PACKAGE_sslh is not set

# ======================
# 固件特性总结
# ======================

# ✅ 已启用的重要功能:
# - IPv6 完整支持
# - UPnP 自动端口映射
# - 完整的 LuCI 应用套件
# - 分区扩容支持
# - 系统控制工具
# - 微信推送通知
# - 网络加速 (TurboACC)
# - 智能DNS (SmartDNS)
# - 硬盘休眠和磁盘管理
# - Web 终端访问
# - 家长控制功能
# - Samba4 文件共享 (已优化)
# - FTP 服务器
# - 工厂镜像生成
# - 预下载验证支持

# ❌ 已禁用的功能:
# - KMS 视频流媒体 (减小体积)
# - 动态DNS (DDNS)
# - 带宽监控统计
# - 网络唤醒 (WOL)

# 🔧 已修复的冲突:
# - DNSMasq 冲突 (使用 dnsmasq-full)
# - 无线驱动冲突 (使用 kmod-ath10k-ct)
# - Samba 依赖冲突 (单独编译依赖库)

# 🚀 性能优化:
# - NSS 硬件加速
# - 加密硬件加速
# - 编译优化
# - 内存优化
# - Samba 编译优化
# - 预下载优化

# 📊 预估固件大小: 25-35MB
# ⏱️ 预估编译时间: 2-4小时
# 💾 预估所需空间: 25-30GB
