# è‡ªåŠ¨åˆ›å»ºçš„æ–‡ä»¶ - Sat Jan 31 01:18:35 UTC 2026
# æ­¥éª¤ 7: ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆä¿®å¤ç‰ˆï¼‰- ç¯å¢ƒå˜é‡ä¿®å¤
- name: "7. ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆç¯å¢ƒå˜é‡ä¿®å¤ç‰ˆï¼‰"
  run: |
    echo "=== æ­¥éª¤ 7: ä¸‹è½½OpenWrtå®˜æ–¹SDKï¼ˆç¯å¢ƒå˜é‡ä¿®å¤ç‰ˆï¼‰ ==="
    echo "ğŸ• å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    
    # è®¾ç½®é”™è¯¯å¤„ç† - è¿™é‡Œä¸é€€å‡ºï¼ŒSDKä¸‹è½½å¤±è´¥å¯ä»¥ç»§ç»­
    trap 'echo "âš ï¸ SDKä¸‹è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨è‡ªåŠ¨æ„å»ºç¼–è¯‘å™¨ï¼Œç»§ç»­æ‰§è¡Œ..."' ERR
    
    echo "ğŸš€ å¼€å§‹ä¸‹è½½OpenWrtå®˜æ–¹SDKå·¥å…·é“¾..."
    
    # å…ˆæ£€æŸ¥ç¯å¢ƒæ–‡ä»¶æ˜¯å¦å·²ç»å­˜åœ¨
    echo "ğŸ” æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶..."
    if [ -f "/mnt/openwrt-build/build_env.sh" ]; then
      echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²å­˜åœ¨ï¼ˆç”±æ­¥éª¤6.4åˆ›å»ºï¼‰"
      echo "ğŸ“Š ç¯å¢ƒæ–‡ä»¶å†…å®¹æ‘˜è¦:"
      head -20 /mnt/openwrt-build/build_env.sh
      
      # åŠ è½½ç°æœ‰ç¯å¢ƒå˜é‡
      source /mnt/openwrt-build/build_env.sh
      echo "âœ… ä»ç°æœ‰ç¯å¢ƒæ–‡ä»¶åŠ è½½å˜é‡:"
      echo "  SELECTED_BRANCH: $SELECTED_BRANCH"
      echo "  TARGET: $TARGET"
      echo "  SUBTARGET: $SUBTARGET"
      echo "  DEVICE: $DEVICE"
      echo "  CONFIG_MODE: $CONFIG_MODE"
      echo "  REPO_ROOT: $REPO_ROOT"
      echo "  COMPILER_DIR: $COMPILER_DIR"
      echo "  DEVICE_NAME: $DEVICE_NAME"
      echo "  PLATFORM: $PLATFORM"
      echo "  SOURCE_REPO: $SOURCE_REPO"
      echo ""
      
      echo "ğŸ’¡ ä½¿ç”¨æ­¥éª¤6.4å·²è®¾ç½®çš„ç¯å¢ƒå˜é‡è¿›è¡ŒSDKä¸‹è½½"
    else
      echo "âš ï¸ ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯æ­¥éª¤6.4å¤±è´¥"
      echo "ğŸ“ é‡æ–°åˆ›å»ºç¯å¢ƒå˜é‡..."
      
      # ä½¿ç”¨è®¾å¤‡æ”¯æŒç³»ç»Ÿè·å–é…ç½®
      SUPPORT_DIR="${{ github.workspace }}/firmware-config"
      if [ -f "$SUPPORT_DIR/support.sh" ]; then
        source "$SUPPORT_DIR/support.sh"
        
        # è·å–è®¾å¤‡é…ç½®
        if command -v get_device_config >/dev/null 2>&1; then
          DEVICE_CONFIG=$(get_device_config "${{ github.event.inputs.device_name }}")
          if [ -n "$DEVICE_CONFIG" ]; then
            TARGET=$(echo $DEVICE_CONFIG | awk '{print $1}')
            SUBTARGET=$(echo $DEVICE_CONFIG | awk '{print $2}')
            DEVICE=$(echo $DEVICE_CONFIG | awk '{print $3}')
            PLATFORM=$(echo $DEVICE_CONFIG | awk '{print $4}')
            echo "âœ… ä»è®¾å¤‡æ”¯æŒç³»ç»Ÿè·å–é…ç½®: TARGET=$TARGET, SUBTARGET=$SUBTARGET, DEVICE=$DEVICE, PLATFORM=$PLATFORM"
          else
            echo "âŒ é”™è¯¯: æ— æ³•è·å–è®¾å¤‡é…ç½®"
            exit 1
          fi
        else
          echo "âŒ é”™è¯¯: get_device_config å‡½æ•°ä¸å­˜åœ¨"
          exit 1
        fi
      else
        echo "âŒ é”™è¯¯: è®¾å¤‡æ”¯æŒè„šæœ¬ä¸å­˜åœ¨"
        exit 1
      fi
      
      # è®¾ç½®ç‰ˆæœ¬åˆ†æ”¯
      if [ "${{ github.event.inputs.version_selection }}" = "23.05" ]; then
        SELECTED_BRANCH="openwrt-23.05"
      else
        SELECTED_BRANCH="openwrt-21.02"
      fi
      
      # è®¾ç½®æºä»£ç ä»“åº“
      SOURCE_REPO="${{ github.event.inputs.source_repo }}"
      
      # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
      ENV_FILE="/mnt/openwrt-build/build_env.sh"
      echo "#!/bin/bash" > "$ENV_FILE"
      echo "export SELECTED_REPO_URL=\"https://github.com/immortalwrt/immortalwrt.git\"" >> "$ENV_FILE"
      echo "export SELECTED_BRANCH=\"$SELECTED_BRANCH\"" >> "$ENV_FILE"
      echo "export TARGET=\"$TARGET\"" >> "$ENV_FILE"
      echo "export SUBTARGET=\"$SUBTARGET\"" >> "$ENV_FILE"
      echo "export DEVICE=\"$DEVICE\"" >> "$ENV_FILE"
      echo "export CONFIG_MODE=\"${{ github.event.inputs.config_mode }}\"" >> "$ENV_FILE"
      echo "export REPO_ROOT=\"${{ github.workspace }}\"" >> "$ENV_FILE"
      echo "export COMPILER_DIR=\"\"" >> "$ENV_FILE"
      echo "export DEVICE_NAME=\"${{ github.event.inputs.device_name }}\"" >> "$ENV_FILE"
      echo "export PLATFORM=\"$PLATFORM\"" >> "$ENV_FILE"
      echo "export SOURCE_REPO=\"$SOURCE_REPO\"" >> "$ENV_FILE"
      
      # å¦‚æœè®¾ç½®äº†GITHUB_ENVï¼Œä¹Ÿå¯¼å‡ºåˆ°GitHub Actionsç¯å¢ƒ
      if [ -n "$GITHUB_ENV" ]; then
        echo "TARGET=$TARGET" >> $GITHUB_ENV
        echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
        echo "DEVICE=$DEVICE" >> $GITHUB_ENV
        echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
        echo "SELECTED_BRANCH=$SELECTED_BRANCH" >> $GITHUB_ENV
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
      fi
      
      chmod +x "$ENV_FILE"
      echo "âœ… å·²åˆ›å»ºç¯å¢ƒæ–‡ä»¶"
      
      # é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡
      source "$ENV_FILE"
    fi
    
    # å…³é”®æ£€æŸ¥ï¼šç¡®ä¿TARGETå˜é‡ä¸ä¸ºç©º
    echo ""
    echo "ğŸ” å…³é”®å˜é‡æ£€æŸ¥:"
    echo "  TARGET: $TARGET"
    echo "  SUBTARGET: $SUBTARGET"
    echo "  DEVICE: $DEVICE"
    echo "  PLATFORM: $PLATFORM"
    
    if [ -z "$TARGET" ]; then
      echo "âŒ é”™è¯¯: TARGET å˜é‡ä¸ºç©ºï¼Œæ— æ³•ç»§ç»­"
      exit 1
    fi
    
    if [ -z "$SUBTARGET" ]; then
      echo "âš ï¸ è­¦å‘Š: SUBTARGET å˜é‡ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼ 'generic'"
      export SUBTARGET="generic"
    fi
    
    if [ -z "$DEVICE" ]; then
      echo "âš ï¸ è­¦å‘Š: DEVICE å˜é‡ä¸ºç©ºï¼Œä½¿ç”¨è®¾å¤‡åç§°ä½œä¸ºé»˜è®¤å€¼"
      export DEVICE="${{ github.event.inputs.device_name }}"
    fi
    
    if [ -z "$PLATFORM" ]; then
      echo "âš ï¸ è­¦å‘Š: PLATFORM å˜é‡ä¸ºç©ºï¼Œä½¿ç”¨TARGETä½œä¸ºé»˜è®¤å€¼"
      export PLATFORM="$TARGET"
    fi
    
    # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
    save_env() {
      local env_file="$1"
      echo "#!/bin/bash" > "$env_file"
      echo "export SELECTED_REPO_URL=\"$SELECTED_REPO_URL\"" >> "$env_file"
      echo "export SELECTED_BRANCH=\"$SELECTED_BRANCH\"" >> "$env_file"
      echo "export TARGET=\"$TARGET\"" >> "$env_file"
      echo "export SUBTARGET=\"$SUBTARGET\"" >> "$env_file"
      echo "export DEVICE=\"$DEVICE\"" >> "$env_file"
      echo "export CONFIG_MODE=\"$CONFIG_MODE\"" >> "$env_file"
      echo "export REPO_ROOT=\"$REPO_ROOT\"" >> "$env_file"
      echo "export COMPILER_DIR=\"$COMPILER_DIR\"" >> "$env_file"
      echo "export DEVICE_NAME=\"$DEVICE_NAME\"" >> "$env_file"
      echo "export PLATFORM=\"$PLATFORM\"" >> "$env_file"
      echo "export SOURCE_REPO=\"$SOURCE_REPO\"" >> "$env_file"
      chmod +x "$env_file"
    }
    
    # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
    save_env "/mnt/openwrt-build/build_env.sh"
    echo "âœ… æ›´æ–°ç¯å¢ƒæ–‡ä»¶å®Œæˆ"
    
    # æ‰§è¡ŒSDKä¸‹è½½ï¼Œå…è®¸å¤±è´¥
    echo "ğŸ”„ å¼€å§‹æ‰§è¡ŒSDKä¸‹è½½..."
    if "${{ github.workspace }}/firmware-config/scripts/build_firmware_main.sh" initialize_compiler_env "${{ github.event.inputs.device_name }}"; then
      echo "âœ… SDKä¸‹è½½æˆåŠŸæˆ–ä½¿ç”¨åå¤‡æ–¹æ¡ˆ"
    else
      echo "âš ï¸ SDKä¸‹è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨OpenWrtè‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘å™¨"
    fi
    
    echo "âœ… SDKä¸‹è½½æ­¥éª¤å®Œæˆï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "ğŸŸ¢ æ­¥éª¤ 7 å®Œæˆ"


